begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 1998 - 2007 SÃ¸ren Schmidt<sos@FreeBSD.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer,  *    without modification, immediately at the beginning of the file.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"opt_ata.h"
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/ata.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<sys/sema.h>
end_include

begin_include
include|#
directive|include
file|<sys/taskqueue.h>
end_include

begin_include
include|#
directive|include
file|<vm/uma.h>
end_include

begin_include
include|#
directive|include
file|<machine/stdarg.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<dev/pci/pcivar.h>
end_include

begin_include
include|#
directive|include
file|<dev/pci/pcireg.h>
end_include

begin_include
include|#
directive|include
file|<dev/ata/ata-all.h>
end_include

begin_include
include|#
directive|include
file|<dev/ata/ata-pci.h>
end_include

begin_include
include|#
directive|include
file|<ata_if.h>
end_include

begin_struct
struct|struct
name|ata_serialize
block|{
name|struct
name|mtx
name|locked_mtx
decl_stmt|;
name|int
name|locked_ch
decl_stmt|;
name|int
name|restart_ch
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* local prototypes */
end_comment

begin_comment
comment|/* ata-chipset.c */
end_comment

begin_function_decl
specifier|static
name|int
name|ata_generic_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_generic_intr
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_generic_setmode
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|mode
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_sata_phy_check_events
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_sata_phy_event
parameter_list|(
name|void
modifier|*
name|context
parameter_list|,
name|int
name|dummy
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_sata_phy_reset
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_sata_connect
parameter_list|(
name|struct
name|ata_channel
modifier|*
name|ch
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_sata_setmode
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|mode
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_request2fis_h2d
parameter_list|(
name|struct
name|ata_request
modifier|*
name|request
parameter_list|,
name|u_int8_t
modifier|*
name|fis
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_ahci_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_ahci_allocate
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_ahci_status
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_ahci_begin_transaction
parameter_list|(
name|struct
name|ata_request
modifier|*
name|request
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_ahci_end_transaction
parameter_list|(
name|struct
name|ata_request
modifier|*
name|request
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_ahci_reset
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_ahci_dmasetprd
parameter_list|(
name|void
modifier|*
name|xsc
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|segs
parameter_list|,
name|int
name|nsegs
parameter_list|,
name|int
name|error
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_ahci_dmainit
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_ahci_setup_fis
parameter_list|(
name|struct
name|ata_ahci_cmd_tab
modifier|*
name|ctp
parameter_list|,
name|struct
name|ata_request
modifier|*
name|request
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_acard_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_acard_allocate
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_acard_status
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_acard_850_setmode
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|mode
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_acard_86X_setmode
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|mode
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_ali_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_ali_allocate
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_ali_sata_allocate
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_ali_reset
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_ali_setmode
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|mode
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_amd_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_ati_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_ati_setmode
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|mode
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_cyrix_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_cyrix_setmode
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|mode
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_cypress_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_cypress_setmode
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|mode
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_highpoint_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_highpoint_allocate
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_highpoint_setmode
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|mode
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_highpoint_check_80pin
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|mode
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_intel_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_intel_allocate
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_intel_reset
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_intel_old_setmode
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|mode
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_intel_new_setmode
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|mode
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_intel_sata_setmode
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|mode
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_intel_31244_allocate
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_intel_31244_status
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_intel_31244_tf_write
parameter_list|(
name|struct
name|ata_request
modifier|*
name|request
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_intel_31244_reset
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_ite_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_ite_8213_setmode
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|mode
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_ite_821x_setmode
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|mode
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_jmicron_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_jmicron_allocate
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_jmicron_reset
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_jmicron_dmainit
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_jmicron_setmode
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|mode
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_marvell_pata_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_marvell_pata_allocate
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_marvell_pata_setmode
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|mode
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_marvell_edma_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_marvell_edma_allocate
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_marvell_edma_status
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_marvell_edma_begin_transaction
parameter_list|(
name|struct
name|ata_request
modifier|*
name|request
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_marvell_edma_end_transaction
parameter_list|(
name|struct
name|ata_request
modifier|*
name|request
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_marvell_edma_reset
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_marvell_edma_dmasetprd
parameter_list|(
name|void
modifier|*
name|xsc
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|segs
parameter_list|,
name|int
name|nsegs
parameter_list|,
name|int
name|error
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_marvell_edma_dmainit
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_national_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_national_setmode
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|mode
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_netcell_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_netcell_allocate
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_nvidia_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_nvidia_allocate
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_nvidia_status
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_nvidia_reset
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_promise_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_promise_allocate
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_promise_status
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_promise_dmastart
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_promise_dmastop
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_promise_dmareset
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_promise_dmainit
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_promise_setmode
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|mode
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_promise_tx2_allocate
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_promise_tx2_status
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_promise_mio_allocate
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_promise_mio_intr
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_promise_mio_status
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_promise_mio_command
parameter_list|(
name|struct
name|ata_request
modifier|*
name|request
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_promise_mio_reset
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_promise_mio_dmainit
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_promise_mio_setprd
parameter_list|(
name|void
modifier|*
name|xsc
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|segs
parameter_list|,
name|int
name|nsegs
parameter_list|,
name|int
name|error
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_promise_mio_setmode
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|mode
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_promise_sx4_intr
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_promise_sx4_command
parameter_list|(
name|struct
name|ata_request
modifier|*
name|request
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_promise_apkt
parameter_list|(
name|u_int8_t
modifier|*
name|bytep
parameter_list|,
name|struct
name|ata_request
modifier|*
name|request
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_promise_queue_hpkt
parameter_list|(
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
parameter_list|,
name|u_int32_t
name|hpkt
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_promise_next_hpkt
parameter_list|(
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_serverworks_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_serverworks_allocate
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_serverworks_tf_read
parameter_list|(
name|struct
name|ata_request
modifier|*
name|request
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_serverworks_tf_write
parameter_list|(
name|struct
name|ata_request
modifier|*
name|request
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_serverworks_setmode
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|mode
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_sii_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_cmd_allocate
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_cmd_status
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_cmd_setmode
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|mode
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_sii_allocate
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_sii_status
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_sii_reset
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_sii_setmode
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|mode
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_siiprb_allocate
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_siiprb_status
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_siiprb_begin_transaction
parameter_list|(
name|struct
name|ata_request
modifier|*
name|request
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_siiprb_end_transaction
parameter_list|(
name|struct
name|ata_request
modifier|*
name|request
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_siiprb_reset
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_siiprb_dmasetprd
parameter_list|(
name|void
modifier|*
name|xsc
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|segs
parameter_list|,
name|int
name|nsegs
parameter_list|,
name|int
name|error
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_siiprb_dmainit
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_sis_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_sis_allocate
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_sis_reset
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_sis_setmode
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|mode
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_via_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_via_allocate
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_via_reset
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_via_setmode
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|mode
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_via_southbridge_fixup
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_via_family_setmode
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|mode
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_set_desc
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|ata_chip_id
modifier|*
name|ata_match_chip
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|struct
name|ata_chip_id
modifier|*
name|index
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|ata_chip_id
modifier|*
name|ata_find_chip
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|struct
name|ata_chip_id
modifier|*
name|index
parameter_list|,
name|int
name|slot
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_setup_interrupt
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_serialize
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|flags
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_serialize_init
parameter_list|(
name|struct
name|ata_serialize
modifier|*
name|serial
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_print_cable
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|u_int8_t
modifier|*
name|who
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_atapi
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_check_80pin
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|mode
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_mode2idx
parameter_list|(
name|int
name|mode
parameter_list|)
function_decl|;
end_function_decl

begin_struct
struct|struct
name|ali_sata_resources
block|{
name|struct
name|resource
modifier|*
name|bars
index|[
literal|4
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/*  * generic ATA support functions  */
end_comment

begin_function
name|int
name|ata_generic_ident
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|char
name|buffer
index|[
literal|64
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"%s ATA controller"
argument_list|,
name|ata_pcivendor2str
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
name|device_set_desc_copy
argument_list|(
name|dev
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|chipinit
operator|=
name|ata_generic_chipinit
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_generic_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|ata_setup_interrupt
argument_list|(
name|dev
argument_list|)
condition|)
return|return
name|ENXIO
return|;
name|ctlr
operator|->
name|setmode
operator|=
name|ata_generic_setmode
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_generic_intr
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|data
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
decl_stmt|;
name|int
name|unit
decl_stmt|;
for|for
control|(
name|unit
operator|=
literal|0
init|;
name|unit
operator|<
name|ctlr
operator|->
name|channels
condition|;
name|unit
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|ch
operator|=
name|ctlr
operator|->
name|interrupt
index|[
name|unit
index|]
operator|.
name|argument
operator|)
condition|)
name|ctlr
operator|->
name|interrupt
index|[
name|unit
index|]
operator|.
name|function
argument_list|(
name|ch
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ata_generic_setmode
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|struct
name|ata_device
modifier|*
name|atadev
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|mode
operator|=
name|ata_limit_mode
argument_list|(
name|dev
argument_list|,
name|mode
argument_list|,
name|ATA_UDMA2
argument_list|)
expr_stmt|;
name|mode
operator|=
name|ata_check_80pin
argument_list|(
name|dev
argument_list|,
name|mode
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ata_controlcmd
argument_list|(
name|dev
argument_list|,
name|ATA_SETFEATURES
argument_list|,
name|ATA_SF_SETXFER
argument_list|,
literal|0
argument_list|,
name|mode
argument_list|)
condition|)
name|atadev
operator|->
name|mode
operator|=
name|mode
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * SATA support functions  */
end_comment

begin_function
specifier|static
name|void
name|ata_sata_phy_check_events
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|u_int32_t
name|error
init|=
name|ATA_IDX_INL
argument_list|(
name|ch
argument_list|,
name|ATA_SERROR
argument_list|)
decl_stmt|;
comment|/* clear error bits/interrupt */
name|ATA_IDX_OUTL
argument_list|(
name|ch
argument_list|,
name|ATA_SERROR
argument_list|,
name|error
argument_list|)
expr_stmt|;
comment|/* do we have any events flagged ? */
if|if
condition|(
name|error
condition|)
block|{
name|struct
name|ata_connect_task
modifier|*
name|tp
decl_stmt|;
name|u_int32_t
name|status
init|=
name|ATA_IDX_INL
argument_list|(
name|ch
argument_list|,
name|ATA_SSTATUS
argument_list|)
decl_stmt|;
comment|/* if we have a connection event deal with it */
if|if
condition|(
operator|(
name|error
operator|&
name|ATA_SE_PHY_CHANGED
operator|)
operator|&&
operator|(
name|tp
operator|=
operator|(
expr|struct
name|ata_connect_task
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|ata_connect_task
argument_list|)
argument_list|,
name|M_ATA
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
operator|(
operator|(
name|status
operator|&
name|ATA_SS_CONWELL_MASK
operator|)
operator|==
name|ATA_SS_CONWELL_GEN1
operator|)
operator|||
operator|(
operator|(
name|status
operator|&
name|ATA_SS_CONWELL_MASK
operator|)
operator|==
name|ATA_SS_CONWELL_GEN2
operator|)
condition|)
block|{
if|if
condition|(
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|ch
operator|->
name|dev
argument_list|,
literal|"CONNECT requested\n"
argument_list|)
expr_stmt|;
name|tp
operator|->
name|action
operator|=
name|ATA_C_ATTACH
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|ch
operator|->
name|dev
argument_list|,
literal|"DISCONNECT requested\n"
argument_list|)
expr_stmt|;
name|tp
operator|->
name|action
operator|=
name|ATA_C_DETACH
expr_stmt|;
block|}
name|tp
operator|->
name|dev
operator|=
name|ch
operator|->
name|dev
expr_stmt|;
name|TASK_INIT
argument_list|(
operator|&
name|tp
operator|->
name|task
argument_list|,
literal|0
argument_list|,
name|ata_sata_phy_event
argument_list|,
name|tp
argument_list|)
expr_stmt|;
name|taskqueue_enqueue
argument_list|(
name|taskqueue_thread
argument_list|,
operator|&
name|tp
operator|->
name|task
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ata_sata_phy_event
parameter_list|(
name|void
modifier|*
name|context
parameter_list|,
name|int
name|dummy
parameter_list|)
block|{
name|struct
name|ata_connect_task
modifier|*
name|tp
init|=
operator|(
expr|struct
name|ata_connect_task
operator|*
operator|)
name|context
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|tp
operator|->
name|dev
argument_list|)
decl_stmt|;
name|device_t
modifier|*
name|children
decl_stmt|;
name|int
name|nchildren
decl_stmt|,
name|i
decl_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|Giant
argument_list|)
expr_stmt|;
comment|/* newbus suckage it needs Giant */
if|if
condition|(
name|tp
operator|->
name|action
operator|==
name|ATA_C_ATTACH
condition|)
block|{
if|if
condition|(
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|tp
operator|->
name|dev
argument_list|,
literal|"CONNECTED\n"
argument_list|)
expr_stmt|;
name|ATA_RESET
argument_list|(
name|tp
operator|->
name|dev
argument_list|)
expr_stmt|;
name|ata_identify
argument_list|(
name|tp
operator|->
name|dev
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|tp
operator|->
name|action
operator|==
name|ATA_C_DETACH
condition|)
block|{
if|if
condition|(
operator|!
name|device_get_children
argument_list|(
name|tp
operator|->
name|dev
argument_list|,
operator|&
name|children
argument_list|,
operator|&
name|nchildren
argument_list|)
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nchildren
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|children
index|[
name|i
index|]
condition|)
name|device_delete_child
argument_list|(
name|tp
operator|->
name|dev
argument_list|,
name|children
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|children
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
block|}
name|mtx_lock
argument_list|(
operator|&
name|ch
operator|->
name|state_mtx
argument_list|)
expr_stmt|;
name|ch
operator|->
name|state
operator|=
name|ATA_IDLE
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|ch
operator|->
name|state_mtx
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|tp
operator|->
name|dev
argument_list|,
literal|"DISCONNECTED\n"
argument_list|)
expr_stmt|;
block|}
name|mtx_unlock
argument_list|(
operator|&
name|Giant
argument_list|)
expr_stmt|;
comment|/* suckage code dealt with, release Giant */
name|free
argument_list|(
name|tp
argument_list|,
name|M_ATA
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_sata_phy_reset
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|loop
decl_stmt|,
name|retry
decl_stmt|;
if|if
condition|(
operator|(
name|ATA_IDX_INL
argument_list|(
name|ch
argument_list|,
name|ATA_SCONTROL
argument_list|)
operator|&
name|ATA_SC_DET_MASK
operator|)
operator|==
name|ATA_SC_DET_IDLE
condition|)
return|return
name|ata_sata_connect
argument_list|(
name|ch
argument_list|)
return|;
for|for
control|(
name|retry
operator|=
literal|0
init|;
name|retry
operator|<
literal|10
condition|;
name|retry
operator|++
control|)
block|{
for|for
control|(
name|loop
operator|=
literal|0
init|;
name|loop
operator|<
literal|10
condition|;
name|loop
operator|++
control|)
block|{
name|ATA_IDX_OUTL
argument_list|(
name|ch
argument_list|,
name|ATA_SCONTROL
argument_list|,
name|ATA_SC_DET_RESET
argument_list|)
expr_stmt|;
name|ata_udelay
argument_list|(
literal|100
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ATA_IDX_INL
argument_list|(
name|ch
argument_list|,
name|ATA_SCONTROL
argument_list|)
operator|&
name|ATA_SC_DET_MASK
operator|)
operator|==
name|ATA_SC_DET_RESET
condition|)
break|break;
block|}
name|ata_udelay
argument_list|(
literal|5000
argument_list|)
expr_stmt|;
for|for
control|(
name|loop
operator|=
literal|0
init|;
name|loop
operator|<
literal|10
condition|;
name|loop
operator|++
control|)
block|{
name|ATA_IDX_OUTL
argument_list|(
name|ch
argument_list|,
name|ATA_SCONTROL
argument_list|,
name|ATA_SC_DET_IDLE
operator||
name|ATA_SC_IPM_DIS_PARTIAL
operator||
name|ATA_SC_IPM_DIS_SLUMBER
argument_list|)
expr_stmt|;
name|ata_udelay
argument_list|(
literal|100
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ATA_IDX_INL
argument_list|(
name|ch
argument_list|,
name|ATA_SCONTROL
argument_list|)
operator|&
name|ATA_SC_DET_MASK
operator|)
operator|==
literal|0
condition|)
return|return
name|ata_sata_connect
argument_list|(
name|ch
argument_list|)
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_sata_connect
parameter_list|(
name|struct
name|ata_channel
modifier|*
name|ch
parameter_list|)
block|{
name|u_int32_t
name|status
decl_stmt|;
name|int
name|timeout
decl_stmt|;
comment|/* wait up to 1 second for "connect well" */
for|for
control|(
name|timeout
operator|=
literal|0
init|;
name|timeout
operator|<
literal|100
condition|;
name|timeout
operator|++
control|)
block|{
name|status
operator|=
name|ATA_IDX_INL
argument_list|(
name|ch
argument_list|,
name|ATA_SSTATUS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|status
operator|&
name|ATA_SS_CONWELL_MASK
operator|)
operator|==
name|ATA_SS_CONWELL_GEN1
operator|||
operator|(
name|status
operator|&
name|ATA_SS_CONWELL_MASK
operator|)
operator|==
name|ATA_SS_CONWELL_GEN2
condition|)
break|break;
name|ata_udelay
argument_list|(
literal|10000
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|timeout
operator|>=
literal|100
condition|)
block|{
if|if
condition|(
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|ch
operator|->
name|dev
argument_list|,
literal|"SATA connect status=%08x\n"
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|ch
operator|->
name|dev
argument_list|,
literal|"SATA connect time=%dms\n"
argument_list|,
name|timeout
operator|*
literal|10
argument_list|)
expr_stmt|;
comment|/* clear SATA error register */
name|ATA_IDX_OUTL
argument_list|(
name|ch
argument_list|,
name|ATA_SERROR
argument_list|,
name|ATA_IDX_INL
argument_list|(
name|ch
argument_list|,
name|ATA_SERROR
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_sata_setmode
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|struct
name|ata_device
modifier|*
name|atadev
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
comment|/*      * if we detect that the device isn't a real SATA device we limit       * the transfer mode to UDMA5/ATA100.      * this works around the problems some devices has with the       * Marvell 88SX8030 SATA->PATA converters and UDMA6/ATA133.      */
if|if
condition|(
name|atadev
operator|->
name|param
operator|.
name|satacapabilities
operator|!=
literal|0x0000
operator|&&
name|atadev
operator|->
name|param
operator|.
name|satacapabilities
operator|!=
literal|0xffff
condition|)
block|{
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
comment|/* on some drives we need to set the transfer mode */
name|ata_controlcmd
argument_list|(
name|dev
argument_list|,
name|ATA_SETFEATURES
argument_list|,
name|ATA_SF_SETXFER
argument_list|,
literal|0
argument_list|,
name|ata_limit_mode
argument_list|(
name|dev
argument_list|,
name|mode
argument_list|,
name|ATA_UDMA6
argument_list|)
argument_list|)
expr_stmt|;
comment|/* query SATA STATUS for the speed */
if|if
condition|(
name|ch
operator|->
name|r_io
index|[
name|ATA_SSTATUS
index|]
operator|.
name|res
operator|&&
operator|(
operator|(
name|ATA_IDX_INL
argument_list|(
name|ch
argument_list|,
name|ATA_SSTATUS
argument_list|)
operator|&
name|ATA_SS_CONWELL_MASK
operator|)
operator|==
name|ATA_SS_CONWELL_GEN2
operator|)
condition|)
name|atadev
operator|->
name|mode
operator|=
name|ATA_SA300
expr_stmt|;
else|else
name|atadev
operator|->
name|mode
operator|=
name|ATA_SA150
expr_stmt|;
block|}
else|else
block|{
name|mode
operator|=
name|ata_limit_mode
argument_list|(
name|dev
argument_list|,
name|mode
argument_list|,
name|ATA_UDMA5
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ata_controlcmd
argument_list|(
name|dev
argument_list|,
name|ATA_SETFEATURES
argument_list|,
name|ATA_SF_SETXFER
argument_list|,
literal|0
argument_list|,
name|mode
argument_list|)
condition|)
name|atadev
operator|->
name|mode
operator|=
name|mode
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|ata_request2fis_h2d
parameter_list|(
name|struct
name|ata_request
modifier|*
name|request
parameter_list|,
name|u_int8_t
modifier|*
name|fis
parameter_list|)
block|{
name|struct
name|ata_device
modifier|*
name|atadev
init|=
name|device_get_softc
argument_list|(
name|request
operator|->
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|request
operator|->
name|flags
operator|&
name|ATA_R_ATAPI
condition|)
block|{
name|fis
index|[
literal|0
index|]
operator|=
literal|0x27
expr_stmt|;
comment|/* host to device */
name|fis
index|[
literal|1
index|]
operator|=
literal|0x80
expr_stmt|;
comment|/* command FIS (note PM goes here) */
name|fis
index|[
literal|2
index|]
operator|=
name|ATA_PACKET_CMD
expr_stmt|;
if|if
condition|(
name|request
operator|->
name|flags
operator|&
operator|(
name|ATA_R_READ
operator||
name|ATA_R_WRITE
operator|)
condition|)
name|fis
index|[
literal|3
index|]
operator|=
name|ATA_F_DMA
expr_stmt|;
else|else
block|{
name|fis
index|[
literal|5
index|]
operator|=
name|request
operator|->
name|transfersize
expr_stmt|;
name|fis
index|[
literal|6
index|]
operator|=
name|request
operator|->
name|transfersize
operator|>>
literal|8
expr_stmt|;
block|}
name|fis
index|[
literal|7
index|]
operator|=
name|ATA_D_LBA
operator||
name|atadev
operator|->
name|unit
expr_stmt|;
name|fis
index|[
literal|15
index|]
operator|=
name|ATA_A_4BIT
expr_stmt|;
return|return
literal|20
return|;
block|}
else|else
block|{
name|ata_modify_if_48bit
argument_list|(
name|request
argument_list|)
expr_stmt|;
name|fis
index|[
literal|0
index|]
operator|=
literal|0x27
expr_stmt|;
comment|/* host to device */
name|fis
index|[
literal|1
index|]
operator|=
literal|0x80
expr_stmt|;
comment|/* command FIS (note PM goes here) */
name|fis
index|[
literal|2
index|]
operator|=
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|command
expr_stmt|;
name|fis
index|[
literal|3
index|]
operator|=
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|feature
expr_stmt|;
name|fis
index|[
literal|4
index|]
operator|=
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
expr_stmt|;
name|fis
index|[
literal|5
index|]
operator|=
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|>>
literal|8
expr_stmt|;
name|fis
index|[
literal|6
index|]
operator|=
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|>>
literal|16
expr_stmt|;
name|fis
index|[
literal|7
index|]
operator|=
name|ATA_D_LBA
operator||
name|atadev
operator|->
name|unit
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|atadev
operator|->
name|flags
operator|&
name|ATA_D_48BIT_ACTIVE
operator|)
condition|)
name|fis
index|[
literal|7
index|]
operator||=
operator|(
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|>>
literal|24
operator|&
literal|0x0f
operator|)
expr_stmt|;
name|fis
index|[
literal|8
index|]
operator|=
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|>>
literal|24
expr_stmt|;
name|fis
index|[
literal|9
index|]
operator|=
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|>>
literal|32
expr_stmt|;
name|fis
index|[
literal|10
index|]
operator|=
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|>>
literal|40
expr_stmt|;
name|fis
index|[
literal|11
index|]
operator|=
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|feature
operator|>>
literal|8
expr_stmt|;
name|fis
index|[
literal|12
index|]
operator|=
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|count
expr_stmt|;
name|fis
index|[
literal|13
index|]
operator|=
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|count
operator|>>
literal|8
expr_stmt|;
name|fis
index|[
literal|15
index|]
operator|=
name|ATA_A_4BIT
expr_stmt|;
return|return
literal|20
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * AHCI v1.x compliant SATA chipset support functions  */
end_comment

begin_function
name|int
name|ata_ahci_ident
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|char
name|buffer
index|[
literal|64
index|]
decl_stmt|;
comment|/* is this PCI device flagged as an AHCI compliant chip ? */
if|if
condition|(
name|pci_read_config
argument_list|(
name|dev
argument_list|,
name|PCIR_PROGIF
argument_list|,
literal|1
argument_list|)
operator|!=
name|PCIP_STORAGE_SATA_AHCI_1_0
condition|)
return|return
name|ENXIO
return|;
if|if
condition|(
name|bootverbose
condition|)
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"%s (ID=%08x) AHCI controller"
argument_list|,
name|ata_pcivendor2str
argument_list|(
name|dev
argument_list|)
argument_list|,
name|pci_get_devid
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"%s AHCI controller"
argument_list|,
name|ata_pcivendor2str
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
name|device_set_desc_copy
argument_list|(
name|dev
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|chipinit
operator|=
name|ata_ahci_chipinit
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_ahci_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|u_int32_t
name|version
decl_stmt|;
comment|/* if we have a memory BAR(5) we are likely on an AHCI part */
name|ctlr
operator|->
name|r_type2
operator|=
name|SYS_RES_MEMORY
expr_stmt|;
name|ctlr
operator|->
name|r_rid2
operator|=
name|PCIR_BAR
argument_list|(
literal|5
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ctlr
operator|->
name|r_res2
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|ctlr
operator|->
name|r_type2
argument_list|,
operator|&
name|ctlr
operator|->
name|r_rid2
argument_list|,
name|RF_ACTIVE
argument_list|)
operator|)
condition|)
return|return
name|ENXIO
return|;
comment|/* setup interrupt delivery if not done allready by a vendor driver */
if|if
condition|(
operator|!
name|ctlr
operator|->
name|r_irq
condition|)
block|{
if|if
condition|(
name|ata_setup_interrupt
argument_list|(
name|dev
argument_list|)
condition|)
return|return
name|ENXIO
return|;
block|}
else|else
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"AHCI called from vendor specific driver\n"
argument_list|)
expr_stmt|;
comment|/* enable AHCI mode */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|ATA_AHCI_GHC
argument_list|,
name|ATA_AHCI_GHC_AE
argument_list|)
expr_stmt|;
comment|/* reset AHCI controller */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|ATA_AHCI_GHC
argument_list|,
name|ATA_AHCI_GHC_HR
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1000000
argument_list|)
expr_stmt|;
if|if
condition|(
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|ATA_AHCI_GHC
argument_list|)
operator|&
name|ATA_AHCI_GHC_HR
condition|)
block|{
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|ctlr
operator|->
name|r_type2
argument_list|,
name|ctlr
operator|->
name|r_rid2
argument_list|,
name|ctlr
operator|->
name|r_res2
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"AHCI controller reset failure\n"
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
comment|/* reenable AHCI mode */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|ATA_AHCI_GHC
argument_list|,
name|ATA_AHCI_GHC_AE
argument_list|)
expr_stmt|;
comment|/* get the number of HW channels */
name|ctlr
operator|->
name|channels
operator|=
name|MAX
argument_list|(
name|flsl
argument_list|(
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|ATA_AHCI_PI
argument_list|)
argument_list|)
argument_list|,
operator|(
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|ATA_AHCI_CAP
argument_list|)
operator|&
name|ATA_AHCI_NPMASK
operator|)
operator|+
literal|1
argument_list|)
expr_stmt|;
comment|/* clear interrupts */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|ATA_AHCI_IS
argument_list|,
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|ATA_AHCI_IS
argument_list|)
argument_list|)
expr_stmt|;
comment|/* enable AHCI interrupts */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|ATA_AHCI_GHC
argument_list|,
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|ATA_AHCI_GHC
argument_list|)
operator||
name|ATA_AHCI_GHC_IE
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|reset
operator|=
name|ata_ahci_reset
expr_stmt|;
name|ctlr
operator|->
name|dmainit
operator|=
name|ata_ahci_dmainit
expr_stmt|;
name|ctlr
operator|->
name|allocate
operator|=
name|ata_ahci_allocate
expr_stmt|;
name|ctlr
operator|->
name|setmode
operator|=
name|ata_sata_setmode
expr_stmt|;
comment|/* announce we support the HW */
name|version
operator|=
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|ATA_AHCI_VS
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"AHCI Version %x%x.%x%x controller with %d ports detected\n"
argument_list|,
operator|(
name|version
operator|>>
literal|24
operator|)
operator|&
literal|0xff
argument_list|,
operator|(
name|version
operator|>>
literal|16
operator|)
operator|&
literal|0xff
argument_list|,
operator|(
name|version
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|,
name|version
operator|&
literal|0xff
argument_list|,
operator|(
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|ATA_AHCI_CAP
argument_list|)
operator|&
name|ATA_AHCI_NPMASK
operator|)
operator|+
literal|1
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_ahci_allocate
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|u_int64_t
name|work
decl_stmt|;
name|int
name|offset
init|=
name|ch
operator|->
name|unit
operator|<<
literal|7
decl_stmt|;
comment|/* set the SATA resources */
name|ch
operator|->
name|r_io
index|[
name|ATA_SSTATUS
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_res2
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SSTATUS
index|]
operator|.
name|offset
operator|=
name|ATA_AHCI_P_SSTS
operator|+
name|offset
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SERROR
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_res2
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SERROR
index|]
operator|.
name|offset
operator|=
name|ATA_AHCI_P_SERR
operator|+
name|offset
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SCONTROL
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_res2
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SCONTROL
index|]
operator|.
name|offset
operator|=
name|ATA_AHCI_P_SCTL
operator|+
name|offset
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SACTIVE
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_res2
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SACTIVE
index|]
operator|.
name|offset
operator|=
name|ATA_AHCI_P_SACT
operator|+
name|offset
expr_stmt|;
name|ch
operator|->
name|hw
operator|.
name|status
operator|=
name|ata_ahci_status
expr_stmt|;
name|ch
operator|->
name|hw
operator|.
name|begin_transaction
operator|=
name|ata_ahci_begin_transaction
expr_stmt|;
name|ch
operator|->
name|hw
operator|.
name|end_transaction
operator|=
name|ata_ahci_end_transaction
expr_stmt|;
name|ch
operator|->
name|hw
operator|.
name|command
operator|=
name|NULL
expr_stmt|;
comment|/* not used here */
comment|/* setup work areas */
name|work
operator|=
name|ch
operator|->
name|dma
operator|->
name|work_bus
operator|+
name|ATA_AHCI_CL_OFFSET
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|ATA_AHCI_P_CLB
operator|+
name|offset
argument_list|,
name|work
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|ATA_AHCI_P_CLBU
operator|+
name|offset
argument_list|,
name|work
operator|>>
literal|32
argument_list|)
expr_stmt|;
name|work
operator|=
name|ch
operator|->
name|dma
operator|->
name|work_bus
operator|+
name|ATA_AHCI_FB_OFFSET
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|ATA_AHCI_P_FB
operator|+
name|offset
argument_list|,
name|work
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|ATA_AHCI_P_FBU
operator|+
name|offset
argument_list|,
name|work
operator|>>
literal|32
argument_list|)
expr_stmt|;
comment|/* enable wanted port interrupts */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|ATA_AHCI_P_IE
operator|+
name|offset
argument_list|,
operator|(
name|ATA_AHCI_P_IX_CPD
operator||
name|ATA_AHCI_P_IX_TFE
operator||
name|ATA_AHCI_P_IX_HBF
operator||
name|ATA_AHCI_P_IX_HBD
operator||
name|ATA_AHCI_P_IX_IF
operator||
name|ATA_AHCI_P_IX_OF
operator||
name|ATA_AHCI_P_IX_PRC
operator||
name|ATA_AHCI_P_IX_PC
operator||
name|ATA_AHCI_P_IX_DP
operator||
name|ATA_AHCI_P_IX_UF
operator||
name|ATA_AHCI_P_IX_SDB
operator||
name|ATA_AHCI_P_IX_DS
operator||
name|ATA_AHCI_P_IX_PS
operator||
name|ATA_AHCI_P_IX_DHR
operator|)
argument_list|)
expr_stmt|;
comment|/* start operations on this channel */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|ATA_AHCI_P_CMD
operator|+
name|offset
argument_list|,
operator|(
name|ATA_AHCI_P_CMD_ACTIVE
operator||
name|ATA_AHCI_P_CMD_FRE
operator||
name|ATA_AHCI_P_CMD_POD
operator||
name|ATA_AHCI_P_CMD_SUD
operator||
name|ATA_AHCI_P_CMD_ST
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_ahci_status
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|u_int32_t
name|action
init|=
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|ATA_AHCI_IS
argument_list|)
decl_stmt|;
name|int
name|offset
init|=
name|ch
operator|->
name|unit
operator|<<
literal|7
decl_stmt|;
name|int
name|tag
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|action
operator|&
operator|(
literal|1
operator|<<
name|ch
operator|->
name|unit
operator|)
condition|)
block|{
name|u_int32_t
name|istatus
init|=
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|ATA_AHCI_P_IS
operator|+
name|offset
argument_list|)
decl_stmt|;
name|u_int32_t
name|cstatus
init|=
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|ATA_AHCI_P_CI
operator|+
name|offset
argument_list|)
decl_stmt|;
comment|/* clear interrupt(s) */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|ATA_AHCI_IS
argument_list|,
name|action
operator|&
operator|(
literal|1
operator|<<
name|ch
operator|->
name|unit
operator|)
argument_list|)
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|ATA_AHCI_P_IS
operator|+
name|offset
argument_list|,
name|istatus
argument_list|)
expr_stmt|;
comment|/* do we have any PHY events ? */
comment|/* XXX SOS check istatus phy bits */
name|ata_sata_phy_check_events
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* do we have a potentially hanging engine to take care of? */
if|if
condition|(
operator|(
name|istatus
operator|&
literal|0x78400050
operator|)
operator|&&
operator|(
name|cstatus
operator|&
operator|(
literal|1
operator|<<
name|tag
operator|)
operator|)
condition|)
block|{
name|u_int32_t
name|cmd
init|=
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|ATA_AHCI_P_CMD
operator|+
name|offset
argument_list|)
decl_stmt|;
name|int
name|timeout
init|=
literal|0
decl_stmt|;
comment|/* kill off all activity on this channel */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|ATA_AHCI_P_CMD
operator|+
name|offset
argument_list|,
name|cmd
operator|&
operator|~
operator|(
name|ATA_AHCI_P_CMD_FRE
operator||
name|ATA_AHCI_P_CMD_ST
operator|)
argument_list|)
expr_stmt|;
comment|/* XXX SOS this is not entirely wrong */
do|do
block|{
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
if|if
condition|(
name|timeout
operator|++
operator|>
literal|500
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"stopping AHCI engine failed\n"
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
do|while
condition|(
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|ATA_AHCI_P_CMD
operator|+
name|offset
argument_list|)
operator|&
name|ATA_AHCI_P_CMD_CR
condition|)
do|;
comment|/* start operations on this channel */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|ATA_AHCI_P_CMD
operator|+
name|offset
argument_list|,
name|cmd
operator||
operator|(
name|ATA_AHCI_P_CMD_FRE
operator||
name|ATA_AHCI_P_CMD_ST
operator|)
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
else|else
return|return
operator|(
operator|!
operator|(
name|cstatus
operator|&
operator|(
literal|1
operator|<<
name|tag
operator|)
operator|)
operator|)
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* must be called with ATA channel locked and state_mtx held */
end_comment

begin_function
specifier|static
name|int
name|ata_ahci_begin_transaction
parameter_list|(
name|struct
name|ata_request
modifier|*
name|request
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|GRANDPARENT
argument_list|(
name|request
operator|->
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|request
operator|->
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_ahci_cmd_tab
modifier|*
name|ctp
decl_stmt|;
name|struct
name|ata_ahci_cmd_list
modifier|*
name|clp
decl_stmt|;
name|int
name|offset
init|=
name|ch
operator|->
name|unit
operator|<<
literal|7
decl_stmt|;
name|int
name|tag
init|=
literal|0
decl_stmt|,
name|entries
init|=
literal|0
decl_stmt|;
name|int
name|fis_size
decl_stmt|;
comment|/* get a piece of the workspace for this request */
name|ctp
operator|=
operator|(
expr|struct
name|ata_ahci_cmd_tab
operator|*
operator|)
operator|(
name|ch
operator|->
name|dma
operator|->
name|work
operator|+
name|ATA_AHCI_CT_OFFSET
operator|+
operator|(
name|ATA_AHCI_CT_SIZE
operator|*
name|tag
operator|)
operator|)
expr_stmt|;
comment|/* setup the FIS for this request */
if|if
condition|(
operator|!
operator|(
name|fis_size
operator|=
name|ata_ahci_setup_fis
argument_list|(
name|ctp
argument_list|,
name|request
argument_list|)
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|request
operator|->
name|dev
argument_list|,
literal|"setting up SATA FIS failed\n"
argument_list|)
expr_stmt|;
name|request
operator|->
name|result
operator|=
name|EIO
expr_stmt|;
return|return
name|ATA_OP_FINISHED
return|;
block|}
comment|/* if request moves data setup and load SG list */
if|if
condition|(
name|request
operator|->
name|flags
operator|&
operator|(
name|ATA_R_READ
operator||
name|ATA_R_WRITE
operator|)
condition|)
block|{
if|if
condition|(
name|ch
operator|->
name|dma
operator|->
name|load
argument_list|(
name|ch
operator|->
name|dev
argument_list|,
name|request
operator|->
name|data
argument_list|,
name|request
operator|->
name|bytecount
argument_list|,
name|request
operator|->
name|flags
operator|&
name|ATA_R_READ
argument_list|,
name|ctp
operator|->
name|prd_tab
argument_list|,
operator|&
name|entries
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|request
operator|->
name|dev
argument_list|,
literal|"setting up DMA failed\n"
argument_list|)
expr_stmt|;
name|request
operator|->
name|result
operator|=
name|EIO
expr_stmt|;
return|return
name|ATA_OP_FINISHED
return|;
block|}
block|}
comment|/* setup the command list entry */
name|clp
operator|=
operator|(
expr|struct
name|ata_ahci_cmd_list
operator|*
operator|)
operator|(
name|ch
operator|->
name|dma
operator|->
name|work
operator|+
name|ATA_AHCI_CL_OFFSET
operator|+
operator|(
name|ATA_AHCI_CL_SIZE
operator|*
name|tag
operator|)
operator|)
expr_stmt|;
name|clp
operator|->
name|prd_length
operator|=
name|entries
expr_stmt|;
name|clp
operator|->
name|cmd_flags
operator|=
operator|(
name|request
operator|->
name|flags
operator|&
name|ATA_R_WRITE
condition|?
operator|(
literal|1
operator|<<
literal|6
operator|)
else|:
literal|0
operator|)
operator||
operator|(
name|request
operator|->
name|flags
operator|&
name|ATA_R_ATAPI
condition|?
operator|(
operator|(
literal|1
operator|<<
literal|5
operator|)
operator||
operator|(
literal|1
operator|<<
literal|7
operator|)
operator|)
else|:
literal|0
operator|)
operator||
operator|(
name|fis_size
operator|/
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
operator|)
expr_stmt|;
name|clp
operator|->
name|bytecount
operator|=
literal|0
expr_stmt|;
name|clp
operator|->
name|cmd_table_phys
operator|=
name|htole64
argument_list|(
name|ch
operator|->
name|dma
operator|->
name|work_bus
operator|+
name|ATA_AHCI_CT_OFFSET
operator|+
operator|(
name|ATA_AHCI_CT_SIZE
operator|*
name|tag
operator|)
argument_list|)
expr_stmt|;
comment|/* clear eventual ACTIVE bit */
name|ATA_IDX_OUTL
argument_list|(
name|ch
argument_list|,
name|ATA_SACTIVE
argument_list|,
name|ATA_IDX_INL
argument_list|(
name|ch
argument_list|,
name|ATA_SACTIVE
argument_list|)
operator|&
operator|(
literal|1
operator|<<
name|tag
operator|)
argument_list|)
expr_stmt|;
comment|/* set command type bit */
if|if
condition|(
name|request
operator|->
name|flags
operator|&
name|ATA_R_ATAPI
condition|)
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|ATA_AHCI_P_CMD
operator|+
name|offset
argument_list|,
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|ATA_AHCI_P_CMD
operator|+
name|offset
argument_list|)
operator||
name|ATA_AHCI_P_CMD_ATAPI
argument_list|)
expr_stmt|;
else|else
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|ATA_AHCI_P_CMD
operator|+
name|offset
argument_list|,
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|ATA_AHCI_P_CMD
operator|+
name|offset
argument_list|)
operator|&
operator|~
name|ATA_AHCI_P_CMD_ATAPI
argument_list|)
expr_stmt|;
comment|/* issue command to controller */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|ATA_AHCI_P_CI
operator|+
name|offset
argument_list|,
operator|(
literal|1
operator|<<
name|tag
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|request
operator|->
name|flags
operator|&
name|ATA_R_ATAPI
operator|)
condition|)
block|{
comment|/* device reset doesn't interrupt */
if|if
condition|(
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|command
operator|==
name|ATA_DEVICE_RESET
condition|)
block|{
name|u_int32_t
name|tf_data
decl_stmt|;
name|int
name|timeout
init|=
literal|1000000
decl_stmt|;
do|do
block|{
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|tf_data
operator|=
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|ATA_AHCI_P_TFD
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|7
operator|)
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
operator|(
name|tf_data
operator|&
name|ATA_S_BUSY
operator|)
operator|&&
name|timeout
operator|--
condition|)
do|;
if|if
condition|(
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|ch
operator|->
name|dev
argument_list|,
literal|"device_reset timeout=%dus\n"
argument_list|,
operator|(
literal|1000000
operator|-
name|timeout
operator|)
operator|*
literal|10
argument_list|)
expr_stmt|;
name|request
operator|->
name|status
operator|=
name|tf_data
expr_stmt|;
if|if
condition|(
name|request
operator|->
name|status
operator|&
name|ATA_S_ERROR
condition|)
name|request
operator|->
name|error
operator|=
name|tf_data
operator|>>
literal|8
expr_stmt|;
return|return
name|ATA_OP_FINISHED
return|;
block|}
block|}
comment|/* start the timeout */
name|callout_reset
argument_list|(
operator|&
name|request
operator|->
name|callout
argument_list|,
name|request
operator|->
name|timeout
operator|*
name|hz
argument_list|,
operator|(
name|timeout_t
operator|*
operator|)
name|ata_timeout
argument_list|,
name|request
argument_list|)
expr_stmt|;
return|return
name|ATA_OP_CONTINUES
return|;
block|}
end_function

begin_comment
comment|/* must be called with ATA channel locked and state_mtx held */
end_comment

begin_function
specifier|static
name|int
name|ata_ahci_end_transaction
parameter_list|(
name|struct
name|ata_request
modifier|*
name|request
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|GRANDPARENT
argument_list|(
name|request
operator|->
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|request
operator|->
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_ahci_cmd_list
modifier|*
name|clp
decl_stmt|;
name|u_int32_t
name|tf_data
decl_stmt|;
name|int
name|offset
init|=
name|ch
operator|->
name|unit
operator|<<
literal|7
decl_stmt|;
name|int
name|tag
init|=
literal|0
decl_stmt|;
comment|/* kill the timeout */
name|callout_stop
argument_list|(
operator|&
name|request
operator|->
name|callout
argument_list|)
expr_stmt|;
comment|/* get status */
name|tf_data
operator|=
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|ATA_AHCI_P_TFD
operator|+
name|offset
argument_list|)
expr_stmt|;
name|request
operator|->
name|status
operator|=
name|tf_data
expr_stmt|;
comment|/* if error status get details */
if|if
condition|(
name|request
operator|->
name|status
operator|&
name|ATA_S_ERROR
condition|)
name|request
operator|->
name|error
operator|=
name|tf_data
operator|>>
literal|8
expr_stmt|;
comment|/* record how much data we actually moved */
name|clp
operator|=
operator|(
expr|struct
name|ata_ahci_cmd_list
operator|*
operator|)
operator|(
name|ch
operator|->
name|dma
operator|->
name|work
operator|+
name|ATA_AHCI_CL_OFFSET
operator|+
operator|(
name|ATA_AHCI_CL_SIZE
operator|*
name|tag
operator|)
operator|)
expr_stmt|;
name|request
operator|->
name|donecount
operator|=
name|clp
operator|->
name|bytecount
expr_stmt|;
comment|/* release SG list etc */
name|ch
operator|->
name|dma
operator|->
name|unload
argument_list|(
name|ch
operator|->
name|dev
argument_list|)
expr_stmt|;
return|return
name|ATA_OP_FINISHED
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_ahci_reset
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|u_int32_t
name|cmd
decl_stmt|,
name|signature
decl_stmt|;
name|int
name|offset
init|=
name|ch
operator|->
name|unit
operator|<<
literal|7
decl_stmt|;
name|int
name|timeout
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|ATA_AHCI_PI
argument_list|)
operator|&
operator|(
literal|1
operator|<<
name|ch
operator|->
name|unit
operator|)
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"port not implemented\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|ch
operator|->
name|devices
operator|=
literal|0
expr_stmt|;
comment|/* kill off all activity on this channel */
name|cmd
operator|=
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|ATA_AHCI_P_CMD
operator|+
name|offset
argument_list|)
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|ATA_AHCI_P_CMD
operator|+
name|offset
argument_list|,
name|cmd
operator|&
operator|~
operator|(
name|ATA_AHCI_P_CMD_FRE
operator||
name|ATA_AHCI_P_CMD_ST
operator|)
argument_list|)
expr_stmt|;
comment|/* XXX SOS this is not entirely wrong */
name|timeout
operator|=
literal|0
expr_stmt|;
do|do
block|{
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
if|if
condition|(
name|timeout
operator|++
operator|>
literal|500
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"stopping AHCI engine failed\n"
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
do|while
condition|(
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|ATA_AHCI_P_CMD
operator|+
name|offset
argument_list|)
operator|&
name|ATA_AHCI_P_CMD_CR
condition|)
do|;
comment|/* issue Command List Override if supported */
if|if
condition|(
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|ATA_AHCI_CAP
argument_list|)
operator|&
name|ATA_AHCI_CAP_CLO
condition|)
block|{
name|cmd
operator|=
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|ATA_AHCI_P_CMD
operator|+
name|offset
argument_list|)
expr_stmt|;
name|cmd
operator||=
name|ATA_AHCI_P_CMD_CLO
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|ATA_AHCI_P_CMD
operator|+
name|offset
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
name|timeout
operator|=
literal|0
expr_stmt|;
do|do
block|{
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
if|if
condition|(
name|timeout
operator|++
operator|>
literal|500
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"executing CLO failed\n"
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
do|while
condition|(
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|ATA_AHCI_P_CMD
operator|+
name|offset
argument_list|)
operator|&
name|ATA_AHCI_P_CMD_CLO
condition|)
do|;
block|}
comment|/* reset PHY and decide what is present */
if|if
condition|(
name|ata_sata_phy_reset
argument_list|(
name|dev
argument_list|)
condition|)
block|{
comment|/* clear any interrupts pending on this channel */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|ATA_AHCI_P_IS
operator|+
name|offset
argument_list|,
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|ATA_AHCI_P_IS
operator|+
name|offset
argument_list|)
argument_list|)
expr_stmt|;
comment|/* clear SATA error register */
name|ATA_IDX_OUTL
argument_list|(
name|ch
argument_list|,
name|ATA_SERROR
argument_list|,
name|ATA_IDX_INL
argument_list|(
name|ch
argument_list|,
name|ATA_SERROR
argument_list|)
argument_list|)
expr_stmt|;
comment|/* start operations on this channel */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|ATA_AHCI_P_CMD
operator|+
name|offset
argument_list|,
operator|(
name|ATA_AHCI_P_CMD_ACTIVE
operator||
name|ATA_AHCI_P_CMD_FRE
operator||
name|ATA_AHCI_P_CMD_POD
operator||
name|ATA_AHCI_P_CMD_SUD
operator||
name|ATA_AHCI_P_CMD_ST
operator|)
argument_list|)
expr_stmt|;
name|signature
operator|=
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|ATA_AHCI_P_SIG
operator|+
name|offset
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"SIGNATURE: %08x\n"
argument_list|,
name|signature
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|signature
condition|)
block|{
case|case
literal|0x00000101
case|:
name|ch
operator|->
name|devices
operator|=
name|ATA_ATA_MASTER
expr_stmt|;
break|break;
case|case
literal|0x96690101
case|:
name|ch
operator|->
name|devices
operator|=
name|ATA_PORTMULTIPLIER
expr_stmt|;
name|device_printf
argument_list|(
name|ch
operator|->
name|dev
argument_list|,
literal|"Portmultipliers not supported yet\n"
argument_list|)
expr_stmt|;
name|ch
operator|->
name|devices
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|0xeb140101
case|:
name|ch
operator|->
name|devices
operator|=
name|ATA_ATAPI_MASTER
expr_stmt|;
break|break;
default|default:
comment|/* SOS XXX */
if|if
condition|(
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|ch
operator|->
name|dev
argument_list|,
literal|"No signature, asuming disk device\n"
argument_list|)
expr_stmt|;
name|ch
operator|->
name|devices
operator|=
name|ATA_ATA_MASTER
expr_stmt|;
block|}
block|}
if|if
condition|(
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"ahci_reset devices=0x%b\n"
argument_list|,
name|ch
operator|->
name|devices
argument_list|,
literal|"\20\4ATAPI_SLAVE\3ATAPI_MASTER\2ATA_SLAVE\1ATA_MASTER"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_ahci_dmasetprd
parameter_list|(
name|void
modifier|*
name|xsc
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|segs
parameter_list|,
name|int
name|nsegs
parameter_list|,
name|int
name|error
parameter_list|)
block|{
name|struct
name|ata_dmasetprd_args
modifier|*
name|args
init|=
name|xsc
decl_stmt|;
name|struct
name|ata_ahci_dma_prd
modifier|*
name|prd
init|=
name|args
operator|->
name|dmatab
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|args
operator|->
name|error
operator|=
name|error
operator|)
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nsegs
condition|;
name|i
operator|++
control|)
block|{
name|prd
index|[
name|i
index|]
operator|.
name|dba
operator|=
name|htole64
argument_list|(
name|segs
index|[
name|i
index|]
operator|.
name|ds_addr
argument_list|)
expr_stmt|;
name|prd
index|[
name|i
index|]
operator|.
name|dbc
operator|=
name|htole32
argument_list|(
operator|(
name|segs
index|[
name|i
index|]
operator|.
name|ds_len
operator|-
literal|1
operator|)
operator|&
name|ATA_AHCI_PRD_MASK
argument_list|)
expr_stmt|;
block|}
block|}
name|KASSERT
argument_list|(
name|nsegs
operator|<=
name|ATA_DMA_ENTRIES
argument_list|,
operator|(
literal|"too many DMA segment entries\n"
operator|)
argument_list|)
expr_stmt|;
name|args
operator|->
name|nsegs
operator|=
name|nsegs
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_ahci_dmainit
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|ata_dmainit
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|ch
operator|->
name|dma
condition|)
block|{
comment|/* note start and stop are not used here */
name|ch
operator|->
name|dma
operator|->
name|setprd
operator|=
name|ata_ahci_dmasetprd
expr_stmt|;
name|ch
operator|->
name|dma
operator|->
name|max_iosize
operator|=
literal|8192
operator|*
name|DEV_BSIZE
expr_stmt|;
if|if
condition|(
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|ATA_AHCI_CAP
argument_list|)
operator|&
name|ATA_AHCI_CAP_64BIT
condition|)
name|ch
operator|->
name|dma
operator|->
name|max_address
operator|=
name|BUS_SPACE_MAXADDR
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|ata_ahci_setup_fis
parameter_list|(
name|struct
name|ata_ahci_cmd_tab
modifier|*
name|ctp
parameter_list|,
name|struct
name|ata_request
modifier|*
name|request
parameter_list|)
block|{
name|bzero
argument_list|(
name|ctp
operator|->
name|cfis
argument_list|,
literal|64
argument_list|)
expr_stmt|;
if|if
condition|(
name|request
operator|->
name|flags
operator|&
name|ATA_R_ATAPI
condition|)
block|{
name|bzero
argument_list|(
name|ctp
operator|->
name|acmd
argument_list|,
literal|32
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|request
operator|->
name|u
operator|.
name|atapi
operator|.
name|ccb
argument_list|,
name|ctp
operator|->
name|acmd
argument_list|,
literal|16
argument_list|)
expr_stmt|;
block|}
return|return
name|ata_request2fis_h2d
argument_list|(
name|request
argument_list|,
operator|&
name|ctp
operator|->
name|cfis
index|[
literal|0
index|]
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  * Acard chipset support functions  */
end_comment

begin_function
name|int
name|ata_acard_ident
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
specifier|static
name|struct
name|ata_chip_id
name|ids
index|[]
init|=
block|{
block|{
name|ATA_ATP850R
block|,
literal|0
block|,
name|ATPOLD
block|,
literal|0x00
block|,
name|ATA_UDMA2
block|,
literal|"ATP850"
block|}
block|,
block|{
name|ATA_ATP860A
block|,
literal|0
block|,
literal|0
block|,
literal|0x00
block|,
name|ATA_UDMA4
block|,
literal|"ATP860A"
block|}
block|,
block|{
name|ATA_ATP860R
block|,
literal|0
block|,
literal|0
block|,
literal|0x00
block|,
name|ATA_UDMA4
block|,
literal|"ATP860R"
block|}
block|,
block|{
name|ATA_ATP865A
block|,
literal|0
block|,
literal|0
block|,
literal|0x00
block|,
name|ATA_UDMA6
block|,
literal|"ATP865A"
block|}
block|,
block|{
name|ATA_ATP865R
block|,
literal|0
block|,
literal|0
block|,
literal|0x00
block|,
name|ATA_UDMA6
block|,
literal|"ATP865R"
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|ctlr
operator|->
name|chip
operator|=
name|ata_match_chip
argument_list|(
name|dev
argument_list|,
name|ids
argument_list|)
operator|)
condition|)
return|return
name|ENXIO
return|;
name|ata_set_desc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|chipinit
operator|=
name|ata_acard_chipinit
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_acard_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ata_serialize
modifier|*
name|serial
decl_stmt|;
if|if
condition|(
name|ata_setup_interrupt
argument_list|(
name|dev
argument_list|)
condition|)
return|return
name|ENXIO
return|;
name|ctlr
operator|->
name|allocate
operator|=
name|ata_acard_allocate
expr_stmt|;
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg1
operator|==
name|ATPOLD
condition|)
block|{
name|ctlr
operator|->
name|setmode
operator|=
name|ata_acard_850_setmode
expr_stmt|;
name|ctlr
operator|->
name|locking
operator|=
name|ata_serialize
expr_stmt|;
name|serial
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|ata_serialize
argument_list|)
argument_list|,
name|M_TEMP
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|ata_serialize_init
argument_list|(
name|serial
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|chipset_data
operator|=
name|serial
expr_stmt|;
block|}
else|else
name|ctlr
operator|->
name|setmode
operator|=
name|ata_acard_86X_setmode
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_acard_allocate
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
comment|/* setup the usual register normal pci style */
if|if
condition|(
name|ata_pci_allocate
argument_list|(
name|dev
argument_list|)
condition|)
return|return
name|ENXIO
return|;
name|ch
operator|->
name|hw
operator|.
name|status
operator|=
name|ata_acard_status
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_acard_status
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg1
operator|==
name|ATPOLD
operator|&&
name|ATA_LOCKING
argument_list|(
name|ch
operator|->
name|dev
argument_list|,
name|ATA_LF_WHICH
argument_list|)
operator|!=
name|ch
operator|->
name|unit
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|ch
operator|->
name|dma
operator|&&
operator|(
name|ch
operator|->
name|dma
operator|->
name|flags
operator|&
name|ATA_DMA_ACTIVE
operator|)
condition|)
block|{
name|int
name|bmstat
init|=
name|ATA_IDX_INB
argument_list|(
name|ch
argument_list|,
name|ATA_BMSTAT_PORT
argument_list|)
operator|&
name|ATA_BMSTAT_MASK
decl_stmt|;
if|if
condition|(
operator|(
name|bmstat
operator|&
operator|(
name|ATA_BMSTAT_ACTIVE
operator||
name|ATA_BMSTAT_INTERRUPT
operator|)
operator|)
operator|!=
name|ATA_BMSTAT_INTERRUPT
condition|)
return|return
literal|0
return|;
name|ATA_IDX_OUTB
argument_list|(
name|ch
argument_list|,
name|ATA_BMSTAT_PORT
argument_list|,
name|bmstat
operator|&
operator|~
name|ATA_BMSTAT_ERROR
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|ATA_IDX_OUTB
argument_list|(
name|ch
argument_list|,
name|ATA_BMCMD_PORT
argument_list|,
name|ATA_IDX_INB
argument_list|(
name|ch
argument_list|,
name|ATA_BMCMD_PORT
argument_list|)
operator|&
operator|~
name|ATA_BMCMD_START_STOP
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ATA_IDX_INB
argument_list|(
name|ch
argument_list|,
name|ATA_ALTSTAT
argument_list|)
operator|&
name|ATA_S_BUSY
condition|)
block|{
name|DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
if|if
condition|(
name|ATA_IDX_INB
argument_list|(
name|ch
argument_list|,
name|ATA_ALTSTAT
argument_list|)
operator|&
name|ATA_S_BUSY
condition|)
return|return
literal|0
return|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_acard_850_setmode
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|device_t
name|gparent
init|=
name|GRANDPARENT
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|gparent
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_device
modifier|*
name|atadev
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|devno
init|=
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|1
operator|)
operator|+
name|ATA_DEV
argument_list|(
name|atadev
operator|->
name|unit
argument_list|)
decl_stmt|;
name|int
name|error
decl_stmt|;
name|mode
operator|=
name|ata_limit_mode
argument_list|(
name|dev
argument_list|,
name|mode
argument_list|,
name|ata_atapi
argument_list|(
name|dev
argument_list|)
condition|?
name|ATA_PIO_MAX
else|:
name|ctlr
operator|->
name|chip
operator|->
name|max_dma
argument_list|)
expr_stmt|;
comment|/* XXX SOS missing WDMA0+1 + PIO modes */
if|if
condition|(
name|mode
operator|>=
name|ATA_WDMA2
condition|)
block|{
name|error
operator|=
name|ata_controlcmd
argument_list|(
name|dev
argument_list|,
name|ATA_SETFEATURES
argument_list|,
name|ATA_SF_SETXFER
argument_list|,
literal|0
argument_list|,
name|mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%ssetting %s on %s chip\n"
argument_list|,
operator|(
name|error
operator|)
condition|?
literal|"FAILURE "
else|:
literal|""
argument_list|,
name|ata_mode2str
argument_list|(
name|mode
argument_list|)
argument_list|,
name|ctlr
operator|->
name|chip
operator|->
name|text
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
block|{
name|u_int8_t
name|reg54
init|=
name|pci_read_config
argument_list|(
name|gparent
argument_list|,
literal|0x54
argument_list|,
literal|1
argument_list|)
decl_stmt|;
name|reg54
operator|&=
operator|~
operator|(
literal|0x03
operator|<<
operator|(
name|devno
operator|<<
literal|1
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|mode
operator|>=
name|ATA_UDMA0
condition|)
name|reg54
operator||=
operator|(
operator|(
operator|(
name|mode
operator|&
name|ATA_MODE_MASK
operator|)
operator|+
literal|1
operator|)
operator|<<
operator|(
name|devno
operator|<<
literal|1
operator|)
operator|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
literal|0x54
argument_list|,
name|reg54
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
literal|0x4a
argument_list|,
literal|0xa6
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
literal|0x40
operator|+
operator|(
name|devno
operator|<<
literal|1
operator|)
argument_list|,
literal|0x0301
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|atadev
operator|->
name|mode
operator|=
name|mode
expr_stmt|;
return|return;
block|}
block|}
comment|/* we could set PIO mode timings, but we assume the BIOS did that */
block|}
end_function

begin_function
specifier|static
name|void
name|ata_acard_86X_setmode
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|device_t
name|gparent
init|=
name|GRANDPARENT
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|gparent
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_device
modifier|*
name|atadev
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|devno
init|=
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|1
operator|)
operator|+
name|ATA_DEV
argument_list|(
name|atadev
operator|->
name|unit
argument_list|)
decl_stmt|;
name|int
name|error
decl_stmt|;
name|mode
operator|=
name|ata_limit_mode
argument_list|(
name|dev
argument_list|,
name|mode
argument_list|,
name|ata_atapi
argument_list|(
name|dev
argument_list|)
condition|?
name|ATA_PIO_MAX
else|:
name|ctlr
operator|->
name|chip
operator|->
name|max_dma
argument_list|)
expr_stmt|;
name|mode
operator|=
name|ata_check_80pin
argument_list|(
name|dev
argument_list|,
name|mode
argument_list|)
expr_stmt|;
comment|/* XXX SOS missing WDMA0+1 + PIO modes */
if|if
condition|(
name|mode
operator|>=
name|ATA_WDMA2
condition|)
block|{
name|error
operator|=
name|ata_controlcmd
argument_list|(
name|dev
argument_list|,
name|ATA_SETFEATURES
argument_list|,
name|ATA_SF_SETXFER
argument_list|,
literal|0
argument_list|,
name|mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%ssetting %s on %s chip\n"
argument_list|,
operator|(
name|error
operator|)
condition|?
literal|"FAILURE "
else|:
literal|""
argument_list|,
name|ata_mode2str
argument_list|(
name|mode
argument_list|)
argument_list|,
name|ctlr
operator|->
name|chip
operator|->
name|text
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
block|{
name|u_int16_t
name|reg44
init|=
name|pci_read_config
argument_list|(
name|gparent
argument_list|,
literal|0x44
argument_list|,
literal|2
argument_list|)
decl_stmt|;
name|reg44
operator|&=
operator|~
operator|(
literal|0x000f
operator|<<
operator|(
name|devno
operator|<<
literal|2
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|mode
operator|>=
name|ATA_UDMA0
condition|)
name|reg44
operator||=
operator|(
operator|(
operator|(
name|mode
operator|&
name|ATA_MODE_MASK
operator|)
operator|+
literal|1
operator|)
operator|<<
operator|(
name|devno
operator|<<
literal|2
operator|)
operator|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
literal|0x44
argument_list|,
name|reg44
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
literal|0x4a
argument_list|,
literal|0xa6
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
literal|0x40
operator|+
name|devno
argument_list|,
literal|0x31
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|atadev
operator|->
name|mode
operator|=
name|mode
expr_stmt|;
return|return;
block|}
block|}
comment|/* we could set PIO mode timings, but we assume the BIOS did that */
block|}
end_function

begin_comment
comment|/*  * Acer Labs Inc (ALI) chipset support functions  */
end_comment

begin_function
name|int
name|ata_ali_ident
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
specifier|static
name|struct
name|ata_chip_id
name|ids
index|[]
init|=
block|{
block|{
name|ATA_ALI_5289
block|,
literal|0x00
block|,
literal|2
block|,
name|ALISATA
block|,
name|ATA_SA150
block|,
literal|"M5289"
block|}
block|,
block|{
name|ATA_ALI_5288
block|,
literal|0x00
block|,
literal|4
block|,
name|ALISATA
block|,
name|ATA_SA300
block|,
literal|"M5288"
block|}
block|,
block|{
name|ATA_ALI_5287
block|,
literal|0x00
block|,
literal|4
block|,
name|ALISATA
block|,
name|ATA_SA150
block|,
literal|"M5287"
block|}
block|,
block|{
name|ATA_ALI_5281
block|,
literal|0x00
block|,
literal|2
block|,
name|ALISATA
block|,
name|ATA_SA150
block|,
literal|"M5281"
block|}
block|,
block|{
name|ATA_ALI_5229
block|,
literal|0xc5
block|,
literal|0
block|,
name|ALINEW
block|,
name|ATA_UDMA6
block|,
literal|"M5229"
block|}
block|,
block|{
name|ATA_ALI_5229
block|,
literal|0xc4
block|,
literal|0
block|,
name|ALINEW
block|,
name|ATA_UDMA5
block|,
literal|"M5229"
block|}
block|,
block|{
name|ATA_ALI_5229
block|,
literal|0xc2
block|,
literal|0
block|,
name|ALINEW
block|,
name|ATA_UDMA4
block|,
literal|"M5229"
block|}
block|,
block|{
name|ATA_ALI_5229
block|,
literal|0x20
block|,
literal|0
block|,
name|ALIOLD
block|,
name|ATA_UDMA2
block|,
literal|"M5229"
block|}
block|,
block|{
name|ATA_ALI_5229
block|,
literal|0x00
block|,
literal|0
block|,
name|ALIOLD
block|,
name|ATA_WDMA2
block|,
literal|"M5229"
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|ctlr
operator|->
name|chip
operator|=
name|ata_match_chip
argument_list|(
name|dev
argument_list|,
name|ids
argument_list|)
operator|)
condition|)
return|return
name|ENXIO
return|;
name|ata_set_desc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|chipinit
operator|=
name|ata_ali_chipinit
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_ali_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ali_sata_resources
modifier|*
name|res
decl_stmt|;
name|int
name|i
decl_stmt|,
name|rid
decl_stmt|;
if|if
condition|(
name|ata_setup_interrupt
argument_list|(
name|dev
argument_list|)
condition|)
return|return
name|ENXIO
return|;
switch|switch
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
condition|)
block|{
case|case
name|ALISATA
case|:
name|ctlr
operator|->
name|channels
operator|=
name|ctlr
operator|->
name|chip
operator|->
name|cfg1
expr_stmt|;
name|ctlr
operator|->
name|allocate
operator|=
name|ata_ali_sata_allocate
expr_stmt|;
name|ctlr
operator|->
name|setmode
operator|=
name|ata_sata_setmode
expr_stmt|;
comment|/* AHCI mode is correctly supported only on the ALi 5288. */
if|if
condition|(
operator|(
name|ctlr
operator|->
name|chip
operator|->
name|chipid
operator|==
name|ATA_ALI_5288
operator|)
operator|&&
operator|(
name|ata_ahci_chipinit
argument_list|(
name|dev
argument_list|)
operator|!=
name|ENXIO
operator|)
condition|)
return|return
literal|0
return|;
comment|/* Allocate resources for later use by channel attach routines. */
name|res
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|ali_sata_resources
argument_list|)
argument_list|,
name|M_TEMP
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
name|rid
operator|=
name|PCIR_BAR
argument_list|(
name|i
argument_list|)
expr_stmt|;
name|res
operator|->
name|bars
index|[
name|i
index|]
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IOPORT
argument_list|,
operator|&
name|rid
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|->
name|bars
index|[
name|i
index|]
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Failed to allocate BAR %d\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|--
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IOPORT
argument_list|,
name|PCIR_BAR
argument_list|(
name|i
argument_list|)
argument_list|,
name|res
operator|->
name|bars
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|res
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
block|}
block|}
name|ctlr
operator|->
name|chipset_data
operator|=
name|res
expr_stmt|;
break|break;
case|case
name|ALINEW
case|:
comment|/* use device interrupt as byte count end */
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x4a
argument_list|,
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x4a
argument_list|,
literal|1
argument_list|)
operator||
literal|0x20
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* enable cable detection and UDMA support on revisions< 0xc7 */
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|chiprev
operator|<
literal|0xc7
condition|)
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x4b
argument_list|,
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x4b
argument_list|,
literal|1
argument_list|)
operator||
literal|0x09
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* enable ATAPI UDMA mode (even if we are going to do PIO) */
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x53
argument_list|,
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x53
argument_list|,
literal|1
argument_list|)
operator||
operator|(
name|ctlr
operator|->
name|chip
operator|->
name|chiprev
operator|>=
literal|0xc7
condition|?
literal|0x03
else|:
literal|0x01
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* only chips with revision> 0xc4 can do 48bit DMA */
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|chiprev
operator|<=
literal|0xc4
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"using PIO transfers above 137GB as workaround for "
literal|"48bit DMA access bug, expect reduced performance\n"
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|allocate
operator|=
name|ata_ali_allocate
expr_stmt|;
name|ctlr
operator|->
name|reset
operator|=
name|ata_ali_reset
expr_stmt|;
name|ctlr
operator|->
name|setmode
operator|=
name|ata_ali_setmode
expr_stmt|;
break|break;
case|case
name|ALIOLD
case|:
comment|/* deactivate the ATAPI FIFO and enable ATAPI UDMA */
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x53
argument_list|,
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x53
argument_list|,
literal|1
argument_list|)
operator||
literal|0x03
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|setmode
operator|=
name|ata_ali_setmode
expr_stmt|;
break|break;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_ali_allocate
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
comment|/* setup the usual register normal pci style */
if|if
condition|(
name|ata_pci_allocate
argument_list|(
name|dev
argument_list|)
condition|)
return|return
name|ENXIO
return|;
comment|/* older chips can't do 48bit DMA transfers */
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|chiprev
operator|<=
literal|0xc4
condition|)
name|ch
operator|->
name|flags
operator||=
name|ATA_NO_48BIT_DMA
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_ali_sata_allocate
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|device_t
name|parent
init|=
name|device_get_parent
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|parent
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ali_sata_resources
modifier|*
name|res
decl_stmt|;
name|struct
name|resource
modifier|*
name|io
init|=
name|NULL
decl_stmt|,
modifier|*
name|ctlio
init|=
name|NULL
decl_stmt|;
name|int
name|unit01
init|=
operator|(
name|ch
operator|->
name|unit
operator|&
literal|1
operator|)
decl_stmt|,
name|unit10
init|=
operator|(
name|ch
operator|->
name|unit
operator|&
literal|2
operator|)
decl_stmt|;
name|int
name|i
decl_stmt|;
name|res
operator|=
name|ctlr
operator|->
name|chipset_data
expr_stmt|;
if|if
condition|(
name|unit01
condition|)
block|{
name|io
operator|=
name|res
operator|->
name|bars
index|[
literal|2
index|]
expr_stmt|;
name|ctlio
operator|=
name|res
operator|->
name|bars
index|[
literal|3
index|]
expr_stmt|;
block|}
else|else
block|{
name|io
operator|=
name|res
operator|->
name|bars
index|[
literal|0
index|]
expr_stmt|;
name|ctlio
operator|=
name|res
operator|->
name|bars
index|[
literal|1
index|]
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
name|ATA_DATA
init|;
name|i
operator|<=
name|ATA_COMMAND
condition|;
name|i
operator|++
control|)
block|{
name|ch
operator|->
name|r_io
index|[
name|i
index|]
operator|.
name|res
operator|=
name|io
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|i
index|]
operator|.
name|offset
operator|=
name|i
operator|+
operator|(
name|unit10
condition|?
literal|8
else|:
literal|0
operator|)
expr_stmt|;
block|}
name|ch
operator|->
name|r_io
index|[
name|ATA_CONTROL
index|]
operator|.
name|res
operator|=
name|ctlio
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_CONTROL
index|]
operator|.
name|offset
operator|=
literal|2
operator|+
operator|(
name|unit10
condition|?
literal|4
else|:
literal|0
operator|)
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_IDX_ADDR
index|]
operator|.
name|res
operator|=
name|io
expr_stmt|;
name|ata_default_registers
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctlr
operator|->
name|r_res1
condition|)
block|{
for|for
control|(
name|i
operator|=
name|ATA_BMCMD_PORT
init|;
name|i
operator|<=
name|ATA_BMDTP_PORT
condition|;
name|i
operator|++
control|)
block|{
name|ch
operator|->
name|r_io
index|[
name|i
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_res1
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|i
index|]
operator|.
name|offset
operator|=
operator|(
name|i
operator|-
name|ATA_BMCMD_PORT
operator|)
operator|+
operator|(
name|ch
operator|->
name|unit
operator|*
name|ATA_BMIOSIZE
operator|)
expr_stmt|;
block|}
block|}
name|ch
operator|->
name|flags
operator||=
name|ATA_NO_SLAVE
expr_stmt|;
comment|/* XXX SOS PHY handling awkward in ALI chip not supported yet */
name|ata_pci_hw
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_ali_reset
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|device_t
modifier|*
name|children
decl_stmt|;
name|int
name|nchildren
decl_stmt|,
name|i
decl_stmt|;
name|ata_generic_reset
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/*      * workaround for datacorruption bug found on at least SUN Blade-100      * find the ISA function on the southbridge and disable then enable      * the ATA channel tristate buffer      */
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|chiprev
operator|==
literal|0xc3
operator|||
name|ctlr
operator|->
name|chip
operator|->
name|chiprev
operator|==
literal|0xc2
condition|)
block|{
if|if
condition|(
operator|!
name|device_get_children
argument_list|(
name|GRANDPARENT
argument_list|(
name|dev
argument_list|)
argument_list|,
operator|&
name|children
argument_list|,
operator|&
name|nchildren
argument_list|)
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nchildren
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|pci_get_devid
argument_list|(
name|children
index|[
name|i
index|]
argument_list|)
operator|==
name|ATA_ALI_1533
condition|)
block|{
name|pci_write_config
argument_list|(
name|children
index|[
name|i
index|]
argument_list|,
literal|0x58
argument_list|,
name|pci_read_config
argument_list|(
name|children
index|[
name|i
index|]
argument_list|,
literal|0x58
argument_list|,
literal|1
argument_list|)
operator|&
operator|~
operator|(
literal|0x04
operator|<<
name|ch
operator|->
name|unit
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|children
index|[
name|i
index|]
argument_list|,
literal|0x58
argument_list|,
name|pci_read_config
argument_list|(
name|children
index|[
name|i
index|]
argument_list|,
literal|0x58
argument_list|,
literal|1
argument_list|)
operator||
operator|(
literal|0x04
operator|<<
name|ch
operator|->
name|unit
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|free
argument_list|(
name|children
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ata_ali_setmode
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|device_t
name|gparent
init|=
name|GRANDPARENT
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|gparent
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_device
modifier|*
name|atadev
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|devno
init|=
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|1
operator|)
operator|+
name|ATA_DEV
argument_list|(
name|atadev
operator|->
name|unit
argument_list|)
decl_stmt|;
name|int
name|error
decl_stmt|;
name|mode
operator|=
name|ata_limit_mode
argument_list|(
name|dev
argument_list|,
name|mode
argument_list|,
name|ctlr
operator|->
name|chip
operator|->
name|max_dma
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|&
name|ALINEW
operator|&&
name|ctlr
operator|->
name|chip
operator|->
name|chiprev
operator|<
literal|0xc7
condition|)
block|{
if|if
condition|(
name|mode
operator|>
name|ATA_UDMA2
operator|&&
name|pci_read_config
argument_list|(
name|gparent
argument_list|,
literal|0x4a
argument_list|,
literal|1
argument_list|)
operator|&
operator|(
literal|1
operator|<<
name|ch
operator|->
name|unit
operator|)
condition|)
block|{
name|ata_print_cable
argument_list|(
name|dev
argument_list|,
literal|"controller"
argument_list|)
expr_stmt|;
name|mode
operator|=
name|ATA_UDMA2
expr_stmt|;
block|}
block|}
else|else
name|mode
operator|=
name|ata_check_80pin
argument_list|(
name|dev
argument_list|,
name|mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|&
name|ALIOLD
condition|)
block|{
comment|/* doesn't support ATAPI DMA on write */
name|ch
operator|->
name|flags
operator||=
name|ATA_ATAPI_DMA_RO
expr_stmt|;
if|if
condition|(
name|ch
operator|->
name|devices
operator|&
name|ATA_ATAPI_MASTER
operator|&&
name|ch
operator|->
name|devices
operator|&
name|ATA_ATAPI_SLAVE
condition|)
block|{
comment|/* doesn't support ATAPI DMA on two ATAPI devices */
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"two atapi devices on this channel, no DMA\n"
argument_list|)
expr_stmt|;
name|mode
operator|=
name|ata_limit_mode
argument_list|(
name|dev
argument_list|,
name|mode
argument_list|,
name|ATA_PIO_MAX
argument_list|)
expr_stmt|;
block|}
block|}
name|error
operator|=
name|ata_controlcmd
argument_list|(
name|dev
argument_list|,
name|ATA_SETFEATURES
argument_list|,
name|ATA_SF_SETXFER
argument_list|,
literal|0
argument_list|,
name|mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%ssetting %s on %s chip\n"
argument_list|,
operator|(
name|error
operator|)
condition|?
literal|"FAILURE "
else|:
literal|""
argument_list|,
name|ata_mode2str
argument_list|(
name|mode
argument_list|)
argument_list|,
name|ctlr
operator|->
name|chip
operator|->
name|text
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
block|{
if|if
condition|(
name|mode
operator|>=
name|ATA_UDMA0
condition|)
block|{
name|u_int8_t
name|udma
index|[]
init|=
block|{
literal|0x0c
block|,
literal|0x0b
block|,
literal|0x0a
block|,
literal|0x09
block|,
literal|0x08
block|,
literal|0x0f
block|,
literal|0x0d
block|}
decl_stmt|;
name|u_int32_t
name|word54
init|=
name|pci_read_config
argument_list|(
name|gparent
argument_list|,
literal|0x54
argument_list|,
literal|4
argument_list|)
decl_stmt|;
name|word54
operator|&=
operator|~
operator|(
literal|0x000f000f
operator|<<
operator|(
name|devno
operator|<<
literal|2
operator|)
operator|)
expr_stmt|;
name|word54
operator||=
operator|(
operator|(
operator|(
name|udma
index|[
name|mode
operator|&
name|ATA_MODE_MASK
index|]
operator|<<
literal|16
operator|)
operator||
literal|0x05
operator|)
operator|<<
operator|(
name|devno
operator|<<
literal|2
operator|)
operator|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
literal|0x54
argument_list|,
name|word54
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
literal|0x58
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|2
operator|)
argument_list|,
literal|0x00310001
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|u_int32_t
name|piotimings
index|[]
init|=
block|{
literal|0x006d0003
block|,
literal|0x00580002
block|,
literal|0x00440001
block|,
literal|0x00330001
block|,
literal|0x00310001
block|,
literal|0x00440001
block|,
literal|0x00330001
block|,
literal|0x00310001
block|}
decl_stmt|;
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
literal|0x54
argument_list|,
name|pci_read_config
argument_list|(
name|gparent
argument_list|,
literal|0x54
argument_list|,
literal|4
argument_list|)
operator|&
operator|~
operator|(
literal|0x0008000f
operator|<<
operator|(
name|devno
operator|<<
literal|2
operator|)
operator|)
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
literal|0x58
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|2
operator|)
argument_list|,
name|piotimings
index|[
name|ata_mode2idx
argument_list|(
name|mode
argument_list|)
index|]
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
name|atadev
operator|->
name|mode
operator|=
name|mode
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * American Micro Devices (AMD) chipset support functions  */
end_comment

begin_function
name|int
name|ata_amd_ident
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
specifier|static
name|struct
name|ata_chip_id
name|ids
index|[]
init|=
block|{
block|{
name|ATA_AMD756
block|,
literal|0x00
block|,
name|AMDNVIDIA
block|,
literal|0x00
block|,
name|ATA_UDMA4
block|,
literal|"756"
block|}
block|,
block|{
name|ATA_AMD766
block|,
literal|0x00
block|,
name|AMDNVIDIA
block|,
name|AMDCABLE
operator||
name|AMDBUG
block|,
name|ATA_UDMA5
block|,
literal|"766"
block|}
block|,
block|{
name|ATA_AMD768
block|,
literal|0x00
block|,
name|AMDNVIDIA
block|,
name|AMDCABLE
block|,
name|ATA_UDMA5
block|,
literal|"768"
block|}
block|,
block|{
name|ATA_AMD8111
block|,
literal|0x00
block|,
name|AMDNVIDIA
block|,
name|AMDCABLE
block|,
name|ATA_UDMA6
block|,
literal|"8111"
block|}
block|,
block|{
name|ATA_AMD5536
block|,
literal|0x00
block|,
name|AMDNVIDIA
block|,
literal|0x00
block|,
name|ATA_UDMA5
block|,
literal|"CS5536"
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|ctlr
operator|->
name|chip
operator|=
name|ata_match_chip
argument_list|(
name|dev
argument_list|,
name|ids
argument_list|)
operator|)
condition|)
return|return
name|ENXIO
return|;
name|ata_set_desc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|chipinit
operator|=
name|ata_amd_chipinit
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_amd_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|ata_setup_interrupt
argument_list|(
name|dev
argument_list|)
condition|)
return|return
name|ENXIO
return|;
comment|/* disable/set prefetch, postwrite */
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|&
name|AMDBUG
condition|)
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x41
argument_list|,
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x41
argument_list|,
literal|1
argument_list|)
operator|&
literal|0x0f
argument_list|,
literal|1
argument_list|)
expr_stmt|;
else|else
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x41
argument_list|,
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x41
argument_list|,
literal|1
argument_list|)
operator||
literal|0xf0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|setmode
operator|=
name|ata_via_family_setmode
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Adaptec chipset support functions  */
end_comment

begin_function
name|int
name|ata_adaptec_ident
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
specifier|static
name|struct
name|ata_chip_id
name|ids
index|[]
init|=
block|{
block|{
name|ATA_ADAPTEC_1420
block|,
literal|0
block|,
literal|4
block|,
name|MV60XX
block|,
name|ATA_SA300
block|,
literal|"1420SA"
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|ctlr
operator|->
name|chip
operator|=
name|ata_match_chip
argument_list|(
name|dev
argument_list|,
name|ids
argument_list|)
operator|)
condition|)
return|return
name|ENXIO
return|;
name|ata_set_desc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|chipinit
operator|=
name|ata_marvell_edma_chipinit
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * ATI chipset support functions  */
end_comment

begin_function
name|int
name|ata_ati_ident
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
specifier|static
name|struct
name|ata_chip_id
name|ids
index|[]
init|=
block|{
block|{
name|ATA_ATI_IXP200
block|,
literal|0x00
block|,
literal|0
block|,
name|ATIPATA
block|,
name|ATA_UDMA5
block|,
literal|"IXP200"
block|}
block|,
block|{
name|ATA_ATI_IXP300
block|,
literal|0x00
block|,
literal|0
block|,
name|ATIPATA
block|,
name|ATA_UDMA6
block|,
literal|"IXP300"
block|}
block|,
block|{
name|ATA_ATI_IXP300_S1
block|,
literal|0x00
block|,
literal|0
block|,
name|ATISATA
block|,
name|ATA_SA150
block|,
literal|"IXP300"
block|}
block|,
block|{
name|ATA_ATI_IXP400
block|,
literal|0x00
block|,
literal|0
block|,
name|ATIPATA
block|,
name|ATA_UDMA6
block|,
literal|"IXP400"
block|}
block|,
block|{
name|ATA_ATI_IXP400_S1
block|,
literal|0x00
block|,
literal|0
block|,
name|ATISATA
block|,
name|ATA_SA150
block|,
literal|"IXP400"
block|}
block|,
block|{
name|ATA_ATI_IXP400_S2
block|,
literal|0x00
block|,
literal|0
block|,
name|ATISATA
block|,
name|ATA_SA150
block|,
literal|"IXP400"
block|}
block|,
block|{
name|ATA_ATI_IXP600
block|,
literal|0x00
block|,
literal|0
block|,
name|ATIPATA
block|,
name|ATA_UDMA6
block|,
literal|"IXP600"
block|}
block|,
block|{
name|ATA_ATI_IXP600_S1
block|,
literal|0x00
block|,
literal|0
block|,
name|ATIAHCI
block|,
name|ATA_SA300
block|,
literal|"IXP600"
block|}
block|,
block|{
name|ATA_ATI_IXP700
block|,
literal|0x00
block|,
literal|0
block|,
name|ATIPATA
block|,
name|ATA_UDMA6
block|,
literal|"IXP700"
block|}
block|,
block|{
name|ATA_ATI_IXP700_S1
block|,
literal|0x00
block|,
literal|0
block|,
name|ATIAHCI
block|,
name|ATA_SA300
block|,
literal|"IXP700"
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|ctlr
operator|->
name|chip
operator|=
name|ata_match_chip
argument_list|(
name|dev
argument_list|,
name|ids
argument_list|)
operator|)
condition|)
return|return
name|ENXIO
return|;
name|ata_set_desc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
condition|)
block|{
case|case
name|ATIPATA
case|:
name|ctlr
operator|->
name|chipinit
operator|=
name|ata_ati_chipinit
expr_stmt|;
break|break;
case|case
name|ATISATA
case|:
comment|/* the ATI SATA controller is actually a SiI 3112 controller */
name|ctlr
operator|->
name|chip
operator|->
name|cfg1
operator|=
name|SIIMEMIO
expr_stmt|;
name|ctlr
operator|->
name|chipinit
operator|=
name|ata_sii_chipinit
expr_stmt|;
break|break;
case|case
name|ATIAHCI
case|:
name|ctlr
operator|->
name|chipinit
operator|=
name|ata_ahci_chipinit
expr_stmt|;
break|break;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_ati_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|ata_setup_interrupt
argument_list|(
name|dev
argument_list|)
condition|)
return|return
name|ENXIO
return|;
comment|/* IXP600 only have 1 PATA channel */
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|chipid
operator|==
name|ATA_ATI_IXP600
condition|)
name|ctlr
operator|->
name|channels
operator|=
literal|1
expr_stmt|;
name|ctlr
operator|->
name|setmode
operator|=
name|ata_ati_setmode
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_ati_setmode
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|device_t
name|gparent
init|=
name|GRANDPARENT
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|gparent
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_device
modifier|*
name|atadev
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|devno
init|=
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|1
operator|)
operator|+
name|ATA_DEV
argument_list|(
name|atadev
operator|->
name|unit
argument_list|)
decl_stmt|;
name|int
name|offset
init|=
operator|(
name|devno
operator|^
literal|0x01
operator|)
operator|<<
literal|3
decl_stmt|;
name|int
name|error
decl_stmt|;
name|u_int8_t
name|piotimings
index|[]
init|=
block|{
literal|0x5d
block|,
literal|0x47
block|,
literal|0x34
block|,
literal|0x22
block|,
literal|0x20
block|,
literal|0x34
block|,
literal|0x22
block|,
literal|0x20
block|,
literal|0x20
block|,
literal|0x20
block|,
literal|0x20
block|,
literal|0x20
block|,
literal|0x20
block|,
literal|0x20
block|}
decl_stmt|;
name|u_int8_t
name|dmatimings
index|[]
init|=
block|{
literal|0x77
block|,
literal|0x21
block|,
literal|0x20
block|}
decl_stmt|;
name|mode
operator|=
name|ata_limit_mode
argument_list|(
name|dev
argument_list|,
name|mode
argument_list|,
name|ctlr
operator|->
name|chip
operator|->
name|max_dma
argument_list|)
expr_stmt|;
name|mode
operator|=
name|ata_check_80pin
argument_list|(
name|dev
argument_list|,
name|mode
argument_list|)
expr_stmt|;
name|error
operator|=
name|ata_controlcmd
argument_list|(
name|dev
argument_list|,
name|ATA_SETFEATURES
argument_list|,
name|ATA_SF_SETXFER
argument_list|,
literal|0
argument_list|,
name|mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%ssetting %s on %s chip\n"
argument_list|,
operator|(
name|error
operator|)
condition|?
literal|"FAILURE "
else|:
literal|""
argument_list|,
name|ata_mode2str
argument_list|(
name|mode
argument_list|)
argument_list|,
name|ctlr
operator|->
name|chip
operator|->
name|text
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
block|{
if|if
condition|(
name|mode
operator|>=
name|ATA_UDMA0
condition|)
block|{
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
literal|0x56
argument_list|,
operator|(
name|pci_read_config
argument_list|(
name|gparent
argument_list|,
literal|0x56
argument_list|,
literal|2
argument_list|)
operator|&
operator|~
operator|(
literal|0xf
operator|<<
operator|(
name|devno
operator|<<
literal|2
operator|)
operator|)
operator|)
operator||
operator|(
operator|(
name|mode
operator|&
name|ATA_MODE_MASK
operator|)
operator|<<
operator|(
name|devno
operator|<<
literal|2
operator|)
operator|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
literal|0x54
argument_list|,
name|pci_read_config
argument_list|(
name|gparent
argument_list|,
literal|0x54
argument_list|,
literal|1
argument_list|)
operator||
operator|(
literal|0x01
operator|<<
name|devno
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
literal|0x44
argument_list|,
operator|(
name|pci_read_config
argument_list|(
name|gparent
argument_list|,
literal|0x44
argument_list|,
literal|4
argument_list|)
operator|&
operator|~
operator|(
literal|0xff
operator|<<
name|offset
operator|)
operator|)
operator||
operator|(
name|dmatimings
index|[
literal|2
index|]
operator|<<
name|offset
operator|)
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|mode
operator|>=
name|ATA_WDMA0
condition|)
block|{
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
literal|0x54
argument_list|,
name|pci_read_config
argument_list|(
name|gparent
argument_list|,
literal|0x54
argument_list|,
literal|1
argument_list|)
operator|&
operator|~
operator|(
literal|0x01
operator|<<
name|devno
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
literal|0x44
argument_list|,
operator|(
name|pci_read_config
argument_list|(
name|gparent
argument_list|,
literal|0x44
argument_list|,
literal|4
argument_list|)
operator|&
operator|~
operator|(
literal|0xff
operator|<<
name|offset
operator|)
operator|)
operator||
operator|(
name|dmatimings
index|[
name|mode
operator|&
name|ATA_MODE_MASK
index|]
operator|<<
name|offset
operator|)
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
else|else
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
literal|0x54
argument_list|,
name|pci_read_config
argument_list|(
name|gparent
argument_list|,
literal|0x54
argument_list|,
literal|1
argument_list|)
operator|&
operator|~
operator|(
literal|0x01
operator|<<
name|devno
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
literal|0x4a
argument_list|,
operator|(
name|pci_read_config
argument_list|(
name|gparent
argument_list|,
literal|0x4a
argument_list|,
literal|2
argument_list|)
operator|&
operator|~
operator|(
literal|0xf
operator|<<
operator|(
name|devno
operator|<<
literal|2
operator|)
operator|)
operator|)
operator||
operator|(
operator|(
operator|(
name|mode
operator|-
name|ATA_PIO0
operator|)
operator|&
name|ATA_MODE_MASK
operator|)
operator|<<
operator|(
name|devno
operator|<<
literal|2
operator|)
operator|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
literal|0x40
argument_list|,
operator|(
name|pci_read_config
argument_list|(
name|gparent
argument_list|,
literal|0x40
argument_list|,
literal|4
argument_list|)
operator|&
operator|~
operator|(
literal|0xff
operator|<<
name|offset
operator|)
operator|)
operator||
operator|(
name|piotimings
index|[
name|ata_mode2idx
argument_list|(
name|mode
argument_list|)
index|]
operator|<<
name|offset
operator|)
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|atadev
operator|->
name|mode
operator|=
name|mode
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Cyrix chipset support functions  */
end_comment

begin_function
name|int
name|ata_cyrix_ident
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|pci_get_devid
argument_list|(
name|dev
argument_list|)
operator|==
name|ATA_CYRIX_5530
condition|)
block|{
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"Cyrix 5530 ATA33 controller"
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|chipinit
operator|=
name|ata_cyrix_chipinit
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
name|ENXIO
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_cyrix_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|ata_setup_interrupt
argument_list|(
name|dev
argument_list|)
condition|)
return|return
name|ENXIO
return|;
if|if
condition|(
name|ctlr
operator|->
name|r_res1
condition|)
name|ctlr
operator|->
name|setmode
operator|=
name|ata_cyrix_setmode
expr_stmt|;
else|else
name|ctlr
operator|->
name|setmode
operator|=
name|ata_generic_setmode
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_cyrix_setmode
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_device
modifier|*
name|atadev
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|devno
init|=
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|1
operator|)
operator|+
name|ATA_DEV
argument_list|(
name|atadev
operator|->
name|unit
argument_list|)
decl_stmt|;
name|u_int32_t
name|piotiming
index|[]
init|=
block|{
literal|0x00009172
block|,
literal|0x00012171
block|,
literal|0x00020080
block|,
literal|0x00032010
block|,
literal|0x00040010
block|}
decl_stmt|;
name|u_int32_t
name|dmatiming
index|[]
init|=
block|{
literal|0x00077771
block|,
literal|0x00012121
block|,
literal|0x00002020
block|}
decl_stmt|;
name|u_int32_t
name|udmatiming
index|[]
init|=
block|{
literal|0x00921250
block|,
literal|0x00911140
block|,
literal|0x00911030
block|}
decl_stmt|;
name|int
name|error
decl_stmt|;
name|ch
operator|->
name|dma
operator|->
name|alignment
operator|=
literal|16
expr_stmt|;
name|ch
operator|->
name|dma
operator|->
name|max_iosize
operator|=
literal|64
operator|*
name|DEV_BSIZE
expr_stmt|;
name|mode
operator|=
name|ata_limit_mode
argument_list|(
name|dev
argument_list|,
name|mode
argument_list|,
name|ATA_UDMA2
argument_list|)
expr_stmt|;
name|error
operator|=
name|ata_controlcmd
argument_list|(
name|dev
argument_list|,
name|ATA_SETFEATURES
argument_list|,
name|ATA_SF_SETXFER
argument_list|,
literal|0
argument_list|,
name|mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%ssetting %s on Cyrix chip\n"
argument_list|,
operator|(
name|error
operator|)
condition|?
literal|"FAILURE "
else|:
literal|""
argument_list|,
name|ata_mode2str
argument_list|(
name|mode
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
block|{
if|if
condition|(
name|mode
operator|>=
name|ATA_UDMA0
condition|)
block|{
name|ATA_OUTL
argument_list|(
name|ch
operator|->
name|r_io
index|[
name|ATA_BMCMD_PORT
index|]
operator|.
name|res
argument_list|,
literal|0x24
operator|+
operator|(
name|devno
operator|<<
literal|3
operator|)
argument_list|,
name|udmatiming
index|[
name|mode
operator|&
name|ATA_MODE_MASK
index|]
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|mode
operator|>=
name|ATA_WDMA0
condition|)
block|{
name|ATA_OUTL
argument_list|(
name|ch
operator|->
name|r_io
index|[
name|ATA_BMCMD_PORT
index|]
operator|.
name|res
argument_list|,
literal|0x24
operator|+
operator|(
name|devno
operator|<<
literal|3
operator|)
argument_list|,
name|dmatiming
index|[
name|mode
operator|&
name|ATA_MODE_MASK
index|]
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ATA_OUTL
argument_list|(
name|ch
operator|->
name|r_io
index|[
name|ATA_BMCMD_PORT
index|]
operator|.
name|res
argument_list|,
literal|0x20
operator|+
operator|(
name|devno
operator|<<
literal|3
operator|)
argument_list|,
name|piotiming
index|[
name|mode
operator|&
name|ATA_MODE_MASK
index|]
argument_list|)
expr_stmt|;
block|}
name|atadev
operator|->
name|mode
operator|=
name|mode
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Cypress chipset support functions  */
end_comment

begin_function
name|int
name|ata_cypress_ident
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
comment|/*      * the Cypress chip is a mess, it contains two ATA functions, but      * both channels are visible on the first one.      * simply ignore the second function for now, as the right      * solution (ignoring the second channel on the first function)      * doesn't work with the crappy ATA interrupt setup on the alpha.      */
if|if
condition|(
name|pci_get_devid
argument_list|(
name|dev
argument_list|)
operator|==
name|ATA_CYPRESS_82C693
operator|&&
name|pci_get_function
argument_list|(
name|dev
argument_list|)
operator|==
literal|1
operator|&&
name|pci_get_subclass
argument_list|(
name|dev
argument_list|)
operator|==
name|PCIS_STORAGE_IDE
condition|)
block|{
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"Cypress 82C693 ATA controller"
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|chipinit
operator|=
name|ata_cypress_chipinit
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
name|ENXIO
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_cypress_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|ata_setup_interrupt
argument_list|(
name|dev
argument_list|)
condition|)
return|return
name|ENXIO
return|;
name|ctlr
operator|->
name|setmode
operator|=
name|ata_cypress_setmode
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_cypress_setmode
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|device_t
name|gparent
init|=
name|GRANDPARENT
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_device
modifier|*
name|atadev
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|error
decl_stmt|;
name|mode
operator|=
name|ata_limit_mode
argument_list|(
name|dev
argument_list|,
name|mode
argument_list|,
name|ATA_WDMA2
argument_list|)
expr_stmt|;
comment|/* XXX SOS missing WDMA0+1 + PIO modes */
if|if
condition|(
name|mode
operator|==
name|ATA_WDMA2
condition|)
block|{
name|error
operator|=
name|ata_controlcmd
argument_list|(
name|dev
argument_list|,
name|ATA_SETFEATURES
argument_list|,
name|ATA_SF_SETXFER
argument_list|,
literal|0
argument_list|,
name|mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%ssetting WDMA2 on Cypress chip\n"
argument_list|,
name|error
condition|?
literal|"FAILURE "
else|:
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
block|{
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
name|ch
operator|->
name|unit
condition|?
literal|0x4e
else|:
literal|0x4c
argument_list|,
literal|0x2020
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|atadev
operator|->
name|mode
operator|=
name|mode
expr_stmt|;
return|return;
block|}
block|}
comment|/* we could set PIO mode timings, but we assume the BIOS did that */
block|}
end_function

begin_comment
comment|/*  * HighPoint chipset support functions  */
end_comment

begin_function
name|int
name|ata_highpoint_ident
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ata_chip_id
modifier|*
name|idx
decl_stmt|;
specifier|static
name|struct
name|ata_chip_id
name|ids
index|[]
init|=
block|{
block|{
name|ATA_HPT374
block|,
literal|0x07
block|,
name|HPT374
block|,
literal|0x00
block|,
name|ATA_UDMA6
block|,
literal|"HPT374"
block|}
block|,
block|{
name|ATA_HPT372
block|,
literal|0x02
block|,
name|HPT372
block|,
literal|0x00
block|,
name|ATA_UDMA6
block|,
literal|"HPT372N"
block|}
block|,
block|{
name|ATA_HPT372
block|,
literal|0x01
block|,
name|HPT372
block|,
literal|0x00
block|,
name|ATA_UDMA6
block|,
literal|"HPT372"
block|}
block|,
block|{
name|ATA_HPT371
block|,
literal|0x01
block|,
name|HPT372
block|,
literal|0x00
block|,
name|ATA_UDMA6
block|,
literal|"HPT371"
block|}
block|,
block|{
name|ATA_HPT366
block|,
literal|0x05
block|,
name|HPT372
block|,
literal|0x00
block|,
name|ATA_UDMA6
block|,
literal|"HPT372"
block|}
block|,
block|{
name|ATA_HPT366
block|,
literal|0x03
block|,
name|HPT370
block|,
literal|0x00
block|,
name|ATA_UDMA5
block|,
literal|"HPT370"
block|}
block|,
block|{
name|ATA_HPT366
block|,
literal|0x02
block|,
name|HPT366
block|,
literal|0x00
block|,
name|ATA_UDMA4
block|,
literal|"HPT368"
block|}
block|,
block|{
name|ATA_HPT366
block|,
literal|0x00
block|,
name|HPT366
block|,
name|HPTOLD
block|,
name|ATA_UDMA4
block|,
literal|"HPT366"
block|}
block|,
block|{
name|ATA_HPT302
block|,
literal|0x01
block|,
name|HPT372
block|,
literal|0x00
block|,
name|ATA_UDMA6
block|,
literal|"HPT302"
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
name|char
name|buffer
index|[
literal|64
index|]
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|idx
operator|=
name|ata_match_chip
argument_list|(
name|dev
argument_list|,
name|ids
argument_list|)
operator|)
condition|)
return|return
name|ENXIO
return|;
name|strcpy
argument_list|(
name|buffer
argument_list|,
literal|"HighPoint "
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|buffer
argument_list|,
name|idx
operator|->
name|text
argument_list|)
expr_stmt|;
if|if
condition|(
name|idx
operator|->
name|cfg1
operator|==
name|HPT374
condition|)
block|{
if|if
condition|(
name|pci_get_function
argument_list|(
name|dev
argument_list|)
operator|==
literal|0
condition|)
name|strcat
argument_list|(
name|buffer
argument_list|,
literal|" (channel 0+1)"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pci_get_function
argument_list|(
name|dev
argument_list|)
operator|==
literal|1
condition|)
name|strcat
argument_list|(
name|buffer
argument_list|,
literal|" (channel 2+3)"
argument_list|)
expr_stmt|;
block|}
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"%s %s controller"
argument_list|,
name|buffer
argument_list|,
name|ata_mode2str
argument_list|(
name|idx
operator|->
name|max_dma
argument_list|)
argument_list|)
expr_stmt|;
name|device_set_desc_copy
argument_list|(
name|dev
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|chip
operator|=
name|idx
expr_stmt|;
name|ctlr
operator|->
name|chipinit
operator|=
name|ata_highpoint_chipinit
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_highpoint_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|ata_setup_interrupt
argument_list|(
name|dev
argument_list|)
condition|)
return|return
name|ENXIO
return|;
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|==
name|HPTOLD
condition|)
block|{
comment|/* disable interrupt prediction */
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x51
argument_list|,
operator|(
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x51
argument_list|,
literal|1
argument_list|)
operator|&
operator|~
literal|0x80
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* disable interrupt prediction */
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x51
argument_list|,
operator|(
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x51
argument_list|,
literal|1
argument_list|)
operator|&
operator|~
literal|0x03
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x55
argument_list|,
operator|(
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x55
argument_list|,
literal|1
argument_list|)
operator|&
operator|~
literal|0x03
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* enable interrupts */
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x5a
argument_list|,
operator|(
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x5a
argument_list|,
literal|1
argument_list|)
operator|&
operator|~
literal|0x10
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* set clocks etc */
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg1
operator|<
name|HPT372
condition|)
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x5b
argument_list|,
literal|0x22
argument_list|,
literal|1
argument_list|)
expr_stmt|;
else|else
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x5b
argument_list|,
operator|(
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x5b
argument_list|,
literal|1
argument_list|)
operator|&
literal|0x01
operator|)
operator||
literal|0x20
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|ctlr
operator|->
name|allocate
operator|=
name|ata_highpoint_allocate
expr_stmt|;
name|ctlr
operator|->
name|setmode
operator|=
name|ata_highpoint_setmode
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_highpoint_allocate
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
comment|/* setup the usual register normal pci style */
if|if
condition|(
name|ata_pci_allocate
argument_list|(
name|dev
argument_list|)
condition|)
return|return
name|ENXIO
return|;
name|ch
operator|->
name|flags
operator||=
name|ATA_ALWAYS_DMASTAT
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_highpoint_setmode
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|device_t
name|gparent
init|=
name|GRANDPARENT
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|gparent
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_device
modifier|*
name|atadev
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|devno
init|=
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|1
operator|)
operator|+
name|ATA_DEV
argument_list|(
name|atadev
operator|->
name|unit
argument_list|)
decl_stmt|;
name|int
name|error
decl_stmt|;
name|u_int32_t
name|timings33
index|[]
index|[
literal|4
index|]
init|=
block|{
comment|/*    HPT366      HPT370      HPT372      HPT374               mode */
block|{
literal|0x40d0a7aa
block|,
literal|0x06914e57
block|,
literal|0x0d029d5e
block|,
literal|0x0ac1f48a
block|}
block|,
comment|/* PIO 0 */
block|{
literal|0x40d0a7a3
block|,
literal|0x06914e43
block|,
literal|0x0d029d26
block|,
literal|0x0ac1f465
block|}
block|,
comment|/* PIO 1 */
block|{
literal|0x40d0a753
block|,
literal|0x06514e33
block|,
literal|0x0c829ca6
block|,
literal|0x0a81f454
block|}
block|,
comment|/* PIO 2 */
block|{
literal|0x40c8a742
block|,
literal|0x06514e22
block|,
literal|0x0c829c84
block|,
literal|0x0a81f443
block|}
block|,
comment|/* PIO 3 */
block|{
literal|0x40c8a731
block|,
literal|0x06514e21
block|,
literal|0x0c829c62
block|,
literal|0x0a81f442
block|}
block|,
comment|/* PIO 4 */
block|{
literal|0x20c8a797
block|,
literal|0x26514e97
block|,
literal|0x2c82922e
block|,
literal|0x228082ea
block|}
block|,
comment|/* MWDMA 0 */
block|{
literal|0x20c8a732
block|,
literal|0x26514e33
block|,
literal|0x2c829266
block|,
literal|0x22808254
block|}
block|,
comment|/* MWDMA 1 */
block|{
literal|0x20c8a731
block|,
literal|0x26514e21
block|,
literal|0x2c829262
block|,
literal|0x22808242
block|}
block|,
comment|/* MWDMA 2 */
block|{
literal|0x10c8a731
block|,
literal|0x16514e31
block|,
literal|0x1c829c62
block|,
literal|0x121882ea
block|}
block|,
comment|/* UDMA 0 */
block|{
literal|0x10cba731
block|,
literal|0x164d4e31
block|,
literal|0x1c9a9c62
block|,
literal|0x12148254
block|}
block|,
comment|/* UDMA 1 */
block|{
literal|0x10caa731
block|,
literal|0x16494e31
block|,
literal|0x1c929c62
block|,
literal|0x120c8242
block|}
block|,
comment|/* UDMA 2 */
block|{
literal|0x10cfa731
block|,
literal|0x166d4e31
block|,
literal|0x1c8e9c62
block|,
literal|0x128c8242
block|}
block|,
comment|/* UDMA 3 */
block|{
literal|0x10c9a731
block|,
literal|0x16454e31
block|,
literal|0x1c8a9c62
block|,
literal|0x12ac8242
block|}
block|,
comment|/* UDMA 4 */
block|{
literal|0
block|,
literal|0x16454e31
block|,
literal|0x1c8a9c62
block|,
literal|0x12848242
block|}
block|,
comment|/* UDMA 5 */
block|{
literal|0
block|,
literal|0
block|,
literal|0x1c869c62
block|,
literal|0x12808242
block|}
comment|/* UDMA 6 */
block|}
decl_stmt|;
name|mode
operator|=
name|ata_limit_mode
argument_list|(
name|dev
argument_list|,
name|mode
argument_list|,
name|ctlr
operator|->
name|chip
operator|->
name|max_dma
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg1
operator|==
name|HPT366
operator|&&
name|ata_atapi
argument_list|(
name|dev
argument_list|)
condition|)
name|mode
operator|=
name|ata_limit_mode
argument_list|(
name|dev
argument_list|,
name|mode
argument_list|,
name|ATA_PIO_MAX
argument_list|)
expr_stmt|;
name|mode
operator|=
name|ata_highpoint_check_80pin
argument_list|(
name|dev
argument_list|,
name|mode
argument_list|)
expr_stmt|;
comment|/*      * most if not all HPT chips cant really handle that the device is      * running at ATA_UDMA6/ATA133 speed, so we cheat at set the device to      * a max of ATA_UDMA5/ATA100 to guard against suboptimal performance      */
name|error
operator|=
name|ata_controlcmd
argument_list|(
name|dev
argument_list|,
name|ATA_SETFEATURES
argument_list|,
name|ATA_SF_SETXFER
argument_list|,
literal|0
argument_list|,
name|ata_limit_mode
argument_list|(
name|dev
argument_list|,
name|mode
argument_list|,
name|ATA_UDMA5
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%ssetting %s on HighPoint chip\n"
argument_list|,
operator|(
name|error
operator|)
condition|?
literal|"FAILURE "
else|:
literal|""
argument_list|,
name|ata_mode2str
argument_list|(
name|mode
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
literal|0x40
operator|+
operator|(
name|devno
operator|<<
literal|2
operator|)
argument_list|,
name|timings33
index|[
name|ata_mode2idx
argument_list|(
name|mode
argument_list|)
index|]
index|[
name|ctlr
operator|->
name|chip
operator|->
name|cfg1
index|]
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|atadev
operator|->
name|mode
operator|=
name|mode
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_highpoint_check_80pin
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|device_t
name|gparent
init|=
name|GRANDPARENT
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|gparent
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|u_int8_t
name|reg
decl_stmt|,
name|val
decl_stmt|,
name|res
decl_stmt|;
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg1
operator|==
name|HPT374
operator|&&
name|pci_get_function
argument_list|(
name|gparent
argument_list|)
operator|==
literal|1
condition|)
block|{
name|reg
operator|=
name|ch
operator|->
name|unit
condition|?
literal|0x57
else|:
literal|0x53
expr_stmt|;
name|val
operator|=
name|pci_read_config
argument_list|(
name|gparent
argument_list|,
name|reg
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
name|reg
argument_list|,
name|val
operator||
literal|0x80
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|reg
operator|=
literal|0x5b
expr_stmt|;
name|val
operator|=
name|pci_read_config
argument_list|(
name|gparent
argument_list|,
name|reg
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
name|reg
argument_list|,
name|val
operator|&
literal|0xfe
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|res
operator|=
name|pci_read_config
argument_list|(
name|gparent
argument_list|,
literal|0x5a
argument_list|,
literal|1
argument_list|)
operator|&
operator|(
name|ch
operator|->
name|unit
condition|?
literal|0x1
else|:
literal|0x2
operator|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
name|reg
argument_list|,
name|val
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|mode
operator|>
name|ATA_UDMA2
operator|&&
name|res
condition|)
block|{
name|ata_print_cable
argument_list|(
name|dev
argument_list|,
literal|"controller"
argument_list|)
expr_stmt|;
name|mode
operator|=
name|ATA_UDMA2
expr_stmt|;
block|}
return|return
name|mode
return|;
block|}
end_function

begin_comment
comment|/*  * Intel chipset support functions  */
end_comment

begin_function
name|int
name|ata_intel_ident
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
specifier|static
name|struct
name|ata_chip_id
name|ids
index|[]
init|=
block|{
block|{
name|ATA_I82371FB
block|,
literal|0
block|,
literal|0
block|,
literal|2
block|,
name|ATA_WDMA2
block|,
literal|"PIIX"
block|}
block|,
block|{
name|ATA_I82371SB
block|,
literal|0
block|,
literal|0
block|,
literal|2
block|,
name|ATA_WDMA2
block|,
literal|"PIIX3"
block|}
block|,
block|{
name|ATA_I82371AB
block|,
literal|0
block|,
literal|0
block|,
literal|2
block|,
name|ATA_UDMA2
block|,
literal|"PIIX4"
block|}
block|,
block|{
name|ATA_I82443MX
block|,
literal|0
block|,
literal|0
block|,
literal|2
block|,
name|ATA_UDMA2
block|,
literal|"PIIX4"
block|}
block|,
block|{
name|ATA_I82451NX
block|,
literal|0
block|,
literal|0
block|,
literal|2
block|,
name|ATA_UDMA2
block|,
literal|"PIIX4"
block|}
block|,
block|{
name|ATA_I82801AB
block|,
literal|0
block|,
literal|0
block|,
literal|2
block|,
name|ATA_UDMA2
block|,
literal|"ICH0"
block|}
block|,
block|{
name|ATA_I82801AA
block|,
literal|0
block|,
literal|0
block|,
literal|2
block|,
name|ATA_UDMA4
block|,
literal|"ICH"
block|}
block|,
block|{
name|ATA_I82372FB
block|,
literal|0
block|,
literal|0
block|,
literal|2
block|,
name|ATA_UDMA4
block|,
literal|"ICH"
block|}
block|,
block|{
name|ATA_I82801BA
block|,
literal|0
block|,
literal|0
block|,
literal|2
block|,
name|ATA_UDMA5
block|,
literal|"ICH2"
block|}
block|,
block|{
name|ATA_I82801BA_1
block|,
literal|0
block|,
literal|0
block|,
literal|2
block|,
name|ATA_UDMA5
block|,
literal|"ICH2"
block|}
block|,
block|{
name|ATA_I82801CA
block|,
literal|0
block|,
literal|0
block|,
literal|2
block|,
name|ATA_UDMA5
block|,
literal|"ICH3"
block|}
block|,
block|{
name|ATA_I82801CA_1
block|,
literal|0
block|,
literal|0
block|,
literal|2
block|,
name|ATA_UDMA5
block|,
literal|"ICH3"
block|}
block|,
block|{
name|ATA_I82801DB
block|,
literal|0
block|,
literal|0
block|,
literal|2
block|,
name|ATA_UDMA5
block|,
literal|"ICH4"
block|}
block|,
block|{
name|ATA_I82801DB_1
block|,
literal|0
block|,
literal|0
block|,
literal|2
block|,
name|ATA_UDMA5
block|,
literal|"ICH4"
block|}
block|,
block|{
name|ATA_I82801EB
block|,
literal|0
block|,
literal|0
block|,
literal|2
block|,
name|ATA_UDMA5
block|,
literal|"ICH5"
block|}
block|,
block|{
name|ATA_I82801EB_S1
block|,
literal|0
block|,
literal|0
block|,
literal|2
block|,
name|ATA_SA150
block|,
literal|"ICH5"
block|}
block|,
block|{
name|ATA_I82801EB_R1
block|,
literal|0
block|,
literal|0
block|,
literal|2
block|,
name|ATA_SA150
block|,
literal|"ICH5"
block|}
block|,
block|{
name|ATA_I6300ESB
block|,
literal|0
block|,
literal|0
block|,
literal|2
block|,
name|ATA_UDMA5
block|,
literal|"6300ESB"
block|}
block|,
block|{
name|ATA_I6300ESB_S1
block|,
literal|0
block|,
literal|0
block|,
literal|2
block|,
name|ATA_SA150
block|,
literal|"6300ESB"
block|}
block|,
block|{
name|ATA_I6300ESB_R1
block|,
literal|0
block|,
literal|0
block|,
literal|2
block|,
name|ATA_SA150
block|,
literal|"6300ESB"
block|}
block|,
block|{
name|ATA_I82801FB
block|,
literal|0
block|,
literal|0
block|,
literal|2
block|,
name|ATA_UDMA5
block|,
literal|"ICH6"
block|}
block|,
block|{
name|ATA_I82801FB_S1
block|,
literal|0
block|,
name|AHCI
block|,
literal|0
block|,
name|ATA_SA150
block|,
literal|"ICH6"
block|}
block|,
block|{
name|ATA_I82801FB_R1
block|,
literal|0
block|,
name|AHCI
block|,
literal|0
block|,
name|ATA_SA150
block|,
literal|"ICH6"
block|}
block|,
block|{
name|ATA_I82801FBM
block|,
literal|0
block|,
name|AHCI
block|,
literal|0
block|,
name|ATA_SA150
block|,
literal|"ICH6M"
block|}
block|,
block|{
name|ATA_I82801GB
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
name|ATA_UDMA5
block|,
literal|"ICH7"
block|}
block|,
block|{
name|ATA_I82801GB_S1
block|,
literal|0
block|,
name|AHCI
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"ICH7"
block|}
block|,
block|{
name|ATA_I82801GB_R1
block|,
literal|0
block|,
name|AHCI
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"ICH7"
block|}
block|,
block|{
name|ATA_I82801GB_AH
block|,
literal|0
block|,
name|AHCI
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"ICH7"
block|}
block|,
block|{
name|ATA_I82801GBM_S1
block|,
literal|0
block|,
name|AHCI
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"ICH7M"
block|}
block|,
block|{
name|ATA_I82801GBM_R1
block|,
literal|0
block|,
name|AHCI
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"ICH7M"
block|}
block|,
block|{
name|ATA_I82801GBM_AH
block|,
literal|0
block|,
name|AHCI
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"ICH7M"
block|}
block|,
block|{
name|ATA_I63XXESB2
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
name|ATA_UDMA5
block|,
literal|"63XXESB2"
block|}
block|,
block|{
name|ATA_I63XXESB2_S1
block|,
literal|0
block|,
name|AHCI
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"63XXESB2"
block|}
block|,
block|{
name|ATA_I63XXESB2_S2
block|,
literal|0
block|,
name|AHCI
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"63XXESB2"
block|}
block|,
block|{
name|ATA_I63XXESB2_R1
block|,
literal|0
block|,
name|AHCI
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"63XXESB2"
block|}
block|,
block|{
name|ATA_I63XXESB2_R2
block|,
literal|0
block|,
name|AHCI
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"63XXESB2"
block|}
block|,
block|{
name|ATA_I82801HB_S1
block|,
literal|0
block|,
name|AHCI
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"ICH8"
block|}
block|,
block|{
name|ATA_I82801HB_S2
block|,
literal|0
block|,
name|AHCI
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"ICH8"
block|}
block|,
block|{
name|ATA_I82801HB_R1
block|,
literal|0
block|,
name|AHCI
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"ICH8"
block|}
block|,
block|{
name|ATA_I82801HB_AH4
block|,
literal|0
block|,
name|AHCI
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"ICH8"
block|}
block|,
block|{
name|ATA_I82801HB_AH6
block|,
literal|0
block|,
name|AHCI
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"ICH8"
block|}
block|,
block|{
name|ATA_I82801HBM
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
name|ATA_UDMA5
block|,
literal|"ICH8M"
block|}
block|,
block|{
name|ATA_I82801HBM_S1
block|,
literal|0
block|,
name|AHCI
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"ICH8M"
block|}
block|,
block|{
name|ATA_I82801HBM_S2
block|,
literal|0
block|,
name|AHCI
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"ICH8M"
block|}
block|,
block|{
name|ATA_I82801HBM_S3
block|,
literal|0
block|,
name|AHCI
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"ICH8M"
block|}
block|,
block|{
name|ATA_I82801IB_S1
block|,
literal|0
block|,
name|AHCI
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"ICH9"
block|}
block|,
block|{
name|ATA_I82801IB_S2
block|,
literal|0
block|,
name|AHCI
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"ICH9"
block|}
block|,
block|{
name|ATA_I82801IB_AH2
block|,
literal|0
block|,
name|AHCI
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"ICH9"
block|}
block|,
block|{
name|ATA_I82801IB_AH4
block|,
literal|0
block|,
name|AHCI
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"ICH9"
block|}
block|,
block|{
name|ATA_I82801IB_AH6
block|,
literal|0
block|,
name|AHCI
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"ICH9"
block|}
block|,
block|{
name|ATA_I82801IB_R1
block|,
literal|0
block|,
name|AHCI
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"ICH9"
block|}
block|,
block|{
name|ATA_I82801JIB_S1
block|,
literal|0
block|,
name|AHCI
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"ICH10"
block|}
block|,
block|{
name|ATA_I82801JIB_AH
block|,
literal|0
block|,
name|AHCI
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"ICH10"
block|}
block|,
block|{
name|ATA_I82801JIB_R1
block|,
literal|0
block|,
name|AHCI
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"ICH10"
block|}
block|,
block|{
name|ATA_I82801JIB_S2
block|,
literal|0
block|,
name|AHCI
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"ICH10"
block|}
block|,
block|{
name|ATA_I82801JD_S1
block|,
literal|0
block|,
name|AHCI
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"ICH10"
block|}
block|,
block|{
name|ATA_I82801JD_AH
block|,
literal|0
block|,
name|AHCI
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"ICH10"
block|}
block|,
block|{
name|ATA_I82801JD_R1
block|,
literal|0
block|,
name|AHCI
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"ICH10"
block|}
block|,
block|{
name|ATA_I82801JD_S2
block|,
literal|0
block|,
name|AHCI
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"ICH10"
block|}
block|,
block|{
name|ATA_I31244
block|,
literal|0
block|,
literal|0
block|,
literal|2
block|,
name|ATA_SA150
block|,
literal|"31244"
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|ctlr
operator|->
name|chip
operator|=
name|ata_match_chip
argument_list|(
name|dev
argument_list|,
name|ids
argument_list|)
operator|)
condition|)
return|return
name|ENXIO
return|;
name|ata_set_desc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|chipinit
operator|=
name|ata_intel_chipinit
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_intel_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|ata_setup_interrupt
argument_list|(
name|dev
argument_list|)
condition|)
return|return
name|ENXIO
return|;
comment|/* good old PIIX needs special treatment (not implemented) */
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|chipid
operator|==
name|ATA_I82371FB
condition|)
block|{
name|ctlr
operator|->
name|setmode
operator|=
name|ata_intel_old_setmode
expr_stmt|;
block|}
comment|/* the intel 31244 needs special care if in DPA mode */
elseif|else
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|chipid
operator|==
name|ATA_I31244
condition|)
block|{
if|if
condition|(
name|pci_get_subclass
argument_list|(
name|dev
argument_list|)
operator|!=
name|PCIS_STORAGE_IDE
condition|)
block|{
name|ctlr
operator|->
name|r_type2
operator|=
name|SYS_RES_MEMORY
expr_stmt|;
name|ctlr
operator|->
name|r_rid2
operator|=
name|PCIR_BAR
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ctlr
operator|->
name|r_res2
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|ctlr
operator|->
name|r_type2
argument_list|,
operator|&
name|ctlr
operator|->
name|r_rid2
argument_list|,
name|RF_ACTIVE
argument_list|)
operator|)
condition|)
return|return
name|ENXIO
return|;
name|ctlr
operator|->
name|channels
operator|=
literal|4
expr_stmt|;
name|ctlr
operator|->
name|allocate
operator|=
name|ata_intel_31244_allocate
expr_stmt|;
name|ctlr
operator|->
name|reset
operator|=
name|ata_intel_31244_reset
expr_stmt|;
block|}
name|ctlr
operator|->
name|setmode
operator|=
name|ata_sata_setmode
expr_stmt|;
block|}
comment|/* non SATA intel chips goes here */
elseif|else
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|max_dma
operator|<
name|ATA_SA150
condition|)
block|{
name|ctlr
operator|->
name|channels
operator|=
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
expr_stmt|;
name|ctlr
operator|->
name|allocate
operator|=
name|ata_intel_allocate
expr_stmt|;
name|ctlr
operator|->
name|setmode
operator|=
name|ata_intel_new_setmode
expr_stmt|;
block|}
comment|/* SATA parts can be either compat or AHCI */
else|else
block|{
comment|/* force all ports active "the legacy way" */
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x92
argument_list|,
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x92
argument_list|,
literal|2
argument_list|)
operator||
literal|0x0f
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|allocate
operator|=
name|ata_intel_allocate
expr_stmt|;
name|ctlr
operator|->
name|reset
operator|=
name|ata_intel_reset
expr_stmt|;
comment|/*  	 * if we have AHCI capability and AHCI or RAID mode enabled 	 * in BIOS we try for AHCI mode 	 */
if|if
condition|(
operator|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg1
operator|==
name|AHCI
operator|)
operator|&&
operator|(
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x90
argument_list|,
literal|1
argument_list|)
operator|&
literal|0xc0
operator|)
operator|&&
operator|(
name|ata_ahci_chipinit
argument_list|(
name|dev
argument_list|)
operator|!=
name|ENXIO
operator|)
condition|)
return|return
literal|0
return|;
comment|/* if BAR(5) is IO it should point to SATA interface registers */
name|ctlr
operator|->
name|r_type2
operator|=
name|SYS_RES_IOPORT
expr_stmt|;
name|ctlr
operator|->
name|r_rid2
operator|=
name|PCIR_BAR
argument_list|(
literal|5
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ctlr
operator|->
name|r_res2
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|ctlr
operator|->
name|r_type2
argument_list|,
operator|&
name|ctlr
operator|->
name|r_rid2
argument_list|,
name|RF_ACTIVE
argument_list|)
operator|)
condition|)
name|ctlr
operator|->
name|setmode
operator|=
name|ata_intel_sata_setmode
expr_stmt|;
else|else
name|ctlr
operator|->
name|setmode
operator|=
name|ata_sata_setmode
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_intel_allocate
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
comment|/* setup the usual register normal pci style */
if|if
condition|(
name|ata_pci_allocate
argument_list|(
name|dev
argument_list|)
condition|)
return|return
name|ENXIO
return|;
comment|/* if r_res2 is valid it points to SATA interface registers */
if|if
condition|(
name|ctlr
operator|->
name|r_res2
condition|)
block|{
name|ch
operator|->
name|r_io
index|[
name|ATA_IDX_ADDR
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_res2
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_IDX_ADDR
index|]
operator|.
name|offset
operator|=
literal|0x00
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_IDX_DATA
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_res2
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_IDX_DATA
index|]
operator|.
name|offset
operator|=
literal|0x04
expr_stmt|;
block|}
name|ch
operator|->
name|flags
operator||=
name|ATA_ALWAYS_DMASTAT
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_intel_reset
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|device_t
name|parent
init|=
name|device_get_parent
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|parent
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|mask
decl_stmt|,
name|timeout
decl_stmt|;
comment|/* ICH6& ICH7 in compat mode has 4 SATA ports as master/slave on 2 ch's */
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg1
condition|)
block|{
name|mask
operator|=
operator|(
literal|0x0005
operator|<<
name|ch
operator|->
name|unit
operator|)
expr_stmt|;
block|}
else|else
block|{
comment|/* ICH5 in compat mode has SATA ports as master/slave on 1 channel */
if|if
condition|(
name|pci_read_config
argument_list|(
name|parent
argument_list|,
literal|0x90
argument_list|,
literal|1
argument_list|)
operator|&
literal|0x04
condition|)
name|mask
operator|=
literal|0x0003
expr_stmt|;
else|else
block|{
name|mask
operator|=
operator|(
literal|0x0001
operator|<<
name|ch
operator|->
name|unit
operator|)
expr_stmt|;
comment|/* XXX SOS should be in intel_allocate if we grow it */
name|ch
operator|->
name|flags
operator||=
name|ATA_NO_SLAVE
expr_stmt|;
block|}
block|}
name|pci_write_config
argument_list|(
name|parent
argument_list|,
literal|0x92
argument_list|,
name|pci_read_config
argument_list|(
name|parent
argument_list|,
literal|0x92
argument_list|,
literal|2
argument_list|)
operator|&
operator|~
name|mask
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|parent
argument_list|,
literal|0x92
argument_list|,
name|pci_read_config
argument_list|(
name|parent
argument_list|,
literal|0x92
argument_list|,
literal|2
argument_list|)
operator||
name|mask
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* wait up to 1 sec for "connect well" */
for|for
control|(
name|timeout
operator|=
literal|0
init|;
name|timeout
operator|<
literal|100
condition|;
name|timeout
operator|++
control|)
block|{
if|if
condition|(
operator|(
operator|(
name|pci_read_config
argument_list|(
name|parent
argument_list|,
literal|0x92
argument_list|,
literal|2
argument_list|)
operator|&
operator|(
name|mask
operator|<<
literal|4
operator|)
operator|)
operator|==
operator|(
name|mask
operator|<<
literal|4
operator|)
operator|)
operator|&&
operator|(
name|ATA_IDX_INB
argument_list|(
name|ch
argument_list|,
name|ATA_STATUS
argument_list|)
operator|!=
literal|0xff
operator|)
condition|)
break|break;
name|ata_udelay
argument_list|(
literal|10000
argument_list|)
expr_stmt|;
block|}
name|ata_generic_reset
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_intel_old_setmode
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
comment|/* NOT YET */
block|}
end_function

begin_function
specifier|static
name|void
name|ata_intel_new_setmode
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|device_t
name|gparent
init|=
name|GRANDPARENT
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|gparent
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_device
modifier|*
name|atadev
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|devno
init|=
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|1
operator|)
operator|+
name|ATA_DEV
argument_list|(
name|atadev
operator|->
name|unit
argument_list|)
decl_stmt|;
name|u_int32_t
name|reg40
init|=
name|pci_read_config
argument_list|(
name|gparent
argument_list|,
literal|0x40
argument_list|,
literal|4
argument_list|)
decl_stmt|;
name|u_int8_t
name|reg44
init|=
name|pci_read_config
argument_list|(
name|gparent
argument_list|,
literal|0x44
argument_list|,
literal|1
argument_list|)
decl_stmt|;
name|u_int8_t
name|reg48
init|=
name|pci_read_config
argument_list|(
name|gparent
argument_list|,
literal|0x48
argument_list|,
literal|1
argument_list|)
decl_stmt|;
name|u_int16_t
name|reg4a
init|=
name|pci_read_config
argument_list|(
name|gparent
argument_list|,
literal|0x4a
argument_list|,
literal|2
argument_list|)
decl_stmt|;
name|u_int16_t
name|reg54
init|=
name|pci_read_config
argument_list|(
name|gparent
argument_list|,
literal|0x54
argument_list|,
literal|2
argument_list|)
decl_stmt|;
name|u_int32_t
name|mask40
init|=
literal|0
decl_stmt|,
name|new40
init|=
literal|0
decl_stmt|;
name|u_int8_t
name|mask44
init|=
literal|0
decl_stmt|,
name|new44
init|=
literal|0
decl_stmt|;
name|int
name|error
decl_stmt|;
name|u_int8_t
name|timings
index|[]
init|=
block|{
literal|0x00
block|,
literal|0x00
block|,
literal|0x10
block|,
literal|0x21
block|,
literal|0x23
block|,
literal|0x10
block|,
literal|0x21
block|,
literal|0x23
block|,
literal|0x23
block|,
literal|0x23
block|,
literal|0x23
block|,
literal|0x23
block|,
literal|0x23
block|,
literal|0x23
block|}
decl_stmt|;
name|mode
operator|=
name|ata_limit_mode
argument_list|(
name|dev
argument_list|,
name|mode
argument_list|,
name|ctlr
operator|->
name|chip
operator|->
name|max_dma
argument_list|)
expr_stmt|;
if|if
condition|(
name|mode
operator|>
name|ATA_UDMA2
operator|&&
operator|!
operator|(
name|reg54
operator|&
operator|(
literal|0x10
operator|<<
name|devno
operator|)
operator|)
condition|)
block|{
name|ata_print_cable
argument_list|(
name|dev
argument_list|,
literal|"controller"
argument_list|)
expr_stmt|;
name|mode
operator|=
name|ATA_UDMA2
expr_stmt|;
block|}
name|error
operator|=
name|ata_controlcmd
argument_list|(
name|dev
argument_list|,
name|ATA_SETFEATURES
argument_list|,
name|ATA_SF_SETXFER
argument_list|,
literal|0
argument_list|,
name|mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%ssetting %s on %s chip\n"
argument_list|,
operator|(
name|error
operator|)
condition|?
literal|"FAILURE "
else|:
literal|""
argument_list|,
name|ata_mode2str
argument_list|(
name|mode
argument_list|)
argument_list|,
name|ctlr
operator|->
name|chip
operator|->
name|text
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
block|{
if|if
condition|(
name|mode
operator|>=
name|ATA_UDMA0
condition|)
block|{
name|u_int8_t
name|utimings
index|[]
init|=
block|{
literal|0x00
block|,
literal|0x01
block|,
literal|0x10
block|,
literal|0x01
block|,
literal|0x10
block|,
literal|0x01
block|,
literal|0x10
block|}
decl_stmt|;
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
literal|0x48
argument_list|,
name|reg48
operator||
operator|(
literal|0x0001
operator|<<
name|devno
operator|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
literal|0x4a
argument_list|,
operator|(
name|reg4a
operator|&
operator|~
operator|(
literal|0x3
operator|<<
operator|(
name|devno
operator|<<
literal|2
operator|)
operator|)
operator|)
operator||
operator|(
name|utimings
index|[
name|mode
operator|&
name|ATA_MODE_MASK
index|]
operator|<<
operator|(
name|devno
operator|<<
literal|2
operator|)
operator|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
literal|0x48
argument_list|,
name|reg48
operator|&
operator|~
operator|(
literal|0x0001
operator|<<
name|devno
operator|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
literal|0x4a
argument_list|,
operator|(
name|reg4a
operator|&
operator|~
operator|(
literal|0x3
operator|<<
operator|(
name|devno
operator|<<
literal|2
operator|)
operator|)
operator|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
name|reg54
operator||=
literal|0x0400
expr_stmt|;
if|if
condition|(
name|mode
operator|>=
name|ATA_UDMA2
condition|)
name|reg54
operator||=
operator|(
literal|0x1
operator|<<
name|devno
operator|)
expr_stmt|;
else|else
name|reg54
operator|&=
operator|~
operator|(
literal|0x1
operator|<<
name|devno
operator|)
expr_stmt|;
if|if
condition|(
name|mode
operator|>=
name|ATA_UDMA5
condition|)
name|reg54
operator||=
operator|(
literal|0x1000
operator|<<
name|devno
operator|)
expr_stmt|;
else|else
name|reg54
operator|&=
operator|~
operator|(
literal|0x1000
operator|<<
name|devno
operator|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
literal|0x54
argument_list|,
name|reg54
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|reg40
operator|&=
operator|~
literal|0x00ff00ff
expr_stmt|;
name|reg40
operator||=
literal|0x40774077
expr_stmt|;
if|if
condition|(
name|atadev
operator|->
name|unit
operator|==
name|ATA_MASTER
condition|)
block|{
name|mask40
operator|=
literal|0x3300
expr_stmt|;
name|new40
operator|=
name|timings
index|[
name|ata_mode2idx
argument_list|(
name|mode
argument_list|)
index|]
operator|<<
literal|8
expr_stmt|;
block|}
else|else
block|{
name|mask44
operator|=
literal|0x0f
expr_stmt|;
name|new44
operator|=
operator|(
operator|(
name|timings
index|[
name|ata_mode2idx
argument_list|(
name|mode
argument_list|)
index|]
operator|&
literal|0x30
operator|)
operator|>>
literal|2
operator|)
operator||
operator|(
name|timings
index|[
name|ata_mode2idx
argument_list|(
name|mode
argument_list|)
index|]
operator|&
literal|0x03
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|ch
operator|->
name|unit
condition|)
block|{
name|mask40
operator|<<=
literal|16
expr_stmt|;
name|new40
operator|<<=
literal|16
expr_stmt|;
name|mask44
operator|<<=
literal|4
expr_stmt|;
name|new44
operator|<<=
literal|4
expr_stmt|;
block|}
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
literal|0x40
argument_list|,
operator|(
name|reg40
operator|&
operator|~
name|mask40
operator|)
operator||
name|new40
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
literal|0x44
argument_list|,
operator|(
name|reg44
operator|&
operator|~
name|mask44
operator|)
operator||
name|new44
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|atadev
operator|->
name|mode
operator|=
name|mode
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ata_intel_sata_setmode
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|struct
name|ata_device
modifier|*
name|atadev
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|atadev
operator|->
name|param
operator|.
name|satacapabilities
operator|!=
literal|0x0000
operator|&&
name|atadev
operator|->
name|param
operator|.
name|satacapabilities
operator|!=
literal|0xffff
condition|)
block|{
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|int
name|devno
init|=
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|1
operator|)
operator|+
name|ATA_DEV
argument_list|(
name|atadev
operator|->
name|unit
argument_list|)
decl_stmt|;
comment|/* on some drives we need to set the transfer mode */
name|ata_controlcmd
argument_list|(
name|dev
argument_list|,
name|ATA_SETFEATURES
argument_list|,
name|ATA_SF_SETXFER
argument_list|,
literal|0
argument_list|,
name|ata_limit_mode
argument_list|(
name|dev
argument_list|,
name|mode
argument_list|,
name|ATA_UDMA6
argument_list|)
argument_list|)
expr_stmt|;
comment|/* set ATA_SSTATUS register offset */
name|ATA_IDX_OUTL
argument_list|(
name|ch
argument_list|,
name|ATA_IDX_ADDR
argument_list|,
name|devno
operator|*
literal|0x100
argument_list|)
expr_stmt|;
comment|/* query SATA STATUS for the speed */
if|if
condition|(
operator|(
name|ATA_IDX_INL
argument_list|(
name|ch
argument_list|,
name|ATA_IDX_DATA
argument_list|)
operator|&
name|ATA_SS_CONWELL_MASK
operator|)
operator|==
name|ATA_SS_CONWELL_GEN2
condition|)
name|atadev
operator|->
name|mode
operator|=
name|ATA_SA300
expr_stmt|;
else|else
name|atadev
operator|->
name|mode
operator|=
name|ATA_SA150
expr_stmt|;
block|}
else|else
block|{
name|mode
operator|=
name|ata_limit_mode
argument_list|(
name|dev
argument_list|,
name|mode
argument_list|,
name|ATA_UDMA5
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ata_controlcmd
argument_list|(
name|dev
argument_list|,
name|ATA_SETFEATURES
argument_list|,
name|ATA_SF_SETXFER
argument_list|,
literal|0
argument_list|,
name|mode
argument_list|)
condition|)
name|atadev
operator|->
name|mode
operator|=
name|mode
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|ata_intel_31244_allocate
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|ch_offset
decl_stmt|;
name|ch_offset
operator|=
literal|0x200
operator|+
name|ch
operator|->
name|unit
operator|*
literal|0x200
expr_stmt|;
for|for
control|(
name|i
operator|=
name|ATA_DATA
init|;
name|i
operator|<
name|ATA_MAX_RES
condition|;
name|i
operator|++
control|)
name|ch
operator|->
name|r_io
index|[
name|i
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_res2
expr_stmt|;
comment|/* setup ATA registers */
name|ch
operator|->
name|r_io
index|[
name|ATA_DATA
index|]
operator|.
name|offset
operator|=
name|ch_offset
operator|+
literal|0x00
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_FEATURE
index|]
operator|.
name|offset
operator|=
name|ch_offset
operator|+
literal|0x06
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_COUNT
index|]
operator|.
name|offset
operator|=
name|ch_offset
operator|+
literal|0x08
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SECTOR
index|]
operator|.
name|offset
operator|=
name|ch_offset
operator|+
literal|0x0c
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_CYL_LSB
index|]
operator|.
name|offset
operator|=
name|ch_offset
operator|+
literal|0x10
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_CYL_MSB
index|]
operator|.
name|offset
operator|=
name|ch_offset
operator|+
literal|0x14
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_DRIVE
index|]
operator|.
name|offset
operator|=
name|ch_offset
operator|+
literal|0x18
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_COMMAND
index|]
operator|.
name|offset
operator|=
name|ch_offset
operator|+
literal|0x1d
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_ERROR
index|]
operator|.
name|offset
operator|=
name|ch_offset
operator|+
literal|0x04
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_STATUS
index|]
operator|.
name|offset
operator|=
name|ch_offset
operator|+
literal|0x1c
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_ALTSTAT
index|]
operator|.
name|offset
operator|=
name|ch_offset
operator|+
literal|0x28
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_CONTROL
index|]
operator|.
name|offset
operator|=
name|ch_offset
operator|+
literal|0x29
expr_stmt|;
comment|/* setup DMA registers */
name|ch
operator|->
name|r_io
index|[
name|ATA_SSTATUS
index|]
operator|.
name|offset
operator|=
name|ch_offset
operator|+
literal|0x100
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SERROR
index|]
operator|.
name|offset
operator|=
name|ch_offset
operator|+
literal|0x104
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SCONTROL
index|]
operator|.
name|offset
operator|=
name|ch_offset
operator|+
literal|0x108
expr_stmt|;
comment|/* setup SATA registers */
name|ch
operator|->
name|r_io
index|[
name|ATA_BMCMD_PORT
index|]
operator|.
name|offset
operator|=
name|ch_offset
operator|+
literal|0x70
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_BMSTAT_PORT
index|]
operator|.
name|offset
operator|=
name|ch_offset
operator|+
literal|0x72
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_BMDTP_PORT
index|]
operator|.
name|offset
operator|=
name|ch_offset
operator|+
literal|0x74
expr_stmt|;
name|ch
operator|->
name|flags
operator||=
name|ATA_NO_SLAVE
expr_stmt|;
name|ata_pci_hw
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|ch
operator|->
name|hw
operator|.
name|status
operator|=
name|ata_intel_31244_status
expr_stmt|;
name|ch
operator|->
name|hw
operator|.
name|tf_write
operator|=
name|ata_intel_31244_tf_write
expr_stmt|;
comment|/* enable PHY state change interrupt */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x4
argument_list|,
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x04
argument_list|)
operator||
operator|(
literal|0x01
operator|<<
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|3
operator|)
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_intel_31244_status
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
comment|/* do we have any PHY events ? */
name|ata_sata_phy_check_events
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* any drive action to take care of ? */
return|return
name|ata_pci_status
argument_list|(
name|dev
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_intel_31244_tf_write
parameter_list|(
name|struct
name|ata_request
modifier|*
name|request
parameter_list|)
block|{
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|request
operator|->
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_device
modifier|*
name|atadev
init|=
name|device_get_softc
argument_list|(
name|request
operator|->
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|atadev
operator|->
name|flags
operator|&
name|ATA_D_48BIT_ACTIVE
condition|)
block|{
name|ATA_IDX_OUTW
argument_list|(
name|ch
argument_list|,
name|ATA_FEATURE
argument_list|,
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|feature
argument_list|)
expr_stmt|;
name|ATA_IDX_OUTW
argument_list|(
name|ch
argument_list|,
name|ATA_COUNT
argument_list|,
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|count
argument_list|)
expr_stmt|;
name|ATA_IDX_OUTW
argument_list|(
name|ch
argument_list|,
name|ATA_SECTOR
argument_list|,
operator|(
operator|(
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|>>
literal|16
operator|)
operator|&
literal|0xff00
operator|)
operator||
operator|(
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|&
literal|0x00ff
operator|)
argument_list|)
expr_stmt|;
name|ATA_IDX_OUTW
argument_list|(
name|ch
argument_list|,
name|ATA_CYL_LSB
argument_list|,
operator|(
operator|(
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|>>
literal|24
operator|)
operator|&
literal|0xff00
operator|)
operator||
operator|(
operator|(
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|>>
literal|8
operator|)
operator|&
literal|0x00ff
operator|)
argument_list|)
expr_stmt|;
name|ATA_IDX_OUTW
argument_list|(
name|ch
argument_list|,
name|ATA_CYL_MSB
argument_list|,
operator|(
operator|(
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|>>
literal|32
operator|)
operator|&
literal|0xff00
operator|)
operator||
operator|(
operator|(
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|>>
literal|16
operator|)
operator|&
literal|0x00ff
operator|)
argument_list|)
expr_stmt|;
name|ATA_IDX_OUTW
argument_list|(
name|ch
argument_list|,
name|ATA_DRIVE
argument_list|,
name|ATA_D_LBA
operator||
name|atadev
operator|->
name|unit
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ATA_IDX_OUTB
argument_list|(
name|ch
argument_list|,
name|ATA_FEATURE
argument_list|,
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|feature
argument_list|)
expr_stmt|;
name|ATA_IDX_OUTB
argument_list|(
name|ch
argument_list|,
name|ATA_COUNT
argument_list|,
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|count
argument_list|)
expr_stmt|;
if|if
condition|(
name|atadev
operator|->
name|flags
operator|&
name|ATA_D_USE_CHS
condition|)
block|{
name|int
name|heads
decl_stmt|,
name|sectors
decl_stmt|;
if|if
condition|(
name|atadev
operator|->
name|param
operator|.
name|atavalid
operator|&
name|ATA_FLAG_54_58
condition|)
block|{
name|heads
operator|=
name|atadev
operator|->
name|param
operator|.
name|current_heads
expr_stmt|;
name|sectors
operator|=
name|atadev
operator|->
name|param
operator|.
name|current_sectors
expr_stmt|;
block|}
else|else
block|{
name|heads
operator|=
name|atadev
operator|->
name|param
operator|.
name|heads
expr_stmt|;
name|sectors
operator|=
name|atadev
operator|->
name|param
operator|.
name|sectors
expr_stmt|;
block|}
name|ATA_IDX_OUTB
argument_list|(
name|ch
argument_list|,
name|ATA_SECTOR
argument_list|,
operator|(
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|%
name|sectors
operator|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|ATA_IDX_OUTB
argument_list|(
name|ch
argument_list|,
name|ATA_CYL_LSB
argument_list|,
operator|(
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|/
operator|(
name|sectors
operator|*
name|heads
operator|)
operator|)
argument_list|)
expr_stmt|;
name|ATA_IDX_OUTB
argument_list|(
name|ch
argument_list|,
name|ATA_CYL_MSB
argument_list|,
operator|(
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|/
operator|(
name|sectors
operator|*
name|heads
operator|)
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|ATA_IDX_OUTB
argument_list|(
name|ch
argument_list|,
name|ATA_DRIVE
argument_list|,
name|ATA_D_IBM
operator||
name|atadev
operator|->
name|unit
operator||
operator|(
operator|(
operator|(
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|%
operator|(
name|sectors
operator|*
name|heads
operator|)
operator|)
operator|/
name|sectors
operator|)
operator|&
literal|0xf
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ATA_IDX_OUTB
argument_list|(
name|ch
argument_list|,
name|ATA_SECTOR
argument_list|,
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
argument_list|)
expr_stmt|;
name|ATA_IDX_OUTB
argument_list|(
name|ch
argument_list|,
name|ATA_CYL_LSB
argument_list|,
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|ATA_IDX_OUTB
argument_list|(
name|ch
argument_list|,
name|ATA_CYL_MSB
argument_list|,
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|>>
literal|16
argument_list|)
expr_stmt|;
name|ATA_IDX_OUTB
argument_list|(
name|ch
argument_list|,
name|ATA_DRIVE
argument_list|,
name|ATA_D_IBM
operator||
name|ATA_D_LBA
operator||
name|atadev
operator|->
name|unit
operator||
operator|(
operator|(
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|>>
literal|24
operator|)
operator|&
literal|0x0f
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ata_intel_31244_reset
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
if|if
condition|(
name|ata_sata_phy_reset
argument_list|(
name|dev
argument_list|)
condition|)
name|ata_generic_reset
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Integrated Technology Express Inc. (ITE) chipset support functions  */
end_comment

begin_function
name|int
name|ata_ite_ident
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
specifier|static
name|struct
name|ata_chip_id
name|ids
index|[]
init|=
block|{
block|{
name|ATA_IT8213F
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
name|ATA_UDMA6
block|,
literal|"IT8213F"
block|}
block|,
block|{
name|ATA_IT8212F
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
name|ATA_UDMA6
block|,
literal|"IT8212F"
block|}
block|,
block|{
name|ATA_IT8211F
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
name|ATA_UDMA6
block|,
literal|"IT8211F"
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|ctlr
operator|->
name|chip
operator|=
name|ata_match_chip
argument_list|(
name|dev
argument_list|,
name|ids
argument_list|)
operator|)
condition|)
return|return
name|ENXIO
return|;
name|ata_set_desc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|chipinit
operator|=
name|ata_ite_chipinit
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_ite_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|ata_setup_interrupt
argument_list|(
name|dev
argument_list|)
condition|)
return|return
name|ENXIO
return|;
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|chipid
operator|==
name|ATA_IT8213F
condition|)
block|{
comment|/* the ITE 8213F only has one channel */
name|ctlr
operator|->
name|channels
operator|=
literal|1
expr_stmt|;
name|ctlr
operator|->
name|setmode
operator|=
name|ata_ite_8213_setmode
expr_stmt|;
block|}
else|else
block|{
comment|/* set PCI mode and 66Mhz reference clock */
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x50
argument_list|,
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x50
argument_list|,
literal|1
argument_list|)
operator|&
operator|~
literal|0x83
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* set default active& recover timings */
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x54
argument_list|,
literal|0x31
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x56
argument_list|,
literal|0x31
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|setmode
operator|=
name|ata_ite_821x_setmode
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_ite_821x_setmode
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|device_t
name|gparent
init|=
name|GRANDPARENT
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_device
modifier|*
name|atadev
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|devno
init|=
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|1
operator|)
operator|+
name|ATA_DEV
argument_list|(
name|atadev
operator|->
name|unit
argument_list|)
decl_stmt|;
name|int
name|error
decl_stmt|;
comment|/* correct the mode for what the HW supports */
name|mode
operator|=
name|ata_limit_mode
argument_list|(
name|dev
argument_list|,
name|mode
argument_list|,
name|ATA_UDMA6
argument_list|)
expr_stmt|;
comment|/* check the CBLID bits for 80 conductor cable detection */
if|if
condition|(
name|mode
operator|>
name|ATA_UDMA2
operator|&&
operator|(
name|pci_read_config
argument_list|(
name|gparent
argument_list|,
literal|0x40
argument_list|,
literal|2
argument_list|)
operator|&
operator|(
name|ch
operator|->
name|unit
condition|?
operator|(
literal|1
operator|<<
literal|3
operator|)
else|:
operator|(
literal|1
operator|<<
literal|2
operator|)
operator|)
operator|)
condition|)
block|{
name|ata_print_cable
argument_list|(
name|dev
argument_list|,
literal|"controller"
argument_list|)
expr_stmt|;
name|mode
operator|=
name|ATA_UDMA2
expr_stmt|;
block|}
comment|/* set the wanted mode on the device */
name|error
operator|=
name|ata_controlcmd
argument_list|(
name|dev
argument_list|,
name|ATA_SETFEATURES
argument_list|,
name|ATA_SF_SETXFER
argument_list|,
literal|0
argument_list|,
name|mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s setting %s on ITE8212F chip\n"
argument_list|,
operator|(
name|error
operator|)
condition|?
literal|"failed"
else|:
literal|"success"
argument_list|,
name|ata_mode2str
argument_list|(
name|mode
argument_list|)
argument_list|)
expr_stmt|;
comment|/* if the device accepted the mode change, setup the HW accordingly */
if|if
condition|(
operator|!
name|error
condition|)
block|{
if|if
condition|(
name|mode
operator|>=
name|ATA_UDMA0
condition|)
block|{
name|u_int8_t
name|udmatiming
index|[]
init|=
block|{
literal|0x44
block|,
literal|0x42
block|,
literal|0x31
block|,
literal|0x21
block|,
literal|0x11
block|,
literal|0xa2
block|,
literal|0x91
block|}
decl_stmt|;
comment|/* enable UDMA mode */
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
literal|0x50
argument_list|,
name|pci_read_config
argument_list|(
name|gparent
argument_list|,
literal|0x50
argument_list|,
literal|1
argument_list|)
operator|&
operator|~
operator|(
literal|1
operator|<<
operator|(
name|devno
operator|+
literal|3
operator|)
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* set UDMA timing */
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
literal|0x56
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|2
operator|)
operator|+
name|ATA_DEV
argument_list|(
name|atadev
operator|->
name|unit
argument_list|)
argument_list|,
name|udmatiming
index|[
name|mode
operator|&
name|ATA_MODE_MASK
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|u_int8_t
name|chtiming
index|[]
init|=
block|{
literal|0xaa
block|,
literal|0xa3
block|,
literal|0xa1
block|,
literal|0x33
block|,
literal|0x31
block|,
literal|0x88
block|,
literal|0x32
block|,
literal|0x31
block|}
decl_stmt|;
comment|/* disable UDMA mode */
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
literal|0x50
argument_list|,
name|pci_read_config
argument_list|(
name|gparent
argument_list|,
literal|0x50
argument_list|,
literal|1
argument_list|)
operator||
operator|(
literal|1
operator|<<
operator|(
name|devno
operator|+
literal|3
operator|)
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* set active and recover timing (shared between master& slave) */
if|if
condition|(
name|pci_read_config
argument_list|(
name|gparent
argument_list|,
literal|0x54
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|2
operator|)
argument_list|,
literal|1
argument_list|)
operator|<
name|chtiming
index|[
name|ata_mode2idx
argument_list|(
name|mode
argument_list|)
index|]
condition|)
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
literal|0x54
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|2
operator|)
argument_list|,
name|chtiming
index|[
name|ata_mode2idx
argument_list|(
name|mode
argument_list|)
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|atadev
operator|->
name|mode
operator|=
name|mode
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ata_ite_8213_setmode
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|device_t
name|gparent
init|=
name|GRANDPARENT
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|gparent
argument_list|)
decl_stmt|;
name|struct
name|ata_device
modifier|*
name|atadev
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|u_int16_t
name|reg40
init|=
name|pci_read_config
argument_list|(
name|gparent
argument_list|,
literal|0x40
argument_list|,
literal|2
argument_list|)
decl_stmt|;
name|u_int8_t
name|reg44
init|=
name|pci_read_config
argument_list|(
name|gparent
argument_list|,
literal|0x44
argument_list|,
literal|1
argument_list|)
decl_stmt|;
name|u_int8_t
name|reg48
init|=
name|pci_read_config
argument_list|(
name|gparent
argument_list|,
literal|0x48
argument_list|,
literal|1
argument_list|)
decl_stmt|;
name|u_int16_t
name|reg4a
init|=
name|pci_read_config
argument_list|(
name|gparent
argument_list|,
literal|0x4a
argument_list|,
literal|2
argument_list|)
decl_stmt|;
name|u_int16_t
name|reg54
init|=
name|pci_read_config
argument_list|(
name|gparent
argument_list|,
literal|0x54
argument_list|,
literal|2
argument_list|)
decl_stmt|;
name|u_int16_t
name|mask40
init|=
literal|0
decl_stmt|,
name|new40
init|=
literal|0
decl_stmt|;
name|u_int8_t
name|mask44
init|=
literal|0
decl_stmt|,
name|new44
init|=
literal|0
decl_stmt|;
name|int
name|devno
init|=
name|atadev
operator|->
name|unit
decl_stmt|;
name|int
name|error
decl_stmt|;
name|u_int8_t
name|timings
index|[]
init|=
block|{
literal|0x00
block|,
literal|0x00
block|,
literal|0x10
block|,
literal|0x21
block|,
literal|0x23
block|,
literal|0x10
block|,
literal|0x21
block|,
literal|0x23
block|,
literal|0x23
block|,
literal|0x23
block|,
literal|0x23
block|,
literal|0x23
block|,
literal|0x23
block|,
literal|0x23
block|}
decl_stmt|;
name|mode
operator|=
name|ata_limit_mode
argument_list|(
name|dev
argument_list|,
name|mode
argument_list|,
name|ctlr
operator|->
name|chip
operator|->
name|max_dma
argument_list|)
expr_stmt|;
if|if
condition|(
name|mode
operator|>
name|ATA_UDMA2
operator|&&
operator|!
operator|(
name|reg54
operator|&
operator|(
literal|0x10
operator|<<
name|devno
operator|)
operator|)
condition|)
block|{
name|ata_print_cable
argument_list|(
name|dev
argument_list|,
literal|"controller"
argument_list|)
expr_stmt|;
name|mode
operator|=
name|ATA_UDMA2
expr_stmt|;
block|}
name|error
operator|=
name|ata_controlcmd
argument_list|(
name|dev
argument_list|,
name|ATA_SETFEATURES
argument_list|,
name|ATA_SF_SETXFER
argument_list|,
literal|0
argument_list|,
name|mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%ssetting %s on %s chip\n"
argument_list|,
operator|(
name|error
operator|)
condition|?
literal|"FAILURE "
else|:
literal|""
argument_list|,
name|ata_mode2str
argument_list|(
name|mode
argument_list|)
argument_list|,
name|ctlr
operator|->
name|chip
operator|->
name|text
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
block|{
if|if
condition|(
name|mode
operator|>=
name|ATA_UDMA0
condition|)
block|{
name|u_int8_t
name|utimings
index|[]
init|=
block|{
literal|0x00
block|,
literal|0x01
block|,
literal|0x10
block|,
literal|0x01
block|,
literal|0x10
block|,
literal|0x01
block|,
literal|0x10
block|}
decl_stmt|;
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
literal|0x48
argument_list|,
name|reg48
operator||
operator|(
literal|0x0001
operator|<<
name|devno
operator|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
literal|0x4a
argument_list|,
operator|(
name|reg4a
operator|&
operator|~
operator|(
literal|0x3
operator|<<
operator|(
name|devno
operator|<<
literal|2
operator|)
operator|)
operator|)
operator||
operator|(
name|utimings
index|[
name|mode
operator|&
name|ATA_MODE_MASK
index|]
operator|<<
operator|(
name|devno
operator|<<
literal|2
operator|)
operator|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
literal|0x48
argument_list|,
name|reg48
operator|&
operator|~
operator|(
literal|0x0001
operator|<<
name|devno
operator|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
literal|0x4a
argument_list|,
operator|(
name|reg4a
operator|&
operator|~
operator|(
literal|0x3
operator|<<
operator|(
name|devno
operator|<<
literal|2
operator|)
operator|)
operator|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mode
operator|>=
name|ATA_UDMA2
condition|)
name|reg54
operator||=
operator|(
literal|0x1
operator|<<
name|devno
operator|)
expr_stmt|;
else|else
name|reg54
operator|&=
operator|~
operator|(
literal|0x1
operator|<<
name|devno
operator|)
expr_stmt|;
if|if
condition|(
name|mode
operator|>=
name|ATA_UDMA5
condition|)
name|reg54
operator||=
operator|(
literal|0x1000
operator|<<
name|devno
operator|)
expr_stmt|;
else|else
name|reg54
operator|&=
operator|~
operator|(
literal|0x1000
operator|<<
name|devno
operator|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
literal|0x54
argument_list|,
name|reg54
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|reg40
operator|&=
literal|0xff00
expr_stmt|;
name|reg40
operator||=
literal|0x4033
expr_stmt|;
if|if
condition|(
name|atadev
operator|->
name|unit
operator|==
name|ATA_MASTER
condition|)
block|{
name|reg40
operator||=
operator|(
name|ata_atapi
argument_list|(
name|dev
argument_list|)
condition|?
literal|0x04
else|:
literal|0x00
operator|)
expr_stmt|;
name|mask40
operator|=
literal|0x3300
expr_stmt|;
name|new40
operator|=
name|timings
index|[
name|ata_mode2idx
argument_list|(
name|mode
argument_list|)
index|]
operator|<<
literal|8
expr_stmt|;
block|}
else|else
block|{
name|reg40
operator||=
operator|(
name|ata_atapi
argument_list|(
name|dev
argument_list|)
condition|?
literal|0x40
else|:
literal|0x00
operator|)
expr_stmt|;
name|mask44
operator|=
literal|0x0f
expr_stmt|;
name|new44
operator|=
operator|(
operator|(
name|timings
index|[
name|ata_mode2idx
argument_list|(
name|mode
argument_list|)
index|]
operator|&
literal|0x30
operator|)
operator|>>
literal|2
operator|)
operator||
operator|(
name|timings
index|[
name|ata_mode2idx
argument_list|(
name|mode
argument_list|)
index|]
operator|&
literal|0x03
operator|)
expr_stmt|;
block|}
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
literal|0x40
argument_list|,
operator|(
name|reg40
operator|&
operator|~
name|mask40
operator|)
operator||
name|new40
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
literal|0x44
argument_list|,
operator|(
name|reg44
operator|&
operator|~
name|mask44
operator|)
operator||
name|new44
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|atadev
operator|->
name|mode
operator|=
name|mode
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * JMicron chipset support functions  */
end_comment

begin_function
name|int
name|ata_jmicron_ident
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ata_chip_id
modifier|*
name|idx
decl_stmt|;
specifier|static
name|struct
name|ata_chip_id
name|ids
index|[]
init|=
block|{
block|{
name|ATA_JMB360
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"JMB360"
block|}
block|,
block|{
name|ATA_JMB361
block|,
literal|0
block|,
literal|1
block|,
literal|1
block|,
name|ATA_SA300
block|,
literal|"JMB361"
block|}
block|,
block|{
name|ATA_JMB363
block|,
literal|0
block|,
literal|2
block|,
literal|1
block|,
name|ATA_SA300
block|,
literal|"JMB363"
block|}
block|,
block|{
name|ATA_JMB365
block|,
literal|0
block|,
literal|1
block|,
literal|2
block|,
name|ATA_SA300
block|,
literal|"JMB365"
block|}
block|,
block|{
name|ATA_JMB366
block|,
literal|0
block|,
literal|2
block|,
literal|2
block|,
name|ATA_SA300
block|,
literal|"JMB366"
block|}
block|,
block|{
name|ATA_JMB368
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
name|ATA_UDMA6
block|,
literal|"JMB368"
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
name|char
name|buffer
index|[
literal|64
index|]
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|idx
operator|=
name|ata_match_chip
argument_list|(
name|dev
argument_list|,
name|ids
argument_list|)
operator|)
condition|)
return|return
name|ENXIO
return|;
if|if
condition|(
operator|(
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0xdf
argument_list|,
literal|1
argument_list|)
operator|&
literal|0x40
operator|)
operator|&&
operator|(
name|pci_get_function
argument_list|(
name|dev
argument_list|)
operator|==
operator|(
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x40
argument_list|,
literal|1
argument_list|)
operator|&
literal|0x02
operator|>>
literal|1
operator|)
operator|)
condition|)
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"JMicron %s %s controller"
argument_list|,
name|idx
operator|->
name|text
argument_list|,
name|ata_mode2str
argument_list|(
name|ATA_UDMA6
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"JMicron %s %s controller"
argument_list|,
name|idx
operator|->
name|text
argument_list|,
name|ata_mode2str
argument_list|(
name|idx
operator|->
name|max_dma
argument_list|)
argument_list|)
expr_stmt|;
name|device_set_desc_copy
argument_list|(
name|dev
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|chip
operator|=
name|idx
expr_stmt|;
name|ctlr
operator|->
name|chipinit
operator|=
name|ata_jmicron_chipinit
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_jmicron_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|error
decl_stmt|;
if|if
condition|(
name|ata_setup_interrupt
argument_list|(
name|dev
argument_list|)
condition|)
return|return
name|ENXIO
return|;
comment|/* do we have multiple PCI functions ? */
if|if
condition|(
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0xdf
argument_list|,
literal|1
argument_list|)
operator|&
literal|0x40
condition|)
block|{
comment|/* are we on the AHCI part ? */
if|if
condition|(
name|ata_ahci_chipinit
argument_list|(
name|dev
argument_list|)
operator|!=
name|ENXIO
condition|)
return|return
literal|0
return|;
comment|/* otherwise we are on the PATA part */
name|ctlr
operator|->
name|allocate
operator|=
name|ata_pci_allocate
expr_stmt|;
name|ctlr
operator|->
name|reset
operator|=
name|ata_generic_reset
expr_stmt|;
name|ctlr
operator|->
name|dmainit
operator|=
name|ata_pci_dmainit
expr_stmt|;
name|ctlr
operator|->
name|setmode
operator|=
name|ata_jmicron_setmode
expr_stmt|;
name|ctlr
operator|->
name|channels
operator|=
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
expr_stmt|;
block|}
else|else
block|{
comment|/* set controller configuration to a combined setup we support */
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x40
argument_list|,
literal|0x80c0a131
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x80
argument_list|,
literal|0x01200000
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg1
operator|&&
operator|(
name|error
operator|=
name|ata_ahci_chipinit
argument_list|(
name|dev
argument_list|)
operator|)
condition|)
return|return
name|error
return|;
name|ctlr
operator|->
name|allocate
operator|=
name|ata_jmicron_allocate
expr_stmt|;
name|ctlr
operator|->
name|reset
operator|=
name|ata_jmicron_reset
expr_stmt|;
name|ctlr
operator|->
name|dmainit
operator|=
name|ata_jmicron_dmainit
expr_stmt|;
name|ctlr
operator|->
name|setmode
operator|=
name|ata_jmicron_setmode
expr_stmt|;
comment|/* set the number of HW channels */
name|ctlr
operator|->
name|channels
operator|=
name|ctlr
operator|->
name|chip
operator|->
name|cfg1
operator|+
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_jmicron_allocate
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|error
decl_stmt|;
if|if
condition|(
name|ch
operator|->
name|unit
operator|>=
name|ctlr
operator|->
name|chip
operator|->
name|cfg1
condition|)
block|{
name|ch
operator|->
name|unit
operator|-=
name|ctlr
operator|->
name|chip
operator|->
name|cfg1
expr_stmt|;
name|error
operator|=
name|ata_pci_allocate
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|ch
operator|->
name|unit
operator|+=
name|ctlr
operator|->
name|chip
operator|->
name|cfg1
expr_stmt|;
block|}
else|else
name|error
operator|=
name|ata_ahci_allocate
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_jmicron_reset
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|ch
operator|->
name|unit
operator|>=
name|ctlr
operator|->
name|chip
operator|->
name|cfg1
condition|)
name|ata_generic_reset
argument_list|(
name|dev
argument_list|)
expr_stmt|;
else|else
name|ata_ahci_reset
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_jmicron_dmainit
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|ch
operator|->
name|unit
operator|>=
name|ctlr
operator|->
name|chip
operator|->
name|cfg1
condition|)
name|ata_pci_dmainit
argument_list|(
name|dev
argument_list|)
expr_stmt|;
else|else
name|ata_ahci_dmainit
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_jmicron_setmode
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|GRANDPARENT
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0xdf
argument_list|,
literal|1
argument_list|)
operator|&
literal|0x40
operator|||
name|ch
operator|->
name|unit
operator|>=
name|ctlr
operator|->
name|chip
operator|->
name|cfg1
condition|)
block|{
name|struct
name|ata_device
modifier|*
name|atadev
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
comment|/* check for 80pin cable present */
if|if
condition|(
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x40
argument_list|,
literal|1
argument_list|)
operator|&
literal|0x08
condition|)
name|mode
operator|=
name|ata_limit_mode
argument_list|(
name|dev
argument_list|,
name|mode
argument_list|,
name|ATA_UDMA2
argument_list|)
expr_stmt|;
else|else
name|mode
operator|=
name|ata_limit_mode
argument_list|(
name|dev
argument_list|,
name|mode
argument_list|,
name|ATA_UDMA6
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ata_controlcmd
argument_list|(
name|dev
argument_list|,
name|ATA_SETFEATURES
argument_list|,
name|ATA_SF_SETXFER
argument_list|,
literal|0
argument_list|,
name|mode
argument_list|)
condition|)
name|atadev
operator|->
name|mode
operator|=
name|mode
expr_stmt|;
block|}
else|else
name|ata_sata_setmode
argument_list|(
name|dev
argument_list|,
name|mode
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Marvell chipset support functions  */
end_comment

begin_define
define|#
directive|define
name|ATA_MV_HOST_BASE
parameter_list|(
name|ch
parameter_list|)
define|\
value|((ch->unit& 3) * 0x0100) + (ch->unit> 3 ? 0x30000 : 0x20000)
end_define

begin_define
define|#
directive|define
name|ATA_MV_EDMA_BASE
parameter_list|(
name|ch
parameter_list|)
define|\
value|((ch->unit& 3) * 0x2000) + (ch->unit> 3 ? 0x30000 : 0x20000)
end_define

begin_struct
struct|struct
name|ata_marvell_response
block|{
name|u_int16_t
name|tag
decl_stmt|;
name|u_int8_t
name|edma_status
decl_stmt|;
name|u_int8_t
name|dev_status
decl_stmt|;
name|u_int32_t
name|timestamp
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|ata_marvell_dma_prdentry
block|{
name|u_int32_t
name|addrlo
decl_stmt|;
name|u_int32_t
name|count
decl_stmt|;
name|u_int32_t
name|addrhi
decl_stmt|;
name|u_int32_t
name|reserved
decl_stmt|;
block|}
struct|;
end_struct

begin_function
name|int
name|ata_marvell_ident
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
specifier|static
name|struct
name|ata_chip_id
name|ids
index|[]
init|=
block|{
block|{
name|ATA_M88SX5040
block|,
literal|0
block|,
literal|4
block|,
name|MV50XX
block|,
name|ATA_SA150
block|,
literal|"88SX5040"
block|}
block|,
block|{
name|ATA_M88SX5041
block|,
literal|0
block|,
literal|4
block|,
name|MV50XX
block|,
name|ATA_SA150
block|,
literal|"88SX5041"
block|}
block|,
block|{
name|ATA_M88SX5080
block|,
literal|0
block|,
literal|8
block|,
name|MV50XX
block|,
name|ATA_SA150
block|,
literal|"88SX5080"
block|}
block|,
block|{
name|ATA_M88SX5081
block|,
literal|0
block|,
literal|8
block|,
name|MV50XX
block|,
name|ATA_SA150
block|,
literal|"88SX5081"
block|}
block|,
block|{
name|ATA_M88SX6041
block|,
literal|0
block|,
literal|4
block|,
name|MV60XX
block|,
name|ATA_SA300
block|,
literal|"88SX6041"
block|}
block|,
block|{
name|ATA_M88SX6081
block|,
literal|0
block|,
literal|8
block|,
name|MV60XX
block|,
name|ATA_SA300
block|,
literal|"88SX6081"
block|}
block|,
block|{
name|ATA_M88SX6101
block|,
literal|0
block|,
literal|1
block|,
name|MV61XX
block|,
name|ATA_UDMA6
block|,
literal|"88SX6101"
block|}
block|,
block|{
name|ATA_M88SX6121
block|,
literal|0
block|,
literal|1
block|,
name|MV61XX
block|,
name|ATA_UDMA6
block|,
literal|"88SX6121"
block|}
block|,
block|{
name|ATA_M88SX6145
block|,
literal|0
block|,
literal|2
block|,
name|MV61XX
block|,
name|ATA_UDMA6
block|,
literal|"88SX6145"
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|ctlr
operator|->
name|chip
operator|=
name|ata_match_chip
argument_list|(
name|dev
argument_list|,
name|ids
argument_list|)
operator|)
condition|)
return|return
name|ENXIO
return|;
name|ata_set_desc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
condition|)
block|{
case|case
name|MV50XX
case|:
case|case
name|MV60XX
case|:
name|ctlr
operator|->
name|chipinit
operator|=
name|ata_marvell_edma_chipinit
expr_stmt|;
break|break;
case|case
name|MV61XX
case|:
name|ctlr
operator|->
name|chipinit
operator|=
name|ata_marvell_pata_chipinit
expr_stmt|;
break|break;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_marvell_pata_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|ata_setup_interrupt
argument_list|(
name|dev
argument_list|)
condition|)
return|return
name|ENXIO
return|;
name|ctlr
operator|->
name|allocate
operator|=
name|ata_marvell_pata_allocate
expr_stmt|;
name|ctlr
operator|->
name|setmode
operator|=
name|ata_marvell_pata_setmode
expr_stmt|;
name|ctlr
operator|->
name|channels
operator|=
name|ctlr
operator|->
name|chip
operator|->
name|cfg1
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_marvell_pata_allocate
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
comment|/* setup the usual register normal pci style */
if|if
condition|(
name|ata_pci_allocate
argument_list|(
name|dev
argument_list|)
condition|)
return|return
name|ENXIO
return|;
comment|/* dont use 32 bit PIO transfers */
name|ch
operator|->
name|flags
operator||=
name|ATA_USE_16BIT
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_marvell_pata_setmode
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|device_t
name|gparent
init|=
name|GRANDPARENT
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|gparent
argument_list|)
decl_stmt|;
name|struct
name|ata_device
modifier|*
name|atadev
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|mode
operator|=
name|ata_limit_mode
argument_list|(
name|dev
argument_list|,
name|mode
argument_list|,
name|ctlr
operator|->
name|chip
operator|->
name|max_dma
argument_list|)
expr_stmt|;
name|mode
operator|=
name|ata_check_80pin
argument_list|(
name|dev
argument_list|,
name|mode
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ata_controlcmd
argument_list|(
name|dev
argument_list|,
name|ATA_SETFEATURES
argument_list|,
name|ATA_SF_SETXFER
argument_list|,
literal|0
argument_list|,
name|mode
argument_list|)
condition|)
name|atadev
operator|->
name|mode
operator|=
name|mode
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_marvell_edma_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|ata_setup_interrupt
argument_list|(
name|dev
argument_list|)
condition|)
return|return
name|ENXIO
return|;
name|ctlr
operator|->
name|r_type1
operator|=
name|SYS_RES_MEMORY
expr_stmt|;
name|ctlr
operator|->
name|r_rid1
operator|=
name|PCIR_BAR
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ctlr
operator|->
name|r_res1
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|ctlr
operator|->
name|r_type1
argument_list|,
operator|&
name|ctlr
operator|->
name|r_rid1
argument_list|,
name|RF_ACTIVE
argument_list|)
operator|)
condition|)
return|return
name|ENXIO
return|;
comment|/* mask all host controller interrupts */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
literal|0x01d64
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
comment|/* mask all PCI interrupts */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
literal|0x01d5c
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|allocate
operator|=
name|ata_marvell_edma_allocate
expr_stmt|;
name|ctlr
operator|->
name|reset
operator|=
name|ata_marvell_edma_reset
expr_stmt|;
name|ctlr
operator|->
name|dmainit
operator|=
name|ata_marvell_edma_dmainit
expr_stmt|;
name|ctlr
operator|->
name|setmode
operator|=
name|ata_sata_setmode
expr_stmt|;
name|ctlr
operator|->
name|channels
operator|=
name|ctlr
operator|->
name|chip
operator|->
name|cfg1
expr_stmt|;
comment|/* clear host controller interrupts */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
literal|0x20014
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg1
operator|>
literal|4
condition|)
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
literal|0x30014
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
comment|/* clear PCI interrupts */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
literal|0x01d58
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
comment|/* unmask PCI interrupts we want */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
literal|0x01d5c
argument_list|,
literal|0x007fffff
argument_list|)
expr_stmt|;
comment|/* unmask host controller interrupts we want */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
literal|0x01d64
argument_list|,
literal|0x000000ff
comment|/*HC0*/
operator||
literal|0x0001fe00
comment|/*HC1*/
operator||
comment|/*(1<<19) | (1<<20) | (1<<21) |*/
operator|(
literal|1
operator|<<
literal|22
operator|)
operator||
operator|(
literal|1
operator|<<
literal|24
operator|)
operator||
operator|(
literal|0x7f
operator|<<
literal|25
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_marvell_edma_allocate
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|u_int64_t
name|work
init|=
name|ch
operator|->
name|dma
operator|->
name|work_bus
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* clear work area */
name|bzero
argument_list|(
name|ch
operator|->
name|dma
operator|->
name|work
argument_list|,
literal|1024
operator|+
literal|256
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|ch
operator|->
name|dma
operator|->
name|work_tag
argument_list|,
name|ch
operator|->
name|dma
operator|->
name|work_map
argument_list|,
name|BUS_DMASYNC_PREREAD
operator||
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
comment|/* set legacy ATA resources */
for|for
control|(
name|i
operator|=
name|ATA_DATA
init|;
name|i
operator|<=
name|ATA_COMMAND
condition|;
name|i
operator|++
control|)
block|{
name|ch
operator|->
name|r_io
index|[
name|i
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_res1
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|i
index|]
operator|.
name|offset
operator|=
literal|0x02100
operator|+
operator|(
name|i
operator|<<
literal|2
operator|)
operator|+
name|ATA_MV_EDMA_BASE
argument_list|(
name|ch
argument_list|)
expr_stmt|;
block|}
name|ch
operator|->
name|r_io
index|[
name|ATA_CONTROL
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_res1
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_CONTROL
index|]
operator|.
name|offset
operator|=
literal|0x02120
operator|+
name|ATA_MV_EDMA_BASE
argument_list|(
name|ch
argument_list|)
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_IDX_ADDR
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_res1
expr_stmt|;
name|ata_default_registers
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* set SATA resources */
switch|switch
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
condition|)
block|{
case|case
name|MV50XX
case|:
name|ch
operator|->
name|r_io
index|[
name|ATA_SSTATUS
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_res1
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SSTATUS
index|]
operator|.
name|offset
operator|=
literal|0x00100
operator|+
name|ATA_MV_HOST_BASE
argument_list|(
name|ch
argument_list|)
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SERROR
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_res1
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SERROR
index|]
operator|.
name|offset
operator|=
literal|0x00104
operator|+
name|ATA_MV_HOST_BASE
argument_list|(
name|ch
argument_list|)
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SCONTROL
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_res1
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SCONTROL
index|]
operator|.
name|offset
operator|=
literal|0x00108
operator|+
name|ATA_MV_HOST_BASE
argument_list|(
name|ch
argument_list|)
expr_stmt|;
break|break;
case|case
name|MV60XX
case|:
name|ch
operator|->
name|r_io
index|[
name|ATA_SSTATUS
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_res1
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SSTATUS
index|]
operator|.
name|offset
operator|=
literal|0x02300
operator|+
name|ATA_MV_EDMA_BASE
argument_list|(
name|ch
argument_list|)
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SERROR
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_res1
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SERROR
index|]
operator|.
name|offset
operator|=
literal|0x02304
operator|+
name|ATA_MV_EDMA_BASE
argument_list|(
name|ch
argument_list|)
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SCONTROL
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_res1
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SCONTROL
index|]
operator|.
name|offset
operator|=
literal|0x02308
operator|+
name|ATA_MV_EDMA_BASE
argument_list|(
name|ch
argument_list|)
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SACTIVE
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_res1
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SACTIVE
index|]
operator|.
name|offset
operator|=
literal|0x02350
operator|+
name|ATA_MV_EDMA_BASE
argument_list|(
name|ch
argument_list|)
expr_stmt|;
break|break;
block|}
name|ch
operator|->
name|flags
operator||=
name|ATA_NO_SLAVE
expr_stmt|;
name|ch
operator|->
name|flags
operator||=
name|ATA_USE_16BIT
expr_stmt|;
comment|/* XXX SOS needed ? */
name|ata_generic_hw
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|ch
operator|->
name|hw
operator|.
name|begin_transaction
operator|=
name|ata_marvell_edma_begin_transaction
expr_stmt|;
name|ch
operator|->
name|hw
operator|.
name|end_transaction
operator|=
name|ata_marvell_edma_end_transaction
expr_stmt|;
name|ch
operator|->
name|hw
operator|.
name|status
operator|=
name|ata_marvell_edma_status
expr_stmt|;
comment|/* disable the EDMA machinery */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
literal|0x02028
operator|+
name|ATA_MV_EDMA_BASE
argument_list|(
name|ch
argument_list|)
argument_list|,
literal|0x00000002
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|100000
argument_list|)
expr_stmt|;
comment|/* SOS should poll for disabled */
comment|/* set configuration to non-queued 128b read transfers stop on error */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
literal|0x02000
operator|+
name|ATA_MV_EDMA_BASE
argument_list|(
name|ch
argument_list|)
argument_list|,
operator|(
literal|1
operator|<<
literal|11
operator|)
operator||
operator|(
literal|1
operator|<<
literal|13
operator|)
argument_list|)
expr_stmt|;
comment|/* request queue base high */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
literal|0x02010
operator|+
name|ATA_MV_EDMA_BASE
argument_list|(
name|ch
argument_list|)
argument_list|,
name|work
operator|>>
literal|32
argument_list|)
expr_stmt|;
comment|/* request queue in ptr */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
literal|0x02014
operator|+
name|ATA_MV_EDMA_BASE
argument_list|(
name|ch
argument_list|)
argument_list|,
name|work
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
comment|/* request queue out ptr */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
literal|0x02018
operator|+
name|ATA_MV_EDMA_BASE
argument_list|(
name|ch
argument_list|)
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
comment|/* response queue base high */
name|work
operator|+=
literal|1024
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
literal|0x0201c
operator|+
name|ATA_MV_EDMA_BASE
argument_list|(
name|ch
argument_list|)
argument_list|,
name|work
operator|>>
literal|32
argument_list|)
expr_stmt|;
comment|/* response queue in ptr */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
literal|0x02020
operator|+
name|ATA_MV_EDMA_BASE
argument_list|(
name|ch
argument_list|)
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
comment|/* response queue out ptr */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
literal|0x02024
operator|+
name|ATA_MV_EDMA_BASE
argument_list|(
name|ch
argument_list|)
argument_list|,
name|work
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
comment|/* clear SATA error register */
name|ATA_IDX_OUTL
argument_list|(
name|ch
argument_list|,
name|ATA_SERROR
argument_list|,
name|ATA_IDX_INL
argument_list|(
name|ch
argument_list|,
name|ATA_SERROR
argument_list|)
argument_list|)
expr_stmt|;
comment|/* clear any outstanding error interrupts */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
literal|0x02008
operator|+
name|ATA_MV_EDMA_BASE
argument_list|(
name|ch
argument_list|)
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
comment|/* unmask all error interrupts */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
literal|0x0200c
operator|+
name|ATA_MV_EDMA_BASE
argument_list|(
name|ch
argument_list|)
argument_list|,
operator|~
literal|0x0
argument_list|)
expr_stmt|;
comment|/* enable EDMA machinery */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
literal|0x02028
operator|+
name|ATA_MV_EDMA_BASE
argument_list|(
name|ch
argument_list|)
argument_list|,
literal|0x00000001
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_marvell_edma_status
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|u_int32_t
name|cause
init|=
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
literal|0x01d60
argument_list|)
decl_stmt|;
name|int
name|shift
init|=
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|1
operator|)
operator|+
operator|(
name|ch
operator|->
name|unit
operator|>
literal|3
operator|)
decl_stmt|;
if|if
condition|(
name|cause
operator|&
operator|(
literal|1
operator|<<
name|shift
operator|)
condition|)
block|{
comment|/* clear interrupt(s) */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
literal|0x02008
operator|+
name|ATA_MV_EDMA_BASE
argument_list|(
name|ch
argument_list|)
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
comment|/* do we have any PHY events ? */
name|ata_sata_phy_check_events
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
comment|/* do we have any device action ? */
return|return
operator|(
name|cause
operator|&
operator|(
literal|2
operator|<<
name|shift
operator|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/* must be called with ATA channel locked and state_mtx held */
end_comment

begin_function
specifier|static
name|int
name|ata_marvell_edma_begin_transaction
parameter_list|(
name|struct
name|ata_request
modifier|*
name|request
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|GRANDPARENT
argument_list|(
name|request
operator|->
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|request
operator|->
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|u_int32_t
name|req_in
decl_stmt|;
name|u_int8_t
modifier|*
name|bytep
decl_stmt|;
name|int
name|i
decl_stmt|,
name|tag
init|=
literal|0x07
decl_stmt|;
name|int
name|dummy
decl_stmt|,
name|error
decl_stmt|,
name|slot
decl_stmt|;
comment|/* only DMA R/W goes through the EMDA machine */
if|if
condition|(
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|command
operator|!=
name|ATA_READ_DMA
operator|&&
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|command
operator|!=
name|ATA_WRITE_DMA
condition|)
block|{
comment|/* disable the EDMA machinery */
if|if
condition|(
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
literal|0x02028
operator|+
name|ATA_MV_EDMA_BASE
argument_list|(
name|ch
argument_list|)
argument_list|)
operator|&
literal|0x00000001
condition|)
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
literal|0x02028
operator|+
name|ATA_MV_EDMA_BASE
argument_list|(
name|ch
argument_list|)
argument_list|,
literal|0x00000002
argument_list|)
expr_stmt|;
return|return
name|ata_begin_transaction
argument_list|(
name|request
argument_list|)
return|;
block|}
comment|/* check for 48 bit access and convert if needed */
name|ata_modify_if_48bit
argument_list|(
name|request
argument_list|)
expr_stmt|;
comment|/* check sanity, setup SG list and DMA engine */
if|if
condition|(
operator|(
name|error
operator|=
name|ch
operator|->
name|dma
operator|->
name|load
argument_list|(
name|ch
operator|->
name|dev
argument_list|,
name|request
operator|->
name|data
argument_list|,
name|request
operator|->
name|bytecount
argument_list|,
name|request
operator|->
name|flags
operator|&
name|ATA_R_READ
argument_list|,
name|ch
operator|->
name|dma
operator|->
name|sg
argument_list|,
operator|&
name|dummy
argument_list|)
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|request
operator|->
name|dev
argument_list|,
literal|"setting up DMA failed\n"
argument_list|)
expr_stmt|;
name|request
operator|->
name|result
operator|=
name|error
expr_stmt|;
return|return
name|ATA_OP_FINISHED
return|;
block|}
comment|/* get next free request queue slot */
name|req_in
operator|=
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
literal|0x02014
operator|+
name|ATA_MV_EDMA_BASE
argument_list|(
name|ch
argument_list|)
argument_list|)
expr_stmt|;
name|slot
operator|=
operator|(
operator|(
operator|(
name|req_in
operator|&
operator|~
literal|0xfffffc00
operator|)
operator|>>
literal|5
operator|)
operator|+
literal|0
operator|)
operator|&
literal|0x1f
expr_stmt|;
name|bytep
operator|=
operator|(
name|u_int8_t
operator|*
operator|)
operator|(
name|ch
operator|->
name|dma
operator|->
name|work
operator|)
expr_stmt|;
name|bytep
operator|+=
operator|(
name|slot
operator|<<
literal|5
operator|)
expr_stmt|;
comment|/* fill in this request */
name|le32enc
argument_list|(
name|bytep
operator|+
literal|0
operator|*
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
argument_list|,
name|ch
operator|->
name|dma
operator|->
name|sg_bus
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
name|le32enc
argument_list|(
name|bytep
operator|+
literal|1
operator|*
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
argument_list|,
operator|(
name|u_int64_t
operator|)
name|ch
operator|->
name|dma
operator|->
name|sg_bus
operator|>>
literal|32
argument_list|)
expr_stmt|;
name|le16enc
argument_list|(
name|bytep
operator|+
literal|4
operator|*
sizeof|sizeof
argument_list|(
name|u_int16_t
argument_list|)
argument_list|,
operator|(
name|request
operator|->
name|flags
operator|&
name|ATA_R_READ
condition|?
literal|0x01
else|:
literal|0x00
operator|)
operator||
operator|(
name|tag
operator|<<
literal|1
operator|)
argument_list|)
expr_stmt|;
name|i
operator|=
literal|10
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
operator|(
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|count
operator|>>
literal|8
operator|)
operator|&
literal|0xff
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
literal|0x10
operator||
name|ATA_COUNT
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|count
operator|&
literal|0xff
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
literal|0x10
operator||
name|ATA_COUNT
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
operator|(
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|>>
literal|24
operator|)
operator|&
literal|0xff
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
literal|0x10
operator||
name|ATA_SECTOR
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|&
literal|0xff
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
literal|0x10
operator||
name|ATA_SECTOR
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
operator|(
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|>>
literal|32
operator|)
operator|&
literal|0xff
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
literal|0x10
operator||
name|ATA_CYL_LSB
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
operator|(
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|>>
literal|8
operator|)
operator|&
literal|0xff
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
literal|0x10
operator||
name|ATA_CYL_LSB
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
operator|(
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|>>
literal|40
operator|)
operator|&
literal|0xff
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
literal|0x10
operator||
name|ATA_CYL_MSB
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
operator|(
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|>>
literal|16
operator|)
operator|&
literal|0xff
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
literal|0x10
operator||
name|ATA_CYL_MSB
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|ATA_D_LBA
operator||
name|ATA_D_IBM
operator||
operator|(
operator|(
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|>>
literal|24
operator|)
operator|&
literal|0xf
operator|)
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
literal|0x10
operator||
name|ATA_DRIVE
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|command
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
literal|0x90
operator||
name|ATA_COMMAND
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|ch
operator|->
name|dma
operator|->
name|work_tag
argument_list|,
name|ch
operator|->
name|dma
operator|->
name|work_map
argument_list|,
name|BUS_DMASYNC_PREREAD
operator||
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
comment|/* enable EDMA machinery if needed */
if|if
condition|(
operator|!
operator|(
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
literal|0x02028
operator|+
name|ATA_MV_EDMA_BASE
argument_list|(
name|ch
argument_list|)
argument_list|)
operator|&
literal|0x00000001
operator|)
condition|)
block|{
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
literal|0x02028
operator|+
name|ATA_MV_EDMA_BASE
argument_list|(
name|ch
argument_list|)
argument_list|,
literal|0x00000001
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
operator|(
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
literal|0x02028
operator|+
name|ATA_MV_EDMA_BASE
argument_list|(
name|ch
argument_list|)
argument_list|)
operator|&
literal|0x00000001
operator|)
condition|)
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
comment|/* tell EDMA it has a new request */
name|slot
operator|=
operator|(
operator|(
operator|(
name|req_in
operator|&
operator|~
literal|0xfffffc00
operator|)
operator|>>
literal|5
operator|)
operator|+
literal|1
operator|)
operator|&
literal|0x1f
expr_stmt|;
name|req_in
operator|&=
literal|0xfffffc00
expr_stmt|;
name|req_in
operator|+=
operator|(
name|slot
operator|<<
literal|5
operator|)
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
literal|0x02014
operator|+
name|ATA_MV_EDMA_BASE
argument_list|(
name|ch
argument_list|)
argument_list|,
name|req_in
argument_list|)
expr_stmt|;
return|return
name|ATA_OP_CONTINUES
return|;
block|}
end_function

begin_comment
comment|/* must be called with ATA channel locked and state_mtx held */
end_comment

begin_function
specifier|static
name|int
name|ata_marvell_edma_end_transaction
parameter_list|(
name|struct
name|ata_request
modifier|*
name|request
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|GRANDPARENT
argument_list|(
name|request
operator|->
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|request
operator|->
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|int
name|offset
init|=
operator|(
name|ch
operator|->
name|unit
operator|>
literal|3
condition|?
literal|0x30014
else|:
literal|0x20014
operator|)
decl_stmt|;
name|u_int32_t
name|icr
init|=
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
name|offset
argument_list|)
decl_stmt|;
name|int
name|res
decl_stmt|;
comment|/* EDMA interrupt */
if|if
condition|(
operator|(
name|icr
operator|&
operator|(
literal|0x0001
operator|<<
operator|(
name|ch
operator|->
name|unit
operator|&
literal|3
operator|)
operator|)
operator|)
condition|)
block|{
name|struct
name|ata_marvell_response
modifier|*
name|response
decl_stmt|;
name|u_int32_t
name|rsp_in
decl_stmt|,
name|rsp_out
decl_stmt|;
name|int
name|slot
decl_stmt|;
comment|/* stop timeout */
name|callout_stop
argument_list|(
operator|&
name|request
operator|->
name|callout
argument_list|)
expr_stmt|;
comment|/* get response ptr's */
name|rsp_in
operator|=
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
literal|0x02020
operator|+
name|ATA_MV_EDMA_BASE
argument_list|(
name|ch
argument_list|)
argument_list|)
expr_stmt|;
name|rsp_out
operator|=
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
literal|0x02024
operator|+
name|ATA_MV_EDMA_BASE
argument_list|(
name|ch
argument_list|)
argument_list|)
expr_stmt|;
name|slot
operator|=
operator|(
operator|(
operator|(
name|rsp_in
operator|&
operator|~
literal|0xffffff00
operator|)
operator|>>
literal|3
operator|)
operator|)
operator|&
literal|0x1f
expr_stmt|;
name|rsp_out
operator|&=
literal|0xffffff00
expr_stmt|;
name|rsp_out
operator|+=
operator|(
name|slot
operator|<<
literal|3
operator|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|ch
operator|->
name|dma
operator|->
name|work_tag
argument_list|,
name|ch
operator|->
name|dma
operator|->
name|work_map
argument_list|,
name|BUS_DMASYNC_POSTREAD
operator||
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
name|response
operator|=
operator|(
expr|struct
name|ata_marvell_response
operator|*
operator|)
operator|(
name|ch
operator|->
name|dma
operator|->
name|work
operator|+
literal|1024
operator|+
operator|(
name|slot
operator|<<
literal|3
operator|)
operator|)
expr_stmt|;
comment|/* record status for this request */
name|request
operator|->
name|status
operator|=
name|response
operator|->
name|dev_status
expr_stmt|;
name|request
operator|->
name|error
operator|=
literal|0
expr_stmt|;
comment|/* ack response */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
literal|0x02024
operator|+
name|ATA_MV_EDMA_BASE
argument_list|(
name|ch
argument_list|)
argument_list|,
name|rsp_out
argument_list|)
expr_stmt|;
comment|/* update progress */
if|if
condition|(
operator|!
operator|(
name|request
operator|->
name|status
operator|&
name|ATA_S_ERROR
operator|)
operator|&&
operator|!
operator|(
name|request
operator|->
name|flags
operator|&
name|ATA_R_TIMEOUT
operator|)
condition|)
name|request
operator|->
name|donecount
operator|=
name|request
operator|->
name|bytecount
expr_stmt|;
comment|/* unload SG list */
name|ch
operator|->
name|dma
operator|->
name|unload
argument_list|(
name|ch
operator|->
name|dev
argument_list|)
expr_stmt|;
name|res
operator|=
name|ATA_OP_FINISHED
expr_stmt|;
block|}
comment|/* legacy ATA interrupt */
else|else
block|{
name|res
operator|=
name|ata_end_transaction
argument_list|(
name|request
argument_list|)
expr_stmt|;
block|}
comment|/* ack interrupt */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
name|offset
argument_list|,
operator|~
operator|(
name|icr
operator|&
operator|(
literal|0x0101
operator|<<
operator|(
name|ch
operator|->
name|unit
operator|&
literal|3
operator|)
operator|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_marvell_edma_reset
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
comment|/* disable the EDMA machinery */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
literal|0x02028
operator|+
name|ATA_MV_EDMA_BASE
argument_list|(
name|ch
argument_list|)
argument_list|,
literal|0x00000002
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
literal|0x02028
operator|+
name|ATA_MV_EDMA_BASE
argument_list|(
name|ch
argument_list|)
argument_list|)
operator|&
literal|0x00000001
operator|)
condition|)
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
comment|/* clear SATA error register */
name|ATA_IDX_OUTL
argument_list|(
name|ch
argument_list|,
name|ATA_SERROR
argument_list|,
name|ATA_IDX_INL
argument_list|(
name|ch
argument_list|,
name|ATA_SERROR
argument_list|)
argument_list|)
expr_stmt|;
comment|/* clear any outstanding error interrupts */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
literal|0x02008
operator|+
name|ATA_MV_EDMA_BASE
argument_list|(
name|ch
argument_list|)
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
comment|/* unmask all error interrupts */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
literal|0x0200c
operator|+
name|ATA_MV_EDMA_BASE
argument_list|(
name|ch
argument_list|)
argument_list|,
operator|~
literal|0x0
argument_list|)
expr_stmt|;
comment|/* enable channel and test for devices */
if|if
condition|(
name|ata_sata_phy_reset
argument_list|(
name|dev
argument_list|)
condition|)
name|ata_generic_reset
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* enable EDMA machinery */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
literal|0x02028
operator|+
name|ATA_MV_EDMA_BASE
argument_list|(
name|ch
argument_list|)
argument_list|,
literal|0x00000001
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_marvell_edma_dmasetprd
parameter_list|(
name|void
modifier|*
name|xsc
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|segs
parameter_list|,
name|int
name|nsegs
parameter_list|,
name|int
name|error
parameter_list|)
block|{
name|struct
name|ata_dmasetprd_args
modifier|*
name|args
init|=
name|xsc
decl_stmt|;
name|struct
name|ata_marvell_dma_prdentry
modifier|*
name|prd
init|=
name|args
operator|->
name|dmatab
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|(
name|args
operator|->
name|error
operator|=
name|error
operator|)
condition|)
return|return;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nsegs
condition|;
name|i
operator|++
control|)
block|{
name|prd
index|[
name|i
index|]
operator|.
name|addrlo
operator|=
name|htole32
argument_list|(
name|segs
index|[
name|i
index|]
operator|.
name|ds_addr
argument_list|)
expr_stmt|;
name|prd
index|[
name|i
index|]
operator|.
name|count
operator|=
name|htole32
argument_list|(
name|segs
index|[
name|i
index|]
operator|.
name|ds_len
argument_list|)
expr_stmt|;
name|prd
index|[
name|i
index|]
operator|.
name|addrhi
operator|=
name|htole32
argument_list|(
operator|(
name|u_int64_t
operator|)
name|segs
index|[
name|i
index|]
operator|.
name|ds_addr
operator|>>
literal|32
argument_list|)
expr_stmt|;
name|prd
index|[
name|i
index|]
operator|.
name|reserved
operator|=
literal|0
expr_stmt|;
block|}
name|prd
index|[
name|i
operator|-
literal|1
index|]
operator|.
name|count
operator||=
name|htole32
argument_list|(
name|ATA_DMA_EOT
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|nsegs
operator|<=
name|ATA_DMA_ENTRIES
argument_list|,
operator|(
literal|"too many DMA segment entries\n"
operator|)
argument_list|)
expr_stmt|;
name|args
operator|->
name|nsegs
operator|=
name|nsegs
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_marvell_edma_dmainit
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|ata_dmainit
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|ch
operator|->
name|dma
condition|)
block|{
comment|/* note start and stop are not used here */
name|ch
operator|->
name|dma
operator|->
name|setprd
operator|=
name|ata_marvell_edma_dmasetprd
expr_stmt|;
comment|/* if 64bit support present adjust max address used */
if|if
condition|(
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
literal|0x00d00
argument_list|)
operator|&
literal|0x00000004
condition|)
name|ch
operator|->
name|dma
operator|->
name|max_address
operator|=
name|BUS_SPACE_MAXADDR
expr_stmt|;
comment|/* chip does not reliably do 64K DMA transfers */
name|ch
operator|->
name|dma
operator|->
name|max_iosize
operator|=
literal|64
operator|*
name|DEV_BSIZE
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * National chipset support functions  */
end_comment

begin_function
name|int
name|ata_national_ident
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
comment|/* this chip is a clone of the Cyrix chip, bugs and all */
if|if
condition|(
name|pci_get_devid
argument_list|(
name|dev
argument_list|)
operator|==
name|ATA_SC1100
condition|)
block|{
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"National Geode SC1100 ATA33 controller"
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|chipinit
operator|=
name|ata_national_chipinit
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
name|ENXIO
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_national_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|ata_setup_interrupt
argument_list|(
name|dev
argument_list|)
condition|)
return|return
name|ENXIO
return|;
name|ctlr
operator|->
name|setmode
operator|=
name|ata_national_setmode
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_national_setmode
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|device_t
name|gparent
init|=
name|GRANDPARENT
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_device
modifier|*
name|atadev
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|devno
init|=
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|1
operator|)
operator|+
name|ATA_DEV
argument_list|(
name|atadev
operator|->
name|unit
argument_list|)
decl_stmt|;
name|u_int32_t
name|piotiming
index|[]
init|=
block|{
literal|0x9172d132
block|,
literal|0x21717121
block|,
literal|0x00803020
block|,
literal|0x20102010
block|,
literal|0x00100010
block|,
literal|0x00803020
block|,
literal|0x20102010
block|,
literal|0x00100010
block|,
literal|0x00100010
block|,
literal|0x00100010
block|,
literal|0x00100010
block|}
decl_stmt|;
name|u_int32_t
name|dmatiming
index|[]
init|=
block|{
literal|0x80077771
block|,
literal|0x80012121
block|,
literal|0x80002020
block|}
decl_stmt|;
name|u_int32_t
name|udmatiming
index|[]
init|=
block|{
literal|0x80921250
block|,
literal|0x80911140
block|,
literal|0x80911030
block|}
decl_stmt|;
name|int
name|error
decl_stmt|;
name|ch
operator|->
name|dma
operator|->
name|alignment
operator|=
literal|16
expr_stmt|;
name|ch
operator|->
name|dma
operator|->
name|max_iosize
operator|=
literal|64
operator|*
name|DEV_BSIZE
expr_stmt|;
name|mode
operator|=
name|ata_limit_mode
argument_list|(
name|dev
argument_list|,
name|mode
argument_list|,
name|ATA_UDMA2
argument_list|)
expr_stmt|;
name|error
operator|=
name|ata_controlcmd
argument_list|(
name|dev
argument_list|,
name|ATA_SETFEATURES
argument_list|,
name|ATA_SF_SETXFER
argument_list|,
literal|0
argument_list|,
name|mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s setting %s on National chip\n"
argument_list|,
operator|(
name|error
operator|)
condition|?
literal|"failed"
else|:
literal|"success"
argument_list|,
name|ata_mode2str
argument_list|(
name|mode
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
block|{
if|if
condition|(
name|mode
operator|>=
name|ATA_UDMA0
condition|)
block|{
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
literal|0x44
operator|+
operator|(
name|devno
operator|<<
literal|3
operator|)
argument_list|,
name|udmatiming
index|[
name|mode
operator|&
name|ATA_MODE_MASK
index|]
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|mode
operator|>=
name|ATA_WDMA0
condition|)
block|{
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
literal|0x44
operator|+
operator|(
name|devno
operator|<<
literal|3
operator|)
argument_list|,
name|dmatiming
index|[
name|mode
operator|&
name|ATA_MODE_MASK
index|]
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
literal|0x44
operator|+
operator|(
name|devno
operator|<<
literal|3
operator|)
argument_list|,
name|pci_read_config
argument_list|(
name|gparent
argument_list|,
literal|0x44
operator|+
operator|(
name|devno
operator|<<
literal|3
operator|)
argument_list|,
literal|4
argument_list|)
operator||
literal|0x80000000
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
literal|0x40
operator|+
operator|(
name|devno
operator|<<
literal|3
operator|)
argument_list|,
name|piotiming
index|[
name|ata_mode2idx
argument_list|(
name|mode
argument_list|)
index|]
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|atadev
operator|->
name|mode
operator|=
name|mode
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * NetCell chipset support functions  */
end_comment

begin_function
name|int
name|ata_netcell_ident
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|pci_get_devid
argument_list|(
name|dev
argument_list|)
operator|==
name|ATA_NETCELL_SR
condition|)
block|{
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"Netcell SyncRAID SR3000/5000 RAID Controller"
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|chipinit
operator|=
name|ata_netcell_chipinit
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
name|ENXIO
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_netcell_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|ata_generic_chipinit
argument_list|(
name|dev
argument_list|)
condition|)
return|return
name|ENXIO
return|;
name|ctlr
operator|->
name|allocate
operator|=
name|ata_netcell_allocate
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_netcell_allocate
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
comment|/* setup the usual register normal pci style */
if|if
condition|(
name|ata_pci_allocate
argument_list|(
name|dev
argument_list|)
condition|)
return|return
name|ENXIO
return|;
comment|/* the NetCell only supports 16 bit PIO transfers */
name|ch
operator|->
name|flags
operator||=
name|ATA_USE_16BIT
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * nVidia chipset support functions  */
end_comment

begin_function
name|int
name|ata_nvidia_ident
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
specifier|static
name|struct
name|ata_chip_id
name|ids
index|[]
init|=
block|{
block|{
name|ATA_NFORCE1
block|,
literal|0
block|,
name|AMDNVIDIA
block|,
name|NVIDIA
block|,
name|ATA_UDMA5
block|,
literal|"nForce"
block|}
block|,
block|{
name|ATA_NFORCE2
block|,
literal|0
block|,
name|AMDNVIDIA
block|,
name|NVIDIA
block|,
name|ATA_UDMA6
block|,
literal|"nForce2"
block|}
block|,
block|{
name|ATA_NFORCE2_PRO
block|,
literal|0
block|,
name|AMDNVIDIA
block|,
name|NVIDIA
block|,
name|ATA_UDMA6
block|,
literal|"nForce2 Pro"
block|}
block|,
block|{
name|ATA_NFORCE2_PRO_S1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
name|ATA_SA150
block|,
literal|"nForce2 Pro"
block|}
block|,
block|{
name|ATA_NFORCE3
block|,
literal|0
block|,
name|AMDNVIDIA
block|,
name|NVIDIA
block|,
name|ATA_UDMA6
block|,
literal|"nForce3"
block|}
block|,
block|{
name|ATA_NFORCE3_PRO
block|,
literal|0
block|,
name|AMDNVIDIA
block|,
name|NVIDIA
block|,
name|ATA_UDMA6
block|,
literal|"nForce3 Pro"
block|}
block|,
block|{
name|ATA_NFORCE3_PRO_S1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
name|ATA_SA150
block|,
literal|"nForce3 Pro"
block|}
block|,
block|{
name|ATA_NFORCE3_PRO_S2
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
name|ATA_SA150
block|,
literal|"nForce3 Pro"
block|}
block|,
block|{
name|ATA_NFORCE_MCP04
block|,
literal|0
block|,
name|AMDNVIDIA
block|,
name|NVIDIA
block|,
name|ATA_UDMA6
block|,
literal|"nForce MCP"
block|}
block|,
block|{
name|ATA_NFORCE_MCP04_S1
block|,
literal|0
block|,
literal|0
block|,
name|NV4
block|,
name|ATA_SA150
block|,
literal|"nForce MCP"
block|}
block|,
block|{
name|ATA_NFORCE_MCP04_S2
block|,
literal|0
block|,
literal|0
block|,
name|NV4
block|,
name|ATA_SA150
block|,
literal|"nForce MCP"
block|}
block|,
block|{
name|ATA_NFORCE_CK804
block|,
literal|0
block|,
name|AMDNVIDIA
block|,
name|NVIDIA
block|,
name|ATA_UDMA6
block|,
literal|"nForce CK804"
block|}
block|,
block|{
name|ATA_NFORCE_CK804_S1
block|,
literal|0
block|,
literal|0
block|,
name|NV4
block|,
name|ATA_SA300
block|,
literal|"nForce CK804"
block|}
block|,
block|{
name|ATA_NFORCE_CK804_S2
block|,
literal|0
block|,
literal|0
block|,
name|NV4
block|,
name|ATA_SA300
block|,
literal|"nForce CK804"
block|}
block|,
block|{
name|ATA_NFORCE_MCP51
block|,
literal|0
block|,
name|AMDNVIDIA
block|,
name|NVIDIA
block|,
name|ATA_UDMA6
block|,
literal|"nForce MCP51"
block|}
block|,
block|{
name|ATA_NFORCE_MCP51_S1
block|,
literal|0
block|,
literal|0
block|,
name|NV4
operator||
name|NVQ
block|,
name|ATA_SA300
block|,
literal|"nForce MCP51"
block|}
block|,
block|{
name|ATA_NFORCE_MCP51_S2
block|,
literal|0
block|,
literal|0
block|,
name|NV4
operator||
name|NVQ
block|,
name|ATA_SA300
block|,
literal|"nForce MCP51"
block|}
block|,
block|{
name|ATA_NFORCE_MCP55
block|,
literal|0
block|,
name|AMDNVIDIA
block|,
name|NVIDIA
block|,
name|ATA_UDMA6
block|,
literal|"nForce MCP55"
block|}
block|,
block|{
name|ATA_NFORCE_MCP55_S1
block|,
literal|0
block|,
literal|0
block|,
name|NV4
operator||
name|NVQ
block|,
name|ATA_SA300
block|,
literal|"nForce MCP55"
block|}
block|,
block|{
name|ATA_NFORCE_MCP55_S2
block|,
literal|0
block|,
literal|0
block|,
name|NV4
operator||
name|NVQ
block|,
name|ATA_SA300
block|,
literal|"nForce MCP55"
block|}
block|,
block|{
name|ATA_NFORCE_MCP61
block|,
literal|0
block|,
name|AMDNVIDIA
block|,
name|NVIDIA
block|,
name|ATA_UDMA6
block|,
literal|"nForce MCP61"
block|}
block|,
block|{
name|ATA_NFORCE_MCP61_S1
block|,
literal|0
block|,
literal|0
block|,
name|NV4
operator||
name|NVQ
block|,
name|ATA_SA300
block|,
literal|"nForce MCP61"
block|}
block|,
block|{
name|ATA_NFORCE_MCP61_S2
block|,
literal|0
block|,
literal|0
block|,
name|NV4
operator||
name|NVQ
block|,
name|ATA_SA300
block|,
literal|"nForce MCP61"
block|}
block|,
block|{
name|ATA_NFORCE_MCP61_S3
block|,
literal|0
block|,
literal|0
block|,
name|NV4
operator||
name|NVQ
block|,
name|ATA_SA300
block|,
literal|"nForce MCP61"
block|}
block|,
block|{
name|ATA_NFORCE_MCP65
block|,
literal|0
block|,
name|AMDNVIDIA
block|,
name|NVIDIA
block|,
name|ATA_UDMA6
block|,
literal|"nForce MCP65"
block|}
block|,
block|{
name|ATA_NFORCE_MCP67
block|,
literal|0
block|,
name|AMDNVIDIA
block|,
name|NVIDIA
block|,
name|ATA_UDMA6
block|,
literal|"nForce MCP67"
block|}
block|,
block|{
name|ATA_NFORCE_MCP67_A0
block|,
literal|0
block|,
name|NVAHCI
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"nForce MCP67"
block|}
block|,
block|{
name|ATA_NFORCE_MCP67_A1
block|,
literal|0
block|,
name|NVAHCI
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"nForce MCP67"
block|}
block|,
block|{
name|ATA_NFORCE_MCP67_A2
block|,
literal|0
block|,
name|NVAHCI
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"nForce MCP67"
block|}
block|,
block|{
name|ATA_NFORCE_MCP67_A3
block|,
literal|0
block|,
name|NVAHCI
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"nForce MCP67"
block|}
block|,
block|{
name|ATA_NFORCE_MCP67_A4
block|,
literal|0
block|,
name|NVAHCI
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"nForce MCP67"
block|}
block|,
block|{
name|ATA_NFORCE_MCP67_A5
block|,
literal|0
block|,
name|NVAHCI
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"nForce MCP67"
block|}
block|,
block|{
name|ATA_NFORCE_MCP67_A6
block|,
literal|0
block|,
name|NVAHCI
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"nForce MCP67"
block|}
block|,
block|{
name|ATA_NFORCE_MCP67_A7
block|,
literal|0
block|,
name|NVAHCI
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"nForce MCP67"
block|}
block|,
block|{
name|ATA_NFORCE_MCP67_A8
block|,
literal|0
block|,
name|NVAHCI
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"nForce MCP67"
block|}
block|,
block|{
name|ATA_NFORCE_MCP67_A9
block|,
literal|0
block|,
name|NVAHCI
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"nForce MCP67"
block|}
block|,
block|{
name|ATA_NFORCE_MCP67_AA
block|,
literal|0
block|,
name|NVAHCI
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"nForce MCP67"
block|}
block|,
block|{
name|ATA_NFORCE_MCP67_AB
block|,
literal|0
block|,
name|NVAHCI
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"nForce MCP67"
block|}
block|,
block|{
name|ATA_NFORCE_MCP73
block|,
literal|0
block|,
name|AMDNVIDIA
block|,
name|NVIDIA
block|,
name|ATA_UDMA6
block|,
literal|"nForce MCP73"
block|}
block|,
block|{
name|ATA_NFORCE_MCP73_A0
block|,
literal|0
block|,
name|NVAHCI
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"nForce MCP73"
block|}
block|,
block|{
name|ATA_NFORCE_MCP73_A1
block|,
literal|0
block|,
name|NVAHCI
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"nForce MCP73"
block|}
block|,
block|{
name|ATA_NFORCE_MCP73_A2
block|,
literal|0
block|,
name|NVAHCI
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"nForce MCP73"
block|}
block|,
block|{
name|ATA_NFORCE_MCP73_A3
block|,
literal|0
block|,
name|NVAHCI
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"nForce MCP73"
block|}
block|,
block|{
name|ATA_NFORCE_MCP73_A4
block|,
literal|0
block|,
name|NVAHCI
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"nForce MCP73"
block|}
block|,
block|{
name|ATA_NFORCE_MCP73_A5
block|,
literal|0
block|,
name|NVAHCI
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"nForce MCP73"
block|}
block|,
block|{
name|ATA_NFORCE_MCP73_A6
block|,
literal|0
block|,
name|NVAHCI
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"nForce MCP73"
block|}
block|,
block|{
name|ATA_NFORCE_MCP73_A7
block|,
literal|0
block|,
name|NVAHCI
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"nForce MCP73"
block|}
block|,
block|{
name|ATA_NFORCE_MCP73_A8
block|,
literal|0
block|,
name|NVAHCI
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"nForce MCP73"
block|}
block|,
block|{
name|ATA_NFORCE_MCP73_A9
block|,
literal|0
block|,
name|NVAHCI
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"nForce MCP73"
block|}
block|,
block|{
name|ATA_NFORCE_MCP73_AA
block|,
literal|0
block|,
name|NVAHCI
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"nForce MCP73"
block|}
block|,
block|{
name|ATA_NFORCE_MCP73_AB
block|,
literal|0
block|,
name|NVAHCI
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"nForce MCP73"
block|}
block|,
block|{
name|ATA_NFORCE_MCP77
block|,
literal|0
block|,
name|AMDNVIDIA
block|,
name|NVIDIA
block|,
name|ATA_UDMA6
block|,
literal|"nForce MCP77"
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|ctlr
operator|->
name|chip
operator|=
name|ata_match_chip
argument_list|(
name|dev
argument_list|,
name|ids
argument_list|)
operator|)
condition|)
return|return
name|ENXIO
return|;
name|ata_set_desc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg1
operator|&
name|NVAHCI
condition|)
name|ctlr
operator|->
name|chipinit
operator|=
name|ata_ahci_chipinit
expr_stmt|;
else|else
name|ctlr
operator|->
name|chipinit
operator|=
name|ata_nvidia_chipinit
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_nvidia_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|ata_setup_interrupt
argument_list|(
name|dev
argument_list|)
condition|)
return|return
name|ENXIO
return|;
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|max_dma
operator|>=
name|ATA_SA150
condition|)
block|{
if|if
condition|(
name|pci_read_config
argument_list|(
name|dev
argument_list|,
name|PCIR_BAR
argument_list|(
literal|5
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|&
literal|1
condition|)
name|ctlr
operator|->
name|r_type2
operator|=
name|SYS_RES_IOPORT
expr_stmt|;
else|else
name|ctlr
operator|->
name|r_type2
operator|=
name|SYS_RES_MEMORY
expr_stmt|;
name|ctlr
operator|->
name|r_rid2
operator|=
name|PCIR_BAR
argument_list|(
literal|5
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ctlr
operator|->
name|r_res2
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|ctlr
operator|->
name|r_type2
argument_list|,
operator|&
name|ctlr
operator|->
name|r_rid2
argument_list|,
name|RF_ACTIVE
argument_list|)
operator|)
condition|)
block|{
name|int
name|offset
init|=
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|&
name|NV4
condition|?
literal|0x0440
else|:
literal|0x0010
decl_stmt|;
name|ctlr
operator|->
name|allocate
operator|=
name|ata_nvidia_allocate
expr_stmt|;
name|ctlr
operator|->
name|reset
operator|=
name|ata_nvidia_reset
expr_stmt|;
comment|/* enable control access */
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x50
argument_list|,
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x50
argument_list|,
literal|1
argument_list|)
operator||
literal|0x04
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|&
name|NVQ
condition|)
block|{
comment|/* clear interrupt status */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|offset
argument_list|,
literal|0x00ff00ff
argument_list|)
expr_stmt|;
comment|/* enable device and PHY state change interrupts */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|offset
operator|+
literal|4
argument_list|,
literal|0x000d000d
argument_list|)
expr_stmt|;
comment|/* disable NCQ support */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x0400
argument_list|,
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x0400
argument_list|)
operator|&
literal|0xfffffff9
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* clear interrupt status */
name|ATA_OUTB
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|offset
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
comment|/* enable device and PHY state change interrupts */
name|ATA_OUTB
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|offset
operator|+
literal|1
argument_list|,
literal|0xdd
argument_list|)
expr_stmt|;
block|}
block|}
name|ctlr
operator|->
name|setmode
operator|=
name|ata_sata_setmode
expr_stmt|;
block|}
else|else
block|{
comment|/* disable prefetch, postwrite */
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x51
argument_list|,
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x51
argument_list|,
literal|1
argument_list|)
operator|&
literal|0x0f
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|setmode
operator|=
name|ata_via_family_setmode
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_nvidia_allocate
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
comment|/* setup the usual register normal pci style */
if|if
condition|(
name|ata_pci_allocate
argument_list|(
name|dev
argument_list|)
condition|)
return|return
name|ENXIO
return|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SSTATUS
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_res2
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SSTATUS
index|]
operator|.
name|offset
operator|=
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|6
operator|)
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SERROR
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_res2
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SERROR
index|]
operator|.
name|offset
operator|=
literal|0x04
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|6
operator|)
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SCONTROL
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_res2
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SCONTROL
index|]
operator|.
name|offset
operator|=
literal|0x08
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|6
operator|)
expr_stmt|;
name|ch
operator|->
name|hw
operator|.
name|status
operator|=
name|ata_nvidia_status
expr_stmt|;
name|ch
operator|->
name|flags
operator||=
name|ATA_NO_SLAVE
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_nvidia_status
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|offset
init|=
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|&
name|NV4
condition|?
literal|0x0440
else|:
literal|0x0010
decl_stmt|;
name|int
name|shift
init|=
name|ch
operator|->
name|unit
operator|<<
operator|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|&
name|NVQ
condition|?
literal|4
else|:
literal|2
operator|)
decl_stmt|;
name|u_int32_t
name|istatus
init|=
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|offset
argument_list|)
decl_stmt|;
comment|/* do we have any PHY events ? */
if|if
condition|(
name|istatus
operator|&
operator|(
literal|0x0c
operator|<<
name|shift
operator|)
condition|)
name|ata_sata_phy_check_events
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* clear interrupt(s) */
name|ATA_OUTB
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|offset
argument_list|,
operator|(
literal|0x0f
operator|<<
name|shift
operator|)
operator||
operator|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|&
name|NVQ
condition|?
literal|0x00f000f0
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
comment|/* do we have any device action ? */
return|return
operator|(
name|istatus
operator|&
operator|(
literal|0x01
operator|<<
name|shift
operator|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_nvidia_reset
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
if|if
condition|(
name|ata_sata_phy_reset
argument_list|(
name|dev
argument_list|)
condition|)
name|ata_generic_reset
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Promise chipset support functions  */
end_comment

begin_define
define|#
directive|define
name|ATA_PDC_APKT_OFFSET
value|0x00000010
end_define

begin_define
define|#
directive|define
name|ATA_PDC_HPKT_OFFSET
value|0x00000040
end_define

begin_define
define|#
directive|define
name|ATA_PDC_ASG_OFFSET
value|0x00000080
end_define

begin_define
define|#
directive|define
name|ATA_PDC_LSG_OFFSET
value|0x000000c0
end_define

begin_define
define|#
directive|define
name|ATA_PDC_HSG_OFFSET
value|0x00000100
end_define

begin_define
define|#
directive|define
name|ATA_PDC_CHN_OFFSET
value|0x00000400
end_define

begin_define
define|#
directive|define
name|ATA_PDC_BUF_BASE
value|0x00400000
end_define

begin_define
define|#
directive|define
name|ATA_PDC_BUF_OFFSET
value|0x00100000
end_define

begin_define
define|#
directive|define
name|ATA_PDC_MAX_HPKT
value|8
end_define

begin_define
define|#
directive|define
name|ATA_PDC_WRITE_REG
value|0x00
end_define

begin_define
define|#
directive|define
name|ATA_PDC_WRITE_CTL
value|0x0e
end_define

begin_define
define|#
directive|define
name|ATA_PDC_WRITE_END
value|0x08
end_define

begin_define
define|#
directive|define
name|ATA_PDC_WAIT_NBUSY
value|0x10
end_define

begin_define
define|#
directive|define
name|ATA_PDC_WAIT_READY
value|0x18
end_define

begin_define
define|#
directive|define
name|ATA_PDC_1B
value|0x20
end_define

begin_define
define|#
directive|define
name|ATA_PDC_2B
value|0x40
end_define

begin_struct
struct|struct
name|host_packet
block|{
name|u_int32_t
name|addr
decl_stmt|;
name|TAILQ_ENTRY
argument_list|(
argument|host_packet
argument_list|)
name|chain
expr_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|ata_promise_sx4
block|{
name|struct
name|mtx
name|mtx
decl_stmt|;
name|TAILQ_HEAD
argument_list|(
argument_list|,
argument|host_packet
argument_list|)
name|queue
expr_stmt|;
name|int
name|busy
decl_stmt|;
block|}
struct|;
end_struct

begin_function
name|int
name|ata_promise_ident
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ata_chip_id
modifier|*
name|idx
decl_stmt|;
specifier|static
name|struct
name|ata_chip_id
name|ids
index|[]
init|=
block|{
block|{
name|ATA_PDC20246
block|,
literal|0
block|,
name|PROLD
block|,
literal|0x00
block|,
name|ATA_UDMA2
block|,
literal|"PDC20246"
block|}
block|,
block|{
name|ATA_PDC20262
block|,
literal|0
block|,
name|PRNEW
block|,
literal|0x00
block|,
name|ATA_UDMA4
block|,
literal|"PDC20262"
block|}
block|,
block|{
name|ATA_PDC20263
block|,
literal|0
block|,
name|PRNEW
block|,
literal|0x00
block|,
name|ATA_UDMA4
block|,
literal|"PDC20263"
block|}
block|,
block|{
name|ATA_PDC20265
block|,
literal|0
block|,
name|PRNEW
block|,
literal|0x00
block|,
name|ATA_UDMA5
block|,
literal|"PDC20265"
block|}
block|,
block|{
name|ATA_PDC20267
block|,
literal|0
block|,
name|PRNEW
block|,
literal|0x00
block|,
name|ATA_UDMA5
block|,
literal|"PDC20267"
block|}
block|,
block|{
name|ATA_PDC20268
block|,
literal|0
block|,
name|PRTX
block|,
name|PRTX4
block|,
name|ATA_UDMA5
block|,
literal|"PDC20268"
block|}
block|,
block|{
name|ATA_PDC20269
block|,
literal|0
block|,
name|PRTX
block|,
literal|0x00
block|,
name|ATA_UDMA6
block|,
literal|"PDC20269"
block|}
block|,
block|{
name|ATA_PDC20270
block|,
literal|0
block|,
name|PRTX
block|,
name|PRTX4
block|,
name|ATA_UDMA5
block|,
literal|"PDC20270"
block|}
block|,
block|{
name|ATA_PDC20271
block|,
literal|0
block|,
name|PRTX
block|,
literal|0x00
block|,
name|ATA_UDMA6
block|,
literal|"PDC20271"
block|}
block|,
block|{
name|ATA_PDC20275
block|,
literal|0
block|,
name|PRTX
block|,
literal|0x00
block|,
name|ATA_UDMA6
block|,
literal|"PDC20275"
block|}
block|,
block|{
name|ATA_PDC20276
block|,
literal|0
block|,
name|PRTX
block|,
name|PRSX6K
block|,
name|ATA_UDMA6
block|,
literal|"PDC20276"
block|}
block|,
block|{
name|ATA_PDC20277
block|,
literal|0
block|,
name|PRTX
block|,
literal|0x00
block|,
name|ATA_UDMA6
block|,
literal|"PDC20277"
block|}
block|,
block|{
name|ATA_PDC20318
block|,
literal|0
block|,
name|PRMIO
block|,
name|PRSATA
block|,
name|ATA_SA150
block|,
literal|"PDC20318"
block|}
block|,
block|{
name|ATA_PDC20319
block|,
literal|0
block|,
name|PRMIO
block|,
name|PRSATA
block|,
name|ATA_SA150
block|,
literal|"PDC20319"
block|}
block|,
block|{
name|ATA_PDC20371
block|,
literal|0
block|,
name|PRMIO
block|,
name|PRCMBO
block|,
name|ATA_SA150
block|,
literal|"PDC20371"
block|}
block|,
block|{
name|ATA_PDC20375
block|,
literal|0
block|,
name|PRMIO
block|,
name|PRCMBO
block|,
name|ATA_SA150
block|,
literal|"PDC20375"
block|}
block|,
block|{
name|ATA_PDC20376
block|,
literal|0
block|,
name|PRMIO
block|,
name|PRCMBO
block|,
name|ATA_SA150
block|,
literal|"PDC20376"
block|}
block|,
block|{
name|ATA_PDC20377
block|,
literal|0
block|,
name|PRMIO
block|,
name|PRCMBO
block|,
name|ATA_SA150
block|,
literal|"PDC20377"
block|}
block|,
block|{
name|ATA_PDC20378
block|,
literal|0
block|,
name|PRMIO
block|,
name|PRCMBO
block|,
name|ATA_SA150
block|,
literal|"PDC20378"
block|}
block|,
block|{
name|ATA_PDC20379
block|,
literal|0
block|,
name|PRMIO
block|,
name|PRCMBO
block|,
name|ATA_SA150
block|,
literal|"PDC20379"
block|}
block|,
block|{
name|ATA_PDC20571
block|,
literal|0
block|,
name|PRMIO
block|,
name|PRCMBO2
block|,
name|ATA_SA150
block|,
literal|"PDC20571"
block|}
block|,
block|{
name|ATA_PDC20575
block|,
literal|0
block|,
name|PRMIO
block|,
name|PRCMBO2
block|,
name|ATA_SA150
block|,
literal|"PDC20575"
block|}
block|,
block|{
name|ATA_PDC20579
block|,
literal|0
block|,
name|PRMIO
block|,
name|PRCMBO2
block|,
name|ATA_SA150
block|,
literal|"PDC20579"
block|}
block|,
block|{
name|ATA_PDC20771
block|,
literal|0
block|,
name|PRMIO
block|,
name|PRCMBO2
block|,
name|ATA_SA300
block|,
literal|"PDC20771"
block|}
block|,
block|{
name|ATA_PDC40775
block|,
literal|0
block|,
name|PRMIO
block|,
name|PRCMBO2
block|,
name|ATA_SA300
block|,
literal|"PDC40775"
block|}
block|,
block|{
name|ATA_PDC20617
block|,
literal|0
block|,
name|PRMIO
block|,
name|PRPATA
block|,
name|ATA_UDMA6
block|,
literal|"PDC20617"
block|}
block|,
block|{
name|ATA_PDC20618
block|,
literal|0
block|,
name|PRMIO
block|,
name|PRPATA
block|,
name|ATA_UDMA6
block|,
literal|"PDC20618"
block|}
block|,
block|{
name|ATA_PDC20619
block|,
literal|0
block|,
name|PRMIO
block|,
name|PRPATA
block|,
name|ATA_UDMA6
block|,
literal|"PDC20619"
block|}
block|,
block|{
name|ATA_PDC20620
block|,
literal|0
block|,
name|PRMIO
block|,
name|PRPATA
block|,
name|ATA_UDMA6
block|,
literal|"PDC20620"
block|}
block|,
block|{
name|ATA_PDC20621
block|,
literal|0
block|,
name|PRMIO
block|,
name|PRSX4X
block|,
name|ATA_UDMA5
block|,
literal|"PDC20621"
block|}
block|,
block|{
name|ATA_PDC20622
block|,
literal|0
block|,
name|PRMIO
block|,
name|PRSX4X
block|,
name|ATA_SA150
block|,
literal|"PDC20622"
block|}
block|,
block|{
name|ATA_PDC40518
block|,
literal|0
block|,
name|PRMIO
block|,
name|PRSATA2
block|,
name|ATA_SA150
block|,
literal|"PDC40518"
block|}
block|,
block|{
name|ATA_PDC40519
block|,
literal|0
block|,
name|PRMIO
block|,
name|PRSATA2
block|,
name|ATA_SA150
block|,
literal|"PDC40519"
block|}
block|,
block|{
name|ATA_PDC40718
block|,
literal|0
block|,
name|PRMIO
block|,
name|PRSATA2
block|,
name|ATA_SA300
block|,
literal|"PDC40718"
block|}
block|,
block|{
name|ATA_PDC40719
block|,
literal|0
block|,
name|PRMIO
block|,
name|PRSATA2
block|,
name|ATA_SA300
block|,
literal|"PDC40719"
block|}
block|,
block|{
name|ATA_PDC40779
block|,
literal|0
block|,
name|PRMIO
block|,
name|PRSATA2
block|,
name|ATA_SA300
block|,
literal|"PDC40779"
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
name|char
name|buffer
index|[
literal|64
index|]
decl_stmt|;
name|uintptr_t
name|devid
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|idx
operator|=
name|ata_match_chip
argument_list|(
name|dev
argument_list|,
name|ids
argument_list|)
operator|)
condition|)
return|return
name|ENXIO
return|;
comment|/* if we are on a SuperTrak SX6000 dont attach */
if|if
condition|(
operator|(
name|idx
operator|->
name|cfg2
operator|&
name|PRSX6K
operator|)
operator|&&
name|pci_get_class
argument_list|(
name|GRANDPARENT
argument_list|(
name|dev
argument_list|)
argument_list|)
operator|==
name|PCIC_BRIDGE
operator|&&
operator|!
name|BUS_READ_IVAR
argument_list|(
name|device_get_parent
argument_list|(
name|GRANDPARENT
argument_list|(
name|dev
argument_list|)
argument_list|)
argument_list|,
name|GRANDPARENT
argument_list|(
name|dev
argument_list|)
argument_list|,
name|PCI_IVAR_DEVID
argument_list|,
operator|&
name|devid
argument_list|)
operator|&&
name|devid
operator|==
name|ATA_I960RM
condition|)
return|return
name|ENXIO
return|;
name|strcpy
argument_list|(
name|buffer
argument_list|,
literal|"Promise "
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|buffer
argument_list|,
name|idx
operator|->
name|text
argument_list|)
expr_stmt|;
comment|/* if we are on a FastTrak TX4, adjust the interrupt resource */
if|if
condition|(
operator|(
name|idx
operator|->
name|cfg2
operator|&
name|PRTX4
operator|)
operator|&&
name|pci_get_class
argument_list|(
name|GRANDPARENT
argument_list|(
name|dev
argument_list|)
argument_list|)
operator|==
name|PCIC_BRIDGE
operator|&&
operator|!
name|BUS_READ_IVAR
argument_list|(
name|device_get_parent
argument_list|(
name|GRANDPARENT
argument_list|(
name|dev
argument_list|)
argument_list|)
argument_list|,
name|GRANDPARENT
argument_list|(
name|dev
argument_list|)
argument_list|,
name|PCI_IVAR_DEVID
argument_list|,
operator|&
name|devid
argument_list|)
operator|&&
operator|(
operator|(
name|devid
operator|==
name|ATA_DEC_21150
operator|)
operator|||
operator|(
name|devid
operator|==
name|ATA_DEC_21150_1
operator|)
operator|)
condition|)
block|{
specifier|static
name|long
name|start
init|=
literal|0
decl_stmt|,
name|end
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|pci_get_slot
argument_list|(
name|dev
argument_list|)
operator|==
literal|1
condition|)
block|{
name|bus_get_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
literal|0
argument_list|,
operator|&
name|start
argument_list|,
operator|&
name|end
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|buffer
argument_list|,
literal|" (channel 0+1)"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pci_get_slot
argument_list|(
name|dev
argument_list|)
operator|==
literal|2
operator|&&
name|start
operator|&&
name|end
condition|)
block|{
name|bus_set_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
literal|0
argument_list|,
name|start
argument_list|,
name|end
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|buffer
argument_list|,
literal|" (channel 2+3)"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|start
operator|=
name|end
operator|=
literal|0
expr_stmt|;
block|}
block|}
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"%s %s controller"
argument_list|,
name|buffer
argument_list|,
name|ata_mode2str
argument_list|(
name|idx
operator|->
name|max_dma
argument_list|)
argument_list|)
expr_stmt|;
name|device_set_desc_copy
argument_list|(
name|dev
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|chip
operator|=
name|idx
expr_stmt|;
name|ctlr
operator|->
name|chipinit
operator|=
name|ata_promise_chipinit
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_promise_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|fake_reg
decl_stmt|,
name|stat_reg
decl_stmt|;
if|if
condition|(
name|ata_setup_interrupt
argument_list|(
name|dev
argument_list|)
condition|)
return|return
name|ENXIO
return|;
switch|switch
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg1
condition|)
block|{
case|case
name|PRNEW
case|:
comment|/* setup clocks */
name|ATA_OUTB
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
literal|0x11
argument_list|,
name|ATA_INB
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
literal|0x11
argument_list|)
operator||
literal|0x0a
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|dmainit
operator|=
name|ata_promise_dmainit
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|PROLD
case|:
comment|/* enable burst mode */
name|ATA_OUTB
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
literal|0x1f
argument_list|,
name|ATA_INB
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
literal|0x1f
argument_list|)
operator||
literal|0x01
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|allocate
operator|=
name|ata_promise_allocate
expr_stmt|;
name|ctlr
operator|->
name|setmode
operator|=
name|ata_promise_setmode
expr_stmt|;
return|return
literal|0
return|;
case|case
name|PRTX
case|:
name|ctlr
operator|->
name|allocate
operator|=
name|ata_promise_tx2_allocate
expr_stmt|;
name|ctlr
operator|->
name|setmode
operator|=
name|ata_promise_setmode
expr_stmt|;
return|return
literal|0
return|;
case|case
name|PRMIO
case|:
name|ctlr
operator|->
name|r_type1
operator|=
name|SYS_RES_MEMORY
expr_stmt|;
name|ctlr
operator|->
name|r_rid1
operator|=
name|PCIR_BAR
argument_list|(
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ctlr
operator|->
name|r_res1
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|ctlr
operator|->
name|r_type1
argument_list|,
operator|&
name|ctlr
operator|->
name|r_rid1
argument_list|,
name|RF_ACTIVE
argument_list|)
operator|)
condition|)
goto|goto
name|failnfree
goto|;
name|ctlr
operator|->
name|r_type2
operator|=
name|SYS_RES_MEMORY
expr_stmt|;
name|ctlr
operator|->
name|r_rid2
operator|=
name|PCIR_BAR
argument_list|(
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ctlr
operator|->
name|r_res2
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|ctlr
operator|->
name|r_type2
argument_list|,
operator|&
name|ctlr
operator|->
name|r_rid2
argument_list|,
name|RF_ACTIVE
argument_list|)
operator|)
condition|)
goto|goto
name|failnfree
goto|;
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|==
name|PRSX4X
condition|)
block|{
name|struct
name|ata_promise_sx4
modifier|*
name|hpkt
decl_stmt|;
name|u_int32_t
name|dimm
init|=
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x000c0080
argument_list|)
decl_stmt|;
if|if
condition|(
name|bus_teardown_intr
argument_list|(
name|dev
argument_list|,
name|ctlr
operator|->
name|r_irq
argument_list|,
name|ctlr
operator|->
name|handle
argument_list|)
operator|||
name|bus_setup_intr
argument_list|(
name|dev
argument_list|,
name|ctlr
operator|->
name|r_irq
argument_list|,
name|ATA_INTR_FLAGS
argument_list|,
name|NULL
argument_list|,
name|ata_promise_sx4_intr
argument_list|,
name|ctlr
argument_list|,
operator|&
name|ctlr
operator|->
name|handle
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to setup interrupt\n"
argument_list|)
expr_stmt|;
goto|goto
name|failnfree
goto|;
block|}
comment|/* print info about cache memory */
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"DIMM size %dMB @ 0x%08x%s\n"
argument_list|,
operator|(
operator|(
operator|(
name|dimm
operator|>>
literal|16
operator|)
operator|&
literal|0xff
operator|)
operator|-
operator|(
operator|(
name|dimm
operator|>>
literal|24
operator|)
operator|&
literal|0xff
operator|)
operator|+
literal|1
operator|)
operator|<<
literal|4
argument_list|,
operator|(
operator|(
name|dimm
operator|>>
literal|24
operator|)
operator|&
literal|0xff
operator|)
argument_list|,
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x000c0088
argument_list|)
operator|&
operator|(
literal|1
operator|<<
literal|16
operator|)
condition|?
literal|" ECC enabled"
else|:
literal|""
argument_list|)
expr_stmt|;
comment|/* adjust cache memory parameters */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x000c000c
argument_list|,
operator|(
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x000c000c
argument_list|)
operator|&
literal|0xffff0000
operator|)
argument_list|)
expr_stmt|;
comment|/* setup host packet controls */
name|hpkt
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|ata_promise_sx4
argument_list|)
argument_list|,
name|M_TEMP
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|mtx_init
argument_list|(
operator|&
name|hpkt
operator|->
name|mtx
argument_list|,
literal|"ATA promise HPKT lock"
argument_list|,
name|NULL
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
name|TAILQ_INIT
argument_list|(
operator|&
name|hpkt
operator|->
name|queue
argument_list|)
expr_stmt|;
name|hpkt
operator|->
name|busy
operator|=
literal|0
expr_stmt|;
name|ctlr
operator|->
name|chipset_data
operator|=
name|hpkt
expr_stmt|;
name|ctlr
operator|->
name|allocate
operator|=
name|ata_promise_mio_allocate
expr_stmt|;
name|ctlr
operator|->
name|reset
operator|=
name|ata_promise_mio_reset
expr_stmt|;
name|ctlr
operator|->
name|dmainit
operator|=
name|ata_promise_mio_dmainit
expr_stmt|;
name|ctlr
operator|->
name|setmode
operator|=
name|ata_promise_setmode
expr_stmt|;
name|ctlr
operator|->
name|channels
operator|=
literal|4
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* mio type controllers need an interrupt intercept */
if|if
condition|(
name|bus_teardown_intr
argument_list|(
name|dev
argument_list|,
name|ctlr
operator|->
name|r_irq
argument_list|,
name|ctlr
operator|->
name|handle
argument_list|)
operator|||
name|bus_setup_intr
argument_list|(
name|dev
argument_list|,
name|ctlr
operator|->
name|r_irq
argument_list|,
name|ATA_INTR_FLAGS
argument_list|,
name|NULL
argument_list|,
name|ata_promise_mio_intr
argument_list|,
name|ctlr
argument_list|,
operator|&
name|ctlr
operator|->
name|handle
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to setup interrupt\n"
argument_list|)
expr_stmt|;
goto|goto
name|failnfree
goto|;
block|}
switch|switch
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
condition|)
block|{
case|case
name|PRPATA
case|:
name|ctlr
operator|->
name|channels
operator|=
operator|(
operator|(
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x48
argument_list|)
operator|&
literal|0x01
operator|)
operator|>
literal|0
operator|)
operator|+
operator|(
operator|(
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x48
argument_list|)
operator|&
literal|0x02
operator|)
operator|>
literal|0
operator|)
operator|+
literal|2
expr_stmt|;
goto|goto
name|sata150
goto|;
case|case
name|PRCMBO
case|:
name|ctlr
operator|->
name|channels
operator|=
literal|3
expr_stmt|;
goto|goto
name|sata150
goto|;
case|case
name|PRSATA
case|:
name|ctlr
operator|->
name|channels
operator|=
literal|4
expr_stmt|;
name|sata150
label|:
name|fake_reg
operator|=
literal|0x60
expr_stmt|;
name|stat_reg
operator|=
literal|0x6c
expr_stmt|;
break|break;
case|case
name|PRCMBO2
case|:
name|ctlr
operator|->
name|channels
operator|=
literal|3
expr_stmt|;
goto|goto
name|sataii
goto|;
case|case
name|PRSATA2
case|:
default|default:
name|ctlr
operator|->
name|channels
operator|=
literal|4
expr_stmt|;
name|sataii
label|:
name|fake_reg
operator|=
literal|0x54
expr_stmt|;
name|stat_reg
operator|=
literal|0x60
expr_stmt|;
break|break;
block|}
comment|/* prime fake interrupt register */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|fake_reg
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
comment|/* clear SATA status and unmask interrupts */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|stat_reg
argument_list|,
literal|0x000000ff
argument_list|)
expr_stmt|;
comment|/* enable "long burst lenght" on gen2 chips */
if|if
condition|(
operator|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|==
name|PRSATA2
operator|)
operator|||
operator|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|==
name|PRCMBO2
operator|)
condition|)
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x44
argument_list|,
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x44
argument_list|)
operator||
literal|0x2000
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|allocate
operator|=
name|ata_promise_mio_allocate
expr_stmt|;
name|ctlr
operator|->
name|reset
operator|=
name|ata_promise_mio_reset
expr_stmt|;
name|ctlr
operator|->
name|dmainit
operator|=
name|ata_promise_mio_dmainit
expr_stmt|;
name|ctlr
operator|->
name|setmode
operator|=
name|ata_promise_mio_setmode
expr_stmt|;
return|return
literal|0
return|;
block|}
name|failnfree
label|:
if|if
condition|(
name|ctlr
operator|->
name|r_res2
condition|)
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|ctlr
operator|->
name|r_type2
argument_list|,
name|ctlr
operator|->
name|r_rid2
argument_list|,
name|ctlr
operator|->
name|r_res2
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctlr
operator|->
name|r_res1
condition|)
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|ctlr
operator|->
name|r_type1
argument_list|,
name|ctlr
operator|->
name|r_rid1
argument_list|,
name|ctlr
operator|->
name|r_res1
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_promise_allocate
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|ata_pci_allocate
argument_list|(
name|dev
argument_list|)
condition|)
return|return
name|ENXIO
return|;
name|ch
operator|->
name|hw
operator|.
name|status
operator|=
name|ata_promise_status
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_promise_status
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
literal|0x1c
argument_list|)
operator|&
operator|(
name|ch
operator|->
name|unit
condition|?
literal|0x00004000
else|:
literal|0x00000400
operator|)
condition|)
block|{
return|return
name|ata_pci_status
argument_list|(
name|dev
argument_list|)
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_promise_dmastart
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|GRANDPARENT
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_device
modifier|*
name|atadev
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|atadev
operator|->
name|flags
operator|&
name|ATA_D_48BIT_ACTIVE
condition|)
block|{
name|ATA_OUTB
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
literal|0x11
argument_list|,
name|ATA_INB
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
literal|0x11
argument_list|)
operator||
operator|(
name|ch
operator|->
name|unit
condition|?
literal|0x08
else|:
literal|0x02
operator|)
argument_list|)
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
name|ch
operator|->
name|unit
condition|?
literal|0x24
else|:
literal|0x20
argument_list|,
operator|(
operator|(
name|ch
operator|->
name|dma
operator|->
name|flags
operator|&
name|ATA_DMA_READ
operator|)
condition|?
literal|0x05000000
else|:
literal|0x06000000
operator|)
operator||
operator|(
name|ch
operator|->
name|dma
operator|->
name|cur_iosize
operator|>>
literal|1
operator|)
argument_list|)
expr_stmt|;
block|}
name|ATA_IDX_OUTB
argument_list|(
name|ch
argument_list|,
name|ATA_BMSTAT_PORT
argument_list|,
operator|(
name|ATA_IDX_INB
argument_list|(
name|ch
argument_list|,
name|ATA_BMSTAT_PORT
argument_list|)
operator||
operator|(
name|ATA_BMSTAT_INTERRUPT
operator||
name|ATA_BMSTAT_ERROR
operator|)
operator|)
argument_list|)
expr_stmt|;
name|ATA_IDX_OUTL
argument_list|(
name|ch
argument_list|,
name|ATA_BMDTP_PORT
argument_list|,
name|ch
operator|->
name|dma
operator|->
name|sg_bus
argument_list|)
expr_stmt|;
name|ATA_IDX_OUTB
argument_list|(
name|ch
argument_list|,
name|ATA_BMCMD_PORT
argument_list|,
operator|(
operator|(
name|ch
operator|->
name|dma
operator|->
name|flags
operator|&
name|ATA_DMA_READ
operator|)
condition|?
name|ATA_BMCMD_WRITE_READ
else|:
literal|0
operator|)
operator||
name|ATA_BMCMD_START_STOP
argument_list|)
expr_stmt|;
name|ch
operator|->
name|flags
operator||=
name|ATA_DMA_ACTIVE
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_promise_dmastop
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|GRANDPARENT
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_device
modifier|*
name|atadev
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|error
decl_stmt|;
if|if
condition|(
name|atadev
operator|->
name|flags
operator|&
name|ATA_D_48BIT_ACTIVE
condition|)
block|{
name|ATA_OUTB
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
literal|0x11
argument_list|,
name|ATA_INB
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
literal|0x11
argument_list|)
operator|&
operator|~
operator|(
name|ch
operator|->
name|unit
condition|?
literal|0x08
else|:
literal|0x02
operator|)
argument_list|)
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
name|ch
operator|->
name|unit
condition|?
literal|0x24
else|:
literal|0x20
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|error
operator|=
name|ATA_IDX_INB
argument_list|(
name|ch
argument_list|,
name|ATA_BMSTAT_PORT
argument_list|)
expr_stmt|;
name|ATA_IDX_OUTB
argument_list|(
name|ch
argument_list|,
name|ATA_BMCMD_PORT
argument_list|,
name|ATA_IDX_INB
argument_list|(
name|ch
argument_list|,
name|ATA_BMCMD_PORT
argument_list|)
operator|&
operator|~
name|ATA_BMCMD_START_STOP
argument_list|)
expr_stmt|;
name|ATA_IDX_OUTB
argument_list|(
name|ch
argument_list|,
name|ATA_BMSTAT_PORT
argument_list|,
name|ATA_BMSTAT_INTERRUPT
operator||
name|ATA_BMSTAT_ERROR
argument_list|)
expr_stmt|;
name|ch
operator|->
name|flags
operator|&=
operator|~
name|ATA_DMA_ACTIVE
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_promise_dmareset
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|ATA_IDX_OUTB
argument_list|(
name|ch
argument_list|,
name|ATA_BMCMD_PORT
argument_list|,
name|ATA_IDX_INB
argument_list|(
name|ch
argument_list|,
name|ATA_BMCMD_PORT
argument_list|)
operator|&
operator|~
name|ATA_BMCMD_START_STOP
argument_list|)
expr_stmt|;
name|ATA_IDX_OUTB
argument_list|(
name|ch
argument_list|,
name|ATA_BMSTAT_PORT
argument_list|,
name|ATA_BMSTAT_INTERRUPT
operator||
name|ATA_BMSTAT_ERROR
argument_list|)
expr_stmt|;
name|ch
operator|->
name|flags
operator|&=
operator|~
name|ATA_DMA_ACTIVE
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_promise_dmainit
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|ata_dmainit
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|ch
operator|->
name|dma
condition|)
block|{
name|ch
operator|->
name|dma
operator|->
name|start
operator|=
name|ata_promise_dmastart
expr_stmt|;
name|ch
operator|->
name|dma
operator|->
name|stop
operator|=
name|ata_promise_dmastop
expr_stmt|;
name|ch
operator|->
name|dma
operator|->
name|reset
operator|=
name|ata_promise_dmareset
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ata_promise_setmode
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|device_t
name|gparent
init|=
name|GRANDPARENT
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|gparent
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_device
modifier|*
name|atadev
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|devno
init|=
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|1
operator|)
operator|+
name|ATA_DEV
argument_list|(
name|atadev
operator|->
name|unit
argument_list|)
decl_stmt|;
name|int
name|error
decl_stmt|;
name|u_int32_t
name|timings
index|[]
index|[
literal|2
index|]
init|=
block|{
comment|/*    PROLD       PRNEW                mode */
block|{
literal|0x004ff329
block|,
literal|0x004fff2f
block|}
block|,
comment|/* PIO 0 */
block|{
literal|0x004fec25
block|,
literal|0x004ff82a
block|}
block|,
comment|/* PIO 1 */
block|{
literal|0x004fe823
block|,
literal|0x004ff026
block|}
block|,
comment|/* PIO 2 */
block|{
literal|0x004fe622
block|,
literal|0x004fec24
block|}
block|,
comment|/* PIO 3 */
block|{
literal|0x004fe421
block|,
literal|0x004fe822
block|}
block|,
comment|/* PIO 4 */
block|{
literal|0x004567f3
block|,
literal|0x004acef6
block|}
block|,
comment|/* MWDMA 0 */
block|{
literal|0x004467f3
block|,
literal|0x0048cef6
block|}
block|,
comment|/* MWDMA 1 */
block|{
literal|0x004367f3
block|,
literal|0x0046cef6
block|}
block|,
comment|/* MWDMA 2 */
block|{
literal|0x004367f3
block|,
literal|0x0046cef6
block|}
block|,
comment|/* UDMA 0 */
block|{
literal|0x004247f3
block|,
literal|0x00448ef6
block|}
block|,
comment|/* UDMA 1 */
block|{
literal|0x004127f3
block|,
literal|0x00436ef6
block|}
block|,
comment|/* UDMA 2 */
block|{
literal|0
block|,
literal|0x00424ef6
block|}
block|,
comment|/* UDMA 3 */
block|{
literal|0
block|,
literal|0x004127f3
block|}
block|,
comment|/* UDMA 4 */
block|{
literal|0
block|,
literal|0x004127f3
block|}
comment|/* UDMA 5 */
block|}
decl_stmt|;
name|mode
operator|=
name|ata_limit_mode
argument_list|(
name|dev
argument_list|,
name|mode
argument_list|,
name|ctlr
operator|->
name|chip
operator|->
name|max_dma
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg1
condition|)
block|{
case|case
name|PROLD
case|:
case|case
name|PRNEW
case|:
if|if
condition|(
name|mode
operator|>
name|ATA_UDMA2
operator|&&
operator|(
name|pci_read_config
argument_list|(
name|gparent
argument_list|,
literal|0x50
argument_list|,
literal|2
argument_list|)
operator|&
operator|(
name|ch
operator|->
name|unit
condition|?
literal|1
operator|<<
literal|11
else|:
literal|1
operator|<<
literal|10
operator|)
operator|)
condition|)
block|{
name|ata_print_cable
argument_list|(
name|dev
argument_list|,
literal|"controller"
argument_list|)
expr_stmt|;
name|mode
operator|=
name|ATA_UDMA2
expr_stmt|;
block|}
if|if
condition|(
name|ata_atapi
argument_list|(
name|dev
argument_list|)
operator|&&
name|mode
operator|>
name|ATA_PIO_MAX
condition|)
name|mode
operator|=
name|ata_limit_mode
argument_list|(
name|dev
argument_list|,
name|mode
argument_list|,
name|ATA_PIO_MAX
argument_list|)
expr_stmt|;
break|break;
case|case
name|PRTX
case|:
name|ATA_IDX_OUTB
argument_list|(
name|ch
argument_list|,
name|ATA_BMDEVSPEC_0
argument_list|,
literal|0x0b
argument_list|)
expr_stmt|;
if|if
condition|(
name|mode
operator|>
name|ATA_UDMA2
operator|&&
name|ATA_IDX_INB
argument_list|(
name|ch
argument_list|,
name|ATA_BMDEVSPEC_1
argument_list|)
operator|&
literal|0x04
condition|)
block|{
name|ata_print_cable
argument_list|(
name|dev
argument_list|,
literal|"controller"
argument_list|)
expr_stmt|;
name|mode
operator|=
name|ATA_UDMA2
expr_stmt|;
block|}
break|break;
case|case
name|PRMIO
case|:
if|if
condition|(
name|mode
operator|>
name|ATA_UDMA2
operator|&&
operator|(
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
operator|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|&
name|PRSX4X
condition|?
literal|0x000c0260
else|:
literal|0x0260
operator|)
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|7
operator|)
argument_list|)
operator|&
literal|0x01000000
operator|)
condition|)
block|{
name|ata_print_cable
argument_list|(
name|dev
argument_list|,
literal|"controller"
argument_list|)
expr_stmt|;
name|mode
operator|=
name|ATA_UDMA2
expr_stmt|;
block|}
break|break;
block|}
name|error
operator|=
name|ata_controlcmd
argument_list|(
name|dev
argument_list|,
name|ATA_SETFEATURES
argument_list|,
name|ATA_SF_SETXFER
argument_list|,
literal|0
argument_list|,
name|mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%ssetting %s on %s chip\n"
argument_list|,
operator|(
name|error
operator|)
condition|?
literal|"FAILURE "
else|:
literal|""
argument_list|,
name|ata_mode2str
argument_list|(
name|mode
argument_list|)
argument_list|,
name|ctlr
operator|->
name|chip
operator|->
name|text
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
block|{
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg1
operator|<
name|PRTX
condition|)
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
literal|0x60
operator|+
operator|(
name|devno
operator|<<
literal|2
operator|)
argument_list|,
name|timings
index|[
name|ata_mode2idx
argument_list|(
name|mode
argument_list|)
index|]
index|[
name|ctlr
operator|->
name|chip
operator|->
name|cfg1
index|]
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|atadev
operator|->
name|mode
operator|=
name|mode
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_promise_tx2_allocate
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|ata_pci_allocate
argument_list|(
name|dev
argument_list|)
condition|)
return|return
name|ENXIO
return|;
name|ch
operator|->
name|hw
operator|.
name|status
operator|=
name|ata_promise_tx2_status
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_promise_tx2_status
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|ATA_IDX_OUTB
argument_list|(
name|ch
argument_list|,
name|ATA_BMDEVSPEC_0
argument_list|,
literal|0x0b
argument_list|)
expr_stmt|;
if|if
condition|(
name|ATA_IDX_INB
argument_list|(
name|ch
argument_list|,
name|ATA_BMDEVSPEC_1
argument_list|)
operator|&
literal|0x20
condition|)
block|{
return|return
name|ata_pci_status
argument_list|(
name|dev
argument_list|)
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_promise_mio_allocate
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|offset
init|=
operator|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|&
name|PRSX4X
operator|)
condition|?
literal|0x000c0000
else|:
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
name|ATA_DATA
init|;
name|i
operator|<=
name|ATA_COMMAND
condition|;
name|i
operator|++
control|)
block|{
name|ch
operator|->
name|r_io
index|[
name|i
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_res2
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|i
index|]
operator|.
name|offset
operator|=
name|offset
operator|+
literal|0x0200
operator|+
operator|(
name|i
operator|<<
literal|2
operator|)
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|7
operator|)
expr_stmt|;
block|}
name|ch
operator|->
name|r_io
index|[
name|ATA_CONTROL
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_res2
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_CONTROL
index|]
operator|.
name|offset
operator|=
name|offset
operator|+
literal|0x0238
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|7
operator|)
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_IDX_ADDR
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_res2
expr_stmt|;
name|ata_default_registers
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|&
operator|(
name|PRSATA
operator||
name|PRSATA2
operator|)
operator|)
operator|||
operator|(
operator|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|&
operator|(
name|PRCMBO
operator||
name|PRCMBO2
operator|)
operator|)
operator|&&
name|ch
operator|->
name|unit
operator|<
literal|2
operator|)
condition|)
block|{
name|ch
operator|->
name|r_io
index|[
name|ATA_SSTATUS
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_res2
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SSTATUS
index|]
operator|.
name|offset
operator|=
literal|0x400
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|8
operator|)
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SERROR
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_res2
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SERROR
index|]
operator|.
name|offset
operator|=
literal|0x404
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|8
operator|)
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SCONTROL
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_res2
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SCONTROL
index|]
operator|.
name|offset
operator|=
literal|0x408
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|8
operator|)
expr_stmt|;
name|ch
operator|->
name|flags
operator||=
name|ATA_NO_SLAVE
expr_stmt|;
block|}
name|ch
operator|->
name|flags
operator||=
name|ATA_USE_16BIT
expr_stmt|;
name|ata_generic_hw
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|&
name|PRSX4X
condition|)
block|{
name|ch
operator|->
name|hw
operator|.
name|command
operator|=
name|ata_promise_sx4_command
expr_stmt|;
block|}
else|else
block|{
name|ch
operator|->
name|hw
operator|.
name|command
operator|=
name|ata_promise_mio_command
expr_stmt|;
name|ch
operator|->
name|hw
operator|.
name|status
operator|=
name|ata_promise_mio_status
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_promise_mio_intr
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|data
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
decl_stmt|;
name|u_int32_t
name|vector
decl_stmt|;
name|int
name|unit
decl_stmt|,
name|fake_reg
decl_stmt|;
switch|switch
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
condition|)
block|{
case|case
name|PRPATA
case|:
case|case
name|PRCMBO
case|:
case|case
name|PRSATA
case|:
name|fake_reg
operator|=
literal|0x60
expr_stmt|;
break|break;
case|case
name|PRCMBO2
case|:
case|case
name|PRSATA2
case|:
default|default:
name|fake_reg
operator|=
literal|0x54
expr_stmt|;
break|break;
block|}
comment|/*      * since reading interrupt status register on early "mio" chips      * clears the status bits we cannot read it for each channel later on      * in the generic interrupt routine.      * store the bits in an unused register in the chip so we can read      * it from there safely to get around this "feature".      */
name|vector
operator|=
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x040
argument_list|)
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x040
argument_list|,
name|vector
argument_list|)
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|fake_reg
argument_list|,
name|vector
argument_list|)
expr_stmt|;
for|for
control|(
name|unit
operator|=
literal|0
init|;
name|unit
operator|<
name|ctlr
operator|->
name|channels
condition|;
name|unit
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|ch
operator|=
name|ctlr
operator|->
name|interrupt
index|[
name|unit
index|]
operator|.
name|argument
operator|)
condition|)
name|ctlr
operator|->
name|interrupt
index|[
name|unit
index|]
operator|.
name|function
argument_list|(
name|ch
argument_list|)
expr_stmt|;
block|}
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|fake_reg
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_promise_mio_status
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ata_connect_task
modifier|*
name|tp
decl_stmt|;
name|u_int32_t
name|fake_reg
decl_stmt|,
name|stat_reg
decl_stmt|,
name|vector
decl_stmt|,
name|status
decl_stmt|;
switch|switch
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
condition|)
block|{
case|case
name|PRPATA
case|:
case|case
name|PRCMBO
case|:
case|case
name|PRSATA
case|:
name|fake_reg
operator|=
literal|0x60
expr_stmt|;
name|stat_reg
operator|=
literal|0x6c
expr_stmt|;
break|break;
case|case
name|PRCMBO2
case|:
case|case
name|PRSATA2
case|:
default|default:
name|fake_reg
operator|=
literal|0x54
expr_stmt|;
name|stat_reg
operator|=
literal|0x60
expr_stmt|;
break|break;
block|}
comment|/* read and acknowledge interrupt */
name|vector
operator|=
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|fake_reg
argument_list|)
expr_stmt|;
comment|/* read and clear interface status */
name|status
operator|=
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|stat_reg
argument_list|)
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|stat_reg
argument_list|,
name|status
operator|&
operator|(
literal|0x00000011
operator|<<
name|ch
operator|->
name|unit
operator|)
argument_list|)
expr_stmt|;
comment|/* check for and handle disconnect events */
if|if
condition|(
operator|(
name|status
operator|&
operator|(
literal|0x00000001
operator|<<
name|ch
operator|->
name|unit
operator|)
operator|)
operator|&&
operator|(
name|tp
operator|=
operator|(
expr|struct
name|ata_connect_task
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|ata_connect_task
argument_list|)
argument_list|,
name|M_ATA
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|ch
operator|->
name|dev
argument_list|,
literal|"DISCONNECT requested\n"
argument_list|)
expr_stmt|;
name|tp
operator|->
name|action
operator|=
name|ATA_C_DETACH
expr_stmt|;
name|tp
operator|->
name|dev
operator|=
name|ch
operator|->
name|dev
expr_stmt|;
name|TASK_INIT
argument_list|(
operator|&
name|tp
operator|->
name|task
argument_list|,
literal|0
argument_list|,
name|ata_sata_phy_event
argument_list|,
name|tp
argument_list|)
expr_stmt|;
name|taskqueue_enqueue
argument_list|(
name|taskqueue_thread
argument_list|,
operator|&
name|tp
operator|->
name|task
argument_list|)
expr_stmt|;
block|}
comment|/* check for and handle connect events */
if|if
condition|(
operator|(
name|status
operator|&
operator|(
literal|0x00000010
operator|<<
name|ch
operator|->
name|unit
operator|)
operator|)
operator|&&
operator|(
name|tp
operator|=
operator|(
expr|struct
name|ata_connect_task
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|ata_connect_task
argument_list|)
argument_list|,
name|M_ATA
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|ch
operator|->
name|dev
argument_list|,
literal|"CONNECT requested\n"
argument_list|)
expr_stmt|;
name|tp
operator|->
name|action
operator|=
name|ATA_C_ATTACH
expr_stmt|;
name|tp
operator|->
name|dev
operator|=
name|ch
operator|->
name|dev
expr_stmt|;
name|TASK_INIT
argument_list|(
operator|&
name|tp
operator|->
name|task
argument_list|,
literal|0
argument_list|,
name|ata_sata_phy_event
argument_list|,
name|tp
argument_list|)
expr_stmt|;
name|taskqueue_enqueue
argument_list|(
name|taskqueue_thread
argument_list|,
operator|&
name|tp
operator|->
name|task
argument_list|)
expr_stmt|;
block|}
comment|/* do we have any device action ? */
return|return
operator|(
name|vector
operator|&
operator|(
literal|1
operator|<<
operator|(
name|ch
operator|->
name|unit
operator|+
literal|1
operator|)
operator|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_promise_mio_command
parameter_list|(
name|struct
name|ata_request
modifier|*
name|request
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|GRANDPARENT
argument_list|(
name|request
operator|->
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|request
operator|->
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|u_int32_t
modifier|*
name|wordp
init|=
operator|(
name|u_int32_t
operator|*
operator|)
name|ch
operator|->
name|dma
operator|->
name|work
decl_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
operator|(
name|ch
operator|->
name|unit
operator|+
literal|1
operator|)
operator|<<
literal|2
argument_list|,
literal|0x00000001
argument_list|)
expr_stmt|;
comment|/* XXX SOS add ATAPI commands support later */
switch|switch
condition|(
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|command
condition|)
block|{
default|default:
return|return
name|ata_generic_command
argument_list|(
name|request
argument_list|)
return|;
case|case
name|ATA_READ_DMA
case|:
case|case
name|ATA_READ_DMA48
case|:
name|wordp
index|[
literal|0
index|]
operator|=
name|htole32
argument_list|(
literal|0x04
operator||
operator|(
operator|(
name|ch
operator|->
name|unit
operator|+
literal|1
operator|)
operator|<<
literal|16
operator|)
operator||
operator|(
literal|0x00
operator|<<
literal|24
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|ATA_WRITE_DMA
case|:
case|case
name|ATA_WRITE_DMA48
case|:
name|wordp
index|[
literal|0
index|]
operator|=
name|htole32
argument_list|(
literal|0x00
operator||
operator|(
operator|(
name|ch
operator|->
name|unit
operator|+
literal|1
operator|)
operator|<<
literal|16
operator|)
operator||
operator|(
literal|0x00
operator|<<
literal|24
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|wordp
index|[
literal|1
index|]
operator|=
name|htole32
argument_list|(
name|ch
operator|->
name|dma
operator|->
name|sg_bus
argument_list|)
expr_stmt|;
name|wordp
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|ata_promise_apkt
argument_list|(
operator|(
name|u_int8_t
operator|*
operator|)
name|wordp
argument_list|,
name|request
argument_list|)
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x0240
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|7
operator|)
argument_list|,
name|ch
operator|->
name|dma
operator|->
name|work_bus
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_promise_mio_reset
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ata_promise_sx4
modifier|*
name|hpktp
decl_stmt|;
switch|switch
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
condition|)
block|{
case|case
name|PRSX4X
case|:
comment|/* softreset channel ATA module */
name|hpktp
operator|=
name|ctlr
operator|->
name|chipset_data
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0xc0260
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|7
operator|)
argument_list|,
name|ch
operator|->
name|unit
operator|+
literal|1
argument_list|)
expr_stmt|;
name|ata_udelay
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0xc0260
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|7
operator|)
argument_list|,
operator|(
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0xc0260
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|7
operator|)
argument_list|)
operator|&
operator|~
literal|0x00003f9f
operator|)
operator||
operator|(
name|ch
operator|->
name|unit
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
comment|/* softreset HOST module */
comment|/* XXX SOS what about other outstandings */
name|mtx_lock
argument_list|(
operator|&
name|hpktp
operator|->
name|mtx
argument_list|)
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0xc012c
argument_list|,
operator|(
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0xc012c
argument_list|)
operator|&
operator|~
literal|0x00000f9f
operator|)
operator||
operator|(
literal|1
operator|<<
literal|11
operator|)
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0xc012c
argument_list|,
operator|(
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0xc012c
argument_list|)
operator|&
operator|~
literal|0x00000f9f
operator|)
argument_list|)
expr_stmt|;
name|hpktp
operator|->
name|busy
operator|=
literal|0
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|hpktp
operator|->
name|mtx
argument_list|)
expr_stmt|;
name|ata_generic_reset
argument_list|(
name|dev
argument_list|)
expr_stmt|;
break|break;
case|case
name|PRPATA
case|:
case|case
name|PRCMBO
case|:
case|case
name|PRSATA
case|:
if|if
condition|(
operator|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|==
name|PRSATA
operator|)
operator|||
operator|(
operator|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|==
name|PRCMBO
operator|)
operator|&&
operator|(
name|ch
operator|->
name|unit
operator|<
literal|2
operator|)
operator|)
condition|)
block|{
comment|/* mask plug/unplug intr */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x06c
argument_list|,
operator|(
literal|0x00110000
operator|<<
name|ch
operator|->
name|unit
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* softreset channels ATA module */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x0260
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|7
operator|)
argument_list|,
operator|(
literal|1
operator|<<
literal|11
operator|)
argument_list|)
expr_stmt|;
name|ata_udelay
argument_list|(
literal|10000
argument_list|)
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x0260
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|7
operator|)
argument_list|,
operator|(
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x0260
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|7
operator|)
argument_list|)
operator|&
operator|~
literal|0x00003f9f
operator|)
operator||
operator|(
name|ch
operator|->
name|unit
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|==
name|PRSATA
operator|)
operator|||
operator|(
operator|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|==
name|PRCMBO
operator|)
operator|&&
operator|(
name|ch
operator|->
name|unit
operator|<
literal|2
operator|)
operator|)
condition|)
block|{
if|if
condition|(
name|ata_sata_phy_reset
argument_list|(
name|dev
argument_list|)
condition|)
name|ata_generic_reset
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* reset and enable plug/unplug intr */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x06c
argument_list|,
operator|(
literal|0x00000011
operator|<<
name|ch
operator|->
name|unit
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
name|ata_generic_reset
argument_list|(
name|dev
argument_list|)
expr_stmt|;
break|break;
case|case
name|PRCMBO2
case|:
case|case
name|PRSATA2
case|:
if|if
condition|(
operator|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|==
name|PRSATA2
operator|)
operator|||
operator|(
operator|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|==
name|PRCMBO2
operator|)
operator|&&
operator|(
name|ch
operator|->
name|unit
operator|<
literal|2
operator|)
operator|)
condition|)
block|{
comment|/* set portmultiplier port */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x4e8
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|8
operator|)
argument_list|,
literal|0x0f
argument_list|)
expr_stmt|;
comment|/* mask plug/unplug intr */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x060
argument_list|,
operator|(
literal|0x00110000
operator|<<
name|ch
operator|->
name|unit
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* softreset channels ATA module */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x0260
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|7
operator|)
argument_list|,
operator|(
literal|1
operator|<<
literal|11
operator|)
argument_list|)
expr_stmt|;
name|ata_udelay
argument_list|(
literal|10000
argument_list|)
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x0260
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|7
operator|)
argument_list|,
operator|(
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x0260
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|7
operator|)
argument_list|)
operator|&
operator|~
literal|0x00003f9f
operator|)
operator||
operator|(
name|ch
operator|->
name|unit
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|==
name|PRSATA2
operator|)
operator|||
operator|(
operator|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|==
name|PRCMBO2
operator|)
operator|&&
operator|(
name|ch
operator|->
name|unit
operator|<
literal|2
operator|)
operator|)
condition|)
block|{
comment|/* set PHY mode to "improved" */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x414
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|8
operator|)
argument_list|,
operator|(
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x414
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|8
operator|)
argument_list|)
operator|&
operator|~
literal|0x00000003
operator|)
operator||
literal|0x00000001
argument_list|)
expr_stmt|;
if|if
condition|(
name|ata_sata_phy_reset
argument_list|(
name|dev
argument_list|)
condition|)
name|ata_generic_reset
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* reset and enable plug/unplug intr */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x060
argument_list|,
operator|(
literal|0x00000011
operator|<<
name|ch
operator|->
name|unit
operator|)
argument_list|)
expr_stmt|;
comment|/* set portmultiplier port */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x4e8
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|8
operator|)
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
block|}
else|else
name|ata_generic_reset
argument_list|(
name|dev
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ata_promise_mio_dmainit
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
comment|/* note start and stop are not used here */
name|ata_dmainit
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|ch
operator|->
name|dma
condition|)
name|ch
operator|->
name|dma
operator|->
name|setprd
operator|=
name|ata_promise_mio_setprd
expr_stmt|;
block|}
end_function

begin_define
define|#
directive|define
name|MAXLASTSGSIZE
value|(32 * sizeof(u_int32_t))
end_define

begin_function
specifier|static
name|void
name|ata_promise_mio_setprd
parameter_list|(
name|void
modifier|*
name|xsc
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|segs
parameter_list|,
name|int
name|nsegs
parameter_list|,
name|int
name|error
parameter_list|)
block|{
name|struct
name|ata_dmasetprd_args
modifier|*
name|args
init|=
name|xsc
decl_stmt|;
name|struct
name|ata_dma_prdentry
modifier|*
name|prd
init|=
name|args
operator|->
name|dmatab
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|(
name|args
operator|->
name|error
operator|=
name|error
operator|)
condition|)
return|return;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nsegs
condition|;
name|i
operator|++
control|)
block|{
name|prd
index|[
name|i
index|]
operator|.
name|addr
operator|=
name|htole32
argument_list|(
name|segs
index|[
name|i
index|]
operator|.
name|ds_addr
argument_list|)
expr_stmt|;
name|prd
index|[
name|i
index|]
operator|.
name|count
operator|=
name|htole32
argument_list|(
name|segs
index|[
name|i
index|]
operator|.
name|ds_len
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|segs
index|[
name|i
operator|-
literal|1
index|]
operator|.
name|ds_len
operator|>
name|MAXLASTSGSIZE
condition|)
block|{
comment|//printf("split last SG element of %u\n", segs[i - 1].ds_len);
name|prd
index|[
name|i
operator|-
literal|1
index|]
operator|.
name|count
operator|=
name|htole32
argument_list|(
name|segs
index|[
name|i
operator|-
literal|1
index|]
operator|.
name|ds_len
operator|-
name|MAXLASTSGSIZE
argument_list|)
expr_stmt|;
name|prd
index|[
name|i
index|]
operator|.
name|count
operator|=
name|htole32
argument_list|(
name|MAXLASTSGSIZE
argument_list|)
expr_stmt|;
name|prd
index|[
name|i
index|]
operator|.
name|addr
operator|=
name|htole32
argument_list|(
name|segs
index|[
name|i
operator|-
literal|1
index|]
operator|.
name|ds_addr
operator|+
operator|(
name|segs
index|[
name|i
operator|-
literal|1
index|]
operator|.
name|ds_len
operator|-
name|MAXLASTSGSIZE
operator|)
argument_list|)
expr_stmt|;
name|nsegs
operator|++
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
name|prd
index|[
name|i
operator|-
literal|1
index|]
operator|.
name|count
operator||=
name|htole32
argument_list|(
name|ATA_DMA_EOT
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|nsegs
operator|<=
name|ATA_DMA_ENTRIES
argument_list|,
operator|(
literal|"too many DMA segment entries\n"
operator|)
argument_list|)
expr_stmt|;
name|args
operator|->
name|nsegs
operator|=
name|nsegs
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_promise_mio_setmode
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|device_t
name|gparent
init|=
name|GRANDPARENT
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|gparent
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|==
name|PRSATA
operator|)
operator|||
operator|(
operator|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|==
name|PRCMBO
operator|)
operator|&&
operator|(
name|ch
operator|->
name|unit
operator|<
literal|2
operator|)
operator|)
operator|||
operator|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|==
name|PRSATA2
operator|)
operator|||
operator|(
operator|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|==
name|PRCMBO2
operator|)
operator|&&
operator|(
name|ch
operator|->
name|unit
operator|<
literal|2
operator|)
operator|)
condition|)
name|ata_sata_setmode
argument_list|(
name|dev
argument_list|,
name|mode
argument_list|)
expr_stmt|;
else|else
name|ata_promise_setmode
argument_list|(
name|dev
argument_list|,
name|mode
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_promise_sx4_intr
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|data
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
decl_stmt|;
name|u_int32_t
name|vector
init|=
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x000c0480
argument_list|)
decl_stmt|;
name|int
name|unit
decl_stmt|;
for|for
control|(
name|unit
operator|=
literal|0
init|;
name|unit
operator|<
name|ctlr
operator|->
name|channels
condition|;
name|unit
operator|++
control|)
block|{
if|if
condition|(
name|vector
operator|&
operator|(
literal|1
operator|<<
operator|(
name|unit
operator|+
literal|1
operator|)
operator|)
condition|)
if|if
condition|(
operator|(
name|ch
operator|=
name|ctlr
operator|->
name|interrupt
index|[
name|unit
index|]
operator|.
name|argument
operator|)
condition|)
name|ctlr
operator|->
name|interrupt
index|[
name|unit
index|]
operator|.
name|function
argument_list|(
name|ch
argument_list|)
expr_stmt|;
if|if
condition|(
name|vector
operator|&
operator|(
literal|1
operator|<<
operator|(
name|unit
operator|+
literal|5
operator|)
operator|)
condition|)
if|if
condition|(
operator|(
name|ch
operator|=
name|ctlr
operator|->
name|interrupt
index|[
name|unit
index|]
operator|.
name|argument
operator|)
condition|)
name|ata_promise_queue_hpkt
argument_list|(
name|ctlr
argument_list|,
name|htole32
argument_list|(
operator|(
name|ch
operator|->
name|unit
operator|*
name|ATA_PDC_CHN_OFFSET
operator|)
operator|+
name|ATA_PDC_HPKT_OFFSET
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vector
operator|&
operator|(
literal|1
operator|<<
operator|(
name|unit
operator|+
literal|9
operator|)
operator|)
condition|)
block|{
name|ata_promise_next_hpkt
argument_list|(
name|ctlr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ch
operator|=
name|ctlr
operator|->
name|interrupt
index|[
name|unit
index|]
operator|.
name|argument
operator|)
condition|)
name|ctlr
operator|->
name|interrupt
index|[
name|unit
index|]
operator|.
name|function
argument_list|(
name|ch
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|vector
operator|&
operator|(
literal|1
operator|<<
operator|(
name|unit
operator|+
literal|13
operator|)
operator|)
condition|)
block|{
name|ata_promise_next_hpkt
argument_list|(
name|ctlr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ch
operator|=
name|ctlr
operator|->
name|interrupt
index|[
name|unit
index|]
operator|.
name|argument
operator|)
condition|)
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x000c0240
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|7
operator|)
argument_list|,
name|htole32
argument_list|(
operator|(
name|ch
operator|->
name|unit
operator|*
name|ATA_PDC_CHN_OFFSET
operator|)
operator|+
name|ATA_PDC_APKT_OFFSET
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|ata_promise_sx4_command
parameter_list|(
name|struct
name|ata_request
modifier|*
name|request
parameter_list|)
block|{
name|device_t
name|gparent
init|=
name|GRANDPARENT
argument_list|(
name|request
operator|->
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|gparent
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|request
operator|->
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_dma_prdentry
modifier|*
name|prd
init|=
name|ch
operator|->
name|dma
operator|->
name|sg
decl_stmt|;
name|caddr_t
name|window
init|=
name|rman_get_virtual
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|)
decl_stmt|;
name|u_int32_t
modifier|*
name|wordp
decl_stmt|;
name|int
name|i
decl_stmt|,
name|idx
decl_stmt|,
name|length
init|=
literal|0
decl_stmt|;
comment|/* XXX SOS add ATAPI commands support later */
switch|switch
condition|(
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|command
condition|)
block|{
default|default:
return|return
operator|-
literal|1
return|;
case|case
name|ATA_ATA_IDENTIFY
case|:
case|case
name|ATA_READ
case|:
case|case
name|ATA_READ48
case|:
case|case
name|ATA_READ_MUL
case|:
case|case
name|ATA_READ_MUL48
case|:
case|case
name|ATA_WRITE
case|:
case|case
name|ATA_WRITE48
case|:
case|case
name|ATA_WRITE_MUL
case|:
case|case
name|ATA_WRITE_MUL48
case|:
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x000c0400
operator|+
operator|(
operator|(
name|ch
operator|->
name|unit
operator|+
literal|1
operator|)
operator|<<
literal|2
operator|)
argument_list|,
literal|0x00000001
argument_list|)
expr_stmt|;
return|return
name|ata_generic_command
argument_list|(
name|request
argument_list|)
return|;
case|case
name|ATA_SETFEATURES
case|:
case|case
name|ATA_FLUSHCACHE
case|:
case|case
name|ATA_FLUSHCACHE48
case|:
case|case
name|ATA_SLEEP
case|:
case|case
name|ATA_SET_MULTI
case|:
name|wordp
operator|=
operator|(
name|u_int32_t
operator|*
operator|)
operator|(
name|window
operator|+
operator|(
name|ch
operator|->
name|unit
operator|*
name|ATA_PDC_CHN_OFFSET
operator|)
operator|+
name|ATA_PDC_APKT_OFFSET
operator|)
expr_stmt|;
name|wordp
index|[
literal|0
index|]
operator|=
name|htole32
argument_list|(
literal|0x08
operator||
operator|(
operator|(
name|ch
operator|->
name|unit
operator|+
literal|1
operator|)
operator|<<
literal|16
operator|)
operator||
operator|(
literal|0x00
operator|<<
literal|24
operator|)
argument_list|)
expr_stmt|;
name|wordp
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|wordp
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|ata_promise_apkt
argument_list|(
operator|(
name|u_int8_t
operator|*
operator|)
name|wordp
argument_list|,
name|request
argument_list|)
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x000c0484
argument_list|,
literal|0x00000001
argument_list|)
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x000c0400
operator|+
operator|(
operator|(
name|ch
operator|->
name|unit
operator|+
literal|1
operator|)
operator|<<
literal|2
operator|)
argument_list|,
literal|0x00000001
argument_list|)
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x000c0240
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|7
operator|)
argument_list|,
name|htole32
argument_list|(
operator|(
name|ch
operator|->
name|unit
operator|*
name|ATA_PDC_CHN_OFFSET
operator|)
operator|+
name|ATA_PDC_APKT_OFFSET
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|ATA_READ_DMA
case|:
case|case
name|ATA_READ_DMA48
case|:
case|case
name|ATA_WRITE_DMA
case|:
case|case
name|ATA_WRITE_DMA48
case|:
name|wordp
operator|=
operator|(
name|u_int32_t
operator|*
operator|)
operator|(
name|window
operator|+
operator|(
name|ch
operator|->
name|unit
operator|*
name|ATA_PDC_CHN_OFFSET
operator|)
operator|+
name|ATA_PDC_HSG_OFFSET
operator|)
expr_stmt|;
name|i
operator|=
name|idx
operator|=
literal|0
expr_stmt|;
do|do
block|{
name|wordp
index|[
name|idx
operator|++
index|]
operator|=
name|prd
index|[
name|i
index|]
operator|.
name|addr
expr_stmt|;
name|wordp
index|[
name|idx
operator|++
index|]
operator|=
name|prd
index|[
name|i
index|]
operator|.
name|count
expr_stmt|;
name|length
operator|+=
operator|(
name|prd
index|[
name|i
index|]
operator|.
name|count
operator|&
operator|~
name|ATA_DMA_EOT
operator|)
expr_stmt|;
block|}
do|while
condition|(
operator|!
operator|(
name|prd
index|[
name|i
operator|++
index|]
operator|.
name|count
operator|&
name|ATA_DMA_EOT
operator|)
condition|)
do|;
name|wordp
operator|=
operator|(
name|u_int32_t
operator|*
operator|)
operator|(
name|window
operator|+
operator|(
name|ch
operator|->
name|unit
operator|*
name|ATA_PDC_CHN_OFFSET
operator|)
operator|+
name|ATA_PDC_LSG_OFFSET
operator|)
expr_stmt|;
name|wordp
index|[
literal|0
index|]
operator|=
name|htole32
argument_list|(
operator|(
name|ch
operator|->
name|unit
operator|*
name|ATA_PDC_BUF_OFFSET
operator|)
operator|+
name|ATA_PDC_BUF_BASE
argument_list|)
expr_stmt|;
name|wordp
index|[
literal|1
index|]
operator|=
name|htole32
argument_list|(
name|request
operator|->
name|bytecount
operator||
name|ATA_DMA_EOT
argument_list|)
expr_stmt|;
name|wordp
operator|=
operator|(
name|u_int32_t
operator|*
operator|)
operator|(
name|window
operator|+
operator|(
name|ch
operator|->
name|unit
operator|*
name|ATA_PDC_CHN_OFFSET
operator|)
operator|+
name|ATA_PDC_ASG_OFFSET
operator|)
expr_stmt|;
name|wordp
index|[
literal|0
index|]
operator|=
name|htole32
argument_list|(
operator|(
name|ch
operator|->
name|unit
operator|*
name|ATA_PDC_BUF_OFFSET
operator|)
operator|+
name|ATA_PDC_BUF_BASE
argument_list|)
expr_stmt|;
name|wordp
index|[
literal|1
index|]
operator|=
name|htole32
argument_list|(
name|request
operator|->
name|bytecount
operator||
name|ATA_DMA_EOT
argument_list|)
expr_stmt|;
name|wordp
operator|=
operator|(
name|u_int32_t
operator|*
operator|)
operator|(
name|window
operator|+
operator|(
name|ch
operator|->
name|unit
operator|*
name|ATA_PDC_CHN_OFFSET
operator|)
operator|+
name|ATA_PDC_HPKT_OFFSET
operator|)
expr_stmt|;
if|if
condition|(
name|request
operator|->
name|flags
operator|&
name|ATA_R_READ
condition|)
name|wordp
index|[
literal|0
index|]
operator|=
name|htole32
argument_list|(
literal|0x14
operator||
operator|(
operator|(
name|ch
operator|->
name|unit
operator|+
literal|9
operator|)
operator|<<
literal|16
operator|)
operator||
operator|(
operator|(
name|ch
operator|->
name|unit
operator|+
literal|5
operator|)
operator|<<
literal|24
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|request
operator|->
name|flags
operator|&
name|ATA_R_WRITE
condition|)
name|wordp
index|[
literal|0
index|]
operator|=
name|htole32
argument_list|(
literal|0x00
operator||
operator|(
operator|(
name|ch
operator|->
name|unit
operator|+
literal|13
operator|)
operator|<<
literal|16
operator|)
operator||
operator|(
literal|0x00
operator|<<
literal|24
operator|)
argument_list|)
expr_stmt|;
name|wordp
index|[
literal|1
index|]
operator|=
name|htole32
argument_list|(
operator|(
name|ch
operator|->
name|unit
operator|*
name|ATA_PDC_CHN_OFFSET
operator|)
operator|+
name|ATA_PDC_HSG_OFFSET
argument_list|)
expr_stmt|;
name|wordp
index|[
literal|2
index|]
operator|=
name|htole32
argument_list|(
operator|(
name|ch
operator|->
name|unit
operator|*
name|ATA_PDC_CHN_OFFSET
operator|)
operator|+
name|ATA_PDC_LSG_OFFSET
argument_list|)
expr_stmt|;
name|wordp
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|wordp
operator|=
operator|(
name|u_int32_t
operator|*
operator|)
operator|(
name|window
operator|+
operator|(
name|ch
operator|->
name|unit
operator|*
name|ATA_PDC_CHN_OFFSET
operator|)
operator|+
name|ATA_PDC_APKT_OFFSET
operator|)
expr_stmt|;
if|if
condition|(
name|request
operator|->
name|flags
operator|&
name|ATA_R_READ
condition|)
name|wordp
index|[
literal|0
index|]
operator|=
name|htole32
argument_list|(
literal|0x04
operator||
operator|(
operator|(
name|ch
operator|->
name|unit
operator|+
literal|5
operator|)
operator|<<
literal|16
operator|)
operator||
operator|(
literal|0x00
operator|<<
literal|24
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|request
operator|->
name|flags
operator|&
name|ATA_R_WRITE
condition|)
name|wordp
index|[
literal|0
index|]
operator|=
name|htole32
argument_list|(
literal|0x10
operator||
operator|(
operator|(
name|ch
operator|->
name|unit
operator|+
literal|1
operator|)
operator|<<
literal|16
operator|)
operator||
operator|(
operator|(
name|ch
operator|->
name|unit
operator|+
literal|13
operator|)
operator|<<
literal|24
operator|)
argument_list|)
expr_stmt|;
name|wordp
index|[
literal|1
index|]
operator|=
name|htole32
argument_list|(
operator|(
name|ch
operator|->
name|unit
operator|*
name|ATA_PDC_CHN_OFFSET
operator|)
operator|+
name|ATA_PDC_ASG_OFFSET
argument_list|)
expr_stmt|;
name|wordp
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|ata_promise_apkt
argument_list|(
operator|(
name|u_int8_t
operator|*
operator|)
name|wordp
argument_list|,
name|request
argument_list|)
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x000c0484
argument_list|,
literal|0x00000001
argument_list|)
expr_stmt|;
if|if
condition|(
name|request
operator|->
name|flags
operator|&
name|ATA_R_READ
condition|)
block|{
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x000c0400
operator|+
operator|(
operator|(
name|ch
operator|->
name|unit
operator|+
literal|5
operator|)
operator|<<
literal|2
operator|)
argument_list|,
literal|0x00000001
argument_list|)
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x000c0400
operator|+
operator|(
operator|(
name|ch
operator|->
name|unit
operator|+
literal|9
operator|)
operator|<<
literal|2
operator|)
argument_list|,
literal|0x00000001
argument_list|)
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x000c0240
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|7
operator|)
argument_list|,
name|htole32
argument_list|(
operator|(
name|ch
operator|->
name|unit
operator|*
name|ATA_PDC_CHN_OFFSET
operator|)
operator|+
name|ATA_PDC_APKT_OFFSET
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|request
operator|->
name|flags
operator|&
name|ATA_R_WRITE
condition|)
block|{
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x000c0400
operator|+
operator|(
operator|(
name|ch
operator|->
name|unit
operator|+
literal|1
operator|)
operator|<<
literal|2
operator|)
argument_list|,
literal|0x00000001
argument_list|)
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x000c0400
operator|+
operator|(
operator|(
name|ch
operator|->
name|unit
operator|+
literal|13
operator|)
operator|<<
literal|2
operator|)
argument_list|,
literal|0x00000001
argument_list|)
expr_stmt|;
name|ata_promise_queue_hpkt
argument_list|(
name|ctlr
argument_list|,
name|htole32
argument_list|(
operator|(
name|ch
operator|->
name|unit
operator|*
name|ATA_PDC_CHN_OFFSET
operator|)
operator|+
name|ATA_PDC_HPKT_OFFSET
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|ata_promise_apkt
parameter_list|(
name|u_int8_t
modifier|*
name|bytep
parameter_list|,
name|struct
name|ata_request
modifier|*
name|request
parameter_list|)
block|{
name|struct
name|ata_device
modifier|*
name|atadev
init|=
name|device_get_softc
argument_list|(
name|request
operator|->
name|dev
argument_list|)
decl_stmt|;
name|int
name|i
init|=
literal|12
decl_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|ATA_PDC_1B
operator||
name|ATA_PDC_WRITE_REG
operator||
name|ATA_PDC_WAIT_NBUSY
operator||
name|ATA_DRIVE
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|ATA_D_IBM
operator||
name|ATA_D_LBA
operator||
name|atadev
operator|->
name|unit
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|ATA_PDC_1B
operator||
name|ATA_PDC_WRITE_CTL
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|ATA_A_4BIT
expr_stmt|;
if|if
condition|(
name|atadev
operator|->
name|flags
operator|&
name|ATA_D_48BIT_ACTIVE
condition|)
block|{
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|ATA_PDC_2B
operator||
name|ATA_PDC_WRITE_REG
operator||
name|ATA_FEATURE
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|feature
operator|>>
literal|8
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|feature
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|ATA_PDC_2B
operator||
name|ATA_PDC_WRITE_REG
operator||
name|ATA_COUNT
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|count
operator|>>
literal|8
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|count
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|ATA_PDC_2B
operator||
name|ATA_PDC_WRITE_REG
operator||
name|ATA_SECTOR
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|>>
literal|24
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|ATA_PDC_2B
operator||
name|ATA_PDC_WRITE_REG
operator||
name|ATA_CYL_LSB
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|>>
literal|32
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|>>
literal|8
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|ATA_PDC_2B
operator||
name|ATA_PDC_WRITE_REG
operator||
name|ATA_CYL_MSB
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|>>
literal|40
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|>>
literal|16
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|ATA_PDC_1B
operator||
name|ATA_PDC_WRITE_REG
operator||
name|ATA_DRIVE
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|ATA_D_LBA
operator||
name|atadev
operator|->
name|unit
expr_stmt|;
block|}
else|else
block|{
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|ATA_PDC_1B
operator||
name|ATA_PDC_WRITE_REG
operator||
name|ATA_FEATURE
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|feature
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|ATA_PDC_1B
operator||
name|ATA_PDC_WRITE_REG
operator||
name|ATA_COUNT
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|count
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|ATA_PDC_1B
operator||
name|ATA_PDC_WRITE_REG
operator||
name|ATA_SECTOR
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|ATA_PDC_1B
operator||
name|ATA_PDC_WRITE_REG
operator||
name|ATA_CYL_LSB
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|>>
literal|8
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|ATA_PDC_1B
operator||
name|ATA_PDC_WRITE_REG
operator||
name|ATA_CYL_MSB
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|>>
literal|16
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|ATA_PDC_1B
operator||
name|ATA_PDC_WRITE_REG
operator||
name|ATA_DRIVE
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
operator|(
name|atadev
operator|->
name|flags
operator|&
name|ATA_D_USE_CHS
condition|?
literal|0
else|:
name|ATA_D_LBA
operator|)
operator||
name|ATA_D_IBM
operator||
name|atadev
operator|->
name|unit
operator||
operator|(
operator|(
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|>>
literal|24
operator|)
operator|&
literal|0xf
operator|)
expr_stmt|;
block|}
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|ATA_PDC_1B
operator||
name|ATA_PDC_WRITE_END
operator||
name|ATA_COMMAND
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|command
expr_stmt|;
return|return
name|i
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_promise_queue_hpkt
parameter_list|(
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
parameter_list|,
name|u_int32_t
name|hpkt
parameter_list|)
block|{
name|struct
name|ata_promise_sx4
modifier|*
name|hpktp
init|=
name|ctlr
operator|->
name|chipset_data
decl_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|hpktp
operator|->
name|mtx
argument_list|)
expr_stmt|;
if|if
condition|(
name|hpktp
operator|->
name|busy
condition|)
block|{
name|struct
name|host_packet
modifier|*
name|hp
init|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|host_packet
argument_list|)
argument_list|,
name|M_TEMP
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
decl_stmt|;
name|hp
operator|->
name|addr
operator|=
name|hpkt
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|hpktp
operator|->
name|queue
argument_list|,
name|hp
argument_list|,
name|chain
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|hpktp
operator|->
name|busy
operator|=
literal|1
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x000c0100
argument_list|,
name|hpkt
argument_list|)
expr_stmt|;
block|}
name|mtx_unlock
argument_list|(
operator|&
name|hpktp
operator|->
name|mtx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_promise_next_hpkt
parameter_list|(
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
parameter_list|)
block|{
name|struct
name|ata_promise_sx4
modifier|*
name|hpktp
init|=
name|ctlr
operator|->
name|chipset_data
decl_stmt|;
name|struct
name|host_packet
modifier|*
name|hp
decl_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|hpktp
operator|->
name|mtx
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|hp
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|hpktp
operator|->
name|queue
argument_list|)
operator|)
condition|)
block|{
name|TAILQ_REMOVE
argument_list|(
operator|&
name|hpktp
operator|->
name|queue
argument_list|,
name|hp
argument_list|,
name|chain
argument_list|)
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x000c0100
argument_list|,
name|hp
operator|->
name|addr
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|hp
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
block|}
else|else
name|hpktp
operator|->
name|busy
operator|=
literal|0
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|hpktp
operator|->
name|mtx
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * ServerWorks chipset support functions  */
end_comment

begin_function
name|int
name|ata_serverworks_ident
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
specifier|static
name|struct
name|ata_chip_id
name|ids
index|[]
init|=
block|{
block|{
name|ATA_ROSB4
block|,
literal|0x00
block|,
name|SWKS33
block|,
literal|0
block|,
name|ATA_UDMA2
block|,
literal|"ROSB4"
block|}
block|,
block|{
name|ATA_CSB5
block|,
literal|0x92
block|,
name|SWKS100
block|,
literal|0
block|,
name|ATA_UDMA5
block|,
literal|"CSB5"
block|}
block|,
block|{
name|ATA_CSB5
block|,
literal|0x00
block|,
name|SWKS66
block|,
literal|0
block|,
name|ATA_UDMA4
block|,
literal|"CSB5"
block|}
block|,
block|{
name|ATA_CSB6
block|,
literal|0x00
block|,
name|SWKS100
block|,
literal|0
block|,
name|ATA_UDMA5
block|,
literal|"CSB6"
block|}
block|,
block|{
name|ATA_CSB6_1
block|,
literal|0x00
block|,
name|SWKS66
block|,
literal|0
block|,
name|ATA_UDMA4
block|,
literal|"CSB6"
block|}
block|,
block|{
name|ATA_HT1000
block|,
literal|0x00
block|,
name|SWKS100
block|,
literal|0
block|,
name|ATA_UDMA5
block|,
literal|"HT1000"
block|}
block|,
block|{
name|ATA_HT1000_S1
block|,
literal|0x00
block|,
name|SWKSMIO
block|,
literal|4
block|,
name|ATA_SA150
block|,
literal|"HT1000"
block|}
block|,
block|{
name|ATA_HT1000_S2
block|,
literal|0x00
block|,
name|SWKSMIO
block|,
literal|4
block|,
name|ATA_SA150
block|,
literal|"HT1000"
block|}
block|,
block|{
name|ATA_K2
block|,
literal|0x00
block|,
name|SWKSMIO
block|,
literal|4
block|,
name|ATA_SA150
block|,
literal|"K2"
block|}
block|,
block|{
name|ATA_FRODO4
block|,
literal|0x00
block|,
name|SWKSMIO
block|,
literal|4
block|,
name|ATA_SA150
block|,
literal|"Frodo4"
block|}
block|,
block|{
name|ATA_FRODO8
block|,
literal|0x00
block|,
name|SWKSMIO
block|,
literal|8
block|,
name|ATA_SA150
block|,
literal|"Frodo8"
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|ctlr
operator|->
name|chip
operator|=
name|ata_match_chip
argument_list|(
name|dev
argument_list|,
name|ids
argument_list|)
operator|)
condition|)
return|return
name|ENXIO
return|;
name|ata_set_desc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|chipinit
operator|=
name|ata_serverworks_chipinit
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_serverworks_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|ata_setup_interrupt
argument_list|(
name|dev
argument_list|)
condition|)
return|return
name|ENXIO
return|;
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg1
operator|==
name|SWKSMIO
condition|)
block|{
name|ctlr
operator|->
name|r_type2
operator|=
name|SYS_RES_MEMORY
expr_stmt|;
name|ctlr
operator|->
name|r_rid2
operator|=
name|PCIR_BAR
argument_list|(
literal|5
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ctlr
operator|->
name|r_res2
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|ctlr
operator|->
name|r_type2
argument_list|,
operator|&
name|ctlr
operator|->
name|r_rid2
argument_list|,
name|RF_ACTIVE
argument_list|)
operator|)
condition|)
return|return
name|ENXIO
return|;
name|ctlr
operator|->
name|channels
operator|=
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
expr_stmt|;
name|ctlr
operator|->
name|allocate
operator|=
name|ata_serverworks_allocate
expr_stmt|;
name|ctlr
operator|->
name|setmode
operator|=
name|ata_sata_setmode
expr_stmt|;
return|return
literal|0
return|;
block|}
elseif|else
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg1
operator|==
name|SWKS33
condition|)
block|{
name|device_t
modifier|*
name|children
decl_stmt|;
name|int
name|nchildren
decl_stmt|,
name|i
decl_stmt|;
comment|/* locate the ISA part in the southbridge and enable UDMA33 */
if|if
condition|(
operator|!
name|device_get_children
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|,
operator|&
name|children
argument_list|,
operator|&
name|nchildren
argument_list|)
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nchildren
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|pci_get_devid
argument_list|(
name|children
index|[
name|i
index|]
argument_list|)
operator|==
name|ATA_ROSB4_ISA
condition|)
block|{
name|pci_write_config
argument_list|(
name|children
index|[
name|i
index|]
argument_list|,
literal|0x64
argument_list|,
operator|(
name|pci_read_config
argument_list|(
name|children
index|[
name|i
index|]
argument_list|,
literal|0x64
argument_list|,
literal|4
argument_list|)
operator|&
operator|~
literal|0x00002000
operator|)
operator||
literal|0x00004000
argument_list|,
literal|4
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|free
argument_list|(
name|children
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x5a
argument_list|,
operator|(
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x5a
argument_list|,
literal|1
argument_list|)
operator|&
operator|~
literal|0x40
operator|)
operator||
operator|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg1
operator|==
name|SWKS100
operator|)
condition|?
literal|0x03
else|:
literal|0x02
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|ctlr
operator|->
name|setmode
operator|=
name|ata_serverworks_setmode
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_serverworks_allocate
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|ch_offset
decl_stmt|;
name|int
name|i
decl_stmt|;
name|ch_offset
operator|=
name|ch
operator|->
name|unit
operator|*
literal|0x100
expr_stmt|;
for|for
control|(
name|i
operator|=
name|ATA_DATA
init|;
name|i
operator|<
name|ATA_MAX_RES
condition|;
name|i
operator|++
control|)
name|ch
operator|->
name|r_io
index|[
name|i
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_res2
expr_stmt|;
comment|/* setup ATA registers */
name|ch
operator|->
name|r_io
index|[
name|ATA_DATA
index|]
operator|.
name|offset
operator|=
name|ch_offset
operator|+
literal|0x00
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_FEATURE
index|]
operator|.
name|offset
operator|=
name|ch_offset
operator|+
literal|0x04
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_COUNT
index|]
operator|.
name|offset
operator|=
name|ch_offset
operator|+
literal|0x08
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SECTOR
index|]
operator|.
name|offset
operator|=
name|ch_offset
operator|+
literal|0x0c
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_CYL_LSB
index|]
operator|.
name|offset
operator|=
name|ch_offset
operator|+
literal|0x10
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_CYL_MSB
index|]
operator|.
name|offset
operator|=
name|ch_offset
operator|+
literal|0x14
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_DRIVE
index|]
operator|.
name|offset
operator|=
name|ch_offset
operator|+
literal|0x18
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_COMMAND
index|]
operator|.
name|offset
operator|=
name|ch_offset
operator|+
literal|0x1c
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_CONTROL
index|]
operator|.
name|offset
operator|=
name|ch_offset
operator|+
literal|0x20
expr_stmt|;
name|ata_default_registers
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* setup DMA registers */
name|ch
operator|->
name|r_io
index|[
name|ATA_BMCMD_PORT
index|]
operator|.
name|offset
operator|=
name|ch_offset
operator|+
literal|0x30
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_BMSTAT_PORT
index|]
operator|.
name|offset
operator|=
name|ch_offset
operator|+
literal|0x32
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_BMDTP_PORT
index|]
operator|.
name|offset
operator|=
name|ch_offset
operator|+
literal|0x34
expr_stmt|;
comment|/* setup SATA registers */
name|ch
operator|->
name|r_io
index|[
name|ATA_SSTATUS
index|]
operator|.
name|offset
operator|=
name|ch_offset
operator|+
literal|0x40
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SERROR
index|]
operator|.
name|offset
operator|=
name|ch_offset
operator|+
literal|0x44
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SCONTROL
index|]
operator|.
name|offset
operator|=
name|ch_offset
operator|+
literal|0x48
expr_stmt|;
name|ch
operator|->
name|flags
operator||=
name|ATA_NO_SLAVE
expr_stmt|;
name|ata_pci_hw
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|ch
operator|->
name|hw
operator|.
name|tf_read
operator|=
name|ata_serverworks_tf_read
expr_stmt|;
name|ch
operator|->
name|hw
operator|.
name|tf_write
operator|=
name|ata_serverworks_tf_write
expr_stmt|;
comment|/* chip does not reliably do 64K DMA transfers */
if|if
condition|(
name|ch
operator|->
name|dma
condition|)
name|ch
operator|->
name|dma
operator|->
name|max_iosize
operator|=
literal|64
operator|*
name|DEV_BSIZE
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_serverworks_tf_read
parameter_list|(
name|struct
name|ata_request
modifier|*
name|request
parameter_list|)
block|{
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|request
operator|->
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_device
modifier|*
name|atadev
init|=
name|device_get_softc
argument_list|(
name|request
operator|->
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|atadev
operator|->
name|flags
operator|&
name|ATA_D_48BIT_ACTIVE
condition|)
block|{
name|u_int16_t
name|temp
decl_stmt|;
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|count
operator|=
name|ATA_IDX_INW
argument_list|(
name|ch
argument_list|,
name|ATA_COUNT
argument_list|)
expr_stmt|;
name|temp
operator|=
name|ATA_IDX_INW
argument_list|(
name|ch
argument_list|,
name|ATA_SECTOR
argument_list|)
expr_stmt|;
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|=
call|(
name|u_int64_t
call|)
argument_list|(
name|temp
operator|&
literal|0x00ff
argument_list|)
operator||
operator|(
call|(
name|u_int64_t
call|)
argument_list|(
name|temp
operator|&
literal|0xff00
argument_list|)
operator|<<
literal|24
operator|)
expr_stmt|;
name|temp
operator|=
name|ATA_IDX_INW
argument_list|(
name|ch
argument_list|,
name|ATA_CYL_LSB
argument_list|)
expr_stmt|;
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator||=
operator|(
call|(
name|u_int64_t
call|)
argument_list|(
name|temp
operator|&
literal|0x00ff
argument_list|)
operator|<<
literal|8
operator|)
operator||
operator|(
call|(
name|u_int64_t
call|)
argument_list|(
name|temp
operator|&
literal|0xff00
argument_list|)
operator|<<
literal|32
operator|)
expr_stmt|;
name|temp
operator|=
name|ATA_IDX_INW
argument_list|(
name|ch
argument_list|,
name|ATA_CYL_MSB
argument_list|)
expr_stmt|;
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator||=
operator|(
call|(
name|u_int64_t
call|)
argument_list|(
name|temp
operator|&
literal|0x00ff
argument_list|)
operator|<<
literal|16
operator|)
operator||
operator|(
call|(
name|u_int64_t
call|)
argument_list|(
name|temp
operator|&
literal|0xff00
argument_list|)
operator|<<
literal|40
operator|)
expr_stmt|;
block|}
else|else
block|{
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|count
operator|=
name|ATA_IDX_INW
argument_list|(
name|ch
argument_list|,
name|ATA_COUNT
argument_list|)
operator|&
literal|0x00ff
expr_stmt|;
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|=
operator|(
name|ATA_IDX_INW
argument_list|(
name|ch
argument_list|,
name|ATA_SECTOR
argument_list|)
operator|&
literal|0x00ff
operator|)
operator||
operator|(
operator|(
name|ATA_IDX_INW
argument_list|(
name|ch
argument_list|,
name|ATA_CYL_LSB
argument_list|)
operator|&
literal|0x00ff
operator|)
operator|<<
literal|8
operator|)
operator||
operator|(
operator|(
name|ATA_IDX_INW
argument_list|(
name|ch
argument_list|,
name|ATA_CYL_MSB
argument_list|)
operator|&
literal|0x00ff
operator|)
operator|<<
literal|16
operator|)
operator||
operator|(
operator|(
name|ATA_IDX_INW
argument_list|(
name|ch
argument_list|,
name|ATA_DRIVE
argument_list|)
operator|&
literal|0xf
operator|)
operator|<<
literal|24
operator|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ata_serverworks_tf_write
parameter_list|(
name|struct
name|ata_request
modifier|*
name|request
parameter_list|)
block|{
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|request
operator|->
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_device
modifier|*
name|atadev
init|=
name|device_get_softc
argument_list|(
name|request
operator|->
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|atadev
operator|->
name|flags
operator|&
name|ATA_D_48BIT_ACTIVE
condition|)
block|{
name|ATA_IDX_OUTW
argument_list|(
name|ch
argument_list|,
name|ATA_FEATURE
argument_list|,
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|feature
argument_list|)
expr_stmt|;
name|ATA_IDX_OUTW
argument_list|(
name|ch
argument_list|,
name|ATA_COUNT
argument_list|,
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|count
argument_list|)
expr_stmt|;
name|ATA_IDX_OUTW
argument_list|(
name|ch
argument_list|,
name|ATA_SECTOR
argument_list|,
operator|(
operator|(
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|>>
literal|16
operator|)
operator|&
literal|0xff00
operator|)
operator||
operator|(
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|&
literal|0x00ff
operator|)
argument_list|)
expr_stmt|;
name|ATA_IDX_OUTW
argument_list|(
name|ch
argument_list|,
name|ATA_CYL_LSB
argument_list|,
operator|(
operator|(
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|>>
literal|24
operator|)
operator|&
literal|0xff00
operator|)
operator||
operator|(
operator|(
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|>>
literal|8
operator|)
operator|&
literal|0x00ff
operator|)
argument_list|)
expr_stmt|;
name|ATA_IDX_OUTW
argument_list|(
name|ch
argument_list|,
name|ATA_CYL_MSB
argument_list|,
operator|(
operator|(
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|>>
literal|32
operator|)
operator|&
literal|0xff00
operator|)
operator||
operator|(
operator|(
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|>>
literal|16
operator|)
operator|&
literal|0x00ff
operator|)
argument_list|)
expr_stmt|;
name|ATA_IDX_OUTW
argument_list|(
name|ch
argument_list|,
name|ATA_DRIVE
argument_list|,
name|ATA_D_LBA
operator||
name|atadev
operator|->
name|unit
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ATA_IDX_OUTW
argument_list|(
name|ch
argument_list|,
name|ATA_FEATURE
argument_list|,
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|feature
argument_list|)
expr_stmt|;
name|ATA_IDX_OUTW
argument_list|(
name|ch
argument_list|,
name|ATA_COUNT
argument_list|,
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|count
argument_list|)
expr_stmt|;
if|if
condition|(
name|atadev
operator|->
name|flags
operator|&
name|ATA_D_USE_CHS
condition|)
block|{
name|int
name|heads
decl_stmt|,
name|sectors
decl_stmt|;
if|if
condition|(
name|atadev
operator|->
name|param
operator|.
name|atavalid
operator|&
name|ATA_FLAG_54_58
condition|)
block|{
name|heads
operator|=
name|atadev
operator|->
name|param
operator|.
name|current_heads
expr_stmt|;
name|sectors
operator|=
name|atadev
operator|->
name|param
operator|.
name|current_sectors
expr_stmt|;
block|}
else|else
block|{
name|heads
operator|=
name|atadev
operator|->
name|param
operator|.
name|heads
expr_stmt|;
name|sectors
operator|=
name|atadev
operator|->
name|param
operator|.
name|sectors
expr_stmt|;
block|}
name|ATA_IDX_OUTW
argument_list|(
name|ch
argument_list|,
name|ATA_SECTOR
argument_list|,
operator|(
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|%
name|sectors
operator|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|ATA_IDX_OUTW
argument_list|(
name|ch
argument_list|,
name|ATA_CYL_LSB
argument_list|,
operator|(
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|/
operator|(
name|sectors
operator|*
name|heads
operator|)
operator|)
argument_list|)
expr_stmt|;
name|ATA_IDX_OUTW
argument_list|(
name|ch
argument_list|,
name|ATA_CYL_MSB
argument_list|,
operator|(
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|/
operator|(
name|sectors
operator|*
name|heads
operator|)
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|ATA_IDX_OUTW
argument_list|(
name|ch
argument_list|,
name|ATA_DRIVE
argument_list|,
name|ATA_D_IBM
operator||
name|atadev
operator|->
name|unit
operator||
operator|(
operator|(
operator|(
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|%
operator|(
name|sectors
operator|*
name|heads
operator|)
operator|)
operator|/
name|sectors
operator|)
operator|&
literal|0xf
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ATA_IDX_OUTW
argument_list|(
name|ch
argument_list|,
name|ATA_SECTOR
argument_list|,
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
argument_list|)
expr_stmt|;
name|ATA_IDX_OUTW
argument_list|(
name|ch
argument_list|,
name|ATA_CYL_LSB
argument_list|,
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|ATA_IDX_OUTW
argument_list|(
name|ch
argument_list|,
name|ATA_CYL_MSB
argument_list|,
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|>>
literal|16
argument_list|)
expr_stmt|;
name|ATA_IDX_OUTW
argument_list|(
name|ch
argument_list|,
name|ATA_DRIVE
argument_list|,
name|ATA_D_IBM
operator||
name|ATA_D_LBA
operator||
name|atadev
operator|->
name|unit
operator||
operator|(
operator|(
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|>>
literal|24
operator|)
operator|&
literal|0x0f
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ata_serverworks_setmode
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|device_t
name|gparent
init|=
name|GRANDPARENT
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|gparent
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_device
modifier|*
name|atadev
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|devno
init|=
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|1
operator|)
operator|+
name|ATA_DEV
argument_list|(
name|atadev
operator|->
name|unit
argument_list|)
decl_stmt|;
name|int
name|offset
init|=
operator|(
name|devno
operator|^
literal|0x01
operator|)
operator|<<
literal|3
decl_stmt|;
name|int
name|error
decl_stmt|;
name|u_int8_t
name|piotimings
index|[]
init|=
block|{
literal|0x5d
block|,
literal|0x47
block|,
literal|0x34
block|,
literal|0x22
block|,
literal|0x20
block|,
literal|0x34
block|,
literal|0x22
block|,
literal|0x20
block|,
literal|0x20
block|,
literal|0x20
block|,
literal|0x20
block|,
literal|0x20
block|,
literal|0x20
block|,
literal|0x20
block|}
decl_stmt|;
name|u_int8_t
name|dmatimings
index|[]
init|=
block|{
literal|0x77
block|,
literal|0x21
block|,
literal|0x20
block|}
decl_stmt|;
name|mode
operator|=
name|ata_limit_mode
argument_list|(
name|dev
argument_list|,
name|mode
argument_list|,
name|ctlr
operator|->
name|chip
operator|->
name|max_dma
argument_list|)
expr_stmt|;
name|mode
operator|=
name|ata_check_80pin
argument_list|(
name|dev
argument_list|,
name|mode
argument_list|)
expr_stmt|;
name|error
operator|=
name|ata_controlcmd
argument_list|(
name|dev
argument_list|,
name|ATA_SETFEATURES
argument_list|,
name|ATA_SF_SETXFER
argument_list|,
literal|0
argument_list|,
name|mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%ssetting %s on %s chip\n"
argument_list|,
operator|(
name|error
operator|)
condition|?
literal|"FAILURE "
else|:
literal|""
argument_list|,
name|ata_mode2str
argument_list|(
name|mode
argument_list|)
argument_list|,
name|ctlr
operator|->
name|chip
operator|->
name|text
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
block|{
if|if
condition|(
name|mode
operator|>=
name|ATA_UDMA0
condition|)
block|{
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
literal|0x56
argument_list|,
operator|(
name|pci_read_config
argument_list|(
name|gparent
argument_list|,
literal|0x56
argument_list|,
literal|2
argument_list|)
operator|&
operator|~
operator|(
literal|0xf
operator|<<
operator|(
name|devno
operator|<<
literal|2
operator|)
operator|)
operator|)
operator||
operator|(
operator|(
name|mode
operator|&
name|ATA_MODE_MASK
operator|)
operator|<<
operator|(
name|devno
operator|<<
literal|2
operator|)
operator|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
literal|0x54
argument_list|,
name|pci_read_config
argument_list|(
name|gparent
argument_list|,
literal|0x54
argument_list|,
literal|1
argument_list|)
operator||
operator|(
literal|0x01
operator|<<
name|devno
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
literal|0x44
argument_list|,
operator|(
name|pci_read_config
argument_list|(
name|gparent
argument_list|,
literal|0x44
argument_list|,
literal|4
argument_list|)
operator|&
operator|~
operator|(
literal|0xff
operator|<<
name|offset
operator|)
operator|)
operator||
operator|(
name|dmatimings
index|[
literal|2
index|]
operator|<<
name|offset
operator|)
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|mode
operator|>=
name|ATA_WDMA0
condition|)
block|{
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
literal|0x54
argument_list|,
name|pci_read_config
argument_list|(
name|gparent
argument_list|,
literal|0x54
argument_list|,
literal|1
argument_list|)
operator|&
operator|~
operator|(
literal|0x01
operator|<<
name|devno
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
literal|0x44
argument_list|,
operator|(
name|pci_read_config
argument_list|(
name|gparent
argument_list|,
literal|0x44
argument_list|,
literal|4
argument_list|)
operator|&
operator|~
operator|(
literal|0xff
operator|<<
name|offset
operator|)
operator|)
operator||
operator|(
name|dmatimings
index|[
name|mode
operator|&
name|ATA_MODE_MASK
index|]
operator|<<
name|offset
operator|)
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
else|else
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
literal|0x54
argument_list|,
name|pci_read_config
argument_list|(
name|gparent
argument_list|,
literal|0x54
argument_list|,
literal|1
argument_list|)
operator|&
operator|~
operator|(
literal|0x01
operator|<<
name|devno
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
literal|0x40
argument_list|,
operator|(
name|pci_read_config
argument_list|(
name|gparent
argument_list|,
literal|0x40
argument_list|,
literal|4
argument_list|)
operator|&
operator|~
operator|(
literal|0xff
operator|<<
name|offset
operator|)
operator|)
operator||
operator|(
name|piotimings
index|[
name|ata_mode2idx
argument_list|(
name|mode
argument_list|)
index|]
operator|<<
name|offset
operator|)
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|atadev
operator|->
name|mode
operator|=
name|mode
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Silicon Image Inc. (SiI) (former CMD) chipset support functions  */
end_comment

begin_function
name|int
name|ata_sii_ident
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
specifier|static
name|struct
name|ata_chip_id
name|ids
index|[]
init|=
block|{
block|{
name|ATA_SII3114
block|,
literal|0x00
block|,
name|SIIMEMIO
block|,
name|SII4CH
block|,
name|ATA_SA150
block|,
literal|"SiI 3114"
block|}
block|,
block|{
name|ATA_SII3512
block|,
literal|0x02
block|,
name|SIIMEMIO
block|,
literal|0
block|,
name|ATA_SA150
block|,
literal|"SiI 3512"
block|}
block|,
block|{
name|ATA_SII3112
block|,
literal|0x02
block|,
name|SIIMEMIO
block|,
literal|0
block|,
name|ATA_SA150
block|,
literal|"SiI 3112"
block|}
block|,
block|{
name|ATA_SII3112_1
block|,
literal|0x02
block|,
name|SIIMEMIO
block|,
literal|0
block|,
name|ATA_SA150
block|,
literal|"SiI 3112"
block|}
block|,
block|{
name|ATA_SII3512
block|,
literal|0x00
block|,
name|SIIMEMIO
block|,
name|SIIBUG
block|,
name|ATA_SA150
block|,
literal|"SiI 3512"
block|}
block|,
block|{
name|ATA_SII3112
block|,
literal|0x00
block|,
name|SIIMEMIO
block|,
name|SIIBUG
block|,
name|ATA_SA150
block|,
literal|"SiI 3112"
block|}
block|,
block|{
name|ATA_SII3112_1
block|,
literal|0x00
block|,
name|SIIMEMIO
block|,
name|SIIBUG
block|,
name|ATA_SA150
block|,
literal|"SiI 3112"
block|}
block|,
block|{
name|ATA_SII3124
block|,
literal|0x00
block|,
name|SIIPRBIO
block|,
name|SII4CH
block|,
name|ATA_SA300
block|,
literal|"SiI 3124"
block|}
block|,
block|{
name|ATA_SII3132
block|,
literal|0x00
block|,
name|SIIPRBIO
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"SiI 3132"
block|}
block|,
block|{
name|ATA_SII3132_1
block|,
literal|0x00
block|,
name|SIIPRBIO
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"SiI 3132"
block|}
block|,
block|{
name|ATA_SII3132_2
block|,
literal|0x00
block|,
name|SIIPRBIO
block|,
literal|0
block|,
name|ATA_SA300
block|,
literal|"SiI 3132"
block|}
block|,
block|{
name|ATA_SII0680
block|,
literal|0x00
block|,
name|SIIMEMIO
block|,
name|SIISETCLK
block|,
name|ATA_UDMA6
block|,
literal|"SiI 0680"
block|}
block|,
block|{
name|ATA_CMD649
block|,
literal|0x00
block|,
literal|0
block|,
name|SIIINTR
block|,
name|ATA_UDMA5
block|,
literal|"CMD 649"
block|}
block|,
block|{
name|ATA_CMD648
block|,
literal|0x00
block|,
literal|0
block|,
name|SIIINTR
block|,
name|ATA_UDMA4
block|,
literal|"CMD 648"
block|}
block|,
block|{
name|ATA_CMD646
block|,
literal|0x07
block|,
literal|0
block|,
literal|0
block|,
name|ATA_UDMA2
block|,
literal|"CMD 646U2"
block|}
block|,
block|{
name|ATA_CMD646
block|,
literal|0x00
block|,
literal|0
block|,
literal|0
block|,
name|ATA_WDMA2
block|,
literal|"CMD 646"
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|ctlr
operator|->
name|chip
operator|=
name|ata_match_chip
argument_list|(
name|dev
argument_list|,
name|ids
argument_list|)
operator|)
condition|)
return|return
name|ENXIO
return|;
name|ata_set_desc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|chipinit
operator|=
name|ata_sii_chipinit
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_sii_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|ata_setup_interrupt
argument_list|(
name|dev
argument_list|)
condition|)
return|return
name|ENXIO
return|;
switch|switch
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg1
condition|)
block|{
case|case
name|SIIPRBIO
case|:
name|ctlr
operator|->
name|r_type1
operator|=
name|SYS_RES_MEMORY
expr_stmt|;
name|ctlr
operator|->
name|r_rid1
operator|=
name|PCIR_BAR
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ctlr
operator|->
name|r_res1
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|ctlr
operator|->
name|r_type1
argument_list|,
operator|&
name|ctlr
operator|->
name|r_rid1
argument_list|,
name|RF_ACTIVE
argument_list|)
operator|)
condition|)
return|return
name|ENXIO
return|;
name|ctlr
operator|->
name|r_rid2
operator|=
name|PCIR_BAR
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|r_type2
operator|=
name|SYS_RES_MEMORY
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ctlr
operator|->
name|r_res2
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|ctlr
operator|->
name|r_type2
argument_list|,
operator|&
name|ctlr
operator|->
name|r_rid2
argument_list|,
name|RF_ACTIVE
argument_list|)
operator|)
condition|)
block|{
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|ctlr
operator|->
name|r_type1
argument_list|,
name|ctlr
operator|->
name|r_rid1
argument_list|,
name|ctlr
operator|->
name|r_res1
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
name|ctlr
operator|->
name|allocate
operator|=
name|ata_siiprb_allocate
expr_stmt|;
name|ctlr
operator|->
name|reset
operator|=
name|ata_siiprb_reset
expr_stmt|;
name|ctlr
operator|->
name|dmainit
operator|=
name|ata_siiprb_dmainit
expr_stmt|;
name|ctlr
operator|->
name|setmode
operator|=
name|ata_sata_setmode
expr_stmt|;
name|ctlr
operator|->
name|channels
operator|=
operator|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|==
name|SII4CH
operator|)
condition|?
literal|4
else|:
literal|2
expr_stmt|;
comment|/* reset controller */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
literal|0x0040
argument_list|,
literal|0x80000000
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|10000
argument_list|)
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
literal|0x0040
argument_list|,
literal|0x0000000f
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIIMEMIO
case|:
name|ctlr
operator|->
name|r_type2
operator|=
name|SYS_RES_MEMORY
expr_stmt|;
name|ctlr
operator|->
name|r_rid2
operator|=
name|PCIR_BAR
argument_list|(
literal|5
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ctlr
operator|->
name|r_res2
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|ctlr
operator|->
name|r_type2
argument_list|,
operator|&
name|ctlr
operator|->
name|r_rid2
argument_list|,
name|RF_ACTIVE
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|chipid
operator|!=
name|ATA_SII0680
operator|||
operator|(
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x8a
argument_list|,
literal|1
argument_list|)
operator|&
literal|1
operator|)
condition|)
return|return
name|ENXIO
return|;
block|}
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|&
name|SIISETCLK
condition|)
block|{
if|if
condition|(
operator|(
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x8a
argument_list|,
literal|1
argument_list|)
operator|&
literal|0x30
operator|)
operator|!=
literal|0x10
condition|)
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x8a
argument_list|,
operator|(
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x8a
argument_list|,
literal|1
argument_list|)
operator|&
literal|0xcf
operator|)
operator||
literal|0x10
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x8a
argument_list|,
literal|1
argument_list|)
operator|&
literal|0x30
operator|)
operator|!=
literal|0x10
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s could not set ATA133 clock\n"
argument_list|,
name|ctlr
operator|->
name|chip
operator|->
name|text
argument_list|)
expr_stmt|;
block|}
comment|/* if we have 4 channels enable the second set */
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|&
name|SII4CH
condition|)
block|{
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x0200
argument_list|,
literal|0x00000002
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|channels
operator|=
literal|4
expr_stmt|;
block|}
comment|/* dont block interrupts from any channel */
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x48
argument_list|,
operator|(
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x48
argument_list|,
literal|4
argument_list|)
operator|&
operator|~
literal|0x03c00000
operator|)
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/* enable PCI interrupt as BIOS might not */
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x8a
argument_list|,
operator|(
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x8a
argument_list|,
literal|1
argument_list|)
operator|&
literal|0x3f
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctlr
operator|->
name|r_res2
condition|)
name|ctlr
operator|->
name|allocate
operator|=
name|ata_sii_allocate
expr_stmt|;
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|max_dma
operator|>=
name|ATA_SA150
condition|)
block|{
name|ctlr
operator|->
name|reset
operator|=
name|ata_sii_reset
expr_stmt|;
name|ctlr
operator|->
name|setmode
operator|=
name|ata_sata_setmode
expr_stmt|;
block|}
else|else
name|ctlr
operator|->
name|setmode
operator|=
name|ata_sii_setmode
expr_stmt|;
break|break;
default|default:
if|if
condition|(
operator|(
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x51
argument_list|,
literal|1
argument_list|)
operator|&
literal|0x08
operator|)
operator|!=
literal|0x08
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"HW has secondary channel disabled\n"
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|channels
operator|=
literal|1
expr_stmt|;
block|}
comment|/* enable interrupt as BIOS might not */
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x71
argument_list|,
literal|0x01
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|allocate
operator|=
name|ata_cmd_allocate
expr_stmt|;
name|ctlr
operator|->
name|setmode
operator|=
name|ata_cmd_setmode
expr_stmt|;
break|break;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_cmd_allocate
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
comment|/* setup the usual register normal pci style */
if|if
condition|(
name|ata_pci_allocate
argument_list|(
name|dev
argument_list|)
condition|)
return|return
name|ENXIO
return|;
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|&
name|SIIINTR
condition|)
name|ch
operator|->
name|hw
operator|.
name|status
operator|=
name|ata_cmd_status
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_cmd_status
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|u_int8_t
name|reg71
decl_stmt|;
if|if
condition|(
operator|(
operator|(
name|reg71
operator|=
name|pci_read_config
argument_list|(
name|device_get_parent
argument_list|(
name|ch
operator|->
name|dev
argument_list|)
argument_list|,
literal|0x71
argument_list|,
literal|1
argument_list|)
operator|)
operator|&
operator|(
name|ch
operator|->
name|unit
condition|?
literal|0x08
else|:
literal|0x04
operator|)
operator|)
condition|)
block|{
name|pci_write_config
argument_list|(
name|device_get_parent
argument_list|(
name|ch
operator|->
name|dev
argument_list|)
argument_list|,
literal|0x71
argument_list|,
name|reg71
operator|&
operator|~
operator|(
name|ch
operator|->
name|unit
condition|?
literal|0x04
else|:
literal|0x08
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|ata_pci_status
argument_list|(
name|dev
argument_list|)
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_cmd_setmode
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|device_t
name|gparent
init|=
name|GRANDPARENT
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|gparent
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_device
modifier|*
name|atadev
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|devno
init|=
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|1
operator|)
operator|+
name|ATA_DEV
argument_list|(
name|atadev
operator|->
name|unit
argument_list|)
decl_stmt|;
name|int
name|error
decl_stmt|;
name|mode
operator|=
name|ata_limit_mode
argument_list|(
name|dev
argument_list|,
name|mode
argument_list|,
name|ctlr
operator|->
name|chip
operator|->
name|max_dma
argument_list|)
expr_stmt|;
name|mode
operator|=
name|ata_check_80pin
argument_list|(
name|dev
argument_list|,
name|mode
argument_list|)
expr_stmt|;
name|error
operator|=
name|ata_controlcmd
argument_list|(
name|dev
argument_list|,
name|ATA_SETFEATURES
argument_list|,
name|ATA_SF_SETXFER
argument_list|,
literal|0
argument_list|,
name|mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%ssetting %s on %s chip\n"
argument_list|,
operator|(
name|error
operator|)
condition|?
literal|"FAILURE "
else|:
literal|""
argument_list|,
name|ata_mode2str
argument_list|(
name|mode
argument_list|)
argument_list|,
name|ctlr
operator|->
name|chip
operator|->
name|text
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
block|{
name|int
name|treg
init|=
literal|0x54
operator|+
operator|(
operator|(
name|devno
operator|<
literal|3
operator|)
condition|?
operator|(
name|devno
operator|<<
literal|1
operator|)
else|:
literal|7
operator|)
decl_stmt|;
name|int
name|ureg
init|=
name|ch
operator|->
name|unit
condition|?
literal|0x7b
else|:
literal|0x73
decl_stmt|;
if|if
condition|(
name|mode
operator|>=
name|ATA_UDMA0
condition|)
block|{
name|int
name|udmatimings
index|[]
index|[
literal|2
index|]
init|=
block|{
block|{
literal|0x31
block|,
literal|0xc2
block|}
block|,
block|{
literal|0x21
block|,
literal|0x82
block|}
block|,
block|{
literal|0x11
block|,
literal|0x42
block|}
block|,
block|{
literal|0x25
block|,
literal|0x8a
block|}
block|,
block|{
literal|0x15
block|,
literal|0x4a
block|}
block|,
block|{
literal|0x05
block|,
literal|0x0a
block|}
block|}
decl_stmt|;
name|u_int8_t
name|umode
init|=
name|pci_read_config
argument_list|(
name|gparent
argument_list|,
name|ureg
argument_list|,
literal|1
argument_list|)
decl_stmt|;
name|umode
operator|&=
operator|~
operator|(
name|atadev
operator|->
name|unit
operator|==
name|ATA_MASTER
condition|?
literal|0x35
else|:
literal|0xca
operator|)
expr_stmt|;
name|umode
operator||=
name|udmatimings
index|[
name|mode
operator|&
name|ATA_MODE_MASK
index|]
index|[
name|ATA_DEV
argument_list|(
name|atadev
operator|->
name|unit
argument_list|)
index|]
expr_stmt|;
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
name|ureg
argument_list|,
name|umode
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|mode
operator|>=
name|ATA_WDMA0
condition|)
block|{
name|int
name|dmatimings
index|[]
init|=
block|{
literal|0x87
block|,
literal|0x32
block|,
literal|0x3f
block|}
decl_stmt|;
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
name|treg
argument_list|,
name|dmatimings
index|[
name|mode
operator|&
name|ATA_MODE_MASK
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
name|ureg
argument_list|,
name|pci_read_config
argument_list|(
name|gparent
argument_list|,
name|ureg
argument_list|,
literal|1
argument_list|)
operator|&
operator|~
operator|(
name|atadev
operator|->
name|unit
operator|==
name|ATA_MASTER
condition|?
literal|0x35
else|:
literal|0xca
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|int
name|piotimings
index|[]
init|=
block|{
literal|0xa9
block|,
literal|0x57
block|,
literal|0x44
block|,
literal|0x32
block|,
literal|0x3f
block|}
decl_stmt|;
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
name|treg
argument_list|,
name|piotimings
index|[
operator|(
name|mode
operator|&
name|ATA_MODE_MASK
operator|)
operator|-
name|ATA_PIO0
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
name|ureg
argument_list|,
name|pci_read_config
argument_list|(
name|gparent
argument_list|,
name|ureg
argument_list|,
literal|1
argument_list|)
operator|&
operator|~
operator|(
name|atadev
operator|->
name|unit
operator|==
name|ATA_MASTER
condition|?
literal|0x35
else|:
literal|0xca
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|atadev
operator|->
name|mode
operator|=
name|mode
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|ata_sii_allocate
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|unit01
init|=
operator|(
name|ch
operator|->
name|unit
operator|&
literal|1
operator|)
decl_stmt|,
name|unit10
init|=
operator|(
name|ch
operator|->
name|unit
operator|&
literal|2
operator|)
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
name|ATA_DATA
init|;
name|i
operator|<=
name|ATA_COMMAND
condition|;
name|i
operator|++
control|)
block|{
name|ch
operator|->
name|r_io
index|[
name|i
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_res2
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|i
index|]
operator|.
name|offset
operator|=
literal|0x80
operator|+
name|i
operator|+
operator|(
name|unit01
operator|<<
literal|6
operator|)
operator|+
operator|(
name|unit10
operator|<<
literal|8
operator|)
expr_stmt|;
block|}
name|ch
operator|->
name|r_io
index|[
name|ATA_CONTROL
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_res2
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_CONTROL
index|]
operator|.
name|offset
operator|=
literal|0x8a
operator|+
operator|(
name|unit01
operator|<<
literal|6
operator|)
operator|+
operator|(
name|unit10
operator|<<
literal|8
operator|)
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_IDX_ADDR
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_res2
expr_stmt|;
name|ata_default_registers
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_BMCMD_PORT
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_res2
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_BMCMD_PORT
index|]
operator|.
name|offset
operator|=
literal|0x00
operator|+
operator|(
name|unit01
operator|<<
literal|3
operator|)
operator|+
operator|(
name|unit10
operator|<<
literal|8
operator|)
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_BMSTAT_PORT
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_res2
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_BMSTAT_PORT
index|]
operator|.
name|offset
operator|=
literal|0x02
operator|+
operator|(
name|unit01
operator|<<
literal|3
operator|)
operator|+
operator|(
name|unit10
operator|<<
literal|8
operator|)
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_BMDTP_PORT
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_res2
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_BMDTP_PORT
index|]
operator|.
name|offset
operator|=
literal|0x04
operator|+
operator|(
name|unit01
operator|<<
literal|3
operator|)
operator|+
operator|(
name|unit10
operator|<<
literal|8
operator|)
expr_stmt|;
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|max_dma
operator|>=
name|ATA_SA150
condition|)
block|{
name|ch
operator|->
name|r_io
index|[
name|ATA_SSTATUS
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_res2
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SSTATUS
index|]
operator|.
name|offset
operator|=
literal|0x104
operator|+
operator|(
name|unit01
operator|<<
literal|7
operator|)
operator|+
operator|(
name|unit10
operator|<<
literal|8
operator|)
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SERROR
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_res2
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SERROR
index|]
operator|.
name|offset
operator|=
literal|0x108
operator|+
operator|(
name|unit01
operator|<<
literal|7
operator|)
operator|+
operator|(
name|unit10
operator|<<
literal|8
operator|)
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SCONTROL
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_res2
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SCONTROL
index|]
operator|.
name|offset
operator|=
literal|0x100
operator|+
operator|(
name|unit01
operator|<<
literal|7
operator|)
operator|+
operator|(
name|unit10
operator|<<
literal|8
operator|)
expr_stmt|;
name|ch
operator|->
name|flags
operator||=
name|ATA_NO_SLAVE
expr_stmt|;
comment|/* enable PHY state change interrupt */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x148
operator|+
operator|(
name|unit01
operator|<<
literal|7
operator|)
operator|+
operator|(
name|unit10
operator|<<
literal|8
operator|)
argument_list|,
operator|(
literal|1
operator|<<
literal|16
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|&
name|SIIBUG
operator|)
operator|&&
name|ch
operator|->
name|dma
condition|)
block|{
comment|/* work around errata in early chips */
name|ch
operator|->
name|dma
operator|->
name|boundary
operator|=
literal|8192
expr_stmt|;
name|ch
operator|->
name|dma
operator|->
name|segsize
operator|=
literal|15
operator|*
name|DEV_BSIZE
expr_stmt|;
block|}
name|ata_pci_hw
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|ch
operator|->
name|hw
operator|.
name|status
operator|=
name|ata_sii_status
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_sii_status
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|offset0
init|=
operator|(
operator|(
name|ch
operator|->
name|unit
operator|&
literal|1
operator|)
operator|<<
literal|3
operator|)
operator|+
operator|(
operator|(
name|ch
operator|->
name|unit
operator|&
literal|2
operator|)
operator|<<
literal|8
operator|)
decl_stmt|;
name|int
name|offset1
init|=
operator|(
operator|(
name|ch
operator|->
name|unit
operator|&
literal|1
operator|)
operator|<<
literal|6
operator|)
operator|+
operator|(
operator|(
name|ch
operator|->
name|unit
operator|&
literal|2
operator|)
operator|<<
literal|8
operator|)
decl_stmt|;
comment|/* do we have any PHY events ? */
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|max_dma
operator|>=
name|ATA_SA150
operator|&&
operator|(
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x10
operator|+
name|offset0
argument_list|)
operator|&
literal|0x00000010
operator|)
condition|)
name|ata_sata_phy_check_events
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0xa0
operator|+
name|offset1
argument_list|)
operator|&
literal|0x00000800
condition|)
return|return
name|ata_pci_status
argument_list|(
name|dev
argument_list|)
return|;
else|else
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_sii_reset
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
if|if
condition|(
name|ata_sata_phy_reset
argument_list|(
name|dev
argument_list|)
condition|)
name|ata_generic_reset
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_sii_setmode
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|device_t
name|gparent
init|=
name|GRANDPARENT
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|gparent
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_device
modifier|*
name|atadev
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|rego
init|=
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|4
operator|)
operator|+
operator|(
name|ATA_DEV
argument_list|(
name|atadev
operator|->
name|unit
argument_list|)
operator|<<
literal|1
operator|)
decl_stmt|;
name|int
name|mreg
init|=
name|ch
operator|->
name|unit
condition|?
literal|0x84
else|:
literal|0x80
decl_stmt|;
name|int
name|mask
init|=
literal|0x03
operator|<<
operator|(
name|ATA_DEV
argument_list|(
name|atadev
operator|->
name|unit
argument_list|)
operator|<<
literal|2
operator|)
decl_stmt|;
name|int
name|mval
init|=
name|pci_read_config
argument_list|(
name|gparent
argument_list|,
name|mreg
argument_list|,
literal|1
argument_list|)
operator|&
operator|~
name|mask
decl_stmt|;
name|int
name|error
decl_stmt|;
name|mode
operator|=
name|ata_limit_mode
argument_list|(
name|dev
argument_list|,
name|mode
argument_list|,
name|ctlr
operator|->
name|chip
operator|->
name|max_dma
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|&
name|SIISETCLK
condition|)
block|{
if|if
condition|(
name|mode
operator|>
name|ATA_UDMA2
operator|&&
operator|(
name|pci_read_config
argument_list|(
name|gparent
argument_list|,
literal|0x79
argument_list|,
literal|1
argument_list|)
operator|&
operator|(
name|ch
operator|->
name|unit
condition|?
literal|0x02
else|:
literal|0x01
operator|)
operator|)
condition|)
block|{
name|ata_print_cable
argument_list|(
name|dev
argument_list|,
literal|"controller"
argument_list|)
expr_stmt|;
name|mode
operator|=
name|ATA_UDMA2
expr_stmt|;
block|}
block|}
else|else
name|mode
operator|=
name|ata_check_80pin
argument_list|(
name|dev
argument_list|,
name|mode
argument_list|)
expr_stmt|;
name|error
operator|=
name|ata_controlcmd
argument_list|(
name|dev
argument_list|,
name|ATA_SETFEATURES
argument_list|,
name|ATA_SF_SETXFER
argument_list|,
literal|0
argument_list|,
name|mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%ssetting %s on %s chip\n"
argument_list|,
operator|(
name|error
operator|)
condition|?
literal|"FAILURE "
else|:
literal|""
argument_list|,
name|ata_mode2str
argument_list|(
name|mode
argument_list|)
argument_list|,
name|ctlr
operator|->
name|chip
operator|->
name|text
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return;
if|if
condition|(
name|mode
operator|>=
name|ATA_UDMA0
condition|)
block|{
name|u_int8_t
name|udmatimings
index|[]
init|=
block|{
literal|0xf
block|,
literal|0xb
block|,
literal|0x7
block|,
literal|0x5
block|,
literal|0x3
block|,
literal|0x2
block|,
literal|0x1
block|}
decl_stmt|;
name|u_int8_t
name|ureg
init|=
literal|0xac
operator|+
name|rego
decl_stmt|;
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
name|mreg
argument_list|,
name|mval
operator||
operator|(
literal|0x03
operator|<<
operator|(
name|ATA_DEV
argument_list|(
name|atadev
operator|->
name|unit
argument_list|)
operator|<<
literal|2
operator|)
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
name|ureg
argument_list|,
operator|(
name|pci_read_config
argument_list|(
name|gparent
argument_list|,
name|ureg
argument_list|,
literal|1
argument_list|)
operator|&
operator|~
literal|0x3f
operator|)
operator||
name|udmatimings
index|[
name|mode
operator|&
name|ATA_MODE_MASK
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|mode
operator|>=
name|ATA_WDMA0
condition|)
block|{
name|u_int8_t
name|dreg
init|=
literal|0xa8
operator|+
name|rego
decl_stmt|;
name|u_int16_t
name|dmatimings
index|[]
init|=
block|{
literal|0x2208
block|,
literal|0x10c2
block|,
literal|0x10c1
block|}
decl_stmt|;
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
name|mreg
argument_list|,
name|mval
operator||
operator|(
literal|0x02
operator|<<
operator|(
name|ATA_DEV
argument_list|(
name|atadev
operator|->
name|unit
argument_list|)
operator|<<
literal|2
operator|)
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
name|dreg
argument_list|,
name|dmatimings
index|[
name|mode
operator|&
name|ATA_MODE_MASK
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|u_int8_t
name|preg
init|=
literal|0xa4
operator|+
name|rego
decl_stmt|;
name|u_int16_t
name|piotimings
index|[]
init|=
block|{
literal|0x328a
block|,
literal|0x2283
block|,
literal|0x1104
block|,
literal|0x10c3
block|,
literal|0x10c1
block|}
decl_stmt|;
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
name|mreg
argument_list|,
name|mval
operator||
operator|(
literal|0x01
operator|<<
operator|(
name|ATA_DEV
argument_list|(
name|atadev
operator|->
name|unit
argument_list|)
operator|<<
literal|2
operator|)
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
name|preg
argument_list|,
name|piotimings
index|[
name|mode
operator|&
name|ATA_MODE_MASK
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
name|atadev
operator|->
name|mode
operator|=
name|mode
expr_stmt|;
block|}
end_function

begin_struct
struct|struct
name|ata_siiprb_dma_prdentry
block|{
name|u_int64_t
name|addr
decl_stmt|;
name|u_int32_t
name|count
decl_stmt|;
name|u_int32_t
name|control
decl_stmt|;
block|}
name|__packed
struct|;
end_struct

begin_struct
struct|struct
name|ata_siiprb_ata_command
block|{
name|struct
name|ata_siiprb_dma_prdentry
name|prd
index|[
literal|126
index|]
decl_stmt|;
block|}
name|__packed
struct|;
end_struct

begin_struct
struct|struct
name|ata_siiprb_atapi_command
block|{
name|u_int8_t
name|ccb
index|[
literal|16
index|]
decl_stmt|;
name|struct
name|ata_siiprb_dma_prdentry
name|prd
index|[
literal|125
index|]
decl_stmt|;
block|}
name|__packed
struct|;
end_struct

begin_struct
struct|struct
name|ata_siiprb_command
block|{
name|u_int16_t
name|control
decl_stmt|;
name|u_int16_t
name|protocol_override
decl_stmt|;
name|u_int32_t
name|transfer_count
decl_stmt|;
name|u_int8_t
name|fis
index|[
literal|24
index|]
decl_stmt|;
union|union
block|{
name|struct
name|ata_siiprb_ata_command
name|ata
decl_stmt|;
name|struct
name|ata_siiprb_atapi_command
name|atapi
decl_stmt|;
block|}
name|u
union|;
block|}
name|__packed
struct|;
end_struct

begin_function
specifier|static
name|int
name|ata_siiprb_allocate
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|offset
init|=
name|ch
operator|->
name|unit
operator|*
literal|0x2000
decl_stmt|;
comment|/* set the SATA resources */
name|ch
operator|->
name|r_io
index|[
name|ATA_SSTATUS
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_res2
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SSTATUS
index|]
operator|.
name|offset
operator|=
literal|0x1f04
operator|+
name|offset
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SERROR
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_res2
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SERROR
index|]
operator|.
name|offset
operator|=
literal|0x1f08
operator|+
name|offset
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SCONTROL
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_res2
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SCONTROL
index|]
operator|.
name|offset
operator|=
literal|0x1f00
operator|+
name|offset
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SACTIVE
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_res2
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SACTIVE
index|]
operator|.
name|offset
operator|=
literal|0x1f0c
operator|+
name|offset
expr_stmt|;
name|ch
operator|->
name|hw
operator|.
name|begin_transaction
operator|=
name|ata_siiprb_begin_transaction
expr_stmt|;
name|ch
operator|->
name|hw
operator|.
name|end_transaction
operator|=
name|ata_siiprb_end_transaction
expr_stmt|;
name|ch
operator|->
name|hw
operator|.
name|status
operator|=
name|ata_siiprb_status
expr_stmt|;
name|ch
operator|->
name|hw
operator|.
name|command
operator|=
name|NULL
expr_stmt|;
comment|/* not used here */
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_siiprb_status
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|u_int32_t
name|action
init|=
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
literal|0x0044
argument_list|)
decl_stmt|;
name|int
name|offset
init|=
name|ch
operator|->
name|unit
operator|*
literal|0x2000
decl_stmt|;
if|if
condition|(
name|action
operator|&
operator|(
literal|1
operator|<<
name|ch
operator|->
name|unit
operator|)
condition|)
block|{
name|u_int32_t
name|istatus
init|=
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x1008
operator|+
name|offset
argument_list|)
decl_stmt|;
comment|/* do we have any PHY events ? */
name|ata_sata_phy_check_events
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* clear interrupt(s) */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x1008
operator|+
name|offset
argument_list|,
name|istatus
argument_list|)
expr_stmt|;
comment|/* do we have any device action ? */
return|return
operator|(
name|istatus
operator|&
literal|0x00000003
operator|)
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_siiprb_begin_transaction
parameter_list|(
name|struct
name|ata_request
modifier|*
name|request
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|GRANDPARENT
argument_list|(
name|request
operator|->
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|request
operator|->
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_siiprb_command
modifier|*
name|prb
decl_stmt|;
name|struct
name|ata_siiprb_dma_prdentry
modifier|*
name|prd
decl_stmt|;
name|int
name|offset
init|=
name|ch
operator|->
name|unit
operator|*
literal|0x2000
decl_stmt|;
name|u_int64_t
name|prb_bus
decl_stmt|;
name|int
name|tag
init|=
literal|0
decl_stmt|,
name|dummy
decl_stmt|;
comment|/* SOS XXX */
if|if
condition|(
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|command
operator|==
name|ATA_DEVICE_RESET
condition|)
block|{
name|request
operator|->
name|result
operator|=
literal|0
expr_stmt|;
return|return
name|ATA_OP_FINISHED
return|;
block|}
comment|/* check for 48 bit access and convert if needed */
name|ata_modify_if_48bit
argument_list|(
name|request
argument_list|)
expr_stmt|;
comment|/* get a piece of the workspace for this request */
name|prb
operator|=
operator|(
expr|struct
name|ata_siiprb_command
operator|*
operator|)
operator|(
name|ch
operator|->
name|dma
operator|->
name|work
operator|+
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|ata_siiprb_command
argument_list|)
operator|*
name|tag
operator|)
operator|)
expr_stmt|;
comment|/* set basic prd options ata/atapi etc etc */
name|bzero
argument_list|(
name|prb
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ata_siiprb_command
argument_list|)
argument_list|)
expr_stmt|;
comment|/* setup the FIS for this request */
if|if
condition|(
operator|!
name|ata_request2fis_h2d
argument_list|(
name|request
argument_list|,
operator|&
name|prb
operator|->
name|fis
index|[
literal|0
index|]
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|request
operator|->
name|dev
argument_list|,
literal|"setting up SATA FIS failed\n"
argument_list|)
expr_stmt|;
name|request
operator|->
name|result
operator|=
name|EIO
expr_stmt|;
return|return
name|ATA_OP_FINISHED
return|;
block|}
comment|/* setup transfer type */
if|if
condition|(
name|request
operator|->
name|flags
operator|&
name|ATA_R_ATAPI
condition|)
block|{
name|struct
name|ata_device
modifier|*
name|atadev
init|=
name|device_get_softc
argument_list|(
name|request
operator|->
name|dev
argument_list|)
decl_stmt|;
name|bcopy
argument_list|(
name|request
operator|->
name|u
operator|.
name|atapi
operator|.
name|ccb
argument_list|,
name|prb
operator|->
name|u
operator|.
name|atapi
operator|.
name|ccb
argument_list|,
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|atadev
operator|->
name|param
operator|.
name|config
operator|&
name|ATA_PROTO_MASK
operator|)
operator|==
name|ATA_PROTO_ATAPI_12
condition|)
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x1004
operator|+
name|offset
argument_list|,
literal|0x00000020
argument_list|)
expr_stmt|;
else|else
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x1000
operator|+
name|offset
argument_list|,
literal|0x00000020
argument_list|)
expr_stmt|;
if|if
condition|(
name|request
operator|->
name|flags
operator|&
name|ATA_R_READ
condition|)
name|prb
operator|->
name|control
operator|=
name|htole16
argument_list|(
literal|0x0010
argument_list|)
expr_stmt|;
if|if
condition|(
name|request
operator|->
name|flags
operator|&
name|ATA_R_WRITE
condition|)
name|prb
operator|->
name|control
operator|=
name|htole16
argument_list|(
literal|0x0020
argument_list|)
expr_stmt|;
name|prd
operator|=
operator|&
name|prb
operator|->
name|u
operator|.
name|atapi
operator|.
name|prd
index|[
literal|0
index|]
expr_stmt|;
block|}
else|else
name|prd
operator|=
operator|&
name|prb
operator|->
name|u
operator|.
name|ata
operator|.
name|prd
index|[
literal|0
index|]
expr_stmt|;
comment|/* if request moves data setup and load SG list */
if|if
condition|(
name|request
operator|->
name|flags
operator|&
operator|(
name|ATA_R_READ
operator||
name|ATA_R_WRITE
operator|)
condition|)
block|{
if|if
condition|(
name|ch
operator|->
name|dma
operator|->
name|load
argument_list|(
name|ch
operator|->
name|dev
argument_list|,
name|request
operator|->
name|data
argument_list|,
name|request
operator|->
name|bytecount
argument_list|,
name|request
operator|->
name|flags
operator|&
name|ATA_R_READ
argument_list|,
name|prd
argument_list|,
operator|&
name|dummy
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|request
operator|->
name|dev
argument_list|,
literal|"setting up DMA failed\n"
argument_list|)
expr_stmt|;
name|request
operator|->
name|result
operator|=
name|EIO
expr_stmt|;
return|return
name|ATA_OP_FINISHED
return|;
block|}
block|}
comment|/* activate the prb */
name|prb_bus
operator|=
name|ch
operator|->
name|dma
operator|->
name|work_bus
operator|+
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|ata_siiprb_command
argument_list|)
operator|*
name|tag
operator|)
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x1c00
operator|+
name|offset
operator|+
operator|(
name|tag
operator|*
sizeof|sizeof
argument_list|(
name|u_int64_t
argument_list|)
operator|)
argument_list|,
name|prb_bus
argument_list|)
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x1c04
operator|+
name|offset
operator|+
operator|(
name|tag
operator|*
sizeof|sizeof
argument_list|(
name|u_int64_t
argument_list|)
operator|)
argument_list|,
name|prb_bus
operator|>>
literal|32
argument_list|)
expr_stmt|;
comment|/* start the timeout */
name|callout_reset
argument_list|(
operator|&
name|request
operator|->
name|callout
argument_list|,
name|request
operator|->
name|timeout
operator|*
name|hz
argument_list|,
operator|(
name|timeout_t
operator|*
operator|)
name|ata_timeout
argument_list|,
name|request
argument_list|)
expr_stmt|;
return|return
name|ATA_OP_CONTINUES
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_siiprb_end_transaction
parameter_list|(
name|struct
name|ata_request
modifier|*
name|request
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|GRANDPARENT
argument_list|(
name|request
operator|->
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|request
operator|->
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_siiprb_command
modifier|*
name|prb
decl_stmt|;
name|int
name|offset
init|=
name|ch
operator|->
name|unit
operator|*
literal|0x2000
decl_stmt|;
name|int
name|error
decl_stmt|,
name|timeout
decl_stmt|,
name|tag
init|=
literal|0
decl_stmt|;
comment|/* kill the timeout */
name|callout_stop
argument_list|(
operator|&
name|request
operator|->
name|callout
argument_list|)
expr_stmt|;
name|prb
operator|=
operator|(
expr|struct
name|ata_siiprb_command
operator|*
operator|)
operator|(
operator|(
name|u_int8_t
operator|*
operator|)
name|rman_get_virtual
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|)
operator|+
operator|(
name|tag
operator|<<
literal|7
operator|)
operator|+
name|offset
operator|)
expr_stmt|;
comment|/* any controller errors flagged ? */
if|if
condition|(
operator|(
name|error
operator|=
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x1024
operator|+
name|offset
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
name|bootverbose
condition|)
name|printf
argument_list|(
literal|"ata_siiprb_end_transaction %s error=%08x\n"
argument_list|,
name|ata_cmd2str
argument_list|(
name|request
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
comment|/* if device error status get details */
if|if
condition|(
name|error
operator|==
literal|1
operator|||
name|error
operator|==
literal|2
condition|)
block|{
name|request
operator|->
name|status
operator|=
name|prb
operator|->
name|fis
index|[
literal|2
index|]
expr_stmt|;
if|if
condition|(
name|request
operator|->
name|status
operator|&
name|ATA_S_ERROR
condition|)
name|request
operator|->
name|error
operator|=
name|prb
operator|->
name|fis
index|[
literal|3
index|]
expr_stmt|;
block|}
comment|/* SOS XXX handle other controller errors here */
comment|/* initialize port */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x1000
operator|+
name|offset
argument_list|,
literal|0x00000004
argument_list|)
expr_stmt|;
comment|/* poll for port ready */
for|for
control|(
name|timeout
operator|=
literal|0
init|;
name|timeout
operator|<
literal|1000
condition|;
name|timeout
operator|++
control|)
block|{
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
if|if
condition|(
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x1008
operator|+
name|offset
argument_list|)
operator|&
literal|0x00040000
condition|)
break|break;
block|}
if|if
condition|(
name|bootverbose
condition|)
block|{
if|if
condition|(
name|timeout
operator|>=
literal|1000
condition|)
name|device_printf
argument_list|(
name|ch
operator|->
name|dev
argument_list|,
literal|"port initialize timeout\n"
argument_list|)
expr_stmt|;
else|else
name|device_printf
argument_list|(
name|ch
operator|->
name|dev
argument_list|,
literal|"port initialize time=%dms\n"
argument_list|,
name|timeout
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* update progress */
if|if
condition|(
operator|!
operator|(
name|request
operator|->
name|status
operator|&
name|ATA_S_ERROR
operator|)
operator|&&
operator|!
operator|(
name|request
operator|->
name|flags
operator|&
name|ATA_R_TIMEOUT
operator|)
condition|)
block|{
if|if
condition|(
name|request
operator|->
name|flags
operator|&
name|ATA_R_READ
condition|)
name|request
operator|->
name|donecount
operator|=
name|prb
operator|->
name|transfer_count
expr_stmt|;
else|else
name|request
operator|->
name|donecount
operator|=
name|request
operator|->
name|bytecount
expr_stmt|;
block|}
comment|/* release SG list etc */
name|ch
operator|->
name|dma
operator|->
name|unload
argument_list|(
name|ch
operator|->
name|dev
argument_list|)
expr_stmt|;
return|return
name|ATA_OP_FINISHED
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_siiprb_reset
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|offset
init|=
name|ch
operator|->
name|unit
operator|*
literal|0x2000
decl_stmt|;
name|struct
name|ata_siiprb_command
modifier|*
name|prb
decl_stmt|;
name|u_int64_t
name|prb_bus
decl_stmt|;
name|u_int32_t
name|status
decl_stmt|,
name|signature
decl_stmt|;
name|int
name|timeout
decl_stmt|,
name|tag
init|=
literal|0
decl_stmt|;
comment|/* reset channel HW */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x1000
operator|+
name|offset
argument_list|,
literal|0x00000001
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x1004
operator|+
name|offset
argument_list|,
literal|0x00000001
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|10000
argument_list|)
expr_stmt|;
comment|/* poll for channel ready */
for|for
control|(
name|timeout
operator|=
literal|0
init|;
name|timeout
operator|<
literal|1000
condition|;
name|timeout
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|status
operator|=
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x1008
operator|+
name|offset
argument_list|)
operator|)
operator|&
literal|0x00040000
condition|)
break|break;
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|bootverbose
condition|)
block|{
if|if
condition|(
name|timeout
operator|>=
literal|1000
condition|)
name|device_printf
argument_list|(
name|ch
operator|->
name|dev
argument_list|,
literal|"channel HW reset timeout\n"
argument_list|)
expr_stmt|;
else|else
name|device_printf
argument_list|(
name|ch
operator|->
name|dev
argument_list|,
literal|"channel HW reset time=%dms\n"
argument_list|,
name|timeout
argument_list|)
expr_stmt|;
block|}
comment|/* reset phy */
if|if
condition|(
operator|!
name|ata_sata_phy_reset
argument_list|(
name|dev
argument_list|)
condition|)
block|{
if|if
condition|(
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|ch
operator|->
name|dev
argument_list|,
literal|"phy reset found no device\n"
argument_list|)
expr_stmt|;
name|ch
operator|->
name|devices
operator|=
literal|0
expr_stmt|;
goto|goto
name|finish
goto|;
block|}
comment|/* get a piece of the workspace for a soft reset request */
name|prb
operator|=
operator|(
expr|struct
name|ata_siiprb_command
operator|*
operator|)
operator|(
name|ch
operator|->
name|dma
operator|->
name|work
operator|+
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|ata_siiprb_command
argument_list|)
operator|*
name|tag
operator|)
operator|)
expr_stmt|;
name|bzero
argument_list|(
name|prb
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ata_siiprb_command
argument_list|)
argument_list|)
expr_stmt|;
name|prb
operator|->
name|control
operator|=
name|htole16
argument_list|(
literal|0x0080
argument_list|)
expr_stmt|;
comment|/* activate the soft reset prb */
name|prb_bus
operator|=
name|ch
operator|->
name|dma
operator|->
name|work_bus
operator|+
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|ata_siiprb_command
argument_list|)
operator|*
name|tag
operator|)
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x1c00
operator|+
name|offset
operator|+
operator|(
name|tag
operator|*
sizeof|sizeof
argument_list|(
name|u_int64_t
argument_list|)
operator|)
argument_list|,
name|prb_bus
argument_list|)
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x1c04
operator|+
name|offset
operator|+
operator|(
name|tag
operator|*
sizeof|sizeof
argument_list|(
name|u_int64_t
argument_list|)
operator|)
argument_list|,
name|prb_bus
operator|>>
literal|32
argument_list|)
expr_stmt|;
comment|/* poll for command finished */
for|for
control|(
name|timeout
operator|=
literal|0
init|;
name|timeout
operator|<
literal|10000
condition|;
name|timeout
operator|++
control|)
block|{
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|status
operator|=
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x1008
operator|+
name|offset
argument_list|)
operator|)
operator|&
literal|0x00010000
condition|)
break|break;
block|}
if|if
condition|(
name|timeout
operator|>=
literal|1000
condition|)
block|{
name|device_printf
argument_list|(
name|ch
operator|->
name|dev
argument_list|,
literal|"reset timeout - no device found\n"
argument_list|)
expr_stmt|;
name|ch
operator|->
name|devices
operator|=
literal|0
expr_stmt|;
goto|goto
name|finish
goto|;
block|}
if|if
condition|(
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|ch
operator|->
name|dev
argument_list|,
literal|"soft reset exec time=%dms status=%08x\n"
argument_list|,
name|timeout
argument_list|,
name|status
argument_list|)
expr_stmt|;
comment|/* find out whats there */
name|prb
operator|=
operator|(
expr|struct
name|ata_siiprb_command
operator|*
operator|)
operator|(
operator|(
name|u_int8_t
operator|*
operator|)
name|rman_get_virtual
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|)
operator|+
operator|(
name|tag
operator|<<
literal|7
operator|)
operator|+
name|offset
operator|)
expr_stmt|;
name|signature
operator|=
name|prb
operator|->
name|fis
index|[
literal|12
index|]
operator||
operator|(
name|prb
operator|->
name|fis
index|[
literal|4
index|]
operator|<<
literal|8
operator|)
operator||
operator|(
name|prb
operator|->
name|fis
index|[
literal|5
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
name|prb
operator|->
name|fis
index|[
literal|6
index|]
operator|<<
literal|24
operator|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|ch
operator|->
name|dev
argument_list|,
literal|"SIGNATURE=%08x\n"
argument_list|,
name|signature
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|signature
condition|)
block|{
case|case
literal|0x00000101
case|:
name|ch
operator|->
name|devices
operator|=
name|ATA_ATA_MASTER
expr_stmt|;
break|break;
case|case
literal|0x96690101
case|:
name|ch
operator|->
name|devices
operator|=
name|ATA_PORTMULTIPLIER
expr_stmt|;
name|device_printf
argument_list|(
name|ch
operator|->
name|dev
argument_list|,
literal|"Portmultipliers not supported yet\n"
argument_list|)
expr_stmt|;
name|ch
operator|->
name|devices
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|0xeb140101
case|:
name|ch
operator|->
name|devices
operator|=
name|ATA_ATAPI_MASTER
expr_stmt|;
break|break;
default|default:
name|ch
operator|->
name|devices
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"siiprb_reset devices=0x%b\n"
argument_list|,
name|ch
operator|->
name|devices
argument_list|,
literal|"\20\4ATAPI_SLAVE\3ATAPI_MASTER\2ATA_SLAVE\1ATA_MASTER"
argument_list|)
expr_stmt|;
name|finish
label|:
comment|/* clear interrupt(s) */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x1008
operator|+
name|offset
argument_list|,
literal|0x000008ff
argument_list|)
expr_stmt|;
comment|/* require explicit interrupt ack */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x1000
operator|+
name|offset
argument_list|,
literal|0x00000008
argument_list|)
expr_stmt|;
comment|/* 64bit mode */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x1004
operator|+
name|offset
argument_list|,
literal|0x00000400
argument_list|)
expr_stmt|;
comment|/* enable interrupts wanted */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x1010
operator|+
name|offset
argument_list|,
literal|0x000000ff
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_siiprb_dmasetprd
parameter_list|(
name|void
modifier|*
name|xsc
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|segs
parameter_list|,
name|int
name|nsegs
parameter_list|,
name|int
name|error
parameter_list|)
block|{
name|struct
name|ata_dmasetprd_args
modifier|*
name|args
init|=
name|xsc
decl_stmt|;
name|struct
name|ata_siiprb_dma_prdentry
modifier|*
name|prd
init|=
name|args
operator|->
name|dmatab
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|(
name|args
operator|->
name|error
operator|=
name|error
operator|)
condition|)
return|return;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nsegs
condition|;
name|i
operator|++
control|)
block|{
name|prd
index|[
name|i
index|]
operator|.
name|addr
operator|=
name|htole64
argument_list|(
name|segs
index|[
name|i
index|]
operator|.
name|ds_addr
argument_list|)
expr_stmt|;
name|prd
index|[
name|i
index|]
operator|.
name|count
operator|=
name|htole32
argument_list|(
name|segs
index|[
name|i
index|]
operator|.
name|ds_len
argument_list|)
expr_stmt|;
block|}
name|prd
index|[
name|i
operator|-
literal|1
index|]
operator|.
name|control
operator|=
name|htole32
argument_list|(
name|ATA_DMA_EOT
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|nsegs
operator|<=
name|ATA_DMA_ENTRIES
argument_list|,
operator|(
literal|"too many DMA segment entries\n"
operator|)
argument_list|)
expr_stmt|;
name|args
operator|->
name|nsegs
operator|=
name|nsegs
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_siiprb_dmainit
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|ata_dmainit
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|ch
operator|->
name|dma
condition|)
block|{
comment|/* note start and stop are not used here */
name|ch
operator|->
name|dma
operator|->
name|setprd
operator|=
name|ata_siiprb_dmasetprd
expr_stmt|;
name|ch
operator|->
name|dma
operator|->
name|max_address
operator|=
name|BUS_SPACE_MAXADDR
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Silicon Integrated Systems Corp. (SiS) chipset support functions  */
end_comment

begin_function
name|int
name|ata_sis_ident
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ata_chip_id
modifier|*
name|idx
decl_stmt|;
specifier|static
name|struct
name|ata_chip_id
name|ids
index|[]
init|=
block|{
block|{
name|ATA_SIS182
block|,
literal|0x00
block|,
name|SISSATA
block|,
literal|0
block|,
name|ATA_SA150
block|,
literal|"182"
block|}
block|,
comment|/* south */
block|{
name|ATA_SIS181
block|,
literal|0x00
block|,
name|SISSATA
block|,
literal|0
block|,
name|ATA_SA150
block|,
literal|"181"
block|}
block|,
comment|/* south */
block|{
name|ATA_SIS180
block|,
literal|0x00
block|,
name|SISSATA
block|,
literal|0
block|,
name|ATA_SA150
block|,
literal|"180"
block|}
block|,
comment|/* south */
block|{
name|ATA_SIS965
block|,
literal|0x00
block|,
name|SIS133NEW
block|,
literal|0
block|,
name|ATA_UDMA6
block|,
literal|"965"
block|}
block|,
comment|/* south */
block|{
name|ATA_SIS964
block|,
literal|0x00
block|,
name|SIS133NEW
block|,
literal|0
block|,
name|ATA_UDMA6
block|,
literal|"964"
block|}
block|,
comment|/* south */
block|{
name|ATA_SIS963
block|,
literal|0x00
block|,
name|SIS133NEW
block|,
literal|0
block|,
name|ATA_UDMA6
block|,
literal|"963"
block|}
block|,
comment|/* south */
block|{
name|ATA_SIS962
block|,
literal|0x00
block|,
name|SIS133NEW
block|,
literal|0
block|,
name|ATA_UDMA6
block|,
literal|"962"
block|}
block|,
comment|/* south */
block|{
name|ATA_SIS745
block|,
literal|0x00
block|,
name|SIS100NEW
block|,
literal|0
block|,
name|ATA_UDMA5
block|,
literal|"745"
block|}
block|,
comment|/* 1chip */
block|{
name|ATA_SIS735
block|,
literal|0x00
block|,
name|SIS100NEW
block|,
literal|0
block|,
name|ATA_UDMA5
block|,
literal|"735"
block|}
block|,
comment|/* 1chip */
block|{
name|ATA_SIS733
block|,
literal|0x00
block|,
name|SIS100NEW
block|,
literal|0
block|,
name|ATA_UDMA5
block|,
literal|"733"
block|}
block|,
comment|/* 1chip */
block|{
name|ATA_SIS730
block|,
literal|0x00
block|,
name|SIS100OLD
block|,
literal|0
block|,
name|ATA_UDMA5
block|,
literal|"730"
block|}
block|,
comment|/* 1chip */
block|{
name|ATA_SIS635
block|,
literal|0x00
block|,
name|SIS100NEW
block|,
literal|0
block|,
name|ATA_UDMA5
block|,
literal|"635"
block|}
block|,
comment|/* 1chip */
block|{
name|ATA_SIS633
block|,
literal|0x00
block|,
name|SIS100NEW
block|,
literal|0
block|,
name|ATA_UDMA5
block|,
literal|"633"
block|}
block|,
comment|/* unknown */
block|{
name|ATA_SIS630
block|,
literal|0x30
block|,
name|SIS100OLD
block|,
literal|0
block|,
name|ATA_UDMA5
block|,
literal|"630S"
block|}
block|,
comment|/* 1chip */
block|{
name|ATA_SIS630
block|,
literal|0x00
block|,
name|SIS66
block|,
literal|0
block|,
name|ATA_UDMA4
block|,
literal|"630"
block|}
block|,
comment|/* 1chip */
block|{
name|ATA_SIS620
block|,
literal|0x00
block|,
name|SIS66
block|,
literal|0
block|,
name|ATA_UDMA4
block|,
literal|"620"
block|}
block|,
comment|/* 1chip */
block|{
name|ATA_SIS550
block|,
literal|0x00
block|,
name|SIS66
block|,
literal|0
block|,
name|ATA_UDMA5
block|,
literal|"550"
block|}
block|,
block|{
name|ATA_SIS540
block|,
literal|0x00
block|,
name|SIS66
block|,
literal|0
block|,
name|ATA_UDMA4
block|,
literal|"540"
block|}
block|,
block|{
name|ATA_SIS530
block|,
literal|0x00
block|,
name|SIS66
block|,
literal|0
block|,
name|ATA_UDMA4
block|,
literal|"530"
block|}
block|,
block|{
name|ATA_SIS5513
block|,
literal|0xc2
block|,
name|SIS33
block|,
literal|1
block|,
name|ATA_UDMA2
block|,
literal|"5513"
block|}
block|,
block|{
name|ATA_SIS5513
block|,
literal|0x00
block|,
name|SIS33
block|,
literal|1
block|,
name|ATA_WDMA2
block|,
literal|"5513"
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
name|char
name|buffer
index|[
literal|64
index|]
decl_stmt|;
name|int
name|found
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|idx
operator|=
name|ata_find_chip
argument_list|(
name|dev
argument_list|,
name|ids
argument_list|,
operator|-
name|pci_get_slot
argument_list|(
name|dev
argument_list|)
argument_list|)
operator|)
condition|)
return|return
name|ENXIO
return|;
if|if
condition|(
name|idx
operator|->
name|cfg2
operator|&&
operator|!
name|found
condition|)
block|{
name|u_int8_t
name|reg57
init|=
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x57
argument_list|,
literal|1
argument_list|)
decl_stmt|;
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x57
argument_list|,
operator|(
name|reg57
operator|&
literal|0x7f
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|pci_read_config
argument_list|(
name|dev
argument_list|,
name|PCIR_DEVVENDOR
argument_list|,
literal|4
argument_list|)
operator|==
name|ATA_SIS5518
condition|)
block|{
name|found
operator|=
literal|1
expr_stmt|;
name|idx
operator|->
name|cfg1
operator|=
name|SIS133NEW
expr_stmt|;
name|idx
operator|->
name|max_dma
operator|=
name|ATA_UDMA6
expr_stmt|;
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"SiS 962/963 %s controller"
argument_list|,
name|ata_mode2str
argument_list|(
name|idx
operator|->
name|max_dma
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x57
argument_list|,
name|reg57
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|idx
operator|->
name|cfg2
operator|&&
operator|!
name|found
condition|)
block|{
name|u_int8_t
name|reg4a
init|=
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x4a
argument_list|,
literal|1
argument_list|)
decl_stmt|;
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x4a
argument_list|,
operator|(
name|reg4a
operator||
literal|0x10
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|pci_read_config
argument_list|(
name|dev
argument_list|,
name|PCIR_DEVVENDOR
argument_list|,
literal|4
argument_list|)
operator|==
name|ATA_SIS5517
condition|)
block|{
name|struct
name|ata_chip_id
name|id
index|[]
init|=
block|{
block|{
name|ATA_SISSOUTH
block|,
literal|0x10
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|""
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
name|found
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|ata_find_chip
argument_list|(
name|dev
argument_list|,
name|id
argument_list|,
name|pci_get_slot
argument_list|(
name|dev
argument_list|)
argument_list|)
condition|)
block|{
name|idx
operator|->
name|cfg1
operator|=
name|SIS133OLD
expr_stmt|;
name|idx
operator|->
name|max_dma
operator|=
name|ATA_UDMA6
expr_stmt|;
block|}
else|else
block|{
name|idx
operator|->
name|cfg1
operator|=
name|SIS100NEW
expr_stmt|;
name|idx
operator|->
name|max_dma
operator|=
name|ATA_UDMA5
expr_stmt|;
block|}
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"SiS 961 %s controller"
argument_list|,
name|ata_mode2str
argument_list|(
name|idx
operator|->
name|max_dma
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x4a
argument_list|,
name|reg4a
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|found
condition|)
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"SiS %s %s controller"
argument_list|,
name|idx
operator|->
name|text
argument_list|,
name|ata_mode2str
argument_list|(
name|idx
operator|->
name|max_dma
argument_list|)
argument_list|)
expr_stmt|;
name|device_set_desc_copy
argument_list|(
name|dev
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|chip
operator|=
name|idx
expr_stmt|;
name|ctlr
operator|->
name|chipinit
operator|=
name|ata_sis_chipinit
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_sis_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|ata_setup_interrupt
argument_list|(
name|dev
argument_list|)
condition|)
return|return
name|ENXIO
return|;
switch|switch
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg1
condition|)
block|{
case|case
name|SIS33
case|:
break|break;
case|case
name|SIS66
case|:
case|case
name|SIS100OLD
case|:
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x52
argument_list|,
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x52
argument_list|,
literal|1
argument_list|)
operator|&
operator|~
literal|0x04
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIS100NEW
case|:
case|case
name|SIS133OLD
case|:
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x49
argument_list|,
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x49
argument_list|,
literal|1
argument_list|)
operator|&
operator|~
literal|0x01
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIS133NEW
case|:
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x50
argument_list|,
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x50
argument_list|,
literal|2
argument_list|)
operator||
literal|0x0008
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x52
argument_list|,
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x52
argument_list|,
literal|2
argument_list|)
operator||
literal|0x0008
argument_list|,
literal|2
argument_list|)
expr_stmt|;
break|break;
case|case
name|SISSATA
case|:
name|ctlr
operator|->
name|r_type2
operator|=
name|SYS_RES_IOPORT
expr_stmt|;
name|ctlr
operator|->
name|r_rid2
operator|=
name|PCIR_BAR
argument_list|(
literal|5
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ctlr
operator|->
name|r_res2
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|ctlr
operator|->
name|r_type2
argument_list|,
operator|&
name|ctlr
operator|->
name|r_rid2
argument_list|,
name|RF_ACTIVE
argument_list|)
operator|)
condition|)
block|{
name|ctlr
operator|->
name|allocate
operator|=
name|ata_sis_allocate
expr_stmt|;
name|ctlr
operator|->
name|reset
operator|=
name|ata_sis_reset
expr_stmt|;
block|}
name|ctlr
operator|->
name|setmode
operator|=
name|ata_sata_setmode
expr_stmt|;
return|return
literal|0
return|;
default|default:
return|return
name|ENXIO
return|;
block|}
name|ctlr
operator|->
name|setmode
operator|=
name|ata_sis_setmode
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_sis_allocate
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|offset
init|=
name|ch
operator|->
name|unit
operator|<<
operator|(
operator|(
name|ctlr
operator|->
name|chip
operator|->
name|chipid
operator|==
name|ATA_SIS182
operator|)
condition|?
literal|5
else|:
literal|6
operator|)
decl_stmt|;
comment|/* setup the usual register normal pci style */
if|if
condition|(
name|ata_pci_allocate
argument_list|(
name|dev
argument_list|)
condition|)
return|return
name|ENXIO
return|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SSTATUS
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_res2
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SSTATUS
index|]
operator|.
name|offset
operator|=
literal|0x00
operator|+
name|offset
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SERROR
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_res2
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SERROR
index|]
operator|.
name|offset
operator|=
literal|0x04
operator|+
name|offset
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SCONTROL
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_res2
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SCONTROL
index|]
operator|.
name|offset
operator|=
literal|0x08
operator|+
name|offset
expr_stmt|;
name|ch
operator|->
name|flags
operator||=
name|ATA_NO_SLAVE
expr_stmt|;
comment|/* XXX SOS PHY hotplug handling missing in SiS chip ?? */
comment|/* XXX SOS unknown how to enable PHY state change interrupt */
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_sis_reset
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
if|if
condition|(
name|ata_sata_phy_reset
argument_list|(
name|dev
argument_list|)
condition|)
name|ata_generic_reset
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_sis_setmode
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|device_t
name|gparent
init|=
name|GRANDPARENT
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|gparent
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_device
modifier|*
name|atadev
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|devno
init|=
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|1
operator|)
operator|+
name|ATA_DEV
argument_list|(
name|atadev
operator|->
name|unit
argument_list|)
decl_stmt|;
name|int
name|error
decl_stmt|;
name|mode
operator|=
name|ata_limit_mode
argument_list|(
name|dev
argument_list|,
name|mode
argument_list|,
name|ctlr
operator|->
name|chip
operator|->
name|max_dma
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg1
operator|==
name|SIS133NEW
condition|)
block|{
if|if
condition|(
name|mode
operator|>
name|ATA_UDMA2
operator|&&
name|pci_read_config
argument_list|(
name|gparent
argument_list|,
name|ch
operator|->
name|unit
condition|?
literal|0x52
else|:
literal|0x50
argument_list|,
literal|2
argument_list|)
operator|&
literal|0x8000
condition|)
block|{
name|ata_print_cable
argument_list|(
name|dev
argument_list|,
literal|"controller"
argument_list|)
expr_stmt|;
name|mode
operator|=
name|ATA_UDMA2
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|mode
operator|>
name|ATA_UDMA2
operator|&&
name|pci_read_config
argument_list|(
name|gparent
argument_list|,
literal|0x48
argument_list|,
literal|1
argument_list|)
operator|&
operator|(
name|ch
operator|->
name|unit
condition|?
literal|0x20
else|:
literal|0x10
operator|)
condition|)
block|{
name|ata_print_cable
argument_list|(
name|dev
argument_list|,
literal|"controller"
argument_list|)
expr_stmt|;
name|mode
operator|=
name|ATA_UDMA2
expr_stmt|;
block|}
block|}
name|error
operator|=
name|ata_controlcmd
argument_list|(
name|dev
argument_list|,
name|ATA_SETFEATURES
argument_list|,
name|ATA_SF_SETXFER
argument_list|,
literal|0
argument_list|,
name|mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%ssetting %s on %s chip\n"
argument_list|,
operator|(
name|error
operator|)
condition|?
literal|"FAILURE "
else|:
literal|""
argument_list|,
name|ata_mode2str
argument_list|(
name|mode
argument_list|)
argument_list|,
name|ctlr
operator|->
name|chip
operator|->
name|text
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
block|{
switch|switch
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg1
condition|)
block|{
case|case
name|SIS133NEW
case|:
block|{
name|u_int32_t
name|timings
index|[]
init|=
block|{
literal|0x28269008
block|,
literal|0x0c266008
block|,
literal|0x04263008
block|,
literal|0x0c0a3008
block|,
literal|0x05093008
block|,
literal|0x22196008
block|,
literal|0x0c0a3008
block|,
literal|0x05093008
block|,
literal|0x050939fc
block|,
literal|0x050936ac
block|,
literal|0x0509347c
block|,
literal|0x0509325c
block|,
literal|0x0509323c
block|,
literal|0x0509322c
block|,
literal|0x0509321c
block|}
decl_stmt|;
name|u_int32_t
name|reg
decl_stmt|;
name|reg
operator|=
operator|(
name|pci_read_config
argument_list|(
name|gparent
argument_list|,
literal|0x57
argument_list|,
literal|1
argument_list|)
operator|&
literal|0x40
condition|?
literal|0x70
else|:
literal|0x40
operator|)
operator|+
operator|(
name|devno
operator|<<
literal|2
operator|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
name|reg
argument_list|,
name|timings
index|[
name|ata_mode2idx
argument_list|(
name|mode
argument_list|)
index|]
argument_list|,
literal|4
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|SIS133OLD
case|:
block|{
name|u_int16_t
name|timings
index|[]
init|=
block|{
literal|0x00cb
block|,
literal|0x0067
block|,
literal|0x0044
block|,
literal|0x0033
block|,
literal|0x0031
block|,
literal|0x0044
block|,
literal|0x0033
block|,
literal|0x0031
block|,
literal|0x8f31
block|,
literal|0x8a31
block|,
literal|0x8731
block|,
literal|0x8531
block|,
literal|0x8331
block|,
literal|0x8231
block|,
literal|0x8131
block|}
decl_stmt|;
name|u_int16_t
name|reg
init|=
literal|0x40
operator|+
operator|(
name|devno
operator|<<
literal|1
operator|)
decl_stmt|;
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
name|reg
argument_list|,
name|timings
index|[
name|ata_mode2idx
argument_list|(
name|mode
argument_list|)
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|SIS100NEW
case|:
block|{
name|u_int16_t
name|timings
index|[]
init|=
block|{
literal|0x00cb
block|,
literal|0x0067
block|,
literal|0x0044
block|,
literal|0x0033
block|,
literal|0x0031
block|,
literal|0x0044
block|,
literal|0x0033
block|,
literal|0x0031
block|,
literal|0x8b31
block|,
literal|0x8731
block|,
literal|0x8531
block|,
literal|0x8431
block|,
literal|0x8231
block|,
literal|0x8131
block|}
decl_stmt|;
name|u_int16_t
name|reg
init|=
literal|0x40
operator|+
operator|(
name|devno
operator|<<
literal|1
operator|)
decl_stmt|;
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
name|reg
argument_list|,
name|timings
index|[
name|ata_mode2idx
argument_list|(
name|mode
argument_list|)
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|SIS100OLD
case|:
case|case
name|SIS66
case|:
case|case
name|SIS33
case|:
block|{
name|u_int16_t
name|timings
index|[]
init|=
block|{
literal|0x0c0b
block|,
literal|0x0607
block|,
literal|0x0404
block|,
literal|0x0303
block|,
literal|0x0301
block|,
literal|0x0404
block|,
literal|0x0303
block|,
literal|0x0301
block|,
literal|0xf301
block|,
literal|0xd301
block|,
literal|0xb301
block|,
literal|0xa301
block|,
literal|0x9301
block|,
literal|0x8301
block|}
decl_stmt|;
name|u_int16_t
name|reg
init|=
literal|0x40
operator|+
operator|(
name|devno
operator|<<
literal|1
operator|)
decl_stmt|;
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
name|reg
argument_list|,
name|timings
index|[
name|ata_mode2idx
argument_list|(
name|mode
argument_list|)
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|atadev
operator|->
name|mode
operator|=
name|mode
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* VIA Technologies Inc. chipset support functions */
end_comment

begin_function
name|int
name|ata_via_ident
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
specifier|static
name|struct
name|ata_chip_id
name|ids
index|[]
init|=
block|{
block|{
name|ATA_VIA82C586
block|,
literal|0x02
block|,
name|VIA33
block|,
literal|0x00
block|,
name|ATA_UDMA2
block|,
literal|"82C586B"
block|}
block|,
block|{
name|ATA_VIA82C586
block|,
literal|0x00
block|,
name|VIA33
block|,
literal|0x00
block|,
name|ATA_WDMA2
block|,
literal|"82C586"
block|}
block|,
block|{
name|ATA_VIA82C596
block|,
literal|0x12
block|,
name|VIA66
block|,
name|VIACLK
block|,
name|ATA_UDMA4
block|,
literal|"82C596B"
block|}
block|,
block|{
name|ATA_VIA82C596
block|,
literal|0x00
block|,
name|VIA33
block|,
literal|0x00
block|,
name|ATA_UDMA2
block|,
literal|"82C596"
block|}
block|,
block|{
name|ATA_VIA82C686
block|,
literal|0x40
block|,
name|VIA100
block|,
name|VIABUG
block|,
name|ATA_UDMA5
block|,
literal|"82C686B"
block|}
block|,
block|{
name|ATA_VIA82C686
block|,
literal|0x10
block|,
name|VIA66
block|,
name|VIACLK
block|,
name|ATA_UDMA4
block|,
literal|"82C686A"
block|}
block|,
block|{
name|ATA_VIA82C686
block|,
literal|0x00
block|,
name|VIA33
block|,
literal|0x00
block|,
name|ATA_UDMA2
block|,
literal|"82C686"
block|}
block|,
block|{
name|ATA_VIA8231
block|,
literal|0x00
block|,
name|VIA100
block|,
name|VIABUG
block|,
name|ATA_UDMA5
block|,
literal|"8231"
block|}
block|,
block|{
name|ATA_VIA8233
block|,
literal|0x00
block|,
name|VIA100
block|,
literal|0x00
block|,
name|ATA_UDMA5
block|,
literal|"8233"
block|}
block|,
block|{
name|ATA_VIA8233C
block|,
literal|0x00
block|,
name|VIA100
block|,
literal|0x00
block|,
name|ATA_UDMA5
block|,
literal|"8233C"
block|}
block|,
block|{
name|ATA_VIA8233A
block|,
literal|0x00
block|,
name|VIA133
block|,
literal|0x00
block|,
name|ATA_UDMA6
block|,
literal|"8233A"
block|}
block|,
block|{
name|ATA_VIA8235
block|,
literal|0x00
block|,
name|VIA133
block|,
literal|0x00
block|,
name|ATA_UDMA6
block|,
literal|"8235"
block|}
block|,
block|{
name|ATA_VIA8237
block|,
literal|0x00
block|,
name|VIA133
block|,
literal|0x00
block|,
name|ATA_UDMA6
block|,
literal|"8237"
block|}
block|,
block|{
name|ATA_VIA8237A
block|,
literal|0x00
block|,
name|VIA133
block|,
literal|0x00
block|,
name|ATA_UDMA6
block|,
literal|"8237A"
block|}
block|,
block|{
name|ATA_VIA8237S
block|,
literal|0x00
block|,
name|VIA133
block|,
literal|0x00
block|,
name|ATA_UDMA6
block|,
literal|"8237S"
block|}
block|,
block|{
name|ATA_VIA8251
block|,
literal|0x00
block|,
name|VIA133
block|,
literal|0x00
block|,
name|ATA_UDMA6
block|,
literal|"8251"
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
specifier|static
name|struct
name|ata_chip_id
name|new_ids
index|[]
init|=
block|{
block|{
name|ATA_VIA6410
block|,
literal|0x00
block|,
literal|0
block|,
literal|0x00
block|,
name|ATA_UDMA6
block|,
literal|"6410"
block|}
block|,
block|{
name|ATA_VIA6420
block|,
literal|0x00
block|,
literal|7
block|,
literal|0x00
block|,
name|ATA_SA150
block|,
literal|"6420"
block|}
block|,
block|{
name|ATA_VIA6421
block|,
literal|0x00
block|,
literal|6
block|,
name|VIABAR
block|,
name|ATA_SA150
block|,
literal|"6421"
block|}
block|,
block|{
name|ATA_VIA8237A
block|,
literal|0x00
block|,
literal|7
block|,
literal|0x00
block|,
name|ATA_SA150
block|,
literal|"8237A"
block|}
block|,
block|{
name|ATA_VIA8237S
block|,
literal|0x00
block|,
literal|7
block|,
literal|0x00
block|,
name|ATA_SA150
block|,
literal|"8237S"
block|}
block|,
block|{
name|ATA_VIA8251
block|,
literal|0x00
block|,
literal|0
block|,
name|VIAAHCI
block|,
name|ATA_SA300
block|,
literal|"8251"
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
if|if
condition|(
name|pci_get_devid
argument_list|(
name|dev
argument_list|)
operator|==
name|ATA_VIA82C571
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|ctlr
operator|->
name|chip
operator|=
name|ata_find_chip
argument_list|(
name|dev
argument_list|,
name|ids
argument_list|,
operator|-
literal|99
argument_list|)
operator|)
condition|)
return|return
name|ENXIO
return|;
block|}
else|else
block|{
if|if
condition|(
operator|!
operator|(
name|ctlr
operator|->
name|chip
operator|=
name|ata_match_chip
argument_list|(
name|dev
argument_list|,
name|new_ids
argument_list|)
operator|)
condition|)
return|return
name|ENXIO
return|;
block|}
name|ata_set_desc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|chipinit
operator|=
name|ata_via_chipinit
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_via_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|ata_setup_interrupt
argument_list|(
name|dev
argument_list|)
condition|)
return|return
name|ENXIO
return|;
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|max_dma
operator|>=
name|ATA_SA150
condition|)
block|{
comment|/* do we have AHCI capability ? */
if|if
condition|(
operator|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|==
name|VIAAHCI
operator|)
operator|&&
name|ata_ahci_chipinit
argument_list|(
name|dev
argument_list|)
operator|!=
name|ENXIO
condition|)
return|return
literal|0
return|;
name|ctlr
operator|->
name|r_type2
operator|=
name|SYS_RES_IOPORT
expr_stmt|;
name|ctlr
operator|->
name|r_rid2
operator|=
name|PCIR_BAR
argument_list|(
literal|5
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ctlr
operator|->
name|r_res2
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|ctlr
operator|->
name|r_type2
argument_list|,
operator|&
name|ctlr
operator|->
name|r_rid2
argument_list|,
name|RF_ACTIVE
argument_list|)
operator|)
condition|)
block|{
name|ctlr
operator|->
name|allocate
operator|=
name|ata_via_allocate
expr_stmt|;
name|ctlr
operator|->
name|reset
operator|=
name|ata_via_reset
expr_stmt|;
block|}
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|&
name|VIABAR
condition|)
block|{
name|ctlr
operator|->
name|channels
operator|=
literal|3
expr_stmt|;
name|ctlr
operator|->
name|setmode
operator|=
name|ata_via_setmode
expr_stmt|;
block|}
else|else
name|ctlr
operator|->
name|setmode
operator|=
name|ata_sata_setmode
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* prepare for ATA-66 on the 82C686a and 82C596b */
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|&
name|VIACLK
condition|)
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x50
argument_list|,
literal|0x030b030b
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/* the southbridge might need the data corruption fix */
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|&
name|VIABUG
condition|)
name|ata_via_southbridge_fixup
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* set fifo configuration half'n'half */
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x43
argument_list|,
operator|(
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x43
argument_list|,
literal|1
argument_list|)
operator|&
literal|0x90
operator|)
operator||
literal|0x2a
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* set status register read retry */
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x44
argument_list|,
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x44
argument_list|,
literal|1
argument_list|)
operator||
literal|0x08
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* set DMA read& end-of-sector fifo flush */
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x46
argument_list|,
operator|(
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x46
argument_list|,
literal|1
argument_list|)
operator|&
literal|0x0c
operator|)
operator||
literal|0xf0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* set sector size */
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x60
argument_list|,
name|DEV_BSIZE
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x68
argument_list|,
name|DEV_BSIZE
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|setmode
operator|=
name|ata_via_family_setmode
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_via_allocate
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
comment|/* newer SATA chips has resources in one BAR for each channel */
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|&
name|VIABAR
condition|)
block|{
name|struct
name|resource
modifier|*
name|r_io
decl_stmt|;
name|int
name|i
decl_stmt|,
name|rid
decl_stmt|;
name|rid
operator|=
name|PCIR_BAR
argument_list|(
name|ch
operator|->
name|unit
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|r_io
operator|=
name|bus_alloc_resource_any
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|,
name|SYS_RES_IOPORT
argument_list|,
operator|&
name|rid
argument_list|,
name|RF_ACTIVE
argument_list|)
operator|)
condition|)
return|return
name|ENXIO
return|;
for|for
control|(
name|i
operator|=
name|ATA_DATA
init|;
name|i
operator|<=
name|ATA_COMMAND
condition|;
name|i
operator|++
control|)
block|{
name|ch
operator|->
name|r_io
index|[
name|i
index|]
operator|.
name|res
operator|=
name|r_io
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|i
index|]
operator|.
name|offset
operator|=
name|i
expr_stmt|;
block|}
name|ch
operator|->
name|r_io
index|[
name|ATA_CONTROL
index|]
operator|.
name|res
operator|=
name|r_io
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_CONTROL
index|]
operator|.
name|offset
operator|=
literal|2
operator|+
name|ATA_IOSIZE
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_IDX_ADDR
index|]
operator|.
name|res
operator|=
name|r_io
expr_stmt|;
name|ata_default_registers
argument_list|(
name|dev
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|ATA_BMCMD_PORT
init|;
name|i
operator|<=
name|ATA_BMDTP_PORT
condition|;
name|i
operator|++
control|)
block|{
name|ch
operator|->
name|r_io
index|[
name|i
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_res1
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|i
index|]
operator|.
name|offset
operator|=
operator|(
name|i
operator|-
name|ATA_BMCMD_PORT
operator|)
operator|+
operator|(
name|ch
operator|->
name|unit
operator|*
name|ATA_BMIOSIZE
operator|)
expr_stmt|;
block|}
name|ata_pci_hw
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|ch
operator|->
name|unit
operator|>=
literal|2
condition|)
return|return
literal|0
return|;
block|}
else|else
block|{
comment|/* setup the usual register normal pci style */
if|if
condition|(
name|ata_pci_allocate
argument_list|(
name|dev
argument_list|)
condition|)
return|return
name|ENXIO
return|;
block|}
name|ch
operator|->
name|r_io
index|[
name|ATA_SSTATUS
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_res2
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SSTATUS
index|]
operator|.
name|offset
operator|=
operator|(
name|ch
operator|->
name|unit
operator|<<
name|ctlr
operator|->
name|chip
operator|->
name|cfg1
operator|)
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SERROR
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_res2
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SERROR
index|]
operator|.
name|offset
operator|=
literal|0x04
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
name|ctlr
operator|->
name|chip
operator|->
name|cfg1
operator|)
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SCONTROL
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_res2
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SCONTROL
index|]
operator|.
name|offset
operator|=
literal|0x08
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
name|ctlr
operator|->
name|chip
operator|->
name|cfg1
operator|)
expr_stmt|;
name|ch
operator|->
name|flags
operator||=
name|ATA_NO_SLAVE
expr_stmt|;
comment|/* XXX SOS PHY hotplug handling missing in VIA chip ?? */
comment|/* XXX SOS unknown how to enable PHY state change interrupt */
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_via_reset
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|&
name|VIABAR
operator|)
operator|&&
operator|(
name|ch
operator|->
name|unit
operator|>
literal|1
operator|)
condition|)
name|ata_generic_reset
argument_list|(
name|dev
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|ata_sata_phy_reset
argument_list|(
name|dev
argument_list|)
condition|)
name|ata_generic_reset
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_via_setmode
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|device_t
name|gparent
init|=
name|GRANDPARENT
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|gparent
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_device
modifier|*
name|atadev
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|error
decl_stmt|;
if|if
condition|(
operator|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|&
name|VIABAR
operator|)
operator|&&
operator|(
name|ch
operator|->
name|unit
operator|>
literal|1
operator|)
condition|)
block|{
name|u_int8_t
name|pio_timings
index|[]
init|=
block|{
literal|0xa8
block|,
literal|0x65
block|,
literal|0x65
block|,
literal|0x32
block|,
literal|0x20
block|,
literal|0x65
block|,
literal|0x32
block|,
literal|0x20
block|,
literal|0x20
block|,
literal|0x20
block|,
literal|0x20
block|,
literal|0x20
block|,
literal|0x20
block|,
literal|0x20
block|,
literal|0x20
block|}
decl_stmt|;
name|u_int8_t
name|dma_timings
index|[]
init|=
block|{
literal|0xee
block|,
literal|0xe8
block|,
literal|0xe6
block|,
literal|0xe4
block|,
literal|0xe2
block|,
literal|0xe1
block|,
literal|0xe0
block|}
decl_stmt|;
name|mode
operator|=
name|ata_check_80pin
argument_list|(
name|dev
argument_list|,
name|ata_limit_mode
argument_list|(
name|dev
argument_list|,
name|mode
argument_list|,
name|ATA_UDMA6
argument_list|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|ata_controlcmd
argument_list|(
name|dev
argument_list|,
name|ATA_SETFEATURES
argument_list|,
name|ATA_SF_SETXFER
argument_list|,
literal|0
argument_list|,
name|mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%ssetting %s on %s chip\n"
argument_list|,
operator|(
name|error
operator|)
condition|?
literal|"FAILURE "
else|:
literal|""
argument_list|,
name|ata_mode2str
argument_list|(
name|mode
argument_list|)
argument_list|,
name|ctlr
operator|->
name|chip
operator|->
name|text
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
block|{
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
literal|0xab
argument_list|,
name|pio_timings
index|[
name|ata_mode2idx
argument_list|(
name|mode
argument_list|)
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|mode
operator|>=
name|ATA_UDMA0
condition|)
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
literal|0xb3
argument_list|,
name|dma_timings
index|[
name|mode
operator|&
name|ATA_MODE_MASK
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|atadev
operator|->
name|mode
operator|=
name|mode
expr_stmt|;
block|}
block|}
else|else
name|ata_sata_setmode
argument_list|(
name|dev
argument_list|,
name|mode
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_via_southbridge_fixup
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|device_t
modifier|*
name|children
decl_stmt|;
name|int
name|nchildren
decl_stmt|,
name|i
decl_stmt|;
if|if
condition|(
name|device_get_children
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|,
operator|&
name|children
argument_list|,
operator|&
name|nchildren
argument_list|)
condition|)
return|return;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nchildren
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|pci_get_devid
argument_list|(
name|children
index|[
name|i
index|]
argument_list|)
operator|==
name|ATA_VIA8363
operator|||
name|pci_get_devid
argument_list|(
name|children
index|[
name|i
index|]
argument_list|)
operator|==
name|ATA_VIA8371
operator|||
name|pci_get_devid
argument_list|(
name|children
index|[
name|i
index|]
argument_list|)
operator|==
name|ATA_VIA8662
operator|||
name|pci_get_devid
argument_list|(
name|children
index|[
name|i
index|]
argument_list|)
operator|==
name|ATA_VIA8361
condition|)
block|{
name|u_int8_t
name|reg76
init|=
name|pci_read_config
argument_list|(
name|children
index|[
name|i
index|]
argument_list|,
literal|0x76
argument_list|,
literal|1
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|reg76
operator|&
literal|0xf0
operator|)
operator|!=
literal|0xd0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Correcting VIA config for southbridge data corruption bug\n"
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|children
index|[
name|i
index|]
argument_list|,
literal|0x75
argument_list|,
literal|0x80
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|children
index|[
name|i
index|]
argument_list|,
literal|0x76
argument_list|,
operator|(
name|reg76
operator|&
literal|0x0f
operator|)
operator||
literal|0xd0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
block|}
name|free
argument_list|(
name|children
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* common code for VIA, AMD& nVidia */
end_comment

begin_function
specifier|static
name|void
name|ata_via_family_setmode
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|device_t
name|gparent
init|=
name|GRANDPARENT
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|gparent
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_device
modifier|*
name|atadev
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|u_int8_t
name|timings
index|[]
init|=
block|{
literal|0xa8
block|,
literal|0x65
block|,
literal|0x42
block|,
literal|0x22
block|,
literal|0x20
block|,
literal|0x42
block|,
literal|0x22
block|,
literal|0x20
block|,
literal|0x20
block|,
literal|0x20
block|,
literal|0x20
block|,
literal|0x20
block|,
literal|0x20
block|,
literal|0x20
block|,
literal|0x20
block|}
decl_stmt|;
name|int
name|modes
index|[]
index|[
literal|7
index|]
init|=
block|{
block|{
literal|0xc2
block|,
literal|0xc1
block|,
literal|0xc0
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|}
block|,
comment|/* VIA ATA33 */
block|{
literal|0xee
block|,
literal|0xec
block|,
literal|0xea
block|,
literal|0xe9
block|,
literal|0xe8
block|,
literal|0x00
block|,
literal|0x00
block|}
block|,
comment|/* VIA ATA66 */
block|{
literal|0xf7
block|,
literal|0xf6
block|,
literal|0xf4
block|,
literal|0xf2
block|,
literal|0xf1
block|,
literal|0xf0
block|,
literal|0x00
block|}
block|,
comment|/* VIA ATA100 */
block|{
literal|0xf7
block|,
literal|0xf7
block|,
literal|0xf6
block|,
literal|0xf4
block|,
literal|0xf2
block|,
literal|0xf1
block|,
literal|0xf0
block|}
block|,
comment|/* VIA ATA133 */
block|{
literal|0xc2
block|,
literal|0xc1
block|,
literal|0xc0
block|,
literal|0xc4
block|,
literal|0xc5
block|,
literal|0xc6
block|,
literal|0xc7
block|}
block|}
decl_stmt|;
comment|/* AMD/nVIDIA */
name|int
name|devno
init|=
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|1
operator|)
operator|+
name|ATA_DEV
argument_list|(
name|atadev
operator|->
name|unit
argument_list|)
decl_stmt|;
name|int
name|reg
init|=
literal|0x53
operator|-
name|devno
decl_stmt|;
name|int
name|error
decl_stmt|;
name|mode
operator|=
name|ata_limit_mode
argument_list|(
name|dev
argument_list|,
name|mode
argument_list|,
name|ctlr
operator|->
name|chip
operator|->
name|max_dma
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|&
name|AMDCABLE
condition|)
block|{
if|if
condition|(
name|mode
operator|>
name|ATA_UDMA2
operator|&&
operator|!
operator|(
name|pci_read_config
argument_list|(
name|gparent
argument_list|,
literal|0x42
argument_list|,
literal|1
argument_list|)
operator|&
operator|(
literal|1
operator|<<
name|devno
operator|)
operator|)
condition|)
block|{
name|ata_print_cable
argument_list|(
name|dev
argument_list|,
literal|"controller"
argument_list|)
expr_stmt|;
name|mode
operator|=
name|ATA_UDMA2
expr_stmt|;
block|}
block|}
else|else
name|mode
operator|=
name|ata_check_80pin
argument_list|(
name|dev
argument_list|,
name|mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|&
name|NVIDIA
condition|)
name|reg
operator|+=
literal|0x10
expr_stmt|;
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg1
operator|!=
name|VIA133
condition|)
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
name|reg
operator|-
literal|0x08
argument_list|,
name|timings
index|[
name|ata_mode2idx
argument_list|(
name|mode
argument_list|)
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|error
operator|=
name|ata_controlcmd
argument_list|(
name|dev
argument_list|,
name|ATA_SETFEATURES
argument_list|,
name|ATA_SF_SETXFER
argument_list|,
literal|0
argument_list|,
name|mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%ssetting %s on %s chip\n"
argument_list|,
operator|(
name|error
operator|)
condition|?
literal|"FAILURE "
else|:
literal|""
argument_list|,
name|ata_mode2str
argument_list|(
name|mode
argument_list|)
argument_list|,
name|ctlr
operator|->
name|chip
operator|->
name|text
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
block|{
if|if
condition|(
name|mode
operator|>=
name|ATA_UDMA0
condition|)
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
name|reg
argument_list|,
name|modes
index|[
name|ctlr
operator|->
name|chip
operator|->
name|cfg1
index|]
index|[
name|mode
operator|&
name|ATA_MODE_MASK
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
else|else
name|pci_write_config
argument_list|(
name|gparent
argument_list|,
name|reg
argument_list|,
literal|0x8b
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|atadev
operator|->
name|mode
operator|=
name|mode
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* misc functions */
end_comment

begin_function
specifier|static
name|void
name|ata_set_desc
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|char
name|buffer
index|[
literal|128
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"%s %s %s controller"
argument_list|,
name|ata_pcivendor2str
argument_list|(
name|dev
argument_list|)
argument_list|,
name|ctlr
operator|->
name|chip
operator|->
name|text
argument_list|,
name|ata_mode2str
argument_list|(
name|ctlr
operator|->
name|chip
operator|->
name|max_dma
argument_list|)
argument_list|)
expr_stmt|;
name|device_set_desc_copy
argument_list|(
name|dev
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|ata_chip_id
modifier|*
name|ata_match_chip
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|struct
name|ata_chip_id
modifier|*
name|index
parameter_list|)
block|{
while|while
condition|(
name|index
operator|->
name|chipid
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|pci_get_devid
argument_list|(
name|dev
argument_list|)
operator|==
name|index
operator|->
name|chipid
operator|&&
name|pci_get_revid
argument_list|(
name|dev
argument_list|)
operator|>=
name|index
operator|->
name|chiprev
condition|)
return|return
name|index
return|;
name|index
operator|++
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|ata_chip_id
modifier|*
name|ata_find_chip
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|struct
name|ata_chip_id
modifier|*
name|index
parameter_list|,
name|int
name|slot
parameter_list|)
block|{
name|device_t
modifier|*
name|children
decl_stmt|;
name|int
name|nchildren
decl_stmt|,
name|i
decl_stmt|;
if|if
condition|(
name|device_get_children
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|,
operator|&
name|children
argument_list|,
operator|&
name|nchildren
argument_list|)
condition|)
return|return
literal|0
return|;
while|while
condition|(
name|index
operator|->
name|chipid
operator|!=
literal|0
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nchildren
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
operator|(
name|slot
operator|>=
literal|0
operator|&&
name|pci_get_slot
argument_list|(
name|children
index|[
name|i
index|]
argument_list|)
operator|==
name|slot
operator|)
operator|||
operator|(
name|slot
operator|<
literal|0
operator|&&
name|pci_get_slot
argument_list|(
name|children
index|[
name|i
index|]
argument_list|)
operator|<=
operator|-
name|slot
operator|)
operator|)
operator|&&
name|pci_get_devid
argument_list|(
name|children
index|[
name|i
index|]
argument_list|)
operator|==
name|index
operator|->
name|chipid
operator|&&
name|pci_get_revid
argument_list|(
name|children
index|[
name|i
index|]
argument_list|)
operator|>=
name|index
operator|->
name|chiprev
condition|)
block|{
name|free
argument_list|(
name|children
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
return|return
name|index
return|;
block|}
block|}
name|index
operator|++
expr_stmt|;
block|}
name|free
argument_list|(
name|children
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_setup_interrupt
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|rid
init|=
name|ATA_IRQ_RID
decl_stmt|;
if|if
condition|(
operator|!
name|ata_legacy
argument_list|(
name|dev
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|ctlr
operator|->
name|r_irq
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
operator|&
name|rid
argument_list|,
name|RF_SHAREABLE
operator||
name|RF_ACTIVE
argument_list|)
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to map interrupt\n"
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
if|if
condition|(
operator|(
name|bus_setup_intr
argument_list|(
name|dev
argument_list|,
name|ctlr
operator|->
name|r_irq
argument_list|,
name|ATA_INTR_FLAGS
argument_list|,
name|NULL
argument_list|,
name|ata_generic_intr
argument_list|,
name|ctlr
argument_list|,
operator|&
name|ctlr
operator|->
name|handle
argument_list|)
operator|)
condition|)
block|{
comment|/* SOS XXX release r_irq */
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to setup interrupt\n"
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_serialize_init
parameter_list|(
name|struct
name|ata_serialize
modifier|*
name|serial
parameter_list|)
block|{
name|mtx_init
argument_list|(
operator|&
name|serial
operator|->
name|locked_mtx
argument_list|,
literal|"ATA serialize lock"
argument_list|,
name|NULL
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
name|serial
operator|->
name|locked_ch
operator|=
operator|-
literal|1
expr_stmt|;
name|serial
operator|->
name|restart_ch
operator|=
operator|-
literal|1
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_serialize
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ata_serialize
modifier|*
name|serial
decl_stmt|;
name|int
name|res
decl_stmt|;
name|serial
operator|=
name|ctlr
operator|->
name|chipset_data
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|serial
operator|->
name|locked_mtx
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|flags
condition|)
block|{
case|case
name|ATA_LF_LOCK
case|:
if|if
condition|(
name|serial
operator|->
name|locked_ch
operator|==
operator|-
literal|1
condition|)
name|serial
operator|->
name|locked_ch
operator|=
name|ch
operator|->
name|unit
expr_stmt|;
if|if
condition|(
name|serial
operator|->
name|locked_ch
operator|!=
name|ch
operator|->
name|unit
condition|)
name|serial
operator|->
name|restart_ch
operator|=
name|ch
operator|->
name|unit
expr_stmt|;
break|break;
case|case
name|ATA_LF_UNLOCK
case|:
if|if
condition|(
name|serial
operator|->
name|locked_ch
operator|==
name|ch
operator|->
name|unit
condition|)
block|{
name|serial
operator|->
name|locked_ch
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|serial
operator|->
name|restart_ch
operator|!=
operator|-
literal|1
condition|)
block|{
if|if
condition|(
operator|(
name|ch
operator|=
name|ctlr
operator|->
name|interrupt
index|[
name|serial
operator|->
name|restart_ch
index|]
operator|.
name|argument
operator|)
condition|)
block|{
name|serial
operator|->
name|restart_ch
operator|=
operator|-
literal|1
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|serial
operator|->
name|locked_mtx
argument_list|)
expr_stmt|;
name|ata_start
argument_list|(
name|ch
operator|->
name|dev
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
block|}
break|break;
case|case
name|ATA_LF_WHICH
case|:
break|break;
block|}
name|res
operator|=
name|serial
operator|->
name|locked_ch
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|serial
operator|->
name|locked_mtx
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_print_cable
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|u_int8_t
modifier|*
name|who
parameter_list|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"DMA limited to UDMA33, %s found non-ATA66 cable\n"
argument_list|,
name|who
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_atapi
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_device
modifier|*
name|atadev
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
return|return
operator|(
operator|(
name|atadev
operator|->
name|unit
operator|==
name|ATA_MASTER
operator|&&
name|ch
operator|->
name|devices
operator|&
name|ATA_ATAPI_MASTER
operator|)
operator|||
operator|(
name|atadev
operator|->
name|unit
operator|==
name|ATA_SLAVE
operator|&&
name|ch
operator|->
name|devices
operator|&
name|ATA_ATAPI_SLAVE
operator|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_check_80pin
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|struct
name|ata_device
modifier|*
name|atadev
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|ata_dma_check_80pin
condition|)
block|{
if|if
condition|(
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Skipping 80pin cable check\n"
argument_list|)
expr_stmt|;
return|return
name|mode
return|;
block|}
if|if
condition|(
name|mode
operator|>
name|ATA_UDMA2
operator|&&
operator|!
operator|(
name|atadev
operator|->
name|param
operator|.
name|hwres
operator|&
name|ATA_CABLE_ID
operator|)
condition|)
block|{
name|ata_print_cable
argument_list|(
name|dev
argument_list|,
literal|"device"
argument_list|)
expr_stmt|;
name|mode
operator|=
name|ATA_UDMA2
expr_stmt|;
block|}
return|return
name|mode
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_mode2idx
parameter_list|(
name|int
name|mode
parameter_list|)
block|{
if|if
condition|(
operator|(
name|mode
operator|&
name|ATA_DMA_MASK
operator|)
operator|==
name|ATA_UDMA0
condition|)
return|return
operator|(
name|mode
operator|&
name|ATA_MODE_MASK
operator|)
operator|+
literal|8
return|;
if|if
condition|(
operator|(
name|mode
operator|&
name|ATA_DMA_MASK
operator|)
operator|==
name|ATA_WDMA0
condition|)
return|return
operator|(
name|mode
operator|&
name|ATA_MODE_MASK
operator|)
operator|+
literal|5
return|;
return|return
operator|(
name|mode
operator|&
name|ATA_MODE_MASK
operator|)
operator|-
name|ATA_PIO0
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 1998,1999,2000,2001,2002 SÃ¸ren Schmidt<sos@FreeBSD.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer,  *    without modification, immediately at the beginning of the file.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. The name of the author may not be used to endorse or promote products  *    derived from this software without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|"opt_ata.h"
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/disk.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/devicestat.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<machine/stdarg.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|__alpha__
end_ifdef

begin_include
include|#
directive|include
file|<machine/md_var.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<pci/pcivar.h>
end_include

begin_include
include|#
directive|include
file|<pci/pcireg.h>
end_include

begin_include
include|#
directive|include
file|<dev/ata/ata-all.h>
end_include

begin_comment
comment|/* device structures */
end_comment

begin_struct
struct|struct
name|ata_pci_controller
block|{
name|struct
name|resource
modifier|*
name|bmio
decl_stmt|;
name|int
name|bmaddr
decl_stmt|;
name|struct
name|resource
modifier|*
name|irq
decl_stmt|;
name|int
name|irqcnt
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* misc defines */
end_comment

begin_define
define|#
directive|define
name|IOMASK
value|0xfffffffc
end_define

begin_define
define|#
directive|define
name|GRANDPARENT
parameter_list|(
name|dev
parameter_list|)
value|device_get_parent(device_get_parent(dev))
end_define

begin_define
define|#
directive|define
name|ATA_MASTERDEV
parameter_list|(
name|dev
parameter_list|)
value|((pci_get_progif(dev)& 0x80)&& \ 				 (pci_get_progif(dev)& 0x05) != 0x05)
end_define

begin_function
name|int
name|ata_find_dev
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|u_int32_t
name|devid
parameter_list|,
name|u_int32_t
name|revid
parameter_list|)
block|{
name|device_t
modifier|*
name|children
decl_stmt|;
name|int
name|nchildren
decl_stmt|,
name|i
decl_stmt|;
if|if
condition|(
name|device_get_children
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|,
operator|&
name|children
argument_list|,
operator|&
name|nchildren
argument_list|)
condition|)
return|return
literal|0
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nchildren
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|pci_get_devid
argument_list|(
name|children
index|[
name|i
index|]
argument_list|)
operator|==
name|devid
operator|&&
name|pci_get_revid
argument_list|(
name|children
index|[
name|i
index|]
argument_list|)
operator|>=
name|revid
condition|)
block|{
name|free
argument_list|(
name|children
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
block|}
name|free
argument_list|(
name|children
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_via_southbridge_fixup
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|device_t
modifier|*
name|children
decl_stmt|;
name|int
name|nchildren
decl_stmt|,
name|i
decl_stmt|;
if|if
condition|(
name|device_get_children
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|,
operator|&
name|children
argument_list|,
operator|&
name|nchildren
argument_list|)
condition|)
return|return;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nchildren
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|pci_get_devid
argument_list|(
name|children
index|[
name|i
index|]
argument_list|)
operator|==
literal|0x03051106
operator|||
comment|/* VIA VT8363 */
name|pci_get_devid
argument_list|(
name|children
index|[
name|i
index|]
argument_list|)
operator|==
literal|0x03911106
operator|||
comment|/* VIA VT8371 */
name|pci_get_devid
argument_list|(
name|children
index|[
name|i
index|]
argument_list|)
operator|==
literal|0x31021106
operator|||
comment|/* VIA VT8662 */
name|pci_get_devid
argument_list|(
name|children
index|[
name|i
index|]
argument_list|)
operator|==
literal|0x31121106
condition|)
block|{
comment|/* VIA VT8361 */
name|u_int8_t
name|reg76
init|=
name|pci_read_config
argument_list|(
name|children
index|[
name|i
index|]
argument_list|,
literal|0x76
argument_list|,
literal|1
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|reg76
operator|&
literal|0xf0
operator|)
operator|!=
literal|0xd0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Correcting VIA config for southbridge data corruption bug\n"
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|children
index|[
name|i
index|]
argument_list|,
literal|0x75
argument_list|,
literal|0x80
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|children
index|[
name|i
index|]
argument_list|,
literal|0x76
argument_list|,
operator|(
name|reg76
operator|&
literal|0x0f
operator|)
operator||
literal|0xd0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
block|}
name|free
argument_list|(
name|children
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|ata_pci_match
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
if|if
condition|(
name|pci_get_class
argument_list|(
name|dev
argument_list|)
operator|!=
name|PCIC_STORAGE
condition|)
return|return
name|NULL
return|;
switch|switch
condition|(
name|pci_get_devid
argument_list|(
name|dev
argument_list|)
condition|)
block|{
comment|/* supported chipsets */
case|case
literal|0x12308086
case|:
return|return
literal|"Intel PIIX ATA controller"
return|;
case|case
literal|0x70108086
case|:
return|return
literal|"Intel PIIX3 ATA controller"
return|;
case|case
literal|0x71118086
case|:
case|case
literal|0x71998086
case|:
case|case
literal|0x84ca8086
case|:
return|return
literal|"Intel PIIX4 ATA33 controller"
return|;
case|case
literal|0x24218086
case|:
return|return
literal|"Intel ICH0 ATA33 controller"
return|;
case|case
literal|0x24118086
case|:
case|case
literal|0x76018086
case|:
return|return
literal|"Intel ICH ATA66 controller"
return|;
case|case
literal|0x244a8086
case|:
case|case
literal|0x244b8086
case|:
return|return
literal|"Intel ICH2 ATA100 controller"
return|;
case|case
literal|0x248a8086
case|:
case|case
literal|0x248b8086
case|:
return|return
literal|"Intel ICH3 ATA100 controller"
return|;
case|case
literal|0x24cb8086
case|:
return|return
literal|"Intel ICH4 ATA100 controller"
return|;
case|case
literal|0x522910b9
case|:
if|if
condition|(
name|pci_get_revid
argument_list|(
name|dev
argument_list|)
operator|>=
literal|0xc4
condition|)
return|return
literal|"AcerLabs Aladdin ATA100 controller"
return|;
elseif|else
if|if
condition|(
name|pci_get_revid
argument_list|(
name|dev
argument_list|)
operator|>=
literal|0xc2
condition|)
return|return
literal|"AcerLabs Aladdin ATA66 controller"
return|;
elseif|else
if|if
condition|(
name|pci_get_revid
argument_list|(
name|dev
argument_list|)
operator|>=
literal|0x20
condition|)
return|return
literal|"AcerLabs Aladdin ATA33 controller"
return|;
else|else
return|return
literal|"AcerLabs Aladdin ATA controller"
return|;
case|case
literal|0x05711106
case|:
if|if
condition|(
name|ata_find_dev
argument_list|(
name|dev
argument_list|,
literal|0x05861106
argument_list|,
literal|0x02
argument_list|)
condition|)
return|return
literal|"VIA 82C586 ATA33 controller"
return|;
if|if
condition|(
name|ata_find_dev
argument_list|(
name|dev
argument_list|,
literal|0x05861106
argument_list|,
literal|0
argument_list|)
condition|)
return|return
literal|"VIA 82C586 ATA controller"
return|;
if|if
condition|(
name|ata_find_dev
argument_list|(
name|dev
argument_list|,
literal|0x05961106
argument_list|,
literal|0x12
argument_list|)
condition|)
return|return
literal|"VIA 82C596 ATA66 controller"
return|;
if|if
condition|(
name|ata_find_dev
argument_list|(
name|dev
argument_list|,
literal|0x05961106
argument_list|,
literal|0
argument_list|)
condition|)
return|return
literal|"VIA 82C596 ATA33 controller"
return|;
if|if
condition|(
name|ata_find_dev
argument_list|(
name|dev
argument_list|,
literal|0x06861106
argument_list|,
literal|0x40
argument_list|)
condition|)
return|return
literal|"VIA 82C686 ATA100 controller"
return|;
if|if
condition|(
name|ata_find_dev
argument_list|(
name|dev
argument_list|,
literal|0x06861106
argument_list|,
literal|0x10
argument_list|)
condition|)
return|return
literal|"VIA 82C686 ATA66 controller"
return|;
if|if
condition|(
name|ata_find_dev
argument_list|(
name|dev
argument_list|,
literal|0x06861106
argument_list|,
literal|0
argument_list|)
condition|)
return|return
literal|"VIA 82C686 ATA33 controller"
return|;
if|if
condition|(
name|ata_find_dev
argument_list|(
name|dev
argument_list|,
literal|0x82311106
argument_list|,
literal|0
argument_list|)
condition|)
return|return
literal|"VIA 8231 ATA100 controller"
return|;
if|if
condition|(
name|ata_find_dev
argument_list|(
name|dev
argument_list|,
literal|0x30741106
argument_list|,
literal|0
argument_list|)
operator|||
name|ata_find_dev
argument_list|(
name|dev
argument_list|,
literal|0x31091106
argument_list|,
literal|0
argument_list|)
condition|)
return|return
literal|"VIA 8233 ATA100 controller"
return|;
if|if
condition|(
name|ata_find_dev
argument_list|(
name|dev
argument_list|,
literal|0x31471106
argument_list|,
literal|0
argument_list|)
condition|)
return|return
literal|"VIA 8233 ATA133 controller"
return|;
if|if
condition|(
name|ata_find_dev
argument_list|(
name|dev
argument_list|,
literal|0x31771106
argument_list|,
literal|0
argument_list|)
condition|)
return|return
literal|"VIA 8235 ATA133 controller"
return|;
return|return
literal|"VIA Apollo ATA controller"
return|;
case|case
literal|0x55131039
case|:
if|if
condition|(
name|ata_find_dev
argument_list|(
name|dev
argument_list|,
literal|0x06301039
argument_list|,
literal|0x30
argument_list|)
operator|||
name|ata_find_dev
argument_list|(
name|dev
argument_list|,
literal|0x06331039
argument_list|,
literal|0
argument_list|)
operator|||
name|ata_find_dev
argument_list|(
name|dev
argument_list|,
literal|0x06351039
argument_list|,
literal|0
argument_list|)
operator|||
name|ata_find_dev
argument_list|(
name|dev
argument_list|,
literal|0x06401039
argument_list|,
literal|0
argument_list|)
operator|||
name|ata_find_dev
argument_list|(
name|dev
argument_list|,
literal|0x06451039
argument_list|,
literal|0
argument_list|)
operator|||
name|ata_find_dev
argument_list|(
name|dev
argument_list|,
literal|0x06501039
argument_list|,
literal|0
argument_list|)
operator|||
name|ata_find_dev
argument_list|(
name|dev
argument_list|,
literal|0x07301039
argument_list|,
literal|0
argument_list|)
operator|||
name|ata_find_dev
argument_list|(
name|dev
argument_list|,
literal|0x07331039
argument_list|,
literal|0
argument_list|)
operator|||
name|ata_find_dev
argument_list|(
name|dev
argument_list|,
literal|0x07351039
argument_list|,
literal|0
argument_list|)
operator|||
name|ata_find_dev
argument_list|(
name|dev
argument_list|,
literal|0x07401039
argument_list|,
literal|0
argument_list|)
operator|||
name|ata_find_dev
argument_list|(
name|dev
argument_list|,
literal|0x07451039
argument_list|,
literal|0
argument_list|)
operator|||
name|ata_find_dev
argument_list|(
name|dev
argument_list|,
literal|0x07501039
argument_list|,
literal|0
argument_list|)
condition|)
return|return
literal|"SiS 5591 ATA100 controller"
return|;
elseif|else
if|if
condition|(
name|ata_find_dev
argument_list|(
name|dev
argument_list|,
literal|0x05301039
argument_list|,
literal|0
argument_list|)
operator|||
name|ata_find_dev
argument_list|(
name|dev
argument_list|,
literal|0x05401039
argument_list|,
literal|0
argument_list|)
operator|||
name|ata_find_dev
argument_list|(
name|dev
argument_list|,
literal|0x06201039
argument_list|,
literal|0
argument_list|)
operator|||
name|ata_find_dev
argument_list|(
name|dev
argument_list|,
literal|0x06301039
argument_list|,
literal|0
argument_list|)
condition|)
return|return
literal|"SiS 5591 ATA66 controller"
return|;
else|else
return|return
literal|"SiS 5591 ATA33 controller"
return|;
case|case
literal|0x06801095
case|:
return|return
literal|"Sil 0680 ATA133 controller"
return|;
case|case
literal|0x06491095
case|:
return|return
literal|"CMD 649 ATA100 controller"
return|;
case|case
literal|0x06481095
case|:
return|return
literal|"CMD 648 ATA66 controller"
return|;
case|case
literal|0x06461095
case|:
return|return
literal|"CMD 646 ATA controller"
return|;
case|case
literal|0xc6931080
case|:
if|if
condition|(
name|pci_get_subclass
argument_list|(
name|dev
argument_list|)
operator|==
name|PCIS_STORAGE_IDE
condition|)
return|return
literal|"Cypress 82C693 ATA controller"
return|;
return|return
name|NULL
return|;
case|case
literal|0x01021078
case|:
return|return
literal|"Cyrix 5530 ATA33 controller"
return|;
case|case
literal|0x74091022
case|:
return|return
literal|"AMD 756 ATA66 controller"
return|;
case|case
literal|0x74111022
case|:
return|return
literal|"AMD 766 ATA100 controller"
return|;
case|case
literal|0x74411022
case|:
return|return
literal|"AMD 768 ATA100 controller"
return|;
case|case
literal|0x01bc10de
case|:
return|return
literal|"nVIDIA nForce ATA100 controller"
return|;
case|case
literal|0x02111166
case|:
return|return
literal|"ServerWorks ROSB4 ATA33 controller"
return|;
case|case
literal|0x02121166
case|:
if|if
condition|(
name|pci_get_revid
argument_list|(
name|dev
argument_list|)
operator|>=
literal|0x92
condition|)
return|return
literal|"ServerWorks CSB5 ATA100 controller"
return|;
else|else
return|return
literal|"ServerWorks CSB5 ATA66 controller"
return|;
case|case
literal|0x4d33105a
case|:
return|return
literal|"Promise ATA33 controller"
return|;
case|case
literal|0x0d38105a
case|:
case|case
literal|0x4d38105a
case|:
return|return
literal|"Promise ATA66 controller"
return|;
case|case
literal|0x0d30105a
case|:
case|case
literal|0x4d30105a
case|:
return|return
literal|"Promise ATA100 controller"
return|;
case|case
literal|0x4d68105a
case|:
case|case
literal|0x6268105a
case|:
if|if
condition|(
name|pci_get_devid
argument_list|(
name|GRANDPARENT
argument_list|(
name|dev
argument_list|)
argument_list|)
operator|==
literal|0x00221011
operator|&&
name|pci_get_class
argument_list|(
name|GRANDPARENT
argument_list|(
name|dev
argument_list|)
argument_list|)
operator|==
name|PCIC_BRIDGE
condition|)
block|{
specifier|static
name|long
name|start
init|=
literal|0
decl_stmt|,
name|end
init|=
literal|0
decl_stmt|;
comment|/* we belive we are on a TX4, now do our (simple) magic */
if|if
condition|(
name|pci_get_slot
argument_list|(
name|dev
argument_list|)
operator|==
literal|1
condition|)
block|{
name|bus_get_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
literal|0
argument_list|,
operator|&
name|start
argument_list|,
operator|&
name|end
argument_list|)
expr_stmt|;
return|return
literal|"Promise TX4 ATA100 controller (channel 0+1)"
return|;
block|}
elseif|else
if|if
condition|(
name|pci_get_slot
argument_list|(
name|dev
argument_list|)
operator|==
literal|2
operator|&&
name|start
operator|&&
name|end
condition|)
block|{
name|bus_set_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
literal|0
argument_list|,
name|start
argument_list|,
name|end
argument_list|)
expr_stmt|;
name|start
operator|=
name|end
operator|=
literal|0
expr_stmt|;
return|return
literal|"Promise TX4 ATA100 controller (channel 2+3)"
return|;
block|}
else|else
name|start
operator|=
name|end
operator|=
literal|0
expr_stmt|;
block|}
return|return
literal|"Promise TX2 ATA100 controller"
return|;
case|case
literal|0x4d69105a
case|:
case|case
literal|0x5275105a
case|:
case|case
literal|0x6269105a
case|:
return|return
literal|"Promise TX2 ATA133 controller"
return|;
case|case
literal|0x00041103
case|:
switch|switch
condition|(
name|pci_get_revid
argument_list|(
name|dev
argument_list|)
condition|)
block|{
case|case
literal|0x00
case|:
case|case
literal|0x01
case|:
return|return
literal|"HighPoint HPT366 ATA66 controller"
return|;
case|case
literal|0x02
case|:
return|return
literal|"HighPoint HPT368 ATA66 controller"
return|;
case|case
literal|0x03
case|:
case|case
literal|0x04
case|:
return|return
literal|"HighPoint HPT370 ATA100 controller"
return|;
case|case
literal|0x05
case|:
return|return
literal|"HighPoint HPT372 ATA133 controller"
return|;
block|}
return|return
name|NULL
return|;
case|case
literal|0x00051103
case|:
switch|switch
condition|(
name|pci_get_revid
argument_list|(
name|dev
argument_list|)
condition|)
block|{
case|case
literal|0x01
case|:
return|return
literal|"HighPoint HPT372 ATA133 controller"
return|;
block|}
return|return
name|NULL
return|;
case|case
literal|0x00081103
case|:
switch|switch
condition|(
name|pci_get_revid
argument_list|(
name|dev
argument_list|)
condition|)
block|{
case|case
literal|0x07
case|:
return|return
literal|"HighPoint HPT374 ATA133 controller"
return|;
block|}
return|return
name|NULL
return|;
case|case
literal|0x000116ca
case|:
return|return
literal|"Cenatek Rocket Drive controller"
return|;
comment|/* unsupported but known chipsets, generic DMA only */
case|case
literal|0x10001042
case|:
case|case
literal|0x10011042
case|:
return|return
literal|"RZ 100? ATA controller !WARNING! buggy chip data loss possible"
return|;
case|case
literal|0x06401095
case|:
return|return
literal|"CMD 640 ATA controller !WARNING! buggy chip data loss possible"
return|;
comment|/* unknown chipsets, try generic DMA if it seems possible */
default|default:
if|if
condition|(
name|pci_get_class
argument_list|(
name|dev
argument_list|)
operator|==
name|PCIC_STORAGE
operator|&&
operator|(
name|pci_get_subclass
argument_list|(
name|dev
argument_list|)
operator|==
name|PCIS_STORAGE_IDE
operator|)
condition|)
return|return
literal|"Generic PCI ATA controller"
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_pci_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|desc
init|=
name|ata_pci_match
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|desc
condition|)
block|{
name|device_set_desc
argument_list|(
name|dev
argument_list|,
name|desc
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
else|else
return|return
name|ENXIO
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_pci_add_child
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|unit
parameter_list|)
block|{
name|device_t
name|child
decl_stmt|;
comment|/* check if this is located at one of the std addresses */
if|if
condition|(
name|ATA_MASTERDEV
argument_list|(
name|dev
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|child
operator|=
name|device_add_child
argument_list|(
name|dev
argument_list|,
literal|"ata"
argument_list|,
name|unit
argument_list|)
operator|)
condition|)
return|return
name|ENOMEM
return|;
block|}
else|else
block|{
if|if
condition|(
operator|!
operator|(
name|child
operator|=
name|device_add_child
argument_list|(
name|dev
argument_list|,
literal|"ata"
argument_list|,
name|devclass_find_free_unit
argument_list|(
name|ata_devclass
argument_list|,
literal|2
argument_list|)
argument_list|)
operator|)
condition|)
return|return
name|ENOMEM
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_pci_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|controller
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|u_int8_t
name|class
decl_stmt|,
name|subclass
decl_stmt|;
name|u_int32_t
name|type
decl_stmt|,
name|cmd
decl_stmt|;
name|int
name|rid
decl_stmt|;
comment|/* set up vendor-specific stuff */
name|type
operator|=
name|pci_get_devid
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|class
operator|=
name|pci_get_class
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|subclass
operator|=
name|pci_get_subclass
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|cmd
operator|=
name|pci_read_config
argument_list|(
name|dev
argument_list|,
name|PCIR_COMMAND
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|cmd
operator|&
name|PCIM_CMD_PORTEN
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"ATA channel disabled by BIOS\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
ifdef|#
directive|ifdef
name|__sparc64__
if|if
condition|(
operator|!
operator|(
name|cmd
operator|&
name|PCIM_CMD_BUSMASTEREN
operator|)
condition|)
block|{
name|pci_write_config
argument_list|(
name|dev
argument_list|,
name|PCIR_COMMAND
argument_list|,
name|cmd
operator||
name|PCIM_CMD_BUSMASTEREN
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|cmd
operator|=
name|pci_read_config
argument_list|(
name|dev
argument_list|,
name|PCIR_COMMAND
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* is busmastering supported ? */
if|if
condition|(
operator|(
name|cmd
operator|&
operator|(
name|PCIM_CMD_PORTEN
operator||
name|PCIM_CMD_BUSMASTEREN
operator|)
operator|)
operator|==
operator|(
name|PCIM_CMD_PORTEN
operator||
name|PCIM_CMD_BUSMASTEREN
operator|)
condition|)
block|{
comment|/* is there a valid port range to connect to ? */
name|rid
operator|=
literal|0x20
expr_stmt|;
name|controller
operator|->
name|bmio
operator|=
name|bus_alloc_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IOPORT
argument_list|,
operator|&
name|rid
argument_list|,
literal|0
argument_list|,
operator|~
literal|0
argument_list|,
literal|1
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|controller
operator|->
name|bmio
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Busmastering DMA not configured\n"
argument_list|)
expr_stmt|;
block|}
else|else
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Busmastering DMA not supported\n"
argument_list|)
expr_stmt|;
comment|/* do extra chipset specific setups */
switch|switch
condition|(
name|type
condition|)
block|{
case|case
literal|0x522910b9
case|:
comment|/* AcerLabs Aladdin need to activate the ATAPI FIFO */
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x53
argument_list|,
operator|(
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x53
argument_list|,
literal|1
argument_list|)
operator|&
operator|~
literal|0x01
operator|)
operator||
literal|0x02
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x0d30105a
case|:
comment|/* Promise 66& 100 (before TX2) need the clock changed */
case|case
literal|0x4d30105a
case|:
case|case
literal|0x0d38105a
case|:
case|case
literal|0x4d38105a
case|:
name|ATA_OUTB
argument_list|(
name|controller
operator|->
name|bmio
argument_list|,
literal|0x11
argument_list|,
name|ATA_INB
argument_list|(
name|controller
operator|->
name|bmio
argument_list|,
literal|0x11
argument_list|)
operator||
literal|0x0a
argument_list|)
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
literal|0x4d33105a
case|:
comment|/* Promise (before TX2) need burst mode turned on */
name|ATA_OUTB
argument_list|(
name|controller
operator|->
name|bmio
argument_list|,
literal|0x1f
argument_list|,
name|ATA_INB
argument_list|(
name|controller
operator|->
name|bmio
argument_list|,
literal|0x1f
argument_list|)
operator||
literal|0x01
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x00041103
case|:
comment|/* HighPoint HPT366/368/370/372 default setup */
if|if
condition|(
name|pci_get_revid
argument_list|(
name|dev
argument_list|)
operator|<
literal|2
condition|)
block|{
comment|/* HPT366 */
comment|/* turn off interrupt prediction */
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x51
argument_list|,
operator|(
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x51
argument_list|,
literal|1
argument_list|)
operator|&
operator|~
literal|0x80
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|pci_get_revid
argument_list|(
name|dev
argument_list|)
operator|<
literal|5
condition|)
block|{
comment|/* HPT368/370 */
comment|/* turn off interrupt prediction */
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x51
argument_list|,
operator|(
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x51
argument_list|,
literal|1
argument_list|)
operator|&
operator|~
literal|0x03
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x55
argument_list|,
operator|(
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x55
argument_list|,
literal|1
argument_list|)
operator|&
operator|~
literal|0x03
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* turn on interrupts */
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x5a
argument_list|,
operator|(
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x5a
argument_list|,
literal|1
argument_list|)
operator|&
operator|~
literal|0x10
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* set clocks etc */
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x5b
argument_list|,
literal|0x22
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* FALLTHROUGH */
case|case
literal|0x00051103
case|:
comment|/* HighPoint HPT372 default setup */
case|case
literal|0x00081103
case|:
comment|/* HighPoint HPT374 default setup */
comment|/* turn off interrupt prediction */
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x51
argument_list|,
operator|(
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x51
argument_list|,
literal|1
argument_list|)
operator|&
operator|~
literal|0x03
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x55
argument_list|,
operator|(
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x55
argument_list|,
literal|1
argument_list|)
operator|&
operator|~
literal|0x03
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* turn on interrupts */
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x5a
argument_list|,
operator|(
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x5a
argument_list|,
literal|1
argument_list|)
operator|&
operator|~
literal|0x10
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* set clocks etc */
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x5b
argument_list|,
operator|(
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x5b
argument_list|,
literal|1
argument_list|)
operator|&
literal|0x01
operator|)
operator||
literal|0x20
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x05711106
case|:
comment|/* VIA 82C586, '596, '686 default setup */
comment|/* prepare for ATA-66 on the 82C686a and 82C596b */
if|if
condition|(
operator|(
name|ata_find_dev
argument_list|(
name|dev
argument_list|,
literal|0x06861106
argument_list|,
literal|0x10
argument_list|)
operator|&&
operator|!
name|ata_find_dev
argument_list|(
name|dev
argument_list|,
literal|0x06861106
argument_list|,
literal|0x40
argument_list|)
operator|)
operator|||
name|ata_find_dev
argument_list|(
name|dev
argument_list|,
literal|0x05961106
argument_list|,
literal|0x12
argument_list|)
condition|)
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x50
argument_list|,
literal|0x030b030b
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/* the southbridge might need the data corruption fix */
if|if
condition|(
name|ata_find_dev
argument_list|(
name|dev
argument_list|,
literal|0x06861106
argument_list|,
literal|0x40
argument_list|)
operator|||
name|ata_find_dev
argument_list|(
name|dev
argument_list|,
literal|0x82311106
argument_list|,
literal|0x10
argument_list|)
condition|)
name|ata_via_southbridge_fixup
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
literal|0x74091022
case|:
comment|/* AMD 756 default setup */
case|case
literal|0x74111022
case|:
comment|/* AMD 766 default setup */
case|case
literal|0x74411022
case|:
comment|/* AMD 768 default setup */
case|case
literal|0x01bc10de
case|:
comment|/* nVIDIA nForce default setup */
comment|/* set prefetch, postwrite */
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x41
argument_list|,
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x41
argument_list|,
literal|1
argument_list|)
operator||
literal|0xf0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* set fifo configuration half'n'half */
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x43
argument_list|,
operator|(
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x43
argument_list|,
literal|1
argument_list|)
operator|&
literal|0x90
operator|)
operator||
literal|0x2a
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* set status register read retry */
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x44
argument_list|,
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x44
argument_list|,
literal|1
argument_list|)
operator||
literal|0x08
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* set DMA read& end-of-sector fifo flush */
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x46
argument_list|,
operator|(
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x46
argument_list|,
literal|1
argument_list|)
operator|&
literal|0x0c
operator|)
operator||
literal|0xf0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* set sector size */
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x60
argument_list|,
name|DEV_BSIZE
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x68
argument_list|,
name|DEV_BSIZE
argument_list|,
literal|2
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x02111166
case|:
comment|/* ServerWorks ROSB4 enable UDMA33 */
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x64
argument_list|,
operator|(
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x64
argument_list|,
literal|4
argument_list|)
operator|&
operator|~
literal|0x00002000
operator|)
operator||
literal|0x00004000
argument_list|,
literal|4
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x02121166
case|:
comment|/* ServerWorks CSB5 enable UDMA66/100 depending on rev */
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x5a
argument_list|,
operator|(
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x5a
argument_list|,
literal|1
argument_list|)
operator|&
operator|~
literal|0x40
operator|)
operator||
operator|(
name|pci_get_revid
argument_list|(
name|dev
argument_list|)
operator|>=
literal|0x92
operator|)
condition|?
literal|0x03
else|:
literal|0x02
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x06801095
case|:
comment|/* Sil 0680 set ATA reference clock speed */
if|if
condition|(
operator|(
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x8a
argument_list|,
literal|1
argument_list|)
operator|&
literal|0x30
operator|)
operator|!=
literal|0x10
condition|)
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x8a
argument_list|,
operator|(
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x8a
argument_list|,
literal|1
argument_list|)
operator|&
literal|0x0F
operator|)
operator||
literal|0x10
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x8a
argument_list|,
literal|1
argument_list|)
operator|&
literal|0x30
operator|)
operator|!=
literal|0x10
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Sil 0680 could not set clock\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x06461095
case|:
comment|/* CMD 646 enable interrupts, set DMA read mode */
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x71
argument_list|,
literal|0x01
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x10001042
case|:
comment|/* RZ 100? known bad, no DMA */
case|case
literal|0x10011042
case|:
case|case
literal|0x06401095
case|:
comment|/* CMD 640 known bad, no DMA */
name|controller
operator|->
name|bmio
operator|=
name|NULL
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Busmastering DMA disabled\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|controller
operator|->
name|bmio
condition|)
block|{
name|controller
operator|->
name|bmaddr
operator|=
name|rman_get_start
argument_list|(
name|controller
operator|->
name|bmio
argument_list|)
expr_stmt|;
name|BUS_RELEASE_RESOURCE
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|,
name|dev
argument_list|,
name|SYS_RES_IOPORT
argument_list|,
name|rid
argument_list|,
name|controller
operator|->
name|bmio
argument_list|)
expr_stmt|;
name|controller
operator|->
name|bmio
operator|=
name|NULL
expr_stmt|;
block|}
comment|/*      * the Cypress chip is a mess, it contains two ATA functions, but       * both channels are visible on the first one.      * simply ignore the second function for now, as the right      * solution (ignoring the second channel on the first function)      * doesn't work with the crappy ATA interrupt setup on the alpha.      */
if|if
condition|(
name|pci_get_devid
argument_list|(
name|dev
argument_list|)
operator|==
literal|0xc6931080
operator|&&
name|pci_get_function
argument_list|(
name|dev
argument_list|)
operator|>
literal|1
condition|)
return|return
literal|0
return|;
name|ata_pci_add_child
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ATA_MASTERDEV
argument_list|(
name|dev
argument_list|)
operator|||
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x18
argument_list|,
literal|4
argument_list|)
operator|&
name|IOMASK
condition|)
name|ata_pci_add_child
argument_list|(
name|dev
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|bus_generic_attach
argument_list|(
name|dev
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_pci_intr
parameter_list|(
name|struct
name|ata_channel
modifier|*
name|ch
parameter_list|)
block|{
name|u_int8_t
name|dmastat
decl_stmt|;
comment|/*       * since we might share the IRQ with another device, and in some      * cases with our twin channel, we only want to process interrupts      * that we know this channel generated.      */
switch|switch
condition|(
name|ch
operator|->
name|chiptype
condition|)
block|{
case|case
literal|0x00041103
case|:
comment|/* HighPoint HPT366/368/370/372 */
case|case
literal|0x00051103
case|:
comment|/* HighPoint HPT372 */
case|case
literal|0x00081103
case|:
comment|/* HighPoint HPT374 */
if|if
condition|(
operator|(
operator|(
name|dmastat
operator|=
name|ata_dmastatus
argument_list|(
name|ch
argument_list|)
operator|)
operator|&
operator|(
name|ATA_BMSTAT_ACTIVE
operator||
name|ATA_BMSTAT_INTERRUPT
operator|)
operator|)
operator|!=
name|ATA_BMSTAT_INTERRUPT
condition|)
return|return
literal|1
return|;
name|ATA_OUTB
argument_list|(
name|ch
operator|->
name|r_bmio
argument_list|,
name|ATA_BMSTAT_PORT
argument_list|,
name|dmastat
operator||
name|ATA_BMSTAT_INTERRUPT
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
literal|0x06481095
case|:
comment|/* CMD 648 */
case|case
literal|0x06491095
case|:
comment|/* CMD 649 */
if|if
condition|(
operator|!
operator|(
name|pci_read_config
argument_list|(
name|device_get_parent
argument_list|(
name|ch
operator|->
name|dev
argument_list|)
argument_list|,
literal|0x71
argument_list|,
literal|1
argument_list|)
operator|&
operator|(
name|ch
operator|->
name|unit
condition|?
literal|0x08
else|:
literal|0x04
operator|)
operator|)
condition|)
return|return
literal|1
return|;
break|break;
case|case
literal|0x4d33105a
case|:
comment|/* Promise Ultra/Fasttrak 33 */
case|case
literal|0x0d38105a
case|:
comment|/* Promise Fasttrak 66 */
case|case
literal|0x4d38105a
case|:
comment|/* Promise Ultra/Fasttrak 66 */
case|case
literal|0x0d30105a
case|:
comment|/* Promise OEM ATA100 */
case|case
literal|0x4d30105a
case|:
comment|/* Promise Ultra/Fasttrak 100 */
if|if
condition|(
operator|!
operator|(
name|ATA_INL
argument_list|(
name|ch
operator|->
name|r_bmio
argument_list|,
operator|(
name|ch
operator|->
name|unit
condition|?
literal|0x14
else|:
literal|0x1c
operator|)
argument_list|)
operator|&
operator|(
name|ch
operator|->
name|unit
condition|?
literal|0x00004000
else|:
literal|0x00000400
operator|)
operator|)
condition|)
return|return
literal|1
return|;
break|break;
case|case
literal|0x4d68105a
case|:
comment|/* Promise TX2 ATA100 */
case|case
literal|0x6268105a
case|:
comment|/* Promise TX2 ATA100 */
case|case
literal|0x4d69105a
case|:
comment|/* Promise TX2 ATA133 */
case|case
literal|0x5275105a
case|:
comment|/* Promise TX2 ATA133 */
case|case
literal|0x6269105a
case|:
comment|/* Promise TX2 ATA133 */
name|ATA_OUTB
argument_list|(
name|ch
operator|->
name|r_bmio
argument_list|,
name|ATA_BMDEVSPEC_0
argument_list|,
literal|0x0b
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ATA_INB
argument_list|(
name|ch
operator|->
name|r_bmio
argument_list|,
name|ATA_BMDEVSPEC_1
argument_list|)
operator|&
literal|0x20
operator|)
condition|)
return|return
literal|1
return|;
break|break;
block|}
if|if
condition|(
name|ch
operator|->
name|flags
operator|&
name|ATA_DMA_ACTIVE
condition|)
block|{
if|if
condition|(
operator|!
operator|(
operator|(
name|dmastat
operator|=
name|ata_dmastatus
argument_list|(
name|ch
argument_list|)
operator|)
operator|&
name|ATA_BMSTAT_INTERRUPT
operator|)
condition|)
return|return
literal|1
return|;
name|ATA_OUTB
argument_list|(
name|ch
operator|->
name|r_bmio
argument_list|,
name|ATA_BMSTAT_PORT
argument_list|,
name|dmastat
operator||
name|ATA_BMSTAT_INTERRUPT
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_pci_print_child
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|device_t
name|child
parameter_list|)
block|{
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|child
argument_list|)
decl_stmt|;
name|int
name|retval
init|=
literal|0
decl_stmt|;
name|retval
operator|+=
name|bus_print_child_header
argument_list|(
name|dev
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|retval
operator|+=
name|printf
argument_list|(
literal|": at 0x%lx"
argument_list|,
name|rman_get_start
argument_list|(
name|ch
operator|->
name|r_io
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ATA_MASTERDEV
argument_list|(
name|dev
argument_list|)
condition|)
name|retval
operator|+=
name|printf
argument_list|(
literal|" irq %d"
argument_list|,
literal|14
operator|+
name|ch
operator|->
name|unit
argument_list|)
expr_stmt|;
name|retval
operator|+=
name|bus_print_child_footer
argument_list|(
name|dev
argument_list|,
name|child
argument_list|)
expr_stmt|;
return|return
name|retval
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|resource
modifier|*
name|ata_pci_alloc_resource
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|device_t
name|child
parameter_list|,
name|int
name|type
parameter_list|,
name|int
modifier|*
name|rid
parameter_list|,
name|u_long
name|start
parameter_list|,
name|u_long
name|end
parameter_list|,
name|u_long
name|count
parameter_list|,
name|u_int
name|flags
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|controller
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|resource
modifier|*
name|res
init|=
name|NULL
decl_stmt|;
name|int
name|unit
init|=
operator|(
operator|(
expr|struct
name|ata_channel
operator|*
operator|)
name|device_get_softc
argument_list|(
name|child
argument_list|)
operator|)
operator|->
name|unit
decl_stmt|;
name|int
name|myrid
decl_stmt|;
if|if
condition|(
name|type
operator|==
name|SYS_RES_IOPORT
condition|)
block|{
switch|switch
condition|(
operator|*
name|rid
condition|)
block|{
case|case
name|ATA_IOADDR_RID
case|:
if|if
condition|(
name|ATA_MASTERDEV
argument_list|(
name|dev
argument_list|)
condition|)
block|{
name|myrid
operator|=
literal|0
expr_stmt|;
name|start
operator|=
operator|(
name|unit
condition|?
name|ATA_SECONDARY
else|:
name|ATA_PRIMARY
operator|)
expr_stmt|;
name|end
operator|=
name|start
operator|+
name|ATA_IOSIZE
operator|-
literal|1
expr_stmt|;
name|count
operator|=
name|ATA_IOSIZE
expr_stmt|;
name|res
operator|=
name|BUS_ALLOC_RESOURCE
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|,
name|child
argument_list|,
name|SYS_RES_IOPORT
argument_list|,
operator|&
name|myrid
argument_list|,
name|start
argument_list|,
name|end
argument_list|,
name|count
argument_list|,
name|flags
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|myrid
operator|=
literal|0x10
operator|+
literal|8
operator|*
name|unit
expr_stmt|;
name|res
operator|=
name|BUS_ALLOC_RESOURCE
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|,
name|dev
argument_list|,
name|SYS_RES_IOPORT
argument_list|,
operator|&
name|myrid
argument_list|,
name|start
argument_list|,
name|end
argument_list|,
name|count
argument_list|,
name|flags
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|ATA_ALTADDR_RID
case|:
if|if
condition|(
name|ATA_MASTERDEV
argument_list|(
name|dev
argument_list|)
condition|)
block|{
name|myrid
operator|=
literal|0
expr_stmt|;
name|start
operator|=
operator|(
name|unit
condition|?
name|ATA_SECONDARY
else|:
name|ATA_PRIMARY
operator|)
operator|+
name|ATA_ALTOFFSET
expr_stmt|;
name|end
operator|=
name|start
operator|+
name|ATA_ALTIOSIZE
operator|-
literal|1
expr_stmt|;
name|count
operator|=
name|ATA_ALTIOSIZE
expr_stmt|;
name|res
operator|=
name|BUS_ALLOC_RESOURCE
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|,
name|child
argument_list|,
name|SYS_RES_IOPORT
argument_list|,
operator|&
name|myrid
argument_list|,
name|start
argument_list|,
name|end
argument_list|,
name|count
argument_list|,
name|flags
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|myrid
operator|=
literal|0x14
operator|+
literal|8
operator|*
name|unit
expr_stmt|;
name|res
operator|=
name|BUS_ALLOC_RESOURCE
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|,
name|dev
argument_list|,
name|SYS_RES_IOPORT
argument_list|,
operator|&
name|myrid
argument_list|,
name|start
argument_list|,
name|end
argument_list|,
name|count
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
condition|)
block|{
name|start
operator|=
name|rman_get_start
argument_list|(
name|res
argument_list|)
operator|+
literal|2
expr_stmt|;
name|end
operator|=
name|start
operator|+
name|ATA_ALTIOSIZE
operator|-
literal|1
expr_stmt|;
name|count
operator|=
name|ATA_ALTIOSIZE
expr_stmt|;
name|BUS_RELEASE_RESOURCE
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|,
name|dev
argument_list|,
name|SYS_RES_IOPORT
argument_list|,
name|myrid
argument_list|,
name|res
argument_list|)
expr_stmt|;
name|res
operator|=
name|BUS_ALLOC_RESOURCE
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|,
name|dev
argument_list|,
name|SYS_RES_IOPORT
argument_list|,
operator|&
name|myrid
argument_list|,
name|start
argument_list|,
name|end
argument_list|,
name|count
argument_list|,
name|flags
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
case|case
name|ATA_BMADDR_RID
case|:
if|if
condition|(
name|controller
operator|->
name|bmaddr
condition|)
block|{
name|myrid
operator|=
literal|0x20
expr_stmt|;
name|start
operator|=
operator|(
name|unit
operator|==
literal|0
condition|?
name|controller
operator|->
name|bmaddr
else|:
name|controller
operator|->
name|bmaddr
operator|+
name|ATA_BMIOSIZE
operator|)
expr_stmt|;
name|end
operator|=
name|start
operator|+
name|ATA_BMIOSIZE
operator|-
literal|1
expr_stmt|;
name|count
operator|=
name|ATA_BMIOSIZE
expr_stmt|;
name|res
operator|=
name|BUS_ALLOC_RESOURCE
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|,
name|child
argument_list|,
name|SYS_RES_IOPORT
argument_list|,
operator|&
name|myrid
argument_list|,
name|start
argument_list|,
name|end
argument_list|,
name|count
argument_list|,
name|flags
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|res
return|;
block|}
if|if
condition|(
name|type
operator|==
name|SYS_RES_IRQ
operator|&&
operator|*
name|rid
operator|==
name|ATA_IRQ_RID
condition|)
block|{
if|if
condition|(
name|ATA_MASTERDEV
argument_list|(
name|dev
argument_list|)
condition|)
block|{
ifdef|#
directive|ifdef
name|__alpha__
return|return
name|alpha_platform_alloc_ide_intr
argument_list|(
name|unit
argument_list|)
return|;
else|#
directive|else
name|int
name|irq
init|=
operator|(
name|unit
operator|==
literal|0
condition|?
literal|14
else|:
literal|15
operator|)
decl_stmt|;
return|return
name|BUS_ALLOC_RESOURCE
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|,
name|child
argument_list|,
name|SYS_RES_IRQ
argument_list|,
name|rid
argument_list|,
name|irq
argument_list|,
name|irq
argument_list|,
literal|1
argument_list|,
name|flags
argument_list|)
return|;
endif|#
directive|endif
block|}
else|else
block|{
comment|/* primary and secondary channels share interrupt, keep track */
if|if
condition|(
operator|!
name|controller
operator|->
name|irq
condition|)
name|controller
operator|->
name|irq
operator|=
name|BUS_ALLOC_RESOURCE
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|,
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
name|rid
argument_list|,
literal|0
argument_list|,
operator|~
literal|0
argument_list|,
literal|1
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|controller
operator|->
name|irqcnt
operator|++
expr_stmt|;
return|return
name|controller
operator|->
name|irq
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_pci_release_resource
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|device_t
name|child
parameter_list|,
name|int
name|type
parameter_list|,
name|int
name|rid
parameter_list|,
name|struct
name|resource
modifier|*
name|r
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|controller
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|unit
init|=
operator|(
operator|(
expr|struct
name|ata_channel
operator|*
operator|)
name|device_get_softc
argument_list|(
name|child
argument_list|)
operator|)
operator|->
name|unit
decl_stmt|;
if|if
condition|(
name|type
operator|==
name|SYS_RES_IOPORT
condition|)
block|{
switch|switch
condition|(
name|rid
condition|)
block|{
case|case
name|ATA_IOADDR_RID
case|:
if|if
condition|(
name|ATA_MASTERDEV
argument_list|(
name|dev
argument_list|)
condition|)
return|return
name|BUS_RELEASE_RESOURCE
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|,
name|child
argument_list|,
name|SYS_RES_IOPORT
argument_list|,
literal|0x0
argument_list|,
name|r
argument_list|)
return|;
else|else
return|return
name|BUS_RELEASE_RESOURCE
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|,
name|dev
argument_list|,
name|SYS_RES_IOPORT
argument_list|,
literal|0x10
operator|+
literal|8
operator|*
name|unit
argument_list|,
name|r
argument_list|)
return|;
break|break;
case|case
name|ATA_ALTADDR_RID
case|:
if|if
condition|(
name|ATA_MASTERDEV
argument_list|(
name|dev
argument_list|)
condition|)
return|return
name|BUS_RELEASE_RESOURCE
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|,
name|child
argument_list|,
name|SYS_RES_IOPORT
argument_list|,
literal|0x0
argument_list|,
name|r
argument_list|)
return|;
else|else
return|return
name|BUS_RELEASE_RESOURCE
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|,
name|dev
argument_list|,
name|SYS_RES_IOPORT
argument_list|,
literal|0x14
operator|+
literal|8
operator|*
name|unit
argument_list|,
name|r
argument_list|)
return|;
break|break;
case|case
name|ATA_BMADDR_RID
case|:
return|return
name|BUS_RELEASE_RESOURCE
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|,
name|child
argument_list|,
name|SYS_RES_IOPORT
argument_list|,
literal|0x20
argument_list|,
name|r
argument_list|)
return|;
default|default:
return|return
name|ENOENT
return|;
block|}
block|}
if|if
condition|(
name|type
operator|==
name|SYS_RES_IRQ
condition|)
block|{
if|if
condition|(
name|rid
operator|!=
name|ATA_IRQ_RID
condition|)
return|return
name|ENOENT
return|;
if|if
condition|(
name|ATA_MASTERDEV
argument_list|(
name|dev
argument_list|)
condition|)
block|{
ifdef|#
directive|ifdef
name|__alpha__
return|return
name|alpha_platform_release_ide_intr
argument_list|(
name|unit
argument_list|,
name|r
argument_list|)
return|;
else|#
directive|else
return|return
name|BUS_RELEASE_RESOURCE
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|,
name|child
argument_list|,
name|SYS_RES_IRQ
argument_list|,
name|rid
argument_list|,
name|r
argument_list|)
return|;
endif|#
directive|endif
block|}
else|else
block|{
comment|/* primary and secondary channels share interrupt, keep track */
if|if
condition|(
operator|--
name|controller
operator|->
name|irqcnt
condition|)
return|return
literal|0
return|;
name|controller
operator|->
name|irq
operator|=
name|NULL
expr_stmt|;
return|return
name|BUS_RELEASE_RESOURCE
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|,
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
name|rid
argument_list|,
name|r
argument_list|)
return|;
block|}
block|}
return|return
name|EINVAL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_pci_setup_intr
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|device_t
name|child
parameter_list|,
name|struct
name|resource
modifier|*
name|irq
parameter_list|,
name|int
name|flags
parameter_list|,
name|driver_intr_t
modifier|*
name|intr
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|,
name|void
modifier|*
modifier|*
name|cookiep
parameter_list|)
block|{
if|if
condition|(
name|ATA_MASTERDEV
argument_list|(
name|dev
argument_list|)
condition|)
block|{
ifdef|#
directive|ifdef
name|__alpha__
return|return
name|alpha_platform_setup_ide_intr
argument_list|(
name|child
argument_list|,
name|irq
argument_list|,
name|intr
argument_list|,
name|arg
argument_list|,
name|cookiep
argument_list|)
return|;
else|#
directive|else
return|return
name|BUS_SETUP_INTR
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|,
name|child
argument_list|,
name|irq
argument_list|,
name|flags
argument_list|,
name|intr
argument_list|,
name|arg
argument_list|,
name|cookiep
argument_list|)
return|;
endif|#
directive|endif
block|}
else|else
return|return
name|BUS_SETUP_INTR
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|,
name|dev
argument_list|,
name|irq
argument_list|,
name|flags
argument_list|,
name|intr
argument_list|,
name|arg
argument_list|,
name|cookiep
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_pci_teardown_intr
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|device_t
name|child
parameter_list|,
name|struct
name|resource
modifier|*
name|irq
parameter_list|,
name|void
modifier|*
name|cookie
parameter_list|)
block|{
if|if
condition|(
name|ATA_MASTERDEV
argument_list|(
name|dev
argument_list|)
condition|)
block|{
ifdef|#
directive|ifdef
name|__alpha__
return|return
name|alpha_platform_teardown_ide_intr
argument_list|(
name|child
argument_list|,
name|irq
argument_list|,
name|cookie
argument_list|)
return|;
else|#
directive|else
return|return
name|BUS_TEARDOWN_INTR
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|,
name|child
argument_list|,
name|irq
argument_list|,
name|cookie
argument_list|)
return|;
endif|#
directive|endif
block|}
else|else
return|return
name|BUS_TEARDOWN_INTR
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|,
name|dev
argument_list|,
name|irq
argument_list|,
name|cookie
argument_list|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|device_method_t
name|ata_pci_methods
index|[]
init|=
block|{
comment|/* device interface */
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|ata_pci_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|ata_pci_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_shutdown
argument_list|,
name|bus_generic_shutdown
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_suspend
argument_list|,
name|bus_generic_suspend
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_resume
argument_list|,
name|bus_generic_resume
argument_list|)
block|,
comment|/* bus methods */
name|DEVMETHOD
argument_list|(
name|bus_print_child
argument_list|,
name|ata_pci_print_child
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|bus_alloc_resource
argument_list|,
name|ata_pci_alloc_resource
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|bus_release_resource
argument_list|,
name|ata_pci_release_resource
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|bus_activate_resource
argument_list|,
name|bus_generic_activate_resource
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|bus_deactivate_resource
argument_list|,
name|bus_generic_deactivate_resource
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|bus_setup_intr
argument_list|,
name|ata_pci_setup_intr
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|bus_teardown_intr
argument_list|,
name|ata_pci_teardown_intr
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|ata_pci_driver
init|=
block|{
literal|"atapci"
block|,
name|ata_pci_methods
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|ata_pci_controller
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|ata_pci_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|atapci
argument_list|,
name|pci
argument_list|,
name|ata_pci_driver
argument_list|,
name|ata_pci_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|int
name|ata_pcisub_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|device_t
modifier|*
name|children
decl_stmt|;
name|int
name|count
decl_stmt|,
name|i
decl_stmt|;
comment|/* find channel number on this controller */
name|device_get_children
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|,
operator|&
name|children
argument_list|,
operator|&
name|count
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|children
index|[
name|i
index|]
operator|==
name|dev
condition|)
name|ch
operator|->
name|unit
operator|=
name|i
expr_stmt|;
block|}
name|free
argument_list|(
name|children
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
name|ch
operator|->
name|chiptype
operator|=
name|pci_get_devid
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
name|ch
operator|->
name|intr_func
operator|=
name|ata_pci_intr
expr_stmt|;
return|return
name|ata_probe
argument_list|(
name|dev
argument_list|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|device_method_t
name|ata_pcisub_methods
index|[]
init|=
block|{
comment|/* device interface */
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|ata_pcisub_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|ata_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|ata_detach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_resume
argument_list|,
name|ata_resume
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|ata_pcisub_driver
init|=
block|{
literal|"ata"
block|,
name|ata_pcisub_methods
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|ata_channel
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|ata
argument_list|,
name|atapci
argument_list|,
name|ata_pcisub_driver
argument_list|,
name|ata_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


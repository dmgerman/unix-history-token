begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (C) 2013 Emulex  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions are met:  *  * 1. Redistributions of source code must retain the above copyright notice,  *    this list of conditions and the following disclaimer.  *  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * 3. Neither the name of the Emulex Corporation nor the names of its  *    contributors may be used to endorse or promote products derived from  *    this software without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE  * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE  * POSSIBILITY OF SUCH DAMAGE.  *  * Contact Information:  * freebsd-drivers@emulex.com  *  * Emulex  * 3333 Susan Street  * Costa Mesa, CA 92626  */
end_comment

begin_comment
comment|/* $FreeBSD$ */
end_comment

begin_include
include|#
directive|include
file|"oce_if.h"
end_include

begin_function_decl
specifier|static
name|void
name|copy_stats_to_sc_xe201
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|copy_stats_to_sc_be3
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|copy_stats_to_sc_be2
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|oce_sysctl_loopback
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|oce_sys_aic_enable
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|oce_be3_fwupgrade
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
specifier|const
name|struct
name|firmware
modifier|*
name|fw
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|oce_skyhawk_fwupgrade
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
specifier|const
name|struct
name|firmware
modifier|*
name|fw
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|oce_sys_fwupgrade
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|oce_lancer_fwupgrade
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
specifier|const
name|struct
name|firmware
modifier|*
name|fw
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|oce_sysctl_sfp_vpd_dump
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|boolean_t
name|oce_phy_flashing_required
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|boolean_t
name|oce_img_flashing_required
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
specifier|const
name|char
modifier|*
name|p
parameter_list|,
name|int
name|img_optype
parameter_list|,
name|uint32_t
name|img_offset
parameter_list|,
name|uint32_t
name|img_size
parameter_list|,
name|uint32_t
name|hdrs_size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|oce_add_stats_sysctls_be3
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
name|struct
name|sysctl_ctx_list
modifier|*
name|ctx
parameter_list|,
name|struct
name|sysctl_oid
modifier|*
name|stats_node
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|oce_add_stats_sysctls_xe201
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
name|struct
name|sysctl_ctx_list
modifier|*
name|ctx
parameter_list|,
name|struct
name|sysctl_oid
modifier|*
name|stats_node
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|extern
name|char
name|component_revision
index|[
literal|32
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|uint32_t
name|sfp_vpd_dump_buffer
index|[
name|TRANSCEIVER_DATA_NUM_ELE
index|]
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|flash_img_attri
block|{
name|int
name|img_offset
decl_stmt|;
name|int
name|img_size
decl_stmt|;
name|int
name|img_type
decl_stmt|;
name|bool
name|skip_image
decl_stmt|;
name|int
name|optype
decl_stmt|;
block|}
struct|;
end_struct

begin_function
name|void
name|oce_add_sysctls
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|)
block|{
name|struct
name|sysctl_ctx_list
modifier|*
name|ctx
init|=
name|device_get_sysctl_ctx
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
decl_stmt|;
name|struct
name|sysctl_oid
modifier|*
name|tree
init|=
name|device_get_sysctl_tree
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
decl_stmt|;
name|struct
name|sysctl_oid_list
modifier|*
name|child
init|=
name|SYSCTL_CHILDREN
argument_list|(
name|tree
argument_list|)
decl_stmt|;
name|struct
name|sysctl_oid
modifier|*
name|stats_node
decl_stmt|;
name|SYSCTL_ADD_STRING
argument_list|(
name|ctx
argument_list|,
name|child
argument_list|,
name|OID_AUTO
argument_list|,
literal|"component_revision"
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|component_revision
argument_list|,
sizeof|sizeof
argument_list|(
name|component_revision
argument_list|)
argument_list|,
literal|"EMULEX One-Connect device driver revision"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_STRING
argument_list|(
name|ctx
argument_list|,
name|child
argument_list|,
name|OID_AUTO
argument_list|,
literal|"firmware_version"
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|sc
operator|->
name|fw_version
argument_list|,
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|fw_version
argument_list|)
argument_list|,
literal|"EMULEX One-Connect Firmware Version"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_INT
argument_list|(
name|ctx
argument_list|,
name|child
argument_list|,
name|OID_AUTO
argument_list|,
literal|"max_rsp_handled"
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|oce_max_rsp_handled
argument_list|,
sizeof|sizeof
argument_list|(
name|oce_max_rsp_handled
argument_list|)
argument_list|,
literal|"Maximum receive frames handled per interupt"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sc
operator|->
name|function_mode
operator|&
name|FNM_FLEX10_MODE
operator|)
operator|||
operator|(
name|sc
operator|->
name|function_mode
operator|&
name|FNM_UMC_MODE
operator|)
condition|)
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|child
argument_list|,
name|OID_AUTO
argument_list|,
literal|"speed"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|qos_link_speed
argument_list|,
literal|0
argument_list|,
literal|"QOS Speed"
argument_list|)
expr_stmt|;
else|else
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|child
argument_list|,
name|OID_AUTO
argument_list|,
literal|"speed"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|speed
argument_list|,
literal|0
argument_list|,
literal|"Link Speed"
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|function_mode
operator|&
name|FNM_UMC_MODE
condition|)
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|child
argument_list|,
name|OID_AUTO
argument_list|,
literal|"pvid"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|pvid
argument_list|,
literal|0
argument_list|,
literal|"PVID"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
name|ctx
argument_list|,
name|child
argument_list|,
name|OID_AUTO
argument_list|,
literal|"loop_back"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RW
argument_list|,
operator|(
name|void
operator|*
operator|)
name|sc
argument_list|,
literal|0
argument_list|,
name|oce_sysctl_loopback
argument_list|,
literal|"I"
argument_list|,
literal|"Loop Back Tests"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
name|ctx
argument_list|,
name|child
argument_list|,
name|OID_AUTO
argument_list|,
literal|"fw_upgrade"
argument_list|,
name|CTLTYPE_STRING
operator||
name|CTLFLAG_RW
argument_list|,
operator|(
name|void
operator|*
operator|)
name|sc
argument_list|,
literal|0
argument_list|,
name|oce_sys_fwupgrade
argument_list|,
literal|"A"
argument_list|,
literal|"Firmware ufi file"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
name|ctx
argument_list|,
name|child
argument_list|,
name|OID_AUTO
argument_list|,
literal|"aic_enable"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RW
argument_list|,
operator|(
name|void
operator|*
operator|)
name|sc
argument_list|,
literal|1
argument_list|,
name|oce_sys_aic_enable
argument_list|,
literal|"I"
argument_list|,
literal|"aic flags"
argument_list|)
expr_stmt|;
comment|/*          *  Dumps Transceiver data 	 *  "sysctl dev.oce.0.sfp_vpd_dump=0"          *  "sysctl -x dev.oce.0.sfp_vpd_dump_buffer" for hex dump          *  "sysctl -b dev.oce.0.sfp_vpd_dump_buffer> sfp.bin" for binary dump          */
name|SYSCTL_ADD_PROC
argument_list|(
name|ctx
argument_list|,
name|child
argument_list|,
name|OID_AUTO
argument_list|,
literal|"sfp_vpd_dump"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RW
argument_list|,
operator|(
name|void
operator|*
operator|)
name|sc
argument_list|,
literal|0
argument_list|,
name|oce_sysctl_sfp_vpd_dump
argument_list|,
literal|"I"
argument_list|,
literal|"Initiate a sfp_vpd_dump operation"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_OPAQUE
argument_list|(
name|ctx
argument_list|,
name|child
argument_list|,
name|OID_AUTO
argument_list|,
literal|"sfp_vpd_dump_buffer"
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|sfp_vpd_dump_buffer
argument_list|,
name|TRANSCEIVER_DATA_SIZE
argument_list|,
literal|"IU"
argument_list|,
literal|"Access sfp_vpd_dump buffer"
argument_list|)
expr_stmt|;
name|stats_node
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
name|ctx
argument_list|,
name|child
argument_list|,
name|OID_AUTO
argument_list|,
literal|"stats"
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|NULL
argument_list|,
literal|"Ethernet Statistics"
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_BE
argument_list|(
name|sc
argument_list|)
operator|||
name|IS_SH
argument_list|(
name|sc
argument_list|)
condition|)
name|oce_add_stats_sysctls_be3
argument_list|(
name|sc
argument_list|,
name|ctx
argument_list|,
name|stats_node
argument_list|)
expr_stmt|;
else|else
name|oce_add_stats_sysctls_xe201
argument_list|(
name|sc
argument_list|,
name|ctx
argument_list|,
name|stats_node
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|oce_loopback_test
parameter_list|(
name|struct
name|oce_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|loopback_type
parameter_list|)
block|{
name|uint32_t
name|status
init|=
literal|0
decl_stmt|;
name|oce_mbox_cmd_set_loopback
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|port_id
argument_list|,
name|loopback_type
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|status
operator|=
name|oce_mbox_cmd_test_loopback
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|port_id
argument_list|,
name|loopback_type
argument_list|,
literal|1500
argument_list|,
literal|2
argument_list|,
literal|0xabc
argument_list|)
expr_stmt|;
name|oce_mbox_cmd_set_loopback
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|port_id
argument_list|,
name|OCE_NO_LOOPBACK
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|oce_sys_aic_enable
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|int
name|value
init|=
literal|0
decl_stmt|;
name|uint32_t
name|status
decl_stmt|,
name|vector
decl_stmt|;
name|POCE_SOFTC
name|sc
init|=
operator|(
expr|struct
name|oce_softc
operator|*
operator|)
name|arg1
decl_stmt|;
name|struct
name|oce_aic_obj
modifier|*
name|aic
decl_stmt|;
name|status
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|value
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|||
operator|!
name|req
operator|->
name|newptr
condition|)
return|return
name|status
return|;
for|for
control|(
name|vector
operator|=
literal|0
init|;
name|vector
operator|<
name|sc
operator|->
name|intr_count
condition|;
name|vector
operator|++
control|)
block|{
name|aic
operator|=
operator|&
name|sc
operator|->
name|aic_obj
index|[
name|vector
index|]
expr_stmt|;
if|if
condition|(
name|value
operator|==
literal|0
condition|)
block|{
name|aic
operator|->
name|max_eqd
operator|=
name|aic
operator|->
name|min_eqd
operator|=
name|aic
operator|->
name|et_eqd
operator|=
literal|0
expr_stmt|;
name|aic
operator|->
name|enable
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|aic
operator|->
name|max_eqd
operator|=
name|OCE_MAX_EQD
expr_stmt|;
name|aic
operator|->
name|min_eqd
operator|=
name|OCE_MIN_EQD
expr_stmt|;
name|aic
operator|->
name|et_eqd
operator|=
name|OCE_MIN_EQD
expr_stmt|;
name|aic
operator|->
name|enable
operator|=
name|TRUE
expr_stmt|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|oce_sysctl_loopback
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|int
name|value
init|=
literal|0
decl_stmt|;
name|uint32_t
name|status
decl_stmt|;
name|struct
name|oce_softc
modifier|*
name|sc
init|=
operator|(
expr|struct
name|oce_softc
operator|*
operator|)
name|arg1
decl_stmt|;
name|status
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|value
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|||
operator|!
name|req
operator|->
name|newptr
condition|)
return|return
name|status
return|;
if|if
condition|(
name|value
operator|!=
literal|1
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Not a Valid value. Set to loop_back=1 to run tests\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|(
name|status
operator|=
name|oce_loopback_test
argument_list|(
name|sc
argument_list|,
name|OCE_MAC_LOOPBACK
argument_list|)
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"MAC Loopback Test = Failed (Error status = %d)\n"
argument_list|,
name|status
argument_list|)
expr_stmt|;
block|}
else|else
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"MAC Loopback Test = Success\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|status
operator|=
name|oce_loopback_test
argument_list|(
name|sc
argument_list|,
name|OCE_PHY_LOOPBACK
argument_list|)
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"PHY Loopback Test = Failed (Error status = %d)\n"
argument_list|,
name|status
argument_list|)
expr_stmt|;
block|}
else|else
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"PHY Loopback Test = Success\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|status
operator|=
name|oce_loopback_test
argument_list|(
name|sc
argument_list|,
name|OCE_ONE_PORT_EXT_LOOPBACK
argument_list|)
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"EXT Loopback Test = Failed (Error status = %d)\n"
argument_list|,
name|status
argument_list|)
expr_stmt|;
block|}
else|else
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"EXT Loopback Test = Success\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|oce_sys_fwupgrade
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|char
name|ufiname
index|[
literal|256
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
name|uint32_t
name|status
init|=
literal|1
decl_stmt|;
name|struct
name|oce_softc
modifier|*
name|sc
init|=
operator|(
expr|struct
name|oce_softc
operator|*
operator|)
name|arg1
decl_stmt|;
specifier|const
name|struct
name|firmware
modifier|*
name|fw
decl_stmt|;
name|status
operator|=
name|sysctl_handle_string
argument_list|(
name|oidp
argument_list|,
name|ufiname
argument_list|,
sizeof|sizeof
argument_list|(
name|ufiname
argument_list|)
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|||
operator|!
name|req
operator|->
name|newptr
condition|)
return|return
name|status
return|;
name|fw
operator|=
name|firmware_get
argument_list|(
name|ufiname
argument_list|)
expr_stmt|;
if|if
condition|(
name|fw
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Unable to get Firmware. "
literal|"Make sure %s is copied to /boot/modules\n"
argument_list|,
name|ufiname
argument_list|)
expr_stmt|;
return|return
name|ENOENT
return|;
block|}
if|if
condition|(
name|IS_BE
argument_list|(
name|sc
argument_list|)
condition|)
block|{
if|if
condition|(
operator|(
name|sc
operator|->
name|flags
operator|&
name|OCE_FLAGS_BE2
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Flashing not supported for BE2 yet.\n"
argument_list|)
expr_stmt|;
name|status
operator|=
literal|1
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|status
operator|=
name|oce_be3_fwupgrade
argument_list|(
name|sc
argument_list|,
name|fw
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|IS_SH
argument_list|(
name|sc
argument_list|)
condition|)
block|{
name|status
operator|=
name|oce_skyhawk_fwupgrade
argument_list|(
name|sc
argument_list|,
name|fw
argument_list|)
expr_stmt|;
block|}
else|else
name|status
operator|=
name|oce_lancer_fwupgrade
argument_list|(
name|sc
argument_list|,
name|fw
argument_list|)
expr_stmt|;
name|done
label|:
if|if
condition|(
name|status
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Firmware Upgrade failed\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Firmware Flashed successfully\n"
argument_list|)
expr_stmt|;
block|}
comment|/* Release Firmware*/
name|firmware_put
argument_list|(
name|fw
argument_list|,
name|FIRMWARE_UNLOAD
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|oce_fill_flash_img_data
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
specifier|const
name|struct
name|flash_sec_info
modifier|*
name|fsec
parameter_list|,
name|struct
name|flash_img_attri
modifier|*
name|pimg
parameter_list|,
name|int
name|i
parameter_list|,
specifier|const
name|struct
name|firmware
modifier|*
name|fw
parameter_list|,
name|int
name|bin_offset
parameter_list|)
block|{
if|if
condition|(
name|IS_SH
argument_list|(
name|sc
argument_list|)
condition|)
block|{
name|pimg
operator|->
name|img_offset
operator|=
name|HOST_32
argument_list|(
name|fsec
operator|->
name|fsec_entry
index|[
name|i
index|]
operator|.
name|offset
argument_list|)
expr_stmt|;
name|pimg
operator|->
name|img_size
operator|=
name|HOST_32
argument_list|(
name|fsec
operator|->
name|fsec_entry
index|[
name|i
index|]
operator|.
name|pad_size
argument_list|)
expr_stmt|;
block|}
name|pimg
operator|->
name|img_type
operator|=
name|HOST_32
argument_list|(
name|fsec
operator|->
name|fsec_entry
index|[
name|i
index|]
operator|.
name|type
argument_list|)
expr_stmt|;
name|pimg
operator|->
name|skip_image
operator|=
name|FALSE
expr_stmt|;
switch|switch
condition|(
name|pimg
operator|->
name|img_type
condition|)
block|{
case|case
name|IMG_ISCSI
case|:
name|pimg
operator|->
name|optype
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|IS_BE3
argument_list|(
name|sc
argument_list|)
condition|)
block|{
name|pimg
operator|->
name|img_offset
operator|=
literal|2097152
expr_stmt|;
name|pimg
operator|->
name|img_size
operator|=
literal|2097152
expr_stmt|;
block|}
break|break;
case|case
name|IMG_REDBOOT
case|:
name|pimg
operator|->
name|optype
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|IS_BE3
argument_list|(
name|sc
argument_list|)
condition|)
block|{
name|pimg
operator|->
name|img_offset
operator|=
literal|262144
expr_stmt|;
name|pimg
operator|->
name|img_size
operator|=
literal|1048576
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|oce_img_flashing_required
argument_list|(
name|sc
argument_list|,
name|fw
operator|->
name|data
argument_list|,
name|pimg
operator|->
name|optype
argument_list|,
name|pimg
operator|->
name|img_offset
argument_list|,
name|pimg
operator|->
name|img_size
argument_list|,
name|bin_offset
argument_list|)
condition|)
name|pimg
operator|->
name|skip_image
operator|=
name|TRUE
expr_stmt|;
break|break;
case|case
name|IMG_BIOS
case|:
name|pimg
operator|->
name|optype
operator|=
literal|2
expr_stmt|;
if|if
condition|(
name|IS_BE3
argument_list|(
name|sc
argument_list|)
condition|)
block|{
name|pimg
operator|->
name|img_offset
operator|=
literal|12582912
expr_stmt|;
name|pimg
operator|->
name|img_size
operator|=
literal|524288
expr_stmt|;
block|}
break|break;
case|case
name|IMG_PXEBIOS
case|:
name|pimg
operator|->
name|optype
operator|=
literal|3
expr_stmt|;
if|if
condition|(
name|IS_BE3
argument_list|(
name|sc
argument_list|)
condition|)
block|{
name|pimg
operator|->
name|img_offset
operator|=
literal|13107200
expr_stmt|;
empty_stmt|;
name|pimg
operator|->
name|img_size
operator|=
literal|524288
expr_stmt|;
block|}
break|break;
case|case
name|IMG_FCOEBIOS
case|:
name|pimg
operator|->
name|optype
operator|=
literal|8
expr_stmt|;
if|if
condition|(
name|IS_BE3
argument_list|(
name|sc
argument_list|)
condition|)
block|{
name|pimg
operator|->
name|img_offset
operator|=
literal|13631488
expr_stmt|;
name|pimg
operator|->
name|img_size
operator|=
literal|524288
expr_stmt|;
block|}
break|break;
case|case
name|IMG_ISCSI_BAK
case|:
name|pimg
operator|->
name|optype
operator|=
literal|9
expr_stmt|;
if|if
condition|(
name|IS_BE3
argument_list|(
name|sc
argument_list|)
condition|)
block|{
name|pimg
operator|->
name|img_offset
operator|=
literal|4194304
expr_stmt|;
name|pimg
operator|->
name|img_size
operator|=
literal|2097152
expr_stmt|;
block|}
break|break;
case|case
name|IMG_FCOE
case|:
name|pimg
operator|->
name|optype
operator|=
literal|10
expr_stmt|;
if|if
condition|(
name|IS_BE3
argument_list|(
name|sc
argument_list|)
condition|)
block|{
name|pimg
operator|->
name|img_offset
operator|=
literal|6291456
expr_stmt|;
name|pimg
operator|->
name|img_size
operator|=
literal|2097152
expr_stmt|;
block|}
break|break;
case|case
name|IMG_FCOE_BAK
case|:
name|pimg
operator|->
name|optype
operator|=
literal|11
expr_stmt|;
if|if
condition|(
name|IS_BE3
argument_list|(
name|sc
argument_list|)
condition|)
block|{
name|pimg
operator|->
name|img_offset
operator|=
literal|8388608
expr_stmt|;
name|pimg
operator|->
name|img_size
operator|=
literal|2097152
expr_stmt|;
block|}
break|break;
case|case
name|IMG_NCSI
case|:
name|pimg
operator|->
name|optype
operator|=
literal|13
expr_stmt|;
if|if
condition|(
name|IS_BE3
argument_list|(
name|sc
argument_list|)
condition|)
block|{
name|pimg
operator|->
name|img_offset
operator|=
literal|15990784
expr_stmt|;
name|pimg
operator|->
name|img_size
operator|=
literal|262144
expr_stmt|;
block|}
break|break;
case|case
name|IMG_PHY
case|:
name|pimg
operator|->
name|optype
operator|=
literal|99
expr_stmt|;
if|if
condition|(
name|IS_BE3
argument_list|(
name|sc
argument_list|)
condition|)
block|{
name|pimg
operator|->
name|img_offset
operator|=
literal|1310720
expr_stmt|;
name|pimg
operator|->
name|img_size
operator|=
literal|262144
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|oce_phy_flashing_required
argument_list|(
name|sc
argument_list|)
condition|)
name|pimg
operator|->
name|skip_image
operator|=
name|TRUE
expr_stmt|;
break|break;
default|default:
name|pimg
operator|->
name|skip_image
operator|=
name|TRUE
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|oce_sh_be3_flashdata
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
specifier|const
name|struct
name|firmware
modifier|*
name|fw
parameter_list|,
name|int32_t
name|num_imgs
parameter_list|)
block|{
name|char
name|cookie
index|[
literal|2
index|]
index|[
literal|16
index|]
init|=
block|{
literal|"*** SE FLAS"
block|,
literal|"H DIRECTORY *** "
block|}
decl_stmt|;
specifier|const
name|char
modifier|*
name|p
init|=
operator|(
specifier|const
name|char
operator|*
operator|)
name|fw
operator|->
name|data
decl_stmt|;
specifier|const
name|struct
name|flash_sec_info
modifier|*
name|fsec
init|=
name|NULL
decl_stmt|;
name|struct
name|mbx_common_read_write_flashrom
modifier|*
name|req
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|,
name|i
decl_stmt|,
name|bin_offset
init|=
literal|0
decl_stmt|,
name|opcode
decl_stmt|,
name|num_bytes
decl_stmt|;
name|OCE_DMA_MEM
name|dma_mem
decl_stmt|;
name|struct
name|flash_img_attri
name|imgatt
decl_stmt|;
comment|/* Validate Cookie */
name|bin_offset
operator|=
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|flash_file_hdr
argument_list|)
operator|+
operator|(
name|num_imgs
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|image_hdr
argument_list|)
operator|)
operator|)
expr_stmt|;
name|p
operator|+=
name|bin_offset
expr_stmt|;
while|while
condition|(
name|p
operator|<
operator|(
operator|(
specifier|const
name|char
operator|*
operator|)
name|fw
operator|->
name|data
operator|+
name|fw
operator|->
name|datasize
operator|)
condition|)
block|{
name|fsec
operator|=
operator|(
specifier|const
expr|struct
name|flash_sec_info
operator|*
operator|)
name|p
expr_stmt|;
if|if
condition|(
operator|!
name|memcmp
argument_list|(
name|cookie
argument_list|,
name|fsec
operator|->
name|cookie
argument_list|,
sizeof|sizeof
argument_list|(
name|cookie
argument_list|)
argument_list|)
condition|)
break|break;
name|fsec
operator|=
name|NULL
expr_stmt|;
name|p
operator|+=
literal|32
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|fsec
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Invalid Cookie. Firmware image corrupted ?\n"
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
name|rc
operator|=
name|oce_dma_alloc
argument_list|(
name|sc
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_common_read_write_flashrom
argument_list|)
argument_list|,
operator|&
name|dma_mem
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Memory allocation failure while flashing\n"
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|req
operator|=
name|OCE_DMAPTR
argument_list|(
operator|&
name|dma_mem
argument_list|,
expr|struct
name|mbx_common_read_write_flashrom
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_SH
argument_list|(
name|sc
argument_list|)
condition|)
name|num_imgs
operator|=
name|HOST_32
argument_list|(
name|fsec
operator|->
name|fsec_hdr
operator|.
name|num_images
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|IS_BE3
argument_list|(
name|sc
argument_list|)
condition|)
name|num_imgs
operator|=
name|MAX_FLASH_COMP
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_imgs
condition|;
name|i
operator|++
control|)
block|{
name|bzero
argument_list|(
operator|&
name|imgatt
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|flash_img_attri
argument_list|)
argument_list|)
expr_stmt|;
name|oce_fill_flash_img_data
argument_list|(
name|sc
argument_list|,
name|fsec
argument_list|,
operator|&
name|imgatt
argument_list|,
name|i
argument_list|,
name|fw
argument_list|,
name|bin_offset
argument_list|)
expr_stmt|;
if|if
condition|(
name|imgatt
operator|.
name|skip_image
condition|)
continue|continue;
name|p
operator|=
name|fw
operator|->
name|data
expr_stmt|;
name|p
operator|=
name|p
operator|+
name|bin_offset
operator|+
name|imgatt
operator|.
name|img_offset
expr_stmt|;
if|if
condition|(
operator|(
name|p
operator|+
name|imgatt
operator|.
name|img_size
operator|)
operator|>
operator|(
operator|(
specifier|const
name|char
operator|*
operator|)
name|fw
operator|->
name|data
operator|+
name|fw
operator|->
name|datasize
operator|)
condition|)
block|{
name|rc
operator|=
literal|1
expr_stmt|;
goto|goto
name|ret
goto|;
block|}
while|while
condition|(
name|imgatt
operator|.
name|img_size
condition|)
block|{
if|if
condition|(
name|imgatt
operator|.
name|img_size
operator|>
literal|32
operator|*
literal|1024
condition|)
name|num_bytes
operator|=
literal|32
operator|*
literal|1024
expr_stmt|;
else|else
name|num_bytes
operator|=
name|imgatt
operator|.
name|img_size
expr_stmt|;
name|imgatt
operator|.
name|img_size
operator|-=
name|num_bytes
expr_stmt|;
if|if
condition|(
operator|!
name|imgatt
operator|.
name|img_size
condition|)
name|opcode
operator|=
name|FLASHROM_OPER_FLASH
expr_stmt|;
else|else
name|opcode
operator|=
name|FLASHROM_OPER_SAVE
expr_stmt|;
name|memcpy
argument_list|(
name|req
operator|->
name|data_buffer
argument_list|,
name|p
argument_list|,
name|num_bytes
argument_list|)
expr_stmt|;
name|p
operator|+=
name|num_bytes
expr_stmt|;
name|rc
operator|=
name|oce_mbox_write_flashrom
argument_list|(
name|sc
argument_list|,
name|imgatt
operator|.
name|optype
argument_list|,
name|opcode
argument_list|,
operator|&
name|dma_mem
argument_list|,
name|num_bytes
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"cmd to write to flash rom failed.\n"
argument_list|)
expr_stmt|;
name|rc
operator|=
name|EIO
expr_stmt|;
goto|goto
name|ret
goto|;
block|}
comment|/* Leave the CPU for others for some time */
name|pause
argument_list|(
literal|"yield"
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
block|}
name|ret
label|:
name|oce_dma_free
argument_list|(
name|sc
argument_list|,
operator|&
name|dma_mem
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_define
define|#
directive|define
name|UFI_TYPE2
value|2
end_define

begin_define
define|#
directive|define
name|UFI_TYPE3
value|3
end_define

begin_define
define|#
directive|define
name|UFI_TYPE3R
value|10
end_define

begin_define
define|#
directive|define
name|UFI_TYPE4
value|4
end_define

begin_define
define|#
directive|define
name|UFI_TYPE4R
value|11
end_define

begin_function
specifier|static
name|int
name|oce_get_ufi_type
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
specifier|const
name|struct
name|flash_file_hdr
modifier|*
name|fhdr
parameter_list|)
block|{
if|if
condition|(
name|fhdr
operator|==
name|NULL
condition|)
goto|goto
name|be_get_ufi_exit
goto|;
if|if
condition|(
name|IS_SH
argument_list|(
name|sc
argument_list|)
operator|&&
name|fhdr
operator|->
name|build
index|[
literal|0
index|]
operator|==
literal|'4'
condition|)
block|{
if|if
condition|(
name|fhdr
operator|->
name|asic_type_rev
operator|>=
literal|0x10
condition|)
return|return
name|UFI_TYPE4R
return|;
else|else
return|return
name|UFI_TYPE4
return|;
block|}
elseif|else
if|if
condition|(
name|IS_BE3
argument_list|(
name|sc
argument_list|)
operator|&&
name|fhdr
operator|->
name|build
index|[
literal|0
index|]
operator|==
literal|'3'
condition|)
block|{
if|if
condition|(
name|fhdr
operator|->
name|asic_type_rev
operator|==
literal|0x10
condition|)
return|return
name|UFI_TYPE3R
return|;
else|else
return|return
name|UFI_TYPE3
return|;
block|}
elseif|else
if|if
condition|(
name|IS_BE2
argument_list|(
name|sc
argument_list|)
operator|&&
name|fhdr
operator|->
name|build
index|[
literal|0
index|]
operator|==
literal|'2'
condition|)
return|return
name|UFI_TYPE2
return|;
name|be_get_ufi_exit
label|:
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"UFI and Interface are not compatible for flashing\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|oce_skyhawk_fwupgrade
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
specifier|const
name|struct
name|firmware
modifier|*
name|fw
parameter_list|)
block|{
name|int
name|rc
init|=
literal|0
decl_stmt|,
name|num_imgs
init|=
literal|0
decl_stmt|,
name|i
init|=
literal|0
decl_stmt|,
name|ufi_type
decl_stmt|;
specifier|const
name|struct
name|flash_file_hdr
modifier|*
name|fhdr
decl_stmt|;
specifier|const
name|struct
name|image_hdr
modifier|*
name|img_ptr
decl_stmt|;
name|fhdr
operator|=
operator|(
specifier|const
expr|struct
name|flash_file_hdr
operator|*
operator|)
name|fw
operator|->
name|data
expr_stmt|;
name|ufi_type
operator|=
name|oce_get_ufi_type
argument_list|(
name|sc
argument_list|,
name|fhdr
argument_list|)
expr_stmt|;
comment|/* Display flash version */
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Flashing Firmware %s\n"
argument_list|,
operator|&
name|fhdr
operator|->
name|build
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|num_imgs
operator|=
name|fhdr
operator|->
name|num_imgs
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_imgs
condition|;
name|i
operator|++
control|)
block|{
name|img_ptr
operator|=
operator|(
specifier|const
expr|struct
name|image_hdr
operator|*
operator|)
operator|(
operator|(
specifier|const
name|char
operator|*
operator|)
name|fw
operator|->
name|data
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|flash_file_hdr
argument_list|)
operator|+
operator|(
name|i
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|image_hdr
argument_list|)
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|img_ptr
operator|->
name|imageid
operator|!=
literal|1
condition|)
continue|continue;
switch|switch
condition|(
name|ufi_type
condition|)
block|{
case|case
name|UFI_TYPE4R
case|:
name|rc
operator|=
name|oce_sh_be3_flashdata
argument_list|(
name|sc
argument_list|,
name|fw
argument_list|,
name|num_imgs
argument_list|)
expr_stmt|;
break|break;
case|case
name|UFI_TYPE4
case|:
if|if
condition|(
name|sc
operator|->
name|asic_revision
operator|<
literal|0x10
condition|)
name|rc
operator|=
name|oce_sh_be3_flashdata
argument_list|(
name|sc
argument_list|,
name|fw
argument_list|,
name|num_imgs
argument_list|)
expr_stmt|;
else|else
block|{
name|rc
operator|=
operator|-
literal|1
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Cant load SH A0 UFI on B0\n"
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|rc
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
block|}
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|oce_be3_fwupgrade
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
specifier|const
name|struct
name|firmware
modifier|*
name|fw
parameter_list|)
block|{
name|int
name|rc
init|=
literal|0
decl_stmt|,
name|num_imgs
init|=
literal|0
decl_stmt|,
name|i
init|=
literal|0
decl_stmt|;
specifier|const
name|struct
name|flash_file_hdr
modifier|*
name|fhdr
decl_stmt|;
specifier|const
name|struct
name|image_hdr
modifier|*
name|img_ptr
decl_stmt|;
name|fhdr
operator|=
operator|(
specifier|const
expr|struct
name|flash_file_hdr
operator|*
operator|)
name|fw
operator|->
name|data
expr_stmt|;
if|if
condition|(
name|fhdr
operator|->
name|build
index|[
literal|0
index|]
operator|!=
literal|'3'
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Invalid BE3 firmware image\n"
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
comment|/* Display flash version */
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Flashing Firmware %s\n"
argument_list|,
operator|&
name|fhdr
operator|->
name|build
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|num_imgs
operator|=
name|fhdr
operator|->
name|num_imgs
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_imgs
condition|;
name|i
operator|++
control|)
block|{
name|img_ptr
operator|=
operator|(
specifier|const
expr|struct
name|image_hdr
operator|*
operator|)
operator|(
operator|(
specifier|const
name|char
operator|*
operator|)
name|fw
operator|->
name|data
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|flash_file_hdr
argument_list|)
operator|+
operator|(
name|i
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|image_hdr
argument_list|)
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|img_ptr
operator|->
name|imageid
operator|==
literal|1
condition|)
block|{
name|rc
operator|=
name|oce_sh_be3_flashdata
argument_list|(
name|sc
argument_list|,
name|fw
argument_list|,
name|num_imgs
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|boolean_t
name|oce_phy_flashing_required
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|)
block|{
name|int
name|status
init|=
literal|0
decl_stmt|;
name|struct
name|oce_phy_info
name|phy_info
decl_stmt|;
name|status
operator|=
name|oce_mbox_get_phy_info
argument_list|(
name|sc
argument_list|,
operator|&
name|phy_info
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
condition|)
return|return
name|FALSE
return|;
if|if
condition|(
operator|(
name|phy_info
operator|.
name|phy_type
operator|==
name|TN_8022
operator|)
operator|&&
operator|(
name|phy_info
operator|.
name|interface_type
operator|==
name|PHY_TYPE_BASET_10GB
operator|)
condition|)
block|{
return|return
name|TRUE
return|;
block|}
return|return
name|FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|boolean_t
name|oce_img_flashing_required
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
specifier|const
name|char
modifier|*
name|p
parameter_list|,
name|int
name|img_optype
parameter_list|,
name|uint32_t
name|img_offset
parameter_list|,
name|uint32_t
name|img_size
parameter_list|,
name|uint32_t
name|hdrs_size
parameter_list|)
block|{
name|uint32_t
name|crc_offset
decl_stmt|;
name|uint8_t
name|flashed_crc
index|[
literal|4
index|]
decl_stmt|;
name|int
name|status
decl_stmt|;
name|crc_offset
operator|=
name|hdrs_size
operator|+
name|img_offset
operator|+
name|img_size
operator|-
literal|4
expr_stmt|;
name|p
operator|+=
name|crc_offset
expr_stmt|;
name|status
operator|=
name|oce_mbox_get_flashrom_crc
argument_list|(
name|sc
argument_list|,
name|flashed_crc
argument_list|,
operator|(
name|img_size
operator|-
literal|4
operator|)
argument_list|,
name|img_optype
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
condition|)
return|return
name|TRUE
return|;
comment|/* Some thing worng. ReFlash */
comment|/*update redboot only if crc does not match*/
if|if
condition|(
name|bcmp
argument_list|(
name|flashed_crc
argument_list|,
name|p
argument_list|,
literal|4
argument_list|)
condition|)
return|return
name|TRUE
return|;
else|else
return|return
name|FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|oce_lancer_fwupgrade
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
specifier|const
name|struct
name|firmware
modifier|*
name|fw
parameter_list|)
block|{
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|OCE_DMA_MEM
name|dma_mem
decl_stmt|;
specifier|const
name|uint8_t
modifier|*
name|data
init|=
name|NULL
decl_stmt|;
name|uint8_t
modifier|*
name|dest_image_ptr
init|=
name|NULL
decl_stmt|;
name|size_t
name|size
init|=
literal|0
decl_stmt|;
name|uint32_t
name|data_written
init|=
literal|0
decl_stmt|,
name|chunk_size
init|=
literal|0
decl_stmt|;
name|uint32_t
name|offset
init|=
literal|0
decl_stmt|,
name|add_status
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|IS_ALIGNED
argument_list|(
name|fw
operator|->
name|datasize
argument_list|,
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Lancer FW image is not 4 byte aligned."
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
name|rc
operator|=
name|oce_dma_alloc
argument_list|(
name|sc
argument_list|,
literal|32
operator|*
literal|1024
argument_list|,
operator|&
name|dma_mem
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Memory allocation failure while flashing Lancer\n"
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|size
operator|=
name|fw
operator|->
name|datasize
expr_stmt|;
name|data
operator|=
name|fw
operator|->
name|data
expr_stmt|;
name|dest_image_ptr
operator|=
name|OCE_DMAPTR
argument_list|(
operator|&
name|dma_mem
argument_list|,
name|uint8_t
argument_list|)
expr_stmt|;
while|while
condition|(
name|size
condition|)
block|{
name|chunk_size
operator|=
name|MIN
argument_list|(
name|size
argument_list|,
operator|(
literal|32
operator|*
literal|1024
operator|)
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|data
argument_list|,
name|dest_image_ptr
argument_list|,
name|chunk_size
argument_list|)
expr_stmt|;
name|rc
operator|=
name|oce_mbox_lancer_write_flashrom
argument_list|(
name|sc
argument_list|,
name|chunk_size
argument_list|,
name|offset
argument_list|,
operator|&
name|dma_mem
argument_list|,
operator|&
name|data_written
argument_list|,
operator|&
name|add_status
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
break|break;
name|size
operator|-=
name|data_written
expr_stmt|;
name|data
operator|+=
name|data_written
expr_stmt|;
name|offset
operator|+=
name|data_written
expr_stmt|;
name|pause
argument_list|(
literal|"yield"
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|rc
condition|)
comment|/* Commit the firmware*/
name|rc
operator|=
name|oce_mbox_lancer_write_flashrom
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
name|offset
argument_list|,
operator|&
name|dma_mem
argument_list|,
operator|&
name|data_written
argument_list|,
operator|&
name|add_status
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Lancer firmware load error. "
literal|"Addstatus = 0x%x, status = %d \n"
argument_list|,
name|add_status
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|rc
operator|=
name|EIO
expr_stmt|;
block|}
name|oce_dma_free
argument_list|(
name|sc
argument_list|,
operator|&
name|dma_mem
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|oce_add_stats_sysctls_be3
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
name|struct
name|sysctl_ctx_list
modifier|*
name|ctx
parameter_list|,
name|struct
name|sysctl_oid
modifier|*
name|stats_node
parameter_list|)
block|{
name|struct
name|sysctl_oid
modifier|*
name|rx_stats_node
decl_stmt|,
modifier|*
name|tx_stats_node
decl_stmt|;
name|struct
name|sysctl_oid_list
modifier|*
name|rx_stat_list
decl_stmt|,
modifier|*
name|tx_stat_list
decl_stmt|;
name|struct
name|sysctl_oid_list
modifier|*
name|queue_stats_list
decl_stmt|;
name|struct
name|sysctl_oid
modifier|*
name|queue_stats_node
decl_stmt|;
name|struct
name|oce_drv_stats
modifier|*
name|stats
decl_stmt|;
name|char
name|prefix
index|[
literal|32
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
name|stats
operator|=
operator|&
name|sc
operator|->
name|oce_stats_info
expr_stmt|;
name|rx_stats_node
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|stats_node
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx"
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|NULL
argument_list|,
literal|"RX Ethernet Statistics"
argument_list|)
expr_stmt|;
name|rx_stat_list
operator|=
name|SYSCTL_CHILDREN
argument_list|(
name|rx_stats_node
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|rx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"total_pkts"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|rx
operator|.
name|t_rx_pkts
argument_list|,
literal|"Total Received Packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|rx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"total_bytes"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|rx
operator|.
name|t_rx_bytes
argument_list|,
literal|"Total Received Bytes"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|rx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"total_frags"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|rx
operator|.
name|t_rx_frags
argument_list|,
literal|0
argument_list|,
literal|"Total Received Fragements"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|rx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"total_mcast_pkts"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|rx
operator|.
name|t_rx_mcast_pkts
argument_list|,
literal|0
argument_list|,
literal|"Total Received Multicast Packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|rx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"total_ucast_pkts"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|rx
operator|.
name|t_rx_ucast_pkts
argument_list|,
literal|0
argument_list|,
literal|"Total Received Unicast Packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|rx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"total_rxcp_errs"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|rx
operator|.
name|t_rxcp_errs
argument_list|,
literal|0
argument_list|,
literal|"Total Receive completion errors"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|rx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"pause_frames"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|u0
operator|.
name|be
operator|.
name|rx_pause_frames
argument_list|,
literal|0
argument_list|,
literal|"Pause Frames"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|rx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"priority_pause_frames"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|u0
operator|.
name|be
operator|.
name|rx_priority_pause_frames
argument_list|,
literal|0
argument_list|,
literal|"Priority Pause Frames"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|rx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"control_frames"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|u0
operator|.
name|be
operator|.
name|rx_control_frames
argument_list|,
literal|0
argument_list|,
literal|"Control Frames"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|nrqs
condition|;
name|i
operator|++
control|)
block|{
name|sprintf
argument_list|(
name|prefix
argument_list|,
literal|"queue%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|queue_stats_node
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|rx_stats_node
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
name|prefix
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|NULL
argument_list|,
literal|"Queue name"
argument_list|)
expr_stmt|;
name|queue_stats_list
operator|=
name|SYSCTL_CHILDREN
argument_list|(
name|queue_stats_node
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|queue_stats_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_pkts"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|rq
index|[
name|i
index|]
operator|->
name|rx_stats
operator|.
name|rx_pkts
argument_list|,
literal|"Receive Packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|queue_stats_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_bytes"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|rq
index|[
name|i
index|]
operator|->
name|rx_stats
operator|.
name|rx_bytes
argument_list|,
literal|"Recived Bytes"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|queue_stats_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_frags"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|rq
index|[
name|i
index|]
operator|->
name|rx_stats
operator|.
name|rx_frags
argument_list|,
literal|0
argument_list|,
literal|"Received Fragments"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|queue_stats_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_mcast_pkts"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|rq
index|[
name|i
index|]
operator|->
name|rx_stats
operator|.
name|rx_mcast_pkts
argument_list|,
literal|0
argument_list|,
literal|"Received Multicast Packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|queue_stats_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_ucast_pkts"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|rq
index|[
name|i
index|]
operator|->
name|rx_stats
operator|.
name|rx_ucast_pkts
argument_list|,
literal|0
argument_list|,
literal|"Received Unicast Packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|queue_stats_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rxcp_err"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|rq
index|[
name|i
index|]
operator|->
name|rx_stats
operator|.
name|rxcp_err
argument_list|,
literal|0
argument_list|,
literal|"Received Completion Errors"
argument_list|)
expr_stmt|;
block|}
name|rx_stats_node
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|rx_stats_node
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"err"
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|NULL
argument_list|,
literal|"Receive Error Stats"
argument_list|)
expr_stmt|;
name|rx_stat_list
operator|=
name|SYSCTL_CHILDREN
argument_list|(
name|rx_stats_node
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|rx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"crc_errs"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|u0
operator|.
name|be
operator|.
name|rx_crc_errors
argument_list|,
literal|0
argument_list|,
literal|"CRC Errors"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|rx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"pbuf_errors"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|u0
operator|.
name|be
operator|.
name|rx_drops_no_pbuf
argument_list|,
literal|0
argument_list|,
literal|"Drops due to pbuf full"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|rx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"erx_errors"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|u0
operator|.
name|be
operator|.
name|rx_drops_no_erx_descr
argument_list|,
literal|0
argument_list|,
literal|"ERX Errors"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|rx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"alignment_errors"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|u0
operator|.
name|be
operator|.
name|rx_drops_too_many_frags
argument_list|,
literal|0
argument_list|,
literal|"RX Alignmnet Errors"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|rx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"in_range_errors"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|u0
operator|.
name|be
operator|.
name|rx_in_range_errors
argument_list|,
literal|0
argument_list|,
literal|"In Range Errors"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|rx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"out_range_errors"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|u0
operator|.
name|be
operator|.
name|rx_out_range_errors
argument_list|,
literal|0
argument_list|,
literal|"Out Range Errors"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|rx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"frame_too_long"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|u0
operator|.
name|be
operator|.
name|rx_frame_too_long
argument_list|,
literal|0
argument_list|,
literal|"Frame Too Long"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|rx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"address_match_errors"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|u0
operator|.
name|be
operator|.
name|rx_address_match_errors
argument_list|,
literal|0
argument_list|,
literal|"Address Match Errors"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|rx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"dropped_too_small"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|u0
operator|.
name|be
operator|.
name|rx_dropped_too_small
argument_list|,
literal|0
argument_list|,
literal|"Dropped Too Small"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|rx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"dropped_too_short"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|u0
operator|.
name|be
operator|.
name|rx_dropped_too_short
argument_list|,
literal|0
argument_list|,
literal|"Dropped Too Short"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|rx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"dropped_header_too_small"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|u0
operator|.
name|be
operator|.
name|rx_dropped_header_too_small
argument_list|,
literal|0
argument_list|,
literal|"Dropped Header Too Small"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|rx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"dropped_tcp_length"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|u0
operator|.
name|be
operator|.
name|rx_dropped_tcp_length
argument_list|,
literal|0
argument_list|,
literal|"Dropped TCP Length"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|rx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"dropped_runt"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|u0
operator|.
name|be
operator|.
name|rx_dropped_runt
argument_list|,
literal|0
argument_list|,
literal|"Dropped runt"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|rx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"ip_checksum_errs"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|u0
operator|.
name|be
operator|.
name|rx_ip_checksum_errs
argument_list|,
literal|0
argument_list|,
literal|"IP Checksum Errors"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|rx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tcp_checksum_errs"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|u0
operator|.
name|be
operator|.
name|rx_tcp_checksum_errs
argument_list|,
literal|0
argument_list|,
literal|"TCP Checksum Errors"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|rx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"udp_checksum_errs"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|u0
operator|.
name|be
operator|.
name|rx_udp_checksum_errs
argument_list|,
literal|0
argument_list|,
literal|"UDP Checksum Errors"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|rx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"fifo_overflow_drop"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|u0
operator|.
name|be
operator|.
name|rxpp_fifo_overflow_drop
argument_list|,
literal|0
argument_list|,
literal|"FIFO Overflow Drop"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|rx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"input_fifo_overflow_drop"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|u0
operator|.
name|be
operator|.
name|rx_input_fifo_overflow_drop
argument_list|,
literal|0
argument_list|,
literal|"Input FIFO Overflow Drop"
argument_list|)
expr_stmt|;
name|tx_stats_node
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|stats_node
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx"
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|NULL
argument_list|,
literal|"TX Ethernet Statistics"
argument_list|)
expr_stmt|;
name|tx_stat_list
operator|=
name|SYSCTL_CHILDREN
argument_list|(
name|tx_stats_node
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|tx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"total_tx_pkts"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|tx
operator|.
name|t_tx_pkts
argument_list|,
literal|"Total Transmit Packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|tx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"total_tx_bytes"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|tx
operator|.
name|t_tx_bytes
argument_list|,
literal|"Total Transmit Bytes"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|tx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"total_tx_reqs"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|tx
operator|.
name|t_tx_reqs
argument_list|,
literal|0
argument_list|,
literal|"Total Transmit Requests"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|tx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"total_tx_stops"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|tx
operator|.
name|t_tx_stops
argument_list|,
literal|0
argument_list|,
literal|"Total Transmit Stops"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|tx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"total_tx_wrbs"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|tx
operator|.
name|t_tx_wrbs
argument_list|,
literal|0
argument_list|,
literal|"Total Transmit WRB's"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|tx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"total_tx_compl"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|tx
operator|.
name|t_tx_compl
argument_list|,
literal|0
argument_list|,
literal|"Total Transmit Completions"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|tx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"total_ipv6_ext_hdr_tx_drop"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|tx
operator|.
name|t_ipv6_ext_hdr_tx_drop
argument_list|,
literal|0
argument_list|,
literal|"Total Transmit IPV6 Drops"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|tx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"pauseframes"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|u0
operator|.
name|be
operator|.
name|tx_pauseframes
argument_list|,
literal|0
argument_list|,
literal|"Pause Frames"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|tx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"priority_pauseframes"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|u0
operator|.
name|be
operator|.
name|tx_priority_pauseframes
argument_list|,
literal|0
argument_list|,
literal|"Priority Pauseframes"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|tx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"controlframes"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|u0
operator|.
name|be
operator|.
name|tx_controlframes
argument_list|,
literal|0
argument_list|,
literal|"Tx Control Frames"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|nwqs
condition|;
name|i
operator|++
control|)
block|{
name|sprintf
argument_list|(
name|prefix
argument_list|,
literal|"queue%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|queue_stats_node
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|tx_stats_node
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
name|prefix
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|NULL
argument_list|,
literal|"Queue name"
argument_list|)
expr_stmt|;
name|queue_stats_list
operator|=
name|SYSCTL_CHILDREN
argument_list|(
name|queue_stats_node
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|queue_stats_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_pkts"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|wq
index|[
name|i
index|]
operator|->
name|tx_stats
operator|.
name|tx_pkts
argument_list|,
literal|"Transmit Packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|queue_stats_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_bytes"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|wq
index|[
name|i
index|]
operator|->
name|tx_stats
operator|.
name|tx_bytes
argument_list|,
literal|"Transmit Bytes"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|queue_stats_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_reqs"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|wq
index|[
name|i
index|]
operator|->
name|tx_stats
operator|.
name|tx_reqs
argument_list|,
literal|0
argument_list|,
literal|"Transmit Requests"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|queue_stats_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_stops"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|wq
index|[
name|i
index|]
operator|->
name|tx_stats
operator|.
name|tx_stops
argument_list|,
literal|0
argument_list|,
literal|"Transmit Stops"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|queue_stats_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_wrbs"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|wq
index|[
name|i
index|]
operator|->
name|tx_stats
operator|.
name|tx_wrbs
argument_list|,
literal|0
argument_list|,
literal|"Transmit WRB's"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|queue_stats_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_compl"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|wq
index|[
name|i
index|]
operator|->
name|tx_stats
operator|.
name|tx_compl
argument_list|,
literal|0
argument_list|,
literal|"Transmit Completions"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|queue_stats_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"ipv6_ext_hdr_tx_drop"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|wq
index|[
name|i
index|]
operator|->
name|tx_stats
operator|.
name|ipv6_ext_hdr_tx_drop
argument_list|,
literal|0
argument_list|,
literal|"Transmit IPV6 Ext Header Drop"
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|oce_add_stats_sysctls_xe201
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
name|struct
name|sysctl_ctx_list
modifier|*
name|ctx
parameter_list|,
name|struct
name|sysctl_oid
modifier|*
name|stats_node
parameter_list|)
block|{
name|struct
name|sysctl_oid
modifier|*
name|rx_stats_node
decl_stmt|,
modifier|*
name|tx_stats_node
decl_stmt|;
name|struct
name|sysctl_oid_list
modifier|*
name|rx_stat_list
decl_stmt|,
modifier|*
name|tx_stat_list
decl_stmt|;
name|struct
name|sysctl_oid_list
modifier|*
name|queue_stats_list
decl_stmt|;
name|struct
name|sysctl_oid
modifier|*
name|queue_stats_node
decl_stmt|;
name|struct
name|oce_drv_stats
modifier|*
name|stats
decl_stmt|;
name|char
name|prefix
index|[
literal|32
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
name|stats
operator|=
operator|&
name|sc
operator|->
name|oce_stats_info
expr_stmt|;
name|rx_stats_node
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|stats_node
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx"
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|NULL
argument_list|,
literal|"RX Ethernet Statistics"
argument_list|)
expr_stmt|;
name|rx_stat_list
operator|=
name|SYSCTL_CHILDREN
argument_list|(
name|rx_stats_node
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|rx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"total_pkts"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|rx
operator|.
name|t_rx_pkts
argument_list|,
literal|"Total Received Packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|rx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"total_bytes"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|rx
operator|.
name|t_rx_bytes
argument_list|,
literal|"Total Received Bytes"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|rx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"total_frags"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|rx
operator|.
name|t_rx_frags
argument_list|,
literal|0
argument_list|,
literal|"Total Received Fragements"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|rx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"total_mcast_pkts"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|rx
operator|.
name|t_rx_mcast_pkts
argument_list|,
literal|0
argument_list|,
literal|"Total Received Multicast Packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|rx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"total_ucast_pkts"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|rx
operator|.
name|t_rx_ucast_pkts
argument_list|,
literal|0
argument_list|,
literal|"Total Received Unicast Packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|rx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"total_rxcp_errs"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|rx
operator|.
name|t_rxcp_errs
argument_list|,
literal|0
argument_list|,
literal|"Total Receive completion errors"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UQUAD
argument_list|(
name|ctx
argument_list|,
name|rx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"pause_frames"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|u0
operator|.
name|xe201
operator|.
name|rx_pause_frames
argument_list|,
literal|"Pause Frames"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UQUAD
argument_list|(
name|ctx
argument_list|,
name|rx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"control_frames"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|u0
operator|.
name|xe201
operator|.
name|rx_control_frames
argument_list|,
literal|"Control Frames"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|nrqs
condition|;
name|i
operator|++
control|)
block|{
name|sprintf
argument_list|(
name|prefix
argument_list|,
literal|"queue%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|queue_stats_node
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|rx_stats_node
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
name|prefix
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|NULL
argument_list|,
literal|"Queue name"
argument_list|)
expr_stmt|;
name|queue_stats_list
operator|=
name|SYSCTL_CHILDREN
argument_list|(
name|queue_stats_node
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|queue_stats_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_pkts"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|rq
index|[
name|i
index|]
operator|->
name|rx_stats
operator|.
name|rx_pkts
argument_list|,
literal|"Receive Packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|queue_stats_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_bytes"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|rq
index|[
name|i
index|]
operator|->
name|rx_stats
operator|.
name|rx_bytes
argument_list|,
literal|"Recived Bytes"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|queue_stats_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_frags"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|rq
index|[
name|i
index|]
operator|->
name|rx_stats
operator|.
name|rx_frags
argument_list|,
literal|0
argument_list|,
literal|"Received Fragments"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|queue_stats_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_mcast_pkts"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|rq
index|[
name|i
index|]
operator|->
name|rx_stats
operator|.
name|rx_mcast_pkts
argument_list|,
literal|0
argument_list|,
literal|"Received Multicast Packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|queue_stats_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_ucast_pkts"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|rq
index|[
name|i
index|]
operator|->
name|rx_stats
operator|.
name|rx_ucast_pkts
argument_list|,
literal|0
argument_list|,
literal|"Received Unicast Packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|queue_stats_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rxcp_err"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|rq
index|[
name|i
index|]
operator|->
name|rx_stats
operator|.
name|rxcp_err
argument_list|,
literal|0
argument_list|,
literal|"Received Completion Errors"
argument_list|)
expr_stmt|;
block|}
name|rx_stats_node
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|rx_stats_node
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"err"
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|NULL
argument_list|,
literal|"Receive Error Stats"
argument_list|)
expr_stmt|;
name|rx_stat_list
operator|=
name|SYSCTL_CHILDREN
argument_list|(
name|rx_stats_node
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UQUAD
argument_list|(
name|ctx
argument_list|,
name|rx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"crc_errs"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|u0
operator|.
name|xe201
operator|.
name|rx_crc_errors
argument_list|,
literal|"CRC Errors"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UQUAD
argument_list|(
name|ctx
argument_list|,
name|rx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"alignment_errors"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|u0
operator|.
name|xe201
operator|.
name|rx_alignment_errors
argument_list|,
literal|"RX Alignmnet Errors"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|rx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"in_range_errors"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|u0
operator|.
name|xe201
operator|.
name|rx_in_range_errors
argument_list|,
literal|0
argument_list|,
literal|"In Range Errors"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|rx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"out_range_errors"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|u0
operator|.
name|xe201
operator|.
name|rx_out_of_range_errors
argument_list|,
literal|0
argument_list|,
literal|"Out Range Errors"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UQUAD
argument_list|(
name|ctx
argument_list|,
name|rx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"frame_too_long"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|u0
operator|.
name|xe201
operator|.
name|rx_frames_too_long
argument_list|,
literal|"Frame Too Long"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|rx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"address_match_errors"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|u0
operator|.
name|xe201
operator|.
name|rx_address_match_errors
argument_list|,
literal|0
argument_list|,
literal|"Address Match Errors"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|rx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"dropped_too_small"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|u0
operator|.
name|xe201
operator|.
name|rx_dropped_too_small
argument_list|,
literal|0
argument_list|,
literal|"Dropped Too Small"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|rx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"dropped_too_short"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|u0
operator|.
name|xe201
operator|.
name|rx_dropped_too_short
argument_list|,
literal|0
argument_list|,
literal|"Dropped Too Short"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|rx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"dropped_header_too_small"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|u0
operator|.
name|xe201
operator|.
name|rx_dropped_header_too_small
argument_list|,
literal|0
argument_list|,
literal|"Dropped Header Too Small"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|rx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"dropped_tcp_length"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|u0
operator|.
name|xe201
operator|.
name|rx_dropped_invalid_tcp_length
argument_list|,
literal|0
argument_list|,
literal|"Dropped TCP Length"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|rx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"dropped_runt"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|u0
operator|.
name|xe201
operator|.
name|rx_dropped_runt
argument_list|,
literal|0
argument_list|,
literal|"Dropped runt"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|rx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"ip_checksum_errs"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|u0
operator|.
name|xe201
operator|.
name|rx_ip_checksum_errors
argument_list|,
literal|0
argument_list|,
literal|"IP Checksum Errors"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|rx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tcp_checksum_errs"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|u0
operator|.
name|xe201
operator|.
name|rx_tcp_checksum_errors
argument_list|,
literal|0
argument_list|,
literal|"TCP Checksum Errors"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|rx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"udp_checksum_errs"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|u0
operator|.
name|xe201
operator|.
name|rx_udp_checksum_errors
argument_list|,
literal|0
argument_list|,
literal|"UDP Checksum Errors"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|rx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"input_fifo_overflow_drop"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|u0
operator|.
name|xe201
operator|.
name|rx_fifo_overflow
argument_list|,
literal|0
argument_list|,
literal|"Input FIFO Overflow Drop"
argument_list|)
expr_stmt|;
name|tx_stats_node
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|stats_node
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx"
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|NULL
argument_list|,
literal|"TX Ethernet Statistics"
argument_list|)
expr_stmt|;
name|tx_stat_list
operator|=
name|SYSCTL_CHILDREN
argument_list|(
name|tx_stats_node
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|tx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"total_tx_pkts"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|tx
operator|.
name|t_tx_pkts
argument_list|,
literal|"Total Transmit Packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|tx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"total_tx_bytes"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|tx
operator|.
name|t_tx_bytes
argument_list|,
literal|"Total Transmit Bytes"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|tx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"total_tx_reqs"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|tx
operator|.
name|t_tx_reqs
argument_list|,
literal|0
argument_list|,
literal|"Total Transmit Requests"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|tx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"total_tx_stops"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|tx
operator|.
name|t_tx_stops
argument_list|,
literal|0
argument_list|,
literal|"Total Transmit Stops"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|tx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"total_tx_wrbs"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|tx
operator|.
name|t_tx_wrbs
argument_list|,
literal|0
argument_list|,
literal|"Total Transmit WRB's"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|tx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"total_tx_compl"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|tx
operator|.
name|t_tx_compl
argument_list|,
literal|0
argument_list|,
literal|"Total Transmit Completions"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|tx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"total_ipv6_ext_hdr_tx_drop"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|tx
operator|.
name|t_ipv6_ext_hdr_tx_drop
argument_list|,
literal|0
argument_list|,
literal|"Total Transmit IPV6 Drops"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UQUAD
argument_list|(
name|ctx
argument_list|,
name|tx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"pauseframes"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|u0
operator|.
name|xe201
operator|.
name|tx_pause_frames
argument_list|,
literal|"Pause Frames"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UQUAD
argument_list|(
name|ctx
argument_list|,
name|tx_stat_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"controlframes"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|u0
operator|.
name|xe201
operator|.
name|tx_control_frames
argument_list|,
literal|"Tx Control Frames"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|nwqs
condition|;
name|i
operator|++
control|)
block|{
name|sprintf
argument_list|(
name|prefix
argument_list|,
literal|"queue%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|queue_stats_node
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|tx_stats_node
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
name|prefix
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|NULL
argument_list|,
literal|"Queue name"
argument_list|)
expr_stmt|;
name|queue_stats_list
operator|=
name|SYSCTL_CHILDREN
argument_list|(
name|queue_stats_node
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|queue_stats_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_pkts"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|wq
index|[
name|i
index|]
operator|->
name|tx_stats
operator|.
name|tx_pkts
argument_list|,
literal|"Transmit Packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|queue_stats_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_bytes"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|wq
index|[
name|i
index|]
operator|->
name|tx_stats
operator|.
name|tx_bytes
argument_list|,
literal|"Transmit Bytes"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|queue_stats_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_reqs"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|wq
index|[
name|i
index|]
operator|->
name|tx_stats
operator|.
name|tx_reqs
argument_list|,
literal|0
argument_list|,
literal|"Transmit Requests"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|queue_stats_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_stops"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|wq
index|[
name|i
index|]
operator|->
name|tx_stats
operator|.
name|tx_stops
argument_list|,
literal|0
argument_list|,
literal|"Transmit Stops"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|queue_stats_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_wrbs"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|wq
index|[
name|i
index|]
operator|->
name|tx_stats
operator|.
name|tx_wrbs
argument_list|,
literal|0
argument_list|,
literal|"Transmit WRB's"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|queue_stats_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_compl"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|wq
index|[
name|i
index|]
operator|->
name|tx_stats
operator|.
name|tx_compl
argument_list|,
literal|0
argument_list|,
literal|"Transmit Completions"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|queue_stats_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"ipv6_ext_hdr_tx_drop"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|wq
index|[
name|i
index|]
operator|->
name|tx_stats
operator|.
name|ipv6_ext_hdr_tx_drop
argument_list|,
literal|0
argument_list|,
literal|"Transmit IPV6 Ext Header Drop"
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
name|void
name|oce_refresh_queue_stats
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|)
block|{
name|struct
name|oce_drv_stats
modifier|*
name|adapter_stats
decl_stmt|;
name|int
name|i
decl_stmt|;
name|adapter_stats
operator|=
operator|&
name|sc
operator|->
name|oce_stats_info
expr_stmt|;
comment|/* Caluculate total TX and TXstats from all queues */
name|bzero
argument_list|(
operator|&
name|adapter_stats
operator|->
name|rx
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|oce_rx_stats
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|nrqs
condition|;
name|i
operator|++
control|)
block|{
name|adapter_stats
operator|->
name|rx
operator|.
name|t_rx_pkts
operator|+=
name|sc
operator|->
name|rq
index|[
name|i
index|]
operator|->
name|rx_stats
operator|.
name|rx_pkts
expr_stmt|;
name|adapter_stats
operator|->
name|rx
operator|.
name|t_rx_bytes
operator|+=
name|sc
operator|->
name|rq
index|[
name|i
index|]
operator|->
name|rx_stats
operator|.
name|rx_bytes
expr_stmt|;
name|adapter_stats
operator|->
name|rx
operator|.
name|t_rx_frags
operator|+=
name|sc
operator|->
name|rq
index|[
name|i
index|]
operator|->
name|rx_stats
operator|.
name|rx_frags
expr_stmt|;
name|adapter_stats
operator|->
name|rx
operator|.
name|t_rx_mcast_pkts
operator|+=
name|sc
operator|->
name|rq
index|[
name|i
index|]
operator|->
name|rx_stats
operator|.
name|rx_mcast_pkts
expr_stmt|;
name|adapter_stats
operator|->
name|rx
operator|.
name|t_rx_ucast_pkts
operator|+=
name|sc
operator|->
name|rq
index|[
name|i
index|]
operator|->
name|rx_stats
operator|.
name|rx_ucast_pkts
expr_stmt|;
name|adapter_stats
operator|->
name|rx
operator|.
name|t_rxcp_errs
operator|+=
name|sc
operator|->
name|rq
index|[
name|i
index|]
operator|->
name|rx_stats
operator|.
name|rxcp_err
expr_stmt|;
block|}
name|bzero
argument_list|(
operator|&
name|adapter_stats
operator|->
name|tx
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|oce_tx_stats
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|nwqs
condition|;
name|i
operator|++
control|)
block|{
name|adapter_stats
operator|->
name|tx
operator|.
name|t_tx_reqs
operator|+=
name|sc
operator|->
name|wq
index|[
name|i
index|]
operator|->
name|tx_stats
operator|.
name|tx_reqs
expr_stmt|;
name|adapter_stats
operator|->
name|tx
operator|.
name|t_tx_stops
operator|+=
name|sc
operator|->
name|wq
index|[
name|i
index|]
operator|->
name|tx_stats
operator|.
name|tx_stops
expr_stmt|;
name|adapter_stats
operator|->
name|tx
operator|.
name|t_tx_wrbs
operator|+=
name|sc
operator|->
name|wq
index|[
name|i
index|]
operator|->
name|tx_stats
operator|.
name|tx_wrbs
expr_stmt|;
name|adapter_stats
operator|->
name|tx
operator|.
name|t_tx_compl
operator|+=
name|sc
operator|->
name|wq
index|[
name|i
index|]
operator|->
name|tx_stats
operator|.
name|tx_compl
expr_stmt|;
name|adapter_stats
operator|->
name|tx
operator|.
name|t_tx_bytes
operator|+=
name|sc
operator|->
name|wq
index|[
name|i
index|]
operator|->
name|tx_stats
operator|.
name|tx_bytes
expr_stmt|;
name|adapter_stats
operator|->
name|tx
operator|.
name|t_tx_pkts
operator|+=
name|sc
operator|->
name|wq
index|[
name|i
index|]
operator|->
name|tx_stats
operator|.
name|tx_pkts
expr_stmt|;
name|adapter_stats
operator|->
name|tx
operator|.
name|t_ipv6_ext_hdr_tx_drop
operator|+=
name|sc
operator|->
name|wq
index|[
name|i
index|]
operator|->
name|tx_stats
operator|.
name|ipv6_ext_hdr_tx_drop
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|copy_stats_to_sc_xe201
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|)
block|{
name|struct
name|oce_xe201_stats
modifier|*
name|adapter_stats
decl_stmt|;
name|struct
name|mbx_get_pport_stats
modifier|*
name|nic_mbx
decl_stmt|;
name|struct
name|pport_stats
modifier|*
name|port_stats
decl_stmt|;
name|nic_mbx
operator|=
name|OCE_DMAPTR
argument_list|(
operator|&
name|sc
operator|->
name|stats_mem
argument_list|,
expr|struct
name|mbx_get_pport_stats
argument_list|)
expr_stmt|;
name|port_stats
operator|=
operator|&
name|nic_mbx
operator|->
name|params
operator|.
name|rsp
operator|.
name|pps
expr_stmt|;
name|adapter_stats
operator|=
operator|&
name|sc
operator|->
name|oce_stats_info
operator|.
name|u0
operator|.
name|xe201
expr_stmt|;
name|adapter_stats
operator|->
name|tx_pkts
operator|=
name|port_stats
operator|->
name|tx_pkts
expr_stmt|;
name|adapter_stats
operator|->
name|tx_unicast_pkts
operator|=
name|port_stats
operator|->
name|tx_unicast_pkts
expr_stmt|;
name|adapter_stats
operator|->
name|tx_multicast_pkts
operator|=
name|port_stats
operator|->
name|tx_multicast_pkts
expr_stmt|;
name|adapter_stats
operator|->
name|tx_broadcast_pkts
operator|=
name|port_stats
operator|->
name|tx_broadcast_pkts
expr_stmt|;
name|adapter_stats
operator|->
name|tx_bytes
operator|=
name|port_stats
operator|->
name|tx_bytes
expr_stmt|;
name|adapter_stats
operator|->
name|tx_unicast_bytes
operator|=
name|port_stats
operator|->
name|tx_unicast_bytes
expr_stmt|;
name|adapter_stats
operator|->
name|tx_multicast_bytes
operator|=
name|port_stats
operator|->
name|tx_multicast_bytes
expr_stmt|;
name|adapter_stats
operator|->
name|tx_broadcast_bytes
operator|=
name|port_stats
operator|->
name|tx_broadcast_bytes
expr_stmt|;
name|adapter_stats
operator|->
name|tx_discards
operator|=
name|port_stats
operator|->
name|tx_discards
expr_stmt|;
name|adapter_stats
operator|->
name|tx_errors
operator|=
name|port_stats
operator|->
name|tx_errors
expr_stmt|;
name|adapter_stats
operator|->
name|tx_pause_frames
operator|=
name|port_stats
operator|->
name|tx_pause_frames
expr_stmt|;
name|adapter_stats
operator|->
name|tx_pause_on_frames
operator|=
name|port_stats
operator|->
name|tx_pause_on_frames
expr_stmt|;
name|adapter_stats
operator|->
name|tx_pause_off_frames
operator|=
name|port_stats
operator|->
name|tx_pause_off_frames
expr_stmt|;
name|adapter_stats
operator|->
name|tx_internal_mac_errors
operator|=
name|port_stats
operator|->
name|tx_internal_mac_errors
expr_stmt|;
name|adapter_stats
operator|->
name|tx_control_frames
operator|=
name|port_stats
operator|->
name|tx_control_frames
expr_stmt|;
name|adapter_stats
operator|->
name|tx_pkts_64_bytes
operator|=
name|port_stats
operator|->
name|tx_pkts_64_bytes
expr_stmt|;
name|adapter_stats
operator|->
name|tx_pkts_65_to_127_bytes
operator|=
name|port_stats
operator|->
name|tx_pkts_65_to_127_bytes
expr_stmt|;
name|adapter_stats
operator|->
name|tx_pkts_128_to_255_bytes
operator|=
name|port_stats
operator|->
name|tx_pkts_128_to_255_bytes
expr_stmt|;
name|adapter_stats
operator|->
name|tx_pkts_256_to_511_bytes
operator|=
name|port_stats
operator|->
name|tx_pkts_256_to_511_bytes
expr_stmt|;
name|adapter_stats
operator|->
name|tx_pkts_512_to_1023_bytes
operator|=
name|port_stats
operator|->
name|tx_pkts_512_to_1023_bytes
expr_stmt|;
name|adapter_stats
operator|->
name|tx_pkts_1024_to_1518_bytes
operator|=
name|port_stats
operator|->
name|tx_pkts_1024_to_1518_bytes
expr_stmt|;
name|adapter_stats
operator|->
name|tx_pkts_1519_to_2047_bytes
operator|=
name|port_stats
operator|->
name|tx_pkts_1519_to_2047_bytes
expr_stmt|;
name|adapter_stats
operator|->
name|tx_pkts_2048_to_4095_bytes
operator|=
name|port_stats
operator|->
name|tx_pkts_2048_to_4095_bytes
expr_stmt|;
name|adapter_stats
operator|->
name|tx_pkts_4096_to_8191_bytes
operator|=
name|port_stats
operator|->
name|tx_pkts_4096_to_8191_bytes
expr_stmt|;
name|adapter_stats
operator|->
name|tx_pkts_8192_to_9216_bytes
operator|=
name|port_stats
operator|->
name|tx_pkts_8192_to_9216_bytes
expr_stmt|;
name|adapter_stats
operator|->
name|tx_lso_pkts
operator|=
name|port_stats
operator|->
name|tx_lso_pkts
expr_stmt|;
name|adapter_stats
operator|->
name|rx_pkts
operator|=
name|port_stats
operator|->
name|rx_pkts
expr_stmt|;
name|adapter_stats
operator|->
name|rx_unicast_pkts
operator|=
name|port_stats
operator|->
name|rx_unicast_pkts
expr_stmt|;
name|adapter_stats
operator|->
name|rx_multicast_pkts
operator|=
name|port_stats
operator|->
name|rx_multicast_pkts
expr_stmt|;
name|adapter_stats
operator|->
name|rx_broadcast_pkts
operator|=
name|port_stats
operator|->
name|rx_broadcast_pkts
expr_stmt|;
name|adapter_stats
operator|->
name|rx_bytes
operator|=
name|port_stats
operator|->
name|rx_bytes
expr_stmt|;
name|adapter_stats
operator|->
name|rx_unicast_bytes
operator|=
name|port_stats
operator|->
name|rx_unicast_bytes
expr_stmt|;
name|adapter_stats
operator|->
name|rx_multicast_bytes
operator|=
name|port_stats
operator|->
name|rx_multicast_bytes
expr_stmt|;
name|adapter_stats
operator|->
name|rx_broadcast_bytes
operator|=
name|port_stats
operator|->
name|rx_broadcast_bytes
expr_stmt|;
name|adapter_stats
operator|->
name|rx_unknown_protos
operator|=
name|port_stats
operator|->
name|rx_unknown_protos
expr_stmt|;
name|adapter_stats
operator|->
name|rx_discards
operator|=
name|port_stats
operator|->
name|rx_discards
expr_stmt|;
name|adapter_stats
operator|->
name|rx_errors
operator|=
name|port_stats
operator|->
name|rx_errors
expr_stmt|;
name|adapter_stats
operator|->
name|rx_crc_errors
operator|=
name|port_stats
operator|->
name|rx_crc_errors
expr_stmt|;
name|adapter_stats
operator|->
name|rx_alignment_errors
operator|=
name|port_stats
operator|->
name|rx_alignment_errors
expr_stmt|;
name|adapter_stats
operator|->
name|rx_symbol_errors
operator|=
name|port_stats
operator|->
name|rx_symbol_errors
expr_stmt|;
name|adapter_stats
operator|->
name|rx_pause_frames
operator|=
name|port_stats
operator|->
name|rx_pause_frames
expr_stmt|;
name|adapter_stats
operator|->
name|rx_pause_on_frames
operator|=
name|port_stats
operator|->
name|rx_pause_on_frames
expr_stmt|;
name|adapter_stats
operator|->
name|rx_pause_off_frames
operator|=
name|port_stats
operator|->
name|rx_pause_off_frames
expr_stmt|;
name|adapter_stats
operator|->
name|rx_frames_too_long
operator|=
name|port_stats
operator|->
name|rx_frames_too_long
expr_stmt|;
name|adapter_stats
operator|->
name|rx_internal_mac_errors
operator|=
name|port_stats
operator|->
name|rx_internal_mac_errors
expr_stmt|;
name|adapter_stats
operator|->
name|rx_undersize_pkts
operator|=
name|port_stats
operator|->
name|rx_undersize_pkts
expr_stmt|;
name|adapter_stats
operator|->
name|rx_oversize_pkts
operator|=
name|port_stats
operator|->
name|rx_oversize_pkts
expr_stmt|;
name|adapter_stats
operator|->
name|rx_fragment_pkts
operator|=
name|port_stats
operator|->
name|rx_fragment_pkts
expr_stmt|;
name|adapter_stats
operator|->
name|rx_jabbers
operator|=
name|port_stats
operator|->
name|rx_jabbers
expr_stmt|;
name|adapter_stats
operator|->
name|rx_control_frames
operator|=
name|port_stats
operator|->
name|rx_control_frames
expr_stmt|;
name|adapter_stats
operator|->
name|rx_control_frames_unknown_opcode
operator|=
name|port_stats
operator|->
name|rx_control_frames_unknown_opcode
expr_stmt|;
name|adapter_stats
operator|->
name|rx_in_range_errors
operator|=
name|port_stats
operator|->
name|rx_in_range_errors
expr_stmt|;
name|adapter_stats
operator|->
name|rx_out_of_range_errors
operator|=
name|port_stats
operator|->
name|rx_out_of_range_errors
expr_stmt|;
name|adapter_stats
operator|->
name|rx_address_match_errors
operator|=
name|port_stats
operator|->
name|rx_address_match_errors
expr_stmt|;
name|adapter_stats
operator|->
name|rx_vlan_mismatch_errors
operator|=
name|port_stats
operator|->
name|rx_vlan_mismatch_errors
expr_stmt|;
name|adapter_stats
operator|->
name|rx_dropped_too_small
operator|=
name|port_stats
operator|->
name|rx_dropped_too_small
expr_stmt|;
name|adapter_stats
operator|->
name|rx_dropped_too_short
operator|=
name|port_stats
operator|->
name|rx_dropped_too_short
expr_stmt|;
name|adapter_stats
operator|->
name|rx_dropped_header_too_small
operator|=
name|port_stats
operator|->
name|rx_dropped_header_too_small
expr_stmt|;
name|adapter_stats
operator|->
name|rx_dropped_invalid_tcp_length
operator|=
name|port_stats
operator|->
name|rx_dropped_invalid_tcp_length
expr_stmt|;
name|adapter_stats
operator|->
name|rx_dropped_runt
operator|=
name|port_stats
operator|->
name|rx_dropped_runt
expr_stmt|;
name|adapter_stats
operator|->
name|rx_ip_checksum_errors
operator|=
name|port_stats
operator|->
name|rx_ip_checksum_errors
expr_stmt|;
name|adapter_stats
operator|->
name|rx_tcp_checksum_errors
operator|=
name|port_stats
operator|->
name|rx_tcp_checksum_errors
expr_stmt|;
name|adapter_stats
operator|->
name|rx_udp_checksum_errors
operator|=
name|port_stats
operator|->
name|rx_udp_checksum_errors
expr_stmt|;
name|adapter_stats
operator|->
name|rx_non_rss_pkts
operator|=
name|port_stats
operator|->
name|rx_non_rss_pkts
expr_stmt|;
name|adapter_stats
operator|->
name|rx_ipv4_pkts
operator|=
name|port_stats
operator|->
name|rx_ipv4_pkts
expr_stmt|;
name|adapter_stats
operator|->
name|rx_ipv6_pkts
operator|=
name|port_stats
operator|->
name|rx_ipv6_pkts
expr_stmt|;
name|adapter_stats
operator|->
name|rx_ipv4_bytes
operator|=
name|port_stats
operator|->
name|rx_ipv4_bytes
expr_stmt|;
name|adapter_stats
operator|->
name|rx_ipv6_bytes
operator|=
name|port_stats
operator|->
name|rx_ipv6_bytes
expr_stmt|;
name|adapter_stats
operator|->
name|rx_nic_pkts
operator|=
name|port_stats
operator|->
name|rx_nic_pkts
expr_stmt|;
name|adapter_stats
operator|->
name|rx_tcp_pkts
operator|=
name|port_stats
operator|->
name|rx_tcp_pkts
expr_stmt|;
name|adapter_stats
operator|->
name|rx_iscsi_pkts
operator|=
name|port_stats
operator|->
name|rx_iscsi_pkts
expr_stmt|;
name|adapter_stats
operator|->
name|rx_management_pkts
operator|=
name|port_stats
operator|->
name|rx_management_pkts
expr_stmt|;
name|adapter_stats
operator|->
name|rx_switched_unicast_pkts
operator|=
name|port_stats
operator|->
name|rx_switched_unicast_pkts
expr_stmt|;
name|adapter_stats
operator|->
name|rx_switched_multicast_pkts
operator|=
name|port_stats
operator|->
name|rx_switched_multicast_pkts
expr_stmt|;
name|adapter_stats
operator|->
name|rx_switched_broadcast_pkts
operator|=
name|port_stats
operator|->
name|rx_switched_broadcast_pkts
expr_stmt|;
name|adapter_stats
operator|->
name|num_forwards
operator|=
name|port_stats
operator|->
name|num_forwards
expr_stmt|;
name|adapter_stats
operator|->
name|rx_fifo_overflow
operator|=
name|port_stats
operator|->
name|rx_fifo_overflow
expr_stmt|;
name|adapter_stats
operator|->
name|rx_input_fifo_overflow
operator|=
name|port_stats
operator|->
name|rx_input_fifo_overflow
expr_stmt|;
name|adapter_stats
operator|->
name|rx_drops_too_many_frags
operator|=
name|port_stats
operator|->
name|rx_drops_too_many_frags
expr_stmt|;
name|adapter_stats
operator|->
name|rx_drops_invalid_queue
operator|=
name|port_stats
operator|->
name|rx_drops_invalid_queue
expr_stmt|;
name|adapter_stats
operator|->
name|rx_drops_mtu
operator|=
name|port_stats
operator|->
name|rx_drops_mtu
expr_stmt|;
name|adapter_stats
operator|->
name|rx_pkts_64_bytes
operator|=
name|port_stats
operator|->
name|rx_pkts_64_bytes
expr_stmt|;
name|adapter_stats
operator|->
name|rx_pkts_65_to_127_bytes
operator|=
name|port_stats
operator|->
name|rx_pkts_65_to_127_bytes
expr_stmt|;
name|adapter_stats
operator|->
name|rx_pkts_128_to_255_bytes
operator|=
name|port_stats
operator|->
name|rx_pkts_128_to_255_bytes
expr_stmt|;
name|adapter_stats
operator|->
name|rx_pkts_256_to_511_bytes
operator|=
name|port_stats
operator|->
name|rx_pkts_256_to_511_bytes
expr_stmt|;
name|adapter_stats
operator|->
name|rx_pkts_512_to_1023_bytes
operator|=
name|port_stats
operator|->
name|rx_pkts_512_to_1023_bytes
expr_stmt|;
name|adapter_stats
operator|->
name|rx_pkts_1024_to_1518_bytes
operator|=
name|port_stats
operator|->
name|rx_pkts_1024_to_1518_bytes
expr_stmt|;
name|adapter_stats
operator|->
name|rx_pkts_1519_to_2047_bytes
operator|=
name|port_stats
operator|->
name|rx_pkts_1519_to_2047_bytes
expr_stmt|;
name|adapter_stats
operator|->
name|rx_pkts_2048_to_4095_bytes
operator|=
name|port_stats
operator|->
name|rx_pkts_2048_to_4095_bytes
expr_stmt|;
name|adapter_stats
operator|->
name|rx_pkts_4096_to_8191_bytes
operator|=
name|port_stats
operator|->
name|rx_pkts_4096_to_8191_bytes
expr_stmt|;
name|adapter_stats
operator|->
name|rx_pkts_8192_to_9216_bytes
operator|=
name|port_stats
operator|->
name|rx_pkts_8192_to_9216_bytes
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|copy_stats_to_sc_be2
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|)
block|{
name|struct
name|oce_be_stats
modifier|*
name|adapter_stats
decl_stmt|;
name|struct
name|oce_pmem_stats
modifier|*
name|pmem
decl_stmt|;
name|struct
name|oce_rxf_stats_v0
modifier|*
name|rxf_stats
decl_stmt|;
name|struct
name|oce_port_rxf_stats_v0
modifier|*
name|port_stats
decl_stmt|;
name|struct
name|mbx_get_nic_stats_v0
modifier|*
name|nic_mbx
decl_stmt|;
name|uint32_t
name|port
init|=
name|sc
operator|->
name|port_id
decl_stmt|;
name|nic_mbx
operator|=
name|OCE_DMAPTR
argument_list|(
operator|&
name|sc
operator|->
name|stats_mem
argument_list|,
expr|struct
name|mbx_get_nic_stats_v0
argument_list|)
expr_stmt|;
name|pmem
operator|=
operator|&
name|nic_mbx
operator|->
name|params
operator|.
name|rsp
operator|.
name|stats
operator|.
name|pmem
expr_stmt|;
name|rxf_stats
operator|=
operator|&
name|nic_mbx
operator|->
name|params
operator|.
name|rsp
operator|.
name|stats
operator|.
name|rxf
expr_stmt|;
name|port_stats
operator|=
operator|&
name|nic_mbx
operator|->
name|params
operator|.
name|rsp
operator|.
name|stats
operator|.
name|rxf
operator|.
name|port
index|[
name|port
index|]
expr_stmt|;
name|adapter_stats
operator|=
operator|&
name|sc
operator|->
name|oce_stats_info
operator|.
name|u0
operator|.
name|be
expr_stmt|;
comment|/* Update stats */
name|adapter_stats
operator|->
name|rx_pause_frames
operator|=
name|port_stats
operator|->
name|rx_pause_frames
expr_stmt|;
name|adapter_stats
operator|->
name|rx_crc_errors
operator|=
name|port_stats
operator|->
name|rx_crc_errors
expr_stmt|;
name|adapter_stats
operator|->
name|rx_control_frames
operator|=
name|port_stats
operator|->
name|rx_control_frames
expr_stmt|;
name|adapter_stats
operator|->
name|rx_in_range_errors
operator|=
name|port_stats
operator|->
name|rx_in_range_errors
expr_stmt|;
name|adapter_stats
operator|->
name|rx_frame_too_long
operator|=
name|port_stats
operator|->
name|rx_frame_too_long
expr_stmt|;
name|adapter_stats
operator|->
name|rx_dropped_runt
operator|=
name|port_stats
operator|->
name|rx_dropped_runt
expr_stmt|;
name|adapter_stats
operator|->
name|rx_ip_checksum_errs
operator|=
name|port_stats
operator|->
name|rx_ip_checksum_errs
expr_stmt|;
name|adapter_stats
operator|->
name|rx_tcp_checksum_errs
operator|=
name|port_stats
operator|->
name|rx_tcp_checksum_errs
expr_stmt|;
name|adapter_stats
operator|->
name|rx_udp_checksum_errs
operator|=
name|port_stats
operator|->
name|rx_udp_checksum_errs
expr_stmt|;
name|adapter_stats
operator|->
name|rxpp_fifo_overflow_drop
operator|=
name|port_stats
operator|->
name|rxpp_fifo_overflow_drop
expr_stmt|;
name|adapter_stats
operator|->
name|rx_dropped_tcp_length
operator|=
name|port_stats
operator|->
name|rx_dropped_tcp_length
expr_stmt|;
name|adapter_stats
operator|->
name|rx_dropped_too_small
operator|=
name|port_stats
operator|->
name|rx_dropped_too_small
expr_stmt|;
name|adapter_stats
operator|->
name|rx_dropped_too_short
operator|=
name|port_stats
operator|->
name|rx_dropped_too_short
expr_stmt|;
name|adapter_stats
operator|->
name|rx_out_range_errors
operator|=
name|port_stats
operator|->
name|rx_out_range_errors
expr_stmt|;
name|adapter_stats
operator|->
name|rx_dropped_header_too_small
operator|=
name|port_stats
operator|->
name|rx_dropped_header_too_small
expr_stmt|;
name|adapter_stats
operator|->
name|rx_input_fifo_overflow_drop
operator|=
name|port_stats
operator|->
name|rx_input_fifo_overflow_drop
expr_stmt|;
name|adapter_stats
operator|->
name|rx_address_match_errors
operator|=
name|port_stats
operator|->
name|rx_address_match_errors
expr_stmt|;
name|adapter_stats
operator|->
name|rx_alignment_symbol_errors
operator|=
name|port_stats
operator|->
name|rx_alignment_symbol_errors
expr_stmt|;
name|adapter_stats
operator|->
name|tx_pauseframes
operator|=
name|port_stats
operator|->
name|tx_pauseframes
expr_stmt|;
name|adapter_stats
operator|->
name|tx_controlframes
operator|=
name|port_stats
operator|->
name|tx_controlframes
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|if_id
condition|)
name|adapter_stats
operator|->
name|jabber_events
operator|=
name|rxf_stats
operator|->
name|port1_jabber_events
expr_stmt|;
else|else
name|adapter_stats
operator|->
name|jabber_events
operator|=
name|rxf_stats
operator|->
name|port0_jabber_events
expr_stmt|;
name|adapter_stats
operator|->
name|rx_drops_no_pbuf
operator|=
name|rxf_stats
operator|->
name|rx_drops_no_pbuf
expr_stmt|;
name|adapter_stats
operator|->
name|rx_drops_no_txpb
operator|=
name|rxf_stats
operator|->
name|rx_drops_no_txpb
expr_stmt|;
name|adapter_stats
operator|->
name|rx_drops_no_erx_descr
operator|=
name|rxf_stats
operator|->
name|rx_drops_no_erx_descr
expr_stmt|;
name|adapter_stats
operator|->
name|rx_drops_invalid_ring
operator|=
name|rxf_stats
operator|->
name|rx_drops_invalid_ring
expr_stmt|;
name|adapter_stats
operator|->
name|forwarded_packets
operator|=
name|rxf_stats
operator|->
name|forwarded_packets
expr_stmt|;
name|adapter_stats
operator|->
name|rx_drops_mtu
operator|=
name|rxf_stats
operator|->
name|rx_drops_mtu
expr_stmt|;
name|adapter_stats
operator|->
name|rx_drops_no_tpre_descr
operator|=
name|rxf_stats
operator|->
name|rx_drops_no_tpre_descr
expr_stmt|;
name|adapter_stats
operator|->
name|rx_drops_too_many_frags
operator|=
name|rxf_stats
operator|->
name|rx_drops_too_many_frags
expr_stmt|;
name|adapter_stats
operator|->
name|eth_red_drops
operator|=
name|pmem
operator|->
name|eth_red_drops
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|copy_stats_to_sc_be3
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|)
block|{
name|struct
name|oce_be_stats
modifier|*
name|adapter_stats
decl_stmt|;
name|struct
name|oce_pmem_stats
modifier|*
name|pmem
decl_stmt|;
name|struct
name|oce_rxf_stats_v1
modifier|*
name|rxf_stats
decl_stmt|;
name|struct
name|oce_port_rxf_stats_v1
modifier|*
name|port_stats
decl_stmt|;
name|struct
name|mbx_get_nic_stats
modifier|*
name|nic_mbx
decl_stmt|;
name|uint32_t
name|port
init|=
name|sc
operator|->
name|port_id
decl_stmt|;
name|nic_mbx
operator|=
name|OCE_DMAPTR
argument_list|(
operator|&
name|sc
operator|->
name|stats_mem
argument_list|,
expr|struct
name|mbx_get_nic_stats
argument_list|)
expr_stmt|;
name|pmem
operator|=
operator|&
name|nic_mbx
operator|->
name|params
operator|.
name|rsp
operator|.
name|stats
operator|.
name|pmem
expr_stmt|;
name|rxf_stats
operator|=
operator|&
name|nic_mbx
operator|->
name|params
operator|.
name|rsp
operator|.
name|stats
operator|.
name|rxf
expr_stmt|;
name|port_stats
operator|=
operator|&
name|nic_mbx
operator|->
name|params
operator|.
name|rsp
operator|.
name|stats
operator|.
name|rxf
operator|.
name|port
index|[
name|port
index|]
expr_stmt|;
name|adapter_stats
operator|=
operator|&
name|sc
operator|->
name|oce_stats_info
operator|.
name|u0
operator|.
name|be
expr_stmt|;
comment|/* Update stats */
name|adapter_stats
operator|->
name|pmem_fifo_overflow_drop
operator|=
name|port_stats
operator|->
name|pmem_fifo_overflow_drop
expr_stmt|;
name|adapter_stats
operator|->
name|rx_priority_pause_frames
operator|=
name|port_stats
operator|->
name|rx_priority_pause_frames
expr_stmt|;
name|adapter_stats
operator|->
name|rx_pause_frames
operator|=
name|port_stats
operator|->
name|rx_pause_frames
expr_stmt|;
name|adapter_stats
operator|->
name|rx_crc_errors
operator|=
name|port_stats
operator|->
name|rx_crc_errors
expr_stmt|;
name|adapter_stats
operator|->
name|rx_control_frames
operator|=
name|port_stats
operator|->
name|rx_control_frames
expr_stmt|;
name|adapter_stats
operator|->
name|rx_in_range_errors
operator|=
name|port_stats
operator|->
name|rx_in_range_errors
expr_stmt|;
name|adapter_stats
operator|->
name|rx_frame_too_long
operator|=
name|port_stats
operator|->
name|rx_frame_too_long
expr_stmt|;
name|adapter_stats
operator|->
name|rx_dropped_runt
operator|=
name|port_stats
operator|->
name|rx_dropped_runt
expr_stmt|;
name|adapter_stats
operator|->
name|rx_ip_checksum_errs
operator|=
name|port_stats
operator|->
name|rx_ip_checksum_errs
expr_stmt|;
name|adapter_stats
operator|->
name|rx_tcp_checksum_errs
operator|=
name|port_stats
operator|->
name|rx_tcp_checksum_errs
expr_stmt|;
name|adapter_stats
operator|->
name|rx_udp_checksum_errs
operator|=
name|port_stats
operator|->
name|rx_udp_checksum_errs
expr_stmt|;
name|adapter_stats
operator|->
name|rx_dropped_tcp_length
operator|=
name|port_stats
operator|->
name|rx_dropped_tcp_length
expr_stmt|;
name|adapter_stats
operator|->
name|rx_dropped_too_small
operator|=
name|port_stats
operator|->
name|rx_dropped_too_small
expr_stmt|;
name|adapter_stats
operator|->
name|rx_dropped_too_short
operator|=
name|port_stats
operator|->
name|rx_dropped_too_short
expr_stmt|;
name|adapter_stats
operator|->
name|rx_out_range_errors
operator|=
name|port_stats
operator|->
name|rx_out_range_errors
expr_stmt|;
name|adapter_stats
operator|->
name|rx_dropped_header_too_small
operator|=
name|port_stats
operator|->
name|rx_dropped_header_too_small
expr_stmt|;
name|adapter_stats
operator|->
name|rx_input_fifo_overflow_drop
operator|=
name|port_stats
operator|->
name|rx_input_fifo_overflow_drop
expr_stmt|;
name|adapter_stats
operator|->
name|rx_address_match_errors
operator|=
name|port_stats
operator|->
name|rx_address_match_errors
expr_stmt|;
name|adapter_stats
operator|->
name|rx_alignment_symbol_errors
operator|=
name|port_stats
operator|->
name|rx_alignment_symbol_errors
expr_stmt|;
name|adapter_stats
operator|->
name|rxpp_fifo_overflow_drop
operator|=
name|port_stats
operator|->
name|rxpp_fifo_overflow_drop
expr_stmt|;
name|adapter_stats
operator|->
name|tx_pauseframes
operator|=
name|port_stats
operator|->
name|tx_pauseframes
expr_stmt|;
name|adapter_stats
operator|->
name|tx_controlframes
operator|=
name|port_stats
operator|->
name|tx_controlframes
expr_stmt|;
name|adapter_stats
operator|->
name|jabber_events
operator|=
name|port_stats
operator|->
name|jabber_events
expr_stmt|;
name|adapter_stats
operator|->
name|rx_drops_no_pbuf
operator|=
name|rxf_stats
operator|->
name|rx_drops_no_pbuf
expr_stmt|;
name|adapter_stats
operator|->
name|rx_drops_no_txpb
operator|=
name|rxf_stats
operator|->
name|rx_drops_no_txpb
expr_stmt|;
name|adapter_stats
operator|->
name|rx_drops_no_erx_descr
operator|=
name|rxf_stats
operator|->
name|rx_drops_no_erx_descr
expr_stmt|;
name|adapter_stats
operator|->
name|rx_drops_invalid_ring
operator|=
name|rxf_stats
operator|->
name|rx_drops_invalid_ring
expr_stmt|;
name|adapter_stats
operator|->
name|forwarded_packets
operator|=
name|rxf_stats
operator|->
name|forwarded_packets
expr_stmt|;
name|adapter_stats
operator|->
name|rx_drops_mtu
operator|=
name|rxf_stats
operator|->
name|rx_drops_mtu
expr_stmt|;
name|adapter_stats
operator|->
name|rx_drops_no_tpre_descr
operator|=
name|rxf_stats
operator|->
name|rx_drops_no_tpre_descr
expr_stmt|;
name|adapter_stats
operator|->
name|rx_drops_too_many_frags
operator|=
name|rxf_stats
operator|->
name|rx_drops_too_many_frags
expr_stmt|;
name|adapter_stats
operator|->
name|eth_red_drops
operator|=
name|pmem
operator|->
name|eth_red_drops
expr_stmt|;
block|}
end_function

begin_function
name|int
name|oce_stats_init
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|)
block|{
name|int
name|rc
init|=
literal|0
decl_stmt|,
name|sz
decl_stmt|;
if|if
condition|(
name|IS_BE
argument_list|(
name|sc
argument_list|)
operator|||
name|IS_SH
argument_list|(
name|sc
argument_list|)
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|flags
operator|&
name|OCE_FLAGS_BE2
condition|)
name|sz
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_get_nic_stats_v0
argument_list|)
expr_stmt|;
else|else
name|sz
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_get_nic_stats
argument_list|)
expr_stmt|;
block|}
else|else
name|sz
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_get_pport_stats
argument_list|)
expr_stmt|;
name|rc
operator|=
name|oce_dma_alloc
argument_list|(
name|sc
argument_list|,
name|sz
argument_list|,
operator|&
name|sc
operator|->
name|stats_mem
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
name|void
name|oce_stats_free
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|)
block|{
name|oce_dma_free
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|stats_mem
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|oce_refresh_nic_stats
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|)
block|{
name|int
name|rc
init|=
literal|0
decl_stmt|,
name|reset
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|IS_BE
argument_list|(
name|sc
argument_list|)
operator|||
name|IS_SH
argument_list|(
name|sc
argument_list|)
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|flags
operator|&
name|OCE_FLAGS_BE2
condition|)
block|{
name|rc
operator|=
name|oce_mbox_get_nic_stats_v0
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|stats_mem
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rc
condition|)
name|copy_stats_to_sc_be2
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|rc
operator|=
name|oce_mbox_get_nic_stats
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|stats_mem
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rc
condition|)
name|copy_stats_to_sc_be3
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|rc
operator|=
name|oce_mbox_get_pport_stats
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|stats_mem
argument_list|,
name|reset
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rc
condition|)
name|copy_stats_to_sc_xe201
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|oce_sysctl_sfp_vpd_dump
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|int
name|result
init|=
literal|0
decl_stmt|,
name|error
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|POCE_SOFTC
name|sc
init|=
operator|(
name|POCE_SOFTC
operator|)
name|arg1
decl_stmt|;
comment|/* sysctl default handler */
name|error
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|result
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|||
operator|!
name|req
operator|->
name|newptr
condition|)
return|return
operator|(
name|error
operator|)
return|;
if|if
condition|(
name|result
operator|==
operator|-
literal|1
condition|)
block|{
return|return
name|EINVAL
return|;
block|}
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
name|sfp_vpd_dump_buffer
argument_list|,
name|TRANSCEIVER_DATA_SIZE
argument_list|)
expr_stmt|;
name|rc
operator|=
name|oce_mbox_read_transrecv_data
argument_list|(
name|sc
argument_list|,
name|PAGE_NUM_A0
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
return|return
name|rc
return|;
name|rc
operator|=
name|oce_mbox_read_transrecv_data
argument_list|(
name|sc
argument_list|,
name|PAGE_NUM_A2
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
return|return
name|rc
return|;
return|return
name|rc
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (C) 2013 Emulex  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions are met:  *  * 1. Redistributions of source code must retain the above copyright notice,  *    this list of conditions and the following disclaimer.  *  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * 3. Neither the name of the Emulex Corporation nor the names of its  *    contributors may be used to endorse or promote products derived from  *    this software without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE  * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE  * POSSIBILITY OF SUCH DAMAGE.  *  * Contact Information:  * freebsd-drivers@emulex.com  *  * Emulex  * 3333 Susan Street  * Costa Mesa, CA 92626  */
end_comment

begin_comment
comment|/* $FreeBSD$ */
end_comment

begin_include
include|#
directive|include
file|"oce_if.h"
end_include

begin_decl_stmt
specifier|extern
name|uint32_t
name|sfp_vpd_dump_buffer
index|[
name|TRANSCEIVER_DATA_NUM_ELE
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/**  * @brief Reset (firmware) common function  * @param sc		software handle to the device  * @returns		0 on success, ETIMEDOUT on failure  */
end_comment

begin_function
name|int
name|oce_reset_fun
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|)
block|{
name|struct
name|oce_mbx
modifier|*
name|mbx
decl_stmt|;
name|struct
name|oce_bmbx
modifier|*
name|mb
decl_stmt|;
name|struct
name|ioctl_common_function_reset
modifier|*
name|fwcmd
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|flags
operator|&
name|OCE_FLAGS_FUNCRESET_RQD
condition|)
block|{
name|mb
operator|=
name|OCE_DMAPTR
argument_list|(
operator|&
name|sc
operator|->
name|bsmbx
argument_list|,
expr|struct
name|oce_bmbx
argument_list|)
expr_stmt|;
name|mbx
operator|=
operator|&
name|mb
operator|->
name|mbx
expr_stmt|;
name|bzero
argument_list|(
name|mbx
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|oce_mbx
argument_list|)
argument_list|)
expr_stmt|;
name|fwcmd
operator|=
operator|(
expr|struct
name|ioctl_common_function_reset
operator|*
operator|)
operator|&
name|mbx
operator|->
name|payload
expr_stmt|;
name|mbx_common_req_hdr_init
argument_list|(
operator|&
name|fwcmd
operator|->
name|hdr
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|MBX_SUBSYSTEM_COMMON
argument_list|,
name|OPCODE_COMMON_FUNCTION_RESET
argument_list|,
literal|10
argument_list|,
comment|/* MBX_TIMEOUT_SEC */
sizeof|sizeof
argument_list|(
expr|struct
name|ioctl_common_function_reset
argument_list|)
argument_list|,
name|OCE_MBX_VER_V0
argument_list|)
expr_stmt|;
name|mbx
operator|->
name|u0
operator|.
name|s
operator|.
name|embedded
operator|=
literal|1
expr_stmt|;
name|mbx
operator|->
name|payload_length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ioctl_common_function_reset
argument_list|)
expr_stmt|;
name|rc
operator|=
name|oce_mbox_dispatch
argument_list|(
name|sc
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
return|return
name|rc
return|;
block|}
end_function

begin_comment
comment|/**  * @brief  		This funtions tells firmware we are  *			done with commands.  * @param sc            software handle to the device  * @returns             0 on success, ETIMEDOUT on failure  */
end_comment

begin_function
name|int
name|oce_fw_clean
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|)
block|{
name|struct
name|oce_bmbx
modifier|*
name|mbx
decl_stmt|;
name|uint8_t
modifier|*
name|ptr
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|mbx
operator|=
name|OCE_DMAPTR
argument_list|(
operator|&
name|sc
operator|->
name|bsmbx
argument_list|,
expr|struct
name|oce_bmbx
argument_list|)
expr_stmt|;
name|ptr
operator|=
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|mbx
operator|->
name|mbx
expr_stmt|;
comment|/* Endian Signature */
operator|*
name|ptr
operator|++
operator|=
literal|0xff
expr_stmt|;
operator|*
name|ptr
operator|++
operator|=
literal|0xaa
expr_stmt|;
operator|*
name|ptr
operator|++
operator|=
literal|0xbb
expr_stmt|;
operator|*
name|ptr
operator|++
operator|=
literal|0xff
expr_stmt|;
operator|*
name|ptr
operator|++
operator|=
literal|0xff
expr_stmt|;
operator|*
name|ptr
operator|++
operator|=
literal|0xcc
expr_stmt|;
operator|*
name|ptr
operator|++
operator|=
literal|0xdd
expr_stmt|;
operator|*
name|ptr
operator|=
literal|0xff
expr_stmt|;
name|ret
operator|=
name|oce_mbox_dispatch
argument_list|(
name|sc
argument_list|,
literal|2
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/**  * @brief Mailbox wait  * @param sc		software handle to the device  * @param tmo_sec	timeout in seconds  */
end_comment

begin_function
specifier|static
name|int
name|oce_mbox_wait
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
name|uint32_t
name|tmo_sec
parameter_list|)
block|{
name|tmo_sec
operator|*=
literal|10000
expr_stmt|;
name|pd_mpu_mbox_db_t
name|mbox_db
decl_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|tmo_sec
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|tmo_sec
operator|==
literal|0
condition|)
break|break;
block|}
name|mbox_db
operator|.
name|dw0
operator|=
name|OCE_READ_REG32
argument_list|(
name|sc
argument_list|,
name|db
argument_list|,
name|PD_MPU_MBOX_DB
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbox_db
operator|.
name|bits
operator|.
name|ready
condition|)
return|return
literal|0
return|;
name|DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
block|}
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Mailbox timed out\n"
argument_list|)
expr_stmt|;
return|return
name|ETIMEDOUT
return|;
block|}
end_function

begin_comment
comment|/**  * @brief Mailbox dispatch  * @param sc		software handle to the device  * @param tmo_sec	timeout in seconds  */
end_comment

begin_function
name|int
name|oce_mbox_dispatch
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
name|uint32_t
name|tmo_sec
parameter_list|)
block|{
name|pd_mpu_mbox_db_t
name|mbox_db
decl_stmt|;
name|uint32_t
name|pa
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|oce_dma_sync
argument_list|(
operator|&
name|sc
operator|->
name|bsmbx
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
name|pa
operator|=
call|(
name|uint32_t
call|)
argument_list|(
operator|(
name|uint64_t
operator|)
name|sc
operator|->
name|bsmbx
operator|.
name|paddr
operator|>>
literal|34
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|mbox_db
argument_list|,
sizeof|sizeof
argument_list|(
name|pd_mpu_mbox_db_t
argument_list|)
argument_list|)
expr_stmt|;
name|mbox_db
operator|.
name|bits
operator|.
name|ready
operator|=
literal|0
expr_stmt|;
name|mbox_db
operator|.
name|bits
operator|.
name|hi
operator|=
literal|1
expr_stmt|;
name|mbox_db
operator|.
name|bits
operator|.
name|address
operator|=
name|pa
expr_stmt|;
name|rc
operator|=
name|oce_mbox_wait
argument_list|(
name|sc
argument_list|,
name|tmo_sec
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
literal|0
condition|)
block|{
name|OCE_WRITE_REG32
argument_list|(
name|sc
argument_list|,
name|db
argument_list|,
name|PD_MPU_MBOX_DB
argument_list|,
name|mbox_db
operator|.
name|dw0
argument_list|)
expr_stmt|;
name|pa
operator|=
call|(
name|uint32_t
call|)
argument_list|(
operator|(
name|uint64_t
operator|)
name|sc
operator|->
name|bsmbx
operator|.
name|paddr
operator|>>
literal|4
argument_list|)
operator|&
literal|0x3fffffff
expr_stmt|;
name|mbox_db
operator|.
name|bits
operator|.
name|ready
operator|=
literal|0
expr_stmt|;
name|mbox_db
operator|.
name|bits
operator|.
name|hi
operator|=
literal|0
expr_stmt|;
name|mbox_db
operator|.
name|bits
operator|.
name|address
operator|=
name|pa
expr_stmt|;
name|rc
operator|=
name|oce_mbox_wait
argument_list|(
name|sc
argument_list|,
name|tmo_sec
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
literal|0
condition|)
block|{
name|OCE_WRITE_REG32
argument_list|(
name|sc
argument_list|,
name|db
argument_list|,
name|PD_MPU_MBOX_DB
argument_list|,
name|mbox_db
operator|.
name|dw0
argument_list|)
expr_stmt|;
name|rc
operator|=
name|oce_mbox_wait
argument_list|(
name|sc
argument_list|,
name|tmo_sec
argument_list|)
expr_stmt|;
name|oce_dma_sync
argument_list|(
operator|&
name|sc
operator|->
name|bsmbx
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|rc
return|;
block|}
end_function

begin_comment
comment|/**  * @brief 		Mailbox common request header initialization  * @param hdr		mailbox header  * @param dom		domain  * @param port		port  * @param subsys	subsystem  * @param opcode	opcode  * @param timeout	timeout  * @param pyld_len	payload length  */
end_comment

begin_function
name|void
name|mbx_common_req_hdr_init
parameter_list|(
name|struct
name|mbx_hdr
modifier|*
name|hdr
parameter_list|,
name|uint8_t
name|dom
parameter_list|,
name|uint8_t
name|port
parameter_list|,
name|uint8_t
name|subsys
parameter_list|,
name|uint8_t
name|opcode
parameter_list|,
name|uint32_t
name|timeout
parameter_list|,
name|uint32_t
name|pyld_len
parameter_list|,
name|uint8_t
name|version
parameter_list|)
block|{
name|hdr
operator|->
name|u0
operator|.
name|req
operator|.
name|opcode
operator|=
name|opcode
expr_stmt|;
name|hdr
operator|->
name|u0
operator|.
name|req
operator|.
name|subsystem
operator|=
name|subsys
expr_stmt|;
name|hdr
operator|->
name|u0
operator|.
name|req
operator|.
name|port_number
operator|=
name|port
expr_stmt|;
name|hdr
operator|->
name|u0
operator|.
name|req
operator|.
name|domain
operator|=
name|dom
expr_stmt|;
name|hdr
operator|->
name|u0
operator|.
name|req
operator|.
name|timeout
operator|=
name|timeout
expr_stmt|;
name|hdr
operator|->
name|u0
operator|.
name|req
operator|.
name|request_length
operator|=
name|pyld_len
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_hdr
argument_list|)
expr_stmt|;
name|hdr
operator|->
name|u0
operator|.
name|req
operator|.
name|version
operator|=
name|version
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * @brief Function to initialize the hw with host endian information  * @param sc		software handle to the device  * @returns		0 on success, ETIMEDOUT on failure  */
end_comment

begin_function
name|int
name|oce_mbox_init
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|)
block|{
name|struct
name|oce_bmbx
modifier|*
name|mbx
decl_stmt|;
name|uint8_t
modifier|*
name|ptr
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|flags
operator|&
name|OCE_FLAGS_MBOX_ENDIAN_RQD
condition|)
block|{
name|mbx
operator|=
name|OCE_DMAPTR
argument_list|(
operator|&
name|sc
operator|->
name|bsmbx
argument_list|,
expr|struct
name|oce_bmbx
argument_list|)
expr_stmt|;
name|ptr
operator|=
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|mbx
operator|->
name|mbx
expr_stmt|;
comment|/* Endian Signature */
operator|*
name|ptr
operator|++
operator|=
literal|0xff
expr_stmt|;
operator|*
name|ptr
operator|++
operator|=
literal|0x12
expr_stmt|;
operator|*
name|ptr
operator|++
operator|=
literal|0x34
expr_stmt|;
operator|*
name|ptr
operator|++
operator|=
literal|0xff
expr_stmt|;
operator|*
name|ptr
operator|++
operator|=
literal|0xff
expr_stmt|;
operator|*
name|ptr
operator|++
operator|=
literal|0x56
expr_stmt|;
operator|*
name|ptr
operator|++
operator|=
literal|0x78
expr_stmt|;
operator|*
name|ptr
operator|=
literal|0xff
expr_stmt|;
name|ret
operator|=
name|oce_mbox_dispatch
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/**  * @brief 		Function to get the firmware version  * @param sc		software handle to the device  * @returns		0 on success, EIO on failure  */
end_comment

begin_function
name|int
name|oce_get_fw_version
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|)
block|{
name|struct
name|oce_mbx
name|mbx
decl_stmt|;
name|struct
name|mbx_get_common_fw_version
modifier|*
name|fwcmd
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|mbx
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|oce_mbx
argument_list|)
argument_list|)
expr_stmt|;
name|fwcmd
operator|=
operator|(
expr|struct
name|mbx_get_common_fw_version
operator|*
operator|)
operator|&
name|mbx
operator|.
name|payload
expr_stmt|;
name|mbx_common_req_hdr_init
argument_list|(
operator|&
name|fwcmd
operator|->
name|hdr
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|MBX_SUBSYSTEM_COMMON
argument_list|,
name|OPCODE_COMMON_GET_FW_VERSION
argument_list|,
name|MBX_TIMEOUT_SEC
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_get_common_fw_version
argument_list|)
argument_list|,
name|OCE_MBX_VER_V0
argument_list|)
expr_stmt|;
name|mbx
operator|.
name|u0
operator|.
name|s
operator|.
name|embedded
operator|=
literal|1
expr_stmt|;
name|mbx
operator|.
name|payload_length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_get_common_fw_version
argument_list|)
expr_stmt|;
name|DW_SWAP
argument_list|(
name|u32ptr
argument_list|(
operator|&
name|mbx
argument_list|)
argument_list|,
name|mbx
operator|.
name|payload_length
operator|+
name|OCE_BMBX_RHDR_SZ
argument_list|)
expr_stmt|;
name|ret
operator|=
name|oce_mbox_post
argument_list|(
name|sc
argument_list|,
operator|&
name|mbx
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
name|ret
operator|=
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"%s failed - cmd status: %d addi status: %d\n"
argument_list|,
name|__FUNCTION__
argument_list|,
name|ret
argument_list|,
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|additional_status
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|bcopy
argument_list|(
name|fwcmd
operator|->
name|params
operator|.
name|rsp
operator|.
name|fw_ver_str
argument_list|,
name|sc
operator|->
name|fw_version
argument_list|,
literal|32
argument_list|)
expr_stmt|;
name|error
label|:
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/**  * @brief	Firmware will send gracious notifications during  *		attach only after sending first mcc commnad. We    *		use MCC queue only for getting async and mailbox  *		for sending cmds. So to get gracious notifications  *		atleast send one dummy command on mcc.  */
end_comment

begin_function
name|int
name|oce_first_mcc_cmd
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|)
block|{
name|struct
name|oce_mbx
modifier|*
name|mbx
decl_stmt|;
name|struct
name|oce_mq
modifier|*
name|mq
init|=
name|sc
operator|->
name|mq
decl_stmt|;
name|struct
name|mbx_get_common_fw_version
modifier|*
name|fwcmd
decl_stmt|;
name|uint32_t
name|reg_value
decl_stmt|;
name|mbx
operator|=
name|RING_GET_PRODUCER_ITEM_VA
argument_list|(
name|mq
operator|->
name|ring
argument_list|,
expr|struct
name|oce_mbx
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|mbx
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|oce_mbx
argument_list|)
argument_list|)
expr_stmt|;
name|fwcmd
operator|=
operator|(
expr|struct
name|mbx_get_common_fw_version
operator|*
operator|)
operator|&
name|mbx
operator|->
name|payload
expr_stmt|;
name|mbx_common_req_hdr_init
argument_list|(
operator|&
name|fwcmd
operator|->
name|hdr
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|MBX_SUBSYSTEM_COMMON
argument_list|,
name|OPCODE_COMMON_GET_FW_VERSION
argument_list|,
name|MBX_TIMEOUT_SEC
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_get_common_fw_version
argument_list|)
argument_list|,
name|OCE_MBX_VER_V0
argument_list|)
expr_stmt|;
name|mbx
operator|->
name|u0
operator|.
name|s
operator|.
name|embedded
operator|=
literal|1
expr_stmt|;
name|mbx
operator|->
name|payload_length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_get_common_fw_version
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|mq
operator|->
name|ring
operator|->
name|dma
operator|.
name|tag
argument_list|,
name|mq
operator|->
name|ring
operator|->
name|dma
operator|.
name|map
argument_list|,
name|BUS_DMASYNC_PREREAD
operator||
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
name|RING_PUT
argument_list|(
name|mq
operator|->
name|ring
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|reg_value
operator|=
operator|(
literal|1
operator|<<
literal|16
operator|)
operator||
name|mq
operator|->
name|mq_id
expr_stmt|;
name|OCE_WRITE_REG32
argument_list|(
name|sc
argument_list|,
name|db
argument_list|,
name|PD_MQ_DB
argument_list|,
name|reg_value
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * @brief		Function to post a MBX to the mbox  * @param sc		software handle to the device  * @param mbx 		pointer to the MBX to send  * @param mbxctx	pointer to the mbx context structure  * @returns		0 on success, error on failure  */
end_comment

begin_function
name|int
name|oce_mbox_post
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
name|struct
name|oce_mbx
modifier|*
name|mbx
parameter_list|,
name|struct
name|oce_mbx_ctx
modifier|*
name|mbxctx
parameter_list|)
block|{
name|struct
name|oce_mbx
modifier|*
name|mb_mbx
init|=
name|NULL
decl_stmt|;
name|struct
name|oce_mq_cqe
modifier|*
name|mb_cqe
init|=
name|NULL
decl_stmt|;
name|struct
name|oce_bmbx
modifier|*
name|mb
init|=
name|NULL
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|uint32_t
name|tmo
init|=
literal|0
decl_stmt|;
name|uint32_t
name|cstatus
init|=
literal|0
decl_stmt|;
name|uint32_t
name|xstatus
init|=
literal|0
decl_stmt|;
name|LOCK
argument_list|(
operator|&
name|sc
operator|->
name|bmbx_lock
argument_list|)
expr_stmt|;
name|mb
operator|=
name|OCE_DMAPTR
argument_list|(
operator|&
name|sc
operator|->
name|bsmbx
argument_list|,
expr|struct
name|oce_bmbx
argument_list|)
expr_stmt|;
name|mb_mbx
operator|=
operator|&
name|mb
operator|->
name|mbx
expr_stmt|;
comment|/* get the tmo */
name|tmo
operator|=
name|mbx
operator|->
name|tag
index|[
literal|0
index|]
expr_stmt|;
name|mbx
operator|->
name|tag
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
comment|/* copy mbx into mbox */
name|bcopy
argument_list|(
name|mbx
argument_list|,
name|mb_mbx
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|oce_mbx
argument_list|)
argument_list|)
expr_stmt|;
comment|/* now dispatch */
name|rc
operator|=
name|oce_mbox_dispatch
argument_list|(
name|sc
argument_list|,
name|tmo
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
literal|0
condition|)
block|{
comment|/* 		 * the command completed successfully. Now get the 		 * completion queue entry 		 */
name|mb_cqe
operator|=
operator|&
name|mb
operator|->
name|cqe
expr_stmt|;
name|DW_SWAP
argument_list|(
name|u32ptr
argument_list|(
operator|&
name|mb_cqe
operator|->
name|u0
operator|.
name|dw
index|[
literal|0
index|]
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|oce_mq_cqe
argument_list|)
argument_list|)
expr_stmt|;
comment|/* copy mbox mbx back */
name|bcopy
argument_list|(
name|mb_mbx
argument_list|,
name|mbx
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|oce_mbx
argument_list|)
argument_list|)
expr_stmt|;
comment|/* pick up the mailbox status */
name|cstatus
operator|=
name|mb_cqe
operator|->
name|u0
operator|.
name|s
operator|.
name|completion_status
expr_stmt|;
name|xstatus
operator|=
name|mb_cqe
operator|->
name|u0
operator|.
name|s
operator|.
name|extended_status
expr_stmt|;
comment|/* 		 * store the mbx context in the cqe tag section so that 		 * the upper layer handling the cqe can associate the mbx 		 * with the response 		 */
if|if
condition|(
name|cstatus
operator|==
literal|0
operator|&&
name|mbxctx
condition|)
block|{
comment|/* save context */
name|mbxctx
operator|->
name|mbx
operator|=
name|mb_mbx
expr_stmt|;
name|bcopy
argument_list|(
operator|&
name|mbxctx
argument_list|,
name|mb_cqe
operator|->
name|u0
operator|.
name|s
operator|.
name|mq_tag
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|oce_mbx_ctx
operator|*
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
name|UNLOCK
argument_list|(
operator|&
name|sc
operator|->
name|bmbx_lock
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_comment
comment|/**  * @brief Function to read the mac address associated with an interface  * @param sc		software handle to the device  * @param if_id 	interface id to read the address from  * @param perm 		set to 1 if reading the factory mac address.  *			In this case if_id is ignored  * @param type 		type of the mac address, whether network or storage  * @param[out] mac 	[OUTPUT] pointer to a buffer containing the  *			mac address when the command succeeds.  * @returns		0 on success, EIO on failure  */
end_comment

begin_function
name|int
name|oce_read_mac_addr
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
name|uint32_t
name|if_id
parameter_list|,
name|uint8_t
name|perm
parameter_list|,
name|uint8_t
name|type
parameter_list|,
name|struct
name|mac_address_format
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|oce_mbx
name|mbx
decl_stmt|;
name|struct
name|mbx_query_common_iface_mac
modifier|*
name|fwcmd
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|mbx
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|oce_mbx
argument_list|)
argument_list|)
expr_stmt|;
name|fwcmd
operator|=
operator|(
expr|struct
name|mbx_query_common_iface_mac
operator|*
operator|)
operator|&
name|mbx
operator|.
name|payload
expr_stmt|;
name|mbx_common_req_hdr_init
argument_list|(
operator|&
name|fwcmd
operator|->
name|hdr
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|MBX_SUBSYSTEM_COMMON
argument_list|,
name|OPCODE_COMMON_QUERY_IFACE_MAC
argument_list|,
name|MBX_TIMEOUT_SEC
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_query_common_iface_mac
argument_list|)
argument_list|,
name|OCE_MBX_VER_V0
argument_list|)
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|permanent
operator|=
name|perm
expr_stmt|;
if|if
condition|(
operator|!
name|perm
condition|)
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|if_id
operator|=
operator|(
name|uint16_t
operator|)
name|if_id
expr_stmt|;
else|else
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|if_id
operator|=
literal|0
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|type
operator|=
name|type
expr_stmt|;
name|mbx
operator|.
name|u0
operator|.
name|s
operator|.
name|embedded
operator|=
literal|1
expr_stmt|;
name|mbx
operator|.
name|payload_length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_query_common_iface_mac
argument_list|)
expr_stmt|;
name|DW_SWAP
argument_list|(
name|u32ptr
argument_list|(
operator|&
name|mbx
argument_list|)
argument_list|,
name|mbx
operator|.
name|payload_length
operator|+
name|OCE_BMBX_RHDR_SZ
argument_list|)
expr_stmt|;
name|ret
operator|=
name|oce_mbox_post
argument_list|(
name|sc
argument_list|,
operator|&
name|mbx
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
name|ret
operator|=
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"%s failed - cmd status: %d addi status: %d\n"
argument_list|,
name|__FUNCTION__
argument_list|,
name|ret
argument_list|,
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|additional_status
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
comment|/* copy the mac addres in the output parameter */
name|mac
operator|->
name|size_of_struct
operator|=
name|fwcmd
operator|->
name|params
operator|.
name|rsp
operator|.
name|mac
operator|.
name|size_of_struct
expr_stmt|;
name|bcopy
argument_list|(
operator|&
name|fwcmd
operator|->
name|params
operator|.
name|rsp
operator|.
name|mac
operator|.
name|mac_addr
index|[
literal|0
index|]
argument_list|,
operator|&
name|mac
operator|->
name|mac_addr
index|[
literal|0
index|]
argument_list|,
name|mac
operator|->
name|size_of_struct
argument_list|)
expr_stmt|;
name|error
label|:
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/**  * @brief Function to query the fw attributes from the hw  * @param sc		software handle to the device  * @returns		0 on success, EIO on failure  */
end_comment

begin_function
name|int
name|oce_get_fw_config
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|)
block|{
name|struct
name|oce_mbx
name|mbx
decl_stmt|;
name|struct
name|mbx_common_query_fw_config
modifier|*
name|fwcmd
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|mbx
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|oce_mbx
argument_list|)
argument_list|)
expr_stmt|;
name|fwcmd
operator|=
operator|(
expr|struct
name|mbx_common_query_fw_config
operator|*
operator|)
operator|&
name|mbx
operator|.
name|payload
expr_stmt|;
name|mbx_common_req_hdr_init
argument_list|(
operator|&
name|fwcmd
operator|->
name|hdr
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|MBX_SUBSYSTEM_COMMON
argument_list|,
name|OPCODE_COMMON_QUERY_FIRMWARE_CONFIG
argument_list|,
name|MBX_TIMEOUT_SEC
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_common_query_fw_config
argument_list|)
argument_list|,
name|OCE_MBX_VER_V0
argument_list|)
expr_stmt|;
name|mbx
operator|.
name|u0
operator|.
name|s
operator|.
name|embedded
operator|=
literal|1
expr_stmt|;
name|mbx
operator|.
name|payload_length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_common_query_fw_config
argument_list|)
expr_stmt|;
name|DW_SWAP
argument_list|(
name|u32ptr
argument_list|(
operator|&
name|mbx
argument_list|)
argument_list|,
name|mbx
operator|.
name|payload_length
operator|+
name|OCE_BMBX_RHDR_SZ
argument_list|)
expr_stmt|;
name|ret
operator|=
name|oce_mbox_post
argument_list|(
name|sc
argument_list|,
operator|&
name|mbx
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
name|ret
operator|=
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"%s failed - cmd status: %d addi status: %d\n"
argument_list|,
name|__FUNCTION__
argument_list|,
name|ret
argument_list|,
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|additional_status
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|DW_SWAP
argument_list|(
name|u32ptr
argument_list|(
name|fwcmd
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_common_query_fw_config
argument_list|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|config_number
operator|=
name|HOST_32
argument_list|(
name|fwcmd
operator|->
name|params
operator|.
name|rsp
operator|.
name|config_number
argument_list|)
expr_stmt|;
name|sc
operator|->
name|asic_revision
operator|=
name|HOST_32
argument_list|(
name|fwcmd
operator|->
name|params
operator|.
name|rsp
operator|.
name|asic_revision
argument_list|)
expr_stmt|;
name|sc
operator|->
name|port_id
operator|=
name|HOST_32
argument_list|(
name|fwcmd
operator|->
name|params
operator|.
name|rsp
operator|.
name|port_id
argument_list|)
expr_stmt|;
name|sc
operator|->
name|function_mode
operator|=
name|HOST_32
argument_list|(
name|fwcmd
operator|->
name|params
operator|.
name|rsp
operator|.
name|function_mode
argument_list|)
expr_stmt|;
name|sc
operator|->
name|function_caps
operator|=
name|HOST_32
argument_list|(
name|fwcmd
operator|->
name|params
operator|.
name|rsp
operator|.
name|function_caps
argument_list|)
expr_stmt|;
if|if
condition|(
name|fwcmd
operator|->
name|params
operator|.
name|rsp
operator|.
name|ulp
index|[
literal|0
index|]
operator|.
name|ulp_mode
operator|&
name|ULP_NIC_MODE
condition|)
block|{
name|sc
operator|->
name|max_tx_rings
operator|=
name|HOST_32
argument_list|(
name|fwcmd
operator|->
name|params
operator|.
name|rsp
operator|.
name|ulp
index|[
literal|0
index|]
operator|.
name|nic_wq_tot
argument_list|)
expr_stmt|;
name|sc
operator|->
name|max_rx_rings
operator|=
name|HOST_32
argument_list|(
name|fwcmd
operator|->
name|params
operator|.
name|rsp
operator|.
name|ulp
index|[
literal|0
index|]
operator|.
name|lro_rqid_tot
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|sc
operator|->
name|max_tx_rings
operator|=
name|HOST_32
argument_list|(
name|fwcmd
operator|->
name|params
operator|.
name|rsp
operator|.
name|ulp
index|[
literal|1
index|]
operator|.
name|nic_wq_tot
argument_list|)
expr_stmt|;
name|sc
operator|->
name|max_rx_rings
operator|=
name|HOST_32
argument_list|(
name|fwcmd
operator|->
name|params
operator|.
name|rsp
operator|.
name|ulp
index|[
literal|1
index|]
operator|.
name|lro_rqid_tot
argument_list|)
expr_stmt|;
block|}
name|error
label|:
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/**  *  * @brief function to create a device interface   * @param sc		software handle to the device  * @param cap_flags	capability flags  * @param en_flags	enable capability flags  * @param vlan_tag	optional vlan tag to associate with the if  * @param mac_addr	pointer to a buffer containing the mac address  * @param[out] if_id	[OUTPUT] pointer to an integer to hold the ID of the  interface created  * @returns		0 on success, EIO on failure  */
end_comment

begin_function
name|int
name|oce_if_create
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
name|uint32_t
name|cap_flags
parameter_list|,
name|uint32_t
name|en_flags
parameter_list|,
name|uint16_t
name|vlan_tag
parameter_list|,
name|uint8_t
modifier|*
name|mac_addr
parameter_list|,
name|uint32_t
modifier|*
name|if_id
parameter_list|)
block|{
name|struct
name|oce_mbx
name|mbx
decl_stmt|;
name|struct
name|mbx_create_common_iface
modifier|*
name|fwcmd
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|mbx
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|oce_mbx
argument_list|)
argument_list|)
expr_stmt|;
name|fwcmd
operator|=
operator|(
expr|struct
name|mbx_create_common_iface
operator|*
operator|)
operator|&
name|mbx
operator|.
name|payload
expr_stmt|;
name|mbx_common_req_hdr_init
argument_list|(
operator|&
name|fwcmd
operator|->
name|hdr
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|MBX_SUBSYSTEM_COMMON
argument_list|,
name|OPCODE_COMMON_CREATE_IFACE
argument_list|,
name|MBX_TIMEOUT_SEC
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_create_common_iface
argument_list|)
argument_list|,
name|OCE_MBX_VER_V0
argument_list|)
expr_stmt|;
name|DW_SWAP
argument_list|(
name|u32ptr
argument_list|(
operator|&
name|fwcmd
operator|->
name|hdr
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_hdr
argument_list|)
argument_list|)
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|version
operator|=
literal|0
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|cap_flags
operator|=
name|LE_32
argument_list|(
name|cap_flags
argument_list|)
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|enable_flags
operator|=
name|LE_32
argument_list|(
name|en_flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac_addr
operator|!=
name|NULL
condition|)
block|{
name|bcopy
argument_list|(
name|mac_addr
argument_list|,
operator|&
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|mac_addr
index|[
literal|0
index|]
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|vlan_tag
operator|.
name|u0
operator|.
name|normal
operator|.
name|vtag
operator|=
name|LE_16
argument_list|(
name|vlan_tag
argument_list|)
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|mac_invalid
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|mac_invalid
operator|=
literal|1
expr_stmt|;
block|}
name|mbx
operator|.
name|u0
operator|.
name|s
operator|.
name|embedded
operator|=
literal|1
expr_stmt|;
name|mbx
operator|.
name|payload_length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_create_common_iface
argument_list|)
expr_stmt|;
name|DW_SWAP
argument_list|(
name|u32ptr
argument_list|(
operator|&
name|mbx
argument_list|)
argument_list|,
name|OCE_BMBX_RHDR_SZ
argument_list|)
expr_stmt|;
name|rc
operator|=
name|oce_mbox_post
argument_list|(
name|sc
argument_list|,
operator|&
name|mbx
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rc
condition|)
name|rc
operator|=
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"%s failed - cmd status: %d addi status: %d\n"
argument_list|,
name|__FUNCTION__
argument_list|,
name|rc
argument_list|,
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|additional_status
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
operator|*
name|if_id
operator|=
name|HOST_32
argument_list|(
name|fwcmd
operator|->
name|params
operator|.
name|rsp
operator|.
name|if_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac_addr
operator|!=
name|NULL
condition|)
name|sc
operator|->
name|pmac_id
operator|=
name|HOST_32
argument_list|(
name|fwcmd
operator|->
name|params
operator|.
name|rsp
operator|.
name|pmac_id
argument_list|)
expr_stmt|;
name|error
label|:
return|return
name|rc
return|;
block|}
end_function

begin_comment
comment|/**  * @brief		Function to delete an interface  * @param sc 		software handle to the device  * @param if_id		ID of the interface to delete  * @returns		0 on success, EIO on failure  */
end_comment

begin_function
name|int
name|oce_if_del
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
name|uint32_t
name|if_id
parameter_list|)
block|{
name|struct
name|oce_mbx
name|mbx
decl_stmt|;
name|struct
name|mbx_destroy_common_iface
modifier|*
name|fwcmd
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|mbx
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|oce_mbx
argument_list|)
argument_list|)
expr_stmt|;
name|fwcmd
operator|=
operator|(
expr|struct
name|mbx_destroy_common_iface
operator|*
operator|)
operator|&
name|mbx
operator|.
name|payload
expr_stmt|;
name|mbx_common_req_hdr_init
argument_list|(
operator|&
name|fwcmd
operator|->
name|hdr
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|MBX_SUBSYSTEM_COMMON
argument_list|,
name|OPCODE_COMMON_DESTROY_IFACE
argument_list|,
name|MBX_TIMEOUT_SEC
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_destroy_common_iface
argument_list|)
argument_list|,
name|OCE_MBX_VER_V0
argument_list|)
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|if_id
operator|=
name|if_id
expr_stmt|;
name|mbx
operator|.
name|u0
operator|.
name|s
operator|.
name|embedded
operator|=
literal|1
expr_stmt|;
name|mbx
operator|.
name|payload_length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_destroy_common_iface
argument_list|)
expr_stmt|;
name|DW_SWAP
argument_list|(
name|u32ptr
argument_list|(
operator|&
name|mbx
argument_list|)
argument_list|,
name|mbx
operator|.
name|payload_length
operator|+
name|OCE_BMBX_RHDR_SZ
argument_list|)
expr_stmt|;
name|rc
operator|=
name|oce_mbox_post
argument_list|(
name|sc
argument_list|,
operator|&
name|mbx
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rc
condition|)
name|rc
operator|=
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|rc
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"%s failed - cmd status: %d addi status: %d\n"
argument_list|,
name|__FUNCTION__
argument_list|,
name|rc
argument_list|,
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|additional_status
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_comment
comment|/**  * @brief Function to send the mbx command to configure vlan  * @param sc 		software handle to the device  * @param if_id 	interface identifier index  * @param vtag_arr	array of vlan tags  * @param vtag_cnt	number of elements in array  * @param untagged	boolean TRUE/FLASE  * @param enable_promisc flag to enable/disable VLAN promiscuous mode  * @returns		0 on success, EIO on failure  */
end_comment

begin_function
name|int
name|oce_config_vlan
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
name|uint32_t
name|if_id
parameter_list|,
name|struct
name|normal_vlan
modifier|*
name|vtag_arr
parameter_list|,
name|uint8_t
name|vtag_cnt
parameter_list|,
name|uint32_t
name|untagged
parameter_list|,
name|uint32_t
name|enable_promisc
parameter_list|)
block|{
name|struct
name|oce_mbx
name|mbx
decl_stmt|;
name|struct
name|mbx_common_config_vlan
modifier|*
name|fwcmd
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|vlans_added
operator|>
name|sc
operator|->
name|max_vlans
condition|)
goto|goto
name|vlan_promisc
goto|;
name|bzero
argument_list|(
operator|&
name|mbx
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|oce_mbx
argument_list|)
argument_list|)
expr_stmt|;
name|fwcmd
operator|=
operator|(
expr|struct
name|mbx_common_config_vlan
operator|*
operator|)
operator|&
name|mbx
operator|.
name|payload
expr_stmt|;
name|mbx_common_req_hdr_init
argument_list|(
operator|&
name|fwcmd
operator|->
name|hdr
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|MBX_SUBSYSTEM_COMMON
argument_list|,
name|OPCODE_COMMON_CONFIG_IFACE_VLAN
argument_list|,
name|MBX_TIMEOUT_SEC
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_common_config_vlan
argument_list|)
argument_list|,
name|OCE_MBX_VER_V0
argument_list|)
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|if_id
operator|=
operator|(
name|uint8_t
operator|)
name|if_id
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|promisc
operator|=
operator|(
name|uint8_t
operator|)
name|enable_promisc
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|untagged
operator|=
operator|(
name|uint8_t
operator|)
name|untagged
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|num_vlans
operator|=
name|vtag_cnt
expr_stmt|;
if|if
condition|(
operator|!
name|enable_promisc
condition|)
block|{
name|bcopy
argument_list|(
name|vtag_arr
argument_list|,
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|tags
operator|.
name|normal_vlans
argument_list|,
name|vtag_cnt
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|normal_vlan
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|mbx
operator|.
name|u0
operator|.
name|s
operator|.
name|embedded
operator|=
literal|1
expr_stmt|;
name|mbx
operator|.
name|payload_length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_common_config_vlan
argument_list|)
expr_stmt|;
name|DW_SWAP
argument_list|(
name|u32ptr
argument_list|(
operator|&
name|mbx
argument_list|)
argument_list|,
operator|(
name|OCE_BMBX_RHDR_SZ
operator|+
name|mbx
operator|.
name|payload_length
operator|)
argument_list|)
expr_stmt|;
name|rc
operator|=
name|oce_mbox_post
argument_list|(
name|sc
argument_list|,
operator|&
name|mbx
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rc
condition|)
name|rc
operator|=
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|rc
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"%s failed - cmd status: %d addi status: %d\n"
argument_list|,
name|__FUNCTION__
argument_list|,
name|rc
argument_list|,
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|additional_status
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
name|vlan_promisc
label|:
comment|/* Enable Vlan Promis */
name|oce_rxf_set_promiscuous
argument_list|(
name|sc
argument_list|,
operator|(
literal|1
operator|<<
literal|1
operator|)
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Enabling Vlan Promisc Mode\n"
argument_list|)
expr_stmt|;
name|done
label|:
return|return
name|rc
return|;
block|}
end_function

begin_comment
comment|/**  * @brief Function to set flow control capability in the hardware  * @param sc 		software handle to the device  * @param flow_control	flow control flags to set  * @returns		0 on success, EIO on failure  */
end_comment

begin_function
name|int
name|oce_set_flow_control
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
name|uint32_t
name|flow_control
parameter_list|)
block|{
name|struct
name|oce_mbx
name|mbx
decl_stmt|;
name|struct
name|mbx_common_get_set_flow_control
modifier|*
name|fwcmd
init|=
operator|(
expr|struct
name|mbx_common_get_set_flow_control
operator|*
operator|)
operator|&
name|mbx
operator|.
name|payload
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|mbx
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|oce_mbx
argument_list|)
argument_list|)
expr_stmt|;
name|mbx_common_req_hdr_init
argument_list|(
operator|&
name|fwcmd
operator|->
name|hdr
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|MBX_SUBSYSTEM_COMMON
argument_list|,
name|OPCODE_COMMON_SET_FLOW_CONTROL
argument_list|,
name|MBX_TIMEOUT_SEC
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_common_get_set_flow_control
argument_list|)
argument_list|,
name|OCE_MBX_VER_V0
argument_list|)
expr_stmt|;
if|if
condition|(
name|flow_control
operator|&
name|OCE_FC_TX
condition|)
name|fwcmd
operator|->
name|tx_flow_control
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|flow_control
operator|&
name|OCE_FC_RX
condition|)
name|fwcmd
operator|->
name|rx_flow_control
operator|=
literal|1
expr_stmt|;
name|mbx
operator|.
name|u0
operator|.
name|s
operator|.
name|embedded
operator|=
literal|1
expr_stmt|;
name|mbx
operator|.
name|payload_length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_common_get_set_flow_control
argument_list|)
expr_stmt|;
name|DW_SWAP
argument_list|(
name|u32ptr
argument_list|(
operator|&
name|mbx
argument_list|)
argument_list|,
name|mbx
operator|.
name|payload_length
operator|+
name|OCE_BMBX_RHDR_SZ
argument_list|)
expr_stmt|;
name|rc
operator|=
name|oce_mbox_post
argument_list|(
name|sc
argument_list|,
operator|&
name|mbx
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rc
condition|)
name|rc
operator|=
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|rc
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"%s failed - cmd status: %d addi status: %d\n"
argument_list|,
name|__FUNCTION__
argument_list|,
name|rc
argument_list|,
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|additional_status
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_comment
comment|/**  * @brief Initialize the RSS CPU indirection table  *  * The table is used to choose the queue to place the incomming packets.  * Incomming packets are hashed.  The lowest bits in the hash result  * are used as the index into the CPU indirection table.  * Each entry in the table contains the RSS CPU-ID returned by the NIC  * create.  Based on the CPU ID, the receive completion is routed to  * the corresponding RSS CQs.  (Non-RSS packets are always completed  * on the default (0) CQ).  *  * @param sc 		software handle to the device  * @param *fwcmd	pointer to the rss mbox command  * @returns		none  */
end_comment

begin_function
specifier|static
name|int
name|oce_rss_itbl_init
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
name|struct
name|mbx_config_nic_rss
modifier|*
name|fwcmd
parameter_list|)
block|{
name|int
name|i
init|=
literal|0
decl_stmt|,
name|j
init|=
literal|0
decl_stmt|,
name|rc
init|=
literal|0
decl_stmt|;
name|uint8_t
modifier|*
name|tbl
init|=
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|cputable
decl_stmt|;
name|struct
name|oce_rq
modifier|*
name|rq
init|=
name|NULL
decl_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|INDIRECTION_TABLE_ENTRIES
condition|;
name|j
operator|+=
operator|(
name|sc
operator|->
name|nrqs
operator|-
literal|1
operator|)
control|)
block|{
name|for_all_rss_queues
argument_list|(
argument|sc
argument_list|,
argument|rq
argument_list|,
argument|i
argument_list|)
block|{
if|if
condition|(
operator|(
name|j
operator|+
name|i
operator|)
operator|>=
name|INDIRECTION_TABLE_ENTRIES
condition|)
break|break;
name|tbl
index|[
name|j
operator|+
name|i
index|]
operator|=
name|rq
operator|->
name|rss_cpuid
expr_stmt|;
block|}
block|}
if|if
condition|(
name|i
operator|==
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"error: Invalid number of RSS RQ's\n"
argument_list|)
expr_stmt|;
name|rc
operator|=
name|ENXIO
expr_stmt|;
block|}
comment|/* fill log2 value indicating the size of the CPU table */
if|if
condition|(
name|rc
operator|==
literal|0
condition|)
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|cpu_tbl_sz_log2
operator|=
name|LE_16
argument_list|(
name|OCE_LOG2
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_comment
comment|/**  * @brief Function to set flow control capability in the hardware  * @param sc 		software handle to the device  * @param if_id 	interface id to read the address from  * @param enable_rss	0=disable, RSS_ENABLE_xxx flags otherwise  * @returns		0 on success, EIO on failure  */
end_comment

begin_function
name|int
name|oce_config_nic_rss
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
name|uint32_t
name|if_id
parameter_list|,
name|uint16_t
name|enable_rss
parameter_list|)
block|{
name|int
name|rc
decl_stmt|;
name|struct
name|oce_mbx
name|mbx
decl_stmt|;
name|struct
name|mbx_config_nic_rss
modifier|*
name|fwcmd
init|=
operator|(
expr|struct
name|mbx_config_nic_rss
operator|*
operator|)
operator|&
name|mbx
operator|.
name|payload
decl_stmt|;
name|int
name|version
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|mbx
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|oce_mbx
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_XE201
argument_list|(
name|sc
argument_list|)
operator|||
name|IS_SH
argument_list|(
name|sc
argument_list|)
condition|)
block|{
name|version
operator|=
name|OCE_MBX_VER_V1
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|enable_rss
operator|=
name|RSS_ENABLE_UDP_IPV4
operator||
name|RSS_ENABLE_UDP_IPV6
expr_stmt|;
block|}
else|else
name|version
operator|=
name|OCE_MBX_VER_V0
expr_stmt|;
name|mbx_common_req_hdr_init
argument_list|(
operator|&
name|fwcmd
operator|->
name|hdr
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|MBX_SUBSYSTEM_NIC
argument_list|,
name|NIC_CONFIG_RSS
argument_list|,
name|MBX_TIMEOUT_SEC
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_config_nic_rss
argument_list|)
argument_list|,
name|version
argument_list|)
expr_stmt|;
if|if
condition|(
name|enable_rss
condition|)
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|enable_rss
operator||=
operator|(
name|RSS_ENABLE_IPV4
operator||
name|RSS_ENABLE_TCP_IPV4
operator||
name|RSS_ENABLE_IPV6
operator||
name|RSS_ENABLE_TCP_IPV6
operator|)
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|flush
operator|=
name|OCE_FLUSH
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|if_id
operator|=
name|LE_32
argument_list|(
name|if_id
argument_list|)
expr_stmt|;
name|srandom
argument_list|(
name|arc4random
argument_list|()
argument_list|)
expr_stmt|;
comment|/* random entropy seed */
name|read_random
argument_list|(
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|hash
argument_list|,
sizeof|sizeof
argument_list|(
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|hash
argument_list|)
argument_list|)
expr_stmt|;
name|rc
operator|=
name|oce_rss_itbl_init
argument_list|(
name|sc
argument_list|,
name|fwcmd
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
literal|0
condition|)
block|{
name|mbx
operator|.
name|u0
operator|.
name|s
operator|.
name|embedded
operator|=
literal|1
expr_stmt|;
name|mbx
operator|.
name|payload_length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_config_nic_rss
argument_list|)
expr_stmt|;
name|DW_SWAP
argument_list|(
name|u32ptr
argument_list|(
operator|&
name|mbx
argument_list|)
argument_list|,
name|mbx
operator|.
name|payload_length
operator|+
name|OCE_BMBX_RHDR_SZ
argument_list|)
expr_stmt|;
name|rc
operator|=
name|oce_mbox_post
argument_list|(
name|sc
argument_list|,
operator|&
name|mbx
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rc
condition|)
name|rc
operator|=
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|rc
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"%s failed - cmd status: %d addi status: %d\n"
argument_list|,
name|__FUNCTION__
argument_list|,
name|rc
argument_list|,
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|additional_status
argument_list|)
expr_stmt|;
block|}
return|return
name|rc
return|;
block|}
end_function

begin_comment
comment|/**  * @brief 		RXF function to enable/disable device promiscuous mode  * @param sc		software handle to the device  * @param enable	enable/disable flag  * @returns		0 on success, EIO on failure  * @note  *	The NIC_CONFIG_PROMISCUOUS command deprecated for Lancer.  *	This function uses the COMMON_SET_IFACE_RX_FILTER command instead.  */
end_comment

begin_function
name|int
name|oce_rxf_set_promiscuous
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
name|uint8_t
name|enable
parameter_list|)
block|{
name|struct
name|mbx_set_common_iface_rx_filter
modifier|*
name|fwcmd
decl_stmt|;
name|int
name|sz
init|=
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_set_common_iface_rx_filter
argument_list|)
decl_stmt|;
name|iface_rx_filter_ctx_t
modifier|*
name|req
decl_stmt|;
name|OCE_DMA_MEM
name|sgl
decl_stmt|;
name|int
name|rc
decl_stmt|;
comment|/* allocate mbx payload's dma scatter/gather memory */
name|rc
operator|=
name|oce_dma_alloc
argument_list|(
name|sc
argument_list|,
name|sz
argument_list|,
operator|&
name|sgl
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
return|return
name|rc
return|;
name|fwcmd
operator|=
name|OCE_DMAPTR
argument_list|(
operator|&
name|sgl
argument_list|,
expr|struct
name|mbx_set_common_iface_rx_filter
argument_list|)
expr_stmt|;
name|req
operator|=
operator|&
name|fwcmd
operator|->
name|params
operator|.
name|req
expr_stmt|;
name|req
operator|->
name|iface_flags_mask
operator|=
name|MBX_RX_IFACE_FLAGS_PROMISCUOUS
operator||
name|MBX_RX_IFACE_FLAGS_VLAN_PROMISCUOUS
expr_stmt|;
comment|/* Bit 0 Mac promisc, Bit 1 Vlan promisc */
if|if
condition|(
name|enable
operator|&
literal|0x01
condition|)
name|req
operator|->
name|iface_flags
operator|=
name|MBX_RX_IFACE_FLAGS_PROMISCUOUS
expr_stmt|;
if|if
condition|(
name|enable
operator|&
literal|0x02
condition|)
name|req
operator|->
name|iface_flags
operator|=
name|MBX_RX_IFACE_FLAGS_VLAN_PROMISCUOUS
expr_stmt|;
name|req
operator|->
name|if_id
operator|=
name|sc
operator|->
name|if_id
expr_stmt|;
name|rc
operator|=
name|oce_set_common_iface_rx_filter
argument_list|(
name|sc
argument_list|,
operator|&
name|sgl
argument_list|)
expr_stmt|;
name|oce_dma_free
argument_list|(
name|sc
argument_list|,
operator|&
name|sgl
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_comment
comment|/**  * @brief 			Function modify and select rx filter options  * @param sc			software handle to the device  * @param sgl			scatter/gather request/response  * @returns			0 on success, error code on failure  */
end_comment

begin_function
name|int
name|oce_set_common_iface_rx_filter
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
name|POCE_DMA_MEM
name|sgl
parameter_list|)
block|{
name|struct
name|oce_mbx
name|mbx
decl_stmt|;
name|int
name|mbx_sz
init|=
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_set_common_iface_rx_filter
argument_list|)
decl_stmt|;
name|struct
name|mbx_set_common_iface_rx_filter
modifier|*
name|fwcmd
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|mbx
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|oce_mbx
argument_list|)
argument_list|)
expr_stmt|;
name|fwcmd
operator|=
name|OCE_DMAPTR
argument_list|(
name|sgl
argument_list|,
expr|struct
name|mbx_set_common_iface_rx_filter
argument_list|)
expr_stmt|;
name|mbx_common_req_hdr_init
argument_list|(
operator|&
name|fwcmd
operator|->
name|hdr
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|MBX_SUBSYSTEM_COMMON
argument_list|,
name|OPCODE_COMMON_SET_IFACE_RX_FILTER
argument_list|,
name|MBX_TIMEOUT_SEC
argument_list|,
name|mbx_sz
argument_list|,
name|OCE_MBX_VER_V0
argument_list|)
expr_stmt|;
name|oce_dma_sync
argument_list|(
name|sgl
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
name|mbx
operator|.
name|u0
operator|.
name|s
operator|.
name|embedded
operator|=
literal|0
expr_stmt|;
name|mbx
operator|.
name|u0
operator|.
name|s
operator|.
name|sge_count
operator|=
literal|1
expr_stmt|;
name|mbx
operator|.
name|payload
operator|.
name|u0
operator|.
name|u1
operator|.
name|sgl
index|[
literal|0
index|]
operator|.
name|pa_lo
operator|=
name|ADDR_LO
argument_list|(
name|sgl
operator|->
name|paddr
argument_list|)
expr_stmt|;
name|mbx
operator|.
name|payload
operator|.
name|u0
operator|.
name|u1
operator|.
name|sgl
index|[
literal|0
index|]
operator|.
name|pa_hi
operator|=
name|ADDR_HI
argument_list|(
name|sgl
operator|->
name|paddr
argument_list|)
expr_stmt|;
name|mbx
operator|.
name|payload
operator|.
name|u0
operator|.
name|u1
operator|.
name|sgl
index|[
literal|0
index|]
operator|.
name|length
operator|=
name|mbx_sz
expr_stmt|;
name|mbx
operator|.
name|payload_length
operator|=
name|mbx_sz
expr_stmt|;
name|DW_SWAP
argument_list|(
name|u32ptr
argument_list|(
operator|&
name|mbx
argument_list|)
argument_list|,
name|mbx
operator|.
name|payload_length
operator|+
name|OCE_BMBX_RHDR_SZ
argument_list|)
expr_stmt|;
name|rc
operator|=
name|oce_mbox_post
argument_list|(
name|sc
argument_list|,
operator|&
name|mbx
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rc
condition|)
name|rc
operator|=
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|rc
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"%s failed - cmd status: %d addi status: %d\n"
argument_list|,
name|__FUNCTION__
argument_list|,
name|rc
argument_list|,
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|additional_status
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_comment
comment|/**  * @brief Function to query the link status from the hardware  * @param sc 		software handle to the device  * @param[out] link	pointer to the structure returning link attributes  * @returns		0 on success, EIO on failure  */
end_comment

begin_function
name|int
name|oce_get_link_status
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
name|struct
name|link_status
modifier|*
name|link
parameter_list|)
block|{
name|struct
name|oce_mbx
name|mbx
decl_stmt|;
name|struct
name|mbx_query_common_link_config
modifier|*
name|fwcmd
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|,
name|version
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|mbx
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|oce_mbx
argument_list|)
argument_list|)
expr_stmt|;
name|IS_XE201
argument_list|(
name|sc
argument_list|)
condition|?
operator|(
name|version
operator|=
name|OCE_MBX_VER_V1
operator|)
else|:
operator|(
name|version
operator|=
name|OCE_MBX_VER_V0
operator|)
expr_stmt|;
name|fwcmd
operator|=
operator|(
expr|struct
name|mbx_query_common_link_config
operator|*
operator|)
operator|&
name|mbx
operator|.
name|payload
expr_stmt|;
name|mbx_common_req_hdr_init
argument_list|(
operator|&
name|fwcmd
operator|->
name|hdr
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|MBX_SUBSYSTEM_COMMON
argument_list|,
name|OPCODE_COMMON_QUERY_LINK_CONFIG
argument_list|,
name|MBX_TIMEOUT_SEC
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_query_common_link_config
argument_list|)
argument_list|,
name|version
argument_list|)
expr_stmt|;
name|mbx
operator|.
name|u0
operator|.
name|s
operator|.
name|embedded
operator|=
literal|1
expr_stmt|;
name|mbx
operator|.
name|payload_length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_query_common_link_config
argument_list|)
expr_stmt|;
name|DW_SWAP
argument_list|(
name|u32ptr
argument_list|(
operator|&
name|mbx
argument_list|)
argument_list|,
name|mbx
operator|.
name|payload_length
operator|+
name|OCE_BMBX_RHDR_SZ
argument_list|)
expr_stmt|;
name|rc
operator|=
name|oce_mbox_post
argument_list|(
name|sc
argument_list|,
operator|&
name|mbx
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rc
condition|)
name|rc
operator|=
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"%s failed - cmd status: %d addi status: %d\n"
argument_list|,
name|__FUNCTION__
argument_list|,
name|rc
argument_list|,
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|additional_status
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
comment|/* interpret response */
name|bcopy
argument_list|(
operator|&
name|fwcmd
operator|->
name|params
operator|.
name|rsp
argument_list|,
name|link
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|link_status
argument_list|)
argument_list|)
expr_stmt|;
name|link
operator|->
name|logical_link_status
operator|=
name|HOST_32
argument_list|(
name|link
operator|->
name|logical_link_status
argument_list|)
expr_stmt|;
name|link
operator|->
name|qos_link_speed
operator|=
name|HOST_16
argument_list|(
name|link
operator|->
name|qos_link_speed
argument_list|)
expr_stmt|;
name|error
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
name|int
name|oce_mbox_get_nic_stats_v0
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
name|POCE_DMA_MEM
name|pstats_dma_mem
parameter_list|)
block|{
name|struct
name|oce_mbx
name|mbx
decl_stmt|;
name|struct
name|mbx_get_nic_stats_v0
modifier|*
name|fwcmd
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|mbx
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|oce_mbx
argument_list|)
argument_list|)
expr_stmt|;
name|fwcmd
operator|=
name|OCE_DMAPTR
argument_list|(
name|pstats_dma_mem
argument_list|,
expr|struct
name|mbx_get_nic_stats_v0
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|fwcmd
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_get_nic_stats_v0
argument_list|)
argument_list|)
expr_stmt|;
name|mbx_common_req_hdr_init
argument_list|(
operator|&
name|fwcmd
operator|->
name|hdr
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|MBX_SUBSYSTEM_NIC
argument_list|,
name|NIC_GET_STATS
argument_list|,
name|MBX_TIMEOUT_SEC
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_get_nic_stats_v0
argument_list|)
argument_list|,
name|OCE_MBX_VER_V0
argument_list|)
expr_stmt|;
name|mbx
operator|.
name|u0
operator|.
name|s
operator|.
name|embedded
operator|=
literal|0
expr_stmt|;
name|mbx
operator|.
name|u0
operator|.
name|s
operator|.
name|sge_count
operator|=
literal|1
expr_stmt|;
name|oce_dma_sync
argument_list|(
name|pstats_dma_mem
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
name|mbx
operator|.
name|payload
operator|.
name|u0
operator|.
name|u1
operator|.
name|sgl
index|[
literal|0
index|]
operator|.
name|pa_lo
operator|=
name|ADDR_LO
argument_list|(
name|pstats_dma_mem
operator|->
name|paddr
argument_list|)
expr_stmt|;
name|mbx
operator|.
name|payload
operator|.
name|u0
operator|.
name|u1
operator|.
name|sgl
index|[
literal|0
index|]
operator|.
name|pa_hi
operator|=
name|ADDR_HI
argument_list|(
name|pstats_dma_mem
operator|->
name|paddr
argument_list|)
expr_stmt|;
name|mbx
operator|.
name|payload
operator|.
name|u0
operator|.
name|u1
operator|.
name|sgl
index|[
literal|0
index|]
operator|.
name|length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_get_nic_stats_v0
argument_list|)
expr_stmt|;
name|mbx
operator|.
name|payload_length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_get_nic_stats_v0
argument_list|)
expr_stmt|;
name|DW_SWAP
argument_list|(
name|u32ptr
argument_list|(
operator|&
name|mbx
argument_list|)
argument_list|,
name|mbx
operator|.
name|payload_length
operator|+
name|OCE_BMBX_RHDR_SZ
argument_list|)
expr_stmt|;
name|rc
operator|=
name|oce_mbox_post
argument_list|(
name|sc
argument_list|,
operator|&
name|mbx
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|oce_dma_sync
argument_list|(
name|pstats_dma_mem
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rc
condition|)
name|rc
operator|=
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|rc
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"%s failed - cmd status: %d addi status: %d\n"
argument_list|,
name|__FUNCTION__
argument_list|,
name|rc
argument_list|,
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|additional_status
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_comment
comment|/**  * @brief Function to get NIC statistics  * @param sc 		software handle to the device  * @param *stats	pointer to where to store statistics  * @param reset_stats	resets statistics of set  * @returns		0 on success, EIO on failure  * @note		command depricated in Lancer  */
end_comment

begin_function
name|int
name|oce_mbox_get_nic_stats
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
name|POCE_DMA_MEM
name|pstats_dma_mem
parameter_list|)
block|{
name|struct
name|oce_mbx
name|mbx
decl_stmt|;
name|struct
name|mbx_get_nic_stats
modifier|*
name|fwcmd
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|mbx
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|oce_mbx
argument_list|)
argument_list|)
expr_stmt|;
name|fwcmd
operator|=
name|OCE_DMAPTR
argument_list|(
name|pstats_dma_mem
argument_list|,
expr|struct
name|mbx_get_nic_stats
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|fwcmd
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_get_nic_stats
argument_list|)
argument_list|)
expr_stmt|;
name|mbx_common_req_hdr_init
argument_list|(
operator|&
name|fwcmd
operator|->
name|hdr
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|MBX_SUBSYSTEM_NIC
argument_list|,
name|NIC_GET_STATS
argument_list|,
name|MBX_TIMEOUT_SEC
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_get_nic_stats
argument_list|)
argument_list|,
name|OCE_MBX_VER_V1
argument_list|)
expr_stmt|;
name|mbx
operator|.
name|u0
operator|.
name|s
operator|.
name|embedded
operator|=
literal|0
expr_stmt|;
comment|/* stats too large for embedded mbx rsp */
name|mbx
operator|.
name|u0
operator|.
name|s
operator|.
name|sge_count
operator|=
literal|1
expr_stmt|;
comment|/* using scatter gather instead */
name|oce_dma_sync
argument_list|(
name|pstats_dma_mem
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
name|mbx
operator|.
name|payload
operator|.
name|u0
operator|.
name|u1
operator|.
name|sgl
index|[
literal|0
index|]
operator|.
name|pa_lo
operator|=
name|ADDR_LO
argument_list|(
name|pstats_dma_mem
operator|->
name|paddr
argument_list|)
expr_stmt|;
name|mbx
operator|.
name|payload
operator|.
name|u0
operator|.
name|u1
operator|.
name|sgl
index|[
literal|0
index|]
operator|.
name|pa_hi
operator|=
name|ADDR_HI
argument_list|(
name|pstats_dma_mem
operator|->
name|paddr
argument_list|)
expr_stmt|;
name|mbx
operator|.
name|payload
operator|.
name|u0
operator|.
name|u1
operator|.
name|sgl
index|[
literal|0
index|]
operator|.
name|length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_get_nic_stats
argument_list|)
expr_stmt|;
name|mbx
operator|.
name|payload_length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_get_nic_stats
argument_list|)
expr_stmt|;
name|DW_SWAP
argument_list|(
name|u32ptr
argument_list|(
operator|&
name|mbx
argument_list|)
argument_list|,
name|mbx
operator|.
name|payload_length
operator|+
name|OCE_BMBX_RHDR_SZ
argument_list|)
expr_stmt|;
name|rc
operator|=
name|oce_mbox_post
argument_list|(
name|sc
argument_list|,
operator|&
name|mbx
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|oce_dma_sync
argument_list|(
name|pstats_dma_mem
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rc
condition|)
name|rc
operator|=
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|rc
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"%s failed - cmd status: %d addi status: %d\n"
argument_list|,
name|__FUNCTION__
argument_list|,
name|rc
argument_list|,
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|additional_status
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_comment
comment|/**  * @brief Function to get pport (physical port) statistics  * @param sc 		software handle to the device  * @param *stats	pointer to where to store statistics  * @param reset_stats	resets statistics of set  * @returns		0 on success, EIO on failure  */
end_comment

begin_function
name|int
name|oce_mbox_get_pport_stats
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
name|POCE_DMA_MEM
name|pstats_dma_mem
parameter_list|,
name|uint32_t
name|reset_stats
parameter_list|)
block|{
name|struct
name|oce_mbx
name|mbx
decl_stmt|;
name|struct
name|mbx_get_pport_stats
modifier|*
name|fwcmd
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|mbx
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|oce_mbx
argument_list|)
argument_list|)
expr_stmt|;
name|fwcmd
operator|=
name|OCE_DMAPTR
argument_list|(
name|pstats_dma_mem
argument_list|,
expr|struct
name|mbx_get_pport_stats
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|fwcmd
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_get_pport_stats
argument_list|)
argument_list|)
expr_stmt|;
name|mbx_common_req_hdr_init
argument_list|(
operator|&
name|fwcmd
operator|->
name|hdr
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|MBX_SUBSYSTEM_NIC
argument_list|,
name|NIC_GET_PPORT_STATS
argument_list|,
name|MBX_TIMEOUT_SEC
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_get_pport_stats
argument_list|)
argument_list|,
name|OCE_MBX_VER_V0
argument_list|)
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|reset_stats
operator|=
name|reset_stats
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|port_number
operator|=
name|sc
operator|->
name|port_id
expr_stmt|;
name|mbx
operator|.
name|u0
operator|.
name|s
operator|.
name|embedded
operator|=
literal|0
expr_stmt|;
comment|/* stats too large for embedded mbx rsp */
name|mbx
operator|.
name|u0
operator|.
name|s
operator|.
name|sge_count
operator|=
literal|1
expr_stmt|;
comment|/* using scatter gather instead */
name|oce_dma_sync
argument_list|(
name|pstats_dma_mem
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
name|mbx
operator|.
name|payload
operator|.
name|u0
operator|.
name|u1
operator|.
name|sgl
index|[
literal|0
index|]
operator|.
name|pa_lo
operator|=
name|ADDR_LO
argument_list|(
name|pstats_dma_mem
operator|->
name|paddr
argument_list|)
expr_stmt|;
name|mbx
operator|.
name|payload
operator|.
name|u0
operator|.
name|u1
operator|.
name|sgl
index|[
literal|0
index|]
operator|.
name|pa_hi
operator|=
name|ADDR_HI
argument_list|(
name|pstats_dma_mem
operator|->
name|paddr
argument_list|)
expr_stmt|;
name|mbx
operator|.
name|payload
operator|.
name|u0
operator|.
name|u1
operator|.
name|sgl
index|[
literal|0
index|]
operator|.
name|length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_get_pport_stats
argument_list|)
expr_stmt|;
name|mbx
operator|.
name|payload_length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_get_pport_stats
argument_list|)
expr_stmt|;
name|DW_SWAP
argument_list|(
name|u32ptr
argument_list|(
operator|&
name|mbx
argument_list|)
argument_list|,
name|mbx
operator|.
name|payload_length
operator|+
name|OCE_BMBX_RHDR_SZ
argument_list|)
expr_stmt|;
name|rc
operator|=
name|oce_mbox_post
argument_list|(
name|sc
argument_list|,
operator|&
name|mbx
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|oce_dma_sync
argument_list|(
name|pstats_dma_mem
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rc
condition|)
name|rc
operator|=
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|rc
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"%s failed - cmd status: %d addi status: %d\n"
argument_list|,
name|__FUNCTION__
argument_list|,
name|rc
argument_list|,
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|additional_status
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_comment
comment|/**  * @brief Function to get vport (virtual port) statistics  * @param sc 		software handle to the device  * @param *stats	pointer to where to store statistics  * @param reset_stats	resets statistics of set  * @returns		0 on success, EIO on failure  */
end_comment

begin_function
name|int
name|oce_mbox_get_vport_stats
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
name|POCE_DMA_MEM
name|pstats_dma_mem
parameter_list|,
name|uint32_t
name|req_size
parameter_list|,
name|uint32_t
name|reset_stats
parameter_list|)
block|{
name|struct
name|oce_mbx
name|mbx
decl_stmt|;
name|struct
name|mbx_get_vport_stats
modifier|*
name|fwcmd
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|mbx
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|oce_mbx
argument_list|)
argument_list|)
expr_stmt|;
name|fwcmd
operator|=
name|OCE_DMAPTR
argument_list|(
name|pstats_dma_mem
argument_list|,
expr|struct
name|mbx_get_vport_stats
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|fwcmd
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_get_vport_stats
argument_list|)
argument_list|)
expr_stmt|;
name|mbx_common_req_hdr_init
argument_list|(
operator|&
name|fwcmd
operator|->
name|hdr
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|MBX_SUBSYSTEM_NIC
argument_list|,
name|NIC_GET_VPORT_STATS
argument_list|,
name|MBX_TIMEOUT_SEC
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_get_vport_stats
argument_list|)
argument_list|,
name|OCE_MBX_VER_V0
argument_list|)
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|reset_stats
operator|=
name|reset_stats
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|vport_number
operator|=
name|sc
operator|->
name|if_id
expr_stmt|;
name|mbx
operator|.
name|u0
operator|.
name|s
operator|.
name|embedded
operator|=
literal|0
expr_stmt|;
comment|/* stats too large for embedded mbx rsp */
name|mbx
operator|.
name|u0
operator|.
name|s
operator|.
name|sge_count
operator|=
literal|1
expr_stmt|;
comment|/* using scatter gather instead */
name|oce_dma_sync
argument_list|(
name|pstats_dma_mem
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
name|mbx
operator|.
name|payload
operator|.
name|u0
operator|.
name|u1
operator|.
name|sgl
index|[
literal|0
index|]
operator|.
name|pa_lo
operator|=
name|ADDR_LO
argument_list|(
name|pstats_dma_mem
operator|->
name|paddr
argument_list|)
expr_stmt|;
name|mbx
operator|.
name|payload
operator|.
name|u0
operator|.
name|u1
operator|.
name|sgl
index|[
literal|0
index|]
operator|.
name|pa_hi
operator|=
name|ADDR_HI
argument_list|(
name|pstats_dma_mem
operator|->
name|paddr
argument_list|)
expr_stmt|;
name|mbx
operator|.
name|payload
operator|.
name|u0
operator|.
name|u1
operator|.
name|sgl
index|[
literal|0
index|]
operator|.
name|length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_get_vport_stats
argument_list|)
expr_stmt|;
name|mbx
operator|.
name|payload_length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_get_vport_stats
argument_list|)
expr_stmt|;
name|DW_SWAP
argument_list|(
name|u32ptr
argument_list|(
operator|&
name|mbx
argument_list|)
argument_list|,
name|mbx
operator|.
name|payload_length
operator|+
name|OCE_BMBX_RHDR_SZ
argument_list|)
expr_stmt|;
name|rc
operator|=
name|oce_mbox_post
argument_list|(
name|sc
argument_list|,
operator|&
name|mbx
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|oce_dma_sync
argument_list|(
name|pstats_dma_mem
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rc
condition|)
name|rc
operator|=
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|rc
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"%s failed - cmd status: %d addi status: %d\n"
argument_list|,
name|__FUNCTION__
argument_list|,
name|rc
argument_list|,
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|additional_status
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_comment
comment|/**  * @brief               Function to update the muticast filter with   *                      values in dma_mem   * @param sc            software handle to the device  * @param dma_mem       pointer to dma memory region  * @returns             0 on success, EIO on failure  */
end_comment

begin_function
name|int
name|oce_update_multicast
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
name|POCE_DMA_MEM
name|pdma_mem
parameter_list|)
block|{
name|struct
name|oce_mbx
name|mbx
decl_stmt|;
name|struct
name|oce_mq_sge
modifier|*
name|sgl
decl_stmt|;
name|struct
name|mbx_set_common_iface_multicast
modifier|*
name|req
init|=
name|NULL
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|req
operator|=
name|OCE_DMAPTR
argument_list|(
name|pdma_mem
argument_list|,
expr|struct
name|mbx_set_common_iface_multicast
argument_list|)
expr_stmt|;
name|mbx_common_req_hdr_init
argument_list|(
operator|&
name|req
operator|->
name|hdr
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|MBX_SUBSYSTEM_COMMON
argument_list|,
name|OPCODE_COMMON_SET_IFACE_MULTICAST
argument_list|,
name|MBX_TIMEOUT_SEC
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_set_common_iface_multicast
argument_list|)
argument_list|,
name|OCE_MBX_VER_V0
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|mbx
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|oce_mbx
argument_list|)
argument_list|)
expr_stmt|;
name|mbx
operator|.
name|u0
operator|.
name|s
operator|.
name|embedded
operator|=
literal|0
expr_stmt|;
comment|/*Non embeded*/
name|mbx
operator|.
name|payload_length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_set_common_iface_multicast
argument_list|)
expr_stmt|;
name|mbx
operator|.
name|u0
operator|.
name|s
operator|.
name|sge_count
operator|=
literal|1
expr_stmt|;
name|sgl
operator|=
operator|&
name|mbx
operator|.
name|payload
operator|.
name|u0
operator|.
name|u1
operator|.
name|sgl
index|[
literal|0
index|]
expr_stmt|;
name|sgl
operator|->
name|pa_hi
operator|=
name|htole32
argument_list|(
name|upper_32_bits
argument_list|(
name|pdma_mem
operator|->
name|paddr
argument_list|)
argument_list|)
expr_stmt|;
name|sgl
operator|->
name|pa_lo
operator|=
name|htole32
argument_list|(
operator|(
name|pdma_mem
operator|->
name|paddr
operator|)
operator|&
literal|0xFFFFFFFF
argument_list|)
expr_stmt|;
name|sgl
operator|->
name|length
operator|=
name|htole32
argument_list|(
name|mbx
operator|.
name|payload_length
argument_list|)
expr_stmt|;
name|DW_SWAP
argument_list|(
name|u32ptr
argument_list|(
operator|&
name|mbx
argument_list|)
argument_list|,
name|mbx
operator|.
name|payload_length
operator|+
name|OCE_BMBX_RHDR_SZ
argument_list|)
expr_stmt|;
name|rc
operator|=
name|oce_mbox_post
argument_list|(
name|sc
argument_list|,
operator|&
name|mbx
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rc
condition|)
name|rc
operator|=
name|req
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|rc
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"%s failed - cmd status: %d addi status: %d\n"
argument_list|,
name|__FUNCTION__
argument_list|,
name|rc
argument_list|,
name|req
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|additional_status
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_comment
comment|/**  * @brief               Function to send passthrough Ioctls  * @param sc            software handle to the device  * @param dma_mem       pointer to dma memory region  * @param req_size      size of dma_mem  * @returns             0 on success, EIO on failure  */
end_comment

begin_function
name|int
name|oce_pass_through_mbox
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
name|POCE_DMA_MEM
name|dma_mem
parameter_list|,
name|uint32_t
name|req_size
parameter_list|)
block|{
name|struct
name|oce_mbx
name|mbx
decl_stmt|;
name|struct
name|oce_mq_sge
modifier|*
name|sgl
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|mbx
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|oce_mbx
argument_list|)
argument_list|)
expr_stmt|;
name|mbx
operator|.
name|u0
operator|.
name|s
operator|.
name|embedded
operator|=
literal|0
expr_stmt|;
comment|/*Non embeded*/
name|mbx
operator|.
name|payload_length
operator|=
name|req_size
expr_stmt|;
name|mbx
operator|.
name|u0
operator|.
name|s
operator|.
name|sge_count
operator|=
literal|1
expr_stmt|;
name|sgl
operator|=
operator|&
name|mbx
operator|.
name|payload
operator|.
name|u0
operator|.
name|u1
operator|.
name|sgl
index|[
literal|0
index|]
expr_stmt|;
name|sgl
operator|->
name|pa_hi
operator|=
name|htole32
argument_list|(
name|upper_32_bits
argument_list|(
name|dma_mem
operator|->
name|paddr
argument_list|)
argument_list|)
expr_stmt|;
name|sgl
operator|->
name|pa_lo
operator|=
name|htole32
argument_list|(
operator|(
name|dma_mem
operator|->
name|paddr
operator|)
operator|&
literal|0xFFFFFFFF
argument_list|)
expr_stmt|;
name|sgl
operator|->
name|length
operator|=
name|htole32
argument_list|(
name|req_size
argument_list|)
expr_stmt|;
name|DW_SWAP
argument_list|(
name|u32ptr
argument_list|(
operator|&
name|mbx
argument_list|)
argument_list|,
name|mbx
operator|.
name|payload_length
operator|+
name|OCE_BMBX_RHDR_SZ
argument_list|)
expr_stmt|;
name|rc
operator|=
name|oce_mbox_post
argument_list|(
name|sc
argument_list|,
operator|&
name|mbx
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
name|int
name|oce_mbox_macaddr_add
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
name|uint8_t
modifier|*
name|mac_addr
parameter_list|,
name|uint32_t
name|if_id
parameter_list|,
name|uint32_t
modifier|*
name|pmac_id
parameter_list|)
block|{
name|struct
name|oce_mbx
name|mbx
decl_stmt|;
name|struct
name|mbx_add_common_iface_mac
modifier|*
name|fwcmd
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|mbx
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|oce_mbx
argument_list|)
argument_list|)
expr_stmt|;
name|fwcmd
operator|=
operator|(
expr|struct
name|mbx_add_common_iface_mac
operator|*
operator|)
operator|&
name|mbx
operator|.
name|payload
expr_stmt|;
name|mbx_common_req_hdr_init
argument_list|(
operator|&
name|fwcmd
operator|->
name|hdr
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|MBX_SUBSYSTEM_COMMON
argument_list|,
name|OPCODE_COMMON_ADD_IFACE_MAC
argument_list|,
name|MBX_TIMEOUT_SEC
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_add_common_iface_mac
argument_list|)
argument_list|,
name|OCE_MBX_VER_V0
argument_list|)
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|if_id
operator|=
operator|(
name|uint16_t
operator|)
name|if_id
expr_stmt|;
name|bcopy
argument_list|(
name|mac_addr
argument_list|,
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|mac_address
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|mbx
operator|.
name|u0
operator|.
name|s
operator|.
name|embedded
operator|=
literal|1
expr_stmt|;
name|mbx
operator|.
name|payload_length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_add_common_iface_mac
argument_list|)
expr_stmt|;
name|DW_SWAP
argument_list|(
name|u32ptr
argument_list|(
operator|&
name|mbx
argument_list|)
argument_list|,
name|mbx
operator|.
name|payload_length
operator|+
name|OCE_BMBX_RHDR_SZ
argument_list|)
expr_stmt|;
name|rc
operator|=
name|oce_mbox_post
argument_list|(
name|sc
argument_list|,
operator|&
name|mbx
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rc
condition|)
name|rc
operator|=
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"%s failed - cmd status: %d addi status: %d\n"
argument_list|,
name|__FUNCTION__
argument_list|,
name|rc
argument_list|,
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|additional_status
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
operator|*
name|pmac_id
operator|=
name|fwcmd
operator|->
name|params
operator|.
name|rsp
operator|.
name|pmac_id
expr_stmt|;
name|error
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
name|int
name|oce_mbox_macaddr_del
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
name|uint32_t
name|if_id
parameter_list|,
name|uint32_t
name|pmac_id
parameter_list|)
block|{
name|struct
name|oce_mbx
name|mbx
decl_stmt|;
name|struct
name|mbx_del_common_iface_mac
modifier|*
name|fwcmd
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|mbx
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|oce_mbx
argument_list|)
argument_list|)
expr_stmt|;
name|fwcmd
operator|=
operator|(
expr|struct
name|mbx_del_common_iface_mac
operator|*
operator|)
operator|&
name|mbx
operator|.
name|payload
expr_stmt|;
name|mbx_common_req_hdr_init
argument_list|(
operator|&
name|fwcmd
operator|->
name|hdr
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|MBX_SUBSYSTEM_COMMON
argument_list|,
name|OPCODE_COMMON_DEL_IFACE_MAC
argument_list|,
name|MBX_TIMEOUT_SEC
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_del_common_iface_mac
argument_list|)
argument_list|,
name|OCE_MBX_VER_V0
argument_list|)
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|if_id
operator|=
operator|(
name|uint16_t
operator|)
name|if_id
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|pmac_id
operator|=
name|pmac_id
expr_stmt|;
name|mbx
operator|.
name|u0
operator|.
name|s
operator|.
name|embedded
operator|=
literal|1
expr_stmt|;
name|mbx
operator|.
name|payload_length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_del_common_iface_mac
argument_list|)
expr_stmt|;
name|DW_SWAP
argument_list|(
name|u32ptr
argument_list|(
operator|&
name|mbx
argument_list|)
argument_list|,
name|mbx
operator|.
name|payload_length
operator|+
name|OCE_BMBX_RHDR_SZ
argument_list|)
expr_stmt|;
name|rc
operator|=
name|oce_mbox_post
argument_list|(
name|sc
argument_list|,
operator|&
name|mbx
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rc
condition|)
name|rc
operator|=
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|rc
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"%s failed - cmd status: %d addi status: %d\n"
argument_list|,
name|__FUNCTION__
argument_list|,
name|rc
argument_list|,
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|additional_status
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
name|int
name|oce_mbox_check_native_mode
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|)
block|{
name|struct
name|oce_mbx
name|mbx
decl_stmt|;
name|struct
name|mbx_common_set_function_cap
modifier|*
name|fwcmd
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|mbx
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|oce_mbx
argument_list|)
argument_list|)
expr_stmt|;
name|fwcmd
operator|=
operator|(
expr|struct
name|mbx_common_set_function_cap
operator|*
operator|)
operator|&
name|mbx
operator|.
name|payload
expr_stmt|;
name|mbx_common_req_hdr_init
argument_list|(
operator|&
name|fwcmd
operator|->
name|hdr
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|MBX_SUBSYSTEM_COMMON
argument_list|,
name|OPCODE_COMMON_SET_FUNCTIONAL_CAPS
argument_list|,
name|MBX_TIMEOUT_SEC
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_common_set_function_cap
argument_list|)
argument_list|,
name|OCE_MBX_VER_V0
argument_list|)
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|valid_capability_flags
operator|=
name|CAP_SW_TIMESTAMPS
operator||
name|CAP_BE3_NATIVE_ERX_API
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|capability_flags
operator|=
name|CAP_BE3_NATIVE_ERX_API
expr_stmt|;
name|mbx
operator|.
name|u0
operator|.
name|s
operator|.
name|embedded
operator|=
literal|1
expr_stmt|;
name|mbx
operator|.
name|payload_length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_common_set_function_cap
argument_list|)
expr_stmt|;
name|DW_SWAP
argument_list|(
name|u32ptr
argument_list|(
operator|&
name|mbx
argument_list|)
argument_list|,
name|mbx
operator|.
name|payload_length
operator|+
name|OCE_BMBX_RHDR_SZ
argument_list|)
expr_stmt|;
name|rc
operator|=
name|oce_mbox_post
argument_list|(
name|sc
argument_list|,
operator|&
name|mbx
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rc
condition|)
name|rc
operator|=
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"%s failed - cmd status: %d addi status: %d\n"
argument_list|,
name|__FUNCTION__
argument_list|,
name|rc
argument_list|,
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|additional_status
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|sc
operator|->
name|be3_native
operator|=
name|HOST_32
argument_list|(
name|fwcmd
operator|->
name|params
operator|.
name|rsp
operator|.
name|capability_flags
argument_list|)
operator|&
name|CAP_BE3_NATIVE_ERX_API
expr_stmt|;
name|error
label|:
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|oce_mbox_cmd_set_loopback
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
name|uint8_t
name|port_num
parameter_list|,
name|uint8_t
name|loopback_type
parameter_list|,
name|uint8_t
name|enable
parameter_list|)
block|{
name|struct
name|oce_mbx
name|mbx
decl_stmt|;
name|struct
name|mbx_lowlevel_set_loopback_mode
modifier|*
name|fwcmd
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|mbx
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|oce_mbx
argument_list|)
argument_list|)
expr_stmt|;
name|fwcmd
operator|=
operator|(
expr|struct
name|mbx_lowlevel_set_loopback_mode
operator|*
operator|)
operator|&
name|mbx
operator|.
name|payload
expr_stmt|;
name|mbx_common_req_hdr_init
argument_list|(
operator|&
name|fwcmd
operator|->
name|hdr
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|MBX_SUBSYSTEM_LOWLEVEL
argument_list|,
name|OPCODE_LOWLEVEL_SET_LOOPBACK_MODE
argument_list|,
name|MBX_TIMEOUT_SEC
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_lowlevel_set_loopback_mode
argument_list|)
argument_list|,
name|OCE_MBX_VER_V0
argument_list|)
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|src_port
operator|=
name|port_num
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|dest_port
operator|=
name|port_num
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|loopback_type
operator|=
name|loopback_type
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|loopback_state
operator|=
name|enable
expr_stmt|;
name|mbx
operator|.
name|u0
operator|.
name|s
operator|.
name|embedded
operator|=
literal|1
expr_stmt|;
name|mbx
operator|.
name|payload_length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_lowlevel_set_loopback_mode
argument_list|)
expr_stmt|;
name|DW_SWAP
argument_list|(
name|u32ptr
argument_list|(
operator|&
name|mbx
argument_list|)
argument_list|,
name|mbx
operator|.
name|payload_length
operator|+
name|OCE_BMBX_RHDR_SZ
argument_list|)
expr_stmt|;
name|rc
operator|=
name|oce_mbox_post
argument_list|(
name|sc
argument_list|,
operator|&
name|mbx
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rc
condition|)
name|rc
operator|=
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|rc
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"%s failed - cmd status: %d addi status: %d\n"
argument_list|,
name|__FUNCTION__
argument_list|,
name|rc
argument_list|,
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|additional_status
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
name|int
name|oce_mbox_cmd_test_loopback
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
name|uint32_t
name|port_num
parameter_list|,
name|uint32_t
name|loopback_type
parameter_list|,
name|uint32_t
name|pkt_size
parameter_list|,
name|uint32_t
name|num_pkts
parameter_list|,
name|uint64_t
name|pattern
parameter_list|)
block|{
name|struct
name|oce_mbx
name|mbx
decl_stmt|;
name|struct
name|mbx_lowlevel_test_loopback_mode
modifier|*
name|fwcmd
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|mbx
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|oce_mbx
argument_list|)
argument_list|)
expr_stmt|;
name|fwcmd
operator|=
operator|(
expr|struct
name|mbx_lowlevel_test_loopback_mode
operator|*
operator|)
operator|&
name|mbx
operator|.
name|payload
expr_stmt|;
name|mbx_common_req_hdr_init
argument_list|(
operator|&
name|fwcmd
operator|->
name|hdr
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|MBX_SUBSYSTEM_LOWLEVEL
argument_list|,
name|OPCODE_LOWLEVEL_TEST_LOOPBACK
argument_list|,
name|MBX_TIMEOUT_SEC
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_lowlevel_test_loopback_mode
argument_list|)
argument_list|,
name|OCE_MBX_VER_V0
argument_list|)
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|pattern
operator|=
name|pattern
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|src_port
operator|=
name|port_num
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|dest_port
operator|=
name|port_num
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|pkt_size
operator|=
name|pkt_size
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|num_pkts
operator|=
name|num_pkts
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|loopback_type
operator|=
name|loopback_type
expr_stmt|;
name|mbx
operator|.
name|u0
operator|.
name|s
operator|.
name|embedded
operator|=
literal|1
expr_stmt|;
name|mbx
operator|.
name|payload_length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_lowlevel_test_loopback_mode
argument_list|)
expr_stmt|;
name|DW_SWAP
argument_list|(
name|u32ptr
argument_list|(
operator|&
name|mbx
argument_list|)
argument_list|,
name|mbx
operator|.
name|payload_length
operator|+
name|OCE_BMBX_RHDR_SZ
argument_list|)
expr_stmt|;
name|rc
operator|=
name|oce_mbox_post
argument_list|(
name|sc
argument_list|,
operator|&
name|mbx
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rc
condition|)
name|rc
operator|=
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|rc
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"%s failed - cmd status: %d addi status: %d\n"
argument_list|,
name|__FUNCTION__
argument_list|,
name|rc
argument_list|,
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|additional_status
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
name|int
name|oce_mbox_write_flashrom
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
name|uint32_t
name|optype
parameter_list|,
name|uint32_t
name|opcode
parameter_list|,
name|POCE_DMA_MEM
name|pdma_mem
parameter_list|,
name|uint32_t
name|num_bytes
parameter_list|)
block|{
name|struct
name|oce_mbx
name|mbx
decl_stmt|;
name|struct
name|oce_mq_sge
modifier|*
name|sgl
init|=
name|NULL
decl_stmt|;
name|struct
name|mbx_common_read_write_flashrom
modifier|*
name|fwcmd
init|=
name|NULL
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|,
name|payload_len
init|=
literal|0
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|mbx
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|oce_mbx
argument_list|)
argument_list|)
expr_stmt|;
name|fwcmd
operator|=
name|OCE_DMAPTR
argument_list|(
name|pdma_mem
argument_list|,
expr|struct
name|mbx_common_read_write_flashrom
argument_list|)
expr_stmt|;
name|payload_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_common_read_write_flashrom
argument_list|)
operator|+
literal|32
operator|*
literal|1024
expr_stmt|;
name|mbx_common_req_hdr_init
argument_list|(
operator|&
name|fwcmd
operator|->
name|hdr
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|MBX_SUBSYSTEM_COMMON
argument_list|,
name|OPCODE_COMMON_WRITE_FLASHROM
argument_list|,
name|LONG_TIMEOUT
argument_list|,
name|payload_len
argument_list|,
name|OCE_MBX_VER_V0
argument_list|)
expr_stmt|;
name|fwcmd
operator|->
name|flash_op_type
operator|=
name|LE_32
argument_list|(
name|optype
argument_list|)
expr_stmt|;
name|fwcmd
operator|->
name|flash_op_code
operator|=
name|LE_32
argument_list|(
name|opcode
argument_list|)
expr_stmt|;
name|fwcmd
operator|->
name|data_buffer_size
operator|=
name|LE_32
argument_list|(
name|num_bytes
argument_list|)
expr_stmt|;
name|mbx
operator|.
name|u0
operator|.
name|s
operator|.
name|embedded
operator|=
literal|0
expr_stmt|;
comment|/*Non embeded*/
name|mbx
operator|.
name|payload_length
operator|=
name|payload_len
expr_stmt|;
name|mbx
operator|.
name|u0
operator|.
name|s
operator|.
name|sge_count
operator|=
literal|1
expr_stmt|;
name|sgl
operator|=
operator|&
name|mbx
operator|.
name|payload
operator|.
name|u0
operator|.
name|u1
operator|.
name|sgl
index|[
literal|0
index|]
expr_stmt|;
name|sgl
operator|->
name|pa_hi
operator|=
name|upper_32_bits
argument_list|(
name|pdma_mem
operator|->
name|paddr
argument_list|)
expr_stmt|;
name|sgl
operator|->
name|pa_lo
operator|=
name|pdma_mem
operator|->
name|paddr
operator|&
literal|0xFFFFFFFF
expr_stmt|;
name|sgl
operator|->
name|length
operator|=
name|payload_len
expr_stmt|;
comment|/* post the command */
name|rc
operator|=
name|oce_mbox_post
argument_list|(
name|sc
argument_list|,
operator|&
name|mbx
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rc
condition|)
name|rc
operator|=
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|rc
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"%s failed - cmd status: %d addi status: %d\n"
argument_list|,
name|__FUNCTION__
argument_list|,
name|rc
argument_list|,
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|additional_status
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
name|int
name|oce_mbox_get_flashrom_crc
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
name|uint8_t
modifier|*
name|flash_crc
parameter_list|,
name|uint32_t
name|offset
parameter_list|,
name|uint32_t
name|optype
parameter_list|)
block|{
name|int
name|rc
init|=
literal|0
decl_stmt|,
name|payload_len
init|=
literal|0
decl_stmt|;
name|struct
name|oce_mbx
name|mbx
decl_stmt|;
name|struct
name|mbx_common_read_write_flashrom
modifier|*
name|fwcmd
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|mbx
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|oce_mbx
argument_list|)
argument_list|)
expr_stmt|;
name|fwcmd
operator|=
operator|(
expr|struct
name|mbx_common_read_write_flashrom
operator|*
operator|)
operator|&
name|mbx
operator|.
name|payload
expr_stmt|;
comment|/* Firmware requires extra 4 bytes with this ioctl. Since there 	   is enough room in the mbx payload it should be good enough 	   Reference: Bug 14853 	*/
name|payload_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_common_read_write_flashrom
argument_list|)
operator|+
literal|4
expr_stmt|;
name|mbx_common_req_hdr_init
argument_list|(
operator|&
name|fwcmd
operator|->
name|hdr
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|MBX_SUBSYSTEM_COMMON
argument_list|,
name|OPCODE_COMMON_READ_FLASHROM
argument_list|,
name|MBX_TIMEOUT_SEC
argument_list|,
name|payload_len
argument_list|,
name|OCE_MBX_VER_V0
argument_list|)
expr_stmt|;
name|fwcmd
operator|->
name|flash_op_type
operator|=
name|optype
expr_stmt|;
name|fwcmd
operator|->
name|flash_op_code
operator|=
name|FLASHROM_OPER_REPORT
expr_stmt|;
name|fwcmd
operator|->
name|data_offset
operator|=
name|offset
expr_stmt|;
name|fwcmd
operator|->
name|data_buffer_size
operator|=
literal|0x4
expr_stmt|;
name|mbx
operator|.
name|u0
operator|.
name|s
operator|.
name|embedded
operator|=
literal|1
expr_stmt|;
name|mbx
operator|.
name|payload_length
operator|=
name|payload_len
expr_stmt|;
comment|/* post the command */
name|rc
operator|=
name|oce_mbox_post
argument_list|(
name|sc
argument_list|,
operator|&
name|mbx
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rc
condition|)
name|rc
operator|=
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"%s failed - cmd status: %d addi status: %d\n"
argument_list|,
name|__FUNCTION__
argument_list|,
name|rc
argument_list|,
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|additional_status
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|bcopy
argument_list|(
name|fwcmd
operator|->
name|data_buffer
argument_list|,
name|flash_crc
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|error
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
name|int
name|oce_mbox_get_phy_info
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
name|struct
name|oce_phy_info
modifier|*
name|phy_info
parameter_list|)
block|{
name|struct
name|oce_mbx
name|mbx
decl_stmt|;
name|struct
name|mbx_common_phy_info
modifier|*
name|fwcmd
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|mbx
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|oce_mbx
argument_list|)
argument_list|)
expr_stmt|;
name|fwcmd
operator|=
operator|(
expr|struct
name|mbx_common_phy_info
operator|*
operator|)
operator|&
name|mbx
operator|.
name|payload
expr_stmt|;
name|mbx_common_req_hdr_init
argument_list|(
operator|&
name|fwcmd
operator|->
name|hdr
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|MBX_SUBSYSTEM_COMMON
argument_list|,
name|OPCODE_COMMON_GET_PHY_CONFIG
argument_list|,
name|MBX_TIMEOUT_SEC
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_common_phy_info
argument_list|)
argument_list|,
name|OCE_MBX_VER_V0
argument_list|)
expr_stmt|;
name|mbx
operator|.
name|u0
operator|.
name|s
operator|.
name|embedded
operator|=
literal|1
expr_stmt|;
name|mbx
operator|.
name|payload_length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_common_phy_info
argument_list|)
expr_stmt|;
comment|/* now post the command */
name|rc
operator|=
name|oce_mbox_post
argument_list|(
name|sc
argument_list|,
operator|&
name|mbx
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rc
condition|)
name|rc
operator|=
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"%s failed - cmd status: %d addi status: %d\n"
argument_list|,
name|__FUNCTION__
argument_list|,
name|rc
argument_list|,
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|additional_status
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|phy_info
operator|->
name|phy_type
operator|=
name|HOST_16
argument_list|(
name|fwcmd
operator|->
name|params
operator|.
name|rsp
operator|.
name|phy_info
operator|.
name|phy_type
argument_list|)
expr_stmt|;
name|phy_info
operator|->
name|interface_type
operator|=
name|HOST_16
argument_list|(
name|fwcmd
operator|->
name|params
operator|.
name|rsp
operator|.
name|phy_info
operator|.
name|interface_type
argument_list|)
expr_stmt|;
name|phy_info
operator|->
name|auto_speeds_supported
operator|=
name|HOST_16
argument_list|(
name|fwcmd
operator|->
name|params
operator|.
name|rsp
operator|.
name|phy_info
operator|.
name|auto_speeds_supported
argument_list|)
expr_stmt|;
name|phy_info
operator|->
name|fixed_speeds_supported
operator|=
name|HOST_16
argument_list|(
name|fwcmd
operator|->
name|params
operator|.
name|rsp
operator|.
name|phy_info
operator|.
name|fixed_speeds_supported
argument_list|)
expr_stmt|;
name|phy_info
operator|->
name|misc_params
operator|=
name|HOST_32
argument_list|(
name|fwcmd
operator|->
name|params
operator|.
name|rsp
operator|.
name|phy_info
operator|.
name|misc_params
argument_list|)
expr_stmt|;
name|error
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
name|int
name|oce_mbox_lancer_write_flashrom
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
name|uint32_t
name|data_size
parameter_list|,
name|uint32_t
name|data_offset
parameter_list|,
name|POCE_DMA_MEM
name|pdma_mem
parameter_list|,
name|uint32_t
modifier|*
name|written_data
parameter_list|,
name|uint32_t
modifier|*
name|additional_status
parameter_list|)
block|{
name|struct
name|oce_mbx
name|mbx
decl_stmt|;
name|struct
name|mbx_lancer_common_write_object
modifier|*
name|fwcmd
init|=
name|NULL
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|,
name|payload_len
init|=
literal|0
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|mbx
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|oce_mbx
argument_list|)
argument_list|)
expr_stmt|;
name|payload_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_lancer_common_write_object
argument_list|)
expr_stmt|;
name|mbx
operator|.
name|u0
operator|.
name|s
operator|.
name|embedded
operator|=
literal|1
expr_stmt|;
comment|/* Embedded */
name|mbx
operator|.
name|payload_length
operator|=
name|payload_len
expr_stmt|;
name|fwcmd
operator|=
operator|(
expr|struct
name|mbx_lancer_common_write_object
operator|*
operator|)
operator|&
name|mbx
operator|.
name|payload
expr_stmt|;
comment|/* initialize the ioctl header */
name|mbx_common_req_hdr_init
argument_list|(
operator|&
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|hdr
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|MBX_SUBSYSTEM_COMMON
argument_list|,
name|OPCODE_COMMON_WRITE_OBJECT
argument_list|,
name|LONG_TIMEOUT
argument_list|,
name|payload_len
argument_list|,
name|OCE_MBX_VER_V0
argument_list|)
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|write_length
operator|=
name|data_size
expr_stmt|;
if|if
condition|(
name|data_size
operator|==
literal|0
condition|)
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|eof
operator|=
literal|1
expr_stmt|;
else|else
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|eof
operator|=
literal|0
expr_stmt|;
name|strcpy
argument_list|(
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|object_name
argument_list|,
literal|"/prg"
argument_list|)
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|descriptor_count
operator|=
literal|1
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|write_offset
operator|=
name|data_offset
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|buffer_length
operator|=
name|data_size
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|address_lower
operator|=
name|pdma_mem
operator|->
name|paddr
operator|&
literal|0xFFFFFFFF
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|address_upper
operator|=
name|upper_32_bits
argument_list|(
name|pdma_mem
operator|->
name|paddr
argument_list|)
expr_stmt|;
comment|/* post the command */
name|rc
operator|=
name|oce_mbox_post
argument_list|(
name|sc
argument_list|,
operator|&
name|mbx
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rc
condition|)
name|rc
operator|=
name|fwcmd
operator|->
name|params
operator|.
name|rsp
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"%s failed - cmd status: %d addi status: %d\n"
argument_list|,
name|__FUNCTION__
argument_list|,
name|rc
argument_list|,
name|fwcmd
operator|->
name|params
operator|.
name|rsp
operator|.
name|additional_status
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
operator|*
name|written_data
operator|=
name|HOST_32
argument_list|(
name|fwcmd
operator|->
name|params
operator|.
name|rsp
operator|.
name|actual_write_length
argument_list|)
expr_stmt|;
operator|*
name|additional_status
operator|=
name|fwcmd
operator|->
name|params
operator|.
name|rsp
operator|.
name|additional_status
expr_stmt|;
name|error
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
name|int
name|oce_mbox_create_rq
parameter_list|(
name|struct
name|oce_rq
modifier|*
name|rq
parameter_list|)
block|{
name|struct
name|oce_mbx
name|mbx
decl_stmt|;
name|struct
name|mbx_create_nic_rq
modifier|*
name|fwcmd
decl_stmt|;
name|POCE_SOFTC
name|sc
init|=
name|rq
operator|->
name|parent
decl_stmt|;
name|int
name|rc
decl_stmt|,
name|num_pages
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|rq
operator|->
name|qstate
operator|==
name|QCREATED
condition|)
return|return
literal|0
return|;
name|bzero
argument_list|(
operator|&
name|mbx
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|oce_mbx
argument_list|)
argument_list|)
expr_stmt|;
name|fwcmd
operator|=
operator|(
expr|struct
name|mbx_create_nic_rq
operator|*
operator|)
operator|&
name|mbx
operator|.
name|payload
expr_stmt|;
name|mbx_common_req_hdr_init
argument_list|(
operator|&
name|fwcmd
operator|->
name|hdr
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|MBX_SUBSYSTEM_NIC
argument_list|,
name|NIC_CREATE_RQ
argument_list|,
name|MBX_TIMEOUT_SEC
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_create_nic_rq
argument_list|)
argument_list|,
name|OCE_MBX_VER_V0
argument_list|)
expr_stmt|;
comment|/* oce_page_list will also prepare pages */
name|num_pages
operator|=
name|oce_page_list
argument_list|(
name|rq
operator|->
name|ring
argument_list|,
operator|&
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|pages
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_XE201
argument_list|(
name|sc
argument_list|)
condition|)
block|{
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|frag_size
operator|=
name|rq
operator|->
name|cfg
operator|.
name|frag_size
operator|/
literal|2048
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|page_size
operator|=
literal|1
expr_stmt|;
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|req
operator|.
name|version
operator|=
name|OCE_MBX_VER_V1
expr_stmt|;
block|}
else|else
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|frag_size
operator|=
name|OCE_LOG2
argument_list|(
name|rq
operator|->
name|cfg
operator|.
name|frag_size
argument_list|)
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|num_pages
operator|=
name|num_pages
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|cq_id
operator|=
name|rq
operator|->
name|cq
operator|->
name|cq_id
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|if_id
operator|=
name|sc
operator|->
name|if_id
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|max_frame_size
operator|=
name|rq
operator|->
name|cfg
operator|.
name|mtu
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|is_rss_queue
operator|=
name|rq
operator|->
name|cfg
operator|.
name|is_rss_queue
expr_stmt|;
name|mbx
operator|.
name|u0
operator|.
name|s
operator|.
name|embedded
operator|=
literal|1
expr_stmt|;
name|mbx
operator|.
name|payload_length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_create_nic_rq
argument_list|)
expr_stmt|;
name|rc
operator|=
name|oce_mbox_post
argument_list|(
name|sc
argument_list|,
operator|&
name|mbx
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rc
condition|)
name|rc
operator|=
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"%s failed - cmd status: %d addi status: %d\n"
argument_list|,
name|__FUNCTION__
argument_list|,
name|rc
argument_list|,
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|additional_status
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|rq
operator|->
name|rq_id
operator|=
name|HOST_16
argument_list|(
name|fwcmd
operator|->
name|params
operator|.
name|rsp
operator|.
name|rq_id
argument_list|)
expr_stmt|;
name|rq
operator|->
name|rss_cpuid
operator|=
name|fwcmd
operator|->
name|params
operator|.
name|rsp
operator|.
name|rss_cpuid
expr_stmt|;
name|error
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
name|int
name|oce_mbox_create_wq
parameter_list|(
name|struct
name|oce_wq
modifier|*
name|wq
parameter_list|)
block|{
name|struct
name|oce_mbx
name|mbx
decl_stmt|;
name|struct
name|mbx_create_nic_wq
modifier|*
name|fwcmd
decl_stmt|;
name|POCE_SOFTC
name|sc
init|=
name|wq
operator|->
name|parent
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|,
name|version
decl_stmt|,
name|num_pages
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|mbx
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|oce_mbx
argument_list|)
argument_list|)
expr_stmt|;
name|fwcmd
operator|=
operator|(
expr|struct
name|mbx_create_nic_wq
operator|*
operator|)
operator|&
name|mbx
operator|.
name|payload
expr_stmt|;
if|if
condition|(
name|IS_XE201
argument_list|(
name|sc
argument_list|)
condition|)
name|version
operator|=
name|OCE_MBX_VER_V1
expr_stmt|;
elseif|else
if|if
condition|(
name|IS_BE
argument_list|(
name|sc
argument_list|)
condition|)
name|IS_PROFILE_SUPER_NIC
argument_list|(
name|sc
argument_list|)
condition|?
operator|(
name|version
operator|=
name|OCE_MBX_VER_V2
operator|)
else|:
operator|(
name|version
operator|=
name|OCE_MBX_VER_V0
operator|)
expr_stmt|;
else|else
name|version
operator|=
name|OCE_MBX_VER_V2
expr_stmt|;
if|if
condition|(
name|version
operator|>
name|OCE_MBX_VER_V0
condition|)
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|if_id
operator|=
name|sc
operator|->
name|if_id
expr_stmt|;
name|mbx_common_req_hdr_init
argument_list|(
operator|&
name|fwcmd
operator|->
name|hdr
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|MBX_SUBSYSTEM_NIC
argument_list|,
name|NIC_CREATE_WQ
argument_list|,
name|MBX_TIMEOUT_SEC
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_create_nic_wq
argument_list|)
argument_list|,
name|version
argument_list|)
expr_stmt|;
name|num_pages
operator|=
name|oce_page_list
argument_list|(
name|wq
operator|->
name|ring
argument_list|,
operator|&
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|pages
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|nic_wq_type
operator|=
name|wq
operator|->
name|cfg
operator|.
name|wq_type
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|num_pages
operator|=
name|num_pages
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|wq_size
operator|=
name|OCE_LOG2
argument_list|(
name|wq
operator|->
name|cfg
operator|.
name|q_len
argument_list|)
operator|+
literal|1
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|cq_id
operator|=
name|wq
operator|->
name|cq
operator|->
name|cq_id
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|ulp_num
operator|=
literal|1
expr_stmt|;
name|mbx
operator|.
name|u0
operator|.
name|s
operator|.
name|embedded
operator|=
literal|1
expr_stmt|;
name|mbx
operator|.
name|payload_length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_create_nic_wq
argument_list|)
expr_stmt|;
name|rc
operator|=
name|oce_mbox_post
argument_list|(
name|sc
argument_list|,
operator|&
name|mbx
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rc
condition|)
name|rc
operator|=
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"%s failed - cmd status: %d addi status: %d\n"
argument_list|,
name|__FUNCTION__
argument_list|,
name|rc
argument_list|,
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|additional_status
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|wq
operator|->
name|wq_id
operator|=
name|HOST_16
argument_list|(
name|fwcmd
operator|->
name|params
operator|.
name|rsp
operator|.
name|wq_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|version
operator|==
name|OCE_MBX_VER_V2
condition|)
name|wq
operator|->
name|db_offset
operator|=
name|HOST_32
argument_list|(
name|fwcmd
operator|->
name|params
operator|.
name|rsp
operator|.
name|db_offset
argument_list|)
expr_stmt|;
else|else
name|wq
operator|->
name|db_offset
operator|=
name|PD_TXULP_DB
expr_stmt|;
name|error
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
name|int
name|oce_mbox_create_eq
parameter_list|(
name|struct
name|oce_eq
modifier|*
name|eq
parameter_list|)
block|{
name|struct
name|oce_mbx
name|mbx
decl_stmt|;
name|struct
name|mbx_create_common_eq
modifier|*
name|fwcmd
decl_stmt|;
name|POCE_SOFTC
name|sc
init|=
name|eq
operator|->
name|parent
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|uint32_t
name|num_pages
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|mbx
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|oce_mbx
argument_list|)
argument_list|)
expr_stmt|;
name|fwcmd
operator|=
operator|(
expr|struct
name|mbx_create_common_eq
operator|*
operator|)
operator|&
name|mbx
operator|.
name|payload
expr_stmt|;
name|mbx_common_req_hdr_init
argument_list|(
operator|&
name|fwcmd
operator|->
name|hdr
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|MBX_SUBSYSTEM_COMMON
argument_list|,
name|OPCODE_COMMON_CREATE_EQ
argument_list|,
name|MBX_TIMEOUT_SEC
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_create_common_eq
argument_list|)
argument_list|,
name|OCE_MBX_VER_V0
argument_list|)
expr_stmt|;
name|num_pages
operator|=
name|oce_page_list
argument_list|(
name|eq
operator|->
name|ring
argument_list|,
operator|&
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|pages
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|ctx
operator|.
name|num_pages
operator|=
name|num_pages
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|ctx
operator|.
name|valid
operator|=
literal|1
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|ctx
operator|.
name|size
operator|=
operator|(
name|eq
operator|->
name|eq_cfg
operator|.
name|item_size
operator|==
literal|4
operator|)
condition|?
literal|0
else|:
literal|1
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|ctx
operator|.
name|count
operator|=
name|OCE_LOG2
argument_list|(
name|eq
operator|->
name|eq_cfg
operator|.
name|q_len
operator|/
literal|256
argument_list|)
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|ctx
operator|.
name|armed
operator|=
literal|0
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|ctx
operator|.
name|delay_mult
operator|=
name|eq
operator|->
name|eq_cfg
operator|.
name|cur_eqd
expr_stmt|;
name|mbx
operator|.
name|u0
operator|.
name|s
operator|.
name|embedded
operator|=
literal|1
expr_stmt|;
name|mbx
operator|.
name|payload_length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_create_common_eq
argument_list|)
expr_stmt|;
name|rc
operator|=
name|oce_mbox_post
argument_list|(
name|sc
argument_list|,
operator|&
name|mbx
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rc
condition|)
name|rc
operator|=
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"%s failed - cmd status: %d addi status: %d\n"
argument_list|,
name|__FUNCTION__
argument_list|,
name|rc
argument_list|,
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|additional_status
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|eq
operator|->
name|eq_id
operator|=
name|HOST_16
argument_list|(
name|fwcmd
operator|->
name|params
operator|.
name|rsp
operator|.
name|eq_id
argument_list|)
expr_stmt|;
name|error
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
name|int
name|oce_mbox_cq_create
parameter_list|(
name|struct
name|oce_cq
modifier|*
name|cq
parameter_list|,
name|uint32_t
name|ncoalesce
parameter_list|,
name|uint32_t
name|is_eventable
parameter_list|)
block|{
name|struct
name|oce_mbx
name|mbx
decl_stmt|;
name|struct
name|mbx_create_common_cq
modifier|*
name|fwcmd
decl_stmt|;
name|POCE_SOFTC
name|sc
init|=
name|cq
operator|->
name|parent
decl_stmt|;
name|uint8_t
name|version
decl_stmt|;
name|oce_cq_ctx_t
modifier|*
name|ctx
decl_stmt|;
name|uint32_t
name|num_pages
decl_stmt|,
name|page_size
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|mbx
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|oce_mbx
argument_list|)
argument_list|)
expr_stmt|;
name|fwcmd
operator|=
operator|(
expr|struct
name|mbx_create_common_cq
operator|*
operator|)
operator|&
name|mbx
operator|.
name|payload
expr_stmt|;
if|if
condition|(
name|IS_XE201
argument_list|(
name|sc
argument_list|)
condition|)
name|version
operator|=
name|OCE_MBX_VER_V2
expr_stmt|;
else|else
name|version
operator|=
name|OCE_MBX_VER_V0
expr_stmt|;
name|mbx_common_req_hdr_init
argument_list|(
operator|&
name|fwcmd
operator|->
name|hdr
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|MBX_SUBSYSTEM_COMMON
argument_list|,
name|OPCODE_COMMON_CREATE_CQ
argument_list|,
name|MBX_TIMEOUT_SEC
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_create_common_cq
argument_list|)
argument_list|,
name|version
argument_list|)
expr_stmt|;
name|ctx
operator|=
operator|&
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|cq_ctx
expr_stmt|;
name|num_pages
operator|=
name|oce_page_list
argument_list|(
name|cq
operator|->
name|ring
argument_list|,
operator|&
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|pages
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|page_size
operator|=
literal|1
expr_stmt|;
comment|/* 1 for 4K */
if|if
condition|(
name|version
operator|==
name|OCE_MBX_VER_V2
condition|)
block|{
name|ctx
operator|->
name|v2
operator|.
name|num_pages
operator|=
name|LE_16
argument_list|(
name|num_pages
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|v2
operator|.
name|page_size
operator|=
name|page_size
expr_stmt|;
name|ctx
operator|->
name|v2
operator|.
name|eventable
operator|=
name|is_eventable
expr_stmt|;
name|ctx
operator|->
name|v2
operator|.
name|valid
operator|=
literal|1
expr_stmt|;
name|ctx
operator|->
name|v2
operator|.
name|count
operator|=
name|OCE_LOG2
argument_list|(
name|cq
operator|->
name|cq_cfg
operator|.
name|q_len
operator|/
literal|256
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|v2
operator|.
name|nodelay
operator|=
name|cq
operator|->
name|cq_cfg
operator|.
name|nodelay
expr_stmt|;
name|ctx
operator|->
name|v2
operator|.
name|coalesce_wm
operator|=
name|ncoalesce
expr_stmt|;
name|ctx
operator|->
name|v2
operator|.
name|armed
operator|=
literal|0
expr_stmt|;
name|ctx
operator|->
name|v2
operator|.
name|eq_id
operator|=
name|cq
operator|->
name|eq
operator|->
name|eq_id
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|v2
operator|.
name|count
operator|==
literal|3
condition|)
block|{
if|if
condition|(
name|cq
operator|->
name|cq_cfg
operator|.
name|q_len
operator|>
operator|(
literal|4
operator|*
literal|1024
operator|)
operator|-
literal|1
condition|)
name|ctx
operator|->
name|v2
operator|.
name|cqe_count
operator|=
operator|(
literal|4
operator|*
literal|1024
operator|)
operator|-
literal|1
expr_stmt|;
else|else
name|ctx
operator|->
name|v2
operator|.
name|cqe_count
operator|=
name|cq
operator|->
name|cq_cfg
operator|.
name|q_len
expr_stmt|;
block|}
block|}
else|else
block|{
name|ctx
operator|->
name|v0
operator|.
name|num_pages
operator|=
name|LE_16
argument_list|(
name|num_pages
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|v0
operator|.
name|eventable
operator|=
name|is_eventable
expr_stmt|;
name|ctx
operator|->
name|v0
operator|.
name|valid
operator|=
literal|1
expr_stmt|;
name|ctx
operator|->
name|v0
operator|.
name|count
operator|=
name|OCE_LOG2
argument_list|(
name|cq
operator|->
name|cq_cfg
operator|.
name|q_len
operator|/
literal|256
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|v0
operator|.
name|nodelay
operator|=
name|cq
operator|->
name|cq_cfg
operator|.
name|nodelay
expr_stmt|;
name|ctx
operator|->
name|v0
operator|.
name|coalesce_wm
operator|=
name|ncoalesce
expr_stmt|;
name|ctx
operator|->
name|v0
operator|.
name|armed
operator|=
literal|0
expr_stmt|;
name|ctx
operator|->
name|v0
operator|.
name|eq_id
operator|=
name|cq
operator|->
name|eq
operator|->
name|eq_id
expr_stmt|;
block|}
name|mbx
operator|.
name|u0
operator|.
name|s
operator|.
name|embedded
operator|=
literal|1
expr_stmt|;
name|mbx
operator|.
name|payload_length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_create_common_cq
argument_list|)
expr_stmt|;
name|rc
operator|=
name|oce_mbox_post
argument_list|(
name|sc
argument_list|,
operator|&
name|mbx
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rc
condition|)
name|rc
operator|=
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"%s failed - cmd status: %d addi status: %d\n"
argument_list|,
name|__FUNCTION__
argument_list|,
name|rc
argument_list|,
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|additional_status
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|cq
operator|->
name|cq_id
operator|=
name|HOST_16
argument_list|(
name|fwcmd
operator|->
name|params
operator|.
name|rsp
operator|.
name|cq_id
argument_list|)
expr_stmt|;
name|error
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
name|int
name|oce_mbox_read_transrecv_data
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
name|uint32_t
name|page_num
parameter_list|)
block|{
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|struct
name|oce_mbx
name|mbx
decl_stmt|;
name|struct
name|mbx_read_common_transrecv_data
modifier|*
name|fwcmd
decl_stmt|;
name|struct
name|oce_mq_sge
modifier|*
name|sgl
decl_stmt|;
name|OCE_DMA_MEM
name|dma
decl_stmt|;
comment|/* Allocate DMA mem*/
if|if
condition|(
name|oce_dma_alloc
argument_list|(
name|sc
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_read_common_transrecv_data
argument_list|)
argument_list|,
operator|&
name|dma
argument_list|,
literal|0
argument_list|)
condition|)
return|return
name|ENOMEM
return|;
name|fwcmd
operator|=
name|OCE_DMAPTR
argument_list|(
operator|&
name|dma
argument_list|,
expr|struct
name|mbx_read_common_transrecv_data
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|fwcmd
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_read_common_transrecv_data
argument_list|)
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|mbx
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|oce_mbx
argument_list|)
argument_list|)
expr_stmt|;
name|mbx_common_req_hdr_init
argument_list|(
operator|&
name|fwcmd
operator|->
name|hdr
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|MBX_SUBSYSTEM_COMMON
argument_list|,
name|OPCODE_COMMON_READ_TRANSRECEIVER_DATA
argument_list|,
name|MBX_TIMEOUT_SEC
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_read_common_transrecv_data
argument_list|)
argument_list|,
name|OCE_MBX_VER_V0
argument_list|)
expr_stmt|;
comment|/* fill rest of mbx */
name|mbx
operator|.
name|u0
operator|.
name|s
operator|.
name|embedded
operator|=
literal|0
expr_stmt|;
name|mbx
operator|.
name|payload_length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_read_common_transrecv_data
argument_list|)
expr_stmt|;
name|mbx
operator|.
name|u0
operator|.
name|s
operator|.
name|sge_count
operator|=
literal|1
expr_stmt|;
name|sgl
operator|=
operator|&
name|mbx
operator|.
name|payload
operator|.
name|u0
operator|.
name|u1
operator|.
name|sgl
index|[
literal|0
index|]
expr_stmt|;
name|sgl
operator|->
name|pa_hi
operator|=
name|htole32
argument_list|(
name|upper_32_bits
argument_list|(
name|dma
operator|.
name|paddr
argument_list|)
argument_list|)
expr_stmt|;
name|sgl
operator|->
name|pa_lo
operator|=
name|htole32
argument_list|(
operator|(
name|dma
operator|.
name|paddr
operator|)
operator|&
literal|0xFFFFFFFF
argument_list|)
expr_stmt|;
name|sgl
operator|->
name|length
operator|=
name|htole32
argument_list|(
name|mbx
operator|.
name|payload_length
argument_list|)
expr_stmt|;
name|DW_SWAP
argument_list|(
name|u32ptr
argument_list|(
operator|&
name|mbx
argument_list|)
argument_list|,
name|mbx
operator|.
name|payload_length
operator|+
name|OCE_BMBX_RHDR_SZ
argument_list|)
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|port
operator|=
name|LE_32
argument_list|(
name|sc
operator|->
name|port_id
argument_list|)
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|page_num
operator|=
name|LE_32
argument_list|(
name|page_num
argument_list|)
expr_stmt|;
comment|/* command post */
name|rc
operator|=
name|oce_mbox_post
argument_list|(
name|sc
argument_list|,
operator|&
name|mbx
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rc
condition|)
name|rc
operator|=
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"%s failed - cmd status: %d addi status: %d\n"
argument_list|,
name|__FUNCTION__
argument_list|,
name|rc
argument_list|,
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|additional_status
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
if|if
condition|(
name|fwcmd
operator|->
name|params
operator|.
name|rsp
operator|.
name|page_num
operator|==
name|PAGE_NUM_A0
condition|)
block|{
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|fwcmd
operator|->
name|params
operator|.
name|rsp
operator|.
name|page_data
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|sfp_vpd_dump_buffer
index|[
literal|0
index|]
argument_list|,
name|TRANSCEIVER_A0_SIZE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fwcmd
operator|->
name|params
operator|.
name|rsp
operator|.
name|page_num
operator|==
name|PAGE_NUM_A2
condition|)
block|{
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|fwcmd
operator|->
name|params
operator|.
name|rsp
operator|.
name|page_data
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|sfp_vpd_dump_buffer
index|[
literal|32
index|]
argument_list|,
name|TRANSCEIVER_A2_SIZE
argument_list|)
expr_stmt|;
block|}
name|error
label|:
name|oce_dma_free
argument_list|(
name|sc
argument_list|,
operator|&
name|dma
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
name|void
name|oce_mbox_eqd_modify_periodic
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
name|struct
name|oce_set_eqd
modifier|*
name|set_eqd
parameter_list|,
name|int
name|num
parameter_list|)
block|{
name|struct
name|oce_mbx
name|mbx
decl_stmt|;
name|struct
name|mbx_modify_common_eq_delay
modifier|*
name|fwcmd
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|mbx
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|oce_mbx
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Initialize MODIFY_EQ_DELAY ioctl header */
name|fwcmd
operator|=
operator|(
expr|struct
name|mbx_modify_common_eq_delay
operator|*
operator|)
operator|&
name|mbx
operator|.
name|payload
expr_stmt|;
name|mbx_common_req_hdr_init
argument_list|(
operator|&
name|fwcmd
operator|->
name|hdr
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|MBX_SUBSYSTEM_COMMON
argument_list|,
name|OPCODE_COMMON_MODIFY_EQ_DELAY
argument_list|,
name|MBX_TIMEOUT_SEC
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_modify_common_eq_delay
argument_list|)
argument_list|,
name|OCE_MBX_VER_V0
argument_list|)
expr_stmt|;
comment|/* fill rest of mbx */
name|mbx
operator|.
name|u0
operator|.
name|s
operator|.
name|embedded
operator|=
literal|1
expr_stmt|;
name|mbx
operator|.
name|payload_length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_modify_common_eq_delay
argument_list|)
expr_stmt|;
name|DW_SWAP
argument_list|(
name|u32ptr
argument_list|(
operator|&
name|mbx
argument_list|)
argument_list|,
name|mbx
operator|.
name|payload_length
operator|+
name|OCE_BMBX_RHDR_SZ
argument_list|)
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|num_eq
operator|=
name|num
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num
condition|;
name|i
operator|++
control|)
block|{
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|delay
index|[
name|i
index|]
operator|.
name|eq_id
operator|=
name|htole32
argument_list|(
name|set_eqd
index|[
name|i
index|]
operator|.
name|eq_id
argument_list|)
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|delay
index|[
name|i
index|]
operator|.
name|phase
operator|=
literal|0
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|delay
index|[
name|i
index|]
operator|.
name|dm
operator|=
name|htole32
argument_list|(
name|set_eqd
index|[
name|i
index|]
operator|.
name|delay_multiplier
argument_list|)
expr_stmt|;
block|}
comment|/* command post */
name|rc
operator|=
name|oce_mbox_post
argument_list|(
name|sc
argument_list|,
operator|&
name|mbx
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rc
condition|)
name|rc
operator|=
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|rc
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"%s failed - cmd status: %d addi status: %d\n"
argument_list|,
name|__FUNCTION__
argument_list|,
name|rc
argument_list|,
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|additional_status
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|oce_get_profile_config
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|)
block|{
name|struct
name|oce_mbx
name|mbx
decl_stmt|;
name|struct
name|mbx_common_get_profile_config
modifier|*
name|fwcmd
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|int
name|version
init|=
literal|0
decl_stmt|;
name|struct
name|oce_mq_sge
modifier|*
name|sgl
decl_stmt|;
name|OCE_DMA_MEM
name|dma
decl_stmt|;
name|uint32_t
name|desc_count
init|=
literal|0
decl_stmt|;
name|struct
name|oce_nic_resc_desc
modifier|*
name|nic_desc
init|=
name|NULL
decl_stmt|;
name|int
name|i
decl_stmt|;
name|boolean_t
name|nic_desc_valid
init|=
name|FALSE
decl_stmt|;
if|if
condition|(
name|IS_BE2
argument_list|(
name|sc
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
comment|/* Allocate DMA mem*/
if|if
condition|(
name|oce_dma_alloc
argument_list|(
name|sc
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_common_get_profile_config
argument_list|)
argument_list|,
operator|&
name|dma
argument_list|,
literal|0
argument_list|)
condition|)
return|return
name|ENOMEM
return|;
comment|/* Initialize MODIFY_EQ_DELAY ioctl header */
name|fwcmd
operator|=
name|OCE_DMAPTR
argument_list|(
operator|&
name|dma
argument_list|,
expr|struct
name|mbx_common_get_profile_config
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|fwcmd
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_common_get_profile_config
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_BE3
argument_list|(
name|sc
argument_list|)
condition|)
name|version
operator|=
name|OCE_MBX_VER_V1
expr_stmt|;
else|else
name|version
operator|=
name|OCE_MBX_VER_V0
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|mbx
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|oce_mbx
argument_list|)
argument_list|)
expr_stmt|;
name|mbx_common_req_hdr_init
argument_list|(
operator|&
name|fwcmd
operator|->
name|hdr
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|MBX_SUBSYSTEM_COMMON
argument_list|,
name|OPCODE_COMMON_GET_PROFILE_CONFIG
argument_list|,
name|MBX_TIMEOUT_SEC
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_common_get_profile_config
argument_list|)
argument_list|,
name|version
argument_list|)
expr_stmt|;
comment|/* fill rest of mbx */
name|mbx
operator|.
name|u0
operator|.
name|s
operator|.
name|embedded
operator|=
literal|0
expr_stmt|;
name|mbx
operator|.
name|payload_length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_common_get_profile_config
argument_list|)
expr_stmt|;
name|mbx
operator|.
name|u0
operator|.
name|s
operator|.
name|sge_count
operator|=
literal|1
expr_stmt|;
name|sgl
operator|=
operator|&
name|mbx
operator|.
name|payload
operator|.
name|u0
operator|.
name|u1
operator|.
name|sgl
index|[
literal|0
index|]
expr_stmt|;
name|sgl
operator|->
name|pa_hi
operator|=
name|htole32
argument_list|(
name|upper_32_bits
argument_list|(
name|dma
operator|.
name|paddr
argument_list|)
argument_list|)
expr_stmt|;
name|sgl
operator|->
name|pa_lo
operator|=
name|htole32
argument_list|(
operator|(
name|dma
operator|.
name|paddr
operator|)
operator|&
literal|0xFFFFFFFF
argument_list|)
expr_stmt|;
name|sgl
operator|->
name|length
operator|=
name|htole32
argument_list|(
name|mbx
operator|.
name|payload_length
argument_list|)
expr_stmt|;
name|DW_SWAP
argument_list|(
name|u32ptr
argument_list|(
operator|&
name|mbx
argument_list|)
argument_list|,
name|mbx
operator|.
name|payload_length
operator|+
name|OCE_BMBX_RHDR_SZ
argument_list|)
expr_stmt|;
name|fwcmd
operator|->
name|params
operator|.
name|req
operator|.
name|type
operator|=
name|ACTIVE_PROFILE
expr_stmt|;
comment|/* command post */
name|rc
operator|=
name|oce_mbox_post
argument_list|(
name|sc
argument_list|,
operator|&
name|mbx
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rc
condition|)
name|rc
operator|=
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"%s failed - cmd status: %d addi status: %d\n"
argument_list|,
name|__FUNCTION__
argument_list|,
name|rc
argument_list|,
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|additional_status
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|nic_desc
operator|=
operator|(
expr|struct
name|oce_nic_resc_desc
operator|*
operator|)
name|fwcmd
operator|->
name|params
operator|.
name|rsp
operator|.
name|resources
expr_stmt|;
name|desc_count
operator|=
name|HOST_32
argument_list|(
name|fwcmd
operator|->
name|params
operator|.
name|rsp
operator|.
name|desc_count
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|desc_count
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|nic_desc
operator|->
name|desc_type
operator|==
name|NIC_RESC_DESC_TYPE_V0
operator|)
operator|||
operator|(
name|nic_desc
operator|->
name|desc_type
operator|==
name|NIC_RESC_DESC_TYPE_V1
operator|)
condition|)
block|{
name|nic_desc_valid
operator|=
name|TRUE
expr_stmt|;
break|break;
block|}
name|nic_desc
operator|=
operator|(
expr|struct
name|oce_nic_resc_desc
operator|*
operator|)
expr|\
operator|(
operator|(
name|char
operator|*
operator|)
name|nic_desc
operator|+
name|nic_desc
operator|->
name|desc_len
operator|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|nic_desc_valid
condition|)
block|{
name|rc
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|error
goto|;
block|}
else|else
block|{
name|sc
operator|->
name|max_vlans
operator|=
name|nic_desc
operator|->
name|vlan_count
expr_stmt|;
name|sc
operator|->
name|nwqs
operator|=
name|HOST_32
argument_list|(
name|nic_desc
operator|->
name|txq_count
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|nwqs
condition|)
name|sc
operator|->
name|nwqs
operator|=
name|MIN
argument_list|(
name|sc
operator|->
name|nwqs
argument_list|,
name|OCE_MAX_WQ
argument_list|)
expr_stmt|;
else|else
name|sc
operator|->
name|nwqs
operator|=
name|OCE_MAX_WQ
expr_stmt|;
block|}
name|error
label|:
name|oce_dma_free
argument_list|(
name|sc
argument_list|,
operator|&
name|dma
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
name|int
name|oce_get_func_config
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|)
block|{
name|struct
name|oce_mbx
name|mbx
decl_stmt|;
name|struct
name|mbx_common_get_func_config
modifier|*
name|fwcmd
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|int
name|version
init|=
literal|0
decl_stmt|;
name|struct
name|oce_mq_sge
modifier|*
name|sgl
decl_stmt|;
name|OCE_DMA_MEM
name|dma
decl_stmt|;
name|uint32_t
name|desc_count
init|=
literal|0
decl_stmt|;
name|struct
name|oce_nic_resc_desc
modifier|*
name|nic_desc
init|=
name|NULL
decl_stmt|;
name|int
name|i
decl_stmt|;
name|boolean_t
name|nic_desc_valid
init|=
name|FALSE
decl_stmt|;
name|uint32_t
name|max_rss
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|(
name|IS_BE
argument_list|(
name|sc
argument_list|)
operator|||
name|IS_SH
argument_list|(
name|sc
argument_list|)
operator|)
operator|&&
operator|(
operator|!
name|sc
operator|->
name|be3_native
operator|)
condition|)
name|max_rss
operator|=
name|OCE_LEGACY_MODE_RSS
expr_stmt|;
else|else
name|max_rss
operator|=
name|OCE_MAX_RSS
expr_stmt|;
comment|/* Allocate DMA mem*/
if|if
condition|(
name|oce_dma_alloc
argument_list|(
name|sc
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_common_get_func_config
argument_list|)
argument_list|,
operator|&
name|dma
argument_list|,
literal|0
argument_list|)
condition|)
return|return
name|ENOMEM
return|;
comment|/* Initialize MODIFY_EQ_DELAY ioctl header */
name|fwcmd
operator|=
name|OCE_DMAPTR
argument_list|(
operator|&
name|dma
argument_list|,
expr|struct
name|mbx_common_get_func_config
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|fwcmd
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_common_get_func_config
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_SH
argument_list|(
name|sc
argument_list|)
condition|)
name|version
operator|=
name|OCE_MBX_VER_V1
expr_stmt|;
else|else
name|version
operator|=
name|OCE_MBX_VER_V0
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|mbx
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|oce_mbx
argument_list|)
argument_list|)
expr_stmt|;
name|mbx_common_req_hdr_init
argument_list|(
operator|&
name|fwcmd
operator|->
name|hdr
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|MBX_SUBSYSTEM_COMMON
argument_list|,
name|OPCODE_COMMON_GET_FUNCTION_CONFIG
argument_list|,
name|MBX_TIMEOUT_SEC
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_common_get_func_config
argument_list|)
argument_list|,
name|version
argument_list|)
expr_stmt|;
comment|/* fill rest of mbx */
name|mbx
operator|.
name|u0
operator|.
name|s
operator|.
name|embedded
operator|=
literal|0
expr_stmt|;
name|mbx
operator|.
name|payload_length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_common_get_func_config
argument_list|)
expr_stmt|;
name|mbx
operator|.
name|u0
operator|.
name|s
operator|.
name|sge_count
operator|=
literal|1
expr_stmt|;
name|sgl
operator|=
operator|&
name|mbx
operator|.
name|payload
operator|.
name|u0
operator|.
name|u1
operator|.
name|sgl
index|[
literal|0
index|]
expr_stmt|;
name|sgl
operator|->
name|pa_hi
operator|=
name|htole32
argument_list|(
name|upper_32_bits
argument_list|(
name|dma
operator|.
name|paddr
argument_list|)
argument_list|)
expr_stmt|;
name|sgl
operator|->
name|pa_lo
operator|=
name|htole32
argument_list|(
operator|(
name|dma
operator|.
name|paddr
operator|)
operator|&
literal|0xFFFFFFFF
argument_list|)
expr_stmt|;
name|sgl
operator|->
name|length
operator|=
name|htole32
argument_list|(
name|mbx
operator|.
name|payload_length
argument_list|)
expr_stmt|;
name|DW_SWAP
argument_list|(
name|u32ptr
argument_list|(
operator|&
name|mbx
argument_list|)
argument_list|,
name|mbx
operator|.
name|payload_length
operator|+
name|OCE_BMBX_RHDR_SZ
argument_list|)
expr_stmt|;
comment|/* command post */
name|rc
operator|=
name|oce_mbox_post
argument_list|(
name|sc
argument_list|,
operator|&
name|mbx
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rc
condition|)
name|rc
operator|=
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"%s failed - cmd status: %d addi status: %d\n"
argument_list|,
name|__FUNCTION__
argument_list|,
name|rc
argument_list|,
name|fwcmd
operator|->
name|hdr
operator|.
name|u0
operator|.
name|rsp
operator|.
name|additional_status
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|nic_desc
operator|=
operator|(
expr|struct
name|oce_nic_resc_desc
operator|*
operator|)
name|fwcmd
operator|->
name|params
operator|.
name|rsp
operator|.
name|resources
expr_stmt|;
name|desc_count
operator|=
name|HOST_32
argument_list|(
name|fwcmd
operator|->
name|params
operator|.
name|rsp
operator|.
name|desc_count
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|desc_count
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|nic_desc
operator|->
name|desc_type
operator|==
name|NIC_RESC_DESC_TYPE_V0
operator|)
operator|||
operator|(
name|nic_desc
operator|->
name|desc_type
operator|==
name|NIC_RESC_DESC_TYPE_V1
operator|)
condition|)
block|{
name|nic_desc_valid
operator|=
name|TRUE
expr_stmt|;
break|break;
block|}
name|nic_desc
operator|=
operator|(
expr|struct
name|oce_nic_resc_desc
operator|*
operator|)
expr|\
operator|(
operator|(
name|char
operator|*
operator|)
name|nic_desc
operator|+
name|nic_desc
operator|->
name|desc_len
operator|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|nic_desc_valid
condition|)
block|{
name|rc
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|error
goto|;
block|}
else|else
block|{
name|sc
operator|->
name|max_vlans
operator|=
name|nic_desc
operator|->
name|vlan_count
expr_stmt|;
name|sc
operator|->
name|nwqs
operator|=
name|HOST_32
argument_list|(
name|nic_desc
operator|->
name|txq_count
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|nwqs
condition|)
name|sc
operator|->
name|nwqs
operator|=
name|MIN
argument_list|(
name|sc
operator|->
name|nwqs
argument_list|,
name|OCE_MAX_WQ
argument_list|)
expr_stmt|;
else|else
name|sc
operator|->
name|nwqs
operator|=
name|OCE_MAX_WQ
expr_stmt|;
name|sc
operator|->
name|nrssqs
operator|=
name|HOST_32
argument_list|(
name|nic_desc
operator|->
name|rssq_count
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|nrssqs
condition|)
name|sc
operator|->
name|nrssqs
operator|=
name|MIN
argument_list|(
name|sc
operator|->
name|nrssqs
argument_list|,
name|max_rss
argument_list|)
expr_stmt|;
else|else
name|sc
operator|->
name|nrssqs
operator|=
name|max_rss
expr_stmt|;
name|sc
operator|->
name|nrqs
operator|=
name|sc
operator|->
name|nrssqs
operator|+
literal|1
expr_stmt|;
comment|/* 1 for def RX */
empty_stmt|;
block|}
name|error
label|:
name|oce_dma_free
argument_list|(
name|sc
argument_list|,
operator|&
name|dma
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

end_unit


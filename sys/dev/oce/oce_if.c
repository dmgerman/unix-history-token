begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (C) 2013 Emulex  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions are met:  *  * 1. Redistributions of source code must retain the above copyright notice,  *    this list of conditions and the following disclaimer.  *  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * 3. Neither the name of the Emulex Corporation nor the names of its  *    contributors may be used to endorse or promote products derived from  *    this software without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE  * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE  * POSSIBILITY OF SUCH DAMAGE.  *  * Contact Information:  * freebsd-drivers@emulex.com  *  * Emulex  * 3333 Susan Street  * Costa Mesa, CA 92626  */
end_comment

begin_comment
comment|/* $FreeBSD$ */
end_comment

begin_include
include|#
directive|include
file|"opt_inet6.h"
end_include

begin_include
include|#
directive|include
file|"opt_inet.h"
end_include

begin_include
include|#
directive|include
file|"oce_if.h"
end_include

begin_include
include|#
directive|include
file|"oce_user.h"
end_include

begin_define
define|#
directive|define
name|is_tso_pkt
parameter_list|(
name|m
parameter_list|)
value|(m->m_pkthdr.csum_flags& CSUM_TSO)
end_define

begin_comment
comment|/* UE Status Low CSR */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|ue_status_low_desc
index|[]
init|=
block|{
literal|"CEV"
block|,
literal|"CTX"
block|,
literal|"DBUF"
block|,
literal|"ERX"
block|,
literal|"Host"
block|,
literal|"MPU"
block|,
literal|"NDMA"
block|,
literal|"PTC "
block|,
literal|"RDMA "
block|,
literal|"RXF "
block|,
literal|"RXIPS "
block|,
literal|"RXULP0 "
block|,
literal|"RXULP1 "
block|,
literal|"RXULP2 "
block|,
literal|"TIM "
block|,
literal|"TPOST "
block|,
literal|"TPRE "
block|,
literal|"TXIPS "
block|,
literal|"TXULP0 "
block|,
literal|"TXULP1 "
block|,
literal|"UC "
block|,
literal|"WDMA "
block|,
literal|"TXULP2 "
block|,
literal|"HOST1 "
block|,
literal|"P0_OB_LINK "
block|,
literal|"P1_OB_LINK "
block|,
literal|"HOST_GPIO "
block|,
literal|"MBOX "
block|,
literal|"AXGMAC0"
block|,
literal|"AXGMAC1"
block|,
literal|"JTAG"
block|,
literal|"MPU_INTPEND"
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* UE Status High CSR */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|ue_status_hi_desc
index|[]
init|=
block|{
literal|"LPCMEMHOST"
block|,
literal|"MGMT_MAC"
block|,
literal|"PCS0ONLINE"
block|,
literal|"MPU_IRAM"
block|,
literal|"PCS1ONLINE"
block|,
literal|"PCTL0"
block|,
literal|"PCTL1"
block|,
literal|"PMEM"
block|,
literal|"RR"
block|,
literal|"TXPB"
block|,
literal|"RXPP"
block|,
literal|"XAUI"
block|,
literal|"TXP"
block|,
literal|"ARM"
block|,
literal|"IPC"
block|,
literal|"HOST2"
block|,
literal|"HOST3"
block|,
literal|"HOST4"
block|,
literal|"HOST5"
block|,
literal|"HOST6"
block|,
literal|"HOST7"
block|,
literal|"HOST8"
block|,
literal|"HOST9"
block|,
literal|"NETC"
block|,
literal|"Unknown"
block|,
literal|"Unknown"
block|,
literal|"Unknown"
block|,
literal|"Unknown"
block|,
literal|"Unknown"
block|,
literal|"Unknown"
block|,
literal|"Unknown"
block|,
literal|"Unknown"
block|}
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|oce_common_cqe_info
block|{
name|uint8_t
name|vtp
range|:
literal|1
decl_stmt|;
name|uint8_t
name|l4_cksum_pass
range|:
literal|1
decl_stmt|;
name|uint8_t
name|ip_cksum_pass
range|:
literal|1
decl_stmt|;
name|uint8_t
name|ipv6_frame
range|:
literal|1
decl_stmt|;
name|uint8_t
name|qnq
range|:
literal|1
decl_stmt|;
name|uint8_t
name|rsvd
range|:
literal|3
decl_stmt|;
name|uint8_t
name|num_frags
decl_stmt|;
name|uint16_t
name|pkt_size
decl_stmt|;
name|uint16_t
name|vtag
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* Driver entry points prototypes */
end_comment

begin_function_decl
specifier|static
name|int
name|oce_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|oce_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|oce_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|oce_shutdown
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|oce_ioctl
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|u_long
name|command
parameter_list|,
name|caddr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|oce_init
parameter_list|(
name|void
modifier|*
name|xsc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|oce_multiq_start
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|oce_multiq_flush
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* Driver interrupt routines protypes */
end_comment

begin_function_decl
specifier|static
name|void
name|oce_intr
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|int
name|pending
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|oce_setup_intr
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|oce_fast_isr
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|oce_alloc_intr
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
name|int
name|vector
parameter_list|,
name|void
function_decl|(
modifier|*
name|isr
function_decl|)
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|int
name|pending
parameter_list|)
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* Media callbacks prototypes */
end_comment

begin_function_decl
specifier|static
name|void
name|oce_media_status
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|ifmediareq
modifier|*
name|req
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|oce_media_change
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* Transmit routines prototypes */
end_comment

begin_function_decl
specifier|static
name|int
name|oce_tx
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|mpp
parameter_list|,
name|int
name|wq_index
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|oce_tx_restart
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
name|struct
name|oce_wq
modifier|*
name|wq
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|oce_process_tx_completion
parameter_list|(
name|struct
name|oce_wq
modifier|*
name|wq
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|oce_multiq_transmit
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|struct
name|oce_wq
modifier|*
name|wq
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* Receive routines prototypes */
end_comment

begin_function_decl
specifier|static
name|int
name|oce_cqe_vtp_valid
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
name|struct
name|oce_nic_rx_cqe
modifier|*
name|cqe
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|oce_cqe_portid_valid
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
name|struct
name|oce_nic_rx_cqe
modifier|*
name|cqe
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|oce_rx
parameter_list|(
name|struct
name|oce_rq
modifier|*
name|rq
parameter_list|,
name|struct
name|oce_nic_rx_cqe
modifier|*
name|cqe
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|oce_check_rx_bufs
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
name|uint32_t
name|num_cqes
parameter_list|,
name|struct
name|oce_rq
modifier|*
name|rq
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
name|oce_rq_handler_lro
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|oce_correct_header
parameter_list|(
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|struct
name|nic_hwlro_cqe_part1
modifier|*
name|cqe1
parameter_list|,
name|struct
name|nic_hwlro_cqe_part2
modifier|*
name|cqe2
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|oce_rx_lro
parameter_list|(
name|struct
name|oce_rq
modifier|*
name|rq
parameter_list|,
name|struct
name|nic_hwlro_singleton_cqe
modifier|*
name|cqe
parameter_list|,
name|struct
name|nic_hwlro_cqe_part2
modifier|*
name|cqe2
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|oce_rx_mbuf_chain
parameter_list|(
name|struct
name|oce_rq
modifier|*
name|rq
parameter_list|,
name|struct
name|oce_common_cqe_info
modifier|*
name|cqe_info
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|m
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* Helper function prototypes in this file */
end_comment

begin_function_decl
specifier|static
name|int
name|oce_attach_ifp
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|oce_add_vlan
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|uint16_t
name|vtag
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|oce_del_vlan
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|uint16_t
name|vtag
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|oce_vid_config
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|oce_mac_addr_set
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|oce_handle_passthrough
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|caddr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|oce_local_timer
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|oce_if_deactivate
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|oce_if_activate
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|setup_max_queues_want
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|update_queues_got
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|process_link_state
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
name|struct
name|oce_async_cqe_link_state
modifier|*
name|acqe
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|oce_tx_asic_stall_verify
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|oce_get_config
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|mbuf
modifier|*
name|oce_insert_vlan_tag
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|boolean_t
modifier|*
name|complete
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|oce_read_env_variables
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* IP specific */
end_comment

begin_if
if|#
directive|if
name|defined
argument_list|(
name|INET6
argument_list|)
operator|||
name|defined
argument_list|(
name|INET
argument_list|)
end_if

begin_function_decl
specifier|static
name|int
name|oce_init_lro
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|mbuf
modifier|*
name|oce_tso_setup
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|mpp
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|static
name|device_method_t
name|oce_dispatch
index|[]
init|=
block|{
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|oce_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|oce_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|oce_detach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_shutdown
argument_list|,
name|oce_shutdown
argument_list|)
block|,
name|DEVMETHOD_END
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|oce_driver
init|=
block|{
literal|"oce"
block|,
name|oce_dispatch
block|,
expr|sizeof
operator|(
name|OCE_SOFTC
operator|)
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|oce_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|oce
argument_list|,
name|pci
argument_list|,
name|oce_driver
argument_list|,
name|oce_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|oce
argument_list|,
name|pci
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|oce
argument_list|,
name|ether
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_VERSION
argument_list|(
name|oce
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* global vars */
end_comment

begin_decl_stmt
specifier|const
name|char
name|component_revision
index|[
literal|32
index|]
init|=
block|{
literal|"///"
name|COMPONENT_REVISION
literal|"///"
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Module capabilites and parameters */
end_comment

begin_decl_stmt
name|uint32_t
name|oce_max_rsp_handled
init|=
name|OCE_MAX_RSP_HANDLED
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|uint32_t
name|oce_enable_rss
init|=
name|OCE_MODCAP_RSS
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|uint32_t
name|oce_rq_buf_size
init|=
literal|2048
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"hw.oce.max_rsp_handled"
argument_list|,
operator|&
name|oce_max_rsp_handled
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"hw.oce.enable_rss"
argument_list|,
operator|&
name|oce_enable_rss
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* Supported devices table */
end_comment

begin_decl_stmt
specifier|static
name|uint32_t
name|supportedDevices
index|[]
init|=
block|{
operator|(
name|PCI_VENDOR_SERVERENGINES
operator|<<
literal|16
operator|)
operator||
name|PCI_PRODUCT_BE2
block|,
operator|(
name|PCI_VENDOR_SERVERENGINES
operator|<<
literal|16
operator|)
operator||
name|PCI_PRODUCT_BE3
block|,
operator|(
name|PCI_VENDOR_EMULEX
operator|<<
literal|16
operator|)
operator||
name|PCI_PRODUCT_BE3
block|,
operator|(
name|PCI_VENDOR_EMULEX
operator|<<
literal|16
operator|)
operator||
name|PCI_PRODUCT_XE201
block|,
operator|(
name|PCI_VENDOR_EMULEX
operator|<<
literal|16
operator|)
operator||
name|PCI_PRODUCT_XE201_VF
block|,
operator|(
name|PCI_VENDOR_EMULEX
operator|<<
literal|16
operator|)
operator||
name|PCI_PRODUCT_SH
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|POCE_SOFTC
name|softc_head
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|POCE_SOFTC
name|softc_tail
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|oce_rdma_if
modifier|*
name|oce_rdma_if
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*****************************************************************************  *			Driver entry points functions                        *  *****************************************************************************/
end_comment

begin_function
specifier|static
name|int
name|oce_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|uint16_t
name|vendor
init|=
literal|0
decl_stmt|;
name|uint16_t
name|device
init|=
literal|0
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
name|char
name|str
index|[
literal|256
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
name|POCE_SOFTC
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|sc
argument_list|,
sizeof|sizeof
argument_list|(
name|OCE_SOFTC
argument_list|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|dev
operator|=
name|dev
expr_stmt|;
name|vendor
operator|=
name|pci_get_vendor
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|device
operator|=
name|pci_get_device
argument_list|(
name|dev
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
sizeof|sizeof
argument_list|(
name|supportedDevices
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|vendor
operator|==
operator|(
operator|(
name|supportedDevices
index|[
name|i
index|]
operator|>>
literal|16
operator|)
operator|&
literal|0xffff
operator|)
condition|)
block|{
if|if
condition|(
name|device
operator|==
operator|(
name|supportedDevices
index|[
name|i
index|]
operator|&
literal|0xffff
operator|)
condition|)
block|{
name|sprintf
argument_list|(
name|str
argument_list|,
literal|"%s:%s"
argument_list|,
literal|"Emulex CNA NIC function"
argument_list|,
name|component_revision
argument_list|)
expr_stmt|;
name|device_set_desc_copy
argument_list|(
name|dev
argument_list|,
name|str
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|device
condition|)
block|{
case|case
name|PCI_PRODUCT_BE2
case|:
name|sc
operator|->
name|flags
operator||=
name|OCE_FLAGS_BE2
expr_stmt|;
break|break;
case|case
name|PCI_PRODUCT_BE3
case|:
name|sc
operator|->
name|flags
operator||=
name|OCE_FLAGS_BE3
expr_stmt|;
break|break;
case|case
name|PCI_PRODUCT_XE201
case|:
case|case
name|PCI_PRODUCT_XE201_VF
case|:
name|sc
operator|->
name|flags
operator||=
name|OCE_FLAGS_XE201
expr_stmt|;
break|break;
case|case
name|PCI_PRODUCT_SH
case|:
name|sc
operator|->
name|flags
operator||=
name|OCE_FLAGS_SH
expr_stmt|;
break|break;
default|default:
return|return
name|ENXIO
return|;
block|}
return|return
name|BUS_PROBE_DEFAULT
return|;
block|}
block|}
block|}
return|return
name|ENXIO
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|oce_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|POCE_SOFTC
name|sc
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|rc
operator|=
name|oce_hw_pci_alloc
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
return|return
name|rc
return|;
name|sc
operator|->
name|tx_ring_size
operator|=
name|OCE_TX_RING_SIZE
expr_stmt|;
name|sc
operator|->
name|rx_ring_size
operator|=
name|OCE_RX_RING_SIZE
expr_stmt|;
comment|/* receive fragment size should be multiple of 2K */
name|sc
operator|->
name|rq_frag_size
operator|=
operator|(
operator|(
name|oce_rq_buf_size
operator|/
literal|2048
operator|)
operator|*
literal|2048
operator|)
expr_stmt|;
name|sc
operator|->
name|flow_control
operator|=
name|OCE_DEFAULT_FLOW_CONTROL
expr_stmt|;
name|sc
operator|->
name|promisc
operator|=
name|OCE_DEFAULT_PROMISCUOUS
expr_stmt|;
name|LOCK_CREATE
argument_list|(
operator|&
name|sc
operator|->
name|bmbx_lock
argument_list|,
literal|"Mailbox_lock"
argument_list|)
expr_stmt|;
name|LOCK_CREATE
argument_list|(
operator|&
name|sc
operator|->
name|dev_lock
argument_list|,
literal|"Device_lock"
argument_list|)
expr_stmt|;
comment|/* initialise the hardware */
name|rc
operator|=
name|oce_hw_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|pci_res_free
goto|;
name|oce_read_env_variables
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|oce_get_config
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|setup_max_queues_want
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|rc
operator|=
name|oce_setup_intr
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|mbox_free
goto|;
name|rc
operator|=
name|oce_queue_init_all
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|intr_free
goto|;
name|rc
operator|=
name|oce_attach_ifp
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|queues_free
goto|;
if|#
directive|if
name|defined
argument_list|(
name|INET6
argument_list|)
operator|||
name|defined
argument_list|(
name|INET
argument_list|)
name|rc
operator|=
name|oce_init_lro
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|ifp_free
goto|;
endif|#
directive|endif
name|rc
operator|=
name|oce_hw_start
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|lro_free
goto|;
name|sc
operator|->
name|vlan_attach
operator|=
name|EVENTHANDLER_REGISTER
argument_list|(
name|vlan_config
argument_list|,
name|oce_add_vlan
argument_list|,
name|sc
argument_list|,
name|EVENTHANDLER_PRI_FIRST
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vlan_detach
operator|=
name|EVENTHANDLER_REGISTER
argument_list|(
name|vlan_unconfig
argument_list|,
name|oce_del_vlan
argument_list|,
name|sc
argument_list|,
name|EVENTHANDLER_PRI_FIRST
argument_list|)
expr_stmt|;
name|rc
operator|=
name|oce_stats_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|vlan_free
goto|;
name|oce_add_sysctls
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|callout_init
argument_list|(
operator|&
name|sc
operator|->
name|timer
argument_list|,
name|CALLOUT_MPSAFE
argument_list|)
expr_stmt|;
name|rc
operator|=
name|callout_reset
argument_list|(
operator|&
name|sc
operator|->
name|timer
argument_list|,
literal|2
operator|*
name|hz
argument_list|,
name|oce_local_timer
argument_list|,
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|stats_free
goto|;
name|sc
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|softc_tail
operator|!=
name|NULL
condition|)
block|{
name|softc_tail
operator|->
name|next
operator|=
name|sc
expr_stmt|;
block|}
else|else
block|{
name|softc_head
operator|=
name|sc
expr_stmt|;
block|}
name|softc_tail
operator|=
name|sc
expr_stmt|;
return|return
literal|0
return|;
name|stats_free
label|:
name|callout_drain
argument_list|(
operator|&
name|sc
operator|->
name|timer
argument_list|)
expr_stmt|;
name|oce_stats_free
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|vlan_free
label|:
if|if
condition|(
name|sc
operator|->
name|vlan_attach
condition|)
name|EVENTHANDLER_DEREGISTER
argument_list|(
name|vlan_config
argument_list|,
name|sc
operator|->
name|vlan_attach
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|vlan_detach
condition|)
name|EVENTHANDLER_DEREGISTER
argument_list|(
name|vlan_unconfig
argument_list|,
name|sc
operator|->
name|vlan_detach
argument_list|)
expr_stmt|;
name|oce_hw_intr_disable
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|lro_free
label|:
if|#
directive|if
name|defined
argument_list|(
name|INET6
argument_list|)
operator|||
name|defined
argument_list|(
name|INET
argument_list|)
name|oce_free_lro
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ifp_free
label|:
endif|#
directive|endif
name|ether_ifdetach
argument_list|(
name|sc
operator|->
name|ifp
argument_list|)
expr_stmt|;
name|if_free
argument_list|(
name|sc
operator|->
name|ifp
argument_list|)
expr_stmt|;
name|queues_free
label|:
name|oce_queue_release_all
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|intr_free
label|:
name|oce_intr_free
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|mbox_free
label|:
name|oce_dma_free
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|bsmbx
argument_list|)
expr_stmt|;
name|pci_res_free
label|:
name|oce_hw_pci_free
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|LOCK_DESTROY
argument_list|(
operator|&
name|sc
operator|->
name|dev_lock
argument_list|)
expr_stmt|;
name|LOCK_DESTROY
argument_list|(
operator|&
name|sc
operator|->
name|bmbx_lock
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|oce_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|POCE_SOFTC
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|POCE_SOFTC
name|poce_sc_tmp
decl_stmt|,
modifier|*
name|ppoce_sc_tmp1
decl_stmt|,
name|poce_sc_tmp2
init|=
name|NULL
decl_stmt|;
name|poce_sc_tmp
operator|=
name|softc_head
expr_stmt|;
name|ppoce_sc_tmp1
operator|=
operator|&
name|softc_head
expr_stmt|;
while|while
condition|(
name|poce_sc_tmp
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|poce_sc_tmp
operator|==
name|sc
condition|)
block|{
operator|*
name|ppoce_sc_tmp1
operator|=
name|sc
operator|->
name|next
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|next
operator|==
name|NULL
condition|)
block|{
name|softc_tail
operator|=
name|poce_sc_tmp2
expr_stmt|;
block|}
break|break;
block|}
name|poce_sc_tmp2
operator|=
name|poce_sc_tmp
expr_stmt|;
name|ppoce_sc_tmp1
operator|=
operator|&
name|poce_sc_tmp
operator|->
name|next
expr_stmt|;
name|poce_sc_tmp
operator|=
name|poce_sc_tmp
operator|->
name|next
expr_stmt|;
block|}
name|LOCK
argument_list|(
operator|&
name|sc
operator|->
name|dev_lock
argument_list|)
expr_stmt|;
name|oce_if_deactivate
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|sc
operator|->
name|dev_lock
argument_list|)
expr_stmt|;
name|callout_drain
argument_list|(
operator|&
name|sc
operator|->
name|timer
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|vlan_attach
operator|!=
name|NULL
condition|)
name|EVENTHANDLER_DEREGISTER
argument_list|(
name|vlan_config
argument_list|,
name|sc
operator|->
name|vlan_attach
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|vlan_detach
operator|!=
name|NULL
condition|)
name|EVENTHANDLER_DEREGISTER
argument_list|(
name|vlan_unconfig
argument_list|,
name|sc
operator|->
name|vlan_detach
argument_list|)
expr_stmt|;
name|ether_ifdetach
argument_list|(
name|sc
operator|->
name|ifp
argument_list|)
expr_stmt|;
name|if_free
argument_list|(
name|sc
operator|->
name|ifp
argument_list|)
expr_stmt|;
name|oce_hw_shutdown
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|bus_generic_detach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|oce_shutdown
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|int
name|rc
decl_stmt|;
name|rc
operator|=
name|oce_detach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|oce_ioctl
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|u_long
name|command
parameter_list|,
name|caddr_t
name|data
parameter_list|)
block|{
name|struct
name|ifreq
modifier|*
name|ifr
init|=
operator|(
expr|struct
name|ifreq
operator|*
operator|)
name|data
decl_stmt|;
name|POCE_SOFTC
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|uint32_t
name|u
decl_stmt|;
switch|switch
condition|(
name|command
condition|)
block|{
case|case
name|SIOCGIFMEDIA
case|:
name|rc
operator|=
name|ifmedia_ioctl
argument_list|(
name|ifp
argument_list|,
name|ifr
argument_list|,
operator|&
name|sc
operator|->
name|media
argument_list|,
name|command
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCSIFMTU
case|:
if|if
condition|(
name|ifr
operator|->
name|ifr_mtu
operator|>
name|OCE_MAX_MTU
condition|)
name|rc
operator|=
name|EINVAL
expr_stmt|;
else|else
name|ifp
operator|->
name|if_mtu
operator|=
name|ifr
operator|->
name|ifr_mtu
expr_stmt|;
break|break;
case|case
name|SIOCSIFFLAGS
case|:
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_UP
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
condition|)
block|{
name|sc
operator|->
name|ifp
operator|->
name|if_drv_flags
operator||=
name|IFF_DRV_RUNNING
expr_stmt|;
name|oce_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Interface Up\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|LOCK
argument_list|(
operator|&
name|sc
operator|->
name|dev_lock
argument_list|)
expr_stmt|;
name|sc
operator|->
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
operator|(
name|IFF_DRV_RUNNING
operator||
name|IFF_DRV_OACTIVE
operator|)
expr_stmt|;
name|oce_if_deactivate
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|sc
operator|->
name|dev_lock
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Interface Down\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_PROMISC
operator|)
operator|&&
operator|!
name|sc
operator|->
name|promisc
condition|)
block|{
if|if
condition|(
operator|!
name|oce_rxf_set_promiscuous
argument_list|(
name|sc
argument_list|,
operator|(
literal|1
operator||
operator|(
literal|1
operator|<<
literal|1
operator|)
operator|)
argument_list|)
condition|)
name|sc
operator|->
name|promisc
operator|=
name|TRUE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
operator|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_PROMISC
operator|)
operator|&&
name|sc
operator|->
name|promisc
condition|)
block|{
if|if
condition|(
operator|!
name|oce_rxf_set_promiscuous
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
condition|)
name|sc
operator|->
name|promisc
operator|=
name|FALSE
expr_stmt|;
block|}
break|break;
case|case
name|SIOCADDMULTI
case|:
case|case
name|SIOCDELMULTI
case|:
name|rc
operator|=
name|oce_hw_update_multicast
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Update multicast address failed\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCSIFCAP
case|:
name|u
operator|=
name|ifr
operator|->
name|ifr_reqcap
operator|^
name|ifp
operator|->
name|if_capenable
expr_stmt|;
if|if
condition|(
name|u
operator|&
name|IFCAP_TXCSUM
condition|)
block|{
name|ifp
operator|->
name|if_capenable
operator|^=
name|IFCAP_TXCSUM
expr_stmt|;
name|ifp
operator|->
name|if_hwassist
operator|^=
operator|(
name|CSUM_TCP
operator||
name|CSUM_UDP
operator||
name|CSUM_IP
operator|)
expr_stmt|;
if|if
condition|(
name|IFCAP_TSO
operator|&
name|ifp
operator|->
name|if_capenable
operator|&&
operator|!
operator|(
name|IFCAP_TXCSUM
operator|&
name|ifp
operator|->
name|if_capenable
operator|)
condition|)
block|{
name|ifp
operator|->
name|if_capenable
operator|&=
operator|~
name|IFCAP_TSO
expr_stmt|;
name|ifp
operator|->
name|if_hwassist
operator|&=
operator|~
name|CSUM_TSO
expr_stmt|;
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"TSO disabled due to -txcsum.\n"
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|u
operator|&
name|IFCAP_RXCSUM
condition|)
name|ifp
operator|->
name|if_capenable
operator|^=
name|IFCAP_RXCSUM
expr_stmt|;
if|if
condition|(
name|u
operator|&
name|IFCAP_TSO4
condition|)
block|{
name|ifp
operator|->
name|if_capenable
operator|^=
name|IFCAP_TSO4
expr_stmt|;
if|if
condition|(
name|IFCAP_TSO
operator|&
name|ifp
operator|->
name|if_capenable
condition|)
block|{
if|if
condition|(
name|IFCAP_TXCSUM
operator|&
name|ifp
operator|->
name|if_capenable
condition|)
name|ifp
operator|->
name|if_hwassist
operator||=
name|CSUM_TSO
expr_stmt|;
else|else
block|{
name|ifp
operator|->
name|if_capenable
operator|&=
operator|~
name|IFCAP_TSO
expr_stmt|;
name|ifp
operator|->
name|if_hwassist
operator|&=
operator|~
name|CSUM_TSO
expr_stmt|;
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"Enable txcsum first.\n"
argument_list|)
expr_stmt|;
name|rc
operator|=
name|EAGAIN
expr_stmt|;
block|}
block|}
else|else
name|ifp
operator|->
name|if_hwassist
operator|&=
operator|~
name|CSUM_TSO
expr_stmt|;
block|}
if|if
condition|(
name|u
operator|&
name|IFCAP_VLAN_HWTAGGING
condition|)
name|ifp
operator|->
name|if_capenable
operator|^=
name|IFCAP_VLAN_HWTAGGING
expr_stmt|;
if|if
condition|(
name|u
operator|&
name|IFCAP_VLAN_HWFILTER
condition|)
block|{
name|ifp
operator|->
name|if_capenable
operator|^=
name|IFCAP_VLAN_HWFILTER
expr_stmt|;
name|oce_vid_config
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
if|#
directive|if
name|defined
argument_list|(
name|INET6
argument_list|)
operator|||
name|defined
argument_list|(
name|INET
argument_list|)
if|if
condition|(
name|u
operator|&
name|IFCAP_LRO
condition|)
block|{
name|ifp
operator|->
name|if_capenable
operator|^=
name|IFCAP_LRO
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|enable_hwlro
condition|)
block|{
if|if
condition|(
name|ifp
operator|->
name|if_capenable
operator|&
name|IFCAP_LRO
condition|)
block|{
name|rc
operator|=
name|oce_mbox_nic_set_iface_lro_config
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|rc
operator|=
name|oce_mbox_nic_set_iface_lro_config
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
block|}
endif|#
directive|endif
break|break;
case|case
name|SIOCGPRIVATE_0
case|:
name|rc
operator|=
name|oce_handle_passthrough
argument_list|(
name|ifp
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
default|default:
name|rc
operator|=
name|ether_ioctl
argument_list|(
name|ifp
argument_list|,
name|command
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|oce_init
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|POCE_SOFTC
name|sc
init|=
name|arg
decl_stmt|;
name|LOCK
argument_list|(
operator|&
name|sc
operator|->
name|dev_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_UP
condition|)
block|{
name|oce_if_deactivate
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|oce_if_activate
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
name|UNLOCK
argument_list|(
operator|&
name|sc
operator|->
name|dev_lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|oce_multiq_start
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|)
block|{
name|POCE_SOFTC
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|oce_wq
modifier|*
name|wq
init|=
name|NULL
decl_stmt|;
name|int
name|queue_index
init|=
literal|0
decl_stmt|;
name|int
name|status
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|sc
operator|->
name|link_status
condition|)
return|return
name|ENXIO
return|;
if|if
condition|(
name|M_HASHTYPE_GET
argument_list|(
name|m
argument_list|)
operator|!=
name|M_HASHTYPE_NONE
condition|)
name|queue_index
operator|=
name|m
operator|->
name|m_pkthdr
operator|.
name|flowid
operator|%
name|sc
operator|->
name|nwqs
expr_stmt|;
name|wq
operator|=
name|sc
operator|->
name|wq
index|[
name|queue_index
index|]
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|wq
operator|->
name|tx_lock
argument_list|)
expr_stmt|;
name|status
operator|=
name|oce_multiq_transmit
argument_list|(
name|ifp
argument_list|,
name|m
argument_list|,
name|wq
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|wq
operator|->
name|tx_lock
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|oce_multiq_flush
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|POCE_SOFTC
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|nwqs
condition|;
name|i
operator|++
control|)
block|{
while|while
condition|(
operator|(
name|m
operator|=
name|buf_ring_dequeue_sc
argument_list|(
name|sc
operator|->
name|wq
index|[
name|i
index|]
operator|->
name|br
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
block|}
name|if_qflush
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*****************************************************************************  *                   Driver interrupt routines functions                     *  *****************************************************************************/
end_comment

begin_function
specifier|static
name|void
name|oce_intr
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|int
name|pending
parameter_list|)
block|{
name|POCE_INTR_INFO
name|ii
init|=
operator|(
name|POCE_INTR_INFO
operator|)
name|arg
decl_stmt|;
name|POCE_SOFTC
name|sc
init|=
name|ii
operator|->
name|sc
decl_stmt|;
name|struct
name|oce_eq
modifier|*
name|eq
init|=
name|ii
operator|->
name|eq
decl_stmt|;
name|struct
name|oce_eqe
modifier|*
name|eqe
decl_stmt|;
name|struct
name|oce_cq
modifier|*
name|cq
init|=
name|NULL
decl_stmt|;
name|int
name|i
decl_stmt|,
name|num_eqes
init|=
literal|0
decl_stmt|;
name|bus_dmamap_sync
argument_list|(
name|eq
operator|->
name|ring
operator|->
name|dma
operator|.
name|tag
argument_list|,
name|eq
operator|->
name|ring
operator|->
name|dma
operator|.
name|map
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
do|do
block|{
name|eqe
operator|=
name|RING_GET_CONSUMER_ITEM_VA
argument_list|(
name|eq
operator|->
name|ring
argument_list|,
expr|struct
name|oce_eqe
argument_list|)
expr_stmt|;
if|if
condition|(
name|eqe
operator|->
name|evnt
operator|==
literal|0
condition|)
break|break;
name|eqe
operator|->
name|evnt
operator|=
literal|0
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|eq
operator|->
name|ring
operator|->
name|dma
operator|.
name|tag
argument_list|,
name|eq
operator|->
name|ring
operator|->
name|dma
operator|.
name|map
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
name|RING_GET
argument_list|(
name|eq
operator|->
name|ring
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|num_eqes
operator|++
expr_stmt|;
block|}
do|while
condition|(
name|TRUE
condition|)
do|;
if|if
condition|(
operator|!
name|num_eqes
condition|)
goto|goto
name|eq_arm
goto|;
comment|/* Spurious */
comment|/* Clear EQ entries, but dont arm */
name|oce_arm_eq
argument_list|(
name|sc
argument_list|,
name|eq
operator|->
name|eq_id
argument_list|,
name|num_eqes
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
comment|/* Process TX, RX and MCC. But dont arm CQ*/
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|eq
operator|->
name|cq_valid
condition|;
name|i
operator|++
control|)
block|{
name|cq
operator|=
name|eq
operator|->
name|cq
index|[
name|i
index|]
expr_stmt|;
call|(
modifier|*
name|cq
operator|->
name|cq_handler
call|)
argument_list|(
name|cq
operator|->
name|cb_arg
argument_list|)
expr_stmt|;
block|}
comment|/* Arm all cqs connected to this EQ */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|eq
operator|->
name|cq_valid
condition|;
name|i
operator|++
control|)
block|{
name|cq
operator|=
name|eq
operator|->
name|cq
index|[
name|i
index|]
expr_stmt|;
name|oce_arm_cq
argument_list|(
name|sc
argument_list|,
name|cq
operator|->
name|cq_id
argument_list|,
literal|0
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
block|}
name|eq_arm
label|:
name|oce_arm_eq
argument_list|(
name|sc
argument_list|,
name|eq
operator|->
name|eq_id
argument_list|,
literal|0
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|oce_setup_intr
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|)
block|{
name|int
name|rc
init|=
literal|0
decl_stmt|,
name|use_intx
init|=
literal|0
decl_stmt|;
name|int
name|vector
init|=
literal|0
decl_stmt|,
name|req_vectors
init|=
literal|0
decl_stmt|;
name|int
name|tot_req_vectors
decl_stmt|,
name|tot_vectors
decl_stmt|;
if|if
condition|(
name|is_rss_enabled
argument_list|(
name|sc
argument_list|)
condition|)
name|req_vectors
operator|=
name|MAX
argument_list|(
operator|(
name|sc
operator|->
name|nrqs
operator|-
literal|1
operator|)
argument_list|,
name|sc
operator|->
name|nwqs
argument_list|)
expr_stmt|;
else|else
name|req_vectors
operator|=
literal|1
expr_stmt|;
name|tot_req_vectors
operator|=
name|req_vectors
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|rdma_flags
operator|&
name|OCE_RDMA_FLAG_SUPPORTED
condition|)
block|{
if|if
condition|(
name|req_vectors
operator|>
literal|1
condition|)
block|{
name|tot_req_vectors
operator|+=
name|OCE_RDMA_VECTORS
expr_stmt|;
name|sc
operator|->
name|roce_intr_count
operator|=
name|OCE_RDMA_VECTORS
expr_stmt|;
block|}
block|}
if|if
condition|(
name|sc
operator|->
name|flags
operator|&
name|OCE_FLAGS_MSIX_CAPABLE
condition|)
block|{
name|sc
operator|->
name|intr_count
operator|=
name|req_vectors
expr_stmt|;
name|tot_vectors
operator|=
name|tot_req_vectors
expr_stmt|;
name|rc
operator|=
name|pci_alloc_msix
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
operator|&
name|tot_vectors
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
literal|0
condition|)
block|{
name|use_intx
operator|=
literal|1
expr_stmt|;
name|pci_release_msi
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|sc
operator|->
name|rdma_flags
operator|&
name|OCE_RDMA_FLAG_SUPPORTED
condition|)
block|{
if|if
condition|(
name|tot_vectors
operator|<
name|tot_req_vectors
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|intr_count
operator|<
operator|(
literal|2
operator|*
name|OCE_RDMA_VECTORS
operator|)
condition|)
block|{
name|sc
operator|->
name|roce_intr_count
operator|=
operator|(
name|tot_vectors
operator|/
literal|2
operator|)
expr_stmt|;
block|}
name|sc
operator|->
name|intr_count
operator|=
name|tot_vectors
operator|-
name|sc
operator|->
name|roce_intr_count
expr_stmt|;
block|}
block|}
else|else
block|{
name|sc
operator|->
name|intr_count
operator|=
name|tot_vectors
expr_stmt|;
block|}
name|sc
operator|->
name|flags
operator||=
name|OCE_FLAGS_USING_MSIX
expr_stmt|;
block|}
block|}
else|else
name|use_intx
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|use_intx
condition|)
name|sc
operator|->
name|intr_count
operator|=
literal|1
expr_stmt|;
comment|/* Scale number of queues based on intr we got */
name|update_queues_got
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|use_intx
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Using legacy interrupt\n"
argument_list|)
expr_stmt|;
name|rc
operator|=
name|oce_alloc_intr
argument_list|(
name|sc
argument_list|,
name|vector
argument_list|,
name|oce_intr
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|error
goto|;
block|}
else|else
block|{
for|for
control|(
init|;
name|vector
operator|<
name|sc
operator|->
name|intr_count
condition|;
name|vector
operator|++
control|)
block|{
name|rc
operator|=
name|oce_alloc_intr
argument_list|(
name|sc
argument_list|,
name|vector
argument_list|,
name|oce_intr
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|error
goto|;
block|}
block|}
return|return
literal|0
return|;
name|error
label|:
name|oce_intr_free
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|oce_fast_isr
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|POCE_INTR_INFO
name|ii
init|=
operator|(
name|POCE_INTR_INFO
operator|)
name|arg
decl_stmt|;
name|POCE_SOFTC
name|sc
init|=
name|ii
operator|->
name|sc
decl_stmt|;
if|if
condition|(
name|ii
operator|->
name|eq
operator|==
name|NULL
condition|)
return|return
name|FILTER_STRAY
return|;
name|oce_arm_eq
argument_list|(
name|sc
argument_list|,
name|ii
operator|->
name|eq
operator|->
name|eq_id
argument_list|,
literal|0
argument_list|,
name|FALSE
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|taskqueue_enqueue
argument_list|(
name|ii
operator|->
name|tq
argument_list|,
operator|&
name|ii
operator|->
name|task
argument_list|)
expr_stmt|;
name|ii
operator|->
name|eq
operator|->
name|intr
operator|++
expr_stmt|;
return|return
name|FILTER_HANDLED
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|oce_alloc_intr
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
name|int
name|vector
parameter_list|,
name|void
function_decl|(
modifier|*
name|isr
function_decl|)
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|int
name|pending
parameter_list|)
parameter_list|)
block|{
name|POCE_INTR_INFO
name|ii
init|=
operator|&
name|sc
operator|->
name|intrs
index|[
name|vector
index|]
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|,
name|rr
decl_stmt|;
if|if
condition|(
name|vector
operator|>=
name|OCE_MAX_EQ
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
comment|/* Set the resource id for the interrupt. 	 * MSIx is vector + 1 for the resource id, 	 * INTx is 0 for the resource id. 	 */
if|if
condition|(
name|sc
operator|->
name|flags
operator|&
name|OCE_FLAGS_USING_MSIX
condition|)
name|rr
operator|=
name|vector
operator|+
literal|1
expr_stmt|;
else|else
name|rr
operator|=
literal|0
expr_stmt|;
name|ii
operator|->
name|intr_res
operator|=
name|bus_alloc_resource_any
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
operator|&
name|rr
argument_list|,
name|RF_ACTIVE
operator||
name|RF_SHAREABLE
argument_list|)
expr_stmt|;
name|ii
operator|->
name|irq_rr
operator|=
name|rr
expr_stmt|;
if|if
condition|(
name|ii
operator|->
name|intr_res
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Could not allocate interrupt\n"
argument_list|)
expr_stmt|;
name|rc
operator|=
name|ENXIO
expr_stmt|;
return|return
name|rc
return|;
block|}
name|TASK_INIT
argument_list|(
operator|&
name|ii
operator|->
name|task
argument_list|,
literal|0
argument_list|,
name|isr
argument_list|,
name|ii
argument_list|)
expr_stmt|;
name|ii
operator|->
name|vector
operator|=
name|vector
expr_stmt|;
name|sprintf
argument_list|(
name|ii
operator|->
name|task_name
argument_list|,
literal|"oce_task[%d]"
argument_list|,
name|ii
operator|->
name|vector
argument_list|)
expr_stmt|;
name|ii
operator|->
name|tq
operator|=
name|taskqueue_create_fast
argument_list|(
name|ii
operator|->
name|task_name
argument_list|,
name|M_NOWAIT
argument_list|,
name|taskqueue_thread_enqueue
argument_list|,
operator|&
name|ii
operator|->
name|tq
argument_list|)
expr_stmt|;
name|taskqueue_start_threads
argument_list|(
operator|&
name|ii
operator|->
name|tq
argument_list|,
literal|1
argument_list|,
name|PI_NET
argument_list|,
literal|"%s taskq"
argument_list|,
name|device_get_nameunit
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
argument_list|)
expr_stmt|;
name|ii
operator|->
name|sc
operator|=
name|sc
expr_stmt|;
name|rc
operator|=
name|bus_setup_intr
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|ii
operator|->
name|intr_res
argument_list|,
name|INTR_TYPE_NET
argument_list|,
name|oce_fast_isr
argument_list|,
name|NULL
argument_list|,
name|ii
argument_list|,
operator|&
name|ii
operator|->
name|tag
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
name|void
name|oce_intr_free
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|)
block|{
name|int
name|i
init|=
literal|0
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|intr_count
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|sc
operator|->
name|intrs
index|[
name|i
index|]
operator|.
name|tag
operator|!=
name|NULL
condition|)
name|bus_teardown_intr
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|sc
operator|->
name|intrs
index|[
name|i
index|]
operator|.
name|intr_res
argument_list|,
name|sc
operator|->
name|intrs
index|[
name|i
index|]
operator|.
name|tag
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|intrs
index|[
name|i
index|]
operator|.
name|tq
operator|!=
name|NULL
condition|)
name|taskqueue_free
argument_list|(
name|sc
operator|->
name|intrs
index|[
name|i
index|]
operator|.
name|tq
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|intrs
index|[
name|i
index|]
operator|.
name|intr_res
operator|!=
name|NULL
condition|)
name|bus_release_resource
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
name|sc
operator|->
name|intrs
index|[
name|i
index|]
operator|.
name|irq_rr
argument_list|,
name|sc
operator|->
name|intrs
index|[
name|i
index|]
operator|.
name|intr_res
argument_list|)
expr_stmt|;
name|sc
operator|->
name|intrs
index|[
name|i
index|]
operator|.
name|tag
operator|=
name|NULL
expr_stmt|;
name|sc
operator|->
name|intrs
index|[
name|i
index|]
operator|.
name|intr_res
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|flags
operator|&
name|OCE_FLAGS_USING_MSIX
condition|)
name|pci_release_msi
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/****************************************************************************** *			  Media callbacks functions 			      * ******************************************************************************/
end_comment

begin_function
specifier|static
name|void
name|oce_media_status
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|ifmediareq
modifier|*
name|req
parameter_list|)
block|{
name|POCE_SOFTC
name|sc
init|=
operator|(
name|POCE_SOFTC
operator|)
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|req
operator|->
name|ifm_status
operator|=
name|IFM_AVALID
expr_stmt|;
name|req
operator|->
name|ifm_active
operator|=
name|IFM_ETHER
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|link_status
operator|==
literal|1
condition|)
name|req
operator|->
name|ifm_status
operator||=
name|IFM_ACTIVE
expr_stmt|;
else|else
return|return;
switch|switch
condition|(
name|sc
operator|->
name|link_speed
condition|)
block|{
case|case
literal|1
case|:
comment|/* 10 Mbps */
name|req
operator|->
name|ifm_active
operator||=
name|IFM_10_T
operator||
name|IFM_FDX
expr_stmt|;
name|sc
operator|->
name|speed
operator|=
literal|10
expr_stmt|;
break|break;
case|case
literal|2
case|:
comment|/* 100 Mbps */
name|req
operator|->
name|ifm_active
operator||=
name|IFM_100_TX
operator||
name|IFM_FDX
expr_stmt|;
name|sc
operator|->
name|speed
operator|=
literal|100
expr_stmt|;
break|break;
case|case
literal|3
case|:
comment|/* 1 Gbps */
name|req
operator|->
name|ifm_active
operator||=
name|IFM_1000_T
operator||
name|IFM_FDX
expr_stmt|;
name|sc
operator|->
name|speed
operator|=
literal|1000
expr_stmt|;
break|break;
case|case
literal|4
case|:
comment|/* 10 Gbps */
name|req
operator|->
name|ifm_active
operator||=
name|IFM_10G_SR
operator||
name|IFM_FDX
expr_stmt|;
name|sc
operator|->
name|speed
operator|=
literal|10000
expr_stmt|;
break|break;
case|case
literal|5
case|:
comment|/* 20 Gbps */
name|req
operator|->
name|ifm_active
operator||=
name|IFM_10G_SR
operator||
name|IFM_FDX
expr_stmt|;
name|sc
operator|->
name|speed
operator|=
literal|20000
expr_stmt|;
break|break;
case|case
literal|6
case|:
comment|/* 25 Gbps */
name|req
operator|->
name|ifm_active
operator||=
name|IFM_10G_SR
operator||
name|IFM_FDX
expr_stmt|;
name|sc
operator|->
name|speed
operator|=
literal|25000
expr_stmt|;
break|break;
case|case
literal|7
case|:
comment|/* 40 Gbps */
name|req
operator|->
name|ifm_active
operator||=
name|IFM_40G_SR4
operator||
name|IFM_FDX
expr_stmt|;
name|sc
operator|->
name|speed
operator|=
literal|40000
expr_stmt|;
break|break;
default|default:
name|sc
operator|->
name|speed
operator|=
literal|0
expr_stmt|;
break|break;
block|}
return|return;
block|}
end_function

begin_function
name|int
name|oce_media_change
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|oce_is_pkt_dest_bmc
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|boolean_t
modifier|*
name|os2bmc
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|m_new
parameter_list|)
block|{
name|struct
name|ether_header
modifier|*
name|eh
init|=
name|NULL
decl_stmt|;
name|eh
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ether_header
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|is_os2bmc_enabled
argument_list|(
name|sc
argument_list|)
operator|||
operator|*
name|os2bmc
condition|)
block|{
operator|*
name|os2bmc
operator|=
name|FALSE
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
operator|!
name|ETHER_IS_MULTICAST
argument_list|(
name|eh
operator|->
name|ether_dhost
argument_list|)
condition|)
goto|goto
name|done
goto|;
if|if
condition|(
name|is_mc_allowed_on_bmc
argument_list|(
name|sc
argument_list|,
name|eh
argument_list|)
operator|||
name|is_bc_allowed_on_bmc
argument_list|(
name|sc
argument_list|,
name|eh
argument_list|)
operator|||
name|is_arp_allowed_on_bmc
argument_list|(
name|sc
argument_list|,
name|ntohs
argument_list|(
name|eh
operator|->
name|ether_type
argument_list|)
argument_list|)
condition|)
block|{
operator|*
name|os2bmc
operator|=
name|TRUE
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ip
operator|*
argument_list|)
operator|->
name|ip_p
operator|==
name|IPPROTO_IPV6
condition|)
block|{
name|struct
name|ip6_hdr
modifier|*
name|ip6
init|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ip6_hdr
operator|*
argument_list|)
decl_stmt|;
name|uint8_t
name|nexthdr
init|=
name|ip6
operator|->
name|ip6_nxt
decl_stmt|;
if|if
condition|(
name|nexthdr
operator|==
name|IPPROTO_ICMPV6
condition|)
block|{
name|struct
name|icmp6_hdr
modifier|*
name|icmp6
init|=
operator|(
expr|struct
name|icmp6_hdr
operator|*
operator|)
operator|(
name|ip6
operator|+
literal|1
operator|)
decl_stmt|;
switch|switch
condition|(
name|icmp6
operator|->
name|icmp6_type
condition|)
block|{
case|case
name|ND_ROUTER_ADVERT
case|:
operator|*
name|os2bmc
operator|=
name|is_ipv6_ra_filt_enabled
argument_list|(
name|sc
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
case|case
name|ND_NEIGHBOR_ADVERT
case|:
operator|*
name|os2bmc
operator|=
name|is_ipv6_na_filt_enabled
argument_list|(
name|sc
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
default|default:
break|break;
block|}
block|}
block|}
if|if
condition|(
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ip
operator|*
argument_list|)
operator|->
name|ip_p
operator|==
name|IPPROTO_UDP
condition|)
block|{
name|struct
name|ip
modifier|*
name|ip
init|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ip
operator|*
argument_list|)
decl_stmt|;
name|int
name|iphlen
init|=
name|ip
operator|->
name|ip_hl
operator|<<
literal|2
decl_stmt|;
name|struct
name|udphdr
modifier|*
name|uh
init|=
operator|(
expr|struct
name|udphdr
operator|*
operator|)
operator|(
operator|(
name|caddr_t
operator|)
name|ip
operator|+
name|iphlen
operator|)
decl_stmt|;
switch|switch
condition|(
name|uh
operator|->
name|uh_dport
condition|)
block|{
case|case
name|DHCP_CLIENT_PORT
case|:
operator|*
name|os2bmc
operator|=
name|is_dhcp_client_filt_enabled
argument_list|(
name|sc
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
case|case
name|DHCP_SERVER_PORT
case|:
operator|*
name|os2bmc
operator|=
name|is_dhcp_srvr_filt_enabled
argument_list|(
name|sc
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
case|case
name|NET_BIOS_PORT1
case|:
case|case
name|NET_BIOS_PORT2
case|:
operator|*
name|os2bmc
operator|=
name|is_nbios_filt_enabled
argument_list|(
name|sc
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
case|case
name|DHCPV6_RAS_PORT
case|:
operator|*
name|os2bmc
operator|=
name|is_ipv6_ras_filt_enabled
argument_list|(
name|sc
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
default|default:
break|break;
block|}
block|}
name|done
label|:
if|if
condition|(
operator|*
name|os2bmc
condition|)
block|{
operator|*
name|m_new
operator|=
name|m_dup
argument_list|(
name|m
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|m_new
condition|)
block|{
operator|*
name|os2bmc
operator|=
name|FALSE
expr_stmt|;
return|return;
block|}
operator|*
name|m_new
operator|=
name|oce_insert_vlan_tag
argument_list|(
name|sc
argument_list|,
operator|*
name|m_new
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*****************************************************************************  *			  Transmit routines functions			     *  *****************************************************************************/
end_comment

begin_function
specifier|static
name|int
name|oce_tx
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|mpp
parameter_list|,
name|int
name|wq_index
parameter_list|)
block|{
name|int
name|rc
init|=
literal|0
decl_stmt|,
name|i
decl_stmt|,
name|retry_cnt
init|=
literal|0
decl_stmt|;
name|bus_dma_segment_t
name|segs
index|[
name|OCE_MAX_TX_ELEMENTS
index|]
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|,
modifier|*
name|m_temp
decl_stmt|,
modifier|*
name|m_new
init|=
name|NULL
decl_stmt|;
name|struct
name|oce_wq
modifier|*
name|wq
init|=
name|sc
operator|->
name|wq
index|[
name|wq_index
index|]
decl_stmt|;
name|struct
name|oce_packet_desc
modifier|*
name|pd
decl_stmt|;
name|struct
name|oce_nic_hdr_wqe
modifier|*
name|nichdr
decl_stmt|;
name|struct
name|oce_nic_frag_wqe
modifier|*
name|nicfrag
decl_stmt|;
name|struct
name|ether_header
modifier|*
name|eh
init|=
name|NULL
decl_stmt|;
name|int
name|num_wqes
decl_stmt|;
name|uint32_t
name|reg_value
decl_stmt|;
name|boolean_t
name|complete
init|=
name|TRUE
decl_stmt|;
name|boolean_t
name|os2bmc
init|=
name|FALSE
decl_stmt|;
name|m
operator|=
operator|*
name|mpp
expr_stmt|;
if|if
condition|(
operator|!
name|m
condition|)
return|return
name|EINVAL
return|;
if|if
condition|(
operator|!
operator|(
name|m
operator|->
name|m_flags
operator|&
name|M_PKTHDR
operator|)
condition|)
block|{
name|rc
operator|=
name|ENXIO
expr_stmt|;
goto|goto
name|free_ret
goto|;
block|}
comment|/* Don't allow non-TSO packets longer than MTU */
if|if
condition|(
operator|!
name|is_tso_pkt
argument_list|(
name|m
argument_list|)
condition|)
block|{
name|eh
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ether_header
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|>
name|ETHER_MAX_FRAME
argument_list|(
name|sc
operator|->
name|ifp
argument_list|,
name|eh
operator|->
name|ether_type
argument_list|,
name|FALSE
argument_list|)
condition|)
goto|goto
name|free_ret
goto|;
block|}
if|if
condition|(
name|oce_tx_asic_stall_verify
argument_list|(
name|sc
argument_list|,
name|m
argument_list|)
condition|)
block|{
name|m
operator|=
name|oce_insert_vlan_tag
argument_list|(
name|sc
argument_list|,
name|m
argument_list|,
operator|&
name|complete
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|m
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Insertion unsuccessful\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
comment|/* Lancer, SH ASIC has a bug wherein Packets that are 32 bytes or less 	 * may cause a transmit stall on that port. So the work-around is to 	 * pad short packets (<= 32 bytes) to a 36-byte length. 	*/
if|if
condition|(
name|IS_SH
argument_list|(
name|sc
argument_list|)
operator|||
name|IS_XE201
argument_list|(
name|sc
argument_list|)
condition|)
block|{
if|if
condition|(
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|<=
literal|32
condition|)
block|{
name|char
name|buf
index|[
literal|36
index|]
decl_stmt|;
name|bzero
argument_list|(
operator|(
name|void
operator|*
operator|)
name|buf
argument_list|,
literal|36
argument_list|)
expr_stmt|;
name|m_append
argument_list|(
name|m
argument_list|,
operator|(
literal|36
operator|-
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|)
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
block|}
name|tx_start
label|:
if|if
condition|(
name|m
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|&
name|CSUM_TSO
condition|)
block|{
comment|/* consolidate packet buffers for TSO/LSO segment offload */
if|#
directive|if
name|defined
argument_list|(
name|INET6
argument_list|)
operator|||
name|defined
argument_list|(
name|INET
argument_list|)
name|m
operator|=
name|oce_tso_setup
argument_list|(
name|sc
argument_list|,
name|mpp
argument_list|)
expr_stmt|;
else|#
directive|else
name|m
operator|=
name|NULL
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
block|{
name|rc
operator|=
name|ENXIO
expr_stmt|;
goto|goto
name|free_ret
goto|;
block|}
block|}
name|pd
operator|=
operator|&
name|wq
operator|->
name|pckts
index|[
name|wq
operator|->
name|pkt_desc_head
index|]
expr_stmt|;
name|retry
label|:
name|rc
operator|=
name|bus_dmamap_load_mbuf_sg
argument_list|(
name|wq
operator|->
name|tag
argument_list|,
name|pd
operator|->
name|map
argument_list|,
name|m
argument_list|,
name|segs
argument_list|,
operator|&
name|pd
operator|->
name|nsegs
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
literal|0
condition|)
block|{
name|num_wqes
operator|=
name|pd
operator|->
name|nsegs
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|IS_BE
argument_list|(
name|sc
argument_list|)
operator|||
name|IS_SH
argument_list|(
name|sc
argument_list|)
condition|)
block|{
comment|/*Dummy required only for BE3.*/
if|if
condition|(
name|num_wqes
operator|&
literal|1
condition|)
name|num_wqes
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|num_wqes
operator|>=
name|RING_NUM_FREE
argument_list|(
name|wq
operator|->
name|ring
argument_list|)
condition|)
block|{
name|bus_dmamap_unload
argument_list|(
name|wq
operator|->
name|tag
argument_list|,
name|pd
operator|->
name|map
argument_list|)
expr_stmt|;
return|return
name|EBUSY
return|;
block|}
name|atomic_store_rel_int
argument_list|(
operator|&
name|wq
operator|->
name|pkt_desc_head
argument_list|,
operator|(
name|wq
operator|->
name|pkt_desc_head
operator|+
literal|1
operator|)
operator|%
expr|\
name|OCE_WQ_PACKET_ARRAY_SIZE
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|wq
operator|->
name|tag
argument_list|,
name|pd
operator|->
name|map
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
name|pd
operator|->
name|mbuf
operator|=
name|m
expr_stmt|;
name|nichdr
operator|=
name|RING_GET_PRODUCER_ITEM_VA
argument_list|(
name|wq
operator|->
name|ring
argument_list|,
expr|struct
name|oce_nic_hdr_wqe
argument_list|)
expr_stmt|;
name|nichdr
operator|->
name|u0
operator|.
name|dw
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|nichdr
operator|->
name|u0
operator|.
name|dw
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|nichdr
operator|->
name|u0
operator|.
name|dw
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|nichdr
operator|->
name|u0
operator|.
name|dw
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|nichdr
operator|->
name|u0
operator|.
name|s
operator|.
name|complete
operator|=
name|complete
expr_stmt|;
name|nichdr
operator|->
name|u0
operator|.
name|s
operator|.
name|mgmt
operator|=
name|os2bmc
expr_stmt|;
name|nichdr
operator|->
name|u0
operator|.
name|s
operator|.
name|event
operator|=
literal|1
expr_stmt|;
name|nichdr
operator|->
name|u0
operator|.
name|s
operator|.
name|crc
operator|=
literal|1
expr_stmt|;
name|nichdr
operator|->
name|u0
operator|.
name|s
operator|.
name|forward
operator|=
literal|0
expr_stmt|;
name|nichdr
operator|->
name|u0
operator|.
name|s
operator|.
name|ipcs
operator|=
operator|(
name|m
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|&
name|CSUM_IP
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|nichdr
operator|->
name|u0
operator|.
name|s
operator|.
name|udpcs
operator|=
operator|(
name|m
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|&
name|CSUM_UDP
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|nichdr
operator|->
name|u0
operator|.
name|s
operator|.
name|tcpcs
operator|=
operator|(
name|m
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|&
name|CSUM_TCP
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|nichdr
operator|->
name|u0
operator|.
name|s
operator|.
name|num_wqe
operator|=
name|num_wqes
expr_stmt|;
name|nichdr
operator|->
name|u0
operator|.
name|s
operator|.
name|total_length
operator|=
name|m
operator|->
name|m_pkthdr
operator|.
name|len
expr_stmt|;
if|if
condition|(
name|m
operator|->
name|m_flags
operator|&
name|M_VLANTAG
condition|)
block|{
name|nichdr
operator|->
name|u0
operator|.
name|s
operator|.
name|vlan
operator|=
literal|1
expr_stmt|;
comment|/*Vlan present*/
name|nichdr
operator|->
name|u0
operator|.
name|s
operator|.
name|vlan_tag
operator|=
name|m
operator|->
name|m_pkthdr
operator|.
name|ether_vtag
expr_stmt|;
block|}
if|if
condition|(
name|m
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|&
name|CSUM_TSO
condition|)
block|{
if|if
condition|(
name|m
operator|->
name|m_pkthdr
operator|.
name|tso_segsz
condition|)
block|{
name|nichdr
operator|->
name|u0
operator|.
name|s
operator|.
name|lso
operator|=
literal|1
expr_stmt|;
name|nichdr
operator|->
name|u0
operator|.
name|s
operator|.
name|lso_mss
operator|=
name|m
operator|->
name|m_pkthdr
operator|.
name|tso_segsz
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|IS_BE
argument_list|(
name|sc
argument_list|)
operator|||
operator|!
name|IS_SH
argument_list|(
name|sc
argument_list|)
condition|)
name|nichdr
operator|->
name|u0
operator|.
name|s
operator|.
name|ipcs
operator|=
literal|1
expr_stmt|;
block|}
name|RING_PUT
argument_list|(
name|wq
operator|->
name|ring
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|atomic_add_int
argument_list|(
operator|&
name|wq
operator|->
name|ring
operator|->
name|num_used
argument_list|,
literal|1
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pd
operator|->
name|nsegs
condition|;
name|i
operator|++
control|)
block|{
name|nicfrag
operator|=
name|RING_GET_PRODUCER_ITEM_VA
argument_list|(
name|wq
operator|->
name|ring
argument_list|,
expr|struct
name|oce_nic_frag_wqe
argument_list|)
expr_stmt|;
name|nicfrag
operator|->
name|u0
operator|.
name|s
operator|.
name|rsvd0
operator|=
literal|0
expr_stmt|;
name|nicfrag
operator|->
name|u0
operator|.
name|s
operator|.
name|frag_pa_hi
operator|=
name|ADDR_HI
argument_list|(
name|segs
index|[
name|i
index|]
operator|.
name|ds_addr
argument_list|)
expr_stmt|;
name|nicfrag
operator|->
name|u0
operator|.
name|s
operator|.
name|frag_pa_lo
operator|=
name|ADDR_LO
argument_list|(
name|segs
index|[
name|i
index|]
operator|.
name|ds_addr
argument_list|)
expr_stmt|;
name|nicfrag
operator|->
name|u0
operator|.
name|s
operator|.
name|frag_len
operator|=
name|segs
index|[
name|i
index|]
operator|.
name|ds_len
expr_stmt|;
name|pd
operator|->
name|wqe_idx
operator|=
name|wq
operator|->
name|ring
operator|->
name|pidx
expr_stmt|;
name|RING_PUT
argument_list|(
name|wq
operator|->
name|ring
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|atomic_add_int
argument_list|(
operator|&
name|wq
operator|->
name|ring
operator|->
name|num_used
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|num_wqes
operator|>
operator|(
name|pd
operator|->
name|nsegs
operator|+
literal|1
operator|)
condition|)
block|{
name|nicfrag
operator|=
name|RING_GET_PRODUCER_ITEM_VA
argument_list|(
name|wq
operator|->
name|ring
argument_list|,
expr|struct
name|oce_nic_frag_wqe
argument_list|)
expr_stmt|;
name|nicfrag
operator|->
name|u0
operator|.
name|dw
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|nicfrag
operator|->
name|u0
operator|.
name|dw
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|nicfrag
operator|->
name|u0
operator|.
name|dw
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|nicfrag
operator|->
name|u0
operator|.
name|dw
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|pd
operator|->
name|wqe_idx
operator|=
name|wq
operator|->
name|ring
operator|->
name|pidx
expr_stmt|;
name|RING_PUT
argument_list|(
name|wq
operator|->
name|ring
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|atomic_add_int
argument_list|(
operator|&
name|wq
operator|->
name|ring
operator|->
name|num_used
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pd
operator|->
name|nsegs
operator|++
expr_stmt|;
block|}
name|if_inc_counter
argument_list|(
name|sc
operator|->
name|ifp
argument_list|,
name|IFCOUNTER_OPACKETS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|wq
operator|->
name|tx_stats
operator|.
name|tx_reqs
operator|++
expr_stmt|;
name|wq
operator|->
name|tx_stats
operator|.
name|tx_wrbs
operator|+=
name|num_wqes
expr_stmt|;
name|wq
operator|->
name|tx_stats
operator|.
name|tx_bytes
operator|+=
name|m
operator|->
name|m_pkthdr
operator|.
name|len
expr_stmt|;
name|wq
operator|->
name|tx_stats
operator|.
name|tx_pkts
operator|++
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|wq
operator|->
name|ring
operator|->
name|dma
operator|.
name|tag
argument_list|,
name|wq
operator|->
name|ring
operator|->
name|dma
operator|.
name|map
argument_list|,
name|BUS_DMASYNC_PREREAD
operator||
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
name|reg_value
operator|=
operator|(
name|num_wqes
operator|<<
literal|16
operator|)
operator||
name|wq
operator|->
name|wq_id
expr_stmt|;
comment|/* if os2bmc is not enabled or if the pkt is already tagged as 		   bmc, do nothing 		 */
name|oce_is_pkt_dest_bmc
argument_list|(
name|sc
argument_list|,
name|m
argument_list|,
operator|&
name|os2bmc
argument_list|,
operator|&
name|m_new
argument_list|)
expr_stmt|;
name|OCE_WRITE_REG32
argument_list|(
name|sc
argument_list|,
name|db
argument_list|,
name|wq
operator|->
name|db_offset
argument_list|,
name|reg_value
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rc
operator|==
name|EFBIG
condition|)
block|{
if|if
condition|(
name|retry_cnt
operator|==
literal|0
condition|)
block|{
name|m_temp
operator|=
name|m_defrag
argument_list|(
name|m
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|m_temp
operator|==
name|NULL
condition|)
goto|goto
name|free_ret
goto|;
name|m
operator|=
name|m_temp
expr_stmt|;
operator|*
name|mpp
operator|=
name|m_temp
expr_stmt|;
name|retry_cnt
operator|=
name|retry_cnt
operator|+
literal|1
expr_stmt|;
goto|goto
name|retry
goto|;
block|}
else|else
goto|goto
name|free_ret
goto|;
block|}
elseif|else
if|if
condition|(
name|rc
operator|==
name|ENOMEM
condition|)
return|return
name|rc
return|;
else|else
goto|goto
name|free_ret
goto|;
if|if
condition|(
name|os2bmc
condition|)
block|{
name|m
operator|=
name|m_new
expr_stmt|;
goto|goto
name|tx_start
goto|;
block|}
return|return
literal|0
return|;
name|free_ret
label|:
name|m_freem
argument_list|(
operator|*
name|mpp
argument_list|)
expr_stmt|;
operator|*
name|mpp
operator|=
name|NULL
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|oce_process_tx_completion
parameter_list|(
name|struct
name|oce_wq
modifier|*
name|wq
parameter_list|)
block|{
name|struct
name|oce_packet_desc
modifier|*
name|pd
decl_stmt|;
name|POCE_SOFTC
name|sc
init|=
operator|(
name|POCE_SOFTC
operator|)
name|wq
operator|->
name|parent
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|pd
operator|=
operator|&
name|wq
operator|->
name|pckts
index|[
name|wq
operator|->
name|pkt_desc_tail
index|]
expr_stmt|;
name|atomic_store_rel_int
argument_list|(
operator|&
name|wq
operator|->
name|pkt_desc_tail
argument_list|,
operator|(
name|wq
operator|->
name|pkt_desc_tail
operator|+
literal|1
operator|)
operator|%
name|OCE_WQ_PACKET_ARRAY_SIZE
argument_list|)
expr_stmt|;
name|atomic_subtract_int
argument_list|(
operator|&
name|wq
operator|->
name|ring
operator|->
name|num_used
argument_list|,
name|pd
operator|->
name|nsegs
operator|+
literal|1
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|wq
operator|->
name|tag
argument_list|,
name|pd
operator|->
name|map
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|wq
operator|->
name|tag
argument_list|,
name|pd
operator|->
name|map
argument_list|)
expr_stmt|;
name|m
operator|=
name|pd
operator|->
name|mbuf
expr_stmt|;
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|pd
operator|->
name|mbuf
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_OACTIVE
condition|)
block|{
if|if
condition|(
name|wq
operator|->
name|ring
operator|->
name|num_used
operator|<
operator|(
name|wq
operator|->
name|ring
operator|->
name|num_items
operator|/
literal|2
operator|)
condition|)
block|{
name|sc
operator|->
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
operator|(
name|IFF_DRV_OACTIVE
operator|)
expr_stmt|;
name|oce_tx_restart
argument_list|(
name|sc
argument_list|,
name|wq
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|oce_tx_restart
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
name|struct
name|oce_wq
modifier|*
name|wq
parameter_list|)
block|{
if|if
condition|(
operator|(
name|sc
operator|->
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
operator|!=
name|IFF_DRV_RUNNING
condition|)
return|return;
if|#
directive|if
name|__FreeBSD_version
operator|>=
literal|800000
if|if
condition|(
operator|!
name|drbr_empty
argument_list|(
name|sc
operator|->
name|ifp
argument_list|,
name|wq
operator|->
name|br
argument_list|)
condition|)
else|#
directive|else
if|if
condition|(
operator|!
name|IFQ_DRV_IS_EMPTY
argument_list|(
operator|&
name|sc
operator|->
name|ifp
operator|->
name|if_snd
argument_list|)
condition|)
endif|#
directive|endif
name|taskqueue_enqueue
argument_list|(
name|taskqueue_swi
argument_list|,
operator|&
name|wq
operator|->
name|txtask
argument_list|)
expr_stmt|;
block|}
end_function

begin_if
if|#
directive|if
name|defined
argument_list|(
name|INET6
argument_list|)
operator|||
name|defined
argument_list|(
name|INET
argument_list|)
end_if

begin_function
specifier|static
name|struct
name|mbuf
modifier|*
name|oce_tso_setup
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|mpp
parameter_list|)
block|{
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
ifdef|#
directive|ifdef
name|INET
name|struct
name|ip
modifier|*
name|ip
decl_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|INET6
name|struct
name|ip6_hdr
modifier|*
name|ip6
decl_stmt|;
endif|#
directive|endif
name|struct
name|ether_vlan_header
modifier|*
name|eh
decl_stmt|;
name|struct
name|tcphdr
modifier|*
name|th
decl_stmt|;
name|uint16_t
name|etype
decl_stmt|;
name|int
name|total_len
init|=
literal|0
decl_stmt|,
name|ehdrlen
init|=
literal|0
decl_stmt|;
name|m
operator|=
operator|*
name|mpp
expr_stmt|;
if|if
condition|(
name|M_WRITABLE
argument_list|(
name|m
argument_list|)
operator|==
literal|0
condition|)
block|{
name|m
operator|=
name|m_dup
argument_list|(
operator|*
name|mpp
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|m
condition|)
return|return
name|NULL
return|;
name|m_freem
argument_list|(
operator|*
name|mpp
argument_list|)
expr_stmt|;
operator|*
name|mpp
operator|=
name|m
expr_stmt|;
block|}
name|eh
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ether_vlan_header
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
name|eh
operator|->
name|evl_encap_proto
operator|==
name|htons
argument_list|(
name|ETHERTYPE_VLAN
argument_list|)
condition|)
block|{
name|etype
operator|=
name|ntohs
argument_list|(
name|eh
operator|->
name|evl_proto
argument_list|)
expr_stmt|;
name|ehdrlen
operator|=
name|ETHER_HDR_LEN
operator|+
name|ETHER_VLAN_ENCAP_LEN
expr_stmt|;
block|}
else|else
block|{
name|etype
operator|=
name|ntohs
argument_list|(
name|eh
operator|->
name|evl_encap_proto
argument_list|)
expr_stmt|;
name|ehdrlen
operator|=
name|ETHER_HDR_LEN
expr_stmt|;
block|}
switch|switch
condition|(
name|etype
condition|)
block|{
ifdef|#
directive|ifdef
name|INET
case|case
name|ETHERTYPE_IP
case|:
name|ip
operator|=
operator|(
expr|struct
name|ip
operator|*
operator|)
operator|(
name|m
operator|->
name|m_data
operator|+
name|ehdrlen
operator|)
expr_stmt|;
if|if
condition|(
name|ip
operator|->
name|ip_p
operator|!=
name|IPPROTO_TCP
condition|)
return|return
name|NULL
return|;
name|th
operator|=
operator|(
expr|struct
name|tcphdr
operator|*
operator|)
operator|(
operator|(
name|caddr_t
operator|)
name|ip
operator|+
operator|(
name|ip
operator|->
name|ip_hl
operator|<<
literal|2
operator|)
operator|)
expr_stmt|;
name|total_len
operator|=
name|ehdrlen
operator|+
operator|(
name|ip
operator|->
name|ip_hl
operator|<<
literal|2
operator|)
operator|+
operator|(
name|th
operator|->
name|th_off
operator|<<
literal|2
operator|)
expr_stmt|;
break|break;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|INET6
case|case
name|ETHERTYPE_IPV6
case|:
name|ip6
operator|=
operator|(
expr|struct
name|ip6_hdr
operator|*
operator|)
operator|(
name|m
operator|->
name|m_data
operator|+
name|ehdrlen
operator|)
expr_stmt|;
if|if
condition|(
name|ip6
operator|->
name|ip6_nxt
operator|!=
name|IPPROTO_TCP
condition|)
return|return
name|NULL
return|;
name|th
operator|=
operator|(
expr|struct
name|tcphdr
operator|*
operator|)
operator|(
operator|(
name|caddr_t
operator|)
name|ip6
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|ip6_hdr
argument_list|)
operator|)
expr_stmt|;
name|total_len
operator|=
name|ehdrlen
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|ip6_hdr
argument_list|)
operator|+
operator|(
name|th
operator|->
name|th_off
operator|<<
literal|2
operator|)
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
return|return
name|NULL
return|;
block|}
name|m
operator|=
name|m_pullup
argument_list|(
name|m
argument_list|,
name|total_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|m
condition|)
return|return
name|NULL
return|;
operator|*
name|mpp
operator|=
name|m
expr_stmt|;
return|return
name|m
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* INET6 || INET */
end_comment

begin_function
name|void
name|oce_tx_task
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|int
name|npending
parameter_list|)
block|{
name|struct
name|oce_wq
modifier|*
name|wq
init|=
name|arg
decl_stmt|;
name|POCE_SOFTC
name|sc
init|=
name|wq
operator|->
name|parent
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|ifp
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
if|#
directive|if
name|__FreeBSD_version
operator|>=
literal|800000
name|LOCK
argument_list|(
operator|&
name|wq
operator|->
name|tx_lock
argument_list|)
expr_stmt|;
name|rc
operator|=
name|oce_multiq_transmit
argument_list|(
name|ifp
argument_list|,
name|NULL
argument_list|,
name|wq
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"TX[%d] restart failed\n"
argument_list|,
name|wq
operator|->
name|queue_index
argument_list|)
expr_stmt|;
block|}
name|UNLOCK
argument_list|(
operator|&
name|wq
operator|->
name|tx_lock
argument_list|)
expr_stmt|;
else|#
directive|else
name|oce_start
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_function
name|void
name|oce_start
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|POCE_SOFTC
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|int
name|def_q
init|=
literal|0
decl_stmt|;
comment|/* Defualt tx queue is 0*/
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
operator|(
name|IFF_DRV_RUNNING
operator||
name|IFF_DRV_OACTIVE
operator|)
operator|)
operator|!=
name|IFF_DRV_RUNNING
condition|)
return|return;
if|if
condition|(
operator|!
name|sc
operator|->
name|link_status
condition|)
return|return;
do|do
block|{
name|IF_DEQUEUE
argument_list|(
operator|&
name|sc
operator|->
name|ifp
operator|->
name|if_snd
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
break|break;
name|LOCK
argument_list|(
operator|&
name|sc
operator|->
name|wq
index|[
name|def_q
index|]
operator|->
name|tx_lock
argument_list|)
expr_stmt|;
name|rc
operator|=
name|oce_tx
argument_list|(
name|sc
argument_list|,
operator|&
name|m
argument_list|,
name|def_q
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|sc
operator|->
name|wq
index|[
name|def_q
index|]
operator|->
name|tx_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
if|if
condition|(
name|m
operator|!=
name|NULL
condition|)
block|{
name|sc
operator|->
name|wq
index|[
name|def_q
index|]
operator|->
name|tx_stats
operator|.
name|tx_stops
operator|++
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator||=
name|IFF_DRV_OACTIVE
expr_stmt|;
name|IFQ_DRV_PREPEND
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|m
operator|=
name|NULL
expr_stmt|;
block|}
break|break;
block|}
if|if
condition|(
name|m
operator|!=
name|NULL
condition|)
name|ETHER_BPF_MTAP
argument_list|(
name|ifp
argument_list|,
name|m
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|TRUE
condition|)
do|;
return|return;
block|}
end_function

begin_comment
comment|/* Handle the Completion Queue for transmit */
end_comment

begin_function
name|uint16_t
name|oce_wq_handler
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|oce_wq
modifier|*
name|wq
init|=
operator|(
expr|struct
name|oce_wq
operator|*
operator|)
name|arg
decl_stmt|;
name|POCE_SOFTC
name|sc
init|=
name|wq
operator|->
name|parent
decl_stmt|;
name|struct
name|oce_cq
modifier|*
name|cq
init|=
name|wq
operator|->
name|cq
decl_stmt|;
name|struct
name|oce_nic_tx_cqe
modifier|*
name|cqe
decl_stmt|;
name|int
name|num_cqes
init|=
literal|0
decl_stmt|;
name|LOCK
argument_list|(
operator|&
name|wq
operator|->
name|tx_compl_lock
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|cq
operator|->
name|ring
operator|->
name|dma
operator|.
name|tag
argument_list|,
name|cq
operator|->
name|ring
operator|->
name|dma
operator|.
name|map
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
name|cqe
operator|=
name|RING_GET_CONSUMER_ITEM_VA
argument_list|(
name|cq
operator|->
name|ring
argument_list|,
expr|struct
name|oce_nic_tx_cqe
argument_list|)
expr_stmt|;
while|while
condition|(
name|cqe
operator|->
name|u0
operator|.
name|dw
index|[
literal|3
index|]
condition|)
block|{
name|DW_SWAP
argument_list|(
operator|(
name|uint32_t
operator|*
operator|)
name|cqe
argument_list|,
sizeof|sizeof
argument_list|(
name|oce_wq_cqe
argument_list|)
argument_list|)
expr_stmt|;
name|wq
operator|->
name|ring
operator|->
name|cidx
operator|=
name|cqe
operator|->
name|u0
operator|.
name|s
operator|.
name|wqe_index
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|wq
operator|->
name|ring
operator|->
name|cidx
operator|>=
name|wq
operator|->
name|ring
operator|->
name|num_items
condition|)
name|wq
operator|->
name|ring
operator|->
name|cidx
operator|-=
name|wq
operator|->
name|ring
operator|->
name|num_items
expr_stmt|;
name|oce_process_tx_completion
argument_list|(
name|wq
argument_list|)
expr_stmt|;
name|wq
operator|->
name|tx_stats
operator|.
name|tx_compl
operator|++
expr_stmt|;
name|cqe
operator|->
name|u0
operator|.
name|dw
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|RING_GET
argument_list|(
name|cq
operator|->
name|ring
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|cq
operator|->
name|ring
operator|->
name|dma
operator|.
name|tag
argument_list|,
name|cq
operator|->
name|ring
operator|->
name|dma
operator|.
name|map
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
name|cqe
operator|=
name|RING_GET_CONSUMER_ITEM_VA
argument_list|(
name|cq
operator|->
name|ring
argument_list|,
expr|struct
name|oce_nic_tx_cqe
argument_list|)
expr_stmt|;
name|num_cqes
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|num_cqes
condition|)
name|oce_arm_cq
argument_list|(
name|sc
argument_list|,
name|cq
operator|->
name|cq_id
argument_list|,
name|num_cqes
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|wq
operator|->
name|tx_compl_lock
argument_list|)
expr_stmt|;
return|return
name|num_cqes
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|oce_multiq_transmit
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|struct
name|oce_wq
modifier|*
name|wq
parameter_list|)
block|{
name|POCE_SOFTC
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|int
name|status
init|=
literal|0
decl_stmt|,
name|queue_index
init|=
literal|0
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|next
init|=
name|NULL
decl_stmt|;
name|struct
name|buf_ring
modifier|*
name|br
init|=
name|NULL
decl_stmt|;
name|br
operator|=
name|wq
operator|->
name|br
expr_stmt|;
name|queue_index
operator|=
name|wq
operator|->
name|queue_index
expr_stmt|;
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
operator|(
name|IFF_DRV_RUNNING
operator||
name|IFF_DRV_OACTIVE
operator|)
operator|)
operator|!=
name|IFF_DRV_RUNNING
condition|)
block|{
if|if
condition|(
name|m
operator|!=
name|NULL
condition|)
name|status
operator|=
name|drbr_enqueue
argument_list|(
name|ifp
argument_list|,
name|br
argument_list|,
name|m
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
if|if
condition|(
name|m
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
name|status
operator|=
name|drbr_enqueue
argument_list|(
name|ifp
argument_list|,
name|br
argument_list|,
name|m
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|status
return|;
block|}
while|while
condition|(
operator|(
name|next
operator|=
name|drbr_peek
argument_list|(
name|ifp
argument_list|,
name|br
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|oce_tx
argument_list|(
name|sc
argument_list|,
operator|&
name|next
argument_list|,
name|queue_index
argument_list|)
condition|)
block|{
if|if
condition|(
name|next
operator|==
name|NULL
condition|)
block|{
name|drbr_advance
argument_list|(
name|ifp
argument_list|,
name|br
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|drbr_putback
argument_list|(
name|ifp
argument_list|,
name|br
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|wq
operator|->
name|tx_stats
operator|.
name|tx_stops
operator|++
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator||=
name|IFF_DRV_OACTIVE
expr_stmt|;
block|}
break|break;
block|}
name|drbr_advance
argument_list|(
name|ifp
argument_list|,
name|br
argument_list|)
expr_stmt|;
name|if_inc_counter
argument_list|(
name|ifp
argument_list|,
name|IFCOUNTER_OBYTES
argument_list|,
name|next
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|next
operator|->
name|m_flags
operator|&
name|M_MCAST
condition|)
name|if_inc_counter
argument_list|(
name|ifp
argument_list|,
name|IFCOUNTER_OMCASTS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ETHER_BPF_MTAP
argument_list|(
name|ifp
argument_list|,
name|next
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************  *			    Receive  routines functions 		     *  *****************************************************************************/
end_comment

begin_function
specifier|static
name|void
name|oce_correct_header
parameter_list|(
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|struct
name|nic_hwlro_cqe_part1
modifier|*
name|cqe1
parameter_list|,
name|struct
name|nic_hwlro_cqe_part2
modifier|*
name|cqe2
parameter_list|)
block|{
name|uint32_t
modifier|*
name|p
decl_stmt|;
name|struct
name|ether_header
modifier|*
name|eh
init|=
name|NULL
decl_stmt|;
name|struct
name|tcphdr
modifier|*
name|tcp_hdr
init|=
name|NULL
decl_stmt|;
name|struct
name|ip
modifier|*
name|ip4_hdr
init|=
name|NULL
decl_stmt|;
name|struct
name|ip6_hdr
modifier|*
name|ip6
init|=
name|NULL
decl_stmt|;
name|uint32_t
name|payload_len
init|=
literal|0
decl_stmt|;
name|eh
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ether_header
operator|*
argument_list|)
expr_stmt|;
comment|/* correct IP header */
if|if
condition|(
operator|!
name|cqe2
operator|->
name|ipv6_frame
condition|)
block|{
name|ip4_hdr
operator|=
operator|(
expr|struct
name|ip
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|eh
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|ether_header
argument_list|)
operator|)
expr_stmt|;
name|ip4_hdr
operator|->
name|ip_ttl
operator|=
name|cqe2
operator|->
name|frame_lifespan
expr_stmt|;
name|ip4_hdr
operator|->
name|ip_len
operator|=
name|htons
argument_list|(
name|cqe2
operator|->
name|coalesced_size
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|ether_header
argument_list|)
argument_list|)
expr_stmt|;
name|tcp_hdr
operator|=
operator|(
expr|struct
name|tcphdr
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|ip4_hdr
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|ip
argument_list|)
operator|)
expr_stmt|;
block|}
else|else
block|{
name|ip6
operator|=
operator|(
expr|struct
name|ip6_hdr
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|eh
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|ether_header
argument_list|)
operator|)
expr_stmt|;
name|ip6
operator|->
name|ip6_ctlun
operator|.
name|ip6_un1
operator|.
name|ip6_un1_hlim
operator|=
name|cqe2
operator|->
name|frame_lifespan
expr_stmt|;
name|payload_len
operator|=
name|cqe2
operator|->
name|coalesced_size
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|ether_header
argument_list|)
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|ip6_hdr
argument_list|)
expr_stmt|;
name|ip6
operator|->
name|ip6_ctlun
operator|.
name|ip6_un1
operator|.
name|ip6_un1_plen
operator|=
name|htons
argument_list|(
name|payload_len
argument_list|)
expr_stmt|;
name|tcp_hdr
operator|=
operator|(
expr|struct
name|tcphdr
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|ip6
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|ip6_hdr
argument_list|)
operator|)
expr_stmt|;
block|}
comment|/* correct tcp header */
name|tcp_hdr
operator|->
name|th_ack
operator|=
name|htonl
argument_list|(
name|cqe2
operator|->
name|tcp_ack_num
argument_list|)
expr_stmt|;
if|if
condition|(
name|cqe2
operator|->
name|push
condition|)
block|{
name|tcp_hdr
operator|->
name|th_flags
operator||=
name|TH_PUSH
expr_stmt|;
block|}
name|tcp_hdr
operator|->
name|th_win
operator|=
name|htons
argument_list|(
name|cqe2
operator|->
name|tcp_window
argument_list|)
expr_stmt|;
name|tcp_hdr
operator|->
name|th_sum
operator|=
literal|0xffff
expr_stmt|;
if|if
condition|(
name|cqe2
operator|->
name|ts_opt
condition|)
block|{
name|p
operator|=
operator|(
name|uint32_t
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|tcp_hdr
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|tcphdr
argument_list|)
operator|+
literal|2
operator|)
expr_stmt|;
operator|*
name|p
operator|=
name|cqe1
operator|->
name|tcp_timestamp_val
expr_stmt|;
operator|*
operator|(
name|p
operator|+
literal|1
operator|)
operator|=
name|cqe1
operator|->
name|tcp_timestamp_ecr
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|oce_rx_mbuf_chain
parameter_list|(
name|struct
name|oce_rq
modifier|*
name|rq
parameter_list|,
name|struct
name|oce_common_cqe_info
modifier|*
name|cqe_info
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|m
parameter_list|)
block|{
name|POCE_SOFTC
name|sc
init|=
operator|(
name|POCE_SOFTC
operator|)
name|rq
operator|->
name|parent
decl_stmt|;
name|uint32_t
name|i
init|=
literal|0
decl_stmt|,
name|frag_len
init|=
literal|0
decl_stmt|;
name|uint32_t
name|len
init|=
name|cqe_info
operator|->
name|pkt_size
decl_stmt|;
name|struct
name|oce_packet_desc
modifier|*
name|pd
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|tail
init|=
name|NULL
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cqe_info
operator|->
name|num_frags
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|rq
operator|->
name|ring
operator|->
name|cidx
operator|==
name|rq
operator|->
name|ring
operator|->
name|pidx
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"oce_rx_mbuf_chain: Invalid RX completion - Queue is empty\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|pd
operator|=
operator|&
name|rq
operator|->
name|pckts
index|[
name|rq
operator|->
name|ring
operator|->
name|cidx
index|]
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|rq
operator|->
name|tag
argument_list|,
name|pd
operator|->
name|map
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|rq
operator|->
name|tag
argument_list|,
name|pd
operator|->
name|map
argument_list|)
expr_stmt|;
name|RING_GET
argument_list|(
name|rq
operator|->
name|ring
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|rq
operator|->
name|pending
operator|--
expr_stmt|;
name|frag_len
operator|=
operator|(
name|len
operator|>
name|rq
operator|->
name|cfg
operator|.
name|frag_size
operator|)
condition|?
name|rq
operator|->
name|cfg
operator|.
name|frag_size
else|:
name|len
expr_stmt|;
name|pd
operator|->
name|mbuf
operator|->
name|m_len
operator|=
name|frag_len
expr_stmt|;
if|if
condition|(
name|tail
operator|!=
name|NULL
condition|)
block|{
comment|/* additional fragments */
name|pd
operator|->
name|mbuf
operator|->
name|m_flags
operator|&=
operator|~
name|M_PKTHDR
expr_stmt|;
name|tail
operator|->
name|m_next
operator|=
name|pd
operator|->
name|mbuf
expr_stmt|;
if|if
condition|(
name|rq
operator|->
name|islro
condition|)
name|tail
operator|->
name|m_nextpkt
operator|=
name|NULL
expr_stmt|;
name|tail
operator|=
name|pd
operator|->
name|mbuf
expr_stmt|;
block|}
else|else
block|{
comment|/* first fragment, fill out much of the packet header */
name|pd
operator|->
name|mbuf
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|len
expr_stmt|;
if|if
condition|(
name|rq
operator|->
name|islro
condition|)
name|pd
operator|->
name|mbuf
operator|->
name|m_nextpkt
operator|=
name|NULL
expr_stmt|;
name|pd
operator|->
name|mbuf
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|IF_CSUM_ENABLED
argument_list|(
name|sc
argument_list|)
condition|)
block|{
if|if
condition|(
name|cqe_info
operator|->
name|l4_cksum_pass
condition|)
block|{
if|if
condition|(
operator|!
name|cqe_info
operator|->
name|ipv6_frame
condition|)
block|{
comment|/* IPV4 */
name|pd
operator|->
name|mbuf
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator||=
operator|(
name|CSUM_DATA_VALID
operator||
name|CSUM_PSEUDO_HDR
operator|)
expr_stmt|;
block|}
else|else
block|{
comment|/* IPV6 frame */
if|if
condition|(
name|rq
operator|->
name|islro
condition|)
block|{
name|pd
operator|->
name|mbuf
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator||=
operator|(
name|CSUM_DATA_VALID
operator||
name|CSUM_PSEUDO_HDR
operator|)
expr_stmt|;
block|}
block|}
name|pd
operator|->
name|mbuf
operator|->
name|m_pkthdr
operator|.
name|csum_data
operator|=
literal|0xffff
expr_stmt|;
block|}
if|if
condition|(
name|cqe_info
operator|->
name|ip_cksum_pass
condition|)
block|{
name|pd
operator|->
name|mbuf
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator||=
operator|(
name|CSUM_IP_CHECKED
operator||
name|CSUM_IP_VALID
operator|)
expr_stmt|;
block|}
block|}
operator|*
name|m
operator|=
name|tail
operator|=
name|pd
operator|->
name|mbuf
expr_stmt|;
block|}
name|pd
operator|->
name|mbuf
operator|=
name|NULL
expr_stmt|;
name|len
operator|-=
name|frag_len
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|oce_rx_lro
parameter_list|(
name|struct
name|oce_rq
modifier|*
name|rq
parameter_list|,
name|struct
name|nic_hwlro_singleton_cqe
modifier|*
name|cqe
parameter_list|,
name|struct
name|nic_hwlro_cqe_part2
modifier|*
name|cqe2
parameter_list|)
block|{
name|POCE_SOFTC
name|sc
init|=
operator|(
name|POCE_SOFTC
operator|)
name|rq
operator|->
name|parent
decl_stmt|;
name|struct
name|nic_hwlro_cqe_part1
modifier|*
name|cqe1
init|=
name|NULL
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
init|=
name|NULL
decl_stmt|;
name|struct
name|oce_common_cqe_info
name|cq_info
decl_stmt|;
comment|/* parse cqe */
if|if
condition|(
name|cqe2
operator|==
name|NULL
condition|)
block|{
name|cq_info
operator|.
name|pkt_size
operator|=
name|cqe
operator|->
name|pkt_size
expr_stmt|;
name|cq_info
operator|.
name|vtag
operator|=
name|cqe
operator|->
name|vlan_tag
expr_stmt|;
name|cq_info
operator|.
name|l4_cksum_pass
operator|=
name|cqe
operator|->
name|l4_cksum_pass
expr_stmt|;
name|cq_info
operator|.
name|ip_cksum_pass
operator|=
name|cqe
operator|->
name|ip_cksum_pass
expr_stmt|;
name|cq_info
operator|.
name|ipv6_frame
operator|=
name|cqe
operator|->
name|ipv6_frame
expr_stmt|;
name|cq_info
operator|.
name|vtp
operator|=
name|cqe
operator|->
name|vtp
expr_stmt|;
name|cq_info
operator|.
name|qnq
operator|=
name|cqe
operator|->
name|qnq
expr_stmt|;
block|}
else|else
block|{
name|cqe1
operator|=
operator|(
expr|struct
name|nic_hwlro_cqe_part1
operator|*
operator|)
name|cqe
expr_stmt|;
name|cq_info
operator|.
name|pkt_size
operator|=
name|cqe2
operator|->
name|coalesced_size
expr_stmt|;
name|cq_info
operator|.
name|vtag
operator|=
name|cqe2
operator|->
name|vlan_tag
expr_stmt|;
name|cq_info
operator|.
name|l4_cksum_pass
operator|=
name|cqe2
operator|->
name|l4_cksum_pass
expr_stmt|;
name|cq_info
operator|.
name|ip_cksum_pass
operator|=
name|cqe2
operator|->
name|ip_cksum_pass
expr_stmt|;
name|cq_info
operator|.
name|ipv6_frame
operator|=
name|cqe2
operator|->
name|ipv6_frame
expr_stmt|;
name|cq_info
operator|.
name|vtp
operator|=
name|cqe2
operator|->
name|vtp
expr_stmt|;
name|cq_info
operator|.
name|qnq
operator|=
name|cqe1
operator|->
name|qnq
expr_stmt|;
block|}
name|cq_info
operator|.
name|vtag
operator|=
name|BSWAP_16
argument_list|(
name|cq_info
operator|.
name|vtag
argument_list|)
expr_stmt|;
name|cq_info
operator|.
name|num_frags
operator|=
name|cq_info
operator|.
name|pkt_size
operator|/
name|rq
operator|->
name|cfg
operator|.
name|frag_size
expr_stmt|;
if|if
condition|(
name|cq_info
operator|.
name|pkt_size
operator|%
name|rq
operator|->
name|cfg
operator|.
name|frag_size
condition|)
name|cq_info
operator|.
name|num_frags
operator|++
expr_stmt|;
name|oce_rx_mbuf_chain
argument_list|(
name|rq
argument_list|,
operator|&
name|cq_info
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
condition|)
block|{
if|if
condition|(
name|cqe2
condition|)
block|{
comment|//assert(cqe2->valid != 0);
comment|//assert(cqe2->cqe_type != 2);
name|oce_correct_header
argument_list|(
name|m
argument_list|,
name|cqe1
argument_list|,
name|cqe2
argument_list|)
expr_stmt|;
block|}
name|m
operator|->
name|m_pkthdr
operator|.
name|rcvif
operator|=
name|sc
operator|->
name|ifp
expr_stmt|;
if|#
directive|if
name|__FreeBSD_version
operator|>=
literal|800000
if|if
condition|(
name|rq
operator|->
name|queue_index
condition|)
name|m
operator|->
name|m_pkthdr
operator|.
name|flowid
operator|=
operator|(
name|rq
operator|->
name|queue_index
operator|-
literal|1
operator|)
expr_stmt|;
else|else
name|m
operator|->
name|m_pkthdr
operator|.
name|flowid
operator|=
name|rq
operator|->
name|queue_index
expr_stmt|;
name|M_HASHTYPE_SET
argument_list|(
name|m
argument_list|,
name|M_HASHTYPE_OPAQUE
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* This deternies if vlan tag is Valid */
if|if
condition|(
name|cq_info
operator|.
name|vtp
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|function_mode
operator|&
name|FNM_FLEX10_MODE
condition|)
block|{
comment|/* FLEX10. If QnQ is not set, neglect VLAN */
if|if
condition|(
name|cq_info
operator|.
name|qnq
condition|)
block|{
name|m
operator|->
name|m_pkthdr
operator|.
name|ether_vtag
operator|=
name|cq_info
operator|.
name|vtag
expr_stmt|;
name|m
operator|->
name|m_flags
operator||=
name|M_VLANTAG
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|sc
operator|->
name|pvid
operator|!=
operator|(
name|cq_info
operator|.
name|vtag
operator|&
name|VLAN_VID_MASK
operator|)
condition|)
block|{
comment|/* In UMC mode generally pvid will be striped by 				   hw. But in some cases we have seen it comes 				   with pvid. So if pvid == vlan, neglect vlan. 				 */
name|m
operator|->
name|m_pkthdr
operator|.
name|ether_vtag
operator|=
name|cq_info
operator|.
name|vtag
expr_stmt|;
name|m
operator|->
name|m_flags
operator||=
name|M_VLANTAG
expr_stmt|;
block|}
block|}
name|if_inc_counter
argument_list|(
name|sc
operator|->
name|ifp
argument_list|,
name|IFCOUNTER_IPACKETS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
call|(
modifier|*
name|sc
operator|->
name|ifp
operator|->
name|if_input
call|)
argument_list|(
name|sc
operator|->
name|ifp
argument_list|,
name|m
argument_list|)
expr_stmt|;
comment|/* Update rx stats per queue */
name|rq
operator|->
name|rx_stats
operator|.
name|rx_pkts
operator|++
expr_stmt|;
name|rq
operator|->
name|rx_stats
operator|.
name|rx_bytes
operator|+=
name|cq_info
operator|.
name|pkt_size
expr_stmt|;
name|rq
operator|->
name|rx_stats
operator|.
name|rx_frags
operator|+=
name|cq_info
operator|.
name|num_frags
expr_stmt|;
name|rq
operator|->
name|rx_stats
operator|.
name|rx_ucast_pkts
operator|++
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|oce_rx
parameter_list|(
name|struct
name|oce_rq
modifier|*
name|rq
parameter_list|,
name|struct
name|oce_nic_rx_cqe
modifier|*
name|cqe
parameter_list|)
block|{
name|POCE_SOFTC
name|sc
init|=
operator|(
name|POCE_SOFTC
operator|)
name|rq
operator|->
name|parent
decl_stmt|;
name|int
name|len
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
init|=
name|NULL
decl_stmt|;
name|struct
name|oce_common_cqe_info
name|cq_info
decl_stmt|;
name|uint16_t
name|vtag
init|=
literal|0
decl_stmt|;
comment|/* Is it a flush compl that has no data */
if|if
condition|(
operator|!
name|cqe
operator|->
name|u0
operator|.
name|s
operator|.
name|num_fragments
condition|)
goto|goto
name|exit
goto|;
name|len
operator|=
name|cqe
operator|->
name|u0
operator|.
name|s
operator|.
name|pkt_size
expr_stmt|;
if|if
condition|(
operator|!
name|len
condition|)
block|{
comment|/*partial DMA workaround for Lancer*/
name|oce_discard_rx_comp
argument_list|(
name|rq
argument_list|,
name|cqe
operator|->
name|u0
operator|.
name|s
operator|.
name|num_fragments
argument_list|)
expr_stmt|;
goto|goto
name|exit
goto|;
block|}
if|if
condition|(
operator|!
name|oce_cqe_portid_valid
argument_list|(
name|sc
argument_list|,
name|cqe
argument_list|)
condition|)
block|{
name|oce_discard_rx_comp
argument_list|(
name|rq
argument_list|,
name|cqe
operator|->
name|u0
operator|.
name|s
operator|.
name|num_fragments
argument_list|)
expr_stmt|;
goto|goto
name|exit
goto|;
block|}
comment|/* Get vlan_tag value */
if|if
condition|(
name|IS_BE
argument_list|(
name|sc
argument_list|)
operator|||
name|IS_SH
argument_list|(
name|sc
argument_list|)
condition|)
name|vtag
operator|=
name|BSWAP_16
argument_list|(
name|cqe
operator|->
name|u0
operator|.
name|s
operator|.
name|vlan_tag
argument_list|)
expr_stmt|;
else|else
name|vtag
operator|=
name|cqe
operator|->
name|u0
operator|.
name|s
operator|.
name|vlan_tag
expr_stmt|;
name|cq_info
operator|.
name|l4_cksum_pass
operator|=
name|cqe
operator|->
name|u0
operator|.
name|s
operator|.
name|l4_cksum_pass
expr_stmt|;
name|cq_info
operator|.
name|ip_cksum_pass
operator|=
name|cqe
operator|->
name|u0
operator|.
name|s
operator|.
name|ip_cksum_pass
expr_stmt|;
name|cq_info
operator|.
name|ipv6_frame
operator|=
name|cqe
operator|->
name|u0
operator|.
name|s
operator|.
name|ip_ver
expr_stmt|;
name|cq_info
operator|.
name|num_frags
operator|=
name|cqe
operator|->
name|u0
operator|.
name|s
operator|.
name|num_fragments
expr_stmt|;
name|cq_info
operator|.
name|pkt_size
operator|=
name|cqe
operator|->
name|u0
operator|.
name|s
operator|.
name|pkt_size
expr_stmt|;
name|oce_rx_mbuf_chain
argument_list|(
name|rq
argument_list|,
operator|&
name|cq_info
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
condition|)
block|{
name|m
operator|->
name|m_pkthdr
operator|.
name|rcvif
operator|=
name|sc
operator|->
name|ifp
expr_stmt|;
if|#
directive|if
name|__FreeBSD_version
operator|>=
literal|800000
if|if
condition|(
name|rq
operator|->
name|queue_index
condition|)
name|m
operator|->
name|m_pkthdr
operator|.
name|flowid
operator|=
operator|(
name|rq
operator|->
name|queue_index
operator|-
literal|1
operator|)
expr_stmt|;
else|else
name|m
operator|->
name|m_pkthdr
operator|.
name|flowid
operator|=
name|rq
operator|->
name|queue_index
expr_stmt|;
name|M_HASHTYPE_SET
argument_list|(
name|m
argument_list|,
name|M_HASHTYPE_OPAQUE
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* This deternies if vlan tag is Valid */
if|if
condition|(
name|oce_cqe_vtp_valid
argument_list|(
name|sc
argument_list|,
name|cqe
argument_list|)
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|function_mode
operator|&
name|FNM_FLEX10_MODE
condition|)
block|{
comment|/* FLEX10. If QnQ is not set, neglect VLAN */
if|if
condition|(
name|cqe
operator|->
name|u0
operator|.
name|s
operator|.
name|qnq
condition|)
block|{
name|m
operator|->
name|m_pkthdr
operator|.
name|ether_vtag
operator|=
name|vtag
expr_stmt|;
name|m
operator|->
name|m_flags
operator||=
name|M_VLANTAG
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|sc
operator|->
name|pvid
operator|!=
operator|(
name|vtag
operator|&
name|VLAN_VID_MASK
operator|)
condition|)
block|{
comment|/* In UMC mode generally pvid will be striped by 				   hw. But in some cases we have seen it comes 				   with pvid. So if pvid == vlan, neglect vlan. 				*/
name|m
operator|->
name|m_pkthdr
operator|.
name|ether_vtag
operator|=
name|vtag
expr_stmt|;
name|m
operator|->
name|m_flags
operator||=
name|M_VLANTAG
expr_stmt|;
block|}
block|}
name|if_inc_counter
argument_list|(
name|sc
operator|->
name|ifp
argument_list|,
name|IFCOUNTER_IPACKETS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|INET6
argument_list|)
operator|||
name|defined
argument_list|(
name|INET
argument_list|)
comment|/* Try to queue to LRO */
if|if
condition|(
name|IF_LRO_ENABLED
argument_list|(
name|sc
argument_list|)
operator|&&
operator|(
name|cqe
operator|->
name|u0
operator|.
name|s
operator|.
name|ip_cksum_pass
operator|)
operator|&&
operator|(
name|cqe
operator|->
name|u0
operator|.
name|s
operator|.
name|l4_cksum_pass
operator|)
operator|&&
operator|(
operator|!
name|cqe
operator|->
name|u0
operator|.
name|s
operator|.
name|ip_ver
operator|)
operator|&&
operator|(
name|rq
operator|->
name|lro
operator|.
name|lro_cnt
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|tcp_lro_rx
argument_list|(
operator|&
name|rq
operator|->
name|lro
argument_list|,
name|m
argument_list|,
literal|0
argument_list|)
operator|==
literal|0
condition|)
block|{
name|rq
operator|->
name|lro_pkts_queued
operator|++
expr_stmt|;
goto|goto
name|post_done
goto|;
block|}
comment|/* If LRO posting fails then try to post to STACK */
block|}
endif|#
directive|endif
call|(
modifier|*
name|sc
operator|->
name|ifp
operator|->
name|if_input
call|)
argument_list|(
name|sc
operator|->
name|ifp
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|INET6
argument_list|)
operator|||
name|defined
argument_list|(
name|INET
argument_list|)
name|post_done
label|:
endif|#
directive|endif
comment|/* Update rx stats per queue */
name|rq
operator|->
name|rx_stats
operator|.
name|rx_pkts
operator|++
expr_stmt|;
name|rq
operator|->
name|rx_stats
operator|.
name|rx_bytes
operator|+=
name|cqe
operator|->
name|u0
operator|.
name|s
operator|.
name|pkt_size
expr_stmt|;
name|rq
operator|->
name|rx_stats
operator|.
name|rx_frags
operator|+=
name|cqe
operator|->
name|u0
operator|.
name|s
operator|.
name|num_fragments
expr_stmt|;
if|if
condition|(
name|cqe
operator|->
name|u0
operator|.
name|s
operator|.
name|pkt_type
operator|==
name|OCE_MULTICAST_PACKET
condition|)
name|rq
operator|->
name|rx_stats
operator|.
name|rx_mcast_pkts
operator|++
expr_stmt|;
if|if
condition|(
name|cqe
operator|->
name|u0
operator|.
name|s
operator|.
name|pkt_type
operator|==
name|OCE_UNICAST_PACKET
condition|)
name|rq
operator|->
name|rx_stats
operator|.
name|rx_ucast_pkts
operator|++
expr_stmt|;
block|}
name|exit
label|:
return|return;
block|}
end_function

begin_function
name|void
name|oce_discard_rx_comp
parameter_list|(
name|struct
name|oce_rq
modifier|*
name|rq
parameter_list|,
name|int
name|num_frags
parameter_list|)
block|{
name|uint32_t
name|i
init|=
literal|0
decl_stmt|;
name|struct
name|oce_packet_desc
modifier|*
name|pd
decl_stmt|;
name|POCE_SOFTC
name|sc
init|=
operator|(
name|POCE_SOFTC
operator|)
name|rq
operator|->
name|parent
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_frags
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|rq
operator|->
name|ring
operator|->
name|cidx
operator|==
name|rq
operator|->
name|ring
operator|->
name|pidx
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"oce_discard_rx_comp: Invalid RX completion - Queue is empty\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|pd
operator|=
operator|&
name|rq
operator|->
name|pckts
index|[
name|rq
operator|->
name|ring
operator|->
name|cidx
index|]
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|rq
operator|->
name|tag
argument_list|,
name|pd
operator|->
name|map
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|rq
operator|->
name|tag
argument_list|,
name|pd
operator|->
name|map
argument_list|)
expr_stmt|;
if|if
condition|(
name|pd
operator|->
name|mbuf
operator|!=
name|NULL
condition|)
block|{
name|m_freem
argument_list|(
name|pd
operator|->
name|mbuf
argument_list|)
expr_stmt|;
name|pd
operator|->
name|mbuf
operator|=
name|NULL
expr_stmt|;
block|}
name|RING_GET
argument_list|(
name|rq
operator|->
name|ring
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|rq
operator|->
name|pending
operator|--
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|oce_cqe_vtp_valid
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
name|struct
name|oce_nic_rx_cqe
modifier|*
name|cqe
parameter_list|)
block|{
name|struct
name|oce_nic_rx_cqe_v1
modifier|*
name|cqe_v1
decl_stmt|;
name|int
name|vtp
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|be3_native
condition|)
block|{
name|cqe_v1
operator|=
operator|(
expr|struct
name|oce_nic_rx_cqe_v1
operator|*
operator|)
name|cqe
expr_stmt|;
name|vtp
operator|=
name|cqe_v1
operator|->
name|u0
operator|.
name|s
operator|.
name|vlan_tag_present
expr_stmt|;
block|}
else|else
name|vtp
operator|=
name|cqe
operator|->
name|u0
operator|.
name|s
operator|.
name|vlan_tag_present
expr_stmt|;
return|return
name|vtp
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|oce_cqe_portid_valid
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
name|struct
name|oce_nic_rx_cqe
modifier|*
name|cqe
parameter_list|)
block|{
name|struct
name|oce_nic_rx_cqe_v1
modifier|*
name|cqe_v1
decl_stmt|;
name|int
name|port_id
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|be3_native
operator|&&
operator|(
name|IS_BE
argument_list|(
name|sc
argument_list|)
operator|||
name|IS_SH
argument_list|(
name|sc
argument_list|)
operator|)
condition|)
block|{
name|cqe_v1
operator|=
operator|(
expr|struct
name|oce_nic_rx_cqe_v1
operator|*
operator|)
name|cqe
expr_stmt|;
name|port_id
operator|=
name|cqe_v1
operator|->
name|u0
operator|.
name|s
operator|.
name|port
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|port_id
operator|!=
name|port_id
condition|)
return|return
literal|0
return|;
block|}
else|else
empty_stmt|;
comment|/* For BE3 legacy and Lancer this is dummy */
return|return
literal|1
return|;
block|}
end_function

begin_if
if|#
directive|if
name|defined
argument_list|(
name|INET6
argument_list|)
operator|||
name|defined
argument_list|(
name|INET
argument_list|)
end_if

begin_function
name|void
name|oce_rx_flush_lro
parameter_list|(
name|struct
name|oce_rq
modifier|*
name|rq
parameter_list|)
block|{
name|struct
name|lro_ctrl
modifier|*
name|lro
init|=
operator|&
name|rq
operator|->
name|lro
decl_stmt|;
name|POCE_SOFTC
name|sc
init|=
operator|(
name|POCE_SOFTC
operator|)
name|rq
operator|->
name|parent
decl_stmt|;
if|if
condition|(
operator|!
name|IF_LRO_ENABLED
argument_list|(
name|sc
argument_list|)
condition|)
return|return;
name|tcp_lro_flush_all
argument_list|(
name|lro
argument_list|)
expr_stmt|;
name|rq
operator|->
name|lro_pkts_queued
operator|=
literal|0
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|oce_init_lro
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|)
block|{
name|struct
name|lro_ctrl
modifier|*
name|lro
init|=
name|NULL
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|,
name|rc
init|=
literal|0
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|nrqs
condition|;
name|i
operator|++
control|)
block|{
name|lro
operator|=
operator|&
name|sc
operator|->
name|rq
index|[
name|i
index|]
operator|->
name|lro
expr_stmt|;
name|rc
operator|=
name|tcp_lro_init
argument_list|(
name|lro
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"LRO init failed\n"
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
name|lro
operator|->
name|ifp
operator|=
name|sc
operator|->
name|ifp
expr_stmt|;
block|}
return|return
name|rc
return|;
block|}
end_function

begin_function
name|void
name|oce_free_lro
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|)
block|{
name|struct
name|lro_ctrl
modifier|*
name|lro
init|=
name|NULL
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|nrqs
condition|;
name|i
operator|++
control|)
block|{
name|lro
operator|=
operator|&
name|sc
operator|->
name|rq
index|[
name|i
index|]
operator|->
name|lro
expr_stmt|;
if|if
condition|(
name|lro
condition|)
name|tcp_lro_free
argument_list|(
name|lro
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|int
name|oce_alloc_rx_bufs
parameter_list|(
name|struct
name|oce_rq
modifier|*
name|rq
parameter_list|,
name|int
name|count
parameter_list|)
block|{
name|POCE_SOFTC
name|sc
init|=
operator|(
name|POCE_SOFTC
operator|)
name|rq
operator|->
name|parent
decl_stmt|;
name|int
name|i
decl_stmt|,
name|in
decl_stmt|,
name|rc
decl_stmt|;
name|struct
name|oce_packet_desc
modifier|*
name|pd
decl_stmt|;
name|bus_dma_segment_t
name|segs
index|[
literal|6
index|]
decl_stmt|;
name|int
name|nsegs
decl_stmt|,
name|added
init|=
literal|0
decl_stmt|;
name|struct
name|oce_nic_rqe
modifier|*
name|rqe
decl_stmt|;
name|pd_rxulp_db_t
name|rxdb_reg
decl_stmt|;
name|uint32_t
name|val
init|=
literal|0
decl_stmt|;
name|uint32_t
name|oce_max_rq_posts
init|=
literal|64
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|rxdb_reg
argument_list|,
sizeof|sizeof
argument_list|(
name|pd_rxulp_db_t
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
block|{
name|in
operator|=
operator|(
name|rq
operator|->
name|ring
operator|->
name|pidx
operator|+
literal|1
operator|)
operator|%
name|OCE_RQ_PACKET_ARRAY_SIZE
expr_stmt|;
name|pd
operator|=
operator|&
name|rq
operator|->
name|pckts
index|[
name|rq
operator|->
name|ring
operator|->
name|pidx
index|]
expr_stmt|;
name|pd
operator|->
name|mbuf
operator|=
name|m_getjcl
argument_list|(
name|M_NOWAIT
argument_list|,
name|MT_DATA
argument_list|,
name|M_PKTHDR
argument_list|,
name|oce_rq_buf_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|pd
operator|->
name|mbuf
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"mbuf allocation failed, size = %d\n"
argument_list|,
name|oce_rq_buf_size
argument_list|)
expr_stmt|;
break|break;
block|}
name|pd
operator|->
name|mbuf
operator|->
name|m_nextpkt
operator|=
name|NULL
expr_stmt|;
name|pd
operator|->
name|mbuf
operator|->
name|m_len
operator|=
name|pd
operator|->
name|mbuf
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|rq
operator|->
name|cfg
operator|.
name|frag_size
expr_stmt|;
name|rc
operator|=
name|bus_dmamap_load_mbuf_sg
argument_list|(
name|rq
operator|->
name|tag
argument_list|,
name|pd
operator|->
name|map
argument_list|,
name|pd
operator|->
name|mbuf
argument_list|,
name|segs
argument_list|,
operator|&
name|nsegs
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|m_free
argument_list|(
name|pd
operator|->
name|mbuf
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"bus_dmamap_load_mbuf_sg failed rc = %d\n"
argument_list|,
name|rc
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|nsegs
operator|!=
literal|1
condition|)
block|{
name|i
operator|--
expr_stmt|;
continue|continue;
block|}
name|bus_dmamap_sync
argument_list|(
name|rq
operator|->
name|tag
argument_list|,
name|pd
operator|->
name|map
argument_list|,
name|BUS_DMASYNC_PREREAD
argument_list|)
expr_stmt|;
name|rqe
operator|=
name|RING_GET_PRODUCER_ITEM_VA
argument_list|(
name|rq
operator|->
name|ring
argument_list|,
expr|struct
name|oce_nic_rqe
argument_list|)
expr_stmt|;
name|rqe
operator|->
name|u0
operator|.
name|s
operator|.
name|frag_pa_hi
operator|=
name|ADDR_HI
argument_list|(
name|segs
index|[
literal|0
index|]
operator|.
name|ds_addr
argument_list|)
expr_stmt|;
name|rqe
operator|->
name|u0
operator|.
name|s
operator|.
name|frag_pa_lo
operator|=
name|ADDR_LO
argument_list|(
name|segs
index|[
literal|0
index|]
operator|.
name|ds_addr
argument_list|)
expr_stmt|;
name|DW_SWAP
argument_list|(
name|u32ptr
argument_list|(
name|rqe
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|oce_nic_rqe
argument_list|)
argument_list|)
expr_stmt|;
name|RING_PUT
argument_list|(
name|rq
operator|->
name|ring
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|added
operator|++
expr_stmt|;
name|rq
operator|->
name|pending
operator|++
expr_stmt|;
block|}
name|oce_max_rq_posts
operator|=
name|sc
operator|->
name|enable_hwlro
condition|?
name|OCE_HWLRO_MAX_RQ_POSTS
else|:
name|OCE_MAX_RQ_POSTS
expr_stmt|;
if|if
condition|(
name|added
operator|!=
literal|0
condition|)
block|{
for|for
control|(
name|i
operator|=
name|added
operator|/
name|oce_max_rq_posts
init|;
name|i
operator|>
literal|0
condition|;
name|i
operator|--
control|)
block|{
name|rxdb_reg
operator|.
name|bits
operator|.
name|num_posted
operator|=
name|oce_max_rq_posts
expr_stmt|;
name|rxdb_reg
operator|.
name|bits
operator|.
name|qid
operator|=
name|rq
operator|->
name|rq_id
expr_stmt|;
if|if
condition|(
name|rq
operator|->
name|islro
condition|)
block|{
name|val
operator||=
name|rq
operator|->
name|rq_id
operator|&
name|DB_LRO_RQ_ID_MASK
expr_stmt|;
name|val
operator||=
name|oce_max_rq_posts
operator|<<
literal|16
expr_stmt|;
name|OCE_WRITE_REG32
argument_list|(
name|sc
argument_list|,
name|db
argument_list|,
name|DB_OFFSET
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|OCE_WRITE_REG32
argument_list|(
name|sc
argument_list|,
name|db
argument_list|,
name|PD_RXULP_DB
argument_list|,
name|rxdb_reg
operator|.
name|dw0
argument_list|)
expr_stmt|;
block|}
name|added
operator|-=
name|oce_max_rq_posts
expr_stmt|;
block|}
if|if
condition|(
name|added
operator|>
literal|0
condition|)
block|{
name|rxdb_reg
operator|.
name|bits
operator|.
name|qid
operator|=
name|rq
operator|->
name|rq_id
expr_stmt|;
name|rxdb_reg
operator|.
name|bits
operator|.
name|num_posted
operator|=
name|added
expr_stmt|;
if|if
condition|(
name|rq
operator|->
name|islro
condition|)
block|{
name|val
operator||=
name|rq
operator|->
name|rq_id
operator|&
name|DB_LRO_RQ_ID_MASK
expr_stmt|;
name|val
operator||=
name|added
operator|<<
literal|16
expr_stmt|;
name|OCE_WRITE_REG32
argument_list|(
name|sc
argument_list|,
name|db
argument_list|,
name|DB_OFFSET
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|OCE_WRITE_REG32
argument_list|(
name|sc
argument_list|,
name|db
argument_list|,
name|PD_RXULP_DB
argument_list|,
name|rxdb_reg
operator|.
name|dw0
argument_list|)
expr_stmt|;
block|}
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|oce_check_rx_bufs
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
name|uint32_t
name|num_cqes
parameter_list|,
name|struct
name|oce_rq
modifier|*
name|rq
parameter_list|)
block|{
if|if
condition|(
name|num_cqes
condition|)
block|{
name|oce_arm_cq
argument_list|(
name|sc
argument_list|,
name|rq
operator|->
name|cq
operator|->
name|cq_id
argument_list|,
name|num_cqes
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sc
operator|->
name|enable_hwlro
condition|)
block|{
if|if
condition|(
operator|(
name|OCE_RQ_PACKET_ARRAY_SIZE
operator|-
name|rq
operator|->
name|pending
operator|)
operator|>
literal|1
condition|)
name|oce_alloc_rx_bufs
argument_list|(
name|rq
argument_list|,
operator|(
operator|(
name|OCE_RQ_PACKET_ARRAY_SIZE
operator|-
name|rq
operator|->
name|pending
operator|)
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|(
name|OCE_RQ_PACKET_ARRAY_SIZE
operator|-
literal|1
operator|-
name|rq
operator|->
name|pending
operator|)
operator|>
literal|64
condition|)
name|oce_alloc_rx_bufs
argument_list|(
name|rq
argument_list|,
literal|64
argument_list|)
expr_stmt|;
block|}
block|}
return|return;
block|}
end_function

begin_function
name|uint16_t
name|oce_rq_handler_lro
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|oce_rq
modifier|*
name|rq
init|=
operator|(
expr|struct
name|oce_rq
operator|*
operator|)
name|arg
decl_stmt|;
name|struct
name|oce_cq
modifier|*
name|cq
init|=
name|rq
operator|->
name|cq
decl_stmt|;
name|POCE_SOFTC
name|sc
init|=
name|rq
operator|->
name|parent
decl_stmt|;
name|struct
name|nic_hwlro_singleton_cqe
modifier|*
name|cqe
decl_stmt|;
name|struct
name|nic_hwlro_cqe_part2
modifier|*
name|cqe2
decl_stmt|;
name|int
name|num_cqes
init|=
literal|0
decl_stmt|;
name|LOCK
argument_list|(
operator|&
name|rq
operator|->
name|rx_lock
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|cq
operator|->
name|ring
operator|->
name|dma
operator|.
name|tag
argument_list|,
name|cq
operator|->
name|ring
operator|->
name|dma
operator|.
name|map
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
name|cqe
operator|=
name|RING_GET_CONSUMER_ITEM_VA
argument_list|(
name|cq
operator|->
name|ring
argument_list|,
expr|struct
name|nic_hwlro_singleton_cqe
argument_list|)
expr_stmt|;
while|while
condition|(
name|cqe
operator|->
name|valid
condition|)
block|{
if|if
condition|(
name|cqe
operator|->
name|cqe_type
operator|==
literal|0
condition|)
block|{
comment|/* singleton cqe */
comment|/* we should not get singleton cqe after cqe1 on same rq */
if|if
condition|(
name|rq
operator|->
name|cqe_firstpart
operator|!=
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Got singleton cqe after cqe1 \n"
argument_list|)
expr_stmt|;
goto|goto
name|exit_rq_handler_lro
goto|;
block|}
if|if
condition|(
name|cqe
operator|->
name|error
operator|!=
literal|0
condition|)
block|{
name|rq
operator|->
name|rx_stats
operator|.
name|rxcp_err
operator|++
expr_stmt|;
name|if_inc_counter
argument_list|(
name|sc
operator|->
name|ifp
argument_list|,
name|IFCOUNTER_IERRORS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|oce_rx_lro
argument_list|(
name|rq
argument_list|,
name|cqe
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|rq
operator|->
name|rx_stats
operator|.
name|rx_compl
operator|++
expr_stmt|;
name|cqe
operator|->
name|valid
operator|=
literal|0
expr_stmt|;
name|RING_GET
argument_list|(
name|cq
operator|->
name|ring
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|num_cqes
operator|++
expr_stmt|;
if|if
condition|(
name|num_cqes
operator|>=
operator|(
name|IS_XE201
argument_list|(
name|sc
argument_list|)
condition|?
literal|8
else|:
name|oce_max_rsp_handled
operator|)
condition|)
break|break;
block|}
elseif|else
if|if
condition|(
name|cqe
operator|->
name|cqe_type
operator|==
literal|0x1
condition|)
block|{
comment|/* first part */
comment|/* we should not get cqe1 after cqe1 on same rq */
if|if
condition|(
name|rq
operator|->
name|cqe_firstpart
operator|!=
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Got cqe1 after cqe1 \n"
argument_list|)
expr_stmt|;
goto|goto
name|exit_rq_handler_lro
goto|;
block|}
name|rq
operator|->
name|cqe_firstpart
operator|=
operator|(
expr|struct
name|nic_hwlro_cqe_part1
operator|*
operator|)
name|cqe
expr_stmt|;
name|RING_GET
argument_list|(
name|cq
operator|->
name|ring
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cqe
operator|->
name|cqe_type
operator|==
literal|0x2
condition|)
block|{
comment|/* second part */
name|cqe2
operator|=
operator|(
expr|struct
name|nic_hwlro_cqe_part2
operator|*
operator|)
name|cqe
expr_stmt|;
if|if
condition|(
name|cqe2
operator|->
name|error
operator|!=
literal|0
condition|)
block|{
name|rq
operator|->
name|rx_stats
operator|.
name|rxcp_err
operator|++
expr_stmt|;
name|if_inc_counter
argument_list|(
name|sc
operator|->
name|ifp
argument_list|,
name|IFCOUNTER_IERRORS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* We should not get cqe2 without cqe1 */
if|if
condition|(
name|rq
operator|->
name|cqe_firstpart
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Got cqe2 without cqe1 \n"
argument_list|)
expr_stmt|;
goto|goto
name|exit_rq_handler_lro
goto|;
block|}
name|oce_rx_lro
argument_list|(
name|rq
argument_list|,
operator|(
expr|struct
name|nic_hwlro_singleton_cqe
operator|*
operator|)
name|rq
operator|->
name|cqe_firstpart
argument_list|,
name|cqe2
argument_list|)
expr_stmt|;
name|rq
operator|->
name|rx_stats
operator|.
name|rx_compl
operator|++
expr_stmt|;
name|rq
operator|->
name|cqe_firstpart
operator|->
name|valid
operator|=
literal|0
expr_stmt|;
name|cqe2
operator|->
name|valid
operator|=
literal|0
expr_stmt|;
name|rq
operator|->
name|cqe_firstpart
operator|=
name|NULL
expr_stmt|;
name|RING_GET
argument_list|(
name|cq
operator|->
name|ring
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|num_cqes
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|num_cqes
operator|>=
operator|(
name|IS_XE201
argument_list|(
name|sc
argument_list|)
condition|?
literal|8
else|:
name|oce_max_rsp_handled
operator|)
condition|)
break|break;
block|}
name|bus_dmamap_sync
argument_list|(
name|cq
operator|->
name|ring
operator|->
name|dma
operator|.
name|tag
argument_list|,
name|cq
operator|->
name|ring
operator|->
name|dma
operator|.
name|map
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
name|cqe
operator|=
name|RING_GET_CONSUMER_ITEM_VA
argument_list|(
name|cq
operator|->
name|ring
argument_list|,
expr|struct
name|nic_hwlro_singleton_cqe
argument_list|)
expr_stmt|;
block|}
name|oce_check_rx_bufs
argument_list|(
name|sc
argument_list|,
name|num_cqes
argument_list|,
name|rq
argument_list|)
expr_stmt|;
name|exit_rq_handler_lro
label|:
name|UNLOCK
argument_list|(
operator|&
name|rq
operator|->
name|rx_lock
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Handle the Completion Queue for receive */
end_comment

begin_function
name|uint16_t
name|oce_rq_handler
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|oce_rq
modifier|*
name|rq
init|=
operator|(
expr|struct
name|oce_rq
operator|*
operator|)
name|arg
decl_stmt|;
name|struct
name|oce_cq
modifier|*
name|cq
init|=
name|rq
operator|->
name|cq
decl_stmt|;
name|POCE_SOFTC
name|sc
init|=
name|rq
operator|->
name|parent
decl_stmt|;
name|struct
name|oce_nic_rx_cqe
modifier|*
name|cqe
decl_stmt|;
name|int
name|num_cqes
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|rq
operator|->
name|islro
condition|)
block|{
name|oce_rq_handler_lro
argument_list|(
name|arg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|LOCK
argument_list|(
operator|&
name|rq
operator|->
name|rx_lock
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|cq
operator|->
name|ring
operator|->
name|dma
operator|.
name|tag
argument_list|,
name|cq
operator|->
name|ring
operator|->
name|dma
operator|.
name|map
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
name|cqe
operator|=
name|RING_GET_CONSUMER_ITEM_VA
argument_list|(
name|cq
operator|->
name|ring
argument_list|,
expr|struct
name|oce_nic_rx_cqe
argument_list|)
expr_stmt|;
while|while
condition|(
name|cqe
operator|->
name|u0
operator|.
name|dw
index|[
literal|2
index|]
condition|)
block|{
name|DW_SWAP
argument_list|(
operator|(
name|uint32_t
operator|*
operator|)
name|cqe
argument_list|,
sizeof|sizeof
argument_list|(
name|oce_rq_cqe
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cqe
operator|->
name|u0
operator|.
name|s
operator|.
name|error
operator|==
literal|0
condition|)
block|{
name|oce_rx
argument_list|(
name|rq
argument_list|,
name|cqe
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|rq
operator|->
name|rx_stats
operator|.
name|rxcp_err
operator|++
expr_stmt|;
name|if_inc_counter
argument_list|(
name|sc
operator|->
name|ifp
argument_list|,
name|IFCOUNTER_IERRORS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* Post L3/L4 errors to stack.*/
name|oce_rx
argument_list|(
name|rq
argument_list|,
name|cqe
argument_list|)
expr_stmt|;
block|}
name|rq
operator|->
name|rx_stats
operator|.
name|rx_compl
operator|++
expr_stmt|;
name|cqe
operator|->
name|u0
operator|.
name|dw
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|INET6
argument_list|)
operator|||
name|defined
argument_list|(
name|INET
argument_list|)
if|if
condition|(
name|IF_LRO_ENABLED
argument_list|(
name|sc
argument_list|)
operator|&&
name|rq
operator|->
name|lro_pkts_queued
operator|>=
literal|16
condition|)
block|{
name|oce_rx_flush_lro
argument_list|(
name|rq
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|RING_GET
argument_list|(
name|cq
operator|->
name|ring
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|cq
operator|->
name|ring
operator|->
name|dma
operator|.
name|tag
argument_list|,
name|cq
operator|->
name|ring
operator|->
name|dma
operator|.
name|map
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
name|cqe
operator|=
name|RING_GET_CONSUMER_ITEM_VA
argument_list|(
name|cq
operator|->
name|ring
argument_list|,
expr|struct
name|oce_nic_rx_cqe
argument_list|)
expr_stmt|;
name|num_cqes
operator|++
expr_stmt|;
if|if
condition|(
name|num_cqes
operator|>=
operator|(
name|IS_XE201
argument_list|(
name|sc
argument_list|)
condition|?
literal|8
else|:
name|oce_max_rsp_handled
operator|)
condition|)
break|break;
block|}
if|#
directive|if
name|defined
argument_list|(
name|INET6
argument_list|)
operator|||
name|defined
argument_list|(
name|INET
argument_list|)
if|if
condition|(
name|IF_LRO_ENABLED
argument_list|(
name|sc
argument_list|)
condition|)
name|oce_rx_flush_lro
argument_list|(
name|rq
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|oce_check_rx_bufs
argument_list|(
name|sc
argument_list|,
name|num_cqes
argument_list|,
name|rq
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|rq
operator|->
name|rx_lock
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************  *		   Helper function prototypes in this file 		     *  *****************************************************************************/
end_comment

begin_function
specifier|static
name|int
name|oce_attach_ifp
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|)
block|{
name|sc
operator|->
name|ifp
operator|=
name|if_alloc
argument_list|(
name|IFT_ETHER
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sc
operator|->
name|ifp
condition|)
return|return
name|ENOMEM
return|;
name|ifmedia_init
argument_list|(
operator|&
name|sc
operator|->
name|media
argument_list|,
name|IFM_IMASK
argument_list|,
name|oce_media_change
argument_list|,
name|oce_media_status
argument_list|)
expr_stmt|;
name|ifmedia_add
argument_list|(
operator|&
name|sc
operator|->
name|media
argument_list|,
name|IFM_ETHER
operator||
name|IFM_AUTO
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ifmedia_set
argument_list|(
operator|&
name|sc
operator|->
name|media
argument_list|,
name|IFM_ETHER
operator||
name|IFM_AUTO
argument_list|)
expr_stmt|;
name|sc
operator|->
name|ifp
operator|->
name|if_flags
operator|=
name|IFF_BROADCAST
operator||
name|IFF_MULTICAST
expr_stmt|;
name|sc
operator|->
name|ifp
operator|->
name|if_ioctl
operator|=
name|oce_ioctl
expr_stmt|;
name|sc
operator|->
name|ifp
operator|->
name|if_start
operator|=
name|oce_start
expr_stmt|;
name|sc
operator|->
name|ifp
operator|->
name|if_init
operator|=
name|oce_init
expr_stmt|;
name|sc
operator|->
name|ifp
operator|->
name|if_mtu
operator|=
name|ETHERMTU
expr_stmt|;
name|sc
operator|->
name|ifp
operator|->
name|if_softc
operator|=
name|sc
expr_stmt|;
if|#
directive|if
name|__FreeBSD_version
operator|>=
literal|800000
name|sc
operator|->
name|ifp
operator|->
name|if_transmit
operator|=
name|oce_multiq_start
expr_stmt|;
name|sc
operator|->
name|ifp
operator|->
name|if_qflush
operator|=
name|oce_multiq_flush
expr_stmt|;
endif|#
directive|endif
name|if_initname
argument_list|(
name|sc
operator|->
name|ifp
argument_list|,
name|device_get_name
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
argument_list|,
name|device_get_unit
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|ifp
operator|->
name|if_snd
operator|.
name|ifq_drv_maxlen
operator|=
name|OCE_MAX_TX_DESC
operator|-
literal|1
expr_stmt|;
name|IFQ_SET_MAXLEN
argument_list|(
operator|&
name|sc
operator|->
name|ifp
operator|->
name|if_snd
argument_list|,
name|sc
operator|->
name|ifp
operator|->
name|if_snd
operator|.
name|ifq_drv_maxlen
argument_list|)
expr_stmt|;
name|IFQ_SET_READY
argument_list|(
operator|&
name|sc
operator|->
name|ifp
operator|->
name|if_snd
argument_list|)
expr_stmt|;
name|sc
operator|->
name|ifp
operator|->
name|if_hwassist
operator|=
name|OCE_IF_HWASSIST
expr_stmt|;
name|sc
operator|->
name|ifp
operator|->
name|if_hwassist
operator||=
name|CSUM_TSO
expr_stmt|;
name|sc
operator|->
name|ifp
operator|->
name|if_hwassist
operator||=
operator|(
name|CSUM_IP
operator||
name|CSUM_TCP
operator||
name|CSUM_UDP
operator|)
expr_stmt|;
name|sc
operator|->
name|ifp
operator|->
name|if_capabilities
operator|=
name|OCE_IF_CAPABILITIES
expr_stmt|;
name|sc
operator|->
name|ifp
operator|->
name|if_capabilities
operator||=
name|IFCAP_HWCSUM
expr_stmt|;
name|sc
operator|->
name|ifp
operator|->
name|if_capabilities
operator||=
name|IFCAP_VLAN_HWFILTER
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|INET6
argument_list|)
operator|||
name|defined
argument_list|(
name|INET
argument_list|)
name|sc
operator|->
name|ifp
operator|->
name|if_capabilities
operator||=
name|IFCAP_TSO
expr_stmt|;
name|sc
operator|->
name|ifp
operator|->
name|if_capabilities
operator||=
name|IFCAP_LRO
expr_stmt|;
name|sc
operator|->
name|ifp
operator|->
name|if_capabilities
operator||=
name|IFCAP_VLAN_HWTSO
expr_stmt|;
endif|#
directive|endif
name|sc
operator|->
name|ifp
operator|->
name|if_capenable
operator|=
name|sc
operator|->
name|ifp
operator|->
name|if_capabilities
expr_stmt|;
name|sc
operator|->
name|ifp
operator|->
name|if_baudrate
operator|=
name|IF_Gbps
argument_list|(
literal|10
argument_list|)
expr_stmt|;
if|#
directive|if
name|__FreeBSD_version
operator|>=
literal|1000000
name|sc
operator|->
name|ifp
operator|->
name|if_hw_tsomax
operator|=
literal|65536
operator|-
operator|(
name|ETHER_HDR_LEN
operator|+
name|ETHER_VLAN_ENCAP_LEN
operator|)
expr_stmt|;
name|sc
operator|->
name|ifp
operator|->
name|if_hw_tsomaxsegcount
operator|=
name|OCE_MAX_TX_ELEMENTS
expr_stmt|;
name|sc
operator|->
name|ifp
operator|->
name|if_hw_tsomaxsegsize
operator|=
literal|4096
expr_stmt|;
endif|#
directive|endif
name|ether_ifattach
argument_list|(
name|sc
operator|->
name|ifp
argument_list|,
name|sc
operator|->
name|macaddr
operator|.
name|mac_addr
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|oce_add_vlan
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|uint16_t
name|vtag
parameter_list|)
block|{
name|POCE_SOFTC
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_softc
operator|!=
name|arg
condition|)
return|return;
if|if
condition|(
operator|(
name|vtag
operator|==
literal|0
operator|)
operator|||
operator|(
name|vtag
operator|>
literal|4095
operator|)
condition|)
return|return;
name|sc
operator|->
name|vlan_tag
index|[
name|vtag
index|]
operator|=
literal|1
expr_stmt|;
name|sc
operator|->
name|vlans_added
operator|++
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|vlans_added
operator|<=
operator|(
name|sc
operator|->
name|max_vlans
operator|+
literal|1
operator|)
condition|)
name|oce_vid_config
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|oce_del_vlan
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|uint16_t
name|vtag
parameter_list|)
block|{
name|POCE_SOFTC
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_softc
operator|!=
name|arg
condition|)
return|return;
if|if
condition|(
operator|(
name|vtag
operator|==
literal|0
operator|)
operator|||
operator|(
name|vtag
operator|>
literal|4095
operator|)
condition|)
return|return;
name|sc
operator|->
name|vlan_tag
index|[
name|vtag
index|]
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|vlans_added
operator|--
expr_stmt|;
name|oce_vid_config
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * A max of 64 vlans can be configured in BE. If the user configures  * more, place the card in vlan promiscuous mode.  */
end_comment

begin_function
specifier|static
name|int
name|oce_vid_config
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|)
block|{
name|struct
name|normal_vlan
name|vtags
index|[
name|MAX_VLANFILTER_SIZE
index|]
decl_stmt|;
name|uint16_t
name|ntags
init|=
literal|0
decl_stmt|,
name|i
decl_stmt|;
name|int
name|status
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|(
name|sc
operator|->
name|vlans_added
operator|<=
name|MAX_VLANFILTER_SIZE
operator|)
operator|&&
operator|(
name|sc
operator|->
name|ifp
operator|->
name|if_capenable
operator|&
name|IFCAP_VLAN_HWFILTER
operator|)
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_VLANS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|sc
operator|->
name|vlan_tag
index|[
name|i
index|]
condition|)
block|{
name|vtags
index|[
name|ntags
index|]
operator|.
name|vtag
operator|=
name|i
expr_stmt|;
name|ntags
operator|++
expr_stmt|;
block|}
block|}
if|if
condition|(
name|ntags
condition|)
name|status
operator|=
name|oce_config_vlan
argument_list|(
name|sc
argument_list|,
operator|(
name|uint8_t
operator|)
name|sc
operator|->
name|if_id
argument_list|,
name|vtags
argument_list|,
name|ntags
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
name|status
operator|=
name|oce_config_vlan
argument_list|(
name|sc
argument_list|,
operator|(
name|uint8_t
operator|)
name|sc
operator|->
name|if_id
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|oce_mac_addr_set
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|)
block|{
name|uint32_t
name|old_pmac_id
init|=
name|sc
operator|->
name|pmac_id
decl_stmt|;
name|int
name|status
init|=
literal|0
decl_stmt|;
name|status
operator|=
name|bcmp
argument_list|(
operator|(
name|IF_LLADDR
argument_list|(
name|sc
operator|->
name|ifp
argument_list|)
operator|)
argument_list|,
name|sc
operator|->
name|macaddr
operator|.
name|mac_addr
argument_list|,
name|sc
operator|->
name|macaddr
operator|.
name|size_of_struct
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|status
condition|)
return|return;
name|status
operator|=
name|oce_mbox_macaddr_add
argument_list|(
name|sc
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|(
name|IF_LLADDR
argument_list|(
name|sc
operator|->
name|ifp
argument_list|)
operator|)
argument_list|,
name|sc
operator|->
name|if_id
argument_list|,
operator|&
name|sc
operator|->
name|pmac_id
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|status
condition|)
block|{
name|status
operator|=
name|oce_mbox_macaddr_del
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|if_id
argument_list|,
name|old_pmac_id
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|(
name|IF_LLADDR
argument_list|(
name|sc
operator|->
name|ifp
argument_list|)
operator|)
argument_list|,
name|sc
operator|->
name|macaddr
operator|.
name|mac_addr
argument_list|,
name|sc
operator|->
name|macaddr
operator|.
name|size_of_struct
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|status
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Failed update macaddress\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|oce_handle_passthrough
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|caddr_t
name|data
parameter_list|)
block|{
name|POCE_SOFTC
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|ifreq
modifier|*
name|ifr
init|=
operator|(
expr|struct
name|ifreq
operator|*
operator|)
name|data
decl_stmt|;
name|int
name|rc
init|=
name|ENXIO
decl_stmt|;
name|char
name|cookie
index|[
literal|32
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
name|void
modifier|*
name|priv_data
init|=
operator|(
name|void
operator|*
operator|)
name|ifr
operator|->
name|ifr_data
decl_stmt|;
name|void
modifier|*
name|ioctl_ptr
decl_stmt|;
name|uint32_t
name|req_size
decl_stmt|;
name|struct
name|mbx_hdr
name|req
decl_stmt|;
name|OCE_DMA_MEM
name|dma_mem
decl_stmt|;
name|struct
name|mbx_common_get_cntl_attr
modifier|*
name|fw_cmd
decl_stmt|;
if|if
condition|(
name|copyin
argument_list|(
name|priv_data
argument_list|,
name|cookie
argument_list|,
name|strlen
argument_list|(
name|IOCTL_COOKIE
argument_list|)
argument_list|)
condition|)
return|return
name|EFAULT
return|;
if|if
condition|(
name|memcmp
argument_list|(
name|cookie
argument_list|,
name|IOCTL_COOKIE
argument_list|,
name|strlen
argument_list|(
name|IOCTL_COOKIE
argument_list|)
argument_list|)
condition|)
return|return
name|EINVAL
return|;
name|ioctl_ptr
operator|=
operator|(
name|char
operator|*
operator|)
name|priv_data
operator|+
name|strlen
argument_list|(
name|IOCTL_COOKIE
argument_list|)
expr_stmt|;
if|if
condition|(
name|copyin
argument_list|(
name|ioctl_ptr
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_hdr
argument_list|)
argument_list|)
condition|)
return|return
name|EFAULT
return|;
name|req_size
operator|=
name|le32toh
argument_list|(
name|req
operator|.
name|u0
operator|.
name|req
operator|.
name|request_length
argument_list|)
expr_stmt|;
if|if
condition|(
name|req_size
operator|>
literal|65536
condition|)
return|return
name|EINVAL
return|;
name|req_size
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|mbx_hdr
argument_list|)
expr_stmt|;
name|rc
operator|=
name|oce_dma_alloc
argument_list|(
name|sc
argument_list|,
name|req_size
argument_list|,
operator|&
name|dma_mem
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
return|return
name|ENOMEM
return|;
if|if
condition|(
name|copyin
argument_list|(
name|ioctl_ptr
argument_list|,
name|OCE_DMAPTR
argument_list|(
operator|&
name|dma_mem
argument_list|,
name|char
argument_list|)
argument_list|,
name|req_size
argument_list|)
condition|)
block|{
name|rc
operator|=
name|EFAULT
expr_stmt|;
goto|goto
name|dma_free
goto|;
block|}
name|rc
operator|=
name|oce_pass_through_mbox
argument_list|(
name|sc
argument_list|,
operator|&
name|dma_mem
argument_list|,
name|req_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|rc
operator|=
name|EIO
expr_stmt|;
goto|goto
name|dma_free
goto|;
block|}
if|if
condition|(
name|copyout
argument_list|(
name|OCE_DMAPTR
argument_list|(
operator|&
name|dma_mem
argument_list|,
name|char
argument_list|)
argument_list|,
name|ioctl_ptr
argument_list|,
name|req_size
argument_list|)
condition|)
name|rc
operator|=
name|EFAULT
expr_stmt|;
comment|/*  	   firmware is filling all the attributes for this ioctl except 	   the driver version..so fill it  	 */
if|if
condition|(
name|req
operator|.
name|u0
operator|.
name|rsp
operator|.
name|opcode
operator|==
name|OPCODE_COMMON_GET_CNTL_ATTRIBUTES
condition|)
block|{
name|fw_cmd
operator|=
operator|(
expr|struct
name|mbx_common_get_cntl_attr
operator|*
operator|)
name|ioctl_ptr
expr_stmt|;
name|strncpy
argument_list|(
name|fw_cmd
operator|->
name|params
operator|.
name|rsp
operator|.
name|cntl_attr_info
operator|.
name|hba_attr
operator|.
name|drv_ver_str
argument_list|,
name|COMPONENT_REVISION
argument_list|,
name|strlen
argument_list|(
name|COMPONENT_REVISION
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|dma_free
label|:
name|oce_dma_free
argument_list|(
name|sc
argument_list|,
operator|&
name|dma_mem
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|oce_eqd_set_periodic
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|)
block|{
name|struct
name|oce_set_eqd
name|set_eqd
index|[
name|OCE_MAX_EQ
index|]
decl_stmt|;
name|struct
name|oce_aic_obj
modifier|*
name|aic
decl_stmt|;
name|struct
name|oce_eq
modifier|*
name|eqo
decl_stmt|;
name|uint64_t
name|now
init|=
literal|0
decl_stmt|,
name|delta
decl_stmt|;
name|int
name|eqd
decl_stmt|,
name|i
decl_stmt|,
name|num
init|=
literal|0
decl_stmt|;
name|uint32_t
name|tx_reqs
init|=
literal|0
decl_stmt|,
name|rxpkts
init|=
literal|0
decl_stmt|,
name|pps
decl_stmt|;
name|struct
name|oce_wq
modifier|*
name|wq
decl_stmt|;
name|struct
name|oce_rq
modifier|*
name|rq
decl_stmt|;
define|#
directive|define
name|ticks_to_msecs
parameter_list|(
name|t
parameter_list|)
value|(1000 * (t) / hz)
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|neqs
condition|;
name|i
operator|++
control|)
block|{
name|eqo
operator|=
name|sc
operator|->
name|eq
index|[
name|i
index|]
expr_stmt|;
name|aic
operator|=
operator|&
name|sc
operator|->
name|aic_obj
index|[
name|i
index|]
expr_stmt|;
comment|/* When setting the static eq delay from the user space */
if|if
condition|(
operator|!
name|aic
operator|->
name|enable
condition|)
block|{
if|if
condition|(
name|aic
operator|->
name|ticks
condition|)
name|aic
operator|->
name|ticks
operator|=
literal|0
expr_stmt|;
name|eqd
operator|=
name|aic
operator|->
name|et_eqd
expr_stmt|;
goto|goto
name|modify_eqd
goto|;
block|}
name|rq
operator|=
name|sc
operator|->
name|rq
index|[
name|i
index|]
expr_stmt|;
name|rxpkts
operator|=
name|rq
operator|->
name|rx_stats
operator|.
name|rx_pkts
expr_stmt|;
name|wq
operator|=
name|sc
operator|->
name|wq
index|[
name|i
index|]
expr_stmt|;
name|tx_reqs
operator|=
name|wq
operator|->
name|tx_stats
operator|.
name|tx_reqs
expr_stmt|;
name|now
operator|=
name|ticks
expr_stmt|;
if|if
condition|(
operator|!
name|aic
operator|->
name|ticks
operator|||
name|now
operator|<
name|aic
operator|->
name|ticks
operator|||
name|rxpkts
operator|<
name|aic
operator|->
name|prev_rxpkts
operator|||
name|tx_reqs
operator|<
name|aic
operator|->
name|prev_txreqs
condition|)
block|{
name|aic
operator|->
name|prev_rxpkts
operator|=
name|rxpkts
expr_stmt|;
name|aic
operator|->
name|prev_txreqs
operator|=
name|tx_reqs
expr_stmt|;
name|aic
operator|->
name|ticks
operator|=
name|now
expr_stmt|;
continue|continue;
block|}
name|delta
operator|=
name|ticks_to_msecs
argument_list|(
name|now
operator|-
name|aic
operator|->
name|ticks
argument_list|)
expr_stmt|;
name|pps
operator|=
operator|(
operator|(
call|(
name|uint32_t
call|)
argument_list|(
name|rxpkts
operator|-
name|aic
operator|->
name|prev_rxpkts
argument_list|)
operator|*
literal|1000
operator|)
operator|/
name|delta
operator|)
operator|+
operator|(
operator|(
call|(
name|uint32_t
call|)
argument_list|(
name|tx_reqs
operator|-
name|aic
operator|->
name|prev_txreqs
argument_list|)
operator|*
literal|1000
operator|)
operator|/
name|delta
operator|)
expr_stmt|;
name|eqd
operator|=
operator|(
name|pps
operator|/
literal|15000
operator|)
operator|<<
literal|2
expr_stmt|;
if|if
condition|(
name|eqd
operator|<
literal|8
condition|)
name|eqd
operator|=
literal|0
expr_stmt|;
comment|/* Make sure that the eq delay is in the known range */
name|eqd
operator|=
name|min
argument_list|(
name|eqd
argument_list|,
name|aic
operator|->
name|max_eqd
argument_list|)
expr_stmt|;
name|eqd
operator|=
name|max
argument_list|(
name|eqd
argument_list|,
name|aic
operator|->
name|min_eqd
argument_list|)
expr_stmt|;
name|aic
operator|->
name|prev_rxpkts
operator|=
name|rxpkts
expr_stmt|;
name|aic
operator|->
name|prev_txreqs
operator|=
name|tx_reqs
expr_stmt|;
name|aic
operator|->
name|ticks
operator|=
name|now
expr_stmt|;
name|modify_eqd
label|:
if|if
condition|(
name|eqd
operator|!=
name|aic
operator|->
name|cur_eqd
condition|)
block|{
name|set_eqd
index|[
name|num
index|]
operator|.
name|delay_multiplier
operator|=
operator|(
name|eqd
operator|*
literal|65
operator|)
operator|/
literal|100
expr_stmt|;
name|set_eqd
index|[
name|num
index|]
operator|.
name|eq_id
operator|=
name|eqo
operator|->
name|eq_id
expr_stmt|;
name|aic
operator|->
name|cur_eqd
operator|=
name|eqd
expr_stmt|;
name|num
operator|++
expr_stmt|;
block|}
block|}
comment|/* Is there atleast one eq that needs to be modified? */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num
condition|;
name|i
operator|+=
literal|8
control|)
block|{
if|if
condition|(
operator|(
name|num
operator|-
name|i
operator|)
operator|>=
literal|8
condition|)
name|oce_mbox_eqd_modify_periodic
argument_list|(
name|sc
argument_list|,
operator|&
name|set_eqd
index|[
name|i
index|]
argument_list|,
literal|8
argument_list|)
expr_stmt|;
else|else
name|oce_mbox_eqd_modify_periodic
argument_list|(
name|sc
argument_list|,
operator|&
name|set_eqd
index|[
name|i
index|]
argument_list|,
operator|(
name|num
operator|-
name|i
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|oce_detect_hw_error
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|)
block|{
name|uint32_t
name|ue_low
init|=
literal|0
decl_stmt|,
name|ue_high
init|=
literal|0
decl_stmt|,
name|ue_low_mask
init|=
literal|0
decl_stmt|,
name|ue_high_mask
init|=
literal|0
decl_stmt|;
name|uint32_t
name|sliport_status
init|=
literal|0
decl_stmt|,
name|sliport_err1
init|=
literal|0
decl_stmt|,
name|sliport_err2
init|=
literal|0
decl_stmt|;
name|uint32_t
name|i
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|hw_error
condition|)
return|return;
if|if
condition|(
name|IS_XE201
argument_list|(
name|sc
argument_list|)
condition|)
block|{
name|sliport_status
operator|=
name|OCE_READ_REG32
argument_list|(
name|sc
argument_list|,
name|db
argument_list|,
name|SLIPORT_STATUS_OFFSET
argument_list|)
expr_stmt|;
if|if
condition|(
name|sliport_status
operator|&
name|SLIPORT_STATUS_ERR_MASK
condition|)
block|{
name|sliport_err1
operator|=
name|OCE_READ_REG32
argument_list|(
name|sc
argument_list|,
name|db
argument_list|,
name|SLIPORT_ERROR1_OFFSET
argument_list|)
expr_stmt|;
name|sliport_err2
operator|=
name|OCE_READ_REG32
argument_list|(
name|sc
argument_list|,
name|db
argument_list|,
name|SLIPORT_ERROR2_OFFSET
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|ue_low
operator|=
name|OCE_READ_REG32
argument_list|(
name|sc
argument_list|,
name|devcfg
argument_list|,
name|PCICFG_UE_STATUS_LOW
argument_list|)
expr_stmt|;
name|ue_high
operator|=
name|OCE_READ_REG32
argument_list|(
name|sc
argument_list|,
name|devcfg
argument_list|,
name|PCICFG_UE_STATUS_HIGH
argument_list|)
expr_stmt|;
name|ue_low_mask
operator|=
name|OCE_READ_REG32
argument_list|(
name|sc
argument_list|,
name|devcfg
argument_list|,
name|PCICFG_UE_STATUS_LOW_MASK
argument_list|)
expr_stmt|;
name|ue_high_mask
operator|=
name|OCE_READ_REG32
argument_list|(
name|sc
argument_list|,
name|devcfg
argument_list|,
name|PCICFG_UE_STATUS_HI_MASK
argument_list|)
expr_stmt|;
name|ue_low
operator|=
operator|(
name|ue_low
operator|&
operator|~
name|ue_low_mask
operator|)
expr_stmt|;
name|ue_high
operator|=
operator|(
name|ue_high
operator|&
operator|~
name|ue_high_mask
operator|)
expr_stmt|;
block|}
comment|/* On certain platforms BE hardware can indicate spurious UEs. 	 * Allow the h/w to stop working completely in case of a real UE. 	 * Hence not setting the hw_error for UE detection. 	 */
if|if
condition|(
name|sliport_status
operator|&
name|SLIPORT_STATUS_ERR_MASK
condition|)
block|{
name|sc
operator|->
name|hw_error
operator|=
name|TRUE
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Error detected in the card\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sliport_status
operator|&
name|SLIPORT_STATUS_ERR_MASK
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"ERR: sliport status 0x%x\n"
argument_list|,
name|sliport_status
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"ERR: sliport error1 0x%x\n"
argument_list|,
name|sliport_err1
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"ERR: sliport error2 0x%x\n"
argument_list|,
name|sliport_err2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ue_low
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|ue_low
condition|;
name|ue_low
operator|>>=
literal|1
operator|,
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ue_low
operator|&
literal|1
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"UE: %s bit set\n"
argument_list|,
name|ue_status_low_desc
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|ue_high
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|ue_high
condition|;
name|ue_high
operator|>>=
literal|1
operator|,
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ue_high
operator|&
literal|1
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"UE: %s bit set\n"
argument_list|,
name|ue_status_hi_desc
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|oce_local_timer
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|POCE_SOFTC
name|sc
init|=
name|arg
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
name|oce_detect_hw_error
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|oce_refresh_nic_stats
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|oce_refresh_queue_stats
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|oce_mac_addr_set
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* TX Watch Dog*/
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|nwqs
condition|;
name|i
operator|++
control|)
name|oce_tx_restart
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|wq
index|[
name|i
index|]
argument_list|)
expr_stmt|;
comment|/* calculate and set the eq delay for optimal interrupt rate */
if|if
condition|(
name|IS_BE
argument_list|(
name|sc
argument_list|)
operator|||
name|IS_SH
argument_list|(
name|sc
argument_list|)
condition|)
name|oce_eqd_set_periodic
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|callout_reset
argument_list|(
operator|&
name|sc
operator|->
name|timer
argument_list|,
name|hz
argument_list|,
name|oce_local_timer
argument_list|,
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|oce_tx_compl_clean
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|)
block|{
name|struct
name|oce_wq
modifier|*
name|wq
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|,
name|timeo
init|=
literal|0
decl_stmt|,
name|num_wqes
init|=
literal|0
decl_stmt|;
name|int
name|pending_txqs
init|=
name|sc
operator|->
name|nwqs
decl_stmt|;
comment|/* Stop polling for compls when HW has been silent for 10ms or  	 * hw_error or no outstanding completions expected 	 */
do|do
block|{
name|pending_txqs
operator|=
name|sc
operator|->
name|nwqs
expr_stmt|;
name|for_all_wq_queues
argument_list|(
argument|sc
argument_list|,
argument|wq
argument_list|,
argument|i
argument_list|)
block|{
name|num_wqes
operator|=
name|oce_wq_handler
argument_list|(
name|wq
argument_list|)
expr_stmt|;
if|if
condition|(
name|num_wqes
condition|)
name|timeo
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|wq
operator|->
name|ring
operator|->
name|num_used
condition|)
name|pending_txqs
operator|--
expr_stmt|;
block|}
if|if
condition|(
name|pending_txqs
operator|==
literal|0
operator|||
operator|++
name|timeo
operator|>
literal|10
operator|||
name|sc
operator|->
name|hw_error
condition|)
break|break;
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|TRUE
condition|)
do|;
name|for_all_wq_queues
argument_list|(
argument|sc
argument_list|,
argument|wq
argument_list|,
argument|i
argument_list|)
block|{
while|while
condition|(
name|wq
operator|->
name|ring
operator|->
name|num_used
condition|)
block|{
name|LOCK
argument_list|(
operator|&
name|wq
operator|->
name|tx_compl_lock
argument_list|)
expr_stmt|;
name|oce_process_tx_completion
argument_list|(
name|wq
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|wq
operator|->
name|tx_compl_lock
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/* NOTE : This should only be called holding  *        DEVICE_LOCK.  */
end_comment

begin_function
specifier|static
name|void
name|oce_if_deactivate
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|struct
name|oce_rq
modifier|*
name|rq
decl_stmt|;
name|struct
name|oce_wq
modifier|*
name|wq
decl_stmt|;
name|struct
name|oce_eq
modifier|*
name|eq
decl_stmt|;
name|sc
operator|->
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
operator|(
name|IFF_DRV_RUNNING
operator||
name|IFF_DRV_OACTIVE
operator|)
expr_stmt|;
name|oce_tx_compl_clean
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Stop intrs and finish any bottom halves pending */
name|oce_hw_intr_disable
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Since taskqueue_drain takes a Gaint Lock, We should not acquire 	   any other lock. So unlock device lock and require after 	   completing taskqueue_drain. 	*/
name|UNLOCK
argument_list|(
operator|&
name|sc
operator|->
name|dev_lock
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|intr_count
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|sc
operator|->
name|intrs
index|[
name|i
index|]
operator|.
name|tq
operator|!=
name|NULL
condition|)
block|{
name|taskqueue_drain
argument_list|(
name|sc
operator|->
name|intrs
index|[
name|i
index|]
operator|.
name|tq
argument_list|,
operator|&
name|sc
operator|->
name|intrs
index|[
name|i
index|]
operator|.
name|task
argument_list|)
expr_stmt|;
block|}
block|}
name|LOCK
argument_list|(
operator|&
name|sc
operator|->
name|dev_lock
argument_list|)
expr_stmt|;
comment|/* Delete RX queue in card with flush param */
name|oce_stop_rx
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Invalidate any pending cq and eq entries*/
name|for_all_evnt_queues
argument_list|(
argument|sc
argument_list|,
argument|eq
argument_list|,
argument|i
argument_list|)
name|oce_drain_eq
argument_list|(
name|eq
argument_list|)
expr_stmt|;
name|for_all_rq_queues
argument_list|(
argument|sc
argument_list|,
argument|rq
argument_list|,
argument|i
argument_list|)
name|oce_drain_rq_cq
argument_list|(
name|rq
argument_list|)
expr_stmt|;
name|for_all_wq_queues
argument_list|(
argument|sc
argument_list|,
argument|wq
argument_list|,
argument|i
argument_list|)
name|oce_drain_wq_cq
argument_list|(
name|wq
argument_list|)
expr_stmt|;
comment|/* But still we need to get MCC aync events. 	   So enable intrs and also arm first EQ 	*/
name|oce_hw_intr_enable
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|oce_arm_eq
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|eq
index|[
literal|0
index|]
operator|->
name|eq_id
argument_list|,
literal|0
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|oce_if_activate
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|)
block|{
name|struct
name|oce_eq
modifier|*
name|eq
decl_stmt|;
name|struct
name|oce_rq
modifier|*
name|rq
decl_stmt|;
name|struct
name|oce_wq
modifier|*
name|wq
decl_stmt|;
name|int
name|i
decl_stmt|,
name|rc
init|=
literal|0
decl_stmt|;
name|sc
operator|->
name|ifp
operator|->
name|if_drv_flags
operator||=
name|IFF_DRV_RUNNING
expr_stmt|;
name|oce_hw_intr_disable
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|oce_start_rx
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|for_all_rq_queues
argument_list|(
argument|sc
argument_list|,
argument|rq
argument_list|,
argument|i
argument_list|)
block|{
name|rc
operator|=
name|oce_start_rq
argument_list|(
name|rq
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Unable to start RX\n"
argument_list|)
expr_stmt|;
block|}
name|for_all_wq_queues
argument_list|(
argument|sc
argument_list|,
argument|wq
argument_list|,
argument|i
argument_list|)
block|{
name|rc
operator|=
name|oce_start_wq
argument_list|(
name|wq
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Unable to start TX\n"
argument_list|)
expr_stmt|;
block|}
name|for_all_evnt_queues
argument_list|(
argument|sc
argument_list|,
argument|eq
argument_list|,
argument|i
argument_list|)
name|oce_arm_eq
argument_list|(
name|sc
argument_list|,
name|eq
operator|->
name|eq_id
argument_list|,
literal|0
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|oce_hw_intr_enable
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|process_link_state
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
name|struct
name|oce_async_cqe_link_state
modifier|*
name|acqe
parameter_list|)
block|{
comment|/* Update Link status */
if|if
condition|(
operator|(
name|acqe
operator|->
name|u0
operator|.
name|s
operator|.
name|link_status
operator|&
operator|~
name|ASYNC_EVENT_LOGICAL
operator|)
operator|==
name|ASYNC_EVENT_LINK_UP
condition|)
block|{
name|sc
operator|->
name|link_status
operator|=
name|ASYNC_EVENT_LINK_UP
expr_stmt|;
name|if_link_state_change
argument_list|(
name|sc
operator|->
name|ifp
argument_list|,
name|LINK_STATE_UP
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|sc
operator|->
name|link_status
operator|=
name|ASYNC_EVENT_LINK_DOWN
expr_stmt|;
name|if_link_state_change
argument_list|(
name|sc
operator|->
name|ifp
argument_list|,
name|LINK_STATE_DOWN
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|oce_async_grp5_osbmc_process
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
name|struct
name|oce_async_evt_grp5_os2bmc
modifier|*
name|evt
parameter_list|)
block|{
name|DW_SWAP
argument_list|(
name|evt
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|oce_async_evt_grp5_os2bmc
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|evt
operator|->
name|u
operator|.
name|s
operator|.
name|mgmt_enable
condition|)
name|sc
operator|->
name|flags
operator||=
name|OCE_FLAGS_OS2BMC
expr_stmt|;
else|else
return|return;
name|sc
operator|->
name|bmc_filt_mask
operator|=
name|evt
operator|->
name|u
operator|.
name|s
operator|.
name|arp_filter
expr_stmt|;
name|sc
operator|->
name|bmc_filt_mask
operator||=
operator|(
name|evt
operator|->
name|u
operator|.
name|s
operator|.
name|dhcp_client_filt
operator|<<
literal|1
operator|)
expr_stmt|;
name|sc
operator|->
name|bmc_filt_mask
operator||=
operator|(
name|evt
operator|->
name|u
operator|.
name|s
operator|.
name|dhcp_server_filt
operator|<<
literal|2
operator|)
expr_stmt|;
name|sc
operator|->
name|bmc_filt_mask
operator||=
operator|(
name|evt
operator|->
name|u
operator|.
name|s
operator|.
name|net_bios_filt
operator|<<
literal|3
operator|)
expr_stmt|;
name|sc
operator|->
name|bmc_filt_mask
operator||=
operator|(
name|evt
operator|->
name|u
operator|.
name|s
operator|.
name|bcast_filt
operator|<<
literal|4
operator|)
expr_stmt|;
name|sc
operator|->
name|bmc_filt_mask
operator||=
operator|(
name|evt
operator|->
name|u
operator|.
name|s
operator|.
name|ipv6_nbr_filt
operator|<<
literal|5
operator|)
expr_stmt|;
name|sc
operator|->
name|bmc_filt_mask
operator||=
operator|(
name|evt
operator|->
name|u
operator|.
name|s
operator|.
name|ipv6_ra_filt
operator|<<
literal|6
operator|)
expr_stmt|;
name|sc
operator|->
name|bmc_filt_mask
operator||=
operator|(
name|evt
operator|->
name|u
operator|.
name|s
operator|.
name|ipv6_ras_filt
operator|<<
literal|7
operator|)
expr_stmt|;
name|sc
operator|->
name|bmc_filt_mask
operator||=
operator|(
name|evt
operator|->
name|u
operator|.
name|s
operator|.
name|mcast_filt
operator|<<
literal|8
operator|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|oce_process_grp5_events
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
name|struct
name|oce_mq_cqe
modifier|*
name|cqe
parameter_list|)
block|{
name|struct
name|oce_async_event_grp5_pvid_state
modifier|*
name|gcqe
decl_stmt|;
name|struct
name|oce_async_evt_grp5_os2bmc
modifier|*
name|bmccqe
decl_stmt|;
switch|switch
condition|(
name|cqe
operator|->
name|u0
operator|.
name|s
operator|.
name|async_type
condition|)
block|{
case|case
name|ASYNC_EVENT_PVID_STATE
case|:
comment|/* GRP5 PVID */
name|gcqe
operator|=
operator|(
expr|struct
name|oce_async_event_grp5_pvid_state
operator|*
operator|)
name|cqe
expr_stmt|;
if|if
condition|(
name|gcqe
operator|->
name|enabled
condition|)
name|sc
operator|->
name|pvid
operator|=
name|gcqe
operator|->
name|tag
operator|&
name|VLAN_VID_MASK
expr_stmt|;
else|else
name|sc
operator|->
name|pvid
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|ASYNC_EVENT_OS2BMC
case|:
name|bmccqe
operator|=
operator|(
expr|struct
name|oce_async_evt_grp5_os2bmc
operator|*
operator|)
name|cqe
expr_stmt|;
name|oce_async_grp5_osbmc_process
argument_list|(
name|sc
argument_list|,
name|bmccqe
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
end_function

begin_comment
comment|/* Handle the Completion Queue for the Mailbox/Async notifications */
end_comment

begin_function
name|uint16_t
name|oce_mq_handler
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|oce_mq
modifier|*
name|mq
init|=
operator|(
expr|struct
name|oce_mq
operator|*
operator|)
name|arg
decl_stmt|;
name|POCE_SOFTC
name|sc
init|=
name|mq
operator|->
name|parent
decl_stmt|;
name|struct
name|oce_cq
modifier|*
name|cq
init|=
name|mq
operator|->
name|cq
decl_stmt|;
name|int
name|num_cqes
init|=
literal|0
decl_stmt|,
name|evt_type
init|=
literal|0
decl_stmt|,
name|optype
init|=
literal|0
decl_stmt|;
name|struct
name|oce_mq_cqe
modifier|*
name|cqe
decl_stmt|;
name|struct
name|oce_async_cqe_link_state
modifier|*
name|acqe
decl_stmt|;
name|struct
name|oce_async_event_qnq
modifier|*
name|dbgcqe
decl_stmt|;
name|bus_dmamap_sync
argument_list|(
name|cq
operator|->
name|ring
operator|->
name|dma
operator|.
name|tag
argument_list|,
name|cq
operator|->
name|ring
operator|->
name|dma
operator|.
name|map
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
name|cqe
operator|=
name|RING_GET_CONSUMER_ITEM_VA
argument_list|(
name|cq
operator|->
name|ring
argument_list|,
expr|struct
name|oce_mq_cqe
argument_list|)
expr_stmt|;
while|while
condition|(
name|cqe
operator|->
name|u0
operator|.
name|dw
index|[
literal|3
index|]
condition|)
block|{
name|DW_SWAP
argument_list|(
operator|(
name|uint32_t
operator|*
operator|)
name|cqe
argument_list|,
sizeof|sizeof
argument_list|(
name|oce_mq_cqe
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cqe
operator|->
name|u0
operator|.
name|s
operator|.
name|async_event
condition|)
block|{
name|evt_type
operator|=
name|cqe
operator|->
name|u0
operator|.
name|s
operator|.
name|event_type
expr_stmt|;
name|optype
operator|=
name|cqe
operator|->
name|u0
operator|.
name|s
operator|.
name|async_type
expr_stmt|;
if|if
condition|(
name|evt_type
operator|==
name|ASYNC_EVENT_CODE_LINK_STATE
condition|)
block|{
comment|/* Link status evt */
name|acqe
operator|=
operator|(
expr|struct
name|oce_async_cqe_link_state
operator|*
operator|)
name|cqe
expr_stmt|;
name|process_link_state
argument_list|(
name|sc
argument_list|,
name|acqe
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|evt_type
operator|==
name|ASYNC_EVENT_GRP5
condition|)
block|{
name|oce_process_grp5_events
argument_list|(
name|sc
argument_list|,
name|cqe
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|evt_type
operator|==
name|ASYNC_EVENT_CODE_DEBUG
operator|&&
name|optype
operator|==
name|ASYNC_EVENT_DEBUG_QNQ
condition|)
block|{
name|dbgcqe
operator|=
operator|(
expr|struct
name|oce_async_event_qnq
operator|*
operator|)
name|cqe
expr_stmt|;
if|if
condition|(
name|dbgcqe
operator|->
name|valid
condition|)
name|sc
operator|->
name|qnqid
operator|=
name|dbgcqe
operator|->
name|vlan_tag
expr_stmt|;
name|sc
operator|->
name|qnq_debug_event
operator|=
name|TRUE
expr_stmt|;
block|}
block|}
name|cqe
operator|->
name|u0
operator|.
name|dw
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|RING_GET
argument_list|(
name|cq
operator|->
name|ring
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|cq
operator|->
name|ring
operator|->
name|dma
operator|.
name|tag
argument_list|,
name|cq
operator|->
name|ring
operator|->
name|dma
operator|.
name|map
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
name|cqe
operator|=
name|RING_GET_CONSUMER_ITEM_VA
argument_list|(
name|cq
operator|->
name|ring
argument_list|,
expr|struct
name|oce_mq_cqe
argument_list|)
expr_stmt|;
name|num_cqes
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|num_cqes
condition|)
name|oce_arm_cq
argument_list|(
name|sc
argument_list|,
name|cq
operator|->
name|cq_id
argument_list|,
name|num_cqes
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|setup_max_queues_want
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|)
block|{
comment|/* Check if it is FLEX machine. Is so dont use RSS */
if|if
condition|(
operator|(
name|sc
operator|->
name|function_mode
operator|&
name|FNM_FLEX10_MODE
operator|)
operator|||
operator|(
name|sc
operator|->
name|function_mode
operator|&
name|FNM_UMC_MODE
operator|)
operator|||
operator|(
name|sc
operator|->
name|function_mode
operator|&
name|FNM_VNIC_MODE
operator|)
operator|||
operator|(
operator|!
name|is_rss_enabled
argument_list|(
name|sc
argument_list|)
operator|)
operator|||
name|IS_BE2
argument_list|(
name|sc
argument_list|)
condition|)
block|{
name|sc
operator|->
name|nrqs
operator|=
literal|1
expr_stmt|;
name|sc
operator|->
name|nwqs
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|sc
operator|->
name|nrqs
operator|=
name|MIN
argument_list|(
name|OCE_NCPUS
argument_list|,
name|sc
operator|->
name|nrssqs
argument_list|)
operator|+
literal|1
expr_stmt|;
name|sc
operator|->
name|nwqs
operator|=
name|MIN
argument_list|(
name|OCE_NCPUS
argument_list|,
name|sc
operator|->
name|nrssqs
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|IS_BE2
argument_list|(
name|sc
argument_list|)
operator|&&
name|is_rss_enabled
argument_list|(
name|sc
argument_list|)
condition|)
name|sc
operator|->
name|nrqs
operator|=
name|MIN
argument_list|(
name|OCE_NCPUS
argument_list|,
name|sc
operator|->
name|nrssqs
argument_list|)
operator|+
literal|1
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|update_queues_got
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|)
block|{
if|if
condition|(
name|is_rss_enabled
argument_list|(
name|sc
argument_list|)
condition|)
block|{
name|sc
operator|->
name|nrqs
operator|=
name|sc
operator|->
name|intr_count
operator|+
literal|1
expr_stmt|;
name|sc
operator|->
name|nwqs
operator|=
name|sc
operator|->
name|intr_count
expr_stmt|;
block|}
else|else
block|{
name|sc
operator|->
name|nrqs
operator|=
literal|1
expr_stmt|;
name|sc
operator|->
name|nwqs
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|IS_BE2
argument_list|(
name|sc
argument_list|)
condition|)
name|sc
operator|->
name|nwqs
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|oce_check_ipv6_ext_hdr
parameter_list|(
name|struct
name|mbuf
modifier|*
name|m
parameter_list|)
block|{
name|struct
name|ether_header
modifier|*
name|eh
init|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ether_header
operator|*
argument_list|)
decl_stmt|;
name|caddr_t
name|m_datatemp
init|=
name|m
operator|->
name|m_data
decl_stmt|;
if|if
condition|(
name|eh
operator|->
name|ether_type
operator|==
name|htons
argument_list|(
name|ETHERTYPE_IPV6
argument_list|)
condition|)
block|{
name|m
operator|->
name|m_data
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|ether_header
argument_list|)
expr_stmt|;
name|struct
name|ip6_hdr
modifier|*
name|ip6
init|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ip6_hdr
operator|*
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|ip6
operator|->
name|ip6_nxt
operator|!=
name|IPPROTO_TCP
operator|)
operator|&&
expr|\
operator|(
name|ip6
operator|->
name|ip6_nxt
operator|!=
name|IPPROTO_UDP
operator|)
condition|)
block|{
name|struct
name|ip6_ext
modifier|*
name|ip6e
init|=
name|NULL
decl_stmt|;
name|m
operator|->
name|m_data
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|ip6_hdr
argument_list|)
expr_stmt|;
name|ip6e
operator|=
operator|(
expr|struct
name|ip6_ext
operator|*
operator|)
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ip6_ext
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
name|ip6e
operator|->
name|ip6e_len
operator|==
literal|0xff
condition|)
block|{
name|m
operator|->
name|m_data
operator|=
name|m_datatemp
expr_stmt|;
return|return
name|TRUE
return|;
block|}
block|}
name|m
operator|->
name|m_data
operator|=
name|m_datatemp
expr_stmt|;
block|}
return|return
name|FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|is_be3_a1
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|)
block|{
if|if
condition|(
operator|(
name|sc
operator|->
name|flags
operator|&
name|OCE_FLAGS_BE3
operator|)
operator|&&
operator|(
operator|(
name|sc
operator|->
name|asic_revision
operator|&
literal|0xFF
operator|)
operator|<
literal|2
operator|)
condition|)
block|{
return|return
name|TRUE
return|;
block|}
return|return
name|FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|mbuf
modifier|*
name|oce_insert_vlan_tag
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|boolean_t
modifier|*
name|complete
parameter_list|)
block|{
name|uint16_t
name|vlan_tag
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|M_WRITABLE
argument_list|(
name|m
argument_list|)
condition|)
return|return
name|NULL
return|;
comment|/* Embed vlan tag in the packet if it is not part of it */
if|if
condition|(
name|m
operator|->
name|m_flags
operator|&
name|M_VLANTAG
condition|)
block|{
name|vlan_tag
operator|=
name|EVL_VLANOFTAG
argument_list|(
name|m
operator|->
name|m_pkthdr
operator|.
name|ether_vtag
argument_list|)
expr_stmt|;
name|m
operator|->
name|m_flags
operator|&=
operator|~
name|M_VLANTAG
expr_stmt|;
block|}
comment|/* if UMC, ignore vlan tag insertion and instead insert pvid */
if|if
condition|(
name|sc
operator|->
name|pvid
condition|)
block|{
if|if
condition|(
operator|!
name|vlan_tag
condition|)
name|vlan_tag
operator|=
name|sc
operator|->
name|pvid
expr_stmt|;
if|if
condition|(
name|complete
condition|)
operator|*
name|complete
operator|=
name|FALSE
expr_stmt|;
block|}
if|if
condition|(
name|vlan_tag
condition|)
block|{
name|m
operator|=
name|ether_vlanencap
argument_list|(
name|m
argument_list|,
name|vlan_tag
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|qnqid
condition|)
block|{
name|m
operator|=
name|ether_vlanencap
argument_list|(
name|m
argument_list|,
name|sc
operator|->
name|qnqid
argument_list|)
expr_stmt|;
if|if
condition|(
name|complete
condition|)
operator|*
name|complete
operator|=
name|FALSE
expr_stmt|;
block|}
return|return
name|m
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|oce_tx_asic_stall_verify
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|)
block|{
if|if
condition|(
name|is_be3_a1
argument_list|(
name|sc
argument_list|)
operator|&&
name|IS_QNQ_OR_UMC
argument_list|(
name|sc
argument_list|)
operator|&&
expr|\
name|oce_check_ipv6_ext_hdr
argument_list|(
name|m
argument_list|)
condition|)
block|{
return|return
name|TRUE
return|;
block|}
return|return
name|FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|oce_get_config
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|)
block|{
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|uint32_t
name|max_rss
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|(
name|IS_BE
argument_list|(
name|sc
argument_list|)
operator|||
name|IS_SH
argument_list|(
name|sc
argument_list|)
operator|)
operator|&&
operator|(
operator|!
name|sc
operator|->
name|be3_native
operator|)
condition|)
name|max_rss
operator|=
name|OCE_LEGACY_MODE_RSS
expr_stmt|;
else|else
name|max_rss
operator|=
name|OCE_MAX_RSS
expr_stmt|;
if|if
condition|(
operator|!
name|IS_BE
argument_list|(
name|sc
argument_list|)
condition|)
block|{
name|rc
operator|=
name|oce_get_profile_config
argument_list|(
name|sc
argument_list|,
name|max_rss
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|sc
operator|->
name|nwqs
operator|=
name|OCE_MAX_WQ
expr_stmt|;
name|sc
operator|->
name|nrssqs
operator|=
name|max_rss
expr_stmt|;
name|sc
operator|->
name|nrqs
operator|=
name|sc
operator|->
name|nrssqs
operator|+
literal|1
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* For BE3 don't rely on fw for determining the resources */
name|sc
operator|->
name|nrssqs
operator|=
name|max_rss
expr_stmt|;
name|sc
operator|->
name|nrqs
operator|=
name|sc
operator|->
name|nrssqs
operator|+
literal|1
expr_stmt|;
name|sc
operator|->
name|nwqs
operator|=
name|OCE_MAX_WQ
expr_stmt|;
name|sc
operator|->
name|max_vlans
operator|=
name|MAX_VLANFILTER_SIZE
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|oce_rdma_close
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
name|oce_rdma_if
operator|!=
name|NULL
condition|)
block|{
name|oce_rdma_if
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|oce_get_mac_addr
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|,
name|uint8_t
modifier|*
name|macaddr
parameter_list|)
block|{
name|memcpy
argument_list|(
name|macaddr
argument_list|,
name|sc
operator|->
name|macaddr
operator|.
name|mac_addr
argument_list|,
literal|6
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|oce_register_rdma
parameter_list|(
name|POCE_RDMA_INFO
name|rdma_info
parameter_list|,
name|POCE_RDMA_IF
name|rdma_if
parameter_list|)
block|{
name|POCE_SOFTC
name|sc
decl_stmt|;
name|struct
name|oce_dev_info
name|di
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|(
name|rdma_info
operator|==
name|NULL
operator|)
operator|||
operator|(
name|rdma_if
operator|==
name|NULL
operator|)
condition|)
block|{
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
operator|(
name|rdma_info
operator|->
name|size
operator|!=
name|OCE_RDMA_INFO_SIZE
operator|)
operator|||
operator|(
name|rdma_if
operator|->
name|size
operator|!=
name|OCE_RDMA_IF_SIZE
operator|)
condition|)
block|{
return|return
operator|-
name|ENXIO
return|;
block|}
name|rdma_info
operator|->
name|close
operator|=
name|oce_rdma_close
expr_stmt|;
name|rdma_info
operator|->
name|mbox_post
operator|=
name|oce_mbox_post
expr_stmt|;
name|rdma_info
operator|->
name|common_req_hdr_init
operator|=
name|mbx_common_req_hdr_init
expr_stmt|;
name|rdma_info
operator|->
name|get_mac_addr
operator|=
name|oce_get_mac_addr
expr_stmt|;
name|oce_rdma_if
operator|=
name|rdma_if
expr_stmt|;
name|sc
operator|=
name|softc_head
expr_stmt|;
while|while
condition|(
name|sc
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|oce_rdma_if
operator|->
name|announce
operator|!=
name|NULL
condition|)
block|{
name|memset
argument_list|(
operator|&
name|di
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|di
argument_list|)
argument_list|)
expr_stmt|;
name|di
operator|.
name|dev
operator|=
name|sc
operator|->
name|dev
expr_stmt|;
name|di
operator|.
name|softc
operator|=
name|sc
expr_stmt|;
name|di
operator|.
name|ifp
operator|=
name|sc
operator|->
name|ifp
expr_stmt|;
name|di
operator|.
name|db_bhandle
operator|=
name|sc
operator|->
name|db_bhandle
expr_stmt|;
name|di
operator|.
name|db_btag
operator|=
name|sc
operator|->
name|db_btag
expr_stmt|;
name|di
operator|.
name|db_page_size
operator|=
literal|4096
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|flags
operator|&
name|OCE_FLAGS_USING_MSIX
condition|)
block|{
name|di
operator|.
name|intr_mode
operator|=
name|OCE_INTERRUPT_MODE_MSIX
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sc
operator|->
name|flags
operator|&
name|OCE_FLAGS_USING_MSI
condition|)
block|{
name|di
operator|.
name|intr_mode
operator|=
name|OCE_INTERRUPT_MODE_MSI
expr_stmt|;
block|}
else|else
block|{
name|di
operator|.
name|intr_mode
operator|=
name|OCE_INTERRUPT_MODE_INTX
expr_stmt|;
block|}
name|di
operator|.
name|dev_family
operator|=
name|OCE_GEN2_FAMILY
expr_stmt|;
comment|// fixme: must detect skyhawk
if|if
condition|(
name|di
operator|.
name|intr_mode
operator|!=
name|OCE_INTERRUPT_MODE_INTX
condition|)
block|{
name|di
operator|.
name|msix
operator|.
name|num_vectors
operator|=
name|sc
operator|->
name|intr_count
operator|+
name|sc
operator|->
name|roce_intr_count
expr_stmt|;
name|di
operator|.
name|msix
operator|.
name|start_vector
operator|=
name|sc
operator|->
name|intr_count
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|di
operator|.
name|msix
operator|.
name|num_vectors
condition|;
name|i
operator|++
control|)
block|{
name|di
operator|.
name|msix
operator|.
name|vector_list
index|[
name|i
index|]
operator|=
name|sc
operator|->
name|intrs
index|[
name|i
index|]
operator|.
name|vector
expr_stmt|;
block|}
block|}
else|else
block|{       }
name|memcpy
argument_list|(
name|di
operator|.
name|mac_addr
argument_list|,
name|sc
operator|->
name|macaddr
operator|.
name|mac_addr
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|di
operator|.
name|vendor_id
operator|=
name|pci_get_vendor
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
expr_stmt|;
name|di
operator|.
name|dev_id
operator|=
name|pci_get_device
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|rdma_flags
operator|&
name|OCE_RDMA_FLAG_SUPPORTED
condition|)
block|{
name|di
operator|.
name|flags
operator||=
name|OCE_RDMA_INFO_RDMA_SUPPORTED
expr_stmt|;
block|}
name|rdma_if
operator|->
name|announce
argument_list|(
operator|&
name|di
argument_list|)
expr_stmt|;
name|sc
operator|=
name|sc
operator|->
name|next
expr_stmt|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|oce_read_env_variables
parameter_list|(
name|POCE_SOFTC
name|sc
parameter_list|)
block|{
name|char
modifier|*
name|value
init|=
name|NULL
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
comment|/* read if user wants to enable hwlro or swlro */
comment|//value = getenv("oce_enable_hwlro");
if|if
condition|(
name|value
operator|&&
name|IS_SH
argument_list|(
name|sc
argument_list|)
condition|)
block|{
name|sc
operator|->
name|enable_hwlro
operator|=
name|strtol
argument_list|(
name|value
argument_list|,
name|NULL
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|enable_hwlro
condition|)
block|{
name|rc
operator|=
name|oce_mbox_nic_query_lro_capabilities
argument_list|(
name|sc
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"no hardware lro support\n"
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"software lro enabled\n"
argument_list|)
expr_stmt|;
name|sc
operator|->
name|enable_hwlro
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"hardware lro enabled\n"
argument_list|)
expr_stmt|;
name|oce_max_rsp_handled
operator|=
literal|32
expr_stmt|;
block|}
block|}
else|else
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"software lro enabled\n"
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|sc
operator|->
name|enable_hwlro
operator|=
literal|0
expr_stmt|;
block|}
comment|/* read mbuf size */
comment|//value = getenv("oce_rq_buf_size");
if|if
condition|(
name|value
operator|&&
name|IS_SH
argument_list|(
name|sc
argument_list|)
condition|)
block|{
name|oce_rq_buf_size
operator|=
name|strtol
argument_list|(
name|value
argument_list|,
name|NULL
argument_list|,
literal|10
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|oce_rq_buf_size
condition|)
block|{
case|case
literal|2048
case|:
case|case
literal|4096
case|:
case|case
literal|9216
case|:
case|case
literal|16384
case|:
break|break;
default|default:
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|" Supported oce_rq_buf_size values are 2K, 4K, 9K, 16K \n"
argument_list|)
expr_stmt|;
name|oce_rq_buf_size
operator|=
literal|2048
expr_stmt|;
block|}
block|}
return|return;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*******************************************************************************    Copyright (c) 2001-2004, Intel Corporation   All rights reserved.      Redistribution and use in source and binary forms, with or without   modification, are permitted provided that the following conditions are met:       1. Redistributions of source code must retain the above copyright notice,       this list of conditions and the following disclaimer.       2. Redistributions in binary form must reproduce the above copyright       notice, this list of conditions and the following disclaimer in the       documentation and/or other materials provided with the distribution.       3. Neither the name of the Intel Corporation nor the names of its       contributors may be used to endorse or promote products derived from       this software without specific prior written permission.      THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"   AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE   IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE   ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE   LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR   CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF   SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS   INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN   CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)   ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE   POSSIBILITY OF SUCH DAMAGE.  *******************************************************************************/
end_comment

begin_comment
comment|/*$FreeBSD$*/
end_comment

begin_include
include|#
directive|include
file|<dev/ixgb/ixgb_hw.h>
end_include

begin_include
include|#
directive|include
file|<dev/ixgb/ixgb_ee.h>
end_include

begin_comment
comment|/* Local prototypes */
end_comment

begin_function_decl
specifier|static
name|uint16_t
name|ixgb_shift_in_bits
parameter_list|(
name|struct
name|ixgb_hw
modifier|*
name|hw
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ixgb_shift_out_bits
parameter_list|(
name|struct
name|ixgb_hw
modifier|*
name|hw
parameter_list|,
name|uint16_t
name|data
parameter_list|,
name|uint16_t
name|count
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ixgb_standby_eeprom
parameter_list|(
name|struct
name|ixgb_hw
modifier|*
name|hw
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|boolean_t
name|ixgb_wait_eeprom_command
parameter_list|(
name|struct
name|ixgb_hw
modifier|*
name|hw
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ixgb_cleanup_eeprom
parameter_list|(
name|struct
name|ixgb_hw
modifier|*
name|hw
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/******************************************************************************  * Raises the EEPROM's clock input.  *  * hw - Struct containing variables accessed by shared code  * eecd_reg - EECD's current value  *****************************************************************************/
end_comment

begin_function
specifier|static
name|void
name|ixgb_raise_clock
parameter_list|(
name|struct
name|ixgb_hw
modifier|*
name|hw
parameter_list|,
name|uint32_t
modifier|*
name|eecd_reg
parameter_list|)
block|{
comment|/* Raise the clock input to the EEPROM (by setting the SK bit), and then      *  wait 50 microseconds.      */
operator|*
name|eecd_reg
operator|=
operator|*
name|eecd_reg
operator||
name|IXGB_EECD_SK
expr_stmt|;
name|IXGB_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|EECD
argument_list|,
operator|*
name|eecd_reg
argument_list|)
expr_stmt|;
name|usec_delay
argument_list|(
literal|50
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/******************************************************************************  * Lowers the EEPROM's clock input.  *  * hw - Struct containing variables accessed by shared code  * eecd_reg - EECD's current value  *****************************************************************************/
end_comment

begin_function
specifier|static
name|void
name|ixgb_lower_clock
parameter_list|(
name|struct
name|ixgb_hw
modifier|*
name|hw
parameter_list|,
name|uint32_t
modifier|*
name|eecd_reg
parameter_list|)
block|{
comment|/* Lower the clock input to the EEPROM (by clearing the SK bit), and then      * wait 50 microseconds.      */
operator|*
name|eecd_reg
operator|=
operator|*
name|eecd_reg
operator|&
operator|~
name|IXGB_EECD_SK
expr_stmt|;
name|IXGB_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|EECD
argument_list|,
operator|*
name|eecd_reg
argument_list|)
expr_stmt|;
name|usec_delay
argument_list|(
literal|50
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/******************************************************************************  * Shift data bits out to the EEPROM.  *  * hw - Struct containing variables accessed by shared code  * data - data to send to the EEPROM  * count - number of bits to shift out  *****************************************************************************/
end_comment

begin_function
specifier|static
name|void
name|ixgb_shift_out_bits
parameter_list|(
name|struct
name|ixgb_hw
modifier|*
name|hw
parameter_list|,
name|uint16_t
name|data
parameter_list|,
name|uint16_t
name|count
parameter_list|)
block|{
name|uint32_t
name|eecd_reg
decl_stmt|;
name|uint32_t
name|mask
decl_stmt|;
comment|/* We need to shift "count" bits out to the EEPROM. So, value in the      * "data" parameter will be shifted out to the EEPROM one bit at a time.      * In order to do this, "data" must be broken down into bits.      */
name|mask
operator|=
literal|0x01
operator|<<
operator|(
name|count
operator|-
literal|1
operator|)
expr_stmt|;
name|eecd_reg
operator|=
name|IXGB_READ_REG
argument_list|(
name|hw
argument_list|,
name|EECD
argument_list|)
expr_stmt|;
name|eecd_reg
operator|&=
operator|~
operator|(
name|IXGB_EECD_DO
operator||
name|IXGB_EECD_DI
operator|)
expr_stmt|;
do|do
block|{
comment|/* A "1" is shifted out to the EEPROM by setting bit "DI" to a "1",          * and then raising and then lowering the clock (the SK bit controls          * the clock input to the EEPROM).  A "0" is shifted out to the EEPROM          * by setting "DI" to "0" and then raising and then lowering the clock.          */
name|eecd_reg
operator|&=
operator|~
name|IXGB_EECD_DI
expr_stmt|;
if|if
condition|(
name|data
operator|&
name|mask
condition|)
name|eecd_reg
operator||=
name|IXGB_EECD_DI
expr_stmt|;
name|IXGB_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|EECD
argument_list|,
name|eecd_reg
argument_list|)
expr_stmt|;
name|usec_delay
argument_list|(
literal|50
argument_list|)
expr_stmt|;
name|ixgb_raise_clock
argument_list|(
name|hw
argument_list|,
operator|&
name|eecd_reg
argument_list|)
expr_stmt|;
name|ixgb_lower_clock
argument_list|(
name|hw
argument_list|,
operator|&
name|eecd_reg
argument_list|)
expr_stmt|;
name|mask
operator|=
name|mask
operator|>>
literal|1
expr_stmt|;
block|}
do|while
condition|(
name|mask
condition|)
do|;
comment|/* We leave the "DI" bit set to "0" when we leave this routine. */
name|eecd_reg
operator|&=
operator|~
name|IXGB_EECD_DI
expr_stmt|;
name|IXGB_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|EECD
argument_list|,
name|eecd_reg
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/******************************************************************************  * Shift data bits in from the EEPROM  *  * hw - Struct containing variables accessed by shared code  *****************************************************************************/
end_comment

begin_function
specifier|static
name|uint16_t
name|ixgb_shift_in_bits
parameter_list|(
name|struct
name|ixgb_hw
modifier|*
name|hw
parameter_list|)
block|{
name|uint32_t
name|eecd_reg
decl_stmt|;
name|uint32_t
name|i
decl_stmt|;
name|uint16_t
name|data
decl_stmt|;
comment|/* In order to read a register from the EEPROM, we need to shift 16 bits      * in from the EEPROM. Bits are "shifted in" by raising the clock input to      * the EEPROM (setting the SK bit), and then reading the value of the "DO"      * bit.  During this "shifting in" process the "DI" bit should always be      * clear..      */
name|eecd_reg
operator|=
name|IXGB_READ_REG
argument_list|(
name|hw
argument_list|,
name|EECD
argument_list|)
expr_stmt|;
name|eecd_reg
operator|&=
operator|~
operator|(
name|IXGB_EECD_DO
operator||
name|IXGB_EECD_DI
operator|)
expr_stmt|;
name|data
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
block|{
name|data
operator|=
name|data
operator|<<
literal|1
expr_stmt|;
name|ixgb_raise_clock
argument_list|(
name|hw
argument_list|,
operator|&
name|eecd_reg
argument_list|)
expr_stmt|;
name|eecd_reg
operator|=
name|IXGB_READ_REG
argument_list|(
name|hw
argument_list|,
name|EECD
argument_list|)
expr_stmt|;
name|eecd_reg
operator|&=
operator|~
operator|(
name|IXGB_EECD_DI
operator|)
expr_stmt|;
if|if
condition|(
name|eecd_reg
operator|&
name|IXGB_EECD_DO
condition|)
name|data
operator||=
literal|1
expr_stmt|;
name|ixgb_lower_clock
argument_list|(
name|hw
argument_list|,
operator|&
name|eecd_reg
argument_list|)
expr_stmt|;
block|}
return|return
name|data
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************  * Prepares EEPROM for access  *  * hw - Struct containing variables accessed by shared code  *  * Lowers EEPROM clock. Clears input pin. Sets the chip select pin. This  * function should be called before issuing a command to the EEPROM.  *****************************************************************************/
end_comment

begin_function
specifier|static
name|void
name|ixgb_setup_eeprom
parameter_list|(
name|struct
name|ixgb_hw
modifier|*
name|hw
parameter_list|)
block|{
name|uint32_t
name|eecd_reg
decl_stmt|;
name|eecd_reg
operator|=
name|IXGB_READ_REG
argument_list|(
name|hw
argument_list|,
name|EECD
argument_list|)
expr_stmt|;
comment|/*  Clear SK and DI  */
name|eecd_reg
operator|&=
operator|~
operator|(
name|IXGB_EECD_SK
operator||
name|IXGB_EECD_DI
operator|)
expr_stmt|;
name|IXGB_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|EECD
argument_list|,
name|eecd_reg
argument_list|)
expr_stmt|;
comment|/*  Set CS  */
name|eecd_reg
operator||=
name|IXGB_EECD_CS
expr_stmt|;
name|IXGB_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|EECD
argument_list|,
name|eecd_reg
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/******************************************************************************  * Returns EEPROM to a "standby" state  *  * hw - Struct containing variables accessed by shared code  *****************************************************************************/
end_comment

begin_function
specifier|static
name|void
name|ixgb_standby_eeprom
parameter_list|(
name|struct
name|ixgb_hw
modifier|*
name|hw
parameter_list|)
block|{
name|uint32_t
name|eecd_reg
decl_stmt|;
name|eecd_reg
operator|=
name|IXGB_READ_REG
argument_list|(
name|hw
argument_list|,
name|EECD
argument_list|)
expr_stmt|;
comment|/*  Deselct EEPROM  */
name|eecd_reg
operator|&=
operator|~
operator|(
name|IXGB_EECD_CS
operator||
name|IXGB_EECD_SK
operator|)
expr_stmt|;
name|IXGB_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|EECD
argument_list|,
name|eecd_reg
argument_list|)
expr_stmt|;
name|usec_delay
argument_list|(
literal|50
argument_list|)
expr_stmt|;
comment|/*  Clock high  */
name|eecd_reg
operator||=
name|IXGB_EECD_SK
expr_stmt|;
name|IXGB_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|EECD
argument_list|,
name|eecd_reg
argument_list|)
expr_stmt|;
name|usec_delay
argument_list|(
literal|50
argument_list|)
expr_stmt|;
comment|/*  Select EEPROM  */
name|eecd_reg
operator||=
name|IXGB_EECD_CS
expr_stmt|;
name|IXGB_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|EECD
argument_list|,
name|eecd_reg
argument_list|)
expr_stmt|;
name|usec_delay
argument_list|(
literal|50
argument_list|)
expr_stmt|;
comment|/*  Clock low  */
name|eecd_reg
operator|&=
operator|~
name|IXGB_EECD_SK
expr_stmt|;
name|IXGB_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|EECD
argument_list|,
name|eecd_reg
argument_list|)
expr_stmt|;
name|usec_delay
argument_list|(
literal|50
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/******************************************************************************  * Raises then lowers the EEPROM's clock pin  *  * hw - Struct containing variables accessed by shared code  *****************************************************************************/
end_comment

begin_function
specifier|static
name|void
name|ixgb_clock_eeprom
parameter_list|(
name|struct
name|ixgb_hw
modifier|*
name|hw
parameter_list|)
block|{
name|uint32_t
name|eecd_reg
decl_stmt|;
name|eecd_reg
operator|=
name|IXGB_READ_REG
argument_list|(
name|hw
argument_list|,
name|EECD
argument_list|)
expr_stmt|;
comment|/*  Rising edge of clock  */
name|eecd_reg
operator||=
name|IXGB_EECD_SK
expr_stmt|;
name|IXGB_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|EECD
argument_list|,
name|eecd_reg
argument_list|)
expr_stmt|;
name|usec_delay
argument_list|(
literal|50
argument_list|)
expr_stmt|;
comment|/*  Falling edge of clock  */
name|eecd_reg
operator|&=
operator|~
name|IXGB_EECD_SK
expr_stmt|;
name|IXGB_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|EECD
argument_list|,
name|eecd_reg
argument_list|)
expr_stmt|;
name|usec_delay
argument_list|(
literal|50
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/******************************************************************************  * Terminates a command by lowering the EEPROM's chip select pin  *  * hw - Struct containing variables accessed by shared code  *****************************************************************************/
end_comment

begin_function
specifier|static
name|void
name|ixgb_cleanup_eeprom
parameter_list|(
name|struct
name|ixgb_hw
modifier|*
name|hw
parameter_list|)
block|{
name|uint32_t
name|eecd_reg
decl_stmt|;
name|eecd_reg
operator|=
name|IXGB_READ_REG
argument_list|(
name|hw
argument_list|,
name|EECD
argument_list|)
expr_stmt|;
name|eecd_reg
operator|&=
operator|~
operator|(
name|IXGB_EECD_CS
operator||
name|IXGB_EECD_DI
operator|)
expr_stmt|;
name|IXGB_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|EECD
argument_list|,
name|eecd_reg
argument_list|)
expr_stmt|;
name|ixgb_clock_eeprom
argument_list|(
name|hw
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/******************************************************************************  * Waits for the EEPROM to finish the current command.  *  * hw - Struct containing variables accessed by shared code  *  * The command is done when the EEPROM's data out pin goes high.  *  * Returns:  *      TRUE: EEPROM data pin is high before timeout.  *      FALSE:  Time expired.  *****************************************************************************/
end_comment

begin_function
specifier|static
name|boolean_t
name|ixgb_wait_eeprom_command
parameter_list|(
name|struct
name|ixgb_hw
modifier|*
name|hw
parameter_list|)
block|{
name|uint32_t
name|eecd_reg
decl_stmt|;
name|uint32_t
name|i
decl_stmt|;
comment|/* Toggle the CS line.  This in effect tells to EEPROM to actually execute      * the command in question.      */
name|ixgb_standby_eeprom
argument_list|(
name|hw
argument_list|)
expr_stmt|;
comment|/* Now read DO repeatedly until is high (equal to '1').  The EEEPROM will      * signal that the command has been completed by raising the DO signal.      * If DO does not go high in 10 milliseconds, then error out.      */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|200
condition|;
name|i
operator|++
control|)
block|{
name|eecd_reg
operator|=
name|IXGB_READ_REG
argument_list|(
name|hw
argument_list|,
name|EECD
argument_list|)
expr_stmt|;
if|if
condition|(
name|eecd_reg
operator|&
name|IXGB_EECD_DO
condition|)
return|return
operator|(
name|TRUE
operator|)
return|;
name|usec_delay
argument_list|(
literal|50
argument_list|)
expr_stmt|;
block|}
name|ASSERT
argument_list|(
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|FALSE
operator|)
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************  * Verifies that the EEPROM has a valid checksum  *  * hw - Struct containing variables accessed by shared code  *  * Reads the first 64 16 bit words of the EEPROM and sums the values read.  * If the the sum of the 64 16 bit words is 0xBABA, the EEPROM's checksum is  * valid.  *  * Returns:  *  TRUE: Checksum is valid  *  FALSE: Checksum is not valid.  *****************************************************************************/
end_comment

begin_function
name|boolean_t
name|ixgb_validate_eeprom_checksum
parameter_list|(
name|struct
name|ixgb_hw
modifier|*
name|hw
parameter_list|)
block|{
name|uint16_t
name|checksum
init|=
literal|0
decl_stmt|;
name|uint16_t
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|EEPROM_CHECKSUM_REG
operator|+
literal|1
operator|)
condition|;
name|i
operator|++
control|)
name|checksum
operator|+=
name|ixgb_read_eeprom
argument_list|(
name|hw
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|checksum
operator|==
operator|(
name|uint16_t
operator|)
name|EEPROM_SUM
condition|)
return|return
operator|(
name|TRUE
operator|)
return|;
else|else
return|return
operator|(
name|FALSE
operator|)
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************  * Calculates the EEPROM checksum and writes it to the EEPROM  *  * hw - Struct containing variables accessed by shared code  *  * Sums the first 63 16 bit words of the EEPROM. Subtracts the sum from 0xBABA.  * Writes the difference to word offset 63 of the EEPROM.  *****************************************************************************/
end_comment

begin_function
name|void
name|ixgb_update_eeprom_checksum
parameter_list|(
name|struct
name|ixgb_hw
modifier|*
name|hw
parameter_list|)
block|{
name|uint16_t
name|checksum
init|=
literal|0
decl_stmt|;
name|uint16_t
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|EEPROM_CHECKSUM_REG
condition|;
name|i
operator|++
control|)
name|checksum
operator|+=
name|ixgb_read_eeprom
argument_list|(
name|hw
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|checksum
operator|=
operator|(
name|uint16_t
operator|)
name|EEPROM_SUM
operator|-
name|checksum
expr_stmt|;
name|ixgb_write_eeprom
argument_list|(
name|hw
argument_list|,
name|EEPROM_CHECKSUM_REG
argument_list|,
name|checksum
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/******************************************************************************  * Writes a 16 bit word to a given offset in the EEPROM.  *  * hw - Struct containing variables accessed by shared code  * reg - offset within the EEPROM to be written to  * data - 16 bit word to be writen to the EEPROM  *  * If ixgb_update_eeprom_checksum is not called after this function, the  * EEPROM will most likely contain an invalid checksum.  *  *****************************************************************************/
end_comment

begin_function
name|void
name|ixgb_write_eeprom
parameter_list|(
name|struct
name|ixgb_hw
modifier|*
name|hw
parameter_list|,
name|uint16_t
name|offset
parameter_list|,
name|uint16_t
name|data
parameter_list|)
block|{
comment|/*  Prepare the EEPROM for writing  */
name|ixgb_setup_eeprom
argument_list|(
name|hw
argument_list|)
expr_stmt|;
comment|/*  Send the 9-bit EWEN (write enable) command to the EEPROM (5-bit opcode      *  plus 4-bit dummy).  This puts the EEPROM into write/erase mode.      */
name|ixgb_shift_out_bits
argument_list|(
name|hw
argument_list|,
name|EEPROM_EWEN_OPCODE
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|ixgb_shift_out_bits
argument_list|(
name|hw
argument_list|,
literal|0
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/*  Prepare the EEPROM  */
name|ixgb_standby_eeprom
argument_list|(
name|hw
argument_list|)
expr_stmt|;
comment|/*  Send the Write command (3-bit opcode + 6-bit addr)  */
name|ixgb_shift_out_bits
argument_list|(
name|hw
argument_list|,
name|EEPROM_WRITE_OPCODE
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|ixgb_shift_out_bits
argument_list|(
name|hw
argument_list|,
name|offset
argument_list|,
literal|6
argument_list|)
expr_stmt|;
comment|/*  Send the data  */
name|ixgb_shift_out_bits
argument_list|(
name|hw
argument_list|,
name|data
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|ixgb_wait_eeprom_command
argument_list|(
name|hw
argument_list|)
expr_stmt|;
comment|/*  Recover from write  */
name|ixgb_standby_eeprom
argument_list|(
name|hw
argument_list|)
expr_stmt|;
comment|/* Send the 9-bit EWDS (write disable) command to the EEPROM (5-bit      * opcode plus 4-bit dummy).  This takes the EEPROM out of write/erase      * mode.      */
name|ixgb_shift_out_bits
argument_list|(
name|hw
argument_list|,
name|EEPROM_EWDS_OPCODE
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|ixgb_shift_out_bits
argument_list|(
name|hw
argument_list|,
literal|0
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/*  Done with writing  */
name|ixgb_cleanup_eeprom
argument_list|(
name|hw
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/******************************************************************************  * Reads a 16 bit word from the EEPROM.  *  * hw - Struct containing variables accessed by shared code  * offset - offset of 16 bit word in the EEPROM to read  *  * Returns:  *  The 16-bit value read from the eeprom  *****************************************************************************/
end_comment

begin_function
name|uint16_t
name|ixgb_read_eeprom
parameter_list|(
name|struct
name|ixgb_hw
modifier|*
name|hw
parameter_list|,
name|uint16_t
name|offset
parameter_list|)
block|{
name|uint16_t
name|data
decl_stmt|;
comment|/*  Prepare the EEPROM for reading  */
name|ixgb_setup_eeprom
argument_list|(
name|hw
argument_list|)
expr_stmt|;
comment|/*  Send the READ command (opcode + addr)  */
name|ixgb_shift_out_bits
argument_list|(
name|hw
argument_list|,
name|EEPROM_READ_OPCODE
argument_list|,
literal|3
argument_list|)
expr_stmt|;
comment|/*      * We have a 64 word EEPROM, there are 6 address bits      */
name|ixgb_shift_out_bits
argument_list|(
name|hw
argument_list|,
name|offset
argument_list|,
literal|6
argument_list|)
expr_stmt|;
comment|/*  Read the data  */
name|data
operator|=
name|ixgb_shift_in_bits
argument_list|(
name|hw
argument_list|)
expr_stmt|;
comment|/*  End this read operation  */
name|ixgb_standby_eeprom
argument_list|(
name|hw
argument_list|)
expr_stmt|;
return|return
operator|(
name|data
operator|)
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************  * Reads eeprom and stores data in shared structure.  * Validates eeprom checksum and eeprom signature.  *  * hw - Struct containing variables accessed by shared code  *  * Returns:  *      TRUE: if eeprom read is successful  *      FALSE: otherwise.  *****************************************************************************/
end_comment

begin_function
name|boolean_t
name|ixgb_get_eeprom_data
parameter_list|(
name|struct
name|ixgb_hw
modifier|*
name|hw
parameter_list|)
block|{
name|uint16_t
name|i
decl_stmt|;
name|uint16_t
name|checksum
init|=
literal|0
decl_stmt|;
name|struct
name|ixgb_ee_map_type
modifier|*
name|ee_map
decl_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"ixgb_get_eeprom_data"
argument_list|)
expr_stmt|;
name|ee_map
operator|=
operator|(
expr|struct
name|ixgb_ee_map_type
operator|*
operator|)
name|hw
operator|->
name|eeprom
expr_stmt|;
name|DEBUGOUT
argument_list|(
literal|"ixgb_ee: Reading eeprom data\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|IXGB_EEPROM_SIZE
condition|;
name|i
operator|++
control|)
block|{
name|uint16_t
name|ee_data
decl_stmt|;
name|ee_data
operator|=
name|ixgb_read_eeprom
argument_list|(
name|hw
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|checksum
operator|+=
name|ee_data
expr_stmt|;
name|hw
operator|->
name|eeprom
index|[
name|i
index|]
operator|=
name|le16_to_cpu
argument_list|(
name|ee_data
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|checksum
operator|!=
operator|(
name|uint16_t
operator|)
name|EEPROM_SUM
condition|)
block|{
name|DEBUGOUT
argument_list|(
literal|"ixgb_ee: Checksum invalid.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|FALSE
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|ee_map
operator|->
name|init_ctrl_reg_1
operator|&
name|le16_to_cpu
argument_list|(
name|EEPROM_ICW1_SIGNATURE_MASK
argument_list|)
operator|)
operator|!=
name|le16_to_cpu
argument_list|(
name|EEPROM_ICW1_SIGNATURE_VALID
argument_list|)
condition|)
block|{
name|DEBUGOUT
argument_list|(
literal|"ixgb_ee: Signature invalid.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|FALSE
operator|)
return|;
block|}
return|return
operator|(
name|TRUE
operator|)
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************  * Local function to check if the eeprom signature is good  * If the eeprom signature is good, calls ixgb)get_eeprom_data.  *  * hw - Struct containing variables accessed by shared code  *  * Returns:  *      TRUE: eeprom signature was good and the eeprom read was successful  *      FALSE: otherwise.  ******************************************************************************/
end_comment

begin_function
specifier|static
name|boolean_t
name|ixgb_check_and_get_eeprom_data
parameter_list|(
name|struct
name|ixgb_hw
modifier|*
name|hw
parameter_list|)
block|{
name|struct
name|ixgb_ee_map_type
modifier|*
name|ee_map
init|=
operator|(
expr|struct
name|ixgb_ee_map_type
operator|*
operator|)
name|hw
operator|->
name|eeprom
decl_stmt|;
if|if
condition|(
operator|(
name|ee_map
operator|->
name|init_ctrl_reg_1
operator|&
name|le16_to_cpu
argument_list|(
name|EEPROM_ICW1_SIGNATURE_MASK
argument_list|)
operator|)
operator|==
name|le16_to_cpu
argument_list|(
name|EEPROM_ICW1_SIGNATURE_VALID
argument_list|)
condition|)
block|{
return|return
operator|(
name|TRUE
operator|)
return|;
block|}
else|else
block|{
return|return
name|ixgb_get_eeprom_data
argument_list|(
name|hw
argument_list|)
return|;
block|}
block|}
end_function

begin_comment
comment|/******************************************************************************  * return a word from the eeprom  *  * hw - Struct containing variables accessed by shared code  * index - Offset of eeprom word  *  * Returns:  *          Word at indexed offset in eeprom, if valid, 0 otherwise.  ******************************************************************************/
end_comment

begin_function
name|uint16_t
name|ixgb_get_eeprom_word
parameter_list|(
name|struct
name|ixgb_hw
modifier|*
name|hw
parameter_list|,
name|uint16_t
name|index
parameter_list|)
block|{
if|if
condition|(
operator|(
name|index
operator|<
name|IXGB_EEPROM_SIZE
operator|)
operator|&&
operator|(
name|ixgb_check_and_get_eeprom_data
argument_list|(
name|hw
argument_list|)
operator|==
name|TRUE
operator|)
condition|)
block|{
return|return
operator|(
name|hw
operator|->
name|eeprom
index|[
name|index
index|]
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************  * return the mac address from EEPROM  *  * hw       - Struct containing variables accessed by shared code  * mac_addr - Ethernet Address if EEPROM contents are valid, 0 otherwise  *  * Returns: None.  ******************************************************************************/
end_comment

begin_function
name|void
name|ixgb_get_ee_mac_addr
parameter_list|(
name|struct
name|ixgb_hw
modifier|*
name|hw
parameter_list|,
name|uint8_t
modifier|*
name|mac_addr
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|struct
name|ixgb_ee_map_type
modifier|*
name|ee_map
init|=
operator|(
expr|struct
name|ixgb_ee_map_type
operator|*
operator|)
name|hw
operator|->
name|eeprom
decl_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"ixgb_get_ee_mac_addr"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ixgb_check_and_get_eeprom_data
argument_list|(
name|hw
argument_list|)
operator|==
name|TRUE
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|IXGB_ETH_LENGTH_OF_ADDRESS
condition|;
name|i
operator|++
control|)
block|{
name|mac_addr
index|[
name|i
index|]
operator|=
name|ee_map
operator|->
name|mac_addr
index|[
name|i
index|]
expr_stmt|;
name|DEBUGOUT2
argument_list|(
literal|"mac(%d) = %.2X\n"
argument_list|,
name|i
argument_list|,
name|mac_addr
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/******************************************************************************  * return the compatibility flags from EEPROM  *  * hw - Struct containing variables accessed by shared code  *  * Returns:  *          compatibility flags if EEPROM contents are valid, 0 otherwise  ******************************************************************************/
end_comment

begin_function
name|uint16_t
name|ixgb_get_ee_compatibility
parameter_list|(
name|struct
name|ixgb_hw
modifier|*
name|hw
parameter_list|)
block|{
name|struct
name|ixgb_ee_map_type
modifier|*
name|ee_map
init|=
operator|(
expr|struct
name|ixgb_ee_map_type
operator|*
operator|)
name|hw
operator|->
name|eeprom
decl_stmt|;
if|if
condition|(
name|ixgb_check_and_get_eeprom_data
argument_list|(
name|hw
argument_list|)
operator|==
name|TRUE
condition|)
return|return
operator|(
name|ee_map
operator|->
name|compatibility
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************  * return the Printed Board Assembly number from EEPROM  *  * hw - Struct containing variables accessed by shared code  *  * Returns:  *          PBA number if EEPROM contents are valid, 0 otherwise  ******************************************************************************/
end_comment

begin_function
name|uint32_t
name|ixgb_get_ee_pba_number
parameter_list|(
name|struct
name|ixgb_hw
modifier|*
name|hw
parameter_list|)
block|{
if|if
condition|(
name|ixgb_check_and_get_eeprom_data
argument_list|(
name|hw
argument_list|)
operator|==
name|TRUE
condition|)
return|return
operator|(
name|le16_to_cpu
argument_list|(
name|hw
operator|->
name|eeprom
index|[
name|EEPROM_PBA_1_2_REG
index|]
argument_list|)
operator||
operator|(
name|le16_to_cpu
argument_list|(
name|hw
operator|->
name|eeprom
index|[
name|EEPROM_PBA_3_4_REG
index|]
argument_list|)
operator|<<
literal|16
operator|)
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************  * return the Initialization Control Word 1 from EEPROM  *  * hw - Struct containing variables accessed by shared code  *  * Returns:  *          Initialization Control Word 1 if EEPROM contents are valid, 0 otherwise  ******************************************************************************/
end_comment

begin_function
name|uint16_t
name|ixgb_get_ee_init_ctrl_reg_1
parameter_list|(
name|struct
name|ixgb_hw
modifier|*
name|hw
parameter_list|)
block|{
name|struct
name|ixgb_ee_map_type
modifier|*
name|ee_map
init|=
operator|(
expr|struct
name|ixgb_ee_map_type
operator|*
operator|)
name|hw
operator|->
name|eeprom
decl_stmt|;
if|if
condition|(
name|ixgb_check_and_get_eeprom_data
argument_list|(
name|hw
argument_list|)
operator|==
name|TRUE
condition|)
return|return
operator|(
name|ee_map
operator|->
name|init_ctrl_reg_1
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************  * return the Initialization Control Word 2 from EEPROM  *  * hw - Struct containing variables accessed by shared code  *  * Returns:  *          Initialization Control Word 2 if EEPROM contents are valid, 0 otherwise  ******************************************************************************/
end_comment

begin_function
name|uint16_t
name|ixgb_get_ee_init_ctrl_reg_2
parameter_list|(
name|struct
name|ixgb_hw
modifier|*
name|hw
parameter_list|)
block|{
name|struct
name|ixgb_ee_map_type
modifier|*
name|ee_map
init|=
operator|(
expr|struct
name|ixgb_ee_map_type
operator|*
operator|)
name|hw
operator|->
name|eeprom
decl_stmt|;
if|if
condition|(
name|ixgb_check_and_get_eeprom_data
argument_list|(
name|hw
argument_list|)
operator|==
name|TRUE
condition|)
return|return
operator|(
name|ee_map
operator|->
name|init_ctrl_reg_2
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************  * return the Subsystem Id from EEPROM  *  * hw - Struct containing variables accessed by shared code  *  * Returns:  *          Subsystem Id if EEPROM contents are valid, 0 otherwise  ******************************************************************************/
end_comment

begin_function
name|uint16_t
name|ixgb_get_ee_subsystem_id
parameter_list|(
name|struct
name|ixgb_hw
modifier|*
name|hw
parameter_list|)
block|{
name|struct
name|ixgb_ee_map_type
modifier|*
name|ee_map
init|=
operator|(
expr|struct
name|ixgb_ee_map_type
operator|*
operator|)
name|hw
operator|->
name|eeprom
decl_stmt|;
if|if
condition|(
name|ixgb_check_and_get_eeprom_data
argument_list|(
name|hw
argument_list|)
operator|==
name|TRUE
condition|)
return|return
operator|(
name|ee_map
operator|->
name|subsystem_id
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************  * return the Sub Vendor Id from EEPROM  *  * hw - Struct containing variables accessed by shared code  *  * Returns:  *          Sub Vendor Id if EEPROM contents are valid, 0 otherwise  ******************************************************************************/
end_comment

begin_function
name|uint16_t
name|ixgb_get_ee_subvendor_id
parameter_list|(
name|struct
name|ixgb_hw
modifier|*
name|hw
parameter_list|)
block|{
name|struct
name|ixgb_ee_map_type
modifier|*
name|ee_map
init|=
operator|(
expr|struct
name|ixgb_ee_map_type
operator|*
operator|)
name|hw
operator|->
name|eeprom
decl_stmt|;
if|if
condition|(
name|ixgb_check_and_get_eeprom_data
argument_list|(
name|hw
argument_list|)
operator|==
name|TRUE
condition|)
return|return
operator|(
name|ee_map
operator|->
name|subvendor_id
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************  * return the Device Id from EEPROM  *  * hw - Struct containing variables accessed by shared code  *  * Returns:  *          Device Id if EEPROM contents are valid, 0 otherwise  ******************************************************************************/
end_comment

begin_function
name|uint16_t
name|ixgb_get_ee_device_id
parameter_list|(
name|struct
name|ixgb_hw
modifier|*
name|hw
parameter_list|)
block|{
name|struct
name|ixgb_ee_map_type
modifier|*
name|ee_map
init|=
operator|(
expr|struct
name|ixgb_ee_map_type
operator|*
operator|)
name|hw
operator|->
name|eeprom
decl_stmt|;
if|if
condition|(
name|ixgb_check_and_get_eeprom_data
argument_list|(
name|hw
argument_list|)
operator|==
name|TRUE
condition|)
return|return
operator|(
name|ee_map
operator|->
name|device_id
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************  * return the Vendor Id from EEPROM  *  * hw - Struct containing variables accessed by shared code  *  * Returns:  *          Device Id if EEPROM contents are valid, 0 otherwise  ******************************************************************************/
end_comment

begin_function
name|uint16_t
name|ixgb_get_ee_vendor_id
parameter_list|(
name|struct
name|ixgb_hw
modifier|*
name|hw
parameter_list|)
block|{
name|struct
name|ixgb_ee_map_type
modifier|*
name|ee_map
init|=
operator|(
expr|struct
name|ixgb_ee_map_type
operator|*
operator|)
name|hw
operator|->
name|eeprom
decl_stmt|;
if|if
condition|(
name|ixgb_check_and_get_eeprom_data
argument_list|(
name|hw
argument_list|)
operator|==
name|TRUE
condition|)
return|return
operator|(
name|ee_map
operator|->
name|vendor_id
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************  * return the Software Defined Pins Register from EEPROM  *  * hw - Struct containing variables accessed by shared code  *  * Returns:  *          SDP Register if EEPROM contents are valid, 0 otherwise  ******************************************************************************/
end_comment

begin_function
name|uint16_t
name|ixgb_get_ee_swdpins_reg
parameter_list|(
name|struct
name|ixgb_hw
modifier|*
name|hw
parameter_list|)
block|{
name|struct
name|ixgb_ee_map_type
modifier|*
name|ee_map
init|=
operator|(
expr|struct
name|ixgb_ee_map_type
operator|*
operator|)
name|hw
operator|->
name|eeprom
decl_stmt|;
if|if
condition|(
name|ixgb_check_and_get_eeprom_data
argument_list|(
name|hw
argument_list|)
operator|==
name|TRUE
condition|)
return|return
operator|(
name|ee_map
operator|->
name|swdpins_reg
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************  * return the D3 Power Management Bits from EEPROM  *  * hw - Struct containing variables accessed by shared code  *  * Returns:  *          D3 Power Management Bits if EEPROM contents are valid, 0 otherwise  ******************************************************************************/
end_comment

begin_function
name|uint8_t
name|ixgb_get_ee_d3_power
parameter_list|(
name|struct
name|ixgb_hw
modifier|*
name|hw
parameter_list|)
block|{
name|struct
name|ixgb_ee_map_type
modifier|*
name|ee_map
init|=
operator|(
expr|struct
name|ixgb_ee_map_type
operator|*
operator|)
name|hw
operator|->
name|eeprom
decl_stmt|;
if|if
condition|(
name|ixgb_check_and_get_eeprom_data
argument_list|(
name|hw
argument_list|)
operator|==
name|TRUE
condition|)
return|return
operator|(
name|ee_map
operator|->
name|d3_power
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************  * return the D0 Power Management Bits from EEPROM  *  * hw - Struct containing variables accessed by shared code  *  * Returns:  *          D0 Power Management Bits if EEPROM contents are valid, 0 otherwise  ******************************************************************************/
end_comment

begin_function
name|uint8_t
name|ixgb_get_ee_d0_power
parameter_list|(
name|struct
name|ixgb_hw
modifier|*
name|hw
parameter_list|)
block|{
name|struct
name|ixgb_ee_map_type
modifier|*
name|ee_map
init|=
operator|(
expr|struct
name|ixgb_ee_map_type
operator|*
operator|)
name|hw
operator|->
name|eeprom
decl_stmt|;
if|if
condition|(
name|ixgb_check_and_get_eeprom_data
argument_list|(
name|hw
argument_list|)
operator|==
name|TRUE
condition|)
return|return
operator|(
name|ee_map
operator|->
name|d0_power
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


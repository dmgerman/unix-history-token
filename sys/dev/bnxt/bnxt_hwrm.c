begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Broadcom NetXtreme-C/E network driver.  *  * Copyright (c) 2016 Broadcom, All Rights Reserved.  * The term Broadcom refers to Broadcom Limited and/or its subsidiaries  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS'  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF  * THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|<sys/bitstring.h>
end_include

begin_include
include|#
directive|include
file|"bnxt.h"
end_include

begin_include
include|#
directive|include
file|"bnxt_hwrm.h"
end_include

begin_include
include|#
directive|include
file|"hsi_struct_def.h"
end_include

begin_function_decl
specifier|static
name|int
name|bnxt_hwrm_err_map
parameter_list|(
name|uint16_t
name|err
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|int
name|_is_valid_ether_addr
parameter_list|(
name|uint8_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|void
name|get_random_ether_addr
parameter_list|(
name|uint8_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bnxt_hwrm_set_link_common
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|,
name|struct
name|hwrm_port_phy_cfg_input
modifier|*
name|req
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bnxt_hwrm_set_pause_common
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|,
name|struct
name|hwrm_port_phy_cfg_input
modifier|*
name|req
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bnxt_hwrm_set_eee
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|,
name|struct
name|hwrm_port_phy_cfg_input
modifier|*
name|req
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|_hwrm_send_message
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|hwrm_send_message
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bnxt_hwrm_cmd_hdr_init
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* NVRam stuff has a five minute timeout */
end_comment

begin_define
define|#
directive|define
name|BNXT_NVM_TIMEO
value|(5 * 60 * 1000)
end_define

begin_function
specifier|static
name|int
name|bnxt_hwrm_err_map
parameter_list|(
name|uint16_t
name|err
parameter_list|)
block|{
name|int
name|rc
decl_stmt|;
switch|switch
condition|(
name|err
condition|)
block|{
case|case
name|HWRM_ERR_CODE_SUCCESS
case|:
return|return
literal|0
return|;
case|case
name|HWRM_ERR_CODE_INVALID_PARAMS
case|:
case|case
name|HWRM_ERR_CODE_INVALID_FLAGS
case|:
case|case
name|HWRM_ERR_CODE_INVALID_ENABLES
case|:
return|return
name|EINVAL
return|;
case|case
name|HWRM_ERR_CODE_RESOURCE_ACCESS_DENIED
case|:
return|return
name|EACCES
return|;
case|case
name|HWRM_ERR_CODE_RESOURCE_ALLOC_ERROR
case|:
return|return
name|ENOMEM
return|;
case|case
name|HWRM_ERR_CODE_CMD_NOT_SUPPORTED
case|:
return|return
name|ENOSYS
return|;
case|case
name|HWRM_ERR_CODE_FAIL
case|:
return|return
name|EIO
return|;
case|case
name|HWRM_ERR_CODE_HWRM_ERROR
case|:
case|case
name|HWRM_ERR_CODE_UNKNOWN_ERR
case|:
default|default:
return|return
name|EDOOFUS
return|;
block|}
return|return
name|rc
return|;
block|}
end_function

begin_function
name|int
name|bnxt_alloc_hwrm_dma_mem
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|)
block|{
name|int
name|rc
decl_stmt|;
name|rc
operator|=
name|iflib_dma_alloc
argument_list|(
name|softc
operator|->
name|ctx
argument_list|,
name|PAGE_SIZE
argument_list|,
operator|&
name|softc
operator|->
name|hwrm_cmd_resp
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
name|void
name|bnxt_free_hwrm_dma_mem
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|)
block|{
if|if
condition|(
name|softc
operator|->
name|hwrm_cmd_resp
operator|.
name|idi_vaddr
condition|)
name|iflib_dma_free
argument_list|(
operator|&
name|softc
operator|->
name|hwrm_cmd_resp
argument_list|)
expr_stmt|;
name|softc
operator|->
name|hwrm_cmd_resp
operator|.
name|idi_vaddr
operator|=
name|NULL
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|bnxt_hwrm_cmd_hdr_init
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|,
name|void
modifier|*
name|request
parameter_list|,
name|uint16_t
name|req_type
parameter_list|)
block|{
name|struct
name|input
modifier|*
name|req
init|=
name|request
decl_stmt|;
name|req
operator|->
name|req_type
operator|=
name|htole16
argument_list|(
name|req_type
argument_list|)
expr_stmt|;
name|req
operator|->
name|cmpl_ring
operator|=
literal|0xffff
expr_stmt|;
name|req
operator|->
name|target_id
operator|=
literal|0xffff
expr_stmt|;
name|req
operator|->
name|resp_addr
operator|=
name|htole64
argument_list|(
name|softc
operator|->
name|hwrm_cmd_resp
operator|.
name|idi_paddr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|_hwrm_send_message
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|,
name|void
modifier|*
name|msg
parameter_list|,
name|uint32_t
name|msg_len
parameter_list|)
block|{
name|struct
name|input
modifier|*
name|req
init|=
name|msg
decl_stmt|;
name|struct
name|hwrm_err_output
modifier|*
name|resp
init|=
operator|(
name|void
operator|*
operator|)
name|softc
operator|->
name|hwrm_cmd_resp
operator|.
name|idi_vaddr
decl_stmt|;
name|uint32_t
modifier|*
name|data
init|=
name|msg
decl_stmt|;
name|int
name|i
decl_stmt|;
name|uint16_t
name|cp_ring_id
decl_stmt|;
name|uint8_t
modifier|*
name|valid
decl_stmt|;
name|uint16_t
name|err
decl_stmt|;
comment|/* TODO: DMASYNC in here. */
name|req
operator|->
name|seq_id
operator|=
name|htole16
argument_list|(
name|softc
operator|->
name|hwrm_cmd_seq
operator|++
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|resp
argument_list|,
literal|0
argument_list|,
name|PAGE_SIZE
argument_list|)
expr_stmt|;
name|cp_ring_id
operator|=
name|le16toh
argument_list|(
name|req
operator|->
name|cmpl_ring
argument_list|)
expr_stmt|;
comment|/* Write request msg to hwrm channel */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|msg_len
condition|;
name|i
operator|+=
literal|4
control|)
block|{
name|bus_space_write_4
argument_list|(
name|softc
operator|->
name|hwrm_bar
operator|.
name|tag
argument_list|,
name|softc
operator|->
name|hwrm_bar
operator|.
name|handle
argument_list|,
name|i
argument_list|,
operator|*
name|data
argument_list|)
expr_stmt|;
name|data
operator|++
expr_stmt|;
block|}
comment|/* Clear to the end of the request buffer */
for|for
control|(
name|i
operator|=
name|msg_len
init|;
name|i
operator|<
name|HWRM_MAX_REQ_LEN
condition|;
name|i
operator|+=
literal|4
control|)
name|bus_space_write_4
argument_list|(
name|softc
operator|->
name|hwrm_bar
operator|.
name|tag
argument_list|,
name|softc
operator|->
name|hwrm_bar
operator|.
name|handle
argument_list|,
name|i
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Ring channel doorbell */
name|bus_space_write_4
argument_list|(
name|softc
operator|->
name|hwrm_bar
operator|.
name|tag
argument_list|,
name|softc
operator|->
name|hwrm_bar
operator|.
name|handle
argument_list|,
literal|0x100
argument_list|,
name|htole32
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Check if response len is updated */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|softc
operator|->
name|hwrm_cmd_timeo
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|resp
operator|->
name|resp_len
operator|&&
name|resp
operator|->
name|resp_len
operator|<=
literal|4096
condition|)
break|break;
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|>=
name|softc
operator|->
name|hwrm_cmd_timeo
condition|)
block|{
name|device_printf
argument_list|(
name|softc
operator|->
name|dev
argument_list|,
literal|"Timeout sending %s: (timeout: %u) seq: %d\n"
argument_list|,
name|GET_HWRM_REQ_TYPE
argument_list|(
name|req
operator|->
name|req_type
argument_list|)
argument_list|,
name|softc
operator|->
name|hwrm_cmd_timeo
argument_list|,
name|le16toh
argument_list|(
name|req
operator|->
name|seq_id
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ETIMEDOUT
return|;
block|}
comment|/* Last byte of resp contains the valid key */
name|valid
operator|=
operator|(
name|uint8_t
operator|*
operator|)
name|resp
operator|+
name|resp
operator|->
name|resp_len
operator|-
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|softc
operator|->
name|hwrm_cmd_timeo
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|*
name|valid
operator|==
name|HWRM_RESP_VALID_KEY
condition|)
break|break;
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|>=
name|softc
operator|->
name|hwrm_cmd_timeo
condition|)
block|{
name|device_printf
argument_list|(
name|softc
operator|->
name|dev
argument_list|,
literal|"Timeout sending %s: "
literal|"(timeout: %u) msg {0x%x 0x%x} len:%d v: %d\n"
argument_list|,
name|GET_HWRM_REQ_TYPE
argument_list|(
name|req
operator|->
name|req_type
argument_list|)
argument_list|,
name|softc
operator|->
name|hwrm_cmd_timeo
argument_list|,
name|le16toh
argument_list|(
name|req
operator|->
name|req_type
argument_list|)
argument_list|,
name|le16toh
argument_list|(
name|req
operator|->
name|seq_id
argument_list|)
argument_list|,
name|msg_len
argument_list|,
operator|*
name|valid
argument_list|)
expr_stmt|;
return|return
name|ETIMEDOUT
return|;
block|}
name|err
operator|=
name|le16toh
argument_list|(
name|resp
operator|->
name|error_code
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
comment|/* HWRM_ERR_CODE_FAIL is a "normal" error, don't log */
if|if
condition|(
name|err
operator|!=
name|HWRM_ERR_CODE_FAIL
condition|)
block|{
name|device_printf
argument_list|(
name|softc
operator|->
name|dev
argument_list|,
literal|"%s command returned %s error.\n"
argument_list|,
name|GET_HWRM_REQ_TYPE
argument_list|(
name|req
operator|->
name|req_type
argument_list|)
argument_list|,
name|GET_HWRM_ERROR_CODE
argument_list|(
name|err
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|bnxt_hwrm_err_map
argument_list|(
name|err
argument_list|)
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hwrm_send_message
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|,
name|void
modifier|*
name|msg
parameter_list|,
name|uint32_t
name|msg_len
parameter_list|)
block|{
name|int
name|rc
decl_stmt|;
name|BNXT_HWRM_LOCK
argument_list|(
name|softc
argument_list|)
expr_stmt|;
name|rc
operator|=
name|_hwrm_send_message
argument_list|(
name|softc
argument_list|,
name|msg
argument_list|,
name|msg_len
argument_list|)
expr_stmt|;
name|BNXT_HWRM_UNLOCK
argument_list|(
name|softc
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
name|int
name|bnxt_hwrm_queue_qportcfg
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|)
block|{
name|struct
name|hwrm_queue_qportcfg_input
name|req
init|=
block|{
literal|0
block|}
decl_stmt|;
name|struct
name|hwrm_queue_qportcfg_output
modifier|*
name|resp
init|=
operator|(
name|void
operator|*
operator|)
name|softc
operator|->
name|hwrm_cmd_resp
operator|.
name|idi_vaddr
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|uint8_t
modifier|*
name|qptr
decl_stmt|;
name|bnxt_hwrm_cmd_hdr_init
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
name|HWRM_QUEUE_QPORTCFG
argument_list|)
expr_stmt|;
name|BNXT_HWRM_LOCK
argument_list|(
name|softc
argument_list|)
expr_stmt|;
name|rc
operator|=
name|_hwrm_send_message
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|qportcfg_exit
goto|;
if|if
condition|(
operator|!
name|resp
operator|->
name|max_configurable_queues
condition|)
block|{
name|rc
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|qportcfg_exit
goto|;
block|}
name|softc
operator|->
name|max_tc
operator|=
name|resp
operator|->
name|max_configurable_queues
expr_stmt|;
if|if
condition|(
name|softc
operator|->
name|max_tc
operator|>
name|BNXT_MAX_QUEUE
condition|)
name|softc
operator|->
name|max_tc
operator|=
name|BNXT_MAX_QUEUE
expr_stmt|;
name|qptr
operator|=
operator|&
name|resp
operator|->
name|queue_id0
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|softc
operator|->
name|max_tc
condition|;
name|i
operator|++
control|)
block|{
name|softc
operator|->
name|q_info
index|[
name|i
index|]
operator|.
name|id
operator|=
operator|*
name|qptr
operator|++
expr_stmt|;
name|softc
operator|->
name|q_info
index|[
name|i
index|]
operator|.
name|profile
operator|=
operator|*
name|qptr
operator|++
expr_stmt|;
block|}
name|qportcfg_exit
label|:
name|BNXT_HWRM_UNLOCK
argument_list|(
name|softc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
name|int
name|bnxt_hwrm_ver_get
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|)
block|{
name|struct
name|hwrm_ver_get_input
name|req
init|=
block|{
literal|0
block|}
decl_stmt|;
name|struct
name|hwrm_ver_get_output
modifier|*
name|resp
init|=
operator|(
name|void
operator|*
operator|)
name|softc
operator|->
name|hwrm_cmd_resp
operator|.
name|idi_vaddr
decl_stmt|;
name|int
name|rc
decl_stmt|;
specifier|const
name|char
name|nastr
index|[]
init|=
literal|"<not installed>"
decl_stmt|;
specifier|const
name|char
name|naver
index|[]
init|=
literal|"<N/A>"
decl_stmt|;
name|softc
operator|->
name|hwrm_max_req_len
operator|=
name|HWRM_MAX_REQ_LEN
expr_stmt|;
name|softc
operator|->
name|hwrm_cmd_timeo
operator|=
literal|1000
expr_stmt|;
name|bnxt_hwrm_cmd_hdr_init
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
name|HWRM_VER_GET
argument_list|)
expr_stmt|;
name|req
operator|.
name|hwrm_intf_maj
operator|=
name|HWRM_VERSION_MAJOR
expr_stmt|;
name|req
operator|.
name|hwrm_intf_min
operator|=
name|HWRM_VERSION_MINOR
expr_stmt|;
name|req
operator|.
name|hwrm_intf_upd
operator|=
name|HWRM_VERSION_UPDATE
expr_stmt|;
name|BNXT_HWRM_LOCK
argument_list|(
name|softc
argument_list|)
expr_stmt|;
name|rc
operator|=
name|_hwrm_send_message
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|fail
goto|;
name|snprintf
argument_list|(
name|softc
operator|->
name|ver_info
operator|->
name|hwrm_if_ver
argument_list|,
name|BNXT_VERSTR_SIZE
argument_list|,
literal|"%d.%d.%d"
argument_list|,
name|resp
operator|->
name|hwrm_intf_maj
argument_list|,
name|resp
operator|->
name|hwrm_intf_min
argument_list|,
name|resp
operator|->
name|hwrm_intf_upd
argument_list|)
expr_stmt|;
name|softc
operator|->
name|ver_info
operator|->
name|hwrm_if_major
operator|=
name|resp
operator|->
name|hwrm_intf_maj
expr_stmt|;
name|softc
operator|->
name|ver_info
operator|->
name|hwrm_if_minor
operator|=
name|resp
operator|->
name|hwrm_intf_min
expr_stmt|;
name|softc
operator|->
name|ver_info
operator|->
name|hwrm_if_update
operator|=
name|resp
operator|->
name|hwrm_intf_upd
expr_stmt|;
name|snprintf
argument_list|(
name|softc
operator|->
name|ver_info
operator|->
name|hwrm_fw_ver
argument_list|,
name|BNXT_VERSTR_SIZE
argument_list|,
literal|"%d.%d.%d"
argument_list|,
name|resp
operator|->
name|hwrm_fw_maj
argument_list|,
name|resp
operator|->
name|hwrm_fw_min
argument_list|,
name|resp
operator|->
name|hwrm_fw_bld
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|softc
operator|->
name|ver_info
operator|->
name|driver_hwrm_if_ver
argument_list|,
name|HWRM_VERSION_STR
argument_list|,
name|BNXT_VERSTR_SIZE
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|softc
operator|->
name|ver_info
operator|->
name|hwrm_fw_name
argument_list|,
name|resp
operator|->
name|hwrm_fw_name
argument_list|,
name|BNXT_NAME_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|resp
operator|->
name|mgmt_fw_maj
operator|==
literal|0
operator|&&
name|resp
operator|->
name|mgmt_fw_min
operator|==
literal|0
operator|&&
name|resp
operator|->
name|mgmt_fw_bld
operator|==
literal|0
condition|)
block|{
name|strlcpy
argument_list|(
name|softc
operator|->
name|ver_info
operator|->
name|mgmt_fw_ver
argument_list|,
name|naver
argument_list|,
name|BNXT_VERSTR_SIZE
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|softc
operator|->
name|ver_info
operator|->
name|mgmt_fw_name
argument_list|,
name|nastr
argument_list|,
name|BNXT_NAME_SIZE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|snprintf
argument_list|(
name|softc
operator|->
name|ver_info
operator|->
name|mgmt_fw_ver
argument_list|,
name|BNXT_VERSTR_SIZE
argument_list|,
literal|"%d.%d.%d"
argument_list|,
name|resp
operator|->
name|mgmt_fw_maj
argument_list|,
name|resp
operator|->
name|mgmt_fw_min
argument_list|,
name|resp
operator|->
name|mgmt_fw_bld
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|softc
operator|->
name|ver_info
operator|->
name|mgmt_fw_name
argument_list|,
name|resp
operator|->
name|mgmt_fw_name
argument_list|,
name|BNXT_NAME_SIZE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|resp
operator|->
name|netctrl_fw_maj
operator|==
literal|0
operator|&&
name|resp
operator|->
name|netctrl_fw_min
operator|==
literal|0
operator|&&
name|resp
operator|->
name|netctrl_fw_bld
operator|==
literal|0
condition|)
block|{
name|strlcpy
argument_list|(
name|softc
operator|->
name|ver_info
operator|->
name|netctrl_fw_ver
argument_list|,
name|naver
argument_list|,
name|BNXT_VERSTR_SIZE
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|softc
operator|->
name|ver_info
operator|->
name|netctrl_fw_name
argument_list|,
name|nastr
argument_list|,
name|BNXT_NAME_SIZE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|snprintf
argument_list|(
name|softc
operator|->
name|ver_info
operator|->
name|netctrl_fw_ver
argument_list|,
name|BNXT_VERSTR_SIZE
argument_list|,
literal|"%d.%d.%d"
argument_list|,
name|resp
operator|->
name|netctrl_fw_maj
argument_list|,
name|resp
operator|->
name|netctrl_fw_min
argument_list|,
name|resp
operator|->
name|netctrl_fw_bld
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|softc
operator|->
name|ver_info
operator|->
name|netctrl_fw_name
argument_list|,
name|resp
operator|->
name|netctrl_fw_name
argument_list|,
name|BNXT_NAME_SIZE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|resp
operator|->
name|roce_fw_maj
operator|==
literal|0
operator|&&
name|resp
operator|->
name|roce_fw_min
operator|==
literal|0
operator|&&
name|resp
operator|->
name|roce_fw_bld
operator|==
literal|0
condition|)
block|{
name|strlcpy
argument_list|(
name|softc
operator|->
name|ver_info
operator|->
name|roce_fw_ver
argument_list|,
name|naver
argument_list|,
name|BNXT_VERSTR_SIZE
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|softc
operator|->
name|ver_info
operator|->
name|roce_fw_name
argument_list|,
name|nastr
argument_list|,
name|BNXT_NAME_SIZE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|snprintf
argument_list|(
name|softc
operator|->
name|ver_info
operator|->
name|roce_fw_ver
argument_list|,
name|BNXT_VERSTR_SIZE
argument_list|,
literal|"%d.%d.%d"
argument_list|,
name|resp
operator|->
name|roce_fw_maj
argument_list|,
name|resp
operator|->
name|roce_fw_min
argument_list|,
name|resp
operator|->
name|roce_fw_bld
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|softc
operator|->
name|ver_info
operator|->
name|roce_fw_name
argument_list|,
name|resp
operator|->
name|roce_fw_name
argument_list|,
name|BNXT_NAME_SIZE
argument_list|)
expr_stmt|;
block|}
name|softc
operator|->
name|ver_info
operator|->
name|chip_num
operator|=
name|le16toh
argument_list|(
name|resp
operator|->
name|chip_num
argument_list|)
expr_stmt|;
name|softc
operator|->
name|ver_info
operator|->
name|chip_rev
operator|=
name|resp
operator|->
name|chip_rev
expr_stmt|;
name|softc
operator|->
name|ver_info
operator|->
name|chip_metal
operator|=
name|resp
operator|->
name|chip_metal
expr_stmt|;
name|softc
operator|->
name|ver_info
operator|->
name|chip_bond_id
operator|=
name|resp
operator|->
name|chip_bond_id
expr_stmt|;
name|softc
operator|->
name|ver_info
operator|->
name|chip_type
operator|=
name|resp
operator|->
name|chip_platform_type
expr_stmt|;
if|if
condition|(
name|resp
operator|->
name|max_req_win_len
condition|)
name|softc
operator|->
name|hwrm_max_req_len
operator|=
name|le16toh
argument_list|(
name|resp
operator|->
name|max_req_win_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|resp
operator|->
name|def_req_timeout
condition|)
name|softc
operator|->
name|hwrm_cmd_timeo
operator|=
name|le16toh
argument_list|(
name|resp
operator|->
name|def_req_timeout
argument_list|)
expr_stmt|;
name|fail
label|:
name|BNXT_HWRM_UNLOCK
argument_list|(
name|softc
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
name|int
name|bnxt_hwrm_func_drv_rgtr
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|)
block|{
name|struct
name|hwrm_func_drv_rgtr_input
name|req
init|=
block|{
literal|0
block|}
decl_stmt|;
name|bnxt_hwrm_cmd_hdr_init
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
name|HWRM_FUNC_DRV_RGTR
argument_list|)
expr_stmt|;
name|req
operator|.
name|enables
operator|=
name|htole32
argument_list|(
name|HWRM_FUNC_DRV_RGTR_INPUT_ENABLES_VER
operator||
name|HWRM_FUNC_DRV_RGTR_INPUT_ENABLES_OS_TYPE
argument_list|)
expr_stmt|;
name|req
operator|.
name|os_type
operator|=
name|htole16
argument_list|(
name|HWRM_FUNC_DRV_RGTR_INPUT_OS_TYPE_FREEBSD
argument_list|)
expr_stmt|;
name|req
operator|.
name|ver_maj
operator|=
name|__FreeBSD_version
operator|/
literal|100000
expr_stmt|;
name|req
operator|.
name|ver_min
operator|=
operator|(
name|__FreeBSD_version
operator|/
literal|1000
operator|)
operator|%
literal|100
expr_stmt|;
name|req
operator|.
name|ver_upd
operator|=
operator|(
name|__FreeBSD_version
operator|/
literal|100
operator|)
operator|%
literal|10
expr_stmt|;
return|return
name|hwrm_send_message
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|bnxt_hwrm_func_drv_unrgtr
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|,
name|bool
name|shutdown
parameter_list|)
block|{
name|struct
name|hwrm_func_drv_unrgtr_input
name|req
init|=
block|{
literal|0
block|}
decl_stmt|;
name|bnxt_hwrm_cmd_hdr_init
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
name|HWRM_FUNC_DRV_UNRGTR
argument_list|)
expr_stmt|;
if|if
condition|(
name|shutdown
operator|==
name|true
condition|)
name|req
operator|.
name|flags
operator||=
name|HWRM_FUNC_DRV_UNRGTR_INPUT_FLAGS_PREPARE_FOR_SHUTDOWN
expr_stmt|;
return|return
name|hwrm_send_message
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|int
name|_is_valid_ether_addr
parameter_list|(
name|uint8_t
modifier|*
name|addr
parameter_list|)
block|{
name|char
name|zero_addr
index|[
literal|6
index|]
init|=
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
if|if
condition|(
operator|(
name|addr
index|[
literal|0
index|]
operator|&
literal|1
operator|)
operator|||
operator|(
operator|!
name|bcmp
argument_list|(
name|addr
argument_list|,
name|zero_addr
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
operator|)
condition|)
return|return
operator|(
name|FALSE
operator|)
return|;
return|return
operator|(
name|TRUE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|get_random_ether_addr
parameter_list|(
name|uint8_t
modifier|*
name|addr
parameter_list|)
block|{
name|uint8_t
name|temp
index|[
name|ETHER_ADDR_LEN
index|]
decl_stmt|;
name|arc4rand
argument_list|(
operator|&
name|temp
argument_list|,
sizeof|sizeof
argument_list|(
name|temp
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|temp
index|[
literal|0
index|]
operator|&=
literal|0xFE
expr_stmt|;
name|temp
index|[
literal|0
index|]
operator||=
literal|0x02
expr_stmt|;
name|bcopy
argument_list|(
name|temp
argument_list|,
name|addr
argument_list|,
sizeof|sizeof
argument_list|(
name|temp
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|bnxt_hwrm_func_qcaps
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|)
block|{
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|struct
name|hwrm_func_qcaps_input
name|req
init|=
block|{
literal|0
block|}
decl_stmt|;
name|struct
name|hwrm_func_qcaps_output
modifier|*
name|resp
init|=
operator|(
name|void
operator|*
operator|)
name|softc
operator|->
name|hwrm_cmd_resp
operator|.
name|idi_vaddr
decl_stmt|;
name|struct
name|bnxt_func_info
modifier|*
name|func
init|=
operator|&
name|softc
operator|->
name|func
decl_stmt|;
name|bnxt_hwrm_cmd_hdr_init
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
name|HWRM_FUNC_QCAPS
argument_list|)
expr_stmt|;
name|req
operator|.
name|fid
operator|=
name|htole16
argument_list|(
literal|0xffff
argument_list|)
expr_stmt|;
name|BNXT_HWRM_LOCK
argument_list|(
name|softc
argument_list|)
expr_stmt|;
name|rc
operator|=
name|_hwrm_send_message
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|resp
operator|->
name|flags
operator|&
name|htole32
argument_list|(
name|HWRM_FUNC_QCAPS_OUTPUT_FLAGS_WOL_MAGICPKT_SUPPORTED
argument_list|)
condition|)
name|softc
operator|->
name|flags
operator||=
name|BNXT_FLAG_WOL_CAP
expr_stmt|;
name|func
operator|->
name|fw_fid
operator|=
name|le16toh
argument_list|(
name|resp
operator|->
name|fid
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|func
operator|->
name|mac_addr
argument_list|,
name|resp
operator|->
name|mac_address
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|func
operator|->
name|max_rsscos_ctxs
operator|=
name|le16toh
argument_list|(
name|resp
operator|->
name|max_rsscos_ctx
argument_list|)
expr_stmt|;
name|func
operator|->
name|max_cp_rings
operator|=
name|le16toh
argument_list|(
name|resp
operator|->
name|max_cmpl_rings
argument_list|)
expr_stmt|;
name|func
operator|->
name|max_tx_rings
operator|=
name|le16toh
argument_list|(
name|resp
operator|->
name|max_tx_rings
argument_list|)
expr_stmt|;
name|func
operator|->
name|max_rx_rings
operator|=
name|le16toh
argument_list|(
name|resp
operator|->
name|max_rx_rings
argument_list|)
expr_stmt|;
name|func
operator|->
name|max_hw_ring_grps
operator|=
name|le32toh
argument_list|(
name|resp
operator|->
name|max_hw_ring_grps
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|func
operator|->
name|max_hw_ring_grps
condition|)
name|func
operator|->
name|max_hw_ring_grps
operator|=
name|func
operator|->
name|max_tx_rings
expr_stmt|;
name|func
operator|->
name|max_l2_ctxs
operator|=
name|le16toh
argument_list|(
name|resp
operator|->
name|max_l2_ctxs
argument_list|)
expr_stmt|;
name|func
operator|->
name|max_vnics
operator|=
name|le16toh
argument_list|(
name|resp
operator|->
name|max_vnics
argument_list|)
expr_stmt|;
name|func
operator|->
name|max_stat_ctxs
operator|=
name|le16toh
argument_list|(
name|resp
operator|->
name|max_stat_ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|BNXT_PF
argument_list|(
name|softc
argument_list|)
condition|)
block|{
name|struct
name|bnxt_pf_info
modifier|*
name|pf
init|=
operator|&
name|softc
operator|->
name|pf
decl_stmt|;
name|pf
operator|->
name|port_id
operator|=
name|le16toh
argument_list|(
name|resp
operator|->
name|port_id
argument_list|)
expr_stmt|;
name|pf
operator|->
name|first_vf_id
operator|=
name|le16toh
argument_list|(
name|resp
operator|->
name|first_vf_id
argument_list|)
expr_stmt|;
name|pf
operator|->
name|max_vfs
operator|=
name|le16toh
argument_list|(
name|resp
operator|->
name|max_vfs
argument_list|)
expr_stmt|;
name|pf
operator|->
name|max_encap_records
operator|=
name|le32toh
argument_list|(
name|resp
operator|->
name|max_encap_records
argument_list|)
expr_stmt|;
name|pf
operator|->
name|max_decap_records
operator|=
name|le32toh
argument_list|(
name|resp
operator|->
name|max_decap_records
argument_list|)
expr_stmt|;
name|pf
operator|->
name|max_tx_em_flows
operator|=
name|le32toh
argument_list|(
name|resp
operator|->
name|max_tx_em_flows
argument_list|)
expr_stmt|;
name|pf
operator|->
name|max_tx_wm_flows
operator|=
name|le32toh
argument_list|(
name|resp
operator|->
name|max_tx_wm_flows
argument_list|)
expr_stmt|;
name|pf
operator|->
name|max_rx_em_flows
operator|=
name|le32toh
argument_list|(
name|resp
operator|->
name|max_rx_em_flows
argument_list|)
expr_stmt|;
name|pf
operator|->
name|max_rx_wm_flows
operator|=
name|le32toh
argument_list|(
name|resp
operator|->
name|max_rx_wm_flows
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|_is_valid_ether_addr
argument_list|(
name|func
operator|->
name|mac_addr
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|softc
operator|->
name|dev
argument_list|,
literal|"Invalid ethernet address, generating random locally administered address\n"
argument_list|)
expr_stmt|;
name|get_random_ether_addr
argument_list|(
name|func
operator|->
name|mac_addr
argument_list|)
expr_stmt|;
block|}
name|fail
label|:
name|BNXT_HWRM_UNLOCK
argument_list|(
name|softc
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
name|int
name|bnxt_hwrm_func_qcfg
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|)
block|{
name|struct
name|hwrm_func_qcfg_input
name|req
init|=
block|{
literal|0
block|}
decl_stmt|;
name|struct
name|hwrm_func_qcfg_output
modifier|*
name|resp
init|=
operator|(
name|void
operator|*
operator|)
name|softc
operator|->
name|hwrm_cmd_resp
operator|.
name|idi_vaddr
decl_stmt|;
name|struct
name|bnxt_func_qcfg
modifier|*
name|fn_qcfg
init|=
operator|&
name|softc
operator|->
name|fn_qcfg
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|bnxt_hwrm_cmd_hdr_init
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
name|HWRM_FUNC_QCFG
argument_list|)
expr_stmt|;
name|req
operator|.
name|fid
operator|=
name|htole16
argument_list|(
literal|0xffff
argument_list|)
expr_stmt|;
name|BNXT_HWRM_LOCK
argument_list|(
name|softc
argument_list|)
expr_stmt|;
name|rc
operator|=
name|_hwrm_send_message
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|fail
goto|;
name|fn_qcfg
operator|->
name|alloc_completion_rings
operator|=
name|le16toh
argument_list|(
name|resp
operator|->
name|alloc_cmpl_rings
argument_list|)
expr_stmt|;
name|fn_qcfg
operator|->
name|alloc_tx_rings
operator|=
name|le16toh
argument_list|(
name|resp
operator|->
name|alloc_tx_rings
argument_list|)
expr_stmt|;
name|fn_qcfg
operator|->
name|alloc_rx_rings
operator|=
name|le16toh
argument_list|(
name|resp
operator|->
name|alloc_rx_rings
argument_list|)
expr_stmt|;
name|fn_qcfg
operator|->
name|alloc_vnics
operator|=
name|le16toh
argument_list|(
name|resp
operator|->
name|alloc_vnics
argument_list|)
expr_stmt|;
name|fail
label|:
name|BNXT_HWRM_UNLOCK
argument_list|(
name|softc
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
name|int
name|bnxt_hwrm_func_reset
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|)
block|{
name|struct
name|hwrm_func_reset_input
name|req
init|=
block|{
literal|0
block|}
decl_stmt|;
name|bnxt_hwrm_cmd_hdr_init
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
name|HWRM_FUNC_RESET
argument_list|)
expr_stmt|;
name|req
operator|.
name|enables
operator|=
literal|0
expr_stmt|;
return|return
name|hwrm_send_message
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bnxt_hwrm_set_link_common
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|,
name|struct
name|hwrm_port_phy_cfg_input
modifier|*
name|req
parameter_list|)
block|{
name|uint8_t
name|autoneg
init|=
name|softc
operator|->
name|link_info
operator|.
name|autoneg
decl_stmt|;
name|uint16_t
name|fw_link_speed
init|=
name|softc
operator|->
name|link_info
operator|.
name|req_link_speed
decl_stmt|;
if|if
condition|(
name|autoneg
operator|&
name|BNXT_AUTONEG_SPEED
condition|)
block|{
name|req
operator|->
name|auto_mode
operator||=
name|HWRM_PORT_PHY_CFG_INPUT_AUTO_MODE_ALL_SPEEDS
expr_stmt|;
name|req
operator|->
name|enables
operator||=
name|htole32
argument_list|(
name|HWRM_PORT_PHY_CFG_INPUT_ENABLES_AUTO_MODE
argument_list|)
expr_stmt|;
name|req
operator|->
name|flags
operator||=
name|htole32
argument_list|(
name|HWRM_PORT_PHY_CFG_INPUT_FLAGS_RESTART_AUTONEG
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|req
operator|->
name|force_link_speed
operator|=
name|htole16
argument_list|(
name|fw_link_speed
argument_list|)
expr_stmt|;
name|req
operator|->
name|flags
operator||=
name|htole32
argument_list|(
name|HWRM_PORT_PHY_CFG_INPUT_FLAGS_FORCE
argument_list|)
expr_stmt|;
block|}
comment|/* tell chimp that the setting takes effect immediately */
name|req
operator|->
name|flags
operator||=
name|htole32
argument_list|(
name|HWRM_PORT_PHY_CFG_INPUT_FLAGS_RESET_PHY
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bnxt_hwrm_set_pause_common
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|,
name|struct
name|hwrm_port_phy_cfg_input
modifier|*
name|req
parameter_list|)
block|{
if|if
condition|(
name|softc
operator|->
name|link_info
operator|.
name|autoneg
operator|&
name|BNXT_AUTONEG_FLOW_CTRL
condition|)
block|{
name|req
operator|->
name|auto_pause
operator|=
name|HWRM_PORT_PHY_CFG_INPUT_AUTO_PAUSE_AUTONEG_PAUSE
expr_stmt|;
if|if
condition|(
name|softc
operator|->
name|link_info
operator|.
name|req_flow_ctrl
operator|&
name|HWRM_PORT_PHY_QCFG_OUTPUT_PAUSE_RX
condition|)
name|req
operator|->
name|auto_pause
operator||=
name|HWRM_PORT_PHY_CFG_INPUT_AUTO_PAUSE_RX
expr_stmt|;
if|if
condition|(
name|softc
operator|->
name|link_info
operator|.
name|req_flow_ctrl
operator|&
name|HWRM_PORT_PHY_QCFG_OUTPUT_PAUSE_TX
condition|)
name|req
operator|->
name|auto_pause
operator||=
name|HWRM_PORT_PHY_CFG_INPUT_AUTO_PAUSE_RX
expr_stmt|;
name|req
operator|->
name|enables
operator||=
name|htole32
argument_list|(
name|HWRM_PORT_PHY_CFG_INPUT_ENABLES_AUTO_PAUSE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|softc
operator|->
name|link_info
operator|.
name|req_flow_ctrl
operator|&
name|HWRM_PORT_PHY_QCFG_OUTPUT_PAUSE_RX
condition|)
name|req
operator|->
name|force_pause
operator||=
name|HWRM_PORT_PHY_CFG_INPUT_FORCE_PAUSE_RX
expr_stmt|;
if|if
condition|(
name|softc
operator|->
name|link_info
operator|.
name|req_flow_ctrl
operator|&
name|HWRM_PORT_PHY_QCFG_OUTPUT_PAUSE_TX
condition|)
name|req
operator|->
name|force_pause
operator||=
name|HWRM_PORT_PHY_CFG_INPUT_FORCE_PAUSE_TX
expr_stmt|;
name|req
operator|->
name|enables
operator||=
name|htole32
argument_list|(
name|HWRM_PORT_PHY_CFG_INPUT_ENABLES_FORCE_PAUSE
argument_list|)
expr_stmt|;
name|req
operator|->
name|auto_pause
operator|=
name|req
operator|->
name|force_pause
expr_stmt|;
name|req
operator|->
name|enables
operator||=
name|htole32
argument_list|(
name|HWRM_PORT_PHY_CFG_INPUT_ENABLES_AUTO_PAUSE
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* JFV this needs interface connection */
end_comment

begin_function
specifier|static
name|void
name|bnxt_hwrm_set_eee
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|,
name|struct
name|hwrm_port_phy_cfg_input
modifier|*
name|req
parameter_list|)
block|{
comment|/* struct ethtool_eee *eee =&softc->eee; */
name|bool
name|eee_enabled
init|=
name|false
decl_stmt|;
if|if
condition|(
name|eee_enabled
condition|)
block|{
if|#
directive|if
literal|0
block|uint16_t eee_speeds; 		uint32_t flags = HWRM_PORT_PHY_CFG_INPUT_FLAGS_EEE_ENABLE;  		if (eee->tx_lpi_enabled) 			flags |= HWRM_PORT_PHY_CFG_INPUT_FLAGS_EEE_TX_LPI;  		req->flags |= htole32(flags); 		eee_speeds = bnxt_get_fw_auto_link_speeds(eee->advertised); 		req->eee_link_speed_mask = htole16(eee_speeds); 		req->tx_lpi_timer = htole32(eee->tx_lpi_timer);
endif|#
directive|endif
block|}
else|else
block|{
name|req
operator|->
name|flags
operator||=
name|htole32
argument_list|(
name|HWRM_PORT_PHY_CFG_INPUT_FLAGS_EEE_DISABLE
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|bnxt_hwrm_set_link_setting
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|,
name|bool
name|set_pause
parameter_list|,
name|bool
name|set_eee
parameter_list|)
block|{
name|struct
name|hwrm_port_phy_cfg_input
name|req
init|=
block|{
literal|0
block|}
decl_stmt|;
if|if
condition|(
name|softc
operator|->
name|flags
operator|&
name|BNXT_FLAG_NPAR
condition|)
return|return
name|ENOTSUP
return|;
name|bnxt_hwrm_cmd_hdr_init
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
name|HWRM_PORT_PHY_CFG
argument_list|)
expr_stmt|;
if|if
condition|(
name|set_pause
condition|)
name|bnxt_hwrm_set_pause_common
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
name|bnxt_hwrm_set_link_common
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|set_eee
condition|)
name|bnxt_hwrm_set_eee
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
return|return
name|hwrm_send_message
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|bnxt_hwrm_set_pause
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|)
block|{
name|struct
name|hwrm_port_phy_cfg_input
name|req
init|=
block|{
literal|0
block|}
decl_stmt|;
name|int
name|rc
decl_stmt|;
if|if
condition|(
name|softc
operator|->
name|flags
operator|&
name|BNXT_FLAG_NPAR
condition|)
return|return
name|ENOTSUP
return|;
name|bnxt_hwrm_cmd_hdr_init
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
name|HWRM_PORT_PHY_CFG
argument_list|)
expr_stmt|;
name|bnxt_hwrm_set_pause_common
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|softc
operator|->
name|link_info
operator|.
name|autoneg
operator|&
name|BNXT_AUTONEG_FLOW_CTRL
condition|)
name|bnxt_hwrm_set_link_common
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
name|BNXT_HWRM_LOCK
argument_list|(
name|softc
argument_list|)
expr_stmt|;
name|rc
operator|=
name|_hwrm_send_message
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rc
operator|&&
operator|!
operator|(
name|softc
operator|->
name|link_info
operator|.
name|autoneg
operator|&
name|BNXT_AUTONEG_FLOW_CTRL
operator|)
condition|)
block|{
comment|/* since changing of pause setting doesn't trigger any link 		 * change event, the driver needs to update the current pause 		 * result upon successfully return of the phy_cfg command */
name|softc
operator|->
name|link_info
operator|.
name|pause
operator|=
name|softc
operator|->
name|link_info
operator|.
name|force_pause
operator|=
name|softc
operator|->
name|link_info
operator|.
name|req_flow_ctrl
expr_stmt|;
name|softc
operator|->
name|link_info
operator|.
name|auto_pause
operator|=
literal|0
expr_stmt|;
name|bnxt_report_link
argument_list|(
name|softc
argument_list|)
expr_stmt|;
block|}
name|BNXT_HWRM_UNLOCK
argument_list|(
name|softc
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
name|int
name|bnxt_hwrm_vnic_cfg
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|,
name|struct
name|bnxt_vnic_info
modifier|*
name|vnic
parameter_list|)
block|{
name|struct
name|hwrm_vnic_cfg_input
name|req
init|=
block|{
literal|0
block|}
decl_stmt|;
name|struct
name|hwrm_vnic_cfg_output
modifier|*
name|resp
decl_stmt|;
name|resp
operator|=
operator|(
name|void
operator|*
operator|)
name|softc
operator|->
name|hwrm_cmd_resp
operator|.
name|idi_vaddr
expr_stmt|;
name|bnxt_hwrm_cmd_hdr_init
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
name|HWRM_VNIC_CFG
argument_list|)
expr_stmt|;
if|if
condition|(
name|vnic
operator|->
name|flags
operator|&
name|BNXT_VNIC_FLAG_DEFAULT
condition|)
name|req
operator|.
name|flags
operator||=
name|htole32
argument_list|(
name|HWRM_VNIC_CFG_INPUT_FLAGS_DEFAULT
argument_list|)
expr_stmt|;
if|if
condition|(
name|vnic
operator|->
name|flags
operator|&
name|BNXT_VNIC_FLAG_BD_STALL
condition|)
name|req
operator|.
name|flags
operator||=
name|htole32
argument_list|(
name|HWRM_VNIC_CFG_INPUT_FLAGS_BD_STALL_MODE
argument_list|)
expr_stmt|;
if|if
condition|(
name|vnic
operator|->
name|flags
operator|&
name|BNXT_VNIC_FLAG_VLAN_STRIP
condition|)
name|req
operator|.
name|flags
operator||=
name|htole32
argument_list|(
name|HWRM_VNIC_CFG_INPUT_FLAGS_VLAN_STRIP_MODE
argument_list|)
expr_stmt|;
name|req
operator|.
name|enables
operator|=
name|htole32
argument_list|(
name|HWRM_VNIC_CFG_INPUT_ENABLES_DFLT_RING_GRP
operator||
name|HWRM_VNIC_CFG_INPUT_ENABLES_RSS_RULE
operator||
name|HWRM_VNIC_CFG_INPUT_ENABLES_MRU
argument_list|)
expr_stmt|;
name|req
operator|.
name|vnic_id
operator|=
name|htole16
argument_list|(
name|vnic
operator|->
name|id
argument_list|)
expr_stmt|;
name|req
operator|.
name|dflt_ring_grp
operator|=
name|htole16
argument_list|(
name|vnic
operator|->
name|def_ring_grp
argument_list|)
expr_stmt|;
name|req
operator|.
name|rss_rule
operator|=
name|htole16
argument_list|(
name|vnic
operator|->
name|rss_id
argument_list|)
expr_stmt|;
name|req
operator|.
name|cos_rule
operator|=
name|htole16
argument_list|(
name|vnic
operator|->
name|cos_rule
argument_list|)
expr_stmt|;
name|req
operator|.
name|lb_rule
operator|=
name|htole16
argument_list|(
name|vnic
operator|->
name|lb_rule
argument_list|)
expr_stmt|;
name|req
operator|.
name|mru
operator|=
name|htole16
argument_list|(
name|vnic
operator|->
name|mru
argument_list|)
expr_stmt|;
return|return
name|hwrm_send_message
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|bnxt_hwrm_vnic_alloc
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|,
name|struct
name|bnxt_vnic_info
modifier|*
name|vnic
parameter_list|)
block|{
name|struct
name|hwrm_vnic_alloc_input
name|req
init|=
block|{
literal|0
block|}
decl_stmt|;
name|struct
name|hwrm_vnic_alloc_output
modifier|*
name|resp
init|=
operator|(
name|void
operator|*
operator|)
name|softc
operator|->
name|hwrm_cmd_resp
operator|.
name|idi_vaddr
decl_stmt|;
name|int
name|rc
decl_stmt|;
if|if
condition|(
name|vnic
operator|->
name|id
operator|!=
operator|(
name|uint16_t
operator|)
name|HWRM_NA_SIGNATURE
condition|)
block|{
name|device_printf
argument_list|(
name|softc
operator|->
name|dev
argument_list|,
literal|"Attempt to re-allocate vnic %04x\n"
argument_list|,
name|vnic
operator|->
name|id
argument_list|)
expr_stmt|;
return|return
name|EDOOFUS
return|;
block|}
name|bnxt_hwrm_cmd_hdr_init
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
name|HWRM_VNIC_ALLOC
argument_list|)
expr_stmt|;
if|if
condition|(
name|vnic
operator|->
name|flags
operator|&
name|BNXT_VNIC_FLAG_DEFAULT
condition|)
name|req
operator|.
name|flags
operator|=
name|htole32
argument_list|(
name|HWRM_VNIC_ALLOC_INPUT_FLAGS_DEFAULT
argument_list|)
expr_stmt|;
name|BNXT_HWRM_LOCK
argument_list|(
name|softc
argument_list|)
expr_stmt|;
name|rc
operator|=
name|_hwrm_send_message
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|fail
goto|;
name|vnic
operator|->
name|id
operator|=
name|le32toh
argument_list|(
name|resp
operator|->
name|vnic_id
argument_list|)
expr_stmt|;
name|fail
label|:
name|BNXT_HWRM_UNLOCK
argument_list|(
name|softc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
name|int
name|bnxt_hwrm_vnic_ctx_alloc
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|,
name|uint16_t
modifier|*
name|ctx_id
parameter_list|)
block|{
name|struct
name|hwrm_vnic_rss_cos_lb_ctx_alloc_input
name|req
init|=
block|{
literal|0
block|}
decl_stmt|;
name|struct
name|hwrm_vnic_rss_cos_lb_ctx_alloc_output
modifier|*
name|resp
init|=
operator|(
name|void
operator|*
operator|)
name|softc
operator|->
name|hwrm_cmd_resp
operator|.
name|idi_vaddr
decl_stmt|;
name|int
name|rc
decl_stmt|;
if|if
condition|(
operator|*
name|ctx_id
operator|!=
operator|(
name|uint16_t
operator|)
name|HWRM_NA_SIGNATURE
condition|)
block|{
name|device_printf
argument_list|(
name|softc
operator|->
name|dev
argument_list|,
literal|"Attempt to re-allocate vnic ctx %04x\n"
argument_list|,
operator|*
name|ctx_id
argument_list|)
expr_stmt|;
return|return
name|EDOOFUS
return|;
block|}
name|bnxt_hwrm_cmd_hdr_init
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
name|HWRM_VNIC_RSS_COS_LB_CTX_ALLOC
argument_list|)
expr_stmt|;
name|BNXT_HWRM_LOCK
argument_list|(
name|softc
argument_list|)
expr_stmt|;
name|rc
operator|=
name|_hwrm_send_message
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|fail
goto|;
operator|*
name|ctx_id
operator|=
name|le32toh
argument_list|(
name|resp
operator|->
name|rss_cos_lb_ctx_id
argument_list|)
expr_stmt|;
name|fail
label|:
name|BNXT_HWRM_UNLOCK
argument_list|(
name|softc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
name|int
name|bnxt_hwrm_ring_grp_alloc
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|,
name|struct
name|bnxt_grp_info
modifier|*
name|grp
parameter_list|)
block|{
name|struct
name|hwrm_ring_grp_alloc_input
name|req
init|=
block|{
literal|0
block|}
decl_stmt|;
name|struct
name|hwrm_ring_grp_alloc_output
modifier|*
name|resp
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|grp
operator|->
name|grp_id
operator|!=
operator|(
name|uint16_t
operator|)
name|HWRM_NA_SIGNATURE
condition|)
block|{
name|device_printf
argument_list|(
name|softc
operator|->
name|dev
argument_list|,
literal|"Attempt to re-allocate ring group %04x\n"
argument_list|,
name|grp
operator|->
name|grp_id
argument_list|)
expr_stmt|;
return|return
name|EDOOFUS
return|;
block|}
name|resp
operator|=
operator|(
name|void
operator|*
operator|)
name|softc
operator|->
name|hwrm_cmd_resp
operator|.
name|idi_vaddr
expr_stmt|;
name|bnxt_hwrm_cmd_hdr_init
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
name|HWRM_RING_GRP_ALLOC
argument_list|)
expr_stmt|;
name|req
operator|.
name|cr
operator|=
name|htole16
argument_list|(
name|grp
operator|->
name|cp_ring_id
argument_list|)
expr_stmt|;
name|req
operator|.
name|rr
operator|=
name|htole16
argument_list|(
name|grp
operator|->
name|rx_ring_id
argument_list|)
expr_stmt|;
name|req
operator|.
name|ar
operator|=
name|htole16
argument_list|(
name|grp
operator|->
name|ag_ring_id
argument_list|)
expr_stmt|;
name|req
operator|.
name|sc
operator|=
name|htole16
argument_list|(
name|grp
operator|->
name|stats_ctx
argument_list|)
expr_stmt|;
name|BNXT_HWRM_LOCK
argument_list|(
name|softc
argument_list|)
expr_stmt|;
name|rc
operator|=
name|_hwrm_send_message
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|fail
goto|;
name|grp
operator|->
name|grp_id
operator|=
name|le32toh
argument_list|(
name|resp
operator|->
name|ring_group_id
argument_list|)
expr_stmt|;
name|fail
label|:
name|BNXT_HWRM_UNLOCK
argument_list|(
name|softc
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_comment
comment|/*  * Ring allocation message to the firmware  */
end_comment

begin_function
name|int
name|bnxt_hwrm_ring_alloc
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|,
name|uint8_t
name|type
parameter_list|,
name|struct
name|bnxt_ring
modifier|*
name|ring
parameter_list|,
name|uint16_t
name|cmpl_ring_id
parameter_list|,
name|uint32_t
name|stat_ctx_id
parameter_list|,
name|bool
name|irq
parameter_list|)
block|{
name|struct
name|hwrm_ring_alloc_input
name|req
init|=
block|{
literal|0
block|}
decl_stmt|;
name|struct
name|hwrm_ring_alloc_output
modifier|*
name|resp
decl_stmt|;
name|int
name|rc
decl_stmt|;
if|if
condition|(
name|ring
operator|->
name|phys_id
operator|!=
operator|(
name|uint16_t
operator|)
name|HWRM_NA_SIGNATURE
condition|)
block|{
name|device_printf
argument_list|(
name|softc
operator|->
name|dev
argument_list|,
literal|"Attempt to re-allocate ring %04x\n"
argument_list|,
name|ring
operator|->
name|phys_id
argument_list|)
expr_stmt|;
return|return
name|EDOOFUS
return|;
block|}
name|resp
operator|=
operator|(
name|void
operator|*
operator|)
name|softc
operator|->
name|hwrm_cmd_resp
operator|.
name|idi_vaddr
expr_stmt|;
name|bnxt_hwrm_cmd_hdr_init
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
name|HWRM_RING_ALLOC
argument_list|)
expr_stmt|;
name|req
operator|.
name|enables
operator|=
name|htole32
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|req
operator|.
name|fbo
operator|=
name|htole32
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|stat_ctx_id
operator|!=
name|HWRM_NA_SIGNATURE
condition|)
block|{
name|req
operator|.
name|enables
operator||=
name|htole32
argument_list|(
name|HWRM_RING_ALLOC_INPUT_ENABLES_STAT_CTX_ID_VALID
argument_list|)
expr_stmt|;
name|req
operator|.
name|stat_ctx_id
operator|=
name|htole32
argument_list|(
name|stat_ctx_id
argument_list|)
expr_stmt|;
block|}
name|req
operator|.
name|ring_type
operator|=
name|type
expr_stmt|;
name|req
operator|.
name|page_tbl_addr
operator|=
name|htole64
argument_list|(
name|ring
operator|->
name|paddr
argument_list|)
expr_stmt|;
name|req
operator|.
name|length
operator|=
name|htole32
argument_list|(
name|ring
operator|->
name|ring_size
argument_list|)
expr_stmt|;
name|req
operator|.
name|logical_id
operator|=
name|htole16
argument_list|(
name|ring
operator|->
name|id
argument_list|)
expr_stmt|;
name|req
operator|.
name|cmpl_ring_id
operator|=
name|htole16
argument_list|(
name|cmpl_ring_id
argument_list|)
expr_stmt|;
name|req
operator|.
name|queue_id
operator|=
name|htole16
argument_list|(
name|softc
operator|->
name|q_info
index|[
literal|0
index|]
operator|.
name|id
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
comment|/* MODE_POLL appears to crash the firmware */
block|if (irq) 		req.int_mode = HWRM_RING_ALLOC_INPUT_INT_MODE_MSIX; 	else 		req.int_mode = HWRM_RING_ALLOC_INPUT_INT_MODE_POLL;
else|#
directive|else
name|req
operator|.
name|int_mode
operator|=
name|HWRM_RING_ALLOC_INPUT_INT_MODE_MSIX
expr_stmt|;
endif|#
directive|endif
name|BNXT_HWRM_LOCK
argument_list|(
name|softc
argument_list|)
expr_stmt|;
name|rc
operator|=
name|_hwrm_send_message
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|fail
goto|;
name|ring
operator|->
name|phys_id
operator|=
name|le16toh
argument_list|(
name|resp
operator|->
name|ring_id
argument_list|)
expr_stmt|;
name|fail
label|:
name|BNXT_HWRM_UNLOCK
argument_list|(
name|softc
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
name|int
name|bnxt_hwrm_stat_ctx_alloc
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|,
name|struct
name|bnxt_cp_ring
modifier|*
name|cpr
parameter_list|,
name|uint64_t
name|paddr
parameter_list|)
block|{
name|struct
name|hwrm_stat_ctx_alloc_input
name|req
init|=
block|{
literal|0
block|}
decl_stmt|;
name|struct
name|hwrm_stat_ctx_alloc_output
modifier|*
name|resp
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|cpr
operator|->
name|stats_ctx_id
operator|!=
name|HWRM_NA_SIGNATURE
condition|)
block|{
name|device_printf
argument_list|(
name|softc
operator|->
name|dev
argument_list|,
literal|"Attempt to re-allocate stats ctx %08x\n"
argument_list|,
name|cpr
operator|->
name|stats_ctx_id
argument_list|)
expr_stmt|;
return|return
name|EDOOFUS
return|;
block|}
name|resp
operator|=
operator|(
name|void
operator|*
operator|)
name|softc
operator|->
name|hwrm_cmd_resp
operator|.
name|idi_vaddr
expr_stmt|;
name|bnxt_hwrm_cmd_hdr_init
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
name|HWRM_STAT_CTX_ALLOC
argument_list|)
expr_stmt|;
name|req
operator|.
name|update_period_ms
operator|=
name|htole32
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
name|req
operator|.
name|stats_dma_addr
operator|=
name|htole64
argument_list|(
name|paddr
argument_list|)
expr_stmt|;
name|BNXT_HWRM_LOCK
argument_list|(
name|softc
argument_list|)
expr_stmt|;
name|rc
operator|=
name|_hwrm_send_message
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|fail
goto|;
name|cpr
operator|->
name|stats_ctx_id
operator|=
name|le32toh
argument_list|(
name|resp
operator|->
name|stat_ctx_id
argument_list|)
expr_stmt|;
name|fail
label|:
name|BNXT_HWRM_UNLOCK
argument_list|(
name|softc
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
name|int
name|bnxt_hwrm_port_qstats
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|)
block|{
name|struct
name|hwrm_port_qstats_input
name|req
init|=
block|{
literal|0
block|}
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|bnxt_hwrm_cmd_hdr_init
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
name|HWRM_PORT_QSTATS
argument_list|)
expr_stmt|;
name|req
operator|.
name|port_id
operator|=
name|htole16
argument_list|(
name|softc
operator|->
name|pf
operator|.
name|port_id
argument_list|)
expr_stmt|;
name|req
operator|.
name|rx_stat_host_addr
operator|=
name|htole64
argument_list|(
name|softc
operator|->
name|hw_rx_port_stats
operator|.
name|idi_paddr
argument_list|)
expr_stmt|;
name|req
operator|.
name|tx_stat_host_addr
operator|=
name|htole64
argument_list|(
name|softc
operator|->
name|hw_tx_port_stats
operator|.
name|idi_paddr
argument_list|)
expr_stmt|;
name|BNXT_HWRM_LOCK
argument_list|(
name|softc
argument_list|)
expr_stmt|;
name|rc
operator|=
name|_hwrm_send_message
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|BNXT_HWRM_UNLOCK
argument_list|(
name|softc
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
name|int
name|bnxt_hwrm_cfa_l2_set_rx_mask
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|,
name|struct
name|bnxt_vnic_info
modifier|*
name|vnic
parameter_list|)
block|{
name|struct
name|hwrm_cfa_l2_set_rx_mask_input
name|req
init|=
block|{
literal|0
block|}
decl_stmt|;
name|struct
name|bnxt_vlan_tag
modifier|*
name|tag
decl_stmt|;
name|uint32_t
modifier|*
name|tags
decl_stmt|;
name|uint32_t
name|num_vlan_tags
init|=
literal|0
decl_stmt|;
empty_stmt|;
name|uint32_t
name|i
decl_stmt|;
name|uint32_t
name|mask
init|=
name|vnic
operator|->
name|rx_mask
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|SLIST_FOREACH
argument_list|(
argument|tag
argument_list|,
argument|&vnic->vlan_tags
argument_list|,
argument|next
argument_list|)
name|num_vlan_tags
operator|++
expr_stmt|;
if|if
condition|(
name|num_vlan_tags
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|mask
operator|&
name|HWRM_CFA_L2_SET_RX_MASK_INPUT_MASK_ANYVLAN_NONVLAN
operator|)
condition|)
block|{
if|if
condition|(
operator|!
name|vnic
operator|->
name|vlan_only
condition|)
name|mask
operator||=
name|HWRM_CFA_L2_SET_RX_MASK_INPUT_MASK_VLAN_NONVLAN
expr_stmt|;
else|else
name|mask
operator||=
name|HWRM_CFA_L2_SET_RX_MASK_INPUT_MASK_VLANONLY
expr_stmt|;
block|}
if|if
condition|(
name|vnic
operator|->
name|vlan_tag_list
operator|.
name|idi_vaddr
condition|)
block|{
name|iflib_dma_free
argument_list|(
operator|&
name|vnic
operator|->
name|vlan_tag_list
argument_list|)
expr_stmt|;
name|vnic
operator|->
name|vlan_tag_list
operator|.
name|idi_vaddr
operator|=
name|NULL
expr_stmt|;
block|}
name|rc
operator|=
name|iflib_dma_alloc
argument_list|(
name|softc
operator|->
name|ctx
argument_list|,
literal|4
operator|*
name|num_vlan_tags
argument_list|,
operator|&
name|vnic
operator|->
name|vlan_tag_list
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
return|return
name|rc
return|;
name|tags
operator|=
operator|(
name|uint32_t
operator|*
operator|)
name|vnic
operator|->
name|vlan_tag_list
operator|.
name|idi_vaddr
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
name|SLIST_FOREACH
argument_list|(
argument|tag
argument_list|,
argument|&vnic->vlan_tags
argument_list|,
argument|next
argument_list|)
block|{
name|tags
index|[
name|i
index|]
operator|=
name|htole32
argument_list|(
operator|(
name|tag
operator|->
name|tpid
operator|<<
literal|16
operator|)
operator||
name|tag
operator|->
name|tag
argument_list|)
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
block|}
name|bnxt_hwrm_cmd_hdr_init
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
name|HWRM_CFA_L2_SET_RX_MASK
argument_list|)
expr_stmt|;
name|req
operator|.
name|vnic_id
operator|=
name|htole32
argument_list|(
name|vnic
operator|->
name|id
argument_list|)
expr_stmt|;
name|req
operator|.
name|mask
operator|=
name|htole32
argument_list|(
name|mask
argument_list|)
expr_stmt|;
name|req
operator|.
name|mc_tbl_addr
operator|=
name|htole64
argument_list|(
name|vnic
operator|->
name|mc_list
operator|.
name|idi_paddr
argument_list|)
expr_stmt|;
name|req
operator|.
name|num_mc_entries
operator|=
name|htole32
argument_list|(
name|vnic
operator|->
name|mc_list_count
argument_list|)
expr_stmt|;
name|req
operator|.
name|vlan_tag_tbl_addr
operator|=
name|htole64
argument_list|(
name|vnic
operator|->
name|vlan_tag_list
operator|.
name|idi_paddr
argument_list|)
expr_stmt|;
name|req
operator|.
name|num_vlan_tags
operator|=
name|htole32
argument_list|(
name|num_vlan_tags
argument_list|)
expr_stmt|;
return|return
name|hwrm_send_message
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|bnxt_hwrm_set_filter
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|,
name|struct
name|bnxt_vnic_info
modifier|*
name|vnic
parameter_list|)
block|{
name|struct
name|hwrm_cfa_l2_filter_alloc_input
name|req
init|=
block|{
literal|0
block|}
decl_stmt|;
name|struct
name|hwrm_cfa_l2_filter_alloc_output
modifier|*
name|resp
decl_stmt|;
name|uint32_t
name|enables
init|=
literal|0
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|vnic
operator|->
name|filter_id
operator|!=
operator|-
literal|1
condition|)
block|{
name|device_printf
argument_list|(
name|softc
operator|->
name|dev
argument_list|,
literal|"Attempt to re-allocate l2 ctx filter\n"
argument_list|)
expr_stmt|;
return|return
name|EDOOFUS
return|;
block|}
name|resp
operator|=
operator|(
name|void
operator|*
operator|)
name|softc
operator|->
name|hwrm_cmd_resp
operator|.
name|idi_vaddr
expr_stmt|;
name|bnxt_hwrm_cmd_hdr_init
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
name|HWRM_CFA_L2_FILTER_ALLOC
argument_list|)
expr_stmt|;
name|req
operator|.
name|flags
operator|=
name|htole32
argument_list|(
name|HWRM_CFA_L2_FILTER_ALLOC_INPUT_FLAGS_PATH_RX
argument_list|)
expr_stmt|;
name|enables
operator|=
name|HWRM_CFA_L2_FILTER_ALLOC_INPUT_ENABLES_L2_ADDR
operator||
name|HWRM_CFA_L2_FILTER_ALLOC_INPUT_ENABLES_L2_ADDR_MASK
operator||
name|HWRM_CFA_L2_FILTER_ALLOC_INPUT_ENABLES_DST_ID
expr_stmt|;
name|req
operator|.
name|enables
operator|=
name|htole32
argument_list|(
name|enables
argument_list|)
expr_stmt|;
name|req
operator|.
name|dst_id
operator|=
name|htole16
argument_list|(
name|vnic
operator|->
name|id
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|req
operator|.
name|l2_addr
argument_list|,
name|if_getlladdr
argument_list|(
name|iflib_get_ifp
argument_list|(
name|softc
operator|->
name|ctx
argument_list|)
argument_list|)
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|req
operator|.
name|l2_addr_mask
argument_list|,
literal|0xff
argument_list|,
sizeof|sizeof
argument_list|(
name|req
operator|.
name|l2_addr_mask
argument_list|)
argument_list|)
expr_stmt|;
name|BNXT_HWRM_LOCK
argument_list|(
name|softc
argument_list|)
expr_stmt|;
name|rc
operator|=
name|_hwrm_send_message
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|fail
goto|;
name|vnic
operator|->
name|filter_id
operator|=
name|le64toh
argument_list|(
name|resp
operator|->
name|l2_filter_id
argument_list|)
expr_stmt|;
name|vnic
operator|->
name|flow_id
operator|=
name|le64toh
argument_list|(
name|resp
operator|->
name|flow_id
argument_list|)
expr_stmt|;
name|fail
label|:
name|BNXT_HWRM_UNLOCK
argument_list|(
name|softc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
name|int
name|bnxt_hwrm_rss_cfg
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|,
name|struct
name|bnxt_vnic_info
modifier|*
name|vnic
parameter_list|,
name|uint32_t
name|hash_type
parameter_list|)
block|{
name|struct
name|hwrm_vnic_rss_cfg_input
name|req
init|=
block|{
literal|0
block|}
decl_stmt|;
name|struct
name|hwrm_vnic_rss_cfg_output
modifier|*
name|resp
decl_stmt|;
name|resp
operator|=
operator|(
name|void
operator|*
operator|)
name|softc
operator|->
name|hwrm_cmd_resp
operator|.
name|idi_vaddr
expr_stmt|;
name|bnxt_hwrm_cmd_hdr_init
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
name|HWRM_VNIC_RSS_CFG
argument_list|)
expr_stmt|;
name|req
operator|.
name|hash_type
operator|=
name|htole32
argument_list|(
name|hash_type
argument_list|)
expr_stmt|;
name|req
operator|.
name|ring_grp_tbl_addr
operator|=
name|htole64
argument_list|(
name|vnic
operator|->
name|rss_grp_tbl
operator|.
name|idi_paddr
argument_list|)
expr_stmt|;
name|req
operator|.
name|hash_key_tbl_addr
operator|=
name|htole64
argument_list|(
name|vnic
operator|->
name|rss_hash_key_tbl
operator|.
name|idi_paddr
argument_list|)
expr_stmt|;
name|req
operator|.
name|rss_ctx_idx
operator|=
name|htole16
argument_list|(
name|vnic
operator|->
name|rss_id
argument_list|)
expr_stmt|;
return|return
name|hwrm_send_message
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|bnxt_cfg_async_cr
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|)
block|{
name|int
name|rc
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|BNXT_PF
argument_list|(
name|softc
argument_list|)
condition|)
block|{
name|struct
name|hwrm_func_cfg_input
name|req
init|=
block|{
literal|0
block|}
decl_stmt|;
name|bnxt_hwrm_cmd_hdr_init
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
name|HWRM_FUNC_CFG
argument_list|)
expr_stmt|;
name|req
operator|.
name|fid
operator|=
literal|0xffff
expr_stmt|;
name|req
operator|.
name|enables
operator|=
name|htole32
argument_list|(
name|HWRM_FUNC_CFG_INPUT_ENABLES_ASYNC_EVENT_CR
argument_list|)
expr_stmt|;
name|req
operator|.
name|async_event_cr
operator|=
name|softc
operator|->
name|def_cp_ring
operator|.
name|ring
operator|.
name|phys_id
expr_stmt|;
name|rc
operator|=
name|hwrm_send_message
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|struct
name|hwrm_func_vf_cfg_input
name|req
init|=
block|{
literal|0
block|}
decl_stmt|;
name|bnxt_hwrm_cmd_hdr_init
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
name|HWRM_FUNC_VF_CFG
argument_list|)
expr_stmt|;
name|req
operator|.
name|enables
operator|=
name|htole32
argument_list|(
name|HWRM_FUNC_VF_CFG_INPUT_ENABLES_ASYNC_EVENT_CR
argument_list|)
expr_stmt|;
name|req
operator|.
name|async_event_cr
operator|=
name|softc
operator|->
name|def_cp_ring
operator|.
name|ring
operator|.
name|phys_id
expr_stmt|;
name|rc
operator|=
name|hwrm_send_message
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|rc
return|;
block|}
end_function

begin_function
name|int
name|bnxt_hwrm_vnic_tpa_cfg
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|,
name|struct
name|bnxt_vnic_info
modifier|*
name|vnic
parameter_list|,
name|uint32_t
name|flags
parameter_list|)
block|{
name|struct
name|hwrm_vnic_tpa_cfg_input
name|req
init|=
block|{
literal|0
block|}
decl_stmt|;
name|bnxt_hwrm_cmd_hdr_init
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
name|HWRM_VNIC_TPA_CFG
argument_list|)
expr_stmt|;
name|req
operator|.
name|flags
operator|=
name|htole32
argument_list|(
name|flags
argument_list|)
expr_stmt|;
name|req
operator|.
name|vnic_id
operator|=
name|htole16
argument_list|(
name|vnic
operator|->
name|id
argument_list|)
expr_stmt|;
name|req
operator|.
name|enables
operator|=
name|htole32
argument_list|(
name|HWRM_VNIC_TPA_CFG_INPUT_ENABLES_MAX_AGG_SEGS
operator||
name|HWRM_VNIC_TPA_CFG_INPUT_ENABLES_MAX_AGGS
operator||
comment|/* HWRM_VNIC_TPA_CFG_INPUT_ENABLES_MAX_AGG_TIMER | */
name|HWRM_VNIC_TPA_CFG_INPUT_ENABLES_MIN_AGG_LEN
argument_list|)
expr_stmt|;
comment|/* TODO: Calculate this based on ring size? */
name|req
operator|.
name|max_agg_segs
operator|=
name|htole16
argument_list|(
literal|3
argument_list|)
expr_stmt|;
comment|/* Base this in the allocated TPA start size... */
name|req
operator|.
name|max_aggs
operator|=
name|htole16
argument_list|(
literal|7
argument_list|)
expr_stmt|;
comment|/* 	 * TODO: max_agg_timer? 	 * req.mag_agg_timer = htole32(XXX); 	 */
name|req
operator|.
name|min_agg_len
operator|=
name|htole32
argument_list|(
literal|0
argument_list|)
expr_stmt|;
return|return
name|hwrm_send_message
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|bnxt_hwrm_nvm_find_dir_entry
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|,
name|uint16_t
name|type
parameter_list|,
name|uint16_t
modifier|*
name|ordinal
parameter_list|,
name|uint16_t
name|ext
parameter_list|,
name|uint16_t
modifier|*
name|index
parameter_list|,
name|bool
name|use_index
parameter_list|,
name|uint8_t
name|search_opt
parameter_list|,
name|uint32_t
modifier|*
name|data_length
parameter_list|,
name|uint32_t
modifier|*
name|item_length
parameter_list|,
name|uint32_t
modifier|*
name|fw_ver
parameter_list|)
block|{
name|struct
name|hwrm_nvm_find_dir_entry_input
name|req
init|=
block|{
literal|0
block|}
decl_stmt|;
name|struct
name|hwrm_nvm_find_dir_entry_output
modifier|*
name|resp
init|=
operator|(
name|void
operator|*
operator|)
name|softc
operator|->
name|hwrm_cmd_resp
operator|.
name|idi_vaddr
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|uint32_t
name|old_timeo
decl_stmt|;
name|MPASS
argument_list|(
name|ordinal
argument_list|)
expr_stmt|;
name|bnxt_hwrm_cmd_hdr_init
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
name|HWRM_NVM_FIND_DIR_ENTRY
argument_list|)
expr_stmt|;
if|if
condition|(
name|use_index
condition|)
block|{
name|req
operator|.
name|enables
operator|=
name|htole32
argument_list|(
name|HWRM_NVM_FIND_DIR_ENTRY_INPUT_ENABLES_DIR_IDX_VALID
argument_list|)
expr_stmt|;
name|req
operator|.
name|dir_idx
operator|=
name|htole16
argument_list|(
operator|*
name|index
argument_list|)
expr_stmt|;
block|}
name|req
operator|.
name|dir_type
operator|=
name|htole16
argument_list|(
name|type
argument_list|)
expr_stmt|;
name|req
operator|.
name|dir_ordinal
operator|=
name|htole16
argument_list|(
operator|*
name|ordinal
argument_list|)
expr_stmt|;
name|req
operator|.
name|dir_ext
operator|=
name|htole16
argument_list|(
name|ext
argument_list|)
expr_stmt|;
name|req
operator|.
name|opt_ordinal
operator|=
name|search_opt
expr_stmt|;
name|BNXT_HWRM_LOCK
argument_list|(
name|softc
argument_list|)
expr_stmt|;
name|old_timeo
operator|=
name|softc
operator|->
name|hwrm_cmd_timeo
expr_stmt|;
name|softc
operator|->
name|hwrm_cmd_timeo
operator|=
name|BNXT_NVM_TIMEO
expr_stmt|;
name|rc
operator|=
name|_hwrm_send_message
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|softc
operator|->
name|hwrm_cmd_timeo
operator|=
name|old_timeo
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|exit
goto|;
if|if
condition|(
name|item_length
condition|)
operator|*
name|item_length
operator|=
name|le32toh
argument_list|(
name|resp
operator|->
name|dir_item_length
argument_list|)
expr_stmt|;
if|if
condition|(
name|data_length
condition|)
operator|*
name|data_length
operator|=
name|le32toh
argument_list|(
name|resp
operator|->
name|dir_data_length
argument_list|)
expr_stmt|;
if|if
condition|(
name|fw_ver
condition|)
operator|*
name|fw_ver
operator|=
name|le32toh
argument_list|(
name|resp
operator|->
name|fw_ver
argument_list|)
expr_stmt|;
operator|*
name|ordinal
operator|=
name|le16toh
argument_list|(
name|resp
operator|->
name|dir_ordinal
argument_list|)
expr_stmt|;
if|if
condition|(
name|index
condition|)
operator|*
name|index
operator|=
name|le16toh
argument_list|(
name|resp
operator|->
name|dir_idx
argument_list|)
expr_stmt|;
name|exit
label|:
name|BNXT_HWRM_UNLOCK
argument_list|(
name|softc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
name|int
name|bnxt_hwrm_nvm_read
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|,
name|uint16_t
name|index
parameter_list|,
name|uint32_t
name|offset
parameter_list|,
name|uint32_t
name|length
parameter_list|,
name|struct
name|iflib_dma_info
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|hwrm_nvm_read_input
name|req
init|=
block|{
literal|0
block|}
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|uint32_t
name|old_timeo
decl_stmt|;
if|if
condition|(
name|length
operator|>
name|data
operator|->
name|idi_size
condition|)
block|{
name|rc
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|exit
goto|;
block|}
name|bnxt_hwrm_cmd_hdr_init
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
name|HWRM_NVM_READ
argument_list|)
expr_stmt|;
name|req
operator|.
name|host_dest_addr
operator|=
name|htole64
argument_list|(
name|data
operator|->
name|idi_paddr
argument_list|)
expr_stmt|;
name|req
operator|.
name|dir_idx
operator|=
name|htole16
argument_list|(
name|index
argument_list|)
expr_stmt|;
name|req
operator|.
name|offset
operator|=
name|htole32
argument_list|(
name|offset
argument_list|)
expr_stmt|;
name|req
operator|.
name|len
operator|=
name|htole32
argument_list|(
name|length
argument_list|)
expr_stmt|;
name|BNXT_HWRM_LOCK
argument_list|(
name|softc
argument_list|)
expr_stmt|;
name|old_timeo
operator|=
name|softc
operator|->
name|hwrm_cmd_timeo
expr_stmt|;
name|softc
operator|->
name|hwrm_cmd_timeo
operator|=
name|BNXT_NVM_TIMEO
expr_stmt|;
name|rc
operator|=
name|_hwrm_send_message
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|softc
operator|->
name|hwrm_cmd_timeo
operator|=
name|old_timeo
expr_stmt|;
name|BNXT_HWRM_UNLOCK
argument_list|(
name|softc
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|exit
goto|;
name|bus_dmamap_sync
argument_list|(
name|data
operator|->
name|idi_tag
argument_list|,
name|data
operator|->
name|idi_map
argument_list|,
name|BUS_DMASYNC_POSTREAD
argument_list|)
expr_stmt|;
goto|goto
name|exit
goto|;
name|exit
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
name|int
name|bnxt_hwrm_nvm_modify
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|,
name|uint16_t
name|index
parameter_list|,
name|uint32_t
name|offset
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|bool
name|cpyin
parameter_list|,
name|uint32_t
name|length
parameter_list|)
block|{
name|struct
name|hwrm_nvm_modify_input
name|req
init|=
block|{
literal|0
block|}
decl_stmt|;
name|struct
name|iflib_dma_info
name|dma_data
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|uint32_t
name|old_timeo
decl_stmt|;
if|if
condition|(
name|length
operator|==
literal|0
operator|||
operator|!
name|data
condition|)
return|return
name|EINVAL
return|;
name|rc
operator|=
name|iflib_dma_alloc
argument_list|(
name|softc
operator|->
name|ctx
argument_list|,
name|length
argument_list|,
operator|&
name|dma_data
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
return|return
name|ENOMEM
return|;
if|if
condition|(
name|cpyin
condition|)
block|{
name|rc
operator|=
name|copyin
argument_list|(
name|data
argument_list|,
name|dma_data
operator|.
name|idi_vaddr
argument_list|,
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|exit
goto|;
block|}
else|else
name|memcpy
argument_list|(
name|dma_data
operator|.
name|idi_vaddr
argument_list|,
name|data
argument_list|,
name|length
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|dma_data
operator|.
name|idi_tag
argument_list|,
name|dma_data
operator|.
name|idi_map
argument_list|,
name|BUS_DMASYNC_PREREAD
operator||
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
name|bnxt_hwrm_cmd_hdr_init
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
name|HWRM_NVM_MODIFY
argument_list|)
expr_stmt|;
name|req
operator|.
name|host_src_addr
operator|=
name|htole64
argument_list|(
name|dma_data
operator|.
name|idi_paddr
argument_list|)
expr_stmt|;
name|req
operator|.
name|dir_idx
operator|=
name|htole16
argument_list|(
name|index
argument_list|)
expr_stmt|;
name|req
operator|.
name|offset
operator|=
name|htole32
argument_list|(
name|offset
argument_list|)
expr_stmt|;
name|req
operator|.
name|len
operator|=
name|htole32
argument_list|(
name|length
argument_list|)
expr_stmt|;
name|BNXT_HWRM_LOCK
argument_list|(
name|softc
argument_list|)
expr_stmt|;
name|old_timeo
operator|=
name|softc
operator|->
name|hwrm_cmd_timeo
expr_stmt|;
name|softc
operator|->
name|hwrm_cmd_timeo
operator|=
name|BNXT_NVM_TIMEO
expr_stmt|;
name|rc
operator|=
name|_hwrm_send_message
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|softc
operator|->
name|hwrm_cmd_timeo
operator|=
name|old_timeo
expr_stmt|;
name|BNXT_HWRM_UNLOCK
argument_list|(
name|softc
argument_list|)
expr_stmt|;
name|exit
label|:
name|iflib_dma_free
argument_list|(
operator|&
name|dma_data
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
name|int
name|bnxt_hwrm_fw_reset
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|,
name|uint8_t
name|processor
parameter_list|,
name|uint8_t
modifier|*
name|selfreset
parameter_list|)
block|{
name|struct
name|hwrm_fw_reset_input
name|req
init|=
block|{
literal|0
block|}
decl_stmt|;
name|struct
name|hwrm_fw_reset_output
modifier|*
name|resp
init|=
operator|(
name|void
operator|*
operator|)
name|softc
operator|->
name|hwrm_cmd_resp
operator|.
name|idi_vaddr
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|MPASS
argument_list|(
name|selfreset
argument_list|)
expr_stmt|;
name|bnxt_hwrm_cmd_hdr_init
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
name|HWRM_FW_RESET
argument_list|)
expr_stmt|;
name|req
operator|.
name|embedded_proc_type
operator|=
name|processor
expr_stmt|;
name|req
operator|.
name|selfrst_status
operator|=
operator|*
name|selfreset
expr_stmt|;
name|BNXT_HWRM_LOCK
argument_list|(
name|softc
argument_list|)
expr_stmt|;
name|rc
operator|=
name|_hwrm_send_message
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|exit
goto|;
operator|*
name|selfreset
operator|=
name|resp
operator|->
name|selfrst_status
expr_stmt|;
name|exit
label|:
name|BNXT_HWRM_UNLOCK
argument_list|(
name|softc
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
name|int
name|bnxt_hwrm_fw_qstatus
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|,
name|uint8_t
name|type
parameter_list|,
name|uint8_t
modifier|*
name|selfreset
parameter_list|)
block|{
name|struct
name|hwrm_fw_qstatus_input
name|req
init|=
block|{
literal|0
block|}
decl_stmt|;
name|struct
name|hwrm_fw_qstatus_output
modifier|*
name|resp
init|=
operator|(
name|void
operator|*
operator|)
name|softc
operator|->
name|hwrm_cmd_resp
operator|.
name|idi_vaddr
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|MPASS
argument_list|(
name|selfreset
argument_list|)
expr_stmt|;
name|bnxt_hwrm_cmd_hdr_init
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
name|HWRM_FW_QSTATUS
argument_list|)
expr_stmt|;
name|req
operator|.
name|embedded_proc_type
operator|=
name|type
expr_stmt|;
name|BNXT_HWRM_LOCK
argument_list|(
name|softc
argument_list|)
expr_stmt|;
name|rc
operator|=
name|_hwrm_send_message
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|exit
goto|;
operator|*
name|selfreset
operator|=
name|resp
operator|->
name|selfrst_status
expr_stmt|;
name|exit
label|:
name|BNXT_HWRM_UNLOCK
argument_list|(
name|softc
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
name|int
name|bnxt_hwrm_nvm_write
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|bool
name|cpyin
parameter_list|,
name|uint16_t
name|type
parameter_list|,
name|uint16_t
name|ordinal
parameter_list|,
name|uint16_t
name|ext
parameter_list|,
name|uint16_t
name|attr
parameter_list|,
name|uint16_t
name|option
parameter_list|,
name|uint32_t
name|data_length
parameter_list|,
name|bool
name|keep
parameter_list|,
name|uint32_t
modifier|*
name|item_length
parameter_list|,
name|uint16_t
modifier|*
name|index
parameter_list|)
block|{
name|struct
name|hwrm_nvm_write_input
name|req
init|=
block|{
literal|0
block|}
decl_stmt|;
name|struct
name|hwrm_nvm_write_output
modifier|*
name|resp
init|=
operator|(
name|void
operator|*
operator|)
name|softc
operator|->
name|hwrm_cmd_resp
operator|.
name|idi_vaddr
decl_stmt|;
name|struct
name|iflib_dma_info
name|dma_data
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|uint32_t
name|old_timeo
decl_stmt|;
if|if
condition|(
name|data_length
condition|)
block|{
name|rc
operator|=
name|iflib_dma_alloc
argument_list|(
name|softc
operator|->
name|ctx
argument_list|,
name|data_length
argument_list|,
operator|&
name|dma_data
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
return|return
name|ENOMEM
return|;
if|if
condition|(
name|cpyin
condition|)
block|{
name|rc
operator|=
name|copyin
argument_list|(
name|data
argument_list|,
name|dma_data
operator|.
name|idi_vaddr
argument_list|,
name|data_length
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|early_exit
goto|;
block|}
else|else
name|memcpy
argument_list|(
name|dma_data
operator|.
name|idi_vaddr
argument_list|,
name|data
argument_list|,
name|data_length
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|dma_data
operator|.
name|idi_tag
argument_list|,
name|dma_data
operator|.
name|idi_map
argument_list|,
name|BUS_DMASYNC_PREREAD
operator||
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
block|}
else|else
name|dma_data
operator|.
name|idi_paddr
operator|=
literal|0
expr_stmt|;
name|bnxt_hwrm_cmd_hdr_init
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
name|HWRM_NVM_WRITE
argument_list|)
expr_stmt|;
name|req
operator|.
name|host_src_addr
operator|=
name|htole64
argument_list|(
name|dma_data
operator|.
name|idi_paddr
argument_list|)
expr_stmt|;
name|req
operator|.
name|dir_type
operator|=
name|htole16
argument_list|(
name|type
argument_list|)
expr_stmt|;
name|req
operator|.
name|dir_ordinal
operator|=
name|htole16
argument_list|(
name|ordinal
argument_list|)
expr_stmt|;
name|req
operator|.
name|dir_ext
operator|=
name|htole16
argument_list|(
name|ext
argument_list|)
expr_stmt|;
name|req
operator|.
name|dir_attr
operator|=
name|htole16
argument_list|(
name|attr
argument_list|)
expr_stmt|;
name|req
operator|.
name|dir_data_length
operator|=
name|htole32
argument_list|(
name|data_length
argument_list|)
expr_stmt|;
name|req
operator|.
name|option
operator|=
name|htole16
argument_list|(
name|option
argument_list|)
expr_stmt|;
if|if
condition|(
name|keep
condition|)
block|{
name|req
operator|.
name|flags
operator|=
name|htole16
argument_list|(
name|HWRM_NVM_WRITE_INPUT_FLAGS_KEEP_ORIG_ACTIVE_IMG
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|item_length
condition|)
name|req
operator|.
name|dir_item_length
operator|=
name|htole32
argument_list|(
operator|*
name|item_length
argument_list|)
expr_stmt|;
name|BNXT_HWRM_LOCK
argument_list|(
name|softc
argument_list|)
expr_stmt|;
name|old_timeo
operator|=
name|softc
operator|->
name|hwrm_cmd_timeo
expr_stmt|;
name|softc
operator|->
name|hwrm_cmd_timeo
operator|=
name|BNXT_NVM_TIMEO
expr_stmt|;
name|rc
operator|=
name|_hwrm_send_message
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|softc
operator|->
name|hwrm_cmd_timeo
operator|=
name|old_timeo
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|exit
goto|;
if|if
condition|(
name|item_length
condition|)
operator|*
name|item_length
operator|=
name|le32toh
argument_list|(
name|resp
operator|->
name|dir_item_length
argument_list|)
expr_stmt|;
if|if
condition|(
name|index
condition|)
operator|*
name|index
operator|=
name|le16toh
argument_list|(
name|resp
operator|->
name|dir_idx
argument_list|)
expr_stmt|;
name|exit
label|:
name|BNXT_HWRM_UNLOCK
argument_list|(
name|softc
argument_list|)
expr_stmt|;
name|early_exit
label|:
if|if
condition|(
name|data_length
condition|)
name|iflib_dma_free
argument_list|(
operator|&
name|dma_data
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
name|int
name|bnxt_hwrm_nvm_erase_dir_entry
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|,
name|uint16_t
name|index
parameter_list|)
block|{
name|struct
name|hwrm_nvm_erase_dir_entry_input
name|req
init|=
block|{
literal|0
block|}
decl_stmt|;
name|uint32_t
name|old_timeo
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|bnxt_hwrm_cmd_hdr_init
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
name|HWRM_NVM_ERASE_DIR_ENTRY
argument_list|)
expr_stmt|;
name|req
operator|.
name|dir_idx
operator|=
name|htole16
argument_list|(
name|index
argument_list|)
expr_stmt|;
name|BNXT_HWRM_LOCK
argument_list|(
name|softc
argument_list|)
expr_stmt|;
name|old_timeo
operator|=
name|softc
operator|->
name|hwrm_cmd_timeo
expr_stmt|;
name|softc
operator|->
name|hwrm_cmd_timeo
operator|=
name|BNXT_NVM_TIMEO
expr_stmt|;
name|rc
operator|=
name|_hwrm_send_message
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|softc
operator|->
name|hwrm_cmd_timeo
operator|=
name|old_timeo
expr_stmt|;
name|BNXT_HWRM_UNLOCK
argument_list|(
name|softc
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
name|int
name|bnxt_hwrm_nvm_get_dir_info
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|,
name|uint32_t
modifier|*
name|entries
parameter_list|,
name|uint32_t
modifier|*
name|entry_length
parameter_list|)
block|{
name|struct
name|hwrm_nvm_get_dir_info_input
name|req
init|=
block|{
literal|0
block|}
decl_stmt|;
name|struct
name|hwrm_nvm_get_dir_info_output
modifier|*
name|resp
init|=
operator|(
name|void
operator|*
operator|)
name|softc
operator|->
name|hwrm_cmd_resp
operator|.
name|idi_vaddr
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|uint32_t
name|old_timeo
decl_stmt|;
name|bnxt_hwrm_cmd_hdr_init
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
name|HWRM_NVM_GET_DIR_INFO
argument_list|)
expr_stmt|;
name|BNXT_HWRM_LOCK
argument_list|(
name|softc
argument_list|)
expr_stmt|;
name|old_timeo
operator|=
name|softc
operator|->
name|hwrm_cmd_timeo
expr_stmt|;
name|softc
operator|->
name|hwrm_cmd_timeo
operator|=
name|BNXT_NVM_TIMEO
expr_stmt|;
name|rc
operator|=
name|_hwrm_send_message
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|softc
operator|->
name|hwrm_cmd_timeo
operator|=
name|old_timeo
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|exit
goto|;
if|if
condition|(
name|entries
condition|)
operator|*
name|entries
operator|=
name|le32toh
argument_list|(
name|resp
operator|->
name|entries
argument_list|)
expr_stmt|;
if|if
condition|(
name|entry_length
condition|)
operator|*
name|entry_length
operator|=
name|le32toh
argument_list|(
name|resp
operator|->
name|entry_length
argument_list|)
expr_stmt|;
name|exit
label|:
name|BNXT_HWRM_UNLOCK
argument_list|(
name|softc
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
name|int
name|bnxt_hwrm_nvm_get_dir_entries
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|,
name|uint32_t
modifier|*
name|entries
parameter_list|,
name|uint32_t
modifier|*
name|entry_length
parameter_list|,
name|struct
name|iflib_dma_info
modifier|*
name|dma_data
parameter_list|)
block|{
name|struct
name|hwrm_nvm_get_dir_entries_input
name|req
init|=
block|{
literal|0
block|}
decl_stmt|;
name|uint32_t
name|ent
decl_stmt|;
name|uint32_t
name|ent_len
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|uint32_t
name|old_timeo
decl_stmt|;
if|if
condition|(
operator|!
name|entries
condition|)
name|entries
operator|=
operator|&
name|ent
expr_stmt|;
if|if
condition|(
operator|!
name|entry_length
condition|)
name|entry_length
operator|=
operator|&
name|ent_len
expr_stmt|;
name|rc
operator|=
name|bnxt_hwrm_nvm_get_dir_info
argument_list|(
name|softc
argument_list|,
name|entries
argument_list|,
name|entry_length
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|exit
goto|;
if|if
condition|(
operator|*
name|entries
operator|*
operator|*
name|entry_length
operator|>
name|dma_data
operator|->
name|idi_size
condition|)
block|{
name|rc
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|exit
goto|;
block|}
comment|/* 	 * TODO: There's a race condition here that could blow up DMA memory... 	 *	 we need to allocate the max size, not the currently in use 	 *	 size.  The command should totally have a max size here. 	 */
name|bnxt_hwrm_cmd_hdr_init
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
name|HWRM_NVM_GET_DIR_ENTRIES
argument_list|)
expr_stmt|;
name|req
operator|.
name|host_dest_addr
operator|=
name|htole64
argument_list|(
name|dma_data
operator|->
name|idi_paddr
argument_list|)
expr_stmt|;
name|BNXT_HWRM_LOCK
argument_list|(
name|softc
argument_list|)
expr_stmt|;
name|old_timeo
operator|=
name|softc
operator|->
name|hwrm_cmd_timeo
expr_stmt|;
name|softc
operator|->
name|hwrm_cmd_timeo
operator|=
name|BNXT_NVM_TIMEO
expr_stmt|;
name|rc
operator|=
name|_hwrm_send_message
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|softc
operator|->
name|hwrm_cmd_timeo
operator|=
name|old_timeo
expr_stmt|;
name|BNXT_HWRM_UNLOCK
argument_list|(
name|softc
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|exit
goto|;
name|bus_dmamap_sync
argument_list|(
name|dma_data
operator|->
name|idi_tag
argument_list|,
name|dma_data
operator|->
name|idi_map
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
name|exit
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
name|int
name|bnxt_hwrm_nvm_get_dev_info
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|,
name|uint16_t
modifier|*
name|mfg_id
parameter_list|,
name|uint16_t
modifier|*
name|device_id
parameter_list|,
name|uint32_t
modifier|*
name|sector_size
parameter_list|,
name|uint32_t
modifier|*
name|nvram_size
parameter_list|,
name|uint32_t
modifier|*
name|reserved_size
parameter_list|,
name|uint32_t
modifier|*
name|available_size
parameter_list|)
block|{
name|struct
name|hwrm_nvm_get_dev_info_input
name|req
init|=
block|{
literal|0
block|}
decl_stmt|;
name|struct
name|hwrm_nvm_get_dev_info_output
modifier|*
name|resp
init|=
operator|(
name|void
operator|*
operator|)
name|softc
operator|->
name|hwrm_cmd_resp
operator|.
name|idi_vaddr
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|uint32_t
name|old_timeo
decl_stmt|;
name|bnxt_hwrm_cmd_hdr_init
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
name|HWRM_NVM_GET_DEV_INFO
argument_list|)
expr_stmt|;
name|BNXT_HWRM_LOCK
argument_list|(
name|softc
argument_list|)
expr_stmt|;
name|old_timeo
operator|=
name|softc
operator|->
name|hwrm_cmd_timeo
expr_stmt|;
name|softc
operator|->
name|hwrm_cmd_timeo
operator|=
name|BNXT_NVM_TIMEO
expr_stmt|;
name|rc
operator|=
name|_hwrm_send_message
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|softc
operator|->
name|hwrm_cmd_timeo
operator|=
name|old_timeo
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|exit
goto|;
if|if
condition|(
name|mfg_id
condition|)
operator|*
name|mfg_id
operator|=
name|le16toh
argument_list|(
name|resp
operator|->
name|manufacturer_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|device_id
condition|)
operator|*
name|device_id
operator|=
name|le16toh
argument_list|(
name|resp
operator|->
name|device_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|sector_size
condition|)
operator|*
name|sector_size
operator|=
name|le32toh
argument_list|(
name|resp
operator|->
name|sector_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|nvram_size
condition|)
operator|*
name|nvram_size
operator|=
name|le32toh
argument_list|(
name|resp
operator|->
name|nvram_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|reserved_size
condition|)
operator|*
name|reserved_size
operator|=
name|le32toh
argument_list|(
name|resp
operator|->
name|reserved_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|available_size
condition|)
operator|*
name|available_size
operator|=
name|le32toh
argument_list|(
name|resp
operator|->
name|available_size
argument_list|)
expr_stmt|;
name|exit
label|:
name|BNXT_HWRM_UNLOCK
argument_list|(
name|softc
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
name|int
name|bnxt_hwrm_nvm_install_update
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|,
name|uint32_t
name|install_type
parameter_list|,
name|uint64_t
modifier|*
name|installed_items
parameter_list|,
name|uint8_t
modifier|*
name|result
parameter_list|,
name|uint8_t
modifier|*
name|problem_item
parameter_list|,
name|uint8_t
modifier|*
name|reset_required
parameter_list|)
block|{
name|struct
name|hwrm_nvm_install_update_input
name|req
init|=
block|{
literal|0
block|}
decl_stmt|;
name|struct
name|hwrm_nvm_install_update_output
modifier|*
name|resp
init|=
operator|(
name|void
operator|*
operator|)
name|softc
operator|->
name|hwrm_cmd_resp
operator|.
name|idi_vaddr
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|uint32_t
name|old_timeo
decl_stmt|;
name|bnxt_hwrm_cmd_hdr_init
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
name|HWRM_NVM_INSTALL_UPDATE
argument_list|)
expr_stmt|;
name|req
operator|.
name|install_type
operator|=
name|htole32
argument_list|(
name|install_type
argument_list|)
expr_stmt|;
name|BNXT_HWRM_LOCK
argument_list|(
name|softc
argument_list|)
expr_stmt|;
name|old_timeo
operator|=
name|softc
operator|->
name|hwrm_cmd_timeo
expr_stmt|;
name|softc
operator|->
name|hwrm_cmd_timeo
operator|=
name|BNXT_NVM_TIMEO
expr_stmt|;
name|rc
operator|=
name|_hwrm_send_message
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|softc
operator|->
name|hwrm_cmd_timeo
operator|=
name|old_timeo
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|exit
goto|;
if|if
condition|(
name|installed_items
condition|)
operator|*
name|installed_items
operator|=
name|le32toh
argument_list|(
name|resp
operator|->
name|installed_items
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
condition|)
operator|*
name|result
operator|=
name|resp
operator|->
name|result
expr_stmt|;
if|if
condition|(
name|problem_item
condition|)
operator|*
name|problem_item
operator|=
name|resp
operator|->
name|problem_item
expr_stmt|;
if|if
condition|(
name|reset_required
condition|)
operator|*
name|reset_required
operator|=
name|resp
operator|->
name|reset_required
expr_stmt|;
name|exit
label|:
name|BNXT_HWRM_UNLOCK
argument_list|(
name|softc
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
name|int
name|bnxt_hwrm_nvm_verify_update
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|,
name|uint16_t
name|type
parameter_list|,
name|uint16_t
name|ordinal
parameter_list|,
name|uint16_t
name|ext
parameter_list|)
block|{
name|struct
name|hwrm_nvm_verify_update_input
name|req
init|=
block|{
literal|0
block|}
decl_stmt|;
name|uint32_t
name|old_timeo
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|bnxt_hwrm_cmd_hdr_init
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
name|HWRM_NVM_VERIFY_UPDATE
argument_list|)
expr_stmt|;
name|req
operator|.
name|dir_type
operator|=
name|htole16
argument_list|(
name|type
argument_list|)
expr_stmt|;
name|req
operator|.
name|dir_ordinal
operator|=
name|htole16
argument_list|(
name|ordinal
argument_list|)
expr_stmt|;
name|req
operator|.
name|dir_ext
operator|=
name|htole16
argument_list|(
name|ext
argument_list|)
expr_stmt|;
name|BNXT_HWRM_LOCK
argument_list|(
name|softc
argument_list|)
expr_stmt|;
name|old_timeo
operator|=
name|softc
operator|->
name|hwrm_cmd_timeo
expr_stmt|;
name|softc
operator|->
name|hwrm_cmd_timeo
operator|=
name|BNXT_NVM_TIMEO
expr_stmt|;
name|rc
operator|=
name|_hwrm_send_message
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|softc
operator|->
name|hwrm_cmd_timeo
operator|=
name|old_timeo
expr_stmt|;
name|BNXT_HWRM_UNLOCK
argument_list|(
name|softc
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
name|int
name|bnxt_hwrm_fw_get_time
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|,
name|uint16_t
modifier|*
name|year
parameter_list|,
name|uint8_t
modifier|*
name|month
parameter_list|,
name|uint8_t
modifier|*
name|day
parameter_list|,
name|uint8_t
modifier|*
name|hour
parameter_list|,
name|uint8_t
modifier|*
name|minute
parameter_list|,
name|uint8_t
modifier|*
name|second
parameter_list|,
name|uint16_t
modifier|*
name|millisecond
parameter_list|,
name|uint16_t
modifier|*
name|zone
parameter_list|)
block|{
name|struct
name|hwrm_fw_get_time_input
name|req
init|=
block|{
literal|0
block|}
decl_stmt|;
name|struct
name|hwrm_fw_get_time_output
modifier|*
name|resp
init|=
operator|(
name|void
operator|*
operator|)
name|softc
operator|->
name|hwrm_cmd_resp
operator|.
name|idi_vaddr
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|bnxt_hwrm_cmd_hdr_init
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
name|HWRM_FW_GET_TIME
argument_list|)
expr_stmt|;
name|BNXT_HWRM_LOCK
argument_list|(
name|softc
argument_list|)
expr_stmt|;
name|rc
operator|=
name|_hwrm_send_message
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|exit
goto|;
if|if
condition|(
name|year
condition|)
operator|*
name|year
operator|=
name|le16toh
argument_list|(
name|resp
operator|->
name|year
argument_list|)
expr_stmt|;
if|if
condition|(
name|month
condition|)
operator|*
name|month
operator|=
name|resp
operator|->
name|month
expr_stmt|;
if|if
condition|(
name|day
condition|)
operator|*
name|day
operator|=
name|resp
operator|->
name|day
expr_stmt|;
if|if
condition|(
name|hour
condition|)
operator|*
name|hour
operator|=
name|resp
operator|->
name|hour
expr_stmt|;
if|if
condition|(
name|minute
condition|)
operator|*
name|minute
operator|=
name|resp
operator|->
name|minute
expr_stmt|;
if|if
condition|(
name|second
condition|)
operator|*
name|second
operator|=
name|resp
operator|->
name|second
expr_stmt|;
if|if
condition|(
name|millisecond
condition|)
operator|*
name|millisecond
operator|=
name|le16toh
argument_list|(
name|resp
operator|->
name|millisecond
argument_list|)
expr_stmt|;
if|if
condition|(
name|zone
condition|)
operator|*
name|zone
operator|=
name|le16toh
argument_list|(
name|resp
operator|->
name|zone
argument_list|)
expr_stmt|;
name|exit
label|:
name|BNXT_HWRM_UNLOCK
argument_list|(
name|softc
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
name|int
name|bnxt_hwrm_fw_set_time
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|,
name|uint16_t
name|year
parameter_list|,
name|uint8_t
name|month
parameter_list|,
name|uint8_t
name|day
parameter_list|,
name|uint8_t
name|hour
parameter_list|,
name|uint8_t
name|minute
parameter_list|,
name|uint8_t
name|second
parameter_list|,
name|uint16_t
name|millisecond
parameter_list|,
name|uint16_t
name|zone
parameter_list|)
block|{
name|struct
name|hwrm_fw_set_time_input
name|req
init|=
block|{
literal|0
block|}
decl_stmt|;
name|bnxt_hwrm_cmd_hdr_init
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
name|HWRM_FW_SET_TIME
argument_list|)
expr_stmt|;
name|req
operator|.
name|year
operator|=
name|htole16
argument_list|(
name|year
argument_list|)
expr_stmt|;
name|req
operator|.
name|month
operator|=
name|month
expr_stmt|;
name|req
operator|.
name|day
operator|=
name|day
expr_stmt|;
name|req
operator|.
name|hour
operator|=
name|hour
expr_stmt|;
name|req
operator|.
name|minute
operator|=
name|minute
expr_stmt|;
name|req
operator|.
name|second
operator|=
name|second
expr_stmt|;
name|req
operator|.
name|millisecond
operator|=
name|htole16
argument_list|(
name|millisecond
argument_list|)
expr_stmt|;
name|req
operator|.
name|zone
operator|=
name|htole16
argument_list|(
name|zone
argument_list|)
expr_stmt|;
return|return
name|hwrm_send_message
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|bnxt_hwrm_port_phy_qcfg
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|)
block|{
name|struct
name|bnxt_link_info
modifier|*
name|link_info
init|=
operator|&
name|softc
operator|->
name|link_info
decl_stmt|;
name|struct
name|hwrm_port_phy_qcfg_input
name|req
init|=
block|{
literal|0
block|}
decl_stmt|;
name|struct
name|hwrm_port_phy_qcfg_output
modifier|*
name|resp
init|=
operator|(
name|void
operator|*
operator|)
name|softc
operator|->
name|hwrm_cmd_resp
operator|.
name|idi_vaddr
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|BNXT_HWRM_LOCK
argument_list|(
name|softc
argument_list|)
expr_stmt|;
name|bnxt_hwrm_cmd_hdr_init
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
name|HWRM_PORT_PHY_QCFG
argument_list|)
expr_stmt|;
name|rc
operator|=
name|_hwrm_send_message
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|exit
goto|;
name|link_info
operator|->
name|phy_link_status
operator|=
name|resp
operator|->
name|link
expr_stmt|;
name|link_info
operator|->
name|duplex
operator|=
name|resp
operator|->
name|duplex_cfg
expr_stmt|;
name|link_info
operator|->
name|pause
operator|=
name|resp
operator|->
name|pause
expr_stmt|;
name|link_info
operator|->
name|auto_mode
operator|=
name|resp
operator|->
name|auto_mode
expr_stmt|;
name|link_info
operator|->
name|auto_pause
operator|=
name|resp
operator|->
name|auto_pause
expr_stmt|;
name|link_info
operator|->
name|force_pause
operator|=
name|resp
operator|->
name|force_pause
expr_stmt|;
name|link_info
operator|->
name|duplex_setting
operator|=
name|resp
operator|->
name|duplex_cfg
expr_stmt|;
if|if
condition|(
name|link_info
operator|->
name|phy_link_status
operator|==
name|HWRM_PORT_PHY_QCFG_OUTPUT_LINK_LINK
condition|)
name|link_info
operator|->
name|link_speed
operator|=
name|le16toh
argument_list|(
name|resp
operator|->
name|link_speed
argument_list|)
expr_stmt|;
else|else
name|link_info
operator|->
name|link_speed
operator|=
literal|0
expr_stmt|;
name|link_info
operator|->
name|force_link_speed
operator|=
name|le16toh
argument_list|(
name|resp
operator|->
name|force_link_speed
argument_list|)
expr_stmt|;
name|link_info
operator|->
name|auto_link_speed
operator|=
name|le16toh
argument_list|(
name|resp
operator|->
name|auto_link_speed
argument_list|)
expr_stmt|;
name|link_info
operator|->
name|support_speeds
operator|=
name|le16toh
argument_list|(
name|resp
operator|->
name|support_speeds
argument_list|)
expr_stmt|;
name|link_info
operator|->
name|auto_link_speeds
operator|=
name|le16toh
argument_list|(
name|resp
operator|->
name|auto_link_speed_mask
argument_list|)
expr_stmt|;
name|link_info
operator|->
name|preemphasis
operator|=
name|le32toh
argument_list|(
name|resp
operator|->
name|preemphasis
argument_list|)
expr_stmt|;
name|link_info
operator|->
name|phy_ver
index|[
literal|0
index|]
operator|=
name|resp
operator|->
name|phy_maj
expr_stmt|;
name|link_info
operator|->
name|phy_ver
index|[
literal|1
index|]
operator|=
name|resp
operator|->
name|phy_min
expr_stmt|;
name|link_info
operator|->
name|phy_ver
index|[
literal|2
index|]
operator|=
name|resp
operator|->
name|phy_bld
expr_stmt|;
name|snprintf
argument_list|(
name|softc
operator|->
name|ver_info
operator|->
name|phy_ver
argument_list|,
sizeof|sizeof
argument_list|(
name|softc
operator|->
name|ver_info
operator|->
name|phy_ver
argument_list|)
argument_list|,
literal|"%d.%d.%d"
argument_list|,
name|link_info
operator|->
name|phy_ver
index|[
literal|0
index|]
argument_list|,
name|link_info
operator|->
name|phy_ver
index|[
literal|1
index|]
argument_list|,
name|link_info
operator|->
name|phy_ver
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|softc
operator|->
name|ver_info
operator|->
name|phy_vendor
argument_list|,
name|resp
operator|->
name|phy_vendor_name
argument_list|,
name|BNXT_NAME_SIZE
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|softc
operator|->
name|ver_info
operator|->
name|phy_partnumber
argument_list|,
name|resp
operator|->
name|phy_vendor_partnumber
argument_list|,
name|BNXT_NAME_SIZE
argument_list|)
expr_stmt|;
name|link_info
operator|->
name|media_type
operator|=
name|resp
operator|->
name|media_type
expr_stmt|;
name|link_info
operator|->
name|phy_type
operator|=
name|resp
operator|->
name|phy_type
expr_stmt|;
name|link_info
operator|->
name|transceiver
operator|=
name|resp
operator|->
name|xcvr_pkg_type
expr_stmt|;
name|link_info
operator|->
name|phy_addr
operator|=
name|resp
operator|->
name|eee_config_phy_addr
operator|&
name|HWRM_PORT_PHY_QCFG_OUTPUT_PHY_ADDR_MASK
expr_stmt|;
name|exit
label|:
name|BNXT_HWRM_UNLOCK
argument_list|(
name|softc
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
name|uint16_t
name|bnxt_hwrm_get_wol_fltrs
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|,
name|uint16_t
name|handle
parameter_list|)
block|{
name|struct
name|hwrm_wol_filter_qcfg_input
name|req
init|=
block|{
literal|0
block|}
decl_stmt|;
name|struct
name|hwrm_wol_filter_qcfg_output
modifier|*
name|resp
init|=
operator|(
name|void
operator|*
operator|)
name|softc
operator|->
name|hwrm_cmd_resp
operator|.
name|idi_vaddr
decl_stmt|;
name|uint16_t
name|next_handle
init|=
literal|0
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|bnxt_hwrm_cmd_hdr_init
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
name|HWRM_WOL_FILTER_QCFG
argument_list|)
expr_stmt|;
name|req
operator|.
name|port_id
operator|=
name|htole16
argument_list|(
name|softc
operator|->
name|pf
operator|.
name|port_id
argument_list|)
expr_stmt|;
name|req
operator|.
name|handle
operator|=
name|htole16
argument_list|(
name|handle
argument_list|)
expr_stmt|;
name|rc
operator|=
name|hwrm_send_message
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rc
condition|)
block|{
name|next_handle
operator|=
name|le16toh
argument_list|(
name|resp
operator|->
name|next_handle
argument_list|)
expr_stmt|;
if|if
condition|(
name|next_handle
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|resp
operator|->
name|wol_type
operator|==
name|HWRM_WOL_FILTER_ALLOC_INPUT_WOL_TYPE_MAGICPKT
condition|)
block|{
name|softc
operator|->
name|wol
operator|=
literal|1
expr_stmt|;
name|softc
operator|->
name|wol_filter_id
operator|=
name|resp
operator|->
name|wol_filter_id
expr_stmt|;
block|}
block|}
block|}
return|return
name|next_handle
return|;
block|}
end_function

begin_function
name|int
name|bnxt_hwrm_alloc_wol_fltr
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|)
block|{
name|struct
name|hwrm_wol_filter_alloc_input
name|req
init|=
block|{
literal|0
block|}
decl_stmt|;
name|struct
name|hwrm_wol_filter_alloc_output
modifier|*
name|resp
init|=
operator|(
name|void
operator|*
operator|)
name|softc
operator|->
name|hwrm_cmd_resp
operator|.
name|idi_vaddr
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|bnxt_hwrm_cmd_hdr_init
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
name|HWRM_WOL_FILTER_ALLOC
argument_list|)
expr_stmt|;
name|req
operator|.
name|port_id
operator|=
name|htole16
argument_list|(
name|softc
operator|->
name|pf
operator|.
name|port_id
argument_list|)
expr_stmt|;
name|req
operator|.
name|wol_type
operator|=
name|HWRM_WOL_FILTER_ALLOC_INPUT_WOL_TYPE_MAGICPKT
expr_stmt|;
name|req
operator|.
name|enables
operator|=
name|htole32
argument_list|(
name|HWRM_WOL_FILTER_ALLOC_INPUT_ENABLES_MAC_ADDRESS
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|req
operator|.
name|mac_address
argument_list|,
name|softc
operator|->
name|func
operator|.
name|mac_addr
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|rc
operator|=
name|hwrm_send_message
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rc
condition|)
name|softc
operator|->
name|wol_filter_id
operator|=
name|resp
operator|->
name|wol_filter_id
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
name|int
name|bnxt_hwrm_free_wol_fltr
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|)
block|{
name|struct
name|hwrm_wol_filter_free_input
name|req
init|=
block|{
literal|0
block|}
decl_stmt|;
name|bnxt_hwrm_cmd_hdr_init
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
name|HWRM_WOL_FILTER_FREE
argument_list|)
expr_stmt|;
name|req
operator|.
name|port_id
operator|=
name|htole16
argument_list|(
name|softc
operator|->
name|pf
operator|.
name|port_id
argument_list|)
expr_stmt|;
name|req
operator|.
name|enables
operator|=
name|htole32
argument_list|(
name|HWRM_WOL_FILTER_FREE_INPUT_ENABLES_WOL_FILTER_ID
argument_list|)
expr_stmt|;
name|req
operator|.
name|wol_filter_id
operator|=
name|softc
operator|->
name|wol_filter_id
expr_stmt|;
return|return
name|hwrm_send_message
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bnxt_hwrm_set_coal_params
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|,
name|uint32_t
name|max_frames
parameter_list|,
name|uint32_t
name|buf_tmrs
parameter_list|,
name|uint16_t
name|flags
parameter_list|,
name|struct
name|hwrm_ring_cmpl_ring_cfg_aggint_params_input
modifier|*
name|req
parameter_list|)
block|{
name|req
operator|->
name|flags
operator|=
name|htole16
argument_list|(
name|flags
argument_list|)
expr_stmt|;
name|req
operator|->
name|num_cmpl_dma_aggr
operator|=
name|htole16
argument_list|(
operator|(
name|uint16_t
operator|)
name|max_frames
argument_list|)
expr_stmt|;
name|req
operator|->
name|num_cmpl_dma_aggr_during_int
operator|=
name|htole16
argument_list|(
name|max_frames
operator|>>
literal|16
argument_list|)
expr_stmt|;
name|req
operator|->
name|cmpl_aggr_dma_tmr
operator|=
name|htole16
argument_list|(
operator|(
name|uint16_t
operator|)
name|buf_tmrs
argument_list|)
expr_stmt|;
name|req
operator|->
name|cmpl_aggr_dma_tmr_during_int
operator|=
name|htole16
argument_list|(
name|buf_tmrs
operator|>>
literal|16
argument_list|)
expr_stmt|;
comment|/* Minimum time between 2 interrupts set to buf_tmr x 2 */
name|req
operator|->
name|int_lat_tmr_min
operator|=
name|htole16
argument_list|(
operator|(
name|uint16_t
operator|)
name|buf_tmrs
operator|*
literal|2
argument_list|)
expr_stmt|;
name|req
operator|->
name|int_lat_tmr_max
operator|=
name|htole16
argument_list|(
operator|(
name|uint16_t
operator|)
name|buf_tmrs
operator|*
literal|4
argument_list|)
expr_stmt|;
name|req
operator|->
name|num_cmpl_aggr_int
operator|=
name|htole16
argument_list|(
operator|(
name|uint16_t
operator|)
name|max_frames
operator|*
literal|4
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|bnxt_hwrm_set_coal
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|rc
init|=
literal|0
decl_stmt|;
name|struct
name|hwrm_ring_cmpl_ring_cfg_aggint_params_input
name|req_rx
init|=
block|{
literal|0
block|}
decl_stmt|,
name|req_tx
init|=
block|{
literal|0
block|}
decl_stmt|,
modifier|*
name|req
decl_stmt|;
name|uint16_t
name|max_buf
decl_stmt|,
name|max_buf_irq
decl_stmt|;
name|uint16_t
name|buf_tmr
decl_stmt|,
name|buf_tmr_irq
decl_stmt|;
name|uint32_t
name|flags
decl_stmt|;
name|bnxt_hwrm_cmd_hdr_init
argument_list|(
name|softc
argument_list|,
operator|&
name|req_rx
argument_list|,
name|HWRM_RING_CMPL_RING_CFG_AGGINT_PARAMS
argument_list|)
expr_stmt|;
name|bnxt_hwrm_cmd_hdr_init
argument_list|(
name|softc
argument_list|,
operator|&
name|req_tx
argument_list|,
name|HWRM_RING_CMPL_RING_CFG_AGGINT_PARAMS
argument_list|)
expr_stmt|;
comment|/* Each rx completion (2 records) should be DMAed immediately.          * DMA 1/4 of the completion buffers at a time.          */
name|max_buf
operator|=
name|min_t
argument_list|(
name|uint16_t
argument_list|,
name|softc
operator|->
name|rx_coal_frames
operator|/
literal|4
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* max_buf must not be zero */
name|max_buf
operator|=
name|clamp_t
argument_list|(
name|uint16_t
argument_list|,
name|max_buf
argument_list|,
literal|1
argument_list|,
literal|63
argument_list|)
expr_stmt|;
name|max_buf_irq
operator|=
name|clamp_t
argument_list|(
name|uint16_t
argument_list|,
name|softc
operator|->
name|rx_coal_frames_irq
argument_list|,
literal|1
argument_list|,
literal|63
argument_list|)
expr_stmt|;
name|buf_tmr
operator|=
name|BNXT_USEC_TO_COAL_TIMER
argument_list|(
name|softc
operator|->
name|rx_coal_usecs
argument_list|)
expr_stmt|;
comment|/* buf timer set to 1/4 of interrupt timer */
name|buf_tmr
operator|=
name|max_t
argument_list|(
name|uint16_t
argument_list|,
name|buf_tmr
operator|/
literal|4
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|buf_tmr_irq
operator|=
name|BNXT_USEC_TO_COAL_TIMER
argument_list|(
name|softc
operator|->
name|rx_coal_usecs_irq
argument_list|)
expr_stmt|;
name|buf_tmr_irq
operator|=
name|max_t
argument_list|(
name|uint16_t
argument_list|,
name|buf_tmr_irq
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|flags
operator|=
name|HWRM_RING_CMPL_RING_CFG_AGGINT_PARAMS_INPUT_FLAGS_TIMER_RESET
expr_stmt|;
comment|/* RING_IDLE generates more IRQs for lower latency.  Enable it only          * if coal_usecs is less than 25 us.          */
if|if
condition|(
name|softc
operator|->
name|rx_coal_usecs
operator|<
literal|25
condition|)
name|flags
operator||=
name|HWRM_RING_CMPL_RING_CFG_AGGINT_PARAMS_INPUT_FLAGS_RING_IDLE
expr_stmt|;
name|bnxt_hwrm_set_coal_params
argument_list|(
name|softc
argument_list|,
name|max_buf_irq
operator|<<
literal|16
operator||
name|max_buf
argument_list|,
name|buf_tmr_irq
operator|<<
literal|16
operator||
name|buf_tmr
argument_list|,
name|flags
argument_list|,
operator|&
name|req_rx
argument_list|)
expr_stmt|;
comment|/* max_buf must not be zero */
name|max_buf
operator|=
name|clamp_t
argument_list|(
name|uint16_t
argument_list|,
name|softc
operator|->
name|tx_coal_frames
argument_list|,
literal|1
argument_list|,
literal|63
argument_list|)
expr_stmt|;
name|max_buf_irq
operator|=
name|clamp_t
argument_list|(
name|uint16_t
argument_list|,
name|softc
operator|->
name|tx_coal_frames_irq
argument_list|,
literal|1
argument_list|,
literal|63
argument_list|)
expr_stmt|;
name|buf_tmr
operator|=
name|BNXT_USEC_TO_COAL_TIMER
argument_list|(
name|softc
operator|->
name|tx_coal_usecs
argument_list|)
expr_stmt|;
comment|/* buf timer set to 1/4 of interrupt timer */
name|buf_tmr
operator|=
name|max_t
argument_list|(
name|uint16_t
argument_list|,
name|buf_tmr
operator|/
literal|4
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|buf_tmr_irq
operator|=
name|BNXT_USEC_TO_COAL_TIMER
argument_list|(
name|softc
operator|->
name|tx_coal_usecs_irq
argument_list|)
expr_stmt|;
name|buf_tmr_irq
operator|=
name|max_t
argument_list|(
name|uint16_t
argument_list|,
name|buf_tmr_irq
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|flags
operator|=
name|HWRM_RING_CMPL_RING_CFG_AGGINT_PARAMS_INPUT_FLAGS_TIMER_RESET
expr_stmt|;
name|bnxt_hwrm_set_coal_params
argument_list|(
name|softc
argument_list|,
name|max_buf_irq
operator|<<
literal|16
operator||
name|max_buf
argument_list|,
name|buf_tmr_irq
operator|<<
literal|16
operator||
name|buf_tmr
argument_list|,
name|flags
argument_list|,
operator|&
name|req_tx
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|softc
operator|->
name|nrxqsets
condition|;
name|i
operator|++
control|)
block|{
name|req
operator|=
operator|&
name|req_rx
expr_stmt|;
comment|/*                  * TBD: 		 *      Check if Tx also needs to be done                  *      So far, Tx processing has been done in softirq contest                  * 		 * req =&req_tx; 		 */
name|req
operator|->
name|ring_id
operator|=
name|htole16
argument_list|(
name|softc
operator|->
name|grp_info
index|[
name|i
index|]
operator|.
name|cp_ring_id
argument_list|)
expr_stmt|;
name|rc
operator|=
name|hwrm_send_message
argument_list|(
name|softc
argument_list|,
name|req
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|req
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
break|break;
block|}
return|return
name|rc
return|;
block|}
end_function

begin_function
name|int
name|bnxt_hwrm_func_rgtr_async_events
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|,
name|unsigned
name|long
modifier|*
name|bmap
parameter_list|,
name|int
name|bmap_size
parameter_list|)
block|{
name|struct
name|hwrm_func_drv_rgtr_input
name|req
init|=
block|{
literal|0
block|}
decl_stmt|;
name|bitstr_t
modifier|*
name|async_events_bmap
decl_stmt|;
name|uint32_t
modifier|*
name|events
decl_stmt|;
name|int
name|i
decl_stmt|;
name|async_events_bmap
operator|=
name|bit_alloc
argument_list|(
literal|256
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|events
operator|=
operator|(
name|uint32_t
operator|*
operator|)
name|async_events_bmap
expr_stmt|;
name|bnxt_hwrm_cmd_hdr_init
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
name|HWRM_FUNC_DRV_RGTR
argument_list|)
expr_stmt|;
name|req
operator|.
name|enables
operator|=
name|htole32
argument_list|(
name|HWRM_FUNC_DRV_RGTR_INPUT_ENABLES_ASYNC_EVENT_FWD
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|async_events_bmap
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
literal|256
operator|/
literal|8
argument_list|)
argument_list|)
expr_stmt|;
name|bit_set
argument_list|(
name|async_events_bmap
argument_list|,
name|HWRM_ASYNC_EVENT_CMPL_EVENT_ID_LINK_STATUS_CHANGE
argument_list|)
expr_stmt|;
name|bit_set
argument_list|(
name|async_events_bmap
argument_list|,
name|HWRM_ASYNC_EVENT_CMPL_EVENT_ID_PF_DRVR_UNLOAD
argument_list|)
expr_stmt|;
name|bit_set
argument_list|(
name|async_events_bmap
argument_list|,
name|HWRM_ASYNC_EVENT_CMPL_EVENT_ID_PORT_CONN_NOT_ALLOWED
argument_list|)
expr_stmt|;
name|bit_set
argument_list|(
name|async_events_bmap
argument_list|,
name|HWRM_ASYNC_EVENT_CMPL_EVENT_ID_VF_CFG_CHANGE
argument_list|)
expr_stmt|;
name|bit_set
argument_list|(
name|async_events_bmap
argument_list|,
name|HWRM_ASYNC_EVENT_CMPL_EVENT_ID_LINK_SPEED_CFG_CHANGE
argument_list|)
expr_stmt|;
if|if
condition|(
name|bmap
operator|&&
name|bmap_size
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|bmap_size
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|bit_test
argument_list|(
name|bmap
argument_list|,
name|i
argument_list|)
condition|)
name|bit_set
argument_list|(
name|async_events_bmap
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
name|req
operator|.
name|async_event_fwd
index|[
name|i
index|]
operator||=
name|htole32
argument_list|(
name|events
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|async_events_bmap
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
return|return
name|hwrm_send_message
argument_list|(
name|softc
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
return|;
block|}
end_function

end_unit


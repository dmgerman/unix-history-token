begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Broadcom NetXtreme-C/E network driver.  *  * Copyright (c) 2016 Broadcom, All Rights Reserved.  * The term Broadcom refers to Broadcom Limited and/or its subsidiaries  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS'  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF  * THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_include
include|#
directive|include
file|<sys/priv.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<dev/pci/pcireg.h>
end_include

begin_include
include|#
directive|include
file|<dev/pci/pcivar.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_media.h>
end_include

begin_include
include|#
directive|include
file|<net/if_var.h>
end_include

begin_include
include|#
directive|include
file|<net/ethernet.h>
end_include

begin_include
include|#
directive|include
file|<net/iflib.h>
end_include

begin_include
include|#
directive|include
file|"opt_inet.h"
end_include

begin_include
include|#
directive|include
file|"opt_inet6.h"
end_include

begin_include
include|#
directive|include
file|"opt_rss.h"
end_include

begin_include
include|#
directive|include
file|"ifdi_if.h"
end_include

begin_include
include|#
directive|include
file|"bnxt.h"
end_include

begin_include
include|#
directive|include
file|"bnxt_hwrm.h"
end_include

begin_include
include|#
directive|include
file|"bnxt_ioctl.h"
end_include

begin_include
include|#
directive|include
file|"bnxt_sysctl.h"
end_include

begin_include
include|#
directive|include
file|"hsi_struct_def.h"
end_include

begin_comment
comment|/*  * PCI Device ID Table  */
end_comment

begin_decl_stmt
specifier|static
name|pci_vendor_info_t
name|bnxt_vendor_info_array
index|[]
init|=
block|{
name|PVID
argument_list|(
name|BROADCOM_VENDOR_ID
argument_list|,
name|BCM57301
argument_list|,
literal|"Broadcom BCM57301 NetXtreme-C 10Gb Ethernet Controller"
argument_list|)
block|,
name|PVID
argument_list|(
name|BROADCOM_VENDOR_ID
argument_list|,
name|BCM57302
argument_list|,
literal|"Broadcom BCM57302 NetXtreme-C 10Gb/25Gb Ethernet Controller"
argument_list|)
block|,
name|PVID
argument_list|(
name|BROADCOM_VENDOR_ID
argument_list|,
name|BCM57304
argument_list|,
literal|"Broadcom BCM57304 NetXtreme-C 10Gb/25Gb/40Gb/50Gb Ethernet Controller"
argument_list|)
block|,
name|PVID
argument_list|(
name|BROADCOM_VENDOR_ID
argument_list|,
name|BCM57402
argument_list|,
literal|"Broadcom BCM57402 NetXtreme-E 10Gb Ethernet Controller"
argument_list|)
block|,
name|PVID
argument_list|(
name|BROADCOM_VENDOR_ID
argument_list|,
name|BCM57404
argument_list|,
literal|"Broadcom BCM57404 NetXtreme-E 10Gb/25Gb Ethernet Controller"
argument_list|)
block|,
name|PVID
argument_list|(
name|BROADCOM_VENDOR_ID
argument_list|,
name|BCM57406
argument_list|,
literal|"Broadcom BCM57406 NetXtreme-E 10GBase-T Ethernet Controller"
argument_list|)
block|,
name|PVID
argument_list|(
name|BROADCOM_VENDOR_ID
argument_list|,
name|BCM57402_NPAR
argument_list|,
literal|"Broadcom BCM57402 NetXtreme-E Partition"
argument_list|)
block|,
name|PVID
argument_list|(
name|BROADCOM_VENDOR_ID
argument_list|,
name|BCM57407
argument_list|,
literal|"Broadcom BCM57407 NetXtreme-E 10GBase-T Ethernet Controller"
argument_list|)
block|,
name|PVID
argument_list|(
name|BROADCOM_VENDOR_ID
argument_list|,
name|BCM57404_NPAR
argument_list|,
literal|"Broadcom BCM57404 NetXtreme-E Partition"
argument_list|)
block|,
name|PVID
argument_list|(
name|BROADCOM_VENDOR_ID
argument_list|,
name|BCM57406_NPAR
argument_list|,
literal|"Broadcom BCM57406 NetXtreme-E Partition"
argument_list|)
block|,
name|PVID
argument_list|(
name|BROADCOM_VENDOR_ID
argument_list|,
name|BCM57407_SFP
argument_list|,
literal|"Broadcom BCM57407 NetXtreme-E 25Gb Ethernet Controller"
argument_list|)
block|,
name|PVID
argument_list|(
name|BROADCOM_VENDOR_ID
argument_list|,
name|BCM57304_VF
argument_list|,
literal|"Broadcom BCM57304 NetXtreme-C Virtual Function"
argument_list|)
block|,
name|PVID
argument_list|(
name|BROADCOM_VENDOR_ID
argument_list|,
name|BCM57404_VF
argument_list|,
literal|"Broadcom BCM57404 NetXtreme-E Virtual Function"
argument_list|)
block|,
comment|/* required last entry */
name|PVID_END
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Function prototypes  */
end_comment

begin_function_decl
specifier|static
name|void
modifier|*
name|bnxt_register
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* Soft queue setup and teardown */
end_comment

begin_function_decl
specifier|static
name|int
name|bnxt_tx_queues_alloc
parameter_list|(
name|if_ctx_t
name|ctx
parameter_list|,
name|caddr_t
modifier|*
name|vaddrs
parameter_list|,
name|uint64_t
modifier|*
name|paddrs
parameter_list|,
name|int
name|ntxqs
parameter_list|,
name|int
name|ntxqsets
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bnxt_rx_queues_alloc
parameter_list|(
name|if_ctx_t
name|ctx
parameter_list|,
name|caddr_t
modifier|*
name|vaddrs
parameter_list|,
name|uint64_t
modifier|*
name|paddrs
parameter_list|,
name|int
name|nrxqs
parameter_list|,
name|int
name|nrxqsets
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bnxt_queues_free
parameter_list|(
name|if_ctx_t
name|ctx
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* Device setup and teardown */
end_comment

begin_function_decl
specifier|static
name|int
name|bnxt_attach_pre
parameter_list|(
name|if_ctx_t
name|ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bnxt_attach_post
parameter_list|(
name|if_ctx_t
name|ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bnxt_detach
parameter_list|(
name|if_ctx_t
name|ctx
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* Device configuration */
end_comment

begin_function_decl
specifier|static
name|void
name|bnxt_init
parameter_list|(
name|if_ctx_t
name|ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bnxt_stop
parameter_list|(
name|if_ctx_t
name|ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bnxt_multi_set
parameter_list|(
name|if_ctx_t
name|ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bnxt_mtu_set
parameter_list|(
name|if_ctx_t
name|ctx
parameter_list|,
name|uint32_t
name|mtu
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bnxt_media_status
parameter_list|(
name|if_ctx_t
name|ctx
parameter_list|,
name|struct
name|ifmediareq
modifier|*
name|ifmr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bnxt_media_change
parameter_list|(
name|if_ctx_t
name|ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bnxt_promisc_set
parameter_list|(
name|if_ctx_t
name|ctx
parameter_list|,
name|int
name|flags
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint64_t
name|bnxt_get_counter
parameter_list|(
name|if_ctx_t
parameter_list|,
name|ift_counter
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bnxt_update_admin_status
parameter_list|(
name|if_ctx_t
name|ctx
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* Interrupt enable / disable */
end_comment

begin_function_decl
specifier|static
name|void
name|bnxt_intr_enable
parameter_list|(
name|if_ctx_t
name|ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bnxt_queue_intr_enable
parameter_list|(
name|if_ctx_t
name|ctx
parameter_list|,
name|uint16_t
name|qid
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bnxt_disable_intr
parameter_list|(
name|if_ctx_t
name|ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bnxt_msix_intr_assign
parameter_list|(
name|if_ctx_t
name|ctx
parameter_list|,
name|int
name|msix
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* vlan support */
end_comment

begin_function_decl
specifier|static
name|void
name|bnxt_vlan_register
parameter_list|(
name|if_ctx_t
name|ctx
parameter_list|,
name|uint16_t
name|vtag
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bnxt_vlan_unregister
parameter_list|(
name|if_ctx_t
name|ctx
parameter_list|,
name|uint16_t
name|vtag
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* ioctl */
end_comment

begin_function_decl
specifier|static
name|int
name|bnxt_priv_ioctl
parameter_list|(
name|if_ctx_t
name|ctx
parameter_list|,
name|u_long
name|command
parameter_list|,
name|caddr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* Internal support functions */
end_comment

begin_function_decl
specifier|static
name|int
name|bnxt_probe_phy
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bnxt_add_media_types
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bnxt_pci_mapping
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bnxt_pci_mapping_free
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bnxt_update_link
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|,
name|bool
name|chng_link_state
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bnxt_handle_def_cp
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bnxt_handle_rx_cp
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bnxt_clear_ids
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
specifier|inline
name|bnxt_do_enable_intr
parameter_list|(
name|struct
name|bnxt_cp_ring
modifier|*
name|cpr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
specifier|inline
name|bnxt_do_disable_intr
parameter_list|(
name|struct
name|bnxt_cp_ring
modifier|*
name|cpr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bnxt_mark_cpr_invalid
parameter_list|(
name|struct
name|bnxt_cp_ring
modifier|*
name|cpr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bnxt_def_cp_task
parameter_list|(
name|void
modifier|*
name|context
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bnxt_handle_async_event
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|,
name|struct
name|cmpl_base
modifier|*
name|cmpl
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint8_t
name|get_phy_type
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint64_t
name|bnxt_get_baudrate
parameter_list|(
name|struct
name|bnxt_link_info
modifier|*
name|link
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * Device Interface Declaration  */
end_comment

begin_decl_stmt
specifier|static
name|device_method_t
name|bnxt_methods
index|[]
init|=
block|{
comment|/* Device interface */
name|DEVMETHOD
argument_list|(
name|device_register
argument_list|,
name|bnxt_register
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|iflib_device_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|iflib_device_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|iflib_device_detach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_shutdown
argument_list|,
name|iflib_device_shutdown
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_suspend
argument_list|,
name|iflib_device_suspend
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_resume
argument_list|,
name|iflib_device_resume
argument_list|)
block|,
name|DEVMETHOD_END
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|bnxt_driver
init|=
block|{
literal|"bnxt"
block|,
name|bnxt_methods
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|bnxt_softc
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|devclass_t
name|bnxt_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|bnxt
argument_list|,
name|pci
argument_list|,
name|bnxt_driver
argument_list|,
name|bnxt_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|bnxt
argument_list|,
name|pci
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|bnxt
argument_list|,
name|ether
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|bnxt
argument_list|,
name|iflib
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|device_method_t
name|bnxt_iflib_methods
index|[]
init|=
block|{
name|DEVMETHOD
argument_list|(
name|ifdi_tx_queues_alloc
argument_list|,
name|bnxt_tx_queues_alloc
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|ifdi_rx_queues_alloc
argument_list|,
name|bnxt_rx_queues_alloc
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|ifdi_queues_free
argument_list|,
name|bnxt_queues_free
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|ifdi_attach_pre
argument_list|,
name|bnxt_attach_pre
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|ifdi_attach_post
argument_list|,
name|bnxt_attach_post
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|ifdi_detach
argument_list|,
name|bnxt_detach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|ifdi_init
argument_list|,
name|bnxt_init
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|ifdi_stop
argument_list|,
name|bnxt_stop
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|ifdi_multi_set
argument_list|,
name|bnxt_multi_set
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|ifdi_mtu_set
argument_list|,
name|bnxt_mtu_set
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|ifdi_media_status
argument_list|,
name|bnxt_media_status
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|ifdi_media_change
argument_list|,
name|bnxt_media_change
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|ifdi_promisc_set
argument_list|,
name|bnxt_promisc_set
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|ifdi_get_counter
argument_list|,
name|bnxt_get_counter
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|ifdi_update_admin_status
argument_list|,
name|bnxt_update_admin_status
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|ifdi_intr_enable
argument_list|,
name|bnxt_intr_enable
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|ifdi_queue_intr_enable
argument_list|,
name|bnxt_queue_intr_enable
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|ifdi_intr_disable
argument_list|,
name|bnxt_disable_intr
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|ifdi_msix_intr_assign
argument_list|,
name|bnxt_msix_intr_assign
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|ifdi_vlan_register
argument_list|,
name|bnxt_vlan_register
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|ifdi_vlan_unregister
argument_list|,
name|bnxt_vlan_unregister
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|ifdi_priv_ioctl
argument_list|,
name|bnxt_priv_ioctl
argument_list|)
block|,
name|DEVMETHOD_END
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|bnxt_iflib_driver
init|=
block|{
literal|"bnxt"
block|,
name|bnxt_iflib_methods
block|,
expr|sizeof
operator|(
expr|struct
name|bnxt_softc
operator|)
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * iflib shared context  */
end_comment

begin_decl_stmt
name|char
name|bnxt_driver_version
index|[]
init|=
literal|"https://github.com/Broadcom/freebsd-nxt/commits/bnxt-dev"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|struct
name|if_txrx
name|bnxt_txrx
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|if_shared_ctx
name|bnxt_sctx_init
init|=
block|{
operator|.
name|isc_magic
operator|=
name|IFLIB_MAGIC
block|,
operator|.
name|isc_txrx
operator|=
operator|&
name|bnxt_txrx
block|,
operator|.
name|isc_driver
operator|=
operator|&
name|bnxt_iflib_driver
block|,
operator|.
name|isc_nfl
operator|=
literal|2
block|,
comment|// Number of Free Lists
operator|.
name|isc_flags
operator|=
name|IFLIB_HAS_RXCQ
operator||
name|IFLIB_HAS_TXCQ
block|,
operator|.
name|isc_q_align
operator|=
name|PAGE_SIZE
block|,
operator|.
name|isc_tx_maxsize
operator|=
name|BNXT_TSO_SIZE
block|,
operator|.
name|isc_tx_maxsegsize
operator|=
name|BNXT_TSO_SIZE
block|,
operator|.
name|isc_rx_maxsize
operator|=
name|BNXT_TSO_SIZE
block|,
operator|.
name|isc_rx_maxsegsize
operator|=
name|BNXT_TSO_SIZE
block|,
comment|// Only use a single segment to avoid page size constraints
operator|.
name|isc_rx_nsegments
operator|=
literal|1
block|,
operator|.
name|isc_ntxqs
operator|=
literal|2
block|,
operator|.
name|isc_nrxqs
operator|=
literal|3
block|,
operator|.
name|isc_nrxd_min
operator|=
block|{
literal|16
block|,
literal|16
block|,
literal|16
block|}
block|,
operator|.
name|isc_nrxd_default
operator|=
block|{
name|PAGE_SIZE
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|cmpl_base
argument_list|)
operator|*
literal|8
block|,
name|PAGE_SIZE
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|rx_prod_pkt_bd
argument_list|)
block|,
name|PAGE_SIZE
operator|/
expr|sizeof
operator|(
expr|struct
name|rx_prod_pkt_bd
operator|)
block|}
block|,
operator|.
name|isc_nrxd_max
operator|=
block|{
name|INT32_MAX
block|,
name|INT32_MAX
block|,
name|INT32_MAX
block|}
block|,
operator|.
name|isc_ntxd_min
operator|=
block|{
literal|16
block|,
literal|16
block|,
literal|16
block|}
block|,
operator|.
name|isc_ntxd_default
operator|=
block|{
name|PAGE_SIZE
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|cmpl_base
argument_list|)
operator|*
literal|2
block|,
name|PAGE_SIZE
operator|/
expr|sizeof
operator|(
expr|struct
name|tx_bd_short
operator|)
block|}
block|,
operator|.
name|isc_ntxd_max
operator|=
block|{
name|INT32_MAX
block|,
name|INT32_MAX
block|,
name|INT32_MAX
block|}
block|,
operator|.
name|isc_admin_intrcnt
operator|=
literal|1
block|,
operator|.
name|isc_vendor_info
operator|=
name|bnxt_vendor_info_array
block|,
operator|.
name|isc_driver_version
operator|=
name|bnxt_driver_version
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|if_shared_ctx_t
name|bnxt_sctx
init|=
operator|&
name|bnxt_sctx_init
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Device Methods  */
end_comment

begin_function
specifier|static
name|void
modifier|*
name|bnxt_register
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
return|return
name|bnxt_sctx
return|;
block|}
end_function

begin_comment
comment|/*  * Device Dependent Configuration Functions */
end_comment

begin_comment
comment|/* Soft queue setup and teardown */
end_comment

begin_function
specifier|static
name|int
name|bnxt_tx_queues_alloc
parameter_list|(
name|if_ctx_t
name|ctx
parameter_list|,
name|caddr_t
modifier|*
name|vaddrs
parameter_list|,
name|uint64_t
modifier|*
name|paddrs
parameter_list|,
name|int
name|ntxqs
parameter_list|,
name|int
name|ntxqsets
parameter_list|)
block|{
name|struct
name|bnxt_softc
modifier|*
name|softc
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|softc
operator|=
name|iflib_get_softc
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
name|softc
operator|->
name|tx_cp_rings
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|bnxt_cp_ring
argument_list|)
operator|*
name|ntxqsets
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|softc
operator|->
name|tx_cp_rings
condition|)
block|{
name|device_printf
argument_list|(
name|iflib_get_dev
argument_list|(
name|ctx
argument_list|)
argument_list|,
literal|"unable to allocate TX completion rings\n"
argument_list|)
expr_stmt|;
name|rc
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|cp_alloc_fail
goto|;
block|}
name|softc
operator|->
name|tx_rings
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|bnxt_ring
argument_list|)
operator|*
name|ntxqsets
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|softc
operator|->
name|tx_rings
condition|)
block|{
name|device_printf
argument_list|(
name|iflib_get_dev
argument_list|(
name|ctx
argument_list|)
argument_list|,
literal|"unable to allocate TX rings\n"
argument_list|)
expr_stmt|;
name|rc
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|ring_alloc_fail
goto|;
block|}
name|rc
operator|=
name|iflib_dma_alloc
argument_list|(
name|ctx
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ctx_hw_stats
argument_list|)
operator|*
name|ntxqsets
argument_list|,
operator|&
name|softc
operator|->
name|tx_stats
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|dma_alloc_fail
goto|;
name|bus_dmamap_sync
argument_list|(
name|softc
operator|->
name|tx_stats
operator|.
name|idi_tag
argument_list|,
name|softc
operator|->
name|tx_stats
operator|.
name|idi_map
argument_list|,
name|BUS_DMASYNC_PREREAD
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ntxqsets
condition|;
name|i
operator|++
control|)
block|{
comment|/* Set up the completion ring */
name|softc
operator|->
name|tx_cp_rings
index|[
name|i
index|]
operator|.
name|stats_ctx_id
operator|=
name|HWRM_NA_SIGNATURE
expr_stmt|;
name|softc
operator|->
name|tx_cp_rings
index|[
name|i
index|]
operator|.
name|ring
operator|.
name|phys_id
operator|=
operator|(
name|uint16_t
operator|)
name|HWRM_NA_SIGNATURE
expr_stmt|;
name|softc
operator|->
name|tx_cp_rings
index|[
name|i
index|]
operator|.
name|ring
operator|.
name|softc
operator|=
name|softc
expr_stmt|;
name|softc
operator|->
name|tx_cp_rings
index|[
name|i
index|]
operator|.
name|ring
operator|.
name|id
operator|=
operator|(
name|softc
operator|->
name|scctx
operator|->
name|isc_nrxqsets
operator|*
literal|2
operator|)
operator|+
literal|1
operator|+
name|i
expr_stmt|;
name|softc
operator|->
name|tx_cp_rings
index|[
name|i
index|]
operator|.
name|ring
operator|.
name|doorbell
operator|=
name|softc
operator|->
name|tx_cp_rings
index|[
name|i
index|]
operator|.
name|ring
operator|.
name|id
operator|*
literal|0x80
expr_stmt|;
name|softc
operator|->
name|tx_cp_rings
index|[
name|i
index|]
operator|.
name|ring
operator|.
name|ring_size
operator|=
name|softc
operator|->
name|scctx
operator|->
name|isc_ntxd
index|[
literal|0
index|]
expr_stmt|;
name|softc
operator|->
name|tx_cp_rings
index|[
name|i
index|]
operator|.
name|ring
operator|.
name|vaddr
operator|=
name|vaddrs
index|[
name|i
operator|*
name|ntxqs
index|]
expr_stmt|;
name|softc
operator|->
name|tx_cp_rings
index|[
name|i
index|]
operator|.
name|ring
operator|.
name|paddr
operator|=
name|paddrs
index|[
name|i
operator|*
name|ntxqs
index|]
expr_stmt|;
comment|/* Set up the TX ring */
name|softc
operator|->
name|tx_rings
index|[
name|i
index|]
operator|.
name|phys_id
operator|=
operator|(
name|uint16_t
operator|)
name|HWRM_NA_SIGNATURE
expr_stmt|;
name|softc
operator|->
name|tx_rings
index|[
name|i
index|]
operator|.
name|softc
operator|=
name|softc
expr_stmt|;
name|softc
operator|->
name|tx_rings
index|[
name|i
index|]
operator|.
name|id
operator|=
operator|(
name|softc
operator|->
name|scctx
operator|->
name|isc_nrxqsets
operator|*
literal|2
operator|)
operator|+
literal|1
operator|+
name|i
expr_stmt|;
name|softc
operator|->
name|tx_rings
index|[
name|i
index|]
operator|.
name|doorbell
operator|=
name|softc
operator|->
name|tx_rings
index|[
name|i
index|]
operator|.
name|id
operator|*
literal|0x80
expr_stmt|;
name|softc
operator|->
name|tx_rings
index|[
name|i
index|]
operator|.
name|ring_size
operator|=
name|softc
operator|->
name|scctx
operator|->
name|isc_ntxd
index|[
literal|1
index|]
expr_stmt|;
name|softc
operator|->
name|tx_rings
index|[
name|i
index|]
operator|.
name|vaddr
operator|=
name|vaddrs
index|[
name|i
operator|*
name|ntxqs
operator|+
literal|1
index|]
expr_stmt|;
name|softc
operator|->
name|tx_rings
index|[
name|i
index|]
operator|.
name|paddr
operator|=
name|paddrs
index|[
name|i
operator|*
name|ntxqs
operator|+
literal|1
index|]
expr_stmt|;
name|bnxt_create_tx_sysctls
argument_list|(
name|softc
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
name|softc
operator|->
name|ntxqsets
operator|=
name|ntxqsets
expr_stmt|;
return|return
name|rc
return|;
name|dma_alloc_fail
label|:
name|free
argument_list|(
name|softc
operator|->
name|tx_rings
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|ring_alloc_fail
label|:
name|free
argument_list|(
name|softc
operator|->
name|tx_cp_rings
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|cp_alloc_fail
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bnxt_queues_free
parameter_list|(
name|if_ctx_t
name|ctx
parameter_list|)
block|{
name|struct
name|bnxt_softc
modifier|*
name|softc
init|=
name|iflib_get_softc
argument_list|(
name|ctx
argument_list|)
decl_stmt|;
comment|// Free TX queues
name|iflib_dma_free
argument_list|(
operator|&
name|softc
operator|->
name|tx_stats
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|softc
operator|->
name|tx_rings
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|softc
operator|->
name|tx_rings
operator|=
name|NULL
expr_stmt|;
name|free
argument_list|(
name|softc
operator|->
name|tx_cp_rings
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|softc
operator|->
name|tx_cp_rings
operator|=
name|NULL
expr_stmt|;
name|softc
operator|->
name|ntxqsets
operator|=
literal|0
expr_stmt|;
comment|// Free RX queues
name|iflib_dma_free
argument_list|(
operator|&
name|softc
operator|->
name|rx_stats
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|softc
operator|->
name|grp_info
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|softc
operator|->
name|ag_rings
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|softc
operator|->
name|rx_rings
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|softc
operator|->
name|rx_cp_rings
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|bnxt_rx_queues_alloc
parameter_list|(
name|if_ctx_t
name|ctx
parameter_list|,
name|caddr_t
modifier|*
name|vaddrs
parameter_list|,
name|uint64_t
modifier|*
name|paddrs
parameter_list|,
name|int
name|nrxqs
parameter_list|,
name|int
name|nrxqsets
parameter_list|)
block|{
name|struct
name|bnxt_softc
modifier|*
name|softc
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|softc
operator|=
name|iflib_get_softc
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
name|softc
operator|->
name|rx_cp_rings
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|bnxt_cp_ring
argument_list|)
operator|*
name|nrxqsets
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|softc
operator|->
name|rx_cp_rings
condition|)
block|{
name|device_printf
argument_list|(
name|iflib_get_dev
argument_list|(
name|ctx
argument_list|)
argument_list|,
literal|"unable to allocate RX completion rings\n"
argument_list|)
expr_stmt|;
name|rc
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|cp_alloc_fail
goto|;
block|}
name|softc
operator|->
name|rx_rings
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|bnxt_ring
argument_list|)
operator|*
name|nrxqsets
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|softc
operator|->
name|rx_rings
condition|)
block|{
name|device_printf
argument_list|(
name|iflib_get_dev
argument_list|(
name|ctx
argument_list|)
argument_list|,
literal|"unable to allocate RX rings\n"
argument_list|)
expr_stmt|;
name|rc
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|ring_alloc_fail
goto|;
block|}
name|softc
operator|->
name|ag_rings
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|bnxt_ring
argument_list|)
operator|*
name|nrxqsets
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|softc
operator|->
name|ag_rings
condition|)
block|{
name|device_printf
argument_list|(
name|iflib_get_dev
argument_list|(
name|ctx
argument_list|)
argument_list|,
literal|"unable to allocate aggregation rings\n"
argument_list|)
expr_stmt|;
name|rc
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|ag_alloc_fail
goto|;
block|}
name|softc
operator|->
name|grp_info
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|bnxt_grp_info
argument_list|)
operator|*
name|nrxqsets
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|softc
operator|->
name|grp_info
condition|)
block|{
name|device_printf
argument_list|(
name|iflib_get_dev
argument_list|(
name|ctx
argument_list|)
argument_list|,
literal|"unable to allocate ring groups\n"
argument_list|)
expr_stmt|;
name|rc
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|grp_alloc_fail
goto|;
block|}
name|rc
operator|=
name|iflib_dma_alloc
argument_list|(
name|ctx
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ctx_hw_stats
argument_list|)
operator|*
name|nrxqsets
argument_list|,
operator|&
name|softc
operator|->
name|rx_stats
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|hw_stats_alloc_fail
goto|;
name|bus_dmamap_sync
argument_list|(
name|softc
operator|->
name|rx_stats
operator|.
name|idi_tag
argument_list|,
name|softc
operator|->
name|rx_stats
operator|.
name|idi_map
argument_list|,
name|BUS_DMASYNC_PREREAD
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nrxqsets
condition|;
name|i
operator|++
control|)
block|{
comment|/* Allocation the completion ring */
name|softc
operator|->
name|rx_cp_rings
index|[
name|i
index|]
operator|.
name|stats_ctx_id
operator|=
name|HWRM_NA_SIGNATURE
expr_stmt|;
name|softc
operator|->
name|rx_cp_rings
index|[
name|i
index|]
operator|.
name|ring
operator|.
name|phys_id
operator|=
operator|(
name|uint16_t
operator|)
name|HWRM_NA_SIGNATURE
expr_stmt|;
name|softc
operator|->
name|rx_cp_rings
index|[
name|i
index|]
operator|.
name|ring
operator|.
name|softc
operator|=
name|softc
expr_stmt|;
name|softc
operator|->
name|rx_cp_rings
index|[
name|i
index|]
operator|.
name|ring
operator|.
name|id
operator|=
name|i
operator|+
literal|1
expr_stmt|;
name|softc
operator|->
name|rx_cp_rings
index|[
name|i
index|]
operator|.
name|ring
operator|.
name|doorbell
operator|=
name|softc
operator|->
name|rx_cp_rings
index|[
name|i
index|]
operator|.
name|ring
operator|.
name|id
operator|*
literal|0x80
expr_stmt|;
comment|/* 		 * If this ring overflows, RX stops working. 		 */
name|softc
operator|->
name|rx_cp_rings
index|[
name|i
index|]
operator|.
name|ring
operator|.
name|ring_size
operator|=
name|softc
operator|->
name|scctx
operator|->
name|isc_nrxd
index|[
literal|0
index|]
expr_stmt|;
name|softc
operator|->
name|rx_cp_rings
index|[
name|i
index|]
operator|.
name|ring
operator|.
name|vaddr
operator|=
name|vaddrs
index|[
name|i
operator|*
name|nrxqs
index|]
expr_stmt|;
name|softc
operator|->
name|rx_cp_rings
index|[
name|i
index|]
operator|.
name|ring
operator|.
name|paddr
operator|=
name|paddrs
index|[
name|i
operator|*
name|nrxqs
index|]
expr_stmt|;
comment|/* Allocate the RX ring */
name|softc
operator|->
name|rx_rings
index|[
name|i
index|]
operator|.
name|phys_id
operator|=
operator|(
name|uint16_t
operator|)
name|HWRM_NA_SIGNATURE
expr_stmt|;
name|softc
operator|->
name|rx_rings
index|[
name|i
index|]
operator|.
name|softc
operator|=
name|softc
expr_stmt|;
name|softc
operator|->
name|rx_rings
index|[
name|i
index|]
operator|.
name|id
operator|=
name|i
operator|+
literal|1
expr_stmt|;
name|softc
operator|->
name|rx_rings
index|[
name|i
index|]
operator|.
name|doorbell
operator|=
name|softc
operator|->
name|rx_rings
index|[
name|i
index|]
operator|.
name|id
operator|*
literal|0x80
expr_stmt|;
name|softc
operator|->
name|rx_rings
index|[
name|i
index|]
operator|.
name|ring_size
operator|=
name|softc
operator|->
name|scctx
operator|->
name|isc_nrxd
index|[
literal|1
index|]
expr_stmt|;
name|softc
operator|->
name|rx_rings
index|[
name|i
index|]
operator|.
name|vaddr
operator|=
name|vaddrs
index|[
name|i
operator|*
name|nrxqs
operator|+
literal|1
index|]
expr_stmt|;
name|softc
operator|->
name|rx_rings
index|[
name|i
index|]
operator|.
name|paddr
operator|=
name|paddrs
index|[
name|i
operator|*
name|nrxqs
operator|+
literal|1
index|]
expr_stmt|;
comment|/* Allocate the AG ring */
name|softc
operator|->
name|ag_rings
index|[
name|i
index|]
operator|.
name|phys_id
operator|=
operator|(
name|uint16_t
operator|)
name|HWRM_NA_SIGNATURE
expr_stmt|;
name|softc
operator|->
name|ag_rings
index|[
name|i
index|]
operator|.
name|softc
operator|=
name|softc
expr_stmt|;
name|softc
operator|->
name|ag_rings
index|[
name|i
index|]
operator|.
name|id
operator|=
name|nrxqsets
operator|+
name|i
operator|+
literal|1
expr_stmt|;
name|softc
operator|->
name|ag_rings
index|[
name|i
index|]
operator|.
name|doorbell
operator|=
name|softc
operator|->
name|ag_rings
index|[
name|i
index|]
operator|.
name|id
operator|*
literal|0x80
expr_stmt|;
name|softc
operator|->
name|ag_rings
index|[
name|i
index|]
operator|.
name|ring_size
operator|=
name|softc
operator|->
name|scctx
operator|->
name|isc_nrxd
index|[
literal|2
index|]
expr_stmt|;
name|softc
operator|->
name|ag_rings
index|[
name|i
index|]
operator|.
name|vaddr
operator|=
name|vaddrs
index|[
name|i
operator|*
name|nrxqs
operator|+
literal|2
index|]
expr_stmt|;
name|softc
operator|->
name|ag_rings
index|[
name|i
index|]
operator|.
name|paddr
operator|=
name|paddrs
index|[
name|i
operator|*
name|nrxqs
operator|+
literal|2
index|]
expr_stmt|;
comment|/* Allocate the ring group */
name|softc
operator|->
name|grp_info
index|[
name|i
index|]
operator|.
name|grp_id
operator|=
operator|(
name|uint16_t
operator|)
name|HWRM_NA_SIGNATURE
expr_stmt|;
name|softc
operator|->
name|grp_info
index|[
name|i
index|]
operator|.
name|stats_ctx
operator|=
name|softc
operator|->
name|rx_cp_rings
index|[
name|i
index|]
operator|.
name|stats_ctx_id
expr_stmt|;
name|softc
operator|->
name|grp_info
index|[
name|i
index|]
operator|.
name|rx_ring_id
operator|=
name|softc
operator|->
name|rx_rings
index|[
name|i
index|]
operator|.
name|phys_id
expr_stmt|;
name|softc
operator|->
name|grp_info
index|[
name|i
index|]
operator|.
name|ag_ring_id
operator|=
name|softc
operator|->
name|ag_rings
index|[
name|i
index|]
operator|.
name|phys_id
expr_stmt|;
name|softc
operator|->
name|grp_info
index|[
name|i
index|]
operator|.
name|cp_ring_id
operator|=
name|softc
operator|->
name|rx_cp_rings
index|[
name|i
index|]
operator|.
name|ring
operator|.
name|phys_id
expr_stmt|;
name|bnxt_create_rx_sysctls
argument_list|(
name|softc
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
comment|/* And finally, the VNIC */
name|softc
operator|->
name|vnic_info
operator|.
name|id
operator|=
operator|(
name|uint16_t
operator|)
name|HWRM_NA_SIGNATURE
expr_stmt|;
name|softc
operator|->
name|vnic_info
operator|.
name|flow_id
operator|=
operator|(
name|uint16_t
operator|)
name|HWRM_NA_SIGNATURE
expr_stmt|;
name|softc
operator|->
name|vnic_info
operator|.
name|filter_id
operator|=
operator|-
literal|1
expr_stmt|;
name|softc
operator|->
name|vnic_info
operator|.
name|def_ring_grp
operator|=
operator|(
name|uint16_t
operator|)
name|HWRM_NA_SIGNATURE
expr_stmt|;
name|softc
operator|->
name|vnic_info
operator|.
name|cos_rule
operator|=
operator|(
name|uint16_t
operator|)
name|HWRM_NA_SIGNATURE
expr_stmt|;
name|softc
operator|->
name|vnic_info
operator|.
name|lb_rule
operator|=
operator|(
name|uint16_t
operator|)
name|HWRM_NA_SIGNATURE
expr_stmt|;
name|softc
operator|->
name|vnic_info
operator|.
name|rx_mask
operator|=
name|HWRM_CFA_L2_SET_RX_MASK_INPUT_MASK_BCAST
expr_stmt|;
name|softc
operator|->
name|vnic_info
operator|.
name|mc_list_count
operator|=
literal|0
expr_stmt|;
name|softc
operator|->
name|vnic_info
operator|.
name|flags
operator|=
name|BNXT_VNIC_FLAG_DEFAULT
expr_stmt|;
name|rc
operator|=
name|iflib_dma_alloc
argument_list|(
name|ctx
argument_list|,
name|BNXT_MAX_MC_ADDRS
operator|*
name|ETHER_ADDR_LEN
argument_list|,
operator|&
name|softc
operator|->
name|vnic_info
operator|.
name|mc_list
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|mc_list_alloc_fail
goto|;
comment|/* The VNIC RSS Hash Key */
name|rc
operator|=
name|iflib_dma_alloc
argument_list|(
name|ctx
argument_list|,
name|HW_HASH_KEY_SIZE
argument_list|,
operator|&
name|softc
operator|->
name|vnic_info
operator|.
name|rss_hash_key_tbl
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|rss_hash_alloc_fail
goto|;
name|bus_dmamap_sync
argument_list|(
name|softc
operator|->
name|vnic_info
operator|.
name|rss_hash_key_tbl
operator|.
name|idi_tag
argument_list|,
name|softc
operator|->
name|vnic_info
operator|.
name|rss_hash_key_tbl
operator|.
name|idi_map
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|softc
operator|->
name|vnic_info
operator|.
name|rss_hash_key_tbl
operator|.
name|idi_vaddr
argument_list|,
name|softc
operator|->
name|vnic_info
operator|.
name|rss_hash_key
argument_list|,
name|HW_HASH_KEY_SIZE
argument_list|)
expr_stmt|;
comment|/* Allocate the RSS tables */
name|rc
operator|=
name|iflib_dma_alloc
argument_list|(
name|ctx
argument_list|,
name|HW_HASH_INDEX_SIZE
operator|*
sizeof|sizeof
argument_list|(
name|uint16_t
argument_list|)
argument_list|,
operator|&
name|softc
operator|->
name|vnic_info
operator|.
name|rss_grp_tbl
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|rss_grp_alloc_fail
goto|;
name|bus_dmamap_sync
argument_list|(
name|softc
operator|->
name|vnic_info
operator|.
name|rss_grp_tbl
operator|.
name|idi_tag
argument_list|,
name|softc
operator|->
name|vnic_info
operator|.
name|rss_grp_tbl
operator|.
name|idi_map
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|softc
operator|->
name|vnic_info
operator|.
name|rss_grp_tbl
operator|.
name|idi_vaddr
argument_list|,
literal|0xff
argument_list|,
name|softc
operator|->
name|vnic_info
operator|.
name|rss_grp_tbl
operator|.
name|idi_size
argument_list|)
expr_stmt|;
name|softc
operator|->
name|nrxqsets
operator|=
name|nrxqsets
expr_stmt|;
return|return
name|rc
return|;
name|rss_grp_alloc_fail
label|:
name|iflib_dma_free
argument_list|(
operator|&
name|softc
operator|->
name|vnic_info
operator|.
name|rss_hash_key_tbl
argument_list|)
expr_stmt|;
name|rss_hash_alloc_fail
label|:
name|iflib_dma_free
argument_list|(
operator|&
name|softc
operator|->
name|vnic_info
operator|.
name|mc_list
argument_list|)
expr_stmt|;
name|mc_list_alloc_fail
label|:
name|iflib_dma_free
argument_list|(
operator|&
name|softc
operator|->
name|rx_stats
argument_list|)
expr_stmt|;
name|hw_stats_alloc_fail
label|:
name|free
argument_list|(
name|softc
operator|->
name|grp_info
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|grp_alloc_fail
label|:
name|free
argument_list|(
name|softc
operator|->
name|ag_rings
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|ag_alloc_fail
label|:
name|free
argument_list|(
name|softc
operator|->
name|rx_rings
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|ring_alloc_fail
label|:
name|free
argument_list|(
name|softc
operator|->
name|rx_cp_rings
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|cp_alloc_fail
label|:
return|return
name|rc
return|;
block|}
end_function

begin_comment
comment|/* Device setup and teardown */
end_comment

begin_function
specifier|static
name|int
name|bnxt_attach_pre
parameter_list|(
name|if_ctx_t
name|ctx
parameter_list|)
block|{
name|struct
name|bnxt_softc
modifier|*
name|softc
init|=
name|iflib_get_softc
argument_list|(
name|ctx
argument_list|)
decl_stmt|;
name|if_softc_ctx_t
name|scctx
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|softc
operator|->
name|ctx
operator|=
name|ctx
expr_stmt|;
name|softc
operator|->
name|dev
operator|=
name|iflib_get_dev
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
name|softc
operator|->
name|media
operator|=
name|iflib_get_media
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
name|softc
operator|->
name|scctx
operator|=
name|iflib_get_softc_ctx
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
name|softc
operator|->
name|sctx
operator|=
name|iflib_get_sctx
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
name|scctx
operator|=
name|softc
operator|->
name|scctx
expr_stmt|;
switch|switch
condition|(
name|softc
operator|->
name|sctx
operator|->
name|isc_vendor_info
operator|->
name|pvi_device_id
condition|)
block|{
case|case
name|BCM57402_NPAR
case|:
case|case
name|BCM57404_NPAR
case|:
case|case
name|BCM57406_NPAR
case|:
name|softc
operator|->
name|flags
operator||=
name|BNXT_FLAG_NPAR
expr_stmt|;
break|break;
case|case
name|BCM57304_VF
case|:
case|case
name|BCM57404_VF
case|:
name|softc
operator|->
name|flags
operator||=
name|BNXT_FLAG_VF
expr_stmt|;
break|break;
block|}
name|pci_enable_busmaster
argument_list|(
name|softc
operator|->
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|bnxt_pci_mapping
argument_list|(
name|softc
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
comment|/* HWRM setup/init */
name|BNXT_HWRM_LOCK_INIT
argument_list|(
name|softc
argument_list|,
name|device_get_nameunit
argument_list|(
name|softc
operator|->
name|dev
argument_list|)
argument_list|)
expr_stmt|;
name|rc
operator|=
name|bnxt_alloc_hwrm_dma_mem
argument_list|(
name|softc
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|dma_fail
goto|;
comment|/* Allocate the TPA start buffer */
name|softc
operator|->
name|tpa_start
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|bnxt_full_tpa_start
argument_list|)
operator|*
operator|(
name|RX_TPA_START_CMPL_AGG_ID_MASK
operator|>>
name|RX_TPA_START_CMPL_AGG_ID_SFT
operator|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|softc
operator|->
name|tpa_start
operator|==
name|NULL
condition|)
block|{
name|rc
operator|=
name|ENOMEM
expr_stmt|;
name|device_printf
argument_list|(
name|softc
operator|->
name|dev
argument_list|,
literal|"Unable to allocate space for TPA\n"
argument_list|)
expr_stmt|;
goto|goto
name|tpa_failed
goto|;
block|}
comment|/* Get firmware version and compare with driver */
name|softc
operator|->
name|ver_info
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|bnxt_ver_info
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|softc
operator|->
name|ver_info
operator|==
name|NULL
condition|)
block|{
name|rc
operator|=
name|ENOMEM
expr_stmt|;
name|device_printf
argument_list|(
name|softc
operator|->
name|dev
argument_list|,
literal|"Unable to allocate space for version info\n"
argument_list|)
expr_stmt|;
goto|goto
name|ver_alloc_fail
goto|;
block|}
comment|/* Default minimum required HWRM version */
name|softc
operator|->
name|ver_info
operator|->
name|hwrm_min_major
operator|=
literal|1
expr_stmt|;
name|softc
operator|->
name|ver_info
operator|->
name|hwrm_min_minor
operator|=
literal|2
expr_stmt|;
name|softc
operator|->
name|ver_info
operator|->
name|hwrm_min_update
operator|=
literal|2
expr_stmt|;
name|rc
operator|=
name|bnxt_hwrm_ver_get
argument_list|(
name|softc
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|device_printf
argument_list|(
name|softc
operator|->
name|dev
argument_list|,
literal|"attach: hwrm ver get failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|ver_fail
goto|;
block|}
comment|/* Get NVRAM info */
name|softc
operator|->
name|nvm_info
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|bnxt_nvram_info
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|softc
operator|->
name|nvm_info
operator|==
name|NULL
condition|)
block|{
name|rc
operator|=
name|ENOMEM
expr_stmt|;
name|device_printf
argument_list|(
name|softc
operator|->
name|dev
argument_list|,
literal|"Unable to allocate space for NVRAM info\n"
argument_list|)
expr_stmt|;
goto|goto
name|nvm_alloc_fail
goto|;
block|}
name|rc
operator|=
name|bnxt_hwrm_nvm_get_dev_info
argument_list|(
name|softc
argument_list|,
operator|&
name|softc
operator|->
name|nvm_info
operator|->
name|mfg_id
argument_list|,
operator|&
name|softc
operator|->
name|nvm_info
operator|->
name|device_id
argument_list|,
operator|&
name|softc
operator|->
name|nvm_info
operator|->
name|sector_size
argument_list|,
operator|&
name|softc
operator|->
name|nvm_info
operator|->
name|size
argument_list|,
operator|&
name|softc
operator|->
name|nvm_info
operator|->
name|reserved_size
argument_list|,
operator|&
name|softc
operator|->
name|nvm_info
operator|->
name|available_size
argument_list|)
expr_stmt|;
comment|/* Register the driver with the FW */
name|rc
operator|=
name|bnxt_hwrm_func_drv_rgtr
argument_list|(
name|softc
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|device_printf
argument_list|(
name|softc
operator|->
name|dev
argument_list|,
literal|"attach: hwrm drv rgtr failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|drv_rgtr_fail
goto|;
block|}
comment|/* Get the HW capabilities */
name|rc
operator|=
name|bnxt_hwrm_func_qcaps
argument_list|(
name|softc
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|failed
goto|;
name|iflib_set_mac
argument_list|(
name|ctx
argument_list|,
name|softc
operator|->
name|func
operator|.
name|mac_addr
argument_list|)
expr_stmt|;
comment|/* Get the queue config */
name|rc
operator|=
name|bnxt_hwrm_queue_qportcfg
argument_list|(
name|softc
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|device_printf
argument_list|(
name|softc
operator|->
name|dev
argument_list|,
literal|"attach: hwrm qportcfg failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|failed
goto|;
block|}
comment|/* Now perform a function reset */
name|rc
operator|=
name|bnxt_hwrm_func_reset
argument_list|(
name|softc
argument_list|)
expr_stmt|;
name|bnxt_clear_ids
argument_list|(
name|softc
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|failed
goto|;
comment|/* Now set up iflib sc */
name|scctx
operator|->
name|isc_tx_nsegments
operator|=
literal|31
operator|,
name|scctx
operator|->
name|isc_tx_tso_segments_max
operator|=
literal|31
expr_stmt|;
name|scctx
operator|->
name|isc_tx_tso_size_max
operator|=
name|BNXT_TSO_SIZE
expr_stmt|;
name|scctx
operator|->
name|isc_tx_tso_segsize_max
operator|=
name|BNXT_TSO_SIZE
expr_stmt|;
name|scctx
operator|->
name|isc_vectors
operator|=
name|softc
operator|->
name|func
operator|.
name|max_cp_rings
expr_stmt|;
if|if
condition|(
name|scctx
operator|->
name|isc_nrxd
index|[
literal|0
index|]
operator|<
operator|(
operator|(
name|scctx
operator|->
name|isc_nrxd
index|[
literal|1
index|]
operator|*
literal|4
operator|)
operator|+
name|scctx
operator|->
name|isc_nrxd
index|[
literal|2
index|]
operator|)
condition|)
name|device_printf
argument_list|(
name|softc
operator|->
name|dev
argument_list|,
literal|"WARNING: nrxd0 (%d) should be at least 4 * nrxd1 (%d) + nrxd2 (%d).  Driver may be unstable\n"
argument_list|,
name|scctx
operator|->
name|isc_nrxd
index|[
literal|0
index|]
argument_list|,
name|scctx
operator|->
name|isc_nrxd
index|[
literal|1
index|]
argument_list|,
name|scctx
operator|->
name|isc_nrxd
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|scctx
operator|->
name|isc_ntxd
index|[
literal|0
index|]
operator|<
name|scctx
operator|->
name|isc_ntxd
index|[
literal|1
index|]
operator|*
literal|2
condition|)
name|device_printf
argument_list|(
name|softc
operator|->
name|dev
argument_list|,
literal|"WARNING: ntxd0 (%d) should be at least 2 * ntxd1 (%d).  Driver may be unstable\n"
argument_list|,
name|scctx
operator|->
name|isc_ntxd
index|[
literal|0
index|]
argument_list|,
name|scctx
operator|->
name|isc_ntxd
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|scctx
operator|->
name|isc_txqsizes
index|[
literal|0
index|]
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|cmpl_base
argument_list|)
operator|*
name|scctx
operator|->
name|isc_ntxd
index|[
literal|0
index|]
expr_stmt|;
name|scctx
operator|->
name|isc_txqsizes
index|[
literal|1
index|]
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|tx_bd_short
argument_list|)
operator|*
name|scctx
operator|->
name|isc_ntxd
index|[
literal|1
index|]
expr_stmt|;
name|scctx
operator|->
name|isc_rxqsizes
index|[
literal|0
index|]
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|cmpl_base
argument_list|)
operator|*
name|scctx
operator|->
name|isc_nrxd
index|[
literal|0
index|]
expr_stmt|;
name|scctx
operator|->
name|isc_rxqsizes
index|[
literal|1
index|]
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|rx_prod_pkt_bd
argument_list|)
operator|*
name|scctx
operator|->
name|isc_nrxd
index|[
literal|1
index|]
expr_stmt|;
name|scctx
operator|->
name|isc_rxqsizes
index|[
literal|2
index|]
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|rx_prod_pkt_bd
argument_list|)
operator|*
name|scctx
operator|->
name|isc_nrxd
index|[
literal|2
index|]
expr_stmt|;
name|scctx
operator|->
name|isc_max_rxqsets
operator|=
name|min
argument_list|(
name|pci_msix_count
argument_list|(
name|softc
operator|->
name|dev
argument_list|)
operator|-
literal|1
argument_list|,
name|softc
operator|->
name|func
operator|.
name|max_cp_rings
operator|-
literal|1
argument_list|)
expr_stmt|;
name|scctx
operator|->
name|isc_max_rxqsets
operator|=
name|min
argument_list|(
name|scctx
operator|->
name|isc_max_rxqsets
argument_list|,
name|softc
operator|->
name|func
operator|.
name|max_rx_rings
argument_list|)
expr_stmt|;
name|scctx
operator|->
name|isc_max_txqsets
operator|=
name|min
argument_list|(
name|softc
operator|->
name|func
operator|.
name|max_rx_rings
argument_list|,
name|softc
operator|->
name|func
operator|.
name|max_cp_rings
operator|-
name|scctx
operator|->
name|isc_max_rxqsets
operator|-
literal|1
argument_list|)
expr_stmt|;
name|scctx
operator|->
name|isc_rss_table_size
operator|=
name|HW_HASH_INDEX_SIZE
expr_stmt|;
name|scctx
operator|->
name|isc_rss_table_mask
operator|=
name|scctx
operator|->
name|isc_rss_table_size
operator|-
literal|1
expr_stmt|;
comment|/* iflib will map and release this bar */
name|scctx
operator|->
name|isc_msix_bar
operator|=
name|pci_msix_table_bar
argument_list|(
name|softc
operator|->
name|dev
argument_list|)
expr_stmt|;
comment|/* Allocate the default completion ring */
name|softc
operator|->
name|def_cp_ring
operator|.
name|stats_ctx_id
operator|=
name|HWRM_NA_SIGNATURE
expr_stmt|;
name|softc
operator|->
name|def_cp_ring
operator|.
name|ring
operator|.
name|phys_id
operator|=
operator|(
name|uint16_t
operator|)
name|HWRM_NA_SIGNATURE
expr_stmt|;
name|softc
operator|->
name|def_cp_ring
operator|.
name|ring
operator|.
name|softc
operator|=
name|softc
expr_stmt|;
name|softc
operator|->
name|def_cp_ring
operator|.
name|ring
operator|.
name|id
operator|=
literal|0
expr_stmt|;
name|softc
operator|->
name|def_cp_ring
operator|.
name|ring
operator|.
name|doorbell
operator|=
name|softc
operator|->
name|def_cp_ring
operator|.
name|ring
operator|.
name|id
operator|*
literal|0x80
expr_stmt|;
name|softc
operator|->
name|def_cp_ring
operator|.
name|ring
operator|.
name|ring_size
operator|=
name|PAGE_SIZE
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|cmpl_base
argument_list|)
expr_stmt|;
name|rc
operator|=
name|iflib_dma_alloc
argument_list|(
name|ctx
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|cmpl_base
argument_list|)
operator|*
name|softc
operator|->
name|def_cp_ring
operator|.
name|ring
operator|.
name|ring_size
argument_list|,
operator|&
name|softc
operator|->
name|def_cp_ring_mem
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|softc
operator|->
name|def_cp_ring
operator|.
name|ring
operator|.
name|vaddr
operator|=
name|softc
operator|->
name|def_cp_ring_mem
operator|.
name|idi_vaddr
expr_stmt|;
name|softc
operator|->
name|def_cp_ring
operator|.
name|ring
operator|.
name|paddr
operator|=
name|softc
operator|->
name|def_cp_ring_mem
operator|.
name|idi_paddr
expr_stmt|;
name|iflib_config_gtask_init
argument_list|(
name|ctx
argument_list|,
operator|&
name|softc
operator|->
name|def_cp_task
argument_list|,
name|bnxt_def_cp_task
argument_list|,
literal|"dflt_cp"
argument_list|)
expr_stmt|;
name|rc
operator|=
name|bnxt_init_sysctl_ctx
argument_list|(
name|softc
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|init_sysctl_failed
goto|;
name|rc
operator|=
name|bnxt_create_nvram_sysctls
argument_list|(
name|softc
operator|->
name|nvm_info
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|failed
goto|;
name|arc4rand
argument_list|(
name|softc
operator|->
name|vnic_info
operator|.
name|rss_hash_key
argument_list|,
name|HW_HASH_KEY_SIZE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|softc
operator|->
name|vnic_info
operator|.
name|rss_hash_type
operator|=
name|HWRM_VNIC_RSS_CFG_INPUT_HASH_TYPE_IPV4
operator||
name|HWRM_VNIC_RSS_CFG_INPUT_HASH_TYPE_TCP_IPV4
operator||
name|HWRM_VNIC_RSS_CFG_INPUT_HASH_TYPE_UDP_IPV4
operator||
name|HWRM_VNIC_RSS_CFG_INPUT_HASH_TYPE_IPV6
operator||
name|HWRM_VNIC_RSS_CFG_INPUT_HASH_TYPE_TCP_IPV6
operator||
name|HWRM_VNIC_RSS_CFG_INPUT_HASH_TYPE_UDP_IPV6
expr_stmt|;
name|rc
operator|=
name|bnxt_create_config_sysctls_pre
argument_list|(
name|softc
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|failed
goto|;
comment|/* Initialize the vlan list */
name|SLIST_INIT
argument_list|(
operator|&
name|softc
operator|->
name|vnic_info
operator|.
name|vlan_tags
argument_list|)
expr_stmt|;
name|softc
operator|->
name|vnic_info
operator|.
name|vlan_tag_list
operator|.
name|idi_vaddr
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
name|failed
label|:
name|bnxt_free_sysctl_ctx
argument_list|(
name|softc
argument_list|)
expr_stmt|;
name|init_sysctl_failed
label|:
name|bnxt_hwrm_func_drv_unrgtr
argument_list|(
name|softc
argument_list|,
name|false
argument_list|)
expr_stmt|;
name|drv_rgtr_fail
label|:
name|free
argument_list|(
name|softc
operator|->
name|nvm_info
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|nvm_alloc_fail
label|:
name|ver_fail
label|:
name|free
argument_list|(
name|softc
operator|->
name|ver_info
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|ver_alloc_fail
label|:
name|free
argument_list|(
name|softc
operator|->
name|tpa_start
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|tpa_failed
label|:
name|bnxt_free_hwrm_dma_mem
argument_list|(
name|softc
argument_list|)
expr_stmt|;
name|dma_fail
label|:
name|BNXT_HWRM_LOCK_DESTROY
argument_list|(
name|softc
argument_list|)
expr_stmt|;
name|bnxt_pci_mapping_free
argument_list|(
name|softc
argument_list|)
expr_stmt|;
name|pci_disable_busmaster
argument_list|(
name|softc
operator|->
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bnxt_attach_post
parameter_list|(
name|if_ctx_t
name|ctx
parameter_list|)
block|{
name|struct
name|bnxt_softc
modifier|*
name|softc
init|=
name|iflib_get_softc
argument_list|(
name|ctx
argument_list|)
decl_stmt|;
name|if_t
name|ifp
init|=
name|iflib_get_ifp
argument_list|(
name|ctx
argument_list|)
decl_stmt|;
name|int
name|capabilities
decl_stmt|,
name|enabling
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|bnxt_create_config_sysctls_post
argument_list|(
name|softc
argument_list|)
expr_stmt|;
comment|/* Update link state etc... */
name|rc
operator|=
name|bnxt_probe_phy
argument_list|(
name|softc
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|failed
goto|;
comment|/* Needs to be done after probing the phy */
name|bnxt_create_ver_sysctls
argument_list|(
name|softc
argument_list|)
expr_stmt|;
name|bnxt_add_media_types
argument_list|(
name|softc
argument_list|)
expr_stmt|;
name|ifmedia_set
argument_list|(
name|softc
operator|->
name|media
argument_list|,
name|IFM_ETHER
operator||
name|IFM_AUTO
argument_list|)
expr_stmt|;
name|if_sethwassist
argument_list|(
name|ifp
argument_list|,
operator|(
name|CSUM_TCP
operator||
name|CSUM_UDP
operator||
name|CSUM_TCP_IPV6
operator||
name|CSUM_UDP_IPV6
operator||
name|CSUM_TSO
operator|)
argument_list|)
expr_stmt|;
name|capabilities
operator|=
comment|/* These are translated to hwassit bits */
name|IFCAP_TXCSUM
operator||
name|IFCAP_TXCSUM_IPV6
operator||
name|IFCAP_TSO4
operator||
name|IFCAP_TSO6
operator||
comment|/* These are checked by iflib */
name|IFCAP_LRO
operator||
name|IFCAP_VLAN_HWFILTER
operator||
comment|/* These are part of the iflib mask */
name|IFCAP_RXCSUM
operator||
name|IFCAP_RXCSUM_IPV6
operator||
name|IFCAP_VLAN_MTU
operator||
name|IFCAP_VLAN_HWTAGGING
operator||
name|IFCAP_VLAN_HWTSO
operator||
comment|/* These likely get lost... */
name|IFCAP_VLAN_HWCSUM
operator||
name|IFCAP_JUMBO_MTU
expr_stmt|;
name|if_setcapabilities
argument_list|(
name|ifp
argument_list|,
name|capabilities
argument_list|)
expr_stmt|;
name|enabling
operator|=
name|capabilities
expr_stmt|;
name|if_setcapenable
argument_list|(
name|ifp
argument_list|,
name|enabling
argument_list|)
expr_stmt|;
name|softc
operator|->
name|scctx
operator|->
name|isc_max_frame_size
operator|=
name|ifp
operator|->
name|if_mtu
operator|+
name|ETHER_HDR_LEN
operator|+
name|ETHER_CRC_LEN
expr_stmt|;
name|failed
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bnxt_detach
parameter_list|(
name|if_ctx_t
name|ctx
parameter_list|)
block|{
name|struct
name|bnxt_softc
modifier|*
name|softc
init|=
name|iflib_get_softc
argument_list|(
name|ctx
argument_list|)
decl_stmt|;
name|struct
name|bnxt_vlan_tag
modifier|*
name|tag
decl_stmt|;
name|struct
name|bnxt_vlan_tag
modifier|*
name|tmp
decl_stmt|;
name|int
name|i
decl_stmt|;
name|bnxt_do_disable_intr
argument_list|(
operator|&
name|softc
operator|->
name|def_cp_ring
argument_list|)
expr_stmt|;
name|bnxt_free_sysctl_ctx
argument_list|(
name|softc
argument_list|)
expr_stmt|;
name|bnxt_hwrm_func_reset
argument_list|(
name|softc
argument_list|)
expr_stmt|;
name|bnxt_clear_ids
argument_list|(
name|softc
argument_list|)
expr_stmt|;
name|iflib_irq_free
argument_list|(
name|ctx
argument_list|,
operator|&
name|softc
operator|->
name|def_cp_ring
operator|.
name|irq
argument_list|)
expr_stmt|;
name|iflib_config_gtask_deinit
argument_list|(
operator|&
name|softc
operator|->
name|def_cp_task
argument_list|)
expr_stmt|;
comment|/* We need to free() these here... */
for|for
control|(
name|i
operator|=
name|softc
operator|->
name|nrxqsets
operator|-
literal|1
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
block|{
name|iflib_irq_free
argument_list|(
name|ctx
argument_list|,
operator|&
name|softc
operator|->
name|rx_cp_rings
index|[
name|i
index|]
operator|.
name|irq
argument_list|)
expr_stmt|;
block|}
name|iflib_dma_free
argument_list|(
operator|&
name|softc
operator|->
name|vnic_info
operator|.
name|mc_list
argument_list|)
expr_stmt|;
name|iflib_dma_free
argument_list|(
operator|&
name|softc
operator|->
name|vnic_info
operator|.
name|rss_hash_key_tbl
argument_list|)
expr_stmt|;
name|iflib_dma_free
argument_list|(
operator|&
name|softc
operator|->
name|vnic_info
operator|.
name|rss_grp_tbl
argument_list|)
expr_stmt|;
if|if
condition|(
name|softc
operator|->
name|vnic_info
operator|.
name|vlan_tag_list
operator|.
name|idi_vaddr
condition|)
name|iflib_dma_free
argument_list|(
operator|&
name|softc
operator|->
name|vnic_info
operator|.
name|vlan_tag_list
argument_list|)
expr_stmt|;
name|SLIST_FOREACH_SAFE
argument_list|(
argument|tag
argument_list|,
argument|&softc->vnic_info.vlan_tags
argument_list|,
argument|next
argument_list|,
argument|tmp
argument_list|)
name|free
argument_list|(
name|tag
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|iflib_dma_free
argument_list|(
operator|&
name|softc
operator|->
name|def_cp_ring_mem
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|softc
operator|->
name|tpa_start
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|softc
operator|->
name|ver_info
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|softc
operator|->
name|nvm_info
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|bnxt_hwrm_func_drv_unrgtr
argument_list|(
name|softc
argument_list|,
name|false
argument_list|)
expr_stmt|;
name|bnxt_free_hwrm_dma_mem
argument_list|(
name|softc
argument_list|)
expr_stmt|;
name|BNXT_HWRM_LOCK_DESTROY
argument_list|(
name|softc
argument_list|)
expr_stmt|;
name|pci_disable_busmaster
argument_list|(
name|softc
operator|->
name|dev
argument_list|)
expr_stmt|;
name|bnxt_pci_mapping_free
argument_list|(
name|softc
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Device configuration */
end_comment

begin_function
specifier|static
name|void
name|bnxt_init
parameter_list|(
name|if_ctx_t
name|ctx
parameter_list|)
block|{
name|struct
name|bnxt_softc
modifier|*
name|softc
init|=
name|iflib_get_softc
argument_list|(
name|ctx
argument_list|)
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|rc
operator|=
name|bnxt_hwrm_func_reset
argument_list|(
name|softc
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
return|return;
name|bnxt_clear_ids
argument_list|(
name|softc
argument_list|)
expr_stmt|;
comment|/* Allocate the default completion ring */
name|softc
operator|->
name|def_cp_ring
operator|.
name|cons
operator|=
name|UINT32_MAX
expr_stmt|;
name|softc
operator|->
name|def_cp_ring
operator|.
name|v_bit
operator|=
literal|1
expr_stmt|;
name|bnxt_mark_cpr_invalid
argument_list|(
operator|&
name|softc
operator|->
name|def_cp_ring
argument_list|)
expr_stmt|;
name|rc
operator|=
name|bnxt_hwrm_ring_alloc
argument_list|(
name|softc
argument_list|,
name|HWRM_RING_ALLOC_INPUT_RING_TYPE_CMPL
argument_list|,
operator|&
name|softc
operator|->
name|def_cp_ring
operator|.
name|ring
argument_list|,
operator|(
name|uint16_t
operator|)
name|HWRM_NA_SIGNATURE
argument_list|,
name|HWRM_NA_SIGNATURE
argument_list|,
name|true
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|fail
goto|;
comment|/* And now set the default CP ring as the async CP ring */
name|rc
operator|=
name|bnxt_hwrm_func_cfg
argument_list|(
name|softc
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|fail
goto|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|softc
operator|->
name|nrxqsets
condition|;
name|i
operator|++
control|)
block|{
comment|/* Allocate the statistics context */
name|rc
operator|=
name|bnxt_hwrm_stat_ctx_alloc
argument_list|(
name|softc
argument_list|,
operator|&
name|softc
operator|->
name|rx_cp_rings
index|[
name|i
index|]
argument_list|,
name|softc
operator|->
name|rx_stats
operator|.
name|idi_paddr
operator|+
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|ctx_hw_stats
argument_list|)
operator|*
name|i
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|fail
goto|;
comment|/* Allocate the completion ring */
name|softc
operator|->
name|rx_cp_rings
index|[
name|i
index|]
operator|.
name|cons
operator|=
name|UINT32_MAX
expr_stmt|;
name|softc
operator|->
name|rx_cp_rings
index|[
name|i
index|]
operator|.
name|v_bit
operator|=
literal|1
expr_stmt|;
name|softc
operator|->
name|rx_cp_rings
index|[
name|i
index|]
operator|.
name|last_idx
operator|=
name|UINT32_MAX
expr_stmt|;
name|bnxt_mark_cpr_invalid
argument_list|(
operator|&
name|softc
operator|->
name|rx_cp_rings
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|rc
operator|=
name|bnxt_hwrm_ring_alloc
argument_list|(
name|softc
argument_list|,
name|HWRM_RING_ALLOC_INPUT_RING_TYPE_CMPL
argument_list|,
operator|&
name|softc
operator|->
name|rx_cp_rings
index|[
name|i
index|]
operator|.
name|ring
argument_list|,
operator|(
name|uint16_t
operator|)
name|HWRM_NA_SIGNATURE
argument_list|,
name|HWRM_NA_SIGNATURE
argument_list|,
name|true
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|fail
goto|;
comment|/* Allocate the RX ring */
name|rc
operator|=
name|bnxt_hwrm_ring_alloc
argument_list|(
name|softc
argument_list|,
name|HWRM_RING_ALLOC_INPUT_RING_TYPE_RX
argument_list|,
operator|&
name|softc
operator|->
name|rx_rings
index|[
name|i
index|]
argument_list|,
operator|(
name|uint16_t
operator|)
name|HWRM_NA_SIGNATURE
argument_list|,
name|HWRM_NA_SIGNATURE
argument_list|,
name|false
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|fail
goto|;
name|BNXT_RX_DB
argument_list|(
operator|&
name|softc
operator|->
name|rx_rings
index|[
name|i
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* TODO: Cumulus+ doesn't need the double doorbell */
name|BNXT_RX_DB
argument_list|(
operator|&
name|softc
operator|->
name|rx_rings
index|[
name|i
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Allocate the AG ring */
name|rc
operator|=
name|bnxt_hwrm_ring_alloc
argument_list|(
name|softc
argument_list|,
name|HWRM_RING_ALLOC_INPUT_RING_TYPE_RX
argument_list|,
operator|&
name|softc
operator|->
name|ag_rings
index|[
name|i
index|]
argument_list|,
operator|(
name|uint16_t
operator|)
name|HWRM_NA_SIGNATURE
argument_list|,
name|HWRM_NA_SIGNATURE
argument_list|,
name|false
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|fail
goto|;
name|BNXT_RX_DB
argument_list|(
operator|&
name|softc
operator|->
name|rx_rings
index|[
name|i
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* TODO: Cumulus+ doesn't need the double doorbell */
name|BNXT_RX_DB
argument_list|(
operator|&
name|softc
operator|->
name|ag_rings
index|[
name|i
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Allocate the ring group */
name|softc
operator|->
name|grp_info
index|[
name|i
index|]
operator|.
name|stats_ctx
operator|=
name|softc
operator|->
name|rx_cp_rings
index|[
name|i
index|]
operator|.
name|stats_ctx_id
expr_stmt|;
name|softc
operator|->
name|grp_info
index|[
name|i
index|]
operator|.
name|rx_ring_id
operator|=
name|softc
operator|->
name|rx_rings
index|[
name|i
index|]
operator|.
name|phys_id
expr_stmt|;
name|softc
operator|->
name|grp_info
index|[
name|i
index|]
operator|.
name|ag_ring_id
operator|=
name|softc
operator|->
name|ag_rings
index|[
name|i
index|]
operator|.
name|phys_id
expr_stmt|;
name|softc
operator|->
name|grp_info
index|[
name|i
index|]
operator|.
name|cp_ring_id
operator|=
name|softc
operator|->
name|rx_cp_rings
index|[
name|i
index|]
operator|.
name|ring
operator|.
name|phys_id
expr_stmt|;
name|rc
operator|=
name|bnxt_hwrm_ring_grp_alloc
argument_list|(
name|softc
argument_list|,
operator|&
name|softc
operator|->
name|grp_info
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|fail
goto|;
block|}
comment|/* Allocate the VNIC RSS context */
name|rc
operator|=
name|bnxt_hwrm_vnic_ctx_alloc
argument_list|(
name|softc
argument_list|,
operator|&
name|softc
operator|->
name|vnic_info
operator|.
name|rss_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|fail
goto|;
comment|/* Allocate the vnic */
name|softc
operator|->
name|vnic_info
operator|.
name|def_ring_grp
operator|=
name|softc
operator|->
name|grp_info
index|[
literal|0
index|]
operator|.
name|grp_id
expr_stmt|;
name|softc
operator|->
name|vnic_info
operator|.
name|mru
operator|=
name|softc
operator|->
name|scctx
operator|->
name|isc_max_frame_size
expr_stmt|;
name|rc
operator|=
name|bnxt_hwrm_vnic_alloc
argument_list|(
name|softc
argument_list|,
operator|&
name|softc
operator|->
name|vnic_info
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|fail
goto|;
name|rc
operator|=
name|bnxt_hwrm_vnic_cfg
argument_list|(
name|softc
argument_list|,
operator|&
name|softc
operator|->
name|vnic_info
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|fail
goto|;
name|rc
operator|=
name|bnxt_hwrm_set_filter
argument_list|(
name|softc
argument_list|,
operator|&
name|softc
operator|->
name|vnic_info
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|fail
goto|;
comment|/* Enable RSS on the VNICs */
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|j
operator|=
literal|0
init|;
name|i
operator|<
name|HW_HASH_INDEX_SIZE
condition|;
name|i
operator|++
control|)
block|{
operator|(
operator|(
name|uint16_t
operator|*
operator|)
name|softc
operator|->
name|vnic_info
operator|.
name|rss_grp_tbl
operator|.
name|idi_vaddr
operator|)
index|[
name|i
index|]
operator|=
name|htole16
argument_list|(
name|softc
operator|->
name|grp_info
index|[
name|j
index|]
operator|.
name|grp_id
argument_list|)
expr_stmt|;
if|if
condition|(
operator|++
name|j
operator|==
name|softc
operator|->
name|nrxqsets
condition|)
name|j
operator|=
literal|0
expr_stmt|;
block|}
name|rc
operator|=
name|bnxt_hwrm_rss_cfg
argument_list|(
name|softc
argument_list|,
operator|&
name|softc
operator|->
name|vnic_info
argument_list|,
name|softc
operator|->
name|vnic_info
operator|.
name|rss_hash_type
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|fail
goto|;
ifdef|#
directive|ifdef
name|notyet
comment|/* Enable LRO/TPA/GRO */
name|rc
operator|=
name|bnxt_hwrm_vnic_tpa_cfg
argument_list|(
name|softc
argument_list|,
operator|&
name|softc
operator|->
name|vnic_info
argument_list|,
operator|(
name|if_getcapenable
argument_list|(
name|iflib_get_ifp
argument_list|(
name|ctx
argument_list|)
argument_list|)
operator|&
name|IFCAP_LRO
operator|)
condition|?
name|HWRM_VNIC_TPA_CFG_INPUT_FLAGS_TPA
else|:
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|fail
goto|;
endif|#
directive|endif
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|softc
operator|->
name|ntxqsets
condition|;
name|i
operator|++
control|)
block|{
comment|/* Allocate the statistics context */
name|rc
operator|=
name|bnxt_hwrm_stat_ctx_alloc
argument_list|(
name|softc
argument_list|,
operator|&
name|softc
operator|->
name|tx_cp_rings
index|[
name|i
index|]
argument_list|,
name|softc
operator|->
name|tx_stats
operator|.
name|idi_paddr
operator|+
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|ctx_hw_stats
argument_list|)
operator|*
name|i
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|fail
goto|;
comment|/* Allocate the completion ring */
name|softc
operator|->
name|tx_cp_rings
index|[
name|i
index|]
operator|.
name|cons
operator|=
name|UINT32_MAX
expr_stmt|;
name|softc
operator|->
name|tx_cp_rings
index|[
name|i
index|]
operator|.
name|v_bit
operator|=
literal|1
expr_stmt|;
name|bnxt_mark_cpr_invalid
argument_list|(
operator|&
name|softc
operator|->
name|tx_cp_rings
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|rc
operator|=
name|bnxt_hwrm_ring_alloc
argument_list|(
name|softc
argument_list|,
name|HWRM_RING_ALLOC_INPUT_RING_TYPE_CMPL
argument_list|,
operator|&
name|softc
operator|->
name|tx_cp_rings
index|[
name|i
index|]
operator|.
name|ring
argument_list|,
operator|(
name|uint16_t
operator|)
name|HWRM_NA_SIGNATURE
argument_list|,
name|HWRM_NA_SIGNATURE
argument_list|,
name|false
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|fail
goto|;
comment|/* Allocate the TX ring */
name|rc
operator|=
name|bnxt_hwrm_ring_alloc
argument_list|(
name|softc
argument_list|,
name|HWRM_RING_ALLOC_INPUT_RING_TYPE_TX
argument_list|,
operator|&
name|softc
operator|->
name|tx_rings
index|[
name|i
index|]
argument_list|,
name|softc
operator|->
name|tx_cp_rings
index|[
name|i
index|]
operator|.
name|ring
operator|.
name|phys_id
argument_list|,
name|softc
operator|->
name|tx_cp_rings
index|[
name|i
index|]
operator|.
name|stats_ctx_id
argument_list|,
name|false
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|fail
goto|;
name|BNXT_TX_DB
argument_list|(
operator|&
name|softc
operator|->
name|tx_rings
index|[
name|i
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* TODO: Cumulus+ doesn't need the double doorbell */
name|BNXT_TX_DB
argument_list|(
operator|&
name|softc
operator|->
name|tx_rings
index|[
name|i
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|bnxt_do_enable_intr
argument_list|(
operator|&
name|softc
operator|->
name|def_cp_ring
argument_list|)
expr_stmt|;
return|return;
name|fail
label|:
name|bnxt_hwrm_func_reset
argument_list|(
name|softc
argument_list|)
expr_stmt|;
name|bnxt_clear_ids
argument_list|(
name|softc
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|bnxt_stop
parameter_list|(
name|if_ctx_t
name|ctx
parameter_list|)
block|{
name|struct
name|bnxt_softc
modifier|*
name|softc
init|=
name|iflib_get_softc
argument_list|(
name|ctx
argument_list|)
decl_stmt|;
name|bnxt_do_disable_intr
argument_list|(
operator|&
name|softc
operator|->
name|def_cp_ring
argument_list|)
expr_stmt|;
name|bnxt_hwrm_func_reset
argument_list|(
name|softc
argument_list|)
expr_stmt|;
name|bnxt_clear_ids
argument_list|(
name|softc
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|bnxt_multi_set
parameter_list|(
name|if_ctx_t
name|ctx
parameter_list|)
block|{
name|struct
name|bnxt_softc
modifier|*
name|softc
init|=
name|iflib_get_softc
argument_list|(
name|ctx
argument_list|)
decl_stmt|;
name|if_t
name|ifp
init|=
name|iflib_get_ifp
argument_list|(
name|ctx
argument_list|)
decl_stmt|;
name|uint8_t
modifier|*
name|mta
decl_stmt|;
name|int
name|cnt
decl_stmt|,
name|mcnt
decl_stmt|;
name|mcnt
operator|=
name|if_multiaddr_count
argument_list|(
name|ifp
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|mcnt
operator|>
name|BNXT_MAX_MC_ADDRS
condition|)
block|{
name|softc
operator|->
name|vnic_info
operator|.
name|rx_mask
operator||=
name|HWRM_CFA_L2_SET_RX_MASK_INPUT_MASK_ALL_MCAST
expr_stmt|;
name|bnxt_hwrm_cfa_l2_set_rx_mask
argument_list|(
name|softc
argument_list|,
operator|&
name|softc
operator|->
name|vnic_info
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|softc
operator|->
name|vnic_info
operator|.
name|rx_mask
operator|&=
operator|~
name|HWRM_CFA_L2_SET_RX_MASK_INPUT_MASK_ALL_MCAST
expr_stmt|;
name|mta
operator|=
name|softc
operator|->
name|vnic_info
operator|.
name|mc_list
operator|.
name|idi_vaddr
expr_stmt|;
name|bzero
argument_list|(
name|mta
argument_list|,
name|softc
operator|->
name|vnic_info
operator|.
name|mc_list
operator|.
name|idi_size
argument_list|)
expr_stmt|;
name|if_multiaddr_array
argument_list|(
name|ifp
argument_list|,
name|mta
argument_list|,
operator|&
name|cnt
argument_list|,
name|mcnt
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|softc
operator|->
name|vnic_info
operator|.
name|mc_list
operator|.
name|idi_tag
argument_list|,
name|softc
operator|->
name|vnic_info
operator|.
name|mc_list
operator|.
name|idi_map
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
name|softc
operator|->
name|vnic_info
operator|.
name|mc_list_count
operator|=
name|cnt
expr_stmt|;
name|softc
operator|->
name|vnic_info
operator|.
name|rx_mask
operator||=
name|HWRM_CFA_L2_SET_RX_MASK_INPUT_MASK_MCAST
expr_stmt|;
if|if
condition|(
name|bnxt_hwrm_cfa_l2_set_rx_mask
argument_list|(
name|softc
argument_list|,
operator|&
name|softc
operator|->
name|vnic_info
argument_list|)
condition|)
name|device_printf
argument_list|(
name|softc
operator|->
name|dev
argument_list|,
literal|"set_multi: rx_mask set failed\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|bnxt_mtu_set
parameter_list|(
name|if_ctx_t
name|ctx
parameter_list|,
name|uint32_t
name|mtu
parameter_list|)
block|{
name|struct
name|bnxt_softc
modifier|*
name|softc
init|=
name|iflib_get_softc
argument_list|(
name|ctx
argument_list|)
decl_stmt|;
if|if
condition|(
name|mtu
operator|>
name|BNXT_MAX_MTU
condition|)
return|return
name|EINVAL
return|;
name|softc
operator|->
name|scctx
operator|->
name|isc_max_frame_size
operator|=
name|mtu
operator|+
name|ETHER_HDR_LEN
operator|+
name|ETHER_CRC_LEN
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bnxt_media_status
parameter_list|(
name|if_ctx_t
name|ctx
parameter_list|,
name|struct
name|ifmediareq
modifier|*
name|ifmr
parameter_list|)
block|{
name|struct
name|bnxt_softc
modifier|*
name|softc
init|=
name|iflib_get_softc
argument_list|(
name|ctx
argument_list|)
decl_stmt|;
name|struct
name|bnxt_link_info
modifier|*
name|link_info
init|=
operator|&
name|softc
operator|->
name|link_info
decl_stmt|;
name|uint8_t
name|phy_type
init|=
name|get_phy_type
argument_list|(
name|softc
argument_list|)
decl_stmt|;
name|bnxt_update_link
argument_list|(
name|softc
argument_list|,
name|true
argument_list|)
expr_stmt|;
name|ifmr
operator|->
name|ifm_status
operator|=
name|IFM_AVALID
expr_stmt|;
name|ifmr
operator|->
name|ifm_active
operator|=
name|IFM_ETHER
expr_stmt|;
if|if
condition|(
name|link_info
operator|->
name|link_up
condition|)
name|ifmr
operator|->
name|ifm_status
operator||=
name|IFM_ACTIVE
expr_stmt|;
else|else
name|ifmr
operator|->
name|ifm_status
operator|&=
operator|~
name|IFM_ACTIVE
expr_stmt|;
if|if
condition|(
name|link_info
operator|->
name|duplex
operator|==
name|HWRM_PORT_PHY_QCFG_OUTPUT_DUPLEX_FULL
condition|)
name|ifmr
operator|->
name|ifm_active
operator||=
name|IFM_FDX
expr_stmt|;
else|else
name|ifmr
operator|->
name|ifm_active
operator||=
name|IFM_HDX
expr_stmt|;
switch|switch
condition|(
name|link_info
operator|->
name|link_speed
condition|)
block|{
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_LINK_SPEED_100MB
case|:
name|ifmr
operator|->
name|ifm_active
operator||=
name|IFM_100_T
expr_stmt|;
break|break;
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_LINK_SPEED_1GB
case|:
switch|switch
condition|(
name|phy_type
condition|)
block|{
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_PHY_TYPE_BASEKX
case|:
name|ifmr
operator|->
name|ifm_active
operator||=
name|IFM_1000_KX
expr_stmt|;
break|break;
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_PHY_TYPE_BASET
case|:
name|ifmr
operator|->
name|ifm_active
operator||=
name|IFM_1000_T
expr_stmt|;
break|break;
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_PHY_TYPE_SGMIIEXTPHY
case|:
name|ifmr
operator|->
name|ifm_active
operator||=
name|IFM_1000_SGMII
expr_stmt|;
break|break;
default|default:
name|ifmr
operator|->
name|ifm_active
operator||=
name|IFM_UNKNOWN
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_LINK_SPEED_2_5GB
case|:
switch|switch
condition|(
name|phy_type
condition|)
block|{
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_PHY_TYPE_BASEKX
case|:
name|ifmr
operator|->
name|ifm_active
operator||=
name|IFM_2500_KX
expr_stmt|;
break|break;
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_PHY_TYPE_BASET
case|:
name|ifmr
operator|->
name|ifm_active
operator||=
name|IFM_2500_T
expr_stmt|;
break|break;
default|default:
name|ifmr
operator|->
name|ifm_active
operator||=
name|IFM_UNKNOWN
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_LINK_SPEED_10GB
case|:
switch|switch
condition|(
name|phy_type
condition|)
block|{
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_PHY_TYPE_BASECR
case|:
name|ifmr
operator|->
name|ifm_active
operator||=
name|IFM_10G_CR1
expr_stmt|;
break|break;
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_PHY_TYPE_BASEKR4
case|:
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_PHY_TYPE_BASEKR2
case|:
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_PHY_TYPE_BASEKR
case|:
name|ifmr
operator|->
name|ifm_active
operator||=
name|IFM_10G_KR
expr_stmt|;
break|break;
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_PHY_TYPE_BASELR
case|:
name|ifmr
operator|->
name|ifm_active
operator||=
name|IFM_10G_LR
expr_stmt|;
break|break;
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_PHY_TYPE_BASESR
case|:
name|ifmr
operator|->
name|ifm_active
operator||=
name|IFM_10G_SR
expr_stmt|;
break|break;
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_PHY_TYPE_BASEKX
case|:
name|ifmr
operator|->
name|ifm_active
operator||=
name|IFM_10G_KX4
expr_stmt|;
break|break;
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_PHY_TYPE_BASET
case|:
name|ifmr
operator|->
name|ifm_active
operator||=
name|IFM_10G_T
expr_stmt|;
break|break;
default|default:
name|ifmr
operator|->
name|ifm_active
operator||=
name|IFM_UNKNOWN
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_LINK_SPEED_20GB
case|:
name|ifmr
operator|->
name|ifm_active
operator||=
name|IFM_20G_KR2
expr_stmt|;
break|break;
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_LINK_SPEED_25GB
case|:
switch|switch
condition|(
name|phy_type
condition|)
block|{
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_PHY_TYPE_BASECR
case|:
name|ifmr
operator|->
name|ifm_active
operator||=
name|IFM_25G_CR
expr_stmt|;
break|break;
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_PHY_TYPE_BASEKR4
case|:
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_PHY_TYPE_BASEKR2
case|:
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_PHY_TYPE_BASEKR
case|:
name|ifmr
operator|->
name|ifm_active
operator||=
name|IFM_25G_KR
expr_stmt|;
break|break;
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_PHY_TYPE_BASESR
case|:
name|ifmr
operator|->
name|ifm_active
operator||=
name|IFM_25G_SR
expr_stmt|;
break|break;
default|default:
name|ifmr
operator|->
name|ifm_active
operator||=
name|IFM_UNKNOWN
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_LINK_SPEED_40GB
case|:
switch|switch
condition|(
name|phy_type
condition|)
block|{
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_PHY_TYPE_BASECR
case|:
name|ifmr
operator|->
name|ifm_active
operator||=
name|IFM_40G_CR4
expr_stmt|;
break|break;
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_PHY_TYPE_BASEKR4
case|:
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_PHY_TYPE_BASEKR2
case|:
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_PHY_TYPE_BASEKR
case|:
name|ifmr
operator|->
name|ifm_active
operator||=
name|IFM_40G_KR4
expr_stmt|;
break|break;
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_PHY_TYPE_BASELR
case|:
name|ifmr
operator|->
name|ifm_active
operator||=
name|IFM_40G_LR4
expr_stmt|;
break|break;
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_PHY_TYPE_BASESR
case|:
name|ifmr
operator|->
name|ifm_active
operator||=
name|IFM_40G_SR4
expr_stmt|;
break|break;
default|default:
name|ifmr
operator|->
name|ifm_active
operator||=
name|IFM_UNKNOWN
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_LINK_SPEED_50GB
case|:
switch|switch
condition|(
name|phy_type
condition|)
block|{
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_PHY_TYPE_BASECR
case|:
name|ifmr
operator|->
name|ifm_active
operator||=
name|IFM_50G_CR2
expr_stmt|;
break|break;
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_PHY_TYPE_BASEKR4
case|:
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_PHY_TYPE_BASEKR2
case|:
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_PHY_TYPE_BASEKR
case|:
name|ifmr
operator|->
name|ifm_active
operator||=
name|IFM_50G_KR2
expr_stmt|;
break|break;
default|default:
name|ifmr
operator|->
name|ifm_active
operator||=
name|IFM_UNKNOWN
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_LINK_SPEED_100GB
case|:
switch|switch
condition|(
name|phy_type
condition|)
block|{
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_PHY_TYPE_BASECR
case|:
name|ifmr
operator|->
name|ifm_active
operator||=
name|IFM_100G_CR4
expr_stmt|;
break|break;
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_PHY_TYPE_BASEKR4
case|:
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_PHY_TYPE_BASEKR2
case|:
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_PHY_TYPE_BASEKR
case|:
name|ifmr
operator|->
name|ifm_active
operator||=
name|IFM_100G_KR4
expr_stmt|;
break|break;
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_PHY_TYPE_BASELR
case|:
name|ifmr
operator|->
name|ifm_active
operator||=
name|IFM_100G_LR4
expr_stmt|;
break|break;
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_PHY_TYPE_BASESR
case|:
name|ifmr
operator|->
name|ifm_active
operator||=
name|IFM_100G_SR4
expr_stmt|;
break|break;
default|default:
name|ifmr
operator|->
name|ifm_active
operator||=
name|IFM_UNKNOWN
expr_stmt|;
break|break;
block|}
default|default:
return|return;
block|}
if|if
condition|(
name|link_info
operator|->
name|pause
operator|==
operator|(
name|HWRM_PORT_PHY_QCFG_OUTPUT_PAUSE_TX
operator||
name|HWRM_PORT_PHY_QCFG_OUTPUT_PAUSE_RX
operator|)
condition|)
name|ifmr
operator|->
name|ifm_active
operator||=
operator|(
name|IFM_ETH_RXPAUSE
operator||
name|IFM_ETH_TXPAUSE
operator|)
expr_stmt|;
elseif|else
if|if
condition|(
name|link_info
operator|->
name|pause
operator|==
name|HWRM_PORT_PHY_QCFG_OUTPUT_PAUSE_TX
condition|)
name|ifmr
operator|->
name|ifm_active
operator||=
name|IFM_ETH_TXPAUSE
expr_stmt|;
elseif|else
if|if
condition|(
name|link_info
operator|->
name|pause
operator|==
name|HWRM_PORT_PHY_QCFG_OUTPUT_PAUSE_RX
condition|)
name|ifmr
operator|->
name|ifm_active
operator||=
name|IFM_ETH_RXPAUSE
expr_stmt|;
name|bnxt_report_link
argument_list|(
name|softc
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|bnxt_media_change
parameter_list|(
name|if_ctx_t
name|ctx
parameter_list|)
block|{
name|struct
name|bnxt_softc
modifier|*
name|softc
init|=
name|iflib_get_softc
argument_list|(
name|ctx
argument_list|)
decl_stmt|;
name|struct
name|ifmedia
modifier|*
name|ifm
init|=
name|iflib_get_media
argument_list|(
name|ctx
argument_list|)
decl_stmt|;
name|struct
name|ifmediareq
name|ifmr
decl_stmt|;
name|int
name|rc
decl_stmt|;
if|if
condition|(
name|IFM_TYPE
argument_list|(
name|ifm
operator|->
name|ifm_media
argument_list|)
operator|!=
name|IFM_ETHER
condition|)
return|return
name|EINVAL
return|;
switch|switch
condition|(
name|IFM_SUBTYPE
argument_list|(
name|ifm
operator|->
name|ifm_media
argument_list|)
condition|)
block|{
case|case
name|IFM_100_T
case|:
name|softc
operator|->
name|link_info
operator|.
name|autoneg
operator|&=
operator|~
name|BNXT_AUTONEG_SPEED
expr_stmt|;
name|softc
operator|->
name|link_info
operator|.
name|req_link_speed
operator|=
name|HWRM_PORT_PHY_CFG_INPUT_FORCE_LINK_SPEED_100MB
expr_stmt|;
break|break;
case|case
name|IFM_1000_KX
case|:
case|case
name|IFM_1000_T
case|:
case|case
name|IFM_1000_SGMII
case|:
name|softc
operator|->
name|link_info
operator|.
name|autoneg
operator|&=
operator|~
name|BNXT_AUTONEG_SPEED
expr_stmt|;
name|softc
operator|->
name|link_info
operator|.
name|req_link_speed
operator|=
name|HWRM_PORT_PHY_CFG_INPUT_FORCE_LINK_SPEED_1GB
expr_stmt|;
break|break;
case|case
name|IFM_2500_KX
case|:
case|case
name|IFM_2500_T
case|:
name|softc
operator|->
name|link_info
operator|.
name|autoneg
operator|&=
operator|~
name|BNXT_AUTONEG_SPEED
expr_stmt|;
name|softc
operator|->
name|link_info
operator|.
name|req_link_speed
operator|=
name|HWRM_PORT_PHY_CFG_INPUT_FORCE_LINK_SPEED_2_5GB
expr_stmt|;
break|break;
case|case
name|IFM_10G_CR1
case|:
case|case
name|IFM_10G_KR
case|:
case|case
name|IFM_10G_LR
case|:
case|case
name|IFM_10G_SR
case|:
case|case
name|IFM_10G_T
case|:
name|softc
operator|->
name|link_info
operator|.
name|autoneg
operator|&=
operator|~
name|BNXT_AUTONEG_SPEED
expr_stmt|;
name|softc
operator|->
name|link_info
operator|.
name|req_link_speed
operator|=
name|HWRM_PORT_PHY_CFG_INPUT_FORCE_LINK_SPEED_10GB
expr_stmt|;
break|break;
case|case
name|IFM_20G_KR2
case|:
name|softc
operator|->
name|link_info
operator|.
name|autoneg
operator|&=
operator|~
name|BNXT_AUTONEG_SPEED
expr_stmt|;
name|softc
operator|->
name|link_info
operator|.
name|req_link_speed
operator|=
name|HWRM_PORT_PHY_CFG_INPUT_FORCE_LINK_SPEED_20GB
expr_stmt|;
break|break;
case|case
name|IFM_25G_CR
case|:
case|case
name|IFM_25G_KR
case|:
case|case
name|IFM_25G_SR
case|:
name|softc
operator|->
name|link_info
operator|.
name|autoneg
operator|&=
operator|~
name|BNXT_AUTONEG_SPEED
expr_stmt|;
name|softc
operator|->
name|link_info
operator|.
name|req_link_speed
operator|=
name|HWRM_PORT_PHY_CFG_INPUT_FORCE_LINK_SPEED_25GB
expr_stmt|;
break|break;
case|case
name|IFM_40G_CR4
case|:
case|case
name|IFM_40G_KR4
case|:
case|case
name|IFM_40G_LR4
case|:
case|case
name|IFM_40G_SR4
case|:
name|softc
operator|->
name|link_info
operator|.
name|autoneg
operator|&=
operator|~
name|BNXT_AUTONEG_SPEED
expr_stmt|;
name|softc
operator|->
name|link_info
operator|.
name|req_link_speed
operator|=
name|HWRM_PORT_PHY_CFG_INPUT_FORCE_LINK_SPEED_40GB
expr_stmt|;
break|break;
case|case
name|IFM_50G_CR2
case|:
case|case
name|IFM_50G_KR2
case|:
name|softc
operator|->
name|link_info
operator|.
name|autoneg
operator|&=
operator|~
name|BNXT_AUTONEG_SPEED
expr_stmt|;
name|softc
operator|->
name|link_info
operator|.
name|req_link_speed
operator|=
name|HWRM_PORT_PHY_CFG_INPUT_FORCE_LINK_SPEED_50GB
expr_stmt|;
break|break;
case|case
name|IFM_100G_CR4
case|:
case|case
name|IFM_100G_KR4
case|:
case|case
name|IFM_100G_LR4
case|:
case|case
name|IFM_100G_SR4
case|:
name|softc
operator|->
name|link_info
operator|.
name|autoneg
operator|&=
operator|~
name|BNXT_AUTONEG_SPEED
expr_stmt|;
name|softc
operator|->
name|link_info
operator|.
name|req_link_speed
operator|=
name|HWRM_PORT_PHY_CFG_INPUT_FORCE_LINK_SPEED_100GB
expr_stmt|;
break|break;
default|default:
name|device_printf
argument_list|(
name|softc
operator|->
name|dev
argument_list|,
literal|"Unsupported media type!  Using auto\n"
argument_list|)
expr_stmt|;
comment|/* Fall-through */
case|case
name|IFM_AUTO
case|:
comment|// Auto
name|softc
operator|->
name|link_info
operator|.
name|autoneg
operator||=
name|BNXT_AUTONEG_SPEED
expr_stmt|;
break|break;
block|}
name|rc
operator|=
name|bnxt_hwrm_set_link_setting
argument_list|(
name|softc
argument_list|,
name|true
argument_list|,
name|true
argument_list|)
expr_stmt|;
name|bnxt_media_status
argument_list|(
name|softc
operator|->
name|ctx
argument_list|,
operator|&
name|ifmr
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bnxt_promisc_set
parameter_list|(
name|if_ctx_t
name|ctx
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
name|struct
name|bnxt_softc
modifier|*
name|softc
init|=
name|iflib_get_softc
argument_list|(
name|ctx
argument_list|)
decl_stmt|;
name|if_t
name|ifp
init|=
name|iflib_get_ifp
argument_list|(
name|ctx
argument_list|)
decl_stmt|;
name|int
name|rc
decl_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_ALLMULTI
operator|||
name|if_multiaddr_count
argument_list|(
name|ifp
argument_list|,
operator|-
literal|1
argument_list|)
operator|>
name|BNXT_MAX_MC_ADDRS
condition|)
name|softc
operator|->
name|vnic_info
operator|.
name|rx_mask
operator||=
name|HWRM_CFA_L2_SET_RX_MASK_INPUT_MASK_ALL_MCAST
expr_stmt|;
else|else
name|softc
operator|->
name|vnic_info
operator|.
name|rx_mask
operator|&=
operator|~
name|HWRM_CFA_L2_SET_RX_MASK_INPUT_MASK_ALL_MCAST
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_PROMISC
condition|)
name|softc
operator|->
name|vnic_info
operator|.
name|rx_mask
operator||=
name|HWRM_CFA_L2_SET_RX_MASK_INPUT_MASK_PROMISCUOUS
operator||
name|HWRM_CFA_L2_SET_RX_MASK_INPUT_MASK_ANYVLAN_NONVLAN
expr_stmt|;
else|else
name|softc
operator|->
name|vnic_info
operator|.
name|rx_mask
operator|&=
operator|~
operator|(
name|HWRM_CFA_L2_SET_RX_MASK_INPUT_MASK_PROMISCUOUS
operator||
name|HWRM_CFA_L2_SET_RX_MASK_INPUT_MASK_ANYVLAN_NONVLAN
operator|)
expr_stmt|;
name|rc
operator|=
name|bnxt_hwrm_cfa_l2_set_rx_mask
argument_list|(
name|softc
argument_list|,
operator|&
name|softc
operator|->
name|vnic_info
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|uint64_t
name|bnxt_get_counter
parameter_list|(
name|if_ctx_t
name|ctx
parameter_list|,
name|ift_counter
name|cnt
parameter_list|)
block|{
name|if_t
name|ifp
init|=
name|iflib_get_ifp
argument_list|(
name|ctx
argument_list|)
decl_stmt|;
if|if
condition|(
name|cnt
operator|<
name|IFCOUNTERS
condition|)
return|return
name|if_get_counter_default
argument_list|(
name|ifp
argument_list|,
name|cnt
argument_list|)
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bnxt_update_admin_status
parameter_list|(
name|if_ctx_t
name|ctx
parameter_list|)
block|{
comment|/* TODO: do we need to do anything here? */
return|return;
block|}
end_function

begin_function
specifier|static
name|void
specifier|inline
name|bnxt_do_enable_intr
parameter_list|(
name|struct
name|bnxt_cp_ring
modifier|*
name|cpr
parameter_list|)
block|{
if|if
condition|(
name|cpr
operator|->
name|ring
operator|.
name|phys_id
operator|!=
operator|(
name|uint16_t
operator|)
name|HWRM_NA_SIGNATURE
condition|)
block|{
comment|/* First time enabling, do not set index */
if|if
condition|(
name|cpr
operator|->
name|cons
operator|==
name|UINT32_MAX
condition|)
name|BNXT_CP_ENABLE_DB
argument_list|(
operator|&
name|cpr
operator|->
name|ring
argument_list|)
expr_stmt|;
else|else
name|BNXT_CP_IDX_ENABLE_DB
argument_list|(
operator|&
name|cpr
operator|->
name|ring
argument_list|,
name|cpr
operator|->
name|cons
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
specifier|inline
name|bnxt_do_disable_intr
parameter_list|(
name|struct
name|bnxt_cp_ring
modifier|*
name|cpr
parameter_list|)
block|{
if|if
condition|(
name|cpr
operator|->
name|ring
operator|.
name|phys_id
operator|!=
operator|(
name|uint16_t
operator|)
name|HWRM_NA_SIGNATURE
condition|)
name|BNXT_CP_DISABLE_DB
argument_list|(
operator|&
name|cpr
operator|->
name|ring
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Enable all interrupts */
end_comment

begin_function
specifier|static
name|void
name|bnxt_intr_enable
parameter_list|(
name|if_ctx_t
name|ctx
parameter_list|)
block|{
name|struct
name|bnxt_softc
modifier|*
name|softc
init|=
name|iflib_get_softc
argument_list|(
name|ctx
argument_list|)
decl_stmt|;
name|int
name|i
decl_stmt|;
name|bnxt_do_enable_intr
argument_list|(
operator|&
name|softc
operator|->
name|def_cp_ring
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|softc
operator|->
name|nrxqsets
condition|;
name|i
operator|++
control|)
name|bnxt_do_enable_intr
argument_list|(
operator|&
name|softc
operator|->
name|rx_cp_rings
index|[
name|i
index|]
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/* Enable interrupt for a single queue */
end_comment

begin_function
specifier|static
name|int
name|bnxt_queue_intr_enable
parameter_list|(
name|if_ctx_t
name|ctx
parameter_list|,
name|uint16_t
name|qid
parameter_list|)
block|{
name|struct
name|bnxt_softc
modifier|*
name|softc
init|=
name|iflib_get_softc
argument_list|(
name|ctx
argument_list|)
decl_stmt|;
name|bnxt_do_enable_intr
argument_list|(
operator|&
name|softc
operator|->
name|rx_cp_rings
index|[
name|qid
index|]
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Disable all interrupts */
end_comment

begin_function
specifier|static
name|void
name|bnxt_disable_intr
parameter_list|(
name|if_ctx_t
name|ctx
parameter_list|)
block|{
name|struct
name|bnxt_softc
modifier|*
name|softc
init|=
name|iflib_get_softc
argument_list|(
name|ctx
argument_list|)
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* 	 * NOTE: These TX interrupts should never get enabled, so don't 	 * update the index 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|softc
operator|->
name|ntxqsets
condition|;
name|i
operator|++
control|)
name|bnxt_do_disable_intr
argument_list|(
operator|&
name|softc
operator|->
name|tx_cp_rings
index|[
name|i
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|softc
operator|->
name|nrxqsets
condition|;
name|i
operator|++
control|)
name|bnxt_do_disable_intr
argument_list|(
operator|&
name|softc
operator|->
name|rx_cp_rings
index|[
name|i
index|]
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|bnxt_msix_intr_assign
parameter_list|(
name|if_ctx_t
name|ctx
parameter_list|,
name|int
name|msix
parameter_list|)
block|{
name|struct
name|bnxt_softc
modifier|*
name|softc
init|=
name|iflib_get_softc
argument_list|(
name|ctx
argument_list|)
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|int
name|i
decl_stmt|;
name|rc
operator|=
name|iflib_irq_alloc_generic
argument_list|(
name|ctx
argument_list|,
operator|&
name|softc
operator|->
name|def_cp_ring
operator|.
name|irq
argument_list|,
name|softc
operator|->
name|def_cp_ring
operator|.
name|ring
operator|.
name|id
operator|+
literal|1
argument_list|,
name|IFLIB_INTR_ADMIN
argument_list|,
name|bnxt_handle_def_cp
argument_list|,
name|softc
argument_list|,
literal|0
argument_list|,
literal|"def_cp"
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|device_printf
argument_list|(
name|iflib_get_dev
argument_list|(
name|ctx
argument_list|)
argument_list|,
literal|"Failed to register default completion ring handler\n"
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|softc
operator|->
name|scctx
operator|->
name|isc_nrxqsets
condition|;
name|i
operator|++
control|)
block|{
name|rc
operator|=
name|iflib_irq_alloc_generic
argument_list|(
name|ctx
argument_list|,
operator|&
name|softc
operator|->
name|rx_cp_rings
index|[
name|i
index|]
operator|.
name|irq
argument_list|,
name|softc
operator|->
name|rx_cp_rings
index|[
name|i
index|]
operator|.
name|ring
operator|.
name|id
operator|+
literal|1
argument_list|,
name|IFLIB_INTR_RX
argument_list|,
name|bnxt_handle_rx_cp
argument_list|,
operator|&
name|softc
operator|->
name|rx_cp_rings
index|[
name|i
index|]
argument_list|,
name|i
argument_list|,
literal|"rx_cp"
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|device_printf
argument_list|(
name|iflib_get_dev
argument_list|(
name|ctx
argument_list|)
argument_list|,
literal|"Failed to register RX completion ring handler\n"
argument_list|)
expr_stmt|;
name|i
operator|--
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|softc
operator|->
name|scctx
operator|->
name|isc_ntxqsets
condition|;
name|i
operator|++
control|)
name|iflib_softirq_alloc_generic
argument_list|(
name|ctx
argument_list|,
name|i
operator|+
literal|1
argument_list|,
name|IFLIB_INTR_TX
argument_list|,
name|NULL
argument_list|,
name|i
argument_list|,
literal|"tx_cp"
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
name|fail
label|:
for|for
control|(
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
name|iflib_irq_free
argument_list|(
name|ctx
argument_list|,
operator|&
name|softc
operator|->
name|rx_cp_rings
index|[
name|i
index|]
operator|.
name|irq
argument_list|)
expr_stmt|;
name|iflib_irq_free
argument_list|(
name|ctx
argument_list|,
operator|&
name|softc
operator|->
name|def_cp_ring
operator|.
name|irq
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_comment
comment|/*  * We're explicitly allowing duplicates here.  They will need to be  * removed as many times as they are added.  */
end_comment

begin_function
specifier|static
name|void
name|bnxt_vlan_register
parameter_list|(
name|if_ctx_t
name|ctx
parameter_list|,
name|uint16_t
name|vtag
parameter_list|)
block|{
name|struct
name|bnxt_softc
modifier|*
name|softc
init|=
name|iflib_get_softc
argument_list|(
name|ctx
argument_list|)
decl_stmt|;
name|struct
name|bnxt_vlan_tag
modifier|*
name|new_tag
decl_stmt|;
name|new_tag
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|bnxt_vlan_tag
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|new_tag
operator|==
name|NULL
condition|)
return|return;
name|new_tag
operator|->
name|tag
operator|=
name|vtag
expr_stmt|;
name|new_tag
operator|->
name|tpid
operator|=
literal|8100
expr_stmt|;
name|SLIST_INSERT_HEAD
argument_list|(
operator|&
name|softc
operator|->
name|vnic_info
operator|.
name|vlan_tags
argument_list|,
name|new_tag
argument_list|,
name|next
argument_list|)
expr_stmt|;
block|}
end_function

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_function
specifier|static
name|void
name|bnxt_vlan_unregister
parameter_list|(
name|if_ctx_t
name|ctx
parameter_list|,
name|uint16_t
name|vtag
parameter_list|)
block|{
name|struct
name|bnxt_softc
modifier|*
name|softc
init|=
name|iflib_get_softc
argument_list|(
name|ctx
argument_list|)
decl_stmt|;
name|struct
name|bnxt_vlan_tag
modifier|*
name|vlan_tag
decl_stmt|;
name|SLIST_FOREACH
argument_list|(
argument|vlan_tag
argument_list|,
argument|&softc->vnic_info.vlan_tags
argument_list|,
argument|next
argument_list|)
block|{
if|if
condition|(
name|vlan_tag
operator|->
name|tag
operator|==
name|vtag
condition|)
block|{
name|SLIST_REMOVE
argument_list|(
operator|&
name|softc
operator|->
name|vnic_info
operator|.
name|vlan_tags
argument_list|,
name|vlan_tag
argument_list|,
name|bnxt_vlan_tag
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|vlan_tag
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|bnxt_priv_ioctl
parameter_list|(
name|if_ctx_t
name|ctx
parameter_list|,
name|u_long
name|command
parameter_list|,
name|caddr_t
name|data
parameter_list|)
block|{
name|struct
name|bnxt_softc
modifier|*
name|softc
init|=
name|iflib_get_softc
argument_list|(
name|ctx
argument_list|)
decl_stmt|;
name|struct
name|ifreq
modifier|*
name|ifr
init|=
operator|(
expr|struct
name|ifreq
operator|*
operator|)
name|data
decl_stmt|;
name|struct
name|ifreq_buffer
modifier|*
name|ifbuf
init|=
operator|&
name|ifr
operator|->
name|ifr_ifru
operator|.
name|ifru_buffer
decl_stmt|;
name|struct
name|bnxt_ioctl_header
modifier|*
name|ioh
init|=
operator|(
expr|struct
name|bnxt_ioctl_header
operator|*
operator|)
operator|(
name|ifbuf
operator|->
name|buffer
operator|)
decl_stmt|;
name|int
name|rc
init|=
name|ENOTSUP
decl_stmt|;
name|struct
name|bnxt_ioctl_data
modifier|*
name|iod
init|=
name|NULL
decl_stmt|;
switch|switch
condition|(
name|command
condition|)
block|{
case|case
name|SIOCGPRIVATE_0
case|:
if|if
condition|(
operator|(
name|rc
operator|=
name|priv_check
argument_list|(
name|curthread
argument_list|,
name|PRIV_DRIVER
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|exit
goto|;
name|iod
operator|=
name|malloc
argument_list|(
name|ifbuf
operator|->
name|length
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|iod
condition|)
block|{
name|rc
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|exit
goto|;
block|}
name|copyin
argument_list|(
name|ioh
argument_list|,
name|iod
argument_list|,
name|ifbuf
operator|->
name|length
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ioh
operator|->
name|type
condition|)
block|{
case|case
name|BNXT_HWRM_NVM_FIND_DIR_ENTRY
case|:
block|{
name|struct
name|bnxt_ioctl_hwrm_nvm_find_dir_entry
modifier|*
name|find
init|=
operator|&
name|iod
operator|->
name|find
decl_stmt|;
name|rc
operator|=
name|bnxt_hwrm_nvm_find_dir_entry
argument_list|(
name|softc
argument_list|,
name|find
operator|->
name|type
argument_list|,
operator|&
name|find
operator|->
name|ordinal
argument_list|,
name|find
operator|->
name|ext
argument_list|,
operator|&
name|find
operator|->
name|index
argument_list|,
name|find
operator|->
name|use_index
argument_list|,
name|find
operator|->
name|search_opt
argument_list|,
operator|&
name|find
operator|->
name|data_length
argument_list|,
operator|&
name|find
operator|->
name|item_length
argument_list|,
operator|&
name|find
operator|->
name|fw_ver
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|iod
operator|->
name|hdr
operator|.
name|rc
operator|=
name|rc
expr_stmt|;
name|copyout
argument_list|(
operator|&
name|iod
operator|->
name|hdr
operator|.
name|rc
argument_list|,
operator|&
name|ioh
operator|->
name|rc
argument_list|,
sizeof|sizeof
argument_list|(
name|ioh
operator|->
name|rc
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|iod
operator|->
name|hdr
operator|.
name|rc
operator|=
literal|0
expr_stmt|;
name|copyout
argument_list|(
name|iod
argument_list|,
name|ioh
argument_list|,
name|ifbuf
operator|->
name|length
argument_list|)
expr_stmt|;
block|}
name|rc
operator|=
literal|0
expr_stmt|;
goto|goto
name|exit
goto|;
block|}
case|case
name|BNXT_HWRM_NVM_READ
case|:
block|{
name|struct
name|bnxt_ioctl_hwrm_nvm_read
modifier|*
name|rd
init|=
operator|&
name|iod
operator|->
name|read
decl_stmt|;
name|struct
name|iflib_dma_info
name|dma_data
decl_stmt|;
name|size_t
name|offset
decl_stmt|;
name|size_t
name|remain
decl_stmt|;
name|size_t
name|csize
decl_stmt|;
comment|/* 			 * Some HWRM versions can't read more than 0x8000 bytes 			 */
name|rc
operator|=
name|iflib_dma_alloc
argument_list|(
name|softc
operator|->
name|ctx
argument_list|,
name|min
argument_list|(
name|rd
operator|->
name|length
argument_list|,
literal|0x8000
argument_list|)
argument_list|,
operator|&
name|dma_data
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
break|break;
for|for
control|(
name|remain
operator|=
name|rd
operator|->
name|length
operator|,
name|offset
operator|=
literal|0
init|;
name|remain
operator|&&
name|offset
operator|<
name|rd
operator|->
name|length
condition|;
name|offset
operator|+=
literal|0x8000
control|)
block|{
name|csize
operator|=
name|min
argument_list|(
name|remain
argument_list|,
literal|0x8000
argument_list|)
expr_stmt|;
name|rc
operator|=
name|bnxt_hwrm_nvm_read
argument_list|(
name|softc
argument_list|,
name|rd
operator|->
name|index
argument_list|,
name|rd
operator|->
name|offset
operator|+
name|offset
argument_list|,
name|csize
argument_list|,
operator|&
name|dma_data
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|iod
operator|->
name|hdr
operator|.
name|rc
operator|=
name|rc
expr_stmt|;
name|copyout
argument_list|(
operator|&
name|iod
operator|->
name|hdr
operator|.
name|rc
argument_list|,
operator|&
name|ioh
operator|->
name|rc
argument_list|,
sizeof|sizeof
argument_list|(
name|ioh
operator|->
name|rc
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
else|else
block|{
name|copyout
argument_list|(
name|dma_data
operator|.
name|idi_vaddr
argument_list|,
name|rd
operator|->
name|data
operator|+
name|offset
argument_list|,
name|csize
argument_list|)
expr_stmt|;
name|iod
operator|->
name|hdr
operator|.
name|rc
operator|=
literal|0
expr_stmt|;
block|}
name|remain
operator|-=
name|csize
expr_stmt|;
block|}
if|if
condition|(
name|iod
operator|->
name|hdr
operator|.
name|rc
operator|==
literal|0
condition|)
name|copyout
argument_list|(
name|iod
argument_list|,
name|ioh
argument_list|,
name|ifbuf
operator|->
name|length
argument_list|)
expr_stmt|;
name|iflib_dma_free
argument_list|(
operator|&
name|dma_data
argument_list|)
expr_stmt|;
name|rc
operator|=
literal|0
expr_stmt|;
goto|goto
name|exit
goto|;
block|}
case|case
name|BNXT_HWRM_FW_RESET
case|:
block|{
name|struct
name|bnxt_ioctl_hwrm_fw_reset
modifier|*
name|rst
init|=
operator|&
name|iod
operator|->
name|reset
decl_stmt|;
name|rc
operator|=
name|bnxt_hwrm_fw_reset
argument_list|(
name|softc
argument_list|,
name|rst
operator|->
name|processor
argument_list|,
operator|&
name|rst
operator|->
name|selfreset
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|iod
operator|->
name|hdr
operator|.
name|rc
operator|=
name|rc
expr_stmt|;
name|copyout
argument_list|(
operator|&
name|iod
operator|->
name|hdr
operator|.
name|rc
argument_list|,
operator|&
name|ioh
operator|->
name|rc
argument_list|,
sizeof|sizeof
argument_list|(
name|ioh
operator|->
name|rc
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|iod
operator|->
name|hdr
operator|.
name|rc
operator|=
literal|0
expr_stmt|;
name|copyout
argument_list|(
name|iod
argument_list|,
name|ioh
argument_list|,
name|ifbuf
operator|->
name|length
argument_list|)
expr_stmt|;
block|}
name|rc
operator|=
literal|0
expr_stmt|;
goto|goto
name|exit
goto|;
block|}
case|case
name|BNXT_HWRM_FW_QSTATUS
case|:
block|{
name|struct
name|bnxt_ioctl_hwrm_fw_qstatus
modifier|*
name|qstat
init|=
operator|&
name|iod
operator|->
name|status
decl_stmt|;
name|rc
operator|=
name|bnxt_hwrm_fw_qstatus
argument_list|(
name|softc
argument_list|,
name|qstat
operator|->
name|processor
argument_list|,
operator|&
name|qstat
operator|->
name|selfreset
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|iod
operator|->
name|hdr
operator|.
name|rc
operator|=
name|rc
expr_stmt|;
name|copyout
argument_list|(
operator|&
name|iod
operator|->
name|hdr
operator|.
name|rc
argument_list|,
operator|&
name|ioh
operator|->
name|rc
argument_list|,
sizeof|sizeof
argument_list|(
name|ioh
operator|->
name|rc
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|iod
operator|->
name|hdr
operator|.
name|rc
operator|=
literal|0
expr_stmt|;
name|copyout
argument_list|(
name|iod
argument_list|,
name|ioh
argument_list|,
name|ifbuf
operator|->
name|length
argument_list|)
expr_stmt|;
block|}
name|rc
operator|=
literal|0
expr_stmt|;
goto|goto
name|exit
goto|;
block|}
case|case
name|BNXT_HWRM_NVM_WRITE
case|:
block|{
name|struct
name|bnxt_ioctl_hwrm_nvm_write
modifier|*
name|wr
init|=
operator|&
name|iod
operator|->
name|write
decl_stmt|;
name|rc
operator|=
name|bnxt_hwrm_nvm_write
argument_list|(
name|softc
argument_list|,
name|wr
operator|->
name|data
argument_list|,
name|true
argument_list|,
name|wr
operator|->
name|type
argument_list|,
name|wr
operator|->
name|ordinal
argument_list|,
name|wr
operator|->
name|ext
argument_list|,
name|wr
operator|->
name|attr
argument_list|,
name|wr
operator|->
name|option
argument_list|,
name|wr
operator|->
name|data_length
argument_list|,
name|wr
operator|->
name|keep
argument_list|,
operator|&
name|wr
operator|->
name|item_length
argument_list|,
operator|&
name|wr
operator|->
name|index
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|iod
operator|->
name|hdr
operator|.
name|rc
operator|=
name|rc
expr_stmt|;
name|copyout
argument_list|(
operator|&
name|iod
operator|->
name|hdr
operator|.
name|rc
argument_list|,
operator|&
name|ioh
operator|->
name|rc
argument_list|,
sizeof|sizeof
argument_list|(
name|ioh
operator|->
name|rc
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|iod
operator|->
name|hdr
operator|.
name|rc
operator|=
literal|0
expr_stmt|;
name|copyout
argument_list|(
name|iod
argument_list|,
name|ioh
argument_list|,
name|ifbuf
operator|->
name|length
argument_list|)
expr_stmt|;
block|}
name|rc
operator|=
literal|0
expr_stmt|;
goto|goto
name|exit
goto|;
block|}
case|case
name|BNXT_HWRM_NVM_ERASE_DIR_ENTRY
case|:
block|{
name|struct
name|bnxt_ioctl_hwrm_nvm_erase_dir_entry
modifier|*
name|erase
init|=
operator|&
name|iod
operator|->
name|erase
decl_stmt|;
name|rc
operator|=
name|bnxt_hwrm_nvm_erase_dir_entry
argument_list|(
name|softc
argument_list|,
name|erase
operator|->
name|index
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|iod
operator|->
name|hdr
operator|.
name|rc
operator|=
name|rc
expr_stmt|;
name|copyout
argument_list|(
operator|&
name|iod
operator|->
name|hdr
operator|.
name|rc
argument_list|,
operator|&
name|ioh
operator|->
name|rc
argument_list|,
sizeof|sizeof
argument_list|(
name|ioh
operator|->
name|rc
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|iod
operator|->
name|hdr
operator|.
name|rc
operator|=
literal|0
expr_stmt|;
name|copyout
argument_list|(
name|iod
argument_list|,
name|ioh
argument_list|,
name|ifbuf
operator|->
name|length
argument_list|)
expr_stmt|;
block|}
name|rc
operator|=
literal|0
expr_stmt|;
goto|goto
name|exit
goto|;
block|}
case|case
name|BNXT_HWRM_NVM_GET_DIR_INFO
case|:
block|{
name|struct
name|bnxt_ioctl_hwrm_nvm_get_dir_info
modifier|*
name|info
init|=
operator|&
name|iod
operator|->
name|dir_info
decl_stmt|;
name|rc
operator|=
name|bnxt_hwrm_nvm_get_dir_info
argument_list|(
name|softc
argument_list|,
operator|&
name|info
operator|->
name|entries
argument_list|,
operator|&
name|info
operator|->
name|entry_length
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|iod
operator|->
name|hdr
operator|.
name|rc
operator|=
name|rc
expr_stmt|;
name|copyout
argument_list|(
operator|&
name|iod
operator|->
name|hdr
operator|.
name|rc
argument_list|,
operator|&
name|ioh
operator|->
name|rc
argument_list|,
sizeof|sizeof
argument_list|(
name|ioh
operator|->
name|rc
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|iod
operator|->
name|hdr
operator|.
name|rc
operator|=
literal|0
expr_stmt|;
name|copyout
argument_list|(
name|iod
argument_list|,
name|ioh
argument_list|,
name|ifbuf
operator|->
name|length
argument_list|)
expr_stmt|;
block|}
name|rc
operator|=
literal|0
expr_stmt|;
goto|goto
name|exit
goto|;
block|}
case|case
name|BNXT_HWRM_NVM_GET_DIR_ENTRIES
case|:
block|{
name|struct
name|bnxt_ioctl_hwrm_nvm_get_dir_entries
modifier|*
name|get
init|=
operator|&
name|iod
operator|->
name|dir_entries
decl_stmt|;
name|struct
name|iflib_dma_info
name|dma_data
decl_stmt|;
name|rc
operator|=
name|iflib_dma_alloc
argument_list|(
name|softc
operator|->
name|ctx
argument_list|,
name|get
operator|->
name|max_size
argument_list|,
operator|&
name|dma_data
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
break|break;
name|rc
operator|=
name|bnxt_hwrm_nvm_get_dir_entries
argument_list|(
name|softc
argument_list|,
operator|&
name|get
operator|->
name|entries
argument_list|,
operator|&
name|get
operator|->
name|entry_length
argument_list|,
operator|&
name|dma_data
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|iod
operator|->
name|hdr
operator|.
name|rc
operator|=
name|rc
expr_stmt|;
name|copyout
argument_list|(
operator|&
name|iod
operator|->
name|hdr
operator|.
name|rc
argument_list|,
operator|&
name|ioh
operator|->
name|rc
argument_list|,
sizeof|sizeof
argument_list|(
name|ioh
operator|->
name|rc
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|copyout
argument_list|(
name|dma_data
operator|.
name|idi_vaddr
argument_list|,
name|get
operator|->
name|data
argument_list|,
name|get
operator|->
name|entry_length
operator|*
name|get
operator|->
name|entries
argument_list|)
expr_stmt|;
name|iod
operator|->
name|hdr
operator|.
name|rc
operator|=
literal|0
expr_stmt|;
name|copyout
argument_list|(
name|iod
argument_list|,
name|ioh
argument_list|,
name|ifbuf
operator|->
name|length
argument_list|)
expr_stmt|;
block|}
name|iflib_dma_free
argument_list|(
operator|&
name|dma_data
argument_list|)
expr_stmt|;
name|rc
operator|=
literal|0
expr_stmt|;
goto|goto
name|exit
goto|;
block|}
case|case
name|BNXT_HWRM_NVM_VERIFY_UPDATE
case|:
block|{
name|struct
name|bnxt_ioctl_hwrm_nvm_verify_update
modifier|*
name|vrfy
init|=
operator|&
name|iod
operator|->
name|verify
decl_stmt|;
name|rc
operator|=
name|bnxt_hwrm_nvm_verify_update
argument_list|(
name|softc
argument_list|,
name|vrfy
operator|->
name|type
argument_list|,
name|vrfy
operator|->
name|ordinal
argument_list|,
name|vrfy
operator|->
name|ext
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|iod
operator|->
name|hdr
operator|.
name|rc
operator|=
name|rc
expr_stmt|;
name|copyout
argument_list|(
operator|&
name|iod
operator|->
name|hdr
operator|.
name|rc
argument_list|,
operator|&
name|ioh
operator|->
name|rc
argument_list|,
sizeof|sizeof
argument_list|(
name|ioh
operator|->
name|rc
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|iod
operator|->
name|hdr
operator|.
name|rc
operator|=
literal|0
expr_stmt|;
name|copyout
argument_list|(
name|iod
argument_list|,
name|ioh
argument_list|,
name|ifbuf
operator|->
name|length
argument_list|)
expr_stmt|;
block|}
name|rc
operator|=
literal|0
expr_stmt|;
goto|goto
name|exit
goto|;
block|}
case|case
name|BNXT_HWRM_NVM_INSTALL_UPDATE
case|:
block|{
name|struct
name|bnxt_ioctl_hwrm_nvm_install_update
modifier|*
name|inst
init|=
operator|&
name|iod
operator|->
name|install
decl_stmt|;
name|rc
operator|=
name|bnxt_hwrm_nvm_install_update
argument_list|(
name|softc
argument_list|,
name|inst
operator|->
name|install_type
argument_list|,
operator|&
name|inst
operator|->
name|installed_items
argument_list|,
operator|&
name|inst
operator|->
name|result
argument_list|,
operator|&
name|inst
operator|->
name|problem_item
argument_list|,
operator|&
name|inst
operator|->
name|reset_required
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|iod
operator|->
name|hdr
operator|.
name|rc
operator|=
name|rc
expr_stmt|;
name|copyout
argument_list|(
operator|&
name|iod
operator|->
name|hdr
operator|.
name|rc
argument_list|,
operator|&
name|ioh
operator|->
name|rc
argument_list|,
sizeof|sizeof
argument_list|(
name|ioh
operator|->
name|rc
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|iod
operator|->
name|hdr
operator|.
name|rc
operator|=
literal|0
expr_stmt|;
name|copyout
argument_list|(
name|iod
argument_list|,
name|ioh
argument_list|,
name|ifbuf
operator|->
name|length
argument_list|)
expr_stmt|;
block|}
name|rc
operator|=
literal|0
expr_stmt|;
goto|goto
name|exit
goto|;
block|}
case|case
name|BNXT_HWRM_NVM_MODIFY
case|:
block|{
name|struct
name|bnxt_ioctl_hwrm_nvm_modify
modifier|*
name|mod
init|=
operator|&
name|iod
operator|->
name|modify
decl_stmt|;
name|rc
operator|=
name|bnxt_hwrm_nvm_modify
argument_list|(
name|softc
argument_list|,
name|mod
operator|->
name|index
argument_list|,
name|mod
operator|->
name|offset
argument_list|,
name|mod
operator|->
name|data
argument_list|,
name|true
argument_list|,
name|mod
operator|->
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|iod
operator|->
name|hdr
operator|.
name|rc
operator|=
name|rc
expr_stmt|;
name|copyout
argument_list|(
operator|&
name|iod
operator|->
name|hdr
operator|.
name|rc
argument_list|,
operator|&
name|ioh
operator|->
name|rc
argument_list|,
sizeof|sizeof
argument_list|(
name|ioh
operator|->
name|rc
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|iod
operator|->
name|hdr
operator|.
name|rc
operator|=
literal|0
expr_stmt|;
name|copyout
argument_list|(
name|iod
argument_list|,
name|ioh
argument_list|,
name|ifbuf
operator|->
name|length
argument_list|)
expr_stmt|;
block|}
name|rc
operator|=
literal|0
expr_stmt|;
goto|goto
name|exit
goto|;
block|}
case|case
name|BNXT_HWRM_FW_GET_TIME
case|:
block|{
name|struct
name|bnxt_ioctl_hwrm_fw_get_time
modifier|*
name|gtm
init|=
operator|&
name|iod
operator|->
name|get_time
decl_stmt|;
name|rc
operator|=
name|bnxt_hwrm_fw_get_time
argument_list|(
name|softc
argument_list|,
operator|&
name|gtm
operator|->
name|year
argument_list|,
operator|&
name|gtm
operator|->
name|month
argument_list|,
operator|&
name|gtm
operator|->
name|day
argument_list|,
operator|&
name|gtm
operator|->
name|hour
argument_list|,
operator|&
name|gtm
operator|->
name|minute
argument_list|,
operator|&
name|gtm
operator|->
name|second
argument_list|,
operator|&
name|gtm
operator|->
name|millisecond
argument_list|,
operator|&
name|gtm
operator|->
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|iod
operator|->
name|hdr
operator|.
name|rc
operator|=
name|rc
expr_stmt|;
name|copyout
argument_list|(
operator|&
name|iod
operator|->
name|hdr
operator|.
name|rc
argument_list|,
operator|&
name|ioh
operator|->
name|rc
argument_list|,
sizeof|sizeof
argument_list|(
name|ioh
operator|->
name|rc
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|iod
operator|->
name|hdr
operator|.
name|rc
operator|=
literal|0
expr_stmt|;
name|copyout
argument_list|(
name|iod
argument_list|,
name|ioh
argument_list|,
name|ifbuf
operator|->
name|length
argument_list|)
expr_stmt|;
block|}
name|rc
operator|=
literal|0
expr_stmt|;
goto|goto
name|exit
goto|;
block|}
case|case
name|BNXT_HWRM_FW_SET_TIME
case|:
block|{
name|struct
name|bnxt_ioctl_hwrm_fw_set_time
modifier|*
name|stm
init|=
operator|&
name|iod
operator|->
name|set_time
decl_stmt|;
name|rc
operator|=
name|bnxt_hwrm_fw_set_time
argument_list|(
name|softc
argument_list|,
name|stm
operator|->
name|year
argument_list|,
name|stm
operator|->
name|month
argument_list|,
name|stm
operator|->
name|day
argument_list|,
name|stm
operator|->
name|hour
argument_list|,
name|stm
operator|->
name|minute
argument_list|,
name|stm
operator|->
name|second
argument_list|,
name|stm
operator|->
name|millisecond
argument_list|,
name|stm
operator|->
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|iod
operator|->
name|hdr
operator|.
name|rc
operator|=
name|rc
expr_stmt|;
name|copyout
argument_list|(
operator|&
name|iod
operator|->
name|hdr
operator|.
name|rc
argument_list|,
operator|&
name|ioh
operator|->
name|rc
argument_list|,
sizeof|sizeof
argument_list|(
name|ioh
operator|->
name|rc
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|iod
operator|->
name|hdr
operator|.
name|rc
operator|=
literal|0
expr_stmt|;
name|copyout
argument_list|(
name|iod
argument_list|,
name|ioh
argument_list|,
name|ifbuf
operator|->
name|length
argument_list|)
expr_stmt|;
block|}
name|rc
operator|=
literal|0
expr_stmt|;
goto|goto
name|exit
goto|;
block|}
block|}
break|break;
block|}
name|exit
label|:
if|if
condition|(
name|iod
condition|)
name|free
argument_list|(
name|iod
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_comment
comment|/*  * Support functions  */
end_comment

begin_function
specifier|static
name|int
name|bnxt_probe_phy
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|)
block|{
name|struct
name|bnxt_link_info
modifier|*
name|link_info
init|=
operator|&
name|softc
operator|->
name|link_info
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|rc
operator|=
name|bnxt_update_link
argument_list|(
name|softc
argument_list|,
name|false
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|device_printf
argument_list|(
name|softc
operator|->
name|dev
argument_list|,
literal|"Probe phy can't update link (rc: %x)\n"
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
comment|/*initialize the ethool setting copy with NVM settings */
if|if
condition|(
name|link_info
operator|->
name|auto_mode
operator|!=
name|HWRM_PORT_PHY_QCFG_OUTPUT_AUTO_MODE_NONE
condition|)
name|link_info
operator|->
name|autoneg
operator||=
name|BNXT_AUTONEG_SPEED
expr_stmt|;
if|if
condition|(
name|link_info
operator|->
name|auto_pause
operator|&
operator|(
name|HWRM_PORT_PHY_QCFG_OUTPUT_PAUSE_TX
operator||
name|HWRM_PORT_PHY_QCFG_OUTPUT_PAUSE_RX
operator|)
condition|)
block|{
if|if
condition|(
name|link_info
operator|->
name|auto_pause
operator|==
operator|(
name|HWRM_PORT_PHY_QCFG_OUTPUT_PAUSE_TX
operator||
name|HWRM_PORT_PHY_QCFG_OUTPUT_PAUSE_RX
operator|)
condition|)
name|link_info
operator|->
name|autoneg
operator||=
name|BNXT_AUTONEG_FLOW_CTRL
expr_stmt|;
name|link_info
operator|->
name|req_flow_ctrl
operator|=
name|link_info
operator|->
name|auto_pause
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|link_info
operator|->
name|force_pause
operator|&
operator|(
name|HWRM_PORT_PHY_QCFG_OUTPUT_PAUSE_TX
operator||
name|HWRM_PORT_PHY_QCFG_OUTPUT_PAUSE_RX
operator|)
condition|)
block|{
name|link_info
operator|->
name|req_flow_ctrl
operator|=
name|link_info
operator|->
name|force_pause
expr_stmt|;
block|}
name|link_info
operator|->
name|req_duplex
operator|=
name|link_info
operator|->
name|duplex_setting
expr_stmt|;
if|if
condition|(
name|link_info
operator|->
name|autoneg
operator|&
name|BNXT_AUTONEG_SPEED
condition|)
name|link_info
operator|->
name|req_link_speed
operator|=
name|link_info
operator|->
name|auto_link_speed
expr_stmt|;
else|else
name|link_info
operator|->
name|req_link_speed
operator|=
name|link_info
operator|->
name|force_link_speed
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bnxt_add_media_types
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|)
block|{
name|struct
name|bnxt_link_info
modifier|*
name|link_info
init|=
operator|&
name|softc
operator|->
name|link_info
decl_stmt|;
name|uint16_t
name|supported
decl_stmt|;
name|uint8_t
name|phy_type
init|=
name|get_phy_type
argument_list|(
name|softc
argument_list|)
decl_stmt|;
name|supported
operator|=
name|link_info
operator|->
name|support_speeds
expr_stmt|;
comment|/* Auto is always supported */
name|ifmedia_add
argument_list|(
name|softc
operator|->
name|media
argument_list|,
name|IFM_ETHER
operator||
name|IFM_AUTO
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|softc
operator|->
name|flags
operator|&
name|BNXT_FLAG_NPAR
condition|)
return|return;
switch|switch
condition|(
name|phy_type
condition|)
block|{
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_PHY_TYPE_BASECR
case|:
if|if
condition|(
name|supported
operator|&
name|HWRM_PORT_PHY_QCFG_OUTPUT_SUPPORT_SPEEDS_100GB
condition|)
name|ifmedia_add
argument_list|(
name|softc
operator|->
name|media
argument_list|,
name|IFM_ETHER
operator||
name|IFM_100G_CR4
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|supported
operator|&
name|HWRM_PORT_PHY_QCFG_OUTPUT_SUPPORT_SPEEDS_50GB
condition|)
name|ifmedia_add
argument_list|(
name|softc
operator|->
name|media
argument_list|,
name|IFM_ETHER
operator||
name|IFM_50G_CR2
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|supported
operator|&
name|HWRM_PORT_PHY_QCFG_OUTPUT_SUPPORT_SPEEDS_40GB
condition|)
name|ifmedia_add
argument_list|(
name|softc
operator|->
name|media
argument_list|,
name|IFM_ETHER
operator||
name|IFM_40G_CR4
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|supported
operator|&
name|HWRM_PORT_PHY_QCFG_OUTPUT_SUPPORT_SPEEDS_25GB
condition|)
name|ifmedia_add
argument_list|(
name|softc
operator|->
name|media
argument_list|,
name|IFM_ETHER
operator||
name|IFM_25G_CR
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|supported
operator|&
name|HWRM_PORT_PHY_QCFG_OUTPUT_SUPPORT_SPEEDS_10GB
condition|)
name|ifmedia_add
argument_list|(
name|softc
operator|->
name|media
argument_list|,
name|IFM_ETHER
operator||
name|IFM_10G_CR1
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
break|break;
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_PHY_TYPE_UNKNOWN
case|:
comment|/* Auto only */
break|break;
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_PHY_TYPE_BASEKR4
case|:
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_PHY_TYPE_BASEKR2
case|:
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_PHY_TYPE_BASEKR
case|:
if|if
condition|(
name|supported
operator|&
name|HWRM_PORT_PHY_QCFG_OUTPUT_SUPPORT_SPEEDS_100GB
condition|)
name|ifmedia_add
argument_list|(
name|softc
operator|->
name|media
argument_list|,
name|IFM_ETHER
operator||
name|IFM_100G_KR4
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|supported
operator|&
name|HWRM_PORT_PHY_QCFG_OUTPUT_SUPPORT_SPEEDS_50GB
condition|)
name|ifmedia_add
argument_list|(
name|softc
operator|->
name|media
argument_list|,
name|IFM_ETHER
operator||
name|IFM_50G_KR2
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|supported
operator|&
name|HWRM_PORT_PHY_QCFG_OUTPUT_SUPPORT_SPEEDS_40GB
condition|)
name|ifmedia_add
argument_list|(
name|softc
operator|->
name|media
argument_list|,
name|IFM_ETHER
operator||
name|IFM_40G_KR4
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|supported
operator|&
name|HWRM_PORT_PHY_QCFG_OUTPUT_SUPPORT_SPEEDS_25GB
condition|)
name|ifmedia_add
argument_list|(
name|softc
operator|->
name|media
argument_list|,
name|IFM_ETHER
operator||
name|IFM_25G_KR
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|supported
operator|&
name|HWRM_PORT_PHY_QCFG_OUTPUT_SUPPORT_SPEEDS_20GB
condition|)
name|ifmedia_add
argument_list|(
name|softc
operator|->
name|media
argument_list|,
name|IFM_ETHER
operator||
name|IFM_20G_KR2
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|supported
operator|&
name|HWRM_PORT_PHY_QCFG_OUTPUT_SUPPORT_SPEEDS_10GB
condition|)
name|ifmedia_add
argument_list|(
name|softc
operator|->
name|media
argument_list|,
name|IFM_ETHER
operator||
name|IFM_10G_KR
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_PHY_TYPE_BASELR
case|:
if|if
condition|(
name|supported
operator|&
name|HWRM_PORT_PHY_QCFG_OUTPUT_SUPPORT_SPEEDS_100GB
condition|)
name|ifmedia_add
argument_list|(
name|softc
operator|->
name|media
argument_list|,
name|IFM_ETHER
operator||
name|IFM_100G_LR4
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|supported
operator|&
name|HWRM_PORT_PHY_QCFG_OUTPUT_SUPPORT_SPEEDS_40GB
condition|)
name|ifmedia_add
argument_list|(
name|softc
operator|->
name|media
argument_list|,
name|IFM_ETHER
operator||
name|IFM_40G_LR4
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|supported
operator|&
name|HWRM_PORT_PHY_QCFG_OUTPUT_SUPPORT_SPEEDS_10GB
condition|)
name|ifmedia_add
argument_list|(
name|softc
operator|->
name|media
argument_list|,
name|IFM_ETHER
operator||
name|IFM_10G_LR
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
break|break;
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_PHY_TYPE_BASESR
case|:
if|if
condition|(
name|supported
operator|&
name|HWRM_PORT_PHY_QCFG_OUTPUT_SUPPORT_SPEEDS_100GB
condition|)
name|ifmedia_add
argument_list|(
name|softc
operator|->
name|media
argument_list|,
name|IFM_ETHER
operator||
name|IFM_100G_SR4
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|supported
operator|&
name|HWRM_PORT_PHY_QCFG_OUTPUT_SUPPORT_SPEEDS_40GB
condition|)
name|ifmedia_add
argument_list|(
name|softc
operator|->
name|media
argument_list|,
name|IFM_ETHER
operator||
name|IFM_40G_SR4
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|supported
operator|&
name|HWRM_PORT_PHY_QCFG_OUTPUT_SUPPORT_SPEEDS_25GB
condition|)
name|ifmedia_add
argument_list|(
name|softc
operator|->
name|media
argument_list|,
name|IFM_ETHER
operator||
name|IFM_25G_SR
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|supported
operator|&
name|HWRM_PORT_PHY_QCFG_OUTPUT_SUPPORT_SPEEDS_10GB
condition|)
name|ifmedia_add
argument_list|(
name|softc
operator|->
name|media
argument_list|,
name|IFM_ETHER
operator||
name|IFM_10G_SR
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
break|break;
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_PHY_TYPE_BASEKX
case|:
if|if
condition|(
name|supported
operator|&
name|HWRM_PORT_PHY_QCFG_OUTPUT_SUPPORT_SPEEDS_10GB
condition|)
name|ifmedia_add
argument_list|(
name|softc
operator|->
name|media
argument_list|,
name|IFM_ETHER
operator||
name|IFM_10G_KX4
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|supported
operator|&
name|HWRM_PORT_PHY_QCFG_OUTPUT_SUPPORT_SPEEDS_2_5GB
condition|)
name|ifmedia_add
argument_list|(
name|softc
operator|->
name|media
argument_list|,
name|IFM_ETHER
operator||
name|IFM_2500_KX
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|supported
operator|&
name|HWRM_PORT_PHY_QCFG_OUTPUT_SUPPORT_SPEEDS_1GB
condition|)
name|ifmedia_add
argument_list|(
name|softc
operator|->
name|media
argument_list|,
name|IFM_ETHER
operator||
name|IFM_1000_KX
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
break|break;
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_PHY_TYPE_BASET
case|:
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_PHY_TYPE_BASETE
case|:
if|if
condition|(
name|supported
operator|&
name|HWRM_PORT_PHY_QCFG_OUTPUT_SUPPORT_SPEEDS_10MB
condition|)
name|ifmedia_add
argument_list|(
name|softc
operator|->
name|media
argument_list|,
name|IFM_ETHER
operator||
name|IFM_10_T
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|supported
operator|&
name|HWRM_PORT_PHY_QCFG_OUTPUT_SUPPORT_SPEEDS_100MB
condition|)
name|ifmedia_add
argument_list|(
name|softc
operator|->
name|media
argument_list|,
name|IFM_ETHER
operator||
name|IFM_100_T
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|supported
operator|&
name|HWRM_PORT_PHY_QCFG_OUTPUT_SUPPORT_SPEEDS_1GB
condition|)
name|ifmedia_add
argument_list|(
name|softc
operator|->
name|media
argument_list|,
name|IFM_ETHER
operator||
name|IFM_1000_T
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|supported
operator|&
name|HWRM_PORT_PHY_QCFG_OUTPUT_SUPPORT_SPEEDS_2_5GB
condition|)
name|ifmedia_add
argument_list|(
name|softc
operator|->
name|media
argument_list|,
name|IFM_ETHER
operator||
name|IFM_2500_T
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|supported
operator|&
name|HWRM_PORT_PHY_QCFG_OUTPUT_SUPPORT_SPEEDS_10GB
condition|)
name|ifmedia_add
argument_list|(
name|softc
operator|->
name|media
argument_list|,
name|IFM_ETHER
operator||
name|IFM_10G_T
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
break|break;
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_PHY_TYPE_SGMIIEXTPHY
case|:
if|if
condition|(
name|supported
operator|&
name|HWRM_PORT_PHY_QCFG_OUTPUT_SUPPORT_SPEEDS_1GB
condition|)
name|ifmedia_add
argument_list|(
name|softc
operator|->
name|media
argument_list|,
name|IFM_ETHER
operator||
name|IFM_1000_SGMII
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
break|break;
block|}
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|bnxt_map_bar
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|,
name|struct
name|bnxt_bar_info
modifier|*
name|bar
parameter_list|,
name|int
name|bar_num
parameter_list|,
name|bool
name|shareable
parameter_list|)
block|{
name|uint32_t
name|flag
decl_stmt|;
if|if
condition|(
name|bar
operator|->
name|res
operator|!=
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|softc
operator|->
name|dev
argument_list|,
literal|"Bar %d already mapped\n"
argument_list|,
name|bar_num
argument_list|)
expr_stmt|;
return|return
name|EDOOFUS
return|;
block|}
name|bar
operator|->
name|rid
operator|=
name|PCIR_BAR
argument_list|(
name|bar_num
argument_list|)
expr_stmt|;
name|flag
operator|=
name|RF_ACTIVE
expr_stmt|;
if|if
condition|(
name|shareable
condition|)
name|flag
operator||=
name|RF_SHAREABLE
expr_stmt|;
if|if
condition|(
operator|(
name|bar
operator|->
name|res
operator|=
name|bus_alloc_resource_any
argument_list|(
name|softc
operator|->
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
operator|&
name|bar
operator|->
name|rid
argument_list|,
name|flag
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|softc
operator|->
name|dev
argument_list|,
literal|"PCI BAR%d mapping failure\n"
argument_list|,
name|bar_num
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|bar
operator|->
name|tag
operator|=
name|rman_get_bustag
argument_list|(
name|bar
operator|->
name|res
argument_list|)
expr_stmt|;
name|bar
operator|->
name|handle
operator|=
name|rman_get_bushandle
argument_list|(
name|bar
operator|->
name|res
argument_list|)
expr_stmt|;
name|bar
operator|->
name|size
operator|=
name|rman_get_size
argument_list|(
name|bar
operator|->
name|res
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bnxt_pci_mapping
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|)
block|{
name|int
name|rc
decl_stmt|;
name|rc
operator|=
name|bnxt_map_bar
argument_list|(
name|softc
argument_list|,
operator|&
name|softc
operator|->
name|hwrm_bar
argument_list|,
literal|0
argument_list|,
name|true
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
return|return
name|rc
return|;
name|rc
operator|=
name|bnxt_map_bar
argument_list|(
name|softc
argument_list|,
operator|&
name|softc
operator|->
name|doorbell_bar
argument_list|,
literal|2
argument_list|,
name|false
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bnxt_pci_mapping_free
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|)
block|{
if|if
condition|(
name|softc
operator|->
name|hwrm_bar
operator|.
name|res
operator|!=
name|NULL
condition|)
name|bus_release_resource
argument_list|(
name|softc
operator|->
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|softc
operator|->
name|hwrm_bar
operator|.
name|rid
argument_list|,
name|softc
operator|->
name|hwrm_bar
operator|.
name|res
argument_list|)
expr_stmt|;
name|softc
operator|->
name|hwrm_bar
operator|.
name|res
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|softc
operator|->
name|doorbell_bar
operator|.
name|res
operator|!=
name|NULL
condition|)
name|bus_release_resource
argument_list|(
name|softc
operator|->
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|softc
operator|->
name|doorbell_bar
operator|.
name|rid
argument_list|,
name|softc
operator|->
name|doorbell_bar
operator|.
name|res
argument_list|)
expr_stmt|;
name|softc
operator|->
name|doorbell_bar
operator|.
name|res
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|bnxt_update_link
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|,
name|bool
name|chng_link_state
parameter_list|)
block|{
name|struct
name|bnxt_link_info
modifier|*
name|link_info
init|=
operator|&
name|softc
operator|->
name|link_info
decl_stmt|;
name|uint8_t
name|link_up
init|=
name|link_info
operator|->
name|link_up
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|rc
operator|=
name|bnxt_hwrm_port_phy_qcfg
argument_list|(
name|softc
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|exit
goto|;
comment|/* TODO: need to add more logic to report VF link */
if|if
condition|(
name|chng_link_state
condition|)
block|{
if|if
condition|(
name|link_info
operator|->
name|phy_link_status
operator|==
name|HWRM_PORT_PHY_QCFG_OUTPUT_LINK_LINK
condition|)
name|link_info
operator|->
name|link_up
operator|=
literal|1
expr_stmt|;
else|else
name|link_info
operator|->
name|link_up
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|link_up
operator|!=
name|link_info
operator|->
name|link_up
condition|)
name|bnxt_report_link
argument_list|(
name|softc
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* always link down if not require to update link state */
name|link_info
operator|->
name|link_up
operator|=
literal|0
expr_stmt|;
block|}
name|exit
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
name|void
name|bnxt_report_link
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|duplex
init|=
name|NULL
decl_stmt|,
modifier|*
name|flow_ctrl
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|softc
operator|->
name|link_info
operator|.
name|link_up
operator|==
name|softc
operator|->
name|link_info
operator|.
name|last_link_up
condition|)
block|{
if|if
condition|(
operator|!
name|softc
operator|->
name|link_info
operator|.
name|link_up
condition|)
return|return;
if|if
condition|(
name|softc
operator|->
name|link_info
operator|.
name|pause
operator|==
name|softc
operator|->
name|link_info
operator|.
name|last_pause
operator|&&
name|softc
operator|->
name|link_info
operator|.
name|duplex
operator|==
name|softc
operator|->
name|link_info
operator|.
name|last_duplex
condition|)
return|return;
block|}
if|if
condition|(
name|softc
operator|->
name|link_info
operator|.
name|link_up
condition|)
block|{
if|if
condition|(
name|softc
operator|->
name|link_info
operator|.
name|duplex
operator|==
name|HWRM_PORT_PHY_QCFG_OUTPUT_DUPLEX_FULL
condition|)
name|duplex
operator|=
literal|"full duplex"
expr_stmt|;
else|else
name|duplex
operator|=
literal|"half duplex"
expr_stmt|;
if|if
condition|(
name|softc
operator|->
name|link_info
operator|.
name|pause
operator|==
operator|(
name|HWRM_PORT_PHY_QCFG_OUTPUT_PAUSE_TX
operator||
name|HWRM_PORT_PHY_QCFG_OUTPUT_PAUSE_RX
operator|)
condition|)
name|flow_ctrl
operator|=
literal|"FC - receive& transmit"
expr_stmt|;
elseif|else
if|if
condition|(
name|softc
operator|->
name|link_info
operator|.
name|pause
operator|==
name|HWRM_PORT_PHY_QCFG_OUTPUT_PAUSE_TX
condition|)
name|flow_ctrl
operator|=
literal|"FC - transmit"
expr_stmt|;
elseif|else
if|if
condition|(
name|softc
operator|->
name|link_info
operator|.
name|pause
operator|==
name|HWRM_PORT_PHY_QCFG_OUTPUT_PAUSE_RX
condition|)
name|flow_ctrl
operator|=
literal|"FC - receive"
expr_stmt|;
else|else
name|flow_ctrl
operator|=
literal|"none"
expr_stmt|;
name|iflib_link_state_change
argument_list|(
name|softc
operator|->
name|ctx
argument_list|,
name|LINK_STATE_UP
argument_list|,
name|IF_Gbps
argument_list|(
literal|100
argument_list|)
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|softc
operator|->
name|dev
argument_list|,
literal|"Link is UP %s, %s\n"
argument_list|,
name|duplex
argument_list|,
name|flow_ctrl
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|iflib_link_state_change
argument_list|(
name|softc
operator|->
name|ctx
argument_list|,
name|LINK_STATE_DOWN
argument_list|,
name|bnxt_get_baudrate
argument_list|(
operator|&
name|softc
operator|->
name|link_info
argument_list|)
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|softc
operator|->
name|dev
argument_list|,
literal|"Link is Down\n"
argument_list|)
expr_stmt|;
block|}
name|softc
operator|->
name|link_info
operator|.
name|last_link_up
operator|=
name|softc
operator|->
name|link_info
operator|.
name|link_up
expr_stmt|;
name|softc
operator|->
name|link_info
operator|.
name|last_pause
operator|=
name|softc
operator|->
name|link_info
operator|.
name|pause
expr_stmt|;
name|softc
operator|->
name|link_info
operator|.
name|last_duplex
operator|=
name|softc
operator|->
name|link_info
operator|.
name|duplex
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|bnxt_handle_rx_cp
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|bnxt_cp_ring
modifier|*
name|cpr
init|=
name|arg
decl_stmt|;
comment|/* Disable further interrupts for this queue */
name|BNXT_CP_DISABLE_DB
argument_list|(
operator|&
name|cpr
operator|->
name|ring
argument_list|)
expr_stmt|;
return|return
name|FILTER_SCHEDULE_THREAD
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bnxt_handle_def_cp
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|bnxt_softc
modifier|*
name|softc
init|=
name|arg
decl_stmt|;
name|BNXT_CP_DISABLE_DB
argument_list|(
operator|&
name|softc
operator|->
name|def_cp_ring
operator|.
name|ring
argument_list|)
expr_stmt|;
name|GROUPTASK_ENQUEUE
argument_list|(
operator|&
name|softc
operator|->
name|def_cp_task
argument_list|)
expr_stmt|;
return|return
name|FILTER_HANDLED
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bnxt_clear_ids
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|softc
operator|->
name|def_cp_ring
operator|.
name|stats_ctx_id
operator|=
name|HWRM_NA_SIGNATURE
expr_stmt|;
name|softc
operator|->
name|def_cp_ring
operator|.
name|ring
operator|.
name|phys_id
operator|=
operator|(
name|uint16_t
operator|)
name|HWRM_NA_SIGNATURE
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|softc
operator|->
name|ntxqsets
condition|;
name|i
operator|++
control|)
block|{
name|softc
operator|->
name|tx_cp_rings
index|[
name|i
index|]
operator|.
name|stats_ctx_id
operator|=
name|HWRM_NA_SIGNATURE
expr_stmt|;
name|softc
operator|->
name|tx_cp_rings
index|[
name|i
index|]
operator|.
name|ring
operator|.
name|phys_id
operator|=
operator|(
name|uint16_t
operator|)
name|HWRM_NA_SIGNATURE
expr_stmt|;
name|softc
operator|->
name|tx_rings
index|[
name|i
index|]
operator|.
name|phys_id
operator|=
operator|(
name|uint16_t
operator|)
name|HWRM_NA_SIGNATURE
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|softc
operator|->
name|nrxqsets
condition|;
name|i
operator|++
control|)
block|{
name|softc
operator|->
name|rx_cp_rings
index|[
name|i
index|]
operator|.
name|stats_ctx_id
operator|=
name|HWRM_NA_SIGNATURE
expr_stmt|;
name|softc
operator|->
name|rx_cp_rings
index|[
name|i
index|]
operator|.
name|ring
operator|.
name|phys_id
operator|=
operator|(
name|uint16_t
operator|)
name|HWRM_NA_SIGNATURE
expr_stmt|;
name|softc
operator|->
name|rx_rings
index|[
name|i
index|]
operator|.
name|phys_id
operator|=
operator|(
name|uint16_t
operator|)
name|HWRM_NA_SIGNATURE
expr_stmt|;
name|softc
operator|->
name|ag_rings
index|[
name|i
index|]
operator|.
name|phys_id
operator|=
operator|(
name|uint16_t
operator|)
name|HWRM_NA_SIGNATURE
expr_stmt|;
name|softc
operator|->
name|grp_info
index|[
name|i
index|]
operator|.
name|grp_id
operator|=
operator|(
name|uint16_t
operator|)
name|HWRM_NA_SIGNATURE
expr_stmt|;
block|}
name|softc
operator|->
name|vnic_info
operator|.
name|filter_id
operator|=
operator|-
literal|1
expr_stmt|;
name|softc
operator|->
name|vnic_info
operator|.
name|id
operator|=
operator|(
name|uint16_t
operator|)
name|HWRM_NA_SIGNATURE
expr_stmt|;
name|softc
operator|->
name|vnic_info
operator|.
name|rss_id
operator|=
operator|(
name|uint16_t
operator|)
name|HWRM_NA_SIGNATURE
expr_stmt|;
name|memset
argument_list|(
name|softc
operator|->
name|vnic_info
operator|.
name|rss_grp_tbl
operator|.
name|idi_vaddr
argument_list|,
literal|0xff
argument_list|,
name|softc
operator|->
name|vnic_info
operator|.
name|rss_grp_tbl
operator|.
name|idi_size
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bnxt_mark_cpr_invalid
parameter_list|(
name|struct
name|bnxt_cp_ring
modifier|*
name|cpr
parameter_list|)
block|{
name|struct
name|cmpl_base
modifier|*
name|cmp
init|=
operator|(
name|void
operator|*
operator|)
name|cpr
operator|->
name|ring
operator|.
name|vaddr
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cpr
operator|->
name|ring
operator|.
name|ring_size
condition|;
name|i
operator|++
control|)
name|cmp
index|[
name|i
index|]
operator|.
name|info3_v
operator|=
operator|!
name|cpr
operator|->
name|v_bit
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bnxt_handle_async_event
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|,
name|struct
name|cmpl_base
modifier|*
name|cmpl
parameter_list|)
block|{
name|struct
name|hwrm_async_event_cmpl
modifier|*
name|ae
init|=
operator|(
name|void
operator|*
operator|)
name|cmpl
decl_stmt|;
name|uint16_t
name|async_id
init|=
name|le16toh
argument_list|(
name|ae
operator|->
name|event_id
argument_list|)
decl_stmt|;
name|struct
name|ifmediareq
name|ifmr
decl_stmt|;
switch|switch
condition|(
name|async_id
condition|)
block|{
case|case
name|HWRM_ASYNC_EVENT_CMPL_EVENT_ID_LINK_STATUS_CHANGE
case|:
case|case
name|HWRM_ASYNC_EVENT_CMPL_EVENT_ID_LINK_SPEED_CHANGE
case|:
case|case
name|HWRM_ASYNC_EVENT_CMPL_EVENT_ID_LINK_SPEED_CFG_CHANGE
case|:
name|bnxt_media_status
argument_list|(
name|softc
operator|->
name|ctx
argument_list|,
operator|&
name|ifmr
argument_list|)
expr_stmt|;
break|break;
case|case
name|HWRM_ASYNC_EVENT_CMPL_EVENT_ID_LINK_MTU_CHANGE
case|:
case|case
name|HWRM_ASYNC_EVENT_CMPL_EVENT_ID_DCB_CONFIG_CHANGE
case|:
case|case
name|HWRM_ASYNC_EVENT_CMPL_EVENT_ID_PORT_CONN_NOT_ALLOWED
case|:
case|case
name|HWRM_ASYNC_EVENT_CMPL_EVENT_ID_LINK_SPEED_CFG_NOT_ALLOWED
case|:
case|case
name|HWRM_ASYNC_EVENT_CMPL_EVENT_ID_FUNC_DRVR_UNLOAD
case|:
case|case
name|HWRM_ASYNC_EVENT_CMPL_EVENT_ID_FUNC_DRVR_LOAD
case|:
case|case
name|HWRM_ASYNC_EVENT_CMPL_EVENT_ID_PF_DRVR_UNLOAD
case|:
case|case
name|HWRM_ASYNC_EVENT_CMPL_EVENT_ID_PF_DRVR_LOAD
case|:
case|case
name|HWRM_ASYNC_EVENT_CMPL_EVENT_ID_VF_FLR
case|:
case|case
name|HWRM_ASYNC_EVENT_CMPL_EVENT_ID_VF_MAC_ADDR_CHANGE
case|:
case|case
name|HWRM_ASYNC_EVENT_CMPL_EVENT_ID_PF_VF_COMM_STATUS_CHANGE
case|:
case|case
name|HWRM_ASYNC_EVENT_CMPL_EVENT_ID_VF_CFG_CHANGE
case|:
case|case
name|HWRM_ASYNC_EVENT_CMPL_EVENT_ID_HWRM_ERROR
case|:
name|device_printf
argument_list|(
name|softc
operator|->
name|dev
argument_list|,
literal|"Unhandled async completion type %u\n"
argument_list|,
name|async_id
argument_list|)
expr_stmt|;
break|break;
default|default:
name|device_printf
argument_list|(
name|softc
operator|->
name|dev
argument_list|,
literal|"Unknown async completion type %u\n"
argument_list|,
name|async_id
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|bnxt_def_cp_task
parameter_list|(
name|void
modifier|*
name|context
parameter_list|)
block|{
name|if_ctx_t
name|ctx
init|=
name|context
decl_stmt|;
name|struct
name|bnxt_softc
modifier|*
name|softc
init|=
name|iflib_get_softc
argument_list|(
name|ctx
argument_list|)
decl_stmt|;
name|struct
name|bnxt_cp_ring
modifier|*
name|cpr
init|=
operator|&
name|softc
operator|->
name|def_cp_ring
decl_stmt|;
comment|/* Handle completions on the default completion ring */
name|struct
name|cmpl_base
modifier|*
name|cmpl
decl_stmt|;
name|uint32_t
name|cons
init|=
name|cpr
operator|->
name|cons
decl_stmt|;
name|bool
name|v_bit
init|=
name|cpr
operator|->
name|v_bit
decl_stmt|;
name|bool
name|last_v_bit
decl_stmt|;
name|uint32_t
name|last_cons
decl_stmt|;
name|uint16_t
name|type
decl_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|last_cons
operator|=
name|cons
expr_stmt|;
name|last_v_bit
operator|=
name|v_bit
expr_stmt|;
name|NEXT_CP_CONS_V
argument_list|(
operator|&
name|cpr
operator|->
name|ring
argument_list|,
name|cons
argument_list|,
name|v_bit
argument_list|)
expr_stmt|;
name|cmpl
operator|=
operator|&
operator|(
operator|(
expr|struct
name|cmpl_base
operator|*
operator|)
name|cpr
operator|->
name|ring
operator|.
name|vaddr
operator|)
index|[
name|cons
index|]
expr_stmt|;
if|if
condition|(
operator|!
name|CMP_VALID
argument_list|(
name|cmpl
argument_list|,
name|v_bit
argument_list|)
condition|)
break|break;
name|type
operator|=
name|le16toh
argument_list|(
name|cmpl
operator|->
name|type
argument_list|)
operator|&
name|CMPL_BASE_TYPE_MASK
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|CMPL_BASE_TYPE_HWRM_ASYNC_EVENT
case|:
name|bnxt_handle_async_event
argument_list|(
name|softc
argument_list|,
name|cmpl
argument_list|)
expr_stmt|;
break|break;
case|case
name|CMPL_BASE_TYPE_TX_L2
case|:
case|case
name|CMPL_BASE_TYPE_RX_L2
case|:
case|case
name|CMPL_BASE_TYPE_RX_AGG
case|:
case|case
name|CMPL_BASE_TYPE_RX_TPA_START
case|:
case|case
name|CMPL_BASE_TYPE_RX_TPA_END
case|:
case|case
name|CMPL_BASE_TYPE_STAT_EJECT
case|:
case|case
name|CMPL_BASE_TYPE_HWRM_DONE
case|:
case|case
name|CMPL_BASE_TYPE_HWRM_FWD_REQ
case|:
case|case
name|CMPL_BASE_TYPE_HWRM_FWD_RESP
case|:
case|case
name|CMPL_BASE_TYPE_CQ_NOTIFICATION
case|:
case|case
name|CMPL_BASE_TYPE_SRQ_EVENT
case|:
case|case
name|CMPL_BASE_TYPE_DBQ_EVENT
case|:
case|case
name|CMPL_BASE_TYPE_QP_EVENT
case|:
case|case
name|CMPL_BASE_TYPE_FUNC_EVENT
case|:
name|device_printf
argument_list|(
name|softc
operator|->
name|dev
argument_list|,
literal|"Unhandled completion type %u\n"
argument_list|,
name|type
argument_list|)
expr_stmt|;
break|break;
default|default:
name|device_printf
argument_list|(
name|softc
operator|->
name|dev
argument_list|,
literal|"Unknown completion type %u\n"
argument_list|,
name|type
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|cpr
operator|->
name|cons
operator|=
name|last_cons
expr_stmt|;
name|cpr
operator|->
name|v_bit
operator|=
name|last_v_bit
expr_stmt|;
name|BNXT_CP_IDX_ENABLE_DB
argument_list|(
operator|&
name|cpr
operator|->
name|ring
argument_list|,
name|cpr
operator|->
name|cons
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|get_phy_type
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|)
block|{
name|struct
name|bnxt_link_info
modifier|*
name|link_info
init|=
operator|&
name|softc
operator|->
name|link_info
decl_stmt|;
name|uint8_t
name|phy_type
init|=
name|link_info
operator|->
name|phy_type
decl_stmt|;
name|uint16_t
name|supported
decl_stmt|;
if|if
condition|(
name|phy_type
operator|!=
name|HWRM_PORT_PHY_QCFG_OUTPUT_PHY_TYPE_UNKNOWN
condition|)
return|return
name|phy_type
return|;
comment|/* Deduce the phy type from the media type and supported speeds */
name|supported
operator|=
name|link_info
operator|->
name|support_speeds
expr_stmt|;
if|if
condition|(
name|link_info
operator|->
name|media_type
operator|==
name|HWRM_PORT_PHY_QCFG_OUTPUT_MEDIA_TYPE_TP
condition|)
return|return
name|HWRM_PORT_PHY_QCFG_OUTPUT_PHY_TYPE_BASET
return|;
if|if
condition|(
name|link_info
operator|->
name|media_type
operator|==
name|HWRM_PORT_PHY_QCFG_OUTPUT_MEDIA_TYPE_DAC
condition|)
block|{
if|if
condition|(
name|supported
operator|&
name|HWRM_PORT_PHY_QCFG_OUTPUT_SUPPORT_SPEEDS_2_5GB
condition|)
return|return
name|HWRM_PORT_PHY_QCFG_OUTPUT_PHY_TYPE_BASEKX
return|;
if|if
condition|(
name|supported
operator|&
name|HWRM_PORT_PHY_QCFG_OUTPUT_SUPPORT_SPEEDS_20GB
condition|)
return|return
name|HWRM_PORT_PHY_QCFG_OUTPUT_PHY_TYPE_BASEKR
return|;
return|return
name|HWRM_PORT_PHY_QCFG_OUTPUT_PHY_TYPE_BASECR
return|;
block|}
if|if
condition|(
name|link_info
operator|->
name|media_type
operator|==
name|HWRM_PORT_PHY_QCFG_OUTPUT_MEDIA_TYPE_FIBRE
condition|)
return|return
name|HWRM_PORT_PHY_QCFG_OUTPUT_PHY_TYPE_BASESR
return|;
return|return
name|phy_type
return|;
block|}
end_function

begin_function
name|bool
name|bnxt_check_hwrm_version
parameter_list|(
name|struct
name|bnxt_softc
modifier|*
name|softc
parameter_list|)
block|{
name|char
name|buf
index|[
literal|16
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%hhu.%hhu.%hhu"
argument_list|,
name|softc
operator|->
name|ver_info
operator|->
name|hwrm_min_major
argument_list|,
name|softc
operator|->
name|ver_info
operator|->
name|hwrm_min_minor
argument_list|,
name|softc
operator|->
name|ver_info
operator|->
name|hwrm_min_update
argument_list|)
expr_stmt|;
if|if
condition|(
name|softc
operator|->
name|ver_info
operator|->
name|hwrm_min_major
operator|>
name|softc
operator|->
name|ver_info
operator|->
name|hwrm_if_major
condition|)
block|{
name|device_printf
argument_list|(
name|softc
operator|->
name|dev
argument_list|,
literal|"WARNING: HWRM version %s is too old (older than %s)\n"
argument_list|,
name|softc
operator|->
name|ver_info
operator|->
name|hwrm_if_ver
argument_list|,
name|buf
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
elseif|else
if|if
condition|(
name|softc
operator|->
name|ver_info
operator|->
name|hwrm_min_major
operator|==
name|softc
operator|->
name|ver_info
operator|->
name|hwrm_if_major
condition|)
block|{
if|if
condition|(
name|softc
operator|->
name|ver_info
operator|->
name|hwrm_min_minor
operator|>
name|softc
operator|->
name|ver_info
operator|->
name|hwrm_if_minor
condition|)
block|{
name|device_printf
argument_list|(
name|softc
operator|->
name|dev
argument_list|,
literal|"WARNING: HWRM version %s is too old (older than %s)\n"
argument_list|,
name|softc
operator|->
name|ver_info
operator|->
name|hwrm_if_ver
argument_list|,
name|buf
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
elseif|else
if|if
condition|(
name|softc
operator|->
name|ver_info
operator|->
name|hwrm_min_minor
operator|==
name|softc
operator|->
name|ver_info
operator|->
name|hwrm_if_minor
condition|)
block|{
if|if
condition|(
name|softc
operator|->
name|ver_info
operator|->
name|hwrm_min_update
operator|>
name|softc
operator|->
name|ver_info
operator|->
name|hwrm_if_update
condition|)
block|{
name|device_printf
argument_list|(
name|softc
operator|->
name|dev
argument_list|,
literal|"WARNING: HWRM version %s is too old (older than %s)\n"
argument_list|,
name|softc
operator|->
name|ver_info
operator|->
name|hwrm_if_ver
argument_list|,
name|buf
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
block|}
block|}
return|return
name|true
return|;
block|}
end_function

begin_function
specifier|static
name|uint64_t
name|bnxt_get_baudrate
parameter_list|(
name|struct
name|bnxt_link_info
modifier|*
name|link
parameter_list|)
block|{
switch|switch
condition|(
name|link
operator|->
name|link_speed
condition|)
block|{
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_LINK_SPEED_100MB
case|:
return|return
name|IF_Mbps
argument_list|(
literal|100
argument_list|)
return|;
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_LINK_SPEED_1GB
case|:
return|return
name|IF_Gbps
argument_list|(
literal|1
argument_list|)
return|;
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_LINK_SPEED_2GB
case|:
return|return
name|IF_Gbps
argument_list|(
literal|2
argument_list|)
return|;
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_LINK_SPEED_2_5GB
case|:
return|return
name|IF_Mbps
argument_list|(
literal|2500
argument_list|)
return|;
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_LINK_SPEED_10GB
case|:
return|return
name|IF_Gbps
argument_list|(
literal|10
argument_list|)
return|;
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_LINK_SPEED_20GB
case|:
return|return
name|IF_Gbps
argument_list|(
literal|20
argument_list|)
return|;
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_LINK_SPEED_25GB
case|:
return|return
name|IF_Gbps
argument_list|(
literal|25
argument_list|)
return|;
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_LINK_SPEED_40GB
case|:
return|return
name|IF_Gbps
argument_list|(
literal|40
argument_list|)
return|;
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_LINK_SPEED_50GB
case|:
return|return
name|IF_Gbps
argument_list|(
literal|50
argument_list|)
return|;
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_LINK_SPEED_100GB
case|:
return|return
name|IF_Gbps
argument_list|(
literal|100
argument_list|)
return|;
case|case
name|HWRM_PORT_PHY_QCFG_OUTPUT_LINK_SPEED_10MB
case|:
return|return
name|IF_Mbps
argument_list|(
literal|10
argument_list|)
return|;
block|}
return|return
name|IF_Gbps
argument_list|(
literal|100
argument_list|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2009-2010 Weongyo Jeong<weongyo@freebsd.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer,  *    without modification.  * 2. Redistributions in binary form must reproduce at minimum a disclaimer  *    similar to the "NO WARRANTY" disclaimer below ("Disclaimer") and any  *    redistribution must be conditioned upon including a substantially  *    similar Disclaimer requirement for further binary redistribution.  *  * NO WARRANTY  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS  * ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT  * LIMITED TO, THE IMPLIED WARRANTIES OF NONINFRINGEMENT, MERCHANTIBILITY  * AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL  * THE COPYRIGHT HOLDERS OR CONTRIBUTORS BE LIABLE FOR SPECIAL, EXEMPLARY,  * OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER  * IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF  * THE POSSIBILITY OF SUCH DAMAGES.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*  * The Broadcom Wireless LAN controller driver.  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|<sys/errno.h>
end_include

begin_include
include|#
directive|include
file|<sys/firmware.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_include
include|#
directive|include
file|<net/ethernet.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_var.h>
end_include

begin_include
include|#
directive|include
file|<net/if_arp.h>
end_include

begin_include
include|#
directive|include
file|<net/if_dl.h>
end_include

begin_include
include|#
directive|include
file|<net/if_llc.h>
end_include

begin_include
include|#
directive|include
file|<net/if_media.h>
end_include

begin_include
include|#
directive|include
file|<net/if_types.h>
end_include

begin_include
include|#
directive|include
file|<dev/pci/pcivar.h>
end_include

begin_include
include|#
directive|include
file|<dev/pci/pcireg.h>
end_include

begin_include
include|#
directive|include
file|<dev/siba/siba_ids.h>
end_include

begin_include
include|#
directive|include
file|<dev/siba/sibareg.h>
end_include

begin_include
include|#
directive|include
file|<dev/siba/sibavar.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_var.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_radiotap.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_regdomain.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_phy.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_ratectl.h>
end_include

begin_include
include|#
directive|include
file|<dev/bwn/if_bwnreg.h>
end_include

begin_include
include|#
directive|include
file|<dev/bwn/if_bwnvar.h>
end_include

begin_include
include|#
directive|include
file|<dev/bwn/if_bwn_debug.h>
end_include

begin_include
include|#
directive|include
file|<dev/bwn/if_bwn_misc.h>
end_include

begin_include
include|#
directive|include
file|<dev/bwn/if_bwn_phy_g.h>
end_include

begin_function_decl
specifier|static
name|void
name|bwn_phy_g_init_sub
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint8_t
name|bwn_has_hwpctl
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_phy_init_b5
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_phy_init_b6
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_phy_init_a
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_loopback_calcgain
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
name|bwn_rf_init_bcm2050
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_lo_g_init
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_lo_g_adjust
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_lo_get_powervector
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|bwn_lo_calib
modifier|*
name|bwn_lo_calibset
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
specifier|const
name|struct
name|bwn_bbatt
modifier|*
parameter_list|,
specifier|const
name|struct
name|bwn_rfatt
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_lo_write
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
name|struct
name|bwn_loctl
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_phy_hwpctl_init
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_phy_g_switch_chan
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
name|int
parameter_list|,
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_phy_g_set_txpwr_sub
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
specifier|const
name|struct
name|bwn_bbatt
modifier|*
parameter_list|,
specifier|const
name|struct
name|bwn_rfatt
modifier|*
parameter_list|,
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_phy_g_set_bbatt
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
name|bwn_rf_2050_rfoverval
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
name|uint16_t
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_spu_workaround
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_wa_init
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_ofdmtab_write_2
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
name|uint16_t
parameter_list|,
name|uint16_t
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_ofdmtab_write_4
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
name|uint16_t
parameter_list|,
name|uint16_t
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_gtab_write
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
name|uint16_t
parameter_list|,
name|uint16_t
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int16_t
name|bwn_nrssi_read
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_nrssi_offset
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_nrssi_threshold
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_nrssi_slope_11g
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_set_all_gains
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
name|int16_t
parameter_list|,
name|int16_t
parameter_list|,
name|int16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_set_original_gains
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_hwpctl_early_init
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_hwpctl_init_gphy
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
name|bwn_phy_g_chan2freq
parameter_list|(
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_phy_g_dc_lookup_init
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* Stuff we need */
end_comment

begin_function_decl
specifier|static
name|uint16_t
name|bwn_phy_g_txctl
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bwn_phy_shm_tssi_read
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint16_t
name|shm_offset
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_phy_g_setatt
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|int
modifier|*
name|bbattp
parameter_list|,
name|int
modifier|*
name|rfattp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_phy_lock
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_phy_unlock
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_rf_lock
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_rf_unlock
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
specifier|const
name|uint16_t
name|bwn_tab_noise_g1
index|[]
init|=
name|BWN_TAB_NOISE_G1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|uint16_t
name|bwn_tab_noise_g2
index|[]
init|=
name|BWN_TAB_NOISE_G2
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|uint16_t
name|bwn_tab_noisescale_g1
index|[]
init|=
name|BWN_TAB_NOISESCALE_G1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|uint16_t
name|bwn_tab_noisescale_g2
index|[]
init|=
name|BWN_TAB_NOISESCALE_G2
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|uint16_t
name|bwn_tab_noisescale_g3
index|[]
init|=
name|BWN_TAB_NOISESCALE_G3
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|const
name|uint8_t
name|bwn_bitrev_table
index|[
literal|256
index|]
init|=
name|BWN_BITREV_TABLE
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|uint8_t
name|bwn_has_hwpctl
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|hwpctl
operator|==
literal|0
operator|||
name|mac
operator|->
name|mac_phy
operator|.
name|use_hwpctl
operator|==
name|NULL
condition|)
return|return
operator|(
literal|0
operator|)
return|;
return|return
operator|(
name|mac
operator|->
name|mac_phy
operator|.
name|use_hwpctl
argument_list|(
name|mac
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|bwn_phy_g_attach
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwn_phy_g
modifier|*
name|pg
init|=
operator|&
name|phy
operator|->
name|phy_g
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
name|int16_t
name|pab0
decl_stmt|,
name|pab1
decl_stmt|,
name|pab2
decl_stmt|;
specifier|static
name|int8_t
name|bwn_phy_g_tssi2dbm_table
index|[]
init|=
name|BWN_PHY_G_TSSI2DBM_TABLE
decl_stmt|;
name|int8_t
name|bg
decl_stmt|;
name|bg
operator|=
operator|(
name|int8_t
operator|)
name|siba_sprom_get_tssi_bg
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
expr_stmt|;
name|pab0
operator|=
operator|(
name|int16_t
operator|)
name|siba_sprom_get_pa0b0
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
expr_stmt|;
name|pab1
operator|=
operator|(
name|int16_t
operator|)
name|siba_sprom_get_pa0b1
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
expr_stmt|;
name|pab2
operator|=
operator|(
name|int16_t
operator|)
name|siba_sprom_get_pa0b2
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|siba_get_chipid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
literal|0x4301
operator|)
operator|&&
operator|(
name|phy
operator|->
name|rf_ver
operator|!=
literal|0x2050
operator|)
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"not supported anymore\n"
argument_list|)
expr_stmt|;
name|pg
operator|->
name|pg_flags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|pab0
operator|==
literal|0
operator|||
name|pab1
operator|==
literal|0
operator|||
name|pab2
operator|==
literal|0
operator|||
name|pab0
operator|==
operator|-
literal|1
operator|||
name|pab1
operator|==
operator|-
literal|1
operator|||
name|pab2
operator|==
operator|-
literal|1
condition|)
block|{
name|pg
operator|->
name|pg_idletssi
operator|=
literal|52
expr_stmt|;
name|pg
operator|->
name|pg_tssi2dbm
operator|=
name|bwn_phy_g_tssi2dbm_table
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|pg
operator|->
name|pg_idletssi
operator|=
operator|(
name|bg
operator|==
literal|0
operator|||
name|bg
operator|==
operator|-
literal|1
operator|)
condition|?
literal|62
else|:
name|bg
expr_stmt|;
name|pg
operator|->
name|pg_tssi2dbm
operator|=
operator|(
name|uint8_t
operator|*
operator|)
name|malloc
argument_list|(
literal|64
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|pg
operator|->
name|pg_tssi2dbm
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"failed to allocate buffer\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|64
condition|;
name|i
operator|++
control|)
block|{
name|int32_t
name|m1
decl_stmt|,
name|m2
decl_stmt|,
name|f
decl_stmt|,
name|q
decl_stmt|,
name|delta
decl_stmt|;
name|int8_t
name|j
init|=
literal|0
decl_stmt|;
name|m1
operator|=
name|BWN_TSSI2DBM
argument_list|(
literal|16
operator|*
name|pab0
operator|+
name|i
operator|*
name|pab1
argument_list|,
literal|32
argument_list|)
expr_stmt|;
name|m2
operator|=
name|MAX
argument_list|(
name|BWN_TSSI2DBM
argument_list|(
literal|32768
operator|+
name|i
operator|*
name|pab2
argument_list|,
literal|256
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|f
operator|=
literal|256
expr_stmt|;
do|do
block|{
if|if
condition|(
name|j
operator|>
literal|15
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"failed to generate tssi2dBm\n"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|pg
operator|->
name|pg_tssi2dbm
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
name|q
operator|=
name|BWN_TSSI2DBM
argument_list|(
name|f
operator|*
literal|4096
operator|-
name|BWN_TSSI2DBM
argument_list|(
name|m2
operator|*
name|f
argument_list|,
literal|16
argument_list|)
operator|*
name|f
argument_list|,
literal|2048
argument_list|)
expr_stmt|;
name|delta
operator|=
name|abs
argument_list|(
name|q
operator|-
name|f
argument_list|)
expr_stmt|;
name|f
operator|=
name|q
expr_stmt|;
name|j
operator|++
expr_stmt|;
block|}
do|while
condition|(
name|delta
operator|>=
literal|2
condition|)
do|;
name|pg
operator|->
name|pg_tssi2dbm
index|[
name|i
index|]
operator|=
name|MIN
argument_list|(
name|MAX
argument_list|(
name|BWN_TSSI2DBM
argument_list|(
name|m1
operator|*
name|f
argument_list|,
literal|8192
argument_list|)
argument_list|,
operator|-
literal|127
argument_list|)
argument_list|,
literal|128
argument_list|)
expr_stmt|;
block|}
name|pg
operator|->
name|pg_flags
operator||=
name|BWN_PHY_G_FLAG_TSSITABLE_ALLOC
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|void
name|bwn_phy_g_detach
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_phy_g
modifier|*
name|pg
init|=
operator|&
name|mac
operator|->
name|mac_phy
operator|.
name|phy_g
decl_stmt|;
if|if
condition|(
name|pg
operator|->
name|pg_flags
operator|&
name|BWN_PHY_G_FLAG_TSSITABLE_ALLOC
condition|)
block|{
name|free
argument_list|(
name|pg
operator|->
name|pg_tssi2dbm
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|pg
operator|->
name|pg_tssi2dbm
operator|=
name|NULL
expr_stmt|;
block|}
name|pg
operator|->
name|pg_flags
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
name|void
name|bwn_phy_g_init_pre
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwn_phy_g
modifier|*
name|pg
init|=
operator|&
name|phy
operator|->
name|phy_g
decl_stmt|;
name|void
modifier|*
name|tssi2dbm
decl_stmt|;
name|int
name|idletssi
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
name|tssi2dbm
operator|=
name|pg
operator|->
name|pg_tssi2dbm
expr_stmt|;
name|idletssi
operator|=
name|pg
operator|->
name|pg_idletssi
expr_stmt|;
name|memset
argument_list|(
name|pg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|pg
argument_list|)
argument_list|)
expr_stmt|;
name|pg
operator|->
name|pg_tssi2dbm
operator|=
name|tssi2dbm
expr_stmt|;
name|pg
operator|->
name|pg_idletssi
operator|=
name|idletssi
expr_stmt|;
name|memset
argument_list|(
name|pg
operator|->
name|pg_minlowsig
argument_list|,
literal|0xff
argument_list|,
sizeof|sizeof
argument_list|(
name|pg
operator|->
name|pg_minlowsig
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|N
argument_list|(
name|pg
operator|->
name|pg_nrssi
argument_list|)
condition|;
name|i
operator|++
control|)
name|pg
operator|->
name|pg_nrssi
index|[
name|i
index|]
operator|=
operator|-
literal|1000
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|N
argument_list|(
name|pg
operator|->
name|pg_nrssi_lt
argument_list|)
condition|;
name|i
operator|++
control|)
name|pg
operator|->
name|pg_nrssi_lt
index|[
name|i
index|]
operator|=
name|i
expr_stmt|;
name|pg
operator|->
name|pg_lofcal
operator|=
literal|0xffff
expr_stmt|;
name|pg
operator|->
name|pg_initval
operator|=
literal|0xffff
expr_stmt|;
name|pg
operator|->
name|pg_immode
operator|=
name|BWN_IMMODE_NONE
expr_stmt|;
name|pg
operator|->
name|pg_ofdmtab_dir
operator|=
name|BWN_OFDMTAB_DIR_UNKNOWN
expr_stmt|;
name|pg
operator|->
name|pg_avgtssi
operator|=
literal|0xff
expr_stmt|;
name|pg
operator|->
name|pg_loctl
operator|.
name|tx_bias
operator|=
literal|0xff
expr_stmt|;
name|TAILQ_INIT
argument_list|(
operator|&
name|pg
operator|->
name|pg_loctl
operator|.
name|calib_list
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|bwn_phy_g_prepare_hw
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwn_phy_g
modifier|*
name|pg
init|=
operator|&
name|phy
operator|->
name|phy_g
decl_stmt|;
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|struct
name|bwn_txpwr_loctl
modifier|*
name|lo
init|=
operator|&
name|pg
operator|->
name|pg_loctl
decl_stmt|;
specifier|static
specifier|const
name|struct
name|bwn_rfatt
name|rfatt0
index|[]
init|=
block|{
block|{
literal|3
block|,
literal|0
block|}
block|,
block|{
literal|1
block|,
literal|0
block|}
block|,
block|{
literal|5
block|,
literal|0
block|}
block|,
block|{
literal|7
block|,
literal|0
block|}
block|,
block|{
literal|9
block|,
literal|0
block|}
block|,
block|{
literal|2
block|,
literal|0
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|4
block|,
literal|0
block|}
block|,
block|{
literal|6
block|,
literal|0
block|}
block|,
block|{
literal|8
block|,
literal|0
block|}
block|,
block|{
literal|1
block|,
literal|1
block|}
block|,
block|{
literal|2
block|,
literal|1
block|}
block|,
block|{
literal|3
block|,
literal|1
block|}
block|,
block|{
literal|4
block|,
literal|1
block|}
block|}
decl_stmt|;
specifier|static
specifier|const
name|struct
name|bwn_rfatt
name|rfatt1
index|[]
init|=
block|{
block|{
literal|2
block|,
literal|1
block|}
block|,
block|{
literal|4
block|,
literal|1
block|}
block|,
block|{
literal|6
block|,
literal|1
block|}
block|,
block|{
literal|8
block|,
literal|1
block|}
block|,
block|{
literal|10
block|,
literal|1
block|}
block|,
block|{
literal|12
block|,
literal|1
block|}
block|,
block|{
literal|14
block|,
literal|1
block|}
block|}
decl_stmt|;
specifier|static
specifier|const
name|struct
name|bwn_rfatt
name|rfatt2
index|[]
init|=
block|{
block|{
literal|0
block|,
literal|1
block|}
block|,
block|{
literal|2
block|,
literal|1
block|}
block|,
block|{
literal|4
block|,
literal|1
block|}
block|,
block|{
literal|6
block|,
literal|1
block|}
block|,
block|{
literal|8
block|,
literal|1
block|}
block|,
block|{
literal|9
block|,
literal|1
block|}
block|,
block|{
literal|9
block|,
literal|1
block|}
block|}
decl_stmt|;
specifier|static
specifier|const
name|struct
name|bwn_bbatt
name|bbatt_0
index|[]
init|=
block|{
block|{
literal|0
block|}
block|,
block|{
literal|1
block|}
block|,
block|{
literal|2
block|}
block|,
block|{
literal|3
block|}
block|,
block|{
literal|4
block|}
block|,
block|{
literal|5
block|}
block|,
block|{
literal|6
block|}
block|,
block|{
literal|7
block|}
block|,
block|{
literal|8
block|}
block|}
decl_stmt|;
name|KASSERT
argument_list|(
name|phy
operator|->
name|type
operator|==
name|BWN_PHYTYPE_G
argument_list|,
operator|(
literal|"%s fail"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rf_ver
operator|==
literal|0x2050
operator|&&
name|phy
operator|->
name|rf_rev
operator|<
literal|6
condition|)
name|pg
operator|->
name|pg_bbatt
operator|.
name|att
operator|=
literal|0
expr_stmt|;
else|else
name|pg
operator|->
name|pg_bbatt
operator|.
name|att
operator|=
literal|2
expr_stmt|;
comment|/* prepare Radio Attenuation */
name|pg
operator|->
name|pg_rfatt
operator|.
name|padmix
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|siba_get_pci_subvendor
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
name|SIBA_BOARDVENDOR_BCM
operator|&&
name|siba_get_pci_subdevice
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
name|SIBA_BOARD_BCM4309G
condition|)
block|{
if|if
condition|(
name|siba_get_pci_revid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|<
literal|0x43
condition|)
block|{
name|pg
operator|->
name|pg_rfatt
operator|.
name|att
operator|=
literal|2
expr_stmt|;
goto|goto
name|done
goto|;
block|}
elseif|else
if|if
condition|(
name|siba_get_pci_revid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|<
literal|0x51
condition|)
block|{
name|pg
operator|->
name|pg_rfatt
operator|.
name|att
operator|=
literal|3
expr_stmt|;
goto|goto
name|done
goto|;
block|}
block|}
if|if
condition|(
name|phy
operator|->
name|type
operator|==
name|BWN_PHYTYPE_A
condition|)
block|{
name|pg
operator|->
name|pg_rfatt
operator|.
name|att
operator|=
literal|0x60
expr_stmt|;
goto|goto
name|done
goto|;
block|}
switch|switch
condition|(
name|phy
operator|->
name|rf_ver
condition|)
block|{
case|case
literal|0x2050
case|:
switch|switch
condition|(
name|phy
operator|->
name|rf_rev
condition|)
block|{
case|case
literal|0
case|:
name|pg
operator|->
name|pg_rfatt
operator|.
name|att
operator|=
literal|5
expr_stmt|;
goto|goto
name|done
goto|;
case|case
literal|1
case|:
if|if
condition|(
name|phy
operator|->
name|type
operator|==
name|BWN_PHYTYPE_G
condition|)
block|{
if|if
condition|(
name|siba_get_pci_subvendor
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
name|SIBA_BOARDVENDOR_BCM
operator|&&
name|siba_get_pci_subdevice
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
name|SIBA_BOARD_BCM4309G
operator|&&
name|siba_get_pci_revid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|>=
literal|30
condition|)
name|pg
operator|->
name|pg_rfatt
operator|.
name|att
operator|=
literal|3
expr_stmt|;
elseif|else
if|if
condition|(
name|siba_get_pci_subvendor
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
name|SIBA_BOARDVENDOR_BCM
operator|&&
name|siba_get_pci_subdevice
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
name|SIBA_BOARD_BU4306
condition|)
name|pg
operator|->
name|pg_rfatt
operator|.
name|att
operator|=
literal|3
expr_stmt|;
else|else
name|pg
operator|->
name|pg_rfatt
operator|.
name|att
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|siba_get_pci_subvendor
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
name|SIBA_BOARDVENDOR_BCM
operator|&&
name|siba_get_pci_subdevice
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
name|SIBA_BOARD_BCM4309G
operator|&&
name|siba_get_pci_revid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|>=
literal|30
condition|)
name|pg
operator|->
name|pg_rfatt
operator|.
name|att
operator|=
literal|7
expr_stmt|;
else|else
name|pg
operator|->
name|pg_rfatt
operator|.
name|att
operator|=
literal|6
expr_stmt|;
block|}
goto|goto
name|done
goto|;
case|case
literal|2
case|:
if|if
condition|(
name|phy
operator|->
name|type
operator|==
name|BWN_PHYTYPE_G
condition|)
block|{
if|if
condition|(
name|siba_get_pci_subvendor
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
name|SIBA_BOARDVENDOR_BCM
operator|&&
name|siba_get_pci_subdevice
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
name|SIBA_BOARD_BCM4309G
operator|&&
name|siba_get_pci_revid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|>=
literal|30
condition|)
name|pg
operator|->
name|pg_rfatt
operator|.
name|att
operator|=
literal|3
expr_stmt|;
elseif|else
if|if
condition|(
name|siba_get_pci_subvendor
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
name|SIBA_BOARDVENDOR_BCM
operator|&&
name|siba_get_pci_subdevice
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
name|SIBA_BOARD_BU4306
condition|)
name|pg
operator|->
name|pg_rfatt
operator|.
name|att
operator|=
literal|5
expr_stmt|;
elseif|else
if|if
condition|(
name|siba_get_chipid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
literal|0x4320
condition|)
name|pg
operator|->
name|pg_rfatt
operator|.
name|att
operator|=
literal|4
expr_stmt|;
else|else
name|pg
operator|->
name|pg_rfatt
operator|.
name|att
operator|=
literal|3
expr_stmt|;
block|}
else|else
name|pg
operator|->
name|pg_rfatt
operator|.
name|att
operator|=
literal|6
expr_stmt|;
goto|goto
name|done
goto|;
case|case
literal|3
case|:
name|pg
operator|->
name|pg_rfatt
operator|.
name|att
operator|=
literal|5
expr_stmt|;
goto|goto
name|done
goto|;
case|case
literal|4
case|:
case|case
literal|5
case|:
name|pg
operator|->
name|pg_rfatt
operator|.
name|att
operator|=
literal|1
expr_stmt|;
goto|goto
name|done
goto|;
case|case
literal|6
case|:
case|case
literal|7
case|:
name|pg
operator|->
name|pg_rfatt
operator|.
name|att
operator|=
literal|5
expr_stmt|;
goto|goto
name|done
goto|;
case|case
literal|8
case|:
name|pg
operator|->
name|pg_rfatt
operator|.
name|att
operator|=
literal|0xa
expr_stmt|;
name|pg
operator|->
name|pg_rfatt
operator|.
name|padmix
operator|=
literal|1
expr_stmt|;
goto|goto
name|done
goto|;
case|case
literal|9
case|:
default|default:
name|pg
operator|->
name|pg_rfatt
operator|.
name|att
operator|=
literal|5
expr_stmt|;
goto|goto
name|done
goto|;
block|}
break|break;
case|case
literal|0x2053
case|:
switch|switch
condition|(
name|phy
operator|->
name|rf_rev
condition|)
block|{
case|case
literal|1
case|:
name|pg
operator|->
name|pg_rfatt
operator|.
name|att
operator|=
literal|6
expr_stmt|;
goto|goto
name|done
goto|;
block|}
break|break;
block|}
name|pg
operator|->
name|pg_rfatt
operator|.
name|att
operator|=
literal|5
expr_stmt|;
name|done
label|:
name|pg
operator|->
name|pg_txctl
operator|=
operator|(
name|bwn_phy_g_txctl
argument_list|(
name|mac
argument_list|)
operator|<<
literal|4
operator|)
expr_stmt|;
if|if
condition|(
operator|!
name|bwn_has_hwpctl
argument_list|(
name|mac
argument_list|)
condition|)
block|{
name|lo
operator|->
name|rfatt
operator|.
name|array
operator|=
name|rfatt0
expr_stmt|;
name|lo
operator|->
name|rfatt
operator|.
name|len
operator|=
name|N
argument_list|(
name|rfatt0
argument_list|)
expr_stmt|;
name|lo
operator|->
name|rfatt
operator|.
name|min
operator|=
literal|0
expr_stmt|;
name|lo
operator|->
name|rfatt
operator|.
name|max
operator|=
literal|9
expr_stmt|;
goto|goto
name|genbbatt
goto|;
block|}
if|if
condition|(
name|phy
operator|->
name|rf_ver
operator|==
literal|0x2050
operator|&&
name|phy
operator|->
name|rf_rev
operator|==
literal|8
condition|)
block|{
name|lo
operator|->
name|rfatt
operator|.
name|array
operator|=
name|rfatt1
expr_stmt|;
name|lo
operator|->
name|rfatt
operator|.
name|len
operator|=
name|N
argument_list|(
name|rfatt1
argument_list|)
expr_stmt|;
name|lo
operator|->
name|rfatt
operator|.
name|min
operator|=
literal|0
expr_stmt|;
name|lo
operator|->
name|rfatt
operator|.
name|max
operator|=
literal|14
expr_stmt|;
goto|goto
name|genbbatt
goto|;
block|}
name|lo
operator|->
name|rfatt
operator|.
name|array
operator|=
name|rfatt2
expr_stmt|;
name|lo
operator|->
name|rfatt
operator|.
name|len
operator|=
name|N
argument_list|(
name|rfatt2
argument_list|)
expr_stmt|;
name|lo
operator|->
name|rfatt
operator|.
name|min
operator|=
literal|0
expr_stmt|;
name|lo
operator|->
name|rfatt
operator|.
name|max
operator|=
literal|9
expr_stmt|;
name|genbbatt
label|:
name|lo
operator|->
name|bbatt
operator|.
name|array
operator|=
name|bbatt_0
expr_stmt|;
name|lo
operator|->
name|bbatt
operator|.
name|len
operator|=
name|N
argument_list|(
name|bbatt_0
argument_list|)
expr_stmt|;
name|lo
operator|->
name|bbatt
operator|.
name|min
operator|=
literal|0
expr_stmt|;
name|lo
operator|->
name|bbatt
operator|.
name|max
operator|=
literal|8
expr_stmt|;
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCTL
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|==
literal|1
condition|)
block|{
name|phy
operator|->
name|gmode
operator|=
literal|0
expr_stmt|;
name|bwn_reset_core
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bwn_phy_g_init_sub
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|phy
operator|->
name|gmode
operator|=
literal|1
expr_stmt|;
name|bwn_reset_core
argument_list|(
name|mac
argument_list|,
name|BWN_TGSLOW_SUPPORT_G
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint16_t
name|bwn_phy_g_txctl
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
if|if
condition|(
name|phy
operator|->
name|rf_ver
operator|!=
literal|0x2050
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|phy
operator|->
name|rf_rev
operator|==
literal|1
condition|)
return|return
operator|(
name|BWN_TXCTL_PA2DB
operator||
name|BWN_TXCTL_TXMIX
operator|)
return|;
if|if
condition|(
name|phy
operator|->
name|rf_rev
operator|<
literal|6
condition|)
return|return
operator|(
name|BWN_TXCTL_PA2DB
operator|)
return|;
if|if
condition|(
name|phy
operator|->
name|rf_rev
operator|==
literal|8
condition|)
return|return
operator|(
name|BWN_TXCTL_TXMIX
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|bwn_phy_g_init
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|bwn_phy_g_init_sub
argument_list|(
name|mac
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|void
name|bwn_phy_g_exit
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_txpwr_loctl
modifier|*
name|lo
init|=
operator|&
name|mac
operator|->
name|mac_phy
operator|.
name|phy_g
operator|.
name|pg_loctl
decl_stmt|;
name|struct
name|bwn_lo_calib
modifier|*
name|cal
decl_stmt|,
modifier|*
name|tmp
decl_stmt|;
if|if
condition|(
name|lo
operator|==
name|NULL
condition|)
return|return;
name|TAILQ_FOREACH_SAFE
argument_list|(
argument|cal
argument_list|,
argument|&lo->calib_list
argument_list|,
argument|list
argument_list|,
argument|tmp
argument_list|)
block|{
name|TAILQ_REMOVE
argument_list|(
operator|&
name|lo
operator|->
name|calib_list
argument_list|,
name|cal
argument_list|,
name|list
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cal
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|uint16_t
name|bwn_phy_g_read
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint16_t
name|reg
parameter_list|)
block|{
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
name|BWN_PHYCTL
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
operator|(
name|BWN_READ_2
argument_list|(
name|mac
argument_list|,
name|BWN_PHYDATA
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|void
name|bwn_phy_g_write
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint16_t
name|reg
parameter_list|,
name|uint16_t
name|value
parameter_list|)
block|{
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
name|BWN_PHYCTL
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
name|BWN_PHYDATA
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|uint16_t
name|bwn_phy_g_rf_read
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint16_t
name|reg
parameter_list|)
block|{
name|KASSERT
argument_list|(
name|reg
operator|!=
literal|1
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
name|BWN_RFCTL
argument_list|,
name|reg
operator||
literal|0x80
argument_list|)
expr_stmt|;
return|return
operator|(
name|BWN_READ_2
argument_list|(
name|mac
argument_list|,
name|BWN_RFDATALO
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|void
name|bwn_phy_g_rf_write
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint16_t
name|reg
parameter_list|,
name|uint16_t
name|value
parameter_list|)
block|{
name|KASSERT
argument_list|(
name|reg
operator|!=
literal|1
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
name|BWN_RFCTL
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
name|BWN_RFDATALO
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|bwn_phy_g_hwpctl
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
return|return
operator|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|6
operator|)
return|;
block|}
end_function

begin_function
name|void
name|bwn_phy_g_rf_onoff
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|int
name|on
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwn_phy_g
modifier|*
name|pg
init|=
operator|&
name|phy
operator|->
name|phy_g
decl_stmt|;
name|unsigned
name|int
name|channel
decl_stmt|;
name|uint16_t
name|rfover
decl_stmt|,
name|rfoverval
decl_stmt|;
if|if
condition|(
name|on
condition|)
block|{
if|if
condition|(
name|phy
operator|->
name|rf_on
condition|)
return|return;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x15
argument_list|,
literal|0x8000
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x15
argument_list|,
literal|0xcc00
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x15
argument_list|,
operator|(
name|phy
operator|->
name|gmode
condition|?
literal|0xc0
else|:
literal|0x0
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pg
operator|->
name|pg_flags
operator|&
name|BWN_PHY_G_FLAG_RADIOCTX_VALID
condition|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVER
argument_list|,
name|pg
operator|->
name|pg_radioctx_over
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVERVAL
argument_list|,
name|pg
operator|->
name|pg_radioctx_overval
argument_list|)
expr_stmt|;
name|pg
operator|->
name|pg_flags
operator|&=
operator|~
name|BWN_PHY_G_FLAG_RADIOCTX_VALID
expr_stmt|;
block|}
name|channel
operator|=
name|phy
operator|->
name|chan
expr_stmt|;
name|bwn_phy_g_switch_chan
argument_list|(
name|mac
argument_list|,
literal|6
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|bwn_phy_g_switch_chan
argument_list|(
name|mac
argument_list|,
name|channel
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
name|rfover
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVER
argument_list|)
expr_stmt|;
name|rfoverval
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVERVAL
argument_list|)
expr_stmt|;
name|pg
operator|->
name|pg_radioctx_over
operator|=
name|rfover
expr_stmt|;
name|pg
operator|->
name|pg_radioctx_overval
operator|=
name|rfoverval
expr_stmt|;
name|pg
operator|->
name|pg_flags
operator||=
name|BWN_PHY_G_FLAG_RADIOCTX_VALID
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVER
argument_list|,
name|rfover
operator||
literal|0x008c
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVERVAL
argument_list|,
name|rfoverval
operator|&
literal|0xff73
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|bwn_phy_g_switch_channel
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint32_t
name|newchan
parameter_list|)
block|{
if|if
condition|(
operator|(
name|newchan
operator|<
literal|1
operator|)
operator|||
operator|(
name|newchan
operator|>
literal|14
operator|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|bwn_phy_g_switch_chan
argument_list|(
name|mac
argument_list|,
name|newchan
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|uint32_t
name|bwn_phy_g_get_default_chan
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
name|void
name|bwn_phy_g_set_antenna
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|int
name|antenna
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|uint64_t
name|hf
decl_stmt|;
name|int
name|autodiv
init|=
literal|0
decl_stmt|;
name|uint16_t
name|tmp
decl_stmt|;
if|if
condition|(
name|antenna
operator|==
name|BWN_ANTAUTO0
operator|||
name|antenna
operator|==
name|BWN_ANTAUTO1
condition|)
name|autodiv
operator|=
literal|1
expr_stmt|;
name|hf
operator|=
name|bwn_hf_read
argument_list|(
name|mac
argument_list|)
operator|&
operator|~
name|BWN_HF_UCODE_ANTDIV_HELPER
expr_stmt|;
name|bwn_hf_write
argument_list|(
name|mac
argument_list|,
name|hf
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_BBANDCFG
argument_list|,
operator|(
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_BBANDCFG
argument_list|)
operator|&
operator|~
name|BWN_PHY_BBANDCFG_RXANT
operator|)
operator||
operator|(
operator|(
name|autodiv
condition|?
name|BWN_ANTAUTO1
else|:
name|antenna
operator|)
operator|<<
name|BWN_PHY_BBANDCFG_RXANT_SHIFT
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|autodiv
condition|)
block|{
name|tmp
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_ANTDWELL
argument_list|)
expr_stmt|;
if|if
condition|(
name|antenna
operator|==
name|BWN_ANTAUTO1
condition|)
name|tmp
operator|&=
operator|~
name|BWN_PHY_ANTDWELL_AUTODIV1
expr_stmt|;
else|else
name|tmp
operator||=
name|BWN_PHY_ANTDWELL_AUTODIV1
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_ANTDWELL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
name|tmp
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_ANTWRSETT
argument_list|)
expr_stmt|;
if|if
condition|(
name|autodiv
condition|)
name|tmp
operator||=
name|BWN_PHY_ANTWRSETT_ARXDIV
expr_stmt|;
else|else
name|tmp
operator|&=
operator|~
name|BWN_PHY_ANTWRSETT_ARXDIV
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_ANTWRSETT
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|2
condition|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_OFDM61
argument_list|,
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_OFDM61
argument_list|)
operator||
name|BWN_PHY_OFDM61_10
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_DIVSRCHGAINBACK
argument_list|,
operator|(
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_DIVSRCHGAINBACK
argument_list|)
operator|&
literal|0xff00
operator|)
operator||
literal|0x15
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|==
literal|2
condition|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_ADIVRELATED
argument_list|,
literal|8
argument_list|)
expr_stmt|;
else|else
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_ADIVRELATED
argument_list|,
operator|(
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_ADIVRELATED
argument_list|)
operator|&
literal|0xff00
operator|)
operator||
literal|8
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|6
condition|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_OFDM9B
argument_list|,
literal|0xdc
argument_list|)
expr_stmt|;
name|hf
operator||=
name|BWN_HF_UCODE_ANTDIV_HELPER
expr_stmt|;
name|bwn_hf_write
argument_list|(
name|mac
argument_list|,
name|hf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|bwn_phy_g_im
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwn_phy_g
modifier|*
name|pg
init|=
operator|&
name|phy
operator|->
name|phy_g
decl_stmt|;
name|KASSERT
argument_list|(
name|phy
operator|->
name|type
operator|==
name|BWN_PHYTYPE_G
argument_list|,
operator|(
literal|"%s: fail"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|mode
operator|==
name|BWN_IMMODE_NONE
argument_list|,
operator|(
literal|"%s: fail"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|==
literal|0
operator|||
operator|!
name|phy
operator|->
name|gmode
condition|)
return|return
operator|(
name|ENODEV
operator|)
return|;
name|pg
operator|->
name|pg_aci_wlan_automatic
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|bwn_phy_g_recalc_txpwr
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|int
name|ignore_tssi
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwn_phy_g
modifier|*
name|pg
init|=
operator|&
name|phy
operator|->
name|phy_g
decl_stmt|;
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|unsigned
name|int
name|tssi
decl_stmt|;
name|int
name|cck
decl_stmt|,
name|ofdm
decl_stmt|;
name|int
name|power
decl_stmt|;
name|int
name|rfatt
decl_stmt|,
name|bbatt
decl_stmt|;
name|unsigned
name|int
name|max
decl_stmt|;
name|KASSERT
argument_list|(
name|phy
operator|->
name|type
operator|==
name|BWN_PHYTYPE_G
argument_list|,
operator|(
literal|"%s: fail"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
name|cck
operator|=
name|bwn_phy_shm_tssi_read
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED_TSSI_CCK
argument_list|)
expr_stmt|;
name|ofdm
operator|=
name|bwn_phy_shm_tssi_read
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED_TSSI_OFDM_G
argument_list|)
expr_stmt|;
if|if
condition|(
name|cck
operator|<
literal|0
operator|&&
name|ofdm
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|ignore_tssi
operator|==
literal|0
condition|)
return|return
operator|(
name|BWN_TXPWR_RES_DONE
operator|)
return|;
name|cck
operator|=
literal|0
expr_stmt|;
name|ofdm
operator|=
literal|0
expr_stmt|;
block|}
name|tssi
operator|=
operator|(
name|cck
operator|<
literal|0
operator|)
condition|?
name|ofdm
else|:
operator|(
operator|(
name|ofdm
operator|<
literal|0
operator|)
condition|?
name|cck
else|:
operator|(
name|cck
operator|+
name|ofdm
operator|)
operator|/
literal|2
operator|)
expr_stmt|;
if|if
condition|(
name|pg
operator|->
name|pg_avgtssi
operator|!=
literal|0xff
condition|)
name|tssi
operator|=
operator|(
name|tssi
operator|+
name|pg
operator|->
name|pg_avgtssi
operator|)
operator|/
literal|2
expr_stmt|;
name|pg
operator|->
name|pg_avgtssi
operator|=
name|tssi
expr_stmt|;
name|KASSERT
argument_list|(
name|tssi
operator|<
name|BWN_TSSI_MAX
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
name|max
operator|=
name|siba_sprom_get_maxpwr_bg
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|siba_sprom_get_bf_lo
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|&
name|BWN_BFL_PACTRL
condition|)
name|max
operator|-=
literal|3
expr_stmt|;
if|if
condition|(
name|max
operator|>=
literal|120
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"invalid max TX-power value\n"
argument_list|)
expr_stmt|;
name|max
operator|=
literal|80
expr_stmt|;
name|siba_sprom_set_maxpwr_bg
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
name|max
argument_list|)
expr_stmt|;
block|}
name|power
operator|=
name|MIN
argument_list|(
name|MAX
argument_list|(
operator|(
name|phy
operator|->
name|txpower
operator|<
literal|0
operator|)
condition|?
literal|0
else|:
operator|(
name|phy
operator|->
name|txpower
operator|<<
literal|2
operator|)
argument_list|,
literal|0
argument_list|)
argument_list|,
name|max
argument_list|)
operator|-
operator|(
name|pg
operator|->
name|pg_tssi2dbm
index|[
name|MIN
argument_list|(
name|MAX
argument_list|(
name|pg
operator|->
name|pg_idletssi
operator|-
name|pg
operator|->
name|pg_curtssi
operator|+
name|tssi
argument_list|,
literal|0x00
argument_list|)
argument_list|,
literal|0x3f
argument_list|)
index|]
operator|)
expr_stmt|;
if|if
condition|(
name|power
operator|==
literal|0
condition|)
return|return
operator|(
name|BWN_TXPWR_RES_DONE
operator|)
return|;
name|rfatt
operator|=
operator|-
operator|(
operator|(
name|power
operator|+
literal|7
operator|)
operator|/
literal|8
operator|)
expr_stmt|;
name|bbatt
operator|=
operator|(
operator|-
operator|(
name|power
operator|/
literal|2
operator|)
operator|)
operator|-
operator|(
literal|4
operator|*
name|rfatt
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|rfatt
operator|==
literal|0
operator|)
operator|&&
operator|(
name|bbatt
operator|==
literal|0
operator|)
condition|)
return|return
operator|(
name|BWN_TXPWR_RES_DONE
operator|)
return|;
name|pg
operator|->
name|pg_bbatt_delta
operator|=
name|bbatt
expr_stmt|;
name|pg
operator|->
name|pg_rfatt_delta
operator|=
name|rfatt
expr_stmt|;
return|return
operator|(
name|BWN_TXPWR_RES_NEED_ADJUST
operator|)
return|;
block|}
end_function

begin_function
name|void
name|bwn_phy_g_set_txpwr
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwn_phy_g
modifier|*
name|pg
init|=
operator|&
name|phy
operator|->
name|phy_g
decl_stmt|;
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|int
name|rfatt
decl_stmt|,
name|bbatt
decl_stmt|;
name|uint8_t
name|txctl
decl_stmt|;
name|bwn_mac_suspend
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|BWN_ASSERT_LOCKED
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|bbatt
operator|=
name|pg
operator|->
name|pg_bbatt
operator|.
name|att
expr_stmt|;
name|bbatt
operator|+=
name|pg
operator|->
name|pg_bbatt_delta
expr_stmt|;
name|rfatt
operator|=
name|pg
operator|->
name|pg_rfatt
operator|.
name|att
expr_stmt|;
name|rfatt
operator|+=
name|pg
operator|->
name|pg_rfatt_delta
expr_stmt|;
name|bwn_phy_g_setatt
argument_list|(
name|mac
argument_list|,
operator|&
name|bbatt
argument_list|,
operator|&
name|rfatt
argument_list|)
expr_stmt|;
name|txctl
operator|=
name|pg
operator|->
name|pg_txctl
expr_stmt|;
if|if
condition|(
operator|(
name|phy
operator|->
name|rf_ver
operator|==
literal|0x2050
operator|)
operator|&&
operator|(
name|phy
operator|->
name|rf_rev
operator|==
literal|2
operator|)
condition|)
block|{
if|if
condition|(
name|rfatt
operator|<=
literal|1
condition|)
block|{
if|if
condition|(
name|txctl
operator|==
literal|0
condition|)
block|{
name|txctl
operator|=
name|BWN_TXCTL_PA2DB
operator||
name|BWN_TXCTL_TXMIX
expr_stmt|;
name|rfatt
operator|+=
literal|2
expr_stmt|;
name|bbatt
operator|+=
literal|2
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|siba_sprom_get_bf_lo
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|&
name|BWN_BFL_PACTRL
condition|)
block|{
name|bbatt
operator|+=
literal|4
operator|*
operator|(
name|rfatt
operator|-
literal|2
operator|)
expr_stmt|;
name|rfatt
operator|=
literal|2
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|rfatt
operator|>
literal|4
operator|&&
name|txctl
condition|)
block|{
name|txctl
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|bbatt
operator|<
literal|3
condition|)
block|{
name|rfatt
operator|-=
literal|3
expr_stmt|;
name|bbatt
operator|+=
literal|2
expr_stmt|;
block|}
else|else
block|{
name|rfatt
operator|-=
literal|2
expr_stmt|;
name|bbatt
operator|-=
literal|2
expr_stmt|;
block|}
block|}
block|}
name|pg
operator|->
name|pg_txctl
operator|=
name|txctl
expr_stmt|;
name|bwn_phy_g_setatt
argument_list|(
name|mac
argument_list|,
operator|&
name|bbatt
argument_list|,
operator|&
name|rfatt
argument_list|)
expr_stmt|;
name|pg
operator|->
name|pg_rfatt
operator|.
name|att
operator|=
name|rfatt
expr_stmt|;
name|pg
operator|->
name|pg_bbatt
operator|.
name|att
operator|=
name|bbatt
expr_stmt|;
name|DPRINTF
argument_list|(
name|sc
argument_list|,
name|BWN_DEBUG_TXPOW
argument_list|,
literal|"%s: adjust TX power\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|bwn_phy_lock
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|bwn_rf_lock
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|bwn_phy_g_set_txpwr_sub
argument_list|(
name|mac
argument_list|,
operator|&
name|pg
operator|->
name|pg_bbatt
argument_list|,
operator|&
name|pg
operator|->
name|pg_rfatt
argument_list|,
name|pg
operator|->
name|pg_txctl
argument_list|)
expr_stmt|;
name|bwn_rf_unlock
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|bwn_phy_unlock
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|bwn_mac_enable
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|bwn_phy_g_task_15s
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwn_phy_g
modifier|*
name|pg
init|=
operator|&
name|phy
operator|->
name|phy_g
decl_stmt|;
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|struct
name|bwn_txpwr_loctl
modifier|*
name|lo
init|=
operator|&
name|pg
operator|->
name|pg_loctl
decl_stmt|;
name|unsigned
name|long
name|expire
decl_stmt|,
name|now
decl_stmt|;
name|struct
name|bwn_lo_calib
modifier|*
name|cal
decl_stmt|,
modifier|*
name|tmp
decl_stmt|;
name|uint8_t
name|expired
init|=
literal|0
decl_stmt|;
name|bwn_mac_suspend
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|lo
operator|==
name|NULL
condition|)
goto|goto
name|fail
goto|;
name|BWN_GETTIME
argument_list|(
name|now
argument_list|)
expr_stmt|;
if|if
condition|(
name|bwn_has_hwpctl
argument_list|(
name|mac
argument_list|)
condition|)
block|{
name|expire
operator|=
name|now
operator|-
name|BWN_LO_PWRVEC_EXPIRE
expr_stmt|;
if|if
condition|(
name|ieee80211_time_before
argument_list|(
name|lo
operator|->
name|pwr_vec_read_time
argument_list|,
name|expire
argument_list|)
condition|)
block|{
name|bwn_lo_get_powervector
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|bwn_phy_g_dc_lookup_init
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
goto|goto
name|fail
goto|;
block|}
name|expire
operator|=
name|now
operator|-
name|BWN_LO_CALIB_EXPIRE
expr_stmt|;
name|TAILQ_FOREACH_SAFE
argument_list|(
argument|cal
argument_list|,
argument|&lo->calib_list
argument_list|,
argument|list
argument_list|,
argument|tmp
argument_list|)
block|{
if|if
condition|(
operator|!
name|ieee80211_time_before
argument_list|(
name|cal
operator|->
name|calib_time
argument_list|,
name|expire
argument_list|)
condition|)
continue|continue;
if|if
condition|(
name|BWN_BBATTCMP
argument_list|(
operator|&
name|cal
operator|->
name|bbatt
argument_list|,
operator|&
name|pg
operator|->
name|pg_bbatt
argument_list|)
operator|&&
name|BWN_RFATTCMP
argument_list|(
operator|&
name|cal
operator|->
name|rfatt
argument_list|,
operator|&
name|pg
operator|->
name|pg_rfatt
argument_list|)
condition|)
block|{
name|KASSERT
argument_list|(
operator|!
name|expired
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
name|expired
operator|=
literal|1
expr_stmt|;
block|}
name|DPRINTF
argument_list|(
name|sc
argument_list|,
name|BWN_DEBUG_LO
argument_list|,
literal|"expired BB %u RF %u %u I %d Q %d\n"
argument_list|,
name|cal
operator|->
name|bbatt
operator|.
name|att
argument_list|,
name|cal
operator|->
name|rfatt
operator|.
name|att
argument_list|,
name|cal
operator|->
name|rfatt
operator|.
name|padmix
argument_list|,
name|cal
operator|->
name|ctl
operator|.
name|i
argument_list|,
name|cal
operator|->
name|ctl
operator|.
name|q
argument_list|)
expr_stmt|;
name|TAILQ_REMOVE
argument_list|(
operator|&
name|lo
operator|->
name|calib_list
argument_list|,
name|cal
argument_list|,
name|list
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cal
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|expired
operator|||
name|TAILQ_EMPTY
argument_list|(
operator|&
name|lo
operator|->
name|calib_list
argument_list|)
condition|)
block|{
name|cal
operator|=
name|bwn_lo_calibset
argument_list|(
name|mac
argument_list|,
operator|&
name|pg
operator|->
name|pg_bbatt
argument_list|,
operator|&
name|pg
operator|->
name|pg_rfatt
argument_list|)
expr_stmt|;
if|if
condition|(
name|cal
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"failed to recalibrate LO\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|lo
operator|->
name|calib_list
argument_list|,
name|cal
argument_list|,
name|list
argument_list|)
expr_stmt|;
name|bwn_lo_write
argument_list|(
name|mac
argument_list|,
operator|&
name|cal
operator|->
name|ctl
argument_list|)
expr_stmt|;
block|}
name|fail
label|:
name|bwn_mac_enable
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|bwn_phy_g_task_60s
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|uint8_t
name|old
init|=
name|phy
operator|->
name|chan
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|siba_sprom_get_bf_lo
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|&
name|BWN_BFL_RSSI
operator|)
condition|)
return|return;
name|bwn_mac_suspend
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|bwn_nrssi_slope_11g
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|phy
operator|->
name|rf_ver
operator|==
literal|0x2050
operator|)
operator|&&
operator|(
name|phy
operator|->
name|rf_rev
operator|==
literal|8
operator|)
condition|)
block|{
name|bwn_switch_channel
argument_list|(
name|mac
argument_list|,
operator|(
name|old
operator|>=
literal|8
operator|)
condition|?
literal|1
else|:
literal|13
argument_list|)
expr_stmt|;
name|bwn_switch_channel
argument_list|(
name|mac
argument_list|,
name|old
argument_list|)
expr_stmt|;
block|}
name|bwn_mac_enable
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|bwn_phy_switch_analog
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|int
name|on
parameter_list|)
block|{
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
name|BWN_PHY0
argument_list|,
name|on
condition|?
literal|0
else|:
literal|0xf4
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_phy_g_init_sub
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwn_phy_g
modifier|*
name|pg
init|=
operator|&
name|phy
operator|->
name|phy_g
decl_stmt|;
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|uint16_t
name|i
decl_stmt|,
name|tmp
decl_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|==
literal|1
condition|)
name|bwn_phy_init_b5
argument_list|(
name|mac
argument_list|)
expr_stmt|;
else|else
name|bwn_phy_init_b6
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|2
operator|||
name|phy
operator|->
name|gmode
condition|)
name|bwn_phy_init_a
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|2
condition|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_ANALOGOVER
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_ANALOGOVERVAL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|phy
operator|->
name|rev
operator|==
literal|2
condition|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVER
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_PGACTL
argument_list|,
literal|0xc0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|phy
operator|->
name|rev
operator|>
literal|5
condition|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVER
argument_list|,
literal|0x400
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_PGACTL
argument_list|,
literal|0xc0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|phy
operator|->
name|gmode
operator|||
name|phy
operator|->
name|rev
operator|>=
literal|2
condition|)
block|{
name|tmp
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_VERSION_OFDM
argument_list|)
expr_stmt|;
name|tmp
operator|&=
name|BWN_PHYVER_VERSION
expr_stmt|;
if|if
condition|(
name|tmp
operator|==
literal|3
operator|||
name|tmp
operator|==
literal|5
condition|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_OFDM
argument_list|(
literal|0xc2
argument_list|)
argument_list|,
literal|0x1816
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_OFDM
argument_list|(
literal|0xc3
argument_list|)
argument_list|,
literal|0x8006
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|tmp
operator|==
literal|5
condition|)
block|{
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_OFDM
argument_list|(
literal|0xcc
argument_list|)
argument_list|,
literal|0x00ff
argument_list|,
literal|0x1f00
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|phy
operator|->
name|rev
operator|<=
literal|2
operator|&&
name|phy
operator|->
name|gmode
operator|)
operator|||
name|phy
operator|->
name|rev
operator|>=
literal|2
condition|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_OFDM
argument_list|(
literal|0x7e
argument_list|)
argument_list|,
literal|0x78
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rf_rev
operator|==
literal|8
condition|)
block|{
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_EXTG
argument_list|(
literal|0x01
argument_list|)
argument_list|,
literal|0x80
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_OFDM
argument_list|(
literal|0x3e
argument_list|)
argument_list|,
literal|0x4
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|BWN_HAS_LOOPBACK
argument_list|(
name|phy
argument_list|)
condition|)
name|bwn_loopback_calcgain
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rf_rev
operator|!=
literal|8
condition|)
block|{
if|if
condition|(
name|pg
operator|->
name|pg_initval
operator|==
literal|0xffff
condition|)
name|pg
operator|->
name|pg_initval
operator|=
name|bwn_rf_init_bcm2050
argument_list|(
name|mac
argument_list|)
expr_stmt|;
else|else
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x0078
argument_list|,
name|pg
operator|->
name|pg_initval
argument_list|)
expr_stmt|;
block|}
name|bwn_lo_g_init
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|BWN_HAS_TXMAG
argument_list|(
name|phy
argument_list|)
condition|)
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x52
argument_list|,
operator|(
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
literal|0x52
argument_list|)
operator|&
literal|0xff00
operator|)
operator||
name|pg
operator|->
name|pg_loctl
operator|.
name|tx_bias
operator||
name|pg
operator|->
name|pg_loctl
operator|.
name|tx_magn
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BWN_RF_SETMASK
argument_list|(
name|mac
argument_list|,
literal|0x52
argument_list|,
literal|0xfff0
argument_list|,
name|pg
operator|->
name|pg_loctl
operator|.
name|tx_bias
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|6
condition|)
block|{
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x36
argument_list|)
argument_list|,
literal|0x0fff
argument_list|,
operator|(
name|pg
operator|->
name|pg_loctl
operator|.
name|tx_bias
operator|<<
literal|12
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|siba_sprom_get_bf_lo
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|&
name|BWN_BFL_PACTRL
condition|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x2e
argument_list|)
argument_list|,
literal|0x8075
argument_list|)
expr_stmt|;
else|else
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x2e
argument_list|)
argument_list|,
literal|0x807f
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|<
literal|2
condition|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x2f
argument_list|)
argument_list|,
literal|0x101
argument_list|)
expr_stmt|;
else|else
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x2f
argument_list|)
argument_list|,
literal|0x202
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|gmode
operator|||
name|phy
operator|->
name|rev
operator|>=
literal|2
condition|)
block|{
name|bwn_lo_g_adjust
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_LO_MASK
argument_list|,
literal|0x8078
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|(
name|siba_sprom_get_bf_lo
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|&
name|BWN_BFL_RSSI
operator|)
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|64
condition|;
name|i
operator|++
control|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_NRSSI_CTRL
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_NRSSI_DATA
argument_list|,
operator|(
name|uint16_t
operator|)
name|MIN
argument_list|(
name|MAX
argument_list|(
name|bwn_nrssi_read
argument_list|(
name|mac
argument_list|,
name|i
argument_list|)
operator|-
literal|0xffff
argument_list|,
operator|-
literal|32
argument_list|)
argument_list|,
literal|31
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|bwn_nrssi_threshold
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|phy
operator|->
name|gmode
operator|||
name|phy
operator|->
name|rev
operator|>=
literal|2
condition|)
block|{
if|if
condition|(
name|pg
operator|->
name|pg_nrssi
index|[
literal|0
index|]
operator|==
operator|-
literal|1000
condition|)
block|{
name|KASSERT
argument_list|(
name|pg
operator|->
name|pg_nrssi
index|[
literal|1
index|]
operator|==
operator|-
literal|1000
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
name|bwn_nrssi_slope_11g
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
else|else
name|bwn_nrssi_threshold
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|phy
operator|->
name|rf_rev
operator|==
literal|8
condition|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_EXTG
argument_list|(
literal|0x05
argument_list|)
argument_list|,
literal|0x3230
argument_list|)
expr_stmt|;
name|bwn_phy_hwpctl_init
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|siba_get_chipid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
literal|0x4306
operator|&&
name|siba_get_chippkg
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
literal|2
operator|)
operator|||
literal|0
condition|)
block|{
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CRS0
argument_list|,
literal|0xbfff
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_OFDM
argument_list|(
literal|0xc3
argument_list|)
argument_list|,
literal|0x7fff
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_phy_init_b5
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwn_phy_g
modifier|*
name|pg
init|=
operator|&
name|phy
operator|->
name|phy_g
decl_stmt|;
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|uint16_t
name|offset
decl_stmt|,
name|value
decl_stmt|;
name|uint8_t
name|old_channel
decl_stmt|;
if|if
condition|(
name|phy
operator|->
name|analog
operator|==
literal|1
condition|)
name|BWN_RF_SET
argument_list|(
name|mac
argument_list|,
literal|0x007a
argument_list|,
literal|0x0050
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|siba_get_pci_subvendor
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|!=
name|SIBA_BOARDVENDOR_BCM
operator|)
operator|&&
operator|(
name|siba_get_pci_subdevice
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|!=
name|SIBA_BOARD_BU4306
operator|)
condition|)
block|{
name|value
operator|=
literal|0x2120
expr_stmt|;
for|for
control|(
name|offset
operator|=
literal|0x00a8
init|;
name|offset
operator|<
literal|0x00c7
condition|;
name|offset
operator|++
control|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|offset
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|value
operator|+=
literal|0x202
expr_stmt|;
block|}
block|}
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
literal|0x0035
argument_list|,
literal|0xf0ff
argument_list|,
literal|0x0700
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rf_ver
operator|==
literal|0x2050
condition|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x0038
argument_list|,
literal|0x0667
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|gmode
operator|||
name|phy
operator|->
name|rev
operator|>=
literal|2
condition|)
block|{
if|if
condition|(
name|phy
operator|->
name|rf_ver
operator|==
literal|0x2050
condition|)
block|{
name|BWN_RF_SET
argument_list|(
name|mac
argument_list|,
literal|0x007a
argument_list|,
literal|0x0020
argument_list|)
expr_stmt|;
name|BWN_RF_SET
argument_list|(
name|mac
argument_list|,
literal|0x0051
argument_list|,
literal|0x0004
argument_list|)
expr_stmt|;
block|}
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RADIO
argument_list|,
literal|0x0000
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
literal|0x0802
argument_list|,
literal|0x0100
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
literal|0x042b
argument_list|,
literal|0x2000
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x001c
argument_list|,
literal|0x186a
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
literal|0x0013
argument_list|,
literal|0x00ff
argument_list|,
literal|0x1900
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
literal|0x0035
argument_list|,
literal|0xffc0
argument_list|,
literal|0x0064
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
literal|0x005d
argument_list|,
literal|0xff80
argument_list|,
literal|0x000a
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mac
operator|->
name|mac_flags
operator|&
name|BWN_MAC_FLAG_BADFRAME_PREEMP
condition|)
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RADIO_BITFIELD
argument_list|,
operator|(
literal|1
operator|<<
literal|11
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|analog
operator|==
literal|1
condition|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x0026
argument_list|,
literal|0xce00
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x0021
argument_list|,
literal|0x3763
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x0022
argument_list|,
literal|0x1bc3
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x0023
argument_list|,
literal|0x06f9
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x0024
argument_list|,
literal|0x037e
argument_list|)
expr_stmt|;
block|}
else|else
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x0026
argument_list|,
literal|0xcc00
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x0030
argument_list|,
literal|0x00c6
argument_list|)
expr_stmt|;
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
literal|0x03ec
argument_list|,
literal|0x3f22
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|analog
operator|==
literal|1
condition|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x0020
argument_list|,
literal|0x3e1c
argument_list|)
expr_stmt|;
else|else
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x0020
argument_list|,
literal|0x301c
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|analog
operator|==
literal|0
condition|)
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
literal|0x03e4
argument_list|,
literal|0x3000
argument_list|)
expr_stmt|;
name|old_channel
operator|=
name|phy
operator|->
name|chan
expr_stmt|;
name|bwn_phy_g_switch_chan
argument_list|(
name|mac
argument_list|,
literal|7
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rf_ver
operator|!=
literal|0x2050
condition|)
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x0075
argument_list|,
literal|0x0080
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x0079
argument_list|,
literal|0x0081
argument_list|)
expr_stmt|;
block|}
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x0050
argument_list|,
literal|0x0020
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x0050
argument_list|,
literal|0x0023
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rf_ver
operator|==
literal|0x2050
condition|)
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x0050
argument_list|,
literal|0x0020
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x005a
argument_list|,
literal|0x0070
argument_list|)
expr_stmt|;
block|}
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x005b
argument_list|,
literal|0x007b
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x005c
argument_list|,
literal|0x00b0
argument_list|)
expr_stmt|;
name|BWN_RF_SET
argument_list|(
name|mac
argument_list|,
literal|0x007a
argument_list|,
literal|0x0007
argument_list|)
expr_stmt|;
name|bwn_phy_g_switch_chan
argument_list|(
name|mac
argument_list|,
name|old_channel
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x0014
argument_list|,
literal|0x0080
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x0032
argument_list|,
literal|0x00ca
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x002a
argument_list|,
literal|0x88a3
argument_list|)
expr_stmt|;
name|bwn_phy_g_set_txpwr_sub
argument_list|(
name|mac
argument_list|,
operator|&
name|pg
operator|->
name|pg_bbatt
argument_list|,
operator|&
name|pg
operator|->
name|pg_rfatt
argument_list|,
name|pg
operator|->
name|pg_txctl
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rf_ver
operator|==
literal|0x2050
condition|)
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x005d
argument_list|,
literal|0x000d
argument_list|)
expr_stmt|;
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
literal|0x03e4
argument_list|,
operator|(
name|BWN_READ_2
argument_list|(
name|mac
argument_list|,
literal|0x03e4
argument_list|)
operator|&
literal|0xffc0
operator|)
operator||
literal|0x0004
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_loopback_calcgain
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwn_phy_g
modifier|*
name|pg
init|=
operator|&
name|phy
operator|->
name|phy_g
decl_stmt|;
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|uint16_t
name|backup_phy
index|[
literal|16
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
name|uint16_t
name|backup_radio
index|[
literal|3
index|]
decl_stmt|;
name|uint16_t
name|backup_bband
decl_stmt|;
name|uint16_t
name|i
decl_stmt|,
name|j
decl_stmt|,
name|loop_i_max
decl_stmt|;
name|uint16_t
name|trsw_rx
decl_stmt|;
name|uint16_t
name|loop1_outer_done
decl_stmt|,
name|loop1_inner_done
decl_stmt|;
name|backup_phy
index|[
literal|0
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CRS0
argument_list|)
expr_stmt|;
name|backup_phy
index|[
literal|1
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCKBBANDCFG
argument_list|)
expr_stmt|;
name|backup_phy
index|[
literal|2
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVER
argument_list|)
expr_stmt|;
name|backup_phy
index|[
literal|3
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVERVAL
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|!=
literal|1
condition|)
block|{
name|backup_phy
index|[
literal|4
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_ANALOGOVER
argument_list|)
expr_stmt|;
name|backup_phy
index|[
literal|5
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_ANALOGOVERVAL
argument_list|)
expr_stmt|;
block|}
name|backup_phy
index|[
literal|6
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x5a
argument_list|)
argument_list|)
expr_stmt|;
name|backup_phy
index|[
literal|7
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x59
argument_list|)
argument_list|)
expr_stmt|;
name|backup_phy
index|[
literal|8
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x58
argument_list|)
argument_list|)
expr_stmt|;
name|backup_phy
index|[
literal|9
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x0a
argument_list|)
argument_list|)
expr_stmt|;
name|backup_phy
index|[
literal|10
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x03
argument_list|)
argument_list|)
expr_stmt|;
name|backup_phy
index|[
literal|11
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_LO_MASK
argument_list|)
expr_stmt|;
name|backup_phy
index|[
literal|12
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_LO_CTL
argument_list|)
expr_stmt|;
name|backup_phy
index|[
literal|13
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x2b
argument_list|)
argument_list|)
expr_stmt|;
name|backup_phy
index|[
literal|14
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_PGACTL
argument_list|)
expr_stmt|;
name|backup_phy
index|[
literal|15
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_LO_LEAKAGE
argument_list|)
expr_stmt|;
name|backup_bband
operator|=
name|pg
operator|->
name|pg_bbatt
operator|.
name|att
expr_stmt|;
name|backup_radio
index|[
literal|0
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
literal|0x52
argument_list|)
expr_stmt|;
name|backup_radio
index|[
literal|1
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
literal|0x43
argument_list|)
expr_stmt|;
name|backup_radio
index|[
literal|2
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
literal|0x7a
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CRS0
argument_list|,
literal|0x3fff
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCKBBANDCFG
argument_list|,
literal|0x8000
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVER
argument_list|,
literal|0x0002
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVERVAL
argument_list|,
literal|0xfffd
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVER
argument_list|,
literal|0x0001
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVERVAL
argument_list|,
literal|0xfffe
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|!=
literal|1
condition|)
block|{
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_ANALOGOVER
argument_list|,
literal|0x0001
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_ANALOGOVERVAL
argument_list|,
literal|0xfffe
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_ANALOGOVER
argument_list|,
literal|0x0002
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_ANALOGOVERVAL
argument_list|,
literal|0xfffd
argument_list|)
expr_stmt|;
block|}
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVER
argument_list|,
literal|0x000c
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVERVAL
argument_list|,
literal|0x000c
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVER
argument_list|,
literal|0x0030
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVERVAL
argument_list|,
literal|0xffcf
argument_list|,
literal|0x10
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x5a
argument_list|)
argument_list|,
literal|0x0780
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x59
argument_list|)
argument_list|,
literal|0xc810
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x58
argument_list|)
argument_list|,
literal|0x000d
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x0a
argument_list|)
argument_list|,
literal|0x2000
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|!=
literal|1
condition|)
block|{
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_ANALOGOVER
argument_list|,
literal|0x0004
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_ANALOGOVERVAL
argument_list|,
literal|0xfffb
argument_list|)
expr_stmt|;
block|}
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x03
argument_list|)
argument_list|,
literal|0xff9f
argument_list|,
literal|0x40
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rf_rev
operator|==
literal|8
condition|)
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x43
argument_list|,
literal|0x000f
argument_list|)
expr_stmt|;
else|else
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x52
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_RF_SETMASK
argument_list|(
name|mac
argument_list|,
literal|0x43
argument_list|,
literal|0xfff0
argument_list|,
literal|0x9
argument_list|)
expr_stmt|;
block|}
name|bwn_phy_g_set_bbatt
argument_list|(
name|mac
argument_list|,
literal|11
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|3
condition|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_LO_MASK
argument_list|,
literal|0xc020
argument_list|)
expr_stmt|;
else|else
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_LO_MASK
argument_list|,
literal|0x8020
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_LO_CTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x2b
argument_list|)
argument_list|,
literal|0xffc0
argument_list|,
literal|0x01
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x2b
argument_list|)
argument_list|,
literal|0xc0ff
argument_list|,
literal|0x800
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVER
argument_list|,
literal|0x0100
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVERVAL
argument_list|,
literal|0xcfff
argument_list|)
expr_stmt|;
if|if
condition|(
name|siba_sprom_get_bf_lo
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|&
name|BWN_BFL_EXTLNA
condition|)
block|{
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|7
condition|)
block|{
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVER
argument_list|,
literal|0x0800
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVERVAL
argument_list|,
literal|0x8000
argument_list|)
expr_stmt|;
block|}
block|}
name|BWN_RF_MASK
argument_list|(
name|mac
argument_list|,
literal|0x7a
argument_list|,
literal|0x00f7
argument_list|)
expr_stmt|;
name|j
operator|=
literal|0
expr_stmt|;
name|loop_i_max
operator|=
operator|(
name|phy
operator|->
name|rf_rev
operator|==
literal|8
operator|)
condition|?
literal|15
else|:
literal|9
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|loop_i_max
condition|;
name|i
operator|++
control|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|16
condition|;
name|j
operator|++
control|)
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x43
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVERVAL
argument_list|,
literal|0xf0ff
argument_list|,
operator|(
name|j
operator|<<
literal|8
operator|)
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_PGACTL
argument_list|,
literal|0x0fff
argument_list|,
literal|0xa000
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_PGACTL
argument_list|,
literal|0xf000
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|20
argument_list|)
expr_stmt|;
if|if
condition|(
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_LO_LEAKAGE
argument_list|)
operator|>=
literal|0xdfc
condition|)
goto|goto
name|done0
goto|;
block|}
block|}
name|done0
label|:
name|loop1_outer_done
operator|=
name|i
expr_stmt|;
name|loop1_inner_done
operator|=
name|j
expr_stmt|;
if|if
condition|(
name|j
operator|>=
literal|8
condition|)
block|{
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVERVAL
argument_list|,
literal|0x30
argument_list|)
expr_stmt|;
name|trsw_rx
operator|=
literal|0x1b
expr_stmt|;
for|for
control|(
name|j
operator|=
name|j
operator|-
literal|8
init|;
name|j
operator|<
literal|16
condition|;
name|j
operator|++
control|)
block|{
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVERVAL
argument_list|,
literal|0xf0ff
argument_list|,
name|j
operator|<<
literal|8
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_PGACTL
argument_list|,
literal|0x0fff
argument_list|,
literal|0xa000
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_PGACTL
argument_list|,
literal|0xf000
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|20
argument_list|)
expr_stmt|;
name|trsw_rx
operator|-=
literal|3
expr_stmt|;
if|if
condition|(
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_LO_LEAKAGE
argument_list|)
operator|>=
literal|0xdfc
condition|)
goto|goto
name|done1
goto|;
block|}
block|}
else|else
name|trsw_rx
operator|=
literal|0x18
expr_stmt|;
name|done1
label|:
if|if
condition|(
name|phy
operator|->
name|rev
operator|!=
literal|1
condition|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_ANALOGOVER
argument_list|,
name|backup_phy
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_ANALOGOVERVAL
argument_list|,
name|backup_phy
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
block|}
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x5a
argument_list|)
argument_list|,
name|backup_phy
index|[
literal|6
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x59
argument_list|)
argument_list|,
name|backup_phy
index|[
literal|7
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x58
argument_list|)
argument_list|,
name|backup_phy
index|[
literal|8
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x0a
argument_list|)
argument_list|,
name|backup_phy
index|[
literal|9
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x03
argument_list|)
argument_list|,
name|backup_phy
index|[
literal|10
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_LO_MASK
argument_list|,
name|backup_phy
index|[
literal|11
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_LO_CTL
argument_list|,
name|backup_phy
index|[
literal|12
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x2b
argument_list|)
argument_list|,
name|backup_phy
index|[
literal|13
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_PGACTL
argument_list|,
name|backup_phy
index|[
literal|14
index|]
argument_list|)
expr_stmt|;
name|bwn_phy_g_set_bbatt
argument_list|(
name|mac
argument_list|,
name|backup_bband
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x52
argument_list|,
name|backup_radio
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x43
argument_list|,
name|backup_radio
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x7a
argument_list|,
name|backup_radio
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVER
argument_list|,
name|backup_phy
index|[
literal|2
index|]
operator||
literal|0x0003
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVER
argument_list|,
name|backup_phy
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVERVAL
argument_list|,
name|backup_phy
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CRS0
argument_list|,
name|backup_phy
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCKBBANDCFG
argument_list|,
name|backup_phy
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|pg
operator|->
name|pg_max_lb_gain
operator|=
operator|(
operator|(
name|loop1_inner_done
operator|*
literal|6
operator|)
operator|-
operator|(
name|loop1_outer_done
operator|*
literal|4
operator|)
operator|)
operator|-
literal|11
expr_stmt|;
name|pg
operator|->
name|pg_trsw_rx_gain
operator|=
name|trsw_rx
operator|*
literal|2
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|uint16_t
name|bwn_rf_init_bcm2050
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|uint32_t
name|tmp1
init|=
literal|0
decl_stmt|,
name|tmp2
init|=
literal|0
decl_stmt|;
name|uint16_t
name|rcc
decl_stmt|,
name|i
decl_stmt|,
name|j
decl_stmt|,
name|pgactl
decl_stmt|,
name|cck0
decl_stmt|,
name|cck1
decl_stmt|,
name|cck2
decl_stmt|,
name|cck3
decl_stmt|,
name|rfover
decl_stmt|,
name|rfoverval
decl_stmt|,
name|analogover
decl_stmt|,
name|analogoverval
decl_stmt|,
name|crs0
decl_stmt|,
name|classctl
decl_stmt|,
name|lomask
decl_stmt|,
name|loctl
decl_stmt|,
name|syncctl
decl_stmt|,
name|radio0
decl_stmt|,
name|radio1
decl_stmt|,
name|radio2
decl_stmt|,
name|reg0
decl_stmt|,
name|reg1
decl_stmt|,
name|reg2
decl_stmt|,
name|radio78
decl_stmt|,
name|reg
decl_stmt|,
name|index
decl_stmt|;
specifier|static
specifier|const
name|uint8_t
name|rcc_table
index|[]
init|=
block|{
literal|0x02
block|,
literal|0x03
block|,
literal|0x01
block|,
literal|0x0f
block|,
literal|0x06
block|,
literal|0x07
block|,
literal|0x05
block|,
literal|0x0f
block|,
literal|0x0a
block|,
literal|0x0b
block|,
literal|0x09
block|,
literal|0x0f
block|,
literal|0x0e
block|,
literal|0x0f
block|,
literal|0x0d
block|,
literal|0x0f
block|, 	}
decl_stmt|;
name|loctl
operator|=
name|lomask
operator|=
name|reg0
operator|=
name|classctl
operator|=
name|crs0
operator|=
name|analogoverval
operator|=
name|analogover
operator|=
name|rfoverval
operator|=
name|rfover
operator|=
name|cck3
operator|=
literal|0
expr_stmt|;
name|radio0
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
literal|0x43
argument_list|)
expr_stmt|;
name|radio1
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
literal|0x51
argument_list|)
expr_stmt|;
name|radio2
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
literal|0x52
argument_list|)
expr_stmt|;
name|pgactl
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_PGACTL
argument_list|)
expr_stmt|;
name|cck0
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x5a
argument_list|)
argument_list|)
expr_stmt|;
name|cck1
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x59
argument_list|)
argument_list|)
expr_stmt|;
name|cck2
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x58
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|type
operator|==
name|BWN_PHYTYPE_B
condition|)
block|{
name|cck3
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x30
argument_list|)
argument_list|)
expr_stmt|;
name|reg0
operator|=
name|BWN_READ_2
argument_list|(
name|mac
argument_list|,
literal|0x3ec
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x30
argument_list|)
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
literal|0x3ec
argument_list|,
literal|0x3f3f
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|phy
operator|->
name|gmode
operator|||
name|phy
operator|->
name|rev
operator|>=
literal|2
condition|)
block|{
name|rfover
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVER
argument_list|)
expr_stmt|;
name|rfoverval
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVERVAL
argument_list|)
expr_stmt|;
name|analogover
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_ANALOGOVER
argument_list|)
expr_stmt|;
name|analogoverval
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_ANALOGOVERVAL
argument_list|)
expr_stmt|;
name|crs0
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CRS0
argument_list|)
expr_stmt|;
name|classctl
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CLASSCTL
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_ANALOGOVER
argument_list|,
literal|0x0003
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_ANALOGOVERVAL
argument_list|,
literal|0xfffc
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CRS0
argument_list|,
literal|0x7fff
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CLASSCTL
argument_list|,
literal|0xfffc
argument_list|)
expr_stmt|;
if|if
condition|(
name|BWN_HAS_LOOPBACK
argument_list|(
name|phy
argument_list|)
condition|)
block|{
name|lomask
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_LO_MASK
argument_list|)
expr_stmt|;
name|loctl
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_LO_CTL
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|3
condition|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_LO_MASK
argument_list|,
literal|0xc020
argument_list|)
expr_stmt|;
else|else
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_LO_MASK
argument_list|,
literal|0x8020
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_LO_CTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVERVAL
argument_list|,
name|bwn_rf_2050_rfoverval
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVERVAL
argument_list|,
name|BWN_LPD
argument_list|(
literal|0
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVER
argument_list|,
name|bwn_rf_2050_rfoverval
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVER
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
literal|0x3e2
argument_list|,
name|BWN_READ_2
argument_list|(
name|mac
argument_list|,
literal|0x3e2
argument_list|)
operator||
literal|0x8000
argument_list|)
expr_stmt|;
name|syncctl
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_SYNCCTL
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_SYNCCTL
argument_list|,
literal|0xff7f
argument_list|)
expr_stmt|;
name|reg1
operator|=
name|BWN_READ_2
argument_list|(
name|mac
argument_list|,
literal|0x3e6
argument_list|)
expr_stmt|;
name|reg2
operator|=
name|BWN_READ_2
argument_list|(
name|mac
argument_list|,
literal|0x3f4
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|analog
operator|==
literal|0
condition|)
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
literal|0x03e6
argument_list|,
literal|0x0122
argument_list|)
expr_stmt|;
else|else
block|{
if|if
condition|(
name|phy
operator|->
name|analog
operator|>=
literal|2
condition|)
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x03
argument_list|)
argument_list|,
literal|0xffbf
argument_list|,
literal|0x40
argument_list|)
expr_stmt|;
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
name|BWN_CHANNEL_EXT
argument_list|,
operator|(
name|BWN_READ_2
argument_list|(
name|mac
argument_list|,
name|BWN_CHANNEL_EXT
argument_list|)
operator||
literal|0x2000
operator|)
argument_list|)
expr_stmt|;
block|}
name|reg
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
literal|0x60
argument_list|)
expr_stmt|;
name|index
operator|=
operator|(
name|reg
operator|&
literal|0x001e
operator|)
operator|>>
literal|1
expr_stmt|;
name|rcc
operator|=
operator|(
operator|(
operator|(
name|rcc_table
index|[
name|index
index|]
operator|<<
literal|1
operator|)
operator||
operator|(
name|reg
operator|&
literal|0x0001
operator|)
operator|)
operator||
literal|0x0020
operator|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|type
operator|==
name|BWN_PHYTYPE_B
condition|)
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x78
argument_list|,
literal|0x26
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|gmode
operator|||
name|phy
operator|->
name|rev
operator|>=
literal|2
condition|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVERVAL
argument_list|,
name|bwn_rf_2050_rfoverval
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVERVAL
argument_list|,
name|BWN_LPD
argument_list|(
literal|0
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_PGACTL
argument_list|,
literal|0xbfaf
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x2b
argument_list|)
argument_list|,
literal|0x1403
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|gmode
operator|||
name|phy
operator|->
name|rev
operator|>=
literal|2
condition|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVERVAL
argument_list|,
name|bwn_rf_2050_rfoverval
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVERVAL
argument_list|,
name|BWN_LPD
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_PGACTL
argument_list|,
literal|0xbfa0
argument_list|)
expr_stmt|;
name|BWN_RF_SET
argument_list|(
name|mac
argument_list|,
literal|0x51
argument_list|,
literal|0x0004
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rf_rev
operator|==
literal|8
condition|)
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x43
argument_list|,
literal|0x1f
argument_list|)
expr_stmt|;
else|else
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x52
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_RF_SETMASK
argument_list|(
name|mac
argument_list|,
literal|0x43
argument_list|,
literal|0xfff0
argument_list|,
literal|0x0009
argument_list|)
expr_stmt|;
block|}
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x58
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x5a
argument_list|)
argument_list|,
literal|0x0480
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x59
argument_list|)
argument_list|,
literal|0xc810
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x58
argument_list|)
argument_list|,
literal|0x000d
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|gmode
operator|||
name|phy
operator|->
name|rev
operator|>=
literal|2
condition|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVERVAL
argument_list|,
name|bwn_rf_2050_rfoverval
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVERVAL
argument_list|,
name|BWN_LPD
argument_list|(
literal|1
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_PGACTL
argument_list|,
literal|0xafb0
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|gmode
operator|||
name|phy
operator|->
name|rev
operator|>=
literal|2
condition|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVERVAL
argument_list|,
name|bwn_rf_2050_rfoverval
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVERVAL
argument_list|,
name|BWN_LPD
argument_list|(
literal|1
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_PGACTL
argument_list|,
literal|0xefb0
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|gmode
operator|||
name|phy
operator|->
name|rev
operator|>=
literal|2
condition|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVERVAL
argument_list|,
name|bwn_rf_2050_rfoverval
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVERVAL
argument_list|,
name|BWN_LPD
argument_list|(
literal|1
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_PGACTL
argument_list|,
literal|0xfff0
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|20
argument_list|)
expr_stmt|;
name|tmp1
operator|+=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_LO_LEAKAGE
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x58
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|gmode
operator|||
name|phy
operator|->
name|rev
operator|>=
literal|2
condition|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVERVAL
argument_list|,
name|bwn_rf_2050_rfoverval
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVERVAL
argument_list|,
name|BWN_LPD
argument_list|(
literal|1
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_PGACTL
argument_list|,
literal|0xafb0
argument_list|)
expr_stmt|;
block|}
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x58
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|tmp1
operator|++
expr_stmt|;
name|tmp1
operator|>>=
literal|9
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
block|{
name|radio78
operator|=
operator|(
name|BWN_BITREV4
argument_list|(
name|i
argument_list|)
operator|<<
literal|1
operator|)
operator||
literal|0x0020
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x78
argument_list|,
name|radio78
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|16
condition|;
name|j
operator|++
control|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x5a
argument_list|)
argument_list|,
literal|0x0d80
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x59
argument_list|)
argument_list|,
literal|0xc810
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x58
argument_list|)
argument_list|,
literal|0x000d
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|gmode
operator|||
name|phy
operator|->
name|rev
operator|>=
literal|2
condition|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVERVAL
argument_list|,
name|bwn_rf_2050_rfoverval
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVERVAL
argument_list|,
name|BWN_LPD
argument_list|(
literal|1
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_PGACTL
argument_list|,
literal|0xafb0
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|gmode
operator|||
name|phy
operator|->
name|rev
operator|>=
literal|2
condition|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVERVAL
argument_list|,
name|bwn_rf_2050_rfoverval
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVERVAL
argument_list|,
name|BWN_LPD
argument_list|(
literal|1
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_PGACTL
argument_list|,
literal|0xefb0
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|gmode
operator|||
name|phy
operator|->
name|rev
operator|>=
literal|2
condition|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVERVAL
argument_list|,
name|bwn_rf_2050_rfoverval
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVERVAL
argument_list|,
name|BWN_LPD
argument_list|(
literal|1
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_PGACTL
argument_list|,
literal|0xfff0
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|tmp2
operator|+=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_LO_LEAKAGE
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x58
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|gmode
operator|||
name|phy
operator|->
name|rev
operator|>=
literal|2
condition|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVERVAL
argument_list|,
name|bwn_rf_2050_rfoverval
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVERVAL
argument_list|,
name|BWN_LPD
argument_list|(
literal|1
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_PGACTL
argument_list|,
literal|0xafb0
argument_list|)
expr_stmt|;
block|}
name|tmp2
operator|++
expr_stmt|;
name|tmp2
operator|>>=
literal|8
expr_stmt|;
if|if
condition|(
name|tmp1
operator|<
name|tmp2
condition|)
break|break;
block|}
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_PGACTL
argument_list|,
name|pgactl
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x51
argument_list|,
name|radio1
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x52
argument_list|,
name|radio2
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x43
argument_list|,
name|radio0
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x5a
argument_list|)
argument_list|,
name|cck0
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x59
argument_list|)
argument_list|,
name|cck1
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x58
argument_list|)
argument_list|,
name|cck2
argument_list|)
expr_stmt|;
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
literal|0x3e6
argument_list|,
name|reg1
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|analog
operator|!=
literal|0
condition|)
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
literal|0x3f4
argument_list|,
name|reg2
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_SYNCCTL
argument_list|,
name|syncctl
argument_list|)
expr_stmt|;
name|bwn_spu_workaround
argument_list|(
name|mac
argument_list|,
name|phy
operator|->
name|chan
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|type
operator|==
name|BWN_PHYTYPE_B
condition|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x30
argument_list|)
argument_list|,
name|cck3
argument_list|)
expr_stmt|;
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
literal|0x3ec
argument_list|,
name|reg0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|phy
operator|->
name|gmode
condition|)
block|{
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RADIO
argument_list|,
name|BWN_READ_2
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RADIO
argument_list|)
operator|&
literal|0x7fff
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVER
argument_list|,
name|rfover
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVERVAL
argument_list|,
name|rfoverval
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_ANALOGOVER
argument_list|,
name|analogover
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_ANALOGOVERVAL
argument_list|,
name|analogoverval
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CRS0
argument_list|,
name|crs0
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CLASSCTL
argument_list|,
name|classctl
argument_list|)
expr_stmt|;
if|if
condition|(
name|BWN_HAS_LOOPBACK
argument_list|(
name|phy
argument_list|)
condition|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_LO_MASK
argument_list|,
name|lomask
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_LO_CTL
argument_list|,
name|loctl
argument_list|)
expr_stmt|;
block|}
block|}
return|return
operator|(
operator|(
name|i
operator|>
literal|15
operator|)
condition|?
name|radio78
else|:
name|rcc
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_phy_init_b6
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwn_phy_g
modifier|*
name|pg
init|=
operator|&
name|phy
operator|->
name|phy_g
decl_stmt|;
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|uint16_t
name|offset
decl_stmt|,
name|val
decl_stmt|;
name|uint8_t
name|old_channel
decl_stmt|;
name|KASSERT
argument_list|(
operator|!
operator|(
name|phy
operator|->
name|rf_rev
operator|==
literal|6
operator|||
name|phy
operator|->
name|rf_rev
operator|==
literal|7
operator|)
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x003e
argument_list|,
literal|0x817a
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x007a
argument_list|,
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
literal|0x007a
argument_list|)
operator||
literal|0x0058
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rf_rev
operator|==
literal|4
operator|||
name|phy
operator|->
name|rf_rev
operator|==
literal|5
condition|)
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x51
argument_list|,
literal|0x37
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x52
argument_list|,
literal|0x70
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x53
argument_list|,
literal|0xb3
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x54
argument_list|,
literal|0x9b
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x5a
argument_list|,
literal|0x88
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x5b
argument_list|,
literal|0x88
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x5d
argument_list|,
literal|0x88
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x5e
argument_list|,
literal|0x88
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x7d
argument_list|,
literal|0x88
argument_list|)
expr_stmt|;
name|bwn_hf_write
argument_list|(
name|mac
argument_list|,
name|bwn_hf_read
argument_list|(
name|mac
argument_list|)
operator||
name|BWN_HF_TSSI_RESET_PSM_WORKAROUN
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|phy
operator|->
name|rf_rev
operator|==
literal|8
condition|)
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x51
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x52
argument_list|,
literal|0x40
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x53
argument_list|,
literal|0xb7
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x54
argument_list|,
literal|0x98
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x5a
argument_list|,
literal|0x88
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x5b
argument_list|,
literal|0x6b
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x5c
argument_list|,
literal|0x0f
argument_list|)
expr_stmt|;
if|if
condition|(
name|siba_sprom_get_bf_lo
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|&
name|BWN_BFL_ALTIQ
condition|)
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x5d
argument_list|,
literal|0xfa
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x5e
argument_list|,
literal|0xd8
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x5d
argument_list|,
literal|0xf5
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x5e
argument_list|,
literal|0xb8
argument_list|)
expr_stmt|;
block|}
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x0073
argument_list|,
literal|0x0003
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x007d
argument_list|,
literal|0x00a8
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x007c
argument_list|,
literal|0x0001
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x007e
argument_list|,
literal|0x0008
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|val
operator|=
literal|0x1e1f
operator|,
name|offset
operator|=
literal|0x0088
init|;
name|offset
operator|<
literal|0x0098
condition|;
name|offset
operator|++
control|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|offset
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|val
operator|-=
literal|0x0202
expr_stmt|;
block|}
for|for
control|(
name|val
operator|=
literal|0x3e3f
operator|,
name|offset
operator|=
literal|0x0098
init|;
name|offset
operator|<
literal|0x00a8
condition|;
name|offset
operator|++
control|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|offset
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|val
operator|-=
literal|0x0202
expr_stmt|;
block|}
for|for
control|(
name|val
operator|=
literal|0x2120
operator|,
name|offset
operator|=
literal|0x00a8
init|;
name|offset
operator|<
literal|0x00c8
condition|;
name|offset
operator|++
control|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|offset
argument_list|,
operator|(
name|val
operator|&
literal|0x3f3f
operator|)
argument_list|)
expr_stmt|;
name|val
operator|+=
literal|0x0202
expr_stmt|;
block|}
if|if
condition|(
name|phy
operator|->
name|type
operator|==
name|BWN_PHYTYPE_G
condition|)
block|{
name|BWN_RF_SET
argument_list|(
name|mac
argument_list|,
literal|0x007a
argument_list|,
literal|0x0020
argument_list|)
expr_stmt|;
name|BWN_RF_SET
argument_list|(
name|mac
argument_list|,
literal|0x0051
argument_list|,
literal|0x0004
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
literal|0x0802
argument_list|,
literal|0x0100
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
literal|0x042b
argument_list|,
literal|0x2000
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x5b
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x5c
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|old_channel
operator|=
name|phy
operator|->
name|chan
expr_stmt|;
name|bwn_phy_g_switch_chan
argument_list|(
name|mac
argument_list|,
operator|(
name|old_channel
operator|>=
literal|8
operator|)
condition|?
literal|1
else|:
literal|13
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x0050
argument_list|,
literal|0x0020
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x0050
argument_list|,
literal|0x0023
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|40
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rf_rev
operator|<
literal|6
operator|||
name|phy
operator|->
name|rf_rev
operator|==
literal|8
condition|)
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x7c
argument_list|,
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
literal|0x7c
argument_list|)
operator||
literal|0x0002
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x50
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|phy
operator|->
name|rf_rev
operator|<=
literal|2
condition|)
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x7c
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x5a
argument_list|,
literal|0x70
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x5b
argument_list|,
literal|0x7b
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x5c
argument_list|,
literal|0xb0
argument_list|)
expr_stmt|;
block|}
name|BWN_RF_SETMASK
argument_list|(
name|mac
argument_list|,
literal|0x007a
argument_list|,
literal|0x00f8
argument_list|,
literal|0x0007
argument_list|)
expr_stmt|;
name|bwn_phy_g_switch_chan
argument_list|(
name|mac
argument_list|,
name|old_channel
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x0014
argument_list|,
literal|0x0200
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rf_rev
operator|>=
literal|6
condition|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x2a
argument_list|,
literal|0x88c2
argument_list|)
expr_stmt|;
else|else
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x2a
argument_list|,
literal|0x8ac0
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x0038
argument_list|,
literal|0x0668
argument_list|)
expr_stmt|;
name|bwn_phy_g_set_txpwr_sub
argument_list|(
name|mac
argument_list|,
operator|&
name|pg
operator|->
name|pg_bbatt
argument_list|,
operator|&
name|pg
operator|->
name|pg_rfatt
argument_list|,
name|pg
operator|->
name|pg_txctl
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rf_rev
operator|<=
literal|5
condition|)
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
literal|0x5d
argument_list|,
literal|0xff80
argument_list|,
literal|0x0003
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rf_rev
operator|<=
literal|2
condition|)
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x005d
argument_list|,
literal|0x000d
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|analog
operator|==
literal|4
condition|)
block|{
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
literal|0x3e4
argument_list|,
literal|9
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
literal|0x61
argument_list|,
literal|0x0fff
argument_list|)
expr_stmt|;
block|}
else|else
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
literal|0x0002
argument_list|,
literal|0xffc0
argument_list|,
literal|0x0004
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|type
operator|==
name|BWN_PHYTYPE_B
condition|)
name|KASSERT
argument_list|(
literal|0
operator|==
literal|1
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|phy
operator|->
name|type
operator|==
name|BWN_PHYTYPE_G
condition|)
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
literal|0x03e6
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_phy_init_a
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|KASSERT
argument_list|(
name|phy
operator|->
name|type
operator|==
name|BWN_PHYTYPE_A
operator|||
name|phy
operator|->
name|type
operator|==
name|BWN_PHYTYPE_G
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|6
condition|)
block|{
if|if
condition|(
name|phy
operator|->
name|type
operator|==
name|BWN_PHYTYPE_A
condition|)
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_OFDM
argument_list|(
literal|0x1b
argument_list|)
argument_list|,
operator|~
literal|0x1000
argument_list|)
expr_stmt|;
if|if
condition|(
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_ENCORE
argument_list|)
operator|&
name|BWN_PHY_ENCORE_EN
condition|)
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_ENCORE
argument_list|,
literal|0x0010
argument_list|)
expr_stmt|;
else|else
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_ENCORE
argument_list|,
operator|~
literal|0x1010
argument_list|)
expr_stmt|;
block|}
name|bwn_wa_init
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|type
operator|==
name|BWN_PHYTYPE_G
operator|&&
operator|(
name|siba_sprom_get_bf_lo
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|&
name|BWN_BFL_PACTRL
operator|)
condition|)
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_OFDM
argument_list|(
literal|0x6e
argument_list|)
argument_list|,
literal|0xe000
argument_list|,
literal|0x3cf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_wa_write_noisescale
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
specifier|const
name|uint16_t
modifier|*
name|nst
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|BWN_TAB_NOISESCALE_SIZE
condition|;
name|i
operator|++
control|)
name|bwn_ofdmtab_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_OFDMTAB_NOISESCALE
argument_list|,
name|i
argument_list|,
name|nst
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_wa_agc
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|==
literal|1
condition|)
block|{
name|bwn_ofdmtab_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_OFDMTAB_AGC1_R1
argument_list|,
literal|0
argument_list|,
literal|254
argument_list|)
expr_stmt|;
name|bwn_ofdmtab_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_OFDMTAB_AGC1_R1
argument_list|,
literal|1
argument_list|,
literal|13
argument_list|)
expr_stmt|;
name|bwn_ofdmtab_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_OFDMTAB_AGC1_R1
argument_list|,
literal|2
argument_list|,
literal|19
argument_list|)
expr_stmt|;
name|bwn_ofdmtab_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_OFDMTAB_AGC1_R1
argument_list|,
literal|3
argument_list|,
literal|25
argument_list|)
expr_stmt|;
name|bwn_ofdmtab_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_OFDMTAB_AGC2
argument_list|,
literal|0
argument_list|,
literal|0x2710
argument_list|)
expr_stmt|;
name|bwn_ofdmtab_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_OFDMTAB_AGC2
argument_list|,
literal|1
argument_list|,
literal|0x9b83
argument_list|)
expr_stmt|;
name|bwn_ofdmtab_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_OFDMTAB_AGC2
argument_list|,
literal|2
argument_list|,
literal|0x9b83
argument_list|)
expr_stmt|;
name|bwn_ofdmtab_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_OFDMTAB_AGC2
argument_list|,
literal|3
argument_list|,
literal|0x0f8d
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_LMS
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|bwn_ofdmtab_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_OFDMTAB_AGC1
argument_list|,
literal|0
argument_list|,
literal|254
argument_list|)
expr_stmt|;
name|bwn_ofdmtab_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_OFDMTAB_AGC1
argument_list|,
literal|1
argument_list|,
literal|13
argument_list|)
expr_stmt|;
name|bwn_ofdmtab_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_OFDMTAB_AGC1
argument_list|,
literal|2
argument_list|,
literal|19
argument_list|)
expr_stmt|;
name|bwn_ofdmtab_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_OFDMTAB_AGC1
argument_list|,
literal|3
argument_list|,
literal|25
argument_list|)
expr_stmt|;
block|}
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCKSHIFTBITS_WA
argument_list|,
operator|(
name|uint16_t
operator|)
operator|~
literal|0xff00
argument_list|,
literal|0x5700
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_OFDM
argument_list|(
literal|0x1a
argument_list|)
argument_list|,
operator|~
literal|0x007f
argument_list|,
literal|0x000f
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_OFDM
argument_list|(
literal|0x1a
argument_list|)
argument_list|,
operator|~
literal|0x3f80
argument_list|,
literal|0x2b80
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_ANTWRSETT
argument_list|,
literal|0xf0ff
argument_list|,
literal|0x0300
argument_list|)
expr_stmt|;
name|BWN_RF_SET
argument_list|(
name|mac
argument_list|,
literal|0x7a
argument_list|,
literal|0x0008
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_N1P1GAIN
argument_list|,
operator|~
literal|0x000f
argument_list|,
literal|0x0008
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_P1P2GAIN
argument_list|,
operator|~
literal|0x0f00
argument_list|,
literal|0x0600
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_N1N2GAIN
argument_list|,
operator|~
literal|0x0f00
argument_list|,
literal|0x0700
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_N1P1GAIN
argument_list|,
operator|~
literal|0x0f00
argument_list|,
literal|0x0100
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|==
literal|1
condition|)
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_N1N2GAIN
argument_list|,
operator|~
literal|0x000f
argument_list|,
literal|0x0007
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_OFDM
argument_list|(
literal|0x88
argument_list|)
argument_list|,
operator|~
literal|0x00ff
argument_list|,
literal|0x001c
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_OFDM
argument_list|(
literal|0x88
argument_list|)
argument_list|,
operator|~
literal|0x3f00
argument_list|,
literal|0x0200
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_OFDM
argument_list|(
literal|0x96
argument_list|)
argument_list|,
operator|~
literal|0x00ff
argument_list|,
literal|0x001c
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_OFDM
argument_list|(
literal|0x89
argument_list|)
argument_list|,
operator|~
literal|0x00ff
argument_list|,
literal|0x0020
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_OFDM
argument_list|(
literal|0x89
argument_list|)
argument_list|,
operator|~
literal|0x3f00
argument_list|,
literal|0x0200
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_OFDM
argument_list|(
literal|0x82
argument_list|)
argument_list|,
operator|~
literal|0x00ff
argument_list|,
literal|0x002e
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_OFDM
argument_list|(
literal|0x96
argument_list|)
argument_list|,
operator|(
name|uint16_t
operator|)
operator|~
literal|0xff00
argument_list|,
literal|0x1a00
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_OFDM
argument_list|(
literal|0x81
argument_list|)
argument_list|,
operator|~
literal|0x00ff
argument_list|,
literal|0x0028
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_OFDM
argument_list|(
literal|0x81
argument_list|)
argument_list|,
operator|(
name|uint16_t
operator|)
operator|~
literal|0xff00
argument_list|,
literal|0x2c00
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|==
literal|1
condition|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_PEAK_COUNT
argument_list|,
literal|0x092b
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_OFDM
argument_list|(
literal|0x1b
argument_list|)
argument_list|,
operator|~
literal|0x001e
argument_list|,
literal|0x0002
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_OFDM
argument_list|(
literal|0x1b
argument_list|)
argument_list|,
operator|~
literal|0x001e
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_OFDM
argument_list|(
literal|0x1f
argument_list|)
argument_list|,
literal|0x287a
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_LPFGAINCTL
argument_list|,
operator|~
literal|0x000f
argument_list|,
literal|0x0004
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|6
condition|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_OFDM
argument_list|(
literal|0x22
argument_list|)
argument_list|,
literal|0x287a
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_LPFGAINCTL
argument_list|,
operator|(
name|uint16_t
operator|)
operator|~
literal|0xf000
argument_list|,
literal|0x3000
argument_list|)
expr_stmt|;
block|}
block|}
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_DIVSRCHIDX
argument_list|,
literal|0x8080
argument_list|,
literal|0x7874
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_OFDM
argument_list|(
literal|0x8e
argument_list|)
argument_list|,
literal|0x1c00
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|==
literal|1
condition|)
block|{
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_DIVP1P2GAIN
argument_list|,
operator|~
literal|0x0f00
argument_list|,
literal|0x0600
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_OFDM
argument_list|(
literal|0x8b
argument_list|)
argument_list|,
literal|0x005e
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_ANTWRSETT
argument_list|,
operator|~
literal|0x00ff
argument_list|,
literal|0x001e
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_OFDM
argument_list|(
literal|0x8d
argument_list|)
argument_list|,
literal|0x0002
argument_list|)
expr_stmt|;
name|bwn_ofdmtab_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_OFDMTAB_AGC3_R1
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bwn_ofdmtab_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_OFDMTAB_AGC3_R1
argument_list|,
literal|1
argument_list|,
literal|7
argument_list|)
expr_stmt|;
name|bwn_ofdmtab_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_OFDMTAB_AGC3_R1
argument_list|,
literal|2
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|bwn_ofdmtab_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_OFDMTAB_AGC3_R1
argument_list|,
literal|3
argument_list|,
literal|28
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|bwn_ofdmtab_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_OFDMTAB_AGC3
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bwn_ofdmtab_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_OFDMTAB_AGC3
argument_list|,
literal|1
argument_list|,
literal|7
argument_list|)
expr_stmt|;
name|bwn_ofdmtab_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_OFDMTAB_AGC3
argument_list|,
literal|2
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|bwn_ofdmtab_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_OFDMTAB_AGC3
argument_list|,
literal|3
argument_list|,
literal|28
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|6
condition|)
block|{
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_OFDM
argument_list|(
literal|0x26
argument_list|)
argument_list|,
operator|~
literal|0x0003
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_OFDM
argument_list|(
literal|0x26
argument_list|)
argument_list|,
operator|~
literal|0x1000
argument_list|)
expr_stmt|;
block|}
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_VERSION_OFDM
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_wa_grev1
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|int
name|i
decl_stmt|;
specifier|static
specifier|const
name|uint16_t
name|bwn_tab_finefreqg
index|[]
init|=
name|BWN_TAB_FINEFREQ_G
decl_stmt|;
specifier|static
specifier|const
name|uint32_t
name|bwn_tab_retard
index|[]
init|=
name|BWN_TAB_RETARD
decl_stmt|;
specifier|static
specifier|const
name|uint32_t
name|bwn_tab_rotor
index|[]
init|=
name|BWN_TAB_ROTOR
decl_stmt|;
name|KASSERT
argument_list|(
name|phy
operator|->
name|type
operator|==
name|BWN_PHYTYPE_G
argument_list|,
operator|(
literal|"%s fail"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
comment|/* init CRSTHRES and ANTDWELL */
if|if
condition|(
name|phy
operator|->
name|rev
operator|==
literal|1
condition|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CRSTHRES1_R1
argument_list|,
literal|0x4f19
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|phy
operator|->
name|rev
operator|==
literal|2
condition|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CRSTHRES1
argument_list|,
literal|0x1861
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CRSTHRES2
argument_list|,
literal|0x0271
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_ANTDWELL
argument_list|,
literal|0x0800
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CRSTHRES1
argument_list|,
literal|0x0098
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CRSTHRES2
argument_list|,
literal|0x0070
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_OFDM
argument_list|(
literal|0xc9
argument_list|)
argument_list|,
literal|0x0080
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_ANTDWELL
argument_list|,
literal|0x0800
argument_list|)
expr_stmt|;
block|}
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CRS0
argument_list|,
operator|~
literal|0x03c0
argument_list|,
literal|0xd000
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_OFDM
argument_list|(
literal|0x2c
argument_list|)
argument_list|,
literal|0x005a
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCKSHIFTBITS
argument_list|,
literal|0x0026
argument_list|)
expr_stmt|;
comment|/* XXX support PHY-A??? */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|N
argument_list|(
name|bwn_tab_finefreqg
argument_list|)
condition|;
name|i
operator|++
control|)
name|bwn_ofdmtab_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_OFDMTAB_DACRFPABB
argument_list|,
name|i
argument_list|,
name|bwn_tab_finefreqg
index|[
name|i
index|]
argument_list|)
expr_stmt|;
comment|/* XXX support PHY-A??? */
if|if
condition|(
name|phy
operator|->
name|rev
operator|==
literal|1
condition|)
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|N
argument_list|(
name|bwn_tab_noise_g1
argument_list|)
condition|;
name|i
operator|++
control|)
name|bwn_ofdmtab_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_OFDMTAB_AGC2
argument_list|,
name|i
argument_list|,
name|bwn_tab_noise_g1
index|[
name|i
index|]
argument_list|)
expr_stmt|;
else|else
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|N
argument_list|(
name|bwn_tab_noise_g2
argument_list|)
condition|;
name|i
operator|++
control|)
name|bwn_ofdmtab_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_OFDMTAB_AGC2
argument_list|,
name|i
argument_list|,
name|bwn_tab_noise_g2
index|[
name|i
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|N
argument_list|(
name|bwn_tab_rotor
argument_list|)
condition|;
name|i
operator|++
control|)
name|bwn_ofdmtab_write_4
argument_list|(
name|mac
argument_list|,
name|BWN_OFDMTAB_ROTOR
argument_list|,
name|i
argument_list|,
name|bwn_tab_rotor
index|[
name|i
index|]
argument_list|)
expr_stmt|;
comment|/* XXX support PHY-A??? */
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|6
condition|)
block|{
if|if
condition|(
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_ENCORE
argument_list|)
operator|&
name|BWN_PHY_ENCORE_EN
condition|)
name|bwn_wa_write_noisescale
argument_list|(
name|mac
argument_list|,
name|bwn_tab_noisescale_g3
argument_list|)
expr_stmt|;
else|else
name|bwn_wa_write_noisescale
argument_list|(
name|mac
argument_list|,
name|bwn_tab_noisescale_g2
argument_list|)
expr_stmt|;
block|}
else|else
name|bwn_wa_write_noisescale
argument_list|(
name|mac
argument_list|,
name|bwn_tab_noisescale_g1
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|N
argument_list|(
name|bwn_tab_retard
argument_list|)
condition|;
name|i
operator|++
control|)
name|bwn_ofdmtab_write_4
argument_list|(
name|mac
argument_list|,
name|BWN_OFDMTAB_ADVRETARD
argument_list|,
name|i
argument_list|,
name|bwn_tab_retard
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|==
literal|1
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
name|bwn_ofdmtab_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_OFDMTAB_WRSSI_R1
argument_list|,
name|i
argument_list|,
literal|0x0020
argument_list|)
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
name|bwn_ofdmtab_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_OFDMTAB_WRSSI
argument_list|,
name|i
argument_list|,
literal|0x0820
argument_list|)
expr_stmt|;
block|}
name|bwn_wa_agc
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_wa_grev26789
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|int
name|i
decl_stmt|;
specifier|static
specifier|const
name|uint16_t
name|bwn_tab_sigmasqr2
index|[]
init|=
name|BWN_TAB_SIGMASQR2
decl_stmt|;
name|uint16_t
name|ofdmrev
decl_stmt|;
name|KASSERT
argument_list|(
name|phy
operator|->
name|type
operator|==
name|BWN_PHYTYPE_G
argument_list|,
operator|(
literal|"%s fail"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
name|bwn_gtab_write
argument_list|(
name|mac
argument_list|,
name|BWN_GTAB_ORIGTR
argument_list|,
literal|0
argument_list|,
literal|0xc480
argument_list|)
expr_stmt|;
comment|/* init CRSTHRES and ANTDWELL */
if|if
condition|(
name|phy
operator|->
name|rev
operator|==
literal|1
condition|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CRSTHRES1_R1
argument_list|,
literal|0x4f19
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|phy
operator|->
name|rev
operator|==
literal|2
condition|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CRSTHRES1
argument_list|,
literal|0x1861
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CRSTHRES2
argument_list|,
literal|0x0271
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_ANTDWELL
argument_list|,
literal|0x0800
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CRSTHRES1
argument_list|,
literal|0x0098
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CRSTHRES2
argument_list|,
literal|0x0070
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_OFDM
argument_list|(
literal|0xc9
argument_list|)
argument_list|,
literal|0x0080
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_ANTDWELL
argument_list|,
literal|0x0800
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|64
condition|;
name|i
operator|++
control|)
name|bwn_ofdmtab_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_OFDMTAB_RSSI
argument_list|,
name|i
argument_list|,
name|i
argument_list|)
expr_stmt|;
comment|/* XXX support PHY-A??? */
if|if
condition|(
name|phy
operator|->
name|rev
operator|==
literal|1
condition|)
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|N
argument_list|(
name|bwn_tab_noise_g1
argument_list|)
condition|;
name|i
operator|++
control|)
name|bwn_ofdmtab_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_OFDMTAB_AGC2
argument_list|,
name|i
argument_list|,
name|bwn_tab_noise_g1
index|[
name|i
index|]
argument_list|)
expr_stmt|;
else|else
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|N
argument_list|(
name|bwn_tab_noise_g2
argument_list|)
condition|;
name|i
operator|++
control|)
name|bwn_ofdmtab_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_OFDMTAB_AGC2
argument_list|,
name|i
argument_list|,
name|bwn_tab_noise_g2
index|[
name|i
index|]
argument_list|)
expr_stmt|;
comment|/* XXX support PHY-A??? */
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|6
condition|)
block|{
if|if
condition|(
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_ENCORE
argument_list|)
operator|&
name|BWN_PHY_ENCORE_EN
condition|)
name|bwn_wa_write_noisescale
argument_list|(
name|mac
argument_list|,
name|bwn_tab_noisescale_g3
argument_list|)
expr_stmt|;
else|else
name|bwn_wa_write_noisescale
argument_list|(
name|mac
argument_list|,
name|bwn_tab_noisescale_g2
argument_list|)
expr_stmt|;
block|}
else|else
name|bwn_wa_write_noisescale
argument_list|(
name|mac
argument_list|,
name|bwn_tab_noisescale_g1
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|N
argument_list|(
name|bwn_tab_sigmasqr2
argument_list|)
condition|;
name|i
operator|++
control|)
name|bwn_ofdmtab_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_OFDMTAB_MINSIGSQ
argument_list|,
name|i
argument_list|,
name|bwn_tab_sigmasqr2
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|==
literal|1
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
name|bwn_ofdmtab_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_OFDMTAB_WRSSI_R1
argument_list|,
name|i
argument_list|,
literal|0x0020
argument_list|)
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
name|bwn_ofdmtab_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_OFDMTAB_WRSSI
argument_list|,
name|i
argument_list|,
literal|0x0820
argument_list|)
expr_stmt|;
block|}
name|bwn_wa_agc
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|ofdmrev
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_VERSION_OFDM
argument_list|)
operator|&
name|BWN_PHYVER_VERSION
expr_stmt|;
if|if
condition|(
name|ofdmrev
operator|>
literal|2
condition|)
block|{
if|if
condition|(
name|phy
operator|->
name|type
operator|==
name|BWN_PHYTYPE_A
condition|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_PWRDOWN
argument_list|,
literal|0x1808
argument_list|)
expr_stmt|;
else|else
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_PWRDOWN
argument_list|,
literal|0x1000
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|bwn_ofdmtab_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_OFDMTAB_DAC
argument_list|,
literal|3
argument_list|,
literal|0x1044
argument_list|)
expr_stmt|;
name|bwn_ofdmtab_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_OFDMTAB_DAC
argument_list|,
literal|4
argument_list|,
literal|0x7201
argument_list|)
expr_stmt|;
name|bwn_ofdmtab_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_OFDMTAB_DAC
argument_list|,
literal|6
argument_list|,
literal|0x0040
argument_list|)
expr_stmt|;
block|}
name|bwn_ofdmtab_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_OFDMTAB_UNKNOWN_0F
argument_list|,
literal|2
argument_list|,
literal|15
argument_list|)
expr_stmt|;
name|bwn_ofdmtab_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_OFDMTAB_UNKNOWN_0F
argument_list|,
literal|3
argument_list|,
literal|20
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_wa_init
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|KASSERT
argument_list|(
name|phy
operator|->
name|type
operator|==
name|BWN_PHYTYPE_G
argument_list|,
operator|(
literal|"%s fail"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|phy
operator|->
name|rev
condition|)
block|{
case|case
literal|1
case|:
name|bwn_wa_grev1
argument_list|(
name|mac
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
case|case
literal|6
case|:
case|case
literal|7
case|:
case|case
literal|8
case|:
case|case
literal|9
case|:
name|bwn_wa_grev26789
argument_list|(
name|mac
argument_list|)
expr_stmt|;
break|break;
default|default:
name|KASSERT
argument_list|(
literal|0
operator|==
literal|1
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|siba_get_pci_subvendor
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|!=
name|SIBA_BOARDVENDOR_BCM
operator|||
name|siba_get_pci_subdevice
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|!=
name|SIBA_BOARD_BU4306
operator|||
name|siba_get_pci_revid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|!=
literal|0x17
condition|)
block|{
if|if
condition|(
name|phy
operator|->
name|rev
operator|<
literal|2
condition|)
block|{
name|bwn_ofdmtab_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_OFDMTAB_GAINX_R1
argument_list|,
literal|1
argument_list|,
literal|0x0002
argument_list|)
expr_stmt|;
name|bwn_ofdmtab_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_OFDMTAB_GAINX_R1
argument_list|,
literal|2
argument_list|,
literal|0x0001
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|bwn_ofdmtab_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_OFDMTAB_GAINX
argument_list|,
literal|1
argument_list|,
literal|0x0002
argument_list|)
expr_stmt|;
name|bwn_ofdmtab_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_OFDMTAB_GAINX
argument_list|,
literal|2
argument_list|,
literal|0x0001
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|siba_sprom_get_bf_lo
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|&
name|BWN_BFL_EXTLNA
operator|)
operator|&&
operator|(
name|phy
operator|->
name|rev
operator|>=
literal|7
operator|)
condition|)
block|{
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_EXTG
argument_list|(
literal|0x11
argument_list|)
argument_list|,
literal|0xf7ff
argument_list|)
expr_stmt|;
name|bwn_ofdmtab_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_OFDMTAB_GAINX
argument_list|,
literal|0x0020
argument_list|,
literal|0x0001
argument_list|)
expr_stmt|;
name|bwn_ofdmtab_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_OFDMTAB_GAINX
argument_list|,
literal|0x0021
argument_list|,
literal|0x0001
argument_list|)
expr_stmt|;
name|bwn_ofdmtab_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_OFDMTAB_GAINX
argument_list|,
literal|0x0022
argument_list|,
literal|0x0001
argument_list|)
expr_stmt|;
name|bwn_ofdmtab_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_OFDMTAB_GAINX
argument_list|,
literal|0x0023
argument_list|,
literal|0x0000
argument_list|)
expr_stmt|;
name|bwn_ofdmtab_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_OFDMTAB_GAINX
argument_list|,
literal|0x0000
argument_list|,
literal|0x0000
argument_list|)
expr_stmt|;
name|bwn_ofdmtab_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_OFDMTAB_GAINX
argument_list|,
literal|0x0003
argument_list|,
literal|0x0002
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|siba_sprom_get_bf_lo
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|&
name|BWN_BFL_FEM
condition|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_GTABCTL
argument_list|,
literal|0x3120
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_GTABDATA
argument_list|,
literal|0xc480
argument_list|)
expr_stmt|;
block|}
name|bwn_ofdmtab_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_OFDMTAB_UNKNOWN_11
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bwn_ofdmtab_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_OFDMTAB_UNKNOWN_11
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_ofdmtab_write_2
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint16_t
name|table
parameter_list|,
name|uint16_t
name|offset
parameter_list|,
name|uint16_t
name|value
parameter_list|)
block|{
name|struct
name|bwn_phy_g
modifier|*
name|pg
init|=
operator|&
name|mac
operator|->
name|mac_phy
operator|.
name|phy_g
decl_stmt|;
name|uint16_t
name|addr
decl_stmt|;
name|addr
operator|=
name|table
operator|+
name|offset
expr_stmt|;
if|if
condition|(
operator|(
name|pg
operator|->
name|pg_ofdmtab_dir
operator|!=
name|BWN_OFDMTAB_DIR_WRITE
operator|)
operator|||
operator|(
name|addr
operator|-
literal|1
operator|!=
name|pg
operator|->
name|pg_ofdmtab_addr
operator|)
condition|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_OTABLECTL
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|pg
operator|->
name|pg_ofdmtab_dir
operator|=
name|BWN_OFDMTAB_DIR_WRITE
expr_stmt|;
block|}
name|pg
operator|->
name|pg_ofdmtab_addr
operator|=
name|addr
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_OTABLEI
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_ofdmtab_write_4
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint16_t
name|table
parameter_list|,
name|uint16_t
name|offset
parameter_list|,
name|uint32_t
name|value
parameter_list|)
block|{
name|struct
name|bwn_phy_g
modifier|*
name|pg
init|=
operator|&
name|mac
operator|->
name|mac_phy
operator|.
name|phy_g
decl_stmt|;
name|uint16_t
name|addr
decl_stmt|;
name|addr
operator|=
name|table
operator|+
name|offset
expr_stmt|;
if|if
condition|(
operator|(
name|pg
operator|->
name|pg_ofdmtab_dir
operator|!=
name|BWN_OFDMTAB_DIR_WRITE
operator|)
operator|||
operator|(
name|addr
operator|-
literal|1
operator|!=
name|pg
operator|->
name|pg_ofdmtab_addr
operator|)
condition|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_OTABLECTL
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|pg
operator|->
name|pg_ofdmtab_dir
operator|=
name|BWN_OFDMTAB_DIR_WRITE
expr_stmt|;
block|}
name|pg
operator|->
name|pg_ofdmtab_addr
operator|=
name|addr
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_OTABLEI
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_OTABLEQ
argument_list|,
operator|(
name|value
operator|>>
literal|16
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_gtab_write
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint16_t
name|table
parameter_list|,
name|uint16_t
name|offset
parameter_list|,
name|uint16_t
name|value
parameter_list|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_GTABCTL
argument_list|,
name|table
operator|+
name|offset
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_GTABDATA
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_lo_write
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|struct
name|bwn_loctl
modifier|*
name|ctl
parameter_list|)
block|{
name|uint16_t
name|value
decl_stmt|;
name|KASSERT
argument_list|(
name|mac
operator|->
name|mac_phy
operator|.
name|type
operator|==
name|BWN_PHYTYPE_G
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
name|value
operator|=
call|(
name|uint8_t
call|)
argument_list|(
name|ctl
operator|->
name|q
argument_list|)
expr_stmt|;
name|value
operator||=
operator|(
call|(
name|uint8_t
call|)
argument_list|(
name|ctl
operator|->
name|i
argument_list|)
operator|)
operator|<<
literal|8
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_LO_CTL
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|uint16_t
name|bwn_lo_calcfeed
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint16_t
name|lna
parameter_list|,
name|uint16_t
name|pga
parameter_list|,
name|uint16_t
name|trsw_rx
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|uint16_t
name|rfover
decl_stmt|;
name|uint16_t
name|feedthrough
decl_stmt|;
if|if
condition|(
name|phy
operator|->
name|gmode
condition|)
block|{
name|lna
operator|<<=
name|BWN_PHY_RFOVERVAL_LNA_SHIFT
expr_stmt|;
name|pga
operator|<<=
name|BWN_PHY_RFOVERVAL_PGA_SHIFT
expr_stmt|;
name|KASSERT
argument_list|(
operator|(
name|lna
operator|&
operator|~
name|BWN_PHY_RFOVERVAL_LNA
operator|)
operator|==
literal|0
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
operator|(
name|pga
operator|&
operator|~
name|BWN_PHY_RFOVERVAL_PGA
operator|)
operator|==
literal|0
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
name|trsw_rx
operator|&=
operator|(
name|BWN_PHY_RFOVERVAL_TRSWRX
operator||
name|BWN_PHY_RFOVERVAL_BW
operator|)
expr_stmt|;
name|rfover
operator|=
name|BWN_PHY_RFOVERVAL_UNK
operator||
name|pga
operator||
name|lna
operator||
name|trsw_rx
expr_stmt|;
if|if
condition|(
operator|(
name|siba_sprom_get_bf_lo
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|&
name|BWN_BFL_EXTLNA
operator|)
operator|&&
name|phy
operator|->
name|rev
operator|>
literal|6
condition|)
name|rfover
operator||=
name|BWN_PHY_RFOVERVAL_EXTLNA
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_PGACTL
argument_list|,
literal|0xe300
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVERVAL
argument_list|,
name|rfover
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|rfover
operator||=
name|BWN_PHY_RFOVERVAL_BW_LBW
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVERVAL
argument_list|,
name|rfover
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|rfover
operator||=
name|BWN_PHY_RFOVERVAL_BW_LPF
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVERVAL
argument_list|,
name|rfover
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_PGACTL
argument_list|,
literal|0xf300
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|pga
operator||=
name|BWN_PHY_PGACTL_UNKNOWN
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_PGACTL
argument_list|,
name|pga
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|pga
operator||=
name|BWN_PHY_PGACTL_LOWBANDW
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_PGACTL
argument_list|,
name|pga
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|pga
operator||=
name|BWN_PHY_PGACTL_LPF
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_PGACTL
argument_list|,
name|pga
argument_list|)
expr_stmt|;
block|}
name|DELAY
argument_list|(
literal|21
argument_list|)
expr_stmt|;
name|feedthrough
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_LO_LEAKAGE
argument_list|)
expr_stmt|;
return|return
operator|(
name|feedthrough
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint16_t
name|bwn_lo_txctl_regtable
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint16_t
modifier|*
name|value
parameter_list|,
name|uint16_t
modifier|*
name|pad_mix_gain
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|uint16_t
name|reg
decl_stmt|,
name|v
decl_stmt|,
name|padmix
decl_stmt|;
if|if
condition|(
name|phy
operator|->
name|type
operator|==
name|BWN_PHYTYPE_B
condition|)
block|{
name|v
operator|=
literal|0x30
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rf_rev
operator|<=
literal|5
condition|)
block|{
name|reg
operator|=
literal|0x43
expr_stmt|;
name|padmix
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|reg
operator|=
literal|0x52
expr_stmt|;
name|padmix
operator|=
literal|5
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|2
operator|&&
name|phy
operator|->
name|rf_rev
operator|==
literal|8
condition|)
block|{
name|reg
operator|=
literal|0x43
expr_stmt|;
name|v
operator|=
literal|0x10
expr_stmt|;
name|padmix
operator|=
literal|2
expr_stmt|;
block|}
else|else
block|{
name|reg
operator|=
literal|0x52
expr_stmt|;
name|v
operator|=
literal|0x30
expr_stmt|;
name|padmix
operator|=
literal|5
expr_stmt|;
block|}
block|}
if|if
condition|(
name|value
condition|)
operator|*
name|value
operator|=
name|v
expr_stmt|;
if|if
condition|(
name|pad_mix_gain
condition|)
operator|*
name|pad_mix_gain
operator|=
name|padmix
expr_stmt|;
return|return
operator|(
name|reg
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_lo_measure_txctl_values
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwn_phy_g
modifier|*
name|pg
init|=
operator|&
name|phy
operator|->
name|phy_g
decl_stmt|;
name|struct
name|bwn_txpwr_loctl
modifier|*
name|lo
init|=
operator|&
name|pg
operator|->
name|pg_loctl
decl_stmt|;
name|uint16_t
name|reg
decl_stmt|,
name|mask
decl_stmt|;
name|uint16_t
name|trsw_rx
decl_stmt|,
name|pga
decl_stmt|;
name|uint16_t
name|rf_pctl_reg
decl_stmt|;
specifier|static
specifier|const
name|uint8_t
name|tx_bias_values
index|[]
init|=
block|{
literal|0x09
block|,
literal|0x08
block|,
literal|0x0a
block|,
literal|0x01
block|,
literal|0x00
block|,
literal|0x02
block|,
literal|0x05
block|,
literal|0x04
block|,
literal|0x06
block|, 	}
decl_stmt|;
specifier|static
specifier|const
name|uint8_t
name|tx_magn_values
index|[]
init|=
block|{
literal|0x70
block|,
literal|0x40
block|, 	}
decl_stmt|;
if|if
condition|(
operator|!
name|BWN_HAS_LOOPBACK
argument_list|(
name|phy
argument_list|)
condition|)
block|{
name|rf_pctl_reg
operator|=
literal|6
expr_stmt|;
name|trsw_rx
operator|=
literal|2
expr_stmt|;
name|pga
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|int
name|lb_gain
decl_stmt|;
name|trsw_rx
operator|=
literal|0
expr_stmt|;
name|lb_gain
operator|=
name|pg
operator|->
name|pg_max_lb_gain
operator|/
literal|2
expr_stmt|;
if|if
condition|(
name|lb_gain
operator|>
literal|10
condition|)
block|{
name|rf_pctl_reg
operator|=
literal|0
expr_stmt|;
name|pga
operator|=
name|abs
argument_list|(
literal|10
operator|-
name|lb_gain
argument_list|)
operator|/
literal|6
expr_stmt|;
name|pga
operator|=
name|MIN
argument_list|(
name|MAX
argument_list|(
name|pga
argument_list|,
literal|0
argument_list|)
argument_list|,
literal|15
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|int
name|cmp_val
decl_stmt|;
name|int
name|tmp
decl_stmt|;
name|pga
operator|=
literal|0
expr_stmt|;
name|cmp_val
operator|=
literal|0x24
expr_stmt|;
if|if
condition|(
operator|(
name|phy
operator|->
name|rev
operator|>=
literal|2
operator|)
operator|&&
operator|(
name|phy
operator|->
name|rf_ver
operator|==
literal|0x2050
operator|)
operator|&&
operator|(
name|phy
operator|->
name|rf_rev
operator|==
literal|8
operator|)
condition|)
name|cmp_val
operator|=
literal|0x3c
expr_stmt|;
name|tmp
operator|=
name|lb_gain
expr_stmt|;
if|if
condition|(
operator|(
literal|10
operator|-
name|lb_gain
operator|)
operator|<
name|cmp_val
condition|)
name|tmp
operator|=
operator|(
literal|10
operator|-
name|lb_gain
operator|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|<
literal|0
condition|)
name|tmp
operator|+=
literal|6
expr_stmt|;
else|else
name|tmp
operator|+=
literal|3
expr_stmt|;
name|cmp_val
operator|/=
literal|4
expr_stmt|;
name|tmp
operator|/=
literal|4
expr_stmt|;
if|if
condition|(
name|tmp
operator|>=
name|cmp_val
condition|)
name|rf_pctl_reg
operator|=
name|cmp_val
expr_stmt|;
else|else
name|rf_pctl_reg
operator|=
name|tmp
expr_stmt|;
block|}
block|}
name|BWN_RF_SETMASK
argument_list|(
name|mac
argument_list|,
literal|0x43
argument_list|,
literal|0xfff0
argument_list|,
name|rf_pctl_reg
argument_list|)
expr_stmt|;
name|bwn_phy_g_set_bbatt
argument_list|(
name|mac
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|reg
operator|=
name|bwn_lo_txctl_regtable
argument_list|(
name|mac
argument_list|,
operator|&
name|mask
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|mask
operator|=
operator|~
name|mask
expr_stmt|;
name|BWN_RF_MASK
argument_list|(
name|mac
argument_list|,
name|reg
argument_list|,
name|mask
argument_list|)
expr_stmt|;
if|if
condition|(
name|BWN_HAS_TXMAG
argument_list|(
name|phy
argument_list|)
condition|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|int
name|feedthrough
decl_stmt|;
name|int
name|min_feedth
init|=
literal|0xffff
decl_stmt|;
name|uint8_t
name|tx_magn
decl_stmt|,
name|tx_bias
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|N
argument_list|(
name|tx_magn_values
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|tx_magn
operator|=
name|tx_magn_values
index|[
name|i
index|]
expr_stmt|;
name|BWN_RF_SETMASK
argument_list|(
name|mac
argument_list|,
literal|0x52
argument_list|,
literal|0xff0f
argument_list|,
name|tx_magn
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|N
argument_list|(
name|tx_bias_values
argument_list|)
condition|;
name|j
operator|++
control|)
block|{
name|tx_bias
operator|=
name|tx_bias_values
index|[
name|j
index|]
expr_stmt|;
name|BWN_RF_SETMASK
argument_list|(
name|mac
argument_list|,
literal|0x52
argument_list|,
literal|0xfff0
argument_list|,
name|tx_bias
argument_list|)
expr_stmt|;
name|feedthrough
operator|=
name|bwn_lo_calcfeed
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|,
name|pga
argument_list|,
name|trsw_rx
argument_list|)
expr_stmt|;
if|if
condition|(
name|feedthrough
operator|<
name|min_feedth
condition|)
block|{
name|lo
operator|->
name|tx_bias
operator|=
name|tx_bias
expr_stmt|;
name|lo
operator|->
name|tx_magn
operator|=
name|tx_magn
expr_stmt|;
name|min_feedth
operator|=
name|feedthrough
expr_stmt|;
block|}
if|if
condition|(
name|lo
operator|->
name|tx_bias
operator|==
literal|0
condition|)
break|break;
block|}
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x52
argument_list|,
operator|(
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
literal|0x52
argument_list|)
operator|&
literal|0xff00
operator|)
operator||
name|lo
operator|->
name|tx_bias
operator||
name|lo
operator|->
name|tx_magn
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|lo
operator|->
name|tx_magn
operator|=
literal|0
expr_stmt|;
name|lo
operator|->
name|tx_bias
operator|=
literal|0
expr_stmt|;
name|BWN_RF_MASK
argument_list|(
name|mac
argument_list|,
literal|0x52
argument_list|,
literal|0xfff0
argument_list|)
expr_stmt|;
block|}
name|BWN_GETTIME
argument_list|(
name|lo
operator|->
name|txctl_measured_time
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_lo_get_powervector
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwn_phy_g
modifier|*
name|pg
init|=
operator|&
name|phy
operator|->
name|phy_g
decl_stmt|;
name|struct
name|bwn_txpwr_loctl
modifier|*
name|lo
init|=
operator|&
name|pg
operator|->
name|pg_loctl
decl_stmt|;
name|int
name|i
decl_stmt|;
name|uint64_t
name|tmp
decl_stmt|;
name|uint64_t
name|power_vector
init|=
literal|0
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|+=
literal|2
control|)
block|{
name|tmp
operator|=
name|bwn_shm_read_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
literal|0x310
operator|+
name|i
argument_list|)
expr_stmt|;
name|power_vector
operator||=
operator|(
name|tmp
operator|<<
operator|(
name|i
operator|*
literal|8
operator|)
operator|)
expr_stmt|;
name|bwn_shm_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
literal|0x310
operator|+
name|i
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|power_vector
condition|)
name|lo
operator|->
name|power_vector
operator|=
name|power_vector
expr_stmt|;
name|BWN_GETTIME
argument_list|(
name|lo
operator|->
name|pwr_vec_read_time
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_lo_measure_gain_values
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|int16_t
name|max_rx_gain
parameter_list|,
name|int
name|use_trsw_rx
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwn_phy_g
modifier|*
name|pg
init|=
operator|&
name|phy
operator|->
name|phy_g
decl_stmt|;
name|uint16_t
name|tmp
decl_stmt|;
if|if
condition|(
name|max_rx_gain
operator|<
literal|0
condition|)
name|max_rx_gain
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|BWN_HAS_LOOPBACK
argument_list|(
name|phy
argument_list|)
condition|)
block|{
name|int
name|trsw_rx
init|=
literal|0
decl_stmt|;
name|int
name|trsw_rx_gain
decl_stmt|;
if|if
condition|(
name|use_trsw_rx
condition|)
block|{
name|trsw_rx_gain
operator|=
name|pg
operator|->
name|pg_trsw_rx_gain
operator|/
literal|2
expr_stmt|;
if|if
condition|(
name|max_rx_gain
operator|>=
name|trsw_rx_gain
condition|)
block|{
name|trsw_rx_gain
operator|=
name|max_rx_gain
operator|-
name|trsw_rx_gain
expr_stmt|;
name|trsw_rx
operator|=
literal|0x20
expr_stmt|;
block|}
block|}
else|else
name|trsw_rx_gain
operator|=
name|max_rx_gain
expr_stmt|;
if|if
condition|(
name|trsw_rx_gain
operator|<
literal|9
condition|)
block|{
name|pg
operator|->
name|pg_lna_lod_gain
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|pg
operator|->
name|pg_lna_lod_gain
operator|=
literal|1
expr_stmt|;
name|trsw_rx_gain
operator|-=
literal|8
expr_stmt|;
block|}
name|trsw_rx_gain
operator|=
name|MIN
argument_list|(
name|MAX
argument_list|(
name|trsw_rx_gain
argument_list|,
literal|0
argument_list|)
argument_list|,
literal|0x2d
argument_list|)
expr_stmt|;
name|pg
operator|->
name|pg_pga_gain
operator|=
name|trsw_rx_gain
operator|/
literal|3
expr_stmt|;
if|if
condition|(
name|pg
operator|->
name|pg_pga_gain
operator|>=
literal|5
condition|)
block|{
name|pg
operator|->
name|pg_pga_gain
operator|-=
literal|5
expr_stmt|;
name|pg
operator|->
name|pg_lna_gain
operator|=
literal|2
expr_stmt|;
block|}
else|else
name|pg
operator|->
name|pg_lna_gain
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|pg
operator|->
name|pg_lna_gain
operator|=
literal|0
expr_stmt|;
name|pg
operator|->
name|pg_trsw_rx_gain
operator|=
literal|0x20
expr_stmt|;
if|if
condition|(
name|max_rx_gain
operator|>=
literal|0x14
condition|)
block|{
name|pg
operator|->
name|pg_lna_lod_gain
operator|=
literal|1
expr_stmt|;
name|pg
operator|->
name|pg_pga_gain
operator|=
literal|2
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|max_rx_gain
operator|>=
literal|0x12
condition|)
block|{
name|pg
operator|->
name|pg_lna_lod_gain
operator|=
literal|1
expr_stmt|;
name|pg
operator|->
name|pg_pga_gain
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|max_rx_gain
operator|>=
literal|0xf
condition|)
block|{
name|pg
operator|->
name|pg_lna_lod_gain
operator|=
literal|1
expr_stmt|;
name|pg
operator|->
name|pg_pga_gain
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|pg
operator|->
name|pg_lna_lod_gain
operator|=
literal|0
expr_stmt|;
name|pg
operator|->
name|pg_pga_gain
operator|=
literal|0
expr_stmt|;
block|}
block|}
name|tmp
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
literal|0x7a
argument_list|)
expr_stmt|;
if|if
condition|(
name|pg
operator|->
name|pg_lna_lod_gain
operator|==
literal|0
condition|)
name|tmp
operator|&=
operator|~
literal|0x0008
expr_stmt|;
else|else
name|tmp
operator||=
literal|0x0008
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x7a
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_lo_save
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|struct
name|bwn_lo_g_value
modifier|*
name|sav
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwn_phy_g
modifier|*
name|pg
init|=
operator|&
name|phy
operator|->
name|phy_g
decl_stmt|;
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|struct
name|bwn_txpwr_loctl
modifier|*
name|lo
init|=
operator|&
name|pg
operator|->
name|pg_loctl
decl_stmt|;
name|struct
name|timespec
name|ts
decl_stmt|;
name|uint16_t
name|tmp
decl_stmt|;
if|if
condition|(
name|bwn_has_hwpctl
argument_list|(
name|mac
argument_list|)
condition|)
block|{
name|sav
operator|->
name|phy_lomask
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_LO_MASK
argument_list|)
expr_stmt|;
name|sav
operator|->
name|phy_extg
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_EXTG
argument_list|(
literal|0x01
argument_list|)
argument_list|)
expr_stmt|;
name|sav
operator|->
name|phy_dacctl_hwpctl
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_DACCTL
argument_list|)
expr_stmt|;
name|sav
operator|->
name|phy_cck4
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x14
argument_list|)
argument_list|)
expr_stmt|;
name|sav
operator|->
name|phy_hpwr_tssictl
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_HPWR_TSSICTL
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_HPWR_TSSICTL
argument_list|,
literal|0x100
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_EXTG
argument_list|(
literal|0x01
argument_list|)
argument_list|,
literal|0x40
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_DACCTL
argument_list|,
literal|0x40
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x14
argument_list|)
argument_list|,
literal|0x200
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|phy
operator|->
name|type
operator|==
name|BWN_PHYTYPE_B
operator|&&
name|phy
operator|->
name|rf_ver
operator|==
literal|0x2050
operator|&&
name|phy
operator|->
name|rf_rev
operator|<
literal|6
condition|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x16
argument_list|)
argument_list|,
literal|0x410
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x17
argument_list|)
argument_list|,
literal|0x820
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|2
condition|)
block|{
name|sav
operator|->
name|phy_analogover
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_ANALOGOVER
argument_list|)
expr_stmt|;
name|sav
operator|->
name|phy_analogoverval
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_ANALOGOVERVAL
argument_list|)
expr_stmt|;
name|sav
operator|->
name|phy_rfover
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVER
argument_list|)
expr_stmt|;
name|sav
operator|->
name|phy_rfoverval
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVERVAL
argument_list|)
expr_stmt|;
name|sav
operator|->
name|phy_classctl
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CLASSCTL
argument_list|)
expr_stmt|;
name|sav
operator|->
name|phy_cck3
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x3e
argument_list|)
argument_list|)
expr_stmt|;
name|sav
operator|->
name|phy_crs0
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CRS0
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CLASSCTL
argument_list|,
literal|0xfffc
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CRS0
argument_list|,
literal|0x7fff
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_ANALOGOVER
argument_list|,
literal|0x0003
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_ANALOGOVERVAL
argument_list|,
literal|0xfffc
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|type
operator|==
name|BWN_PHYTYPE_G
condition|)
block|{
if|if
condition|(
operator|(
name|phy
operator|->
name|rev
operator|>=
literal|7
operator|)
operator|&&
operator|(
name|siba_sprom_get_bf_lo
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|&
name|BWN_BFL_EXTLNA
operator|)
condition|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVER
argument_list|,
literal|0x933
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVER
argument_list|,
literal|0x133
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVER
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x3e
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|sav
operator|->
name|reg0
operator|=
name|BWN_READ_2
argument_list|(
name|mac
argument_list|,
literal|0x3f4
argument_list|)
expr_stmt|;
name|sav
operator|->
name|reg1
operator|=
name|BWN_READ_2
argument_list|(
name|mac
argument_list|,
literal|0x3e2
argument_list|)
expr_stmt|;
name|sav
operator|->
name|rf0
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
literal|0x43
argument_list|)
expr_stmt|;
name|sav
operator|->
name|rf1
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
literal|0x7a
argument_list|)
expr_stmt|;
name|sav
operator|->
name|phy_pgactl
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_PGACTL
argument_list|)
expr_stmt|;
name|sav
operator|->
name|phy_cck2
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x2a
argument_list|)
argument_list|)
expr_stmt|;
name|sav
operator|->
name|phy_syncctl
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_SYNCCTL
argument_list|)
expr_stmt|;
name|sav
operator|->
name|phy_dacctl
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_DACCTL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|BWN_HAS_TXMAG
argument_list|(
name|phy
argument_list|)
condition|)
block|{
name|sav
operator|->
name|rf2
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
literal|0x52
argument_list|)
expr_stmt|;
name|sav
operator|->
name|rf2
operator|&=
literal|0x00f0
expr_stmt|;
block|}
if|if
condition|(
name|phy
operator|->
name|type
operator|==
name|BWN_PHYTYPE_B
condition|)
block|{
name|sav
operator|->
name|phy_cck0
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x30
argument_list|)
argument_list|)
expr_stmt|;
name|sav
operator|->
name|phy_cck1
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x06
argument_list|)
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x30
argument_list|)
argument_list|,
literal|0x00ff
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x06
argument_list|)
argument_list|,
literal|0x3f3f
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
literal|0x3e2
argument_list|,
name|BWN_READ_2
argument_list|(
name|mac
argument_list|,
literal|0x3e2
argument_list|)
operator||
literal|0x8000
argument_list|)
expr_stmt|;
block|}
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
literal|0x3f4
argument_list|,
name|BWN_READ_2
argument_list|(
name|mac
argument_list|,
literal|0x3f4
argument_list|)
operator|&
literal|0xf000
argument_list|)
expr_stmt|;
name|tmp
operator|=
operator|(
name|phy
operator|->
name|type
operator|==
name|BWN_PHYTYPE_G
operator|)
condition|?
name|BWN_PHY_LO_MASK
else|:
name|BWN_PHY_CCK
argument_list|(
literal|0x2e
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|tmp
argument_list|,
literal|0x007f
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|sav
operator|->
name|phy_syncctl
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_SYNCCTL
argument_list|,
name|tmp
operator|&
literal|0xff7f
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|sav
operator|->
name|rf1
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x007a
argument_list|,
name|tmp
operator|&
literal|0xfff0
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x2a
argument_list|)
argument_list|,
literal|0x8a3
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|type
operator|==
name|BWN_PHYTYPE_G
operator|||
operator|(
name|phy
operator|->
name|type
operator|==
name|BWN_PHYTYPE_B
operator|&&
name|phy
operator|->
name|rf_ver
operator|==
literal|0x2050
operator|&&
name|phy
operator|->
name|rf_rev
operator|>=
literal|6
operator|)
condition|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x2b
argument_list|)
argument_list|,
literal|0x1003
argument_list|)
expr_stmt|;
block|}
else|else
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x2b
argument_list|)
argument_list|,
literal|0x0802
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|2
condition|)
name|bwn_dummy_transmission
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|bwn_phy_g_switch_chan
argument_list|(
name|mac
argument_list|,
literal|6
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
literal|0x51
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|type
operator|==
name|BWN_PHYTYPE_G
condition|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x2f
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|nanouptime
argument_list|(
operator|&
name|ts
argument_list|)
expr_stmt|;
if|if
condition|(
name|ieee80211_time_before
argument_list|(
name|lo
operator|->
name|txctl_measured_time
argument_list|,
operator|(
name|ts
operator|.
name|tv_nsec
operator|/
literal|1000000
operator|+
name|ts
operator|.
name|tv_sec
operator|*
literal|1000
operator|)
operator|-
name|BWN_LO_TXCTL_EXPIRE
argument_list|)
condition|)
name|bwn_lo_measure_txctl_values
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|type
operator|==
name|BWN_PHYTYPE_G
operator|&&
name|phy
operator|->
name|rev
operator|>=
literal|3
condition|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_LO_MASK
argument_list|,
literal|0xc078
argument_list|)
expr_stmt|;
else|else
block|{
if|if
condition|(
name|phy
operator|->
name|type
operator|==
name|BWN_PHYTYPE_B
condition|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x2e
argument_list|)
argument_list|,
literal|0x8078
argument_list|)
expr_stmt|;
else|else
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_LO_MASK
argument_list|,
literal|0x8078
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_lo_restore
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|struct
name|bwn_lo_g_value
modifier|*
name|sav
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwn_phy_g
modifier|*
name|pg
init|=
operator|&
name|phy
operator|->
name|phy_g
decl_stmt|;
name|uint16_t
name|tmp
decl_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|2
condition|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_PGACTL
argument_list|,
literal|0xe300
argument_list|)
expr_stmt|;
name|tmp
operator|=
operator|(
name|pg
operator|->
name|pg_pga_gain
operator|<<
literal|8
operator|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVERVAL
argument_list|,
name|tmp
operator||
literal|0xa0
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|5
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVERVAL
argument_list|,
name|tmp
operator||
literal|0xa2
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVERVAL
argument_list|,
name|tmp
operator||
literal|0xa3
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tmp
operator|=
operator|(
name|pg
operator|->
name|pg_pga_gain
operator||
literal|0xefa0
operator|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_PGACTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|phy
operator|->
name|type
operator|==
name|BWN_PHYTYPE_G
condition|)
block|{
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|3
condition|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x2e
argument_list|)
argument_list|,
literal|0xc078
argument_list|)
expr_stmt|;
else|else
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x2e
argument_list|)
argument_list|,
literal|0x8078
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|2
condition|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x2f
argument_list|)
argument_list|,
literal|0x0202
argument_list|)
expr_stmt|;
else|else
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x2f
argument_list|)
argument_list|,
literal|0x0101
argument_list|)
expr_stmt|;
block|}
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
literal|0x3f4
argument_list|,
name|sav
operator|->
name|reg0
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_PGACTL
argument_list|,
name|sav
operator|->
name|phy_pgactl
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x2a
argument_list|)
argument_list|,
name|sav
operator|->
name|phy_cck2
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_SYNCCTL
argument_list|,
name|sav
operator|->
name|phy_syncctl
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_DACCTL
argument_list|,
name|sav
operator|->
name|phy_dacctl
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x43
argument_list|,
name|sav
operator|->
name|rf0
argument_list|)
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x7a
argument_list|,
name|sav
operator|->
name|rf1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|BWN_HAS_TXMAG
argument_list|(
name|phy
argument_list|)
condition|)
block|{
name|tmp
operator|=
name|sav
operator|->
name|rf2
expr_stmt|;
name|BWN_RF_SETMASK
argument_list|(
name|mac
argument_list|,
literal|0x52
argument_list|,
literal|0xff0f
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
literal|0x3e2
argument_list|,
name|sav
operator|->
name|reg1
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|type
operator|==
name|BWN_PHYTYPE_B
operator|&&
name|phy
operator|->
name|rf_ver
operator|==
literal|0x2050
operator|&&
name|phy
operator|->
name|rf_rev
operator|<=
literal|5
condition|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x30
argument_list|)
argument_list|,
name|sav
operator|->
name|phy_cck0
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x06
argument_list|)
argument_list|,
name|sav
operator|->
name|phy_cck1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|2
condition|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_ANALOGOVER
argument_list|,
name|sav
operator|->
name|phy_analogover
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_ANALOGOVERVAL
argument_list|,
name|sav
operator|->
name|phy_analogoverval
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CLASSCTL
argument_list|,
name|sav
operator|->
name|phy_classctl
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVER
argument_list|,
name|sav
operator|->
name|phy_rfover
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_RFOVERVAL
argument_list|,
name|sav
operator|->
name|phy_rfoverval
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x3e
argument_list|)
argument_list|,
name|sav
operator|->
name|phy_cck3
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CRS0
argument_list|,
name|sav
operator|->
name|phy_crs0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|bwn_has_hwpctl
argument_list|(
name|mac
argument_list|)
condition|)
block|{
name|tmp
operator|=
operator|(
name|sav
operator|->
name|phy_lomask
operator|&
literal|0xbfff
operator|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_LO_MASK
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_EXTG
argument_list|(
literal|0x01
argument_list|)
argument_list|,
name|sav
operator|->
name|phy_extg
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_DACCTL
argument_list|,
name|sav
operator|->
name|phy_dacctl_hwpctl
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_CCK
argument_list|(
literal|0x14
argument_list|)
argument_list|,
name|sav
operator|->
name|phy_cck4
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_HPWR_TSSICTL
argument_list|,
name|sav
operator|->
name|phy_hpwr_tssictl
argument_list|)
expr_stmt|;
block|}
name|bwn_phy_g_switch_chan
argument_list|(
name|mac
argument_list|,
name|sav
operator|->
name|old_channel
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|bwn_lo_probe_loctl
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|struct
name|bwn_loctl
modifier|*
name|probe
parameter_list|,
name|struct
name|bwn_lo_g_sm
modifier|*
name|d
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwn_phy_g
modifier|*
name|pg
init|=
operator|&
name|phy
operator|->
name|phy_g
decl_stmt|;
name|struct
name|bwn_loctl
name|orig
decl_stmt|,
name|test
decl_stmt|;
name|struct
name|bwn_loctl
name|prev
init|=
block|{
operator|-
literal|100
block|,
operator|-
literal|100
block|}
decl_stmt|;
specifier|static
specifier|const
name|struct
name|bwn_loctl
name|modifiers
index|[]
init|=
block|{
block|{
literal|1
block|,
literal|1
block|,}
block|,
block|{
literal|1
block|,
literal|0
block|,}
block|,
block|{
literal|1
block|,
operator|-
literal|1
block|,}
block|,
block|{
literal|0
block|,
operator|-
literal|1
block|,}
block|,
block|{
operator|-
literal|1
block|,
operator|-
literal|1
block|,}
block|,
block|{
operator|-
literal|1
block|,
literal|0
block|,}
block|,
block|{
operator|-
literal|1
block|,
literal|1
block|,}
block|,
block|{
literal|0
block|,
literal|1
block|,}
block|}
decl_stmt|;
name|int
name|begin
decl_stmt|,
name|end
decl_stmt|,
name|lower
init|=
literal|0
decl_stmt|,
name|i
decl_stmt|;
name|uint16_t
name|feedth
decl_stmt|;
if|if
condition|(
name|d
operator|->
name|curstate
operator|==
literal|0
condition|)
block|{
name|begin
operator|=
literal|1
expr_stmt|;
name|end
operator|=
literal|8
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|d
operator|->
name|curstate
operator|%
literal|2
operator|==
literal|0
condition|)
block|{
name|begin
operator|=
name|d
operator|->
name|curstate
operator|-
literal|1
expr_stmt|;
name|end
operator|=
name|d
operator|->
name|curstate
operator|+
literal|1
expr_stmt|;
block|}
else|else
block|{
name|begin
operator|=
name|d
operator|->
name|curstate
operator|-
literal|2
expr_stmt|;
name|end
operator|=
name|d
operator|->
name|curstate
operator|+
literal|2
expr_stmt|;
block|}
if|if
condition|(
name|begin
operator|<
literal|1
condition|)
name|begin
operator|+=
literal|8
expr_stmt|;
if|if
condition|(
name|end
operator|>
literal|8
condition|)
name|end
operator|-=
literal|8
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|orig
argument_list|,
name|probe
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|bwn_loctl
argument_list|)
argument_list|)
expr_stmt|;
name|i
operator|=
name|begin
expr_stmt|;
name|d
operator|->
name|curstate
operator|=
name|i
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|KASSERT
argument_list|(
name|i
operator|>=
literal|1
operator|&&
name|i
operator|<=
literal|8
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|test
argument_list|,
operator|&
name|orig
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|bwn_loctl
argument_list|)
argument_list|)
expr_stmt|;
name|test
operator|.
name|i
operator|+=
name|modifiers
index|[
name|i
operator|-
literal|1
index|]
operator|.
name|i
operator|*
name|d
operator|->
name|multipler
expr_stmt|;
name|test
operator|.
name|q
operator|+=
name|modifiers
index|[
name|i
operator|-
literal|1
index|]
operator|.
name|q
operator|*
name|d
operator|->
name|multipler
expr_stmt|;
if|if
condition|(
operator|(
name|test
operator|.
name|i
operator|!=
name|prev
operator|.
name|i
operator|||
name|test
operator|.
name|q
operator|!=
name|prev
operator|.
name|q
operator|)
operator|&&
operator|(
name|abs
argument_list|(
name|test
operator|.
name|i
argument_list|)
operator|<=
literal|16
operator|&&
name|abs
argument_list|(
name|test
operator|.
name|q
argument_list|)
operator|<=
literal|16
operator|)
condition|)
block|{
name|bwn_lo_write
argument_list|(
name|mac
argument_list|,
operator|&
name|test
argument_list|)
expr_stmt|;
name|feedth
operator|=
name|bwn_lo_calcfeed
argument_list|(
name|mac
argument_list|,
name|pg
operator|->
name|pg_lna_gain
argument_list|,
name|pg
operator|->
name|pg_pga_gain
argument_list|,
name|pg
operator|->
name|pg_trsw_rx_gain
argument_list|)
expr_stmt|;
if|if
condition|(
name|feedth
operator|<
name|d
operator|->
name|feedth
condition|)
block|{
name|memcpy
argument_list|(
name|probe
argument_list|,
operator|&
name|test
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|bwn_loctl
argument_list|)
argument_list|)
expr_stmt|;
name|lower
operator|=
literal|1
expr_stmt|;
name|d
operator|->
name|feedth
operator|=
name|feedth
expr_stmt|;
if|if
condition|(
name|d
operator|->
name|nmeasure
operator|<
literal|2
operator|&&
operator|!
name|BWN_HAS_LOOPBACK
argument_list|(
name|phy
argument_list|)
condition|)
break|break;
block|}
block|}
name|memcpy
argument_list|(
operator|&
name|prev
argument_list|,
operator|&
name|test
argument_list|,
sizeof|sizeof
argument_list|(
name|prev
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
name|end
condition|)
break|break;
if|if
condition|(
name|i
operator|==
literal|8
condition|)
name|i
operator|=
literal|1
expr_stmt|;
else|else
name|i
operator|++
expr_stmt|;
name|d
operator|->
name|curstate
operator|=
name|i
expr_stmt|;
block|}
return|return
operator|(
name|lower
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_lo_probe_sm
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|struct
name|bwn_loctl
modifier|*
name|loctl
parameter_list|,
name|int
modifier|*
name|rxgain
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwn_phy_g
modifier|*
name|pg
init|=
operator|&
name|phy
operator|->
name|phy_g
decl_stmt|;
name|struct
name|bwn_lo_g_sm
name|d
decl_stmt|;
name|struct
name|bwn_loctl
name|probe
decl_stmt|;
name|int
name|lower
decl_stmt|,
name|repeat
decl_stmt|,
name|cnt
init|=
literal|0
decl_stmt|;
name|uint16_t
name|feedth
decl_stmt|;
name|d
operator|.
name|nmeasure
operator|=
literal|0
expr_stmt|;
name|d
operator|.
name|multipler
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|BWN_HAS_LOOPBACK
argument_list|(
name|phy
argument_list|)
condition|)
name|d
operator|.
name|multipler
operator|=
literal|3
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|d
operator|.
name|loctl
argument_list|,
name|loctl
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|bwn_loctl
argument_list|)
argument_list|)
expr_stmt|;
name|repeat
operator|=
operator|(
name|BWN_HAS_LOOPBACK
argument_list|(
name|phy
argument_list|)
operator|)
condition|?
literal|4
else|:
literal|1
expr_stmt|;
do|do
block|{
name|bwn_lo_write
argument_list|(
name|mac
argument_list|,
operator|&
name|d
operator|.
name|loctl
argument_list|)
expr_stmt|;
name|feedth
operator|=
name|bwn_lo_calcfeed
argument_list|(
name|mac
argument_list|,
name|pg
operator|->
name|pg_lna_gain
argument_list|,
name|pg
operator|->
name|pg_pga_gain
argument_list|,
name|pg
operator|->
name|pg_trsw_rx_gain
argument_list|)
expr_stmt|;
if|if
condition|(
name|feedth
operator|<
literal|0x258
condition|)
block|{
if|if
condition|(
name|feedth
operator|>=
literal|0x12c
condition|)
operator|*
name|rxgain
operator|+=
literal|6
expr_stmt|;
else|else
operator|*
name|rxgain
operator|+=
literal|3
expr_stmt|;
name|feedth
operator|=
name|bwn_lo_calcfeed
argument_list|(
name|mac
argument_list|,
name|pg
operator|->
name|pg_lna_gain
argument_list|,
name|pg
operator|->
name|pg_pga_gain
argument_list|,
name|pg
operator|->
name|pg_trsw_rx_gain
argument_list|)
expr_stmt|;
block|}
name|d
operator|.
name|feedth
operator|=
name|feedth
expr_stmt|;
name|d
operator|.
name|curstate
operator|=
literal|0
expr_stmt|;
do|do
block|{
name|KASSERT
argument_list|(
name|d
operator|.
name|curstate
operator|>=
literal|0
operator|&&
name|d
operator|.
name|curstate
operator|<=
literal|8
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|probe
argument_list|,
operator|&
name|d
operator|.
name|loctl
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|bwn_loctl
argument_list|)
argument_list|)
expr_stmt|;
name|lower
operator|=
name|bwn_lo_probe_loctl
argument_list|(
name|mac
argument_list|,
operator|&
name|probe
argument_list|,
operator|&
name|d
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|lower
condition|)
break|break;
if|if
condition|(
operator|(
name|probe
operator|.
name|i
operator|==
name|d
operator|.
name|loctl
operator|.
name|i
operator|)
operator|&&
operator|(
name|probe
operator|.
name|q
operator|==
name|d
operator|.
name|loctl
operator|.
name|q
operator|)
condition|)
break|break;
name|memcpy
argument_list|(
operator|&
name|d
operator|.
name|loctl
argument_list|,
operator|&
name|probe
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|bwn_loctl
argument_list|)
argument_list|)
expr_stmt|;
name|d
operator|.
name|nmeasure
operator|++
expr_stmt|;
block|}
do|while
condition|(
name|d
operator|.
name|nmeasure
operator|<
literal|24
condition|)
do|;
name|memcpy
argument_list|(
name|loctl
argument_list|,
operator|&
name|d
operator|.
name|loctl
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|bwn_loctl
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|BWN_HAS_LOOPBACK
argument_list|(
name|phy
argument_list|)
condition|)
block|{
if|if
condition|(
name|d
operator|.
name|feedth
operator|>
literal|0x1194
condition|)
operator|*
name|rxgain
operator|-=
literal|6
expr_stmt|;
elseif|else
if|if
condition|(
name|d
operator|.
name|feedth
operator|<
literal|0x5dc
condition|)
operator|*
name|rxgain
operator|+=
literal|3
expr_stmt|;
if|if
condition|(
name|cnt
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|d
operator|.
name|feedth
operator|<=
literal|0x5dc
condition|)
block|{
name|d
operator|.
name|multipler
operator|=
literal|1
expr_stmt|;
name|cnt
operator|++
expr_stmt|;
block|}
else|else
name|d
operator|.
name|multipler
operator|=
literal|2
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cnt
operator|==
literal|2
condition|)
name|d
operator|.
name|multipler
operator|=
literal|1
expr_stmt|;
block|}
name|bwn_lo_measure_gain_values
argument_list|(
name|mac
argument_list|,
operator|*
name|rxgain
argument_list|,
name|BWN_HAS_LOOPBACK
argument_list|(
name|phy
argument_list|)
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
operator|++
name|cnt
operator|<
name|repeat
condition|)
do|;
block|}
end_function

begin_function
specifier|static
name|struct
name|bwn_lo_calib
modifier|*
name|bwn_lo_calibset
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
specifier|const
name|struct
name|bwn_bbatt
modifier|*
name|bbatt
parameter_list|,
specifier|const
name|struct
name|bwn_rfatt
modifier|*
name|rfatt
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwn_phy_g
modifier|*
name|pg
init|=
operator|&
name|phy
operator|->
name|phy_g
decl_stmt|;
name|struct
name|bwn_loctl
name|loctl
init|=
block|{
literal|0
block|,
literal|0
block|}
decl_stmt|;
name|struct
name|bwn_lo_calib
modifier|*
name|cal
decl_stmt|;
name|struct
name|bwn_lo_g_value
name|sval
init|=
block|{
literal|0
block|}
decl_stmt|;
name|int
name|rxgain
decl_stmt|;
name|uint16_t
name|pad
decl_stmt|,
name|reg
decl_stmt|,
name|value
decl_stmt|;
name|sval
operator|.
name|old_channel
operator|=
name|phy
operator|->
name|chan
expr_stmt|;
name|bwn_mac_suspend
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|bwn_lo_save
argument_list|(
name|mac
argument_list|,
operator|&
name|sval
argument_list|)
expr_stmt|;
name|reg
operator|=
name|bwn_lo_txctl_regtable
argument_list|(
name|mac
argument_list|,
operator|&
name|value
argument_list|,
operator|&
name|pad
argument_list|)
expr_stmt|;
name|BWN_RF_SETMASK
argument_list|(
name|mac
argument_list|,
literal|0x43
argument_list|,
literal|0xfff0
argument_list|,
name|rfatt
operator|->
name|att
argument_list|)
expr_stmt|;
name|BWN_RF_SETMASK
argument_list|(
name|mac
argument_list|,
name|reg
argument_list|,
operator|~
name|value
argument_list|,
operator|(
name|rfatt
operator|->
name|padmix
condition|?
name|value
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|rxgain
operator|=
operator|(
name|rfatt
operator|->
name|att
operator|*
literal|2
operator|)
operator|+
operator|(
name|bbatt
operator|->
name|att
operator|/
literal|2
operator|)
expr_stmt|;
if|if
condition|(
name|rfatt
operator|->
name|padmix
condition|)
name|rxgain
operator|-=
name|pad
expr_stmt|;
if|if
condition|(
name|BWN_HAS_LOOPBACK
argument_list|(
name|phy
argument_list|)
condition|)
name|rxgain
operator|+=
name|pg
operator|->
name|pg_max_lb_gain
expr_stmt|;
name|bwn_lo_measure_gain_values
argument_list|(
name|mac
argument_list|,
name|rxgain
argument_list|,
name|BWN_HAS_LOOPBACK
argument_list|(
name|phy
argument_list|)
argument_list|)
expr_stmt|;
name|bwn_phy_g_set_bbatt
argument_list|(
name|mac
argument_list|,
name|bbatt
operator|->
name|att
argument_list|)
expr_stmt|;
name|bwn_lo_probe_sm
argument_list|(
name|mac
argument_list|,
operator|&
name|loctl
argument_list|,
operator|&
name|rxgain
argument_list|)
expr_stmt|;
name|bwn_lo_restore
argument_list|(
name|mac
argument_list|,
operator|&
name|sval
argument_list|)
expr_stmt|;
name|bwn_mac_enable
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|cal
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|cal
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cal
condition|)
block|{
name|device_printf
argument_list|(
name|mac
operator|->
name|mac_sc
operator|->
name|sc_dev
argument_list|,
literal|"out of memory\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|memcpy
argument_list|(
operator|&
name|cal
operator|->
name|bbatt
argument_list|,
name|bbatt
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|bbatt
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|cal
operator|->
name|rfatt
argument_list|,
name|rfatt
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|rfatt
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|cal
operator|->
name|ctl
argument_list|,
operator|&
name|loctl
argument_list|,
sizeof|sizeof
argument_list|(
name|loctl
argument_list|)
argument_list|)
expr_stmt|;
name|BWN_GETTIME
argument_list|(
name|cal
operator|->
name|calib_time
argument_list|)
expr_stmt|;
return|return
operator|(
name|cal
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|bwn_lo_calib
modifier|*
name|bwn_lo_get_calib
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
specifier|const
name|struct
name|bwn_bbatt
modifier|*
name|bbatt
parameter_list|,
specifier|const
name|struct
name|bwn_rfatt
modifier|*
name|rfatt
parameter_list|)
block|{
name|struct
name|bwn_txpwr_loctl
modifier|*
name|lo
init|=
operator|&
name|mac
operator|->
name|mac_phy
operator|.
name|phy_g
operator|.
name|pg_loctl
decl_stmt|;
name|struct
name|bwn_lo_calib
modifier|*
name|c
decl_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|c
argument_list|,
argument|&lo->calib_list
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
operator|!
name|BWN_BBATTCMP
argument_list|(
operator|&
name|c
operator|->
name|bbatt
argument_list|,
name|bbatt
argument_list|)
condition|)
continue|continue;
if|if
condition|(
operator|!
name|BWN_RFATTCMP
argument_list|(
operator|&
name|c
operator|->
name|rfatt
argument_list|,
name|rfatt
argument_list|)
condition|)
continue|continue;
return|return
operator|(
name|c
operator|)
return|;
block|}
name|c
operator|=
name|bwn_lo_calibset
argument_list|(
name|mac
argument_list|,
name|bbatt
argument_list|,
name|rfatt
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|c
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|lo
operator|->
name|calib_list
argument_list|,
name|c
argument_list|,
name|list
argument_list|)
expr_stmt|;
return|return
operator|(
name|c
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_phy_g_dc_lookup_init
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint8_t
name|update
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwn_phy_g
modifier|*
name|pg
init|=
operator|&
name|phy
operator|->
name|phy_g
decl_stmt|;
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|struct
name|bwn_txpwr_loctl
modifier|*
name|lo
init|=
operator|&
name|pg
operator|->
name|pg_loctl
decl_stmt|;
specifier|const
name|struct
name|bwn_rfatt
modifier|*
name|rfatt
decl_stmt|;
specifier|const
name|struct
name|bwn_bbatt
modifier|*
name|bbatt
decl_stmt|;
name|uint64_t
name|pvector
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|rf_offset
decl_stmt|,
name|bb_offset
decl_stmt|;
name|uint8_t
name|changed
init|=
literal|0
decl_stmt|;
name|KASSERT
argument_list|(
name|BWN_DC_LT_SIZE
operator|==
literal|32
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|lo
operator|->
name|rfatt
operator|.
name|len
operator|*
name|lo
operator|->
name|bbatt
operator|.
name|len
operator|<=
literal|64
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
name|pvector
operator|=
name|lo
operator|->
name|power_vector
expr_stmt|;
if|if
condition|(
operator|!
name|update
operator|&&
operator|!
name|pvector
condition|)
return|return;
name|bwn_mac_suspend
argument_list|(
name|mac
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|BWN_DC_LT_SIZE
operator|*
literal|2
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|bwn_lo_calib
modifier|*
name|cal
decl_stmt|;
name|int
name|idx
decl_stmt|;
name|uint16_t
name|val
decl_stmt|;
if|if
condition|(
operator|!
name|update
operator|&&
operator|!
operator|(
name|pvector
operator|&
operator|(
operator|(
operator|(
name|uint64_t
operator|)
literal|1ULL
operator|)
operator|<<
name|i
operator|)
operator|)
condition|)
continue|continue;
name|bb_offset
operator|=
name|i
operator|/
name|lo
operator|->
name|rfatt
operator|.
name|len
expr_stmt|;
name|rf_offset
operator|=
name|i
operator|%
name|lo
operator|->
name|rfatt
operator|.
name|len
expr_stmt|;
name|bbatt
operator|=
operator|&
operator|(
name|lo
operator|->
name|bbatt
operator|.
name|array
index|[
name|bb_offset
index|]
operator|)
expr_stmt|;
name|rfatt
operator|=
operator|&
operator|(
name|lo
operator|->
name|rfatt
operator|.
name|array
index|[
name|rf_offset
index|]
operator|)
expr_stmt|;
name|cal
operator|=
name|bwn_lo_calibset
argument_list|(
name|mac
argument_list|,
name|bbatt
argument_list|,
name|rfatt
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cal
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"LO: Could not "
literal|"calibrate DC table entry\n"
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|val
operator|=
call|(
name|uint8_t
call|)
argument_list|(
name|cal
operator|->
name|ctl
operator|.
name|q
argument_list|)
expr_stmt|;
name|val
operator||=
operator|(
call|(
name|uint8_t
call|)
argument_list|(
name|cal
operator|->
name|ctl
operator|.
name|i
argument_list|)
operator|)
operator|<<
literal|4
expr_stmt|;
name|free
argument_list|(
name|cal
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|idx
operator|=
name|i
operator|/
literal|2
expr_stmt|;
if|if
condition|(
name|i
operator|%
literal|2
condition|)
name|lo
operator|->
name|dc_lt
index|[
name|idx
index|]
operator|=
operator|(
name|lo
operator|->
name|dc_lt
index|[
name|idx
index|]
operator|&
literal|0x00ff
operator|)
operator||
operator|(
operator|(
name|val
operator|&
literal|0x00ff
operator|)
operator|<<
literal|8
operator|)
expr_stmt|;
else|else
name|lo
operator|->
name|dc_lt
index|[
name|idx
index|]
operator|=
operator|(
name|lo
operator|->
name|dc_lt
index|[
name|idx
index|]
operator|&
literal|0xff00
operator|)
operator||
operator|(
name|val
operator|&
literal|0x00ff
operator|)
expr_stmt|;
name|changed
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|changed
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|BWN_DC_LT_SIZE
condition|;
name|i
operator|++
control|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x3a0
operator|+
name|i
argument_list|,
name|lo
operator|->
name|dc_lt
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|bwn_mac_enable
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_lo_fixup_rfatt
parameter_list|(
name|struct
name|bwn_rfatt
modifier|*
name|rf
parameter_list|)
block|{
if|if
condition|(
operator|!
name|rf
operator|->
name|padmix
condition|)
return|return;
if|if
condition|(
operator|(
name|rf
operator|->
name|att
operator|!=
literal|1
operator|)
operator|&&
operator|(
name|rf
operator|->
name|att
operator|!=
literal|2
operator|)
operator|&&
operator|(
name|rf
operator|->
name|att
operator|!=
literal|3
operator|)
condition|)
name|rf
operator|->
name|att
operator|=
literal|4
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_lo_g_adjust
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_phy_g
modifier|*
name|pg
init|=
operator|&
name|mac
operator|->
name|mac_phy
operator|.
name|phy_g
decl_stmt|;
name|struct
name|bwn_lo_calib
modifier|*
name|cal
decl_stmt|;
name|struct
name|bwn_rfatt
name|rf
decl_stmt|;
name|memcpy
argument_list|(
operator|&
name|rf
argument_list|,
operator|&
name|pg
operator|->
name|pg_rfatt
argument_list|,
sizeof|sizeof
argument_list|(
name|rf
argument_list|)
argument_list|)
expr_stmt|;
name|bwn_lo_fixup_rfatt
argument_list|(
operator|&
name|rf
argument_list|)
expr_stmt|;
name|cal
operator|=
name|bwn_lo_get_calib
argument_list|(
name|mac
argument_list|,
operator|&
name|pg
operator|->
name|pg_bbatt
argument_list|,
operator|&
name|rf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cal
condition|)
return|return;
name|bwn_lo_write
argument_list|(
name|mac
argument_list|,
operator|&
name|cal
operator|->
name|ctl
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_lo_g_init
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
if|if
condition|(
operator|!
name|bwn_has_hwpctl
argument_list|(
name|mac
argument_list|)
condition|)
return|return;
name|bwn_lo_get_powervector
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|bwn_phy_g_dc_lookup_init
argument_list|(
name|mac
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int16_t
name|bwn_nrssi_read
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint16_t
name|offset
parameter_list|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_NRSSI_CTRL
argument_list|,
name|offset
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
name|int16_t
operator|)
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_NRSSI_DATA
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_nrssi_threshold
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwn_phy_g
modifier|*
name|pg
init|=
operator|&
name|phy
operator|->
name|phy_g
decl_stmt|;
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|int32_t
name|a
decl_stmt|,
name|b
decl_stmt|;
name|int16_t
name|tmp16
decl_stmt|;
name|uint16_t
name|tmpu16
decl_stmt|;
name|KASSERT
argument_list|(
name|phy
operator|->
name|type
operator|==
name|BWN_PHYTYPE_G
argument_list|,
operator|(
literal|"%s: fail"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|gmode
operator|&&
operator|(
name|siba_sprom_get_bf_lo
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|&
name|BWN_BFL_RSSI
operator|)
condition|)
block|{
if|if
condition|(
operator|!
name|pg
operator|->
name|pg_aci_wlan_automatic
operator|&&
name|pg
operator|->
name|pg_aci_enable
condition|)
block|{
name|a
operator|=
literal|0x13
expr_stmt|;
name|b
operator|=
literal|0x12
expr_stmt|;
block|}
else|else
block|{
name|a
operator|=
literal|0xe
expr_stmt|;
name|b
operator|=
literal|0x11
expr_stmt|;
block|}
name|a
operator|=
name|a
operator|*
operator|(
name|pg
operator|->
name|pg_nrssi
index|[
literal|1
index|]
operator|-
name|pg
operator|->
name|pg_nrssi
index|[
literal|0
index|]
operator|)
expr_stmt|;
name|a
operator|+=
operator|(
name|pg
operator|->
name|pg_nrssi
index|[
literal|0
index|]
operator|<<
literal|6
operator|)
expr_stmt|;
name|a
operator|+=
operator|(
name|a
operator|<
literal|32
operator|)
condition|?
literal|31
else|:
literal|32
expr_stmt|;
name|a
operator|=
name|a
operator|>>
literal|6
expr_stmt|;
name|a
operator|=
name|MIN
argument_list|(
name|MAX
argument_list|(
name|a
argument_list|,
operator|-
literal|31
argument_list|)
argument_list|,
literal|31
argument_list|)
expr_stmt|;
name|b
operator|=
name|b
operator|*
operator|(
name|pg
operator|->
name|pg_nrssi
index|[
literal|1
index|]
operator|-
name|pg
operator|->
name|pg_nrssi
index|[
literal|0
index|]
operator|)
expr_stmt|;
name|b
operator|+=
operator|(
name|pg
operator|->
name|pg_nrssi
index|[
literal|0
index|]
operator|<<
literal|6
operator|)
expr_stmt|;
if|if
condition|(
name|b
operator|<
literal|32
condition|)
name|b
operator|+=
literal|31
expr_stmt|;
else|else
name|b
operator|+=
literal|32
expr_stmt|;
name|b
operator|=
name|b
operator|>>
literal|6
expr_stmt|;
name|b
operator|=
name|MIN
argument_list|(
name|MAX
argument_list|(
name|b
argument_list|,
operator|-
literal|31
argument_list|)
argument_list|,
literal|31
argument_list|)
expr_stmt|;
name|tmpu16
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
literal|0x048a
argument_list|)
operator|&
literal|0xf000
expr_stmt|;
name|tmpu16
operator||=
operator|(
operator|(
name|uint32_t
operator|)
name|b
operator|&
literal|0x0000003f
operator|)
expr_stmt|;
name|tmpu16
operator||=
operator|(
operator|(
operator|(
name|uint32_t
operator|)
name|a
operator|&
literal|0x0000003f
operator|)
operator|<<
literal|6
operator|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x048a
argument_list|,
name|tmpu16
argument_list|)
expr_stmt|;
return|return;
block|}
name|tmp16
operator|=
name|bwn_nrssi_read
argument_list|(
name|mac
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp16
operator|>=
literal|0x20
condition|)
name|tmp16
operator|-=
literal|0x40
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
literal|0x048a
argument_list|,
literal|0xf000
argument_list|,
operator|(
name|tmp16
operator|<
literal|3
operator|)
condition|?
literal|0x09eb
else|:
literal|0x0aed
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_nrssi_slope_11g
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
define|#
directive|define
name|SAVE_RF_MAX
value|3
define|#
directive|define
name|SAVE_PHY_COMM_MAX
value|4
define|#
directive|define
name|SAVE_PHY3_MAX
value|8
specifier|static
specifier|const
name|uint16_t
name|save_rf_regs
index|[
name|SAVE_RF_MAX
index|]
init|=
block|{
literal|0x7a
block|,
literal|0x52
block|,
literal|0x43
block|}
decl_stmt|;
specifier|static
specifier|const
name|uint16_t
name|save_phy_comm_regs
index|[
name|SAVE_PHY_COMM_MAX
index|]
init|=
block|{
literal|0x15
block|,
literal|0x5a
block|,
literal|0x59
block|,
literal|0x58
block|}
decl_stmt|;
specifier|static
specifier|const
name|uint16_t
name|save_phy3_regs
index|[
name|SAVE_PHY3_MAX
index|]
init|=
block|{
literal|0x002e
block|,
literal|0x002f
block|,
literal|0x080f
block|,
name|BWN_PHY_G_LOCTL
block|,
literal|0x0801
block|,
literal|0x0060
block|,
literal|0x0014
block|,
literal|0x0478
block|}
decl_stmt|;
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwn_phy_g
modifier|*
name|pg
init|=
operator|&
name|phy
operator|->
name|phy_g
decl_stmt|;
name|int32_t
name|i
decl_stmt|,
name|tmp32
decl_stmt|,
name|phy3_idx
init|=
literal|0
decl_stmt|;
name|uint16_t
name|delta
decl_stmt|,
name|tmp
decl_stmt|;
name|uint16_t
name|save_rf
index|[
name|SAVE_RF_MAX
index|]
decl_stmt|;
name|uint16_t
name|save_phy_comm
index|[
name|SAVE_PHY_COMM_MAX
index|]
decl_stmt|;
name|uint16_t
name|save_phy3
index|[
name|SAVE_PHY3_MAX
index|]
decl_stmt|;
name|uint16_t
name|ant_div
decl_stmt|,
name|phy0
decl_stmt|,
name|chan_ex
decl_stmt|;
name|int16_t
name|nrssi0
decl_stmt|,
name|nrssi1
decl_stmt|;
name|KASSERT
argument_list|(
name|phy
operator|->
name|type
operator|==
name|BWN_PHYTYPE_G
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rf_rev
operator|>=
literal|9
condition|)
return|return;
if|if
condition|(
name|phy
operator|->
name|rf_rev
operator|==
literal|8
condition|)
name|bwn_nrssi_offset
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_G_CRS
argument_list|,
literal|0x7fff
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
literal|0x0802
argument_list|,
literal|0xfffc
argument_list|)
expr_stmt|;
comment|/* 	 * Save RF/PHY registers for later restoration 	 */
name|ant_div
operator|=
name|BWN_READ_2
argument_list|(
name|mac
argument_list|,
literal|0x03e2
argument_list|)
expr_stmt|;
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
literal|0x03e2
argument_list|,
name|BWN_READ_2
argument_list|(
name|mac
argument_list|,
literal|0x03e2
argument_list|)
operator||
literal|0x8000
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SAVE_RF_MAX
condition|;
operator|++
name|i
control|)
name|save_rf
index|[
name|i
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
name|save_rf_regs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SAVE_PHY_COMM_MAX
condition|;
operator|++
name|i
control|)
name|save_phy_comm
index|[
name|i
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|save_phy_comm_regs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|phy0
operator|=
name|BWN_READ_2
argument_list|(
name|mac
argument_list|,
name|BWN_PHY0
argument_list|)
expr_stmt|;
name|chan_ex
operator|=
name|BWN_READ_2
argument_list|(
name|mac
argument_list|,
name|BWN_CHANNEL_EXT
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|3
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SAVE_PHY3_MAX
condition|;
operator|++
name|i
control|)
name|save_phy3
index|[
name|i
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|save_phy3_regs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x002e
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_G_LOCTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|phy
operator|->
name|rev
condition|)
block|{
case|case
literal|4
case|:
case|case
literal|6
case|:
case|case
literal|7
case|:
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
literal|0x0478
argument_list|,
literal|0x0100
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
literal|0x0801
argument_list|,
literal|0x0040
argument_list|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
case|case
literal|5
case|:
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
literal|0x0801
argument_list|,
literal|0xffbf
argument_list|)
expr_stmt|;
break|break;
block|}
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
literal|0x0060
argument_list|,
literal|0x0040
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
literal|0x0014
argument_list|,
literal|0x0200
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Calculate nrssi0 	 */
name|BWN_RF_SET
argument_list|(
name|mac
argument_list|,
literal|0x007a
argument_list|,
literal|0x0070
argument_list|)
expr_stmt|;
name|bwn_set_all_gains
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|,
literal|8
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_RF_MASK
argument_list|(
name|mac
argument_list|,
literal|0x007a
argument_list|,
literal|0x00f7
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|2
condition|)
block|{
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
literal|0x0811
argument_list|,
literal|0xffcf
argument_list|,
literal|0x0030
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
literal|0x0812
argument_list|,
literal|0xffcf
argument_list|,
literal|0x0010
argument_list|)
expr_stmt|;
block|}
name|BWN_RF_SET
argument_list|(
name|mac
argument_list|,
literal|0x007a
argument_list|,
literal|0x0080
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|20
argument_list|)
expr_stmt|;
name|nrssi0
operator|=
call|(
name|int16_t
call|)
argument_list|(
operator|(
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
literal|0x047f
argument_list|)
operator|>>
literal|8
operator|)
operator|&
literal|0x003f
argument_list|)
expr_stmt|;
if|if
condition|(
name|nrssi0
operator|>=
literal|0x0020
condition|)
name|nrssi0
operator|-=
literal|0x0040
expr_stmt|;
comment|/* 	 * Calculate nrssi1 	 */
name|BWN_RF_MASK
argument_list|(
name|mac
argument_list|,
literal|0x007a
argument_list|,
literal|0x007f
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|2
condition|)
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
literal|0x0003
argument_list|,
literal|0xff9f
argument_list|,
literal|0x0040
argument_list|)
expr_stmt|;
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
name|BWN_CHANNEL_EXT
argument_list|,
name|BWN_READ_2
argument_list|(
name|mac
argument_list|,
name|BWN_CHANNEL_EXT
argument_list|)
operator||
literal|0x2000
argument_list|)
expr_stmt|;
name|BWN_RF_SET
argument_list|(
name|mac
argument_list|,
literal|0x007a
argument_list|,
literal|0x000f
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x0015
argument_list|,
literal|0xf330
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|2
condition|)
block|{
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
literal|0x0812
argument_list|,
literal|0xffcf
argument_list|,
literal|0x0020
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
literal|0x0811
argument_list|,
literal|0xffcf
argument_list|,
literal|0x0020
argument_list|)
expr_stmt|;
block|}
name|bwn_set_all_gains
argument_list|(
name|mac
argument_list|,
literal|3
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rf_rev
operator|==
literal|8
condition|)
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x0043
argument_list|,
literal|0x001f
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tmp
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
literal|0x0052
argument_list|)
operator|&
literal|0xff0f
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x0052
argument_list|,
name|tmp
operator||
literal|0x0060
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
literal|0x0043
argument_list|)
operator|&
literal|0xfff0
expr_stmt|;
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x0043
argument_list|,
name|tmp
operator||
literal|0x0009
argument_list|)
expr_stmt|;
block|}
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x005a
argument_list|,
literal|0x0480
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x0059
argument_list|,
literal|0x0810
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x0058
argument_list|,
literal|0x000d
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|20
argument_list|)
expr_stmt|;
name|nrssi1
operator|=
call|(
name|int16_t
call|)
argument_list|(
operator|(
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
literal|0x047f
argument_list|)
operator|>>
literal|8
operator|)
operator|&
literal|0x003f
argument_list|)
expr_stmt|;
comment|/* 	 * Install calculated narrow RSSI values 	 */
if|if
condition|(
name|nrssi1
operator|>=
literal|0x0020
condition|)
name|nrssi1
operator|-=
literal|0x0040
expr_stmt|;
if|if
condition|(
name|nrssi0
operator|==
name|nrssi1
condition|)
name|pg
operator|->
name|pg_nrssi_slope
operator|=
literal|0x00010000
expr_stmt|;
else|else
name|pg
operator|->
name|pg_nrssi_slope
operator|=
literal|0x00400000
operator|/
operator|(
name|nrssi0
operator|-
name|nrssi1
operator|)
expr_stmt|;
if|if
condition|(
name|nrssi0
operator|>=
operator|-
literal|4
condition|)
block|{
name|pg
operator|->
name|pg_nrssi
index|[
literal|0
index|]
operator|=
name|nrssi1
expr_stmt|;
name|pg
operator|->
name|pg_nrssi
index|[
literal|1
index|]
operator|=
name|nrssi0
expr_stmt|;
block|}
comment|/* 	 * Restore saved RF/PHY registers 	 */
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|3
condition|)
block|{
for|for
control|(
name|phy3_idx
operator|=
literal|0
init|;
name|phy3_idx
operator|<
literal|4
condition|;
operator|++
name|phy3_idx
control|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|save_phy3_regs
index|[
name|phy3_idx
index|]
argument_list|,
name|save_phy3
index|[
name|phy3_idx
index|]
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|2
condition|)
block|{
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
literal|0x0812
argument_list|,
literal|0xffcf
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
literal|0x0811
argument_list|,
literal|0xffcf
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SAVE_RF_MAX
condition|;
operator|++
name|i
control|)
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|save_rf_regs
index|[
name|i
index|]
argument_list|,
name|save_rf
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
literal|0x03e2
argument_list|,
name|ant_div
argument_list|)
expr_stmt|;
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
literal|0x03e6
argument_list|,
name|phy0
argument_list|)
expr_stmt|;
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
name|BWN_CHANNEL_EXT
argument_list|,
name|chan_ex
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SAVE_PHY_COMM_MAX
condition|;
operator|++
name|i
control|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|save_phy_comm_regs
index|[
name|i
index|]
argument_list|,
name|save_phy_comm
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|bwn_spu_workaround
argument_list|(
name|mac
argument_list|,
name|phy
operator|->
name|chan
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
literal|0x0802
argument_list|,
operator|(
literal|0x0001
operator||
literal|0x0002
operator|)
argument_list|)
expr_stmt|;
name|bwn_set_original_gains
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_G_CRS
argument_list|,
literal|0x8000
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|3
condition|)
block|{
for|for
control|(
init|;
name|phy3_idx
operator|<
name|SAVE_PHY3_MAX
condition|;
operator|++
name|phy3_idx
control|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|save_phy3_regs
index|[
name|phy3_idx
index|]
argument_list|,
name|save_phy3
index|[
name|phy3_idx
index|]
argument_list|)
expr_stmt|;
block|}
block|}
name|delta
operator|=
literal|0x1f
operator|-
name|pg
operator|->
name|pg_nrssi
index|[
literal|0
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|64
condition|;
name|i
operator|++
control|)
block|{
name|tmp32
operator|=
operator|(
operator|(
operator|(
name|i
operator|-
name|delta
operator|)
operator|*
name|pg
operator|->
name|pg_nrssi_slope
operator|)
operator|/
literal|0x10000
operator|)
operator|+
literal|0x3a
expr_stmt|;
name|tmp32
operator|=
name|MIN
argument_list|(
name|MAX
argument_list|(
name|tmp32
argument_list|,
literal|0
argument_list|)
argument_list|,
literal|0x3f
argument_list|)
expr_stmt|;
name|pg
operator|->
name|pg_nrssi_lt
index|[
name|i
index|]
operator|=
name|tmp32
expr_stmt|;
block|}
name|bwn_nrssi_threshold
argument_list|(
name|mac
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|SAVE_RF_MAX
undef|#
directive|undef
name|SAVE_PHY_COMM_MAX
undef|#
directive|undef
name|SAVE_PHY3_MAX
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_nrssi_offset
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
define|#
directive|define
name|SAVE_RF_MAX
value|2
define|#
directive|define
name|SAVE_PHY_COMM_MAX
value|10
define|#
directive|define
name|SAVE_PHY6_MAX
value|8
specifier|static
specifier|const
name|uint16_t
name|save_rf_regs
index|[
name|SAVE_RF_MAX
index|]
init|=
block|{
literal|0x7a
block|,
literal|0x43
block|}
decl_stmt|;
specifier|static
specifier|const
name|uint16_t
name|save_phy_comm_regs
index|[
name|SAVE_PHY_COMM_MAX
index|]
init|=
block|{
literal|0x0001
block|,
literal|0x0811
block|,
literal|0x0812
block|,
literal|0x0814
block|,
literal|0x0815
block|,
literal|0x005a
block|,
literal|0x0059
block|,
literal|0x0058
block|,
literal|0x000a
block|,
literal|0x0003
block|}
decl_stmt|;
specifier|static
specifier|const
name|uint16_t
name|save_phy6_regs
index|[
name|SAVE_PHY6_MAX
index|]
init|=
block|{
literal|0x002e
block|,
literal|0x002f
block|,
literal|0x080f
block|,
literal|0x0810
block|,
literal|0x0801
block|,
literal|0x0060
block|,
literal|0x0014
block|,
literal|0x0478
block|}
decl_stmt|;
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|int
name|i
decl_stmt|,
name|phy6_idx
init|=
literal|0
decl_stmt|;
name|uint16_t
name|save_rf
index|[
name|SAVE_RF_MAX
index|]
decl_stmt|;
name|uint16_t
name|save_phy_comm
index|[
name|SAVE_PHY_COMM_MAX
index|]
decl_stmt|;
name|uint16_t
name|save_phy6
index|[
name|SAVE_PHY6_MAX
index|]
decl_stmt|;
name|int16_t
name|nrssi
decl_stmt|;
name|uint16_t
name|saved
init|=
literal|0xffff
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SAVE_PHY_COMM_MAX
condition|;
operator|++
name|i
control|)
name|save_phy_comm
index|[
name|i
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|save_phy_comm_regs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SAVE_RF_MAX
condition|;
operator|++
name|i
control|)
name|save_rf
index|[
name|i
index|]
operator|=
name|BWN_RF_READ
argument_list|(
name|mac
argument_list|,
name|save_rf_regs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
literal|0x0429
argument_list|,
literal|0x7fff
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
literal|0x0001
argument_list|,
literal|0x3fff
argument_list|,
literal|0x4000
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
literal|0x0811
argument_list|,
literal|0x000c
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
literal|0x0812
argument_list|,
literal|0xfff3
argument_list|,
literal|0x0004
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
literal|0x0802
argument_list|,
operator|~
operator|(
literal|0x1
operator||
literal|0x2
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|6
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SAVE_PHY6_MAX
condition|;
operator|++
name|i
control|)
name|save_phy6
index|[
name|i
index|]
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|save_phy6_regs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x002e
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x002f
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x080f
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x0810
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
literal|0x0478
argument_list|,
literal|0x0100
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
literal|0x0801
argument_list|,
literal|0x0040
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
literal|0x0060
argument_list|,
literal|0x0040
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
literal|0x0014
argument_list|,
literal|0x0200
argument_list|)
expr_stmt|;
block|}
name|BWN_RF_SET
argument_list|(
name|mac
argument_list|,
literal|0x007a
argument_list|,
literal|0x0070
argument_list|)
expr_stmt|;
name|BWN_RF_SET
argument_list|(
name|mac
argument_list|,
literal|0x007a
argument_list|,
literal|0x0080
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|30
argument_list|)
expr_stmt|;
name|nrssi
operator|=
call|(
name|int16_t
call|)
argument_list|(
operator|(
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
literal|0x047f
argument_list|)
operator|>>
literal|8
operator|)
operator|&
literal|0x003f
argument_list|)
expr_stmt|;
if|if
condition|(
name|nrssi
operator|>=
literal|0x20
condition|)
name|nrssi
operator|-=
literal|0x40
expr_stmt|;
if|if
condition|(
name|nrssi
operator|==
literal|31
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|7
init|;
name|i
operator|>=
literal|4
condition|;
name|i
operator|--
control|)
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x007b
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|20
argument_list|)
expr_stmt|;
name|nrssi
operator|=
call|(
name|int16_t
call|)
argument_list|(
operator|(
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
literal|0x047f
argument_list|)
operator|>>
literal|8
operator|)
operator|&
literal|0x003f
argument_list|)
expr_stmt|;
if|if
condition|(
name|nrssi
operator|>=
literal|0x20
condition|)
name|nrssi
operator|-=
literal|0x40
expr_stmt|;
if|if
condition|(
name|nrssi
operator|<
literal|31
operator|&&
name|saved
operator|==
literal|0xffff
condition|)
name|saved
operator|=
name|i
expr_stmt|;
block|}
if|if
condition|(
name|saved
operator|==
literal|0xffff
condition|)
name|saved
operator|=
literal|4
expr_stmt|;
block|}
else|else
block|{
name|BWN_RF_MASK
argument_list|(
name|mac
argument_list|,
literal|0x007a
argument_list|,
literal|0x007f
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|!=
literal|1
condition|)
block|{
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
literal|0x0814
argument_list|,
literal|0x0001
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
literal|0x0815
argument_list|,
literal|0xfffe
argument_list|)
expr_stmt|;
block|}
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
literal|0x0811
argument_list|,
literal|0x000c
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
literal|0x0812
argument_list|,
literal|0x000c
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
literal|0x0811
argument_list|,
literal|0x0030
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
literal|0x0812
argument_list|,
literal|0x0030
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x005a
argument_list|,
literal|0x0480
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x0059
argument_list|,
literal|0x0810
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x0058
argument_list|,
literal|0x000d
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|==
literal|0
condition|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x0003
argument_list|,
literal|0x0122
argument_list|)
expr_stmt|;
else|else
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
literal|0x000a
argument_list|,
literal|0x2000
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|!=
literal|1
condition|)
block|{
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
literal|0x0814
argument_list|,
literal|0x0004
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
literal|0x0815
argument_list|,
literal|0xfffb
argument_list|)
expr_stmt|;
block|}
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
literal|0x0003
argument_list|,
literal|0xff9f
argument_list|,
literal|0x0040
argument_list|)
expr_stmt|;
name|BWN_RF_SET
argument_list|(
name|mac
argument_list|,
literal|0x007a
argument_list|,
literal|0x000f
argument_list|)
expr_stmt|;
name|bwn_set_all_gains
argument_list|(
name|mac
argument_list|,
literal|3
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|BWN_RF_SETMASK
argument_list|(
name|mac
argument_list|,
literal|0x0043
argument_list|,
literal|0x00f0
argument_list|,
literal|0x000f
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|30
argument_list|)
expr_stmt|;
name|nrssi
operator|=
call|(
name|int16_t
call|)
argument_list|(
operator|(
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
literal|0x047f
argument_list|)
operator|>>
literal|8
operator|)
operator|&
literal|0x003f
argument_list|)
expr_stmt|;
if|if
condition|(
name|nrssi
operator|>=
literal|0x20
condition|)
name|nrssi
operator|-=
literal|0x40
expr_stmt|;
if|if
condition|(
name|nrssi
operator|==
operator|-
literal|32
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x007b
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|20
argument_list|)
expr_stmt|;
name|nrssi
operator|=
call|(
name|int16_t
call|)
argument_list|(
operator|(
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
literal|0x047f
argument_list|)
operator|>>
literal|8
operator|)
operator|&
literal|0x003f
argument_list|)
expr_stmt|;
if|if
condition|(
name|nrssi
operator|>=
literal|0x20
condition|)
name|nrssi
operator|-=
literal|0x40
expr_stmt|;
if|if
condition|(
name|nrssi
operator|>
operator|-
literal|31
operator|&&
name|saved
operator|==
literal|0xffff
condition|)
name|saved
operator|=
name|i
expr_stmt|;
block|}
if|if
condition|(
name|saved
operator|==
literal|0xffff
condition|)
name|saved
operator|=
literal|3
expr_stmt|;
block|}
else|else
name|saved
operator|=
literal|0
expr_stmt|;
block|}
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x007b
argument_list|,
name|saved
argument_list|)
expr_stmt|;
comment|/* 	 * Restore saved RF/PHY registers 	 */
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|6
condition|)
block|{
for|for
control|(
name|phy6_idx
operator|=
literal|0
init|;
name|phy6_idx
operator|<
literal|4
condition|;
operator|++
name|phy6_idx
control|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|save_phy6_regs
index|[
name|phy6_idx
index|]
argument_list|,
name|save_phy6
index|[
name|phy6_idx
index|]
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|phy
operator|->
name|rev
operator|!=
literal|1
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|3
init|;
name|i
operator|<
literal|5
condition|;
name|i
operator|++
control|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|save_phy_comm_regs
index|[
name|i
index|]
argument_list|,
name|save_phy_comm
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|5
init|;
name|i
operator|<
name|SAVE_PHY_COMM_MAX
condition|;
name|i
operator|++
control|)
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|save_phy_comm_regs
index|[
name|i
index|]
argument_list|,
name|save_phy_comm
index|[
name|i
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|SAVE_RF_MAX
operator|-
literal|1
init|;
name|i
operator|>=
literal|0
condition|;
operator|--
name|i
control|)
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
name|save_rf_regs
index|[
name|i
index|]
argument_list|,
name|save_rf
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x0802
argument_list|,
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
literal|0x0802
argument_list|)
operator||
literal|0x1
operator||
literal|0x2
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
literal|0x0429
argument_list|,
literal|0x8000
argument_list|)
expr_stmt|;
name|bwn_set_original_gains
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|>=
literal|6
condition|)
block|{
for|for
control|(
init|;
name|phy6_idx
operator|<
name|SAVE_PHY6_MAX
condition|;
operator|++
name|phy6_idx
control|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|save_phy6_regs
index|[
name|phy6_idx
index|]
argument_list|,
name|save_phy6
index|[
name|phy6_idx
index|]
argument_list|)
expr_stmt|;
block|}
block|}
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|save_phy_comm_regs
index|[
literal|0
index|]
argument_list|,
name|save_phy_comm
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|save_phy_comm_regs
index|[
literal|2
index|]
argument_list|,
name|save_phy_comm
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|save_phy_comm_regs
index|[
literal|1
index|]
argument_list|,
name|save_phy_comm
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_set_all_gains
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|int16_t
name|first
parameter_list|,
name|int16_t
name|second
parameter_list|,
name|int16_t
name|third
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|uint16_t
name|i
decl_stmt|;
name|uint16_t
name|start
init|=
literal|0x08
decl_stmt|,
name|end
init|=
literal|0x18
decl_stmt|;
name|uint16_t
name|tmp
decl_stmt|;
name|uint16_t
name|table
decl_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|<=
literal|1
condition|)
block|{
name|start
operator|=
literal|0x10
expr_stmt|;
name|end
operator|=
literal|0x20
expr_stmt|;
block|}
name|table
operator|=
name|BWN_OFDMTAB_GAINX
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|<=
literal|1
condition|)
name|table
operator|=
name|BWN_OFDMTAB_GAINX_R1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
name|bwn_ofdmtab_write_2
argument_list|(
name|mac
argument_list|,
name|table
argument_list|,
name|i
argument_list|,
name|first
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|start
init|;
name|i
operator|<
name|end
condition|;
name|i
operator|++
control|)
name|bwn_ofdmtab_write_2
argument_list|(
name|mac
argument_list|,
name|table
argument_list|,
name|i
argument_list|,
name|second
argument_list|)
expr_stmt|;
if|if
condition|(
name|third
operator|!=
operator|-
literal|1
condition|)
block|{
name|tmp
operator|=
operator|(
operator|(
name|uint16_t
operator|)
name|third
operator|<<
literal|14
operator|)
operator||
operator|(
operator|(
name|uint16_t
operator|)
name|third
operator|<<
literal|6
operator|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
literal|0x04a0
argument_list|,
literal|0xbfbf
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
literal|0x04a1
argument_list|,
literal|0xbfbf
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
literal|0x04a2
argument_list|,
literal|0xbfbf
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
name|bwn_dummy_transmission
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_set_original_gains
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|uint16_t
name|i
decl_stmt|,
name|tmp
decl_stmt|;
name|uint16_t
name|table
decl_stmt|;
name|uint16_t
name|start
init|=
literal|0x0008
decl_stmt|,
name|end
init|=
literal|0x0018
decl_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|<=
literal|1
condition|)
block|{
name|start
operator|=
literal|0x0010
expr_stmt|;
name|end
operator|=
literal|0x0020
expr_stmt|;
block|}
name|table
operator|=
name|BWN_OFDMTAB_GAINX
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rev
operator|<=
literal|1
condition|)
name|table
operator|=
name|BWN_OFDMTAB_GAINX_R1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
name|tmp
operator|=
operator|(
name|i
operator|&
literal|0xfffc
operator|)
expr_stmt|;
name|tmp
operator||=
operator|(
name|i
operator|&
literal|0x0001
operator|)
operator|<<
literal|1
expr_stmt|;
name|tmp
operator||=
operator|(
name|i
operator|&
literal|0x0002
operator|)
operator|>>
literal|1
expr_stmt|;
name|bwn_ofdmtab_write_2
argument_list|(
name|mac
argument_list|,
name|table
argument_list|,
name|i
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
name|start
init|;
name|i
operator|<
name|end
condition|;
name|i
operator|++
control|)
name|bwn_ofdmtab_write_2
argument_list|(
name|mac
argument_list|,
name|table
argument_list|,
name|i
argument_list|,
name|i
operator|-
name|start
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
literal|0x04a0
argument_list|,
literal|0xbfbf
argument_list|,
literal|0x4040
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
literal|0x04a1
argument_list|,
literal|0xbfbf
argument_list|,
literal|0x4040
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
literal|0x04a2
argument_list|,
literal|0xbfbf
argument_list|,
literal|0x4000
argument_list|)
expr_stmt|;
name|bwn_dummy_transmission
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_phy_hwpctl_init
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwn_phy_g
modifier|*
name|pg
init|=
operator|&
name|phy
operator|->
name|phy_g
decl_stmt|;
name|struct
name|bwn_rfatt
name|old_rfatt
decl_stmt|,
name|rfatt
decl_stmt|;
name|struct
name|bwn_bbatt
name|old_bbatt
decl_stmt|,
name|bbatt
decl_stmt|;
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|uint8_t
name|old_txctl
init|=
literal|0
decl_stmt|;
name|KASSERT
argument_list|(
name|phy
operator|->
name|type
operator|==
name|BWN_PHYTYPE_G
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|siba_get_pci_subvendor
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
name|SIBA_BOARDVENDOR_BCM
operator|)
operator|&&
operator|(
name|siba_get_pci_subdevice
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
name|SIBA_BOARD_BU4306
operator|)
condition|)
return|return;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x0028
argument_list|,
literal|0x8018
argument_list|)
expr_stmt|;
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
name|BWN_PHY0
argument_list|,
name|BWN_READ_2
argument_list|(
name|mac
argument_list|,
name|BWN_PHY0
argument_list|)
operator|&
literal|0xffdf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|phy
operator|->
name|gmode
condition|)
return|return;
name|bwn_hwpctl_early_init
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|pg
operator|->
name|pg_curtssi
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|phy
operator|->
name|rf_ver
operator|==
literal|0x2050
operator|&&
name|phy
operator|->
name|analog
operator|==
literal|0
condition|)
block|{
name|BWN_RF_SETMASK
argument_list|(
name|mac
argument_list|,
literal|0x0076
argument_list|,
literal|0x00f7
argument_list|,
literal|0x0084
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|memcpy
argument_list|(
operator|&
name|old_rfatt
argument_list|,
operator|&
name|pg
operator|->
name|pg_rfatt
argument_list|,
sizeof|sizeof
argument_list|(
name|old_rfatt
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|old_bbatt
argument_list|,
operator|&
name|pg
operator|->
name|pg_bbatt
argument_list|,
sizeof|sizeof
argument_list|(
name|old_bbatt
argument_list|)
argument_list|)
expr_stmt|;
name|old_txctl
operator|=
name|pg
operator|->
name|pg_txctl
expr_stmt|;
name|bbatt
operator|.
name|att
operator|=
literal|11
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rf_rev
operator|==
literal|8
condition|)
block|{
name|rfatt
operator|.
name|att
operator|=
literal|15
expr_stmt|;
name|rfatt
operator|.
name|padmix
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|rfatt
operator|.
name|att
operator|=
literal|9
expr_stmt|;
name|rfatt
operator|.
name|padmix
operator|=
literal|0
expr_stmt|;
block|}
name|bwn_phy_g_set_txpwr_sub
argument_list|(
name|mac
argument_list|,
operator|&
name|bbatt
argument_list|,
operator|&
name|rfatt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|bwn_dummy_transmission
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pg
operator|->
name|pg_curtssi
operator|=
name|BWN_PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_TSSI
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rf_ver
operator|==
literal|0x2050
operator|&&
name|phy
operator|->
name|analog
operator|==
literal|0
condition|)
name|BWN_RF_MASK
argument_list|(
name|mac
argument_list|,
literal|0x0076
argument_list|,
literal|0xff7b
argument_list|)
expr_stmt|;
else|else
name|bwn_phy_g_set_txpwr_sub
argument_list|(
name|mac
argument_list|,
operator|&
name|old_bbatt
argument_list|,
operator|&
name|old_rfatt
argument_list|,
name|old_txctl
argument_list|)
expr_stmt|;
block|}
name|bwn_hwpctl_init_gphy
argument_list|(
name|mac
argument_list|)
expr_stmt|;
comment|/* clear TSSI */
name|bwn_shm_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
literal|0x0058
argument_list|,
literal|0x7f7f
argument_list|)
expr_stmt|;
name|bwn_shm_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
literal|0x005a
argument_list|,
literal|0x7f7f
argument_list|)
expr_stmt|;
name|bwn_shm_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
literal|0x0070
argument_list|,
literal|0x7f7f
argument_list|)
expr_stmt|;
name|bwn_shm_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
literal|0x0072
argument_list|,
literal|0x7f7f
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_hwpctl_early_init
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
if|if
condition|(
operator|!
name|bwn_has_hwpctl
argument_list|(
name|mac
argument_list|)
condition|)
block|{
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x047a
argument_list|,
literal|0xc111
argument_list|)
expr_stmt|;
return|return;
block|}
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
literal|0x0036
argument_list|,
literal|0xfeff
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x002f
argument_list|,
literal|0x0202
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
literal|0x047c
argument_list|,
literal|0x0002
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
literal|0x047a
argument_list|,
literal|0xf000
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rf_ver
operator|==
literal|0x2050
operator|&&
name|phy
operator|->
name|rf_rev
operator|==
literal|8
condition|)
block|{
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
literal|0x047a
argument_list|,
literal|0xff0f
argument_list|,
literal|0x0010
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
literal|0x005d
argument_list|,
literal|0x8000
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
literal|0x004e
argument_list|,
literal|0xffc0
argument_list|,
literal|0x0010
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x002e
argument_list|,
literal|0xc07f
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
literal|0x0036
argument_list|,
literal|0x0400
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
literal|0x0036
argument_list|,
literal|0x0200
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
literal|0x0036
argument_list|,
literal|0x0400
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
literal|0x005d
argument_list|,
literal|0x7fff
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
literal|0x004f
argument_list|,
literal|0xfffe
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
literal|0x004e
argument_list|,
literal|0xffc0
argument_list|,
literal|0x0010
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x002e
argument_list|,
literal|0xc07f
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
literal|0x047a
argument_list|,
literal|0xff0f
argument_list|,
literal|0x0010
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_hwpctl_init_gphy
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwn_phy_g
modifier|*
name|pg
init|=
operator|&
name|phy
operator|->
name|phy_g
decl_stmt|;
name|struct
name|bwn_txpwr_loctl
modifier|*
name|lo
init|=
operator|&
name|pg
operator|->
name|pg_loctl
decl_stmt|;
name|int
name|i
decl_stmt|;
name|uint16_t
name|nr_written
init|=
literal|0
decl_stmt|,
name|tmp
decl_stmt|,
name|value
decl_stmt|;
name|uint8_t
name|rf
decl_stmt|,
name|bb
decl_stmt|;
if|if
condition|(
operator|!
name|bwn_has_hwpctl
argument_list|(
name|mac
argument_list|)
condition|)
block|{
name|bwn_hf_write
argument_list|(
name|mac
argument_list|,
name|bwn_hf_read
argument_list|(
name|mac
argument_list|)
operator|&
operator|~
name|BWN_HF_HW_POWERCTL
argument_list|)
expr_stmt|;
return|return;
block|}
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
literal|0x0036
argument_list|,
literal|0xffc0
argument_list|,
operator|(
name|pg
operator|->
name|pg_idletssi
operator|-
name|pg
operator|->
name|pg_curtssi
operator|)
argument_list|)
expr_stmt|;
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
literal|0x0478
argument_list|,
literal|0xff00
argument_list|,
operator|(
name|pg
operator|->
name|pg_idletssi
operator|-
name|pg
operator|->
name|pg_curtssi
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
name|bwn_ofdmtab_write_2
argument_list|(
name|mac
argument_list|,
literal|0x3c20
argument_list|,
name|i
argument_list|,
name|pg
operator|->
name|pg_tssi2dbm
index|[
name|i
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|32
init|;
name|i
operator|<
literal|64
condition|;
name|i
operator|++
control|)
name|bwn_ofdmtab_write_2
argument_list|(
name|mac
argument_list|,
literal|0x3c00
argument_list|,
name|i
operator|-
literal|32
argument_list|,
name|pg
operator|->
name|pg_tssi2dbm
index|[
name|i
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|64
condition|;
name|i
operator|+=
literal|2
control|)
block|{
name|value
operator|=
operator|(
name|uint16_t
operator|)
name|pg
operator|->
name|pg_tssi2dbm
index|[
name|i
index|]
expr_stmt|;
name|value
operator||=
operator|(
operator|(
name|uint16_t
operator|)
name|pg
operator|->
name|pg_tssi2dbm
index|[
name|i
operator|+
literal|1
index|]
operator|)
operator|<<
literal|8
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x380
operator|+
operator|(
name|i
operator|/
literal|2
operator|)
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|rf
operator|=
literal|0
init|;
name|rf
operator|<
name|lo
operator|->
name|rfatt
operator|.
name|len
condition|;
name|rf
operator|++
control|)
block|{
for|for
control|(
name|bb
operator|=
literal|0
init|;
name|bb
operator|<
name|lo
operator|->
name|bbatt
operator|.
name|len
condition|;
name|bb
operator|++
control|)
block|{
if|if
condition|(
name|nr_written
operator|>=
literal|0x40
condition|)
return|return;
name|tmp
operator|=
name|lo
operator|->
name|bbatt
operator|.
name|array
index|[
name|bb
index|]
operator|.
name|att
expr_stmt|;
name|tmp
operator|<<=
literal|8
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rf_rev
operator|==
literal|8
condition|)
name|tmp
operator||=
literal|0x50
expr_stmt|;
else|else
name|tmp
operator||=
literal|0x40
expr_stmt|;
name|tmp
operator||=
name|lo
operator|->
name|rfatt
operator|.
name|array
index|[
name|rf
index|]
operator|.
name|att
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x3c0
operator|+
name|nr_written
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|nr_written
operator|++
expr_stmt|;
block|}
block|}
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
literal|0x0060
argument_list|,
literal|0xffbf
argument_list|)
expr_stmt|;
name|BWN_PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x0014
argument_list|,
literal|0x0000
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|phy
operator|->
name|rev
operator|>=
literal|6
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
name|BWN_PHY_SET
argument_list|(
name|mac
argument_list|,
literal|0x0478
argument_list|,
literal|0x0800
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
literal|0x0478
argument_list|,
literal|0xfeff
argument_list|)
expr_stmt|;
name|BWN_PHY_MASK
argument_list|(
name|mac
argument_list|,
literal|0x0801
argument_list|,
literal|0xffbf
argument_list|)
expr_stmt|;
name|bwn_phy_g_dc_lookup_init
argument_list|(
name|mac
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|bwn_hf_write
argument_list|(
name|mac
argument_list|,
name|bwn_hf_read
argument_list|(
name|mac
argument_list|)
operator||
name|BWN_HF_HW_POWERCTL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_phy_g_switch_chan
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|int
name|channel
parameter_list|,
name|uint8_t
name|spu
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
if|if
condition|(
name|spu
operator|!=
literal|0
condition|)
name|bwn_spu_workaround
argument_list|(
name|mac
argument_list|,
name|channel
argument_list|)
expr_stmt|;
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
name|BWN_CHANNEL
argument_list|,
name|bwn_phy_g_chan2freq
argument_list|(
name|channel
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|channel
operator|==
literal|14
condition|)
block|{
if|if
condition|(
name|siba_sprom_get_ccode
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
name|SIBA_CCODE_JAPAN
condition|)
name|bwn_hf_write
argument_list|(
name|mac
argument_list|,
name|bwn_hf_read
argument_list|(
name|mac
argument_list|)
operator|&
operator|~
name|BWN_HF_JAPAN_CHAN14_OFF
argument_list|)
expr_stmt|;
else|else
name|bwn_hf_write
argument_list|(
name|mac
argument_list|,
name|bwn_hf_read
argument_list|(
name|mac
argument_list|)
operator||
name|BWN_HF_JAPAN_CHAN14_OFF
argument_list|)
expr_stmt|;
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
name|BWN_CHANNEL_EXT
argument_list|,
name|BWN_READ_2
argument_list|(
name|mac
argument_list|,
name|BWN_CHANNEL_EXT
argument_list|)
operator||
operator|(
literal|1
operator|<<
literal|11
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
name|BWN_CHANNEL_EXT
argument_list|,
name|BWN_READ_2
argument_list|(
name|mac
argument_list|,
name|BWN_CHANNEL_EXT
argument_list|)
operator|&
literal|0xf7bf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|uint16_t
name|bwn_phy_g_chan2freq
parameter_list|(
name|uint8_t
name|channel
parameter_list|)
block|{
specifier|static
specifier|const
name|uint8_t
name|bwn_phy_g_rf_channels
index|[]
init|=
name|BWN_PHY_G_RF_CHANNELS
decl_stmt|;
name|KASSERT
argument_list|(
name|channel
operator|>=
literal|1
operator|&&
name|channel
operator|<=
literal|14
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|bwn_phy_g_rf_channels
index|[
name|channel
operator|-
literal|1
index|]
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_phy_g_set_txpwr_sub
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
specifier|const
name|struct
name|bwn_bbatt
modifier|*
name|bbatt
parameter_list|,
specifier|const
name|struct
name|bwn_rfatt
modifier|*
name|rfatt
parameter_list|,
name|uint8_t
name|txctl
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwn_phy_g
modifier|*
name|pg
init|=
operator|&
name|phy
operator|->
name|phy_g
decl_stmt|;
name|struct
name|bwn_txpwr_loctl
modifier|*
name|lo
init|=
operator|&
name|pg
operator|->
name|pg_loctl
decl_stmt|;
name|uint16_t
name|bb
decl_stmt|,
name|rf
decl_stmt|;
name|uint16_t
name|tx_bias
decl_stmt|,
name|tx_magn
decl_stmt|;
name|bb
operator|=
name|bbatt
operator|->
name|att
expr_stmt|;
name|rf
operator|=
name|rfatt
operator|->
name|att
expr_stmt|;
name|tx_bias
operator|=
name|lo
operator|->
name|tx_bias
expr_stmt|;
name|tx_magn
operator|=
name|lo
operator|->
name|tx_magn
expr_stmt|;
if|if
condition|(
name|tx_bias
operator|==
literal|0xff
condition|)
name|tx_bias
operator|=
literal|0
expr_stmt|;
name|pg
operator|->
name|pg_txctl
operator|=
name|txctl
expr_stmt|;
name|memmove
argument_list|(
operator|&
name|pg
operator|->
name|pg_rfatt
argument_list|,
name|rfatt
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|rfatt
argument_list|)
argument_list|)
expr_stmt|;
name|pg
operator|->
name|pg_rfatt
operator|.
name|padmix
operator|=
operator|(
name|txctl
operator|&
name|BWN_TXCTL_TXMIX
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|memmove
argument_list|(
operator|&
name|pg
operator|->
name|pg_bbatt
argument_list|,
name|bbatt
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|bbatt
argument_list|)
argument_list|)
expr_stmt|;
name|bwn_phy_g_set_bbatt
argument_list|(
name|mac
argument_list|,
name|bb
argument_list|)
expr_stmt|;
name|bwn_shm_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
name|BWN_SHARED_RADIO_ATT
argument_list|,
name|rf
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rf_ver
operator|==
literal|0x2050
operator|&&
name|phy
operator|->
name|rf_rev
operator|==
literal|8
condition|)
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x43
argument_list|,
operator|(
name|rf
operator|&
literal|0x000f
operator|)
operator||
operator|(
name|txctl
operator|&
literal|0x0070
operator|)
argument_list|)
expr_stmt|;
else|else
block|{
name|BWN_RF_SETMASK
argument_list|(
name|mac
argument_list|,
literal|0x43
argument_list|,
literal|0xfff0
argument_list|,
operator|(
name|rf
operator|&
literal|0x000f
operator|)
argument_list|)
expr_stmt|;
name|BWN_RF_SETMASK
argument_list|(
name|mac
argument_list|,
literal|0x52
argument_list|,
operator|~
literal|0x0070
argument_list|,
operator|(
name|txctl
operator|&
literal|0x0070
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|BWN_HAS_TXMAG
argument_list|(
name|phy
argument_list|)
condition|)
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x52
argument_list|,
name|tx_magn
operator||
name|tx_bias
argument_list|)
expr_stmt|;
else|else
name|BWN_RF_SETMASK
argument_list|(
name|mac
argument_list|,
literal|0x52
argument_list|,
literal|0xfff0
argument_list|,
operator|(
name|tx_bias
operator|&
literal|0x000f
operator|)
argument_list|)
expr_stmt|;
name|bwn_lo_g_adjust
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_phy_g_set_bbatt
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint16_t
name|bbatt
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
if|if
condition|(
name|phy
operator|->
name|analog
operator|==
literal|0
condition|)
block|{
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
name|BWN_PHY0
argument_list|,
operator|(
name|BWN_READ_2
argument_list|(
name|mac
argument_list|,
name|BWN_PHY0
argument_list|)
operator|&
literal|0xfff0
operator|)
operator||
name|bbatt
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|phy
operator|->
name|analog
operator|>
literal|1
condition|)
block|{
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_DACCTL
argument_list|,
literal|0xffc3
argument_list|,
name|bbatt
operator|<<
literal|2
argument_list|)
expr_stmt|;
return|return;
block|}
name|BWN_PHY_SETMASK
argument_list|(
name|mac
argument_list|,
name|BWN_PHY_DACCTL
argument_list|,
literal|0xff87
argument_list|,
name|bbatt
operator|<<
literal|3
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|uint16_t
name|bwn_rf_2050_rfoverval
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint16_t
name|reg
parameter_list|,
name|uint32_t
name|lpd
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwn_phy_g
modifier|*
name|pg
init|=
operator|&
name|phy
operator|->
name|phy_g
decl_stmt|;
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|int
name|max_lb_gain
decl_stmt|;
name|uint16_t
name|extlna
decl_stmt|;
name|uint16_t
name|i
decl_stmt|;
if|if
condition|(
name|phy
operator|->
name|gmode
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|BWN_HAS_LOOPBACK
argument_list|(
name|phy
argument_list|)
condition|)
block|{
name|max_lb_gain
operator|=
name|pg
operator|->
name|pg_max_lb_gain
expr_stmt|;
name|max_lb_gain
operator|+=
operator|(
name|phy
operator|->
name|rf_rev
operator|==
literal|8
operator|)
condition|?
literal|0x3e
else|:
literal|0x26
expr_stmt|;
if|if
condition|(
name|max_lb_gain
operator|>=
literal|0x46
condition|)
block|{
name|extlna
operator|=
literal|0x3000
expr_stmt|;
name|max_lb_gain
operator|-=
literal|0x46
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|max_lb_gain
operator|>=
literal|0x3a
condition|)
block|{
name|extlna
operator|=
literal|0x1000
expr_stmt|;
name|max_lb_gain
operator|-=
literal|0x3a
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|max_lb_gain
operator|>=
literal|0x2e
condition|)
block|{
name|extlna
operator|=
literal|0x2000
expr_stmt|;
name|max_lb_gain
operator|-=
literal|0x2e
expr_stmt|;
block|}
else|else
block|{
name|extlna
operator|=
literal|0
expr_stmt|;
name|max_lb_gain
operator|-=
literal|0x10
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
block|{
name|max_lb_gain
operator|-=
operator|(
name|i
operator|*
literal|6
operator|)
expr_stmt|;
if|if
condition|(
name|max_lb_gain
operator|<
literal|6
condition|)
break|break;
block|}
if|if
condition|(
operator|(
name|phy
operator|->
name|rev
operator|<
literal|7
operator|)
operator|||
operator|!
operator|(
name|siba_sprom_get_bf_lo
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|&
name|BWN_BFL_EXTLNA
operator|)
condition|)
block|{
if|if
condition|(
name|reg
operator|==
name|BWN_PHY_RFOVER
condition|)
block|{
return|return
operator|(
literal|0x1b3
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|reg
operator|==
name|BWN_PHY_RFOVERVAL
condition|)
block|{
name|extlna
operator||=
operator|(
name|i
operator|<<
literal|8
operator|)
expr_stmt|;
switch|switch
condition|(
name|lpd
condition|)
block|{
case|case
name|BWN_LPD
argument_list|(
literal|0
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
case|:
return|return
operator|(
literal|0x0f92
operator|)
return|;
case|case
name|BWN_LPD
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
case|:
case|case
name|BWN_LPD
argument_list|(
literal|1
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
case|:
return|return
operator|(
literal|0x0092
operator||
name|extlna
operator|)
return|;
case|case
name|BWN_LPD
argument_list|(
literal|1
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
case|:
return|return
operator|(
literal|0x0093
operator||
name|extlna
operator|)
return|;
block|}
name|KASSERT
argument_list|(
literal|0
operator|==
literal|1
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
block|}
name|KASSERT
argument_list|(
literal|0
operator|==
literal|1
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|reg
operator|==
name|BWN_PHY_RFOVER
condition|)
return|return
operator|(
literal|0x9b3
operator|)
return|;
if|if
condition|(
name|reg
operator|==
name|BWN_PHY_RFOVERVAL
condition|)
block|{
if|if
condition|(
name|extlna
condition|)
name|extlna
operator||=
literal|0x8000
expr_stmt|;
name|extlna
operator||=
operator|(
name|i
operator|<<
literal|8
operator|)
expr_stmt|;
switch|switch
condition|(
name|lpd
condition|)
block|{
case|case
name|BWN_LPD
argument_list|(
literal|0
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
case|:
return|return
operator|(
literal|0x8f92
operator|)
return|;
case|case
name|BWN_LPD
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
case|:
return|return
operator|(
literal|0x8092
operator||
name|extlna
operator|)
return|;
case|case
name|BWN_LPD
argument_list|(
literal|1
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
case|:
return|return
operator|(
literal|0x2092
operator||
name|extlna
operator|)
return|;
case|case
name|BWN_LPD
argument_list|(
literal|1
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
case|:
return|return
operator|(
literal|0x2093
operator||
name|extlna
operator|)
return|;
block|}
name|KASSERT
argument_list|(
literal|0
operator|==
literal|1
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
block|}
name|KASSERT
argument_list|(
literal|0
operator|==
literal|1
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|phy
operator|->
name|rev
operator|<
literal|7
operator|)
operator|||
operator|!
operator|(
name|siba_sprom_get_bf_lo
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|&
name|BWN_BFL_EXTLNA
operator|)
condition|)
block|{
if|if
condition|(
name|reg
operator|==
name|BWN_PHY_RFOVER
condition|)
block|{
return|return
operator|(
literal|0x1b3
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|reg
operator|==
name|BWN_PHY_RFOVERVAL
condition|)
block|{
switch|switch
condition|(
name|lpd
condition|)
block|{
case|case
name|BWN_LPD
argument_list|(
literal|0
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
case|:
return|return
operator|(
literal|0x0fb2
operator|)
return|;
case|case
name|BWN_LPD
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
case|:
return|return
operator|(
literal|0x00b2
operator|)
return|;
case|case
name|BWN_LPD
argument_list|(
literal|1
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
case|:
return|return
operator|(
literal|0x30b2
operator|)
return|;
case|case
name|BWN_LPD
argument_list|(
literal|1
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
case|:
return|return
operator|(
literal|0x30b3
operator|)
return|;
block|}
name|KASSERT
argument_list|(
literal|0
operator|==
literal|1
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
block|}
name|KASSERT
argument_list|(
literal|0
operator|==
literal|1
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|reg
operator|==
name|BWN_PHY_RFOVER
condition|)
block|{
return|return
operator|(
literal|0x9b3
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|reg
operator|==
name|BWN_PHY_RFOVERVAL
condition|)
block|{
switch|switch
condition|(
name|lpd
condition|)
block|{
case|case
name|BWN_LPD
argument_list|(
literal|0
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
case|:
return|return
operator|(
literal|0x8fb2
operator|)
return|;
case|case
name|BWN_LPD
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
case|:
return|return
operator|(
literal|0x80b2
operator|)
return|;
case|case
name|BWN_LPD
argument_list|(
literal|1
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
case|:
return|return
operator|(
literal|0x20b2
operator|)
return|;
case|case
name|BWN_LPD
argument_list|(
literal|1
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
case|:
return|return
operator|(
literal|0x20b3
operator|)
return|;
block|}
name|KASSERT
argument_list|(
literal|0
operator|==
literal|1
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
block|}
name|KASSERT
argument_list|(
literal|0
operator|==
literal|1
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_spu_workaround
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint8_t
name|channel
parameter_list|)
block|{
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rf_ver
operator|!=
literal|0x2050
operator|||
name|mac
operator|->
name|mac_phy
operator|.
name|rf_rev
operator|>=
literal|6
condition|)
return|return;
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
name|BWN_CHANNEL
argument_list|,
operator|(
name|channel
operator|<=
literal|10
operator|)
condition|?
name|bwn_phy_g_chan2freq
argument_list|(
name|channel
operator|+
literal|4
argument_list|)
else|:
name|bwn_phy_g_chan2freq
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
name|BWN_CHANNEL
argument_list|,
name|bwn_phy_g_chan2freq
argument_list|(
name|channel
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|bwn_phy_shm_tssi_read
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint16_t
name|shm_offset
parameter_list|)
block|{
specifier|const
name|uint8_t
name|ofdm
init|=
operator|(
name|shm_offset
operator|!=
name|BWN_SHARED_TSSI_CCK
operator|)
decl_stmt|;
name|unsigned
name|int
name|a
decl_stmt|,
name|b
decl_stmt|,
name|c
decl_stmt|,
name|d
decl_stmt|;
name|unsigned
name|int
name|avg
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
name|tmp
operator|=
name|bwn_shm_read_4
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
name|shm_offset
argument_list|)
expr_stmt|;
name|a
operator|=
name|tmp
operator|&
literal|0xff
expr_stmt|;
name|b
operator|=
operator|(
name|tmp
operator|>>
literal|8
operator|)
operator|&
literal|0xff
expr_stmt|;
name|c
operator|=
operator|(
name|tmp
operator|>>
literal|16
operator|)
operator|&
literal|0xff
expr_stmt|;
name|d
operator|=
operator|(
name|tmp
operator|>>
literal|24
operator|)
operator|&
literal|0xff
expr_stmt|;
if|if
condition|(
name|a
operator|==
literal|0
operator|||
name|a
operator|==
name|BWN_TSSI_MAX
operator|||
name|b
operator|==
literal|0
operator|||
name|b
operator|==
name|BWN_TSSI_MAX
operator|||
name|c
operator|==
literal|0
operator|||
name|c
operator|==
name|BWN_TSSI_MAX
operator|||
name|d
operator|==
literal|0
operator|||
name|d
operator|==
name|BWN_TSSI_MAX
condition|)
return|return
operator|(
name|ENOENT
operator|)
return|;
name|bwn_shm_write_4
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
name|shm_offset
argument_list|,
name|BWN_TSSI_MAX
operator||
operator|(
name|BWN_TSSI_MAX
operator|<<
literal|8
operator|)
operator||
operator|(
name|BWN_TSSI_MAX
operator|<<
literal|16
operator|)
operator||
operator|(
name|BWN_TSSI_MAX
operator|<<
literal|24
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ofdm
condition|)
block|{
name|a
operator|=
operator|(
name|a
operator|+
literal|32
operator|)
operator|&
literal|0x3f
expr_stmt|;
name|b
operator|=
operator|(
name|b
operator|+
literal|32
operator|)
operator|&
literal|0x3f
expr_stmt|;
name|c
operator|=
operator|(
name|c
operator|+
literal|32
operator|)
operator|&
literal|0x3f
expr_stmt|;
name|d
operator|=
operator|(
name|d
operator|+
literal|32
operator|)
operator|&
literal|0x3f
expr_stmt|;
block|}
name|avg
operator|=
operator|(
name|a
operator|+
name|b
operator|+
name|c
operator|+
name|d
operator|+
literal|2
operator|)
operator|/
literal|4
expr_stmt|;
if|if
condition|(
name|ofdm
condition|)
block|{
if|if
condition|(
name|bwn_shm_read_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
name|BWN_SHARED_HFLO
argument_list|)
operator|&
name|BWN_HF_4DB_CCK_POWERBOOST
condition|)
name|avg
operator|=
operator|(
name|avg
operator|>=
literal|13
operator|)
condition|?
operator|(
name|avg
operator|-
literal|13
operator|)
else|:
literal|0
expr_stmt|;
block|}
return|return
operator|(
name|avg
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_phy_g_setatt
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|int
modifier|*
name|bbattp
parameter_list|,
name|int
modifier|*
name|rfattp
parameter_list|)
block|{
name|struct
name|bwn_txpwr_loctl
modifier|*
name|lo
init|=
operator|&
name|mac
operator|->
name|mac_phy
operator|.
name|phy_g
operator|.
name|pg_loctl
decl_stmt|;
name|int
name|rfatt
init|=
operator|*
name|rfattp
decl_stmt|;
name|int
name|bbatt
init|=
operator|*
name|bbattp
decl_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
if|if
condition|(
name|rfatt
operator|>
name|lo
operator|->
name|rfatt
operator|.
name|max
operator|&&
name|bbatt
operator|>
name|lo
operator|->
name|bbatt
operator|.
name|max
operator|-
literal|4
condition|)
break|break;
if|if
condition|(
name|rfatt
operator|<
name|lo
operator|->
name|rfatt
operator|.
name|min
operator|&&
name|bbatt
operator|<
name|lo
operator|->
name|bbatt
operator|.
name|min
operator|+
literal|4
condition|)
break|break;
if|if
condition|(
name|bbatt
operator|>
name|lo
operator|->
name|bbatt
operator|.
name|max
operator|&&
name|rfatt
operator|>
name|lo
operator|->
name|rfatt
operator|.
name|max
operator|-
literal|1
condition|)
break|break;
if|if
condition|(
name|bbatt
operator|<
name|lo
operator|->
name|bbatt
operator|.
name|min
operator|&&
name|rfatt
operator|<
name|lo
operator|->
name|rfatt
operator|.
name|min
operator|+
literal|1
condition|)
break|break;
if|if
condition|(
name|bbatt
operator|>
name|lo
operator|->
name|bbatt
operator|.
name|max
condition|)
block|{
name|bbatt
operator|-=
literal|4
expr_stmt|;
name|rfatt
operator|+=
literal|1
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|bbatt
operator|<
name|lo
operator|->
name|bbatt
operator|.
name|min
condition|)
block|{
name|bbatt
operator|+=
literal|4
expr_stmt|;
name|rfatt
operator|-=
literal|1
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|rfatt
operator|>
name|lo
operator|->
name|rfatt
operator|.
name|max
condition|)
block|{
name|rfatt
operator|-=
literal|1
expr_stmt|;
name|bbatt
operator|+=
literal|4
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|rfatt
operator|<
name|lo
operator|->
name|rfatt
operator|.
name|min
condition|)
block|{
name|rfatt
operator|+=
literal|1
expr_stmt|;
name|bbatt
operator|-=
literal|4
expr_stmt|;
continue|continue;
block|}
break|break;
block|}
operator|*
name|rfattp
operator|=
name|MIN
argument_list|(
name|MAX
argument_list|(
name|rfatt
argument_list|,
name|lo
operator|->
name|rfatt
operator|.
name|min
argument_list|)
argument_list|,
name|lo
operator|->
name|rfatt
operator|.
name|max
argument_list|)
expr_stmt|;
operator|*
name|bbattp
operator|=
name|MIN
argument_list|(
name|MAX
argument_list|(
name|bbatt
argument_list|,
name|lo
operator|->
name|bbatt
operator|.
name|min
argument_list|)
argument_list|,
name|lo
operator|->
name|bbatt
operator|.
name|max
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_phy_lock
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
name|KASSERT
argument_list|(
name|siba_get_revid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|>=
literal|3
argument_list|,
operator|(
literal|"%s: unsupported rev %d"
operator|,
name|__func__
operator|,
name|siba_get_revid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ic
operator|->
name|ic_opmode
operator|!=
name|IEEE80211_M_HOSTAP
condition|)
name|bwn_psctl
argument_list|(
name|mac
argument_list|,
name|BWN_PS_AWAKE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_phy_unlock
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
name|KASSERT
argument_list|(
name|siba_get_revid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|>=
literal|3
argument_list|,
operator|(
literal|"%s: unsupported rev %d"
operator|,
name|__func__
operator|,
name|siba_get_revid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ic
operator|->
name|ic_opmode
operator|!=
name|IEEE80211_M_HOSTAP
condition|)
name|bwn_psctl
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_rf_lock
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCTL
argument_list|,
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCTL
argument_list|)
operator||
name|BWN_MACCTL_RADIO_LOCK
argument_list|)
expr_stmt|;
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCTL
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_rf_unlock
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|BWN_READ_2
argument_list|(
name|mac
argument_list|,
name|BWN_PHYVER
argument_list|)
expr_stmt|;
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCTL
argument_list|,
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCTL
argument_list|)
operator|&
operator|~
name|BWN_MACCTL_RADIO_LOCK
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


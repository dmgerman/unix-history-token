begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2009-2010 Weongyo Jeong<weongyo@freebsd.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer,  *    without modification.  * 2. Redistributions in binary form must reproduce at minimum a disclaimer  *    similar to the "NO WARRANTY" disclaimer below ("Disclaimer") and any  *    redistribution must be conditioned upon including a substantially  *    similar Disclaimer requirement for further binary redistribution.  *  * NO WARRANTY  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS  * ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT  * LIMITED TO, THE IMPLIED WARRANTIES OF NONINFRINGEMENT, MERCHANTIBILITY  * AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL  * THE COPYRIGHT HOLDERS OR CONTRIBUTORS BE LIABLE FOR SPECIAL, EXEMPLARY,  * OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER  * IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF  * THE POSSIBILITY OF SUCH DAMAGES.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*  * The Broadcom Wireless LAN controller driver.  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|<sys/errno.h>
end_include

begin_include
include|#
directive|include
file|<sys/firmware.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_include
include|#
directive|include
file|<net/ethernet.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_var.h>
end_include

begin_include
include|#
directive|include
file|<net/if_arp.h>
end_include

begin_include
include|#
directive|include
file|<net/if_dl.h>
end_include

begin_include
include|#
directive|include
file|<net/if_llc.h>
end_include

begin_include
include|#
directive|include
file|<net/if_media.h>
end_include

begin_include
include|#
directive|include
file|<net/if_types.h>
end_include

begin_include
include|#
directive|include
file|<dev/pci/pcivar.h>
end_include

begin_include
include|#
directive|include
file|<dev/pci/pcireg.h>
end_include

begin_include
include|#
directive|include
file|<dev/siba/siba_ids.h>
end_include

begin_include
include|#
directive|include
file|<dev/siba/sibareg.h>
end_include

begin_include
include|#
directive|include
file|<dev/siba/sibavar.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_var.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_radiotap.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_regdomain.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_phy.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_ratectl.h>
end_include

begin_include
include|#
directive|include
file|<dev/bwn/if_bwnreg.h>
end_include

begin_include
include|#
directive|include
file|<dev/bwn/if_bwnvar.h>
end_include

begin_include
include|#
directive|include
file|<dev/bwn/if_bwn_debug.h>
end_include

begin_include
include|#
directive|include
file|<dev/bwn/if_bwn_misc.h>
end_include

begin_include
include|#
directive|include
file|<dev/bwn/if_bwn_util.h>
end_include

begin_include
include|#
directive|include
file|<dev/bwn/if_bwn_phy_common.h>
end_include

begin_include
include|#
directive|include
file|<dev/bwn/if_bwn_phy_g.h>
end_include

begin_include
include|#
directive|include
file|<dev/bwn/if_bwn_phy_lp.h>
end_include

begin_expr_stmt
specifier|static
name|SYSCTL_NODE
argument_list|(
name|_hw
argument_list|,
name|OID_AUTO
argument_list|,
name|bwn
argument_list|,
name|CTLFLAG_RD
argument_list|,
literal|0
argument_list|,
literal|"Broadcom driver parameters"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*  * Tunable& sysctl variables.  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|BWN_DEBUG
end_ifdef

begin_decl_stmt
specifier|static
name|int
name|bwn_debug
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_hw_bwn
argument_list|,
name|OID_AUTO
argument_list|,
name|debug
argument_list|,
name|CTLFLAG_RWTUN
argument_list|,
operator|&
name|bwn_debug
argument_list|,
literal|0
argument_list|,
literal|"Broadcom debugging printfs"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|static
name|int
name|bwn_bfp
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* use "Bad Frames Preemption" */
end_comment

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_hw_bwn
argument_list|,
name|OID_AUTO
argument_list|,
name|bfp
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|bwn_bfp
argument_list|,
literal|0
argument_list|,
literal|"uses Bad Frames Preemption"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|int
name|bwn_bluetooth
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_hw_bwn
argument_list|,
name|OID_AUTO
argument_list|,
name|bluetooth
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|bwn_bluetooth
argument_list|,
literal|0
argument_list|,
literal|"turns on Bluetooth Coexistence"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|int
name|bwn_hwpctl
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_hw_bwn
argument_list|,
name|OID_AUTO
argument_list|,
name|hwpctl
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|bwn_hwpctl
argument_list|,
literal|0
argument_list|,
literal|"uses H/W power control"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|int
name|bwn_msi_disable
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* MSI disabled  */
end_comment

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"hw.bwn.msi_disable"
argument_list|,
operator|&
name|bwn_msi_disable
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|int
name|bwn_usedma
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_hw_bwn
argument_list|,
name|OID_AUTO
argument_list|,
name|usedma
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|bwn_usedma
argument_list|,
literal|0
argument_list|,
literal|"uses DMA"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"hw.bwn.usedma"
argument_list|,
operator|&
name|bwn_usedma
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|int
name|bwn_wme
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_hw_bwn
argument_list|,
name|OID_AUTO
argument_list|,
name|wme
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|bwn_wme
argument_list|,
literal|0
argument_list|,
literal|"uses WME support"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function_decl
specifier|static
name|void
name|bwn_attach_pre
parameter_list|(
name|struct
name|bwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bwn_attach_post
parameter_list|(
name|struct
name|bwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_sprom_bugfixes
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bwn_init
parameter_list|(
name|struct
name|bwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_parent
parameter_list|(
name|struct
name|ieee80211com
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_start
parameter_list|(
name|struct
name|bwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bwn_transmit
parameter_list|(
name|struct
name|ieee80211com
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bwn_attach_core
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bwn_phy_getinfo
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bwn_chiptest
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bwn_setup_channels
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_shm_ctlword
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
name|uint16_t
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_addchannels
parameter_list|(
name|struct
name|ieee80211_channel
type|[]
parameter_list|,
name|int
parameter_list|,
name|int
modifier|*
parameter_list|,
specifier|const
name|struct
name|bwn_channelinfo
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bwn_raw_xmit
parameter_list|(
name|struct
name|ieee80211_node
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|,
specifier|const
name|struct
name|ieee80211_bpf_params
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_updateslot
parameter_list|(
name|struct
name|ieee80211com
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_update_promisc
parameter_list|(
name|struct
name|ieee80211com
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_wme_init
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bwn_wme_update
parameter_list|(
name|struct
name|ieee80211com
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_wme_clear
parameter_list|(
name|struct
name|bwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_wme_load
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_wme_loadparams
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
specifier|const
name|struct
name|wmeParams
modifier|*
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_scan_start
parameter_list|(
name|struct
name|ieee80211com
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_scan_end
parameter_list|(
name|struct
name|ieee80211com
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_set_channel
parameter_list|(
name|struct
name|ieee80211com
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|ieee80211vap
modifier|*
name|bwn_vap_create
parameter_list|(
name|struct
name|ieee80211com
modifier|*
parameter_list|,
specifier|const
name|char
index|[
name|IFNAMSIZ
index|]
parameter_list|,
name|int
parameter_list|,
name|enum
name|ieee80211_opmode
parameter_list|,
name|int
parameter_list|,
specifier|const
name|uint8_t
index|[
name|IEEE80211_ADDR_LEN
index|]
parameter_list|,
specifier|const
name|uint8_t
index|[
name|IEEE80211_ADDR_LEN
index|]
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_vap_delete
parameter_list|(
name|struct
name|ieee80211vap
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_stop
parameter_list|(
name|struct
name|bwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bwn_core_init
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_core_start
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_core_exit
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_bt_disable
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bwn_chip_init
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_set_txretry
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_rate_init
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_set_phytxctl
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_spu_setdelay
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_bt_enable
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_set_macaddr
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_crypt_init
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_chip_exit
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bwn_fw_fillinfo
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bwn_fw_loaducode
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bwn_gpio_init
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bwn_fw_loadinitvals
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bwn_phy_init
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_set_txantenna
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_set_opmode
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_rate_write
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
name|uint16_t
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint8_t
name|bwn_plcp_getcck
parameter_list|(
specifier|const
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint8_t
name|bwn_plcp_getofdm
parameter_list|(
specifier|const
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_pio_init
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
name|bwn_pio_idx2base
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_pio_set_txqueue
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
name|struct
name|bwn_pio_txqueue
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_pio_setupqueue_rx
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
name|struct
name|bwn_pio_rxqueue
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_destroy_queue_tx
parameter_list|(
name|struct
name|bwn_pio_txqueue
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
name|bwn_pio_read_2
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
name|struct
name|bwn_pio_txqueue
modifier|*
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_pio_cancel_tx_packets
parameter_list|(
name|struct
name|bwn_pio_txqueue
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bwn_pio_rx
parameter_list|(
name|struct
name|bwn_pio_rxqueue
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint8_t
name|bwn_pio_rxeof
parameter_list|(
name|struct
name|bwn_pio_rxqueue
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_pio_handle_txeof
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
specifier|const
name|struct
name|bwn_txstatus
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
name|bwn_pio_rx_read_2
parameter_list|(
name|struct
name|bwn_pio_rxqueue
modifier|*
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|bwn_pio_rx_read_4
parameter_list|(
name|struct
name|bwn_pio_rxqueue
modifier|*
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_pio_rx_write_2
parameter_list|(
name|struct
name|bwn_pio_rxqueue
modifier|*
parameter_list|,
name|uint16_t
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_pio_rx_write_4
parameter_list|(
name|struct
name|bwn_pio_rxqueue
modifier|*
parameter_list|,
name|uint16_t
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bwn_pio_tx_start
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
name|struct
name|ieee80211_node
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|bwn_pio_txqueue
modifier|*
name|bwn_pio_select
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|bwn_pio_write_multi_4
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
name|struct
name|bwn_pio_txqueue
modifier|*
parameter_list|,
name|uint32_t
parameter_list|,
specifier|const
name|void
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_pio_write_4
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
name|struct
name|bwn_pio_txqueue
modifier|*
parameter_list|,
name|uint16_t
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
name|bwn_pio_write_multi_2
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
name|struct
name|bwn_pio_txqueue
modifier|*
parameter_list|,
name|uint16_t
parameter_list|,
specifier|const
name|void
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
name|bwn_pio_write_mbuf_2
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
name|struct
name|bwn_pio_txqueue
modifier|*
parameter_list|,
name|uint16_t
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|bwn_pio_txqueue
modifier|*
name|bwn_pio_parse_cookie
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
name|uint16_t
parameter_list|,
name|struct
name|bwn_pio_txpkt
modifier|*
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_dma_init
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_dma_rxdirectfifo
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
name|int
parameter_list|,
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bwn_dma_mask2type
parameter_list|(
name|uint64_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint64_t
name|bwn_dma_mask
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
name|bwn_dma_base
parameter_list|(
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_dma_ringfree
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_dma_32_getdesc
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
parameter_list|,
name|int
parameter_list|,
name|struct
name|bwn_dmadesc_generic
modifier|*
modifier|*
parameter_list|,
name|struct
name|bwn_dmadesc_meta
modifier|*
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_dma_32_setdesc
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
parameter_list|,
name|struct
name|bwn_dmadesc_generic
modifier|*
parameter_list|,
name|bus_addr_t
parameter_list|,
name|uint16_t
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_dma_32_start_transfer
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_dma_32_suspend
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_dma_32_resume
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bwn_dma_32_get_curslot
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_dma_32_set_curslot
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_dma_64_getdesc
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
parameter_list|,
name|int
parameter_list|,
name|struct
name|bwn_dmadesc_generic
modifier|*
modifier|*
parameter_list|,
name|struct
name|bwn_dmadesc_meta
modifier|*
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_dma_64_setdesc
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
parameter_list|,
name|struct
name|bwn_dmadesc_generic
modifier|*
parameter_list|,
name|bus_addr_t
parameter_list|,
name|uint16_t
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_dma_64_start_transfer
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_dma_64_suspend
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_dma_64_resume
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bwn_dma_64_get_curslot
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_dma_64_set_curslot
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bwn_dma_allocringmemory
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_dma_setup
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_dma_free_ringmemory
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_dma_cleanup
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_dma_free_descbufs
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bwn_dma_tx_reset
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
name|uint16_t
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_dma_rx
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bwn_dma_rx_reset
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
name|uint16_t
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_dma_free_descbuf
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
parameter_list|,
name|struct
name|bwn_dmadesc_meta
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_dma_set_redzone
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bwn_dma_gettype
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_dma_ring_addr
parameter_list|(
name|void
modifier|*
parameter_list|,
name|bus_dma_segment_t
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bwn_dma_freeslot
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bwn_dma_nextslot
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_dma_rxeof
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
parameter_list|,
name|int
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bwn_dma_newbuf
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
parameter_list|,
name|struct
name|bwn_dmadesc_generic
modifier|*
parameter_list|,
name|struct
name|bwn_dmadesc_meta
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_dma_buf_addr
parameter_list|(
name|void
modifier|*
parameter_list|,
name|bus_dma_segment_t
modifier|*
parameter_list|,
name|int
parameter_list|,
name|bus_size_t
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint8_t
name|bwn_dma_check_redzone
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_dma_handle_txeof
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
specifier|const
name|struct
name|bwn_txstatus
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bwn_dma_tx_start
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
name|struct
name|ieee80211_node
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bwn_dma_getslot
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|bwn_dma_ring
modifier|*
name|bwn_dma_select
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bwn_dma_attach
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|bwn_dma_ring
modifier|*
name|bwn_dma_ringsetup
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|bwn_dma_ring
modifier|*
name|bwn_dma_parse_cookie
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
specifier|const
name|struct
name|bwn_txstatus
modifier|*
parameter_list|,
name|uint16_t
parameter_list|,
name|int
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_dma_free
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bwn_fw_gets
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
name|enum
name|bwn_fwtype
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bwn_fw_get
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
name|enum
name|bwn_fwtype
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|,
name|struct
name|bwn_fwfile
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_release_firmware
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_do_release_fw
parameter_list|(
name|struct
name|bwn_fwfile
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
name|bwn_fwcaps_read
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bwn_fwinitvals_write
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
specifier|const
name|struct
name|bwn_fwinitvals
modifier|*
parameter_list|,
name|size_t
parameter_list|,
name|size_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
name|bwn_ant2phy
parameter_list|(
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_mac_write_bssid
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_mac_setfilter
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
name|uint16_t
parameter_list|,
specifier|const
name|uint8_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_key_dowrite
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
name|uint8_t
parameter_list|,
name|uint8_t
parameter_list|,
specifier|const
name|uint8_t
modifier|*
parameter_list|,
name|size_t
parameter_list|,
specifier|const
name|uint8_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_key_macwrite
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
name|uint8_t
parameter_list|,
specifier|const
name|uint8_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_key_write
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
name|uint8_t
parameter_list|,
name|uint8_t
parameter_list|,
specifier|const
name|uint8_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_phy_exit
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_core_stop
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bwn_switch_band
parameter_list|(
name|struct
name|bwn_softc
modifier|*
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_phy_reset
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bwn_newstate
parameter_list|(
name|struct
name|ieee80211vap
modifier|*
parameter_list|,
name|enum
name|ieee80211_state
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_set_pretbtt
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bwn_intr
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_intrtask
parameter_list|(
name|void
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_restart
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_intr_ucode_debug
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_intr_tbtt_indication
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_intr_atim_end
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_intr_beacon
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_intr_pmq
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_intr_noise
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_intr_txeof
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_hwreset
parameter_list|(
name|void
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_handle_fwpanic
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_load_beacon0
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_load_beacon1
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|bwn_jssi_read
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_noise_gensample
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_handle_txeof
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
specifier|const
name|struct
name|bwn_txstatus
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_rxeof
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|,
specifier|const
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_phy_txpower_check
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bwn_tx_start
parameter_list|(
name|struct
name|bwn_softc
modifier|*
parameter_list|,
name|struct
name|ieee80211_node
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bwn_tx_isfull
parameter_list|(
name|struct
name|bwn_softc
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bwn_set_txhdr
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
name|struct
name|ieee80211_node
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|,
name|struct
name|bwn_txhdr
modifier|*
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_plcp_genhdr
parameter_list|(
name|struct
name|bwn_plcp4
modifier|*
parameter_list|,
specifier|const
name|uint16_t
parameter_list|,
specifier|const
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint8_t
name|bwn_antenna_sanitize
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint8_t
name|bwn_get_fbrate
parameter_list|(
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_txpwr
parameter_list|(
name|void
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_tasks
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_task_15s
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_task_30s
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_task_60s
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bwn_plcp_get_ofdmrate
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
name|struct
name|bwn_plcp6
modifier|*
parameter_list|,
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bwn_plcp_get_cckrate
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
name|struct
name|bwn_plcp6
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_rx_radiotap
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|,
specifier|const
name|struct
name|bwn_rxhdr4
modifier|*
parameter_list|,
name|struct
name|bwn_plcp6
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_tsf_read
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
name|uint64_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_set_slot_time
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_watchdog
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_dma_stop
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_pio_stop
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_dma_ringstop
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_led_attach
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_led_newstate
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
name|enum
name|ieee80211_state
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_led_event
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_led_blink_start
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_led_blink_next
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_led_blink_end
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_rfswitch
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_rf_turnon
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_rf_turnoff
parameter_list|(
name|struct
name|bwn_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwn_sysctl_node
parameter_list|(
name|struct
name|bwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|struct
name|resource_spec
name|bwn_res_spec_legacy
index|[]
init|=
block|{
block|{
name|SYS_RES_IRQ
block|,
literal|0
block|,
name|RF_ACTIVE
operator||
name|RF_SHAREABLE
block|}
block|,
block|{
operator|-
literal|1
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|resource_spec
name|bwn_res_spec_msi
index|[]
init|=
block|{
block|{
name|SYS_RES_IRQ
block|,
literal|1
block|,
name|RF_ACTIVE
block|}
block|,
block|{
operator|-
literal|1
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|bwn_channelinfo
name|bwn_chantable_bg
init|=
block|{
operator|.
name|channels
operator|=
block|{
block|{
literal|2412
block|,
literal|1
block|,
literal|30
block|}
block|,
block|{
literal|2417
block|,
literal|2
block|,
literal|30
block|}
block|,
block|{
literal|2422
block|,
literal|3
block|,
literal|30
block|}
block|,
block|{
literal|2427
block|,
literal|4
block|,
literal|30
block|}
block|,
block|{
literal|2432
block|,
literal|5
block|,
literal|30
block|}
block|,
block|{
literal|2437
block|,
literal|6
block|,
literal|30
block|}
block|,
block|{
literal|2442
block|,
literal|7
block|,
literal|30
block|}
block|,
block|{
literal|2447
block|,
literal|8
block|,
literal|30
block|}
block|,
block|{
literal|2452
block|,
literal|9
block|,
literal|30
block|}
block|,
block|{
literal|2457
block|,
literal|10
block|,
literal|30
block|}
block|,
block|{
literal|2462
block|,
literal|11
block|,
literal|30
block|}
block|,
block|{
literal|2467
block|,
literal|12
block|,
literal|30
block|}
block|,
block|{
literal|2472
block|,
literal|13
block|,
literal|30
block|}
block|,
block|{
literal|2484
block|,
literal|14
block|,
literal|30
block|}
block|}
block|,
operator|.
name|nchannels
operator|=
literal|14
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|bwn_channelinfo
name|bwn_chantable_a
init|=
block|{
operator|.
name|channels
operator|=
block|{
block|{
literal|5170
block|,
literal|34
block|,
literal|30
block|}
block|,
block|{
literal|5180
block|,
literal|36
block|,
literal|30
block|}
block|,
block|{
literal|5190
block|,
literal|38
block|,
literal|30
block|}
block|,
block|{
literal|5200
block|,
literal|40
block|,
literal|30
block|}
block|,
block|{
literal|5210
block|,
literal|42
block|,
literal|30
block|}
block|,
block|{
literal|5220
block|,
literal|44
block|,
literal|30
block|}
block|,
block|{
literal|5230
block|,
literal|46
block|,
literal|30
block|}
block|,
block|{
literal|5240
block|,
literal|48
block|,
literal|30
block|}
block|,
block|{
literal|5260
block|,
literal|52
block|,
literal|30
block|}
block|,
block|{
literal|5280
block|,
literal|56
block|,
literal|30
block|}
block|,
block|{
literal|5300
block|,
literal|60
block|,
literal|30
block|}
block|,
block|{
literal|5320
block|,
literal|64
block|,
literal|30
block|}
block|,
block|{
literal|5500
block|,
literal|100
block|,
literal|30
block|}
block|,
block|{
literal|5520
block|,
literal|104
block|,
literal|30
block|}
block|,
block|{
literal|5540
block|,
literal|108
block|,
literal|30
block|}
block|,
block|{
literal|5560
block|,
literal|112
block|,
literal|30
block|}
block|,
block|{
literal|5580
block|,
literal|116
block|,
literal|30
block|}
block|,
block|{
literal|5600
block|,
literal|120
block|,
literal|30
block|}
block|,
block|{
literal|5620
block|,
literal|124
block|,
literal|30
block|}
block|,
block|{
literal|5640
block|,
literal|128
block|,
literal|30
block|}
block|,
block|{
literal|5660
block|,
literal|132
block|,
literal|30
block|}
block|,
block|{
literal|5680
block|,
literal|136
block|,
literal|30
block|}
block|,
block|{
literal|5700
block|,
literal|140
block|,
literal|30
block|}
block|,
block|{
literal|5745
block|,
literal|149
block|,
literal|30
block|}
block|,
block|{
literal|5765
block|,
literal|153
block|,
literal|30
block|}
block|,
block|{
literal|5785
block|,
literal|157
block|,
literal|30
block|}
block|,
block|{
literal|5805
block|,
literal|161
block|,
literal|30
block|}
block|,
block|{
literal|5825
block|,
literal|165
block|,
literal|30
block|}
block|,
block|{
literal|5920
block|,
literal|184
block|,
literal|30
block|}
block|,
block|{
literal|5940
block|,
literal|188
block|,
literal|30
block|}
block|,
block|{
literal|5960
block|,
literal|192
block|,
literal|30
block|}
block|,
block|{
literal|5980
block|,
literal|196
block|,
literal|30
block|}
block|,
block|{
literal|6000
block|,
literal|200
block|,
literal|30
block|}
block|,
block|{
literal|6020
block|,
literal|204
block|,
literal|30
block|}
block|,
block|{
literal|6040
block|,
literal|208
block|,
literal|30
block|}
block|,
block|{
literal|6060
block|,
literal|212
block|,
literal|30
block|}
block|,
block|{
literal|6080
block|,
literal|216
block|,
literal|30
block|}
block|}
block|,
operator|.
name|nchannels
operator|=
literal|37
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|bwn_channelinfo
name|bwn_chantable_n
init|=
block|{
operator|.
name|channels
operator|=
block|{
block|{
literal|5160
block|,
literal|32
block|,
literal|30
block|}
block|,
block|{
literal|5170
block|,
literal|34
block|,
literal|30
block|}
block|,
block|{
literal|5180
block|,
literal|36
block|,
literal|30
block|}
block|,
block|{
literal|5190
block|,
literal|38
block|,
literal|30
block|}
block|,
block|{
literal|5200
block|,
literal|40
block|,
literal|30
block|}
block|,
block|{
literal|5210
block|,
literal|42
block|,
literal|30
block|}
block|,
block|{
literal|5220
block|,
literal|44
block|,
literal|30
block|}
block|,
block|{
literal|5230
block|,
literal|46
block|,
literal|30
block|}
block|,
block|{
literal|5240
block|,
literal|48
block|,
literal|30
block|}
block|,
block|{
literal|5250
block|,
literal|50
block|,
literal|30
block|}
block|,
block|{
literal|5260
block|,
literal|52
block|,
literal|30
block|}
block|,
block|{
literal|5270
block|,
literal|54
block|,
literal|30
block|}
block|,
block|{
literal|5280
block|,
literal|56
block|,
literal|30
block|}
block|,
block|{
literal|5290
block|,
literal|58
block|,
literal|30
block|}
block|,
block|{
literal|5300
block|,
literal|60
block|,
literal|30
block|}
block|,
block|{
literal|5310
block|,
literal|62
block|,
literal|30
block|}
block|,
block|{
literal|5320
block|,
literal|64
block|,
literal|30
block|}
block|,
block|{
literal|5330
block|,
literal|66
block|,
literal|30
block|}
block|,
block|{
literal|5340
block|,
literal|68
block|,
literal|30
block|}
block|,
block|{
literal|5350
block|,
literal|70
block|,
literal|30
block|}
block|,
block|{
literal|5360
block|,
literal|72
block|,
literal|30
block|}
block|,
block|{
literal|5370
block|,
literal|74
block|,
literal|30
block|}
block|,
block|{
literal|5380
block|,
literal|76
block|,
literal|30
block|}
block|,
block|{
literal|5390
block|,
literal|78
block|,
literal|30
block|}
block|,
block|{
literal|5400
block|,
literal|80
block|,
literal|30
block|}
block|,
block|{
literal|5410
block|,
literal|82
block|,
literal|30
block|}
block|,
block|{
literal|5420
block|,
literal|84
block|,
literal|30
block|}
block|,
block|{
literal|5430
block|,
literal|86
block|,
literal|30
block|}
block|,
block|{
literal|5440
block|,
literal|88
block|,
literal|30
block|}
block|,
block|{
literal|5450
block|,
literal|90
block|,
literal|30
block|}
block|,
block|{
literal|5460
block|,
literal|92
block|,
literal|30
block|}
block|,
block|{
literal|5470
block|,
literal|94
block|,
literal|30
block|}
block|,
block|{
literal|5480
block|,
literal|96
block|,
literal|30
block|}
block|,
block|{
literal|5490
block|,
literal|98
block|,
literal|30
block|}
block|,
block|{
literal|5500
block|,
literal|100
block|,
literal|30
block|}
block|,
block|{
literal|5510
block|,
literal|102
block|,
literal|30
block|}
block|,
block|{
literal|5520
block|,
literal|104
block|,
literal|30
block|}
block|,
block|{
literal|5530
block|,
literal|106
block|,
literal|30
block|}
block|,
block|{
literal|5540
block|,
literal|108
block|,
literal|30
block|}
block|,
block|{
literal|5550
block|,
literal|110
block|,
literal|30
block|}
block|,
block|{
literal|5560
block|,
literal|112
block|,
literal|30
block|}
block|,
block|{
literal|5570
block|,
literal|114
block|,
literal|30
block|}
block|,
block|{
literal|5580
block|,
literal|116
block|,
literal|30
block|}
block|,
block|{
literal|5590
block|,
literal|118
block|,
literal|30
block|}
block|,
block|{
literal|5600
block|,
literal|120
block|,
literal|30
block|}
block|,
block|{
literal|5610
block|,
literal|122
block|,
literal|30
block|}
block|,
block|{
literal|5620
block|,
literal|124
block|,
literal|30
block|}
block|,
block|{
literal|5630
block|,
literal|126
block|,
literal|30
block|}
block|,
block|{
literal|5640
block|,
literal|128
block|,
literal|30
block|}
block|,
block|{
literal|5650
block|,
literal|130
block|,
literal|30
block|}
block|,
block|{
literal|5660
block|,
literal|132
block|,
literal|30
block|}
block|,
block|{
literal|5670
block|,
literal|134
block|,
literal|30
block|}
block|,
block|{
literal|5680
block|,
literal|136
block|,
literal|30
block|}
block|,
block|{
literal|5690
block|,
literal|138
block|,
literal|30
block|}
block|,
block|{
literal|5700
block|,
literal|140
block|,
literal|30
block|}
block|,
block|{
literal|5710
block|,
literal|142
block|,
literal|30
block|}
block|,
block|{
literal|5720
block|,
literal|144
block|,
literal|30
block|}
block|,
block|{
literal|5725
block|,
literal|145
block|,
literal|30
block|}
block|,
block|{
literal|5730
block|,
literal|146
block|,
literal|30
block|}
block|,
block|{
literal|5735
block|,
literal|147
block|,
literal|30
block|}
block|,
block|{
literal|5740
block|,
literal|148
block|,
literal|30
block|}
block|,
block|{
literal|5745
block|,
literal|149
block|,
literal|30
block|}
block|,
block|{
literal|5750
block|,
literal|150
block|,
literal|30
block|}
block|,
block|{
literal|5755
block|,
literal|151
block|,
literal|30
block|}
block|,
block|{
literal|5760
block|,
literal|152
block|,
literal|30
block|}
block|,
block|{
literal|5765
block|,
literal|153
block|,
literal|30
block|}
block|,
block|{
literal|5770
block|,
literal|154
block|,
literal|30
block|}
block|,
block|{
literal|5775
block|,
literal|155
block|,
literal|30
block|}
block|,
block|{
literal|5780
block|,
literal|156
block|,
literal|30
block|}
block|,
block|{
literal|5785
block|,
literal|157
block|,
literal|30
block|}
block|,
block|{
literal|5790
block|,
literal|158
block|,
literal|30
block|}
block|,
block|{
literal|5795
block|,
literal|159
block|,
literal|30
block|}
block|,
block|{
literal|5800
block|,
literal|160
block|,
literal|30
block|}
block|,
block|{
literal|5805
block|,
literal|161
block|,
literal|30
block|}
block|,
block|{
literal|5810
block|,
literal|162
block|,
literal|30
block|}
block|,
block|{
literal|5815
block|,
literal|163
block|,
literal|30
block|}
block|,
block|{
literal|5820
block|,
literal|164
block|,
literal|30
block|}
block|,
block|{
literal|5825
block|,
literal|165
block|,
literal|30
block|}
block|,
block|{
literal|5830
block|,
literal|166
block|,
literal|30
block|}
block|,
block|{
literal|5840
block|,
literal|168
block|,
literal|30
block|}
block|,
block|{
literal|5850
block|,
literal|170
block|,
literal|30
block|}
block|,
block|{
literal|5860
block|,
literal|172
block|,
literal|30
block|}
block|,
block|{
literal|5870
block|,
literal|174
block|,
literal|30
block|}
block|,
block|{
literal|5880
block|,
literal|176
block|,
literal|30
block|}
block|,
block|{
literal|5890
block|,
literal|178
block|,
literal|30
block|}
block|,
block|{
literal|5900
block|,
literal|180
block|,
literal|30
block|}
block|,
block|{
literal|5910
block|,
literal|182
block|,
literal|30
block|}
block|,
block|{
literal|5920
block|,
literal|184
block|,
literal|30
block|}
block|,
block|{
literal|5930
block|,
literal|186
block|,
literal|30
block|}
block|,
block|{
literal|5940
block|,
literal|188
block|,
literal|30
block|}
block|,
block|{
literal|5950
block|,
literal|190
block|,
literal|30
block|}
block|,
block|{
literal|5960
block|,
literal|192
block|,
literal|30
block|}
block|,
block|{
literal|5970
block|,
literal|194
block|,
literal|30
block|}
block|,
block|{
literal|5980
block|,
literal|196
block|,
literal|30
block|}
block|,
block|{
literal|5990
block|,
literal|198
block|,
literal|30
block|}
block|,
block|{
literal|6000
block|,
literal|200
block|,
literal|30
block|}
block|,
block|{
literal|6010
block|,
literal|202
block|,
literal|30
block|}
block|,
block|{
literal|6020
block|,
literal|204
block|,
literal|30
block|}
block|,
block|{
literal|6030
block|,
literal|206
block|,
literal|30
block|}
block|,
block|{
literal|6040
block|,
literal|208
block|,
literal|30
block|}
block|,
block|{
literal|6050
block|,
literal|210
block|,
literal|30
block|}
block|,
block|{
literal|6060
block|,
literal|212
block|,
literal|30
block|}
block|,
block|{
literal|6070
block|,
literal|214
block|,
literal|30
block|}
block|,
block|{
literal|6080
block|,
literal|216
block|,
literal|30
block|}
block|,
block|{
literal|6090
block|,
literal|218
block|,
literal|30
block|}
block|,
block|{
literal|6100
block|,
literal|220
block|,
literal|30
block|}
block|,
block|{
literal|6110
block|,
literal|222
block|,
literal|30
block|}
block|,
block|{
literal|6120
block|,
literal|224
block|,
literal|30
block|}
block|,
block|{
literal|6130
block|,
literal|226
block|,
literal|30
block|}
block|,
block|{
literal|6140
block|,
literal|228
block|,
literal|30
block|}
block|}
block|,
operator|.
name|nchannels
operator|=
literal|110
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|VENDOR_LED_ACT
parameter_list|(
name|vendor
parameter_list|)
define|\
value|{							\ 	.vid = PCI_VENDOR_##vendor,			\ 	.led_act = { BWN_VENDOR_LED_ACT_##vendor }	\ }
end_define

begin_struct
specifier|static
specifier|const
struct|struct
block|{
name|uint16_t
name|vid
decl_stmt|;
name|uint8_t
name|led_act
index|[
name|BWN_LED_MAX
index|]
decl_stmt|;
block|}
name|bwn_vendor_led_act
index|[]
init|=
block|{
name|VENDOR_LED_ACT
argument_list|(
name|COMPAQ
argument_list|)
block|,
name|VENDOR_LED_ACT
argument_list|(
argument|ASUSTEK
argument_list|)
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
specifier|const
name|uint8_t
name|bwn_default_led_act
index|[
name|BWN_LED_MAX
index|]
init|=
block|{
name|BWN_VENDOR_LED_ACT_DEFAULT
block|}
decl_stmt|;
end_decl_stmt

begin_undef
undef|#
directive|undef
name|VENDOR_LED_ACT
end_undef

begin_struct
specifier|static
specifier|const
struct|struct
block|{
name|int
name|on_dur
decl_stmt|;
name|int
name|off_dur
decl_stmt|;
block|}
name|bwn_led_duration
index|[
literal|109
index|]
init|=
block|{
index|[
literal|0
index|]
operator|=
block|{
literal|400
block|,
literal|100
block|}
block|,
index|[
literal|2
index|]
operator|=
block|{
literal|150
block|,
literal|75
block|}
block|,
index|[
literal|4
index|]
operator|=
block|{
literal|90
block|,
literal|45
block|}
block|,
index|[
literal|11
index|]
operator|=
block|{
literal|66
block|,
literal|34
block|}
block|,
index|[
literal|12
index|]
operator|=
block|{
literal|53
block|,
literal|26
block|}
block|,
index|[
literal|18
index|]
operator|=
block|{
literal|42
block|,
literal|21
block|}
block|,
index|[
literal|22
index|]
operator|=
block|{
literal|35
block|,
literal|17
block|}
block|,
index|[
literal|24
index|]
operator|=
block|{
literal|32
block|,
literal|16
block|}
block|,
index|[
literal|36
index|]
operator|=
block|{
literal|21
block|,
literal|10
block|}
block|,
index|[
literal|48
index|]
operator|=
block|{
literal|16
block|,
literal|8
block|}
block|,
index|[
literal|72
index|]
operator|=
block|{
literal|11
block|,
literal|5
block|}
block|,
index|[
literal|96
index|]
operator|=
block|{
literal|9
block|,
literal|4
block|}
block|,
index|[
literal|108
index|]
operator|=
block|{
literal|7
block|,
literal|3
block|}
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
specifier|const
name|uint16_t
name|bwn_wme_shm_offsets
index|[]
init|=
block|{
index|[
literal|0
index|]
operator|=
name|BWN_WME_BESTEFFORT
block|,
index|[
literal|1
index|]
operator|=
name|BWN_WME_BACKGROUND
block|,
index|[
literal|2
index|]
operator|=
name|BWN_WME_VOICE
block|,
index|[
literal|3
index|]
operator|=
name|BWN_WME_VIDEO
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|siba_devid
name|bwn_devs
index|[]
init|=
block|{
name|SIBA_DEV
argument_list|(
name|BROADCOM
argument_list|,
literal|80211
argument_list|,
literal|5
argument_list|,
literal|"Revision 5"
argument_list|)
block|,
name|SIBA_DEV
argument_list|(
name|BROADCOM
argument_list|,
literal|80211
argument_list|,
literal|6
argument_list|,
literal|"Revision 6"
argument_list|)
block|,
name|SIBA_DEV
argument_list|(
name|BROADCOM
argument_list|,
literal|80211
argument_list|,
literal|7
argument_list|,
literal|"Revision 7"
argument_list|)
block|,
name|SIBA_DEV
argument_list|(
name|BROADCOM
argument_list|,
literal|80211
argument_list|,
literal|9
argument_list|,
literal|"Revision 9"
argument_list|)
block|,
name|SIBA_DEV
argument_list|(
name|BROADCOM
argument_list|,
literal|80211
argument_list|,
literal|10
argument_list|,
literal|"Revision 10"
argument_list|)
block|,
name|SIBA_DEV
argument_list|(
name|BROADCOM
argument_list|,
literal|80211
argument_list|,
literal|11
argument_list|,
literal|"Revision 11"
argument_list|)
block|,
name|SIBA_DEV
argument_list|(
name|BROADCOM
argument_list|,
literal|80211
argument_list|,
literal|13
argument_list|,
literal|"Revision 13"
argument_list|)
block|,
name|SIBA_DEV
argument_list|(
name|BROADCOM
argument_list|,
literal|80211
argument_list|,
literal|15
argument_list|,
literal|"Revision 15"
argument_list|)
block|,
name|SIBA_DEV
argument_list|(
argument|BROADCOM
argument_list|,
literal|80211
argument_list|,
literal|16
argument_list|,
literal|"Revision 16"
argument_list|)
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|bwn_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nitems
argument_list|(
name|bwn_devs
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|siba_get_vendor
argument_list|(
name|dev
argument_list|)
operator|==
name|bwn_devs
index|[
name|i
index|]
operator|.
name|sd_vendor
operator|&&
name|siba_get_device
argument_list|(
name|dev
argument_list|)
operator|==
name|bwn_devs
index|[
name|i
index|]
operator|.
name|sd_device
operator|&&
name|siba_get_revid
argument_list|(
name|dev
argument_list|)
operator|==
name|bwn_devs
index|[
name|i
index|]
operator|.
name|sd_rev
condition|)
return|return
operator|(
name|BUS_PROBE_DEFAULT
operator|)
return|;
block|}
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bwn_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|bwn_mac
modifier|*
name|mac
decl_stmt|;
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|error
decl_stmt|,
name|i
decl_stmt|,
name|msic
decl_stmt|,
name|reg
decl_stmt|;
name|sc
operator|->
name|sc_dev
operator|=
name|dev
expr_stmt|;
ifdef|#
directive|ifdef
name|BWN_DEBUG
name|sc
operator|->
name|sc_debug
operator|=
name|bwn_debug
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|BWN_FLAG_ATTACHED
operator|)
operator|==
literal|0
condition|)
block|{
name|bwn_attach_pre
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|bwn_sprom_bugfixes
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_flags
operator||=
name|BWN_FLAG_ATTACHED
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|TAILQ_EMPTY
argument_list|(
operator|&
name|sc
operator|->
name|sc_maclist
argument_list|)
condition|)
block|{
if|if
condition|(
name|siba_get_pci_device
argument_list|(
name|dev
argument_list|)
operator|!=
literal|0x4313
operator|&&
name|siba_get_pci_device
argument_list|(
name|dev
argument_list|)
operator|!=
literal|0x431a
operator|&&
name|siba_get_pci_device
argument_list|(
name|dev
argument_list|)
operator|!=
literal|0x4321
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"skip 802.11 cores\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENODEV
operator|)
return|;
block|}
block|}
name|mac
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|mac
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|mac
operator|->
name|mac_sc
operator|=
name|sc
expr_stmt|;
name|mac
operator|->
name|mac_status
operator|=
name|BWN_MAC_STATUS_UNINIT
expr_stmt|;
if|if
condition|(
name|bwn_bfp
operator|!=
literal|0
condition|)
name|mac
operator|->
name|mac_flags
operator||=
name|BWN_MAC_FLAG_BADFRAME_PREEMP
expr_stmt|;
name|TASK_INIT
argument_list|(
operator|&
name|mac
operator|->
name|mac_hwreset
argument_list|,
literal|0
argument_list|,
name|bwn_hwreset
argument_list|,
name|mac
argument_list|)
expr_stmt|;
name|TASK_INIT
argument_list|(
operator|&
name|mac
operator|->
name|mac_intrtask
argument_list|,
literal|0
argument_list|,
name|bwn_intrtask
argument_list|,
name|mac
argument_list|)
expr_stmt|;
name|TASK_INIT
argument_list|(
operator|&
name|mac
operator|->
name|mac_txpower
argument_list|,
literal|0
argument_list|,
name|bwn_txpwr
argument_list|,
name|mac
argument_list|)
expr_stmt|;
name|error
operator|=
name|bwn_attach_core
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail0
goto|;
name|bwn_led_attach
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"WLAN (chipid %#x rev %u) "
literal|"PHY (analog %d type %d rev %d) RADIO (manuf %#x ver %#x rev %d)\n"
argument_list|,
name|siba_get_chipid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|siba_get_revid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|mac
operator|->
name|mac_phy
operator|.
name|analog
argument_list|,
name|mac
operator|->
name|mac_phy
operator|.
name|type
argument_list|,
name|mac
operator|->
name|mac_phy
operator|.
name|rev
argument_list|,
name|mac
operator|->
name|mac_phy
operator|.
name|rf_manuf
argument_list|,
name|mac
operator|->
name|mac_phy
operator|.
name|rf_ver
argument_list|,
name|mac
operator|->
name|mac_phy
operator|.
name|rf_rev
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_flags
operator|&
name|BWN_MAC_FLAG_DMA
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"DMA (%d bits)\n"
argument_list|,
name|mac
operator|->
name|mac_method
operator|.
name|dma
operator|.
name|dmatype
argument_list|)
expr_stmt|;
else|else
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"PIO\n"
argument_list|)
expr_stmt|;
comment|/* 	 * setup PCI resources and interrupt. 	 */
if|if
condition|(
name|pci_find_cap
argument_list|(
name|dev
argument_list|,
name|PCIY_EXPRESS
argument_list|,
operator|&
name|reg
argument_list|)
operator|==
literal|0
condition|)
block|{
name|msic
operator|=
name|pci_msi_count
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"MSI count : %d\n"
argument_list|,
name|msic
argument_list|)
expr_stmt|;
block|}
else|else
name|msic
operator|=
literal|0
expr_stmt|;
name|mac
operator|->
name|mac_intr_spec
operator|=
name|bwn_res_spec_legacy
expr_stmt|;
if|if
condition|(
name|msic
operator|==
name|BWN_MSI_MESSAGES
operator|&&
name|bwn_msi_disable
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|pci_alloc_msi
argument_list|(
name|dev
argument_list|,
operator|&
name|msic
argument_list|)
operator|==
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"Using %d MSI messages\n"
argument_list|,
name|msic
argument_list|)
expr_stmt|;
name|mac
operator|->
name|mac_intr_spec
operator|=
name|bwn_res_spec_msi
expr_stmt|;
name|mac
operator|->
name|mac_msi
operator|=
literal|1
expr_stmt|;
block|}
block|}
name|error
operator|=
name|bus_alloc_resources
argument_list|(
name|dev
argument_list|,
name|mac
operator|->
name|mac_intr_spec
argument_list|,
name|mac
operator|->
name|mac_res_irq
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"couldn't allocate IRQ resources (%d)\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
if|if
condition|(
name|mac
operator|->
name|mac_msi
operator|==
literal|0
condition|)
name|error
operator|=
name|bus_setup_intr
argument_list|(
name|dev
argument_list|,
name|mac
operator|->
name|mac_res_irq
index|[
literal|0
index|]
argument_list|,
name|INTR_TYPE_NET
operator||
name|INTR_MPSAFE
argument_list|,
name|bwn_intr
argument_list|,
name|NULL
argument_list|,
name|mac
argument_list|,
operator|&
name|mac
operator|->
name|mac_intrhand
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|BWN_MSI_MESSAGES
condition|;
name|i
operator|++
control|)
block|{
name|error
operator|=
name|bus_setup_intr
argument_list|(
name|dev
argument_list|,
name|mac
operator|->
name|mac_res_irq
index|[
name|i
index|]
argument_list|,
name|INTR_TYPE_NET
operator||
name|INTR_MPSAFE
argument_list|,
name|bwn_intr
argument_list|,
name|NULL
argument_list|,
name|mac
argument_list|,
operator|&
name|mac
operator|->
name|mac_intrhand
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"couldn't setup interrupt (%d)\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|sc
operator|->
name|sc_maclist
argument_list|,
name|mac
argument_list|,
name|mac_list
argument_list|)
expr_stmt|;
comment|/* 	 * calls attach-post routine 	 */
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|BWN_FLAG_ATTACHED
operator|)
operator|!=
literal|0
condition|)
name|bwn_attach_post
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail1
label|:
if|if
condition|(
name|msic
operator|==
name|BWN_MSI_MESSAGES
operator|&&
name|bwn_msi_disable
operator|==
literal|0
condition|)
name|pci_release_msi
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|fail0
label|:
name|free
argument_list|(
name|mac
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bwn_is_valid_ether_addr
parameter_list|(
name|uint8_t
modifier|*
name|addr
parameter_list|)
block|{
name|char
name|zero_addr
index|[
literal|6
index|]
init|=
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
if|if
condition|(
operator|(
name|addr
index|[
literal|0
index|]
operator|&
literal|1
operator|)
operator|||
operator|(
operator|!
name|bcmp
argument_list|(
name|addr
argument_list|,
name|zero_addr
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
operator|)
condition|)
return|return
operator|(
name|FALSE
operator|)
return|;
return|return
operator|(
name|TRUE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bwn_attach_post
parameter_list|(
name|struct
name|bwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
name|ic
operator|->
name|ic_softc
operator|=
name|sc
expr_stmt|;
name|ic
operator|->
name|ic_name
operator|=
name|device_get_nameunit
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
expr_stmt|;
comment|/* XXX not right but it's not used anywhere important */
name|ic
operator|->
name|ic_phytype
operator|=
name|IEEE80211_T_OFDM
expr_stmt|;
name|ic
operator|->
name|ic_opmode
operator|=
name|IEEE80211_M_STA
expr_stmt|;
name|ic
operator|->
name|ic_caps
operator|=
name|IEEE80211_C_STA
comment|/* station mode supported */
operator||
name|IEEE80211_C_MONITOR
comment|/* monitor mode */
operator||
name|IEEE80211_C_AHDEMO
comment|/* adhoc demo mode */
operator||
name|IEEE80211_C_SHPREAMBLE
comment|/* short preamble supported */
operator||
name|IEEE80211_C_SHSLOT
comment|/* short slot time supported */
operator||
name|IEEE80211_C_WME
comment|/* WME/WMM supported */
operator||
name|IEEE80211_C_WPA
comment|/* capable of WPA1+WPA2 */
if|#
directive|if
literal|0
expr|| IEEE80211_C_BGSCAN
comment|/* capable of bg scanning */
endif|#
directive|endif
operator||
name|IEEE80211_C_TXPMGT
comment|/* capable of txpow mgt */
expr_stmt|;
name|ic
operator|->
name|ic_flags_ext
operator||=
name|IEEE80211_FEXT_SWBMISS
expr_stmt|;
comment|/* s/w bmiss */
name|IEEE80211_ADDR_COPY
argument_list|(
name|ic
operator|->
name|ic_macaddr
argument_list|,
name|bwn_is_valid_ether_addr
argument_list|(
name|siba_sprom_get_mac_80211a
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|)
condition|?
name|siba_sprom_get_mac_80211a
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
else|:
name|siba_sprom_get_mac_80211bg
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|)
expr_stmt|;
comment|/* call MI attach routine. */
name|ieee80211_ifattach
argument_list|(
name|ic
argument_list|)
expr_stmt|;
name|ic
operator|->
name|ic_headroom
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|bwn_txhdr
argument_list|)
expr_stmt|;
comment|/* override default methods */
name|ic
operator|->
name|ic_raw_xmit
operator|=
name|bwn_raw_xmit
expr_stmt|;
name|ic
operator|->
name|ic_updateslot
operator|=
name|bwn_updateslot
expr_stmt|;
name|ic
operator|->
name|ic_update_promisc
operator|=
name|bwn_update_promisc
expr_stmt|;
name|ic
operator|->
name|ic_wme
operator|.
name|wme_update
operator|=
name|bwn_wme_update
expr_stmt|;
name|ic
operator|->
name|ic_scan_start
operator|=
name|bwn_scan_start
expr_stmt|;
name|ic
operator|->
name|ic_scan_end
operator|=
name|bwn_scan_end
expr_stmt|;
name|ic
operator|->
name|ic_set_channel
operator|=
name|bwn_set_channel
expr_stmt|;
name|ic
operator|->
name|ic_vap_create
operator|=
name|bwn_vap_create
expr_stmt|;
name|ic
operator|->
name|ic_vap_delete
operator|=
name|bwn_vap_delete
expr_stmt|;
name|ic
operator|->
name|ic_transmit
operator|=
name|bwn_transmit
expr_stmt|;
name|ic
operator|->
name|ic_parent
operator|=
name|bwn_parent
expr_stmt|;
name|ieee80211_radiotap_attach
argument_list|(
name|ic
argument_list|,
operator|&
name|sc
operator|->
name|sc_tx_th
operator|.
name|wt_ihdr
argument_list|,
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|sc_tx_th
argument_list|)
argument_list|,
name|BWN_TX_RADIOTAP_PRESENT
argument_list|,
operator|&
name|sc
operator|->
name|sc_rx_th
operator|.
name|wr_ihdr
argument_list|,
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|sc_rx_th
argument_list|)
argument_list|,
name|BWN_RX_RADIOTAP_PRESENT
argument_list|)
expr_stmt|;
name|bwn_sysctl_node
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|ieee80211_announce
argument_list|(
name|ic
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_phy_detach
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|detach
operator|!=
name|NULL
condition|)
name|mac
operator|->
name|mac_phy
operator|.
name|detach
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|bwn_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|bwn_mac
modifier|*
name|mac
init|=
name|sc
operator|->
name|sc_curmac
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
name|int
name|i
decl_stmt|;
name|sc
operator|->
name|sc_flags
operator||=
name|BWN_FLAG_INVALID
expr_stmt|;
if|if
condition|(
name|device_is_attached
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
condition|)
block|{
name|BWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|bwn_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|BWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|bwn_dma_free
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|callout_drain
argument_list|(
operator|&
name|sc
operator|->
name|sc_led_blink_ch
argument_list|)
expr_stmt|;
name|callout_drain
argument_list|(
operator|&
name|sc
operator|->
name|sc_rfswitch_ch
argument_list|)
expr_stmt|;
name|callout_drain
argument_list|(
operator|&
name|sc
operator|->
name|sc_task_ch
argument_list|)
expr_stmt|;
name|callout_drain
argument_list|(
operator|&
name|sc
operator|->
name|sc_watchdog_ch
argument_list|)
expr_stmt|;
name|bwn_phy_detach
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|ieee80211_draintask
argument_list|(
name|ic
argument_list|,
operator|&
name|mac
operator|->
name|mac_hwreset
argument_list|)
expr_stmt|;
name|ieee80211_draintask
argument_list|(
name|ic
argument_list|,
operator|&
name|mac
operator|->
name|mac_txpower
argument_list|)
expr_stmt|;
name|ieee80211_ifdetach
argument_list|(
name|ic
argument_list|)
expr_stmt|;
block|}
name|taskqueue_drain
argument_list|(
name|sc
operator|->
name|sc_tq
argument_list|,
operator|&
name|mac
operator|->
name|mac_intrtask
argument_list|)
expr_stmt|;
name|taskqueue_free
argument_list|(
name|sc
operator|->
name|sc_tq
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|BWN_MSI_MESSAGES
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|mac
operator|->
name|mac_intrhand
index|[
name|i
index|]
operator|!=
name|NULL
condition|)
block|{
name|bus_teardown_intr
argument_list|(
name|dev
argument_list|,
name|mac
operator|->
name|mac_res_irq
index|[
name|i
index|]
argument_list|,
name|mac
operator|->
name|mac_intrhand
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|mac
operator|->
name|mac_intrhand
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
block|}
block|}
name|bus_release_resources
argument_list|(
name|dev
argument_list|,
name|mac
operator|->
name|mac_intr_spec
argument_list|,
name|mac
operator|->
name|mac_res_irq
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_msi
operator|!=
literal|0
condition|)
name|pci_release_msi
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|mbufq_drain
argument_list|(
operator|&
name|sc
operator|->
name|sc_snd
argument_list|)
expr_stmt|;
name|BWN_LOCK_DESTROY
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_attach_pre
parameter_list|(
name|struct
name|bwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|BWN_LOCK_INIT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|TAILQ_INIT
argument_list|(
operator|&
name|sc
operator|->
name|sc_maclist
argument_list|)
expr_stmt|;
name|callout_init_mtx
argument_list|(
operator|&
name|sc
operator|->
name|sc_rfswitch_ch
argument_list|,
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|callout_init_mtx
argument_list|(
operator|&
name|sc
operator|->
name|sc_task_ch
argument_list|,
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|callout_init_mtx
argument_list|(
operator|&
name|sc
operator|->
name|sc_watchdog_ch
argument_list|,
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mbufq_init
argument_list|(
operator|&
name|sc
operator|->
name|sc_snd
argument_list|,
name|ifqmaxlen
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_tq
operator|=
name|taskqueue_create_fast
argument_list|(
literal|"bwn_taskq"
argument_list|,
name|M_NOWAIT
argument_list|,
name|taskqueue_thread_enqueue
argument_list|,
operator|&
name|sc
operator|->
name|sc_tq
argument_list|)
expr_stmt|;
name|taskqueue_start_threads
argument_list|(
operator|&
name|sc
operator|->
name|sc_tq
argument_list|,
literal|1
argument_list|,
name|PI_NET
argument_list|,
literal|"%s taskq"
argument_list|,
name|device_get_nameunit
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_sprom_bugfixes
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
define|#
directive|define
name|BWN_ISDEV
parameter_list|(
name|_vendor
parameter_list|,
name|_device
parameter_list|,
name|_subvendor
parameter_list|,
name|_subdevice
parameter_list|)
define|\
value|((siba_get_pci_vendor(dev) == PCI_VENDOR_##_vendor)&&		\ 	 (siba_get_pci_device(dev) == _device)&&			\ 	 (siba_get_pci_subvendor(dev) == PCI_VENDOR_##_subvendor)&&	\ 	 (siba_get_pci_subdevice(dev) == _subdevice))
if|if
condition|(
name|siba_get_pci_subvendor
argument_list|(
name|dev
argument_list|)
operator|==
name|PCI_VENDOR_APPLE
operator|&&
name|siba_get_pci_subdevice
argument_list|(
name|dev
argument_list|)
operator|==
literal|0x4e
operator|&&
name|siba_get_pci_revid
argument_list|(
name|dev
argument_list|)
operator|>
literal|0x40
condition|)
name|siba_sprom_set_bf_lo
argument_list|(
name|dev
argument_list|,
name|siba_sprom_get_bf_lo
argument_list|(
name|dev
argument_list|)
operator||
name|BWN_BFL_PACTRL
argument_list|)
expr_stmt|;
if|if
condition|(
name|siba_get_pci_subvendor
argument_list|(
name|dev
argument_list|)
operator|==
name|SIBA_BOARDVENDOR_DELL
operator|&&
name|siba_get_chipid
argument_list|(
name|dev
argument_list|)
operator|==
literal|0x4301
operator|&&
name|siba_get_pci_revid
argument_list|(
name|dev
argument_list|)
operator|==
literal|0x74
condition|)
name|siba_sprom_set_bf_lo
argument_list|(
name|dev
argument_list|,
name|siba_sprom_get_bf_lo
argument_list|(
name|dev
argument_list|)
operator||
name|BWN_BFL_BTCOEXIST
argument_list|)
expr_stmt|;
if|if
condition|(
name|siba_get_type
argument_list|(
name|dev
argument_list|)
operator|==
name|SIBA_TYPE_PCI
condition|)
block|{
if|if
condition|(
name|BWN_ISDEV
argument_list|(
name|BROADCOM
argument_list|,
literal|0x4318
argument_list|,
name|ASUSTEK
argument_list|,
literal|0x100f
argument_list|)
operator|||
name|BWN_ISDEV
argument_list|(
name|BROADCOM
argument_list|,
literal|0x4320
argument_list|,
name|DELL
argument_list|,
literal|0x0003
argument_list|)
operator|||
name|BWN_ISDEV
argument_list|(
name|BROADCOM
argument_list|,
literal|0x4320
argument_list|,
name|HP
argument_list|,
literal|0x12f8
argument_list|)
operator|||
name|BWN_ISDEV
argument_list|(
name|BROADCOM
argument_list|,
literal|0x4320
argument_list|,
name|LINKSYS
argument_list|,
literal|0x0013
argument_list|)
operator|||
name|BWN_ISDEV
argument_list|(
name|BROADCOM
argument_list|,
literal|0x4320
argument_list|,
name|LINKSYS
argument_list|,
literal|0x0014
argument_list|)
operator|||
name|BWN_ISDEV
argument_list|(
name|BROADCOM
argument_list|,
literal|0x4320
argument_list|,
name|LINKSYS
argument_list|,
literal|0x0015
argument_list|)
operator|||
name|BWN_ISDEV
argument_list|(
name|BROADCOM
argument_list|,
literal|0x4320
argument_list|,
name|MOTOROLA
argument_list|,
literal|0x7010
argument_list|)
condition|)
name|siba_sprom_set_bf_lo
argument_list|(
name|dev
argument_list|,
name|siba_sprom_get_bf_lo
argument_list|(
name|dev
argument_list|)
operator|&
operator|~
name|BWN_BFL_BTCOEXIST
argument_list|)
expr_stmt|;
block|}
undef|#
directive|undef
name|BWN_ISDEV
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_parent
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_softc
decl_stmt|;
name|int
name|startall
init|=
literal|0
decl_stmt|;
name|BWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|ic
operator|->
name|ic_nrunning
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|BWN_FLAG_RUNNING
operator|)
operator|==
literal|0
condition|)
block|{
name|bwn_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|startall
operator|=
literal|1
expr_stmt|;
block|}
else|else
name|bwn_update_promisc
argument_list|(
name|ic
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sc
operator|->
name|sc_flags
operator|&
name|BWN_FLAG_RUNNING
condition|)
name|bwn_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|BWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|startall
condition|)
name|ieee80211_start_all
argument_list|(
name|ic
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|bwn_transmit
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_softc
decl_stmt|;
name|int
name|error
decl_stmt|;
name|BWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|BWN_FLAG_RUNNING
operator|)
operator|==
literal|0
condition|)
block|{
name|BWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|error
operator|=
name|mbufq_enqueue
argument_list|(
operator|&
name|sc
operator|->
name|sc_snd
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|BWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|bwn_start
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|BWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_start
parameter_list|(
name|struct
name|bwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|bwn_mac
modifier|*
name|mac
init|=
name|sc
operator|->
name|sc_curmac
decl_stmt|;
name|struct
name|ieee80211_frame
modifier|*
name|wh
decl_stmt|;
name|struct
name|ieee80211_node
modifier|*
name|ni
decl_stmt|;
name|struct
name|ieee80211_key
modifier|*
name|k
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|BWN_ASSERT_LOCKED
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|BWN_FLAG_RUNNING
operator|)
operator|==
literal|0
operator|||
name|mac
operator|==
name|NULL
operator|||
name|mac
operator|->
name|mac_status
operator|<
name|BWN_MAC_STATUS_STARTED
condition|)
return|return;
while|while
condition|(
operator|(
name|m
operator|=
name|mbufq_dequeue
argument_list|(
operator|&
name|sc
operator|->
name|sc_snd
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|bwn_tx_isfull
argument_list|(
name|sc
argument_list|,
name|m
argument_list|)
condition|)
break|break;
name|ni
operator|=
operator|(
expr|struct
name|ieee80211_node
operator|*
operator|)
name|m
operator|->
name|m_pkthdr
operator|.
name|rcvif
expr_stmt|;
if|if
condition|(
name|ni
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"unexpected NULL ni\n"
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|counter_u64_add
argument_list|(
name|sc
operator|->
name|sc_ic
operator|.
name|ic_oerrors
argument_list|,
literal|1
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|wh
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ieee80211_frame
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator|&
name|IEEE80211_FC1_PROTECTED
condition|)
block|{
name|k
operator|=
name|ieee80211_crypto_encap
argument_list|(
name|ni
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|k
operator|==
name|NULL
condition|)
block|{
name|if_inc_counter
argument_list|(
name|ni
operator|->
name|ni_vap
operator|->
name|iv_ifp
argument_list|,
name|IFCOUNTER_OERRORS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ieee80211_free_node
argument_list|(
name|ni
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
continue|continue;
block|}
block|}
name|wh
operator|=
name|NULL
expr_stmt|;
comment|/* Catch any invalid use */
if|if
condition|(
name|bwn_tx_start
argument_list|(
name|sc
argument_list|,
name|ni
argument_list|,
name|m
argument_list|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|ni
operator|!=
name|NULL
condition|)
block|{
name|if_inc_counter
argument_list|(
name|ni
operator|->
name|ni_vap
operator|->
name|iv_ifp
argument_list|,
name|IFCOUNTER_OERRORS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ieee80211_free_node
argument_list|(
name|ni
argument_list|)
expr_stmt|;
block|}
continue|continue;
block|}
name|sc
operator|->
name|sc_watchdog_timer
operator|=
literal|5
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|bwn_tx_isfull
parameter_list|(
name|struct
name|bwn_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|)
block|{
name|struct
name|bwn_dma_ring
modifier|*
name|dr
decl_stmt|;
name|struct
name|bwn_mac
modifier|*
name|mac
init|=
name|sc
operator|->
name|sc_curmac
decl_stmt|;
name|struct
name|bwn_pio_txqueue
modifier|*
name|tq
decl_stmt|;
name|int
name|pktlen
init|=
name|roundup
argument_list|(
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|+
name|BWN_HDRSIZE
argument_list|(
name|mac
argument_list|)
argument_list|,
literal|4
argument_list|)
decl_stmt|;
name|BWN_ASSERT_LOCKED
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_flags
operator|&
name|BWN_MAC_FLAG_DMA
condition|)
block|{
name|dr
operator|=
name|bwn_dma_select
argument_list|(
name|mac
argument_list|,
name|M_WME_GETAC
argument_list|(
name|m
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dr
operator|->
name|dr_stop
operator|==
literal|1
operator|||
name|bwn_dma_freeslot
argument_list|(
name|dr
argument_list|)
operator|<
name|BWN_TX_SLOTS_PER_FRAME
condition|)
block|{
name|dr
operator|->
name|dr_stop
operator|=
literal|1
expr_stmt|;
goto|goto
name|full
goto|;
block|}
block|}
else|else
block|{
name|tq
operator|=
name|bwn_pio_select
argument_list|(
name|mac
argument_list|,
name|M_WME_GETAC
argument_list|(
name|m
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tq
operator|->
name|tq_free
operator|==
literal|0
operator|||
name|pktlen
operator|>
name|tq
operator|->
name|tq_size
operator|||
name|pktlen
operator|>
operator|(
name|tq
operator|->
name|tq_size
operator|-
name|tq
operator|->
name|tq_used
operator|)
condition|)
goto|goto
name|full
goto|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|full
label|:
name|mbufq_prepend
argument_list|(
operator|&
name|sc
operator|->
name|sc_snd
argument_list|,
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bwn_tx_start
parameter_list|(
name|struct
name|bwn_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|ieee80211_node
modifier|*
name|ni
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|)
block|{
name|struct
name|bwn_mac
modifier|*
name|mac
init|=
name|sc
operator|->
name|sc_curmac
decl_stmt|;
name|int
name|error
decl_stmt|;
name|BWN_ASSERT_LOCKED
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|<
name|IEEE80211_MIN_LEN
operator|||
name|mac
operator|==
name|NULL
condition|)
block|{
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|error
operator|=
operator|(
name|mac
operator|->
name|mac_flags
operator|&
name|BWN_MAC_FLAG_DMA
operator|)
condition|?
name|bwn_dma_tx_start
argument_list|(
name|mac
argument_list|,
name|ni
argument_list|,
name|m
argument_list|)
else|:
name|bwn_pio_tx_start
argument_list|(
name|mac
argument_list|,
name|ni
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bwn_pio_tx_start
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|struct
name|ieee80211_node
modifier|*
name|ni
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|)
block|{
name|struct
name|bwn_pio_txpkt
modifier|*
name|tp
decl_stmt|;
name|struct
name|bwn_pio_txqueue
modifier|*
name|tq
init|=
name|bwn_pio_select
argument_list|(
name|mac
argument_list|,
name|M_WME_GETAC
argument_list|(
name|m
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|struct
name|bwn_txhdr
name|txhdr
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m_new
decl_stmt|;
name|uint32_t
name|ctl32
decl_stmt|;
name|int
name|error
decl_stmt|;
name|uint16_t
name|ctl16
decl_stmt|;
name|BWN_ASSERT_LOCKED
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* XXX TODO send packets after DTIM */
name|KASSERT
argument_list|(
operator|!
name|TAILQ_EMPTY
argument_list|(
operator|&
name|tq
operator|->
name|tq_pktlist
argument_list|)
argument_list|,
operator|(
literal|"%s: fail"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
name|tp
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|tq
operator|->
name|tq_pktlist
argument_list|)
expr_stmt|;
name|tp
operator|->
name|tp_ni
operator|=
name|ni
expr_stmt|;
name|tp
operator|->
name|tp_m
operator|=
name|m
expr_stmt|;
name|error
operator|=
name|bwn_set_txhdr
argument_list|(
name|mac
argument_list|,
name|ni
argument_list|,
name|m
argument_list|,
operator|&
name|txhdr
argument_list|,
name|BWN_PIO_COOKIE
argument_list|(
name|tq
argument_list|,
name|tp
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"tx fail\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|TAILQ_REMOVE
argument_list|(
operator|&
name|tq
operator|->
name|tq_pktlist
argument_list|,
name|tp
argument_list|,
name|tp_list
argument_list|)
expr_stmt|;
name|tq
operator|->
name|tq_used
operator|+=
name|roundup
argument_list|(
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|+
name|BWN_HDRSIZE
argument_list|(
name|mac
argument_list|)
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|tq
operator|->
name|tq_free
operator|--
expr_stmt|;
if|if
condition|(
name|siba_get_revid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|>=
literal|8
condition|)
block|{
comment|/* 		 * XXX please removes m_defrag(9) 		 */
name|m_new
operator|=
name|m_defrag
argument_list|(
name|m
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|m_new
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: can't defrag TX buffer\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOBUFS
operator|)
return|;
block|}
if|if
condition|(
name|m_new
operator|->
name|m_next
operator|!=
name|NULL
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"TODO: fragmented packets for PIO\n"
argument_list|)
expr_stmt|;
name|tp
operator|->
name|tp_m
operator|=
name|m_new
expr_stmt|;
comment|/* send HEADER */
name|ctl32
operator|=
name|bwn_pio_write_multi_4
argument_list|(
name|mac
argument_list|,
name|tq
argument_list|,
operator|(
name|BWN_PIO_READ_4
argument_list|(
name|mac
argument_list|,
name|tq
argument_list|,
name|BWN_PIO8_TXCTL
argument_list|)
operator||
name|BWN_PIO8_TXCTL_FRAMEREADY
operator|)
operator|&
operator|~
name|BWN_PIO8_TXCTL_EOF
argument_list|,
operator|(
specifier|const
name|uint8_t
operator|*
operator|)
operator|&
name|txhdr
argument_list|,
name|BWN_HDRSIZE
argument_list|(
name|mac
argument_list|)
argument_list|)
expr_stmt|;
comment|/* send BODY */
name|ctl32
operator|=
name|bwn_pio_write_multi_4
argument_list|(
name|mac
argument_list|,
name|tq
argument_list|,
name|ctl32
argument_list|,
name|mtod
argument_list|(
name|m_new
argument_list|,
specifier|const
name|void
operator|*
argument_list|)
argument_list|,
name|m_new
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|)
expr_stmt|;
name|bwn_pio_write_4
argument_list|(
name|mac
argument_list|,
name|tq
argument_list|,
name|BWN_PIO_TXCTL
argument_list|,
name|ctl32
operator||
name|BWN_PIO8_TXCTL_EOF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ctl16
operator|=
name|bwn_pio_write_multi_2
argument_list|(
name|mac
argument_list|,
name|tq
argument_list|,
operator|(
name|bwn_pio_read_2
argument_list|(
name|mac
argument_list|,
name|tq
argument_list|,
name|BWN_PIO_TXCTL
argument_list|)
operator||
name|BWN_PIO_TXCTL_FRAMEREADY
operator|)
operator|&
operator|~
name|BWN_PIO_TXCTL_EOF
argument_list|,
operator|(
specifier|const
name|uint8_t
operator|*
operator|)
operator|&
name|txhdr
argument_list|,
name|BWN_HDRSIZE
argument_list|(
name|mac
argument_list|)
argument_list|)
expr_stmt|;
name|ctl16
operator|=
name|bwn_pio_write_mbuf_2
argument_list|(
name|mac
argument_list|,
name|tq
argument_list|,
name|ctl16
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|BWN_PIO_WRITE_2
argument_list|(
name|mac
argument_list|,
name|tq
argument_list|,
name|BWN_PIO_TXCTL
argument_list|,
name|ctl16
operator||
name|BWN_PIO_TXCTL_EOF
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|bwn_pio_txqueue
modifier|*
name|bwn_pio_select
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint8_t
name|prio
parameter_list|)
block|{
if|if
condition|(
operator|(
name|mac
operator|->
name|mac_flags
operator|&
name|BWN_MAC_FLAG_WME
operator|)
operator|==
literal|0
condition|)
return|return
operator|(
operator|&
name|mac
operator|->
name|mac_method
operator|.
name|pio
operator|.
name|wme
index|[
name|WME_AC_BE
index|]
operator|)
return|;
switch|switch
condition|(
name|prio
condition|)
block|{
case|case
literal|0
case|:
return|return
operator|(
operator|&
name|mac
operator|->
name|mac_method
operator|.
name|pio
operator|.
name|wme
index|[
name|WME_AC_BE
index|]
operator|)
return|;
case|case
literal|1
case|:
return|return
operator|(
operator|&
name|mac
operator|->
name|mac_method
operator|.
name|pio
operator|.
name|wme
index|[
name|WME_AC_BK
index|]
operator|)
return|;
case|case
literal|2
case|:
return|return
operator|(
operator|&
name|mac
operator|->
name|mac_method
operator|.
name|pio
operator|.
name|wme
index|[
name|WME_AC_VI
index|]
operator|)
return|;
case|case
literal|3
case|:
return|return
operator|(
operator|&
name|mac
operator|->
name|mac_method
operator|.
name|pio
operator|.
name|wme
index|[
name|WME_AC_VO
index|]
operator|)
return|;
block|}
name|KASSERT
argument_list|(
literal|0
operator|==
literal|1
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bwn_dma_tx_start
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|struct
name|ieee80211_node
modifier|*
name|ni
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|)
block|{
define|#
directive|define
name|BWN_GET_TXHDRCACHE
parameter_list|(
name|slot
parameter_list|)
define|\
value|&(txhdr_cache[(slot / BWN_TX_SLOTS_PER_FRAME) * BWN_HDRSIZE(mac)])
name|struct
name|bwn_dma
modifier|*
name|dma
init|=
operator|&
name|mac
operator|->
name|mac_method
operator|.
name|dma
decl_stmt|;
name|struct
name|bwn_dma_ring
modifier|*
name|dr
init|=
name|bwn_dma_select
argument_list|(
name|mac
argument_list|,
name|M_WME_GETAC
argument_list|(
name|m
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|bwn_dmadesc_generic
modifier|*
name|desc
decl_stmt|;
name|struct
name|bwn_dmadesc_meta
modifier|*
name|mt
decl_stmt|;
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|uint8_t
modifier|*
name|txhdr_cache
init|=
operator|(
name|uint8_t
operator|*
operator|)
name|dr
operator|->
name|dr_txhdr_cache
decl_stmt|;
name|int
name|error
decl_stmt|,
name|slot
decl_stmt|,
name|backup
index|[
literal|2
index|]
init|=
block|{
name|dr
operator|->
name|dr_curslot
block|,
name|dr
operator|->
name|dr_usedslot
block|}
decl_stmt|;
name|BWN_ASSERT_LOCKED
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
operator|!
name|dr
operator|->
name|dr_stop
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
comment|/* XXX send after DTIM */
name|slot
operator|=
name|bwn_dma_getslot
argument_list|(
name|dr
argument_list|)
expr_stmt|;
name|dr
operator|->
name|getdesc
argument_list|(
name|dr
argument_list|,
name|slot
argument_list|,
operator|&
name|desc
argument_list|,
operator|&
name|mt
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|mt
operator|->
name|mt_txtype
operator|==
name|BWN_DMADESC_METATYPE_HEADER
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|bwn_set_txhdr
argument_list|(
name|dr
operator|->
name|dr_mac
argument_list|,
name|ni
argument_list|,
name|m
argument_list|,
operator|(
expr|struct
name|bwn_txhdr
operator|*
operator|)
name|BWN_GET_TXHDRCACHE
argument_list|(
name|slot
argument_list|)
argument_list|,
name|BWN_DMA_COOKIE
argument_list|(
name|dr
argument_list|,
name|slot
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
name|error
operator|=
name|bus_dmamap_load
argument_list|(
name|dr
operator|->
name|dr_txring_dtag
argument_list|,
name|mt
operator|->
name|mt_dmap
argument_list|,
name|BWN_GET_TXHDRCACHE
argument_list|(
name|slot
argument_list|)
argument_list|,
name|BWN_HDRSIZE
argument_list|(
name|mac
argument_list|)
argument_list|,
name|bwn_dma_ring_addr
argument_list|,
operator|&
name|mt
operator|->
name|mt_paddr
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: can't load TX buffer (1) %d\n"
argument_list|,
name|__func__
argument_list|,
name|error
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|bus_dmamap_sync
argument_list|(
name|dr
operator|->
name|dr_txring_dtag
argument_list|,
name|mt
operator|->
name|mt_dmap
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
name|dr
operator|->
name|setdesc
argument_list|(
name|dr
argument_list|,
name|desc
argument_list|,
name|mt
operator|->
name|mt_paddr
argument_list|,
name|BWN_HDRSIZE
argument_list|(
name|mac
argument_list|)
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|dr
operator|->
name|dr_ring_dtag
argument_list|,
name|dr
operator|->
name|dr_ring_dmap
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
name|slot
operator|=
name|bwn_dma_getslot
argument_list|(
name|dr
argument_list|)
expr_stmt|;
name|dr
operator|->
name|getdesc
argument_list|(
name|dr
argument_list|,
name|slot
argument_list|,
operator|&
name|desc
argument_list|,
operator|&
name|mt
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|mt
operator|->
name|mt_txtype
operator|==
name|BWN_DMADESC_METATYPE_BODY
operator|&&
name|mt
operator|->
name|mt_islast
operator|==
literal|1
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
name|mt
operator|->
name|mt_m
operator|=
name|m
expr_stmt|;
name|mt
operator|->
name|mt_ni
operator|=
name|ni
expr_stmt|;
name|error
operator|=
name|bus_dmamap_load_mbuf
argument_list|(
name|dma
operator|->
name|txbuf_dtag
argument_list|,
name|mt
operator|->
name|mt_dmap
argument_list|,
name|m
argument_list|,
name|bwn_dma_buf_addr
argument_list|,
operator|&
name|mt
operator|->
name|mt_paddr
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|&&
name|error
operator|!=
name|EFBIG
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: can't load TX buffer (1) %d\n"
argument_list|,
name|__func__
argument_list|,
name|error
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|error
condition|)
block|{
comment|/* error == EFBIG */
name|struct
name|mbuf
modifier|*
name|m_new
decl_stmt|;
name|m_new
operator|=
name|m_defrag
argument_list|(
name|m
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|m_new
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: can't defrag TX buffer\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENOBUFS
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
else|else
block|{
name|m
operator|=
name|m_new
expr_stmt|;
block|}
name|mt
operator|->
name|mt_m
operator|=
name|m
expr_stmt|;
name|error
operator|=
name|bus_dmamap_load_mbuf
argument_list|(
name|dma
operator|->
name|txbuf_dtag
argument_list|,
name|mt
operator|->
name|mt_dmap
argument_list|,
name|m
argument_list|,
name|bwn_dma_buf_addr
argument_list|,
operator|&
name|mt
operator|->
name|mt_paddr
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: can't load TX buffer (2) %d\n"
argument_list|,
name|__func__
argument_list|,
name|error
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
block|}
name|bus_dmamap_sync
argument_list|(
name|dma
operator|->
name|txbuf_dtag
argument_list|,
name|mt
operator|->
name|mt_dmap
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
name|dr
operator|->
name|setdesc
argument_list|(
name|dr
argument_list|,
name|desc
argument_list|,
name|mt
operator|->
name|mt_paddr
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|dr
operator|->
name|dr_ring_dtag
argument_list|,
name|dr
operator|->
name|dr_ring_dmap
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
comment|/* XXX send after DTIM */
name|dr
operator|->
name|start_transfer
argument_list|(
name|dr
argument_list|,
name|bwn_dma_nextslot
argument_list|(
name|dr
argument_list|,
name|slot
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail
label|:
name|dr
operator|->
name|dr_curslot
operator|=
name|backup
index|[
literal|0
index|]
expr_stmt|;
name|dr
operator|->
name|dr_usedslot
operator|=
name|backup
index|[
literal|1
index|]
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
undef|#
directive|undef
name|BWN_GET_TXHDRCACHE
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_watchdog
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|arg
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_watchdog_timer
operator|!=
literal|0
operator|&&
operator|--
name|sc
operator|->
name|sc_watchdog_timer
operator|==
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"device timeout\n"
argument_list|)
expr_stmt|;
name|counter_u64_add
argument_list|(
name|sc
operator|->
name|sc_ic
operator|.
name|ic_oerrors
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|callout_schedule
argument_list|(
operator|&
name|sc
operator|->
name|sc_watchdog_ch
argument_list|,
name|hz
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|bwn_attach_core
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|int
name|error
decl_stmt|,
name|have_bg
init|=
literal|0
decl_stmt|,
name|have_a
init|=
literal|0
decl_stmt|;
name|uint32_t
name|high
decl_stmt|;
name|KASSERT
argument_list|(
name|siba_get_revid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|>=
literal|5
argument_list|,
operator|(
literal|"unsupported revision %d"
operator|,
name|siba_get_revid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|siba_powerup
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|high
operator|=
name|siba_read_4
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
name|SIBA_TGSHIGH
argument_list|)
expr_stmt|;
name|bwn_reset_core
argument_list|(
name|mac
argument_list|,
operator|!
operator|!
operator|(
name|high
operator|&
name|BWN_TGSHIGH_HAVE_2GHZ
operator|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|bwn_phy_getinfo
argument_list|(
name|mac
argument_list|,
name|high
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
name|have_a
operator|=
operator|(
name|high
operator|&
name|BWN_TGSHIGH_HAVE_5GHZ
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|have_bg
operator|=
operator|(
name|high
operator|&
name|BWN_TGSHIGH_HAVE_2GHZ
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
if|if
condition|(
name|siba_get_pci_device
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|!=
literal|0x4312
operator|&&
name|siba_get_pci_device
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|!=
literal|0x4319
operator|&&
name|siba_get_pci_device
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|!=
literal|0x4324
condition|)
block|{
name|have_a
operator|=
name|have_bg
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|type
operator|==
name|BWN_PHYTYPE_A
condition|)
name|have_a
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|type
operator|==
name|BWN_PHYTYPE_G
operator|||
name|mac
operator|->
name|mac_phy
operator|.
name|type
operator|==
name|BWN_PHYTYPE_N
operator|||
name|mac
operator|->
name|mac_phy
operator|.
name|type
operator|==
name|BWN_PHYTYPE_LP
condition|)
name|have_bg
operator|=
literal|1
expr_stmt|;
else|else
name|KASSERT
argument_list|(
literal|0
operator|==
literal|1
argument_list|,
operator|(
literal|"%s: unknown phy type (%d)"
operator|,
name|__func__
operator|,
name|mac
operator|->
name|mac_phy
operator|.
name|type
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* XXX turns off PHY A because it's not supported */
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|type
operator|!=
name|BWN_PHYTYPE_LP
operator|&&
name|mac
operator|->
name|mac_phy
operator|.
name|type
operator|!=
name|BWN_PHYTYPE_N
condition|)
block|{
name|have_a
operator|=
literal|0
expr_stmt|;
name|have_bg
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|type
operator|==
name|BWN_PHYTYPE_G
condition|)
block|{
name|mac
operator|->
name|mac_phy
operator|.
name|attach
operator|=
name|bwn_phy_g_attach
expr_stmt|;
name|mac
operator|->
name|mac_phy
operator|.
name|detach
operator|=
name|bwn_phy_g_detach
expr_stmt|;
name|mac
operator|->
name|mac_phy
operator|.
name|prepare_hw
operator|=
name|bwn_phy_g_prepare_hw
expr_stmt|;
name|mac
operator|->
name|mac_phy
operator|.
name|init_pre
operator|=
name|bwn_phy_g_init_pre
expr_stmt|;
name|mac
operator|->
name|mac_phy
operator|.
name|init
operator|=
name|bwn_phy_g_init
expr_stmt|;
name|mac
operator|->
name|mac_phy
operator|.
name|exit
operator|=
name|bwn_phy_g_exit
expr_stmt|;
name|mac
operator|->
name|mac_phy
operator|.
name|phy_read
operator|=
name|bwn_phy_g_read
expr_stmt|;
name|mac
operator|->
name|mac_phy
operator|.
name|phy_write
operator|=
name|bwn_phy_g_write
expr_stmt|;
name|mac
operator|->
name|mac_phy
operator|.
name|rf_read
operator|=
name|bwn_phy_g_rf_read
expr_stmt|;
name|mac
operator|->
name|mac_phy
operator|.
name|rf_write
operator|=
name|bwn_phy_g_rf_write
expr_stmt|;
name|mac
operator|->
name|mac_phy
operator|.
name|use_hwpctl
operator|=
name|bwn_phy_g_hwpctl
expr_stmt|;
name|mac
operator|->
name|mac_phy
operator|.
name|rf_onoff
operator|=
name|bwn_phy_g_rf_onoff
expr_stmt|;
name|mac
operator|->
name|mac_phy
operator|.
name|switch_analog
operator|=
name|bwn_phy_switch_analog
expr_stmt|;
name|mac
operator|->
name|mac_phy
operator|.
name|switch_channel
operator|=
name|bwn_phy_g_switch_channel
expr_stmt|;
name|mac
operator|->
name|mac_phy
operator|.
name|get_default_chan
operator|=
name|bwn_phy_g_get_default_chan
expr_stmt|;
name|mac
operator|->
name|mac_phy
operator|.
name|set_antenna
operator|=
name|bwn_phy_g_set_antenna
expr_stmt|;
name|mac
operator|->
name|mac_phy
operator|.
name|set_im
operator|=
name|bwn_phy_g_im
expr_stmt|;
name|mac
operator|->
name|mac_phy
operator|.
name|recalc_txpwr
operator|=
name|bwn_phy_g_recalc_txpwr
expr_stmt|;
name|mac
operator|->
name|mac_phy
operator|.
name|set_txpwr
operator|=
name|bwn_phy_g_set_txpwr
expr_stmt|;
name|mac
operator|->
name|mac_phy
operator|.
name|task_15s
operator|=
name|bwn_phy_g_task_15s
expr_stmt|;
name|mac
operator|->
name|mac_phy
operator|.
name|task_60s
operator|=
name|bwn_phy_g_task_60s
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|type
operator|==
name|BWN_PHYTYPE_LP
condition|)
block|{
name|mac
operator|->
name|mac_phy
operator|.
name|init_pre
operator|=
name|bwn_phy_lp_init_pre
expr_stmt|;
name|mac
operator|->
name|mac_phy
operator|.
name|init
operator|=
name|bwn_phy_lp_init
expr_stmt|;
name|mac
operator|->
name|mac_phy
operator|.
name|phy_read
operator|=
name|bwn_phy_lp_read
expr_stmt|;
name|mac
operator|->
name|mac_phy
operator|.
name|phy_write
operator|=
name|bwn_phy_lp_write
expr_stmt|;
name|mac
operator|->
name|mac_phy
operator|.
name|phy_maskset
operator|=
name|bwn_phy_lp_maskset
expr_stmt|;
name|mac
operator|->
name|mac_phy
operator|.
name|rf_read
operator|=
name|bwn_phy_lp_rf_read
expr_stmt|;
name|mac
operator|->
name|mac_phy
operator|.
name|rf_write
operator|=
name|bwn_phy_lp_rf_write
expr_stmt|;
name|mac
operator|->
name|mac_phy
operator|.
name|rf_onoff
operator|=
name|bwn_phy_lp_rf_onoff
expr_stmt|;
name|mac
operator|->
name|mac_phy
operator|.
name|switch_analog
operator|=
name|bwn_phy_lp_switch_analog
expr_stmt|;
name|mac
operator|->
name|mac_phy
operator|.
name|switch_channel
operator|=
name|bwn_phy_lp_switch_channel
expr_stmt|;
name|mac
operator|->
name|mac_phy
operator|.
name|get_default_chan
operator|=
name|bwn_phy_lp_get_default_chan
expr_stmt|;
name|mac
operator|->
name|mac_phy
operator|.
name|set_antenna
operator|=
name|bwn_phy_lp_set_antenna
expr_stmt|;
name|mac
operator|->
name|mac_phy
operator|.
name|task_60s
operator|=
name|bwn_phy_lp_task_60s
expr_stmt|;
block|}
else|else
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"unsupported PHY type (%d)\n"
argument_list|,
name|mac
operator|->
name|mac_phy
operator|.
name|type
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENXIO
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|mac
operator|->
name|mac_phy
operator|.
name|gmode
operator|=
name|have_bg
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|attach
operator|!=
name|NULL
condition|)
block|{
name|error
operator|=
name|mac
operator|->
name|mac_phy
operator|.
name|attach
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
block|}
name|bwn_reset_core
argument_list|(
name|mac
argument_list|,
name|have_bg
argument_list|)
expr_stmt|;
name|error
operator|=
name|bwn_chiptest
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
name|error
operator|=
name|bwn_setup_channels
argument_list|(
name|mac
argument_list|,
name|have_bg
argument_list|,
name|have_a
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"failed to setup channels\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|sc
operator|->
name|sc_curmac
operator|==
name|NULL
condition|)
name|sc
operator|->
name|sc_curmac
operator|=
name|mac
expr_stmt|;
name|error
operator|=
name|bwn_dma_attach
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"failed to initialize DMA\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|mac
operator|->
name|mac_phy
operator|.
name|switch_analog
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|siba_dev_down
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fail
label|:
name|siba_powerdown
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Reset - SIBA.  *  * XXX TODO: implement BCMA version!  */
end_comment

begin_function
name|void
name|bwn_reset_core
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|int
name|g_mode
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|uint32_t
name|low
decl_stmt|,
name|ctl
decl_stmt|;
name|uint32_t
name|flags
init|=
literal|0
decl_stmt|;
name|DPRINTF
argument_list|(
name|sc
argument_list|,
name|BWN_DEBUG_RESET
argument_list|,
literal|"%s: g_mode=%d\n"
argument_list|,
name|__func__
argument_list|,
name|g_mode
argument_list|)
expr_stmt|;
name|flags
operator||=
operator|(
name|BWN_TGSLOW_PHYCLOCK_ENABLE
operator||
name|BWN_TGSLOW_PHYRESET
operator|)
expr_stmt|;
if|if
condition|(
name|g_mode
condition|)
name|flags
operator||=
name|BWN_TGSLOW_SUPPORT_G
expr_stmt|;
comment|/* XXX N-PHY only; and hard-code to 20MHz for now */
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|type
operator|==
name|BWN_PHYTYPE_N
condition|)
name|flags
operator||=
name|BWN_TGSLOW_PHY_BANDWIDTH_20MHZ
expr_stmt|;
name|siba_dev_up
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|2000
argument_list|)
expr_stmt|;
comment|/* Take PHY out of reset */
name|low
operator|=
operator|(
name|siba_read_4
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
name|SIBA_TGSLOW
argument_list|)
operator||
name|SIBA_TGSLOW_FGC
operator|)
operator|&
operator|~
name|BWN_TGSLOW_PHYRESET
expr_stmt|;
name|siba_write_4
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
name|SIBA_TGSLOW
argument_list|,
name|low
argument_list|)
expr_stmt|;
name|siba_read_4
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
name|SIBA_TGSLOW
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
name|siba_write_4
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
name|SIBA_TGSLOW
argument_list|,
name|low
operator|&
operator|~
name|SIBA_TGSLOW_FGC
argument_list|)
expr_stmt|;
name|siba_read_4
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
name|SIBA_TGSLOW
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|switch_analog
operator|!=
name|NULL
condition|)
name|mac
operator|->
name|mac_phy
operator|.
name|switch_analog
argument_list|(
name|mac
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ctl
operator|=
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCTL
argument_list|)
operator|&
operator|~
name|BWN_MACCTL_GMODE
expr_stmt|;
if|if
condition|(
name|g_mode
condition|)
name|ctl
operator||=
name|BWN_MACCTL_GMODE
expr_stmt|;
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCTL
argument_list|,
name|ctl
operator||
name|BWN_MACCTL_IHR_ON
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|bwn_phy_getinfo
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|int
name|tgshigh
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
comment|/* PHY */
name|tmp
operator|=
name|BWN_READ_2
argument_list|(
name|mac
argument_list|,
name|BWN_PHYVER
argument_list|)
expr_stmt|;
name|phy
operator|->
name|gmode
operator|=
operator|!
operator|!
operator|(
name|tgshigh
operator|&
name|BWN_TGSHIGH_HAVE_2GHZ
operator|)
expr_stmt|;
name|phy
operator|->
name|rf_on
operator|=
literal|1
expr_stmt|;
name|phy
operator|->
name|analog
operator|=
operator|(
name|tmp
operator|&
name|BWN_PHYVER_ANALOG
operator|)
operator|>>
literal|12
expr_stmt|;
name|phy
operator|->
name|type
operator|=
operator|(
name|tmp
operator|&
name|BWN_PHYVER_TYPE
operator|)
operator|>>
literal|8
expr_stmt|;
name|phy
operator|->
name|rev
operator|=
operator|(
name|tmp
operator|&
name|BWN_PHYVER_VERSION
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|phy
operator|->
name|type
operator|==
name|BWN_PHYTYPE_A
operator|&&
name|phy
operator|->
name|rev
operator|>=
literal|4
operator|)
operator|||
operator|(
name|phy
operator|->
name|type
operator|==
name|BWN_PHYTYPE_B
operator|&&
name|phy
operator|->
name|rev
operator|!=
literal|2
operator|&&
name|phy
operator|->
name|rev
operator|!=
literal|4
operator|&&
name|phy
operator|->
name|rev
operator|!=
literal|6
operator|&&
name|phy
operator|->
name|rev
operator|!=
literal|7
operator|)
operator|||
operator|(
name|phy
operator|->
name|type
operator|==
name|BWN_PHYTYPE_G
operator|&&
name|phy
operator|->
name|rev
operator|>
literal|9
operator|)
operator|||
operator|(
name|phy
operator|->
name|type
operator|==
name|BWN_PHYTYPE_N
operator|&&
name|phy
operator|->
name|rev
operator|>
literal|4
operator|)
operator|||
operator|(
name|phy
operator|->
name|type
operator|==
name|BWN_PHYTYPE_LP
operator|&&
name|phy
operator|->
name|rev
operator|>
literal|2
operator|)
condition|)
goto|goto
name|unsupphy
goto|;
comment|/* RADIO */
if|if
condition|(
name|siba_get_chipid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
literal|0x4317
condition|)
block|{
if|if
condition|(
name|siba_get_chiprev
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
literal|0
condition|)
name|tmp
operator|=
literal|0x3205017f
expr_stmt|;
elseif|else
if|if
condition|(
name|siba_get_chiprev
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
literal|1
condition|)
name|tmp
operator|=
literal|0x4205017f
expr_stmt|;
else|else
name|tmp
operator|=
literal|0x5205017f
expr_stmt|;
block|}
else|else
block|{
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
name|BWN_RFCTL
argument_list|,
name|BWN_RFCTL_ID
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|BWN_READ_2
argument_list|(
name|mac
argument_list|,
name|BWN_RFDATALO
argument_list|)
expr_stmt|;
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
name|BWN_RFCTL
argument_list|,
name|BWN_RFCTL_ID
argument_list|)
expr_stmt|;
name|tmp
operator||=
operator|(
name|uint32_t
operator|)
name|BWN_READ_2
argument_list|(
name|mac
argument_list|,
name|BWN_RFDATAHI
argument_list|)
operator|<<
literal|16
expr_stmt|;
block|}
name|phy
operator|->
name|rf_rev
operator|=
operator|(
name|tmp
operator|&
literal|0xf0000000
operator|)
operator|>>
literal|28
expr_stmt|;
name|phy
operator|->
name|rf_ver
operator|=
operator|(
name|tmp
operator|&
literal|0x0ffff000
operator|)
operator|>>
literal|12
expr_stmt|;
name|phy
operator|->
name|rf_manuf
operator|=
operator|(
name|tmp
operator|&
literal|0x00000fff
operator|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rf_manuf
operator|!=
literal|0x17f
condition|)
comment|/* 0x17f is broadcom */
goto|goto
name|unsupradio
goto|;
if|if
condition|(
operator|(
name|phy
operator|->
name|type
operator|==
name|BWN_PHYTYPE_A
operator|&&
operator|(
name|phy
operator|->
name|rf_ver
operator|!=
literal|0x2060
operator|||
name|phy
operator|->
name|rf_rev
operator|!=
literal|1
operator|||
name|phy
operator|->
name|rf_manuf
operator|!=
literal|0x17f
operator|)
operator|)
operator|||
operator|(
name|phy
operator|->
name|type
operator|==
name|BWN_PHYTYPE_B
operator|&&
operator|(
name|phy
operator|->
name|rf_ver
operator|&
literal|0xfff0
operator|)
operator|!=
literal|0x2050
operator|)
operator|||
operator|(
name|phy
operator|->
name|type
operator|==
name|BWN_PHYTYPE_G
operator|&&
name|phy
operator|->
name|rf_ver
operator|!=
literal|0x2050
operator|)
operator|||
operator|(
name|phy
operator|->
name|type
operator|==
name|BWN_PHYTYPE_N
operator|&&
name|phy
operator|->
name|rf_ver
operator|!=
literal|0x2055
operator|&&
name|phy
operator|->
name|rf_ver
operator|!=
literal|0x2056
operator|)
operator|||
operator|(
name|phy
operator|->
name|type
operator|==
name|BWN_PHYTYPE_LP
operator|&&
name|phy
operator|->
name|rf_ver
operator|!=
literal|0x2062
operator|&&
name|phy
operator|->
name|rf_ver
operator|!=
literal|0x2063
operator|)
condition|)
goto|goto
name|unsupradio
goto|;
return|return
operator|(
literal|0
operator|)
return|;
name|unsupphy
label|:
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"unsupported PHY (type %#x, rev %#x, "
literal|"analog %#x)\n"
argument_list|,
name|phy
operator|->
name|type
argument_list|,
name|phy
operator|->
name|rev
argument_list|,
name|phy
operator|->
name|analog
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
name|unsupradio
label|:
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"unsupported radio (manuf %#x, ver %#x, "
literal|"rev %#x)\n"
argument_list|,
name|phy
operator|->
name|rf_manuf
argument_list|,
name|phy
operator|->
name|rf_ver
argument_list|,
name|phy
operator|->
name|rf_rev
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bwn_chiptest
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
define|#
directive|define
name|TESTVAL0
value|0x55aaaa55
define|#
directive|define
name|TESTVAL1
value|0xaa5555aa
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|uint32_t
name|v
decl_stmt|,
name|backup
decl_stmt|;
name|BWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|backup
operator|=
name|bwn_shm_read_4
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bwn_shm_write_4
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
literal|0
argument_list|,
name|TESTVAL0
argument_list|)
expr_stmt|;
if|if
condition|(
name|bwn_shm_read_4
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
literal|0
argument_list|)
operator|!=
name|TESTVAL0
condition|)
goto|goto
name|error
goto|;
name|bwn_shm_write_4
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
literal|0
argument_list|,
name|TESTVAL1
argument_list|)
expr_stmt|;
if|if
condition|(
name|bwn_shm_read_4
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
literal|0
argument_list|)
operator|!=
name|TESTVAL1
condition|)
goto|goto
name|error
goto|;
name|bwn_shm_write_4
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
literal|0
argument_list|,
name|backup
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|siba_get_revid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|>=
literal|3
operator|)
operator|&&
operator|(
name|siba_get_revid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|<=
literal|10
operator|)
condition|)
block|{
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
name|BWN_TSF_CFP_START
argument_list|,
literal|0xaaaa
argument_list|)
expr_stmt|;
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
name|BWN_TSF_CFP_START
argument_list|,
literal|0xccccbbbb
argument_list|)
expr_stmt|;
if|if
condition|(
name|BWN_READ_2
argument_list|(
name|mac
argument_list|,
name|BWN_TSF_CFP_START_LOW
argument_list|)
operator|!=
literal|0xbbbb
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
name|BWN_READ_2
argument_list|(
name|mac
argument_list|,
name|BWN_TSF_CFP_START_HIGH
argument_list|)
operator|!=
literal|0xcccc
condition|)
goto|goto
name|error
goto|;
block|}
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
name|BWN_TSF_CFP_START
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|v
operator|=
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCTL
argument_list|)
operator||
name|BWN_MACCTL_GMODE
expr_stmt|;
if|if
condition|(
name|v
operator|!=
operator|(
name|BWN_MACCTL_GMODE
operator||
name|BWN_MACCTL_IHR_ON
operator|)
condition|)
goto|goto
name|error
goto|;
name|BWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|error
label|:
name|BWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"failed to validate the chipaccess\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENODEV
operator|)
return|;
block|}
end_function

begin_define
define|#
directive|define
name|IEEE80211_CHAN_HTG
value|(IEEE80211_CHAN_HT | IEEE80211_CHAN_G)
end_define

begin_define
define|#
directive|define
name|IEEE80211_CHAN_HTA
value|(IEEE80211_CHAN_HT | IEEE80211_CHAN_A)
end_define

begin_function
specifier|static
name|int
name|bwn_setup_channels
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|int
name|have_bg
parameter_list|,
name|int
name|have_a
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
name|memset
argument_list|(
name|ic
operator|->
name|ic_channels
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ic
operator|->
name|ic_channels
argument_list|)
argument_list|)
expr_stmt|;
name|ic
operator|->
name|ic_nchans
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|have_bg
condition|)
name|bwn_addchannels
argument_list|(
name|ic
operator|->
name|ic_channels
argument_list|,
name|IEEE80211_CHAN_MAX
argument_list|,
operator|&
name|ic
operator|->
name|ic_nchans
argument_list|,
operator|&
name|bwn_chantable_bg
argument_list|,
name|IEEE80211_CHAN_G
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|type
operator|==
name|BWN_PHYTYPE_N
condition|)
block|{
if|if
condition|(
name|have_a
condition|)
name|bwn_addchannels
argument_list|(
name|ic
operator|->
name|ic_channels
argument_list|,
name|IEEE80211_CHAN_MAX
argument_list|,
operator|&
name|ic
operator|->
name|ic_nchans
argument_list|,
operator|&
name|bwn_chantable_n
argument_list|,
name|IEEE80211_CHAN_HTA
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|have_a
condition|)
name|bwn_addchannels
argument_list|(
name|ic
operator|->
name|ic_channels
argument_list|,
name|IEEE80211_CHAN_MAX
argument_list|,
operator|&
name|ic
operator|->
name|ic_nchans
argument_list|,
operator|&
name|bwn_chantable_a
argument_list|,
name|IEEE80211_CHAN_A
argument_list|)
expr_stmt|;
block|}
name|mac
operator|->
name|mac_phy
operator|.
name|supports_2ghz
operator|=
name|have_bg
expr_stmt|;
name|mac
operator|->
name|mac_phy
operator|.
name|supports_5ghz
operator|=
name|have_a
expr_stmt|;
return|return
operator|(
name|ic
operator|->
name|ic_nchans
operator|==
literal|0
condition|?
name|ENXIO
else|:
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|uint32_t
name|bwn_shm_read_4
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint16_t
name|way
parameter_list|,
name|uint16_t
name|offset
parameter_list|)
block|{
name|uint32_t
name|ret
decl_stmt|;
name|BWN_ASSERT_LOCKED
argument_list|(
name|mac
operator|->
name|mac_sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|way
operator|==
name|BWN_SHARED
condition|)
block|{
name|KASSERT
argument_list|(
operator|(
name|offset
operator|&
literal|0x0001
operator|)
operator|==
literal|0
argument_list|,
operator|(
literal|"%s:%d warn"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|offset
operator|&
literal|0x0003
condition|)
block|{
name|bwn_shm_ctlword
argument_list|(
name|mac
argument_list|,
name|way
argument_list|,
name|offset
operator|>>
literal|2
argument_list|)
expr_stmt|;
name|ret
operator|=
name|BWN_READ_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHM_DATA_UNALIGNED
argument_list|)
expr_stmt|;
name|ret
operator|<<=
literal|16
expr_stmt|;
name|bwn_shm_ctlword
argument_list|(
name|mac
argument_list|,
name|way
argument_list|,
operator|(
name|offset
operator|>>
literal|2
operator|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|ret
operator||=
name|BWN_READ_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHM_DATA
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|offset
operator|>>=
literal|2
expr_stmt|;
block|}
name|bwn_shm_ctlword
argument_list|(
name|mac
argument_list|,
name|way
argument_list|,
name|offset
argument_list|)
expr_stmt|;
name|ret
operator|=
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|BWN_SHM_DATA
argument_list|)
expr_stmt|;
name|out
label|:
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
name|uint16_t
name|bwn_shm_read_2
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint16_t
name|way
parameter_list|,
name|uint16_t
name|offset
parameter_list|)
block|{
name|uint16_t
name|ret
decl_stmt|;
name|BWN_ASSERT_LOCKED
argument_list|(
name|mac
operator|->
name|mac_sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|way
operator|==
name|BWN_SHARED
condition|)
block|{
name|KASSERT
argument_list|(
operator|(
name|offset
operator|&
literal|0x0001
operator|)
operator|==
literal|0
argument_list|,
operator|(
literal|"%s:%d warn"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|offset
operator|&
literal|0x0003
condition|)
block|{
name|bwn_shm_ctlword
argument_list|(
name|mac
argument_list|,
name|way
argument_list|,
name|offset
operator|>>
literal|2
argument_list|)
expr_stmt|;
name|ret
operator|=
name|BWN_READ_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHM_DATA_UNALIGNED
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|offset
operator|>>=
literal|2
expr_stmt|;
block|}
name|bwn_shm_ctlword
argument_list|(
name|mac
argument_list|,
name|way
argument_list|,
name|offset
argument_list|)
expr_stmt|;
name|ret
operator|=
name|BWN_READ_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHM_DATA
argument_list|)
expr_stmt|;
name|out
label|:
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_shm_ctlword
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint16_t
name|way
parameter_list|,
name|uint16_t
name|offset
parameter_list|)
block|{
name|uint32_t
name|control
decl_stmt|;
name|control
operator|=
name|way
expr_stmt|;
name|control
operator|<<=
literal|16
expr_stmt|;
name|control
operator||=
name|offset
expr_stmt|;
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
name|BWN_SHM_CONTROL
argument_list|,
name|control
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|bwn_shm_write_4
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint16_t
name|way
parameter_list|,
name|uint16_t
name|offset
parameter_list|,
name|uint32_t
name|value
parameter_list|)
block|{
name|BWN_ASSERT_LOCKED
argument_list|(
name|mac
operator|->
name|mac_sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|way
operator|==
name|BWN_SHARED
condition|)
block|{
name|KASSERT
argument_list|(
operator|(
name|offset
operator|&
literal|0x0001
operator|)
operator|==
literal|0
argument_list|,
operator|(
literal|"%s:%d warn"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|offset
operator|&
literal|0x0003
condition|)
block|{
name|bwn_shm_ctlword
argument_list|(
name|mac
argument_list|,
name|way
argument_list|,
name|offset
operator|>>
literal|2
argument_list|)
expr_stmt|;
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHM_DATA_UNALIGNED
argument_list|,
operator|(
name|value
operator|>>
literal|16
operator|)
operator|&
literal|0xffff
argument_list|)
expr_stmt|;
name|bwn_shm_ctlword
argument_list|(
name|mac
argument_list|,
name|way
argument_list|,
operator|(
name|offset
operator|>>
literal|2
operator|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHM_DATA
argument_list|,
name|value
operator|&
literal|0xffff
argument_list|)
expr_stmt|;
return|return;
block|}
name|offset
operator|>>=
literal|2
expr_stmt|;
block|}
name|bwn_shm_ctlword
argument_list|(
name|mac
argument_list|,
name|way
argument_list|,
name|offset
argument_list|)
expr_stmt|;
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
name|BWN_SHM_DATA
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|bwn_shm_write_2
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint16_t
name|way
parameter_list|,
name|uint16_t
name|offset
parameter_list|,
name|uint16_t
name|value
parameter_list|)
block|{
name|BWN_ASSERT_LOCKED
argument_list|(
name|mac
operator|->
name|mac_sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|way
operator|==
name|BWN_SHARED
condition|)
block|{
name|KASSERT
argument_list|(
operator|(
name|offset
operator|&
literal|0x0001
operator|)
operator|==
literal|0
argument_list|,
operator|(
literal|"%s:%d warn"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|offset
operator|&
literal|0x0003
condition|)
block|{
name|bwn_shm_ctlword
argument_list|(
name|mac
argument_list|,
name|way
argument_list|,
name|offset
operator|>>
literal|2
argument_list|)
expr_stmt|;
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHM_DATA_UNALIGNED
argument_list|,
name|value
argument_list|)
expr_stmt|;
return|return;
block|}
name|offset
operator|>>=
literal|2
expr_stmt|;
block|}
name|bwn_shm_ctlword
argument_list|(
name|mac
argument_list|,
name|way
argument_list|,
name|offset
argument_list|)
expr_stmt|;
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHM_DATA
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_addchan
parameter_list|(
name|struct
name|ieee80211_channel
modifier|*
name|c
parameter_list|,
name|int
name|freq
parameter_list|,
name|int
name|flags
parameter_list|,
name|int
name|ieee
parameter_list|,
name|int
name|txpow
parameter_list|)
block|{
name|c
operator|->
name|ic_freq
operator|=
name|freq
expr_stmt|;
name|c
operator|->
name|ic_flags
operator|=
name|flags
expr_stmt|;
name|c
operator|->
name|ic_ieee
operator|=
name|ieee
expr_stmt|;
name|c
operator|->
name|ic_minpower
operator|=
literal|0
expr_stmt|;
name|c
operator|->
name|ic_maxpower
operator|=
literal|2
operator|*
name|txpow
expr_stmt|;
name|c
operator|->
name|ic_maxregpower
operator|=
name|txpow
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_addchannels
parameter_list|(
name|struct
name|ieee80211_channel
name|chans
index|[]
parameter_list|,
name|int
name|maxchans
parameter_list|,
name|int
modifier|*
name|nchans
parameter_list|,
specifier|const
name|struct
name|bwn_channelinfo
modifier|*
name|ci
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
name|struct
name|ieee80211_channel
modifier|*
name|c
decl_stmt|;
name|int
name|i
decl_stmt|;
name|c
operator|=
operator|&
name|chans
index|[
operator|*
name|nchans
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ci
operator|->
name|nchannels
condition|;
name|i
operator|++
control|)
block|{
specifier|const
name|struct
name|bwn_channel
modifier|*
name|hc
decl_stmt|;
name|hc
operator|=
operator|&
name|ci
operator|->
name|channels
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
operator|*
name|nchans
operator|>=
name|maxchans
condition|)
break|break;
name|bwn_addchan
argument_list|(
name|c
argument_list|,
name|hc
operator|->
name|freq
argument_list|,
name|flags
argument_list|,
name|hc
operator|->
name|ieee
argument_list|,
name|hc
operator|->
name|maxTxPow
argument_list|)
expr_stmt|;
name|c
operator|++
operator|,
operator|(
operator|*
name|nchans
operator|)
operator|++
expr_stmt|;
if|if
condition|(
name|flags
operator|==
name|IEEE80211_CHAN_G
operator|||
name|flags
operator|==
name|IEEE80211_CHAN_HTG
condition|)
block|{
comment|/* g channel have a separate b-only entry */
if|if
condition|(
operator|*
name|nchans
operator|>=
name|maxchans
condition|)
break|break;
name|c
index|[
literal|0
index|]
operator|=
name|c
index|[
operator|-
literal|1
index|]
expr_stmt|;
name|c
index|[
operator|-
literal|1
index|]
operator|.
name|ic_flags
operator|=
name|IEEE80211_CHAN_B
expr_stmt|;
name|c
operator|++
operator|,
operator|(
operator|*
name|nchans
operator|)
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|flags
operator|==
name|IEEE80211_CHAN_HTG
condition|)
block|{
comment|/* HT g channel have a separate g-only entry */
if|if
condition|(
operator|*
name|nchans
operator|>=
name|maxchans
condition|)
break|break;
name|c
index|[
operator|-
literal|1
index|]
operator|.
name|ic_flags
operator|=
name|IEEE80211_CHAN_G
expr_stmt|;
name|c
index|[
literal|0
index|]
operator|=
name|c
index|[
operator|-
literal|1
index|]
expr_stmt|;
name|c
index|[
literal|0
index|]
operator|.
name|ic_flags
operator|&=
operator|~
name|IEEE80211_CHAN_HT
expr_stmt|;
name|c
index|[
literal|0
index|]
operator|.
name|ic_flags
operator||=
name|IEEE80211_CHAN_HT20
expr_stmt|;
comment|/* HT20 */
name|c
operator|++
operator|,
operator|(
operator|*
name|nchans
operator|)
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|flags
operator|==
name|IEEE80211_CHAN_HTA
condition|)
block|{
comment|/* HT a channel have a separate a-only entry */
if|if
condition|(
operator|*
name|nchans
operator|>=
name|maxchans
condition|)
break|break;
name|c
index|[
operator|-
literal|1
index|]
operator|.
name|ic_flags
operator|=
name|IEEE80211_CHAN_A
expr_stmt|;
name|c
index|[
literal|0
index|]
operator|=
name|c
index|[
operator|-
literal|1
index|]
expr_stmt|;
name|c
index|[
literal|0
index|]
operator|.
name|ic_flags
operator|&=
operator|~
name|IEEE80211_CHAN_HT
expr_stmt|;
name|c
index|[
literal|0
index|]
operator|.
name|ic_flags
operator||=
name|IEEE80211_CHAN_HT20
expr_stmt|;
comment|/* HT20 */
name|c
operator|++
operator|,
operator|(
operator|*
name|nchans
operator|)
operator|++
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|bwn_raw_xmit
parameter_list|(
name|struct
name|ieee80211_node
modifier|*
name|ni
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
specifier|const
name|struct
name|ieee80211_bpf_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|ni
operator|->
name|ni_ic
decl_stmt|;
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_softc
decl_stmt|;
name|struct
name|bwn_mac
modifier|*
name|mac
init|=
name|sc
operator|->
name|sc_curmac
decl_stmt|;
name|int
name|error
decl_stmt|;
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|BWN_FLAG_RUNNING
operator|)
operator|==
literal|0
operator|||
name|mac
operator|->
name|mac_status
operator|<
name|BWN_MAC_STATUS_STARTED
condition|)
block|{
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENETDOWN
operator|)
return|;
block|}
name|BWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|bwn_tx_isfull
argument_list|(
name|sc
argument_list|,
name|m
argument_list|)
condition|)
block|{
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|BWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOBUFS
operator|)
return|;
block|}
name|error
operator|=
name|bwn_tx_start
argument_list|(
name|sc
argument_list|,
name|ni
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|sc
operator|->
name|sc_watchdog_timer
operator|=
literal|5
expr_stmt|;
name|BWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Callback from the 802.11 layer to update the slot time  * based on the current setting.  We use it to notify the  * firmware of ERP changes and the f/w takes care of things  * like slot time and preamble.  */
end_comment

begin_function
specifier|static
name|void
name|bwn_updateslot
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_softc
decl_stmt|;
name|struct
name|bwn_mac
modifier|*
name|mac
decl_stmt|;
name|BWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_flags
operator|&
name|BWN_FLAG_RUNNING
condition|)
block|{
name|mac
operator|=
operator|(
expr|struct
name|bwn_mac
operator|*
operator|)
name|sc
operator|->
name|sc_curmac
expr_stmt|;
name|bwn_set_slot_time
argument_list|(
name|mac
argument_list|,
name|IEEE80211_GET_SLOTTIME
argument_list|(
name|ic
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|BWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Callback from the 802.11 layer after a promiscuous mode change.  * Note this interface does not check the operating mode as this  * is an internal callback and we are expected to honor the current  * state (e.g. this is used for setting the interface in promiscuous  * mode when operating in hostap mode to do ACS).  */
end_comment

begin_function
specifier|static
name|void
name|bwn_update_promisc
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_softc
decl_stmt|;
name|struct
name|bwn_mac
modifier|*
name|mac
init|=
name|sc
operator|->
name|sc_curmac
decl_stmt|;
name|BWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|mac
operator|=
name|sc
operator|->
name|sc_curmac
expr_stmt|;
if|if
condition|(
name|mac
operator|!=
name|NULL
operator|&&
name|mac
operator|->
name|mac_status
operator|>=
name|BWN_MAC_STATUS_INITED
condition|)
block|{
if|if
condition|(
name|ic
operator|->
name|ic_promisc
operator|>
literal|0
condition|)
name|sc
operator|->
name|sc_filters
operator||=
name|BWN_MACCTL_PROMISC
expr_stmt|;
else|else
name|sc
operator|->
name|sc_filters
operator|&=
operator|~
name|BWN_MACCTL_PROMISC
expr_stmt|;
name|bwn_set_opmode
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
name|BWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Callback from the 802.11 layer to update WME parameters.  */
end_comment

begin_function
specifier|static
name|int
name|bwn_wme_update
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_softc
decl_stmt|;
name|struct
name|bwn_mac
modifier|*
name|mac
init|=
name|sc
operator|->
name|sc_curmac
decl_stmt|;
name|struct
name|wmeParams
modifier|*
name|wmep
decl_stmt|;
name|int
name|i
decl_stmt|;
name|BWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|mac
operator|=
name|sc
operator|->
name|sc_curmac
expr_stmt|;
if|if
condition|(
name|mac
operator|!=
name|NULL
operator|&&
name|mac
operator|->
name|mac_status
operator|>=
name|BWN_MAC_STATUS_INITED
condition|)
block|{
name|bwn_mac_suspend
argument_list|(
name|mac
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|N
argument_list|(
name|sc
operator|->
name|sc_wmeParams
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|wmep
operator|=
operator|&
name|ic
operator|->
name|ic_wme
operator|.
name|wme_chanParams
operator|.
name|cap_wmeParams
index|[
name|i
index|]
expr_stmt|;
name|bwn_wme_loadparams
argument_list|(
name|mac
argument_list|,
name|wmep
argument_list|,
name|bwn_wme_shm_offsets
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|bwn_mac_enable
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
name|BWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_scan_start
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_softc
decl_stmt|;
name|struct
name|bwn_mac
modifier|*
name|mac
decl_stmt|;
name|BWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|mac
operator|=
name|sc
operator|->
name|sc_curmac
expr_stmt|;
if|if
condition|(
name|mac
operator|!=
name|NULL
operator|&&
name|mac
operator|->
name|mac_status
operator|>=
name|BWN_MAC_STATUS_INITED
condition|)
block|{
name|sc
operator|->
name|sc_filters
operator||=
name|BWN_MACCTL_BEACON_PROMISC
expr_stmt|;
name|bwn_set_opmode
argument_list|(
name|mac
argument_list|)
expr_stmt|;
comment|/* disable CFP update during scan */
name|bwn_hf_write
argument_list|(
name|mac
argument_list|,
name|bwn_hf_read
argument_list|(
name|mac
argument_list|)
operator||
name|BWN_HF_SKIP_CFP_UPDATE
argument_list|)
expr_stmt|;
block|}
name|BWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_scan_end
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_softc
decl_stmt|;
name|struct
name|bwn_mac
modifier|*
name|mac
decl_stmt|;
name|BWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|mac
operator|=
name|sc
operator|->
name|sc_curmac
expr_stmt|;
if|if
condition|(
name|mac
operator|!=
name|NULL
operator|&&
name|mac
operator|->
name|mac_status
operator|>=
name|BWN_MAC_STATUS_INITED
condition|)
block|{
name|sc
operator|->
name|sc_filters
operator|&=
operator|~
name|BWN_MACCTL_BEACON_PROMISC
expr_stmt|;
name|bwn_set_opmode
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|bwn_hf_write
argument_list|(
name|mac
argument_list|,
name|bwn_hf_read
argument_list|(
name|mac
argument_list|)
operator|&
operator|~
name|BWN_HF_SKIP_CFP_UPDATE
argument_list|)
expr_stmt|;
block|}
name|BWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_set_channel
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_softc
decl_stmt|;
name|struct
name|bwn_mac
modifier|*
name|mac
init|=
name|sc
operator|->
name|sc_curmac
decl_stmt|;
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|int
name|chan
decl_stmt|,
name|error
decl_stmt|;
name|BWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|error
operator|=
name|bwn_switch_band
argument_list|(
name|sc
argument_list|,
name|ic
operator|->
name|ic_curchan
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
name|bwn_mac_suspend
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|bwn_set_txretry
argument_list|(
name|mac
argument_list|,
name|BWN_RETRY_SHORT
argument_list|,
name|BWN_RETRY_LONG
argument_list|)
expr_stmt|;
name|chan
operator|=
name|ieee80211_chan2ieee
argument_list|(
name|ic
argument_list|,
name|ic
operator|->
name|ic_curchan
argument_list|)
expr_stmt|;
if|if
condition|(
name|chan
operator|!=
name|phy
operator|->
name|chan
condition|)
name|bwn_switch_channel
argument_list|(
name|mac
argument_list|,
name|chan
argument_list|)
expr_stmt|;
comment|/* TX power level */
if|if
condition|(
name|ic
operator|->
name|ic_curchan
operator|->
name|ic_maxpower
operator|!=
literal|0
operator|&&
name|ic
operator|->
name|ic_curchan
operator|->
name|ic_maxpower
operator|!=
name|phy
operator|->
name|txpower
condition|)
block|{
name|phy
operator|->
name|txpower
operator|=
name|ic
operator|->
name|ic_curchan
operator|->
name|ic_maxpower
operator|/
literal|2
expr_stmt|;
name|bwn_phy_txpower_check
argument_list|(
name|mac
argument_list|,
name|BWN_TXPWR_IGNORE_TIME
operator||
name|BWN_TXPWR_IGNORE_TSSI
argument_list|)
expr_stmt|;
block|}
name|bwn_set_txantenna
argument_list|(
name|mac
argument_list|,
name|BWN_ANT_DEFAULT
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|set_antenna
condition|)
name|phy
operator|->
name|set_antenna
argument_list|(
name|mac
argument_list|,
name|BWN_ANT_DEFAULT
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_rf_enabled
operator|!=
name|phy
operator|->
name|rf_on
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|sc_rf_enabled
condition|)
block|{
name|bwn_rf_turnon
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|mac
operator|->
name|mac_flags
operator|&
name|BWN_MAC_FLAG_RADIO_ON
operator|)
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"please turn on the RF switch\n"
argument_list|)
expr_stmt|;
block|}
else|else
name|bwn_rf_turnoff
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
name|bwn_mac_enable
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|fail
label|:
comment|/* 	 * Setup radio tap channel freq and flags 	 */
name|sc
operator|->
name|sc_tx_th
operator|.
name|wt_chan_freq
operator|=
name|sc
operator|->
name|sc_rx_th
operator|.
name|wr_chan_freq
operator|=
name|htole16
argument_list|(
name|ic
operator|->
name|ic_curchan
operator|->
name|ic_freq
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_tx_th
operator|.
name|wt_chan_flags
operator|=
name|sc
operator|->
name|sc_rx_th
operator|.
name|wr_chan_flags
operator|=
name|htole16
argument_list|(
name|ic
operator|->
name|ic_curchan
operator|->
name|ic_flags
operator|&
literal|0xffff
argument_list|)
expr_stmt|;
name|BWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|ieee80211vap
modifier|*
name|bwn_vap_create
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|,
specifier|const
name|char
name|name
index|[
name|IFNAMSIZ
index|]
parameter_list|,
name|int
name|unit
parameter_list|,
name|enum
name|ieee80211_opmode
name|opmode
parameter_list|,
name|int
name|flags
parameter_list|,
specifier|const
name|uint8_t
name|bssid
index|[
name|IEEE80211_ADDR_LEN
index|]
parameter_list|,
specifier|const
name|uint8_t
name|mac
index|[
name|IEEE80211_ADDR_LEN
index|]
parameter_list|)
block|{
name|struct
name|ieee80211vap
modifier|*
name|vap
decl_stmt|;
name|struct
name|bwn_vap
modifier|*
name|bvp
decl_stmt|;
switch|switch
condition|(
name|opmode
condition|)
block|{
case|case
name|IEEE80211_M_HOSTAP
case|:
case|case
name|IEEE80211_M_MBSS
case|:
case|case
name|IEEE80211_M_STA
case|:
case|case
name|IEEE80211_M_WDS
case|:
case|case
name|IEEE80211_M_MONITOR
case|:
case|case
name|IEEE80211_M_IBSS
case|:
case|case
name|IEEE80211_M_AHDEMO
case|:
break|break;
default|default:
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|bvp
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|bwn_vap
argument_list|)
argument_list|,
name|M_80211_VAP
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|vap
operator|=
operator|&
name|bvp
operator|->
name|bv_vap
expr_stmt|;
name|ieee80211_vap_setup
argument_list|(
name|ic
argument_list|,
name|vap
argument_list|,
name|name
argument_list|,
name|unit
argument_list|,
name|opmode
argument_list|,
name|flags
argument_list|,
name|bssid
argument_list|)
expr_stmt|;
comment|/* override with driver methods */
name|bvp
operator|->
name|bv_newstate
operator|=
name|vap
operator|->
name|iv_newstate
expr_stmt|;
name|vap
operator|->
name|iv_newstate
operator|=
name|bwn_newstate
expr_stmt|;
comment|/* override max aid so sta's cannot assoc when we're out of sta id's */
name|vap
operator|->
name|iv_max_aid
operator|=
name|BWN_STAID_MAX
expr_stmt|;
name|ieee80211_ratectl_init
argument_list|(
name|vap
argument_list|)
expr_stmt|;
comment|/* complete setup */
name|ieee80211_vap_attach
argument_list|(
name|vap
argument_list|,
name|ieee80211_media_change
argument_list|,
name|ieee80211_media_status
argument_list|,
name|mac
argument_list|)
expr_stmt|;
return|return
operator|(
name|vap
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_vap_delete
parameter_list|(
name|struct
name|ieee80211vap
modifier|*
name|vap
parameter_list|)
block|{
name|struct
name|bwn_vap
modifier|*
name|bvp
init|=
name|BWN_VAP
argument_list|(
name|vap
argument_list|)
decl_stmt|;
name|ieee80211_ratectl_deinit
argument_list|(
name|vap
argument_list|)
expr_stmt|;
name|ieee80211_vap_detach
argument_list|(
name|vap
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|bvp
argument_list|,
name|M_80211_VAP
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|bwn_init
parameter_list|(
name|struct
name|bwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|bwn_mac
modifier|*
name|mac
decl_stmt|;
name|int
name|error
decl_stmt|;
name|BWN_ASSERT_LOCKED
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|sc
operator|->
name|sc_bssid
argument_list|,
name|IEEE80211_ADDR_LEN
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_flags
operator||=
name|BWN_FLAG_NEED_BEACON_TP
expr_stmt|;
name|sc
operator|->
name|sc_filters
operator|=
literal|0
expr_stmt|;
name|bwn_wme_clear
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_beacons
index|[
literal|0
index|]
operator|=
name|sc
operator|->
name|sc_beacons
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_rf_enabled
operator|=
literal|1
expr_stmt|;
name|mac
operator|=
name|sc
operator|->
name|sc_curmac
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_status
operator|==
name|BWN_MAC_STATUS_UNINIT
condition|)
block|{
name|error
operator|=
name|bwn_core_init
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
block|}
if|if
condition|(
name|mac
operator|->
name|mac_status
operator|==
name|BWN_MAC_STATUS_INITED
condition|)
name|bwn_core_start
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|bwn_set_opmode
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|bwn_set_pretbtt
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|bwn_spu_setdelay
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bwn_set_macaddr
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_flags
operator||=
name|BWN_FLAG_RUNNING
expr_stmt|;
name|callout_reset
argument_list|(
operator|&
name|sc
operator|->
name|sc_rfswitch_ch
argument_list|,
name|hz
argument_list|,
name|bwn_rfswitch
argument_list|,
name|sc
argument_list|)
expr_stmt|;
name|callout_reset
argument_list|(
operator|&
name|sc
operator|->
name|sc_watchdog_ch
argument_list|,
name|hz
argument_list|,
name|bwn_watchdog
argument_list|,
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_stop
parameter_list|(
name|struct
name|bwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|bwn_mac
modifier|*
name|mac
init|=
name|sc
operator|->
name|sc_curmac
decl_stmt|;
name|BWN_ASSERT_LOCKED
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_status
operator|>=
name|BWN_MAC_STATUS_INITED
condition|)
block|{
comment|/* XXX FIXME opmode not based on VAP */
name|bwn_set_opmode
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|bwn_set_macaddr
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mac
operator|->
name|mac_status
operator|>=
name|BWN_MAC_STATUS_STARTED
condition|)
name|bwn_core_stop
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|callout_stop
argument_list|(
operator|&
name|sc
operator|->
name|sc_led_blink_ch
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_led_blinking
operator|=
literal|0
expr_stmt|;
name|bwn_core_exit
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_rf_enabled
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_flags
operator|&=
operator|~
name|BWN_FLAG_RUNNING
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_wme_clear
parameter_list|(
name|struct
name|bwn_softc
modifier|*
name|sc
parameter_list|)
block|{
define|#
directive|define
name|MS
parameter_list|(
name|_v
parameter_list|,
name|_f
parameter_list|)
value|(((_v)& _f)>> _f##_S)
name|struct
name|wmeParams
modifier|*
name|p
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
name|KASSERT
argument_list|(
name|N
argument_list|(
name|bwn_wme_shm_offsets
argument_list|)
operator|==
name|N
argument_list|(
name|sc
operator|->
name|sc_wmeParams
argument_list|)
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|N
argument_list|(
name|sc
operator|->
name|sc_wmeParams
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|p
operator|=
operator|&
operator|(
name|sc
operator|->
name|sc_wmeParams
index|[
name|i
index|]
operator|)
expr_stmt|;
switch|switch
condition|(
name|bwn_wme_shm_offsets
index|[
name|i
index|]
condition|)
block|{
case|case
name|BWN_WME_VOICE
case|:
name|p
operator|->
name|wmep_txopLimit
operator|=
literal|0
expr_stmt|;
name|p
operator|->
name|wmep_aifsn
operator|=
literal|2
expr_stmt|;
comment|/* XXX FIXME: log2(cwmin) */
name|p
operator|->
name|wmep_logcwmin
operator|=
name|MS
argument_list|(
literal|0x0001
argument_list|,
name|WME_PARAM_LOGCWMIN
argument_list|)
expr_stmt|;
name|p
operator|->
name|wmep_logcwmax
operator|=
name|MS
argument_list|(
literal|0x0001
argument_list|,
name|WME_PARAM_LOGCWMAX
argument_list|)
expr_stmt|;
break|break;
case|case
name|BWN_WME_VIDEO
case|:
name|p
operator|->
name|wmep_txopLimit
operator|=
literal|0
expr_stmt|;
name|p
operator|->
name|wmep_aifsn
operator|=
literal|2
expr_stmt|;
comment|/* XXX FIXME: log2(cwmin) */
name|p
operator|->
name|wmep_logcwmin
operator|=
name|MS
argument_list|(
literal|0x0001
argument_list|,
name|WME_PARAM_LOGCWMIN
argument_list|)
expr_stmt|;
name|p
operator|->
name|wmep_logcwmax
operator|=
name|MS
argument_list|(
literal|0x0001
argument_list|,
name|WME_PARAM_LOGCWMAX
argument_list|)
expr_stmt|;
break|break;
case|case
name|BWN_WME_BESTEFFORT
case|:
name|p
operator|->
name|wmep_txopLimit
operator|=
literal|0
expr_stmt|;
name|p
operator|->
name|wmep_aifsn
operator|=
literal|3
expr_stmt|;
comment|/* XXX FIXME: log2(cwmin) */
name|p
operator|->
name|wmep_logcwmin
operator|=
name|MS
argument_list|(
literal|0x0001
argument_list|,
name|WME_PARAM_LOGCWMIN
argument_list|)
expr_stmt|;
name|p
operator|->
name|wmep_logcwmax
operator|=
name|MS
argument_list|(
literal|0x03ff
argument_list|,
name|WME_PARAM_LOGCWMAX
argument_list|)
expr_stmt|;
break|break;
case|case
name|BWN_WME_BACKGROUND
case|:
name|p
operator|->
name|wmep_txopLimit
operator|=
literal|0
expr_stmt|;
name|p
operator|->
name|wmep_aifsn
operator|=
literal|7
expr_stmt|;
comment|/* XXX FIXME: log2(cwmin) */
name|p
operator|->
name|wmep_logcwmin
operator|=
name|MS
argument_list|(
literal|0x0001
argument_list|,
name|WME_PARAM_LOGCWMIN
argument_list|)
expr_stmt|;
name|p
operator|->
name|wmep_logcwmax
operator|=
name|MS
argument_list|(
literal|0x03ff
argument_list|,
name|WME_PARAM_LOGCWMAX
argument_list|)
expr_stmt|;
break|break;
default|default:
name|KASSERT
argument_list|(
literal|0
operator|==
literal|1
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|bwn_core_init
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|uint64_t
name|hf
decl_stmt|;
name|int
name|error
decl_stmt|;
name|KASSERT
argument_list|(
name|mac
operator|->
name|mac_status
operator|==
name|BWN_MAC_STATUS_UNINIT
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
name|siba_powerup
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|siba_dev_isup
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
condition|)
name|bwn_reset_core
argument_list|(
name|mac
argument_list|,
name|mac
operator|->
name|mac_phy
operator|.
name|gmode
argument_list|)
expr_stmt|;
name|mac
operator|->
name|mac_flags
operator|&=
operator|~
name|BWN_MAC_FLAG_DFQVALID
expr_stmt|;
name|mac
operator|->
name|mac_flags
operator||=
name|BWN_MAC_FLAG_RADIO_ON
expr_stmt|;
name|mac
operator|->
name|mac_phy
operator|.
name|hwpctl
operator|=
operator|(
name|bwn_hwpctl
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|BWN_GETTIME
argument_list|(
name|mac
operator|->
name|mac_phy
operator|.
name|nexttime
argument_list|)
expr_stmt|;
name|mac
operator|->
name|mac_phy
operator|.
name|txerrors
operator|=
name|BWN_TXERROR_MAX
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|mac
operator|->
name|mac_stats
argument_list|,
sizeof|sizeof
argument_list|(
name|mac
operator|->
name|mac_stats
argument_list|)
argument_list|)
expr_stmt|;
name|mac
operator|->
name|mac_stats
operator|.
name|link_noise
operator|=
operator|-
literal|95
expr_stmt|;
name|mac
operator|->
name|mac_reason_intr
operator|=
literal|0
expr_stmt|;
name|bzero
argument_list|(
name|mac
operator|->
name|mac_reason
argument_list|,
sizeof|sizeof
argument_list|(
name|mac
operator|->
name|mac_reason
argument_list|)
argument_list|)
expr_stmt|;
name|mac
operator|->
name|mac_intr_mask
operator|=
name|BWN_INTR_MASKTEMPLATE
expr_stmt|;
ifdef|#
directive|ifdef
name|BWN_DEBUG
if|if
condition|(
name|sc
operator|->
name|sc_debug
operator|&
name|BWN_DEBUG_XMIT
condition|)
name|mac
operator|->
name|mac_intr_mask
operator|&=
operator|~
name|BWN_INTR_PHY_TXERR
expr_stmt|;
endif|#
directive|endif
name|mac
operator|->
name|mac_suspended
operator|=
literal|1
expr_stmt|;
name|mac
operator|->
name|mac_task_state
operator|=
literal|0
expr_stmt|;
name|memset
argument_list|(
operator|&
name|mac
operator|->
name|mac_noise
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|mac
operator|->
name|mac_noise
argument_list|)
argument_list|)
expr_stmt|;
name|mac
operator|->
name|mac_phy
operator|.
name|init_pre
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|siba_pcicore_intr
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
expr_stmt|;
name|siba_fix_imcfglobug
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
expr_stmt|;
name|bwn_bt_disable
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|prepare_hw
condition|)
block|{
name|error
operator|=
name|mac
operator|->
name|mac_phy
operator|.
name|prepare_hw
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail0
goto|;
block|}
name|error
operator|=
name|bwn_chip_init
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail0
goto|;
name|bwn_shm_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
name|BWN_SHARED_COREREV
argument_list|,
name|siba_get_revid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|)
expr_stmt|;
name|hf
operator|=
name|bwn_hf_read
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|type
operator|==
name|BWN_PHYTYPE_G
condition|)
block|{
name|hf
operator||=
name|BWN_HF_GPHY_SYM_WORKAROUND
expr_stmt|;
if|if
condition|(
name|siba_sprom_get_bf_lo
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|&
name|BWN_BFL_PACTRL
condition|)
name|hf
operator||=
name|BWN_HF_PAGAINBOOST_OFDM_ON
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|==
literal|1
condition|)
name|hf
operator||=
name|BWN_HF_GPHY_DC_CANCELFILTER
expr_stmt|;
block|}
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rf_ver
operator|==
literal|0x2050
condition|)
block|{
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rf_rev
operator|<
literal|6
condition|)
name|hf
operator||=
name|BWN_HF_FORCE_VCO_RECALC
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rf_rev
operator|==
literal|6
condition|)
name|hf
operator||=
name|BWN_HF_4318_TSSI
expr_stmt|;
block|}
if|if
condition|(
name|siba_sprom_get_bf_lo
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|&
name|BWN_BFL_CRYSTAL_NOSLOW
condition|)
name|hf
operator||=
name|BWN_HF_SLOWCLOCK_REQ_OFF
expr_stmt|;
if|if
condition|(
operator|(
name|siba_get_type
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
name|SIBA_TYPE_PCI
operator|)
operator|&&
operator|(
name|siba_get_pcicore_revid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|<=
literal|10
operator|)
condition|)
name|hf
operator||=
name|BWN_HF_PCI_SLOWCLOCK_WORKAROUND
expr_stmt|;
name|hf
operator|&=
operator|~
name|BWN_HF_SKIP_CFP_UPDATE
expr_stmt|;
name|bwn_hf_write
argument_list|(
name|mac
argument_list|,
name|hf
argument_list|)
expr_stmt|;
name|bwn_set_txretry
argument_list|(
name|mac
argument_list|,
name|BWN_RETRY_SHORT
argument_list|,
name|BWN_RETRY_LONG
argument_list|)
expr_stmt|;
name|bwn_shm_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
name|BWN_SHARED_SHORT_RETRY_FALLBACK
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|bwn_shm_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
name|BWN_SHARED_LONG_RETRY_FALLBACK
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|bwn_shm_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
name|BWN_SHARED_PROBE_RESP_MAXTIME
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|bwn_rate_init
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|bwn_set_phytxctl
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|bwn_shm_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_SCRATCH
argument_list|,
name|BWN_SCRATCH_CONT_MIN
argument_list|,
operator|(
name|mac
operator|->
name|mac_phy
operator|.
name|type
operator|==
name|BWN_PHYTYPE_B
operator|)
condition|?
literal|0x1f
else|:
literal|0xf
argument_list|)
expr_stmt|;
name|bwn_shm_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_SCRATCH
argument_list|,
name|BWN_SCRATCH_CONT_MAX
argument_list|,
literal|0x3ff
argument_list|)
expr_stmt|;
if|if
condition|(
name|siba_get_type
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
name|SIBA_TYPE_PCMCIA
operator|||
name|bwn_usedma
operator|==
literal|0
condition|)
name|bwn_pio_init
argument_list|(
name|mac
argument_list|)
expr_stmt|;
else|else
name|bwn_dma_init
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|bwn_wme_init
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|bwn_spu_setdelay
argument_list|(
name|mac
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|bwn_bt_enable
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|siba_powerup
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
operator|!
operator|(
name|siba_sprom_get_bf_lo
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|&
name|BWN_BFL_CRYSTAL_NOSLOW
operator|)
argument_list|)
expr_stmt|;
name|bwn_set_macaddr
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|bwn_crypt_init
argument_list|(
name|mac
argument_list|)
expr_stmt|;
comment|/* XXX LED initializatin */
name|mac
operator|->
name|mac_status
operator|=
name|BWN_MAC_STATUS_INITED
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
name|fail0
label|:
name|siba_powerdown
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|mac
operator|->
name|mac_status
operator|==
name|BWN_MAC_STATUS_UNINIT
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_core_start
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
name|KASSERT
argument_list|(
name|mac
operator|->
name|mac_status
operator|==
name|BWN_MAC_STATUS_INITED
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|siba_get_revid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|<
literal|5
condition|)
return|return;
while|while
condition|(
literal|1
condition|)
block|{
name|tmp
operator|=
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|BWN_XMITSTAT_0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|tmp
operator|&
literal|0x00000001
operator|)
condition|)
break|break;
name|tmp
operator|=
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|BWN_XMITSTAT_1
argument_list|)
expr_stmt|;
block|}
name|bwn_mac_enable
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
name|BWN_INTR_MASK
argument_list|,
name|mac
operator|->
name|mac_intr_mask
argument_list|)
expr_stmt|;
name|callout_reset
argument_list|(
operator|&
name|sc
operator|->
name|sc_task_ch
argument_list|,
name|hz
operator|*
literal|15
argument_list|,
name|bwn_tasks
argument_list|,
name|mac
argument_list|)
expr_stmt|;
name|mac
operator|->
name|mac_status
operator|=
name|BWN_MAC_STATUS_STARTED
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_core_exit
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|uint32_t
name|macctl
decl_stmt|;
name|BWN_ASSERT_LOCKED
argument_list|(
name|mac
operator|->
name|mac_sc
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|mac
operator|->
name|mac_status
operator|<=
name|BWN_MAC_STATUS_INITED
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_status
operator|!=
name|BWN_MAC_STATUS_INITED
condition|)
return|return;
name|mac
operator|->
name|mac_status
operator|=
name|BWN_MAC_STATUS_UNINIT
expr_stmt|;
name|macctl
operator|=
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCTL
argument_list|)
expr_stmt|;
name|macctl
operator|&=
operator|~
name|BWN_MACCTL_MCODE_RUN
expr_stmt|;
name|macctl
operator||=
name|BWN_MACCTL_MCODE_JMP0
expr_stmt|;
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCTL
argument_list|,
name|macctl
argument_list|)
expr_stmt|;
name|bwn_dma_stop
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|bwn_pio_stop
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|bwn_chip_exit
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|mac
operator|->
name|mac_phy
operator|.
name|switch_analog
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|siba_dev_down
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|siba_powerdown
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_bt_disable
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
operator|(
name|void
operator|)
name|sc
expr_stmt|;
comment|/* XXX do nothing yet */
block|}
end_function

begin_function
specifier|static
name|int
name|bwn_chip_init
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|uint32_t
name|macctl
decl_stmt|;
name|int
name|error
decl_stmt|;
name|macctl
operator|=
name|BWN_MACCTL_IHR_ON
operator||
name|BWN_MACCTL_SHM_ON
operator||
name|BWN_MACCTL_STA
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|gmode
condition|)
name|macctl
operator||=
name|BWN_MACCTL_GMODE
expr_stmt|;
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCTL
argument_list|,
name|macctl
argument_list|)
expr_stmt|;
name|error
operator|=
name|bwn_fw_fillinfo
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|error
operator|=
name|bwn_fw_loaducode
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|error
operator|=
name|bwn_gpio_init
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|error
operator|=
name|bwn_fw_loadinitvals
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|siba_gpio_set
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|phy
operator|->
name|switch_analog
argument_list|(
name|mac
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|error
operator|=
name|bwn_phy_init
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|siba_gpio_set
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
if|if
condition|(
name|phy
operator|->
name|set_im
condition|)
name|phy
operator|->
name|set_im
argument_list|(
name|mac
argument_list|,
name|BWN_IMMODE_NONE
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|set_antenna
condition|)
name|phy
operator|->
name|set_antenna
argument_list|(
name|mac
argument_list|,
name|BWN_ANT_DEFAULT
argument_list|)
expr_stmt|;
name|bwn_set_txantenna
argument_list|(
name|mac
argument_list|,
name|BWN_ANT_DEFAULT
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|type
operator|==
name|BWN_PHYTYPE_B
condition|)
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
literal|0x005e
argument_list|,
name|BWN_READ_2
argument_list|(
name|mac
argument_list|,
literal|0x005e
argument_list|)
operator||
literal|0x0004
argument_list|)
expr_stmt|;
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
literal|0x0100
argument_list|,
literal|0x01000000
argument_list|)
expr_stmt|;
if|if
condition|(
name|siba_get_revid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|<
literal|5
condition|)
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
literal|0x010c
argument_list|,
literal|0x01000000
argument_list|)
expr_stmt|;
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCTL
argument_list|,
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCTL
argument_list|)
operator|&
operator|~
name|BWN_MACCTL_STA
argument_list|)
expr_stmt|;
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCTL
argument_list|,
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCTL
argument_list|)
operator||
name|BWN_MACCTL_STA
argument_list|)
expr_stmt|;
name|bwn_shm_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
literal|0x0074
argument_list|,
literal|0x0000
argument_list|)
expr_stmt|;
name|bwn_set_opmode
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|siba_get_revid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|<
literal|3
condition|)
block|{
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
literal|0x060e
argument_list|,
literal|0x0000
argument_list|)
expr_stmt|;
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
literal|0x0610
argument_list|,
literal|0x8000
argument_list|)
expr_stmt|;
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
literal|0x0604
argument_list|,
literal|0x0000
argument_list|)
expr_stmt|;
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
literal|0x0606
argument_list|,
literal|0x0200
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
literal|0x0188
argument_list|,
literal|0x80000000
argument_list|)
expr_stmt|;
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
literal|0x018c
argument_list|,
literal|0x02000000
argument_list|)
expr_stmt|;
block|}
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
name|BWN_INTR_REASON
argument_list|,
literal|0x00004000
argument_list|)
expr_stmt|;
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
name|BWN_DMA0_INTR_MASK
argument_list|,
literal|0x0001dc00
argument_list|)
expr_stmt|;
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
name|BWN_DMA1_INTR_MASK
argument_list|,
literal|0x0000dc00
argument_list|)
expr_stmt|;
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
name|BWN_DMA2_INTR_MASK
argument_list|,
literal|0x0000dc00
argument_list|)
expr_stmt|;
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
name|BWN_DMA3_INTR_MASK
argument_list|,
literal|0x0001dc00
argument_list|)
expr_stmt|;
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
name|BWN_DMA4_INTR_MASK
argument_list|,
literal|0x0000dc00
argument_list|)
expr_stmt|;
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
name|BWN_DMA5_INTR_MASK
argument_list|,
literal|0x0000dc00
argument_list|)
expr_stmt|;
name|bwn_mac_phy_clock_set
argument_list|(
name|mac
argument_list|,
name|true
argument_list|)
expr_stmt|;
comment|/* SIBA powerup */
comment|/* XXX TODO: BCMA powerup */
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
name|BWN_POWERUP_DELAY
argument_list|,
name|siba_get_cc_powerdelay
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/* read hostflags */
end_comment

begin_function
name|uint64_t
name|bwn_hf_read
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|uint64_t
name|ret
decl_stmt|;
name|ret
operator|=
name|bwn_shm_read_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
name|BWN_SHARED_HFHI
argument_list|)
expr_stmt|;
name|ret
operator|<<=
literal|16
expr_stmt|;
name|ret
operator||=
name|bwn_shm_read_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
name|BWN_SHARED_HFMI
argument_list|)
expr_stmt|;
name|ret
operator|<<=
literal|16
expr_stmt|;
name|ret
operator||=
name|bwn_shm_read_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
name|BWN_SHARED_HFLO
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
name|void
name|bwn_hf_write
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint64_t
name|value
parameter_list|)
block|{
name|bwn_shm_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
name|BWN_SHARED_HFLO
argument_list|,
operator|(
name|value
operator|&
literal|0x00000000ffffull
operator|)
argument_list|)
expr_stmt|;
name|bwn_shm_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
name|BWN_SHARED_HFMI
argument_list|,
operator|(
name|value
operator|&
literal|0x0000ffff0000ull
operator|)
operator|>>
literal|16
argument_list|)
expr_stmt|;
name|bwn_shm_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
name|BWN_SHARED_HFHI
argument_list|,
operator|(
name|value
operator|&
literal|0xffff00000000ULL
operator|)
operator|>>
literal|32
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_set_txretry
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|int
name|s
parameter_list|,
name|int
name|l
parameter_list|)
block|{
name|bwn_shm_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_SCRATCH
argument_list|,
name|BWN_SCRATCH_SHORT_RETRY
argument_list|,
name|MIN
argument_list|(
name|s
argument_list|,
literal|0xf
argument_list|)
argument_list|)
expr_stmt|;
name|bwn_shm_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_SCRATCH
argument_list|,
name|BWN_SCRATCH_LONG_RETRY
argument_list|,
name|MIN
argument_list|(
name|l
argument_list|,
literal|0xf
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_rate_init
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
switch|switch
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|type
condition|)
block|{
case|case
name|BWN_PHYTYPE_A
case|:
case|case
name|BWN_PHYTYPE_G
case|:
case|case
name|BWN_PHYTYPE_LP
case|:
case|case
name|BWN_PHYTYPE_N
case|:
name|bwn_rate_write
argument_list|(
name|mac
argument_list|,
name|BWN_OFDM_RATE_6MB
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|bwn_rate_write
argument_list|(
name|mac
argument_list|,
name|BWN_OFDM_RATE_12MB
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|bwn_rate_write
argument_list|(
name|mac
argument_list|,
name|BWN_OFDM_RATE_18MB
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|bwn_rate_write
argument_list|(
name|mac
argument_list|,
name|BWN_OFDM_RATE_24MB
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|bwn_rate_write
argument_list|(
name|mac
argument_list|,
name|BWN_OFDM_RATE_36MB
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|bwn_rate_write
argument_list|(
name|mac
argument_list|,
name|BWN_OFDM_RATE_48MB
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|bwn_rate_write
argument_list|(
name|mac
argument_list|,
name|BWN_OFDM_RATE_54MB
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|type
operator|==
name|BWN_PHYTYPE_A
condition|)
break|break;
comment|/* FALLTHROUGH */
case|case
name|BWN_PHYTYPE_B
case|:
name|bwn_rate_write
argument_list|(
name|mac
argument_list|,
name|BWN_CCK_RATE_1MB
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bwn_rate_write
argument_list|(
name|mac
argument_list|,
name|BWN_CCK_RATE_2MB
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bwn_rate_write
argument_list|(
name|mac
argument_list|,
name|BWN_CCK_RATE_5MB
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bwn_rate_write
argument_list|(
name|mac
argument_list|,
name|BWN_CCK_RATE_11MB
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
default|default:
name|KASSERT
argument_list|(
literal|0
operator|==
literal|1
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_rate_write
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint16_t
name|rate
parameter_list|,
name|int
name|ofdm
parameter_list|)
block|{
name|uint16_t
name|offset
decl_stmt|;
if|if
condition|(
name|ofdm
condition|)
block|{
name|offset
operator|=
literal|0x480
expr_stmt|;
name|offset
operator|+=
operator|(
name|bwn_plcp_getofdm
argument_list|(
name|rate
argument_list|)
operator|&
literal|0x000f
operator|)
operator|*
literal|2
expr_stmt|;
block|}
else|else
block|{
name|offset
operator|=
literal|0x4c0
expr_stmt|;
name|offset
operator|+=
operator|(
name|bwn_plcp_getcck
argument_list|(
name|rate
argument_list|)
operator|&
literal|0x000f
operator|)
operator|*
literal|2
expr_stmt|;
block|}
name|bwn_shm_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
name|offset
operator|+
literal|0x20
argument_list|,
name|bwn_shm_read_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
name|offset
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|bwn_plcp_getcck
parameter_list|(
specifier|const
name|uint8_t
name|bitrate
parameter_list|)
block|{
switch|switch
condition|(
name|bitrate
condition|)
block|{
case|case
name|BWN_CCK_RATE_1MB
case|:
return|return
operator|(
literal|0x0a
operator|)
return|;
case|case
name|BWN_CCK_RATE_2MB
case|:
return|return
operator|(
literal|0x14
operator|)
return|;
case|case
name|BWN_CCK_RATE_5MB
case|:
return|return
operator|(
literal|0x37
operator|)
return|;
case|case
name|BWN_CCK_RATE_11MB
case|:
return|return
operator|(
literal|0x6e
operator|)
return|;
block|}
name|KASSERT
argument_list|(
literal|0
operator|==
literal|1
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|bwn_plcp_getofdm
parameter_list|(
specifier|const
name|uint8_t
name|bitrate
parameter_list|)
block|{
switch|switch
condition|(
name|bitrate
condition|)
block|{
case|case
name|BWN_OFDM_RATE_6MB
case|:
return|return
operator|(
literal|0xb
operator|)
return|;
case|case
name|BWN_OFDM_RATE_9MB
case|:
return|return
operator|(
literal|0xf
operator|)
return|;
case|case
name|BWN_OFDM_RATE_12MB
case|:
return|return
operator|(
literal|0xa
operator|)
return|;
case|case
name|BWN_OFDM_RATE_18MB
case|:
return|return
operator|(
literal|0xe
operator|)
return|;
case|case
name|BWN_OFDM_RATE_24MB
case|:
return|return
operator|(
literal|0x9
operator|)
return|;
case|case
name|BWN_OFDM_RATE_36MB
case|:
return|return
operator|(
literal|0xd
operator|)
return|;
case|case
name|BWN_OFDM_RATE_48MB
case|:
return|return
operator|(
literal|0x8
operator|)
return|;
case|case
name|BWN_OFDM_RATE_54MB
case|:
return|return
operator|(
literal|0xc
operator|)
return|;
block|}
name|KASSERT
argument_list|(
literal|0
operator|==
literal|1
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_set_phytxctl
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|uint16_t
name|ctl
decl_stmt|;
name|ctl
operator|=
operator|(
name|BWN_TX_PHY_ENC_CCK
operator||
name|BWN_TX_PHY_ANT01AUTO
operator||
name|BWN_TX_PHY_TXPWR
operator|)
expr_stmt|;
name|bwn_shm_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
name|BWN_SHARED_BEACON_PHYCTL
argument_list|,
name|ctl
argument_list|)
expr_stmt|;
name|bwn_shm_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
name|BWN_SHARED_ACKCTS_PHYCTL
argument_list|,
name|ctl
argument_list|)
expr_stmt|;
name|bwn_shm_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
name|BWN_SHARED_PROBE_RESP_PHYCTL
argument_list|,
name|ctl
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_pio_init
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_pio
modifier|*
name|pio
init|=
operator|&
name|mac
operator|->
name|mac_method
operator|.
name|pio
decl_stmt|;
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCTL
argument_list|,
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCTL
argument_list|)
operator|&
operator|~
name|BWN_MACCTL_BIGENDIAN
argument_list|)
expr_stmt|;
name|bwn_shm_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
name|BWN_SHARED_RX_PADOFFSET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bwn_pio_set_txqueue
argument_list|(
name|mac
argument_list|,
operator|&
name|pio
operator|->
name|wme
index|[
name|WME_AC_BK
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bwn_pio_set_txqueue
argument_list|(
name|mac
argument_list|,
operator|&
name|pio
operator|->
name|wme
index|[
name|WME_AC_BE
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|bwn_pio_set_txqueue
argument_list|(
name|mac
argument_list|,
operator|&
name|pio
operator|->
name|wme
index|[
name|WME_AC_VI
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|bwn_pio_set_txqueue
argument_list|(
name|mac
argument_list|,
operator|&
name|pio
operator|->
name|wme
index|[
name|WME_AC_VO
index|]
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|bwn_pio_set_txqueue
argument_list|(
name|mac
argument_list|,
operator|&
name|pio
operator|->
name|mcast
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|bwn_pio_setupqueue_rx
argument_list|(
name|mac
argument_list|,
operator|&
name|pio
operator|->
name|rx
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_pio_set_txqueue
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|struct
name|bwn_pio_txqueue
modifier|*
name|tq
parameter_list|,
name|int
name|index
parameter_list|)
block|{
name|struct
name|bwn_pio_txpkt
modifier|*
name|tp
decl_stmt|;
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
name|tq
operator|->
name|tq_base
operator|=
name|bwn_pio_idx2base
argument_list|(
name|mac
argument_list|,
name|index
argument_list|)
operator|+
name|BWN_PIO_TXQOFFSET
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|tq
operator|->
name|tq_index
operator|=
name|index
expr_stmt|;
name|tq
operator|->
name|tq_free
operator|=
name|BWN_PIO_MAX_TXPACKETS
expr_stmt|;
if|if
condition|(
name|siba_get_revid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|>=
literal|8
condition|)
name|tq
operator|->
name|tq_size
operator|=
literal|1920
expr_stmt|;
else|else
block|{
name|tq
operator|->
name|tq_size
operator|=
name|bwn_pio_read_2
argument_list|(
name|mac
argument_list|,
name|tq
argument_list|,
name|BWN_PIO_TXQBUFSIZE
argument_list|)
expr_stmt|;
name|tq
operator|->
name|tq_size
operator|-=
literal|80
expr_stmt|;
block|}
name|TAILQ_INIT
argument_list|(
operator|&
name|tq
operator|->
name|tq_pktlist
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|N
argument_list|(
name|tq
operator|->
name|tq_pkts
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|tp
operator|=
operator|&
operator|(
name|tq
operator|->
name|tq_pkts
index|[
name|i
index|]
operator|)
expr_stmt|;
name|tp
operator|->
name|tp_index
operator|=
name|i
expr_stmt|;
name|tp
operator|->
name|tp_queue
operator|=
name|tq
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|tq
operator|->
name|tq_pktlist
argument_list|,
name|tp
argument_list|,
name|tp_list
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|uint16_t
name|bwn_pio_idx2base
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|int
name|index
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
specifier|static
specifier|const
name|uint16_t
name|bases
index|[]
init|=
block|{
name|BWN_PIO_BASE0
block|,
name|BWN_PIO_BASE1
block|,
name|BWN_PIO_BASE2
block|,
name|BWN_PIO_BASE3
block|,
name|BWN_PIO_BASE4
block|,
name|BWN_PIO_BASE5
block|,
name|BWN_PIO_BASE6
block|,
name|BWN_PIO_BASE7
block|, 	}
decl_stmt|;
specifier|static
specifier|const
name|uint16_t
name|bases_rev11
index|[]
init|=
block|{
name|BWN_PIO11_BASE0
block|,
name|BWN_PIO11_BASE1
block|,
name|BWN_PIO11_BASE2
block|,
name|BWN_PIO11_BASE3
block|,
name|BWN_PIO11_BASE4
block|,
name|BWN_PIO11_BASE5
block|, 	}
decl_stmt|;
if|if
condition|(
name|siba_get_revid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|>=
literal|11
condition|)
block|{
if|if
condition|(
name|index
operator|>=
name|N
argument_list|(
name|bases_rev11
argument_list|)
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: warning\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
name|bases_rev11
index|[
name|index
index|]
operator|)
return|;
block|}
if|if
condition|(
name|index
operator|>=
name|N
argument_list|(
name|bases
argument_list|)
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: warning\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
name|bases
index|[
name|index
index|]
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_pio_setupqueue_rx
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|struct
name|bwn_pio_rxqueue
modifier|*
name|prq
parameter_list|,
name|int
name|index
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|prq
operator|->
name|prq_mac
operator|=
name|mac
expr_stmt|;
name|prq
operator|->
name|prq_rev
operator|=
name|siba_get_revid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
expr_stmt|;
name|prq
operator|->
name|prq_base
operator|=
name|bwn_pio_idx2base
argument_list|(
name|mac
argument_list|,
name|index
argument_list|)
operator|+
name|BWN_PIO_RXQOFFSET
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|bwn_dma_rxdirectfifo
argument_list|(
name|mac
argument_list|,
name|index
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_destroy_pioqueue_tx
parameter_list|(
name|struct
name|bwn_pio_txqueue
modifier|*
name|tq
parameter_list|)
block|{
if|if
condition|(
name|tq
operator|==
name|NULL
condition|)
return|return;
name|bwn_pio_cancel_tx_packets
argument_list|(
name|tq
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_destroy_queue_tx
parameter_list|(
name|struct
name|bwn_pio_txqueue
modifier|*
name|pio
parameter_list|)
block|{
name|bwn_destroy_pioqueue_tx
argument_list|(
name|pio
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|uint16_t
name|bwn_pio_read_2
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|struct
name|bwn_pio_txqueue
modifier|*
name|tq
parameter_list|,
name|uint16_t
name|offset
parameter_list|)
block|{
return|return
operator|(
name|BWN_READ_2
argument_list|(
name|mac
argument_list|,
name|tq
operator|->
name|tq_base
operator|+
name|offset
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_dma_rxdirectfifo
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|int
name|idx
parameter_list|,
name|uint8_t
name|enable
parameter_list|)
block|{
name|uint32_t
name|ctl
decl_stmt|;
name|int
name|type
decl_stmt|;
name|uint16_t
name|base
decl_stmt|;
name|type
operator|=
name|bwn_dma_mask2type
argument_list|(
name|bwn_dma_mask
argument_list|(
name|mac
argument_list|)
argument_list|)
expr_stmt|;
name|base
operator|=
name|bwn_dma_base
argument_list|(
name|type
argument_list|,
name|idx
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|BWN_DMA_64BIT
condition|)
block|{
name|ctl
operator|=
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|base
operator|+
name|BWN_DMA64_RXCTL
argument_list|)
expr_stmt|;
name|ctl
operator|&=
operator|~
name|BWN_DMA64_RXDIRECTFIFO
expr_stmt|;
if|if
condition|(
name|enable
condition|)
name|ctl
operator||=
name|BWN_DMA64_RXDIRECTFIFO
expr_stmt|;
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
name|base
operator|+
name|BWN_DMA64_RXCTL
argument_list|,
name|ctl
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ctl
operator|=
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|base
operator|+
name|BWN_DMA32_RXCTL
argument_list|)
expr_stmt|;
name|ctl
operator|&=
operator|~
name|BWN_DMA32_RXDIRECTFIFO
expr_stmt|;
if|if
condition|(
name|enable
condition|)
name|ctl
operator||=
name|BWN_DMA32_RXDIRECTFIFO
expr_stmt|;
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
name|base
operator|+
name|BWN_DMA32_RXCTL
argument_list|,
name|ctl
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|uint64_t
name|bwn_dma_mask
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
name|uint16_t
name|base
decl_stmt|;
name|tmp
operator|=
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|SIBA_TGSHIGH
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|&
name|SIBA_TGSHIGH_DMA64
condition|)
return|return
operator|(
name|BWN_DMA_BIT_MASK
argument_list|(
literal|64
argument_list|)
operator|)
return|;
name|base
operator|=
name|bwn_dma_base
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
name|base
operator|+
name|BWN_DMA32_TXCTL
argument_list|,
name|BWN_DMA32_TXADDREXT_MASK
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|base
operator|+
name|BWN_DMA32_TXCTL
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|&
name|BWN_DMA32_TXADDREXT_MASK
condition|)
return|return
operator|(
name|BWN_DMA_BIT_MASK
argument_list|(
literal|32
argument_list|)
operator|)
return|;
return|return
operator|(
name|BWN_DMA_BIT_MASK
argument_list|(
literal|30
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bwn_dma_mask2type
parameter_list|(
name|uint64_t
name|dmamask
parameter_list|)
block|{
if|if
condition|(
name|dmamask
operator|==
name|BWN_DMA_BIT_MASK
argument_list|(
literal|30
argument_list|)
condition|)
return|return
operator|(
name|BWN_DMA_30BIT
operator|)
return|;
if|if
condition|(
name|dmamask
operator|==
name|BWN_DMA_BIT_MASK
argument_list|(
literal|32
argument_list|)
condition|)
return|return
operator|(
name|BWN_DMA_32BIT
operator|)
return|;
if|if
condition|(
name|dmamask
operator|==
name|BWN_DMA_BIT_MASK
argument_list|(
literal|64
argument_list|)
condition|)
return|return
operator|(
name|BWN_DMA_64BIT
operator|)
return|;
name|KASSERT
argument_list|(
literal|0
operator|==
literal|1
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|BWN_DMA_30BIT
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_pio_cancel_tx_packets
parameter_list|(
name|struct
name|bwn_pio_txqueue
modifier|*
name|tq
parameter_list|)
block|{
name|struct
name|bwn_pio_txpkt
modifier|*
name|tp
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|N
argument_list|(
name|tq
operator|->
name|tq_pkts
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|tp
operator|=
operator|&
operator|(
name|tq
operator|->
name|tq_pkts
index|[
name|i
index|]
operator|)
expr_stmt|;
if|if
condition|(
name|tp
operator|->
name|tp_m
condition|)
block|{
name|m_freem
argument_list|(
name|tp
operator|->
name|tp_m
argument_list|)
expr_stmt|;
name|tp
operator|->
name|tp_m
operator|=
name|NULL
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|uint16_t
name|bwn_dma_base
parameter_list|(
name|int
name|type
parameter_list|,
name|int
name|controller_idx
parameter_list|)
block|{
specifier|static
specifier|const
name|uint16_t
name|map64
index|[]
init|=
block|{
name|BWN_DMA64_BASE0
block|,
name|BWN_DMA64_BASE1
block|,
name|BWN_DMA64_BASE2
block|,
name|BWN_DMA64_BASE3
block|,
name|BWN_DMA64_BASE4
block|,
name|BWN_DMA64_BASE5
block|, 	}
decl_stmt|;
specifier|static
specifier|const
name|uint16_t
name|map32
index|[]
init|=
block|{
name|BWN_DMA32_BASE0
block|,
name|BWN_DMA32_BASE1
block|,
name|BWN_DMA32_BASE2
block|,
name|BWN_DMA32_BASE3
block|,
name|BWN_DMA32_BASE4
block|,
name|BWN_DMA32_BASE5
block|, 	}
decl_stmt|;
if|if
condition|(
name|type
operator|==
name|BWN_DMA_64BIT
condition|)
block|{
name|KASSERT
argument_list|(
name|controller_idx
operator|>=
literal|0
operator|&&
name|controller_idx
operator|<
name|N
argument_list|(
name|map64
argument_list|)
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|map64
index|[
name|controller_idx
index|]
operator|)
return|;
block|}
name|KASSERT
argument_list|(
name|controller_idx
operator|>=
literal|0
operator|&&
name|controller_idx
operator|<
name|N
argument_list|(
name|map32
argument_list|)
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|map32
index|[
name|controller_idx
index|]
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_dma_init
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_dma
modifier|*
name|dma
init|=
operator|&
name|mac
operator|->
name|mac_method
operator|.
name|dma
decl_stmt|;
comment|/* setup TX DMA channels. */
name|bwn_dma_setup
argument_list|(
name|dma
operator|->
name|wme
index|[
name|WME_AC_BK
index|]
argument_list|)
expr_stmt|;
name|bwn_dma_setup
argument_list|(
name|dma
operator|->
name|wme
index|[
name|WME_AC_BE
index|]
argument_list|)
expr_stmt|;
name|bwn_dma_setup
argument_list|(
name|dma
operator|->
name|wme
index|[
name|WME_AC_VI
index|]
argument_list|)
expr_stmt|;
name|bwn_dma_setup
argument_list|(
name|dma
operator|->
name|wme
index|[
name|WME_AC_VO
index|]
argument_list|)
expr_stmt|;
name|bwn_dma_setup
argument_list|(
name|dma
operator|->
name|mcast
argument_list|)
expr_stmt|;
comment|/* setup RX DMA channel. */
name|bwn_dma_setup
argument_list|(
name|dma
operator|->
name|rx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|bwn_dma_ring
modifier|*
name|bwn_dma_ringsetup
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|int
name|controller_index
parameter_list|,
name|int
name|for_tx
parameter_list|,
name|int
name|type
parameter_list|)
block|{
name|struct
name|bwn_dma
modifier|*
name|dma
init|=
operator|&
name|mac
operator|->
name|mac_method
operator|.
name|dma
decl_stmt|;
name|struct
name|bwn_dma_ring
modifier|*
name|dr
decl_stmt|;
name|struct
name|bwn_dmadesc_generic
modifier|*
name|desc
decl_stmt|;
name|struct
name|bwn_dmadesc_meta
modifier|*
name|mt
decl_stmt|;
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|int
name|error
decl_stmt|,
name|i
decl_stmt|;
name|dr
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|dr
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|dr
operator|==
name|NULL
condition|)
goto|goto
name|out
goto|;
name|dr
operator|->
name|dr_numslots
operator|=
name|BWN_RXRING_SLOTS
expr_stmt|;
if|if
condition|(
name|for_tx
condition|)
name|dr
operator|->
name|dr_numslots
operator|=
name|BWN_TXRING_SLOTS
expr_stmt|;
name|dr
operator|->
name|dr_meta
operator|=
name|malloc
argument_list|(
name|dr
operator|->
name|dr_numslots
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|bwn_dmadesc_meta
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|dr
operator|->
name|dr_meta
operator|==
name|NULL
condition|)
goto|goto
name|fail0
goto|;
name|dr
operator|->
name|dr_type
operator|=
name|type
expr_stmt|;
name|dr
operator|->
name|dr_mac
operator|=
name|mac
expr_stmt|;
name|dr
operator|->
name|dr_base
operator|=
name|bwn_dma_base
argument_list|(
name|type
argument_list|,
name|controller_index
argument_list|)
expr_stmt|;
name|dr
operator|->
name|dr_index
operator|=
name|controller_index
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|BWN_DMA_64BIT
condition|)
block|{
name|dr
operator|->
name|getdesc
operator|=
name|bwn_dma_64_getdesc
expr_stmt|;
name|dr
operator|->
name|setdesc
operator|=
name|bwn_dma_64_setdesc
expr_stmt|;
name|dr
operator|->
name|start_transfer
operator|=
name|bwn_dma_64_start_transfer
expr_stmt|;
name|dr
operator|->
name|suspend
operator|=
name|bwn_dma_64_suspend
expr_stmt|;
name|dr
operator|->
name|resume
operator|=
name|bwn_dma_64_resume
expr_stmt|;
name|dr
operator|->
name|get_curslot
operator|=
name|bwn_dma_64_get_curslot
expr_stmt|;
name|dr
operator|->
name|set_curslot
operator|=
name|bwn_dma_64_set_curslot
expr_stmt|;
block|}
else|else
block|{
name|dr
operator|->
name|getdesc
operator|=
name|bwn_dma_32_getdesc
expr_stmt|;
name|dr
operator|->
name|setdesc
operator|=
name|bwn_dma_32_setdesc
expr_stmt|;
name|dr
operator|->
name|start_transfer
operator|=
name|bwn_dma_32_start_transfer
expr_stmt|;
name|dr
operator|->
name|suspend
operator|=
name|bwn_dma_32_suspend
expr_stmt|;
name|dr
operator|->
name|resume
operator|=
name|bwn_dma_32_resume
expr_stmt|;
name|dr
operator|->
name|get_curslot
operator|=
name|bwn_dma_32_get_curslot
expr_stmt|;
name|dr
operator|->
name|set_curslot
operator|=
name|bwn_dma_32_set_curslot
expr_stmt|;
block|}
if|if
condition|(
name|for_tx
condition|)
block|{
name|dr
operator|->
name|dr_tx
operator|=
literal|1
expr_stmt|;
name|dr
operator|->
name|dr_curslot
operator|=
operator|-
literal|1
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|dr
operator|->
name|dr_index
operator|==
literal|0
condition|)
block|{
name|dr
operator|->
name|dr_rx_bufsize
operator|=
name|BWN_DMA0_RX_BUFFERSIZE
expr_stmt|;
name|dr
operator|->
name|dr_frameoffset
operator|=
name|BWN_DMA0_RX_FRAMEOFFSET
expr_stmt|;
block|}
else|else
name|KASSERT
argument_list|(
literal|0
operator|==
literal|1
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
block|}
name|error
operator|=
name|bwn_dma_allocringmemory
argument_list|(
name|dr
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail2
goto|;
if|if
condition|(
name|for_tx
condition|)
block|{
comment|/* 		 * Assumption: BWN_TXRING_SLOTS can be divided by 		 * BWN_TX_SLOTS_PER_FRAME 		 */
name|KASSERT
argument_list|(
name|BWN_TXRING_SLOTS
operator|%
name|BWN_TX_SLOTS_PER_FRAME
operator|==
literal|0
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
name|dr
operator|->
name|dr_txhdr_cache
operator|=
name|malloc
argument_list|(
operator|(
name|dr
operator|->
name|dr_numslots
operator|/
name|BWN_TX_SLOTS_PER_FRAME
operator|)
operator|*
name|BWN_HDRSIZE
argument_list|(
name|mac
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|dr
operator|->
name|dr_txhdr_cache
operator|!=
name|NULL
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
comment|/* 		 * Create TX ring DMA stuffs 		 */
name|error
operator|=
name|bus_dma_tag_create
argument_list|(
name|dma
operator|->
name|parent_dtag
argument_list|,
name|BWN_ALIGN
argument_list|,
literal|0
argument_list|,
name|BUS_SPACE_MAXADDR
argument_list|,
name|BUS_SPACE_MAXADDR
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|BWN_HDRSIZE
argument_list|(
name|mac
argument_list|)
argument_list|,
literal|1
argument_list|,
name|BUS_SPACE_MAXSIZE_32BIT
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|dr
operator|->
name|dr_txring_dtag
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"can't create TX ring DMA tag: TODO frees\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dr
operator|->
name|dr_numslots
condition|;
name|i
operator|+=
literal|2
control|)
block|{
name|dr
operator|->
name|getdesc
argument_list|(
name|dr
argument_list|,
name|i
argument_list|,
operator|&
name|desc
argument_list|,
operator|&
name|mt
argument_list|)
expr_stmt|;
name|mt
operator|->
name|mt_txtype
operator|=
name|BWN_DMADESC_METATYPE_HEADER
expr_stmt|;
name|mt
operator|->
name|mt_m
operator|=
name|NULL
expr_stmt|;
name|mt
operator|->
name|mt_ni
operator|=
name|NULL
expr_stmt|;
name|mt
operator|->
name|mt_islast
operator|=
literal|0
expr_stmt|;
name|error
operator|=
name|bus_dmamap_create
argument_list|(
name|dr
operator|->
name|dr_txring_dtag
argument_list|,
literal|0
argument_list|,
operator|&
name|mt
operator|->
name|mt_dmap
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"can't create RX buf DMA map\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
name|dr
operator|->
name|getdesc
argument_list|(
name|dr
argument_list|,
name|i
operator|+
literal|1
argument_list|,
operator|&
name|desc
argument_list|,
operator|&
name|mt
argument_list|)
expr_stmt|;
name|mt
operator|->
name|mt_txtype
operator|=
name|BWN_DMADESC_METATYPE_BODY
expr_stmt|;
name|mt
operator|->
name|mt_m
operator|=
name|NULL
expr_stmt|;
name|mt
operator|->
name|mt_ni
operator|=
name|NULL
expr_stmt|;
name|mt
operator|->
name|mt_islast
operator|=
literal|1
expr_stmt|;
name|error
operator|=
name|bus_dmamap_create
argument_list|(
name|dma
operator|->
name|txbuf_dtag
argument_list|,
literal|0
argument_list|,
operator|&
name|mt
operator|->
name|mt_dmap
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"can't create RX buf DMA map\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
block|}
block|}
else|else
block|{
name|error
operator|=
name|bus_dmamap_create
argument_list|(
name|dma
operator|->
name|rxbuf_dtag
argument_list|,
literal|0
argument_list|,
operator|&
name|dr
operator|->
name|dr_spare_dmap
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"can't create RX buf DMA map\n"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
comment|/* XXX wrong! */
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dr
operator|->
name|dr_numslots
condition|;
name|i
operator|++
control|)
block|{
name|dr
operator|->
name|getdesc
argument_list|(
name|dr
argument_list|,
name|i
argument_list|,
operator|&
name|desc
argument_list|,
operator|&
name|mt
argument_list|)
expr_stmt|;
name|error
operator|=
name|bus_dmamap_create
argument_list|(
name|dma
operator|->
name|rxbuf_dtag
argument_list|,
literal|0
argument_list|,
operator|&
name|mt
operator|->
name|mt_dmap
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"can't create RX buf DMA map\n"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
comment|/* XXX wrong! */
block|}
name|error
operator|=
name|bwn_dma_newbuf
argument_list|(
name|dr
argument_list|,
name|desc
argument_list|,
name|mt
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"failed to allocate RX buf\n"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
comment|/* XXX wrong! */
block|}
block|}
name|bus_dmamap_sync
argument_list|(
name|dr
operator|->
name|dr_ring_dtag
argument_list|,
name|dr
operator|->
name|dr_ring_dmap
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
name|dr
operator|->
name|dr_usedslot
operator|=
name|dr
operator|->
name|dr_numslots
expr_stmt|;
block|}
name|out
label|:
return|return
operator|(
name|dr
operator|)
return|;
name|fail2
label|:
name|free
argument_list|(
name|dr
operator|->
name|dr_txhdr_cache
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|fail1
label|:
name|free
argument_list|(
name|dr
operator|->
name|dr_meta
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|fail0
label|:
name|free
argument_list|(
name|dr
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_dma_ringfree
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
modifier|*
name|dr
parameter_list|)
block|{
if|if
condition|(
name|dr
operator|==
name|NULL
condition|)
return|return;
name|bwn_dma_free_descbufs
argument_list|(
operator|*
name|dr
argument_list|)
expr_stmt|;
name|bwn_dma_free_ringmemory
argument_list|(
operator|*
name|dr
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
operator|*
name|dr
operator|)
operator|->
name|dr_txhdr_cache
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
operator|*
name|dr
operator|)
operator|->
name|dr_meta
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|*
name|dr
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
operator|*
name|dr
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_dma_32_getdesc
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
name|dr
parameter_list|,
name|int
name|slot
parameter_list|,
name|struct
name|bwn_dmadesc_generic
modifier|*
modifier|*
name|gdesc
parameter_list|,
name|struct
name|bwn_dmadesc_meta
modifier|*
modifier|*
name|meta
parameter_list|)
block|{
name|struct
name|bwn_dmadesc32
modifier|*
name|desc
decl_stmt|;
operator|*
name|meta
operator|=
operator|&
operator|(
name|dr
operator|->
name|dr_meta
index|[
name|slot
index|]
operator|)
expr_stmt|;
name|desc
operator|=
name|dr
operator|->
name|dr_ring_descbase
expr_stmt|;
name|desc
operator|=
operator|&
operator|(
name|desc
index|[
name|slot
index|]
operator|)
expr_stmt|;
operator|*
name|gdesc
operator|=
operator|(
expr|struct
name|bwn_dmadesc_generic
operator|*
operator|)
name|desc
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_dma_32_setdesc
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
name|dr
parameter_list|,
name|struct
name|bwn_dmadesc_generic
modifier|*
name|desc
parameter_list|,
name|bus_addr_t
name|dmaaddr
parameter_list|,
name|uint16_t
name|bufsize
parameter_list|,
name|int
name|start
parameter_list|,
name|int
name|end
parameter_list|,
name|int
name|irq
parameter_list|)
block|{
name|struct
name|bwn_dmadesc32
modifier|*
name|descbase
init|=
name|dr
operator|->
name|dr_ring_descbase
decl_stmt|;
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|dr
operator|->
name|dr_mac
operator|->
name|mac_sc
decl_stmt|;
name|uint32_t
name|addr
decl_stmt|,
name|addrext
decl_stmt|,
name|ctl
decl_stmt|;
name|int
name|slot
decl_stmt|;
name|slot
operator|=
call|(
name|int
call|)
argument_list|(
operator|&
operator|(
name|desc
operator|->
name|dma
operator|.
name|dma32
operator|)
operator|-
name|descbase
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|slot
operator|>=
literal|0
operator|&&
name|slot
operator|<
name|dr
operator|->
name|dr_numslots
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
name|addr
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|dmaaddr
operator|&
operator|~
name|SIBA_DMA_TRANSLATION_MASK
argument_list|)
expr_stmt|;
name|addrext
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|dmaaddr
operator|&
name|SIBA_DMA_TRANSLATION_MASK
argument_list|)
operator|>>
literal|30
expr_stmt|;
name|addr
operator||=
name|siba_dma_translation
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
expr_stmt|;
name|ctl
operator|=
name|bufsize
operator|&
name|BWN_DMA32_DCTL_BYTECNT
expr_stmt|;
if|if
condition|(
name|slot
operator|==
name|dr
operator|->
name|dr_numslots
operator|-
literal|1
condition|)
name|ctl
operator||=
name|BWN_DMA32_DCTL_DTABLEEND
expr_stmt|;
if|if
condition|(
name|start
condition|)
name|ctl
operator||=
name|BWN_DMA32_DCTL_FRAMESTART
expr_stmt|;
if|if
condition|(
name|end
condition|)
name|ctl
operator||=
name|BWN_DMA32_DCTL_FRAMEEND
expr_stmt|;
if|if
condition|(
name|irq
condition|)
name|ctl
operator||=
name|BWN_DMA32_DCTL_IRQ
expr_stmt|;
name|ctl
operator||=
operator|(
name|addrext
operator|<<
name|BWN_DMA32_DCTL_ADDREXT_SHIFT
operator|)
operator|&
name|BWN_DMA32_DCTL_ADDREXT_MASK
expr_stmt|;
name|desc
operator|->
name|dma
operator|.
name|dma32
operator|.
name|control
operator|=
name|htole32
argument_list|(
name|ctl
argument_list|)
expr_stmt|;
name|desc
operator|->
name|dma
operator|.
name|dma32
operator|.
name|address
operator|=
name|htole32
argument_list|(
name|addr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_dma_32_start_transfer
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
name|dr
parameter_list|,
name|int
name|slot
parameter_list|)
block|{
name|BWN_DMA_WRITE
argument_list|(
name|dr
argument_list|,
name|BWN_DMA32_TXINDEX
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|slot
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|bwn_dmadesc32
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_dma_32_suspend
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
name|dr
parameter_list|)
block|{
name|BWN_DMA_WRITE
argument_list|(
name|dr
argument_list|,
name|BWN_DMA32_TXCTL
argument_list|,
name|BWN_DMA_READ
argument_list|(
name|dr
argument_list|,
name|BWN_DMA32_TXCTL
argument_list|)
operator||
name|BWN_DMA32_TXSUSPEND
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_dma_32_resume
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
name|dr
parameter_list|)
block|{
name|BWN_DMA_WRITE
argument_list|(
name|dr
argument_list|,
name|BWN_DMA32_TXCTL
argument_list|,
name|BWN_DMA_READ
argument_list|(
name|dr
argument_list|,
name|BWN_DMA32_TXCTL
argument_list|)
operator|&
operator|~
name|BWN_DMA32_TXSUSPEND
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|bwn_dma_32_get_curslot
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
name|dr
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|;
name|val
operator|=
name|BWN_DMA_READ
argument_list|(
name|dr
argument_list|,
name|BWN_DMA32_RXSTATUS
argument_list|)
expr_stmt|;
name|val
operator|&=
name|BWN_DMA32_RXDPTR
expr_stmt|;
return|return
operator|(
name|val
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|bwn_dmadesc32
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_dma_32_set_curslot
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
name|dr
parameter_list|,
name|int
name|slot
parameter_list|)
block|{
name|BWN_DMA_WRITE
argument_list|(
name|dr
argument_list|,
name|BWN_DMA32_RXINDEX
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|slot
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|bwn_dmadesc32
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_dma_64_getdesc
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
name|dr
parameter_list|,
name|int
name|slot
parameter_list|,
name|struct
name|bwn_dmadesc_generic
modifier|*
modifier|*
name|gdesc
parameter_list|,
name|struct
name|bwn_dmadesc_meta
modifier|*
modifier|*
name|meta
parameter_list|)
block|{
name|struct
name|bwn_dmadesc64
modifier|*
name|desc
decl_stmt|;
operator|*
name|meta
operator|=
operator|&
operator|(
name|dr
operator|->
name|dr_meta
index|[
name|slot
index|]
operator|)
expr_stmt|;
name|desc
operator|=
name|dr
operator|->
name|dr_ring_descbase
expr_stmt|;
name|desc
operator|=
operator|&
operator|(
name|desc
index|[
name|slot
index|]
operator|)
expr_stmt|;
operator|*
name|gdesc
operator|=
operator|(
expr|struct
name|bwn_dmadesc_generic
operator|*
operator|)
name|desc
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_dma_64_setdesc
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
name|dr
parameter_list|,
name|struct
name|bwn_dmadesc_generic
modifier|*
name|desc
parameter_list|,
name|bus_addr_t
name|dmaaddr
parameter_list|,
name|uint16_t
name|bufsize
parameter_list|,
name|int
name|start
parameter_list|,
name|int
name|end
parameter_list|,
name|int
name|irq
parameter_list|)
block|{
name|struct
name|bwn_dmadesc64
modifier|*
name|descbase
init|=
name|dr
operator|->
name|dr_ring_descbase
decl_stmt|;
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|dr
operator|->
name|dr_mac
operator|->
name|mac_sc
decl_stmt|;
name|int
name|slot
decl_stmt|;
name|uint32_t
name|ctl0
init|=
literal|0
decl_stmt|,
name|ctl1
init|=
literal|0
decl_stmt|;
name|uint32_t
name|addrlo
decl_stmt|,
name|addrhi
decl_stmt|;
name|uint32_t
name|addrext
decl_stmt|;
name|slot
operator|=
call|(
name|int
call|)
argument_list|(
operator|&
operator|(
name|desc
operator|->
name|dma
operator|.
name|dma64
operator|)
operator|-
name|descbase
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|slot
operator|>=
literal|0
operator|&&
name|slot
operator|<
name|dr
operator|->
name|dr_numslots
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
name|addrlo
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|dmaaddr
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
name|addrhi
operator|=
operator|(
operator|(
operator|(
name|uint64_t
operator|)
name|dmaaddr
operator|>>
literal|32
operator|)
operator|&
operator|~
name|SIBA_DMA_TRANSLATION_MASK
operator|)
expr_stmt|;
name|addrext
operator|=
operator|(
operator|(
operator|(
name|uint64_t
operator|)
name|dmaaddr
operator|>>
literal|32
operator|)
operator|&
name|SIBA_DMA_TRANSLATION_MASK
operator|)
operator|>>
literal|30
expr_stmt|;
name|addrhi
operator||=
operator|(
name|siba_dma_translation
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|<<
literal|1
operator|)
expr_stmt|;
if|if
condition|(
name|slot
operator|==
name|dr
operator|->
name|dr_numslots
operator|-
literal|1
condition|)
name|ctl0
operator||=
name|BWN_DMA64_DCTL0_DTABLEEND
expr_stmt|;
if|if
condition|(
name|start
condition|)
name|ctl0
operator||=
name|BWN_DMA64_DCTL0_FRAMESTART
expr_stmt|;
if|if
condition|(
name|end
condition|)
name|ctl0
operator||=
name|BWN_DMA64_DCTL0_FRAMEEND
expr_stmt|;
if|if
condition|(
name|irq
condition|)
name|ctl0
operator||=
name|BWN_DMA64_DCTL0_IRQ
expr_stmt|;
name|ctl1
operator||=
name|bufsize
operator|&
name|BWN_DMA64_DCTL1_BYTECNT
expr_stmt|;
name|ctl1
operator||=
operator|(
name|addrext
operator|<<
name|BWN_DMA64_DCTL1_ADDREXT_SHIFT
operator|)
operator|&
name|BWN_DMA64_DCTL1_ADDREXT_MASK
expr_stmt|;
name|desc
operator|->
name|dma
operator|.
name|dma64
operator|.
name|control0
operator|=
name|htole32
argument_list|(
name|ctl0
argument_list|)
expr_stmt|;
name|desc
operator|->
name|dma
operator|.
name|dma64
operator|.
name|control1
operator|=
name|htole32
argument_list|(
name|ctl1
argument_list|)
expr_stmt|;
name|desc
operator|->
name|dma
operator|.
name|dma64
operator|.
name|address_low
operator|=
name|htole32
argument_list|(
name|addrlo
argument_list|)
expr_stmt|;
name|desc
operator|->
name|dma
operator|.
name|dma64
operator|.
name|address_high
operator|=
name|htole32
argument_list|(
name|addrhi
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_dma_64_start_transfer
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
name|dr
parameter_list|,
name|int
name|slot
parameter_list|)
block|{
name|BWN_DMA_WRITE
argument_list|(
name|dr
argument_list|,
name|BWN_DMA64_TXINDEX
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|slot
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|bwn_dmadesc64
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_dma_64_suspend
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
name|dr
parameter_list|)
block|{
name|BWN_DMA_WRITE
argument_list|(
name|dr
argument_list|,
name|BWN_DMA64_TXCTL
argument_list|,
name|BWN_DMA_READ
argument_list|(
name|dr
argument_list|,
name|BWN_DMA64_TXCTL
argument_list|)
operator||
name|BWN_DMA64_TXSUSPEND
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_dma_64_resume
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
name|dr
parameter_list|)
block|{
name|BWN_DMA_WRITE
argument_list|(
name|dr
argument_list|,
name|BWN_DMA64_TXCTL
argument_list|,
name|BWN_DMA_READ
argument_list|(
name|dr
argument_list|,
name|BWN_DMA64_TXCTL
argument_list|)
operator|&
operator|~
name|BWN_DMA64_TXSUSPEND
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|bwn_dma_64_get_curslot
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
name|dr
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|;
name|val
operator|=
name|BWN_DMA_READ
argument_list|(
name|dr
argument_list|,
name|BWN_DMA64_RXSTATUS
argument_list|)
expr_stmt|;
name|val
operator|&=
name|BWN_DMA64_RXSTATDPTR
expr_stmt|;
return|return
operator|(
name|val
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|bwn_dmadesc64
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_dma_64_set_curslot
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
name|dr
parameter_list|,
name|int
name|slot
parameter_list|)
block|{
name|BWN_DMA_WRITE
argument_list|(
name|dr
argument_list|,
name|BWN_DMA64_RXINDEX
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|slot
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|bwn_dmadesc64
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|bwn_dma_allocringmemory
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
name|dr
parameter_list|)
block|{
name|struct
name|bwn_mac
modifier|*
name|mac
init|=
name|dr
operator|->
name|dr_mac
decl_stmt|;
name|struct
name|bwn_dma
modifier|*
name|dma
init|=
operator|&
name|mac
operator|->
name|mac_method
operator|.
name|dma
decl_stmt|;
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|int
name|error
decl_stmt|;
name|error
operator|=
name|bus_dma_tag_create
argument_list|(
name|dma
operator|->
name|parent_dtag
argument_list|,
name|BWN_ALIGN
argument_list|,
literal|0
argument_list|,
name|BUS_SPACE_MAXADDR
argument_list|,
name|BUS_SPACE_MAXADDR
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|BWN_DMA_RINGMEMSIZE
argument_list|,
literal|1
argument_list|,
name|BUS_SPACE_MAXSIZE_32BIT
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|dr
operator|->
name|dr_ring_dtag
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"can't create TX ring DMA tag: TODO frees\n"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|error
operator|=
name|bus_dmamem_alloc
argument_list|(
name|dr
operator|->
name|dr_ring_dtag
argument_list|,
operator|&
name|dr
operator|->
name|dr_ring_descbase
argument_list|,
name|BUS_DMA_WAITOK
operator||
name|BUS_DMA_ZERO
argument_list|,
operator|&
name|dr
operator|->
name|dr_ring_dmap
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"can't allocate DMA mem: TODO frees\n"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|error
operator|=
name|bus_dmamap_load
argument_list|(
name|dr
operator|->
name|dr_ring_dtag
argument_list|,
name|dr
operator|->
name|dr_ring_dmap
argument_list|,
name|dr
operator|->
name|dr_ring_descbase
argument_list|,
name|BWN_DMA_RINGMEMSIZE
argument_list|,
name|bwn_dma_ring_addr
argument_list|,
operator|&
name|dr
operator|->
name|dr_ring_dmabase
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"can't load DMA mem: TODO free\n"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_dma_setup
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
name|dr
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|dr
operator|->
name|dr_mac
operator|->
name|mac_sc
decl_stmt|;
name|uint64_t
name|ring64
decl_stmt|;
name|uint32_t
name|addrext
decl_stmt|,
name|ring32
decl_stmt|,
name|value
decl_stmt|;
name|uint32_t
name|trans
init|=
name|siba_dma_translation
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|dr
operator|->
name|dr_tx
condition|)
block|{
name|dr
operator|->
name|dr_curslot
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|dr
operator|->
name|dr_type
operator|==
name|BWN_DMA_64BIT
condition|)
block|{
name|ring64
operator|=
call|(
name|uint64_t
call|)
argument_list|(
name|dr
operator|->
name|dr_ring_dmabase
argument_list|)
expr_stmt|;
name|addrext
operator|=
operator|(
operator|(
name|ring64
operator|>>
literal|32
operator|)
operator|&
name|SIBA_DMA_TRANSLATION_MASK
operator|)
operator|>>
literal|30
expr_stmt|;
name|value
operator|=
name|BWN_DMA64_TXENABLE
expr_stmt|;
name|value
operator||=
operator|(
name|addrext
operator|<<
name|BWN_DMA64_TXADDREXT_SHIFT
operator|)
operator|&
name|BWN_DMA64_TXADDREXT_MASK
expr_stmt|;
name|BWN_DMA_WRITE
argument_list|(
name|dr
argument_list|,
name|BWN_DMA64_TXCTL
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|BWN_DMA_WRITE
argument_list|(
name|dr
argument_list|,
name|BWN_DMA64_TXRINGLO
argument_list|,
operator|(
name|ring64
operator|&
literal|0xffffffff
operator|)
argument_list|)
expr_stmt|;
name|BWN_DMA_WRITE
argument_list|(
name|dr
argument_list|,
name|BWN_DMA64_TXRINGHI
argument_list|,
operator|(
operator|(
name|ring64
operator|>>
literal|32
operator|)
operator|&
operator|~
name|SIBA_DMA_TRANSLATION_MASK
operator|)
operator||
operator|(
name|trans
operator|<<
literal|1
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ring32
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|dr
operator|->
name|dr_ring_dmabase
argument_list|)
expr_stmt|;
name|addrext
operator|=
operator|(
name|ring32
operator|&
name|SIBA_DMA_TRANSLATION_MASK
operator|)
operator|>>
literal|30
expr_stmt|;
name|value
operator|=
name|BWN_DMA32_TXENABLE
expr_stmt|;
name|value
operator||=
operator|(
name|addrext
operator|<<
name|BWN_DMA32_TXADDREXT_SHIFT
operator|)
operator|&
name|BWN_DMA32_TXADDREXT_MASK
expr_stmt|;
name|BWN_DMA_WRITE
argument_list|(
name|dr
argument_list|,
name|BWN_DMA32_TXCTL
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|BWN_DMA_WRITE
argument_list|(
name|dr
argument_list|,
name|BWN_DMA32_TXRING
argument_list|,
operator|(
name|ring32
operator|&
operator|~
name|SIBA_DMA_TRANSLATION_MASK
operator|)
operator||
name|trans
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
comment|/* 	 * set for RX 	 */
name|dr
operator|->
name|dr_usedslot
operator|=
name|dr
operator|->
name|dr_numslots
expr_stmt|;
if|if
condition|(
name|dr
operator|->
name|dr_type
operator|==
name|BWN_DMA_64BIT
condition|)
block|{
name|ring64
operator|=
call|(
name|uint64_t
call|)
argument_list|(
name|dr
operator|->
name|dr_ring_dmabase
argument_list|)
expr_stmt|;
name|addrext
operator|=
operator|(
operator|(
name|ring64
operator|>>
literal|32
operator|)
operator|&
name|SIBA_DMA_TRANSLATION_MASK
operator|)
operator|>>
literal|30
expr_stmt|;
name|value
operator|=
operator|(
name|dr
operator|->
name|dr_frameoffset
operator|<<
name|BWN_DMA64_RXFROFF_SHIFT
operator|)
expr_stmt|;
name|value
operator||=
name|BWN_DMA64_RXENABLE
expr_stmt|;
name|value
operator||=
operator|(
name|addrext
operator|<<
name|BWN_DMA64_RXADDREXT_SHIFT
operator|)
operator|&
name|BWN_DMA64_RXADDREXT_MASK
expr_stmt|;
name|BWN_DMA_WRITE
argument_list|(
name|dr
argument_list|,
name|BWN_DMA64_RXCTL
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|BWN_DMA_WRITE
argument_list|(
name|dr
argument_list|,
name|BWN_DMA64_RXRINGLO
argument_list|,
operator|(
name|ring64
operator|&
literal|0xffffffff
operator|)
argument_list|)
expr_stmt|;
name|BWN_DMA_WRITE
argument_list|(
name|dr
argument_list|,
name|BWN_DMA64_RXRINGHI
argument_list|,
operator|(
operator|(
name|ring64
operator|>>
literal|32
operator|)
operator|&
operator|~
name|SIBA_DMA_TRANSLATION_MASK
operator|)
operator||
operator|(
name|trans
operator|<<
literal|1
operator|)
argument_list|)
expr_stmt|;
name|BWN_DMA_WRITE
argument_list|(
name|dr
argument_list|,
name|BWN_DMA64_RXINDEX
argument_list|,
name|dr
operator|->
name|dr_numslots
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|bwn_dmadesc64
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ring32
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|dr
operator|->
name|dr_ring_dmabase
argument_list|)
expr_stmt|;
name|addrext
operator|=
operator|(
name|ring32
operator|&
name|SIBA_DMA_TRANSLATION_MASK
operator|)
operator|>>
literal|30
expr_stmt|;
name|value
operator|=
operator|(
name|dr
operator|->
name|dr_frameoffset
operator|<<
name|BWN_DMA32_RXFROFF_SHIFT
operator|)
expr_stmt|;
name|value
operator||=
name|BWN_DMA32_RXENABLE
expr_stmt|;
name|value
operator||=
operator|(
name|addrext
operator|<<
name|BWN_DMA32_RXADDREXT_SHIFT
operator|)
operator|&
name|BWN_DMA32_RXADDREXT_MASK
expr_stmt|;
name|BWN_DMA_WRITE
argument_list|(
name|dr
argument_list|,
name|BWN_DMA32_RXCTL
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|BWN_DMA_WRITE
argument_list|(
name|dr
argument_list|,
name|BWN_DMA32_RXRING
argument_list|,
operator|(
name|ring32
operator|&
operator|~
name|SIBA_DMA_TRANSLATION_MASK
operator|)
operator||
name|trans
argument_list|)
expr_stmt|;
name|BWN_DMA_WRITE
argument_list|(
name|dr
argument_list|,
name|BWN_DMA32_RXINDEX
argument_list|,
name|dr
operator|->
name|dr_numslots
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|bwn_dmadesc32
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_dma_free_ringmemory
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
name|dr
parameter_list|)
block|{
name|bus_dmamap_unload
argument_list|(
name|dr
operator|->
name|dr_ring_dtag
argument_list|,
name|dr
operator|->
name|dr_ring_dmap
argument_list|)
expr_stmt|;
name|bus_dmamem_free
argument_list|(
name|dr
operator|->
name|dr_ring_dtag
argument_list|,
name|dr
operator|->
name|dr_ring_descbase
argument_list|,
name|dr
operator|->
name|dr_ring_dmap
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_dma_cleanup
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
name|dr
parameter_list|)
block|{
if|if
condition|(
name|dr
operator|->
name|dr_tx
condition|)
block|{
name|bwn_dma_tx_reset
argument_list|(
name|dr
operator|->
name|dr_mac
argument_list|,
name|dr
operator|->
name|dr_base
argument_list|,
name|dr
operator|->
name|dr_type
argument_list|)
expr_stmt|;
if|if
condition|(
name|dr
operator|->
name|dr_type
operator|==
name|BWN_DMA_64BIT
condition|)
block|{
name|BWN_DMA_WRITE
argument_list|(
name|dr
argument_list|,
name|BWN_DMA64_TXRINGLO
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_DMA_WRITE
argument_list|(
name|dr
argument_list|,
name|BWN_DMA64_TXRINGHI
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
name|BWN_DMA_WRITE
argument_list|(
name|dr
argument_list|,
name|BWN_DMA32_TXRING
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|bwn_dma_rx_reset
argument_list|(
name|dr
operator|->
name|dr_mac
argument_list|,
name|dr
operator|->
name|dr_base
argument_list|,
name|dr
operator|->
name|dr_type
argument_list|)
expr_stmt|;
if|if
condition|(
name|dr
operator|->
name|dr_type
operator|==
name|BWN_DMA_64BIT
condition|)
block|{
name|BWN_DMA_WRITE
argument_list|(
name|dr
argument_list|,
name|BWN_DMA64_RXRINGLO
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_DMA_WRITE
argument_list|(
name|dr
argument_list|,
name|BWN_DMA64_RXRINGHI
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
name|BWN_DMA_WRITE
argument_list|(
name|dr
argument_list|,
name|BWN_DMA32_RXRING
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_dma_free_descbufs
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
name|dr
parameter_list|)
block|{
name|struct
name|bwn_dmadesc_generic
modifier|*
name|desc
decl_stmt|;
name|struct
name|bwn_dmadesc_meta
modifier|*
name|meta
decl_stmt|;
name|struct
name|bwn_mac
modifier|*
name|mac
init|=
name|dr
operator|->
name|dr_mac
decl_stmt|;
name|struct
name|bwn_dma
modifier|*
name|dma
init|=
operator|&
name|mac
operator|->
name|mac_method
operator|.
name|dma
decl_stmt|;
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|dr
operator|->
name|dr_usedslot
condition|)
return|return;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dr
operator|->
name|dr_numslots
condition|;
name|i
operator|++
control|)
block|{
name|dr
operator|->
name|getdesc
argument_list|(
name|dr
argument_list|,
name|i
argument_list|,
operator|&
name|desc
argument_list|,
operator|&
name|meta
argument_list|)
expr_stmt|;
if|if
condition|(
name|meta
operator|->
name|mt_m
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
operator|!
name|dr
operator|->
name|dr_tx
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: not TX?\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|dr
operator|->
name|dr_tx
condition|)
block|{
if|if
condition|(
name|meta
operator|->
name|mt_txtype
operator|==
name|BWN_DMADESC_METATYPE_HEADER
condition|)
name|bus_dmamap_unload
argument_list|(
name|dr
operator|->
name|dr_txring_dtag
argument_list|,
name|meta
operator|->
name|mt_dmap
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|meta
operator|->
name|mt_txtype
operator|==
name|BWN_DMADESC_METATYPE_BODY
condition|)
name|bus_dmamap_unload
argument_list|(
name|dma
operator|->
name|txbuf_dtag
argument_list|,
name|meta
operator|->
name|mt_dmap
argument_list|)
expr_stmt|;
block|}
else|else
name|bus_dmamap_unload
argument_list|(
name|dma
operator|->
name|rxbuf_dtag
argument_list|,
name|meta
operator|->
name|mt_dmap
argument_list|)
expr_stmt|;
name|bwn_dma_free_descbuf
argument_list|(
name|dr
argument_list|,
name|meta
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|bwn_dma_tx_reset
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint16_t
name|base
parameter_list|,
name|int
name|type
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|uint32_t
name|value
decl_stmt|;
name|int
name|i
decl_stmt|;
name|uint16_t
name|offset
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|10
condition|;
name|i
operator|++
control|)
block|{
name|offset
operator|=
operator|(
name|type
operator|==
name|BWN_DMA_64BIT
operator|)
condition|?
name|BWN_DMA64_TXSTATUS
else|:
name|BWN_DMA32_TXSTATUS
expr_stmt|;
name|value
operator|=
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|base
operator|+
name|offset
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|BWN_DMA_64BIT
condition|)
block|{
name|value
operator|&=
name|BWN_DMA64_TXSTAT
expr_stmt|;
if|if
condition|(
name|value
operator|==
name|BWN_DMA64_TXSTAT_DISABLED
operator|||
name|value
operator|==
name|BWN_DMA64_TXSTAT_IDLEWAIT
operator|||
name|value
operator|==
name|BWN_DMA64_TXSTAT_STOPPED
condition|)
break|break;
block|}
else|else
block|{
name|value
operator|&=
name|BWN_DMA32_TXSTATE
expr_stmt|;
if|if
condition|(
name|value
operator|==
name|BWN_DMA32_TXSTAT_DISABLED
operator|||
name|value
operator|==
name|BWN_DMA32_TXSTAT_IDLEWAIT
operator|||
name|value
operator|==
name|BWN_DMA32_TXSTAT_STOPPED
condition|)
break|break;
block|}
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
block|}
name|offset
operator|=
operator|(
name|type
operator|==
name|BWN_DMA_64BIT
operator|)
condition|?
name|BWN_DMA64_TXCTL
else|:
name|BWN_DMA32_TXCTL
expr_stmt|;
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
name|base
operator|+
name|offset
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|10
condition|;
name|i
operator|++
control|)
block|{
name|offset
operator|=
operator|(
name|type
operator|==
name|BWN_DMA_64BIT
operator|)
condition|?
name|BWN_DMA64_TXSTATUS
else|:
name|BWN_DMA32_TXSTATUS
expr_stmt|;
name|value
operator|=
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|base
operator|+
name|offset
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|BWN_DMA_64BIT
condition|)
block|{
name|value
operator|&=
name|BWN_DMA64_TXSTAT
expr_stmt|;
if|if
condition|(
name|value
operator|==
name|BWN_DMA64_TXSTAT_DISABLED
condition|)
block|{
name|i
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
name|value
operator|&=
name|BWN_DMA32_TXSTATE
expr_stmt|;
if|if
condition|(
name|value
operator|==
name|BWN_DMA32_TXSTAT_DISABLED
condition|)
block|{
name|i
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
block|}
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|!=
operator|-
literal|1
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: timed out\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENODEV
operator|)
return|;
block|}
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bwn_dma_rx_reset
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint16_t
name|base
parameter_list|,
name|int
name|type
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|uint32_t
name|value
decl_stmt|;
name|int
name|i
decl_stmt|;
name|uint16_t
name|offset
decl_stmt|;
name|offset
operator|=
operator|(
name|type
operator|==
name|BWN_DMA_64BIT
operator|)
condition|?
name|BWN_DMA64_RXCTL
else|:
name|BWN_DMA32_RXCTL
expr_stmt|;
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
name|base
operator|+
name|offset
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|10
condition|;
name|i
operator|++
control|)
block|{
name|offset
operator|=
operator|(
name|type
operator|==
name|BWN_DMA_64BIT
operator|)
condition|?
name|BWN_DMA64_RXSTATUS
else|:
name|BWN_DMA32_RXSTATUS
expr_stmt|;
name|value
operator|=
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|base
operator|+
name|offset
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|BWN_DMA_64BIT
condition|)
block|{
name|value
operator|&=
name|BWN_DMA64_RXSTAT
expr_stmt|;
if|if
condition|(
name|value
operator|==
name|BWN_DMA64_RXSTAT_DISABLED
condition|)
block|{
name|i
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
name|value
operator|&=
name|BWN_DMA32_RXSTATE
expr_stmt|;
if|if
condition|(
name|value
operator|==
name|BWN_DMA32_RXSTAT_DISABLED
condition|)
block|{
name|i
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
block|}
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|!=
operator|-
literal|1
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: timed out\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENODEV
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_dma_free_descbuf
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
name|dr
parameter_list|,
name|struct
name|bwn_dmadesc_meta
modifier|*
name|meta
parameter_list|)
block|{
if|if
condition|(
name|meta
operator|->
name|mt_m
operator|!=
name|NULL
condition|)
block|{
name|m_freem
argument_list|(
name|meta
operator|->
name|mt_m
argument_list|)
expr_stmt|;
name|meta
operator|->
name|mt_m
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|meta
operator|->
name|mt_ni
operator|!=
name|NULL
condition|)
block|{
name|ieee80211_free_node
argument_list|(
name|meta
operator|->
name|mt_ni
argument_list|)
expr_stmt|;
name|meta
operator|->
name|mt_ni
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_dma_set_redzone
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
name|dr
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|)
block|{
name|struct
name|bwn_rxhdr4
modifier|*
name|rxhdr
decl_stmt|;
name|unsigned
name|char
modifier|*
name|frame
decl_stmt|;
name|rxhdr
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|bwn_rxhdr4
operator|*
argument_list|)
expr_stmt|;
name|rxhdr
operator|->
name|frame_len
operator|=
literal|0
expr_stmt|;
name|KASSERT
argument_list|(
name|dr
operator|->
name|dr_rx_bufsize
operator|>=
name|dr
operator|->
name|dr_frameoffset
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|bwn_plcp6
argument_list|)
operator|+
literal|2
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
name|frame
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
name|char
operator|*
argument_list|)
operator|+
name|dr
operator|->
name|dr_frameoffset
expr_stmt|;
name|memset
argument_list|(
name|frame
argument_list|,
literal|0xff
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|bwn_plcp6
argument_list|)
operator|+
literal|2
comment|/* padding */
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|bwn_dma_check_redzone
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
name|dr
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|)
block|{
name|unsigned
name|char
modifier|*
name|f
init|=
name|mtod
argument_list|(
name|m
argument_list|,
name|char
operator|*
argument_list|)
operator|+
name|dr
operator|->
name|dr_frameoffset
decl_stmt|;
return|return
operator|(
operator|(
name|f
index|[
literal|0
index|]
operator|&
name|f
index|[
literal|1
index|]
operator|&
name|f
index|[
literal|2
index|]
operator|&
name|f
index|[
literal|3
index|]
operator|&
name|f
index|[
literal|4
index|]
operator|&
name|f
index|[
literal|5
index|]
operator|&
name|f
index|[
literal|6
index|]
operator|&
name|f
index|[
literal|7
index|]
operator|)
operator|==
literal|0xff
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_wme_init
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|bwn_wme_load
argument_list|(
name|mac
argument_list|)
expr_stmt|;
comment|/* enable WME support. */
name|bwn_hf_write
argument_list|(
name|mac
argument_list|,
name|bwn_hf_read
argument_list|(
name|mac
argument_list|)
operator||
name|BWN_HF_EDCF
argument_list|)
expr_stmt|;
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
name|BWN_IFSCTL
argument_list|,
name|BWN_READ_2
argument_list|(
name|mac
argument_list|,
name|BWN_IFSCTL
argument_list|)
operator||
name|BWN_IFSCTL_USE_EDCF
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_spu_setdelay
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|int
name|idle
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
name|uint16_t
name|delay
decl_stmt|;
comment|/* microsec */
name|delay
operator|=
operator|(
name|mac
operator|->
name|mac_phy
operator|.
name|type
operator|==
name|BWN_PHYTYPE_A
operator|)
condition|?
literal|3700
else|:
literal|1050
expr_stmt|;
if|if
condition|(
name|ic
operator|->
name|ic_opmode
operator|==
name|IEEE80211_M_IBSS
operator|||
name|idle
condition|)
name|delay
operator|=
literal|500
expr_stmt|;
if|if
condition|(
operator|(
name|mac
operator|->
name|mac_phy
operator|.
name|rf_ver
operator|==
literal|0x2050
operator|)
operator|&&
operator|(
name|mac
operator|->
name|mac_phy
operator|.
name|rf_rev
operator|==
literal|8
operator|)
condition|)
name|delay
operator|=
name|max
argument_list|(
name|delay
argument_list|,
operator|(
name|uint16_t
operator|)
literal|2400
argument_list|)
expr_stmt|;
name|bwn_shm_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
name|BWN_SHARED_SPU_WAKEUP
argument_list|,
name|delay
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_bt_enable
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|uint64_t
name|hf
decl_stmt|;
if|if
condition|(
name|bwn_bluetooth
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
operator|(
name|siba_sprom_get_bf_lo
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|&
name|BWN_BFL_BTCOEXIST
operator|)
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|type
operator|!=
name|BWN_PHYTYPE_B
operator|&&
operator|!
name|mac
operator|->
name|mac_phy
operator|.
name|gmode
condition|)
return|return;
name|hf
operator|=
name|bwn_hf_read
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|siba_sprom_get_bf_lo
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|&
name|BWN_BFL_BTCMOD
condition|)
name|hf
operator||=
name|BWN_HF_BT_COEXISTALT
expr_stmt|;
else|else
name|hf
operator||=
name|BWN_HF_BT_COEXIST
expr_stmt|;
name|bwn_hf_write
argument_list|(
name|mac
argument_list|,
name|hf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_set_macaddr
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|bwn_mac_write_bssid
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|bwn_mac_setfilter
argument_list|(
name|mac
argument_list|,
name|BWN_MACFILTER_SELF
argument_list|,
name|mac
operator|->
name|mac_sc
operator|->
name|sc_ic
operator|.
name|ic_macaddr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_clear_keys
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|mac
operator|->
name|mac_max_nr_keys
condition|;
name|i
operator|++
control|)
block|{
name|KASSERT
argument_list|(
name|i
operator|>=
literal|0
operator|&&
name|i
operator|<
name|mac
operator|->
name|mac_max_nr_keys
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
name|bwn_key_dowrite
argument_list|(
name|mac
argument_list|,
name|i
argument_list|,
name|BWN_SEC_ALGO_NONE
argument_list|,
name|NULL
argument_list|,
name|BWN_SEC_KEYSIZE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|<=
literal|3
operator|)
operator|&&
operator|!
name|BWN_SEC_NEWAPI
argument_list|(
name|mac
argument_list|)
condition|)
block|{
name|bwn_key_dowrite
argument_list|(
name|mac
argument_list|,
name|i
operator|+
literal|4
argument_list|,
name|BWN_SEC_ALGO_NONE
argument_list|,
name|NULL
argument_list|,
name|BWN_SEC_KEYSIZE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
name|mac
operator|->
name|mac_key
index|[
name|i
index|]
operator|.
name|keyconf
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_crypt_init
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|mac
operator|->
name|mac_max_nr_keys
operator|=
operator|(
name|siba_get_revid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|>=
literal|5
operator|)
condition|?
literal|58
else|:
literal|20
expr_stmt|;
name|KASSERT
argument_list|(
name|mac
operator|->
name|mac_max_nr_keys
operator|<=
name|N
argument_list|(
name|mac
operator|->
name|mac_key
argument_list|)
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
name|mac
operator|->
name|mac_ktp
operator|=
name|bwn_shm_read_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
name|BWN_SHARED_KEY_TABLEP
argument_list|)
expr_stmt|;
name|mac
operator|->
name|mac_ktp
operator|*=
literal|2
expr_stmt|;
if|if
condition|(
name|siba_get_revid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|>=
literal|5
condition|)
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
name|BWN_RCMTA_COUNT
argument_list|,
name|mac
operator|->
name|mac_max_nr_keys
operator|-
literal|8
argument_list|)
expr_stmt|;
name|bwn_clear_keys
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_chip_exit
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|bwn_phy_exit
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|siba_gpio_set
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|bwn_fw_fillinfo
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
name|error
operator|=
name|bwn_fw_gets
argument_list|(
name|mac
argument_list|,
name|BWN_FWTYPE_DEFAULT
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|error
operator|=
name|bwn_fw_gets
argument_list|(
name|mac
argument_list|,
name|BWN_FWTYPE_OPENSOURCE
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bwn_gpio_init
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|uint32_t
name|mask
init|=
literal|0x1f
decl_stmt|,
name|set
init|=
literal|0xf
decl_stmt|,
name|value
decl_stmt|;
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCTL
argument_list|,
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCTL
argument_list|)
operator|&
operator|~
name|BWN_MACCTL_GPOUT_MASK
argument_list|)
expr_stmt|;
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
name|BWN_GPIO_MASK
argument_list|,
name|BWN_READ_2
argument_list|(
name|mac
argument_list|,
name|BWN_GPIO_MASK
argument_list|)
operator||
literal|0x000f
argument_list|)
expr_stmt|;
if|if
condition|(
name|siba_get_chipid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
literal|0x4301
condition|)
block|{
name|mask
operator||=
literal|0x0060
expr_stmt|;
name|set
operator||=
literal|0x0060
expr_stmt|;
block|}
if|if
condition|(
name|siba_sprom_get_bf_lo
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|&
name|BWN_BFL_PACTRL
condition|)
block|{
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
name|BWN_GPIO_MASK
argument_list|,
name|BWN_READ_2
argument_list|(
name|mac
argument_list|,
name|BWN_GPIO_MASK
argument_list|)
operator||
literal|0x0200
argument_list|)
expr_stmt|;
name|mask
operator||=
literal|0x0200
expr_stmt|;
name|set
operator||=
literal|0x0200
expr_stmt|;
block|}
if|if
condition|(
name|siba_get_revid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|>=
literal|2
condition|)
name|mask
operator||=
literal|0x0010
expr_stmt|;
name|value
operator|=
name|siba_gpio_get
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|siba_gpio_set
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
operator|(
name|value
operator|&
name|mask
operator|)
operator||
name|set
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bwn_fw_loadinitvals
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
define|#
directive|define
name|GETFWOFFSET
parameter_list|(
name|fwp
parameter_list|,
name|offset
parameter_list|)
define|\
value|((const struct bwn_fwinitvals *)((const char *)fwp.fw->data + offset))
specifier|const
name|size_t
name|hdr_len
init|=
sizeof|sizeof
argument_list|(
expr|struct
name|bwn_fwhdr
argument_list|)
decl_stmt|;
specifier|const
name|struct
name|bwn_fwhdr
modifier|*
name|hdr
decl_stmt|;
name|struct
name|bwn_fw
modifier|*
name|fw
init|=
operator|&
name|mac
operator|->
name|mac_fw
decl_stmt|;
name|int
name|error
decl_stmt|;
name|hdr
operator|=
operator|(
specifier|const
expr|struct
name|bwn_fwhdr
operator|*
operator|)
operator|(
name|fw
operator|->
name|initvals
operator|.
name|fw
operator|->
name|data
operator|)
expr_stmt|;
name|error
operator|=
name|bwn_fwinitvals_write
argument_list|(
name|mac
argument_list|,
name|GETFWOFFSET
argument_list|(
name|fw
operator|->
name|initvals
argument_list|,
name|hdr_len
argument_list|)
argument_list|,
name|be32toh
argument_list|(
name|hdr
operator|->
name|size
argument_list|)
argument_list|,
name|fw
operator|->
name|initvals
operator|.
name|fw
operator|->
name|datasize
operator|-
name|hdr_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
if|if
condition|(
name|fw
operator|->
name|initvals_band
operator|.
name|fw
condition|)
block|{
name|hdr
operator|=
operator|(
specifier|const
expr|struct
name|bwn_fwhdr
operator|*
operator|)
operator|(
name|fw
operator|->
name|initvals_band
operator|.
name|fw
operator|->
name|data
operator|)
expr_stmt|;
name|error
operator|=
name|bwn_fwinitvals_write
argument_list|(
name|mac
argument_list|,
name|GETFWOFFSET
argument_list|(
name|fw
operator|->
name|initvals_band
argument_list|,
name|hdr_len
argument_list|)
argument_list|,
name|be32toh
argument_list|(
name|hdr
operator|->
name|size
argument_list|)
argument_list|,
name|fw
operator|->
name|initvals_band
operator|.
name|fw
operator|->
name|datasize
operator|-
name|hdr_len
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
undef|#
directive|undef
name|GETFWOFFSET
block|}
end_function

begin_function
specifier|static
name|int
name|bwn_phy_init
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|int
name|error
decl_stmt|;
name|mac
operator|->
name|mac_phy
operator|.
name|chan
operator|=
name|mac
operator|->
name|mac_phy
operator|.
name|get_default_chan
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|mac
operator|->
name|mac_phy
operator|.
name|rf_onoff
argument_list|(
name|mac
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|error
operator|=
name|mac
operator|->
name|mac_phy
operator|.
name|init
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"PHY init failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail0
goto|;
block|}
name|error
operator|=
name|bwn_switch_channel
argument_list|(
name|mac
argument_list|,
name|mac
operator|->
name|mac_phy
operator|.
name|get_default_chan
argument_list|(
name|mac
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"failed to switch default channel\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|fail1
label|:
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|exit
condition|)
name|mac
operator|->
name|mac_phy
operator|.
name|exit
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|fail0
label|:
name|mac
operator|->
name|mac_phy
operator|.
name|rf_onoff
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_set_txantenna
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|int
name|antenna
parameter_list|)
block|{
name|uint16_t
name|ant
decl_stmt|;
name|uint16_t
name|tmp
decl_stmt|;
name|ant
operator|=
name|bwn_ant2phy
argument_list|(
name|antenna
argument_list|)
expr_stmt|;
comment|/* For ACK/CTS */
name|tmp
operator|=
name|bwn_shm_read_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
name|BWN_SHARED_ACKCTS_PHYCTL
argument_list|)
expr_stmt|;
name|tmp
operator|=
operator|(
name|tmp
operator|&
operator|~
name|BWN_TX_PHY_ANT
operator|)
operator||
name|ant
expr_stmt|;
name|bwn_shm_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
name|BWN_SHARED_ACKCTS_PHYCTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* For Probe Resposes */
name|tmp
operator|=
name|bwn_shm_read_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
name|BWN_SHARED_PROBE_RESP_PHYCTL
argument_list|)
expr_stmt|;
name|tmp
operator|=
operator|(
name|tmp
operator|&
operator|~
name|BWN_TX_PHY_ANT
operator|)
operator||
name|ant
expr_stmt|;
name|bwn_shm_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
name|BWN_SHARED_PROBE_RESP_PHYCTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_set_opmode
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
name|uint32_t
name|ctl
decl_stmt|;
name|uint16_t
name|cfp_pretbtt
decl_stmt|;
name|ctl
operator|=
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCTL
argument_list|)
expr_stmt|;
name|ctl
operator|&=
operator|~
operator|(
name|BWN_MACCTL_HOSTAP
operator||
name|BWN_MACCTL_PASS_CTL
operator||
name|BWN_MACCTL_PASS_BADPLCP
operator||
name|BWN_MACCTL_PASS_BADFCS
operator||
name|BWN_MACCTL_PROMISC
operator||
name|BWN_MACCTL_BEACON_PROMISC
operator|)
expr_stmt|;
name|ctl
operator||=
name|BWN_MACCTL_STA
expr_stmt|;
if|if
condition|(
name|ic
operator|->
name|ic_opmode
operator|==
name|IEEE80211_M_HOSTAP
operator|||
name|ic
operator|->
name|ic_opmode
operator|==
name|IEEE80211_M_MBSS
condition|)
name|ctl
operator||=
name|BWN_MACCTL_HOSTAP
expr_stmt|;
elseif|else
if|if
condition|(
name|ic
operator|->
name|ic_opmode
operator|==
name|IEEE80211_M_IBSS
condition|)
name|ctl
operator|&=
operator|~
name|BWN_MACCTL_STA
expr_stmt|;
name|ctl
operator||=
name|sc
operator|->
name|sc_filters
expr_stmt|;
if|if
condition|(
name|siba_get_revid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|<=
literal|4
condition|)
name|ctl
operator||=
name|BWN_MACCTL_PROMISC
expr_stmt|;
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCTL
argument_list|,
name|ctl
argument_list|)
expr_stmt|;
name|cfp_pretbtt
operator|=
literal|2
expr_stmt|;
if|if
condition|(
operator|(
name|ctl
operator|&
name|BWN_MACCTL_STA
operator|)
operator|&&
operator|!
operator|(
name|ctl
operator|&
name|BWN_MACCTL_HOSTAP
operator|)
condition|)
block|{
if|if
condition|(
name|siba_get_chipid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
literal|0x4306
operator|&&
name|siba_get_chiprev
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
literal|3
condition|)
name|cfp_pretbtt
operator|=
literal|100
expr_stmt|;
else|else
name|cfp_pretbtt
operator|=
literal|50
expr_stmt|;
block|}
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
literal|0x612
argument_list|,
name|cfp_pretbtt
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|bwn_dma_gettype
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
name|uint16_t
name|base
decl_stmt|;
name|tmp
operator|=
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|SIBA_TGSHIGH
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|&
name|SIBA_TGSHIGH_DMA64
condition|)
return|return
operator|(
name|BWN_DMA_64BIT
operator|)
return|;
name|base
operator|=
name|bwn_dma_base
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
name|base
operator|+
name|BWN_DMA32_TXCTL
argument_list|,
name|BWN_DMA32_TXADDREXT_MASK
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|base
operator|+
name|BWN_DMA32_TXCTL
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|&
name|BWN_DMA32_TXADDREXT_MASK
condition|)
return|return
operator|(
name|BWN_DMA_32BIT
operator|)
return|;
return|return
operator|(
name|BWN_DMA_30BIT
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_dma_ring_addr
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|seg
parameter_list|,
name|int
name|nseg
parameter_list|,
name|int
name|error
parameter_list|)
block|{
if|if
condition|(
operator|!
name|error
condition|)
block|{
name|KASSERT
argument_list|(
name|nseg
operator|==
literal|1
argument_list|,
operator|(
literal|"too many segments(%d)\n"
operator|,
name|nseg
operator|)
argument_list|)
expr_stmt|;
operator|*
operator|(
operator|(
name|bus_addr_t
operator|*
operator|)
name|arg
operator|)
operator|=
name|seg
operator|->
name|ds_addr
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|bwn_dummy_transmission
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|int
name|ofdm
parameter_list|,
name|int
name|paon
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|,
name|max_loop
decl_stmt|;
name|uint16_t
name|value
decl_stmt|;
name|uint32_t
name|buffer
index|[
literal|5
index|]
init|=
block|{
literal|0x00000000
block|,
literal|0x00d40000
block|,
literal|0x00000000
block|,
literal|0x01000000
block|,
literal|0x00000000
block|}
decl_stmt|;
if|if
condition|(
name|ofdm
condition|)
block|{
name|max_loop
operator|=
literal|0x1e
expr_stmt|;
name|buffer
index|[
literal|0
index|]
operator|=
literal|0x000201cc
expr_stmt|;
block|}
else|else
block|{
name|max_loop
operator|=
literal|0xfa
expr_stmt|;
name|buffer
index|[
literal|0
index|]
operator|=
literal|0x000b846e
expr_stmt|;
block|}
name|BWN_ASSERT_LOCKED
argument_list|(
name|mac
operator|->
name|mac_sc
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|5
condition|;
name|i
operator|++
control|)
name|bwn_ram_write
argument_list|(
name|mac
argument_list|,
name|i
operator|*
literal|4
argument_list|,
name|buffer
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
literal|0x0568
argument_list|,
literal|0x0000
argument_list|)
expr_stmt|;
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
literal|0x07c0
argument_list|,
operator|(
name|siba_get_revid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|<
literal|11
operator|)
condition|?
literal|0x0000
else|:
literal|0x0100
argument_list|)
expr_stmt|;
name|value
operator|=
operator|(
name|ofdm
condition|?
literal|0x41
else|:
literal|0x40
operator|)
expr_stmt|;
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
literal|0x050c
argument_list|,
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|type
operator|==
name|BWN_PHYTYPE_N
operator|||
name|phy
operator|->
name|type
operator|==
name|BWN_PHYTYPE_LP
operator|||
name|phy
operator|->
name|type
operator|==
name|BWN_PHYTYPE_LCN
condition|)
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
literal|0x0514
argument_list|,
literal|0x1a02
argument_list|)
expr_stmt|;
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
literal|0x0508
argument_list|,
literal|0x0000
argument_list|)
expr_stmt|;
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
literal|0x050a
argument_list|,
literal|0x0000
argument_list|)
expr_stmt|;
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
literal|0x054c
argument_list|,
literal|0x0000
argument_list|)
expr_stmt|;
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
literal|0x056a
argument_list|,
literal|0x0014
argument_list|)
expr_stmt|;
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
literal|0x0568
argument_list|,
literal|0x0826
argument_list|)
expr_stmt|;
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
literal|0x0500
argument_list|,
literal|0x0000
argument_list|)
expr_stmt|;
comment|/* XXX TODO: n phy pa override? */
switch|switch
condition|(
name|phy
operator|->
name|type
condition|)
block|{
case|case
name|BWN_PHYTYPE_N
case|:
case|case
name|BWN_PHYTYPE_LCN
case|:
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
literal|0x0502
argument_list|,
literal|0x00d0
argument_list|)
expr_stmt|;
break|break;
case|case
name|BWN_PHYTYPE_LP
case|:
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
literal|0x0502
argument_list|,
literal|0x0050
argument_list|)
expr_stmt|;
break|break;
default|default:
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
literal|0x0502
argument_list|,
literal|0x0030
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* flush */
name|BWN_READ_2
argument_list|(
name|mac
argument_list|,
literal|0x0502
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|rf_ver
operator|==
literal|0x2050
operator|&&
name|phy
operator|->
name|rf_rev
operator|<=
literal|0x5
condition|)
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x0051
argument_list|,
literal|0x0017
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0x00
init|;
name|i
operator|<
name|max_loop
condition|;
name|i
operator|++
control|)
block|{
name|value
operator|=
name|BWN_READ_2
argument_list|(
name|mac
argument_list|,
literal|0x050e
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|&
literal|0x0080
condition|)
break|break;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0x00
init|;
name|i
operator|<
literal|0x0a
condition|;
name|i
operator|++
control|)
block|{
name|value
operator|=
name|BWN_READ_2
argument_list|(
name|mac
argument_list|,
literal|0x050e
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|&
literal|0x0400
condition|)
break|break;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0x00
init|;
name|i
operator|<
literal|0x19
condition|;
name|i
operator|++
control|)
block|{
name|value
operator|=
name|BWN_READ_2
argument_list|(
name|mac
argument_list|,
literal|0x0690
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|value
operator|&
literal|0x0100
operator|)
condition|)
break|break;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|phy
operator|->
name|rf_ver
operator|==
literal|0x2050
operator|&&
name|phy
operator|->
name|rf_rev
operator|<=
literal|0x5
condition|)
name|BWN_RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x0051
argument_list|,
literal|0x0037
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|bwn_ram_write
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint16_t
name|offset
parameter_list|,
name|uint32_t
name|val
parameter_list|)
block|{
name|uint32_t
name|macctl
decl_stmt|;
name|KASSERT
argument_list|(
name|offset
operator|%
literal|4
operator|==
literal|0
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
name|macctl
operator|=
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCTL
argument_list|)
expr_stmt|;
if|if
condition|(
name|macctl
operator|&
name|BWN_MACCTL_BIGENDIAN
condition|)
name|printf
argument_list|(
literal|"TODO: need swap\n"
argument_list|)
expr_stmt|;
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
name|BWN_RAM_CONTROL
argument_list|,
name|offset
argument_list|)
expr_stmt|;
name|BWN_BARRIER
argument_list|(
name|mac
argument_list|,
name|BUS_SPACE_BARRIER_WRITE
argument_list|)
expr_stmt|;
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
name|BWN_RAM_DATA
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|bwn_mac_suspend
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|int
name|i
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
name|KASSERT
argument_list|(
name|mac
operator|->
name|mac_suspended
operator|>=
literal|0
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_suspended
operator|==
literal|0
condition|)
block|{
name|bwn_psctl
argument_list|(
name|mac
argument_list|,
name|BWN_PS_AWAKE
argument_list|)
expr_stmt|;
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCTL
argument_list|,
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCTL
argument_list|)
operator|&
operator|~
name|BWN_MACCTL_ON
argument_list|)
expr_stmt|;
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCTL
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|35
init|;
name|i
condition|;
name|i
operator|--
control|)
block|{
name|tmp
operator|=
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|BWN_INTR_REASON
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|&
name|BWN_INTR_MAC_SUSPENDED
condition|)
goto|goto
name|out
goto|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|40
init|;
name|i
condition|;
name|i
operator|--
control|)
block|{
name|tmp
operator|=
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|BWN_INTR_REASON
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|&
name|BWN_INTR_MAC_SUSPENDED
condition|)
goto|goto
name|out
goto|;
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
block|}
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"MAC suspend failed\n"
argument_list|)
expr_stmt|;
block|}
name|out
label|:
name|mac
operator|->
name|mac_suspended
operator|++
expr_stmt|;
block|}
end_function

begin_function
name|void
name|bwn_mac_enable
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|uint16_t
name|state
decl_stmt|;
name|state
operator|=
name|bwn_shm_read_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
name|BWN_SHARED_UCODESTAT
argument_list|)
expr_stmt|;
if|if
condition|(
name|state
operator|!=
name|BWN_SHARED_UCODESTAT_SUSPEND
operator|&&
name|state
operator|!=
name|BWN_SHARED_UCODESTAT_SLEEP
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"warn: firmware state (%d)\n"
argument_list|,
name|state
argument_list|)
expr_stmt|;
name|mac
operator|->
name|mac_suspended
operator|--
expr_stmt|;
name|KASSERT
argument_list|(
name|mac
operator|->
name|mac_suspended
operator|>=
literal|0
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_suspended
operator|==
literal|0
condition|)
block|{
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCTL
argument_list|,
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCTL
argument_list|)
operator||
name|BWN_MACCTL_ON
argument_list|)
expr_stmt|;
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
name|BWN_INTR_REASON
argument_list|,
name|BWN_INTR_MAC_SUSPENDED
argument_list|)
expr_stmt|;
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCTL
argument_list|)
expr_stmt|;
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|BWN_INTR_REASON
argument_list|)
expr_stmt|;
name|bwn_psctl
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|bwn_psctl
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint32_t
name|flags
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|int
name|i
decl_stmt|;
name|uint16_t
name|ucstat
decl_stmt|;
name|KASSERT
argument_list|(
operator|!
operator|(
operator|(
name|flags
operator|&
name|BWN_PS_ON
operator|)
operator|&&
operator|(
name|flags
operator|&
name|BWN_PS_OFF
operator|)
operator|)
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
operator|!
operator|(
operator|(
name|flags
operator|&
name|BWN_PS_AWAKE
operator|)
operator|&&
operator|(
name|flags
operator|&
name|BWN_PS_ASLEEP
operator|)
operator|)
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
comment|/* XXX forcibly awake and hwps-off */
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCTL
argument_list|,
operator|(
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCTL
argument_list|)
operator||
name|BWN_MACCTL_AWAKE
operator|)
operator|&
operator|~
name|BWN_MACCTL_HWPS
argument_list|)
expr_stmt|;
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCTL
argument_list|)
expr_stmt|;
if|if
condition|(
name|siba_get_revid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|>=
literal|5
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|100
condition|;
name|i
operator|++
control|)
block|{
name|ucstat
operator|=
name|bwn_shm_read_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
name|BWN_SHARED_UCODESTAT
argument_list|)
expr_stmt|;
if|if
condition|(
name|ucstat
operator|!=
name|BWN_SHARED_UCODESTAT_SLEEP
condition|)
break|break;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|bwn_fw_gets
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|enum
name|bwn_fwtype
name|type
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|struct
name|bwn_fw
modifier|*
name|fw
init|=
operator|&
name|mac
operator|->
name|mac_fw
decl_stmt|;
specifier|const
name|uint8_t
name|rev
init|=
name|siba_get_revid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|filename
decl_stmt|;
name|uint32_t
name|high
decl_stmt|;
name|int
name|error
decl_stmt|;
comment|/* microcode */
name|filename
operator|=
name|NULL
expr_stmt|;
switch|switch
condition|(
name|rev
condition|)
block|{
case|case
literal|42
case|:
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|type
operator|==
name|BWN_PHYTYPE_AC
condition|)
name|filename
operator|=
literal|"ucode42"
expr_stmt|;
break|break;
case|case
literal|40
case|:
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|type
operator|==
name|BWN_PHYTYPE_AC
condition|)
name|filename
operator|=
literal|"ucode40"
expr_stmt|;
break|break;
case|case
literal|33
case|:
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|type
operator|==
name|BWN_PHYTYPE_LCN40
condition|)
name|filename
operator|=
literal|"ucode33_lcn40"
expr_stmt|;
break|break;
case|case
literal|30
case|:
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|type
operator|==
name|BWN_PHYTYPE_N
condition|)
name|filename
operator|=
literal|"ucode30_mimo"
expr_stmt|;
break|break;
case|case
literal|29
case|:
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|type
operator|==
name|BWN_PHYTYPE_HT
condition|)
name|filename
operator|=
literal|"ucode29_mimo"
expr_stmt|;
break|break;
case|case
literal|26
case|:
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|type
operator|==
name|BWN_PHYTYPE_HT
condition|)
name|filename
operator|=
literal|"ucode26_mimo"
expr_stmt|;
break|break;
case|case
literal|28
case|:
case|case
literal|25
case|:
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|type
operator|==
name|BWN_PHYTYPE_N
condition|)
name|filename
operator|=
literal|"ucode25_mimo"
expr_stmt|;
elseif|else
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|type
operator|==
name|BWN_PHYTYPE_LCN
condition|)
name|filename
operator|=
literal|"ucode25_lcn"
expr_stmt|;
break|break;
case|case
literal|24
case|:
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|type
operator|==
name|BWN_PHYTYPE_LCN
condition|)
name|filename
operator|=
literal|"ucode24_lcn"
expr_stmt|;
break|break;
case|case
literal|23
case|:
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|type
operator|==
name|BWN_PHYTYPE_N
condition|)
name|filename
operator|=
literal|"ucode16_mimo"
expr_stmt|;
break|break;
case|case
literal|16
case|:
case|case
literal|17
case|:
case|case
literal|18
case|:
case|case
literal|19
case|:
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|type
operator|==
name|BWN_PHYTYPE_N
condition|)
name|filename
operator|=
literal|"ucode16_mimo"
expr_stmt|;
elseif|else
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|type
operator|==
name|BWN_PHYTYPE_LP
condition|)
name|filename
operator|=
literal|"ucode16_lp"
expr_stmt|;
break|break;
case|case
literal|15
case|:
name|filename
operator|=
literal|"ucode15"
expr_stmt|;
break|break;
case|case
literal|14
case|:
name|filename
operator|=
literal|"ucode14"
expr_stmt|;
break|break;
case|case
literal|13
case|:
name|filename
operator|=
literal|"ucode13"
expr_stmt|;
break|break;
case|case
literal|12
case|:
case|case
literal|11
case|:
name|filename
operator|=
literal|"ucode11"
expr_stmt|;
break|break;
case|case
literal|10
case|:
case|case
literal|9
case|:
case|case
literal|8
case|:
case|case
literal|7
case|:
case|case
literal|6
case|:
case|case
literal|5
case|:
name|filename
operator|=
literal|"ucode5"
expr_stmt|;
break|break;
default|default:
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"no ucode for rev %d\n"
argument_list|,
name|rev
argument_list|)
expr_stmt|;
name|bwn_release_firmware
argument_list|(
name|mac
argument_list|)
expr_stmt|;
return|return
operator|(
name|EOPNOTSUPP
operator|)
return|;
block|}
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"ucode fw: %s\n"
argument_list|,
name|filename
argument_list|)
expr_stmt|;
name|error
operator|=
name|bwn_fw_get
argument_list|(
name|mac
argument_list|,
name|type
argument_list|,
name|filename
argument_list|,
operator|&
name|fw
operator|->
name|ucode
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|bwn_release_firmware
argument_list|(
name|mac
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
comment|/* PCM */
name|KASSERT
argument_list|(
name|fw
operator|->
name|no_pcmfile
operator|==
literal|0
argument_list|,
operator|(
literal|"%s:%d fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rev
operator|>=
literal|5
operator|&&
name|rev
operator|<=
literal|10
condition|)
block|{
name|error
operator|=
name|bwn_fw_get
argument_list|(
name|mac
argument_list|,
name|type
argument_list|,
literal|"pcm5"
argument_list|,
operator|&
name|fw
operator|->
name|pcm
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
name|ENOENT
condition|)
name|fw
operator|->
name|no_pcmfile
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|error
condition|)
block|{
name|bwn_release_firmware
argument_list|(
name|mac
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|rev
operator|<
literal|11
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"no PCM for rev %d\n"
argument_list|,
name|rev
argument_list|)
expr_stmt|;
return|return
operator|(
name|EOPNOTSUPP
operator|)
return|;
block|}
comment|/* initvals */
name|high
operator|=
name|siba_read_4
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
name|SIBA_TGSHIGH
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|type
condition|)
block|{
case|case
name|BWN_PHYTYPE_A
case|:
if|if
condition|(
name|rev
operator|<
literal|5
operator|||
name|rev
operator|>
literal|10
condition|)
goto|goto
name|fail1
goto|;
if|if
condition|(
name|high
operator|&
name|BWN_TGSHIGH_HAVE_2GHZ
condition|)
name|filename
operator|=
literal|"a0g1initvals5"
expr_stmt|;
else|else
name|filename
operator|=
literal|"a0g0initvals5"
expr_stmt|;
break|break;
case|case
name|BWN_PHYTYPE_G
case|:
if|if
condition|(
name|rev
operator|>=
literal|5
operator|&&
name|rev
operator|<=
literal|10
condition|)
name|filename
operator|=
literal|"b0g0initvals5"
expr_stmt|;
elseif|else
if|if
condition|(
name|rev
operator|>=
literal|13
condition|)
name|filename
operator|=
literal|"b0g0initvals13"
expr_stmt|;
else|else
goto|goto
name|fail1
goto|;
break|break;
case|case
name|BWN_PHYTYPE_LP
case|:
if|if
condition|(
name|rev
operator|==
literal|13
condition|)
name|filename
operator|=
literal|"lp0initvals13"
expr_stmt|;
elseif|else
if|if
condition|(
name|rev
operator|==
literal|14
condition|)
name|filename
operator|=
literal|"lp0initvals14"
expr_stmt|;
elseif|else
if|if
condition|(
name|rev
operator|>=
literal|15
condition|)
name|filename
operator|=
literal|"lp0initvals15"
expr_stmt|;
else|else
goto|goto
name|fail1
goto|;
break|break;
case|case
name|BWN_PHYTYPE_N
case|:
if|if
condition|(
name|rev
operator|==
literal|30
condition|)
name|filename
operator|=
literal|"n16initvals30"
expr_stmt|;
elseif|else
if|if
condition|(
name|rev
operator|==
literal|28
operator|||
name|rev
operator|==
literal|25
condition|)
name|filename
operator|=
literal|"n0initvals25"
expr_stmt|;
elseif|else
if|if
condition|(
name|rev
operator|==
literal|24
condition|)
name|filename
operator|=
literal|"n0initvals24"
expr_stmt|;
elseif|else
if|if
condition|(
name|rev
operator|==
literal|23
condition|)
name|filename
operator|=
literal|"n0initvals16"
expr_stmt|;
elseif|else
if|if
condition|(
name|rev
operator|>=
literal|16
operator|&&
name|rev
operator|<=
literal|18
condition|)
name|filename
operator|=
literal|"n0initvals16"
expr_stmt|;
elseif|else
if|if
condition|(
name|rev
operator|>=
literal|11
operator|&&
name|rev
operator|<=
literal|12
condition|)
name|filename
operator|=
literal|"n0initvals11"
expr_stmt|;
else|else
goto|goto
name|fail1
goto|;
break|break;
default|default:
goto|goto
name|fail1
goto|;
block|}
name|error
operator|=
name|bwn_fw_get
argument_list|(
name|mac
argument_list|,
name|type
argument_list|,
name|filename
argument_list|,
operator|&
name|fw
operator|->
name|initvals
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|bwn_release_firmware
argument_list|(
name|mac
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
comment|/* bandswitch initvals */
switch|switch
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|type
condition|)
block|{
case|case
name|BWN_PHYTYPE_A
case|:
if|if
condition|(
name|rev
operator|>=
literal|5
operator|&&
name|rev
operator|<=
literal|10
condition|)
block|{
if|if
condition|(
name|high
operator|&
name|BWN_TGSHIGH_HAVE_2GHZ
condition|)
name|filename
operator|=
literal|"a0g1bsinitvals5"
expr_stmt|;
else|else
name|filename
operator|=
literal|"a0g0bsinitvals5"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rev
operator|>=
literal|11
condition|)
name|filename
operator|=
name|NULL
expr_stmt|;
else|else
goto|goto
name|fail1
goto|;
break|break;
case|case
name|BWN_PHYTYPE_G
case|:
if|if
condition|(
name|rev
operator|>=
literal|5
operator|&&
name|rev
operator|<=
literal|10
condition|)
name|filename
operator|=
literal|"b0g0bsinitvals5"
expr_stmt|;
elseif|else
if|if
condition|(
name|rev
operator|>=
literal|11
condition|)
name|filename
operator|=
name|NULL
expr_stmt|;
else|else
goto|goto
name|fail1
goto|;
break|break;
case|case
name|BWN_PHYTYPE_LP
case|:
if|if
condition|(
name|rev
operator|==
literal|13
condition|)
name|filename
operator|=
literal|"lp0bsinitvals13"
expr_stmt|;
elseif|else
if|if
condition|(
name|rev
operator|==
literal|14
condition|)
name|filename
operator|=
literal|"lp0bsinitvals14"
expr_stmt|;
elseif|else
if|if
condition|(
name|rev
operator|>=
literal|15
condition|)
name|filename
operator|=
literal|"lp0bsinitvals15"
expr_stmt|;
else|else
goto|goto
name|fail1
goto|;
break|break;
case|case
name|BWN_PHYTYPE_N
case|:
if|if
condition|(
name|rev
operator|==
literal|30
condition|)
name|filename
operator|=
literal|"n16bsinitvals30"
expr_stmt|;
elseif|else
if|if
condition|(
name|rev
operator|==
literal|28
operator|||
name|rev
operator|==
literal|25
condition|)
name|filename
operator|=
literal|"n0bsinitvals25"
expr_stmt|;
elseif|else
if|if
condition|(
name|rev
operator|==
literal|24
condition|)
name|filename
operator|=
literal|"n0bsinitvals24"
expr_stmt|;
elseif|else
if|if
condition|(
name|rev
operator|==
literal|23
condition|)
name|filename
operator|=
literal|"n0bsinitvals16"
expr_stmt|;
elseif|else
if|if
condition|(
name|rev
operator|>=
literal|16
operator|&&
name|rev
operator|<=
literal|18
condition|)
name|filename
operator|=
literal|"n0bsinitvals16"
expr_stmt|;
elseif|else
if|if
condition|(
name|rev
operator|>=
literal|11
operator|&&
name|rev
operator|<=
literal|12
condition|)
name|filename
operator|=
literal|"n0bsinitvals11"
expr_stmt|;
else|else
goto|goto
name|fail1
goto|;
break|break;
default|default:
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"unknown phy (%d)\n"
argument_list|,
name|mac
operator|->
name|mac_phy
operator|.
name|type
argument_list|)
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
name|error
operator|=
name|bwn_fw_get
argument_list|(
name|mac
argument_list|,
name|type
argument_list|,
name|filename
argument_list|,
operator|&
name|fw
operator|->
name|initvals_band
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|bwn_release_firmware
argument_list|(
name|mac
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|fail1
label|:
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"no INITVALS for rev %d, phy.type %d\n"
argument_list|,
name|rev
argument_list|,
name|mac
operator|->
name|mac_phy
operator|.
name|type
argument_list|)
expr_stmt|;
name|bwn_release_firmware
argument_list|(
name|mac
argument_list|)
expr_stmt|;
return|return
operator|(
name|EOPNOTSUPP
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bwn_fw_get
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|enum
name|bwn_fwtype
name|type
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|struct
name|bwn_fwfile
modifier|*
name|bfw
parameter_list|)
block|{
specifier|const
name|struct
name|bwn_fwhdr
modifier|*
name|hdr
decl_stmt|;
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
specifier|const
name|struct
name|firmware
modifier|*
name|fw
decl_stmt|;
name|char
name|namebuf
index|[
literal|64
index|]
decl_stmt|;
if|if
condition|(
name|name
operator|==
name|NULL
condition|)
block|{
name|bwn_do_release_fw
argument_list|(
name|bfw
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|bfw
operator|->
name|filename
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|bfw
operator|->
name|type
operator|==
name|type
operator|&&
operator|(
name|strcmp
argument_list|(
name|bfw
operator|->
name|filename
argument_list|,
name|name
argument_list|)
operator|==
literal|0
operator|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|bwn_do_release_fw
argument_list|(
name|bfw
argument_list|)
expr_stmt|;
block|}
name|snprintf
argument_list|(
name|namebuf
argument_list|,
sizeof|sizeof
argument_list|(
name|namebuf
argument_list|)
argument_list|,
literal|"bwn%s_v4_%s%s"
argument_list|,
operator|(
name|type
operator|==
name|BWN_FWTYPE_OPENSOURCE
operator|)
condition|?
literal|"-open"
else|:
literal|""
argument_list|,
operator|(
name|mac
operator|->
name|mac_phy
operator|.
name|type
operator|==
name|BWN_PHYTYPE_LP
operator|)
condition|?
literal|"lp_"
else|:
literal|""
argument_list|,
name|name
argument_list|)
expr_stmt|;
comment|/* XXX Sleeping on "fwload" with the non-sleepable locks held */
name|fw
operator|=
name|firmware_get
argument_list|(
name|namebuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|fw
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"the fw file(%s) not found\n"
argument_list|,
name|namebuf
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOENT
operator|)
return|;
block|}
if|if
condition|(
name|fw
operator|->
name|datasize
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|bwn_fwhdr
argument_list|)
condition|)
goto|goto
name|fail
goto|;
name|hdr
operator|=
operator|(
specifier|const
expr|struct
name|bwn_fwhdr
operator|*
operator|)
operator|(
name|fw
operator|->
name|data
operator|)
expr_stmt|;
switch|switch
condition|(
name|hdr
operator|->
name|type
condition|)
block|{
case|case
name|BWN_FWTYPE_UCODE
case|:
case|case
name|BWN_FWTYPE_PCM
case|:
if|if
condition|(
name|be32toh
argument_list|(
name|hdr
operator|->
name|size
argument_list|)
operator|!=
operator|(
name|fw
operator|->
name|datasize
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|bwn_fwhdr
argument_list|)
operator|)
condition|)
goto|goto
name|fail
goto|;
comment|/* FALLTHROUGH */
case|case
name|BWN_FWTYPE_IV
case|:
if|if
condition|(
name|hdr
operator|->
name|ver
operator|!=
literal|1
condition|)
goto|goto
name|fail
goto|;
break|break;
default|default:
goto|goto
name|fail
goto|;
block|}
name|bfw
operator|->
name|filename
operator|=
name|name
expr_stmt|;
name|bfw
operator|->
name|fw
operator|=
name|fw
expr_stmt|;
name|bfw
operator|->
name|type
operator|=
name|type
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail
label|:
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"the fw file(%s) format error\n"
argument_list|,
name|namebuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|fw
operator|!=
name|NULL
condition|)
name|firmware_put
argument_list|(
name|fw
argument_list|,
name|FIRMWARE_UNLOAD
argument_list|)
expr_stmt|;
return|return
operator|(
name|EPROTO
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_release_firmware
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|bwn_do_release_fw
argument_list|(
operator|&
name|mac
operator|->
name|mac_fw
operator|.
name|ucode
argument_list|)
expr_stmt|;
name|bwn_do_release_fw
argument_list|(
operator|&
name|mac
operator|->
name|mac_fw
operator|.
name|pcm
argument_list|)
expr_stmt|;
name|bwn_do_release_fw
argument_list|(
operator|&
name|mac
operator|->
name|mac_fw
operator|.
name|initvals
argument_list|)
expr_stmt|;
name|bwn_do_release_fw
argument_list|(
operator|&
name|mac
operator|->
name|mac_fw
operator|.
name|initvals_band
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_do_release_fw
parameter_list|(
name|struct
name|bwn_fwfile
modifier|*
name|bfw
parameter_list|)
block|{
if|if
condition|(
name|bfw
operator|->
name|fw
operator|!=
name|NULL
condition|)
name|firmware_put
argument_list|(
name|bfw
operator|->
name|fw
argument_list|,
name|FIRMWARE_UNLOAD
argument_list|)
expr_stmt|;
name|bfw
operator|->
name|fw
operator|=
name|NULL
expr_stmt|;
name|bfw
operator|->
name|filename
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|bwn_fw_loaducode
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
define|#
directive|define
name|GETFWOFFSET
parameter_list|(
name|fwp
parameter_list|,
name|offset
parameter_list|)
define|\
value|((const uint32_t *)((const char *)fwp.fw->data + offset))
define|#
directive|define
name|GETFWSIZE
parameter_list|(
name|fwp
parameter_list|,
name|offset
parameter_list|)
define|\
value|((fwp.fw->datasize - offset) / sizeof(uint32_t))
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
specifier|const
name|uint32_t
modifier|*
name|data
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
name|uint32_t
name|ctl
decl_stmt|;
name|uint16_t
name|date
decl_stmt|,
name|fwcaps
decl_stmt|,
name|time
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|ctl
operator|=
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCTL
argument_list|)
expr_stmt|;
name|ctl
operator||=
name|BWN_MACCTL_MCODE_JMP0
expr_stmt|;
name|KASSERT
argument_list|(
operator|!
operator|(
name|ctl
operator|&
name|BWN_MACCTL_MCODE_RUN
operator|)
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCTL
argument_list|,
name|ctl
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|64
condition|;
name|i
operator|++
control|)
name|bwn_shm_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_SCRATCH
argument_list|,
name|i
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4096
condition|;
name|i
operator|+=
literal|2
control|)
name|bwn_shm_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
name|i
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|data
operator|=
name|GETFWOFFSET
argument_list|(
name|mac
operator|->
name|mac_fw
operator|.
name|ucode
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|bwn_fwhdr
argument_list|)
argument_list|)
expr_stmt|;
name|bwn_shm_ctlword
argument_list|(
name|mac
argument_list|,
name|BWN_UCODE
operator||
name|BWN_SHARED_AUTOINC
argument_list|,
literal|0x0000
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|GETFWSIZE
argument_list|(
name|mac
operator|->
name|mac_fw
operator|.
name|ucode
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|bwn_fwhdr
argument_list|)
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
name|BWN_SHM_DATA
argument_list|,
name|be32toh
argument_list|(
name|data
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mac
operator|->
name|mac_fw
operator|.
name|pcm
operator|.
name|fw
condition|)
block|{
name|data
operator|=
name|GETFWOFFSET
argument_list|(
name|mac
operator|->
name|mac_fw
operator|.
name|pcm
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|bwn_fwhdr
argument_list|)
argument_list|)
expr_stmt|;
name|bwn_shm_ctlword
argument_list|(
name|mac
argument_list|,
name|BWN_HW
argument_list|,
literal|0x01ea
argument_list|)
expr_stmt|;
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
name|BWN_SHM_DATA
argument_list|,
literal|0x00004000
argument_list|)
expr_stmt|;
name|bwn_shm_ctlword
argument_list|(
name|mac
argument_list|,
name|BWN_HW
argument_list|,
literal|0x01eb
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|GETFWSIZE
argument_list|(
name|mac
operator|->
name|mac_fw
operator|.
name|pcm
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|bwn_fwhdr
argument_list|)
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
name|BWN_SHM_DATA
argument_list|,
name|be32toh
argument_list|(
name|data
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
block|}
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
name|BWN_INTR_REASON
argument_list|,
name|BWN_INTR_ALL
argument_list|)
expr_stmt|;
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCTL
argument_list|,
operator|(
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCTL
argument_list|)
operator|&
operator|~
name|BWN_MACCTL_MCODE_JMP0
operator|)
operator||
name|BWN_MACCTL_MCODE_RUN
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|21
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|BWN_INTR_REASON
argument_list|)
operator|==
name|BWN_INTR_MAC_SUSPENDED
condition|)
break|break;
if|if
condition|(
name|i
operator|>=
literal|20
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"ucode timeout\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENXIO
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|DELAY
argument_list|(
literal|50000
argument_list|)
expr_stmt|;
block|}
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|BWN_INTR_REASON
argument_list|)
expr_stmt|;
name|mac
operator|->
name|mac_fw
operator|.
name|rev
operator|=
name|bwn_shm_read_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
name|BWN_SHARED_UCODE_REV
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_fw
operator|.
name|rev
operator|<=
literal|0x128
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"the firmware is too old\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|EOPNOTSUPP
expr_stmt|;
goto|goto
name|error
goto|;
block|}
comment|/* 	 * Determine firmware header version; needed for TX/RX packet 	 * handling. 	 */
if|if
condition|(
name|mac
operator|->
name|mac_fw
operator|.
name|rev
operator|>=
literal|598
condition|)
name|mac
operator|->
name|mac_fw
operator|.
name|fw_hdr_format
operator|=
name|BWN_FW_HDR_598
expr_stmt|;
elseif|else
if|if
condition|(
name|mac
operator|->
name|mac_fw
operator|.
name|rev
operator|>=
literal|410
condition|)
name|mac
operator|->
name|mac_fw
operator|.
name|fw_hdr_format
operator|=
name|BWN_FW_HDR_410
expr_stmt|;
else|else
name|mac
operator|->
name|mac_fw
operator|.
name|fw_hdr_format
operator|=
name|BWN_FW_HDR_351
expr_stmt|;
comment|/* 	 * We don't support rev 598 or later; that requires 	 * another round of changes to the TX/RX descriptor 	 * and status layout. 	 * 	 * So, complain this is the case and exit out, rather 	 * than attaching and then failing. 	 */
if|if
condition|(
name|mac
operator|->
name|mac_fw
operator|.
name|fw_hdr_format
operator|==
name|BWN_FW_HDR_598
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"firmware is too new (>=598); not supported\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|EOPNOTSUPP
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|mac
operator|->
name|mac_fw
operator|.
name|patch
operator|=
name|bwn_shm_read_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
name|BWN_SHARED_UCODE_PATCH
argument_list|)
expr_stmt|;
name|date
operator|=
name|bwn_shm_read_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
name|BWN_SHARED_UCODE_DATE
argument_list|)
expr_stmt|;
name|mac
operator|->
name|mac_fw
operator|.
name|opensource
operator|=
operator|(
name|date
operator|==
literal|0xffff
operator|)
expr_stmt|;
if|if
condition|(
name|bwn_wme
operator|!=
literal|0
condition|)
name|mac
operator|->
name|mac_flags
operator||=
name|BWN_MAC_FLAG_WME
expr_stmt|;
name|mac
operator|->
name|mac_flags
operator||=
name|BWN_MAC_FLAG_HWCRYPTO
expr_stmt|;
name|time
operator|=
name|bwn_shm_read_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
name|BWN_SHARED_UCODE_TIME
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_fw
operator|.
name|opensource
operator|==
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"firmware version (rev %u patch %u date %#x time %#x)\n"
argument_list|,
name|mac
operator|->
name|mac_fw
operator|.
name|rev
argument_list|,
name|mac
operator|->
name|mac_fw
operator|.
name|patch
argument_list|,
name|date
argument_list|,
name|time
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_fw
operator|.
name|no_pcmfile
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"no HW crypto acceleration due to pcm5\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|mac
operator|->
name|mac_fw
operator|.
name|patch
operator|=
name|time
expr_stmt|;
name|fwcaps
operator|=
name|bwn_fwcaps_read
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|fwcaps
operator|&
name|BWN_FWCAPS_HWCRYPTO
operator|)
operator|||
name|mac
operator|->
name|mac_fw
operator|.
name|no_pcmfile
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"disabling HW crypto acceleration\n"
argument_list|)
expr_stmt|;
name|mac
operator|->
name|mac_flags
operator|&=
operator|~
name|BWN_MAC_FLAG_HWCRYPTO
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|(
name|fwcaps
operator|&
name|BWN_FWCAPS_WME
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"disabling WME support\n"
argument_list|)
expr_stmt|;
name|mac
operator|->
name|mac_flags
operator|&=
operator|~
name|BWN_MAC_FLAG_WME
expr_stmt|;
block|}
block|}
if|if
condition|(
name|BWN_ISOLDFMT
argument_list|(
name|mac
argument_list|)
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"using old firmware image\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|error
label|:
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCTL
argument_list|,
operator|(
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCTL
argument_list|)
operator|&
operator|~
name|BWN_MACCTL_MCODE_RUN
operator|)
operator||
name|BWN_MACCTL_MCODE_JMP0
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
undef|#
directive|undef
name|GETFWSIZE
undef|#
directive|undef
name|GETFWOFFSET
block|}
end_function

begin_comment
comment|/* OpenFirmware only */
end_comment

begin_function
specifier|static
name|uint16_t
name|bwn_fwcaps_read
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|KASSERT
argument_list|(
name|mac
operator|->
name|mac_fw
operator|.
name|opensource
operator|==
literal|1
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|bwn_shm_read_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
name|BWN_SHARED_FWCAPS
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bwn_fwinitvals_write
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
specifier|const
name|struct
name|bwn_fwinitvals
modifier|*
name|ivals
parameter_list|,
name|size_t
name|count
parameter_list|,
name|size_t
name|array_size
parameter_list|)
block|{
define|#
directive|define
name|GET_NEXTIV16
parameter_list|(
name|iv
parameter_list|)
define|\
value|((const struct bwn_fwinitvals *)((const uint8_t *)(iv) +	\ 	    sizeof(uint16_t) + sizeof(uint16_t)))
define|#
directive|define
name|GET_NEXTIV32
parameter_list|(
name|iv
parameter_list|)
define|\
value|((const struct bwn_fwinitvals *)((const uint8_t *)(iv) +	\ 	    sizeof(uint16_t) + sizeof(uint32_t)))
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
specifier|const
name|struct
name|bwn_fwinitvals
modifier|*
name|iv
decl_stmt|;
name|uint16_t
name|offset
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|uint8_t
name|bit32
decl_stmt|;
name|KASSERT
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|bwn_fwinitvals
argument_list|)
operator|==
literal|6
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
name|iv
operator|=
name|ivals
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|array_size
operator|<
sizeof|sizeof
argument_list|(
name|iv
operator|->
name|offset_size
argument_list|)
condition|)
goto|goto
name|fail
goto|;
name|array_size
operator|-=
sizeof|sizeof
argument_list|(
name|iv
operator|->
name|offset_size
argument_list|)
expr_stmt|;
name|offset
operator|=
name|be16toh
argument_list|(
name|iv
operator|->
name|offset_size
argument_list|)
expr_stmt|;
name|bit32
operator|=
operator|(
name|offset
operator|&
name|BWN_FWINITVALS_32BIT
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|offset
operator|&=
name|BWN_FWINITVALS_OFFSET_MASK
expr_stmt|;
if|if
condition|(
name|offset
operator|>=
literal|0x1000
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|bit32
condition|)
block|{
if|if
condition|(
name|array_size
operator|<
sizeof|sizeof
argument_list|(
name|iv
operator|->
name|data
operator|.
name|d32
argument_list|)
condition|)
goto|goto
name|fail
goto|;
name|array_size
operator|-=
sizeof|sizeof
argument_list|(
name|iv
operator|->
name|data
operator|.
name|d32
argument_list|)
expr_stmt|;
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
name|offset
argument_list|,
name|be32toh
argument_list|(
name|iv
operator|->
name|data
operator|.
name|d32
argument_list|)
argument_list|)
expr_stmt|;
name|iv
operator|=
name|GET_NEXTIV32
argument_list|(
name|iv
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|array_size
operator|<
sizeof|sizeof
argument_list|(
name|iv
operator|->
name|data
operator|.
name|d16
argument_list|)
condition|)
goto|goto
name|fail
goto|;
name|array_size
operator|-=
sizeof|sizeof
argument_list|(
name|iv
operator|->
name|data
operator|.
name|d16
argument_list|)
expr_stmt|;
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
name|offset
argument_list|,
name|be16toh
argument_list|(
name|iv
operator|->
name|data
operator|.
name|d16
argument_list|)
argument_list|)
expr_stmt|;
name|iv
operator|=
name|GET_NEXTIV16
argument_list|(
name|iv
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|array_size
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail
label|:
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"initvals: invalid format\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EPROTO
operator|)
return|;
undef|#
directive|undef
name|GET_NEXTIV16
undef|#
directive|undef
name|GET_NEXTIV32
block|}
end_function

begin_function
name|int
name|bwn_switch_channel
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|int
name|chan
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
operator|(
name|mac
operator|->
name|mac_phy
operator|)
decl_stmt|;
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
name|uint16_t
name|channelcookie
decl_stmt|,
name|savedcookie
decl_stmt|;
name|int
name|error
decl_stmt|;
if|if
condition|(
name|chan
operator|==
literal|0xffff
condition|)
name|chan
operator|=
name|phy
operator|->
name|get_default_chan
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|channelcookie
operator|=
name|chan
expr_stmt|;
if|if
condition|(
name|IEEE80211_IS_CHAN_5GHZ
argument_list|(
name|ic
operator|->
name|ic_curchan
argument_list|)
condition|)
name|channelcookie
operator||=
literal|0x100
expr_stmt|;
name|savedcookie
operator|=
name|bwn_shm_read_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
name|BWN_SHARED_CHAN
argument_list|)
expr_stmt|;
name|bwn_shm_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
name|BWN_SHARED_CHAN
argument_list|,
name|channelcookie
argument_list|)
expr_stmt|;
name|error
operator|=
name|phy
operator|->
name|switch_channel
argument_list|(
name|mac
argument_list|,
name|chan
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
name|mac
operator|->
name|mac_phy
operator|.
name|chan
operator|=
name|chan
expr_stmt|;
name|DELAY
argument_list|(
literal|8000
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail
label|:
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"failed to switch channel\n"
argument_list|)
expr_stmt|;
name|bwn_shm_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
name|BWN_SHARED_CHAN
argument_list|,
name|savedcookie
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint16_t
name|bwn_ant2phy
parameter_list|(
name|int
name|antenna
parameter_list|)
block|{
switch|switch
condition|(
name|antenna
condition|)
block|{
case|case
name|BWN_ANT0
case|:
return|return
operator|(
name|BWN_TX_PHY_ANT0
operator|)
return|;
case|case
name|BWN_ANT1
case|:
return|return
operator|(
name|BWN_TX_PHY_ANT1
operator|)
return|;
case|case
name|BWN_ANT2
case|:
return|return
operator|(
name|BWN_TX_PHY_ANT2
operator|)
return|;
case|case
name|BWN_ANT3
case|:
return|return
operator|(
name|BWN_TX_PHY_ANT3
operator|)
return|;
case|case
name|BWN_ANTAUTO
case|:
return|return
operator|(
name|BWN_TX_PHY_ANT01AUTO
operator|)
return|;
block|}
name|KASSERT
argument_list|(
literal|0
operator|==
literal|1
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_wme_load
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|int
name|i
decl_stmt|;
name|KASSERT
argument_list|(
name|N
argument_list|(
name|bwn_wme_shm_offsets
argument_list|)
operator|==
name|N
argument_list|(
name|sc
operator|->
name|sc_wmeParams
argument_list|)
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
name|bwn_mac_suspend
argument_list|(
name|mac
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|N
argument_list|(
name|sc
operator|->
name|sc_wmeParams
argument_list|)
condition|;
name|i
operator|++
control|)
name|bwn_wme_loadparams
argument_list|(
name|mac
argument_list|,
operator|&
operator|(
name|sc
operator|->
name|sc_wmeParams
index|[
name|i
index|]
operator|)
argument_list|,
name|bwn_wme_shm_offsets
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|bwn_mac_enable
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_wme_loadparams
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
specifier|const
name|struct
name|wmeParams
modifier|*
name|p
parameter_list|,
name|uint16_t
name|shm_offset
parameter_list|)
block|{
define|#
directive|define
name|SM
parameter_list|(
name|_v
parameter_list|,
name|_f
parameter_list|)
value|(((_v)<< _f##_S)& _f)
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|uint16_t
name|params
index|[
name|BWN_NR_WMEPARAMS
index|]
decl_stmt|;
name|int
name|slot
decl_stmt|,
name|tmp
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
name|slot
operator|=
name|BWN_READ_2
argument_list|(
name|mac
argument_list|,
name|BWN_RNG
argument_list|)
operator|&
name|SM
argument_list|(
name|p
operator|->
name|wmep_logcwmin
argument_list|,
name|WME_PARAM_LOGCWMIN
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|params
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|params
argument_list|)
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
name|sc
argument_list|,
name|BWN_DEBUG_WME
argument_list|,
literal|"wmep_txopLimit %d wmep_logcwmin %d "
literal|"wmep_logcwmax %d wmep_aifsn %d\n"
argument_list|,
name|p
operator|->
name|wmep_txopLimit
argument_list|,
name|p
operator|->
name|wmep_logcwmin
argument_list|,
name|p
operator|->
name|wmep_logcwmax
argument_list|,
name|p
operator|->
name|wmep_aifsn
argument_list|)
expr_stmt|;
name|params
index|[
name|BWN_WMEPARAM_TXOP
index|]
operator|=
name|p
operator|->
name|wmep_txopLimit
operator|*
literal|32
expr_stmt|;
name|params
index|[
name|BWN_WMEPARAM_CWMIN
index|]
operator|=
name|SM
argument_list|(
name|p
operator|->
name|wmep_logcwmin
argument_list|,
name|WME_PARAM_LOGCWMIN
argument_list|)
expr_stmt|;
name|params
index|[
name|BWN_WMEPARAM_CWMAX
index|]
operator|=
name|SM
argument_list|(
name|p
operator|->
name|wmep_logcwmax
argument_list|,
name|WME_PARAM_LOGCWMAX
argument_list|)
expr_stmt|;
name|params
index|[
name|BWN_WMEPARAM_CWCUR
index|]
operator|=
name|SM
argument_list|(
name|p
operator|->
name|wmep_logcwmin
argument_list|,
name|WME_PARAM_LOGCWMIN
argument_list|)
expr_stmt|;
name|params
index|[
name|BWN_WMEPARAM_AIFS
index|]
operator|=
name|p
operator|->
name|wmep_aifsn
expr_stmt|;
name|params
index|[
name|BWN_WMEPARAM_BSLOTS
index|]
operator|=
name|slot
expr_stmt|;
name|params
index|[
name|BWN_WMEPARAM_REGGAP
index|]
operator|=
name|slot
operator|+
name|p
operator|->
name|wmep_aifsn
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|N
argument_list|(
name|params
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|==
name|BWN_WMEPARAM_STATUS
condition|)
block|{
name|tmp
operator|=
name|bwn_shm_read_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
name|shm_offset
operator|+
operator|(
name|i
operator|*
literal|2
operator|)
argument_list|)
expr_stmt|;
name|tmp
operator||=
literal|0x100
expr_stmt|;
name|bwn_shm_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
name|shm_offset
operator|+
operator|(
name|i
operator|*
literal|2
operator|)
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|bwn_shm_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
name|shm_offset
operator|+
operator|(
name|i
operator|*
literal|2
operator|)
argument_list|,
name|params
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_mac_write_bssid
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
name|int
name|i
decl_stmt|;
name|uint8_t
name|mac_bssid
index|[
name|IEEE80211_ADDR_LEN
operator|*
literal|2
index|]
decl_stmt|;
name|bwn_mac_setfilter
argument_list|(
name|mac
argument_list|,
name|BWN_MACFILTER_BSSID
argument_list|,
name|sc
operator|->
name|sc_bssid
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|mac_bssid
argument_list|,
name|sc
operator|->
name|sc_ic
operator|.
name|ic_macaddr
argument_list|,
name|IEEE80211_ADDR_LEN
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|mac_bssid
operator|+
name|IEEE80211_ADDR_LEN
argument_list|,
name|sc
operator|->
name|sc_bssid
argument_list|,
name|IEEE80211_ADDR_LEN
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|N
argument_list|(
name|mac_bssid
argument_list|)
condition|;
name|i
operator|+=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
control|)
block|{
name|tmp
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|mac_bssid
index|[
name|i
operator|+
literal|0
index|]
argument_list|)
expr_stmt|;
name|tmp
operator||=
call|(
name|uint32_t
call|)
argument_list|(
name|mac_bssid
index|[
name|i
operator|+
literal|1
index|]
argument_list|)
operator|<<
literal|8
expr_stmt|;
name|tmp
operator||=
call|(
name|uint32_t
call|)
argument_list|(
name|mac_bssid
index|[
name|i
operator|+
literal|2
index|]
argument_list|)
operator|<<
literal|16
expr_stmt|;
name|tmp
operator||=
call|(
name|uint32_t
call|)
argument_list|(
name|mac_bssid
index|[
name|i
operator|+
literal|3
index|]
argument_list|)
operator|<<
literal|24
expr_stmt|;
name|bwn_ram_write
argument_list|(
name|mac
argument_list|,
literal|0x20
operator|+
name|i
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_mac_setfilter
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint16_t
name|offset
parameter_list|,
specifier|const
name|uint8_t
modifier|*
name|macaddr
parameter_list|)
block|{
specifier|static
specifier|const
name|uint8_t
name|zero
index|[
name|IEEE80211_ADDR_LEN
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
name|uint16_t
name|data
decl_stmt|;
if|if
condition|(
operator|!
name|mac
condition|)
name|macaddr
operator|=
name|zero
expr_stmt|;
name|offset
operator||=
literal|0x0020
expr_stmt|;
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
name|BWN_MACFILTER_CONTROL
argument_list|,
name|offset
argument_list|)
expr_stmt|;
name|data
operator|=
name|macaddr
index|[
literal|0
index|]
expr_stmt|;
name|data
operator||=
name|macaddr
index|[
literal|1
index|]
operator|<<
literal|8
expr_stmt|;
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
name|BWN_MACFILTER_DATA
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|data
operator|=
name|macaddr
index|[
literal|2
index|]
expr_stmt|;
name|data
operator||=
name|macaddr
index|[
literal|3
index|]
operator|<<
literal|8
expr_stmt|;
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
name|BWN_MACFILTER_DATA
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|data
operator|=
name|macaddr
index|[
literal|4
index|]
expr_stmt|;
name|data
operator||=
name|macaddr
index|[
literal|5
index|]
operator|<<
literal|8
expr_stmt|;
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
name|BWN_MACFILTER_DATA
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_key_dowrite
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint8_t
name|index
parameter_list|,
name|uint8_t
name|algorithm
parameter_list|,
specifier|const
name|uint8_t
modifier|*
name|key
parameter_list|,
name|size_t
name|key_len
parameter_list|,
specifier|const
name|uint8_t
modifier|*
name|mac_addr
parameter_list|)
block|{
name|uint8_t
name|buf
index|[
name|BWN_SEC_KEYSIZE
index|]
init|=
block|{
literal|0
block|, }
decl_stmt|;
name|uint8_t
name|per_sta_keys_start
init|=
literal|8
decl_stmt|;
if|if
condition|(
name|BWN_SEC_NEWAPI
argument_list|(
name|mac
argument_list|)
condition|)
name|per_sta_keys_start
operator|=
literal|4
expr_stmt|;
name|KASSERT
argument_list|(
name|index
operator|<
name|mac
operator|->
name|mac_max_nr_keys
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|key_len
operator|<=
name|BWN_SEC_KEYSIZE
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|index
operator|>=
name|per_sta_keys_start
condition|)
name|bwn_key_macwrite
argument_list|(
name|mac
argument_list|,
name|index
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|key
condition|)
name|memcpy
argument_list|(
name|buf
argument_list|,
name|key
argument_list|,
name|key_len
argument_list|)
expr_stmt|;
name|bwn_key_write
argument_list|(
name|mac
argument_list|,
name|index
argument_list|,
name|algorithm
argument_list|,
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|index
operator|>=
name|per_sta_keys_start
condition|)
name|bwn_key_macwrite
argument_list|(
name|mac
argument_list|,
name|index
argument_list|,
name|mac_addr
argument_list|)
expr_stmt|;
name|mac
operator|->
name|mac_key
index|[
name|index
index|]
operator|.
name|algorithm
operator|=
name|algorithm
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_key_macwrite
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint8_t
name|index
parameter_list|,
specifier|const
name|uint8_t
modifier|*
name|addr
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|uint32_t
name|addrtmp
index|[
literal|2
index|]
init|=
block|{
literal|0
block|,
literal|0
block|}
decl_stmt|;
name|uint8_t
name|start
init|=
literal|8
decl_stmt|;
if|if
condition|(
name|BWN_SEC_NEWAPI
argument_list|(
name|mac
argument_list|)
condition|)
name|start
operator|=
literal|4
expr_stmt|;
name|KASSERT
argument_list|(
name|index
operator|>=
name|start
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
name|index
operator|-=
name|start
expr_stmt|;
if|if
condition|(
name|addr
condition|)
block|{
name|addrtmp
index|[
literal|0
index|]
operator|=
name|addr
index|[
literal|0
index|]
expr_stmt|;
name|addrtmp
index|[
literal|0
index|]
operator||=
operator|(
call|(
name|uint32_t
call|)
argument_list|(
name|addr
index|[
literal|1
index|]
argument_list|)
operator|<<
literal|8
operator|)
expr_stmt|;
name|addrtmp
index|[
literal|0
index|]
operator||=
operator|(
call|(
name|uint32_t
call|)
argument_list|(
name|addr
index|[
literal|2
index|]
argument_list|)
operator|<<
literal|16
operator|)
expr_stmt|;
name|addrtmp
index|[
literal|0
index|]
operator||=
operator|(
call|(
name|uint32_t
call|)
argument_list|(
name|addr
index|[
literal|3
index|]
argument_list|)
operator|<<
literal|24
operator|)
expr_stmt|;
name|addrtmp
index|[
literal|1
index|]
operator|=
name|addr
index|[
literal|4
index|]
expr_stmt|;
name|addrtmp
index|[
literal|1
index|]
operator||=
operator|(
call|(
name|uint32_t
call|)
argument_list|(
name|addr
index|[
literal|5
index|]
argument_list|)
operator|<<
literal|8
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|siba_get_revid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|>=
literal|5
condition|)
block|{
name|bwn_shm_write_4
argument_list|(
name|mac
argument_list|,
name|BWN_RCMTA
argument_list|,
operator|(
name|index
operator|*
literal|2
operator|)
operator|+
literal|0
argument_list|,
name|addrtmp
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|bwn_shm_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_RCMTA
argument_list|,
operator|(
name|index
operator|*
literal|2
operator|)
operator|+
literal|1
argument_list|,
name|addrtmp
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|index
operator|>=
literal|8
condition|)
block|{
name|bwn_shm_write_4
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
name|BWN_SHARED_PSM
operator|+
operator|(
name|index
operator|*
literal|6
operator|)
operator|+
literal|0
argument_list|,
name|addrtmp
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|bwn_shm_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
name|BWN_SHARED_PSM
operator|+
operator|(
name|index
operator|*
literal|6
operator|)
operator|+
literal|4
argument_list|,
name|addrtmp
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_key_write
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint8_t
name|index
parameter_list|,
name|uint8_t
name|algorithm
parameter_list|,
specifier|const
name|uint8_t
modifier|*
name|key
parameter_list|)
block|{
name|unsigned
name|int
name|i
decl_stmt|;
name|uint32_t
name|offset
decl_stmt|;
name|uint16_t
name|kidx
decl_stmt|,
name|value
decl_stmt|;
name|kidx
operator|=
name|BWN_SEC_KEY2FW
argument_list|(
name|mac
argument_list|,
name|index
argument_list|)
expr_stmt|;
name|bwn_shm_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
name|BWN_SHARED_KEYIDX_BLOCK
operator|+
operator|(
name|kidx
operator|*
literal|2
operator|)
argument_list|,
operator|(
name|kidx
operator|<<
literal|4
operator|)
operator||
name|algorithm
argument_list|)
expr_stmt|;
name|offset
operator|=
name|mac
operator|->
name|mac_ktp
operator|+
operator|(
name|index
operator|*
name|BWN_SEC_KEYSIZE
operator|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|BWN_SEC_KEYSIZE
condition|;
name|i
operator|+=
literal|2
control|)
block|{
name|value
operator|=
name|key
index|[
name|i
index|]
expr_stmt|;
name|value
operator||=
call|(
name|uint16_t
call|)
argument_list|(
name|key
index|[
name|i
operator|+
literal|1
index|]
argument_list|)
operator|<<
literal|8
expr_stmt|;
name|bwn_shm_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
name|offset
operator|+
name|i
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_phy_exit
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|mac
operator|->
name|mac_phy
operator|.
name|rf_onoff
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|exit
operator|!=
name|NULL
condition|)
name|mac
operator|->
name|mac_phy
operator|.
name|exit
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_dma_free
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_dma
modifier|*
name|dma
decl_stmt|;
if|if
condition|(
operator|(
name|mac
operator|->
name|mac_flags
operator|&
name|BWN_MAC_FLAG_DMA
operator|)
operator|==
literal|0
condition|)
return|return;
name|dma
operator|=
operator|&
name|mac
operator|->
name|mac_method
operator|.
name|dma
expr_stmt|;
name|bwn_dma_ringfree
argument_list|(
operator|&
name|dma
operator|->
name|rx
argument_list|)
expr_stmt|;
name|bwn_dma_ringfree
argument_list|(
operator|&
name|dma
operator|->
name|wme
index|[
name|WME_AC_BK
index|]
argument_list|)
expr_stmt|;
name|bwn_dma_ringfree
argument_list|(
operator|&
name|dma
operator|->
name|wme
index|[
name|WME_AC_BE
index|]
argument_list|)
expr_stmt|;
name|bwn_dma_ringfree
argument_list|(
operator|&
name|dma
operator|->
name|wme
index|[
name|WME_AC_VI
index|]
argument_list|)
expr_stmt|;
name|bwn_dma_ringfree
argument_list|(
operator|&
name|dma
operator|->
name|wme
index|[
name|WME_AC_VO
index|]
argument_list|)
expr_stmt|;
name|bwn_dma_ringfree
argument_list|(
operator|&
name|dma
operator|->
name|mcast
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_core_stop
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|BWN_ASSERT_LOCKED
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_status
operator|<
name|BWN_MAC_STATUS_STARTED
condition|)
return|return;
name|callout_stop
argument_list|(
operator|&
name|sc
operator|->
name|sc_rfswitch_ch
argument_list|)
expr_stmt|;
name|callout_stop
argument_list|(
operator|&
name|sc
operator|->
name|sc_task_ch
argument_list|)
expr_stmt|;
name|callout_stop
argument_list|(
operator|&
name|sc
operator|->
name|sc_watchdog_ch
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_watchdog_timer
operator|=
literal|0
expr_stmt|;
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
name|BWN_INTR_MASK
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|BWN_INTR_MASK
argument_list|)
expr_stmt|;
name|bwn_mac_suspend
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|mac
operator|->
name|mac_status
operator|=
name|BWN_MAC_STATUS_INITED
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|bwn_switch_band
parameter_list|(
name|struct
name|bwn_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
name|chan
parameter_list|)
block|{
name|struct
name|bwn_mac
modifier|*
name|up_dev
init|=
name|NULL
decl_stmt|;
name|struct
name|bwn_mac
modifier|*
name|down_dev
decl_stmt|;
name|struct
name|bwn_mac
modifier|*
name|mac
decl_stmt|;
name|int
name|err
decl_stmt|,
name|status
decl_stmt|;
name|uint8_t
name|gmode
decl_stmt|;
name|BWN_ASSERT_LOCKED
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|mac
argument_list|,
argument|&sc->sc_maclist
argument_list|,
argument|mac_list
argument_list|)
block|{
if|if
condition|(
name|IEEE80211_IS_CHAN_2GHZ
argument_list|(
name|chan
argument_list|)
operator|&&
name|mac
operator|->
name|mac_phy
operator|.
name|supports_2ghz
condition|)
block|{
name|up_dev
operator|=
name|mac
expr_stmt|;
name|gmode
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|IEEE80211_IS_CHAN_5GHZ
argument_list|(
name|chan
argument_list|)
operator|&&
name|mac
operator|->
name|mac_phy
operator|.
name|supports_5ghz
condition|)
block|{
name|up_dev
operator|=
name|mac
expr_stmt|;
name|gmode
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|KASSERT
argument_list|(
literal|0
operator|==
literal|1
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
if|if
condition|(
name|up_dev
operator|!=
name|NULL
condition|)
break|break;
block|}
if|if
condition|(
name|up_dev
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"Could not find a device\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENODEV
operator|)
return|;
block|}
if|if
condition|(
name|up_dev
operator|==
name|sc
operator|->
name|sc_curmac
operator|&&
name|sc
operator|->
name|sc_curmac
operator|->
name|mac_phy
operator|.
name|gmode
operator|==
name|gmode
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"switching to %s-GHz band\n"
argument_list|,
name|IEEE80211_IS_CHAN_2GHZ
argument_list|(
name|chan
argument_list|)
condition|?
literal|"2"
else|:
literal|"5"
argument_list|)
expr_stmt|;
name|down_dev
operator|=
name|sc
operator|->
name|sc_curmac
expr_stmt|;
name|status
operator|=
name|down_dev
operator|->
name|mac_status
expr_stmt|;
if|if
condition|(
name|status
operator|>=
name|BWN_MAC_STATUS_STARTED
condition|)
name|bwn_core_stop
argument_list|(
name|down_dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|>=
name|BWN_MAC_STATUS_INITED
condition|)
name|bwn_core_exit
argument_list|(
name|down_dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|down_dev
operator|!=
name|up_dev
condition|)
name|bwn_phy_reset
argument_list|(
name|down_dev
argument_list|)
expr_stmt|;
name|up_dev
operator|->
name|mac_phy
operator|.
name|gmode
operator|=
name|gmode
expr_stmt|;
if|if
condition|(
name|status
operator|>=
name|BWN_MAC_STATUS_INITED
condition|)
block|{
name|err
operator|=
name|bwn_core_init
argument_list|(
name|up_dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"fatal: failed to initialize for %s-GHz\n"
argument_list|,
name|IEEE80211_IS_CHAN_2GHZ
argument_list|(
name|chan
argument_list|)
condition|?
literal|"2"
else|:
literal|"5"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
block|}
if|if
condition|(
name|status
operator|>=
name|BWN_MAC_STATUS_STARTED
condition|)
name|bwn_core_start
argument_list|(
name|up_dev
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|up_dev
operator|->
name|mac_status
operator|==
name|status
argument_list|,
operator|(
literal|"%s: fail"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_curmac
operator|=
name|up_dev
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail
label|:
name|sc
operator|->
name|sc_curmac
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_rf_turnon
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|bwn_mac_suspend
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|mac
operator|->
name|mac_phy
operator|.
name|rf_onoff
argument_list|(
name|mac
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|mac
operator|->
name|mac_phy
operator|.
name|rf_on
operator|=
literal|1
expr_stmt|;
name|bwn_mac_enable
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_rf_turnoff
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|bwn_mac_suspend
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|mac
operator|->
name|mac_phy
operator|.
name|rf_onoff
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mac
operator|->
name|mac_phy
operator|.
name|rf_on
operator|=
literal|0
expr_stmt|;
name|bwn_mac_enable
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * SSB PHY reset.  *  * XXX TODO: BCMA PHY reset.  */
end_comment

begin_function
specifier|static
name|void
name|bwn_phy_reset
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|siba_write_4
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
name|SIBA_TGSLOW
argument_list|,
operator|(
operator|(
name|siba_read_4
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
name|SIBA_TGSLOW
argument_list|)
operator|&
operator|~
name|BWN_TGSLOW_SUPPORT_G
operator|)
operator||
name|BWN_TGSLOW_PHYRESET
operator|)
operator||
name|SIBA_TGSLOW_FGC
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
name|siba_write_4
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
name|SIBA_TGSLOW
argument_list|,
operator|(
name|siba_read_4
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
name|SIBA_TGSLOW
argument_list|)
operator|&
operator|~
name|SIBA_TGSLOW_FGC
operator|)
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|bwn_newstate
parameter_list|(
name|struct
name|ieee80211vap
modifier|*
name|vap
parameter_list|,
name|enum
name|ieee80211_state
name|nstate
parameter_list|,
name|int
name|arg
parameter_list|)
block|{
name|struct
name|bwn_vap
modifier|*
name|bvp
init|=
name|BWN_VAP
argument_list|(
name|vap
argument_list|)
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|vap
operator|->
name|iv_ic
decl_stmt|;
name|enum
name|ieee80211_state
name|ostate
init|=
name|vap
operator|->
name|iv_state
decl_stmt|;
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_softc
decl_stmt|;
name|struct
name|bwn_mac
modifier|*
name|mac
init|=
name|sc
operator|->
name|sc_curmac
decl_stmt|;
name|int
name|error
decl_stmt|;
name|DPRINTF
argument_list|(
name|sc
argument_list|,
name|BWN_DEBUG_STATE
argument_list|,
literal|"%s: %s -> %s\n"
argument_list|,
name|__func__
argument_list|,
name|ieee80211_state_name
index|[
name|vap
operator|->
name|iv_state
index|]
argument_list|,
name|ieee80211_state_name
index|[
name|nstate
index|]
argument_list|)
expr_stmt|;
name|error
operator|=
name|bvp
operator|->
name|bv_newstate
argument_list|(
name|vap
argument_list|,
name|nstate
argument_list|,
name|arg
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|BWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|bwn_led_newstate
argument_list|(
name|mac
argument_list|,
name|nstate
argument_list|)
expr_stmt|;
comment|/* 	 * Clear the BSSID when we stop a STA 	 */
if|if
condition|(
name|vap
operator|->
name|iv_opmode
operator|==
name|IEEE80211_M_STA
condition|)
block|{
if|if
condition|(
name|ostate
operator|==
name|IEEE80211_S_RUN
operator|&&
name|nstate
operator|!=
name|IEEE80211_S_RUN
condition|)
block|{
comment|/* 			 * Clear out the BSSID.  If we reassociate to 			 * the same AP, this will reinialize things 			 * correctly... 			 */
if|if
condition|(
name|ic
operator|->
name|ic_opmode
operator|==
name|IEEE80211_M_STA
operator|&&
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|BWN_FLAG_INVALID
operator|)
operator|==
literal|0
condition|)
block|{
name|memset
argument_list|(
name|sc
operator|->
name|sc_bssid
argument_list|,
literal|0
argument_list|,
name|IEEE80211_ADDR_LEN
argument_list|)
expr_stmt|;
name|bwn_set_macaddr
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|vap
operator|->
name|iv_opmode
operator|==
name|IEEE80211_M_MONITOR
operator|||
name|vap
operator|->
name|iv_opmode
operator|==
name|IEEE80211_M_AHDEMO
condition|)
block|{
comment|/* XXX nothing to do? */
block|}
elseif|else
if|if
condition|(
name|nstate
operator|==
name|IEEE80211_S_RUN
condition|)
block|{
name|memcpy
argument_list|(
name|sc
operator|->
name|sc_bssid
argument_list|,
name|vap
operator|->
name|iv_bss
operator|->
name|ni_bssid
argument_list|,
name|IEEE80211_ADDR_LEN
argument_list|)
expr_stmt|;
name|bwn_set_opmode
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|bwn_set_pretbtt
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|bwn_spu_setdelay
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bwn_set_macaddr
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
name|BWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_set_pretbtt
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
name|uint16_t
name|pretbtt
decl_stmt|;
if|if
condition|(
name|ic
operator|->
name|ic_opmode
operator|==
name|IEEE80211_M_IBSS
condition|)
name|pretbtt
operator|=
literal|2
expr_stmt|;
else|else
name|pretbtt
operator|=
operator|(
name|mac
operator|->
name|mac_phy
operator|.
name|type
operator|==
name|BWN_PHYTYPE_A
operator|)
condition|?
literal|120
else|:
literal|250
expr_stmt|;
name|bwn_shm_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
name|BWN_SHARED_PRETBTT
argument_list|,
name|pretbtt
argument_list|)
expr_stmt|;
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
name|BWN_TSF_CFP_PRETBTT
argument_list|,
name|pretbtt
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|bwn_intr
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|bwn_mac
modifier|*
name|mac
init|=
name|arg
decl_stmt|;
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|uint32_t
name|reason
decl_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_status
operator|<
name|BWN_MAC_STATUS_STARTED
operator|||
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|BWN_FLAG_INVALID
operator|)
condition|)
return|return
operator|(
name|FILTER_STRAY
operator|)
return|;
name|reason
operator|=
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|BWN_INTR_REASON
argument_list|)
expr_stmt|;
if|if
condition|(
name|reason
operator|==
literal|0xffffffff
condition|)
comment|/* shared IRQ */
return|return
operator|(
name|FILTER_STRAY
operator|)
return|;
name|reason
operator|&=
name|mac
operator|->
name|mac_intr_mask
expr_stmt|;
if|if
condition|(
name|reason
operator|==
literal|0
condition|)
return|return
operator|(
name|FILTER_HANDLED
operator|)
return|;
name|mac
operator|->
name|mac_reason
index|[
literal|0
index|]
operator|=
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|BWN_DMA0_REASON
argument_list|)
operator|&
literal|0x0001dc00
expr_stmt|;
name|mac
operator|->
name|mac_reason
index|[
literal|1
index|]
operator|=
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|BWN_DMA1_REASON
argument_list|)
operator|&
literal|0x0000dc00
expr_stmt|;
name|mac
operator|->
name|mac_reason
index|[
literal|2
index|]
operator|=
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|BWN_DMA2_REASON
argument_list|)
operator|&
literal|0x0000dc00
expr_stmt|;
name|mac
operator|->
name|mac_reason
index|[
literal|3
index|]
operator|=
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|BWN_DMA3_REASON
argument_list|)
operator|&
literal|0x0001dc00
expr_stmt|;
name|mac
operator|->
name|mac_reason
index|[
literal|4
index|]
operator|=
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|BWN_DMA4_REASON
argument_list|)
operator|&
literal|0x0000dc00
expr_stmt|;
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
name|BWN_INTR_REASON
argument_list|,
name|reason
argument_list|)
expr_stmt|;
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
name|BWN_DMA0_REASON
argument_list|,
name|mac
operator|->
name|mac_reason
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
name|BWN_DMA1_REASON
argument_list|,
name|mac
operator|->
name|mac_reason
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
name|BWN_DMA2_REASON
argument_list|,
name|mac
operator|->
name|mac_reason
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
name|BWN_DMA3_REASON
argument_list|,
name|mac
operator|->
name|mac_reason
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
name|BWN_DMA4_REASON
argument_list|,
name|mac
operator|->
name|mac_reason
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
comment|/* Disable interrupts. */
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
name|BWN_INTR_MASK
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mac
operator|->
name|mac_reason_intr
operator|=
name|reason
expr_stmt|;
name|BWN_BARRIER
argument_list|(
name|mac
argument_list|,
name|BUS_SPACE_BARRIER_READ
argument_list|)
expr_stmt|;
name|BWN_BARRIER
argument_list|(
name|mac
argument_list|,
name|BUS_SPACE_BARRIER_WRITE
argument_list|)
expr_stmt|;
name|taskqueue_enqueue
argument_list|(
name|sc
operator|->
name|sc_tq
argument_list|,
operator|&
name|mac
operator|->
name|mac_intrtask
argument_list|)
expr_stmt|;
return|return
operator|(
name|FILTER_HANDLED
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_intrtask
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|int
name|npending
parameter_list|)
block|{
name|struct
name|bwn_mac
modifier|*
name|mac
init|=
name|arg
decl_stmt|;
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|uint32_t
name|merged
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|,
name|tx
init|=
literal|0
decl_stmt|,
name|rx
init|=
literal|0
decl_stmt|;
name|BWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_status
operator|<
name|BWN_MAC_STATUS_STARTED
operator|||
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|BWN_FLAG_INVALID
operator|)
condition|)
block|{
name|BWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|N
argument_list|(
name|mac
operator|->
name|mac_reason
argument_list|)
condition|;
name|i
operator|++
control|)
name|merged
operator||=
name|mac
operator|->
name|mac_reason
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_reason_intr
operator|&
name|BWN_INTR_MAC_TXERR
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"MAC trans error\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_reason_intr
operator|&
name|BWN_INTR_PHY_TXERR
condition|)
block|{
name|DPRINTF
argument_list|(
name|sc
argument_list|,
name|BWN_DEBUG_INTR
argument_list|,
literal|"%s: PHY trans error\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|mac
operator|->
name|mac_phy
operator|.
name|txerrors
operator|--
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|txerrors
operator|==
literal|0
condition|)
block|{
name|mac
operator|->
name|mac_phy
operator|.
name|txerrors
operator|=
name|BWN_TXERROR_MAX
expr_stmt|;
name|bwn_restart
argument_list|(
name|mac
argument_list|,
literal|"PHY TX errors"
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|merged
operator|&
operator|(
name|BWN_DMAINTR_FATALMASK
operator||
name|BWN_DMAINTR_NONFATALMASK
operator|)
condition|)
block|{
if|if
condition|(
name|merged
operator|&
name|BWN_DMAINTR_FATALMASK
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"Fatal DMA error: %#x %#x %#x %#x %#x %#x\n"
argument_list|,
name|mac
operator|->
name|mac_reason
index|[
literal|0
index|]
argument_list|,
name|mac
operator|->
name|mac_reason
index|[
literal|1
index|]
argument_list|,
name|mac
operator|->
name|mac_reason
index|[
literal|2
index|]
argument_list|,
name|mac
operator|->
name|mac_reason
index|[
literal|3
index|]
argument_list|,
name|mac
operator|->
name|mac_reason
index|[
literal|4
index|]
argument_list|,
name|mac
operator|->
name|mac_reason
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
name|bwn_restart
argument_list|(
name|mac
argument_list|,
literal|"DMA error"
argument_list|)
expr_stmt|;
name|BWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|merged
operator|&
name|BWN_DMAINTR_NONFATALMASK
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"DMA error: %#x %#x %#x %#x %#x %#x\n"
argument_list|,
name|mac
operator|->
name|mac_reason
index|[
literal|0
index|]
argument_list|,
name|mac
operator|->
name|mac_reason
index|[
literal|1
index|]
argument_list|,
name|mac
operator|->
name|mac_reason
index|[
literal|2
index|]
argument_list|,
name|mac
operator|->
name|mac_reason
index|[
literal|3
index|]
argument_list|,
name|mac
operator|->
name|mac_reason
index|[
literal|4
index|]
argument_list|,
name|mac
operator|->
name|mac_reason
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|mac
operator|->
name|mac_reason_intr
operator|&
name|BWN_INTR_UCODE_DEBUG
condition|)
name|bwn_intr_ucode_debug
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_reason_intr
operator|&
name|BWN_INTR_TBTT_INDI
condition|)
name|bwn_intr_tbtt_indication
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_reason_intr
operator|&
name|BWN_INTR_ATIM_END
condition|)
name|bwn_intr_atim_end
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_reason_intr
operator|&
name|BWN_INTR_BEACON
condition|)
name|bwn_intr_beacon
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_reason_intr
operator|&
name|BWN_INTR_PMQ
condition|)
name|bwn_intr_pmq
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_reason_intr
operator|&
name|BWN_INTR_NOISESAMPLE_OK
condition|)
name|bwn_intr_noise
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_flags
operator|&
name|BWN_MAC_FLAG_DMA
condition|)
block|{
if|if
condition|(
name|mac
operator|->
name|mac_reason
index|[
literal|0
index|]
operator|&
name|BWN_DMAINTR_RX_DONE
condition|)
block|{
name|bwn_dma_rx
argument_list|(
name|mac
operator|->
name|mac_method
operator|.
name|dma
operator|.
name|rx
argument_list|)
expr_stmt|;
name|rx
operator|=
literal|1
expr_stmt|;
block|}
block|}
else|else
name|rx
operator|=
name|bwn_pio_rx
argument_list|(
operator|&
name|mac
operator|->
name|mac_method
operator|.
name|pio
operator|.
name|rx
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
operator|!
operator|(
name|mac
operator|->
name|mac_reason
index|[
literal|1
index|]
operator|&
name|BWN_DMAINTR_RX_DONE
operator|)
argument_list|,
operator|(
literal|"%s"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
operator|!
operator|(
name|mac
operator|->
name|mac_reason
index|[
literal|2
index|]
operator|&
name|BWN_DMAINTR_RX_DONE
operator|)
argument_list|,
operator|(
literal|"%s"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
operator|!
operator|(
name|mac
operator|->
name|mac_reason
index|[
literal|3
index|]
operator|&
name|BWN_DMAINTR_RX_DONE
operator|)
argument_list|,
operator|(
literal|"%s"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
operator|!
operator|(
name|mac
operator|->
name|mac_reason
index|[
literal|4
index|]
operator|&
name|BWN_DMAINTR_RX_DONE
operator|)
argument_list|,
operator|(
literal|"%s"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
operator|!
operator|(
name|mac
operator|->
name|mac_reason
index|[
literal|5
index|]
operator|&
name|BWN_DMAINTR_RX_DONE
operator|)
argument_list|,
operator|(
literal|"%s"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_reason_intr
operator|&
name|BWN_INTR_TX_OK
condition|)
block|{
name|bwn_intr_txeof
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|tx
operator|=
literal|1
expr_stmt|;
block|}
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
name|BWN_INTR_MASK
argument_list|,
name|mac
operator|->
name|mac_intr_mask
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_blink_led
operator|!=
name|NULL
operator|&&
name|sc
operator|->
name|sc_led_blink
condition|)
block|{
name|int
name|evt
init|=
name|BWN_LED_EVENT_NONE
decl_stmt|;
if|if
condition|(
name|tx
operator|&&
name|rx
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|sc_rx_rate
operator|>
name|sc
operator|->
name|sc_tx_rate
condition|)
name|evt
operator|=
name|BWN_LED_EVENT_RX
expr_stmt|;
else|else
name|evt
operator|=
name|BWN_LED_EVENT_TX
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|tx
condition|)
block|{
name|evt
operator|=
name|BWN_LED_EVENT_TX
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rx
condition|)
block|{
name|evt
operator|=
name|BWN_LED_EVENT_RX
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rx
operator|==
literal|0
condition|)
block|{
name|evt
operator|=
name|BWN_LED_EVENT_POLL
expr_stmt|;
block|}
if|if
condition|(
name|evt
operator|!=
name|BWN_LED_EVENT_NONE
condition|)
name|bwn_led_event
argument_list|(
name|mac
argument_list|,
name|evt
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mbufq_first
argument_list|(
operator|&
name|sc
operator|->
name|sc_snd
argument_list|)
operator|!=
name|NULL
condition|)
name|bwn_start
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|BWN_BARRIER
argument_list|(
name|mac
argument_list|,
name|BUS_SPACE_BARRIER_READ
argument_list|)
expr_stmt|;
name|BWN_BARRIER
argument_list|(
name|mac
argument_list|,
name|BUS_SPACE_BARRIER_WRITE
argument_list|)
expr_stmt|;
name|BWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_restart
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
specifier|const
name|char
modifier|*
name|msg
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_status
operator|<
name|BWN_MAC_STATUS_INITED
condition|)
return|return;
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"HW reset: %s\n"
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|ieee80211_runtask
argument_list|(
name|ic
argument_list|,
operator|&
name|mac
operator|->
name|mac_hwreset
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_intr_ucode_debug
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|uint16_t
name|reason
decl_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_fw
operator|.
name|opensource
operator|==
literal|0
condition|)
return|return;
name|reason
operator|=
name|bwn_shm_read_2
argument_list|(
name|mac
argument_list|,
name|BWN_SCRATCH
argument_list|,
name|BWN_DEBUGINTR_REASON_REG
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|reason
condition|)
block|{
case|case
name|BWN_DEBUGINTR_PANIC
case|:
name|bwn_handle_fwpanic
argument_list|(
name|mac
argument_list|)
expr_stmt|;
break|break;
case|case
name|BWN_DEBUGINTR_DUMP_SHM
case|:
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"BWN_DEBUGINTR_DUMP_SHM\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|BWN_DEBUGINTR_DUMP_REGS
case|:
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"BWN_DEBUGINTR_DUMP_REGS\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|BWN_DEBUGINTR_MARKER
case|:
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"BWN_DEBUGINTR_MARKER\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"ucode debug unknown reason: %#x\n"
argument_list|,
name|reason
argument_list|)
expr_stmt|;
block|}
name|bwn_shm_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_SCRATCH
argument_list|,
name|BWN_DEBUGINTR_REASON_REG
argument_list|,
name|BWN_DEBUGINTR_ACK
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_intr_tbtt_indication
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
if|if
condition|(
name|ic
operator|->
name|ic_opmode
operator|!=
name|IEEE80211_M_HOSTAP
condition|)
name|bwn_psctl
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ic
operator|->
name|ic_opmode
operator|==
name|IEEE80211_M_IBSS
condition|)
name|mac
operator|->
name|mac_flags
operator||=
name|BWN_MAC_FLAG_DFQVALID
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_intr_atim_end
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
if|if
condition|(
name|mac
operator|->
name|mac_flags
operator|&
name|BWN_MAC_FLAG_DFQVALID
condition|)
block|{
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCMD
argument_list|,
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCMD
argument_list|)
operator||
name|BWN_MACCMD_DFQ_VALID
argument_list|)
expr_stmt|;
name|mac
operator|->
name|mac_flags
operator|&=
operator|~
name|BWN_MAC_FLAG_DFQVALID
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_intr_beacon
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
name|uint32_t
name|cmd
decl_stmt|,
name|beacon0
decl_stmt|,
name|beacon1
decl_stmt|;
if|if
condition|(
name|ic
operator|->
name|ic_opmode
operator|==
name|IEEE80211_M_HOSTAP
operator|||
name|ic
operator|->
name|ic_opmode
operator|==
name|IEEE80211_M_MBSS
condition|)
return|return;
name|mac
operator|->
name|mac_intr_mask
operator|&=
operator|~
name|BWN_INTR_BEACON
expr_stmt|;
name|cmd
operator|=
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCMD
argument_list|)
expr_stmt|;
name|beacon0
operator|=
operator|(
name|cmd
operator|&
name|BWN_MACCMD_BEACON0_VALID
operator|)
expr_stmt|;
name|beacon1
operator|=
operator|(
name|cmd
operator|&
name|BWN_MACCMD_BEACON1_VALID
operator|)
expr_stmt|;
if|if
condition|(
name|beacon0
operator|&&
name|beacon1
condition|)
block|{
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
name|BWN_INTR_REASON
argument_list|,
name|BWN_INTR_BEACON
argument_list|)
expr_stmt|;
name|mac
operator|->
name|mac_intr_mask
operator||=
name|BWN_INTR_BEACON
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|sc
operator|->
name|sc_flags
operator|&
name|BWN_FLAG_NEED_BEACON_TP
condition|)
block|{
name|sc
operator|->
name|sc_flags
operator|&=
operator|~
name|BWN_FLAG_NEED_BEACON_TP
expr_stmt|;
name|bwn_load_beacon0
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|bwn_load_beacon1
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|cmd
operator|=
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCMD
argument_list|)
expr_stmt|;
name|cmd
operator||=
name|BWN_MACCMD_BEACON0_VALID
expr_stmt|;
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCMD
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|beacon0
condition|)
block|{
name|bwn_load_beacon0
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|cmd
operator|=
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCMD
argument_list|)
expr_stmt|;
name|cmd
operator||=
name|BWN_MACCMD_BEACON0_VALID
expr_stmt|;
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCMD
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|beacon1
condition|)
block|{
name|bwn_load_beacon1
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|cmd
operator|=
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCMD
argument_list|)
expr_stmt|;
name|cmd
operator||=
name|BWN_MACCMD_BEACON1_VALID
expr_stmt|;
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCMD
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_intr_pmq
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|tmp
operator|=
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|BWN_PS_STATUS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|tmp
operator|&
literal|0x00000008
operator|)
condition|)
break|break;
block|}
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
name|BWN_PS_STATUS
argument_list|,
literal|0x0002
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_intr_noise
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_phy_g
modifier|*
name|pg
init|=
operator|&
name|mac
operator|->
name|mac_phy
operator|.
name|phy_g
decl_stmt|;
name|uint16_t
name|tmp
decl_stmt|;
name|uint8_t
name|noise
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|i
decl_stmt|,
name|j
decl_stmt|;
name|int32_t
name|average
decl_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|type
operator|!=
name|BWN_PHYTYPE_G
condition|)
return|return;
name|KASSERT
argument_list|(
name|mac
operator|->
name|mac_noise
operator|.
name|noi_running
argument_list|,
operator|(
literal|"%s: fail"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
operator|*
operator|(
operator|(
name|uint32_t
operator|*
operator|)
name|noise
operator|)
operator|=
name|htole32
argument_list|(
name|bwn_jssi_read
argument_list|(
name|mac
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|noise
index|[
literal|0
index|]
operator|==
literal|0x7f
operator|||
name|noise
index|[
literal|1
index|]
operator|==
literal|0x7f
operator|||
name|noise
index|[
literal|2
index|]
operator|==
literal|0x7f
operator|||
name|noise
index|[
literal|3
index|]
operator|==
literal|0x7f
condition|)
goto|goto
name|new
goto|;
name|KASSERT
argument_list|(
name|mac
operator|->
name|mac_noise
operator|.
name|noi_nsamples
operator|<
literal|8
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
name|i
operator|=
name|mac
operator|->
name|mac_noise
operator|.
name|noi_nsamples
expr_stmt|;
name|noise
index|[
literal|0
index|]
operator|=
name|MIN
argument_list|(
name|MAX
argument_list|(
name|noise
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
argument_list|,
name|N
argument_list|(
name|pg
operator|->
name|pg_nrssi_lt
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|noise
index|[
literal|1
index|]
operator|=
name|MIN
argument_list|(
name|MAX
argument_list|(
name|noise
index|[
literal|1
index|]
argument_list|,
literal|0
argument_list|)
argument_list|,
name|N
argument_list|(
name|pg
operator|->
name|pg_nrssi_lt
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|noise
index|[
literal|2
index|]
operator|=
name|MIN
argument_list|(
name|MAX
argument_list|(
name|noise
index|[
literal|2
index|]
argument_list|,
literal|0
argument_list|)
argument_list|,
name|N
argument_list|(
name|pg
operator|->
name|pg_nrssi_lt
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|noise
index|[
literal|3
index|]
operator|=
name|MIN
argument_list|(
name|MAX
argument_list|(
name|noise
index|[
literal|3
index|]
argument_list|,
literal|0
argument_list|)
argument_list|,
name|N
argument_list|(
name|pg
operator|->
name|pg_nrssi_lt
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|mac
operator|->
name|mac_noise
operator|.
name|noi_samples
index|[
name|i
index|]
index|[
literal|0
index|]
operator|=
name|pg
operator|->
name|pg_nrssi_lt
index|[
name|noise
index|[
literal|0
index|]
index|]
expr_stmt|;
name|mac
operator|->
name|mac_noise
operator|.
name|noi_samples
index|[
name|i
index|]
index|[
literal|1
index|]
operator|=
name|pg
operator|->
name|pg_nrssi_lt
index|[
name|noise
index|[
literal|1
index|]
index|]
expr_stmt|;
name|mac
operator|->
name|mac_noise
operator|.
name|noi_samples
index|[
name|i
index|]
index|[
literal|2
index|]
operator|=
name|pg
operator|->
name|pg_nrssi_lt
index|[
name|noise
index|[
literal|2
index|]
index|]
expr_stmt|;
name|mac
operator|->
name|mac_noise
operator|.
name|noi_samples
index|[
name|i
index|]
index|[
literal|3
index|]
operator|=
name|pg
operator|->
name|pg_nrssi_lt
index|[
name|noise
index|[
literal|3
index|]
index|]
expr_stmt|;
name|mac
operator|->
name|mac_noise
operator|.
name|noi_nsamples
operator|++
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_noise
operator|.
name|noi_nsamples
operator|==
literal|8
condition|)
block|{
name|average
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|4
condition|;
name|j
operator|++
control|)
name|average
operator|+=
name|mac
operator|->
name|mac_noise
operator|.
name|noi_samples
index|[
name|i
index|]
index|[
name|j
index|]
expr_stmt|;
block|}
name|average
operator|=
operator|(
operator|(
operator|(
name|average
operator|/
literal|32
operator|)
operator|*
literal|125
operator|)
operator|+
literal|64
operator|)
operator|/
literal|128
expr_stmt|;
name|tmp
operator|=
operator|(
name|bwn_shm_read_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
literal|0x40c
argument_list|)
operator|/
literal|128
operator|)
operator|&
literal|0x1f
expr_stmt|;
if|if
condition|(
name|tmp
operator|>=
literal|8
condition|)
name|average
operator|+=
literal|2
expr_stmt|;
else|else
name|average
operator|-=
literal|25
expr_stmt|;
name|average
operator|-=
operator|(
name|tmp
operator|==
literal|8
operator|)
condition|?
literal|72
else|:
literal|48
expr_stmt|;
name|mac
operator|->
name|mac_stats
operator|.
name|link_noise
operator|=
name|average
expr_stmt|;
name|mac
operator|->
name|mac_noise
operator|.
name|noi_running
operator|=
literal|0
expr_stmt|;
return|return;
block|}
name|new
label|:
name|bwn_noise_gensample
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|bwn_pio_rx
parameter_list|(
name|struct
name|bwn_pio_rxqueue
modifier|*
name|prq
parameter_list|)
block|{
name|struct
name|bwn_mac
modifier|*
name|mac
init|=
name|prq
operator|->
name|prq_mac
decl_stmt|;
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
name|BWN_ASSERT_LOCKED
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_status
operator|<
name|BWN_MAC_STATUS_STARTED
condition|)
return|return
operator|(
literal|0
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|5000
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|bwn_pio_rxeof
argument_list|(
name|prq
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|i
operator|>=
literal|5000
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"too many RX frames in PIO mode\n"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
name|i
operator|>
literal|0
operator|)
condition|?
literal|1
else|:
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_dma_rx
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
name|dr
parameter_list|)
block|{
name|int
name|slot
decl_stmt|,
name|curslot
decl_stmt|;
name|KASSERT
argument_list|(
operator|!
name|dr
operator|->
name|dr_tx
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
name|curslot
operator|=
name|dr
operator|->
name|get_curslot
argument_list|(
name|dr
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|curslot
operator|>=
literal|0
operator|&&
name|curslot
operator|<
name|dr
operator|->
name|dr_numslots
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
name|slot
operator|=
name|dr
operator|->
name|dr_curslot
expr_stmt|;
for|for
control|(
init|;
name|slot
operator|!=
name|curslot
condition|;
name|slot
operator|=
name|bwn_dma_nextslot
argument_list|(
name|dr
argument_list|,
name|slot
argument_list|)
control|)
name|bwn_dma_rxeof
argument_list|(
name|dr
argument_list|,
operator|&
name|slot
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|dr
operator|->
name|dr_ring_dtag
argument_list|,
name|dr
operator|->
name|dr_ring_dmap
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
name|dr
operator|->
name|set_curslot
argument_list|(
name|dr
argument_list|,
name|slot
argument_list|)
expr_stmt|;
name|dr
operator|->
name|dr_curslot
operator|=
name|slot
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_intr_txeof
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_txstatus
name|stat
decl_stmt|;
name|uint32_t
name|stat0
decl_stmt|,
name|stat1
decl_stmt|;
name|uint16_t
name|tmp
decl_stmt|;
name|BWN_ASSERT_LOCKED
argument_list|(
name|mac
operator|->
name|mac_sc
argument_list|)
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|stat0
operator|=
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|BWN_XMITSTAT_0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|stat0
operator|&
literal|0x00000001
operator|)
condition|)
break|break;
name|stat1
operator|=
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|BWN_XMITSTAT_1
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
name|mac
operator|->
name|mac_sc
argument_list|,
name|BWN_DEBUG_XMIT
argument_list|,
literal|"%s: stat0=0x%08x, stat1=0x%08x\n"
argument_list|,
name|__func__
argument_list|,
name|stat0
argument_list|,
name|stat1
argument_list|)
expr_stmt|;
name|stat
operator|.
name|cookie
operator|=
operator|(
name|stat0
operator|>>
literal|16
operator|)
expr_stmt|;
name|stat
operator|.
name|seq
operator|=
operator|(
name|stat1
operator|&
literal|0x0000ffff
operator|)
expr_stmt|;
name|stat
operator|.
name|phy_stat
operator|=
operator|(
operator|(
name|stat1
operator|&
literal|0x00ff0000
operator|)
operator|>>
literal|16
operator|)
expr_stmt|;
name|tmp
operator|=
operator|(
name|stat0
operator|&
literal|0x0000ffff
operator|)
expr_stmt|;
name|stat
operator|.
name|framecnt
operator|=
operator|(
operator|(
name|tmp
operator|&
literal|0xf000
operator|)
operator|>>
literal|12
operator|)
expr_stmt|;
name|stat
operator|.
name|rtscnt
operator|=
operator|(
operator|(
name|tmp
operator|&
literal|0x0f00
operator|)
operator|>>
literal|8
operator|)
expr_stmt|;
name|stat
operator|.
name|sreason
operator|=
operator|(
operator|(
name|tmp
operator|&
literal|0x001c
operator|)
operator|>>
literal|2
operator|)
expr_stmt|;
name|stat
operator|.
name|pm
operator|=
operator|(
name|tmp
operator|&
literal|0x0080
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|stat
operator|.
name|im
operator|=
operator|(
name|tmp
operator|&
literal|0x0040
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|stat
operator|.
name|ampdu
operator|=
operator|(
name|tmp
operator|&
literal|0x0020
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|stat
operator|.
name|ack
operator|=
operator|(
name|tmp
operator|&
literal|0x0002
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|DPRINTF
argument_list|(
name|mac
operator|->
name|mac_sc
argument_list|,
name|BWN_DEBUG_XMIT
argument_list|,
literal|"%s: cookie=%d, seq=%d, phystat=0x%02x, framecnt=%d, "
literal|"rtscnt=%d, sreason=%d, pm=%d, im=%d, ampdu=%d, ack=%d\n"
argument_list|,
name|__func__
argument_list|,
name|stat
operator|.
name|cookie
argument_list|,
name|stat
operator|.
name|seq
argument_list|,
name|stat
operator|.
name|phy_stat
argument_list|,
name|stat
operator|.
name|framecnt
argument_list|,
name|stat
operator|.
name|rtscnt
argument_list|,
name|stat
operator|.
name|sreason
argument_list|,
name|stat
operator|.
name|pm
argument_list|,
name|stat
operator|.
name|im
argument_list|,
name|stat
operator|.
name|ampdu
argument_list|,
name|stat
operator|.
name|ack
argument_list|)
expr_stmt|;
name|bwn_handle_txeof
argument_list|(
name|mac
argument_list|,
operator|&
name|stat
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_hwreset
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|int
name|npending
parameter_list|)
block|{
name|struct
name|bwn_mac
modifier|*
name|mac
init|=
name|arg
decl_stmt|;
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|int
name|prev_status
decl_stmt|;
name|BWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|prev_status
operator|=
name|mac
operator|->
name|mac_status
expr_stmt|;
if|if
condition|(
name|prev_status
operator|>=
name|BWN_MAC_STATUS_STARTED
condition|)
name|bwn_core_stop
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|prev_status
operator|>=
name|BWN_MAC_STATUS_INITED
condition|)
name|bwn_core_exit
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|prev_status
operator|>=
name|BWN_MAC_STATUS_INITED
condition|)
block|{
name|error
operator|=
name|bwn_core_init
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|prev_status
operator|>=
name|BWN_MAC_STATUS_STARTED
condition|)
name|bwn_core_start
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|out
label|:
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: failed (%d)\n"
argument_list|,
name|__func__
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_curmac
operator|=
name|NULL
expr_stmt|;
block|}
name|BWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_handle_fwpanic
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|uint16_t
name|reason
decl_stmt|;
name|reason
operator|=
name|bwn_shm_read_2
argument_list|(
name|mac
argument_list|,
name|BWN_SCRATCH
argument_list|,
name|BWN_FWPANIC_REASON_REG
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"fw panic (%u)\n"
argument_list|,
name|reason
argument_list|)
expr_stmt|;
if|if
condition|(
name|reason
operator|==
name|BWN_FWPANIC_RESTART
condition|)
name|bwn_restart
argument_list|(
name|mac
argument_list|,
literal|"ucode panic"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_load_beacon0
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|KASSERT
argument_list|(
literal|0
operator|==
literal|1
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_load_beacon1
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|KASSERT
argument_list|(
literal|0
operator|==
literal|1
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|bwn_jssi_read
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|uint32_t
name|val
init|=
literal|0
decl_stmt|;
name|val
operator|=
name|bwn_shm_read_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
literal|0x08a
argument_list|)
expr_stmt|;
name|val
operator|<<=
literal|16
expr_stmt|;
name|val
operator||=
name|bwn_shm_read_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
literal|0x088
argument_list|)
expr_stmt|;
return|return
operator|(
name|val
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_noise_gensample
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|uint32_t
name|jssi
init|=
literal|0x7f7f7f7f
decl_stmt|;
name|bwn_shm_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
literal|0x088
argument_list|,
operator|(
name|jssi
operator|&
literal|0x0000ffff
operator|)
argument_list|)
expr_stmt|;
name|bwn_shm_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
literal|0x08a
argument_list|,
operator|(
name|jssi
operator|&
literal|0xffff0000
operator|)
operator|>>
literal|16
argument_list|)
expr_stmt|;
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCMD
argument_list|,
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|BWN_MACCMD
argument_list|)
operator||
name|BWN_MACCMD_BGNOISE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|bwn_dma_freeslot
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
name|dr
parameter_list|)
block|{
name|BWN_ASSERT_LOCKED
argument_list|(
name|dr
operator|->
name|dr_mac
operator|->
name|mac_sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|dr
operator|->
name|dr_numslots
operator|-
name|dr
operator|->
name|dr_usedslot
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bwn_dma_nextslot
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
name|dr
parameter_list|,
name|int
name|slot
parameter_list|)
block|{
name|BWN_ASSERT_LOCKED
argument_list|(
name|dr
operator|->
name|dr_mac
operator|->
name|mac_sc
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|slot
operator|>=
operator|-
literal|1
operator|&&
name|slot
operator|<=
name|dr
operator|->
name|dr_numslots
operator|-
literal|1
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|slot
operator|==
name|dr
operator|->
name|dr_numslots
operator|-
literal|1
condition|)
return|return
operator|(
literal|0
operator|)
return|;
return|return
operator|(
name|slot
operator|+
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_dma_rxeof
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
name|dr
parameter_list|,
name|int
modifier|*
name|slot
parameter_list|)
block|{
name|struct
name|bwn_mac
modifier|*
name|mac
init|=
name|dr
operator|->
name|dr_mac
decl_stmt|;
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|struct
name|bwn_dma
modifier|*
name|dma
init|=
operator|&
name|mac
operator|->
name|mac_method
operator|.
name|dma
decl_stmt|;
name|struct
name|bwn_dmadesc_generic
modifier|*
name|desc
decl_stmt|;
name|struct
name|bwn_dmadesc_meta
modifier|*
name|meta
decl_stmt|;
name|struct
name|bwn_rxhdr4
modifier|*
name|rxhdr
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|uint32_t
name|macstat
decl_stmt|;
name|int32_t
name|tmp
decl_stmt|;
name|int
name|cnt
init|=
literal|0
decl_stmt|;
name|uint16_t
name|len
decl_stmt|;
name|dr
operator|->
name|getdesc
argument_list|(
name|dr
argument_list|,
operator|*
name|slot
argument_list|,
operator|&
name|desc
argument_list|,
operator|&
name|meta
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|dma
operator|->
name|rxbuf_dtag
argument_list|,
name|meta
operator|->
name|mt_dmap
argument_list|,
name|BUS_DMASYNC_POSTREAD
argument_list|)
expr_stmt|;
name|m
operator|=
name|meta
operator|->
name|mt_m
expr_stmt|;
if|if
condition|(
name|bwn_dma_newbuf
argument_list|(
name|dr
argument_list|,
name|desc
argument_list|,
name|meta
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|counter_u64_add
argument_list|(
name|sc
operator|->
name|sc_ic
operator|.
name|ic_ierrors
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return;
block|}
name|rxhdr
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|bwn_rxhdr4
operator|*
argument_list|)
expr_stmt|;
name|len
operator|=
name|le16toh
argument_list|(
name|rxhdr
operator|->
name|frame_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<=
literal|0
condition|)
block|{
name|counter_u64_add
argument_list|(
name|sc
operator|->
name|sc_ic
operator|.
name|ic_ierrors
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|bwn_dma_check_redzone
argument_list|(
name|dr
argument_list|,
name|m
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"redzone error.\n"
argument_list|)
expr_stmt|;
name|bwn_dma_set_redzone
argument_list|(
name|dr
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|dma
operator|->
name|rxbuf_dtag
argument_list|,
name|meta
operator|->
name|mt_dmap
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|len
operator|>
name|dr
operator|->
name|dr_rx_bufsize
condition|)
block|{
name|tmp
operator|=
name|len
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|dr
operator|->
name|getdesc
argument_list|(
name|dr
argument_list|,
operator|*
name|slot
argument_list|,
operator|&
name|desc
argument_list|,
operator|&
name|meta
argument_list|)
expr_stmt|;
name|bwn_dma_set_redzone
argument_list|(
name|dr
argument_list|,
name|meta
operator|->
name|mt_m
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|dma
operator|->
name|rxbuf_dtag
argument_list|,
name|meta
operator|->
name|mt_dmap
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
operator|*
name|slot
operator|=
name|bwn_dma_nextslot
argument_list|(
name|dr
argument_list|,
operator|*
name|slot
argument_list|)
expr_stmt|;
name|cnt
operator|++
expr_stmt|;
name|tmp
operator|-=
name|dr
operator|->
name|dr_rx_bufsize
expr_stmt|;
if|if
condition|(
name|tmp
operator|<=
literal|0
condition|)
break|break;
block|}
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"too small buffer "
literal|"(len %u buffer %u dropped %d)\n"
argument_list|,
name|len
argument_list|,
name|dr
operator|->
name|dr_rx_bufsize
argument_list|,
name|cnt
argument_list|)
expr_stmt|;
return|return;
block|}
name|macstat
operator|=
name|le32toh
argument_list|(
name|rxhdr
operator|->
name|mac_status
argument_list|)
expr_stmt|;
if|if
condition|(
name|macstat
operator|&
name|BWN_RX_MAC_FCSERR
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|mac
operator|->
name|mac_sc
operator|->
name|sc_filters
operator|&
name|BWN_MACCTL_PASS_BADFCS
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"RX drop\n"
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|m
operator|->
name|m_len
operator|=
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|len
operator|+
name|dr
operator|->
name|dr_frameoffset
expr_stmt|;
name|m_adj
argument_list|(
name|m
argument_list|,
name|dr
operator|->
name|dr_frameoffset
argument_list|)
expr_stmt|;
name|bwn_rxeof
argument_list|(
name|dr
operator|->
name|dr_mac
argument_list|,
name|m
argument_list|,
name|rxhdr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_handle_txeof
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
specifier|const
name|struct
name|bwn_txstatus
modifier|*
name|status
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|struct
name|bwn_stats
modifier|*
name|stats
init|=
operator|&
name|mac
operator|->
name|mac_stats
decl_stmt|;
name|BWN_ASSERT_LOCKED
argument_list|(
name|mac
operator|->
name|mac_sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|->
name|im
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"TODO: STATUS IM\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|->
name|ampdu
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"TODO: STATUS AMPDU\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|->
name|rtscnt
condition|)
block|{
if|if
condition|(
name|status
operator|->
name|rtscnt
operator|==
literal|0xf
condition|)
name|stats
operator|->
name|rtsfail
operator|++
expr_stmt|;
else|else
name|stats
operator|->
name|rts
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|mac
operator|->
name|mac_flags
operator|&
name|BWN_MAC_FLAG_DMA
condition|)
block|{
name|bwn_dma_handle_txeof
argument_list|(
name|mac
argument_list|,
name|status
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|bwn_pio_handle_txeof
argument_list|(
name|mac
argument_list|,
name|status
argument_list|)
expr_stmt|;
block|}
name|bwn_phy_txpower_check
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|bwn_pio_rxeof
parameter_list|(
name|struct
name|bwn_pio_rxqueue
modifier|*
name|prq
parameter_list|)
block|{
name|struct
name|bwn_mac
modifier|*
name|mac
init|=
name|prq
operator|->
name|prq_mac
decl_stmt|;
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|struct
name|bwn_rxhdr4
name|rxhdr
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|uint32_t
name|ctl32
decl_stmt|,
name|macstat
decl_stmt|,
name|v32
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|,
name|padding
decl_stmt|;
name|uint16_t
name|ctl16
decl_stmt|,
name|len
decl_stmt|,
name|totlen
decl_stmt|,
name|v16
decl_stmt|;
name|unsigned
name|char
modifier|*
name|mp
decl_stmt|;
name|char
modifier|*
name|data
decl_stmt|;
name|memset
argument_list|(
operator|&
name|rxhdr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|rxhdr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|prq
operator|->
name|prq_rev
operator|>=
literal|8
condition|)
block|{
name|ctl32
operator|=
name|bwn_pio_rx_read_4
argument_list|(
name|prq
argument_list|,
name|BWN_PIO8_RXCTL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ctl32
operator|&
name|BWN_PIO8_RXCTL_FRAMEREADY
operator|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|bwn_pio_rx_write_4
argument_list|(
name|prq
argument_list|,
name|BWN_PIO8_RXCTL
argument_list|,
name|BWN_PIO8_RXCTL_FRAMEREADY
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|10
condition|;
name|i
operator|++
control|)
block|{
name|ctl32
operator|=
name|bwn_pio_rx_read_4
argument_list|(
name|prq
argument_list|,
name|BWN_PIO8_RXCTL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctl32
operator|&
name|BWN_PIO8_RXCTL_DATAREADY
condition|)
goto|goto
name|ready
goto|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|ctl16
operator|=
name|bwn_pio_rx_read_2
argument_list|(
name|prq
argument_list|,
name|BWN_PIO_RXCTL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ctl16
operator|&
name|BWN_PIO_RXCTL_FRAMEREADY
operator|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|bwn_pio_rx_write_2
argument_list|(
name|prq
argument_list|,
name|BWN_PIO_RXCTL
argument_list|,
name|BWN_PIO_RXCTL_FRAMEREADY
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|10
condition|;
name|i
operator|++
control|)
block|{
name|ctl16
operator|=
name|bwn_pio_rx_read_2
argument_list|(
name|prq
argument_list|,
name|BWN_PIO_RXCTL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctl16
operator|&
name|BWN_PIO_RXCTL_DATAREADY
condition|)
goto|goto
name|ready
goto|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
block|}
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: timed out\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
name|ready
label|:
if|if
condition|(
name|prq
operator|->
name|prq_rev
operator|>=
literal|8
condition|)
name|siba_read_multi_4
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
operator|&
name|rxhdr
argument_list|,
sizeof|sizeof
argument_list|(
name|rxhdr
argument_list|)
argument_list|,
name|prq
operator|->
name|prq_base
operator|+
name|BWN_PIO8_RXDATA
argument_list|)
expr_stmt|;
else|else
name|siba_read_multi_2
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
operator|&
name|rxhdr
argument_list|,
sizeof|sizeof
argument_list|(
name|rxhdr
argument_list|)
argument_list|,
name|prq
operator|->
name|prq_base
operator|+
name|BWN_PIO_RXDATA
argument_list|)
expr_stmt|;
name|len
operator|=
name|le16toh
argument_list|(
name|rxhdr
operator|.
name|frame_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
literal|0x700
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: len is too big\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
if|if
condition|(
name|len
operator|==
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: len is 0\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|macstat
operator|=
name|le32toh
argument_list|(
name|rxhdr
operator|.
name|mac_status
argument_list|)
expr_stmt|;
if|if
condition|(
name|macstat
operator|&
name|BWN_RX_MAC_FCSERR
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|mac
operator|->
name|mac_sc
operator|->
name|sc_filters
operator|&
name|BWN_MACCTL_PASS_BADFCS
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: FCS error"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
block|}
name|padding
operator|=
operator|(
name|macstat
operator|&
name|BWN_RX_MAC_PADDING
operator|)
condition|?
literal|2
else|:
literal|0
expr_stmt|;
name|totlen
operator|=
name|len
operator|+
name|padding
expr_stmt|;
name|KASSERT
argument_list|(
name|totlen
operator|<=
name|MCLBYTES
argument_list|,
operator|(
literal|"too big..\n"
operator|)
argument_list|)
expr_stmt|;
name|m
operator|=
name|m_getcl
argument_list|(
name|M_NOWAIT
argument_list|,
name|MT_DATA
argument_list|,
name|M_PKTHDR
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: out of memory"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|mp
operator|=
name|mtod
argument_list|(
argument|m
argument_list|,
argument|unsigned char *
argument_list|)
expr_stmt|;
if|if
condition|(
name|prq
operator|->
name|prq_rev
operator|>=
literal|8
condition|)
block|{
name|siba_read_multi_4
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
name|mp
argument_list|,
operator|(
name|totlen
operator|&
operator|~
literal|3
operator|)
argument_list|,
name|prq
operator|->
name|prq_base
operator|+
name|BWN_PIO8_RXDATA
argument_list|)
expr_stmt|;
if|if
condition|(
name|totlen
operator|&
literal|3
condition|)
block|{
name|v32
operator|=
name|bwn_pio_rx_read_4
argument_list|(
name|prq
argument_list|,
name|BWN_PIO8_RXDATA
argument_list|)
expr_stmt|;
name|data
operator|=
operator|&
operator|(
name|mp
index|[
name|totlen
operator|-
literal|1
index|]
operator|)
expr_stmt|;
switch|switch
condition|(
name|totlen
operator|&
literal|3
condition|)
block|{
case|case
literal|3
case|:
operator|*
name|data
operator|=
operator|(
name|v32
operator|>>
literal|16
operator|)
expr_stmt|;
name|data
operator|--
expr_stmt|;
case|case
literal|2
case|:
operator|*
name|data
operator|=
operator|(
name|v32
operator|>>
literal|8
operator|)
expr_stmt|;
name|data
operator|--
expr_stmt|;
case|case
literal|1
case|:
operator|*
name|data
operator|=
name|v32
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|siba_read_multi_2
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
name|mp
argument_list|,
operator|(
name|totlen
operator|&
operator|~
literal|1
operator|)
argument_list|,
name|prq
operator|->
name|prq_base
operator|+
name|BWN_PIO_RXDATA
argument_list|)
expr_stmt|;
if|if
condition|(
name|totlen
operator|&
literal|1
condition|)
block|{
name|v16
operator|=
name|bwn_pio_rx_read_2
argument_list|(
name|prq
argument_list|,
name|BWN_PIO_RXDATA
argument_list|)
expr_stmt|;
name|mp
index|[
name|totlen
operator|-
literal|1
index|]
operator|=
name|v16
expr_stmt|;
block|}
block|}
name|m
operator|->
name|m_len
operator|=
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|totlen
expr_stmt|;
name|bwn_rxeof
argument_list|(
name|prq
operator|->
name|prq_mac
argument_list|,
name|m
argument_list|,
operator|&
name|rxhdr
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
name|error
label|:
if|if
condition|(
name|prq
operator|->
name|prq_rev
operator|>=
literal|8
condition|)
name|bwn_pio_rx_write_4
argument_list|(
name|prq
argument_list|,
name|BWN_PIO8_RXCTL
argument_list|,
name|BWN_PIO8_RXCTL_DATAREADY
argument_list|)
expr_stmt|;
else|else
name|bwn_pio_rx_write_2
argument_list|(
name|prq
argument_list|,
name|BWN_PIO_RXCTL
argument_list|,
name|BWN_PIO_RXCTL_DATAREADY
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bwn_dma_newbuf
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
name|dr
parameter_list|,
name|struct
name|bwn_dmadesc_generic
modifier|*
name|desc
parameter_list|,
name|struct
name|bwn_dmadesc_meta
modifier|*
name|meta
parameter_list|,
name|int
name|init
parameter_list|)
block|{
name|struct
name|bwn_mac
modifier|*
name|mac
init|=
name|dr
operator|->
name|dr_mac
decl_stmt|;
name|struct
name|bwn_dma
modifier|*
name|dma
init|=
operator|&
name|mac
operator|->
name|mac_method
operator|.
name|dma
decl_stmt|;
name|struct
name|bwn_rxhdr4
modifier|*
name|hdr
decl_stmt|;
name|bus_dmamap_t
name|map
decl_stmt|;
name|bus_addr_t
name|paddr
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|int
name|error
decl_stmt|;
name|m
operator|=
name|m_getcl
argument_list|(
name|M_NOWAIT
argument_list|,
name|MT_DATA
argument_list|,
name|M_PKTHDR
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|ENOBUFS
expr_stmt|;
comment|/* 		 * If the NIC is up and running, we need to: 		 * - Clear RX buffer's header. 		 * - Restore RX descriptor settings. 		 */
if|if
condition|(
name|init
condition|)
return|return
operator|(
name|error
operator|)
return|;
else|else
goto|goto
name|back
goto|;
block|}
name|m
operator|->
name|m_len
operator|=
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|MCLBYTES
expr_stmt|;
name|bwn_dma_set_redzone
argument_list|(
name|dr
argument_list|,
name|m
argument_list|)
expr_stmt|;
comment|/* 	 * Try to load RX buf into temporary DMA map 	 */
name|error
operator|=
name|bus_dmamap_load_mbuf
argument_list|(
name|dma
operator|->
name|rxbuf_dtag
argument_list|,
name|dr
operator|->
name|dr_spare_dmap
argument_list|,
name|m
argument_list|,
name|bwn_dma_buf_addr
argument_list|,
operator|&
name|paddr
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
comment|/* 		 * See the comment above 		 */
if|if
condition|(
name|init
condition|)
return|return
operator|(
name|error
operator|)
return|;
else|else
goto|goto
name|back
goto|;
block|}
if|if
condition|(
operator|!
name|init
condition|)
name|bus_dmamap_unload
argument_list|(
name|dma
operator|->
name|rxbuf_dtag
argument_list|,
name|meta
operator|->
name|mt_dmap
argument_list|)
expr_stmt|;
name|meta
operator|->
name|mt_m
operator|=
name|m
expr_stmt|;
name|meta
operator|->
name|mt_paddr
operator|=
name|paddr
expr_stmt|;
comment|/* 	 * Swap RX buf's DMA map with the loaded temporary one 	 */
name|map
operator|=
name|meta
operator|->
name|mt_dmap
expr_stmt|;
name|meta
operator|->
name|mt_dmap
operator|=
name|dr
operator|->
name|dr_spare_dmap
expr_stmt|;
name|dr
operator|->
name|dr_spare_dmap
operator|=
name|map
expr_stmt|;
name|back
label|:
comment|/* 	 * Clear RX buf header 	 */
name|hdr
operator|=
name|mtod
argument_list|(
name|meta
operator|->
name|mt_m
argument_list|,
expr|struct
name|bwn_rxhdr4
operator|*
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|hdr
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|dma
operator|->
name|rxbuf_dtag
argument_list|,
name|meta
operator|->
name|mt_dmap
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
comment|/* 	 * Setup RX buf descriptor 	 */
name|dr
operator|->
name|setdesc
argument_list|(
name|dr
argument_list|,
name|desc
argument_list|,
name|meta
operator|->
name|mt_paddr
argument_list|,
name|meta
operator|->
name|mt_m
operator|->
name|m_len
operator|-
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_dma_buf_addr
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|seg
parameter_list|,
name|int
name|nseg
parameter_list|,
name|bus_size_t
name|mapsz
name|__unused
parameter_list|,
name|int
name|error
parameter_list|)
block|{
if|if
condition|(
operator|!
name|error
condition|)
block|{
name|KASSERT
argument_list|(
name|nseg
operator|==
literal|1
argument_list|,
operator|(
literal|"too many segments(%d)\n"
operator|,
name|nseg
operator|)
argument_list|)
expr_stmt|;
operator|*
operator|(
operator|(
name|bus_addr_t
operator|*
operator|)
name|arg
operator|)
operator|=
name|seg
operator|->
name|ds_addr
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|bwn_hwrate2ieeerate
parameter_list|(
name|int
name|rate
parameter_list|)
block|{
switch|switch
condition|(
name|rate
condition|)
block|{
case|case
name|BWN_CCK_RATE_1MB
case|:
return|return
operator|(
literal|2
operator|)
return|;
case|case
name|BWN_CCK_RATE_2MB
case|:
return|return
operator|(
literal|4
operator|)
return|;
case|case
name|BWN_CCK_RATE_5MB
case|:
return|return
operator|(
literal|11
operator|)
return|;
case|case
name|BWN_CCK_RATE_11MB
case|:
return|return
operator|(
literal|22
operator|)
return|;
case|case
name|BWN_OFDM_RATE_6MB
case|:
return|return
operator|(
literal|12
operator|)
return|;
case|case
name|BWN_OFDM_RATE_9MB
case|:
return|return
operator|(
literal|18
operator|)
return|;
case|case
name|BWN_OFDM_RATE_12MB
case|:
return|return
operator|(
literal|24
operator|)
return|;
case|case
name|BWN_OFDM_RATE_18MB
case|:
return|return
operator|(
literal|36
operator|)
return|;
case|case
name|BWN_OFDM_RATE_24MB
case|:
return|return
operator|(
literal|48
operator|)
return|;
case|case
name|BWN_OFDM_RATE_36MB
case|:
return|return
operator|(
literal|72
operator|)
return|;
case|case
name|BWN_OFDM_RATE_48MB
case|:
return|return
operator|(
literal|96
operator|)
return|;
case|case
name|BWN_OFDM_RATE_54MB
case|:
return|return
operator|(
literal|108
operator|)
return|;
default|default:
name|printf
argument_list|(
literal|"Ooops\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
end_function

begin_comment
comment|/*  * Post process the RX provided RSSI.  *  * Valid for A, B, G, LP PHYs.  */
end_comment

begin_function
specifier|static
name|int8_t
name|bwn_rx_rssi_calc
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint8_t
name|in_rssi
parameter_list|,
name|int
name|ofdm
parameter_list|,
name|int
name|adjust_2053
parameter_list|,
name|int
name|adjust_2050
parameter_list|)
block|{
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwn_phy_g
modifier|*
name|gphy
init|=
operator|&
name|phy
operator|->
name|phy_g
decl_stmt|;
name|int
name|tmp
decl_stmt|;
switch|switch
condition|(
name|phy
operator|->
name|rf_ver
condition|)
block|{
case|case
literal|0x2050
case|:
if|if
condition|(
name|ofdm
condition|)
block|{
name|tmp
operator|=
name|in_rssi
expr_stmt|;
if|if
condition|(
name|tmp
operator|>
literal|127
condition|)
name|tmp
operator|-=
literal|256
expr_stmt|;
name|tmp
operator|=
name|tmp
operator|*
literal|73
operator|/
literal|64
expr_stmt|;
if|if
condition|(
name|adjust_2050
condition|)
name|tmp
operator|+=
literal|25
expr_stmt|;
else|else
name|tmp
operator|-=
literal|3
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|siba_sprom_get_bf_lo
argument_list|(
name|mac
operator|->
name|mac_sc
operator|->
name|sc_dev
argument_list|)
operator|&
name|BWN_BFL_RSSI
condition|)
block|{
if|if
condition|(
name|in_rssi
operator|>
literal|63
condition|)
name|in_rssi
operator|=
literal|63
expr_stmt|;
name|tmp
operator|=
name|gphy
operator|->
name|pg_nrssi_lt
index|[
name|in_rssi
index|]
expr_stmt|;
name|tmp
operator|=
operator|(
literal|31
operator|-
name|tmp
operator|)
operator|*
operator|-
literal|131
operator|/
literal|128
operator|-
literal|57
expr_stmt|;
block|}
else|else
block|{
name|tmp
operator|=
name|in_rssi
expr_stmt|;
name|tmp
operator|=
operator|(
literal|31
operator|-
name|tmp
operator|)
operator|*
operator|-
literal|149
operator|/
literal|128
operator|-
literal|68
expr_stmt|;
block|}
if|if
condition|(
name|phy
operator|->
name|type
operator|==
name|BWN_PHYTYPE_G
operator|&&
name|adjust_2050
condition|)
name|tmp
operator|+=
literal|25
expr_stmt|;
block|}
break|break;
case|case
literal|0x2060
case|:
if|if
condition|(
name|in_rssi
operator|>
literal|127
condition|)
name|tmp
operator|=
name|in_rssi
operator|-
literal|256
expr_stmt|;
else|else
name|tmp
operator|=
name|in_rssi
expr_stmt|;
break|break;
default|default:
name|tmp
operator|=
name|in_rssi
expr_stmt|;
name|tmp
operator|=
operator|(
name|tmp
operator|-
literal|11
operator|)
operator|*
literal|103
operator|/
literal|64
expr_stmt|;
if|if
condition|(
name|adjust_2053
condition|)
name|tmp
operator|-=
literal|109
expr_stmt|;
else|else
name|tmp
operator|-=
literal|83
expr_stmt|;
block|}
return|return
operator|(
name|tmp
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_rxeof
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
specifier|const
name|void
modifier|*
name|_rxhdr
parameter_list|)
block|{
specifier|const
name|struct
name|bwn_rxhdr4
modifier|*
name|rxhdr
init|=
name|_rxhdr
decl_stmt|;
name|struct
name|bwn_plcp6
modifier|*
name|plcp
decl_stmt|;
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|struct
name|ieee80211_frame_min
modifier|*
name|wh
decl_stmt|;
name|struct
name|ieee80211_node
modifier|*
name|ni
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
name|uint32_t
name|macstat
decl_stmt|;
name|int
name|padding
decl_stmt|,
name|rate
decl_stmt|,
name|rssi
init|=
literal|0
decl_stmt|,
name|noise
init|=
literal|0
decl_stmt|,
name|type
decl_stmt|;
name|uint16_t
name|phytype
decl_stmt|,
name|phystat0
decl_stmt|,
name|phystat3
decl_stmt|,
name|chanstat
decl_stmt|;
name|unsigned
name|char
modifier|*
name|mp
init|=
name|mtod
argument_list|(
argument|m
argument_list|,
argument|unsigned char *
argument_list|)
decl_stmt|;
specifier|static
name|int
name|rx_mac_dec_rpt
init|=
literal|0
decl_stmt|;
name|BWN_ASSERT_LOCKED
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|phystat0
operator|=
name|le16toh
argument_list|(
name|rxhdr
operator|->
name|phy_status0
argument_list|)
expr_stmt|;
name|phystat3
operator|=
name|le16toh
argument_list|(
name|rxhdr
operator|->
name|phy_status3
argument_list|)
expr_stmt|;
comment|/* XXX Note: mactime, macstat, chanstat need fixing for fw 598 */
name|macstat
operator|=
name|le32toh
argument_list|(
name|rxhdr
operator|->
name|mac_status
argument_list|)
expr_stmt|;
name|chanstat
operator|=
name|le16toh
argument_list|(
name|rxhdr
operator|->
name|channel
argument_list|)
expr_stmt|;
name|phytype
operator|=
name|chanstat
operator|&
name|BWN_RX_CHAN_PHYTYPE
expr_stmt|;
if|if
condition|(
name|macstat
operator|&
name|BWN_RX_MAC_FCSERR
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"TODO RX: RX_FLAG_FAILED_FCS_CRC\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|phystat0
operator|&
operator|(
name|BWN_RX_PHYST0_PLCPHCF
operator||
name|BWN_RX_PHYST0_PLCPFV
operator|)
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"TODO RX: RX_FLAG_FAILED_PLCP_CRC\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|macstat
operator|&
name|BWN_RX_MAC_DECERR
condition|)
goto|goto
name|drop
goto|;
name|padding
operator|=
operator|(
name|macstat
operator|&
name|BWN_RX_MAC_PADDING
operator|)
condition|?
literal|2
else|:
literal|0
expr_stmt|;
if|if
condition|(
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|<
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|bwn_plcp6
argument_list|)
operator|+
name|padding
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"frame too short (length=%d)\n"
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|)
expr_stmt|;
goto|goto
name|drop
goto|;
block|}
name|plcp
operator|=
operator|(
expr|struct
name|bwn_plcp6
operator|*
operator|)
operator|(
name|mp
operator|+
name|padding
operator|)
expr_stmt|;
name|m_adj
argument_list|(
name|m
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|bwn_plcp6
argument_list|)
operator|+
name|padding
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|<
name|IEEE80211_MIN_LEN
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"frame too short (length=%d)\n"
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|)
expr_stmt|;
goto|goto
name|drop
goto|;
block|}
name|wh
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ieee80211_frame_min
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
name|macstat
operator|&
name|BWN_RX_MAC_DEC
operator|&&
name|rx_mac_dec_rpt
operator|++
operator|<
literal|50
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"RX decryption attempted (old %d keyidx %#x)\n"
argument_list|,
name|BWN_ISOLDFMT
argument_list|(
name|mac
argument_list|)
argument_list|,
operator|(
name|macstat
operator|&
name|BWN_RX_MAC_KEYIDX
operator|)
operator|>>
name|BWN_RX_MAC_KEYIDX_SHIFT
argument_list|)
expr_stmt|;
if|if
condition|(
name|phystat0
operator|&
name|BWN_RX_PHYST0_OFDM
condition|)
name|rate
operator|=
name|bwn_plcp_get_ofdmrate
argument_list|(
name|mac
argument_list|,
name|plcp
argument_list|,
name|phytype
operator|==
name|BWN_PHYTYPE_A
argument_list|)
expr_stmt|;
else|else
name|rate
operator|=
name|bwn_plcp_get_cckrate
argument_list|(
name|mac
argument_list|,
name|plcp
argument_list|)
expr_stmt|;
if|if
condition|(
name|rate
operator|==
operator|-
literal|1
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|mac
operator|->
name|mac_sc
operator|->
name|sc_filters
operator|&
name|BWN_MACCTL_PASS_BADPLCP
operator|)
condition|)
goto|goto
name|drop
goto|;
block|}
name|sc
operator|->
name|sc_rx_rate
operator|=
name|bwn_hwrate2ieeerate
argument_list|(
name|rate
argument_list|)
expr_stmt|;
comment|/* rssi/noise */
switch|switch
condition|(
name|phytype
condition|)
block|{
case|case
name|BWN_PHYTYPE_A
case|:
case|case
name|BWN_PHYTYPE_B
case|:
case|case
name|BWN_PHYTYPE_G
case|:
case|case
name|BWN_PHYTYPE_LP
case|:
name|rssi
operator|=
name|bwn_rx_rssi_calc
argument_list|(
name|mac
argument_list|,
name|rxhdr
operator|->
name|phy
operator|.
name|abg
operator|.
name|rssi
argument_list|,
operator|!
operator|!
operator|(
name|phystat0
operator|&
name|BWN_RX_PHYST0_OFDM
operator|)
argument_list|,
operator|!
operator|!
operator|(
name|phystat0
operator|&
name|BWN_RX_PHYST0_GAINCTL
operator|)
argument_list|,
operator|!
operator|!
operator|(
name|phystat3
operator|&
name|BWN_RX_PHYST3_TRSTATE
operator|)
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|/* XXX TODO: implement rssi for other PHYs */
break|break;
block|}
name|noise
operator|=
name|mac
operator|->
name|mac_stats
operator|.
name|link_noise
expr_stmt|;
comment|/* RX radio tap */
if|if
condition|(
name|ieee80211_radiotap_active
argument_list|(
name|ic
argument_list|)
condition|)
name|bwn_rx_radiotap
argument_list|(
name|mac
argument_list|,
name|m
argument_list|,
name|rxhdr
argument_list|,
name|plcp
argument_list|,
name|rate
argument_list|,
name|rssi
argument_list|,
name|noise
argument_list|)
expr_stmt|;
name|m_adj
argument_list|(
name|m
argument_list|,
operator|-
name|IEEE80211_CRC_LEN
argument_list|)
expr_stmt|;
name|BWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ni
operator|=
name|ieee80211_find_rxnode
argument_list|(
name|ic
argument_list|,
name|wh
argument_list|)
expr_stmt|;
if|if
condition|(
name|ni
operator|!=
name|NULL
condition|)
block|{
name|type
operator|=
name|ieee80211_input
argument_list|(
name|ni
argument_list|,
name|m
argument_list|,
name|rssi
argument_list|,
name|noise
argument_list|)
expr_stmt|;
name|ieee80211_free_node
argument_list|(
name|ni
argument_list|)
expr_stmt|;
block|}
else|else
name|type
operator|=
name|ieee80211_input_all
argument_list|(
name|ic
argument_list|,
name|m
argument_list|,
name|rssi
argument_list|,
name|noise
argument_list|)
expr_stmt|;
name|BWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return;
name|drop
label|:
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: dropped\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_dma_handle_txeof
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
specifier|const
name|struct
name|bwn_txstatus
modifier|*
name|status
parameter_list|)
block|{
name|struct
name|bwn_dma
modifier|*
name|dma
init|=
operator|&
name|mac
operator|->
name|mac_method
operator|.
name|dma
decl_stmt|;
name|struct
name|bwn_dma_ring
modifier|*
name|dr
decl_stmt|;
name|struct
name|bwn_dmadesc_generic
modifier|*
name|desc
decl_stmt|;
name|struct
name|bwn_dmadesc_meta
modifier|*
name|meta
decl_stmt|;
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|int
name|slot
decl_stmt|;
name|int
name|retrycnt
init|=
literal|0
decl_stmt|;
name|BWN_ASSERT_LOCKED
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|dr
operator|=
name|bwn_dma_parse_cookie
argument_list|(
name|mac
argument_list|,
name|status
argument_list|,
name|status
operator|->
name|cookie
argument_list|,
operator|&
name|slot
argument_list|)
expr_stmt|;
if|if
condition|(
name|dr
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"failed to parse cookie\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|KASSERT
argument_list|(
name|dr
operator|->
name|dr_tx
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|KASSERT
argument_list|(
name|slot
operator|>=
literal|0
operator|&&
name|slot
operator|<
name|dr
operator|->
name|dr_numslots
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
name|dr
operator|->
name|getdesc
argument_list|(
name|dr
argument_list|,
name|slot
argument_list|,
operator|&
name|desc
argument_list|,
operator|&
name|meta
argument_list|)
expr_stmt|;
if|if
condition|(
name|meta
operator|->
name|mt_txtype
operator|==
name|BWN_DMADESC_METATYPE_HEADER
condition|)
name|bus_dmamap_unload
argument_list|(
name|dr
operator|->
name|dr_txring_dtag
argument_list|,
name|meta
operator|->
name|mt_dmap
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|meta
operator|->
name|mt_txtype
operator|==
name|BWN_DMADESC_METATYPE_BODY
condition|)
name|bus_dmamap_unload
argument_list|(
name|dma
operator|->
name|txbuf_dtag
argument_list|,
name|meta
operator|->
name|mt_dmap
argument_list|)
expr_stmt|;
if|if
condition|(
name|meta
operator|->
name|mt_islast
condition|)
block|{
name|KASSERT
argument_list|(
name|meta
operator|->
name|mt_m
operator|!=
name|NULL
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
comment|/* 			 * If we don't get an ACK, then we should log the 			 * full framecnt.  That may be 0 if it's a PHY 			 * failure, so ensure that gets logged as some 			 * retry attempt. 			 */
if|if
condition|(
name|status
operator|->
name|ack
condition|)
block|{
name|retrycnt
operator|=
name|status
operator|->
name|framecnt
operator|-
literal|1
expr_stmt|;
block|}
else|else
block|{
name|retrycnt
operator|=
name|status
operator|->
name|framecnt
expr_stmt|;
if|if
condition|(
name|retrycnt
operator|==
literal|0
condition|)
name|retrycnt
operator|=
literal|1
expr_stmt|;
block|}
name|ieee80211_ratectl_tx_complete
argument_list|(
name|meta
operator|->
name|mt_ni
operator|->
name|ni_vap
argument_list|,
name|meta
operator|->
name|mt_ni
argument_list|,
name|status
operator|->
name|ack
condition|?
name|IEEE80211_RATECTL_TX_SUCCESS
else|:
name|IEEE80211_RATECTL_TX_FAILURE
argument_list|,
operator|&
name|retrycnt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ieee80211_tx_complete
argument_list|(
name|meta
operator|->
name|mt_ni
argument_list|,
name|meta
operator|->
name|mt_m
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|meta
operator|->
name|mt_ni
operator|=
name|NULL
expr_stmt|;
name|meta
operator|->
name|mt_m
operator|=
name|NULL
expr_stmt|;
block|}
else|else
name|KASSERT
argument_list|(
name|meta
operator|->
name|mt_m
operator|==
name|NULL
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
name|dr
operator|->
name|dr_usedslot
operator|--
expr_stmt|;
if|if
condition|(
name|meta
operator|->
name|mt_islast
condition|)
break|break;
name|slot
operator|=
name|bwn_dma_nextslot
argument_list|(
name|dr
argument_list|,
name|slot
argument_list|)
expr_stmt|;
block|}
name|sc
operator|->
name|sc_watchdog_timer
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|dr
operator|->
name|dr_stop
condition|)
block|{
name|KASSERT
argument_list|(
name|bwn_dma_freeslot
argument_list|(
name|dr
argument_list|)
operator|>=
name|BWN_TX_SLOTS_PER_FRAME
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
name|dr
operator|->
name|dr_stop
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_pio_handle_txeof
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
specifier|const
name|struct
name|bwn_txstatus
modifier|*
name|status
parameter_list|)
block|{
name|struct
name|bwn_pio_txqueue
modifier|*
name|tq
decl_stmt|;
name|struct
name|bwn_pio_txpkt
modifier|*
name|tp
init|=
name|NULL
decl_stmt|;
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|int
name|retrycnt
init|=
literal|0
decl_stmt|;
name|BWN_ASSERT_LOCKED
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|tq
operator|=
name|bwn_pio_parse_cookie
argument_list|(
name|mac
argument_list|,
name|status
operator|->
name|cookie
argument_list|,
operator|&
name|tp
argument_list|)
expr_stmt|;
if|if
condition|(
name|tq
operator|==
name|NULL
condition|)
return|return;
name|tq
operator|->
name|tq_used
operator|-=
name|roundup
argument_list|(
name|tp
operator|->
name|tp_m
operator|->
name|m_pkthdr
operator|.
name|len
operator|+
name|BWN_HDRSIZE
argument_list|(
name|mac
argument_list|)
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|tq
operator|->
name|tq_free
operator|++
expr_stmt|;
if|if
condition|(
name|tp
operator|->
name|tp_ni
operator|!=
name|NULL
condition|)
block|{
comment|/* 		 * Do any tx complete callback.  Note this must 		 * be done before releasing the node reference. 		 */
comment|/* 		 * If we don't get an ACK, then we should log the 		 * full framecnt.  That may be 0 if it's a PHY 		 * failure, so ensure that gets logged as some 		 * retry attempt. 		 */
if|if
condition|(
name|status
operator|->
name|ack
condition|)
block|{
name|retrycnt
operator|=
name|status
operator|->
name|framecnt
operator|-
literal|1
expr_stmt|;
block|}
else|else
block|{
name|retrycnt
operator|=
name|status
operator|->
name|framecnt
expr_stmt|;
if|if
condition|(
name|retrycnt
operator|==
literal|0
condition|)
name|retrycnt
operator|=
literal|1
expr_stmt|;
block|}
name|ieee80211_ratectl_tx_complete
argument_list|(
name|tp
operator|->
name|tp_ni
operator|->
name|ni_vap
argument_list|,
name|tp
operator|->
name|tp_ni
argument_list|,
name|status
operator|->
name|ack
condition|?
name|IEEE80211_RATECTL_TX_SUCCESS
else|:
name|IEEE80211_RATECTL_TX_FAILURE
argument_list|,
operator|&
name|retrycnt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|tp
operator|->
name|tp_m
operator|->
name|m_flags
operator|&
name|M_TXCB
condition|)
name|ieee80211_process_callback
argument_list|(
name|tp
operator|->
name|tp_ni
argument_list|,
name|tp
operator|->
name|tp_m
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ieee80211_free_node
argument_list|(
name|tp
operator|->
name|tp_ni
argument_list|)
expr_stmt|;
name|tp
operator|->
name|tp_ni
operator|=
name|NULL
expr_stmt|;
block|}
name|m_freem
argument_list|(
name|tp
operator|->
name|tp_m
argument_list|)
expr_stmt|;
name|tp
operator|->
name|tp_m
operator|=
name|NULL
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|tq
operator|->
name|tq_pktlist
argument_list|,
name|tp
argument_list|,
name|tp_list
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_watchdog_timer
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_phy_txpower_check
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint32_t
name|flags
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
name|unsigned
name|long
name|now
decl_stmt|;
name|int
name|result
decl_stmt|;
name|BWN_GETTIME
argument_list|(
name|now
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|flags
operator|&
name|BWN_TXPWR_IGNORE_TIME
operator|)
operator|&&
name|ieee80211_time_before
argument_list|(
name|now
argument_list|,
name|phy
operator|->
name|nexttime
argument_list|)
condition|)
return|return;
name|phy
operator|->
name|nexttime
operator|=
name|now
operator|+
literal|2
operator|*
literal|1000
expr_stmt|;
if|if
condition|(
name|siba_get_pci_subvendor
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
name|SIBA_BOARDVENDOR_BCM
operator|&&
name|siba_get_pci_subdevice
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
name|SIBA_BOARD_BU4306
condition|)
return|return;
if|if
condition|(
name|phy
operator|->
name|recalc_txpwr
operator|!=
name|NULL
condition|)
block|{
name|result
operator|=
name|phy
operator|->
name|recalc_txpwr
argument_list|(
name|mac
argument_list|,
operator|(
name|flags
operator|&
name|BWN_TXPWR_IGNORE_TSSI
operator|)
condition|?
literal|1
else|:
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|BWN_TXPWR_RES_DONE
condition|)
return|return;
name|KASSERT
argument_list|(
name|result
operator|==
name|BWN_TXPWR_RES_NEED_ADJUST
argument_list|,
operator|(
literal|"%s: fail"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|phy
operator|->
name|set_txpwr
operator|!=
name|NULL
argument_list|,
operator|(
literal|"%s: fail"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
name|ieee80211_runtask
argument_list|(
name|ic
argument_list|,
operator|&
name|mac
operator|->
name|mac_txpower
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|uint16_t
name|bwn_pio_rx_read_2
parameter_list|(
name|struct
name|bwn_pio_rxqueue
modifier|*
name|prq
parameter_list|,
name|uint16_t
name|offset
parameter_list|)
block|{
return|return
operator|(
name|BWN_READ_2
argument_list|(
name|prq
operator|->
name|prq_mac
argument_list|,
name|prq
operator|->
name|prq_base
operator|+
name|offset
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|bwn_pio_rx_read_4
parameter_list|(
name|struct
name|bwn_pio_rxqueue
modifier|*
name|prq
parameter_list|,
name|uint16_t
name|offset
parameter_list|)
block|{
return|return
operator|(
name|BWN_READ_4
argument_list|(
name|prq
operator|->
name|prq_mac
argument_list|,
name|prq
operator|->
name|prq_base
operator|+
name|offset
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_pio_rx_write_2
parameter_list|(
name|struct
name|bwn_pio_rxqueue
modifier|*
name|prq
parameter_list|,
name|uint16_t
name|offset
parameter_list|,
name|uint16_t
name|value
parameter_list|)
block|{
name|BWN_WRITE_2
argument_list|(
name|prq
operator|->
name|prq_mac
argument_list|,
name|prq
operator|->
name|prq_base
operator|+
name|offset
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_pio_rx_write_4
parameter_list|(
name|struct
name|bwn_pio_rxqueue
modifier|*
name|prq
parameter_list|,
name|uint16_t
name|offset
parameter_list|,
name|uint32_t
name|value
parameter_list|)
block|{
name|BWN_WRITE_4
argument_list|(
name|prq
operator|->
name|prq_mac
argument_list|,
name|prq
operator|->
name|prq_base
operator|+
name|offset
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|bwn_ieeerate2hwrate
parameter_list|(
name|struct
name|bwn_softc
modifier|*
name|sc
parameter_list|,
name|int
name|rate
parameter_list|)
block|{
switch|switch
condition|(
name|rate
condition|)
block|{
comment|/* OFDM rates (cf IEEE Std 802.11a-1999, pp. 14 Table 80) */
case|case
literal|12
case|:
return|return
operator|(
name|BWN_OFDM_RATE_6MB
operator|)
return|;
case|case
literal|18
case|:
return|return
operator|(
name|BWN_OFDM_RATE_9MB
operator|)
return|;
case|case
literal|24
case|:
return|return
operator|(
name|BWN_OFDM_RATE_12MB
operator|)
return|;
case|case
literal|36
case|:
return|return
operator|(
name|BWN_OFDM_RATE_18MB
operator|)
return|;
case|case
literal|48
case|:
return|return
operator|(
name|BWN_OFDM_RATE_24MB
operator|)
return|;
case|case
literal|72
case|:
return|return
operator|(
name|BWN_OFDM_RATE_36MB
operator|)
return|;
case|case
literal|96
case|:
return|return
operator|(
name|BWN_OFDM_RATE_48MB
operator|)
return|;
case|case
literal|108
case|:
return|return
operator|(
name|BWN_OFDM_RATE_54MB
operator|)
return|;
comment|/* CCK rates (NB: not IEEE std, device-specific) */
case|case
literal|2
case|:
return|return
operator|(
name|BWN_CCK_RATE_1MB
operator|)
return|;
case|case
literal|4
case|:
return|return
operator|(
name|BWN_CCK_RATE_2MB
operator|)
return|;
case|case
literal|11
case|:
return|return
operator|(
name|BWN_CCK_RATE_5MB
operator|)
return|;
case|case
literal|22
case|:
return|return
operator|(
name|BWN_CCK_RATE_11MB
operator|)
return|;
block|}
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"unsupported rate %d\n"
argument_list|,
name|rate
argument_list|)
expr_stmt|;
return|return
operator|(
name|BWN_CCK_RATE_1MB
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bwn_set_txhdr
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|struct
name|ieee80211_node
modifier|*
name|ni
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|struct
name|bwn_txhdr
modifier|*
name|txhdr
parameter_list|,
name|uint16_t
name|cookie
parameter_list|)
block|{
specifier|const
name|struct
name|bwn_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|struct
name|ieee80211_frame
modifier|*
name|wh
decl_stmt|;
name|struct
name|ieee80211_frame
modifier|*
name|protwh
decl_stmt|;
name|struct
name|ieee80211_frame_cts
modifier|*
name|cts
decl_stmt|;
name|struct
name|ieee80211_frame_rts
modifier|*
name|rts
decl_stmt|;
specifier|const
name|struct
name|ieee80211_txparam
modifier|*
name|tp
decl_stmt|;
name|struct
name|ieee80211vap
modifier|*
name|vap
init|=
name|ni
operator|->
name|ni_vap
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|mprot
decl_stmt|;
name|unsigned
name|int
name|len
decl_stmt|;
name|uint32_t
name|macctl
init|=
literal|0
decl_stmt|;
name|int
name|protdur
decl_stmt|,
name|rts_rate
decl_stmt|,
name|rts_rate_fb
decl_stmt|,
name|ismcast
decl_stmt|,
name|isshort
decl_stmt|,
name|rix
decl_stmt|,
name|type
decl_stmt|;
name|uint16_t
name|phyctl
init|=
literal|0
decl_stmt|;
name|uint8_t
name|rate
decl_stmt|,
name|rate_fb
decl_stmt|;
name|wh
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ieee80211_frame
operator|*
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|txhdr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|txhdr
argument_list|)
argument_list|)
expr_stmt|;
name|type
operator|=
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator|&
name|IEEE80211_FC0_TYPE_MASK
expr_stmt|;
name|ismcast
operator|=
name|IEEE80211_IS_MULTICAST
argument_list|(
name|wh
operator|->
name|i_addr1
argument_list|)
expr_stmt|;
name|isshort
operator|=
operator|(
name|ic
operator|->
name|ic_flags
operator|&
name|IEEE80211_F_SHPREAMBLE
operator|)
operator|!=
literal|0
expr_stmt|;
comment|/* 	 * Find TX rate 	 */
name|tp
operator|=
operator|&
name|vap
operator|->
name|iv_txparms
index|[
name|ieee80211_chan2mode
argument_list|(
name|ic
operator|->
name|ic_curchan
argument_list|)
index|]
expr_stmt|;
if|if
condition|(
name|type
operator|!=
name|IEEE80211_FC0_TYPE_DATA
operator|||
operator|(
name|m
operator|->
name|m_flags
operator|&
name|M_EAPOL
operator|)
condition|)
name|rate
operator|=
name|rate_fb
operator|=
name|tp
operator|->
name|mgmtrate
expr_stmt|;
elseif|else
if|if
condition|(
name|ismcast
condition|)
name|rate
operator|=
name|rate_fb
operator|=
name|tp
operator|->
name|mcastrate
expr_stmt|;
elseif|else
if|if
condition|(
name|tp
operator|->
name|ucastrate
operator|!=
name|IEEE80211_FIXED_RATE_NONE
condition|)
name|rate
operator|=
name|rate_fb
operator|=
name|tp
operator|->
name|ucastrate
expr_stmt|;
else|else
block|{
comment|/* XXX TODO: don't fall back to CCK rates for OFDM */
name|rix
operator|=
name|ieee80211_ratectl_rate
argument_list|(
name|ni
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rate
operator|=
name|ni
operator|->
name|ni_txrate
expr_stmt|;
if|if
condition|(
name|rix
operator|>
literal|0
condition|)
name|rate_fb
operator|=
name|ni
operator|->
name|ni_rates
operator|.
name|rs_rates
index|[
name|rix
operator|-
literal|1
index|]
operator|&
name|IEEE80211_RATE_VAL
expr_stmt|;
else|else
name|rate_fb
operator|=
name|rate
expr_stmt|;
block|}
name|sc
operator|->
name|sc_tx_rate
operator|=
name|rate
expr_stmt|;
comment|/* Note: this maps the select ieee80211 rate to hardware rate */
name|rate
operator|=
name|bwn_ieeerate2hwrate
argument_list|(
name|sc
argument_list|,
name|rate
argument_list|)
expr_stmt|;
name|rate_fb
operator|=
name|bwn_ieeerate2hwrate
argument_list|(
name|sc
argument_list|,
name|rate_fb
argument_list|)
expr_stmt|;
name|txhdr
operator|->
name|phyrate
operator|=
operator|(
name|BWN_ISOFDMRATE
argument_list|(
name|rate
argument_list|)
operator|)
condition|?
name|bwn_plcp_getofdm
argument_list|(
name|rate
argument_list|)
else|:
name|bwn_plcp_getcck
argument_list|(
name|rate
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|wh
operator|->
name|i_fc
argument_list|,
name|txhdr
operator|->
name|macfc
argument_list|,
sizeof|sizeof
argument_list|(
name|txhdr
operator|->
name|macfc
argument_list|)
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|wh
operator|->
name|i_addr1
argument_list|,
name|txhdr
operator|->
name|addr1
argument_list|,
name|IEEE80211_ADDR_LEN
argument_list|)
expr_stmt|;
comment|/* XXX rate/rate_fb is the hardware rate */
if|if
condition|(
operator|(
name|rate_fb
operator|==
name|rate
operator|)
operator|||
operator|(
operator|*
operator|(
name|u_int16_t
operator|*
operator|)
name|wh
operator|->
name|i_dur
operator|&
name|htole16
argument_list|(
literal|0x8000
argument_list|)
operator|)
operator|||
operator|(
operator|*
operator|(
name|u_int16_t
operator|*
operator|)
name|wh
operator|->
name|i_dur
operator|==
name|htole16
argument_list|(
literal|0
argument_list|)
operator|)
condition|)
name|txhdr
operator|->
name|dur_fb
operator|=
operator|*
operator|(
name|u_int16_t
operator|*
operator|)
name|wh
operator|->
name|i_dur
expr_stmt|;
else|else
name|txhdr
operator|->
name|dur_fb
operator|=
name|ieee80211_compute_duration
argument_list|(
name|ic
operator|->
name|ic_rt
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|,
name|rate
argument_list|,
name|isshort
argument_list|)
expr_stmt|;
comment|/* XXX TX encryption */
name|bwn_plcp_genhdr
argument_list|(
name|BWN_ISOLDFMT
argument_list|(
name|mac
argument_list|)
condition|?
operator|(
expr|struct
name|bwn_plcp4
operator|*
operator|)
operator|(
operator|&
name|txhdr
operator|->
name|body
operator|.
name|old
operator|.
name|plcp
operator|)
else|:
operator|(
expr|struct
name|bwn_plcp4
operator|*
operator|)
operator|(
operator|&
name|txhdr
operator|->
name|body
operator|.
name|new
operator|.
name|plcp
operator|)
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|+
name|IEEE80211_CRC_LEN
argument_list|,
name|rate
argument_list|)
expr_stmt|;
name|bwn_plcp_genhdr
argument_list|(
operator|(
expr|struct
name|bwn_plcp4
operator|*
operator|)
operator|(
operator|&
name|txhdr
operator|->
name|plcp_fb
operator|)
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|+
name|IEEE80211_CRC_LEN
argument_list|,
name|rate_fb
argument_list|)
expr_stmt|;
name|txhdr
operator|->
name|eftypes
operator||=
operator|(
name|BWN_ISOFDMRATE
argument_list|(
name|rate_fb
argument_list|)
operator|)
condition|?
name|BWN_TX_EFT_FB_OFDM
else|:
name|BWN_TX_EFT_FB_CCK
expr_stmt|;
name|txhdr
operator|->
name|chan
operator|=
name|phy
operator|->
name|chan
expr_stmt|;
name|phyctl
operator||=
operator|(
name|BWN_ISOFDMRATE
argument_list|(
name|rate
argument_list|)
operator|)
condition|?
name|BWN_TX_PHY_ENC_OFDM
else|:
name|BWN_TX_PHY_ENC_CCK
expr_stmt|;
comment|/* XXX preamble? obey net80211 */
if|if
condition|(
name|isshort
operator|&&
operator|(
name|rate
operator|==
name|BWN_CCK_RATE_2MB
operator|||
name|rate
operator|==
name|BWN_CCK_RATE_5MB
operator|||
name|rate
operator|==
name|BWN_CCK_RATE_11MB
operator|)
condition|)
name|phyctl
operator||=
name|BWN_TX_PHY_SHORTPRMBL
expr_stmt|;
comment|/* XXX TX antenna selection */
switch|switch
condition|(
name|bwn_antenna_sanitize
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|)
condition|)
block|{
case|case
literal|0
case|:
name|phyctl
operator||=
name|BWN_TX_PHY_ANT01AUTO
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|phyctl
operator||=
name|BWN_TX_PHY_ANT0
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|phyctl
operator||=
name|BWN_TX_PHY_ANT1
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|phyctl
operator||=
name|BWN_TX_PHY_ANT2
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|phyctl
operator||=
name|BWN_TX_PHY_ANT3
expr_stmt|;
break|break;
default|default:
name|KASSERT
argument_list|(
literal|0
operator|==
literal|1
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|ismcast
condition|)
name|macctl
operator||=
name|BWN_TX_MAC_ACK
expr_stmt|;
name|macctl
operator||=
operator|(
name|BWN_TX_MAC_HWSEQ
operator||
name|BWN_TX_MAC_START_MSDU
operator|)
expr_stmt|;
if|if
condition|(
operator|!
name|IEEE80211_IS_MULTICAST
argument_list|(
name|wh
operator|->
name|i_addr1
argument_list|)
operator|&&
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|+
name|IEEE80211_CRC_LEN
operator|>
name|vap
operator|->
name|iv_rtsthreshold
condition|)
name|macctl
operator||=
name|BWN_TX_MAC_LONGFRAME
expr_stmt|;
if|if
condition|(
name|ic
operator|->
name|ic_flags
operator|&
name|IEEE80211_F_USEPROT
condition|)
block|{
comment|/* XXX RTS rate is always 1MB??? */
comment|/* XXX TODO: don't fall back to CCK rates for OFDM */
name|rts_rate
operator|=
name|BWN_CCK_RATE_1MB
expr_stmt|;
name|rts_rate_fb
operator|=
name|bwn_get_fbrate
argument_list|(
name|rts_rate
argument_list|)
expr_stmt|;
comment|/* XXX 'rate' here is hardware rate now, not the net80211 rate */
name|protdur
operator|=
name|ieee80211_compute_duration
argument_list|(
name|ic
operator|->
name|ic_rt
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|,
name|rate
argument_list|,
name|isshort
argument_list|)
operator|+
operator|+
name|ieee80211_ack_duration
argument_list|(
name|ic
operator|->
name|ic_rt
argument_list|,
name|rate
argument_list|,
name|isshort
argument_list|)
expr_stmt|;
if|if
condition|(
name|ic
operator|->
name|ic_protmode
operator|==
name|IEEE80211_PROT_CTSONLY
condition|)
block|{
name|cts
operator|=
operator|(
expr|struct
name|ieee80211_frame_cts
operator|*
operator|)
operator|(
name|BWN_ISOLDFMT
argument_list|(
name|mac
argument_list|)
condition|?
operator|(
name|txhdr
operator|->
name|body
operator|.
name|old
operator|.
name|rts_frame
operator|)
else|:
operator|(
name|txhdr
operator|->
name|body
operator|.
name|new
operator|.
name|rts_frame
operator|)
operator|)
expr_stmt|;
name|mprot
operator|=
name|ieee80211_alloc_cts
argument_list|(
name|ic
argument_list|,
name|ni
operator|->
name|ni_vap
operator|->
name|iv_myaddr
argument_list|,
name|protdur
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|mprot
operator|!=
name|NULL
argument_list|,
operator|(
literal|"failed to alloc mbuf\n"
operator|)
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|mtod
argument_list|(
name|mprot
argument_list|,
name|uint8_t
operator|*
argument_list|)
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
name|cts
argument_list|,
name|mprot
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|mprot
argument_list|)
expr_stmt|;
name|macctl
operator||=
name|BWN_TX_MAC_SEND_CTSTOSELF
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ieee80211_frame_cts
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|rts
operator|=
operator|(
expr|struct
name|ieee80211_frame_rts
operator|*
operator|)
operator|(
name|BWN_ISOLDFMT
argument_list|(
name|mac
argument_list|)
condition|?
operator|(
name|txhdr
operator|->
name|body
operator|.
name|old
operator|.
name|rts_frame
operator|)
else|:
operator|(
name|txhdr
operator|->
name|body
operator|.
name|new
operator|.
name|rts_frame
operator|)
operator|)
expr_stmt|;
comment|/* XXX rate/rate_fb is the hardware rate */
name|protdur
operator|+=
name|ieee80211_ack_duration
argument_list|(
name|ic
operator|->
name|ic_rt
argument_list|,
name|rate
argument_list|,
name|isshort
argument_list|)
expr_stmt|;
name|mprot
operator|=
name|ieee80211_alloc_rts
argument_list|(
name|ic
argument_list|,
name|wh
operator|->
name|i_addr1
argument_list|,
name|wh
operator|->
name|i_addr2
argument_list|,
name|protdur
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|mprot
operator|!=
name|NULL
argument_list|,
operator|(
literal|"failed to alloc mbuf\n"
operator|)
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|mtod
argument_list|(
name|mprot
argument_list|,
name|uint8_t
operator|*
argument_list|)
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
name|rts
argument_list|,
name|mprot
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|mprot
argument_list|)
expr_stmt|;
name|macctl
operator||=
name|BWN_TX_MAC_SEND_RTSCTS
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ieee80211_frame_rts
argument_list|)
expr_stmt|;
block|}
name|len
operator|+=
name|IEEE80211_CRC_LEN
expr_stmt|;
name|bwn_plcp_genhdr
argument_list|(
operator|(
expr|struct
name|bwn_plcp4
operator|*
operator|)
operator|(
operator|(
name|BWN_ISOLDFMT
argument_list|(
name|mac
argument_list|)
operator|)
condition|?
operator|&
name|txhdr
operator|->
name|body
operator|.
name|old
operator|.
name|rts_plcp
else|:
operator|&
name|txhdr
operator|->
name|body
operator|.
name|new
operator|.
name|rts_plcp
operator|)
argument_list|,
name|len
argument_list|,
name|rts_rate
argument_list|)
expr_stmt|;
name|bwn_plcp_genhdr
argument_list|(
operator|(
expr|struct
name|bwn_plcp4
operator|*
operator|)
operator|&
name|txhdr
operator|->
name|rts_plcp_fb
argument_list|,
name|len
argument_list|,
name|rts_rate_fb
argument_list|)
expr_stmt|;
name|protwh
operator|=
operator|(
expr|struct
name|ieee80211_frame
operator|*
operator|)
operator|(
name|BWN_ISOLDFMT
argument_list|(
name|mac
argument_list|)
condition|?
operator|(
operator|&
name|txhdr
operator|->
name|body
operator|.
name|old
operator|.
name|rts_frame
operator|)
else|:
operator|(
operator|&
name|txhdr
operator|->
name|body
operator|.
name|new
operator|.
name|rts_frame
operator|)
operator|)
expr_stmt|;
name|txhdr
operator|->
name|rts_dur_fb
operator|=
operator|*
operator|(
name|u_int16_t
operator|*
operator|)
name|protwh
operator|->
name|i_dur
expr_stmt|;
if|if
condition|(
name|BWN_ISOFDMRATE
argument_list|(
name|rts_rate
argument_list|)
condition|)
block|{
name|txhdr
operator|->
name|eftypes
operator||=
name|BWN_TX_EFT_RTS_OFDM
expr_stmt|;
name|txhdr
operator|->
name|phyrate_rts
operator|=
name|bwn_plcp_getofdm
argument_list|(
name|rts_rate
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|txhdr
operator|->
name|eftypes
operator||=
name|BWN_TX_EFT_RTS_CCK
expr_stmt|;
name|txhdr
operator|->
name|phyrate_rts
operator|=
name|bwn_plcp_getcck
argument_list|(
name|rts_rate
argument_list|)
expr_stmt|;
block|}
name|txhdr
operator|->
name|eftypes
operator||=
operator|(
name|BWN_ISOFDMRATE
argument_list|(
name|rts_rate_fb
argument_list|)
operator|)
condition|?
name|BWN_TX_EFT_RTS_FBOFDM
else|:
name|BWN_TX_EFT_RTS_FBCCK
expr_stmt|;
block|}
if|if
condition|(
name|BWN_ISOLDFMT
argument_list|(
name|mac
argument_list|)
condition|)
name|txhdr
operator|->
name|body
operator|.
name|old
operator|.
name|cookie
operator|=
name|htole16
argument_list|(
name|cookie
argument_list|)
expr_stmt|;
else|else
name|txhdr
operator|->
name|body
operator|.
name|new
operator|.
name|cookie
operator|=
name|htole16
argument_list|(
name|cookie
argument_list|)
expr_stmt|;
name|txhdr
operator|->
name|macctl
operator|=
name|htole32
argument_list|(
name|macctl
argument_list|)
expr_stmt|;
name|txhdr
operator|->
name|phyctl
operator|=
name|htole16
argument_list|(
name|phyctl
argument_list|)
expr_stmt|;
comment|/* 	 * TX radio tap 	 */
if|if
condition|(
name|ieee80211_radiotap_active_vap
argument_list|(
name|vap
argument_list|)
condition|)
block|{
name|sc
operator|->
name|sc_tx_th
operator|.
name|wt_flags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator|&
name|IEEE80211_FC1_PROTECTED
condition|)
name|sc
operator|->
name|sc_tx_th
operator|.
name|wt_flags
operator||=
name|IEEE80211_RADIOTAP_F_WEP
expr_stmt|;
if|if
condition|(
name|isshort
operator|&&
operator|(
name|rate
operator|==
name|BWN_CCK_RATE_2MB
operator|||
name|rate
operator|==
name|BWN_CCK_RATE_5MB
operator|||
name|rate
operator|==
name|BWN_CCK_RATE_11MB
operator|)
condition|)
name|sc
operator|->
name|sc_tx_th
operator|.
name|wt_flags
operator||=
name|IEEE80211_RADIOTAP_F_SHORTPRE
expr_stmt|;
name|sc
operator|->
name|sc_tx_th
operator|.
name|wt_rate
operator|=
name|rate
expr_stmt|;
name|ieee80211_radiotap_tx
argument_list|(
name|vap
argument_list|,
name|m
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_plcp_genhdr
parameter_list|(
name|struct
name|bwn_plcp4
modifier|*
name|plcp
parameter_list|,
specifier|const
name|uint16_t
name|octets
parameter_list|,
specifier|const
name|uint8_t
name|rate
parameter_list|)
block|{
name|uint32_t
name|d
decl_stmt|,
name|plen
decl_stmt|;
name|uint8_t
modifier|*
name|raw
init|=
name|plcp
operator|->
name|o
operator|.
name|raw
decl_stmt|;
if|if
condition|(
name|BWN_ISOFDMRATE
argument_list|(
name|rate
argument_list|)
condition|)
block|{
name|d
operator|=
name|bwn_plcp_getofdm
argument_list|(
name|rate
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
operator|!
operator|(
name|octets
operator|&
literal|0xf000
operator|)
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
name|d
operator||=
operator|(
name|octets
operator|<<
literal|5
operator|)
expr_stmt|;
name|plcp
operator|->
name|o
operator|.
name|data
operator|=
name|htole32
argument_list|(
name|d
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|plen
operator|=
name|octets
operator|*
literal|16
operator|/
name|rate
expr_stmt|;
if|if
condition|(
operator|(
name|octets
operator|*
literal|16
operator|%
name|rate
operator|)
operator|>
literal|0
condition|)
block|{
name|plen
operator|++
expr_stmt|;
if|if
condition|(
operator|(
name|rate
operator|==
name|BWN_CCK_RATE_11MB
operator|)
operator|&&
operator|(
operator|(
name|octets
operator|*
literal|8
operator|%
literal|11
operator|)
operator|<
literal|4
operator|)
condition|)
block|{
name|raw
index|[
literal|1
index|]
operator|=
literal|0x84
expr_stmt|;
block|}
else|else
name|raw
index|[
literal|1
index|]
operator|=
literal|0x04
expr_stmt|;
block|}
else|else
name|raw
index|[
literal|1
index|]
operator|=
literal|0x04
expr_stmt|;
name|plcp
operator|->
name|o
operator|.
name|data
operator||=
name|htole32
argument_list|(
name|plen
operator|<<
literal|16
argument_list|)
expr_stmt|;
name|raw
index|[
literal|0
index|]
operator|=
name|bwn_plcp_getcck
argument_list|(
name|rate
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|bwn_antenna_sanitize
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint8_t
name|n
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|uint8_t
name|mask
decl_stmt|;
if|if
condition|(
name|n
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|gmode
condition|)
name|mask
operator|=
name|siba_sprom_get_ant_bg
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
expr_stmt|;
else|else
name|mask
operator|=
name|siba_sprom_get_ant_a
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|mask
operator|&
operator|(
literal|1
operator|<<
operator|(
name|n
operator|-
literal|1
operator|)
operator|)
operator|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
return|return
operator|(
name|n
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Return a fallback rate for the given rate.  *  * Note: Don't fall back from OFDM to CCK.  */
end_comment

begin_function
specifier|static
name|uint8_t
name|bwn_get_fbrate
parameter_list|(
name|uint8_t
name|bitrate
parameter_list|)
block|{
switch|switch
condition|(
name|bitrate
condition|)
block|{
comment|/* CCK */
case|case
name|BWN_CCK_RATE_1MB
case|:
return|return
operator|(
name|BWN_CCK_RATE_1MB
operator|)
return|;
case|case
name|BWN_CCK_RATE_2MB
case|:
return|return
operator|(
name|BWN_CCK_RATE_1MB
operator|)
return|;
case|case
name|BWN_CCK_RATE_5MB
case|:
return|return
operator|(
name|BWN_CCK_RATE_2MB
operator|)
return|;
case|case
name|BWN_CCK_RATE_11MB
case|:
return|return
operator|(
name|BWN_CCK_RATE_5MB
operator|)
return|;
comment|/* OFDM */
case|case
name|BWN_OFDM_RATE_6MB
case|:
return|return
operator|(
name|BWN_OFDM_RATE_6MB
operator|)
return|;
case|case
name|BWN_OFDM_RATE_9MB
case|:
return|return
operator|(
name|BWN_OFDM_RATE_6MB
operator|)
return|;
case|case
name|BWN_OFDM_RATE_12MB
case|:
return|return
operator|(
name|BWN_OFDM_RATE_9MB
operator|)
return|;
case|case
name|BWN_OFDM_RATE_18MB
case|:
return|return
operator|(
name|BWN_OFDM_RATE_12MB
operator|)
return|;
case|case
name|BWN_OFDM_RATE_24MB
case|:
return|return
operator|(
name|BWN_OFDM_RATE_18MB
operator|)
return|;
case|case
name|BWN_OFDM_RATE_36MB
case|:
return|return
operator|(
name|BWN_OFDM_RATE_24MB
operator|)
return|;
case|case
name|BWN_OFDM_RATE_48MB
case|:
return|return
operator|(
name|BWN_OFDM_RATE_36MB
operator|)
return|;
case|case
name|BWN_OFDM_RATE_54MB
case|:
return|return
operator|(
name|BWN_OFDM_RATE_48MB
operator|)
return|;
block|}
name|KASSERT
argument_list|(
literal|0
operator|==
literal|1
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|bwn_pio_write_multi_4
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|struct
name|bwn_pio_txqueue
modifier|*
name|tq
parameter_list|,
name|uint32_t
name|ctl
parameter_list|,
specifier|const
name|void
modifier|*
name|_data
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|uint32_t
name|value
init|=
literal|0
decl_stmt|;
specifier|const
name|uint8_t
modifier|*
name|data
init|=
name|_data
decl_stmt|;
name|ctl
operator||=
name|BWN_PIO8_TXCTL_0_7
operator||
name|BWN_PIO8_TXCTL_8_15
operator||
name|BWN_PIO8_TXCTL_16_23
operator||
name|BWN_PIO8_TXCTL_24_31
expr_stmt|;
name|bwn_pio_write_4
argument_list|(
name|mac
argument_list|,
name|tq
argument_list|,
name|BWN_PIO8_TXCTL
argument_list|,
name|ctl
argument_list|)
expr_stmt|;
name|siba_write_multi_4
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
name|data
argument_list|,
operator|(
name|len
operator|&
operator|~
literal|3
operator|)
argument_list|,
name|tq
operator|->
name|tq_base
operator|+
name|BWN_PIO8_TXDATA
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|&
literal|3
condition|)
block|{
name|ctl
operator|&=
operator|~
operator|(
name|BWN_PIO8_TXCTL_8_15
operator||
name|BWN_PIO8_TXCTL_16_23
operator||
name|BWN_PIO8_TXCTL_24_31
operator|)
expr_stmt|;
name|data
operator|=
operator|&
operator|(
name|data
index|[
name|len
operator|-
literal|1
index|]
operator|)
expr_stmt|;
switch|switch
condition|(
name|len
operator|&
literal|3
condition|)
block|{
case|case
literal|3
case|:
name|ctl
operator||=
name|BWN_PIO8_TXCTL_16_23
expr_stmt|;
name|value
operator||=
call|(
name|uint32_t
call|)
argument_list|(
operator|*
name|data
argument_list|)
operator|<<
literal|16
expr_stmt|;
name|data
operator|--
expr_stmt|;
case|case
literal|2
case|:
name|ctl
operator||=
name|BWN_PIO8_TXCTL_8_15
expr_stmt|;
name|value
operator||=
call|(
name|uint32_t
call|)
argument_list|(
operator|*
name|data
argument_list|)
operator|<<
literal|8
expr_stmt|;
name|data
operator|--
expr_stmt|;
case|case
literal|1
case|:
name|value
operator||=
call|(
name|uint32_t
call|)
argument_list|(
operator|*
name|data
argument_list|)
expr_stmt|;
block|}
name|bwn_pio_write_4
argument_list|(
name|mac
argument_list|,
name|tq
argument_list|,
name|BWN_PIO8_TXCTL
argument_list|,
name|ctl
argument_list|)
expr_stmt|;
name|bwn_pio_write_4
argument_list|(
name|mac
argument_list|,
name|tq
argument_list|,
name|BWN_PIO8_TXDATA
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|ctl
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_pio_write_4
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|struct
name|bwn_pio_txqueue
modifier|*
name|tq
parameter_list|,
name|uint16_t
name|offset
parameter_list|,
name|uint32_t
name|value
parameter_list|)
block|{
name|BWN_WRITE_4
argument_list|(
name|mac
argument_list|,
name|tq
operator|->
name|tq_base
operator|+
name|offset
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|uint16_t
name|bwn_pio_write_multi_2
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|struct
name|bwn_pio_txqueue
modifier|*
name|tq
parameter_list|,
name|uint16_t
name|ctl
parameter_list|,
specifier|const
name|void
modifier|*
name|_data
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
specifier|const
name|uint8_t
modifier|*
name|data
init|=
name|_data
decl_stmt|;
name|ctl
operator||=
name|BWN_PIO_TXCTL_WRITELO
operator||
name|BWN_PIO_TXCTL_WRITEHI
expr_stmt|;
name|BWN_PIO_WRITE_2
argument_list|(
name|mac
argument_list|,
name|tq
argument_list|,
name|BWN_PIO_TXCTL
argument_list|,
name|ctl
argument_list|)
expr_stmt|;
name|siba_write_multi_2
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
name|data
argument_list|,
operator|(
name|len
operator|&
operator|~
literal|1
operator|)
argument_list|,
name|tq
operator|->
name|tq_base
operator|+
name|BWN_PIO_TXDATA
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|&
literal|1
condition|)
block|{
name|ctl
operator|&=
operator|~
name|BWN_PIO_TXCTL_WRITEHI
expr_stmt|;
name|BWN_PIO_WRITE_2
argument_list|(
name|mac
argument_list|,
name|tq
argument_list|,
name|BWN_PIO_TXCTL
argument_list|,
name|ctl
argument_list|)
expr_stmt|;
name|BWN_PIO_WRITE_2
argument_list|(
name|mac
argument_list|,
name|tq
argument_list|,
name|BWN_PIO_TXDATA
argument_list|,
name|data
index|[
name|len
operator|-
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|ctl
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint16_t
name|bwn_pio_write_mbuf_2
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|struct
name|bwn_pio_txqueue
modifier|*
name|tq
parameter_list|,
name|uint16_t
name|ctl
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m0
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
init|=
literal|0
decl_stmt|;
name|uint16_t
name|data
init|=
literal|0
decl_stmt|;
specifier|const
name|uint8_t
modifier|*
name|buf
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
init|=
name|m0
decl_stmt|;
name|ctl
operator||=
name|BWN_PIO_TXCTL_WRITELO
operator||
name|BWN_PIO_TXCTL_WRITEHI
expr_stmt|;
name|BWN_PIO_WRITE_2
argument_list|(
name|mac
argument_list|,
name|tq
argument_list|,
name|BWN_PIO_TXCTL
argument_list|,
name|ctl
argument_list|)
expr_stmt|;
for|for
control|(
init|;
name|m
operator|!=
name|NULL
condition|;
name|m
operator|=
name|m
operator|->
name|m_next
control|)
block|{
name|buf
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
specifier|const
name|uint8_t
operator|*
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|m
operator|->
name|m_len
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
operator|(
name|j
operator|++
operator|)
operator|%
literal|2
operator|)
condition|)
name|data
operator||=
name|buf
index|[
name|i
index|]
expr_stmt|;
else|else
block|{
name|data
operator||=
operator|(
name|buf
index|[
name|i
index|]
operator|<<
literal|8
operator|)
expr_stmt|;
name|BWN_PIO_WRITE_2
argument_list|(
name|mac
argument_list|,
name|tq
argument_list|,
name|BWN_PIO_TXDATA
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|data
operator|=
literal|0
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|m0
operator|->
name|m_pkthdr
operator|.
name|len
operator|%
literal|2
condition|)
block|{
name|ctl
operator|&=
operator|~
name|BWN_PIO_TXCTL_WRITEHI
expr_stmt|;
name|BWN_PIO_WRITE_2
argument_list|(
name|mac
argument_list|,
name|tq
argument_list|,
name|BWN_PIO_TXCTL
argument_list|,
name|ctl
argument_list|)
expr_stmt|;
name|BWN_PIO_WRITE_2
argument_list|(
name|mac
argument_list|,
name|tq
argument_list|,
name|BWN_PIO_TXDATA
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|ctl
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_set_slot_time
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint16_t
name|time
parameter_list|)
block|{
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|type
operator|!=
name|BWN_PHYTYPE_G
condition|)
return|return;
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
literal|0x684
argument_list|,
literal|510
operator|+
name|time
argument_list|)
expr_stmt|;
name|bwn_shm_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_SHARED
argument_list|,
literal|0x0010
argument_list|,
name|time
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|bwn_dma_ring
modifier|*
name|bwn_dma_select
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint8_t
name|prio
parameter_list|)
block|{
if|if
condition|(
operator|(
name|mac
operator|->
name|mac_flags
operator|&
name|BWN_MAC_FLAG_WME
operator|)
operator|==
literal|0
condition|)
return|return
operator|(
name|mac
operator|->
name|mac_method
operator|.
name|dma
operator|.
name|wme
index|[
name|WME_AC_BE
index|]
operator|)
return|;
switch|switch
condition|(
name|prio
condition|)
block|{
case|case
literal|3
case|:
return|return
operator|(
name|mac
operator|->
name|mac_method
operator|.
name|dma
operator|.
name|wme
index|[
name|WME_AC_VO
index|]
operator|)
return|;
case|case
literal|2
case|:
return|return
operator|(
name|mac
operator|->
name|mac_method
operator|.
name|dma
operator|.
name|wme
index|[
name|WME_AC_VI
index|]
operator|)
return|;
case|case
literal|0
case|:
return|return
operator|(
name|mac
operator|->
name|mac_method
operator|.
name|dma
operator|.
name|wme
index|[
name|WME_AC_BE
index|]
operator|)
return|;
case|case
literal|1
case|:
return|return
operator|(
name|mac
operator|->
name|mac_method
operator|.
name|dma
operator|.
name|wme
index|[
name|WME_AC_BK
index|]
operator|)
return|;
block|}
name|KASSERT
argument_list|(
literal|0
operator|==
literal|1
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bwn_dma_getslot
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
name|dr
parameter_list|)
block|{
name|int
name|slot
decl_stmt|;
name|BWN_ASSERT_LOCKED
argument_list|(
name|dr
operator|->
name|dr_mac
operator|->
name|mac_sc
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|dr
operator|->
name|dr_tx
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
operator|!
operator|(
name|dr
operator|->
name|dr_stop
operator|)
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|bwn_dma_freeslot
argument_list|(
name|dr
argument_list|)
operator|!=
literal|0
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
name|slot
operator|=
name|bwn_dma_nextslot
argument_list|(
name|dr
argument_list|,
name|dr
operator|->
name|dr_curslot
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
operator|!
operator|(
name|slot
operator|&
operator|~
literal|0x0fff
operator|)
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
name|dr
operator|->
name|dr_curslot
operator|=
name|slot
expr_stmt|;
name|dr
operator|->
name|dr_usedslot
operator|++
expr_stmt|;
return|return
operator|(
name|slot
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|bwn_pio_txqueue
modifier|*
name|bwn_pio_parse_cookie
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint16_t
name|cookie
parameter_list|,
name|struct
name|bwn_pio_txpkt
modifier|*
modifier|*
name|pack
parameter_list|)
block|{
name|struct
name|bwn_pio
modifier|*
name|pio
init|=
operator|&
name|mac
operator|->
name|mac_method
operator|.
name|pio
decl_stmt|;
name|struct
name|bwn_pio_txqueue
modifier|*
name|tq
init|=
name|NULL
decl_stmt|;
name|unsigned
name|int
name|index
decl_stmt|;
switch|switch
condition|(
name|cookie
operator|&
literal|0xf000
condition|)
block|{
case|case
literal|0x1000
case|:
name|tq
operator|=
operator|&
name|pio
operator|->
name|wme
index|[
name|WME_AC_BK
index|]
expr_stmt|;
break|break;
case|case
literal|0x2000
case|:
name|tq
operator|=
operator|&
name|pio
operator|->
name|wme
index|[
name|WME_AC_BE
index|]
expr_stmt|;
break|break;
case|case
literal|0x3000
case|:
name|tq
operator|=
operator|&
name|pio
operator|->
name|wme
index|[
name|WME_AC_VI
index|]
expr_stmt|;
break|break;
case|case
literal|0x4000
case|:
name|tq
operator|=
operator|&
name|pio
operator|->
name|wme
index|[
name|WME_AC_VO
index|]
expr_stmt|;
break|break;
case|case
literal|0x5000
case|:
name|tq
operator|=
operator|&
name|pio
operator|->
name|mcast
expr_stmt|;
break|break;
block|}
name|KASSERT
argument_list|(
name|tq
operator|!=
name|NULL
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tq
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|index
operator|=
operator|(
name|cookie
operator|&
literal|0x0fff
operator|)
expr_stmt|;
name|KASSERT
argument_list|(
name|index
operator|<
name|N
argument_list|(
name|tq
operator|->
name|tq_pkts
argument_list|)
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|index
operator|>=
name|N
argument_list|(
name|tq
operator|->
name|tq_pkts
argument_list|)
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
operator|*
name|pack
operator|=
operator|&
name|tq
operator|->
name|tq_pkts
index|[
name|index
index|]
expr_stmt|;
name|KASSERT
argument_list|(
operator|*
name|pack
operator|!=
name|NULL
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|tq
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_txpwr
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|int
name|npending
parameter_list|)
block|{
name|struct
name|bwn_mac
modifier|*
name|mac
init|=
name|arg
decl_stmt|;
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|BWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|&&
name|mac
operator|->
name|mac_status
operator|>=
name|BWN_MAC_STATUS_STARTED
operator|&&
name|mac
operator|->
name|mac_phy
operator|.
name|set_txpwr
operator|!=
name|NULL
condition|)
name|mac
operator|->
name|mac_phy
operator|.
name|set_txpwr
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|BWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_task_15s
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|uint16_t
name|reg
decl_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_fw
operator|.
name|opensource
condition|)
block|{
name|reg
operator|=
name|bwn_shm_read_2
argument_list|(
name|mac
argument_list|,
name|BWN_SCRATCH
argument_list|,
name|BWN_WATCHDOG_REG
argument_list|)
expr_stmt|;
if|if
condition|(
name|reg
condition|)
block|{
name|bwn_restart
argument_list|(
name|mac
argument_list|,
literal|"fw watchdog"
argument_list|)
expr_stmt|;
return|return;
block|}
name|bwn_shm_write_2
argument_list|(
name|mac
argument_list|,
name|BWN_SCRATCH
argument_list|,
name|BWN_WATCHDOG_REG
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|task_15s
condition|)
name|mac
operator|->
name|mac_phy
operator|.
name|task_15s
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|mac
operator|->
name|mac_phy
operator|.
name|txerrors
operator|=
name|BWN_TXERROR_MAX
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_task_30s
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|type
operator|!=
name|BWN_PHYTYPE_G
operator|||
name|mac
operator|->
name|mac_noise
operator|.
name|noi_running
condition|)
return|return;
name|mac
operator|->
name|mac_noise
operator|.
name|noi_running
operator|=
literal|1
expr_stmt|;
name|mac
operator|->
name|mac_noise
operator|.
name|noi_nsamples
operator|=
literal|0
expr_stmt|;
name|bwn_noise_gensample
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_task_60s
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|task_60s
condition|)
name|mac
operator|->
name|mac_phy
operator|.
name|task_60s
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|bwn_phy_txpower_check
argument_list|(
name|mac
argument_list|,
name|BWN_TXPWR_IGNORE_TIME
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_tasks
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|bwn_mac
modifier|*
name|mac
init|=
name|arg
decl_stmt|;
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|BWN_ASSERT_LOCKED
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_status
operator|!=
name|BWN_MAC_STATUS_STARTED
condition|)
return|return;
if|if
condition|(
name|mac
operator|->
name|mac_task_state
operator|%
literal|4
operator|==
literal|0
condition|)
name|bwn_task_60s
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_task_state
operator|%
literal|2
operator|==
literal|0
condition|)
name|bwn_task_30s
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|bwn_task_15s
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|mac
operator|->
name|mac_task_state
operator|++
expr_stmt|;
name|callout_reset
argument_list|(
operator|&
name|sc
operator|->
name|sc_task_ch
argument_list|,
name|hz
operator|*
literal|15
argument_list|,
name|bwn_tasks
argument_list|,
name|mac
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|bwn_plcp_get_ofdmrate
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|struct
name|bwn_plcp6
modifier|*
name|plcp
parameter_list|,
name|uint8_t
name|a
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|KASSERT
argument_list|(
name|a
operator|==
literal|0
argument_list|,
operator|(
literal|"not support APHY\n"
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|plcp
operator|->
name|o
operator|.
name|raw
index|[
literal|0
index|]
operator|&
literal|0xf
condition|)
block|{
case|case
literal|0xb
case|:
return|return
operator|(
name|BWN_OFDM_RATE_6MB
operator|)
return|;
case|case
literal|0xf
case|:
return|return
operator|(
name|BWN_OFDM_RATE_9MB
operator|)
return|;
case|case
literal|0xa
case|:
return|return
operator|(
name|BWN_OFDM_RATE_12MB
operator|)
return|;
case|case
literal|0xe
case|:
return|return
operator|(
name|BWN_OFDM_RATE_18MB
operator|)
return|;
case|case
literal|0x9
case|:
return|return
operator|(
name|BWN_OFDM_RATE_24MB
operator|)
return|;
case|case
literal|0xd
case|:
return|return
operator|(
name|BWN_OFDM_RATE_36MB
operator|)
return|;
case|case
literal|0x8
case|:
return|return
operator|(
name|BWN_OFDM_RATE_48MB
operator|)
return|;
case|case
literal|0xc
case|:
return|return
operator|(
name|BWN_OFDM_RATE_54MB
operator|)
return|;
block|}
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"incorrect OFDM rate %d\n"
argument_list|,
name|plcp
operator|->
name|o
operator|.
name|raw
index|[
literal|0
index|]
operator|&
literal|0xf
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bwn_plcp_get_cckrate
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|struct
name|bwn_plcp6
modifier|*
name|plcp
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
switch|switch
condition|(
name|plcp
operator|->
name|o
operator|.
name|raw
index|[
literal|0
index|]
condition|)
block|{
case|case
literal|0x0a
case|:
return|return
operator|(
name|BWN_CCK_RATE_1MB
operator|)
return|;
case|case
literal|0x14
case|:
return|return
operator|(
name|BWN_CCK_RATE_2MB
operator|)
return|;
case|case
literal|0x37
case|:
return|return
operator|(
name|BWN_CCK_RATE_5MB
operator|)
return|;
case|case
literal|0x6e
case|:
return|return
operator|(
name|BWN_CCK_RATE_11MB
operator|)
return|;
block|}
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"incorrect CCK rate %d\n"
argument_list|,
name|plcp
operator|->
name|o
operator|.
name|raw
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_rx_radiotap
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
specifier|const
name|struct
name|bwn_rxhdr4
modifier|*
name|rxhdr
parameter_list|,
name|struct
name|bwn_plcp6
modifier|*
name|plcp
parameter_list|,
name|int
name|rate
parameter_list|,
name|int
name|rssi
parameter_list|,
name|int
name|noise
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
specifier|const
name|struct
name|ieee80211_frame_min
modifier|*
name|wh
decl_stmt|;
name|uint64_t
name|tsf
decl_stmt|;
name|uint16_t
name|low_mactime_now
decl_stmt|;
if|if
condition|(
name|htole16
argument_list|(
name|rxhdr
operator|->
name|phy_status0
argument_list|)
operator|&
name|BWN_RX_PHYST0_SHORTPRMBL
condition|)
name|sc
operator|->
name|sc_rx_th
operator|.
name|wr_flags
operator||=
name|IEEE80211_RADIOTAP_F_SHORTPRE
expr_stmt|;
name|wh
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
specifier|const
expr|struct
name|ieee80211_frame_min
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator|&
name|IEEE80211_FC1_PROTECTED
condition|)
name|sc
operator|->
name|sc_rx_th
operator|.
name|wr_flags
operator||=
name|IEEE80211_RADIOTAP_F_WEP
expr_stmt|;
name|bwn_tsf_read
argument_list|(
name|mac
argument_list|,
operator|&
name|tsf
argument_list|)
expr_stmt|;
name|low_mactime_now
operator|=
name|tsf
expr_stmt|;
name|tsf
operator|=
name|tsf
operator|&
operator|~
literal|0xffffULL
expr_stmt|;
name|tsf
operator|+=
name|le16toh
argument_list|(
name|rxhdr
operator|->
name|mac_time
argument_list|)
expr_stmt|;
if|if
condition|(
name|low_mactime_now
operator|<
name|le16toh
argument_list|(
name|rxhdr
operator|->
name|mac_time
argument_list|)
condition|)
name|tsf
operator|-=
literal|0x10000
expr_stmt|;
name|sc
operator|->
name|sc_rx_th
operator|.
name|wr_tsf
operator|=
name|tsf
expr_stmt|;
name|sc
operator|->
name|sc_rx_th
operator|.
name|wr_rate
operator|=
name|rate
expr_stmt|;
name|sc
operator|->
name|sc_rx_th
operator|.
name|wr_antsignal
operator|=
name|rssi
expr_stmt|;
name|sc
operator|->
name|sc_rx_th
operator|.
name|wr_antnoise
operator|=
name|noise
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_tsf_read
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|uint64_t
modifier|*
name|tsf
parameter_list|)
block|{
name|uint32_t
name|low
decl_stmt|,
name|high
decl_stmt|;
name|KASSERT
argument_list|(
name|siba_get_revid
argument_list|(
name|mac
operator|->
name|mac_sc
operator|->
name|sc_dev
argument_list|)
operator|>=
literal|3
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
name|low
operator|=
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|BWN_REV3PLUS_TSF_LOW
argument_list|)
expr_stmt|;
name|high
operator|=
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|BWN_REV3PLUS_TSF_HIGH
argument_list|)
expr_stmt|;
operator|*
name|tsf
operator|=
name|high
expr_stmt|;
operator|*
name|tsf
operator|<<=
literal|32
expr_stmt|;
operator|*
name|tsf
operator||=
name|low
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|bwn_dma_attach
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_dma
modifier|*
name|dma
init|=
operator|&
name|mac
operator|->
name|mac_method
operator|.
name|dma
decl_stmt|;
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|bus_addr_t
name|lowaddr
init|=
literal|0
decl_stmt|;
name|int
name|error
decl_stmt|;
if|if
condition|(
name|siba_get_type
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
name|SIBA_TYPE_PCMCIA
operator|||
name|bwn_usedma
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|KASSERT
argument_list|(
name|siba_get_revid
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|>=
literal|5
argument_list|,
operator|(
literal|"%s: fail"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
name|mac
operator|->
name|mac_flags
operator||=
name|BWN_MAC_FLAG_DMA
expr_stmt|;
name|dma
operator|->
name|dmatype
operator|=
name|bwn_dma_gettype
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|dma
operator|->
name|dmatype
operator|==
name|BWN_DMA_30BIT
condition|)
name|lowaddr
operator|=
name|BWN_BUS_SPACE_MAXADDR_30BIT
expr_stmt|;
elseif|else
if|if
condition|(
name|dma
operator|->
name|dmatype
operator|==
name|BWN_DMA_32BIT
condition|)
name|lowaddr
operator|=
name|BUS_SPACE_MAXADDR_32BIT
expr_stmt|;
else|else
name|lowaddr
operator|=
name|BUS_SPACE_MAXADDR
expr_stmt|;
comment|/* 	 * Create top level DMA tag 	 */
name|error
operator|=
name|bus_dma_tag_create
argument_list|(
name|bus_get_dma_tag
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
comment|/* parent */
name|BWN_ALIGN
argument_list|,
literal|0
argument_list|,
comment|/* alignment, bounds */
name|lowaddr
argument_list|,
comment|/* lowaddr */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* highaddr */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* filter, filterarg */
name|BUS_SPACE_MAXSIZE
argument_list|,
comment|/* maxsize */
name|BUS_SPACE_UNRESTRICTED
argument_list|,
comment|/* nsegments */
name|BUS_SPACE_MAXSIZE
argument_list|,
comment|/* maxsegsize */
literal|0
argument_list|,
comment|/* flags */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* lockfunc, lockarg */
operator|&
name|dma
operator|->
name|parent_dtag
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"can't create parent DMA tag\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
comment|/* 	 * Create TX/RX mbuf DMA tag 	 */
name|error
operator|=
name|bus_dma_tag_create
argument_list|(
name|dma
operator|->
name|parent_dtag
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
name|BUS_SPACE_MAXADDR
argument_list|,
name|BUS_SPACE_MAXADDR
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|MCLBYTES
argument_list|,
literal|1
argument_list|,
name|BUS_SPACE_MAXSIZE_32BIT
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|dma
operator|->
name|rxbuf_dtag
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"can't create mbuf DMA tag\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail0
goto|;
block|}
name|error
operator|=
name|bus_dma_tag_create
argument_list|(
name|dma
operator|->
name|parent_dtag
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
name|BUS_SPACE_MAXADDR
argument_list|,
name|BUS_SPACE_MAXADDR
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|MCLBYTES
argument_list|,
literal|1
argument_list|,
name|BUS_SPACE_MAXSIZE_32BIT
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|dma
operator|->
name|txbuf_dtag
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"can't create mbuf DMA tag\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
name|dma
operator|->
name|wme
index|[
name|WME_AC_BK
index|]
operator|=
name|bwn_dma_ringsetup
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|dma
operator|->
name|dmatype
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dma
operator|->
name|wme
index|[
name|WME_AC_BK
index|]
condition|)
goto|goto
name|fail2
goto|;
name|dma
operator|->
name|wme
index|[
name|WME_AC_BE
index|]
operator|=
name|bwn_dma_ringsetup
argument_list|(
name|mac
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|dma
operator|->
name|dmatype
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dma
operator|->
name|wme
index|[
name|WME_AC_BE
index|]
condition|)
goto|goto
name|fail3
goto|;
name|dma
operator|->
name|wme
index|[
name|WME_AC_VI
index|]
operator|=
name|bwn_dma_ringsetup
argument_list|(
name|mac
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|dma
operator|->
name|dmatype
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dma
operator|->
name|wme
index|[
name|WME_AC_VI
index|]
condition|)
goto|goto
name|fail4
goto|;
name|dma
operator|->
name|wme
index|[
name|WME_AC_VO
index|]
operator|=
name|bwn_dma_ringsetup
argument_list|(
name|mac
argument_list|,
literal|3
argument_list|,
literal|1
argument_list|,
name|dma
operator|->
name|dmatype
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dma
operator|->
name|wme
index|[
name|WME_AC_VO
index|]
condition|)
goto|goto
name|fail5
goto|;
name|dma
operator|->
name|mcast
operator|=
name|bwn_dma_ringsetup
argument_list|(
name|mac
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|dma
operator|->
name|dmatype
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dma
operator|->
name|mcast
condition|)
goto|goto
name|fail6
goto|;
name|dma
operator|->
name|rx
operator|=
name|bwn_dma_ringsetup
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|dma
operator|->
name|dmatype
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dma
operator|->
name|rx
condition|)
goto|goto
name|fail7
goto|;
return|return
operator|(
name|error
operator|)
return|;
name|fail7
label|:
name|bwn_dma_ringfree
argument_list|(
operator|&
name|dma
operator|->
name|mcast
argument_list|)
expr_stmt|;
name|fail6
label|:
name|bwn_dma_ringfree
argument_list|(
operator|&
name|dma
operator|->
name|wme
index|[
name|WME_AC_VO
index|]
argument_list|)
expr_stmt|;
name|fail5
label|:
name|bwn_dma_ringfree
argument_list|(
operator|&
name|dma
operator|->
name|wme
index|[
name|WME_AC_VI
index|]
argument_list|)
expr_stmt|;
name|fail4
label|:
name|bwn_dma_ringfree
argument_list|(
operator|&
name|dma
operator|->
name|wme
index|[
name|WME_AC_BE
index|]
argument_list|)
expr_stmt|;
name|fail3
label|:
name|bwn_dma_ringfree
argument_list|(
operator|&
name|dma
operator|->
name|wme
index|[
name|WME_AC_BK
index|]
argument_list|)
expr_stmt|;
name|fail2
label|:
name|bus_dma_tag_destroy
argument_list|(
name|dma
operator|->
name|txbuf_dtag
argument_list|)
expr_stmt|;
name|fail1
label|:
name|bus_dma_tag_destroy
argument_list|(
name|dma
operator|->
name|rxbuf_dtag
argument_list|)
expr_stmt|;
name|fail0
label|:
name|bus_dma_tag_destroy
argument_list|(
name|dma
operator|->
name|parent_dtag
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|bwn_dma_ring
modifier|*
name|bwn_dma_parse_cookie
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
specifier|const
name|struct
name|bwn_txstatus
modifier|*
name|status
parameter_list|,
name|uint16_t
name|cookie
parameter_list|,
name|int
modifier|*
name|slot
parameter_list|)
block|{
name|struct
name|bwn_dma
modifier|*
name|dma
init|=
operator|&
name|mac
operator|->
name|mac_method
operator|.
name|dma
decl_stmt|;
name|struct
name|bwn_dma_ring
modifier|*
name|dr
decl_stmt|;
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|BWN_ASSERT_LOCKED
argument_list|(
name|mac
operator|->
name|mac_sc
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cookie
operator|&
literal|0xf000
condition|)
block|{
case|case
literal|0x1000
case|:
name|dr
operator|=
name|dma
operator|->
name|wme
index|[
name|WME_AC_BK
index|]
expr_stmt|;
break|break;
case|case
literal|0x2000
case|:
name|dr
operator|=
name|dma
operator|->
name|wme
index|[
name|WME_AC_BE
index|]
expr_stmt|;
break|break;
case|case
literal|0x3000
case|:
name|dr
operator|=
name|dma
operator|->
name|wme
index|[
name|WME_AC_VI
index|]
expr_stmt|;
break|break;
case|case
literal|0x4000
case|:
name|dr
operator|=
name|dma
operator|->
name|wme
index|[
name|WME_AC_VO
index|]
expr_stmt|;
break|break;
case|case
literal|0x5000
case|:
name|dr
operator|=
name|dma
operator|->
name|mcast
expr_stmt|;
break|break;
default|default:
name|dr
operator|=
name|NULL
expr_stmt|;
name|KASSERT
argument_list|(
literal|0
operator|==
literal|1
argument_list|,
operator|(
literal|"invalid cookie value %d"
operator|,
name|cookie
operator|&
literal|0xf000
operator|)
argument_list|)
expr_stmt|;
block|}
operator|*
name|slot
operator|=
operator|(
name|cookie
operator|&
literal|0x0fff
operator|)
expr_stmt|;
if|if
condition|(
operator|*
name|slot
operator|<
literal|0
operator|||
operator|*
name|slot
operator|>=
name|dr
operator|->
name|dr_numslots
condition|)
block|{
comment|/* 		 * XXX FIXME: sometimes H/W returns TX DONE events duplicately 		 * that it occurs events which have same H/W sequence numbers. 		 * When it's occurred just prints a WARNING msgs and ignores. 		 */
name|KASSERT
argument_list|(
name|status
operator|->
name|seq
operator|==
name|dma
operator|->
name|lastseq
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"out of slot ranges (0< %d< %d)\n"
argument_list|,
operator|*
name|slot
argument_list|,
name|dr
operator|->
name|dr_numslots
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|dma
operator|->
name|lastseq
operator|=
name|status
operator|->
name|seq
expr_stmt|;
return|return
operator|(
name|dr
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_dma_stop
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_dma
modifier|*
name|dma
decl_stmt|;
if|if
condition|(
operator|(
name|mac
operator|->
name|mac_flags
operator|&
name|BWN_MAC_FLAG_DMA
operator|)
operator|==
literal|0
condition|)
return|return;
name|dma
operator|=
operator|&
name|mac
operator|->
name|mac_method
operator|.
name|dma
expr_stmt|;
name|bwn_dma_ringstop
argument_list|(
operator|&
name|dma
operator|->
name|rx
argument_list|)
expr_stmt|;
name|bwn_dma_ringstop
argument_list|(
operator|&
name|dma
operator|->
name|wme
index|[
name|WME_AC_BK
index|]
argument_list|)
expr_stmt|;
name|bwn_dma_ringstop
argument_list|(
operator|&
name|dma
operator|->
name|wme
index|[
name|WME_AC_BE
index|]
argument_list|)
expr_stmt|;
name|bwn_dma_ringstop
argument_list|(
operator|&
name|dma
operator|->
name|wme
index|[
name|WME_AC_VI
index|]
argument_list|)
expr_stmt|;
name|bwn_dma_ringstop
argument_list|(
operator|&
name|dma
operator|->
name|wme
index|[
name|WME_AC_VO
index|]
argument_list|)
expr_stmt|;
name|bwn_dma_ringstop
argument_list|(
operator|&
name|dma
operator|->
name|mcast
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_dma_ringstop
parameter_list|(
name|struct
name|bwn_dma_ring
modifier|*
modifier|*
name|dr
parameter_list|)
block|{
if|if
condition|(
name|dr
operator|==
name|NULL
condition|)
return|return;
name|bwn_dma_cleanup
argument_list|(
operator|*
name|dr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_pio_stop
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_pio
modifier|*
name|pio
decl_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_flags
operator|&
name|BWN_MAC_FLAG_DMA
condition|)
return|return;
name|pio
operator|=
operator|&
name|mac
operator|->
name|mac_method
operator|.
name|pio
expr_stmt|;
name|bwn_destroy_queue_tx
argument_list|(
operator|&
name|pio
operator|->
name|mcast
argument_list|)
expr_stmt|;
name|bwn_destroy_queue_tx
argument_list|(
operator|&
name|pio
operator|->
name|wme
index|[
name|WME_AC_VO
index|]
argument_list|)
expr_stmt|;
name|bwn_destroy_queue_tx
argument_list|(
operator|&
name|pio
operator|->
name|wme
index|[
name|WME_AC_VI
index|]
argument_list|)
expr_stmt|;
name|bwn_destroy_queue_tx
argument_list|(
operator|&
name|pio
operator|->
name|wme
index|[
name|WME_AC_BE
index|]
argument_list|)
expr_stmt|;
name|bwn_destroy_queue_tx
argument_list|(
operator|&
name|pio
operator|->
name|wme
index|[
name|WME_AC_BK
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_led_attach
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
specifier|const
name|uint8_t
modifier|*
name|led_act
init|=
name|NULL
decl_stmt|;
name|uint16_t
name|val
index|[
name|BWN_LED_MAX
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
name|sc
operator|->
name|sc_led_idle
operator|=
operator|(
literal|2350
operator|*
name|hz
operator|)
operator|/
literal|1000
expr_stmt|;
name|sc
operator|->
name|sc_led_blink
operator|=
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|N
argument_list|(
name|bwn_vendor_led_act
argument_list|)
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|siba_get_pci_subvendor
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|==
name|bwn_vendor_led_act
index|[
name|i
index|]
operator|.
name|vid
condition|)
block|{
name|led_act
operator|=
name|bwn_vendor_led_act
index|[
name|i
index|]
operator|.
name|led_act
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|led_act
operator|==
name|NULL
condition|)
name|led_act
operator|=
name|bwn_default_led_act
expr_stmt|;
name|val
index|[
literal|0
index|]
operator|=
name|siba_sprom_get_gpio0
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
expr_stmt|;
name|val
index|[
literal|1
index|]
operator|=
name|siba_sprom_get_gpio1
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
expr_stmt|;
name|val
index|[
literal|2
index|]
operator|=
name|siba_sprom_get_gpio2
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
expr_stmt|;
name|val
index|[
literal|3
index|]
operator|=
name|siba_sprom_get_gpio3
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|BWN_LED_MAX
condition|;
operator|++
name|i
control|)
block|{
name|struct
name|bwn_led
modifier|*
name|led
init|=
operator|&
name|sc
operator|->
name|sc_leds
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
name|val
index|[
name|i
index|]
operator|==
literal|0xff
condition|)
block|{
name|led
operator|->
name|led_act
operator|=
name|led_act
index|[
name|i
index|]
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|val
index|[
name|i
index|]
operator|&
name|BWN_LED_ACT_LOW
condition|)
name|led
operator|->
name|led_flags
operator||=
name|BWN_LED_F_ACTLOW
expr_stmt|;
name|led
operator|->
name|led_act
operator|=
name|val
index|[
name|i
index|]
operator|&
name|BWN_LED_ACT_MASK
expr_stmt|;
block|}
name|led
operator|->
name|led_mask
operator|=
operator|(
literal|1
operator|<<
name|i
operator|)
expr_stmt|;
if|if
condition|(
name|led
operator|->
name|led_act
operator|==
name|BWN_LED_ACT_BLINK_SLOW
operator|||
name|led
operator|->
name|led_act
operator|==
name|BWN_LED_ACT_BLINK_POLL
operator|||
name|led
operator|->
name|led_act
operator|==
name|BWN_LED_ACT_BLINK
condition|)
block|{
name|led
operator|->
name|led_flags
operator||=
name|BWN_LED_F_BLINK
expr_stmt|;
if|if
condition|(
name|led
operator|->
name|led_act
operator|==
name|BWN_LED_ACT_BLINK_POLL
condition|)
name|led
operator|->
name|led_flags
operator||=
name|BWN_LED_F_POLLABLE
expr_stmt|;
elseif|else
if|if
condition|(
name|led
operator|->
name|led_act
operator|==
name|BWN_LED_ACT_BLINK_SLOW
condition|)
name|led
operator|->
name|led_flags
operator||=
name|BWN_LED_F_SLOW
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_blink_led
operator|==
name|NULL
condition|)
block|{
name|sc
operator|->
name|sc_blink_led
operator|=
name|led
expr_stmt|;
if|if
condition|(
name|led
operator|->
name|led_flags
operator|&
name|BWN_LED_F_SLOW
condition|)
name|BWN_LED_SLOWDOWN
argument_list|(
name|sc
operator|->
name|sc_led_idle
argument_list|)
expr_stmt|;
block|}
block|}
name|DPRINTF
argument_list|(
name|sc
argument_list|,
name|BWN_DEBUG_LED
argument_list|,
literal|"%dth led, act %d, lowact %d\n"
argument_list|,
name|i
argument_list|,
name|led
operator|->
name|led_act
argument_list|,
name|led
operator|->
name|led_flags
operator|&
name|BWN_LED_F_ACTLOW
argument_list|)
expr_stmt|;
block|}
name|callout_init_mtx
argument_list|(
operator|&
name|sc
operator|->
name|sc_led_blink_ch
argument_list|,
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|__inline
name|uint16_t
name|bwn_led_onoff
parameter_list|(
specifier|const
name|struct
name|bwn_led
modifier|*
name|led
parameter_list|,
name|uint16_t
name|val
parameter_list|,
name|int
name|on
parameter_list|)
block|{
if|if
condition|(
name|led
operator|->
name|led_flags
operator|&
name|BWN_LED_F_ACTLOW
condition|)
name|on
operator|=
operator|!
name|on
expr_stmt|;
if|if
condition|(
name|on
condition|)
name|val
operator||=
name|led
operator|->
name|led_mask
expr_stmt|;
else|else
name|val
operator|&=
operator|~
name|led
operator|->
name|led_mask
expr_stmt|;
return|return
name|val
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_led_newstate
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|enum
name|ieee80211_state
name|nstate
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
name|uint16_t
name|val
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|nstate
operator|==
name|IEEE80211_S_INIT
condition|)
block|{
name|callout_stop
argument_list|(
operator|&
name|sc
operator|->
name|sc_led_blink_ch
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_led_blinking
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|BWN_FLAG_RUNNING
operator|)
operator|==
literal|0
condition|)
return|return;
name|val
operator|=
name|BWN_READ_2
argument_list|(
name|mac
argument_list|,
name|BWN_GPIO_CONTROL
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|BWN_LED_MAX
condition|;
operator|++
name|i
control|)
block|{
name|struct
name|bwn_led
modifier|*
name|led
init|=
operator|&
name|sc
operator|->
name|sc_leds
index|[
name|i
index|]
decl_stmt|;
name|int
name|on
decl_stmt|;
if|if
condition|(
name|led
operator|->
name|led_act
operator|==
name|BWN_LED_ACT_UNKN
operator|||
name|led
operator|->
name|led_act
operator|==
name|BWN_LED_ACT_NULL
condition|)
continue|continue;
if|if
condition|(
operator|(
name|led
operator|->
name|led_flags
operator|&
name|BWN_LED_F_BLINK
operator|)
operator|&&
name|nstate
operator|!=
name|IEEE80211_S_INIT
condition|)
continue|continue;
switch|switch
condition|(
name|led
operator|->
name|led_act
condition|)
block|{
case|case
name|BWN_LED_ACT_ON
case|:
comment|/* Always on */
name|on
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|BWN_LED_ACT_OFF
case|:
comment|/* Always off */
case|case
name|BWN_LED_ACT_5GHZ
case|:
comment|/* TODO: 11A */
name|on
operator|=
literal|0
expr_stmt|;
break|break;
default|default:
name|on
operator|=
literal|1
expr_stmt|;
switch|switch
condition|(
name|nstate
condition|)
block|{
case|case
name|IEEE80211_S_INIT
case|:
name|on
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|IEEE80211_S_RUN
case|:
if|if
condition|(
name|led
operator|->
name|led_act
operator|==
name|BWN_LED_ACT_11G
operator|&&
name|ic
operator|->
name|ic_curmode
operator|!=
name|IEEE80211_MODE_11G
condition|)
name|on
operator|=
literal|0
expr_stmt|;
break|break;
default|default:
if|if
condition|(
name|led
operator|->
name|led_act
operator|==
name|BWN_LED_ACT_ASSOC
condition|)
name|on
operator|=
literal|0
expr_stmt|;
break|break;
block|}
break|break;
block|}
name|val
operator|=
name|bwn_led_onoff
argument_list|(
name|led
argument_list|,
name|val
argument_list|,
name|on
argument_list|)
expr_stmt|;
block|}
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
name|BWN_GPIO_CONTROL
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_led_event
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|int
name|event
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|struct
name|bwn_led
modifier|*
name|led
init|=
name|sc
operator|->
name|sc_blink_led
decl_stmt|;
name|int
name|rate
decl_stmt|;
if|if
condition|(
name|event
operator|==
name|BWN_LED_EVENT_POLL
condition|)
block|{
if|if
condition|(
operator|(
name|led
operator|->
name|led_flags
operator|&
name|BWN_LED_F_POLLABLE
operator|)
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
name|ticks
operator|-
name|sc
operator|->
name|sc_led_ticks
operator|<
name|sc
operator|->
name|sc_led_idle
condition|)
return|return;
block|}
name|sc
operator|->
name|sc_led_ticks
operator|=
name|ticks
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_led_blinking
condition|)
return|return;
switch|switch
condition|(
name|event
condition|)
block|{
case|case
name|BWN_LED_EVENT_RX
case|:
name|rate
operator|=
name|sc
operator|->
name|sc_rx_rate
expr_stmt|;
break|break;
case|case
name|BWN_LED_EVENT_TX
case|:
name|rate
operator|=
name|sc
operator|->
name|sc_tx_rate
expr_stmt|;
break|break;
case|case
name|BWN_LED_EVENT_POLL
case|:
name|rate
operator|=
literal|0
expr_stmt|;
break|break;
default|default:
name|panic
argument_list|(
literal|"unknown LED event %d\n"
argument_list|,
name|event
argument_list|)
expr_stmt|;
break|break;
block|}
name|bwn_led_blink_start
argument_list|(
name|mac
argument_list|,
name|bwn_led_duration
index|[
name|rate
index|]
operator|.
name|on_dur
argument_list|,
name|bwn_led_duration
index|[
name|rate
index|]
operator|.
name|off_dur
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_led_blink_start
parameter_list|(
name|struct
name|bwn_mac
modifier|*
name|mac
parameter_list|,
name|int
name|on_dur
parameter_list|,
name|int
name|off_dur
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|struct
name|bwn_led
modifier|*
name|led
init|=
name|sc
operator|->
name|sc_blink_led
decl_stmt|;
name|uint16_t
name|val
decl_stmt|;
name|val
operator|=
name|BWN_READ_2
argument_list|(
name|mac
argument_list|,
name|BWN_GPIO_CONTROL
argument_list|)
expr_stmt|;
name|val
operator|=
name|bwn_led_onoff
argument_list|(
name|led
argument_list|,
name|val
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
name|BWN_GPIO_CONTROL
argument_list|,
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|led
operator|->
name|led_flags
operator|&
name|BWN_LED_F_SLOW
condition|)
block|{
name|BWN_LED_SLOWDOWN
argument_list|(
name|on_dur
argument_list|)
expr_stmt|;
name|BWN_LED_SLOWDOWN
argument_list|(
name|off_dur
argument_list|)
expr_stmt|;
block|}
name|sc
operator|->
name|sc_led_blinking
operator|=
literal|1
expr_stmt|;
name|sc
operator|->
name|sc_led_blink_offdur
operator|=
name|off_dur
expr_stmt|;
name|callout_reset
argument_list|(
operator|&
name|sc
operator|->
name|sc_led_blink_ch
argument_list|,
name|on_dur
argument_list|,
name|bwn_led_blink_next
argument_list|,
name|mac
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_led_blink_next
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|bwn_mac
modifier|*
name|mac
init|=
name|arg
decl_stmt|;
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|uint16_t
name|val
decl_stmt|;
name|val
operator|=
name|BWN_READ_2
argument_list|(
name|mac
argument_list|,
name|BWN_GPIO_CONTROL
argument_list|)
expr_stmt|;
name|val
operator|=
name|bwn_led_onoff
argument_list|(
name|sc
operator|->
name|sc_blink_led
argument_list|,
name|val
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BWN_WRITE_2
argument_list|(
name|mac
argument_list|,
name|BWN_GPIO_CONTROL
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|callout_reset
argument_list|(
operator|&
name|sc
operator|->
name|sc_led_blink_ch
argument_list|,
name|sc
operator|->
name|sc_led_blink_offdur
argument_list|,
name|bwn_led_blink_end
argument_list|,
name|mac
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_led_blink_end
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|bwn_mac
modifier|*
name|mac
init|=
name|arg
decl_stmt|;
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|sc
operator|->
name|sc_led_blinking
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|bwn_suspend
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|BWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|bwn_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|BWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bwn_resume
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|error
init|=
name|EDOOFUS
decl_stmt|;
name|BWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_ic
operator|.
name|ic_nrunning
operator|>
literal|0
condition|)
name|error
operator|=
name|bwn_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|BWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|ieee80211_start_all
argument_list|(
operator|&
name|sc
operator|->
name|sc_ic
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_rfswitch
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|bwn_softc
modifier|*
name|sc
init|=
name|arg
decl_stmt|;
name|struct
name|bwn_mac
modifier|*
name|mac
init|=
name|sc
operator|->
name|sc_curmac
decl_stmt|;
name|int
name|cur
init|=
literal|0
decl_stmt|,
name|prev
init|=
literal|0
decl_stmt|;
name|KASSERT
argument_list|(
name|mac
operator|->
name|mac_status
operator|>=
name|BWN_MAC_STATUS_STARTED
argument_list|,
operator|(
literal|"%s: invalid MAC status %d"
operator|,
name|__func__
operator|,
name|mac
operator|->
name|mac_status
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|rev
operator|>=
literal|3
operator|||
name|mac
operator|->
name|mac_phy
operator|.
name|type
operator|==
name|BWN_PHYTYPE_LP
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|BWN_READ_4
argument_list|(
name|mac
argument_list|,
name|BWN_RF_HWENABLED_HI
argument_list|)
operator|&
name|BWN_RF_HWENABLED_HI_MASK
operator|)
condition|)
name|cur
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|BWN_READ_2
argument_list|(
name|mac
argument_list|,
name|BWN_RF_HWENABLED_LO
argument_list|)
operator|&
name|BWN_RF_HWENABLED_LO_MASK
condition|)
name|cur
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|mac
operator|->
name|mac_flags
operator|&
name|BWN_MAC_FLAG_RADIO_ON
condition|)
name|prev
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|cur
operator|!=
name|prev
condition|)
block|{
if|if
condition|(
name|cur
condition|)
name|mac
operator|->
name|mac_flags
operator||=
name|BWN_MAC_FLAG_RADIO_ON
expr_stmt|;
else|else
name|mac
operator|->
name|mac_flags
operator|&=
operator|~
name|BWN_MAC_FLAG_RADIO_ON
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"status of RF switch is changed to %s\n"
argument_list|,
name|cur
condition|?
literal|"ON"
else|:
literal|"OFF"
argument_list|)
expr_stmt|;
if|if
condition|(
name|cur
operator|!=
name|mac
operator|->
name|mac_phy
operator|.
name|rf_on
condition|)
block|{
if|if
condition|(
name|cur
condition|)
name|bwn_rf_turnon
argument_list|(
name|mac
argument_list|)
expr_stmt|;
else|else
name|bwn_rf_turnoff
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
block|}
name|callout_schedule
argument_list|(
operator|&
name|sc
operator|->
name|sc_rfswitch_ch
argument_list|,
name|hz
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwn_sysctl_node
parameter_list|(
name|struct
name|bwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|device_t
name|dev
init|=
name|sc
operator|->
name|sc_dev
decl_stmt|;
name|struct
name|bwn_mac
modifier|*
name|mac
decl_stmt|;
name|struct
name|bwn_stats
modifier|*
name|stats
decl_stmt|;
comment|/* XXX assume that count of MAC is only 1. */
if|if
condition|(
operator|(
name|mac
operator|=
name|sc
operator|->
name|sc_curmac
operator|)
operator|==
name|NULL
condition|)
return|return;
name|stats
operator|=
operator|&
name|mac
operator|->
name|mac_stats
expr_stmt|;
name|SYSCTL_ADD_INT
argument_list|(
name|device_get_sysctl_ctx
argument_list|(
name|dev
argument_list|)
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|device_get_sysctl_tree
argument_list|(
name|dev
argument_list|)
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"linknoise"
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|stats
operator|->
name|rts
argument_list|,
literal|0
argument_list|,
literal|"Noise level"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_INT
argument_list|(
name|device_get_sysctl_ctx
argument_list|(
name|dev
argument_list|)
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|device_get_sysctl_tree
argument_list|(
name|dev
argument_list|)
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rts"
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|stats
operator|->
name|rts
argument_list|,
literal|0
argument_list|,
literal|"RTS"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_INT
argument_list|(
name|device_get_sysctl_ctx
argument_list|(
name|dev
argument_list|)
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|device_get_sysctl_tree
argument_list|(
name|dev
argument_list|)
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rtsfail"
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|stats
operator|->
name|rtsfail
argument_list|,
literal|0
argument_list|,
literal|"RTS failed to send"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|BWN_DEBUG
name|SYSCTL_ADD_UINT
argument_list|(
name|device_get_sysctl_ctx
argument_list|(
name|dev
argument_list|)
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|device_get_sysctl_tree
argument_list|(
name|dev
argument_list|)
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"debug"
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|sc
operator|->
name|sc_debug
argument_list|,
literal|0
argument_list|,
literal|"Debug flags"
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_decl_stmt
specifier|static
name|device_method_t
name|bwn_methods
index|[]
init|=
block|{
comment|/* Device interface */
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|bwn_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|bwn_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|bwn_detach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_suspend
argument_list|,
name|bwn_suspend
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_resume
argument_list|,
name|bwn_resume
argument_list|)
block|,
name|DEVMETHOD_END
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|bwn_driver
init|=
block|{
literal|"bwn"
block|,
name|bwn_methods
block|,
expr|sizeof
operator|(
expr|struct
name|bwn_softc
operator|)
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|bwn_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|bwn
argument_list|,
name|siba_bwn
argument_list|,
name|bwn_driver
argument_list|,
name|bwn_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|bwn
argument_list|,
name|siba_bwn
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|bwn
argument_list|,
name|wlan
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* 802.11 media layer */
end_comment

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|bwn
argument_list|,
name|firmware
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* firmware support */
end_comment

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|bwn
argument_list|,
name|wlan_amrr
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_VERSION
argument_list|(
name|bwn
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* $FreeBSD$ */
end_comment

begin_comment
comment|/*-  * Copyright (c) 2008 Hans Petter Selasky. All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/stdint.h>
end_include

begin_include
include|#
directive|include
file|<sys/stddef.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<sys/condvar.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/sx.h>
end_include

begin_include
include|#
directive|include
file|<sys/unistd.h>
end_include

begin_include
include|#
directive|include
file|<sys/callout.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/priv.h>
end_include

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_include
include|#
directive|include
file|<sys/fcntl.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb_ioctl.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usbdi.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usbdi_util.h>
end_include

begin_define
define|#
directive|define
name|USB_DEBUG_VAR
value|ugen_debug
end_define

begin_include
include|#
directive|include
file|<dev/usb/usb_core.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb_dev.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb_mbuf.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb_process.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb_device.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb_debug.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb_request.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb_busdma.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb_util.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb_hub.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb_generic.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb_transfer.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb_controller.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb_bus.h>
end_include

begin_if
if|#
directive|if
name|USB_HAVE_UGEN
end_if

begin_comment
comment|/* defines */
end_comment

begin_define
define|#
directive|define
name|UGEN_BULK_FS_BUFFER_SIZE
value|(64*32)
end_define

begin_comment
comment|/* bytes */
end_comment

begin_define
define|#
directive|define
name|UGEN_BULK_HS_BUFFER_SIZE
value|(1024*32)
end_define

begin_comment
comment|/* bytes */
end_comment

begin_define
define|#
directive|define
name|UGEN_HW_FRAMES
value|50
end_define

begin_comment
comment|/* number of milliseconds per transfer */
end_comment

begin_comment
comment|/* function prototypes */
end_comment

begin_decl_stmt
specifier|static
name|usb_callback_t
name|ugen_read_clear_stall_callback
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|usb_callback_t
name|ugen_write_clear_stall_callback
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|usb_callback_t
name|ugen_ctrl_read_callback
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|usb_callback_t
name|ugen_ctrl_write_callback
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|usb_callback_t
name|ugen_isoc_read_callback
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|usb_callback_t
name|ugen_isoc_write_callback
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|usb_callback_t
name|ugen_ctrl_fs_callback
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|usb_fifo_open_t
name|ugen_open
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|usb_fifo_close_t
name|ugen_close
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|usb_fifo_ioctl_t
name|ugen_ioctl
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|usb_fifo_ioctl_t
name|ugen_ioctl_post
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|usb_fifo_cmd_t
name|ugen_start_read
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|usb_fifo_cmd_t
name|ugen_start_write
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|usb_fifo_cmd_t
name|ugen_stop_io
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|int
name|ugen_transfer_setup
parameter_list|(
name|struct
name|usb_fifo
modifier|*
parameter_list|,
specifier|const
name|struct
name|usb_config
modifier|*
parameter_list|,
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ugen_open_pipe_write
parameter_list|(
name|struct
name|usb_fifo
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ugen_open_pipe_read
parameter_list|(
name|struct
name|usb_fifo
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ugen_set_config
parameter_list|(
name|struct
name|usb_fifo
modifier|*
parameter_list|,
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ugen_set_interface
parameter_list|(
name|struct
name|usb_fifo
modifier|*
parameter_list|,
name|uint8_t
parameter_list|,
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ugen_get_cdesc
parameter_list|(
name|struct
name|usb_fifo
modifier|*
parameter_list|,
name|struct
name|usb_gen_descriptor
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ugen_get_sdesc
parameter_list|(
name|struct
name|usb_fifo
modifier|*
parameter_list|,
name|struct
name|usb_gen_descriptor
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ugen_get_iface_driver
parameter_list|(
name|struct
name|usb_fifo
modifier|*
name|f
parameter_list|,
name|struct
name|usb_gen_descriptor
modifier|*
name|ugd
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|usb_gen_fill_deviceinfo
parameter_list|(
name|struct
name|usb_fifo
modifier|*
parameter_list|,
name|struct
name|usb_device_info
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ugen_re_enumerate
parameter_list|(
name|struct
name|usb_fifo
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ugen_iface_ioctl
parameter_list|(
name|struct
name|usb_fifo
modifier|*
parameter_list|,
name|u_long
parameter_list|,
name|void
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint8_t
name|ugen_fs_get_complete
parameter_list|(
name|struct
name|usb_fifo
modifier|*
parameter_list|,
name|uint8_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ugen_fs_uninit
parameter_list|(
name|struct
name|usb_fifo
modifier|*
name|f
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* structures */
end_comment

begin_decl_stmt
name|struct
name|usb_fifo_methods
name|usb_ugen_methods
init|=
block|{
operator|.
name|f_open
operator|=
operator|&
name|ugen_open
block|,
operator|.
name|f_close
operator|=
operator|&
name|ugen_close
block|,
operator|.
name|f_ioctl
operator|=
operator|&
name|ugen_ioctl
block|,
operator|.
name|f_ioctl_post
operator|=
operator|&
name|ugen_ioctl_post
block|,
operator|.
name|f_start_read
operator|=
operator|&
name|ugen_start_read
block|,
operator|.
name|f_stop_read
operator|=
operator|&
name|ugen_stop_io
block|,
operator|.
name|f_start_write
operator|=
operator|&
name|ugen_start_write
block|,
operator|.
name|f_stop_write
operator|=
operator|&
name|ugen_stop_io
block|, }
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|USB_DEBUG
end_ifdef

begin_decl_stmt
specifier|static
name|int
name|ugen_debug
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_expr_stmt
specifier|static
name|SYSCTL_NODE
argument_list|(
name|_hw_usb
argument_list|,
name|OID_AUTO
argument_list|,
name|ugen
argument_list|,
name|CTLFLAG_RW
argument_list|,
literal|0
argument_list|,
literal|"USB generic"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_hw_usb_ugen
argument_list|,
name|OID_AUTO
argument_list|,
name|debug
argument_list|,
name|CTLFLAG_RW
operator||
name|CTLFLAG_TUN
argument_list|,
operator|&
name|ugen_debug
argument_list|,
literal|0
argument_list|,
literal|"Debug level"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"hw.usb.ugen.debug"
argument_list|,
operator|&
name|ugen_debug
argument_list|)
expr_stmt|;
end_expr_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* prototypes */
end_comment

begin_function
specifier|static
name|int
name|ugen_transfer_setup
parameter_list|(
name|struct
name|usb_fifo
modifier|*
name|f
parameter_list|,
specifier|const
name|struct
name|usb_config
modifier|*
name|setup
parameter_list|,
name|uint8_t
name|n_setup
parameter_list|)
block|{
name|struct
name|usb_endpoint
modifier|*
name|ep
init|=
name|usb_fifo_softc
argument_list|(
name|f
argument_list|)
decl_stmt|;
name|struct
name|usb_device
modifier|*
name|udev
init|=
name|f
operator|->
name|udev
decl_stmt|;
name|uint8_t
name|iface_index
init|=
name|ep
operator|->
name|iface_index
decl_stmt|;
name|int
name|error
decl_stmt|;
name|mtx_unlock
argument_list|(
name|f
operator|->
name|priv_mtx
argument_list|)
expr_stmt|;
comment|/* 	 * "usbd_transfer_setup()" can sleep so one needs to make a wrapper, 	 * exiting the mutex and checking things 	 */
name|error
operator|=
name|usbd_transfer_setup
argument_list|(
name|udev
argument_list|,
operator|&
name|iface_index
argument_list|,
name|f
operator|->
name|xfer
argument_list|,
name|setup
argument_list|,
name|n_setup
argument_list|,
name|f
argument_list|,
name|f
operator|->
name|priv_mtx
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|f
operator|->
name|xfer
index|[
literal|0
index|]
operator|->
name|nframes
operator|==
literal|1
condition|)
block|{
name|error
operator|=
name|usb_fifo_alloc_buffer
argument_list|(
name|f
argument_list|,
name|f
operator|->
name|xfer
index|[
literal|0
index|]
operator|->
name|max_data_length
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|error
operator|=
name|usb_fifo_alloc_buffer
argument_list|(
name|f
argument_list|,
name|f
operator|->
name|xfer
index|[
literal|0
index|]
operator|->
name|max_frame_size
argument_list|,
literal|2
operator|*
name|f
operator|->
name|xfer
index|[
literal|0
index|]
operator|->
name|nframes
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|error
condition|)
block|{
name|usbd_transfer_unsetup
argument_list|(
name|f
operator|->
name|xfer
argument_list|,
name|n_setup
argument_list|)
expr_stmt|;
block|}
block|}
name|mtx_lock
argument_list|(
name|f
operator|->
name|priv_mtx
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ugen_open
parameter_list|(
name|struct
name|usb_fifo
modifier|*
name|f
parameter_list|,
name|int
name|fflags
parameter_list|)
block|{
name|struct
name|usb_endpoint
modifier|*
name|ep
init|=
name|usb_fifo_softc
argument_list|(
name|f
argument_list|)
decl_stmt|;
name|struct
name|usb_endpoint_descriptor
modifier|*
name|ed
init|=
name|ep
operator|->
name|edesc
decl_stmt|;
name|uint8_t
name|type
decl_stmt|;
name|DPRINTFN
argument_list|(
literal|6
argument_list|,
literal|"flag=0x%x\n"
argument_list|,
name|fflags
argument_list|)
expr_stmt|;
name|mtx_lock
argument_list|(
name|f
operator|->
name|priv_mtx
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|usbd_get_speed
argument_list|(
name|f
operator|->
name|udev
argument_list|)
condition|)
block|{
case|case
name|USB_SPEED_LOW
case|:
case|case
name|USB_SPEED_FULL
case|:
name|f
operator|->
name|nframes
operator|=
name|UGEN_HW_FRAMES
expr_stmt|;
name|f
operator|->
name|bufsize
operator|=
name|UGEN_BULK_FS_BUFFER_SIZE
expr_stmt|;
break|break;
default|default:
name|f
operator|->
name|nframes
operator|=
name|UGEN_HW_FRAMES
operator|*
literal|8
expr_stmt|;
name|f
operator|->
name|bufsize
operator|=
name|UGEN_BULK_HS_BUFFER_SIZE
expr_stmt|;
break|break;
block|}
name|type
operator|=
name|ed
operator|->
name|bmAttributes
operator|&
name|UE_XFERTYPE
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|UE_INTERRUPT
condition|)
block|{
name|f
operator|->
name|bufsize
operator|=
literal|0
expr_stmt|;
comment|/* use "wMaxPacketSize" */
block|}
name|f
operator|->
name|timeout
operator|=
name|USB_NO_TIMEOUT
expr_stmt|;
name|f
operator|->
name|flag_short
operator|=
literal|0
expr_stmt|;
name|f
operator|->
name|fifo_zlp
operator|=
literal|0
expr_stmt|;
name|mtx_unlock
argument_list|(
name|f
operator|->
name|priv_mtx
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ugen_close
parameter_list|(
name|struct
name|usb_fifo
modifier|*
name|f
parameter_list|,
name|int
name|fflags
parameter_list|)
block|{
name|DPRINTFN
argument_list|(
literal|6
argument_list|,
literal|"flag=0x%x\n"
argument_list|,
name|fflags
argument_list|)
expr_stmt|;
comment|/* cleanup */
name|mtx_lock
argument_list|(
name|f
operator|->
name|priv_mtx
argument_list|)
expr_stmt|;
name|usbd_transfer_stop
argument_list|(
name|f
operator|->
name|xfer
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|usbd_transfer_stop
argument_list|(
name|f
operator|->
name|xfer
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
name|f
operator|->
name|priv_mtx
argument_list|)
expr_stmt|;
name|usbd_transfer_unsetup
argument_list|(
name|f
operator|->
name|xfer
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|usb_fifo_free_buffer
argument_list|(
name|f
argument_list|)
expr_stmt|;
if|if
condition|(
name|ugen_fs_uninit
argument_list|(
name|f
argument_list|)
condition|)
block|{
comment|/* ignore any errors - we are closing */
name|DPRINTFN
argument_list|(
literal|6
argument_list|,
literal|"no FIFOs\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|ugen_open_pipe_write
parameter_list|(
name|struct
name|usb_fifo
modifier|*
name|f
parameter_list|)
block|{
name|struct
name|usb_config
name|usb_config
index|[
literal|2
index|]
decl_stmt|;
name|struct
name|usb_endpoint
modifier|*
name|ep
init|=
name|usb_fifo_softc
argument_list|(
name|f
argument_list|)
decl_stmt|;
name|struct
name|usb_endpoint_descriptor
modifier|*
name|ed
init|=
name|ep
operator|->
name|edesc
decl_stmt|;
name|mtx_assert
argument_list|(
name|f
operator|->
name|priv_mtx
argument_list|,
name|MA_OWNED
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|->
name|xfer
index|[
literal|0
index|]
operator|||
name|f
operator|->
name|xfer
index|[
literal|1
index|]
condition|)
block|{
comment|/* transfers are already opened */
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|memset
argument_list|(
name|usb_config
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|usb_config
argument_list|)
argument_list|)
expr_stmt|;
name|usb_config
index|[
literal|1
index|]
operator|.
name|type
operator|=
name|UE_CONTROL
expr_stmt|;
name|usb_config
index|[
literal|1
index|]
operator|.
name|endpoint
operator|=
literal|0
expr_stmt|;
name|usb_config
index|[
literal|1
index|]
operator|.
name|direction
operator|=
name|UE_DIR_ANY
expr_stmt|;
name|usb_config
index|[
literal|1
index|]
operator|.
name|timeout
operator|=
literal|1000
expr_stmt|;
comment|/* 1 second */
name|usb_config
index|[
literal|1
index|]
operator|.
name|interval
operator|=
literal|50
expr_stmt|;
comment|/* 50 milliseconds */
name|usb_config
index|[
literal|1
index|]
operator|.
name|bufsize
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|usb_device_request
argument_list|)
expr_stmt|;
name|usb_config
index|[
literal|1
index|]
operator|.
name|callback
operator|=
operator|&
name|ugen_write_clear_stall_callback
expr_stmt|;
name|usb_config
index|[
literal|1
index|]
operator|.
name|usb_mode
operator|=
name|USB_MODE_HOST
expr_stmt|;
name|usb_config
index|[
literal|0
index|]
operator|.
name|type
operator|=
name|ed
operator|->
name|bmAttributes
operator|&
name|UE_XFERTYPE
expr_stmt|;
name|usb_config
index|[
literal|0
index|]
operator|.
name|endpoint
operator|=
name|ed
operator|->
name|bEndpointAddress
operator|&
name|UE_ADDR
expr_stmt|;
name|usb_config
index|[
literal|0
index|]
operator|.
name|direction
operator|=
name|UE_DIR_TX
expr_stmt|;
name|usb_config
index|[
literal|0
index|]
operator|.
name|interval
operator|=
name|USB_DEFAULT_INTERVAL
expr_stmt|;
name|usb_config
index|[
literal|0
index|]
operator|.
name|flags
operator|.
name|proxy_buffer
operator|=
literal|1
expr_stmt|;
name|usb_config
index|[
literal|0
index|]
operator|.
name|usb_mode
operator|=
name|USB_MODE_DUAL
expr_stmt|;
comment|/* both modes */
switch|switch
condition|(
name|ed
operator|->
name|bmAttributes
operator|&
name|UE_XFERTYPE
condition|)
block|{
case|case
name|UE_INTERRUPT
case|:
case|case
name|UE_BULK
case|:
if|if
condition|(
name|f
operator|->
name|flag_short
condition|)
block|{
name|usb_config
index|[
literal|0
index|]
operator|.
name|flags
operator|.
name|force_short_xfer
operator|=
literal|1
expr_stmt|;
block|}
name|usb_config
index|[
literal|0
index|]
operator|.
name|callback
operator|=
operator|&
name|ugen_ctrl_write_callback
expr_stmt|;
name|usb_config
index|[
literal|0
index|]
operator|.
name|timeout
operator|=
name|f
operator|->
name|timeout
expr_stmt|;
name|usb_config
index|[
literal|0
index|]
operator|.
name|frames
operator|=
literal|1
expr_stmt|;
name|usb_config
index|[
literal|0
index|]
operator|.
name|bufsize
operator|=
name|f
operator|->
name|bufsize
expr_stmt|;
if|if
condition|(
name|ugen_transfer_setup
argument_list|(
name|f
argument_list|,
name|usb_config
argument_list|,
literal|2
argument_list|)
condition|)
block|{
return|return
operator|(
name|EIO
operator|)
return|;
block|}
comment|/* first transfer does not clear stall */
name|f
operator|->
name|flag_stall
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|UE_ISOCHRONOUS
case|:
name|usb_config
index|[
literal|0
index|]
operator|.
name|flags
operator|.
name|short_xfer_ok
operator|=
literal|1
expr_stmt|;
name|usb_config
index|[
literal|0
index|]
operator|.
name|bufsize
operator|=
literal|0
expr_stmt|;
comment|/* use default */
name|usb_config
index|[
literal|0
index|]
operator|.
name|frames
operator|=
name|f
operator|->
name|nframes
expr_stmt|;
name|usb_config
index|[
literal|0
index|]
operator|.
name|callback
operator|=
operator|&
name|ugen_isoc_write_callback
expr_stmt|;
name|usb_config
index|[
literal|0
index|]
operator|.
name|timeout
operator|=
literal|0
expr_stmt|;
comment|/* clone configuration */
name|usb_config
index|[
literal|1
index|]
operator|=
name|usb_config
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|ugen_transfer_setup
argument_list|(
name|f
argument_list|,
name|usb_config
argument_list|,
literal|2
argument_list|)
condition|)
block|{
return|return
operator|(
name|EIO
operator|)
return|;
block|}
break|break;
default|default:
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ugen_open_pipe_read
parameter_list|(
name|struct
name|usb_fifo
modifier|*
name|f
parameter_list|)
block|{
name|struct
name|usb_config
name|usb_config
index|[
literal|2
index|]
decl_stmt|;
name|struct
name|usb_endpoint
modifier|*
name|ep
init|=
name|usb_fifo_softc
argument_list|(
name|f
argument_list|)
decl_stmt|;
name|struct
name|usb_endpoint_descriptor
modifier|*
name|ed
init|=
name|ep
operator|->
name|edesc
decl_stmt|;
name|mtx_assert
argument_list|(
name|f
operator|->
name|priv_mtx
argument_list|,
name|MA_OWNED
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|->
name|xfer
index|[
literal|0
index|]
operator|||
name|f
operator|->
name|xfer
index|[
literal|1
index|]
condition|)
block|{
comment|/* transfers are already opened */
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|memset
argument_list|(
name|usb_config
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|usb_config
argument_list|)
argument_list|)
expr_stmt|;
name|usb_config
index|[
literal|1
index|]
operator|.
name|type
operator|=
name|UE_CONTROL
expr_stmt|;
name|usb_config
index|[
literal|1
index|]
operator|.
name|endpoint
operator|=
literal|0
expr_stmt|;
name|usb_config
index|[
literal|1
index|]
operator|.
name|direction
operator|=
name|UE_DIR_ANY
expr_stmt|;
name|usb_config
index|[
literal|1
index|]
operator|.
name|timeout
operator|=
literal|1000
expr_stmt|;
comment|/* 1 second */
name|usb_config
index|[
literal|1
index|]
operator|.
name|interval
operator|=
literal|50
expr_stmt|;
comment|/* 50 milliseconds */
name|usb_config
index|[
literal|1
index|]
operator|.
name|bufsize
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|usb_device_request
argument_list|)
expr_stmt|;
name|usb_config
index|[
literal|1
index|]
operator|.
name|callback
operator|=
operator|&
name|ugen_read_clear_stall_callback
expr_stmt|;
name|usb_config
index|[
literal|1
index|]
operator|.
name|usb_mode
operator|=
name|USB_MODE_HOST
expr_stmt|;
name|usb_config
index|[
literal|0
index|]
operator|.
name|type
operator|=
name|ed
operator|->
name|bmAttributes
operator|&
name|UE_XFERTYPE
expr_stmt|;
name|usb_config
index|[
literal|0
index|]
operator|.
name|endpoint
operator|=
name|ed
operator|->
name|bEndpointAddress
operator|&
name|UE_ADDR
expr_stmt|;
name|usb_config
index|[
literal|0
index|]
operator|.
name|direction
operator|=
name|UE_DIR_RX
expr_stmt|;
name|usb_config
index|[
literal|0
index|]
operator|.
name|interval
operator|=
name|USB_DEFAULT_INTERVAL
expr_stmt|;
name|usb_config
index|[
literal|0
index|]
operator|.
name|flags
operator|.
name|proxy_buffer
operator|=
literal|1
expr_stmt|;
name|usb_config
index|[
literal|0
index|]
operator|.
name|usb_mode
operator|=
name|USB_MODE_DUAL
expr_stmt|;
comment|/* both modes */
switch|switch
condition|(
name|ed
operator|->
name|bmAttributes
operator|&
name|UE_XFERTYPE
condition|)
block|{
case|case
name|UE_INTERRUPT
case|:
case|case
name|UE_BULK
case|:
if|if
condition|(
name|f
operator|->
name|flag_short
condition|)
block|{
name|usb_config
index|[
literal|0
index|]
operator|.
name|flags
operator|.
name|short_xfer_ok
operator|=
literal|1
expr_stmt|;
block|}
name|usb_config
index|[
literal|0
index|]
operator|.
name|timeout
operator|=
name|f
operator|->
name|timeout
expr_stmt|;
name|usb_config
index|[
literal|0
index|]
operator|.
name|frames
operator|=
literal|1
expr_stmt|;
name|usb_config
index|[
literal|0
index|]
operator|.
name|callback
operator|=
operator|&
name|ugen_ctrl_read_callback
expr_stmt|;
name|usb_config
index|[
literal|0
index|]
operator|.
name|bufsize
operator|=
name|f
operator|->
name|bufsize
expr_stmt|;
if|if
condition|(
name|ugen_transfer_setup
argument_list|(
name|f
argument_list|,
name|usb_config
argument_list|,
literal|2
argument_list|)
condition|)
block|{
return|return
operator|(
name|EIO
operator|)
return|;
block|}
comment|/* first transfer does not clear stall */
name|f
operator|->
name|flag_stall
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|UE_ISOCHRONOUS
case|:
name|usb_config
index|[
literal|0
index|]
operator|.
name|flags
operator|.
name|short_xfer_ok
operator|=
literal|1
expr_stmt|;
name|usb_config
index|[
literal|0
index|]
operator|.
name|bufsize
operator|=
literal|0
expr_stmt|;
comment|/* use default */
name|usb_config
index|[
literal|0
index|]
operator|.
name|frames
operator|=
name|f
operator|->
name|nframes
expr_stmt|;
name|usb_config
index|[
literal|0
index|]
operator|.
name|callback
operator|=
operator|&
name|ugen_isoc_read_callback
expr_stmt|;
name|usb_config
index|[
literal|0
index|]
operator|.
name|timeout
operator|=
literal|0
expr_stmt|;
comment|/* clone configuration */
name|usb_config
index|[
literal|1
index|]
operator|=
name|usb_config
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|ugen_transfer_setup
argument_list|(
name|f
argument_list|,
name|usb_config
argument_list|,
literal|2
argument_list|)
condition|)
block|{
return|return
operator|(
name|EIO
operator|)
return|;
block|}
break|break;
default|default:
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ugen_start_read
parameter_list|(
name|struct
name|usb_fifo
modifier|*
name|f
parameter_list|)
block|{
comment|/* check that pipes are open */
if|if
condition|(
name|ugen_open_pipe_read
argument_list|(
name|f
argument_list|)
condition|)
block|{
comment|/* signal error */
name|usb_fifo_put_data_error
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
comment|/* start transfers */
name|usbd_transfer_start
argument_list|(
name|f
operator|->
name|xfer
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|usbd_transfer_start
argument_list|(
name|f
operator|->
name|xfer
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ugen_start_write
parameter_list|(
name|struct
name|usb_fifo
modifier|*
name|f
parameter_list|)
block|{
comment|/* check that pipes are open */
if|if
condition|(
name|ugen_open_pipe_write
argument_list|(
name|f
argument_list|)
condition|)
block|{
comment|/* signal error */
name|usb_fifo_get_data_error
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
comment|/* start transfers */
name|usbd_transfer_start
argument_list|(
name|f
operator|->
name|xfer
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|usbd_transfer_start
argument_list|(
name|f
operator|->
name|xfer
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ugen_stop_io
parameter_list|(
name|struct
name|usb_fifo
modifier|*
name|f
parameter_list|)
block|{
comment|/* stop transfers */
name|usbd_transfer_stop
argument_list|(
name|f
operator|->
name|xfer
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|usbd_transfer_stop
argument_list|(
name|f
operator|->
name|xfer
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ugen_ctrl_read_callback
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|,
name|usb_error_t
name|error
parameter_list|)
block|{
name|struct
name|usb_fifo
modifier|*
name|f
init|=
name|usbd_xfer_softc
argument_list|(
name|xfer
argument_list|)
decl_stmt|;
name|struct
name|usb_mbuf
modifier|*
name|m
decl_stmt|;
name|DPRINTFN
argument_list|(
literal|4
argument_list|,
literal|"actlen=%u, aframes=%u\n"
argument_list|,
name|xfer
operator|->
name|actlen
argument_list|,
name|xfer
operator|->
name|aframes
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|USB_GET_STATE
argument_list|(
name|xfer
argument_list|)
condition|)
block|{
case|case
name|USB_ST_TRANSFERRED
case|:
if|if
condition|(
name|xfer
operator|->
name|actlen
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|f
operator|->
name|fifo_zlp
operator|!=
literal|4
condition|)
block|{
name|f
operator|->
name|fifo_zlp
operator|++
expr_stmt|;
block|}
else|else
block|{
comment|/* 				 * Throttle a little bit we have multiple ZLPs 				 * in a row! 				 */
name|xfer
operator|->
name|interval
operator|=
literal|64
expr_stmt|;
comment|/* ms */
block|}
block|}
else|else
block|{
comment|/* clear throttle */
name|xfer
operator|->
name|interval
operator|=
literal|0
expr_stmt|;
name|f
operator|->
name|fifo_zlp
operator|=
literal|0
expr_stmt|;
block|}
name|usb_fifo_put_data
argument_list|(
name|f
argument_list|,
name|xfer
operator|->
name|frbuffers
argument_list|,
literal|0
argument_list|,
name|xfer
operator|->
name|actlen
argument_list|,
literal|1
argument_list|)
expr_stmt|;
case|case
name|USB_ST_SETUP
case|:
if|if
condition|(
name|f
operator|->
name|flag_stall
condition|)
block|{
name|usbd_transfer_start
argument_list|(
name|f
operator|->
name|xfer
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
name|USB_IF_POLL
argument_list|(
operator|&
name|f
operator|->
name|free_q
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
condition|)
block|{
name|usbd_xfer_set_frame_len
argument_list|(
name|xfer
argument_list|,
literal|0
argument_list|,
name|usbd_xfer_max_len
argument_list|(
name|xfer
argument_list|)
argument_list|)
expr_stmt|;
name|usbd_transfer_submit
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
comment|/* Error */
if|if
condition|(
name|xfer
operator|->
name|error
operator|!=
name|USB_ERR_CANCELLED
condition|)
block|{
comment|/* send a zero length packet to userland */
name|usb_fifo_put_data
argument_list|(
name|f
argument_list|,
name|xfer
operator|->
name|frbuffers
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|f
operator|->
name|flag_stall
operator|=
literal|1
expr_stmt|;
name|f
operator|->
name|fifo_zlp
operator|=
literal|0
expr_stmt|;
name|usbd_transfer_start
argument_list|(
name|f
operator|->
name|xfer
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ugen_ctrl_write_callback
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|,
name|usb_error_t
name|error
parameter_list|)
block|{
name|struct
name|usb_fifo
modifier|*
name|f
init|=
name|usbd_xfer_softc
argument_list|(
name|xfer
argument_list|)
decl_stmt|;
name|usb_frlength_t
name|actlen
decl_stmt|;
name|DPRINTFN
argument_list|(
literal|4
argument_list|,
literal|"actlen=%u, aframes=%u\n"
argument_list|,
name|xfer
operator|->
name|actlen
argument_list|,
name|xfer
operator|->
name|aframes
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|USB_GET_STATE
argument_list|(
name|xfer
argument_list|)
condition|)
block|{
case|case
name|USB_ST_SETUP
case|:
case|case
name|USB_ST_TRANSFERRED
case|:
comment|/* 		 * If writing is in stall, just jump to clear stall 		 * callback and solve the situation. 		 */
if|if
condition|(
name|f
operator|->
name|flag_stall
condition|)
block|{
name|usbd_transfer_start
argument_list|(
name|f
operator|->
name|xfer
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* 		 * Write data, setup and perform hardware transfer. 		 */
if|if
condition|(
name|usb_fifo_get_data
argument_list|(
name|f
argument_list|,
name|xfer
operator|->
name|frbuffers
argument_list|,
literal|0
argument_list|,
name|xfer
operator|->
name|max_data_length
argument_list|,
operator|&
name|actlen
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|usbd_xfer_set_frame_len
argument_list|(
name|xfer
argument_list|,
literal|0
argument_list|,
name|actlen
argument_list|)
expr_stmt|;
name|usbd_transfer_submit
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
comment|/* Error */
if|if
condition|(
name|xfer
operator|->
name|error
operator|!=
name|USB_ERR_CANCELLED
condition|)
block|{
name|f
operator|->
name|flag_stall
operator|=
literal|1
expr_stmt|;
name|usbd_transfer_start
argument_list|(
name|f
operator|->
name|xfer
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ugen_read_clear_stall_callback
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|,
name|usb_error_t
name|error
parameter_list|)
block|{
name|struct
name|usb_fifo
modifier|*
name|f
init|=
name|usbd_xfer_softc
argument_list|(
name|xfer
argument_list|)
decl_stmt|;
name|struct
name|usb_xfer
modifier|*
name|xfer_other
init|=
name|f
operator|->
name|xfer
index|[
literal|0
index|]
decl_stmt|;
if|if
condition|(
name|f
operator|->
name|flag_stall
operator|==
literal|0
condition|)
block|{
comment|/* nothing to do */
return|return;
block|}
if|if
condition|(
name|usbd_clear_stall_callback
argument_list|(
name|xfer
argument_list|,
name|xfer_other
argument_list|)
condition|)
block|{
name|DPRINTFN
argument_list|(
literal|5
argument_list|,
literal|"f=%p: stall cleared\n"
argument_list|,
name|f
argument_list|)
expr_stmt|;
name|f
operator|->
name|flag_stall
operator|=
literal|0
expr_stmt|;
name|usbd_transfer_start
argument_list|(
name|xfer_other
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ugen_write_clear_stall_callback
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|,
name|usb_error_t
name|error
parameter_list|)
block|{
name|struct
name|usb_fifo
modifier|*
name|f
init|=
name|usbd_xfer_softc
argument_list|(
name|xfer
argument_list|)
decl_stmt|;
name|struct
name|usb_xfer
modifier|*
name|xfer_other
init|=
name|f
operator|->
name|xfer
index|[
literal|0
index|]
decl_stmt|;
if|if
condition|(
name|f
operator|->
name|flag_stall
operator|==
literal|0
condition|)
block|{
comment|/* nothing to do */
return|return;
block|}
if|if
condition|(
name|usbd_clear_stall_callback
argument_list|(
name|xfer
argument_list|,
name|xfer_other
argument_list|)
condition|)
block|{
name|DPRINTFN
argument_list|(
literal|5
argument_list|,
literal|"f=%p: stall cleared\n"
argument_list|,
name|f
argument_list|)
expr_stmt|;
name|f
operator|->
name|flag_stall
operator|=
literal|0
expr_stmt|;
name|usbd_transfer_start
argument_list|(
name|xfer_other
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ugen_isoc_read_callback
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|,
name|usb_error_t
name|error
parameter_list|)
block|{
name|struct
name|usb_fifo
modifier|*
name|f
init|=
name|usbd_xfer_softc
argument_list|(
name|xfer
argument_list|)
decl_stmt|;
name|usb_frlength_t
name|offset
decl_stmt|;
name|usb_frcount_t
name|n
decl_stmt|;
name|DPRINTFN
argument_list|(
literal|4
argument_list|,
literal|"actlen=%u, aframes=%u\n"
argument_list|,
name|xfer
operator|->
name|actlen
argument_list|,
name|xfer
operator|->
name|aframes
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|USB_GET_STATE
argument_list|(
name|xfer
argument_list|)
condition|)
block|{
case|case
name|USB_ST_TRANSFERRED
case|:
name|DPRINTFN
argument_list|(
literal|6
argument_list|,
literal|"actlen=%d\n"
argument_list|,
name|xfer
operator|->
name|actlen
argument_list|)
expr_stmt|;
name|offset
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|!=
name|xfer
operator|->
name|aframes
condition|;
name|n
operator|++
control|)
block|{
name|usb_fifo_put_data
argument_list|(
name|f
argument_list|,
name|xfer
operator|->
name|frbuffers
argument_list|,
name|offset
argument_list|,
name|xfer
operator|->
name|frlengths
index|[
name|n
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|offset
operator|+=
name|xfer
operator|->
name|max_frame_size
expr_stmt|;
block|}
case|case
name|USB_ST_SETUP
case|:
name|tr_setup
label|:
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|!=
name|xfer
operator|->
name|nframes
condition|;
name|n
operator|++
control|)
block|{
comment|/* setup size for next transfer */
name|usbd_xfer_set_frame_len
argument_list|(
name|xfer
argument_list|,
name|n
argument_list|,
name|xfer
operator|->
name|max_frame_size
argument_list|)
expr_stmt|;
block|}
name|usbd_transfer_submit
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|/* Error */
if|if
condition|(
name|xfer
operator|->
name|error
operator|==
name|USB_ERR_CANCELLED
condition|)
block|{
break|break;
block|}
goto|goto
name|tr_setup
goto|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ugen_isoc_write_callback
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|,
name|usb_error_t
name|error
parameter_list|)
block|{
name|struct
name|usb_fifo
modifier|*
name|f
init|=
name|usbd_xfer_softc
argument_list|(
name|xfer
argument_list|)
decl_stmt|;
name|usb_frlength_t
name|actlen
decl_stmt|;
name|usb_frlength_t
name|offset
decl_stmt|;
name|usb_frcount_t
name|n
decl_stmt|;
name|DPRINTFN
argument_list|(
literal|4
argument_list|,
literal|"actlen=%u, aframes=%u\n"
argument_list|,
name|xfer
operator|->
name|actlen
argument_list|,
name|xfer
operator|->
name|aframes
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|USB_GET_STATE
argument_list|(
name|xfer
argument_list|)
condition|)
block|{
case|case
name|USB_ST_TRANSFERRED
case|:
case|case
name|USB_ST_SETUP
case|:
name|tr_setup
label|:
name|offset
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|!=
name|xfer
operator|->
name|nframes
condition|;
name|n
operator|++
control|)
block|{
if|if
condition|(
name|usb_fifo_get_data
argument_list|(
name|f
argument_list|,
name|xfer
operator|->
name|frbuffers
argument_list|,
name|offset
argument_list|,
name|xfer
operator|->
name|max_frame_size
argument_list|,
operator|&
name|actlen
argument_list|,
literal|1
argument_list|)
condition|)
block|{
name|usbd_xfer_set_frame_len
argument_list|(
name|xfer
argument_list|,
name|n
argument_list|,
name|actlen
argument_list|)
expr_stmt|;
name|offset
operator|+=
name|actlen
expr_stmt|;
block|}
else|else
block|{
break|break;
block|}
block|}
for|for
control|(
init|;
name|n
operator|!=
name|xfer
operator|->
name|nframes
condition|;
name|n
operator|++
control|)
block|{
comment|/* fill in zero frames */
name|usbd_xfer_set_frame_len
argument_list|(
name|xfer
argument_list|,
name|n
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|usbd_transfer_submit
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|/* Error */
if|if
condition|(
name|xfer
operator|->
name|error
operator|==
name|USB_ERR_CANCELLED
condition|)
block|{
break|break;
block|}
goto|goto
name|tr_setup
goto|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|ugen_set_config
parameter_list|(
name|struct
name|usb_fifo
modifier|*
name|f
parameter_list|,
name|uint8_t
name|index
parameter_list|)
block|{
name|DPRINTFN
argument_list|(
literal|2
argument_list|,
literal|"index %u\n"
argument_list|,
name|index
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|->
name|udev
operator|->
name|flags
operator|.
name|usb_mode
operator|!=
name|USB_MODE_HOST
condition|)
block|{
comment|/* not possible in device side mode */
return|return
operator|(
name|ENOTTY
operator|)
return|;
block|}
if|if
condition|(
name|f
operator|->
name|udev
operator|->
name|curr_config_index
operator|==
name|index
condition|)
block|{
comment|/* no change needed */
return|return
operator|(
literal|0
operator|)
return|;
block|}
comment|/* make sure all FIFO's are gone */
comment|/* else there can be a deadlock */
if|if
condition|(
name|ugen_fs_uninit
argument_list|(
name|f
argument_list|)
condition|)
block|{
comment|/* ignore any errors */
name|DPRINTFN
argument_list|(
literal|6
argument_list|,
literal|"no FIFOs\n"
argument_list|)
expr_stmt|;
block|}
comment|/* change setting - will free generic FIFOs, if any */
if|if
condition|(
name|usbd_set_config_index
argument_list|(
name|f
operator|->
name|udev
argument_list|,
name|index
argument_list|)
condition|)
block|{
return|return
operator|(
name|EIO
operator|)
return|;
block|}
comment|/* probe and attach */
if|if
condition|(
name|usb_probe_and_attach
argument_list|(
name|f
operator|->
name|udev
argument_list|,
name|USB_IFACE_INDEX_ANY
argument_list|)
condition|)
block|{
return|return
operator|(
name|EIO
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ugen_set_interface
parameter_list|(
name|struct
name|usb_fifo
modifier|*
name|f
parameter_list|,
name|uint8_t
name|iface_index
parameter_list|,
name|uint8_t
name|alt_index
parameter_list|)
block|{
name|DPRINTFN
argument_list|(
literal|2
argument_list|,
literal|"%u, %u\n"
argument_list|,
name|iface_index
argument_list|,
name|alt_index
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|->
name|udev
operator|->
name|flags
operator|.
name|usb_mode
operator|!=
name|USB_MODE_HOST
condition|)
block|{
comment|/* not possible in device side mode */
return|return
operator|(
name|ENOTTY
operator|)
return|;
block|}
comment|/* make sure all FIFO's are gone */
comment|/* else there can be a deadlock */
if|if
condition|(
name|ugen_fs_uninit
argument_list|(
name|f
argument_list|)
condition|)
block|{
comment|/* ignore any errors */
name|DPRINTFN
argument_list|(
literal|6
argument_list|,
literal|"no FIFOs\n"
argument_list|)
expr_stmt|;
block|}
comment|/* change setting - will free generic FIFOs, if any */
if|if
condition|(
name|usbd_set_alt_interface_index
argument_list|(
name|f
operator|->
name|udev
argument_list|,
name|iface_index
argument_list|,
name|alt_index
argument_list|)
condition|)
block|{
return|return
operator|(
name|EIO
operator|)
return|;
block|}
comment|/* probe and attach */
if|if
condition|(
name|usb_probe_and_attach
argument_list|(
name|f
operator|->
name|udev
argument_list|,
name|iface_index
argument_list|)
condition|)
block|{
return|return
operator|(
name|EIO
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*------------------------------------------------------------------------*  *	ugen_get_cdesc  *  * This function will retrieve the complete configuration descriptor  * at the given index.  *------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|int
name|ugen_get_cdesc
parameter_list|(
name|struct
name|usb_fifo
modifier|*
name|f
parameter_list|,
name|struct
name|usb_gen_descriptor
modifier|*
name|ugd
parameter_list|)
block|{
name|struct
name|usb_config_descriptor
modifier|*
name|cdesc
decl_stmt|;
name|struct
name|usb_device
modifier|*
name|udev
init|=
name|f
operator|->
name|udev
decl_stmt|;
name|int
name|error
decl_stmt|;
name|uint16_t
name|len
decl_stmt|;
name|uint8_t
name|free_data
decl_stmt|;
name|DPRINTFN
argument_list|(
literal|6
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ugd
operator|->
name|ugd_data
operator|==
name|NULL
condition|)
block|{
comment|/* userland pointer should not be zero */
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|ugd
operator|->
name|ugd_config_index
operator|==
name|USB_UNCONFIG_INDEX
operator|)
operator|||
operator|(
name|ugd
operator|->
name|ugd_config_index
operator|==
name|udev
operator|->
name|curr_config_index
operator|)
condition|)
block|{
name|cdesc
operator|=
name|usbd_get_config_descriptor
argument_list|(
name|udev
argument_list|)
expr_stmt|;
if|if
condition|(
name|cdesc
operator|==
name|NULL
condition|)
block|{
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|free_data
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|usbd_req_get_config_desc_full
argument_list|(
name|udev
argument_list|,
name|NULL
argument_list|,
operator|&
name|cdesc
argument_list|,
name|M_USBDEV
argument_list|,
name|ugd
operator|->
name|ugd_config_index
argument_list|)
condition|)
block|{
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|free_data
operator|=
literal|1
expr_stmt|;
block|}
name|len
operator|=
name|UGETW
argument_list|(
name|cdesc
operator|->
name|wTotalLength
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|ugd
operator|->
name|ugd_maxlen
condition|)
block|{
name|len
operator|=
name|ugd
operator|->
name|ugd_maxlen
expr_stmt|;
block|}
name|DPRINTFN
argument_list|(
literal|6
argument_list|,
literal|"len=%u\n"
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|ugd
operator|->
name|ugd_actlen
operator|=
name|len
expr_stmt|;
name|ugd
operator|->
name|ugd_offset
operator|=
literal|0
expr_stmt|;
name|error
operator|=
name|copyout
argument_list|(
name|cdesc
argument_list|,
name|ugd
operator|->
name|ugd_data
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|free_data
condition|)
block|{
name|free
argument_list|(
name|cdesc
argument_list|,
name|M_USBDEV
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * This function is called having the enumeration SX locked which  * protects the scratch area used.  */
end_comment

begin_function
specifier|static
name|int
name|ugen_get_sdesc
parameter_list|(
name|struct
name|usb_fifo
modifier|*
name|f
parameter_list|,
name|struct
name|usb_gen_descriptor
modifier|*
name|ugd
parameter_list|)
block|{
name|void
modifier|*
name|ptr
decl_stmt|;
name|uint16_t
name|size
decl_stmt|;
name|int
name|error
decl_stmt|;
name|ptr
operator|=
name|f
operator|->
name|udev
operator|->
name|scratch
operator|.
name|data
expr_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
name|f
operator|->
name|udev
operator|->
name|scratch
operator|.
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|usbd_req_get_string_desc
argument_list|(
name|f
operator|->
name|udev
argument_list|,
name|NULL
argument_list|,
name|ptr
argument_list|,
name|size
argument_list|,
name|ugd
operator|->
name|ugd_lang_id
argument_list|,
name|ugd
operator|->
name|ugd_string_index
argument_list|)
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|size
operator|>
operator|(
operator|(
name|uint8_t
operator|*
operator|)
name|ptr
operator|)
index|[
literal|0
index|]
condition|)
block|{
name|size
operator|=
operator|(
operator|(
name|uint8_t
operator|*
operator|)
name|ptr
operator|)
index|[
literal|0
index|]
expr_stmt|;
block|}
if|if
condition|(
name|size
operator|>
name|ugd
operator|->
name|ugd_maxlen
condition|)
block|{
name|size
operator|=
name|ugd
operator|->
name|ugd_maxlen
expr_stmt|;
block|}
name|ugd
operator|->
name|ugd_actlen
operator|=
name|size
expr_stmt|;
name|ugd
operator|->
name|ugd_offset
operator|=
literal|0
expr_stmt|;
name|error
operator|=
name|copyout
argument_list|(
name|ptr
argument_list|,
name|ugd
operator|->
name|ugd_data
argument_list|,
name|size
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*------------------------------------------------------------------------*  *	ugen_get_iface_driver  *  * This function generates an USB interface description for userland.  *  * Returns:  *    0: Success  * Else: Failure  *------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|int
name|ugen_get_iface_driver
parameter_list|(
name|struct
name|usb_fifo
modifier|*
name|f
parameter_list|,
name|struct
name|usb_gen_descriptor
modifier|*
name|ugd
parameter_list|)
block|{
name|struct
name|usb_device
modifier|*
name|udev
init|=
name|f
operator|->
name|udev
decl_stmt|;
name|struct
name|usb_interface
modifier|*
name|iface
decl_stmt|;
specifier|const
name|char
modifier|*
name|ptr
decl_stmt|;
specifier|const
name|char
modifier|*
name|desc
decl_stmt|;
name|unsigned
name|int
name|len
decl_stmt|;
name|unsigned
name|int
name|maxlen
decl_stmt|;
name|char
name|buf
index|[
literal|128
index|]
decl_stmt|;
name|int
name|error
decl_stmt|;
name|DPRINTFN
argument_list|(
literal|6
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ugd
operator|->
name|ugd_data
operator|==
name|NULL
operator|)
operator|||
operator|(
name|ugd
operator|->
name|ugd_maxlen
operator|==
literal|0
operator|)
condition|)
block|{
comment|/* userland pointer should not be zero */
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
name|iface
operator|=
name|usbd_get_iface
argument_list|(
name|udev
argument_list|,
name|ugd
operator|->
name|ugd_iface_index
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|iface
operator|==
name|NULL
operator|)
operator|||
operator|(
name|iface
operator|->
name|idesc
operator|==
name|NULL
operator|)
condition|)
block|{
comment|/* invalid interface index */
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
comment|/* read out device nameunit string, if any */
if|if
condition|(
operator|(
name|iface
operator|->
name|subdev
operator|!=
name|NULL
operator|)
operator|&&
name|device_is_attached
argument_list|(
name|iface
operator|->
name|subdev
argument_list|)
operator|&&
operator|(
name|ptr
operator|=
name|device_get_nameunit
argument_list|(
name|iface
operator|->
name|subdev
argument_list|)
operator|)
operator|&&
operator|(
name|desc
operator|=
name|device_get_desc
argument_list|(
name|iface
operator|->
name|subdev
argument_list|)
operator|)
condition|)
block|{
comment|/* print description */
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s:<%s>"
argument_list|,
name|ptr
argument_list|,
name|desc
argument_list|)
expr_stmt|;
comment|/* range checks */
name|maxlen
operator|=
name|ugd
operator|->
name|ugd_maxlen
operator|-
literal|1
expr_stmt|;
name|len
operator|=
name|strlen
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|maxlen
condition|)
name|len
operator|=
name|maxlen
expr_stmt|;
comment|/* update actual length, including terminating zero */
name|ugd
operator|->
name|ugd_actlen
operator|=
name|len
operator|+
literal|1
expr_stmt|;
comment|/* copy out interface description */
name|error
operator|=
name|copyout
argument_list|(
name|buf
argument_list|,
name|ugd
operator|->
name|ugd_data
argument_list|,
name|ugd
operator|->
name|ugd_actlen
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* zero length string is default */
name|error
operator|=
name|copyout
argument_list|(
literal|""
argument_list|,
name|ugd
operator|->
name|ugd_data
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*------------------------------------------------------------------------*  *	usb_gen_fill_deviceinfo  *  * This function dumps information about an USB device to the  * structure pointed to by the "di" argument.  *  * Returns:  *    0: Success  * Else: Failure  *------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|int
name|usb_gen_fill_deviceinfo
parameter_list|(
name|struct
name|usb_fifo
modifier|*
name|f
parameter_list|,
name|struct
name|usb_device_info
modifier|*
name|di
parameter_list|)
block|{
name|struct
name|usb_device
modifier|*
name|udev
decl_stmt|;
name|struct
name|usb_device
modifier|*
name|hub
decl_stmt|;
name|udev
operator|=
name|f
operator|->
name|udev
expr_stmt|;
name|bzero
argument_list|(
name|di
argument_list|,
sizeof|sizeof
argument_list|(
name|di
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|di
operator|->
name|udi_bus
operator|=
name|device_get_unit
argument_list|(
name|udev
operator|->
name|bus
operator|->
name|bdev
argument_list|)
expr_stmt|;
name|di
operator|->
name|udi_addr
operator|=
name|udev
operator|->
name|address
expr_stmt|;
name|di
operator|->
name|udi_index
operator|=
name|udev
operator|->
name|device_index
expr_stmt|;
name|strlcpy
argument_list|(
name|di
operator|->
name|udi_serial
argument_list|,
name|usb_get_serial
argument_list|(
name|udev
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|di
operator|->
name|udi_serial
argument_list|)
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|di
operator|->
name|udi_vendor
argument_list|,
name|usb_get_manufacturer
argument_list|(
name|udev
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|di
operator|->
name|udi_vendor
argument_list|)
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|di
operator|->
name|udi_product
argument_list|,
name|usb_get_product
argument_list|(
name|udev
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|di
operator|->
name|udi_product
argument_list|)
argument_list|)
expr_stmt|;
name|usb_printbcd
argument_list|(
name|di
operator|->
name|udi_release
argument_list|,
sizeof|sizeof
argument_list|(
name|di
operator|->
name|udi_release
argument_list|)
argument_list|,
name|UGETW
argument_list|(
name|udev
operator|->
name|ddesc
operator|.
name|bcdDevice
argument_list|)
argument_list|)
expr_stmt|;
name|di
operator|->
name|udi_vendorNo
operator|=
name|UGETW
argument_list|(
name|udev
operator|->
name|ddesc
operator|.
name|idVendor
argument_list|)
expr_stmt|;
name|di
operator|->
name|udi_productNo
operator|=
name|UGETW
argument_list|(
name|udev
operator|->
name|ddesc
operator|.
name|idProduct
argument_list|)
expr_stmt|;
name|di
operator|->
name|udi_releaseNo
operator|=
name|UGETW
argument_list|(
name|udev
operator|->
name|ddesc
operator|.
name|bcdDevice
argument_list|)
expr_stmt|;
name|di
operator|->
name|udi_class
operator|=
name|udev
operator|->
name|ddesc
operator|.
name|bDeviceClass
expr_stmt|;
name|di
operator|->
name|udi_subclass
operator|=
name|udev
operator|->
name|ddesc
operator|.
name|bDeviceSubClass
expr_stmt|;
name|di
operator|->
name|udi_protocol
operator|=
name|udev
operator|->
name|ddesc
operator|.
name|bDeviceProtocol
expr_stmt|;
name|di
operator|->
name|udi_config_no
operator|=
name|udev
operator|->
name|curr_config_no
expr_stmt|;
name|di
operator|->
name|udi_config_index
operator|=
name|udev
operator|->
name|curr_config_index
expr_stmt|;
name|di
operator|->
name|udi_power
operator|=
name|udev
operator|->
name|flags
operator|.
name|self_powered
condition|?
literal|0
else|:
name|udev
operator|->
name|power
expr_stmt|;
name|di
operator|->
name|udi_speed
operator|=
name|udev
operator|->
name|speed
expr_stmt|;
name|di
operator|->
name|udi_mode
operator|=
name|udev
operator|->
name|flags
operator|.
name|usb_mode
expr_stmt|;
name|di
operator|->
name|udi_power_mode
operator|=
name|udev
operator|->
name|power_mode
expr_stmt|;
name|di
operator|->
name|udi_suspended
operator|=
name|udev
operator|->
name|flags
operator|.
name|peer_suspended
expr_stmt|;
name|hub
operator|=
name|udev
operator|->
name|parent_hub
expr_stmt|;
if|if
condition|(
name|hub
condition|)
block|{
name|di
operator|->
name|udi_hubaddr
operator|=
name|hub
operator|->
name|address
expr_stmt|;
name|di
operator|->
name|udi_hubindex
operator|=
name|hub
operator|->
name|device_index
expr_stmt|;
name|di
operator|->
name|udi_hubport
operator|=
name|udev
operator|->
name|port_no
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*------------------------------------------------------------------------*  *	ugen_check_request  *  * Return values:  * 0: Access allowed  * Else: No access  *------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|int
name|ugen_check_request
parameter_list|(
name|struct
name|usb_device
modifier|*
name|udev
parameter_list|,
name|struct
name|usb_device_request
modifier|*
name|req
parameter_list|)
block|{
name|struct
name|usb_endpoint
modifier|*
name|ep
decl_stmt|;
name|int
name|error
decl_stmt|;
comment|/* 	 * Avoid requests that would damage the bus integrity: 	 */
if|if
condition|(
operator|(
operator|(
name|req
operator|->
name|bmRequestType
operator|==
name|UT_WRITE_DEVICE
operator|)
operator|&&
operator|(
name|req
operator|->
name|bRequest
operator|==
name|UR_SET_ADDRESS
operator|)
operator|)
operator|||
operator|(
operator|(
name|req
operator|->
name|bmRequestType
operator|==
name|UT_WRITE_DEVICE
operator|)
operator|&&
operator|(
name|req
operator|->
name|bRequest
operator|==
name|UR_SET_CONFIG
operator|)
operator|)
operator|||
operator|(
operator|(
name|req
operator|->
name|bmRequestType
operator|==
name|UT_WRITE_INTERFACE
operator|)
operator|&&
operator|(
name|req
operator|->
name|bRequest
operator|==
name|UR_SET_INTERFACE
operator|)
operator|)
condition|)
block|{
comment|/* 		 * These requests can be useful for testing USB drivers. 		 */
name|error
operator|=
name|priv_check
argument_list|(
name|curthread
argument_list|,
name|PRIV_DRIVER
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
return|return
operator|(
name|error
operator|)
return|;
block|}
block|}
comment|/* 	 * Special case - handle clearing of stall 	 */
if|if
condition|(
name|req
operator|->
name|bmRequestType
operator|==
name|UT_WRITE_ENDPOINT
condition|)
block|{
name|ep
operator|=
name|usbd_get_ep_by_addr
argument_list|(
name|udev
argument_list|,
name|req
operator|->
name|wIndex
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ep
operator|==
name|NULL
condition|)
block|{
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|req
operator|->
name|bRequest
operator|==
name|UR_CLEAR_FEATURE
operator|)
operator|&&
operator|(
name|UGETW
argument_list|(
name|req
operator|->
name|wValue
argument_list|)
operator|==
name|UF_ENDPOINT_HALT
operator|)
condition|)
block|{
name|usbd_clear_data_toggle
argument_list|(
name|udev
argument_list|,
name|ep
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* TODO: add more checks to verify the interface index */
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ugen_do_request
parameter_list|(
name|struct
name|usb_fifo
modifier|*
name|f
parameter_list|,
name|struct
name|usb_ctl_request
modifier|*
name|ur
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
name|uint16_t
name|len
decl_stmt|;
name|uint16_t
name|actlen
decl_stmt|;
if|if
condition|(
name|ugen_check_request
argument_list|(
name|f
operator|->
name|udev
argument_list|,
operator|&
name|ur
operator|->
name|ucr_request
argument_list|)
condition|)
block|{
return|return
operator|(
name|EPERM
operator|)
return|;
block|}
name|len
operator|=
name|UGETW
argument_list|(
name|ur
operator|->
name|ucr_request
operator|.
name|wLength
argument_list|)
expr_stmt|;
comment|/* check if "ucr_data" is valid */
if|if
condition|(
name|len
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|ur
operator|->
name|ucr_data
operator|==
name|NULL
condition|)
block|{
return|return
operator|(
name|EFAULT
operator|)
return|;
block|}
block|}
comment|/* do the USB request */
name|error
operator|=
name|usbd_do_request_flags
argument_list|(
name|f
operator|->
name|udev
argument_list|,
name|NULL
argument_list|,
operator|&
name|ur
operator|->
name|ucr_request
argument_list|,
name|ur
operator|->
name|ucr_data
argument_list|,
operator|(
name|ur
operator|->
name|ucr_flags
operator|&
name|USB_SHORT_XFER_OK
operator|)
operator||
name|USB_USER_DATA_PTR
argument_list|,
operator|&
name|actlen
argument_list|,
name|USB_DEFAULT_TIMEOUT
argument_list|)
expr_stmt|;
name|ur
operator|->
name|ucr_actlen
operator|=
name|actlen
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|error
operator|=
name|EIO
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*------------------------------------------------------------------------  *	ugen_re_enumerate  *------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|int
name|ugen_re_enumerate
parameter_list|(
name|struct
name|usb_fifo
modifier|*
name|f
parameter_list|)
block|{
name|struct
name|usb_device
modifier|*
name|udev
init|=
name|f
operator|->
name|udev
decl_stmt|;
name|int
name|error
decl_stmt|;
comment|/* 	 * This request can be useful for testing USB drivers: 	 */
name|error
operator|=
name|priv_check
argument_list|(
name|curthread
argument_list|,
name|PRIV_DRIVER
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
return|return
operator|(
name|error
operator|)
return|;
block|}
if|if
condition|(
name|udev
operator|->
name|flags
operator|.
name|usb_mode
operator|!=
name|USB_MODE_HOST
condition|)
block|{
comment|/* not possible in device side mode */
name|DPRINTFN
argument_list|(
literal|6
argument_list|,
literal|"device mode\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOTTY
operator|)
return|;
block|}
if|if
condition|(
name|udev
operator|->
name|parent_hub
operator|==
name|NULL
condition|)
block|{
comment|/* the root HUB cannot be re-enumerated */
name|DPRINTFN
argument_list|(
literal|6
argument_list|,
literal|"cannot reset root HUB\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
comment|/* make sure all FIFO's are gone */
comment|/* else there can be a deadlock */
if|if
condition|(
name|ugen_fs_uninit
argument_list|(
name|f
argument_list|)
condition|)
block|{
comment|/* ignore any errors */
name|DPRINTFN
argument_list|(
literal|6
argument_list|,
literal|"no FIFOs\n"
argument_list|)
expr_stmt|;
block|}
comment|/* start re-enumeration of device */
name|usbd_start_re_enumerate
argument_list|(
name|udev
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ugen_fs_uninit
parameter_list|(
name|struct
name|usb_fifo
modifier|*
name|f
parameter_list|)
block|{
if|if
condition|(
name|f
operator|->
name|fs_xfer
operator|==
name|NULL
condition|)
block|{
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
name|usbd_transfer_unsetup
argument_list|(
name|f
operator|->
name|fs_xfer
argument_list|,
name|f
operator|->
name|fs_ep_max
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|f
operator|->
name|fs_xfer
argument_list|,
name|M_USB
argument_list|)
expr_stmt|;
name|f
operator|->
name|fs_xfer
operator|=
name|NULL
expr_stmt|;
name|f
operator|->
name|fs_ep_max
operator|=
literal|0
expr_stmt|;
name|f
operator|->
name|fs_ep_ptr
operator|=
name|NULL
expr_stmt|;
name|f
operator|->
name|flag_iscomplete
operator|=
literal|0
expr_stmt|;
name|usb_fifo_free_buffer
argument_list|(
name|f
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|ugen_fs_get_complete
parameter_list|(
name|struct
name|usb_fifo
modifier|*
name|f
parameter_list|,
name|uint8_t
modifier|*
name|pindex
parameter_list|)
block|{
name|struct
name|usb_mbuf
modifier|*
name|m
decl_stmt|;
name|USB_IF_DEQUEUE
argument_list|(
operator|&
name|f
operator|->
name|used_q
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
condition|)
block|{
operator|*
name|pindex
operator|=
operator|*
operator|(
operator|(
name|uint8_t
operator|*
operator|)
operator|(
name|m
operator|->
name|cur_data_ptr
operator|)
operator|)
expr_stmt|;
name|USB_IF_ENQUEUE
argument_list|(
operator|&
name|f
operator|->
name|free_q
argument_list|,
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
comment|/* success */
block|}
else|else
block|{
operator|*
name|pindex
operator|=
literal|0
expr_stmt|;
comment|/* fix compiler warning */
name|f
operator|->
name|flag_iscomplete
operator|=
literal|0
expr_stmt|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
comment|/* failure */
block|}
end_function

begin_function
specifier|static
name|void
name|ugen_fs_set_complete
parameter_list|(
name|struct
name|usb_fifo
modifier|*
name|f
parameter_list|,
name|uint8_t
name|index
parameter_list|)
block|{
name|struct
name|usb_mbuf
modifier|*
name|m
decl_stmt|;
name|USB_IF_DEQUEUE
argument_list|(
operator|&
name|f
operator|->
name|free_q
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
block|{
comment|/* can happen during close */
name|DPRINTF
argument_list|(
literal|"out of buffers\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|USB_MBUF_RESET
argument_list|(
name|m
argument_list|)
expr_stmt|;
operator|*
operator|(
operator|(
name|uint8_t
operator|*
operator|)
operator|(
name|m
operator|->
name|cur_data_ptr
operator|)
operator|)
operator|=
name|index
expr_stmt|;
name|USB_IF_ENQUEUE
argument_list|(
operator|&
name|f
operator|->
name|used_q
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|f
operator|->
name|flag_iscomplete
operator|=
literal|1
expr_stmt|;
name|usb_fifo_wakeup
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|ugen_fs_copy_in
parameter_list|(
name|struct
name|usb_fifo
modifier|*
name|f
parameter_list|,
name|uint8_t
name|ep_index
parameter_list|)
block|{
name|struct
name|usb_device_request
modifier|*
name|req
decl_stmt|;
name|struct
name|usb_xfer
modifier|*
name|xfer
decl_stmt|;
name|struct
name|usb_fs_endpoint
name|fs_ep
decl_stmt|;
name|void
modifier|*
name|uaddr
decl_stmt|;
comment|/* userland pointer */
name|void
modifier|*
name|kaddr
decl_stmt|;
name|usb_frlength_t
name|offset
decl_stmt|;
name|usb_frlength_t
name|rem
decl_stmt|;
name|usb_frcount_t
name|n
decl_stmt|;
name|uint32_t
name|length
decl_stmt|;
name|int
name|error
decl_stmt|;
name|uint8_t
name|isread
decl_stmt|;
if|if
condition|(
name|ep_index
operator|>=
name|f
operator|->
name|fs_ep_max
condition|)
block|{
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
name|xfer
operator|=
name|f
operator|->
name|fs_xfer
index|[
name|ep_index
index|]
expr_stmt|;
if|if
condition|(
name|xfer
operator|==
name|NULL
condition|)
block|{
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
name|mtx_lock
argument_list|(
name|f
operator|->
name|priv_mtx
argument_list|)
expr_stmt|;
if|if
condition|(
name|usbd_transfer_pending
argument_list|(
name|xfer
argument_list|)
condition|)
block|{
name|mtx_unlock
argument_list|(
name|f
operator|->
name|priv_mtx
argument_list|)
expr_stmt|;
return|return
operator|(
name|EBUSY
operator|)
return|;
comment|/* should not happen */
block|}
name|mtx_unlock
argument_list|(
name|f
operator|->
name|priv_mtx
argument_list|)
expr_stmt|;
name|error
operator|=
name|copyin
argument_list|(
name|f
operator|->
name|fs_ep_ptr
operator|+
name|ep_index
argument_list|,
operator|&
name|fs_ep
argument_list|,
sizeof|sizeof
argument_list|(
name|fs_ep
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
return|return
operator|(
name|error
operator|)
return|;
block|}
comment|/* security checks */
if|if
condition|(
name|fs_ep
operator|.
name|nFrames
operator|>
name|xfer
operator|->
name|max_frame_count
condition|)
block|{
name|xfer
operator|->
name|error
operator|=
name|USB_ERR_INVAL
expr_stmt|;
goto|goto
name|complete
goto|;
block|}
if|if
condition|(
name|fs_ep
operator|.
name|nFrames
operator|==
literal|0
condition|)
block|{
name|xfer
operator|->
name|error
operator|=
name|USB_ERR_INVAL
expr_stmt|;
goto|goto
name|complete
goto|;
block|}
name|error
operator|=
name|copyin
argument_list|(
name|fs_ep
operator|.
name|ppBuffer
argument_list|,
operator|&
name|uaddr
argument_list|,
sizeof|sizeof
argument_list|(
name|uaddr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
return|return
operator|(
name|error
operator|)
return|;
block|}
comment|/* reset first frame */
name|usbd_xfer_set_frame_offset
argument_list|(
name|xfer
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|xfer
operator|->
name|flags_int
operator|.
name|control_xfr
condition|)
block|{
name|req
operator|=
name|xfer
operator|->
name|frbuffers
index|[
literal|0
index|]
operator|.
name|buffer
expr_stmt|;
name|error
operator|=
name|copyin
argument_list|(
name|fs_ep
operator|.
name|pLength
argument_list|,
operator|&
name|length
argument_list|,
sizeof|sizeof
argument_list|(
name|length
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
return|return
operator|(
name|error
operator|)
return|;
block|}
if|if
condition|(
name|length
operator|!=
sizeof|sizeof
argument_list|(
operator|*
name|req
argument_list|)
condition|)
block|{
name|xfer
operator|->
name|error
operator|=
name|USB_ERR_INVAL
expr_stmt|;
goto|goto
name|complete
goto|;
block|}
if|if
condition|(
name|length
operator|!=
literal|0
condition|)
block|{
name|error
operator|=
name|copyin
argument_list|(
name|uaddr
argument_list|,
name|req
argument_list|,
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
return|return
operator|(
name|error
operator|)
return|;
block|}
block|}
if|if
condition|(
name|ugen_check_request
argument_list|(
name|f
operator|->
name|udev
argument_list|,
name|req
argument_list|)
condition|)
block|{
name|xfer
operator|->
name|error
operator|=
name|USB_ERR_INVAL
expr_stmt|;
goto|goto
name|complete
goto|;
block|}
name|usbd_xfer_set_frame_len
argument_list|(
name|xfer
argument_list|,
literal|0
argument_list|,
name|length
argument_list|)
expr_stmt|;
comment|/* Host mode only ! */
if|if
condition|(
operator|(
name|req
operator|->
name|bmRequestType
operator|&
operator|(
name|UT_READ
operator||
name|UT_WRITE
operator|)
operator|)
operator|==
name|UT_READ
condition|)
block|{
name|isread
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|isread
operator|=
literal|0
expr_stmt|;
block|}
name|n
operator|=
literal|1
expr_stmt|;
name|offset
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|req
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Device and Host mode */
if|if
condition|(
name|USB_GET_DATA_ISREAD
argument_list|(
name|xfer
argument_list|)
condition|)
block|{
name|isread
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|isread
operator|=
literal|0
expr_stmt|;
block|}
name|n
operator|=
literal|0
expr_stmt|;
name|offset
operator|=
literal|0
expr_stmt|;
block|}
name|rem
operator|=
name|usbd_xfer_max_len
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
name|xfer
operator|->
name|nframes
operator|=
name|fs_ep
operator|.
name|nFrames
expr_stmt|;
name|xfer
operator|->
name|timeout
operator|=
name|fs_ep
operator|.
name|timeout
expr_stmt|;
if|if
condition|(
name|xfer
operator|->
name|timeout
operator|>
literal|65535
condition|)
block|{
name|xfer
operator|->
name|timeout
operator|=
literal|65535
expr_stmt|;
block|}
if|if
condition|(
name|fs_ep
operator|.
name|flags
operator|&
name|USB_FS_FLAG_SINGLE_SHORT_OK
condition|)
name|xfer
operator|->
name|flags
operator|.
name|short_xfer_ok
operator|=
literal|1
expr_stmt|;
else|else
name|xfer
operator|->
name|flags
operator|.
name|short_xfer_ok
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|fs_ep
operator|.
name|flags
operator|&
name|USB_FS_FLAG_MULTI_SHORT_OK
condition|)
name|xfer
operator|->
name|flags
operator|.
name|short_frames_ok
operator|=
literal|1
expr_stmt|;
else|else
name|xfer
operator|->
name|flags
operator|.
name|short_frames_ok
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|fs_ep
operator|.
name|flags
operator|&
name|USB_FS_FLAG_FORCE_SHORT
condition|)
name|xfer
operator|->
name|flags
operator|.
name|force_short_xfer
operator|=
literal|1
expr_stmt|;
else|else
name|xfer
operator|->
name|flags
operator|.
name|force_short_xfer
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|fs_ep
operator|.
name|flags
operator|&
name|USB_FS_FLAG_CLEAR_STALL
condition|)
name|usbd_xfer_set_stall
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
else|else
name|xfer
operator|->
name|flags
operator|.
name|stall_pipe
operator|=
literal|0
expr_stmt|;
for|for
control|(
init|;
name|n
operator|!=
name|xfer
operator|->
name|nframes
condition|;
name|n
operator|++
control|)
block|{
name|error
operator|=
name|copyin
argument_list|(
name|fs_ep
operator|.
name|pLength
operator|+
name|n
argument_list|,
operator|&
name|length
argument_list|,
sizeof|sizeof
argument_list|(
name|length
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
break|break;
block|}
name|usbd_xfer_set_frame_len
argument_list|(
name|xfer
argument_list|,
name|n
argument_list|,
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|length
operator|>
name|rem
condition|)
block|{
name|xfer
operator|->
name|error
operator|=
name|USB_ERR_INVAL
expr_stmt|;
goto|goto
name|complete
goto|;
block|}
name|rem
operator|-=
name|length
expr_stmt|;
if|if
condition|(
operator|!
name|isread
condition|)
block|{
comment|/* we need to know the source buffer */
name|error
operator|=
name|copyin
argument_list|(
name|fs_ep
operator|.
name|ppBuffer
operator|+
name|n
argument_list|,
operator|&
name|uaddr
argument_list|,
sizeof|sizeof
argument_list|(
name|uaddr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
break|break;
block|}
if|if
condition|(
name|xfer
operator|->
name|flags_int
operator|.
name|isochronous_xfr
condition|)
block|{
comment|/* get kernel buffer address */
name|kaddr
operator|=
name|xfer
operator|->
name|frbuffers
index|[
literal|0
index|]
operator|.
name|buffer
expr_stmt|;
name|kaddr
operator|=
name|USB_ADD_BYTES
argument_list|(
name|kaddr
argument_list|,
name|offset
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* set current frame offset */
name|usbd_xfer_set_frame_offset
argument_list|(
name|xfer
argument_list|,
name|offset
argument_list|,
name|n
argument_list|)
expr_stmt|;
comment|/* get kernel buffer address */
name|kaddr
operator|=
name|xfer
operator|->
name|frbuffers
index|[
name|n
index|]
operator|.
name|buffer
expr_stmt|;
block|}
comment|/* move data */
name|error
operator|=
name|copyin
argument_list|(
name|uaddr
argument_list|,
name|kaddr
argument_list|,
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
break|break;
block|}
block|}
name|offset
operator|+=
name|length
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
name|complete
label|:
name|mtx_lock
argument_list|(
name|f
operator|->
name|priv_mtx
argument_list|)
expr_stmt|;
name|ugen_fs_set_complete
argument_list|(
name|f
argument_list|,
name|ep_index
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
name|f
operator|->
name|priv_mtx
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ugen_fs_copy_out
parameter_list|(
name|struct
name|usb_fifo
modifier|*
name|f
parameter_list|,
name|uint8_t
name|ep_index
parameter_list|)
block|{
name|struct
name|usb_device_request
modifier|*
name|req
decl_stmt|;
name|struct
name|usb_xfer
modifier|*
name|xfer
decl_stmt|;
name|struct
name|usb_fs_endpoint
name|fs_ep
decl_stmt|;
name|struct
name|usb_fs_endpoint
modifier|*
name|fs_ep_uptr
decl_stmt|;
comment|/* userland ptr */
name|void
modifier|*
name|uaddr
decl_stmt|;
comment|/* userland ptr */
name|void
modifier|*
name|kaddr
decl_stmt|;
name|usb_frlength_t
name|offset
decl_stmt|;
name|usb_frlength_t
name|rem
decl_stmt|;
name|usb_frcount_t
name|n
decl_stmt|;
name|uint32_t
name|length
decl_stmt|;
name|uint32_t
name|temp
decl_stmt|;
name|int
name|error
decl_stmt|;
name|uint8_t
name|isread
decl_stmt|;
if|if
condition|(
name|ep_index
operator|>=
name|f
operator|->
name|fs_ep_max
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|xfer
operator|=
name|f
operator|->
name|fs_xfer
index|[
name|ep_index
index|]
expr_stmt|;
if|if
condition|(
name|xfer
operator|==
name|NULL
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|mtx_lock
argument_list|(
name|f
operator|->
name|priv_mtx
argument_list|)
expr_stmt|;
if|if
condition|(
name|usbd_transfer_pending
argument_list|(
name|xfer
argument_list|)
condition|)
block|{
name|mtx_unlock
argument_list|(
name|f
operator|->
name|priv_mtx
argument_list|)
expr_stmt|;
return|return
operator|(
name|EBUSY
operator|)
return|;
comment|/* should not happen */
block|}
name|mtx_unlock
argument_list|(
name|f
operator|->
name|priv_mtx
argument_list|)
expr_stmt|;
name|fs_ep_uptr
operator|=
name|f
operator|->
name|fs_ep_ptr
operator|+
name|ep_index
expr_stmt|;
name|error
operator|=
name|copyin
argument_list|(
name|fs_ep_uptr
argument_list|,
operator|&
name|fs_ep
argument_list|,
sizeof|sizeof
argument_list|(
name|fs_ep
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
return|return
operator|(
name|error
operator|)
return|;
block|}
name|fs_ep
operator|.
name|status
operator|=
name|xfer
operator|->
name|error
expr_stmt|;
name|fs_ep
operator|.
name|aFrames
operator|=
name|xfer
operator|->
name|aframes
expr_stmt|;
name|fs_ep
operator|.
name|isoc_time_complete
operator|=
name|xfer
operator|->
name|isoc_time_complete
expr_stmt|;
if|if
condition|(
name|xfer
operator|->
name|error
condition|)
block|{
goto|goto
name|complete
goto|;
block|}
if|if
condition|(
name|xfer
operator|->
name|flags_int
operator|.
name|control_xfr
condition|)
block|{
name|req
operator|=
name|xfer
operator|->
name|frbuffers
index|[
literal|0
index|]
operator|.
name|buffer
expr_stmt|;
comment|/* Host mode only ! */
if|if
condition|(
operator|(
name|req
operator|->
name|bmRequestType
operator|&
operator|(
name|UT_READ
operator||
name|UT_WRITE
operator|)
operator|)
operator|==
name|UT_READ
condition|)
block|{
name|isread
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|isread
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|xfer
operator|->
name|nframes
operator|==
literal|0
condition|)
name|n
operator|=
literal|0
expr_stmt|;
comment|/* should never happen */
else|else
name|n
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
comment|/* Device and Host mode */
if|if
condition|(
name|USB_GET_DATA_ISREAD
argument_list|(
name|xfer
argument_list|)
condition|)
block|{
name|isread
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|isread
operator|=
literal|0
expr_stmt|;
block|}
name|n
operator|=
literal|0
expr_stmt|;
block|}
comment|/* Update lengths and copy out data */
name|rem
operator|=
name|usbd_xfer_max_len
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
name|offset
operator|=
literal|0
expr_stmt|;
for|for
control|(
init|;
name|n
operator|!=
name|xfer
operator|->
name|nframes
condition|;
name|n
operator|++
control|)
block|{
comment|/* get initial length into "temp" */
name|error
operator|=
name|copyin
argument_list|(
name|fs_ep
operator|.
name|pLength
operator|+
name|n
argument_list|,
operator|&
name|temp
argument_list|,
sizeof|sizeof
argument_list|(
name|temp
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
return|return
operator|(
name|error
operator|)
return|;
block|}
if|if
condition|(
name|temp
operator|>
name|rem
condition|)
block|{
comment|/* the userland length has been corrupted */
name|DPRINTF
argument_list|(
literal|"corrupt userland length "
literal|"%u> %u\n"
argument_list|,
name|temp
argument_list|,
name|rem
argument_list|)
expr_stmt|;
name|fs_ep
operator|.
name|status
operator|=
name|USB_ERR_INVAL
expr_stmt|;
goto|goto
name|complete
goto|;
block|}
name|rem
operator|-=
name|temp
expr_stmt|;
comment|/* get actual transfer length */
name|length
operator|=
name|xfer
operator|->
name|frlengths
index|[
name|n
index|]
expr_stmt|;
if|if
condition|(
name|length
operator|>
name|temp
condition|)
block|{
comment|/* data overflow */
name|fs_ep
operator|.
name|status
operator|=
name|USB_ERR_INVAL
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"data overflow %u> %u\n"
argument_list|,
name|length
argument_list|,
name|temp
argument_list|)
expr_stmt|;
goto|goto
name|complete
goto|;
block|}
if|if
condition|(
name|isread
condition|)
block|{
comment|/* we need to know the destination buffer */
name|error
operator|=
name|copyin
argument_list|(
name|fs_ep
operator|.
name|ppBuffer
operator|+
name|n
argument_list|,
operator|&
name|uaddr
argument_list|,
sizeof|sizeof
argument_list|(
name|uaddr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
return|return
operator|(
name|error
operator|)
return|;
block|}
if|if
condition|(
name|xfer
operator|->
name|flags_int
operator|.
name|isochronous_xfr
condition|)
block|{
comment|/* only one frame buffer */
name|kaddr
operator|=
name|USB_ADD_BYTES
argument_list|(
name|xfer
operator|->
name|frbuffers
index|[
literal|0
index|]
operator|.
name|buffer
argument_list|,
name|offset
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* multiple frame buffers */
name|kaddr
operator|=
name|xfer
operator|->
name|frbuffers
index|[
name|n
index|]
operator|.
name|buffer
expr_stmt|;
block|}
comment|/* move data */
name|error
operator|=
name|copyout
argument_list|(
name|kaddr
argument_list|,
name|uaddr
argument_list|,
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
return|return
operator|(
name|error
operator|)
return|;
block|}
block|}
comment|/* 		 * Update offset according to initial length, which is 		 * needed by isochronous transfers! 		 */
name|offset
operator|+=
name|temp
expr_stmt|;
comment|/* update length */
name|error
operator|=
name|copyout
argument_list|(
operator|&
name|length
argument_list|,
name|fs_ep
operator|.
name|pLength
operator|+
name|n
argument_list|,
sizeof|sizeof
argument_list|(
name|length
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
return|return
operator|(
name|error
operator|)
return|;
block|}
block|}
name|complete
label|:
comment|/* update "aFrames" */
name|error
operator|=
name|copyout
argument_list|(
operator|&
name|fs_ep
operator|.
name|aFrames
argument_list|,
operator|&
name|fs_ep_uptr
operator|->
name|aFrames
argument_list|,
sizeof|sizeof
argument_list|(
name|fs_ep
operator|.
name|aFrames
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|done
goto|;
comment|/* update "isoc_time_complete" */
name|error
operator|=
name|copyout
argument_list|(
operator|&
name|fs_ep
operator|.
name|isoc_time_complete
argument_list|,
operator|&
name|fs_ep_uptr
operator|->
name|isoc_time_complete
argument_list|,
sizeof|sizeof
argument_list|(
name|fs_ep
operator|.
name|isoc_time_complete
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|done
goto|;
comment|/* update "status" */
name|error
operator|=
name|copyout
argument_list|(
operator|&
name|fs_ep
operator|.
name|status
argument_list|,
operator|&
name|fs_ep_uptr
operator|->
name|status
argument_list|,
sizeof|sizeof
argument_list|(
name|fs_ep
operator|.
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|done
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|ugen_fifo_in_use
parameter_list|(
name|struct
name|usb_fifo
modifier|*
name|f
parameter_list|,
name|int
name|fflags
parameter_list|)
block|{
name|struct
name|usb_fifo
modifier|*
name|f_rx
decl_stmt|;
name|struct
name|usb_fifo
modifier|*
name|f_tx
decl_stmt|;
name|f_rx
operator|=
name|f
operator|->
name|udev
operator|->
name|fifo
index|[
operator|(
name|f
operator|->
name|fifo_index
operator|&
operator|~
literal|1
operator|)
operator|+
name|USB_FIFO_RX
index|]
expr_stmt|;
name|f_tx
operator|=
name|f
operator|->
name|udev
operator|->
name|fifo
index|[
operator|(
name|f
operator|->
name|fifo_index
operator|&
operator|~
literal|1
operator|)
operator|+
name|USB_FIFO_TX
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|fflags
operator|&
name|FREAD
operator|)
operator|&&
name|f_rx
operator|&&
operator|(
name|f_rx
operator|->
name|xfer
index|[
literal|0
index|]
operator|||
name|f_rx
operator|->
name|xfer
index|[
literal|1
index|]
operator|)
condition|)
block|{
return|return
operator|(
literal|1
operator|)
return|;
comment|/* RX FIFO in use */
block|}
if|if
condition|(
operator|(
name|fflags
operator|&
name|FWRITE
operator|)
operator|&&
name|f_tx
operator|&&
operator|(
name|f_tx
operator|->
name|xfer
index|[
literal|0
index|]
operator|||
name|f_tx
operator|->
name|xfer
index|[
literal|1
index|]
operator|)
condition|)
block|{
return|return
operator|(
literal|1
operator|)
return|;
comment|/* TX FIFO in use */
block|}
return|return
operator|(
literal|0
operator|)
return|;
comment|/* not in use */
block|}
end_function

begin_function
specifier|static
name|int
name|ugen_ioctl
parameter_list|(
name|struct
name|usb_fifo
modifier|*
name|f
parameter_list|,
name|u_long
name|cmd
parameter_list|,
name|void
modifier|*
name|addr
parameter_list|,
name|int
name|fflags
parameter_list|)
block|{
name|struct
name|usb_config
name|usb_config
index|[
literal|1
index|]
decl_stmt|;
name|struct
name|usb_device_request
name|req
decl_stmt|;
union|union
block|{
name|struct
name|usb_fs_complete
modifier|*
name|pcomp
decl_stmt|;
name|struct
name|usb_fs_start
modifier|*
name|pstart
decl_stmt|;
name|struct
name|usb_fs_stop
modifier|*
name|pstop
decl_stmt|;
name|struct
name|usb_fs_open
modifier|*
name|popen
decl_stmt|;
name|struct
name|usb_fs_close
modifier|*
name|pclose
decl_stmt|;
name|struct
name|usb_fs_clear_stall_sync
modifier|*
name|pstall
decl_stmt|;
name|void
modifier|*
name|addr
decl_stmt|;
block|}
name|u
union|;
name|struct
name|usb_endpoint
modifier|*
name|ep
decl_stmt|;
name|struct
name|usb_endpoint_descriptor
modifier|*
name|ed
decl_stmt|;
name|struct
name|usb_xfer
modifier|*
name|xfer
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|uint8_t
name|iface_index
decl_stmt|;
name|uint8_t
name|isread
decl_stmt|;
name|uint8_t
name|ep_index
decl_stmt|;
name|uint8_t
name|pre_scale
decl_stmt|;
name|u
operator|.
name|addr
operator|=
name|addr
expr_stmt|;
name|DPRINTFN
argument_list|(
literal|6
argument_list|,
literal|"cmd=0x%08lx\n"
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|USB_FS_COMPLETE
case|:
name|mtx_lock
argument_list|(
name|f
operator|->
name|priv_mtx
argument_list|)
expr_stmt|;
name|error
operator|=
name|ugen_fs_get_complete
argument_list|(
name|f
argument_list|,
operator|&
name|ep_index
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
name|f
operator|->
name|priv_mtx
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|error
operator|=
name|EBUSY
expr_stmt|;
break|break;
block|}
name|u
operator|.
name|pcomp
operator|->
name|ep_index
operator|=
name|ep_index
expr_stmt|;
name|error
operator|=
name|ugen_fs_copy_out
argument_list|(
name|f
argument_list|,
name|u
operator|.
name|pcomp
operator|->
name|ep_index
argument_list|)
expr_stmt|;
break|break;
case|case
name|USB_FS_START
case|:
name|error
operator|=
name|ugen_fs_copy_in
argument_list|(
name|f
argument_list|,
name|u
operator|.
name|pstart
operator|->
name|ep_index
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
break|break;
name|mtx_lock
argument_list|(
name|f
operator|->
name|priv_mtx
argument_list|)
expr_stmt|;
name|xfer
operator|=
name|f
operator|->
name|fs_xfer
index|[
name|u
operator|.
name|pstart
operator|->
name|ep_index
index|]
expr_stmt|;
name|usbd_transfer_start
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
name|f
operator|->
name|priv_mtx
argument_list|)
expr_stmt|;
break|break;
case|case
name|USB_FS_STOP
case|:
if|if
condition|(
name|u
operator|.
name|pstop
operator|->
name|ep_index
operator|>=
name|f
operator|->
name|fs_ep_max
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
name|mtx_lock
argument_list|(
name|f
operator|->
name|priv_mtx
argument_list|)
expr_stmt|;
name|xfer
operator|=
name|f
operator|->
name|fs_xfer
index|[
name|u
operator|.
name|pstart
operator|->
name|ep_index
index|]
expr_stmt|;
if|if
condition|(
name|usbd_transfer_pending
argument_list|(
name|xfer
argument_list|)
condition|)
block|{
name|usbd_transfer_stop
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
comment|/* 			 * Check if the USB transfer was stopped 			 * before it was even started. Else a cancel 			 * callback will be pending. 			 */
if|if
condition|(
operator|!
name|xfer
operator|->
name|flags_int
operator|.
name|transferring
condition|)
block|{
name|ugen_fs_set_complete
argument_list|(
name|xfer
operator|->
name|priv_sc
argument_list|,
name|USB_P2U
argument_list|(
name|xfer
operator|->
name|priv_fifo
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
name|mtx_unlock
argument_list|(
name|f
operator|->
name|priv_mtx
argument_list|)
expr_stmt|;
break|break;
case|case
name|USB_FS_OPEN
case|:
if|if
condition|(
name|u
operator|.
name|popen
operator|->
name|ep_index
operator|>=
name|f
operator|->
name|fs_ep_max
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|f
operator|->
name|fs_xfer
index|[
name|u
operator|.
name|popen
operator|->
name|ep_index
index|]
operator|!=
name|NULL
condition|)
block|{
name|error
operator|=
name|EBUSY
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|u
operator|.
name|popen
operator|->
name|max_bufsize
operator|>
name|USB_FS_MAX_BUFSIZE
condition|)
block|{
name|u
operator|.
name|popen
operator|->
name|max_bufsize
operator|=
name|USB_FS_MAX_BUFSIZE
expr_stmt|;
block|}
if|if
condition|(
name|u
operator|.
name|popen
operator|->
name|max_frames
operator|&
name|USB_FS_MAX_FRAMES_PRE_SCALE
condition|)
block|{
name|pre_scale
operator|=
literal|1
expr_stmt|;
name|u
operator|.
name|popen
operator|->
name|max_frames
operator|&=
operator|~
name|USB_FS_MAX_FRAMES_PRE_SCALE
expr_stmt|;
block|}
else|else
block|{
name|pre_scale
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|u
operator|.
name|popen
operator|->
name|max_frames
operator|>
name|USB_FS_MAX_FRAMES
condition|)
block|{
name|u
operator|.
name|popen
operator|->
name|max_frames
operator|=
name|USB_FS_MAX_FRAMES
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|u
operator|.
name|popen
operator|->
name|max_frames
operator|==
literal|0
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
name|ep
operator|=
name|usbd_get_ep_by_addr
argument_list|(
name|f
operator|->
name|udev
argument_list|,
name|u
operator|.
name|popen
operator|->
name|ep_no
argument_list|)
expr_stmt|;
if|if
condition|(
name|ep
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
name|ed
operator|=
name|ep
operator|->
name|edesc
expr_stmt|;
if|if
condition|(
name|ed
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|ENXIO
expr_stmt|;
break|break;
block|}
name|iface_index
operator|=
name|ep
operator|->
name|iface_index
expr_stmt|;
name|memset
argument_list|(
name|usb_config
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|usb_config
argument_list|)
argument_list|)
expr_stmt|;
name|usb_config
index|[
literal|0
index|]
operator|.
name|type
operator|=
name|ed
operator|->
name|bmAttributes
operator|&
name|UE_XFERTYPE
expr_stmt|;
name|usb_config
index|[
literal|0
index|]
operator|.
name|endpoint
operator|=
name|ed
operator|->
name|bEndpointAddress
operator|&
name|UE_ADDR
expr_stmt|;
name|usb_config
index|[
literal|0
index|]
operator|.
name|direction
operator|=
name|ed
operator|->
name|bEndpointAddress
operator|&
operator|(
name|UE_DIR_OUT
operator||
name|UE_DIR_IN
operator|)
expr_stmt|;
name|usb_config
index|[
literal|0
index|]
operator|.
name|interval
operator|=
name|USB_DEFAULT_INTERVAL
expr_stmt|;
name|usb_config
index|[
literal|0
index|]
operator|.
name|flags
operator|.
name|proxy_buffer
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|pre_scale
operator|!=
literal|0
condition|)
name|usb_config
index|[
literal|0
index|]
operator|.
name|flags
operator|.
name|pre_scale_frames
operator|=
literal|1
expr_stmt|;
name|usb_config
index|[
literal|0
index|]
operator|.
name|callback
operator|=
operator|&
name|ugen_ctrl_fs_callback
expr_stmt|;
name|usb_config
index|[
literal|0
index|]
operator|.
name|timeout
operator|=
literal|0
expr_stmt|;
comment|/* no timeout */
name|usb_config
index|[
literal|0
index|]
operator|.
name|frames
operator|=
name|u
operator|.
name|popen
operator|->
name|max_frames
expr_stmt|;
name|usb_config
index|[
literal|0
index|]
operator|.
name|bufsize
operator|=
name|u
operator|.
name|popen
operator|->
name|max_bufsize
expr_stmt|;
name|usb_config
index|[
literal|0
index|]
operator|.
name|usb_mode
operator|=
name|USB_MODE_DUAL
expr_stmt|;
comment|/* both modes */
if|if
condition|(
name|usb_config
index|[
literal|0
index|]
operator|.
name|type
operator|==
name|UE_CONTROL
condition|)
block|{
if|if
condition|(
name|f
operator|->
name|udev
operator|->
name|flags
operator|.
name|usb_mode
operator|!=
name|USB_MODE_HOST
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
name|isread
operator|=
operator|(
operator|(
name|usb_config
index|[
literal|0
index|]
operator|.
name|endpoint
operator|&
operator|(
name|UE_DIR_IN
operator||
name|UE_DIR_OUT
operator|)
operator|)
operator|==
name|UE_DIR_IN
operator|)
expr_stmt|;
if|if
condition|(
name|f
operator|->
name|udev
operator|->
name|flags
operator|.
name|usb_mode
operator|!=
name|USB_MODE_HOST
condition|)
block|{
name|isread
operator|=
operator|!
name|isread
expr_stmt|;
block|}
comment|/* check permissions */
if|if
condition|(
name|isread
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|fflags
operator|&
name|FREAD
operator|)
condition|)
block|{
name|error
operator|=
name|EPERM
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
if|if
condition|(
operator|!
operator|(
name|fflags
operator|&
name|FWRITE
operator|)
condition|)
block|{
name|error
operator|=
name|EPERM
expr_stmt|;
break|break;
block|}
block|}
block|}
name|error
operator|=
name|usbd_transfer_setup
argument_list|(
name|f
operator|->
name|udev
argument_list|,
operator|&
name|iface_index
argument_list|,
name|f
operator|->
name|fs_xfer
operator|+
name|u
operator|.
name|popen
operator|->
name|ep_index
argument_list|,
name|usb_config
argument_list|,
literal|1
argument_list|,
name|f
argument_list|,
name|f
operator|->
name|priv_mtx
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
block|{
comment|/* update maximums */
name|u
operator|.
name|popen
operator|->
name|max_packet_length
operator|=
name|f
operator|->
name|fs_xfer
index|[
name|u
operator|.
name|popen
operator|->
name|ep_index
index|]
operator|->
name|max_frame_size
expr_stmt|;
name|u
operator|.
name|popen
operator|->
name|max_bufsize
operator|=
name|f
operator|->
name|fs_xfer
index|[
name|u
operator|.
name|popen
operator|->
name|ep_index
index|]
operator|->
name|max_data_length
expr_stmt|;
comment|/* update number of frames */
name|u
operator|.
name|popen
operator|->
name|max_frames
operator|=
name|f
operator|->
name|fs_xfer
index|[
name|u
operator|.
name|popen
operator|->
name|ep_index
index|]
operator|->
name|nframes
expr_stmt|;
comment|/* store index of endpoint */
name|f
operator|->
name|fs_xfer
index|[
name|u
operator|.
name|popen
operator|->
name|ep_index
index|]
operator|->
name|priv_fifo
operator|=
operator|(
operator|(
name|uint8_t
operator|*
operator|)
literal|0
operator|)
operator|+
name|u
operator|.
name|popen
operator|->
name|ep_index
expr_stmt|;
block|}
else|else
block|{
name|error
operator|=
name|ENOMEM
expr_stmt|;
block|}
break|break;
case|case
name|USB_FS_CLOSE
case|:
if|if
condition|(
name|u
operator|.
name|pclose
operator|->
name|ep_index
operator|>=
name|f
operator|->
name|fs_ep_max
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|f
operator|->
name|fs_xfer
index|[
name|u
operator|.
name|pclose
operator|->
name|ep_index
index|]
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
name|usbd_transfer_unsetup
argument_list|(
name|f
operator|->
name|fs_xfer
operator|+
name|u
operator|.
name|pclose
operator|->
name|ep_index
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|USB_FS_CLEAR_STALL_SYNC
case|:
if|if
condition|(
name|u
operator|.
name|pstall
operator|->
name|ep_index
operator|>=
name|f
operator|->
name|fs_ep_max
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|f
operator|->
name|fs_xfer
index|[
name|u
operator|.
name|pstall
operator|->
name|ep_index
index|]
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|f
operator|->
name|udev
operator|->
name|flags
operator|.
name|usb_mode
operator|!=
name|USB_MODE_HOST
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
name|mtx_lock
argument_list|(
name|f
operator|->
name|priv_mtx
argument_list|)
expr_stmt|;
name|error
operator|=
name|usbd_transfer_pending
argument_list|(
name|f
operator|->
name|fs_xfer
index|[
name|u
operator|.
name|pstall
operator|->
name|ep_index
index|]
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
name|f
operator|->
name|priv_mtx
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
return|return
operator|(
name|EBUSY
operator|)
return|;
block|}
name|ep
operator|=
name|f
operator|->
name|fs_xfer
index|[
name|u
operator|.
name|pstall
operator|->
name|ep_index
index|]
operator|->
name|endpoint
expr_stmt|;
comment|/* setup a clear-stall packet */
name|req
operator|.
name|bmRequestType
operator|=
name|UT_WRITE_ENDPOINT
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|UR_CLEAR_FEATURE
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
name|UF_ENDPOINT_HALT
argument_list|)
expr_stmt|;
name|req
operator|.
name|wIndex
index|[
literal|0
index|]
operator|=
name|ep
operator|->
name|edesc
operator|->
name|bEndpointAddress
expr_stmt|;
name|req
operator|.
name|wIndex
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|error
operator|=
name|usbd_do_request
argument_list|(
name|f
operator|->
name|udev
argument_list|,
name|NULL
argument_list|,
operator|&
name|req
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
block|{
name|usbd_clear_data_toggle
argument_list|(
name|f
operator|->
name|udev
argument_list|,
name|ep
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|error
operator|=
name|ENXIO
expr_stmt|;
block|}
break|break;
default|default:
name|error
operator|=
name|ENOIOCTL
expr_stmt|;
break|break;
block|}
name|DPRINTFN
argument_list|(
literal|6
argument_list|,
literal|"error=%d\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ugen_set_short_xfer
parameter_list|(
name|struct
name|usb_fifo
modifier|*
name|f
parameter_list|,
name|void
modifier|*
name|addr
parameter_list|)
block|{
name|uint8_t
name|t
decl_stmt|;
if|if
condition|(
operator|*
operator|(
name|int
operator|*
operator|)
name|addr
condition|)
name|t
operator|=
literal|1
expr_stmt|;
else|else
name|t
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|f
operator|->
name|flag_short
operator|==
name|t
condition|)
block|{
comment|/* same value like before - accept */
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|f
operator|->
name|xfer
index|[
literal|0
index|]
operator|||
name|f
operator|->
name|xfer
index|[
literal|1
index|]
condition|)
block|{
comment|/* cannot change this during transfer */
return|return
operator|(
name|EBUSY
operator|)
return|;
block|}
name|f
operator|->
name|flag_short
operator|=
name|t
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ugen_set_timeout
parameter_list|(
name|struct
name|usb_fifo
modifier|*
name|f
parameter_list|,
name|void
modifier|*
name|addr
parameter_list|)
block|{
name|f
operator|->
name|timeout
operator|=
operator|*
operator|(
name|int
operator|*
operator|)
name|addr
expr_stmt|;
if|if
condition|(
name|f
operator|->
name|timeout
operator|>
literal|65535
condition|)
block|{
comment|/* limit user input */
name|f
operator|->
name|timeout
operator|=
literal|65535
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ugen_get_frame_size
parameter_list|(
name|struct
name|usb_fifo
modifier|*
name|f
parameter_list|,
name|void
modifier|*
name|addr
parameter_list|)
block|{
if|if
condition|(
name|f
operator|->
name|xfer
index|[
literal|0
index|]
condition|)
block|{
operator|*
operator|(
name|int
operator|*
operator|)
name|addr
operator|=
name|f
operator|->
name|xfer
index|[
literal|0
index|]
operator|->
name|max_frame_size
expr_stmt|;
block|}
else|else
block|{
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ugen_set_buffer_size
parameter_list|(
name|struct
name|usb_fifo
modifier|*
name|f
parameter_list|,
name|void
modifier|*
name|addr
parameter_list|)
block|{
name|usb_frlength_t
name|t
decl_stmt|;
if|if
condition|(
operator|*
operator|(
name|int
operator|*
operator|)
name|addr
operator|<
literal|0
condition|)
name|t
operator|=
literal|0
expr_stmt|;
comment|/* use "wMaxPacketSize" */
elseif|else
if|if
condition|(
operator|*
operator|(
name|int
operator|*
operator|)
name|addr
operator|<
operator|(
literal|256
operator|*
literal|1024
operator|)
condition|)
name|t
operator|=
operator|*
operator|(
name|int
operator|*
operator|)
name|addr
expr_stmt|;
else|else
name|t
operator|=
literal|256
operator|*
literal|1024
expr_stmt|;
if|if
condition|(
name|f
operator|->
name|bufsize
operator|==
name|t
condition|)
block|{
comment|/* same value like before - accept */
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|f
operator|->
name|xfer
index|[
literal|0
index|]
operator|||
name|f
operator|->
name|xfer
index|[
literal|1
index|]
condition|)
block|{
comment|/* cannot change this during transfer */
return|return
operator|(
name|EBUSY
operator|)
return|;
block|}
name|f
operator|->
name|bufsize
operator|=
name|t
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ugen_get_buffer_size
parameter_list|(
name|struct
name|usb_fifo
modifier|*
name|f
parameter_list|,
name|void
modifier|*
name|addr
parameter_list|)
block|{
operator|*
operator|(
name|int
operator|*
operator|)
name|addr
operator|=
name|f
operator|->
name|bufsize
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ugen_get_iface_desc
parameter_list|(
name|struct
name|usb_fifo
modifier|*
name|f
parameter_list|,
name|struct
name|usb_interface_descriptor
modifier|*
name|idesc
parameter_list|)
block|{
name|struct
name|usb_interface
modifier|*
name|iface
decl_stmt|;
name|iface
operator|=
name|usbd_get_iface
argument_list|(
name|f
operator|->
name|udev
argument_list|,
name|f
operator|->
name|iface_index
argument_list|)
expr_stmt|;
if|if
condition|(
name|iface
operator|&&
name|iface
operator|->
name|idesc
condition|)
block|{
operator|*
name|idesc
operator|=
operator|*
operator|(
name|iface
operator|->
name|idesc
operator|)
expr_stmt|;
block|}
else|else
block|{
return|return
operator|(
name|EIO
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ugen_get_endpoint_desc
parameter_list|(
name|struct
name|usb_fifo
modifier|*
name|f
parameter_list|,
name|struct
name|usb_endpoint_descriptor
modifier|*
name|ed
parameter_list|)
block|{
name|struct
name|usb_endpoint
modifier|*
name|ep
decl_stmt|;
name|ep
operator|=
name|usb_fifo_softc
argument_list|(
name|f
argument_list|)
expr_stmt|;
if|if
condition|(
name|ep
operator|&&
name|ep
operator|->
name|edesc
condition|)
block|{
operator|*
name|ed
operator|=
operator|*
name|ep
operator|->
name|edesc
expr_stmt|;
block|}
else|else
block|{
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ugen_set_power_mode
parameter_list|(
name|struct
name|usb_fifo
modifier|*
name|f
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|struct
name|usb_device
modifier|*
name|udev
init|=
name|f
operator|->
name|udev
decl_stmt|;
name|int
name|err
decl_stmt|;
name|uint8_t
name|old_mode
decl_stmt|;
if|if
condition|(
operator|(
name|udev
operator|==
name|NULL
operator|)
operator|||
operator|(
name|udev
operator|->
name|parent_hub
operator|==
name|NULL
operator|)
condition|)
block|{
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
name|err
operator|=
name|priv_check
argument_list|(
name|curthread
argument_list|,
name|PRIV_DRIVER
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
operator|(
name|err
operator|)
return|;
comment|/* get old power mode */
name|old_mode
operator|=
name|udev
operator|->
name|power_mode
expr_stmt|;
comment|/* if no change, then just return */
if|if
condition|(
name|old_mode
operator|==
name|mode
condition|)
return|return
operator|(
literal|0
operator|)
return|;
switch|switch
condition|(
name|mode
condition|)
block|{
case|case
name|USB_POWER_MODE_OFF
case|:
comment|/* get the device unconfigured */
name|err
operator|=
name|ugen_set_config
argument_list|(
name|f
argument_list|,
name|USB_UNCONFIG_INDEX
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|DPRINTFN
argument_list|(
literal|0
argument_list|,
literal|"Could not unconfigure "
literal|"device (ignored)\n"
argument_list|)
expr_stmt|;
block|}
comment|/* clear port enable */
name|err
operator|=
name|usbd_req_clear_port_feature
argument_list|(
name|udev
operator|->
name|parent_hub
argument_list|,
name|NULL
argument_list|,
name|udev
operator|->
name|port_no
argument_list|,
name|UHF_PORT_ENABLE
argument_list|)
expr_stmt|;
break|break;
case|case
name|USB_POWER_MODE_ON
case|:
case|case
name|USB_POWER_MODE_SAVE
case|:
break|break;
case|case
name|USB_POWER_MODE_RESUME
case|:
if|#
directive|if
name|USB_HAVE_POWERD
comment|/* let USB-powerd handle resume */
name|USB_BUS_LOCK
argument_list|(
name|udev
operator|->
name|bus
argument_list|)
expr_stmt|;
name|udev
operator|->
name|pwr_save
operator|.
name|write_refs
operator|++
expr_stmt|;
name|udev
operator|->
name|pwr_save
operator|.
name|last_xfer_time
operator|=
name|ticks
expr_stmt|;
name|USB_BUS_UNLOCK
argument_list|(
name|udev
operator|->
name|bus
argument_list|)
expr_stmt|;
comment|/* set new power mode */
name|usbd_set_power_mode
argument_list|(
name|udev
argument_list|,
name|USB_POWER_MODE_SAVE
argument_list|)
expr_stmt|;
comment|/* wait for resume to complete */
name|usb_pause_mtx
argument_list|(
name|NULL
argument_list|,
name|hz
operator|/
literal|4
argument_list|)
expr_stmt|;
comment|/* clear write reference */
name|USB_BUS_LOCK
argument_list|(
name|udev
operator|->
name|bus
argument_list|)
expr_stmt|;
name|udev
operator|->
name|pwr_save
operator|.
name|write_refs
operator|--
expr_stmt|;
name|USB_BUS_UNLOCK
argument_list|(
name|udev
operator|->
name|bus
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|mode
operator|=
name|USB_POWER_MODE_SAVE
expr_stmt|;
break|break;
case|case
name|USB_POWER_MODE_SUSPEND
case|:
if|#
directive|if
name|USB_HAVE_POWERD
comment|/* let USB-powerd handle suspend */
name|USB_BUS_LOCK
argument_list|(
name|udev
operator|->
name|bus
argument_list|)
expr_stmt|;
name|udev
operator|->
name|pwr_save
operator|.
name|last_xfer_time
operator|=
name|ticks
operator|-
operator|(
literal|256
operator|*
name|hz
operator|)
expr_stmt|;
name|USB_BUS_UNLOCK
argument_list|(
name|udev
operator|->
name|bus
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|mode
operator|=
name|USB_POWER_MODE_SAVE
expr_stmt|;
break|break;
default|default:
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
if|if
condition|(
name|err
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
comment|/* I/O failure */
comment|/* if we are powered off we need to re-enumerate first */
if|if
condition|(
name|old_mode
operator|==
name|USB_POWER_MODE_OFF
condition|)
block|{
if|if
condition|(
name|udev
operator|->
name|flags
operator|.
name|usb_mode
operator|==
name|USB_MODE_HOST
condition|)
block|{
if|if
condition|(
name|udev
operator|->
name|re_enumerate_wait
operator|==
literal|0
condition|)
name|udev
operator|->
name|re_enumerate_wait
operator|=
literal|1
expr_stmt|;
block|}
comment|/* set power mode will wake up the explore thread */
block|}
comment|/* set new power mode */
name|usbd_set_power_mode
argument_list|(
name|udev
argument_list|,
name|mode
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
comment|/* success */
block|}
end_function

begin_function
specifier|static
name|int
name|ugen_get_power_mode
parameter_list|(
name|struct
name|usb_fifo
modifier|*
name|f
parameter_list|)
block|{
name|struct
name|usb_device
modifier|*
name|udev
init|=
name|f
operator|->
name|udev
decl_stmt|;
if|if
condition|(
name|udev
operator|==
name|NULL
condition|)
return|return
operator|(
name|USB_POWER_MODE_ON
operator|)
return|;
return|return
operator|(
name|udev
operator|->
name|power_mode
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ugen_get_port_path
parameter_list|(
name|struct
name|usb_fifo
modifier|*
name|f
parameter_list|,
name|struct
name|usb_device_port_path
modifier|*
name|dpp
parameter_list|)
block|{
name|struct
name|usb_device
modifier|*
name|udev
init|=
name|f
operator|->
name|udev
decl_stmt|;
name|struct
name|usb_device
modifier|*
name|next
decl_stmt|;
name|unsigned
name|int
name|nlevel
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|udev
operator|==
name|NULL
condition|)
goto|goto
name|error
goto|;
name|dpp
operator|->
name|udp_bus
operator|=
name|device_get_unit
argument_list|(
name|udev
operator|->
name|bus
operator|->
name|bdev
argument_list|)
expr_stmt|;
name|dpp
operator|->
name|udp_index
operator|=
name|udev
operator|->
name|device_index
expr_stmt|;
comment|/* count port levels */
name|next
operator|=
name|udev
expr_stmt|;
while|while
condition|(
name|next
operator|->
name|parent_hub
operator|!=
name|NULL
condition|)
block|{
name|nlevel
operator|++
expr_stmt|;
name|next
operator|=
name|next
operator|->
name|parent_hub
expr_stmt|;
block|}
comment|/* check if too many levels */
if|if
condition|(
name|nlevel
operator|>
name|USB_DEVICE_PORT_PATH_MAX
condition|)
goto|goto
name|error
goto|;
comment|/* store port index array */
name|next
operator|=
name|udev
expr_stmt|;
while|while
condition|(
name|next
operator|->
name|parent_hub
operator|!=
name|NULL
condition|)
block|{
name|nlevel
operator|--
expr_stmt|;
name|dpp
operator|->
name|udp_port_no
index|[
name|nlevel
index|]
operator|=
name|next
operator|->
name|port_no
expr_stmt|;
name|dpp
operator|->
name|udp_port_level
operator|=
name|nlevel
expr_stmt|;
name|next
operator|=
name|next
operator|->
name|parent_hub
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
comment|/* success */
name|error
label|:
return|return
operator|(
name|EINVAL
operator|)
return|;
comment|/* failure */
block|}
end_function

begin_function
specifier|static
name|int
name|ugen_get_power_usage
parameter_list|(
name|struct
name|usb_fifo
modifier|*
name|f
parameter_list|)
block|{
name|struct
name|usb_device
modifier|*
name|udev
init|=
name|f
operator|->
name|udev
decl_stmt|;
if|if
condition|(
name|udev
operator|==
name|NULL
condition|)
return|return
operator|(
literal|0
operator|)
return|;
return|return
operator|(
name|udev
operator|->
name|power
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ugen_do_port_feature
parameter_list|(
name|struct
name|usb_fifo
modifier|*
name|f
parameter_list|,
name|uint8_t
name|port_no
parameter_list|,
name|uint8_t
name|set
parameter_list|,
name|uint16_t
name|feature
parameter_list|)
block|{
name|struct
name|usb_device
modifier|*
name|udev
init|=
name|f
operator|->
name|udev
decl_stmt|;
name|struct
name|usb_hub
modifier|*
name|hub
decl_stmt|;
name|int
name|err
decl_stmt|;
name|err
operator|=
name|priv_check
argument_list|(
name|curthread
argument_list|,
name|PRIV_DRIVER
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
return|return
operator|(
name|err
operator|)
return|;
block|}
if|if
condition|(
name|port_no
operator|==
literal|0
condition|)
block|{
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|udev
operator|==
name|NULL
operator|)
operator|||
operator|(
name|udev
operator|->
name|hub
operator|==
name|NULL
operator|)
condition|)
block|{
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
name|hub
operator|=
name|udev
operator|->
name|hub
expr_stmt|;
if|if
condition|(
name|port_no
operator|>
name|hub
operator|->
name|nports
condition|)
block|{
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
if|if
condition|(
name|set
condition|)
name|err
operator|=
name|usbd_req_set_port_feature
argument_list|(
name|udev
argument_list|,
name|NULL
argument_list|,
name|port_no
argument_list|,
name|feature
argument_list|)
expr_stmt|;
else|else
name|err
operator|=
name|usbd_req_clear_port_feature
argument_list|(
name|udev
argument_list|,
name|NULL
argument_list|,
name|port_no
argument_list|,
name|feature
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
comment|/* failure */
return|return
operator|(
literal|0
operator|)
return|;
comment|/* success */
block|}
end_function

begin_function
specifier|static
name|int
name|ugen_iface_ioctl
parameter_list|(
name|struct
name|usb_fifo
modifier|*
name|f
parameter_list|,
name|u_long
name|cmd
parameter_list|,
name|void
modifier|*
name|addr
parameter_list|,
name|int
name|fflags
parameter_list|)
block|{
name|struct
name|usb_fifo
modifier|*
name|f_rx
decl_stmt|;
name|struct
name|usb_fifo
modifier|*
name|f_tx
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|f_rx
operator|=
name|f
operator|->
name|udev
operator|->
name|fifo
index|[
operator|(
name|f
operator|->
name|fifo_index
operator|&
operator|~
literal|1
operator|)
operator|+
name|USB_FIFO_RX
index|]
expr_stmt|;
name|f_tx
operator|=
name|f
operator|->
name|udev
operator|->
name|fifo
index|[
operator|(
name|f
operator|->
name|fifo_index
operator|&
operator|~
literal|1
operator|)
operator|+
name|USB_FIFO_TX
index|]
expr_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|USB_SET_RX_SHORT_XFER
case|:
if|if
condition|(
name|fflags
operator|&
name|FREAD
condition|)
block|{
name|error
operator|=
name|ugen_set_short_xfer
argument_list|(
name|f_rx
argument_list|,
name|addr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
block|}
break|break;
case|case
name|USB_SET_TX_FORCE_SHORT
case|:
if|if
condition|(
name|fflags
operator|&
name|FWRITE
condition|)
block|{
name|error
operator|=
name|ugen_set_short_xfer
argument_list|(
name|f_tx
argument_list|,
name|addr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
block|}
break|break;
case|case
name|USB_SET_RX_TIMEOUT
case|:
if|if
condition|(
name|fflags
operator|&
name|FREAD
condition|)
block|{
name|error
operator|=
name|ugen_set_timeout
argument_list|(
name|f_rx
argument_list|,
name|addr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
block|}
break|break;
case|case
name|USB_SET_TX_TIMEOUT
case|:
if|if
condition|(
name|fflags
operator|&
name|FWRITE
condition|)
block|{
name|error
operator|=
name|ugen_set_timeout
argument_list|(
name|f_tx
argument_list|,
name|addr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
block|}
break|break;
case|case
name|USB_GET_RX_FRAME_SIZE
case|:
if|if
condition|(
name|fflags
operator|&
name|FREAD
condition|)
block|{
name|error
operator|=
name|ugen_get_frame_size
argument_list|(
name|f_rx
argument_list|,
name|addr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
block|}
break|break;
case|case
name|USB_GET_TX_FRAME_SIZE
case|:
if|if
condition|(
name|fflags
operator|&
name|FWRITE
condition|)
block|{
name|error
operator|=
name|ugen_get_frame_size
argument_list|(
name|f_tx
argument_list|,
name|addr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
block|}
break|break;
case|case
name|USB_SET_RX_BUFFER_SIZE
case|:
if|if
condition|(
name|fflags
operator|&
name|FREAD
condition|)
block|{
name|error
operator|=
name|ugen_set_buffer_size
argument_list|(
name|f_rx
argument_list|,
name|addr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
block|}
break|break;
case|case
name|USB_SET_TX_BUFFER_SIZE
case|:
if|if
condition|(
name|fflags
operator|&
name|FWRITE
condition|)
block|{
name|error
operator|=
name|ugen_set_buffer_size
argument_list|(
name|f_tx
argument_list|,
name|addr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
block|}
break|break;
case|case
name|USB_GET_RX_BUFFER_SIZE
case|:
if|if
condition|(
name|fflags
operator|&
name|FREAD
condition|)
block|{
name|error
operator|=
name|ugen_get_buffer_size
argument_list|(
name|f_rx
argument_list|,
name|addr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
block|}
break|break;
case|case
name|USB_GET_TX_BUFFER_SIZE
case|:
if|if
condition|(
name|fflags
operator|&
name|FWRITE
condition|)
block|{
name|error
operator|=
name|ugen_get_buffer_size
argument_list|(
name|f_tx
argument_list|,
name|addr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
block|}
break|break;
case|case
name|USB_GET_RX_INTERFACE_DESC
case|:
if|if
condition|(
name|fflags
operator|&
name|FREAD
condition|)
block|{
name|error
operator|=
name|ugen_get_iface_desc
argument_list|(
name|f_rx
argument_list|,
name|addr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
block|}
break|break;
case|case
name|USB_GET_TX_INTERFACE_DESC
case|:
if|if
condition|(
name|fflags
operator|&
name|FWRITE
condition|)
block|{
name|error
operator|=
name|ugen_get_iface_desc
argument_list|(
name|f_tx
argument_list|,
name|addr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
block|}
break|break;
case|case
name|USB_GET_RX_ENDPOINT_DESC
case|:
if|if
condition|(
name|fflags
operator|&
name|FREAD
condition|)
block|{
name|error
operator|=
name|ugen_get_endpoint_desc
argument_list|(
name|f_rx
argument_list|,
name|addr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
block|}
break|break;
case|case
name|USB_GET_TX_ENDPOINT_DESC
case|:
if|if
condition|(
name|fflags
operator|&
name|FWRITE
condition|)
block|{
name|error
operator|=
name|ugen_get_endpoint_desc
argument_list|(
name|f_tx
argument_list|,
name|addr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
block|}
break|break;
case|case
name|USB_SET_RX_STALL_FLAG
case|:
if|if
condition|(
operator|(
name|fflags
operator|&
name|FREAD
operator|)
operator|&&
operator|(
operator|*
operator|(
name|int
operator|*
operator|)
name|addr
operator|)
condition|)
block|{
name|f_rx
operator|->
name|flag_stall
operator|=
literal|1
expr_stmt|;
block|}
break|break;
case|case
name|USB_SET_TX_STALL_FLAG
case|:
if|if
condition|(
operator|(
name|fflags
operator|&
name|FWRITE
operator|)
operator|&&
operator|(
operator|*
operator|(
name|int
operator|*
operator|)
name|addr
operator|)
condition|)
block|{
name|f_tx
operator|->
name|flag_stall
operator|=
literal|1
expr_stmt|;
block|}
break|break;
default|default:
name|error
operator|=
name|ENOIOCTL
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ugen_ioctl_post
parameter_list|(
name|struct
name|usb_fifo
modifier|*
name|f
parameter_list|,
name|u_long
name|cmd
parameter_list|,
name|void
modifier|*
name|addr
parameter_list|,
name|int
name|fflags
parameter_list|)
block|{
union|union
block|{
name|struct
name|usb_interface_descriptor
modifier|*
name|idesc
decl_stmt|;
name|struct
name|usb_alt_interface
modifier|*
name|ai
decl_stmt|;
name|struct
name|usb_device_descriptor
modifier|*
name|ddesc
decl_stmt|;
name|struct
name|usb_config_descriptor
modifier|*
name|cdesc
decl_stmt|;
name|struct
name|usb_device_stats
modifier|*
name|stat
decl_stmt|;
name|struct
name|usb_fs_init
modifier|*
name|pinit
decl_stmt|;
name|struct
name|usb_fs_uninit
modifier|*
name|puninit
decl_stmt|;
name|struct
name|usb_device_port_path
modifier|*
name|dpp
decl_stmt|;
name|uint32_t
modifier|*
name|ptime
decl_stmt|;
name|void
modifier|*
name|addr
decl_stmt|;
name|int
modifier|*
name|pint
decl_stmt|;
block|}
name|u
union|;
name|struct
name|usb_device_descriptor
modifier|*
name|dtemp
decl_stmt|;
name|struct
name|usb_config_descriptor
modifier|*
name|ctemp
decl_stmt|;
name|struct
name|usb_interface
modifier|*
name|iface
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|uint8_t
name|n
decl_stmt|;
name|u
operator|.
name|addr
operator|=
name|addr
expr_stmt|;
name|DPRINTFN
argument_list|(
literal|6
argument_list|,
literal|"cmd=0x%08lx\n"
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|USB_DISCOVER
case|:
name|usb_needs_explore_all
argument_list|()
expr_stmt|;
break|break;
case|case
name|USB_SETDEBUG
case|:
if|if
condition|(
operator|!
operator|(
name|fflags
operator|&
name|FWRITE
operator|)
condition|)
block|{
name|error
operator|=
name|EPERM
expr_stmt|;
break|break;
block|}
name|usb_debug
operator|=
operator|*
operator|(
name|int
operator|*
operator|)
name|addr
expr_stmt|;
break|break;
case|case
name|USB_GET_CONFIG
case|:
operator|*
operator|(
name|int
operator|*
operator|)
name|addr
operator|=
name|f
operator|->
name|udev
operator|->
name|curr_config_index
expr_stmt|;
break|break;
case|case
name|USB_SET_CONFIG
case|:
if|if
condition|(
operator|!
operator|(
name|fflags
operator|&
name|FWRITE
operator|)
condition|)
block|{
name|error
operator|=
name|EPERM
expr_stmt|;
break|break;
block|}
name|error
operator|=
name|ugen_set_config
argument_list|(
name|f
argument_list|,
operator|*
operator|(
name|int
operator|*
operator|)
name|addr
argument_list|)
expr_stmt|;
break|break;
case|case
name|USB_GET_ALTINTERFACE
case|:
name|iface
operator|=
name|usbd_get_iface
argument_list|(
name|f
operator|->
name|udev
argument_list|,
name|u
operator|.
name|ai
operator|->
name|uai_interface_index
argument_list|)
expr_stmt|;
if|if
condition|(
name|iface
operator|&&
name|iface
operator|->
name|idesc
condition|)
block|{
name|u
operator|.
name|ai
operator|->
name|uai_alt_index
operator|=
name|iface
operator|->
name|alt_index
expr_stmt|;
block|}
else|else
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
block|}
break|break;
case|case
name|USB_SET_ALTINTERFACE
case|:
if|if
condition|(
operator|!
operator|(
name|fflags
operator|&
name|FWRITE
operator|)
condition|)
block|{
name|error
operator|=
name|EPERM
expr_stmt|;
break|break;
block|}
name|error
operator|=
name|ugen_set_interface
argument_list|(
name|f
argument_list|,
name|u
operator|.
name|ai
operator|->
name|uai_interface_index
argument_list|,
name|u
operator|.
name|ai
operator|->
name|uai_alt_index
argument_list|)
expr_stmt|;
break|break;
case|case
name|USB_GET_DEVICE_DESC
case|:
name|dtemp
operator|=
name|usbd_get_device_descriptor
argument_list|(
name|f
operator|->
name|udev
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dtemp
condition|)
block|{
name|error
operator|=
name|EIO
expr_stmt|;
break|break;
block|}
operator|*
name|u
operator|.
name|ddesc
operator|=
operator|*
name|dtemp
expr_stmt|;
break|break;
case|case
name|USB_GET_CONFIG_DESC
case|:
name|ctemp
operator|=
name|usbd_get_config_descriptor
argument_list|(
name|f
operator|->
name|udev
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ctemp
condition|)
block|{
name|error
operator|=
name|EIO
expr_stmt|;
break|break;
block|}
operator|*
name|u
operator|.
name|cdesc
operator|=
operator|*
name|ctemp
expr_stmt|;
break|break;
case|case
name|USB_GET_FULL_DESC
case|:
name|error
operator|=
name|ugen_get_cdesc
argument_list|(
name|f
argument_list|,
name|addr
argument_list|)
expr_stmt|;
break|break;
case|case
name|USB_GET_STRING_DESC
case|:
name|error
operator|=
name|ugen_get_sdesc
argument_list|(
name|f
argument_list|,
name|addr
argument_list|)
expr_stmt|;
break|break;
case|case
name|USB_GET_IFACE_DRIVER
case|:
name|error
operator|=
name|ugen_get_iface_driver
argument_list|(
name|f
argument_list|,
name|addr
argument_list|)
expr_stmt|;
break|break;
case|case
name|USB_REQUEST
case|:
case|case
name|USB_DO_REQUEST
case|:
if|if
condition|(
operator|!
operator|(
name|fflags
operator|&
name|FWRITE
operator|)
condition|)
block|{
name|error
operator|=
name|EPERM
expr_stmt|;
break|break;
block|}
name|error
operator|=
name|ugen_do_request
argument_list|(
name|f
argument_list|,
name|addr
argument_list|)
expr_stmt|;
break|break;
case|case
name|USB_DEVICEINFO
case|:
case|case
name|USB_GET_DEVICEINFO
case|:
name|error
operator|=
name|usb_gen_fill_deviceinfo
argument_list|(
name|f
argument_list|,
name|addr
argument_list|)
expr_stmt|;
break|break;
case|case
name|USB_DEVICESTATS
case|:
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|!=
literal|4
condition|;
name|n
operator|++
control|)
block|{
name|u
operator|.
name|stat
operator|->
name|uds_requests_fail
index|[
name|n
index|]
operator|=
name|f
operator|->
name|udev
operator|->
name|bus
operator|->
name|stats_err
operator|.
name|uds_requests
index|[
name|n
index|]
expr_stmt|;
name|u
operator|.
name|stat
operator|->
name|uds_requests_ok
index|[
name|n
index|]
operator|=
name|f
operator|->
name|udev
operator|->
name|bus
operator|->
name|stats_ok
operator|.
name|uds_requests
index|[
name|n
index|]
expr_stmt|;
block|}
break|break;
case|case
name|USB_DEVICEENUMERATE
case|:
name|error
operator|=
name|ugen_re_enumerate
argument_list|(
name|f
argument_list|)
expr_stmt|;
break|break;
case|case
name|USB_GET_PLUGTIME
case|:
operator|*
name|u
operator|.
name|ptime
operator|=
name|f
operator|->
name|udev
operator|->
name|plugtime
expr_stmt|;
break|break;
case|case
name|USB_CLAIM_INTERFACE
case|:
case|case
name|USB_RELEASE_INTERFACE
case|:
comment|/* TODO */
break|break;
case|case
name|USB_IFACE_DRIVER_ACTIVE
case|:
name|n
operator|=
operator|*
name|u
operator|.
name|pint
operator|&
literal|0xFF
expr_stmt|;
name|iface
operator|=
name|usbd_get_iface
argument_list|(
name|f
operator|->
name|udev
argument_list|,
name|n
argument_list|)
expr_stmt|;
if|if
condition|(
name|iface
operator|&&
name|iface
operator|->
name|subdev
condition|)
name|error
operator|=
literal|0
expr_stmt|;
else|else
name|error
operator|=
name|ENXIO
expr_stmt|;
break|break;
case|case
name|USB_IFACE_DRIVER_DETACH
case|:
name|error
operator|=
name|priv_check
argument_list|(
name|curthread
argument_list|,
name|PRIV_DRIVER
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
break|break;
name|n
operator|=
operator|*
name|u
operator|.
name|pint
operator|&
literal|0xFF
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|USB_IFACE_INDEX_ANY
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
comment|/* 		 * Detach the currently attached driver. 		 */
name|usb_detach_device
argument_list|(
name|f
operator|->
name|udev
argument_list|,
name|n
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* 		 * Set parent to self, this should keep attach away 		 * until the next set configuration event. 		 */
name|usbd_set_parent_iface
argument_list|(
name|f
operator|->
name|udev
argument_list|,
name|n
argument_list|,
name|n
argument_list|)
expr_stmt|;
break|break;
case|case
name|USB_SET_POWER_MODE
case|:
name|error
operator|=
name|ugen_set_power_mode
argument_list|(
name|f
argument_list|,
operator|*
name|u
operator|.
name|pint
argument_list|)
expr_stmt|;
break|break;
case|case
name|USB_GET_POWER_MODE
case|:
operator|*
name|u
operator|.
name|pint
operator|=
name|ugen_get_power_mode
argument_list|(
name|f
argument_list|)
expr_stmt|;
break|break;
case|case
name|USB_GET_DEV_PORT_PATH
case|:
name|error
operator|=
name|ugen_get_port_path
argument_list|(
name|f
argument_list|,
name|u
operator|.
name|dpp
argument_list|)
expr_stmt|;
break|break;
case|case
name|USB_GET_POWER_USAGE
case|:
operator|*
name|u
operator|.
name|pint
operator|=
name|ugen_get_power_usage
argument_list|(
name|f
argument_list|)
expr_stmt|;
break|break;
case|case
name|USB_SET_PORT_ENABLE
case|:
name|error
operator|=
name|ugen_do_port_feature
argument_list|(
name|f
argument_list|,
operator|*
name|u
operator|.
name|pint
argument_list|,
literal|1
argument_list|,
name|UHF_PORT_ENABLE
argument_list|)
expr_stmt|;
break|break;
case|case
name|USB_SET_PORT_DISABLE
case|:
name|error
operator|=
name|ugen_do_port_feature
argument_list|(
name|f
argument_list|,
operator|*
name|u
operator|.
name|pint
argument_list|,
literal|0
argument_list|,
name|UHF_PORT_ENABLE
argument_list|)
expr_stmt|;
break|break;
case|case
name|USB_FS_INIT
case|:
comment|/* verify input parameters */
if|if
condition|(
name|u
operator|.
name|pinit
operator|->
name|pEndpoints
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|u
operator|.
name|pinit
operator|->
name|ep_index_max
operator|>
literal|127
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|u
operator|.
name|pinit
operator|->
name|ep_index_max
operator|==
literal|0
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|f
operator|->
name|fs_xfer
operator|!=
name|NULL
condition|)
block|{
name|error
operator|=
name|EBUSY
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|f
operator|->
name|dev_ep_index
operator|!=
literal|0
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ugen_fifo_in_use
argument_list|(
name|f
argument_list|,
name|fflags
argument_list|)
condition|)
block|{
name|error
operator|=
name|EBUSY
expr_stmt|;
break|break;
block|}
name|error
operator|=
name|usb_fifo_alloc_buffer
argument_list|(
name|f
argument_list|,
literal|1
argument_list|,
name|u
operator|.
name|pinit
operator|->
name|ep_index_max
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
break|break;
block|}
name|f
operator|->
name|fs_xfer
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|f
operator|->
name|fs_xfer
index|[
literal|0
index|]
argument_list|)
operator|*
name|u
operator|.
name|pinit
operator|->
name|ep_index_max
argument_list|,
name|M_USB
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|->
name|fs_xfer
operator|==
name|NULL
condition|)
block|{
name|usb_fifo_free_buffer
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENOMEM
expr_stmt|;
break|break;
block|}
name|f
operator|->
name|fs_ep_max
operator|=
name|u
operator|.
name|pinit
operator|->
name|ep_index_max
expr_stmt|;
name|f
operator|->
name|fs_ep_ptr
operator|=
name|u
operator|.
name|pinit
operator|->
name|pEndpoints
expr_stmt|;
break|break;
case|case
name|USB_FS_UNINIT
case|:
if|if
condition|(
name|u
operator|.
name|puninit
operator|->
name|dummy
operator|!=
literal|0
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
name|error
operator|=
name|ugen_fs_uninit
argument_list|(
name|f
argument_list|)
expr_stmt|;
break|break;
default|default:
name|mtx_lock
argument_list|(
name|f
operator|->
name|priv_mtx
argument_list|)
expr_stmt|;
name|error
operator|=
name|ugen_iface_ioctl
argument_list|(
name|f
argument_list|,
name|cmd
argument_list|,
name|addr
argument_list|,
name|fflags
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
name|f
operator|->
name|priv_mtx
argument_list|)
expr_stmt|;
break|break;
block|}
name|DPRINTFN
argument_list|(
literal|6
argument_list|,
literal|"error=%d\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ugen_ctrl_fs_callback
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|,
name|usb_error_t
name|error
parameter_list|)
block|{
empty_stmt|;
comment|/* workaround for a bug in "indent" */
name|DPRINTF
argument_list|(
literal|"st=%u alen=%u aframes=%u\n"
argument_list|,
name|USB_GET_STATE
argument_list|(
name|xfer
argument_list|)
argument_list|,
name|xfer
operator|->
name|actlen
argument_list|,
name|xfer
operator|->
name|aframes
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|USB_GET_STATE
argument_list|(
name|xfer
argument_list|)
condition|)
block|{
case|case
name|USB_ST_SETUP
case|:
name|usbd_transfer_submit
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
break|break;
default|default:
name|ugen_fs_set_complete
argument_list|(
name|xfer
operator|->
name|priv_sc
argument_list|,
name|USB_P2U
argument_list|(
name|xfer
operator|->
name|priv_fifo
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* USB_HAVE_UGEN */
end_comment

end_unit


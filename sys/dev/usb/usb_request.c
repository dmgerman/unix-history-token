begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* $FreeBSD$ */
end_comment

begin_comment
comment|/*-  * Copyright (c) 1998 The NetBSD Foundation, Inc. All rights reserved.  * Copyright (c) 1998 Lennart Augustsson. All rights reserved.  * Copyright (c) 2008 Hans Petter Selasky. All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/stdint.h>
end_include

begin_include
include|#
directive|include
file|<sys/stddef.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/linker_set.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<sys/condvar.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/sx.h>
end_include

begin_include
include|#
directive|include
file|<sys/unistd.h>
end_include

begin_include
include|#
directive|include
file|<sys/callout.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/priv.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usbdi.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usbdi_util.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb_ioctl.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usbhid.h>
end_include

begin_define
define|#
directive|define
name|USB_DEBUG_VAR
value|usb_debug
end_define

begin_include
include|#
directive|include
file|<dev/usb/usb_core.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb_busdma.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb_request.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb_process.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb_transfer.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb_debug.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb_device.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb_util.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb_dynamic.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb_controller.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb_bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/ctype.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|USB_DEBUG
end_ifdef

begin_decl_stmt
specifier|static
name|int
name|usb_pr_poll_delay
init|=
name|USB_PORT_RESET_DELAY
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|usb_pr_recovery_delay
init|=
name|USB_PORT_RESET_RECOVERY
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_hw_usb
argument_list|,
name|OID_AUTO
argument_list|,
name|pr_poll_delay
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|usb_pr_poll_delay
argument_list|,
literal|0
argument_list|,
literal|"USB port reset poll delay in ms"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_hw_usb
argument_list|,
name|OID_AUTO
argument_list|,
name|pr_recovery_delay
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|usb_pr_recovery_delay
argument_list|,
literal|0
argument_list|,
literal|"USB port reset recovery delay in ms"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|USB_REQ_DEBUG
end_ifdef

begin_comment
comment|/* The following structures are used in connection to fault injection. */
end_comment

begin_struct
struct|struct
name|usb_ctrl_debug
block|{
name|int
name|bus_index
decl_stmt|;
comment|/* target bus */
name|int
name|dev_index
decl_stmt|;
comment|/* target address */
name|int
name|ds_fail
decl_stmt|;
comment|/* fail data stage */
name|int
name|ss_fail
decl_stmt|;
comment|/* fail data stage */
name|int
name|ds_delay
decl_stmt|;
comment|/* data stage delay in ms */
name|int
name|ss_delay
decl_stmt|;
comment|/* status stage delay in ms */
name|int
name|bmRequestType_value
decl_stmt|;
name|int
name|bRequest_value
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|usb_ctrl_debug_bits
block|{
name|uint16_t
name|ds_delay
decl_stmt|;
name|uint16_t
name|ss_delay
decl_stmt|;
name|uint8_t
name|ds_fail
range|:
literal|1
decl_stmt|;
name|uint8_t
name|ss_fail
range|:
literal|1
decl_stmt|;
name|uint8_t
name|enabled
range|:
literal|1
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* The default is to disable fault injection. */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|usb_ctrl_debug
name|usb_ctrl_debug
init|=
block|{
operator|.
name|bus_index
operator|=
operator|-
literal|1
block|,
operator|.
name|dev_index
operator|=
operator|-
literal|1
block|,
operator|.
name|bmRequestType_value
operator|=
operator|-
literal|1
block|,
operator|.
name|bRequest_value
operator|=
operator|-
literal|1
block|, }
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_hw_usb
argument_list|,
name|OID_AUTO
argument_list|,
name|ctrl_bus_fail
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|usb_ctrl_debug
operator|.
name|bus_index
argument_list|,
literal|0
argument_list|,
literal|"USB controller index to fail"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_hw_usb
argument_list|,
name|OID_AUTO
argument_list|,
name|ctrl_dev_fail
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|usb_ctrl_debug
operator|.
name|dev_index
argument_list|,
literal|0
argument_list|,
literal|"USB device address to fail"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_hw_usb
argument_list|,
name|OID_AUTO
argument_list|,
name|ctrl_ds_fail
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|usb_ctrl_debug
operator|.
name|ds_fail
argument_list|,
literal|0
argument_list|,
literal|"USB fail data stage"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_hw_usb
argument_list|,
name|OID_AUTO
argument_list|,
name|ctrl_ss_fail
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|usb_ctrl_debug
operator|.
name|ss_fail
argument_list|,
literal|0
argument_list|,
literal|"USB fail status stage"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_hw_usb
argument_list|,
name|OID_AUTO
argument_list|,
name|ctrl_ds_delay
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|usb_ctrl_debug
operator|.
name|ds_delay
argument_list|,
literal|0
argument_list|,
literal|"USB data stage delay in ms"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_hw_usb
argument_list|,
name|OID_AUTO
argument_list|,
name|ctrl_ss_delay
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|usb_ctrl_debug
operator|.
name|ss_delay
argument_list|,
literal|0
argument_list|,
literal|"USB status stage delay in ms"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_hw_usb
argument_list|,
name|OID_AUTO
argument_list|,
name|ctrl_rt_fail
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|usb_ctrl_debug
operator|.
name|bmRequestType_value
argument_list|,
literal|0
argument_list|,
literal|"USB bmRequestType to fail"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_hw_usb
argument_list|,
name|OID_AUTO
argument_list|,
name|ctrl_rv_fail
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|usb_ctrl_debug
operator|.
name|bRequest_value
argument_list|,
literal|0
argument_list|,
literal|"USB bRequest to fail"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*------------------------------------------------------------------------*  *	usbd_get_debug_bits  *  * This function is only useful in USB host mode.  *------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|usbd_get_debug_bits
parameter_list|(
name|struct
name|usb_device
modifier|*
name|udev
parameter_list|,
name|struct
name|usb_device_request
modifier|*
name|req
parameter_list|,
name|struct
name|usb_ctrl_debug_bits
modifier|*
name|dbg
parameter_list|)
block|{
name|int
name|temp
decl_stmt|;
name|memset
argument_list|(
name|dbg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|dbg
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Compute data stage delay */
name|temp
operator|=
name|usb_ctrl_debug
operator|.
name|ds_delay
expr_stmt|;
if|if
condition|(
name|temp
operator|<
literal|0
condition|)
name|temp
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|temp
operator|>
operator|(
literal|16
operator|*
literal|1024
operator|)
condition|)
name|temp
operator|=
operator|(
literal|16
operator|*
literal|1024
operator|)
expr_stmt|;
name|dbg
operator|->
name|ds_delay
operator|=
name|temp
expr_stmt|;
comment|/* Compute status stage delay */
name|temp
operator|=
name|usb_ctrl_debug
operator|.
name|ss_delay
expr_stmt|;
if|if
condition|(
name|temp
operator|<
literal|0
condition|)
name|temp
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|temp
operator|>
operator|(
literal|16
operator|*
literal|1024
operator|)
condition|)
name|temp
operator|=
operator|(
literal|16
operator|*
literal|1024
operator|)
expr_stmt|;
name|dbg
operator|->
name|ss_delay
operator|=
name|temp
expr_stmt|;
comment|/* Check if this control request should be failed */
if|if
condition|(
name|usbd_get_bus_index
argument_list|(
name|udev
argument_list|)
operator|!=
name|usb_ctrl_debug
operator|.
name|bus_index
condition|)
return|return;
if|if
condition|(
name|usbd_get_device_index
argument_list|(
name|udev
argument_list|)
operator|!=
name|usb_ctrl_debug
operator|.
name|dev_index
condition|)
return|return;
name|temp
operator|=
name|usb_ctrl_debug
operator|.
name|bmRequestType_value
expr_stmt|;
if|if
condition|(
operator|(
name|temp
operator|!=
name|req
operator|->
name|bmRequestType
operator|)
operator|&&
operator|(
name|temp
operator|>=
literal|0
operator|)
operator|&&
operator|(
name|temp
operator|<=
literal|255
operator|)
condition|)
return|return;
name|temp
operator|=
name|usb_ctrl_debug
operator|.
name|bRequest_value
expr_stmt|;
if|if
condition|(
operator|(
name|temp
operator|!=
name|req
operator|->
name|bRequest
operator|)
operator|&&
operator|(
name|temp
operator|>=
literal|0
operator|)
operator|&&
operator|(
name|temp
operator|<=
literal|255
operator|)
condition|)
return|return;
name|temp
operator|=
name|usb_ctrl_debug
operator|.
name|ds_fail
expr_stmt|;
if|if
condition|(
name|temp
condition|)
name|dbg
operator|->
name|ds_fail
operator|=
literal|1
expr_stmt|;
name|temp
operator|=
name|usb_ctrl_debug
operator|.
name|ss_fail
expr_stmt|;
if|if
condition|(
name|temp
condition|)
name|dbg
operator|->
name|ss_fail
operator|=
literal|1
expr_stmt|;
name|dbg
operator|->
name|enabled
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* USB_REQ_DEBUG */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* USB_DEBUG */
end_comment

begin_comment
comment|/*------------------------------------------------------------------------*  *	usbd_do_request_callback  *  * This function is the USB callback for generic USB Host control  * transfers.  *------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|usbd_do_request_callback
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|,
name|usb_error_t
name|error
parameter_list|)
block|{
empty_stmt|;
comment|/* workaround for a bug in "indent" */
name|DPRINTF
argument_list|(
literal|"st=%u\n"
argument_list|,
name|USB_GET_STATE
argument_list|(
name|xfer
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|USB_GET_STATE
argument_list|(
name|xfer
argument_list|)
condition|)
block|{
case|case
name|USB_ST_SETUP
case|:
name|usbd_transfer_submit
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
break|break;
default|default:
name|cv_signal
argument_list|(
operator|&
name|xfer
operator|->
name|xroot
operator|->
name|udev
operator|->
name|ctrlreq_cv
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/*------------------------------------------------------------------------*  *	usb_do_clear_stall_callback  *  * This function is the USB callback for generic clear stall requests.  *------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|usb_do_clear_stall_callback
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|,
name|usb_error_t
name|error
parameter_list|)
block|{
name|struct
name|usb_device_request
name|req
decl_stmt|;
name|struct
name|usb_device
modifier|*
name|udev
decl_stmt|;
name|struct
name|usb_endpoint
modifier|*
name|ep
decl_stmt|;
name|struct
name|usb_endpoint
modifier|*
name|ep_end
decl_stmt|;
name|struct
name|usb_endpoint
modifier|*
name|ep_first
decl_stmt|;
name|uint8_t
name|to
decl_stmt|;
name|udev
operator|=
name|xfer
operator|->
name|xroot
operator|->
name|udev
expr_stmt|;
name|USB_BUS_LOCK
argument_list|(
name|udev
operator|->
name|bus
argument_list|)
expr_stmt|;
comment|/* round robin endpoint clear stall */
name|ep
operator|=
name|udev
operator|->
name|ep_curr
expr_stmt|;
name|ep_end
operator|=
name|udev
operator|->
name|endpoints
operator|+
name|udev
operator|->
name|endpoints_max
expr_stmt|;
name|ep_first
operator|=
name|udev
operator|->
name|endpoints
expr_stmt|;
name|to
operator|=
name|udev
operator|->
name|endpoints_max
expr_stmt|;
switch|switch
condition|(
name|USB_GET_STATE
argument_list|(
name|xfer
argument_list|)
condition|)
block|{
case|case
name|USB_ST_TRANSFERRED
case|:
if|if
condition|(
name|ep
operator|==
name|NULL
condition|)
goto|goto
name|tr_setup
goto|;
comment|/* device was unconfigured */
if|if
condition|(
name|ep
operator|->
name|edesc
operator|&&
name|ep
operator|->
name|is_stalled
condition|)
block|{
name|ep
operator|->
name|toggle_next
operator|=
literal|0
expr_stmt|;
name|ep
operator|->
name|is_stalled
operator|=
literal|0
expr_stmt|;
comment|/* some hardware needs a callback to clear the data toggle */
name|usbd_clear_stall_locked
argument_list|(
name|udev
argument_list|,
name|ep
argument_list|)
expr_stmt|;
comment|/* start up the current or next transfer, if any */
name|usb_command_wrapper
argument_list|(
operator|&
name|ep
operator|->
name|endpoint_q
argument_list|,
name|ep
operator|->
name|endpoint_q
operator|.
name|curr
argument_list|)
expr_stmt|;
block|}
name|ep
operator|++
expr_stmt|;
case|case
name|USB_ST_SETUP
case|:
name|tr_setup
label|:
if|if
condition|(
name|to
operator|==
literal|0
condition|)
break|break;
comment|/* no endpoints - nothing to do */
if|if
condition|(
operator|(
name|ep
operator|<
name|ep_first
operator|)
operator|||
operator|(
name|ep
operator|>=
name|ep_end
operator|)
condition|)
name|ep
operator|=
name|ep_first
expr_stmt|;
comment|/* endpoint wrapped around */
if|if
condition|(
name|ep
operator|->
name|edesc
operator|&&
name|ep
operator|->
name|is_stalled
condition|)
block|{
comment|/* setup a clear-stall packet */
name|req
operator|.
name|bmRequestType
operator|=
name|UT_WRITE_ENDPOINT
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|UR_CLEAR_FEATURE
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
name|UF_ENDPOINT_HALT
argument_list|)
expr_stmt|;
name|req
operator|.
name|wIndex
index|[
literal|0
index|]
operator|=
name|ep
operator|->
name|edesc
operator|->
name|bEndpointAddress
expr_stmt|;
name|req
operator|.
name|wIndex
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* copy in the transfer */
name|usbd_copy_in
argument_list|(
name|xfer
operator|->
name|frbuffers
argument_list|,
literal|0
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
comment|/* set length */
name|usbd_xfer_set_frame_len
argument_list|(
name|xfer
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|xfer
operator|->
name|nframes
operator|=
literal|1
expr_stmt|;
name|USB_BUS_UNLOCK
argument_list|(
name|udev
operator|->
name|bus
argument_list|)
expr_stmt|;
name|usbd_transfer_submit
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
name|USB_BUS_LOCK
argument_list|(
name|udev
operator|->
name|bus
argument_list|)
expr_stmt|;
break|break;
block|}
name|ep
operator|++
expr_stmt|;
name|to
operator|--
expr_stmt|;
goto|goto
name|tr_setup
goto|;
default|default:
if|if
condition|(
name|xfer
operator|->
name|error
operator|==
name|USB_ERR_CANCELLED
condition|)
block|{
break|break;
block|}
goto|goto
name|tr_setup
goto|;
block|}
comment|/* store current endpoint */
name|udev
operator|->
name|ep_curr
operator|=
name|ep
expr_stmt|;
name|USB_BUS_UNLOCK
argument_list|(
name|udev
operator|->
name|bus
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|usb_handle_req_t
modifier|*
name|usbd_get_hr_func
parameter_list|(
name|struct
name|usb_device
modifier|*
name|udev
parameter_list|)
block|{
comment|/* figure out if there is a Handle Request function */
if|if
condition|(
name|udev
operator|->
name|flags
operator|.
name|usb_mode
operator|==
name|USB_MODE_DEVICE
condition|)
return|return
operator|(
name|usb_temp_get_desc_p
operator|)
return|;
elseif|else
if|if
condition|(
name|udev
operator|->
name|parent_hub
operator|==
name|NULL
condition|)
return|return
operator|(
name|udev
operator|->
name|bus
operator|->
name|methods
operator|->
name|roothub_exec
operator|)
return|;
else|else
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_comment
comment|/*------------------------------------------------------------------------*  *	usbd_do_request_flags and usbd_do_request  *  * Description of arguments passed to these functions:  *  * "udev" - this is the "usb_device" structure pointer on which the  * request should be performed. It is possible to call this function  * in both Host Side mode and Device Side mode.  *  * "mtx" - if this argument is non-NULL the mutex pointed to by it  * will get dropped and picked up during the execution of this  * function, hence this function sometimes needs to sleep. If this  * argument is NULL it has no effect.  *  * "req" - this argument must always be non-NULL and points to an  * 8-byte structure holding the USB request to be done. The USB  * request structure has a bit telling the direction of the USB  * request, if it is a read or a write.  *  * "data" - if the "wLength" part of the structure pointed to by "req"  * is non-zero this argument must point to a valid kernel buffer which  * can hold at least "wLength" bytes. If "wLength" is zero "data" can  * be NULL.  *  * "flags" - here is a list of valid flags:  *  *  o USB_SHORT_XFER_OK: allows the data transfer to be shorter than  *  specified  *  *  o USB_DELAY_STATUS_STAGE: allows the status stage to be performed  *  at a later point in time. This is tunable by the "hw.usb.ss_delay"  *  sysctl. This flag is mostly useful for debugging.  *  *  o USB_USER_DATA_PTR: treat the "data" pointer like a userland  *  pointer.  *  * "actlen" - if non-NULL the actual transfer length will be stored in  * the 16-bit unsigned integer pointed to by "actlen". This  * information is mostly useful when the "USB_SHORT_XFER_OK" flag is  * used.  *  * "timeout" - gives the timeout for the control transfer in  * milliseconds. A "timeout" value less than 50 milliseconds is  * treated like a 50 millisecond timeout. A "timeout" value greater  * than 30 seconds is treated like a 30 second timeout. This USB stack  * does not allow control requests without a timeout.  *  * NOTE: This function is thread safe. All calls to  * "usbd_do_request_flags" will be serialised by the use of an  * internal "sx_lock".  *  * Returns:  *    0: Success  * Else: Failure  *------------------------------------------------------------------------*/
end_comment

begin_function
name|usb_error_t
name|usbd_do_request_flags
parameter_list|(
name|struct
name|usb_device
modifier|*
name|udev
parameter_list|,
name|struct
name|mtx
modifier|*
name|mtx
parameter_list|,
name|struct
name|usb_device_request
modifier|*
name|req
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|uint16_t
name|flags
parameter_list|,
name|uint16_t
modifier|*
name|actlen
parameter_list|,
name|usb_timeout_t
name|timeout
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|USB_REQ_DEBUG
name|struct
name|usb_ctrl_debug_bits
name|dbg
decl_stmt|;
endif|#
directive|endif
name|usb_handle_req_t
modifier|*
name|hr_func
decl_stmt|;
name|struct
name|usb_xfer
modifier|*
name|xfer
decl_stmt|;
specifier|const
name|void
modifier|*
name|desc
decl_stmt|;
name|int
name|err
init|=
literal|0
decl_stmt|;
name|usb_ticks_t
name|start_ticks
decl_stmt|;
name|usb_ticks_t
name|delta_ticks
decl_stmt|;
name|usb_ticks_t
name|max_ticks
decl_stmt|;
name|uint16_t
name|length
decl_stmt|;
name|uint16_t
name|temp
decl_stmt|;
name|uint16_t
name|acttemp
decl_stmt|;
name|uint8_t
name|enum_locked
decl_stmt|;
if|if
condition|(
name|timeout
operator|<
literal|50
condition|)
block|{
comment|/* timeout is too small */
name|timeout
operator|=
literal|50
expr_stmt|;
block|}
if|if
condition|(
name|timeout
operator|>
literal|30000
condition|)
block|{
comment|/* timeout is too big */
name|timeout
operator|=
literal|30000
expr_stmt|;
block|}
name|length
operator|=
name|UGETW
argument_list|(
name|req
operator|->
name|wLength
argument_list|)
expr_stmt|;
name|enum_locked
operator|=
name|usbd_enum_is_locked
argument_list|(
name|udev
argument_list|)
expr_stmt|;
name|DPRINTFN
argument_list|(
literal|5
argument_list|,
literal|"udev=%p bmRequestType=0x%02x bRequest=0x%02x "
literal|"wValue=0x%02x%02x wIndex=0x%02x%02x wLength=0x%02x%02x\n"
argument_list|,
name|udev
argument_list|,
name|req
operator|->
name|bmRequestType
argument_list|,
name|req
operator|->
name|bRequest
argument_list|,
name|req
operator|->
name|wValue
index|[
literal|1
index|]
argument_list|,
name|req
operator|->
name|wValue
index|[
literal|0
index|]
argument_list|,
name|req
operator|->
name|wIndex
index|[
literal|1
index|]
argument_list|,
name|req
operator|->
name|wIndex
index|[
literal|0
index|]
argument_list|,
name|req
operator|->
name|wLength
index|[
literal|1
index|]
argument_list|,
name|req
operator|->
name|wLength
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
comment|/* Check if the device is still alive */
if|if
condition|(
name|udev
operator|->
name|state
operator|<
name|USB_STATE_POWERED
condition|)
block|{
name|DPRINTF
argument_list|(
literal|"usb device has gone\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|USB_ERR_NOT_CONFIGURED
operator|)
return|;
block|}
comment|/* 	 * Set "actlen" to a known value in case the caller does not 	 * check the return value: 	 */
if|if
condition|(
name|actlen
condition|)
operator|*
name|actlen
operator|=
literal|0
expr_stmt|;
if|#
directive|if
operator|(
name|USB_HAVE_USER_IO
operator|==
literal|0
operator|)
if|if
condition|(
name|flags
operator|&
name|USB_USER_DATA_PTR
condition|)
return|return
operator|(
name|USB_ERR_INVAL
operator|)
return|;
endif|#
directive|endif
if|if
condition|(
operator|(
name|mtx
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|mtx
operator|!=
operator|&
name|Giant
operator|)
condition|)
block|{
name|mtx_unlock
argument_list|(
name|mtx
argument_list|)
expr_stmt|;
name|mtx_assert
argument_list|(
name|mtx
argument_list|,
name|MA_NOTOWNED
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * We need to allow suspend and resume at this point, else the 	 * control transfer will timeout if the device is suspended! 	 */
if|if
condition|(
name|enum_locked
condition|)
name|usbd_sr_unlock
argument_list|(
name|udev
argument_list|)
expr_stmt|;
comment|/* 	 * Grab the default sx-lock so that serialisation 	 * is achieved when multiple threads are involved: 	 */
name|sx_xlock
argument_list|(
operator|&
name|udev
operator|->
name|ctrl_sx
argument_list|)
expr_stmt|;
name|hr_func
operator|=
name|usbd_get_hr_func
argument_list|(
name|udev
argument_list|)
expr_stmt|;
if|if
condition|(
name|hr_func
operator|!=
name|NULL
condition|)
block|{
name|DPRINTF
argument_list|(
literal|"Handle Request function is set\n"
argument_list|)
expr_stmt|;
name|desc
operator|=
name|NULL
expr_stmt|;
name|temp
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|req
operator|->
name|bmRequestType
operator|&
name|UT_READ
operator|)
condition|)
block|{
if|if
condition|(
name|length
operator|!=
literal|0
condition|)
block|{
name|DPRINTFN
argument_list|(
literal|1
argument_list|,
literal|"The handle request function "
literal|"does not support writing data!\n"
argument_list|)
expr_stmt|;
name|err
operator|=
name|USB_ERR_INVAL
expr_stmt|;
goto|goto
name|done
goto|;
block|}
block|}
comment|/* The root HUB code needs the BUS lock locked */
name|USB_BUS_LOCK
argument_list|(
name|udev
operator|->
name|bus
argument_list|)
expr_stmt|;
name|err
operator|=
call|(
name|hr_func
call|)
argument_list|(
name|udev
argument_list|,
name|req
argument_list|,
operator|&
name|desc
argument_list|,
operator|&
name|temp
argument_list|)
expr_stmt|;
name|USB_BUS_UNLOCK
argument_list|(
name|udev
operator|->
name|bus
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|done
goto|;
if|if
condition|(
name|length
operator|>
name|temp
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|flags
operator|&
name|USB_SHORT_XFER_OK
operator|)
condition|)
block|{
name|err
operator|=
name|USB_ERR_SHORT_XFER
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|length
operator|=
name|temp
expr_stmt|;
block|}
if|if
condition|(
name|actlen
condition|)
operator|*
name|actlen
operator|=
name|length
expr_stmt|;
if|if
condition|(
name|length
operator|>
literal|0
condition|)
block|{
if|#
directive|if
name|USB_HAVE_USER_IO
if|if
condition|(
name|flags
operator|&
name|USB_USER_DATA_PTR
condition|)
block|{
if|if
condition|(
name|copyout
argument_list|(
name|desc
argument_list|,
name|data
argument_list|,
name|length
argument_list|)
condition|)
block|{
name|err
operator|=
name|USB_ERR_INVAL
expr_stmt|;
goto|goto
name|done
goto|;
block|}
block|}
else|else
endif|#
directive|endif
name|bcopy
argument_list|(
name|desc
argument_list|,
name|data
argument_list|,
name|length
argument_list|)
expr_stmt|;
block|}
goto|goto
name|done
goto|;
comment|/* success */
block|}
comment|/* 	 * Setup a new USB transfer or use the existing one, if any: 	 */
name|usbd_ctrl_transfer_setup
argument_list|(
name|udev
argument_list|)
expr_stmt|;
name|xfer
operator|=
name|udev
operator|->
name|ctrl_xfer
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|xfer
operator|==
name|NULL
condition|)
block|{
comment|/* most likely out of memory */
name|err
operator|=
name|USB_ERR_NOMEM
expr_stmt|;
goto|goto
name|done
goto|;
block|}
ifdef|#
directive|ifdef
name|USB_REQ_DEBUG
comment|/* Get debug bits */
name|usbd_get_debug_bits
argument_list|(
name|udev
argument_list|,
name|req
argument_list|,
operator|&
name|dbg
argument_list|)
expr_stmt|;
comment|/* Check for fault injection */
if|if
condition|(
name|dbg
operator|.
name|enabled
condition|)
name|flags
operator||=
name|USB_DELAY_STATUS_STAGE
expr_stmt|;
endif|#
directive|endif
name|USB_XFER_LOCK
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|USB_DELAY_STATUS_STAGE
condition|)
name|xfer
operator|->
name|flags
operator|.
name|manual_status
operator|=
literal|1
expr_stmt|;
else|else
name|xfer
operator|->
name|flags
operator|.
name|manual_status
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|USB_SHORT_XFER_OK
condition|)
name|xfer
operator|->
name|flags
operator|.
name|short_xfer_ok
operator|=
literal|1
expr_stmt|;
else|else
name|xfer
operator|->
name|flags
operator|.
name|short_xfer_ok
operator|=
literal|0
expr_stmt|;
name|xfer
operator|->
name|timeout
operator|=
name|timeout
expr_stmt|;
name|start_ticks
operator|=
name|ticks
expr_stmt|;
name|max_ticks
operator|=
name|USB_MS_TO_TICKS
argument_list|(
name|timeout
argument_list|)
expr_stmt|;
name|usbd_copy_in
argument_list|(
name|xfer
operator|->
name|frbuffers
argument_list|,
literal|0
argument_list|,
name|req
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|usbd_xfer_set_frame_len
argument_list|(
name|xfer
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|req
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|temp
operator|=
name|length
expr_stmt|;
if|if
condition|(
name|temp
operator|>
name|usbd_xfer_max_len
argument_list|(
name|xfer
argument_list|)
condition|)
block|{
name|temp
operator|=
name|usbd_xfer_max_len
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|USB_REQ_DEBUG
if|if
condition|(
name|xfer
operator|->
name|flags
operator|.
name|manual_status
condition|)
block|{
if|if
condition|(
name|usbd_xfer_frame_len
argument_list|(
name|xfer
argument_list|,
literal|0
argument_list|)
operator|!=
literal|0
condition|)
block|{
comment|/* Execute data stage separately */
name|temp
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|temp
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|dbg
operator|.
name|ds_fail
condition|)
block|{
name|err
operator|=
name|USB_ERR_INVAL
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|dbg
operator|.
name|ds_delay
operator|>
literal|0
condition|)
block|{
name|usb_pause_mtx
argument_list|(
name|xfer
operator|->
name|xroot
operator|->
name|xfer_mtx
argument_list|,
name|USB_MS_TO_TICKS
argument_list|(
name|dbg
operator|.
name|ds_delay
argument_list|)
argument_list|)
expr_stmt|;
comment|/* make sure we don't time out */
name|start_ticks
operator|=
name|ticks
expr_stmt|;
block|}
block|}
block|}
endif|#
directive|endif
name|usbd_xfer_set_frame_len
argument_list|(
name|xfer
argument_list|,
literal|1
argument_list|,
name|temp
argument_list|)
expr_stmt|;
if|if
condition|(
name|temp
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|req
operator|->
name|bmRequestType
operator|&
name|UT_READ
operator|)
condition|)
block|{
if|#
directive|if
name|USB_HAVE_USER_IO
if|if
condition|(
name|flags
operator|&
name|USB_USER_DATA_PTR
condition|)
block|{
name|USB_XFER_UNLOCK
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
name|err
operator|=
name|usbd_copy_in_user
argument_list|(
name|xfer
operator|->
name|frbuffers
operator|+
literal|1
argument_list|,
literal|0
argument_list|,
name|data
argument_list|,
name|temp
argument_list|)
expr_stmt|;
name|USB_XFER_LOCK
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|err
operator|=
name|USB_ERR_INVAL
expr_stmt|;
break|break;
block|}
block|}
else|else
endif|#
directive|endif
name|usbd_copy_in
argument_list|(
name|xfer
operator|->
name|frbuffers
operator|+
literal|1
argument_list|,
literal|0
argument_list|,
name|data
argument_list|,
name|temp
argument_list|)
expr_stmt|;
block|}
name|usbd_xfer_set_frames
argument_list|(
name|xfer
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|usbd_xfer_frame_len
argument_list|(
name|xfer
argument_list|,
literal|0
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|xfer
operator|->
name|flags
operator|.
name|manual_status
condition|)
block|{
ifdef|#
directive|ifdef
name|USB_REQ_DEBUG
if|if
condition|(
name|dbg
operator|.
name|ss_fail
condition|)
block|{
name|err
operator|=
name|USB_ERR_INVAL
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|dbg
operator|.
name|ss_delay
operator|>
literal|0
condition|)
block|{
name|usb_pause_mtx
argument_list|(
name|xfer
operator|->
name|xroot
operator|->
name|xfer_mtx
argument_list|,
name|USB_MS_TO_TICKS
argument_list|(
name|dbg
operator|.
name|ss_delay
argument_list|)
argument_list|)
expr_stmt|;
comment|/* make sure we don't time out */
name|start_ticks
operator|=
name|ticks
expr_stmt|;
block|}
endif|#
directive|endif
name|xfer
operator|->
name|flags
operator|.
name|manual_status
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
break|break;
block|}
block|}
name|usbd_xfer_set_frames
argument_list|(
name|xfer
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|usbd_transfer_start
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
while|while
condition|(
name|usbd_transfer_pending
argument_list|(
name|xfer
argument_list|)
condition|)
block|{
name|cv_wait
argument_list|(
operator|&
name|udev
operator|->
name|ctrlreq_cv
argument_list|,
name|xfer
operator|->
name|xroot
operator|->
name|xfer_mtx
argument_list|)
expr_stmt|;
block|}
name|err
operator|=
name|xfer
operator|->
name|error
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
break|break;
block|}
comment|/* get actual length of DATA stage */
if|if
condition|(
name|xfer
operator|->
name|aframes
operator|<
literal|2
condition|)
block|{
name|acttemp
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|acttemp
operator|=
name|usbd_xfer_frame_len
argument_list|(
name|xfer
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* check for short packet */
if|if
condition|(
name|temp
operator|>
name|acttemp
condition|)
block|{
name|temp
operator|=
name|acttemp
expr_stmt|;
name|length
operator|=
name|temp
expr_stmt|;
block|}
if|if
condition|(
name|temp
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|req
operator|->
name|bmRequestType
operator|&
name|UT_READ
condition|)
block|{
if|#
directive|if
name|USB_HAVE_USER_IO
if|if
condition|(
name|flags
operator|&
name|USB_USER_DATA_PTR
condition|)
block|{
name|USB_XFER_UNLOCK
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
name|err
operator|=
name|usbd_copy_out_user
argument_list|(
name|xfer
operator|->
name|frbuffers
operator|+
literal|1
argument_list|,
literal|0
argument_list|,
name|data
argument_list|,
name|temp
argument_list|)
expr_stmt|;
name|USB_XFER_LOCK
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|err
operator|=
name|USB_ERR_INVAL
expr_stmt|;
break|break;
block|}
block|}
else|else
endif|#
directive|endif
name|usbd_copy_out
argument_list|(
name|xfer
operator|->
name|frbuffers
operator|+
literal|1
argument_list|,
literal|0
argument_list|,
name|data
argument_list|,
name|temp
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* 		 * Clear "frlengths[0]" so that we don't send the setup 		 * packet again: 		 */
name|usbd_xfer_set_frame_len
argument_list|(
name|xfer
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* update length and data pointer */
name|length
operator|-=
name|temp
expr_stmt|;
name|data
operator|=
name|USB_ADD_BYTES
argument_list|(
name|data
argument_list|,
name|temp
argument_list|)
expr_stmt|;
if|if
condition|(
name|actlen
condition|)
block|{
operator|(
operator|*
name|actlen
operator|)
operator|+=
name|temp
expr_stmt|;
block|}
comment|/* check for timeout */
name|delta_ticks
operator|=
name|ticks
operator|-
name|start_ticks
expr_stmt|;
if|if
condition|(
name|delta_ticks
operator|>
name|max_ticks
condition|)
block|{
if|if
condition|(
operator|!
name|err
condition|)
block|{
name|err
operator|=
name|USB_ERR_TIMEOUT
expr_stmt|;
block|}
block|}
if|if
condition|(
name|err
condition|)
block|{
break|break;
block|}
block|}
if|if
condition|(
name|err
condition|)
block|{
comment|/* 		 * Make sure that the control endpoint is no longer 		 * blocked in case of a non-transfer related error: 		 */
name|usbd_transfer_stop
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
block|}
name|USB_XFER_UNLOCK
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
name|done
label|:
name|sx_xunlock
argument_list|(
operator|&
name|udev
operator|->
name|ctrl_sx
argument_list|)
expr_stmt|;
if|if
condition|(
name|enum_locked
condition|)
name|usbd_sr_lock
argument_list|(
name|udev
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|mtx
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|mtx
operator|!=
operator|&
name|Giant
operator|)
condition|)
name|mtx_lock
argument_list|(
name|mtx
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
name|usb_error_t
operator|)
name|err
operator|)
return|;
block|}
end_function

begin_comment
comment|/*------------------------------------------------------------------------*  *	usbd_do_request_proc - factored out code  *  * This function is factored out code. It does basically the same like  * usbd_do_request_flags, except it will check the status of the  * passed process argument before doing the USB request. If the  * process is draining the USB_ERR_IOERROR code will be returned. It  * is assumed that the mutex associated with the process is locked  * when calling this function.  *------------------------------------------------------------------------*/
end_comment

begin_function
name|usb_error_t
name|usbd_do_request_proc
parameter_list|(
name|struct
name|usb_device
modifier|*
name|udev
parameter_list|,
name|struct
name|usb_process
modifier|*
name|pproc
parameter_list|,
name|struct
name|usb_device_request
modifier|*
name|req
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|uint16_t
name|flags
parameter_list|,
name|uint16_t
modifier|*
name|actlen
parameter_list|,
name|usb_timeout_t
name|timeout
parameter_list|)
block|{
name|usb_error_t
name|err
decl_stmt|;
name|uint16_t
name|len
decl_stmt|;
comment|/* get request data length */
name|len
operator|=
name|UGETW
argument_list|(
name|req
operator|->
name|wLength
argument_list|)
expr_stmt|;
comment|/* check if the device is being detached */
if|if
condition|(
name|usb_proc_is_gone
argument_list|(
name|pproc
argument_list|)
condition|)
block|{
name|err
operator|=
name|USB_ERR_IOERROR
expr_stmt|;
goto|goto
name|done
goto|;
block|}
comment|/* forward the USB request */
name|err
operator|=
name|usbd_do_request_flags
argument_list|(
name|udev
argument_list|,
name|pproc
operator|->
name|up_mtx
argument_list|,
name|req
argument_list|,
name|data
argument_list|,
name|flags
argument_list|,
name|actlen
argument_list|,
name|timeout
argument_list|)
expr_stmt|;
name|done
label|:
comment|/* on failure we zero the data */
comment|/* on short packet we zero the unused data */
if|if
condition|(
operator|(
name|len
operator|!=
literal|0
operator|)
operator|&&
operator|(
name|req
operator|->
name|bmRequestType
operator|&
name|UE_DIR_IN
operator|)
condition|)
block|{
if|if
condition|(
name|err
condition|)
name|memset
argument_list|(
name|data
argument_list|,
literal|0
argument_list|,
name|len
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|actlen
operator|&&
operator|*
name|actlen
operator|!=
name|len
condition|)
name|memset
argument_list|(
operator|(
operator|(
name|uint8_t
operator|*
operator|)
name|data
operator|)
operator|+
operator|*
name|actlen
argument_list|,
literal|0
argument_list|,
name|len
operator|-
operator|*
name|actlen
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_comment
comment|/*------------------------------------------------------------------------*  *	usbd_req_reset_port  *  * This function will instruct a USB HUB to perform a reset sequence  * on the specified port number.  *  * Returns:  *    0: Success. The USB device should now be at address zero.  * Else: Failure. No USB device is present and the USB port should be  *       disabled.  *------------------------------------------------------------------------*/
end_comment

begin_function
name|usb_error_t
name|usbd_req_reset_port
parameter_list|(
name|struct
name|usb_device
modifier|*
name|udev
parameter_list|,
name|struct
name|mtx
modifier|*
name|mtx
parameter_list|,
name|uint8_t
name|port
parameter_list|)
block|{
name|struct
name|usb_port_status
name|ps
decl_stmt|;
name|usb_error_t
name|err
decl_stmt|;
name|uint16_t
name|n
decl_stmt|;
ifdef|#
directive|ifdef
name|USB_DEBUG
name|uint16_t
name|pr_poll_delay
decl_stmt|;
name|uint16_t
name|pr_recovery_delay
decl_stmt|;
endif|#
directive|endif
name|err
operator|=
name|usbd_req_set_port_feature
argument_list|(
name|udev
argument_list|,
name|mtx
argument_list|,
name|port
argument_list|,
name|UHF_PORT_RESET
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
goto|goto
name|done
goto|;
block|}
ifdef|#
directive|ifdef
name|USB_DEBUG
comment|/* range check input parameters */
name|pr_poll_delay
operator|=
name|usb_pr_poll_delay
expr_stmt|;
if|if
condition|(
name|pr_poll_delay
operator|<
literal|1
condition|)
block|{
name|pr_poll_delay
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pr_poll_delay
operator|>
literal|1000
condition|)
block|{
name|pr_poll_delay
operator|=
literal|1000
expr_stmt|;
block|}
name|pr_recovery_delay
operator|=
name|usb_pr_recovery_delay
expr_stmt|;
if|if
condition|(
name|pr_recovery_delay
operator|>
literal|1000
condition|)
block|{
name|pr_recovery_delay
operator|=
literal|1000
expr_stmt|;
block|}
endif|#
directive|endif
name|n
operator|=
literal|0
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
ifdef|#
directive|ifdef
name|USB_DEBUG
comment|/* wait for the device to recover from reset */
name|usb_pause_mtx
argument_list|(
name|mtx
argument_list|,
name|USB_MS_TO_TICKS
argument_list|(
name|pr_poll_delay
argument_list|)
argument_list|)
expr_stmt|;
name|n
operator|+=
name|pr_poll_delay
expr_stmt|;
else|#
directive|else
comment|/* wait for the device to recover from reset */
name|usb_pause_mtx
argument_list|(
name|mtx
argument_list|,
name|USB_MS_TO_TICKS
argument_list|(
name|USB_PORT_RESET_DELAY
argument_list|)
argument_list|)
expr_stmt|;
name|n
operator|+=
name|USB_PORT_RESET_DELAY
expr_stmt|;
endif|#
directive|endif
name|err
operator|=
name|usbd_req_get_port_status
argument_list|(
name|udev
argument_list|,
name|mtx
argument_list|,
operator|&
name|ps
argument_list|,
name|port
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
goto|goto
name|done
goto|;
block|}
comment|/* check if reset is complete */
if|if
condition|(
name|UGETW
argument_list|(
name|ps
operator|.
name|wPortChange
argument_list|)
operator|&
name|UPS_C_PORT_RESET
condition|)
block|{
break|break;
block|}
comment|/* check for timeout */
if|if
condition|(
name|n
operator|>
literal|1000
condition|)
block|{
name|n
operator|=
literal|0
expr_stmt|;
break|break;
block|}
block|}
comment|/* clear port reset first */
name|err
operator|=
name|usbd_req_clear_port_feature
argument_list|(
name|udev
argument_list|,
name|mtx
argument_list|,
name|port
argument_list|,
name|UHF_C_PORT_RESET
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
goto|goto
name|done
goto|;
block|}
comment|/* check for timeout */
if|if
condition|(
name|n
operator|==
literal|0
condition|)
block|{
name|err
operator|=
name|USB_ERR_TIMEOUT
expr_stmt|;
goto|goto
name|done
goto|;
block|}
ifdef|#
directive|ifdef
name|USB_DEBUG
comment|/* wait for the device to recover from reset */
name|usb_pause_mtx
argument_list|(
name|mtx
argument_list|,
name|USB_MS_TO_TICKS
argument_list|(
name|pr_recovery_delay
argument_list|)
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* wait for the device to recover from reset */
name|usb_pause_mtx
argument_list|(
name|mtx
argument_list|,
name|USB_MS_TO_TICKS
argument_list|(
name|USB_PORT_RESET_RECOVERY
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|done
label|:
name|DPRINTFN
argument_list|(
literal|2
argument_list|,
literal|"port %d reset returning error=%s\n"
argument_list|,
name|port
argument_list|,
name|usbd_errstr
argument_list|(
name|err
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_comment
comment|/*------------------------------------------------------------------------*  *	usbd_req_warm_reset_port  *  * This function will instruct an USB HUB to perform a warm reset  * sequence on the specified port number. This kind of reset is not  * mandatory for LOW-, FULL- and HIGH-speed USB HUBs and is targeted  * for SUPER-speed USB HUBs.  *  * Returns:  *    0: Success. The USB device should now be available again.  * Else: Failure. No USB device is present and the USB port should be  *       disabled.  *------------------------------------------------------------------------*/
end_comment

begin_function
name|usb_error_t
name|usbd_req_warm_reset_port
parameter_list|(
name|struct
name|usb_device
modifier|*
name|udev
parameter_list|,
name|struct
name|mtx
modifier|*
name|mtx
parameter_list|,
name|uint8_t
name|port
parameter_list|)
block|{
name|struct
name|usb_port_status
name|ps
decl_stmt|;
name|usb_error_t
name|err
decl_stmt|;
name|uint16_t
name|n
decl_stmt|;
ifdef|#
directive|ifdef
name|USB_DEBUG
name|uint16_t
name|pr_poll_delay
decl_stmt|;
name|uint16_t
name|pr_recovery_delay
decl_stmt|;
endif|#
directive|endif
name|err
operator|=
name|usbd_req_set_port_feature
argument_list|(
name|udev
argument_list|,
name|mtx
argument_list|,
name|port
argument_list|,
name|UHF_BH_PORT_RESET
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
goto|goto
name|done
goto|;
block|}
ifdef|#
directive|ifdef
name|USB_DEBUG
comment|/* range check input parameters */
name|pr_poll_delay
operator|=
name|usb_pr_poll_delay
expr_stmt|;
if|if
condition|(
name|pr_poll_delay
operator|<
literal|1
condition|)
block|{
name|pr_poll_delay
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pr_poll_delay
operator|>
literal|1000
condition|)
block|{
name|pr_poll_delay
operator|=
literal|1000
expr_stmt|;
block|}
name|pr_recovery_delay
operator|=
name|usb_pr_recovery_delay
expr_stmt|;
if|if
condition|(
name|pr_recovery_delay
operator|>
literal|1000
condition|)
block|{
name|pr_recovery_delay
operator|=
literal|1000
expr_stmt|;
block|}
endif|#
directive|endif
name|n
operator|=
literal|0
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
ifdef|#
directive|ifdef
name|USB_DEBUG
comment|/* wait for the device to recover from reset */
name|usb_pause_mtx
argument_list|(
name|mtx
argument_list|,
name|USB_MS_TO_TICKS
argument_list|(
name|pr_poll_delay
argument_list|)
argument_list|)
expr_stmt|;
name|n
operator|+=
name|pr_poll_delay
expr_stmt|;
else|#
directive|else
comment|/* wait for the device to recover from reset */
name|usb_pause_mtx
argument_list|(
name|mtx
argument_list|,
name|USB_MS_TO_TICKS
argument_list|(
name|USB_PORT_RESET_DELAY
argument_list|)
argument_list|)
expr_stmt|;
name|n
operator|+=
name|USB_PORT_RESET_DELAY
expr_stmt|;
endif|#
directive|endif
name|err
operator|=
name|usbd_req_get_port_status
argument_list|(
name|udev
argument_list|,
name|mtx
argument_list|,
operator|&
name|ps
argument_list|,
name|port
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
goto|goto
name|done
goto|;
block|}
comment|/* if the device disappeared, just give up */
if|if
condition|(
operator|!
operator|(
name|UGETW
argument_list|(
name|ps
operator|.
name|wPortStatus
argument_list|)
operator|&
name|UPS_CURRENT_CONNECT_STATUS
operator|)
condition|)
block|{
goto|goto
name|done
goto|;
block|}
comment|/* check if reset is complete */
if|if
condition|(
name|UGETW
argument_list|(
name|ps
operator|.
name|wPortChange
argument_list|)
operator|&
name|UPS_C_BH_PORT_RESET
condition|)
block|{
break|break;
block|}
comment|/* check for timeout */
if|if
condition|(
name|n
operator|>
literal|1000
condition|)
block|{
name|n
operator|=
literal|0
expr_stmt|;
break|break;
block|}
block|}
comment|/* clear port reset first */
name|err
operator|=
name|usbd_req_clear_port_feature
argument_list|(
name|udev
argument_list|,
name|mtx
argument_list|,
name|port
argument_list|,
name|UHF_C_BH_PORT_RESET
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
goto|goto
name|done
goto|;
block|}
comment|/* check for timeout */
if|if
condition|(
name|n
operator|==
literal|0
condition|)
block|{
name|err
operator|=
name|USB_ERR_TIMEOUT
expr_stmt|;
goto|goto
name|done
goto|;
block|}
ifdef|#
directive|ifdef
name|USB_DEBUG
comment|/* wait for the device to recover from reset */
name|usb_pause_mtx
argument_list|(
name|mtx
argument_list|,
name|USB_MS_TO_TICKS
argument_list|(
name|pr_recovery_delay
argument_list|)
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* wait for the device to recover from reset */
name|usb_pause_mtx
argument_list|(
name|mtx
argument_list|,
name|USB_MS_TO_TICKS
argument_list|(
name|USB_PORT_RESET_RECOVERY
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|done
label|:
name|DPRINTFN
argument_list|(
literal|2
argument_list|,
literal|"port %d warm reset returning error=%s\n"
argument_list|,
name|port
argument_list|,
name|usbd_errstr
argument_list|(
name|err
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_comment
comment|/*------------------------------------------------------------------------*  *	usbd_req_get_desc  *  * This function can be used to retrieve USB descriptors. It contains  * some additional logic like zeroing of missing descriptor bytes and  * retrying an USB descriptor in case of failure. The "min_len"  * argument specifies the minimum descriptor length. The "max_len"  * argument specifies the maximum descriptor length. If the real  * descriptor length is less than the minimum length the missing  * byte(s) will be zeroed. The type field, the second byte of the USB  * descriptor, will get forced to the correct type. If the "actlen"  * pointer is non-NULL, the actual length of the transfer will get  * stored in the 16-bit unsigned integer which it is pointing to. The  * first byte of the descriptor will not get updated. If the "actlen"  * pointer is NULL the first byte of the descriptor will get updated  * to reflect the actual length instead. If "min_len" is not equal to  * "max_len" then this function will try to retrive the beginning of  * the descriptor and base the maximum length on the first byte of the  * descriptor.  *  * Returns:  *    0: Success  * Else: Failure  *------------------------------------------------------------------------*/
end_comment

begin_function
name|usb_error_t
name|usbd_req_get_desc
parameter_list|(
name|struct
name|usb_device
modifier|*
name|udev
parameter_list|,
name|struct
name|mtx
modifier|*
name|mtx
parameter_list|,
name|uint16_t
modifier|*
name|actlen
parameter_list|,
name|void
modifier|*
name|desc
parameter_list|,
name|uint16_t
name|min_len
parameter_list|,
name|uint16_t
name|max_len
parameter_list|,
name|uint16_t
name|id
parameter_list|,
name|uint8_t
name|type
parameter_list|,
name|uint8_t
name|index
parameter_list|,
name|uint8_t
name|retries
parameter_list|)
block|{
name|struct
name|usb_device_request
name|req
decl_stmt|;
name|uint8_t
modifier|*
name|buf
decl_stmt|;
name|usb_error_t
name|err
decl_stmt|;
name|DPRINTFN
argument_list|(
literal|4
argument_list|,
literal|"id=%d, type=%d, index=%d, max_len=%d\n"
argument_list|,
name|id
argument_list|,
name|type
argument_list|,
name|index
argument_list|,
name|max_len
argument_list|)
expr_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_READ_DEVICE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|UR_GET_DESCRIPTOR
expr_stmt|;
name|USETW2
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
name|type
argument_list|,
name|index
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
name|id
argument_list|)
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
if|if
condition|(
operator|(
name|min_len
operator|<
literal|2
operator|)
operator|||
operator|(
name|max_len
operator|<
literal|2
operator|)
condition|)
block|{
name|err
operator|=
name|USB_ERR_INVAL
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
name|min_len
argument_list|)
expr_stmt|;
name|err
operator|=
name|usbd_do_request_flags
argument_list|(
name|udev
argument_list|,
name|mtx
argument_list|,
operator|&
name|req
argument_list|,
name|desc
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|1000
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
if|if
condition|(
operator|!
name|retries
condition|)
block|{
goto|goto
name|done
goto|;
block|}
name|retries
operator|--
expr_stmt|;
name|usb_pause_mtx
argument_list|(
name|mtx
argument_list|,
name|hz
operator|/
literal|5
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|buf
operator|=
name|desc
expr_stmt|;
if|if
condition|(
name|min_len
operator|==
name|max_len
condition|)
block|{
comment|/* enforce correct length */
if|if
condition|(
operator|(
name|buf
index|[
literal|0
index|]
operator|>
name|min_len
operator|)
operator|&&
operator|(
name|actlen
operator|==
name|NULL
operator|)
condition|)
name|buf
index|[
literal|0
index|]
operator|=
name|min_len
expr_stmt|;
comment|/* enforce correct type */
name|buf
index|[
literal|1
index|]
operator|=
name|type
expr_stmt|;
goto|goto
name|done
goto|;
block|}
comment|/* range check */
if|if
condition|(
name|max_len
operator|>
name|buf
index|[
literal|0
index|]
condition|)
block|{
name|max_len
operator|=
name|buf
index|[
literal|0
index|]
expr_stmt|;
block|}
comment|/* zero minimum data */
while|while
condition|(
name|min_len
operator|>
name|max_len
condition|)
block|{
name|min_len
operator|--
expr_stmt|;
name|buf
index|[
name|min_len
index|]
operator|=
literal|0
expr_stmt|;
block|}
comment|/* set new minimum length */
name|min_len
operator|=
name|max_len
expr_stmt|;
block|}
name|done
label|:
if|if
condition|(
name|actlen
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|err
condition|)
operator|*
name|actlen
operator|=
literal|0
expr_stmt|;
else|else
operator|*
name|actlen
operator|=
name|min_len
expr_stmt|;
block|}
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_comment
comment|/*------------------------------------------------------------------------*  *	usbd_req_get_string_any  *  * This function will return the string given by "string_index"  * using the first language ID. The maximum length "len" includes  * the terminating zero. The "len" argument should be twice as  * big pluss 2 bytes, compared with the actual maximum string length !  *  * Returns:  *    0: Success  * Else: Failure  *------------------------------------------------------------------------*/
end_comment

begin_function
name|usb_error_t
name|usbd_req_get_string_any
parameter_list|(
name|struct
name|usb_device
modifier|*
name|udev
parameter_list|,
name|struct
name|mtx
modifier|*
name|mtx
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|uint16_t
name|len
parameter_list|,
name|uint8_t
name|string_index
parameter_list|)
block|{
name|char
modifier|*
name|s
decl_stmt|;
name|uint8_t
modifier|*
name|temp
decl_stmt|;
name|uint16_t
name|i
decl_stmt|;
name|uint16_t
name|n
decl_stmt|;
name|uint16_t
name|c
decl_stmt|;
name|uint8_t
name|swap
decl_stmt|;
name|usb_error_t
name|err
decl_stmt|;
if|if
condition|(
name|len
operator|==
literal|0
condition|)
block|{
comment|/* should not happen */
return|return
operator|(
name|USB_ERR_NORMAL_COMPLETION
operator|)
return|;
block|}
if|if
condition|(
name|string_index
operator|==
literal|0
condition|)
block|{
comment|/* this is the language table */
name|buf
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|USB_ERR_INVAL
operator|)
return|;
block|}
if|if
condition|(
name|udev
operator|->
name|flags
operator|.
name|no_strings
condition|)
block|{
name|buf
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|USB_ERR_STALLED
operator|)
return|;
block|}
name|err
operator|=
name|usbd_req_get_string_desc
argument_list|(
name|udev
argument_list|,
name|mtx
argument_list|,
name|buf
argument_list|,
name|len
argument_list|,
name|udev
operator|->
name|langid
argument_list|,
name|string_index
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|buf
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
name|temp
operator|=
operator|(
name|uint8_t
operator|*
operator|)
name|buf
expr_stmt|;
if|if
condition|(
name|temp
index|[
literal|0
index|]
operator|<
literal|2
condition|)
block|{
comment|/* string length is too short */
name|buf
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|USB_ERR_INVAL
operator|)
return|;
block|}
comment|/* reserve one byte for terminating zero */
name|len
operator|--
expr_stmt|;
comment|/* find maximum length */
name|s
operator|=
name|buf
expr_stmt|;
name|n
operator|=
operator|(
name|temp
index|[
literal|0
index|]
operator|/
literal|2
operator|)
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|n
operator|>
name|len
condition|)
block|{
name|n
operator|=
name|len
expr_stmt|;
block|}
comment|/* skip descriptor header */
name|temp
operator|+=
literal|2
expr_stmt|;
comment|/* reset swap state */
name|swap
operator|=
literal|3
expr_stmt|;
comment|/* convert and filter */
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|(
name|i
operator|!=
name|n
operator|)
condition|;
name|i
operator|++
control|)
block|{
name|c
operator|=
name|UGETW
argument_list|(
name|temp
operator|+
operator|(
literal|2
operator|*
name|i
operator|)
argument_list|)
expr_stmt|;
comment|/* convert from Unicode, handle buggy strings */
if|if
condition|(
operator|(
operator|(
name|c
operator|&
literal|0xff00
operator|)
operator|==
literal|0
operator|)
operator|&&
operator|(
name|swap
operator|&
literal|1
operator|)
condition|)
block|{
comment|/* Little Endian, default */
operator|*
name|s
operator|=
name|c
expr_stmt|;
name|swap
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
operator|(
name|c
operator|&
literal|0x00ff
operator|)
operator|==
literal|0
operator|)
operator|&&
operator|(
name|swap
operator|&
literal|2
operator|)
condition|)
block|{
comment|/* Big Endian */
operator|*
name|s
operator|=
name|c
operator|>>
literal|8
expr_stmt|;
name|swap
operator|=
literal|2
expr_stmt|;
block|}
else|else
block|{
comment|/* silently skip bad character */
continue|continue;
block|}
comment|/* 		 * Filter by default - we don't allow greater and less than 		 * signs because they might confuse the dmesg printouts! 		 */
if|if
condition|(
operator|(
operator|*
name|s
operator|==
literal|'<'
operator|)
operator|||
operator|(
operator|*
name|s
operator|==
literal|'>'
operator|)
operator|||
operator|(
operator|!
name|isprint
argument_list|(
operator|*
name|s
argument_list|)
operator|)
condition|)
block|{
comment|/* silently skip bad character */
continue|continue;
block|}
name|s
operator|++
expr_stmt|;
block|}
operator|*
name|s
operator|=
literal|0
expr_stmt|;
comment|/* zero terminate resulting string */
return|return
operator|(
name|USB_ERR_NORMAL_COMPLETION
operator|)
return|;
block|}
end_function

begin_comment
comment|/*------------------------------------------------------------------------*  *	usbd_req_get_string_desc  *  * If you don't know the language ID, consider using  * "usbd_req_get_string_any()".  *  * Returns:  *    0: Success  * Else: Failure  *------------------------------------------------------------------------*/
end_comment

begin_function
name|usb_error_t
name|usbd_req_get_string_desc
parameter_list|(
name|struct
name|usb_device
modifier|*
name|udev
parameter_list|,
name|struct
name|mtx
modifier|*
name|mtx
parameter_list|,
name|void
modifier|*
name|sdesc
parameter_list|,
name|uint16_t
name|max_len
parameter_list|,
name|uint16_t
name|lang_id
parameter_list|,
name|uint8_t
name|string_index
parameter_list|)
block|{
return|return
operator|(
name|usbd_req_get_desc
argument_list|(
name|udev
argument_list|,
name|mtx
argument_list|,
name|NULL
argument_list|,
name|sdesc
argument_list|,
literal|2
argument_list|,
name|max_len
argument_list|,
name|lang_id
argument_list|,
name|UDESC_STRING
argument_list|,
name|string_index
argument_list|,
literal|0
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*------------------------------------------------------------------------*  *	usbd_req_get_config_desc_ptr  *  * This function is used in device side mode to retrieve the pointer  * to the generated config descriptor. This saves allocating space for  * an additional config descriptor when setting the configuration.  *  * Returns:  *    0: Success  * Else: Failure  *------------------------------------------------------------------------*/
end_comment

begin_function
name|usb_error_t
name|usbd_req_get_descriptor_ptr
parameter_list|(
name|struct
name|usb_device
modifier|*
name|udev
parameter_list|,
name|struct
name|usb_config_descriptor
modifier|*
modifier|*
name|ppcd
parameter_list|,
name|uint16_t
name|wValue
parameter_list|)
block|{
name|struct
name|usb_device_request
name|req
decl_stmt|;
name|usb_handle_req_t
modifier|*
name|hr_func
decl_stmt|;
specifier|const
name|void
modifier|*
name|ptr
decl_stmt|;
name|uint16_t
name|len
decl_stmt|;
name|usb_error_t
name|err
decl_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_READ_DEVICE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|UR_GET_DESCRIPTOR
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
name|wValue
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ptr
operator|=
name|NULL
expr_stmt|;
name|len
operator|=
literal|0
expr_stmt|;
name|hr_func
operator|=
name|usbd_get_hr_func
argument_list|(
name|udev
argument_list|)
expr_stmt|;
if|if
condition|(
name|hr_func
operator|==
name|NULL
condition|)
name|err
operator|=
name|USB_ERR_INVAL
expr_stmt|;
else|else
block|{
name|USB_BUS_LOCK
argument_list|(
name|udev
operator|->
name|bus
argument_list|)
expr_stmt|;
name|err
operator|=
call|(
name|hr_func
call|)
argument_list|(
name|udev
argument_list|,
operator|&
name|req
argument_list|,
operator|&
name|ptr
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
name|USB_BUS_UNLOCK
argument_list|(
name|udev
operator|->
name|bus
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|err
condition|)
name|ptr
operator|=
name|NULL
expr_stmt|;
elseif|else
if|if
condition|(
name|ptr
operator|==
name|NULL
condition|)
name|err
operator|=
name|USB_ERR_INVAL
expr_stmt|;
operator|*
name|ppcd
operator|=
name|__DECONST
argument_list|(
expr|struct
name|usb_config_descriptor
operator|*
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_comment
comment|/*------------------------------------------------------------------------*  *	usbd_req_get_config_desc  *  * Returns:  *    0: Success  * Else: Failure  *------------------------------------------------------------------------*/
end_comment

begin_function
name|usb_error_t
name|usbd_req_get_config_desc
parameter_list|(
name|struct
name|usb_device
modifier|*
name|udev
parameter_list|,
name|struct
name|mtx
modifier|*
name|mtx
parameter_list|,
name|struct
name|usb_config_descriptor
modifier|*
name|d
parameter_list|,
name|uint8_t
name|conf_index
parameter_list|)
block|{
name|usb_error_t
name|err
decl_stmt|;
name|DPRINTFN
argument_list|(
literal|4
argument_list|,
literal|"confidx=%d\n"
argument_list|,
name|conf_index
argument_list|)
expr_stmt|;
name|err
operator|=
name|usbd_req_get_desc
argument_list|(
name|udev
argument_list|,
name|mtx
argument_list|,
name|NULL
argument_list|,
name|d
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|d
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|d
argument_list|)
argument_list|,
literal|0
argument_list|,
name|UDESC_CONFIG
argument_list|,
name|conf_index
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
goto|goto
name|done
goto|;
block|}
comment|/* Extra sanity checking */
if|if
condition|(
name|UGETW
argument_list|(
name|d
operator|->
name|wTotalLength
argument_list|)
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|d
argument_list|)
condition|)
block|{
name|err
operator|=
name|USB_ERR_INVAL
expr_stmt|;
block|}
name|done
label|:
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_comment
comment|/*------------------------------------------------------------------------*  *	usbd_req_get_config_desc_full  *  * This function gets the complete USB configuration descriptor and  * ensures that "wTotalLength" is correct.  *  * Returns:  *    0: Success  * Else: Failure  *------------------------------------------------------------------------*/
end_comment

begin_function
name|usb_error_t
name|usbd_req_get_config_desc_full
parameter_list|(
name|struct
name|usb_device
modifier|*
name|udev
parameter_list|,
name|struct
name|mtx
modifier|*
name|mtx
parameter_list|,
name|struct
name|usb_config_descriptor
modifier|*
modifier|*
name|ppcd
parameter_list|,
name|struct
name|malloc_type
modifier|*
name|mtype
parameter_list|,
name|uint8_t
name|index
parameter_list|)
block|{
name|struct
name|usb_config_descriptor
name|cd
decl_stmt|;
name|struct
name|usb_config_descriptor
modifier|*
name|cdesc
decl_stmt|;
name|uint16_t
name|len
decl_stmt|;
name|usb_error_t
name|err
decl_stmt|;
name|DPRINTFN
argument_list|(
literal|4
argument_list|,
literal|"index=%d\n"
argument_list|,
name|index
argument_list|)
expr_stmt|;
operator|*
name|ppcd
operator|=
name|NULL
expr_stmt|;
name|err
operator|=
name|usbd_req_get_config_desc
argument_list|(
name|udev
argument_list|,
name|mtx
argument_list|,
operator|&
name|cd
argument_list|,
name|index
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
return|return
operator|(
name|err
operator|)
return|;
block|}
comment|/* get full descriptor */
name|len
operator|=
name|UGETW
argument_list|(
name|cd
operator|.
name|wTotalLength
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|cdesc
argument_list|)
condition|)
block|{
comment|/* corrupt descriptor */
return|return
operator|(
name|USB_ERR_INVAL
operator|)
return|;
block|}
name|cdesc
operator|=
name|malloc
argument_list|(
name|len
argument_list|,
name|mtype
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
if|if
condition|(
name|cdesc
operator|==
name|NULL
condition|)
block|{
return|return
operator|(
name|USB_ERR_NOMEM
operator|)
return|;
block|}
name|err
operator|=
name|usbd_req_get_desc
argument_list|(
name|udev
argument_list|,
name|mtx
argument_list|,
name|NULL
argument_list|,
name|cdesc
argument_list|,
name|len
argument_list|,
name|len
argument_list|,
literal|0
argument_list|,
name|UDESC_CONFIG
argument_list|,
name|index
argument_list|,
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|free
argument_list|(
name|cdesc
argument_list|,
name|mtype
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
comment|/* make sure that the device is not fooling us: */
name|USETW
argument_list|(
name|cdesc
operator|->
name|wTotalLength
argument_list|,
name|len
argument_list|)
expr_stmt|;
operator|*
name|ppcd
operator|=
name|cdesc
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
comment|/* success */
block|}
end_function

begin_comment
comment|/*------------------------------------------------------------------------*  *	usbd_req_get_device_desc  *  * Returns:  *    0: Success  * Else: Failure  *------------------------------------------------------------------------*/
end_comment

begin_function
name|usb_error_t
name|usbd_req_get_device_desc
parameter_list|(
name|struct
name|usb_device
modifier|*
name|udev
parameter_list|,
name|struct
name|mtx
modifier|*
name|mtx
parameter_list|,
name|struct
name|usb_device_descriptor
modifier|*
name|d
parameter_list|)
block|{
name|DPRINTFN
argument_list|(
literal|4
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|usbd_req_get_desc
argument_list|(
name|udev
argument_list|,
name|mtx
argument_list|,
name|NULL
argument_list|,
name|d
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|d
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|d
argument_list|)
argument_list|,
literal|0
argument_list|,
name|UDESC_DEVICE
argument_list|,
literal|0
argument_list|,
literal|3
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*------------------------------------------------------------------------*  *	usbd_req_get_alt_interface_no  *  * Returns:  *    0: Success  * Else: Failure  *------------------------------------------------------------------------*/
end_comment

begin_function
name|usb_error_t
name|usbd_req_get_alt_interface_no
parameter_list|(
name|struct
name|usb_device
modifier|*
name|udev
parameter_list|,
name|struct
name|mtx
modifier|*
name|mtx
parameter_list|,
name|uint8_t
modifier|*
name|alt_iface_no
parameter_list|,
name|uint8_t
name|iface_index
parameter_list|)
block|{
name|struct
name|usb_interface
modifier|*
name|iface
init|=
name|usbd_get_iface
argument_list|(
name|udev
argument_list|,
name|iface_index
argument_list|)
decl_stmt|;
name|struct
name|usb_device_request
name|req
decl_stmt|;
if|if
condition|(
operator|(
name|iface
operator|==
name|NULL
operator|)
operator|||
operator|(
name|iface
operator|->
name|idesc
operator|==
name|NULL
operator|)
condition|)
return|return
operator|(
name|USB_ERR_INVAL
operator|)
return|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_READ_INTERFACE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|UR_GET_INTERFACE
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|req
operator|.
name|wIndex
index|[
literal|0
index|]
operator|=
name|iface
operator|->
name|idesc
operator|->
name|bInterfaceNumber
expr_stmt|;
name|req
operator|.
name|wIndex
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
operator|(
name|usbd_do_request
argument_list|(
name|udev
argument_list|,
name|mtx
argument_list|,
operator|&
name|req
argument_list|,
name|alt_iface_no
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*------------------------------------------------------------------------*  *	usbd_req_set_alt_interface_no  *  * Returns:  *    0: Success  * Else: Failure  *------------------------------------------------------------------------*/
end_comment

begin_function
name|usb_error_t
name|usbd_req_set_alt_interface_no
parameter_list|(
name|struct
name|usb_device
modifier|*
name|udev
parameter_list|,
name|struct
name|mtx
modifier|*
name|mtx
parameter_list|,
name|uint8_t
name|iface_index
parameter_list|,
name|uint8_t
name|alt_no
parameter_list|)
block|{
name|struct
name|usb_interface
modifier|*
name|iface
init|=
name|usbd_get_iface
argument_list|(
name|udev
argument_list|,
name|iface_index
argument_list|)
decl_stmt|;
name|struct
name|usb_device_request
name|req
decl_stmt|;
if|if
condition|(
operator|(
name|iface
operator|==
name|NULL
operator|)
operator|||
operator|(
name|iface
operator|->
name|idesc
operator|==
name|NULL
operator|)
condition|)
return|return
operator|(
name|USB_ERR_INVAL
operator|)
return|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_WRITE_INTERFACE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|UR_SET_INTERFACE
expr_stmt|;
name|req
operator|.
name|wValue
index|[
literal|0
index|]
operator|=
name|alt_no
expr_stmt|;
name|req
operator|.
name|wValue
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|req
operator|.
name|wIndex
index|[
literal|0
index|]
operator|=
name|iface
operator|->
name|idesc
operator|->
name|bInterfaceNumber
expr_stmt|;
name|req
operator|.
name|wIndex
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|usbd_do_request
argument_list|(
name|udev
argument_list|,
name|mtx
argument_list|,
operator|&
name|req
argument_list|,
literal|0
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*------------------------------------------------------------------------*  *	usbd_req_get_device_status  *  * Returns:  *    0: Success  * Else: Failure  *------------------------------------------------------------------------*/
end_comment

begin_function
name|usb_error_t
name|usbd_req_get_device_status
parameter_list|(
name|struct
name|usb_device
modifier|*
name|udev
parameter_list|,
name|struct
name|mtx
modifier|*
name|mtx
parameter_list|,
name|struct
name|usb_status
modifier|*
name|st
parameter_list|)
block|{
name|struct
name|usb_device_request
name|req
decl_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_READ_DEVICE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|UR_GET_STATUS
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|st
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|usbd_do_request
argument_list|(
name|udev
argument_list|,
name|mtx
argument_list|,
operator|&
name|req
argument_list|,
name|st
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*------------------------------------------------------------------------*  *	usbd_req_get_hub_descriptor  *  * Returns:  *    0: Success  * Else: Failure  *------------------------------------------------------------------------*/
end_comment

begin_function
name|usb_error_t
name|usbd_req_get_hub_descriptor
parameter_list|(
name|struct
name|usb_device
modifier|*
name|udev
parameter_list|,
name|struct
name|mtx
modifier|*
name|mtx
parameter_list|,
name|struct
name|usb_hub_descriptor
modifier|*
name|hd
parameter_list|,
name|uint8_t
name|nports
parameter_list|)
block|{
name|struct
name|usb_device_request
name|req
decl_stmt|;
name|uint16_t
name|len
init|=
operator|(
name|nports
operator|+
literal|7
operator|+
operator|(
literal|8
operator|*
literal|8
operator|)
operator|)
operator|/
literal|8
decl_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_READ_CLASS_DEVICE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|UR_GET_DESCRIPTOR
expr_stmt|;
name|USETW2
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
name|UDESC_HUB
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|(
name|usbd_do_request
argument_list|(
name|udev
argument_list|,
name|mtx
argument_list|,
operator|&
name|req
argument_list|,
name|hd
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*------------------------------------------------------------------------*  *	usbd_req_get_ss_hub_descriptor  *  * Returns:  *    0: Success  * Else: Failure  *------------------------------------------------------------------------*/
end_comment

begin_function
name|usb_error_t
name|usbd_req_get_ss_hub_descriptor
parameter_list|(
name|struct
name|usb_device
modifier|*
name|udev
parameter_list|,
name|struct
name|mtx
modifier|*
name|mtx
parameter_list|,
name|struct
name|usb_hub_ss_descriptor
modifier|*
name|hd
parameter_list|,
name|uint8_t
name|nports
parameter_list|)
block|{
name|struct
name|usb_device_request
name|req
decl_stmt|;
name|uint16_t
name|len
init|=
sizeof|sizeof
argument_list|(
operator|*
name|hd
argument_list|)
operator|-
literal|32
operator|+
literal|1
operator|+
operator|(
operator|(
name|nports
operator|+
literal|7
operator|)
operator|/
literal|8
operator|)
decl_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_READ_CLASS_DEVICE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|UR_GET_DESCRIPTOR
expr_stmt|;
name|USETW2
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
name|UDESC_SS_HUB
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|(
name|usbd_do_request
argument_list|(
name|udev
argument_list|,
name|mtx
argument_list|,
operator|&
name|req
argument_list|,
name|hd
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*------------------------------------------------------------------------*  *	usbd_req_get_hub_status  *  * Returns:  *    0: Success  * Else: Failure  *------------------------------------------------------------------------*/
end_comment

begin_function
name|usb_error_t
name|usbd_req_get_hub_status
parameter_list|(
name|struct
name|usb_device
modifier|*
name|udev
parameter_list|,
name|struct
name|mtx
modifier|*
name|mtx
parameter_list|,
name|struct
name|usb_hub_status
modifier|*
name|st
parameter_list|)
block|{
name|struct
name|usb_device_request
name|req
decl_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_READ_CLASS_DEVICE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|UR_GET_STATUS
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|usb_hub_status
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|usbd_do_request
argument_list|(
name|udev
argument_list|,
name|mtx
argument_list|,
operator|&
name|req
argument_list|,
name|st
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*------------------------------------------------------------------------*  *	usbd_req_set_address  *  * This function is used to set the address for an USB device. After  * port reset the USB device will respond at address zero.  *  * Returns:  *    0: Success  * Else: Failure  *------------------------------------------------------------------------*/
end_comment

begin_function
name|usb_error_t
name|usbd_req_set_address
parameter_list|(
name|struct
name|usb_device
modifier|*
name|udev
parameter_list|,
name|struct
name|mtx
modifier|*
name|mtx
parameter_list|,
name|uint16_t
name|addr
parameter_list|)
block|{
name|struct
name|usb_device_request
name|req
decl_stmt|;
name|usb_error_t
name|err
decl_stmt|;
name|DPRINTFN
argument_list|(
literal|6
argument_list|,
literal|"setting device address=%d\n"
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_WRITE_DEVICE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|UR_SET_ADDRESS
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|err
operator|=
name|USB_ERR_INVAL
expr_stmt|;
comment|/* check if USB controller handles set address */
if|if
condition|(
name|udev
operator|->
name|bus
operator|->
name|methods
operator|->
name|set_address
operator|!=
name|NULL
condition|)
name|err
operator|=
call|(
name|udev
operator|->
name|bus
operator|->
name|methods
operator|->
name|set_address
call|)
argument_list|(
name|udev
argument_list|,
name|mtx
argument_list|,
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|USB_ERR_INVAL
condition|)
goto|goto
name|done
goto|;
comment|/* Setting the address should not take more than 1 second ! */
name|err
operator|=
name|usbd_do_request_flags
argument_list|(
name|udev
argument_list|,
name|mtx
argument_list|,
operator|&
name|req
argument_list|,
name|NULL
argument_list|,
name|USB_DELAY_STATUS_STAGE
argument_list|,
name|NULL
argument_list|,
literal|1000
argument_list|)
expr_stmt|;
name|done
label|:
comment|/* allow device time to set new address */
name|usb_pause_mtx
argument_list|(
name|mtx
argument_list|,
name|USB_MS_TO_TICKS
argument_list|(
name|USB_SET_ADDRESS_SETTLE
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_comment
comment|/*------------------------------------------------------------------------*  *	usbd_req_get_port_status  *  * Returns:  *    0: Success  * Else: Failure  *------------------------------------------------------------------------*/
end_comment

begin_function
name|usb_error_t
name|usbd_req_get_port_status
parameter_list|(
name|struct
name|usb_device
modifier|*
name|udev
parameter_list|,
name|struct
name|mtx
modifier|*
name|mtx
parameter_list|,
name|struct
name|usb_port_status
modifier|*
name|ps
parameter_list|,
name|uint8_t
name|port
parameter_list|)
block|{
name|struct
name|usb_device_request
name|req
decl_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_READ_CLASS_OTHER
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|UR_GET_STATUS
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|req
operator|.
name|wIndex
index|[
literal|0
index|]
operator|=
name|port
expr_stmt|;
name|req
operator|.
name|wIndex
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
sizeof|sizeof
expr|*
name|ps
argument_list|)
expr_stmt|;
return|return
operator|(
name|usbd_do_request
argument_list|(
name|udev
argument_list|,
name|mtx
argument_list|,
operator|&
name|req
argument_list|,
name|ps
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*------------------------------------------------------------------------*  *	usbd_req_clear_hub_feature  *  * Returns:  *    0: Success  * Else: Failure  *------------------------------------------------------------------------*/
end_comment

begin_function
name|usb_error_t
name|usbd_req_clear_hub_feature
parameter_list|(
name|struct
name|usb_device
modifier|*
name|udev
parameter_list|,
name|struct
name|mtx
modifier|*
name|mtx
parameter_list|,
name|uint16_t
name|sel
parameter_list|)
block|{
name|struct
name|usb_device_request
name|req
decl_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_WRITE_CLASS_DEVICE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|UR_CLEAR_FEATURE
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
name|sel
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|usbd_do_request
argument_list|(
name|udev
argument_list|,
name|mtx
argument_list|,
operator|&
name|req
argument_list|,
literal|0
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*------------------------------------------------------------------------*  *	usbd_req_set_hub_feature  *  * Returns:  *    0: Success  * Else: Failure  *------------------------------------------------------------------------*/
end_comment

begin_function
name|usb_error_t
name|usbd_req_set_hub_feature
parameter_list|(
name|struct
name|usb_device
modifier|*
name|udev
parameter_list|,
name|struct
name|mtx
modifier|*
name|mtx
parameter_list|,
name|uint16_t
name|sel
parameter_list|)
block|{
name|struct
name|usb_device_request
name|req
decl_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_WRITE_CLASS_DEVICE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|UR_SET_FEATURE
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
name|sel
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|usbd_do_request
argument_list|(
name|udev
argument_list|,
name|mtx
argument_list|,
operator|&
name|req
argument_list|,
literal|0
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*------------------------------------------------------------------------*  *	usbd_req_set_hub_u1_timeout  *  * Returns:  *    0: Success  * Else: Failure  *------------------------------------------------------------------------*/
end_comment

begin_function
name|usb_error_t
name|usbd_req_set_hub_u1_timeout
parameter_list|(
name|struct
name|usb_device
modifier|*
name|udev
parameter_list|,
name|struct
name|mtx
modifier|*
name|mtx
parameter_list|,
name|uint8_t
name|port
parameter_list|,
name|uint8_t
name|timeout
parameter_list|)
block|{
name|struct
name|usb_device_request
name|req
decl_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_WRITE_CLASS_OTHER
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|UR_SET_FEATURE
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
name|UHF_PORT_U1_TIMEOUT
argument_list|)
expr_stmt|;
name|req
operator|.
name|wIndex
index|[
literal|0
index|]
operator|=
name|port
expr_stmt|;
name|req
operator|.
name|wIndex
index|[
literal|1
index|]
operator|=
name|timeout
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|usbd_do_request
argument_list|(
name|udev
argument_list|,
name|mtx
argument_list|,
operator|&
name|req
argument_list|,
literal|0
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*------------------------------------------------------------------------*  *	usbd_req_set_hub_u2_timeout  *  * Returns:  *    0: Success  * Else: Failure  *------------------------------------------------------------------------*/
end_comment

begin_function
name|usb_error_t
name|usbd_req_set_hub_u2_timeout
parameter_list|(
name|struct
name|usb_device
modifier|*
name|udev
parameter_list|,
name|struct
name|mtx
modifier|*
name|mtx
parameter_list|,
name|uint8_t
name|port
parameter_list|,
name|uint8_t
name|timeout
parameter_list|)
block|{
name|struct
name|usb_device_request
name|req
decl_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_WRITE_CLASS_OTHER
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|UR_SET_FEATURE
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
name|UHF_PORT_U2_TIMEOUT
argument_list|)
expr_stmt|;
name|req
operator|.
name|wIndex
index|[
literal|0
index|]
operator|=
name|port
expr_stmt|;
name|req
operator|.
name|wIndex
index|[
literal|1
index|]
operator|=
name|timeout
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|usbd_do_request
argument_list|(
name|udev
argument_list|,
name|mtx
argument_list|,
operator|&
name|req
argument_list|,
literal|0
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*------------------------------------------------------------------------*  *	usbd_req_set_hub_depth  *  * Returns:  *    0: Success  * Else: Failure  *------------------------------------------------------------------------*/
end_comment

begin_function
name|usb_error_t
name|usbd_req_set_hub_depth
parameter_list|(
name|struct
name|usb_device
modifier|*
name|udev
parameter_list|,
name|struct
name|mtx
modifier|*
name|mtx
parameter_list|,
name|uint16_t
name|depth
parameter_list|)
block|{
name|struct
name|usb_device_request
name|req
decl_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_WRITE_CLASS_DEVICE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|UR_SET_HUB_DEPTH
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
name|depth
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|usbd_do_request
argument_list|(
name|udev
argument_list|,
name|mtx
argument_list|,
operator|&
name|req
argument_list|,
literal|0
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*------------------------------------------------------------------------*  *	usbd_req_clear_port_feature  *  * Returns:  *    0: Success  * Else: Failure  *------------------------------------------------------------------------*/
end_comment

begin_function
name|usb_error_t
name|usbd_req_clear_port_feature
parameter_list|(
name|struct
name|usb_device
modifier|*
name|udev
parameter_list|,
name|struct
name|mtx
modifier|*
name|mtx
parameter_list|,
name|uint8_t
name|port
parameter_list|,
name|uint16_t
name|sel
parameter_list|)
block|{
name|struct
name|usb_device_request
name|req
decl_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_WRITE_CLASS_OTHER
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|UR_CLEAR_FEATURE
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
name|sel
argument_list|)
expr_stmt|;
name|req
operator|.
name|wIndex
index|[
literal|0
index|]
operator|=
name|port
expr_stmt|;
name|req
operator|.
name|wIndex
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|usbd_do_request
argument_list|(
name|udev
argument_list|,
name|mtx
argument_list|,
operator|&
name|req
argument_list|,
literal|0
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*------------------------------------------------------------------------*  *	usbd_req_set_port_feature  *  * Returns:  *    0: Success  * Else: Failure  *------------------------------------------------------------------------*/
end_comment

begin_function
name|usb_error_t
name|usbd_req_set_port_feature
parameter_list|(
name|struct
name|usb_device
modifier|*
name|udev
parameter_list|,
name|struct
name|mtx
modifier|*
name|mtx
parameter_list|,
name|uint8_t
name|port
parameter_list|,
name|uint16_t
name|sel
parameter_list|)
block|{
name|struct
name|usb_device_request
name|req
decl_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_WRITE_CLASS_OTHER
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|UR_SET_FEATURE
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
name|sel
argument_list|)
expr_stmt|;
name|req
operator|.
name|wIndex
index|[
literal|0
index|]
operator|=
name|port
expr_stmt|;
name|req
operator|.
name|wIndex
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|usbd_do_request
argument_list|(
name|udev
argument_list|,
name|mtx
argument_list|,
operator|&
name|req
argument_list|,
literal|0
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*------------------------------------------------------------------------*  *	usbd_req_set_protocol  *  * Returns:  *    0: Success  * Else: Failure  *------------------------------------------------------------------------*/
end_comment

begin_function
name|usb_error_t
name|usbd_req_set_protocol
parameter_list|(
name|struct
name|usb_device
modifier|*
name|udev
parameter_list|,
name|struct
name|mtx
modifier|*
name|mtx
parameter_list|,
name|uint8_t
name|iface_index
parameter_list|,
name|uint16_t
name|report
parameter_list|)
block|{
name|struct
name|usb_interface
modifier|*
name|iface
init|=
name|usbd_get_iface
argument_list|(
name|udev
argument_list|,
name|iface_index
argument_list|)
decl_stmt|;
name|struct
name|usb_device_request
name|req
decl_stmt|;
if|if
condition|(
operator|(
name|iface
operator|==
name|NULL
operator|)
operator|||
operator|(
name|iface
operator|->
name|idesc
operator|==
name|NULL
operator|)
condition|)
block|{
return|return
operator|(
name|USB_ERR_INVAL
operator|)
return|;
block|}
name|DPRINTFN
argument_list|(
literal|5
argument_list|,
literal|"iface=%p, report=%d, endpt=%d\n"
argument_list|,
name|iface
argument_list|,
name|report
argument_list|,
name|iface
operator|->
name|idesc
operator|->
name|bInterfaceNumber
argument_list|)
expr_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_WRITE_CLASS_INTERFACE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|UR_SET_PROTOCOL
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
name|report
argument_list|)
expr_stmt|;
name|req
operator|.
name|wIndex
index|[
literal|0
index|]
operator|=
name|iface
operator|->
name|idesc
operator|->
name|bInterfaceNumber
expr_stmt|;
name|req
operator|.
name|wIndex
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|usbd_do_request
argument_list|(
name|udev
argument_list|,
name|mtx
argument_list|,
operator|&
name|req
argument_list|,
literal|0
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*------------------------------------------------------------------------*  *	usbd_req_set_report  *  * Returns:  *    0: Success  * Else: Failure  *------------------------------------------------------------------------*/
end_comment

begin_function
name|usb_error_t
name|usbd_req_set_report
parameter_list|(
name|struct
name|usb_device
modifier|*
name|udev
parameter_list|,
name|struct
name|mtx
modifier|*
name|mtx
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|uint16_t
name|len
parameter_list|,
name|uint8_t
name|iface_index
parameter_list|,
name|uint8_t
name|type
parameter_list|,
name|uint8_t
name|id
parameter_list|)
block|{
name|struct
name|usb_interface
modifier|*
name|iface
init|=
name|usbd_get_iface
argument_list|(
name|udev
argument_list|,
name|iface_index
argument_list|)
decl_stmt|;
name|struct
name|usb_device_request
name|req
decl_stmt|;
if|if
condition|(
operator|(
name|iface
operator|==
name|NULL
operator|)
operator|||
operator|(
name|iface
operator|->
name|idesc
operator|==
name|NULL
operator|)
condition|)
block|{
return|return
operator|(
name|USB_ERR_INVAL
operator|)
return|;
block|}
name|DPRINTFN
argument_list|(
literal|5
argument_list|,
literal|"len=%d\n"
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_WRITE_CLASS_INTERFACE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|UR_SET_REPORT
expr_stmt|;
name|USETW2
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
name|type
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|req
operator|.
name|wIndex
index|[
literal|0
index|]
operator|=
name|iface
operator|->
name|idesc
operator|->
name|bInterfaceNumber
expr_stmt|;
name|req
operator|.
name|wIndex
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|(
name|usbd_do_request
argument_list|(
name|udev
argument_list|,
name|mtx
argument_list|,
operator|&
name|req
argument_list|,
name|data
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*------------------------------------------------------------------------*  *	usbd_req_get_report  *  * Returns:  *    0: Success  * Else: Failure  *------------------------------------------------------------------------*/
end_comment

begin_function
name|usb_error_t
name|usbd_req_get_report
parameter_list|(
name|struct
name|usb_device
modifier|*
name|udev
parameter_list|,
name|struct
name|mtx
modifier|*
name|mtx
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|uint16_t
name|len
parameter_list|,
name|uint8_t
name|iface_index
parameter_list|,
name|uint8_t
name|type
parameter_list|,
name|uint8_t
name|id
parameter_list|)
block|{
name|struct
name|usb_interface
modifier|*
name|iface
init|=
name|usbd_get_iface
argument_list|(
name|udev
argument_list|,
name|iface_index
argument_list|)
decl_stmt|;
name|struct
name|usb_device_request
name|req
decl_stmt|;
if|if
condition|(
operator|(
name|iface
operator|==
name|NULL
operator|)
operator|||
operator|(
name|iface
operator|->
name|idesc
operator|==
name|NULL
operator|)
operator|||
operator|(
name|id
operator|==
literal|0
operator|)
condition|)
block|{
return|return
operator|(
name|USB_ERR_INVAL
operator|)
return|;
block|}
name|DPRINTFN
argument_list|(
literal|5
argument_list|,
literal|"len=%d\n"
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_READ_CLASS_INTERFACE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|UR_GET_REPORT
expr_stmt|;
name|USETW2
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
name|type
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|req
operator|.
name|wIndex
index|[
literal|0
index|]
operator|=
name|iface
operator|->
name|idesc
operator|->
name|bInterfaceNumber
expr_stmt|;
name|req
operator|.
name|wIndex
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|(
name|usbd_do_request
argument_list|(
name|udev
argument_list|,
name|mtx
argument_list|,
operator|&
name|req
argument_list|,
name|data
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*------------------------------------------------------------------------*  *	usbd_req_set_idle  *  * Returns:  *    0: Success  * Else: Failure  *------------------------------------------------------------------------*/
end_comment

begin_function
name|usb_error_t
name|usbd_req_set_idle
parameter_list|(
name|struct
name|usb_device
modifier|*
name|udev
parameter_list|,
name|struct
name|mtx
modifier|*
name|mtx
parameter_list|,
name|uint8_t
name|iface_index
parameter_list|,
name|uint8_t
name|duration
parameter_list|,
name|uint8_t
name|id
parameter_list|)
block|{
name|struct
name|usb_interface
modifier|*
name|iface
init|=
name|usbd_get_iface
argument_list|(
name|udev
argument_list|,
name|iface_index
argument_list|)
decl_stmt|;
name|struct
name|usb_device_request
name|req
decl_stmt|;
if|if
condition|(
operator|(
name|iface
operator|==
name|NULL
operator|)
operator|||
operator|(
name|iface
operator|->
name|idesc
operator|==
name|NULL
operator|)
condition|)
block|{
return|return
operator|(
name|USB_ERR_INVAL
operator|)
return|;
block|}
name|DPRINTFN
argument_list|(
literal|5
argument_list|,
literal|"%d %d\n"
argument_list|,
name|duration
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_WRITE_CLASS_INTERFACE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|UR_SET_IDLE
expr_stmt|;
name|USETW2
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
name|duration
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|req
operator|.
name|wIndex
index|[
literal|0
index|]
operator|=
name|iface
operator|->
name|idesc
operator|->
name|bInterfaceNumber
expr_stmt|;
name|req
operator|.
name|wIndex
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|usbd_do_request
argument_list|(
name|udev
argument_list|,
name|mtx
argument_list|,
operator|&
name|req
argument_list|,
literal|0
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*------------------------------------------------------------------------*  *	usbd_req_get_report_descriptor  *  * Returns:  *    0: Success  * Else: Failure  *------------------------------------------------------------------------*/
end_comment

begin_function
name|usb_error_t
name|usbd_req_get_report_descriptor
parameter_list|(
name|struct
name|usb_device
modifier|*
name|udev
parameter_list|,
name|struct
name|mtx
modifier|*
name|mtx
parameter_list|,
name|void
modifier|*
name|d
parameter_list|,
name|uint16_t
name|size
parameter_list|,
name|uint8_t
name|iface_index
parameter_list|)
block|{
name|struct
name|usb_interface
modifier|*
name|iface
init|=
name|usbd_get_iface
argument_list|(
name|udev
argument_list|,
name|iface_index
argument_list|)
decl_stmt|;
name|struct
name|usb_device_request
name|req
decl_stmt|;
if|if
condition|(
operator|(
name|iface
operator|==
name|NULL
operator|)
operator|||
operator|(
name|iface
operator|->
name|idesc
operator|==
name|NULL
operator|)
condition|)
block|{
return|return
operator|(
name|USB_ERR_INVAL
operator|)
return|;
block|}
name|req
operator|.
name|bmRequestType
operator|=
name|UT_READ_INTERFACE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|UR_GET_DESCRIPTOR
expr_stmt|;
name|USETW2
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
name|UDESC_REPORT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* report id should be 0 */
name|req
operator|.
name|wIndex
index|[
literal|0
index|]
operator|=
name|iface
operator|->
name|idesc
operator|->
name|bInterfaceNumber
expr_stmt|;
name|req
operator|.
name|wIndex
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
name|size
argument_list|)
expr_stmt|;
return|return
operator|(
name|usbd_do_request
argument_list|(
name|udev
argument_list|,
name|mtx
argument_list|,
operator|&
name|req
argument_list|,
name|d
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*------------------------------------------------------------------------*  *	usbd_req_set_config  *  * This function is used to select the current configuration number in  * both USB device side mode and USB host side mode. When setting the  * configuration the function of the interfaces can change.  *  * Returns:  *    0: Success  * Else: Failure  *------------------------------------------------------------------------*/
end_comment

begin_function
name|usb_error_t
name|usbd_req_set_config
parameter_list|(
name|struct
name|usb_device
modifier|*
name|udev
parameter_list|,
name|struct
name|mtx
modifier|*
name|mtx
parameter_list|,
name|uint8_t
name|conf
parameter_list|)
block|{
name|struct
name|usb_device_request
name|req
decl_stmt|;
name|DPRINTF
argument_list|(
literal|"setting config %d\n"
argument_list|,
name|conf
argument_list|)
expr_stmt|;
comment|/* do "set configuration" request */
name|req
operator|.
name|bmRequestType
operator|=
name|UT_WRITE_DEVICE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|UR_SET_CONFIG
expr_stmt|;
name|req
operator|.
name|wValue
index|[
literal|0
index|]
operator|=
name|conf
expr_stmt|;
name|req
operator|.
name|wValue
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|usbd_do_request
argument_list|(
name|udev
argument_list|,
name|mtx
argument_list|,
operator|&
name|req
argument_list|,
literal|0
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*------------------------------------------------------------------------*  *	usbd_req_get_config  *  * Returns:  *    0: Success  * Else: Failure  *------------------------------------------------------------------------*/
end_comment

begin_function
name|usb_error_t
name|usbd_req_get_config
parameter_list|(
name|struct
name|usb_device
modifier|*
name|udev
parameter_list|,
name|struct
name|mtx
modifier|*
name|mtx
parameter_list|,
name|uint8_t
modifier|*
name|pconf
parameter_list|)
block|{
name|struct
name|usb_device_request
name|req
decl_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_READ_DEVICE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|UR_GET_CONFIG
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
operator|(
name|usbd_do_request
argument_list|(
name|udev
argument_list|,
name|mtx
argument_list|,
operator|&
name|req
argument_list|,
name|pconf
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*------------------------------------------------------------------------*  *	usbd_setup_device_desc  *------------------------------------------------------------------------*/
end_comment

begin_function
name|usb_error_t
name|usbd_setup_device_desc
parameter_list|(
name|struct
name|usb_device
modifier|*
name|udev
parameter_list|,
name|struct
name|mtx
modifier|*
name|mtx
parameter_list|)
block|{
name|usb_error_t
name|err
decl_stmt|;
comment|/* 	 * Get the first 8 bytes of the device descriptor ! 	 * 	 * NOTE: "usbd_do_request()" will check the device descriptor 	 * next time we do a request to see if the maximum packet size 	 * changed! The 8 first bytes of the device descriptor 	 * contains the maximum packet size to use on control endpoint 	 * 0. If this value is different from "USB_MAX_IPACKET" a new 	 * USB control request will be setup! 	 */
switch|switch
condition|(
name|udev
operator|->
name|speed
condition|)
block|{
case|case
name|USB_SPEED_FULL
case|:
case|case
name|USB_SPEED_LOW
case|:
name|err
operator|=
name|usbd_req_get_desc
argument_list|(
name|udev
argument_list|,
name|mtx
argument_list|,
name|NULL
argument_list|,
operator|&
name|udev
operator|->
name|ddesc
argument_list|,
name|USB_MAX_IPACKET
argument_list|,
name|USB_MAX_IPACKET
argument_list|,
literal|0
argument_list|,
name|UDESC_DEVICE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
block|{
name|DPRINTFN
argument_list|(
literal|0
argument_list|,
literal|"getting device descriptor "
literal|"at addr %d failed, %s\n"
argument_list|,
name|udev
operator|->
name|address
argument_list|,
name|usbd_errstr
argument_list|(
name|err
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
break|break;
default|default:
name|DPRINTF
argument_list|(
literal|"Minimum MaxPacketSize is large enough "
literal|"to hold the complete device descriptor\n"
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* get the full device descriptor */
name|err
operator|=
name|usbd_req_get_device_desc
argument_list|(
name|udev
argument_list|,
name|mtx
argument_list|,
operator|&
name|udev
operator|->
name|ddesc
argument_list|)
expr_stmt|;
comment|/* try one more time, if error */
if|if
condition|(
name|err
condition|)
name|err
operator|=
name|usbd_req_get_device_desc
argument_list|(
name|udev
argument_list|,
name|mtx
argument_list|,
operator|&
name|udev
operator|->
name|ddesc
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|DPRINTF
argument_list|(
literal|"addr=%d, getting full desc failed\n"
argument_list|,
name|udev
operator|->
name|address
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
name|DPRINTF
argument_list|(
literal|"adding unit addr=%d, rev=%02x, class=%d, "
literal|"subclass=%d, protocol=%d, maxpacket=%d, len=%d, speed=%d\n"
argument_list|,
name|udev
operator|->
name|address
argument_list|,
name|UGETW
argument_list|(
name|udev
operator|->
name|ddesc
operator|.
name|bcdUSB
argument_list|)
argument_list|,
name|udev
operator|->
name|ddesc
operator|.
name|bDeviceClass
argument_list|,
name|udev
operator|->
name|ddesc
operator|.
name|bDeviceSubClass
argument_list|,
name|udev
operator|->
name|ddesc
operator|.
name|bDeviceProtocol
argument_list|,
name|udev
operator|->
name|ddesc
operator|.
name|bMaxPacketSize
argument_list|,
name|udev
operator|->
name|ddesc
operator|.
name|bLength
argument_list|,
name|udev
operator|->
name|speed
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_comment
comment|/*------------------------------------------------------------------------*  *	usbd_req_re_enumerate  *  * NOTE: After this function returns the hardware is in the  * unconfigured state! The application is responsible for setting a  * new configuration.  *  * Returns:  *    0: Success  * Else: Failure  *------------------------------------------------------------------------*/
end_comment

begin_function
name|usb_error_t
name|usbd_req_re_enumerate
parameter_list|(
name|struct
name|usb_device
modifier|*
name|udev
parameter_list|,
name|struct
name|mtx
modifier|*
name|mtx
parameter_list|)
block|{
name|struct
name|usb_device
modifier|*
name|parent_hub
decl_stmt|;
name|usb_error_t
name|err
decl_stmt|;
name|uint8_t
name|old_addr
decl_stmt|;
name|uint8_t
name|do_retry
init|=
literal|1
decl_stmt|;
if|if
condition|(
name|udev
operator|->
name|flags
operator|.
name|usb_mode
operator|!=
name|USB_MODE_HOST
condition|)
block|{
return|return
operator|(
name|USB_ERR_INVAL
operator|)
return|;
block|}
name|old_addr
operator|=
name|udev
operator|->
name|address
expr_stmt|;
name|parent_hub
operator|=
name|udev
operator|->
name|parent_hub
expr_stmt|;
if|if
condition|(
name|parent_hub
operator|==
name|NULL
condition|)
block|{
return|return
operator|(
name|USB_ERR_INVAL
operator|)
return|;
block|}
name|retry
label|:
name|err
operator|=
name|usbd_req_reset_port
argument_list|(
name|parent_hub
argument_list|,
name|mtx
argument_list|,
name|udev
operator|->
name|port_no
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|DPRINTFN
argument_list|(
literal|0
argument_list|,
literal|"addr=%d, port reset failed, %s\n"
argument_list|,
name|old_addr
argument_list|,
name|usbd_errstr
argument_list|(
name|err
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
comment|/* 	 * After that the port has been reset our device should be at 	 * address zero: 	 */
name|udev
operator|->
name|address
operator|=
name|USB_START_ADDR
expr_stmt|;
comment|/* reset "bMaxPacketSize" */
name|udev
operator|->
name|ddesc
operator|.
name|bMaxPacketSize
operator|=
name|USB_MAX_IPACKET
expr_stmt|;
comment|/* reset USB state */
name|usb_set_device_state
argument_list|(
name|udev
argument_list|,
name|USB_STATE_POWERED
argument_list|)
expr_stmt|;
comment|/* 	 * Restore device address: 	 */
name|err
operator|=
name|usbd_req_set_address
argument_list|(
name|udev
argument_list|,
name|mtx
argument_list|,
name|old_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
comment|/* XXX ignore any errors! */
name|DPRINTFN
argument_list|(
literal|0
argument_list|,
literal|"addr=%d, set address failed! (%s, ignored)\n"
argument_list|,
name|old_addr
argument_list|,
name|usbd_errstr
argument_list|(
name|err
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Restore device address, if the controller driver did not 	 * set a new one: 	 */
if|if
condition|(
name|udev
operator|->
name|address
operator|==
name|USB_START_ADDR
condition|)
name|udev
operator|->
name|address
operator|=
name|old_addr
expr_stmt|;
comment|/* setup the device descriptor and the initial "wMaxPacketSize" */
name|err
operator|=
name|usbd_setup_device_desc
argument_list|(
name|udev
argument_list|,
name|mtx
argument_list|)
expr_stmt|;
name|done
label|:
if|if
condition|(
name|err
operator|&&
name|do_retry
condition|)
block|{
comment|/* give the USB firmware some time to load */
name|usb_pause_mtx
argument_list|(
name|mtx
argument_list|,
name|hz
operator|/
literal|2
argument_list|)
expr_stmt|;
comment|/* no more retries after this retry */
name|do_retry
operator|=
literal|0
expr_stmt|;
comment|/* try again */
goto|goto
name|retry
goto|;
block|}
comment|/* restore address */
if|if
condition|(
name|udev
operator|->
name|address
operator|==
name|USB_START_ADDR
condition|)
name|udev
operator|->
name|address
operator|=
name|old_addr
expr_stmt|;
comment|/* update state, if successful */
if|if
condition|(
name|err
operator|==
literal|0
condition|)
name|usb_set_device_state
argument_list|(
name|udev
argument_list|,
name|USB_STATE_ADDRESSED
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_comment
comment|/*------------------------------------------------------------------------*  *	usbd_req_clear_device_feature  *  * Returns:  *    0: Success  * Else: Failure  *------------------------------------------------------------------------*/
end_comment

begin_function
name|usb_error_t
name|usbd_req_clear_device_feature
parameter_list|(
name|struct
name|usb_device
modifier|*
name|udev
parameter_list|,
name|struct
name|mtx
modifier|*
name|mtx
parameter_list|,
name|uint16_t
name|sel
parameter_list|)
block|{
name|struct
name|usb_device_request
name|req
decl_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_WRITE_DEVICE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|UR_CLEAR_FEATURE
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
name|sel
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|usbd_do_request
argument_list|(
name|udev
argument_list|,
name|mtx
argument_list|,
operator|&
name|req
argument_list|,
literal|0
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*------------------------------------------------------------------------*  *	usbd_req_set_device_feature  *  * Returns:  *    0: Success  * Else: Failure  *------------------------------------------------------------------------*/
end_comment

begin_function
name|usb_error_t
name|usbd_req_set_device_feature
parameter_list|(
name|struct
name|usb_device
modifier|*
name|udev
parameter_list|,
name|struct
name|mtx
modifier|*
name|mtx
parameter_list|,
name|uint16_t
name|sel
parameter_list|)
block|{
name|struct
name|usb_device_request
name|req
decl_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_WRITE_DEVICE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|UR_SET_FEATURE
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
name|sel
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|usbd_do_request
argument_list|(
name|udev
argument_list|,
name|mtx
argument_list|,
operator|&
name|req
argument_list|,
literal|0
argument_list|)
operator|)
return|;
block|}
end_function

end_unit


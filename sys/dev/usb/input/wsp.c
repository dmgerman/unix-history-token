begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2012 Huang Wen Hui  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_include
include|#
directive|include
file|<sys/fcntl.h>
end_include

begin_include
include|#
directive|include
file|<sys/file.h>
end_include

begin_include
include|#
directive|include
file|<sys/selinfo.h>
end_include

begin_include
include|#
directive|include
file|<sys/poll.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usbdi.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usbdi_util.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usbhid.h>
end_include

begin_include
include|#
directive|include
file|"usbdevs.h"
end_include

begin_define
define|#
directive|define
name|USB_DEBUG_VAR
value|wsp_debug
end_define

begin_include
include|#
directive|include
file|<dev/usb/usb_debug.h>
end_include

begin_include
include|#
directive|include
file|<sys/mouse.h>
end_include

begin_define
define|#
directive|define
name|WSP_DRIVER_NAME
value|"wsp"
end_define

begin_define
define|#
directive|define
name|WSP_BUFFER_MAX
value|1024
end_define

begin_define
define|#
directive|define
name|WSP_CLAMP
parameter_list|(
name|x
parameter_list|,
name|low
parameter_list|,
name|high
parameter_list|)
value|do {		\ 	if ((x)< (low))			\ 		(x) = (low);			\ 	else if ((x)> (high))			\ 		(x) = (high);			\ } while (0)
end_define

begin_comment
comment|/* Tunables */
end_comment

begin_expr_stmt
specifier|static
name|SYSCTL_NODE
argument_list|(
name|_hw_usb
argument_list|,
name|OID_AUTO
argument_list|,
name|wsp
argument_list|,
name|CTLFLAG_RW
argument_list|,
literal|0
argument_list|,
literal|"USB wsp"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|USB_DEBUG
end_ifdef

begin_enum
enum|enum
name|wsp_log_level
block|{
name|WSP_LLEVEL_DISABLED
init|=
literal|0
block|,
name|WSP_LLEVEL_ERROR
block|,
name|WSP_LLEVEL_DEBUG
block|,
comment|/* for troubleshooting */
name|WSP_LLEVEL_INFO
block|,
comment|/* for diagnostics */
block|}
enum|;
end_enum

begin_decl_stmt
specifier|static
name|int
name|wsp_debug
init|=
name|WSP_LLEVEL_ERROR
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* the default is to only log errors */
end_comment

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_hw_usb_wsp
argument_list|,
name|OID_AUTO
argument_list|,
name|debug
argument_list|,
name|CTLFLAG_RWTUN
argument_list|,
operator|&
name|wsp_debug
argument_list|,
name|WSP_LLEVEL_ERROR
argument_list|,
literal|"WSP debug level"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* USB_DEBUG */
end_comment

begin_struct
specifier|static
struct|struct
name|wsp_tuning
block|{
name|int
name|scale_factor
decl_stmt|;
name|int
name|z_factor
decl_stmt|;
name|int
name|pressure_touch_threshold
decl_stmt|;
name|int
name|pressure_untouch_threshold
decl_stmt|;
name|int
name|pressure_tap_threshold
decl_stmt|;
name|int
name|scr_hor_threshold
decl_stmt|;
block|}
name|wsp_tuning
init|=
block|{
operator|.
name|scale_factor
operator|=
literal|12
block|,
operator|.
name|z_factor
operator|=
literal|5
block|,
operator|.
name|pressure_touch_threshold
operator|=
literal|50
block|,
operator|.
name|pressure_untouch_threshold
operator|=
literal|10
block|,
operator|.
name|pressure_tap_threshold
operator|=
literal|120
block|,
operator|.
name|scr_hor_threshold
operator|=
literal|20
block|, }
struct|;
end_struct

begin_function
specifier|static
name|void
name|wsp_runing_rangecheck
parameter_list|(
name|struct
name|wsp_tuning
modifier|*
name|ptun
parameter_list|)
block|{
name|WSP_CLAMP
argument_list|(
name|ptun
operator|->
name|scale_factor
argument_list|,
literal|1
argument_list|,
literal|63
argument_list|)
expr_stmt|;
name|WSP_CLAMP
argument_list|(
name|ptun
operator|->
name|z_factor
argument_list|,
literal|1
argument_list|,
literal|63
argument_list|)
expr_stmt|;
name|WSP_CLAMP
argument_list|(
name|ptun
operator|->
name|pressure_touch_threshold
argument_list|,
literal|1
argument_list|,
literal|255
argument_list|)
expr_stmt|;
name|WSP_CLAMP
argument_list|(
name|ptun
operator|->
name|pressure_untouch_threshold
argument_list|,
literal|1
argument_list|,
literal|255
argument_list|)
expr_stmt|;
name|WSP_CLAMP
argument_list|(
name|ptun
operator|->
name|pressure_tap_threshold
argument_list|,
literal|1
argument_list|,
literal|255
argument_list|)
expr_stmt|;
name|WSP_CLAMP
argument_list|(
name|ptun
operator|->
name|scr_hor_threshold
argument_list|,
literal|1
argument_list|,
literal|255
argument_list|)
expr_stmt|;
block|}
end_function

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_hw_usb_wsp
argument_list|,
name|OID_AUTO
argument_list|,
name|scale_factor
argument_list|,
name|CTLFLAG_RWTUN
argument_list|,
operator|&
name|wsp_tuning
operator|.
name|scale_factor
argument_list|,
literal|0
argument_list|,
literal|"movement scale factor"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_hw_usb_wsp
argument_list|,
name|OID_AUTO
argument_list|,
name|z_factor
argument_list|,
name|CTLFLAG_RWTUN
argument_list|,
operator|&
name|wsp_tuning
operator|.
name|z_factor
argument_list|,
literal|0
argument_list|,
literal|"Z-axis scale factor"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_hw_usb_wsp
argument_list|,
name|OID_AUTO
argument_list|,
name|pressure_touch_threshold
argument_list|,
name|CTLFLAG_RWTUN
argument_list|,
operator|&
name|wsp_tuning
operator|.
name|pressure_touch_threshold
argument_list|,
literal|0
argument_list|,
literal|"touch pressure threshold"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_hw_usb_wsp
argument_list|,
name|OID_AUTO
argument_list|,
name|pressure_untouch_threshold
argument_list|,
name|CTLFLAG_RWTUN
argument_list|,
operator|&
name|wsp_tuning
operator|.
name|pressure_untouch_threshold
argument_list|,
literal|0
argument_list|,
literal|"untouch pressure threshold"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_hw_usb_wsp
argument_list|,
name|OID_AUTO
argument_list|,
name|pressure_tap_threshold
argument_list|,
name|CTLFLAG_RWTUN
argument_list|,
operator|&
name|wsp_tuning
operator|.
name|pressure_tap_threshold
argument_list|,
literal|0
argument_list|,
literal|"tap pressure threshold"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_hw_usb_wsp
argument_list|,
name|OID_AUTO
argument_list|,
name|scr_hor_threshold
argument_list|,
name|CTLFLAG_RWTUN
argument_list|,
operator|&
name|wsp_tuning
operator|.
name|scr_hor_threshold
argument_list|,
literal|0
argument_list|,
literal|"horizontal scrolling threshold"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*  * Some tables, structures, definitions and constant values for the  * touchpad protocol has been copied from Linux's  * "drivers/input/mouse/bcm5974.c" which has the following copyright  * holders under GPLv2. All device specific code in this driver has  * been written from scratch. The decoding algorithm is based on  * output from FreeBSD's usbdump.  *  * Copyright (C) 2008      Henrik Rydberg (rydberg@euromail.se)  * Copyright (C) 2008      Scott Shawcroft (scott.shawcroft@gmail.com)  * Copyright (C) 2001-2004 Greg Kroah-Hartman (greg@kroah.com)  * Copyright (C) 2005      Johannes Berg (johannes@sipsolutions.net)  * Copyright (C) 2005      Stelian Pop (stelian@popies.net)  * Copyright (C) 2005      Frank Arnold (frank@scirocco-5v-turbo.de)  * Copyright (C) 2005      Peter Osterlund (petero2@telia.com)  * Copyright (C) 2005      Michael Hanselmann (linux-kernel@hansmi.ch)  * Copyright (C) 2006      Nicolas Boichat (nicolas@boichat.ch)  */
end_comment

begin_comment
comment|/* button data structure */
end_comment

begin_struct
struct|struct
name|bt_data
block|{
name|uint8_t
name|unknown1
decl_stmt|;
comment|/* constant */
name|uint8_t
name|button
decl_stmt|;
comment|/* left button */
name|uint8_t
name|rel_x
decl_stmt|;
comment|/* relative x coordinate */
name|uint8_t
name|rel_y
decl_stmt|;
comment|/* relative y coordinate */
block|}
name|__packed
struct|;
end_struct

begin_comment
comment|/* trackpad header types */
end_comment

begin_enum
enum|enum
name|tp_type
block|{
name|TYPE1
block|,
comment|/* plain trackpad */
name|TYPE2
block|,
comment|/* button integrated in trackpad */
name|TYPE3
block|,
comment|/* additional header fields since June 2013 */
name|TYPE4
comment|/* additional header field for pressure data */
block|}
enum|;
end_enum

begin_comment
comment|/* trackpad finger data offsets, le16-aligned */
end_comment

begin_define
define|#
directive|define
name|FINGER_TYPE1
value|(13 * 2)
end_define

begin_define
define|#
directive|define
name|FINGER_TYPE2
value|(15 * 2)
end_define

begin_define
define|#
directive|define
name|FINGER_TYPE3
value|(19 * 2)
end_define

begin_define
define|#
directive|define
name|FINGER_TYPE4
value|(23 * 2)
end_define

begin_comment
comment|/* trackpad button data offsets */
end_comment

begin_define
define|#
directive|define
name|BUTTON_TYPE2
value|15
end_define

begin_define
define|#
directive|define
name|BUTTON_TYPE3
value|23
end_define

begin_define
define|#
directive|define
name|BUTTON_TYPE4
value|31
end_define

begin_comment
comment|/* list of device capability bits */
end_comment

begin_define
define|#
directive|define
name|HAS_INTEGRATED_BUTTON
value|1
end_define

begin_comment
comment|/* trackpad finger data block size */
end_comment

begin_define
define|#
directive|define
name|FSIZE_TYPE1
value|(14 * 2)
end_define

begin_define
define|#
directive|define
name|FSIZE_TYPE2
value|(14 * 2)
end_define

begin_define
define|#
directive|define
name|FSIZE_TYPE3
value|(14 * 2)
end_define

begin_define
define|#
directive|define
name|FSIZE_TYPE4
value|(15 * 2)
end_define

begin_comment
comment|/* trackpad finger header - little endian */
end_comment

begin_struct
struct|struct
name|tp_header
block|{
name|uint8_t
name|flag
decl_stmt|;
name|uint8_t
name|sn0
decl_stmt|;
name|uint16_t
name|wFixed0
decl_stmt|;
name|uint32_t
name|dwSn1
decl_stmt|;
name|uint32_t
name|dwFixed1
decl_stmt|;
name|uint16_t
name|wLength
decl_stmt|;
name|uint8_t
name|nfinger
decl_stmt|;
name|uint8_t
name|ibt
decl_stmt|;
name|int16_t
name|wUnknown
index|[
literal|6
index|]
decl_stmt|;
name|uint8_t
name|q1
decl_stmt|;
name|uint8_t
name|q2
decl_stmt|;
block|}
name|__packed
struct|;
end_struct

begin_comment
comment|/* trackpad finger structure - little endian */
end_comment

begin_struct
struct|struct
name|tp_finger
block|{
name|int16_t
name|origin
decl_stmt|;
comment|/* zero when switching track finger */
name|int16_t
name|abs_x
decl_stmt|;
comment|/* absolute x coodinate */
name|int16_t
name|abs_y
decl_stmt|;
comment|/* absolute y coodinate */
name|int16_t
name|rel_x
decl_stmt|;
comment|/* relative x coodinate */
name|int16_t
name|rel_y
decl_stmt|;
comment|/* relative y coodinate */
name|int16_t
name|tool_major
decl_stmt|;
comment|/* tool area, major axis */
name|int16_t
name|tool_minor
decl_stmt|;
comment|/* tool area, minor axis */
name|int16_t
name|orientation
decl_stmt|;
comment|/* 16384 when point, else 15 bit angle */
name|int16_t
name|touch_major
decl_stmt|;
comment|/* touch area, major axis */
name|int16_t
name|touch_minor
decl_stmt|;
comment|/* touch area, minor axis */
name|int16_t
name|unused
index|[
literal|2
index|]
decl_stmt|;
comment|/* zeros */
name|int16_t
name|pressure
decl_stmt|;
comment|/* pressure on forcetouch touchpad */
name|int16_t
name|multi
decl_stmt|;
comment|/* one finger: varies, more fingers: 				 	 * constant */
block|}
name|__packed
struct|;
end_struct

begin_comment
comment|/* trackpad finger data size, empirically at least ten fingers */
end_comment

begin_define
define|#
directive|define
name|MAX_FINGERS
value|16
end_define

begin_define
define|#
directive|define
name|SIZEOF_FINGER
value|sizeof(struct tp_finger)
end_define

begin_define
define|#
directive|define
name|SIZEOF_ALL_FINGERS
value|(MAX_FINGERS * SIZEOF_FINGER)
end_define

begin_if
if|#
directive|if
operator|(
name|WSP_BUFFER_MAX
operator|<
operator|(
operator|(
name|MAX_FINGERS
operator|*
name|FSIZE_TYPE4
operator|)
operator|+
name|FINGER_TYPE4
operator|)
operator|)
end_if

begin_error
error|#
directive|error
literal|"WSP_BUFFER_MAX is too small"
end_error

begin_endif
endif|#
directive|endif
end_endif

begin_enum
enum|enum
block|{
name|WSP_FLAG_WELLSPRING1
block|,
name|WSP_FLAG_WELLSPRING2
block|,
name|WSP_FLAG_WELLSPRING3
block|,
name|WSP_FLAG_WELLSPRING4
block|,
name|WSP_FLAG_WELLSPRING4A
block|,
name|WSP_FLAG_WELLSPRING5
block|,
name|WSP_FLAG_WELLSPRING6A
block|,
name|WSP_FLAG_WELLSPRING6
block|,
name|WSP_FLAG_WELLSPRING5A
block|,
name|WSP_FLAG_WELLSPRING7
block|,
name|WSP_FLAG_WELLSPRING7A
block|,
name|WSP_FLAG_WELLSPRING8
block|,
name|WSP_FLAG_WELLSPRING9
block|,
name|WSP_FLAG_MAX
block|, }
enum|;
end_enum

begin_comment
comment|/* device-specific configuration */
end_comment

begin_struct
struct|struct
name|wsp_dev_params
block|{
name|uint8_t
name|caps
decl_stmt|;
comment|/* device capability bitmask */
name|uint8_t
name|tp_type
decl_stmt|;
comment|/* type of trackpad interface */
name|uint8_t
name|tp_button
decl_stmt|;
comment|/* offset to button data */
name|uint8_t
name|tp_offset
decl_stmt|;
comment|/* offset to trackpad finger data */
name|uint8_t
name|tp_fsize
decl_stmt|;
comment|/* bytes in single finger block */
name|uint8_t
name|tp_delta
decl_stmt|;
comment|/* offset from header to finger struct */
name|uint8_t
name|iface_index
decl_stmt|;
name|uint8_t
name|um_size
decl_stmt|;
comment|/* usb control message length */
name|uint8_t
name|um_req_val
decl_stmt|;
comment|/* usb control message value */
name|uint8_t
name|um_req_idx
decl_stmt|;
comment|/* usb control message index */
name|uint8_t
name|um_switch_idx
decl_stmt|;
comment|/* usb control message mode switch index */
name|uint8_t
name|um_switch_on
decl_stmt|;
comment|/* usb control message mode switch on */
name|uint8_t
name|um_switch_off
decl_stmt|;
comment|/* usb control message mode switch off */
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|wsp_dev_params
name|wsp_dev_params
index|[
name|WSP_FLAG_MAX
index|]
init|=
block|{
index|[
name|WSP_FLAG_WELLSPRING1
index|]
operator|=
block|{
operator|.
name|caps
operator|=
literal|0
block|,
operator|.
name|tp_type
operator|=
name|TYPE1
block|,
operator|.
name|tp_button
operator|=
literal|0
block|,
operator|.
name|tp_offset
operator|=
name|FINGER_TYPE1
block|,
operator|.
name|tp_fsize
operator|=
name|FSIZE_TYPE1
block|,
operator|.
name|tp_delta
operator|=
literal|0
block|,
operator|.
name|iface_index
operator|=
literal|0
block|,
operator|.
name|um_size
operator|=
literal|8
block|,
operator|.
name|um_req_val
operator|=
literal|0x03
block|,
operator|.
name|um_req_idx
operator|=
literal|0x00
block|,
operator|.
name|um_switch_idx
operator|=
literal|0
block|,
operator|.
name|um_switch_on
operator|=
literal|0x01
block|,
operator|.
name|um_switch_off
operator|=
literal|0x08
block|, 	}
block|,
index|[
name|WSP_FLAG_WELLSPRING2
index|]
operator|=
block|{
operator|.
name|caps
operator|=
literal|0
block|,
operator|.
name|tp_type
operator|=
name|TYPE1
block|,
operator|.
name|tp_button
operator|=
literal|0
block|,
operator|.
name|tp_offset
operator|=
name|FINGER_TYPE1
block|,
operator|.
name|tp_fsize
operator|=
name|FSIZE_TYPE1
block|,
operator|.
name|tp_delta
operator|=
literal|0
block|,
operator|.
name|iface_index
operator|=
literal|0
block|,
operator|.
name|um_size
operator|=
literal|8
block|,
operator|.
name|um_req_val
operator|=
literal|0x03
block|,
operator|.
name|um_req_idx
operator|=
literal|0x00
block|,
operator|.
name|um_switch_idx
operator|=
literal|0
block|,
operator|.
name|um_switch_on
operator|=
literal|0x01
block|,
operator|.
name|um_switch_off
operator|=
literal|0x08
block|, 	}
block|,
index|[
name|WSP_FLAG_WELLSPRING3
index|]
operator|=
block|{
operator|.
name|caps
operator|=
name|HAS_INTEGRATED_BUTTON
block|,
operator|.
name|tp_type
operator|=
name|TYPE2
block|,
operator|.
name|tp_button
operator|=
name|BUTTON_TYPE2
block|,
operator|.
name|tp_offset
operator|=
name|FINGER_TYPE2
block|,
operator|.
name|tp_fsize
operator|=
name|FSIZE_TYPE2
block|,
operator|.
name|tp_delta
operator|=
literal|0
block|,
operator|.
name|iface_index
operator|=
literal|0
block|,
operator|.
name|um_size
operator|=
literal|8
block|,
operator|.
name|um_req_val
operator|=
literal|0x03
block|,
operator|.
name|um_req_idx
operator|=
literal|0x00
block|,
operator|.
name|um_switch_idx
operator|=
literal|0
block|,
operator|.
name|um_switch_on
operator|=
literal|0x01
block|,
operator|.
name|um_switch_off
operator|=
literal|0x08
block|, 	}
block|,
index|[
name|WSP_FLAG_WELLSPRING4
index|]
operator|=
block|{
operator|.
name|caps
operator|=
name|HAS_INTEGRATED_BUTTON
block|,
operator|.
name|tp_type
operator|=
name|TYPE2
block|,
operator|.
name|tp_button
operator|=
name|BUTTON_TYPE2
block|,
operator|.
name|tp_offset
operator|=
name|FINGER_TYPE2
block|,
operator|.
name|tp_fsize
operator|=
name|FSIZE_TYPE2
block|,
operator|.
name|tp_delta
operator|=
literal|0
block|,
operator|.
name|iface_index
operator|=
literal|0
block|,
operator|.
name|um_size
operator|=
literal|8
block|,
operator|.
name|um_req_val
operator|=
literal|0x03
block|,
operator|.
name|um_req_idx
operator|=
literal|0x00
block|,
operator|.
name|um_switch_idx
operator|=
literal|0
block|,
operator|.
name|um_switch_on
operator|=
literal|0x01
block|,
operator|.
name|um_switch_off
operator|=
literal|0x08
block|, 	}
block|,
index|[
name|WSP_FLAG_WELLSPRING4A
index|]
operator|=
block|{
operator|.
name|caps
operator|=
name|HAS_INTEGRATED_BUTTON
block|,
operator|.
name|tp_type
operator|=
name|TYPE2
block|,
operator|.
name|tp_button
operator|=
name|BUTTON_TYPE2
block|,
operator|.
name|tp_offset
operator|=
name|FINGER_TYPE2
block|,
operator|.
name|tp_fsize
operator|=
name|FSIZE_TYPE2
block|,
operator|.
name|tp_delta
operator|=
literal|0
block|,
operator|.
name|iface_index
operator|=
literal|0
block|,
operator|.
name|um_size
operator|=
literal|8
block|,
operator|.
name|um_req_val
operator|=
literal|0x03
block|,
operator|.
name|um_req_idx
operator|=
literal|0x00
block|,
operator|.
name|um_switch_idx
operator|=
literal|0
block|,
operator|.
name|um_switch_on
operator|=
literal|0x01
block|,
operator|.
name|um_switch_off
operator|=
literal|0x08
block|, 	}
block|,
index|[
name|WSP_FLAG_WELLSPRING5
index|]
operator|=
block|{
operator|.
name|caps
operator|=
name|HAS_INTEGRATED_BUTTON
block|,
operator|.
name|tp_type
operator|=
name|TYPE2
block|,
operator|.
name|tp_button
operator|=
name|BUTTON_TYPE2
block|,
operator|.
name|tp_offset
operator|=
name|FINGER_TYPE2
block|,
operator|.
name|tp_fsize
operator|=
name|FSIZE_TYPE2
block|,
operator|.
name|tp_delta
operator|=
literal|0
block|,
operator|.
name|iface_index
operator|=
literal|0
block|,
operator|.
name|um_size
operator|=
literal|8
block|,
operator|.
name|um_req_val
operator|=
literal|0x03
block|,
operator|.
name|um_req_idx
operator|=
literal|0x00
block|,
operator|.
name|um_switch_idx
operator|=
literal|0
block|,
operator|.
name|um_switch_on
operator|=
literal|0x01
block|,
operator|.
name|um_switch_off
operator|=
literal|0x08
block|, 	}
block|,
index|[
name|WSP_FLAG_WELLSPRING6
index|]
operator|=
block|{
operator|.
name|caps
operator|=
name|HAS_INTEGRATED_BUTTON
block|,
operator|.
name|tp_type
operator|=
name|TYPE2
block|,
operator|.
name|tp_button
operator|=
name|BUTTON_TYPE2
block|,
operator|.
name|tp_offset
operator|=
name|FINGER_TYPE2
block|,
operator|.
name|tp_fsize
operator|=
name|FSIZE_TYPE2
block|,
operator|.
name|tp_delta
operator|=
literal|0
block|,
operator|.
name|iface_index
operator|=
literal|0
block|,
operator|.
name|um_size
operator|=
literal|8
block|,
operator|.
name|um_req_val
operator|=
literal|0x03
block|,
operator|.
name|um_req_idx
operator|=
literal|0x00
block|,
operator|.
name|um_switch_idx
operator|=
literal|0
block|,
operator|.
name|um_switch_on
operator|=
literal|0x01
block|,
operator|.
name|um_switch_off
operator|=
literal|0x08
block|, 	}
block|,
index|[
name|WSP_FLAG_WELLSPRING5A
index|]
operator|=
block|{
operator|.
name|caps
operator|=
name|HAS_INTEGRATED_BUTTON
block|,
operator|.
name|tp_type
operator|=
name|TYPE2
block|,
operator|.
name|tp_button
operator|=
name|BUTTON_TYPE2
block|,
operator|.
name|tp_offset
operator|=
name|FINGER_TYPE2
block|,
operator|.
name|tp_fsize
operator|=
name|FSIZE_TYPE2
block|,
operator|.
name|tp_delta
operator|=
literal|0
block|,
operator|.
name|iface_index
operator|=
literal|0
block|,
operator|.
name|um_size
operator|=
literal|8
block|,
operator|.
name|um_req_val
operator|=
literal|0x03
block|,
operator|.
name|um_req_idx
operator|=
literal|0x00
block|,
operator|.
name|um_switch_idx
operator|=
literal|0
block|,
operator|.
name|um_switch_on
operator|=
literal|0x01
block|,
operator|.
name|um_switch_off
operator|=
literal|0x08
block|, 	}
block|,
index|[
name|WSP_FLAG_WELLSPRING6A
index|]
operator|=
block|{
operator|.
name|caps
operator|=
name|HAS_INTEGRATED_BUTTON
block|,
operator|.
name|tp_type
operator|=
name|TYPE2
block|,
operator|.
name|tp_button
operator|=
name|BUTTON_TYPE2
block|,
operator|.
name|tp_offset
operator|=
name|FINGER_TYPE2
block|,
operator|.
name|tp_fsize
operator|=
name|FSIZE_TYPE2
block|,
operator|.
name|tp_delta
operator|=
literal|0
block|,
operator|.
name|um_size
operator|=
literal|8
block|,
operator|.
name|um_req_val
operator|=
literal|0x03
block|,
operator|.
name|um_req_idx
operator|=
literal|0x00
block|,
operator|.
name|um_switch_idx
operator|=
literal|0
block|,
operator|.
name|um_switch_on
operator|=
literal|0x01
block|,
operator|.
name|um_switch_off
operator|=
literal|0x08
block|, 	}
block|,
index|[
name|WSP_FLAG_WELLSPRING7
index|]
operator|=
block|{
operator|.
name|caps
operator|=
name|HAS_INTEGRATED_BUTTON
block|,
operator|.
name|tp_type
operator|=
name|TYPE2
block|,
operator|.
name|tp_button
operator|=
name|BUTTON_TYPE2
block|,
operator|.
name|tp_offset
operator|=
name|FINGER_TYPE2
block|,
operator|.
name|tp_fsize
operator|=
name|FSIZE_TYPE2
block|,
operator|.
name|tp_delta
operator|=
literal|0
block|,
operator|.
name|iface_index
operator|=
literal|0
block|,
operator|.
name|um_size
operator|=
literal|8
block|,
operator|.
name|um_req_val
operator|=
literal|0x03
block|,
operator|.
name|um_req_idx
operator|=
literal|0x00
block|,
operator|.
name|um_switch_idx
operator|=
literal|0
block|,
operator|.
name|um_switch_on
operator|=
literal|0x01
block|,
operator|.
name|um_switch_off
operator|=
literal|0x08
block|, 	}
block|,
index|[
name|WSP_FLAG_WELLSPRING7A
index|]
operator|=
block|{
operator|.
name|caps
operator|=
name|HAS_INTEGRATED_BUTTON
block|,
operator|.
name|tp_type
operator|=
name|TYPE2
block|,
operator|.
name|tp_button
operator|=
name|BUTTON_TYPE2
block|,
operator|.
name|tp_offset
operator|=
name|FINGER_TYPE2
block|,
operator|.
name|tp_fsize
operator|=
name|FSIZE_TYPE2
block|,
operator|.
name|tp_delta
operator|=
literal|0
block|,
operator|.
name|iface_index
operator|=
literal|0
block|,
operator|.
name|um_size
operator|=
literal|8
block|,
operator|.
name|um_req_val
operator|=
literal|0x03
block|,
operator|.
name|um_req_idx
operator|=
literal|0x00
block|,
operator|.
name|um_switch_idx
operator|=
literal|0
block|,
operator|.
name|um_switch_on
operator|=
literal|0x01
block|,
operator|.
name|um_switch_off
operator|=
literal|0x08
block|, 	}
block|,
index|[
name|WSP_FLAG_WELLSPRING8
index|]
operator|=
block|{
operator|.
name|caps
operator|=
name|HAS_INTEGRATED_BUTTON
block|,
operator|.
name|tp_type
operator|=
name|TYPE3
block|,
operator|.
name|tp_button
operator|=
name|BUTTON_TYPE3
block|,
operator|.
name|tp_offset
operator|=
name|FINGER_TYPE3
block|,
operator|.
name|tp_fsize
operator|=
name|FSIZE_TYPE3
block|,
operator|.
name|tp_delta
operator|=
literal|0
block|,
operator|.
name|iface_index
operator|=
literal|0
block|,
operator|.
name|um_size
operator|=
literal|8
block|,
operator|.
name|um_req_val
operator|=
literal|0x03
block|,
operator|.
name|um_req_idx
operator|=
literal|0x00
block|,
operator|.
name|um_switch_idx
operator|=
literal|0
block|,
operator|.
name|um_switch_on
operator|=
literal|0x01
block|,
operator|.
name|um_switch_off
operator|=
literal|0x08
block|, 	}
block|,
index|[
name|WSP_FLAG_WELLSPRING9
index|]
operator|=
block|{
operator|.
name|caps
operator|=
name|HAS_INTEGRATED_BUTTON
block|,
operator|.
name|tp_type
operator|=
name|TYPE4
block|,
operator|.
name|tp_button
operator|=
name|BUTTON_TYPE4
block|,
operator|.
name|tp_offset
operator|=
name|FINGER_TYPE4
block|,
operator|.
name|tp_fsize
operator|=
name|FSIZE_TYPE4
block|,
operator|.
name|tp_delta
operator|=
literal|2
block|,
operator|.
name|iface_index
operator|=
literal|2
block|,
operator|.
name|um_size
operator|=
literal|2
block|,
operator|.
name|um_req_val
operator|=
literal|0x03
block|,
operator|.
name|um_req_idx
operator|=
literal|0x02
block|,
operator|.
name|um_switch_idx
operator|=
literal|1
block|,
operator|.
name|um_switch_on
operator|=
literal|0x01
block|,
operator|.
name|um_switch_off
operator|=
literal|0x00
block|, 	}
block|, }
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|WSP_DEV
parameter_list|(
name|v
parameter_list|,
name|p
parameter_list|,
name|i
parameter_list|)
value|{ USB_VPI(USB_VENDOR_##v, USB_PRODUCT_##v##_##p, i) }
end_define

begin_decl_stmt
specifier|static
specifier|const
name|STRUCT_USB_HOST_ID
name|wsp_devs
index|[]
init|=
block|{
comment|/* MacbookAir1.1 */
name|WSP_DEV
argument_list|(
name|APPLE
argument_list|,
name|WELLSPRING_ANSI
argument_list|,
name|WSP_FLAG_WELLSPRING1
argument_list|)
block|,
name|WSP_DEV
argument_list|(
name|APPLE
argument_list|,
name|WELLSPRING_ISO
argument_list|,
name|WSP_FLAG_WELLSPRING1
argument_list|)
block|,
name|WSP_DEV
argument_list|(
name|APPLE
argument_list|,
name|WELLSPRING_JIS
argument_list|,
name|WSP_FLAG_WELLSPRING1
argument_list|)
block|,
comment|/* MacbookProPenryn, aka wellspring2 */
name|WSP_DEV
argument_list|(
name|APPLE
argument_list|,
name|WELLSPRING2_ANSI
argument_list|,
name|WSP_FLAG_WELLSPRING2
argument_list|)
block|,
name|WSP_DEV
argument_list|(
name|APPLE
argument_list|,
name|WELLSPRING2_ISO
argument_list|,
name|WSP_FLAG_WELLSPRING2
argument_list|)
block|,
name|WSP_DEV
argument_list|(
name|APPLE
argument_list|,
name|WELLSPRING2_JIS
argument_list|,
name|WSP_FLAG_WELLSPRING2
argument_list|)
block|,
comment|/* Macbook5,1 (unibody), aka wellspring3 */
name|WSP_DEV
argument_list|(
name|APPLE
argument_list|,
name|WELLSPRING3_ANSI
argument_list|,
name|WSP_FLAG_WELLSPRING3
argument_list|)
block|,
name|WSP_DEV
argument_list|(
name|APPLE
argument_list|,
name|WELLSPRING3_ISO
argument_list|,
name|WSP_FLAG_WELLSPRING3
argument_list|)
block|,
name|WSP_DEV
argument_list|(
name|APPLE
argument_list|,
name|WELLSPRING3_JIS
argument_list|,
name|WSP_FLAG_WELLSPRING3
argument_list|)
block|,
comment|/* MacbookAir3,2 (unibody), aka wellspring4 */
name|WSP_DEV
argument_list|(
name|APPLE
argument_list|,
name|WELLSPRING4_ANSI
argument_list|,
name|WSP_FLAG_WELLSPRING4
argument_list|)
block|,
name|WSP_DEV
argument_list|(
name|APPLE
argument_list|,
name|WELLSPRING4_ISO
argument_list|,
name|WSP_FLAG_WELLSPRING4
argument_list|)
block|,
name|WSP_DEV
argument_list|(
name|APPLE
argument_list|,
name|WELLSPRING4_JIS
argument_list|,
name|WSP_FLAG_WELLSPRING4
argument_list|)
block|,
comment|/* MacbookAir3,1 (unibody), aka wellspring4 */
name|WSP_DEV
argument_list|(
name|APPLE
argument_list|,
name|WELLSPRING4A_ANSI
argument_list|,
name|WSP_FLAG_WELLSPRING4A
argument_list|)
block|,
name|WSP_DEV
argument_list|(
name|APPLE
argument_list|,
name|WELLSPRING4A_ISO
argument_list|,
name|WSP_FLAG_WELLSPRING4A
argument_list|)
block|,
name|WSP_DEV
argument_list|(
name|APPLE
argument_list|,
name|WELLSPRING4A_JIS
argument_list|,
name|WSP_FLAG_WELLSPRING4A
argument_list|)
block|,
comment|/* Macbook8 (unibody, March 2011) */
name|WSP_DEV
argument_list|(
name|APPLE
argument_list|,
name|WELLSPRING5_ANSI
argument_list|,
name|WSP_FLAG_WELLSPRING5
argument_list|)
block|,
name|WSP_DEV
argument_list|(
name|APPLE
argument_list|,
name|WELLSPRING5_ISO
argument_list|,
name|WSP_FLAG_WELLSPRING5
argument_list|)
block|,
name|WSP_DEV
argument_list|(
name|APPLE
argument_list|,
name|WELLSPRING5_JIS
argument_list|,
name|WSP_FLAG_WELLSPRING5
argument_list|)
block|,
comment|/* MacbookAir4,1 (unibody, July 2011) */
name|WSP_DEV
argument_list|(
name|APPLE
argument_list|,
name|WELLSPRING6A_ANSI
argument_list|,
name|WSP_FLAG_WELLSPRING6A
argument_list|)
block|,
name|WSP_DEV
argument_list|(
name|APPLE
argument_list|,
name|WELLSPRING6A_ISO
argument_list|,
name|WSP_FLAG_WELLSPRING6A
argument_list|)
block|,
name|WSP_DEV
argument_list|(
name|APPLE
argument_list|,
name|WELLSPRING6A_JIS
argument_list|,
name|WSP_FLAG_WELLSPRING6A
argument_list|)
block|,
comment|/* MacbookAir4,2 (unibody, July 2011) */
name|WSP_DEV
argument_list|(
name|APPLE
argument_list|,
name|WELLSPRING6_ANSI
argument_list|,
name|WSP_FLAG_WELLSPRING6
argument_list|)
block|,
name|WSP_DEV
argument_list|(
name|APPLE
argument_list|,
name|WELLSPRING6_ISO
argument_list|,
name|WSP_FLAG_WELLSPRING6
argument_list|)
block|,
name|WSP_DEV
argument_list|(
name|APPLE
argument_list|,
name|WELLSPRING6_JIS
argument_list|,
name|WSP_FLAG_WELLSPRING6
argument_list|)
block|,
comment|/* Macbook8,2 (unibody) */
name|WSP_DEV
argument_list|(
name|APPLE
argument_list|,
name|WELLSPRING5A_ANSI
argument_list|,
name|WSP_FLAG_WELLSPRING5A
argument_list|)
block|,
name|WSP_DEV
argument_list|(
name|APPLE
argument_list|,
name|WELLSPRING5A_ISO
argument_list|,
name|WSP_FLAG_WELLSPRING5A
argument_list|)
block|,
name|WSP_DEV
argument_list|(
name|APPLE
argument_list|,
name|WELLSPRING5A_JIS
argument_list|,
name|WSP_FLAG_WELLSPRING5A
argument_list|)
block|,
comment|/* MacbookPro10,1 (unibody, June 2012) */
comment|/* MacbookPro11,1-3 (unibody, June 2013) */
name|WSP_DEV
argument_list|(
name|APPLE
argument_list|,
name|WELLSPRING7_ANSI
argument_list|,
name|WSP_FLAG_WELLSPRING7
argument_list|)
block|,
name|WSP_DEV
argument_list|(
name|APPLE
argument_list|,
name|WELLSPRING7_ISO
argument_list|,
name|WSP_FLAG_WELLSPRING7
argument_list|)
block|,
name|WSP_DEV
argument_list|(
name|APPLE
argument_list|,
name|WELLSPRING7_JIS
argument_list|,
name|WSP_FLAG_WELLSPRING7
argument_list|)
block|,
comment|/* MacbookPro10,2 (unibody, October 2012) */
name|WSP_DEV
argument_list|(
name|APPLE
argument_list|,
name|WELLSPRING7A_ANSI
argument_list|,
name|WSP_FLAG_WELLSPRING7A
argument_list|)
block|,
name|WSP_DEV
argument_list|(
name|APPLE
argument_list|,
name|WELLSPRING7A_ISO
argument_list|,
name|WSP_FLAG_WELLSPRING7A
argument_list|)
block|,
name|WSP_DEV
argument_list|(
name|APPLE
argument_list|,
name|WELLSPRING7A_JIS
argument_list|,
name|WSP_FLAG_WELLSPRING7A
argument_list|)
block|,
comment|/* MacbookAir6,2 (unibody, June 2013) */
name|WSP_DEV
argument_list|(
name|APPLE
argument_list|,
name|WELLSPRING8_ANSI
argument_list|,
name|WSP_FLAG_WELLSPRING8
argument_list|)
block|,
name|WSP_DEV
argument_list|(
name|APPLE
argument_list|,
name|WELLSPRING8_ISO
argument_list|,
name|WSP_FLAG_WELLSPRING8
argument_list|)
block|,
name|WSP_DEV
argument_list|(
name|APPLE
argument_list|,
name|WELLSPRING8_JIS
argument_list|,
name|WSP_FLAG_WELLSPRING8
argument_list|)
block|,
comment|/* MacbookPro12,1 MacbookPro11,4 */
name|WSP_DEV
argument_list|(
name|APPLE
argument_list|,
name|WELLSPRING9_ANSI
argument_list|,
name|WSP_FLAG_WELLSPRING9
argument_list|)
block|,
name|WSP_DEV
argument_list|(
name|APPLE
argument_list|,
name|WELLSPRING9_ISO
argument_list|,
name|WSP_FLAG_WELLSPRING9
argument_list|)
block|,
name|WSP_DEV
argument_list|(
name|APPLE
argument_list|,
name|WELLSPRING9_JIS
argument_list|,
name|WSP_FLAG_WELLSPRING9
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|WSP_FIFO_BUF_SIZE
value|8
end_define

begin_comment
comment|/* bytes */
end_comment

begin_define
define|#
directive|define
name|WSP_FIFO_QUEUE_MAXLEN
value|50
end_define

begin_comment
comment|/* units */
end_comment

begin_enum
enum|enum
block|{
name|WSP_INTR_DT
block|,
name|WSP_N_TRANSFER
block|, }
enum|;
end_enum

begin_struct
struct|struct
name|wsp_softc
block|{
name|struct
name|usb_device
modifier|*
name|sc_usb_device
decl_stmt|;
name|struct
name|mtx
name|sc_mutex
decl_stmt|;
comment|/* for synchronization */
name|struct
name|usb_xfer
modifier|*
name|sc_xfer
index|[
name|WSP_N_TRANSFER
index|]
decl_stmt|;
name|struct
name|usb_fifo_sc
name|sc_fifo
decl_stmt|;
specifier|const
name|struct
name|wsp_dev_params
modifier|*
name|sc_params
decl_stmt|;
comment|/* device configuration */
name|mousehw_t
name|sc_hw
decl_stmt|;
name|mousemode_t
name|sc_mode
decl_stmt|;
name|u_int
name|sc_pollrate
decl_stmt|;
name|mousestatus_t
name|sc_status
decl_stmt|;
name|u_int
name|sc_state
decl_stmt|;
define|#
directive|define
name|WSP_ENABLED
value|0x01
name|struct
name|tp_finger
modifier|*
name|index
index|[
name|MAX_FINGERS
index|]
decl_stmt|;
comment|/* finger index data */
name|int16_t
name|pos_x
index|[
name|MAX_FINGERS
index|]
decl_stmt|;
comment|/* position array */
name|int16_t
name|pos_y
index|[
name|MAX_FINGERS
index|]
decl_stmt|;
comment|/* position array */
name|u_int
name|sc_touch
decl_stmt|;
comment|/* touch status */
define|#
directive|define
name|WSP_UNTOUCH
value|0x00
define|#
directive|define
name|WSP_FIRST_TOUCH
value|0x01
define|#
directive|define
name|WSP_SECOND_TOUCH
value|0x02
define|#
directive|define
name|WSP_TOUCHING
value|0x04
name|int16_t
name|pre_pos_x
decl_stmt|;
comment|/* previous position array */
name|int16_t
name|pre_pos_y
decl_stmt|;
comment|/* previous position array */
name|int
name|dx_sum
decl_stmt|;
comment|/* x axis cumulative movement */
name|int
name|dy_sum
decl_stmt|;
comment|/* y axis cumulative movement */
name|int
name|dz_sum
decl_stmt|;
comment|/* z axis cumulative movement */
name|int
name|dz_count
decl_stmt|;
define|#
directive|define
name|WSP_DZ_MAX_COUNT
value|32
name|int
name|dt_sum
decl_stmt|;
comment|/* T-axis cumulative movement */
name|int
name|rdx
decl_stmt|;
comment|/* x axis remainder of divide by scale_factor */
name|int
name|rdy
decl_stmt|;
comment|/* y axis remainder of divide by scale_factor */
name|int
name|rdz
decl_stmt|;
comment|/* z axis remainder of divide by scale_factor */
name|int
name|tp_datalen
decl_stmt|;
name|uint8_t
name|o_ntouch
decl_stmt|;
comment|/* old touch finger status */
name|uint8_t
name|finger
decl_stmt|;
comment|/* 0 or 1 *, check which finger moving */
name|uint16_t
name|intr_count
decl_stmt|;
define|#
directive|define
name|WSP_TAP_THRESHOLD
value|3
define|#
directive|define
name|WSP_TAP_MAX_COUNT
value|20
name|int
name|distance
decl_stmt|;
comment|/* the distance of 2 fingers */
define|#
directive|define
name|MAX_DISTANCE
value|2500
comment|/* the max allowed distance */
name|uint8_t
name|ibtn
decl_stmt|;
comment|/* button status in tapping */
name|uint8_t
name|ntaps
decl_stmt|;
comment|/* finger status in tapping */
name|uint8_t
name|scr_mode
decl_stmt|;
comment|/* scroll status in movement */
define|#
directive|define
name|WSP_SCR_NONE
value|0
define|#
directive|define
name|WSP_SCR_VER
value|1
define|#
directive|define
name|WSP_SCR_HOR
value|2
name|uint8_t
name|tp_data
index|[
name|WSP_BUFFER_MAX
index|]
name|__aligned
argument_list|(
literal|4
argument_list|)
decl_stmt|;
comment|/* trackpad transferred data */
block|}
struct|;
end_struct

begin_comment
comment|/*  * function prototypes  */
end_comment

begin_decl_stmt
specifier|static
name|usb_fifo_cmd_t
name|wsp_start_read
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|usb_fifo_cmd_t
name|wsp_stop_read
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|usb_fifo_open_t
name|wsp_open
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|usb_fifo_close_t
name|wsp_close
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|usb_fifo_ioctl_t
name|wsp_ioctl
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|usb_fifo_methods
name|wsp_fifo_methods
init|=
block|{
operator|.
name|f_open
operator|=
operator|&
name|wsp_open
block|,
operator|.
name|f_close
operator|=
operator|&
name|wsp_close
block|,
operator|.
name|f_ioctl
operator|=
operator|&
name|wsp_ioctl
block|,
operator|.
name|f_start_read
operator|=
operator|&
name|wsp_start_read
block|,
operator|.
name|f_stop_read
operator|=
operator|&
name|wsp_stop_read
block|,
operator|.
name|basename
index|[
literal|0
index|]
operator|=
name|WSP_DRIVER_NAME
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* device initialization and shutdown */
end_comment

begin_function_decl
specifier|static
name|int
name|wsp_enable
parameter_list|(
name|struct
name|wsp_softc
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|wsp_disable
parameter_list|(
name|struct
name|wsp_softc
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* updating fifo */
end_comment

begin_function_decl
specifier|static
name|void
name|wsp_reset_buf
parameter_list|(
name|struct
name|wsp_softc
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|wsp_add_to_queue
parameter_list|(
name|struct
name|wsp_softc
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* Device methods. */
end_comment

begin_decl_stmt
specifier|static
name|device_probe_t
name|wsp_probe
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|device_attach_t
name|wsp_attach
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|device_detach_t
name|wsp_detach
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|usb_callback_t
name|wsp_intr_callback
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|usb_config
name|wsp_config
index|[
name|WSP_N_TRANSFER
index|]
init|=
block|{
index|[
name|WSP_INTR_DT
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|UE_INTERRUPT
block|,
operator|.
name|endpoint
operator|=
name|UE_ADDR_ANY
block|,
operator|.
name|direction
operator|=
name|UE_DIR_IN
block|,
operator|.
name|flags
operator|=
block|{
operator|.
name|pipe_bof
operator|=
literal|0
block|,
operator|.
name|short_xfer_ok
operator|=
literal|1
block|, 		}
block|,
operator|.
name|bufsize
operator|=
name|WSP_BUFFER_MAX
block|,
operator|.
name|callback
operator|=
operator|&
name|wsp_intr_callback
block|, 	}
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|usb_error_t
name|wsp_set_device_mode
parameter_list|(
name|struct
name|wsp_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|on
parameter_list|)
block|{
specifier|const
name|struct
name|wsp_dev_params
modifier|*
name|params
init|=
name|sc
operator|->
name|sc_params
decl_stmt|;
name|uint8_t
name|mode_bytes
index|[
literal|8
index|]
decl_stmt|;
name|usb_error_t
name|err
decl_stmt|;
comment|/* Type 3 does not require a mode switch */
if|if
condition|(
name|params
operator|->
name|tp_type
operator|==
name|TYPE3
condition|)
return|return
literal|0
return|;
name|err
operator|=
name|usbd_req_get_report
argument_list|(
name|sc
operator|->
name|sc_usb_device
argument_list|,
name|NULL
argument_list|,
name|mode_bytes
argument_list|,
name|params
operator|->
name|um_size
argument_list|,
name|params
operator|->
name|iface_index
argument_list|,
name|params
operator|->
name|um_req_val
argument_list|,
name|params
operator|->
name|um_req_idx
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|USB_ERR_NORMAL_COMPLETION
condition|)
block|{
name|DPRINTF
argument_list|(
literal|"Failed to read device mode (%d)\n"
argument_list|,
name|err
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
comment|/* 	 * XXX Need to wait at least 250ms for hardware to get 	 * ready. The device mode handling appears to be handled 	 * asynchronously and we should not issue these commands too 	 * quickly. 	 */
name|pause
argument_list|(
literal|"WHW"
argument_list|,
name|hz
operator|/
literal|4
argument_list|)
expr_stmt|;
name|mode_bytes
index|[
name|params
operator|->
name|um_switch_idx
index|]
operator|=
name|on
condition|?
name|params
operator|->
name|um_switch_on
else|:
name|params
operator|->
name|um_switch_off
expr_stmt|;
return|return
operator|(
name|usbd_req_set_report
argument_list|(
name|sc
operator|->
name|sc_usb_device
argument_list|,
name|NULL
argument_list|,
name|mode_bytes
argument_list|,
name|params
operator|->
name|um_size
argument_list|,
name|params
operator|->
name|iface_index
argument_list|,
name|params
operator|->
name|um_req_val
argument_list|,
name|params
operator|->
name|um_req_idx
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wsp_enable
parameter_list|(
name|struct
name|wsp_softc
modifier|*
name|sc
parameter_list|)
block|{
comment|/* reset status */
name|memset
argument_list|(
operator|&
name|sc
operator|->
name|sc_status
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|sc_status
argument_list|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_state
operator||=
name|WSP_ENABLED
expr_stmt|;
name|DPRINTFN
argument_list|(
name|WSP_LLEVEL_INFO
argument_list|,
literal|"enabled wsp\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wsp_disable
parameter_list|(
name|struct
name|wsp_softc
modifier|*
name|sc
parameter_list|)
block|{
name|sc
operator|->
name|sc_state
operator|&=
operator|~
name|WSP_ENABLED
expr_stmt|;
name|DPRINTFN
argument_list|(
name|WSP_LLEVEL_INFO
argument_list|,
literal|"disabled wsp\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wsp_probe
parameter_list|(
name|device_t
name|self
parameter_list|)
block|{
name|struct
name|usb_attach_arg
modifier|*
name|uaa
init|=
name|device_get_ivars
argument_list|(
name|self
argument_list|)
decl_stmt|;
name|struct
name|usb_interface_descriptor
modifier|*
name|id
decl_stmt|;
name|struct
name|usb_interface
modifier|*
name|iface
decl_stmt|;
name|uint8_t
name|i
decl_stmt|;
if|if
condition|(
name|uaa
operator|->
name|usb_mode
operator|!=
name|USB_MODE_HOST
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
comment|/* figure out first interface matching */
for|for
control|(
name|i
operator|=
literal|1
init|;
condition|;
name|i
operator|++
control|)
block|{
name|iface
operator|=
name|usbd_get_iface
argument_list|(
name|uaa
operator|->
name|device
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|iface
operator|==
name|NULL
operator|||
name|i
operator|==
literal|3
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|id
operator|=
name|iface
operator|->
name|idesc
expr_stmt|;
if|if
condition|(
operator|(
name|id
operator|==
name|NULL
operator|)
operator|||
operator|(
name|id
operator|->
name|bInterfaceClass
operator|!=
name|UICLASS_HID
operator|)
operator|||
operator|(
name|id
operator|->
name|bInterfaceProtocol
operator|!=
literal|0
operator|&&
name|id
operator|->
name|bInterfaceProtocol
operator|!=
name|UIPROTO_MOUSE
operator|)
condition|)
continue|continue;
break|break;
block|}
comment|/* check if we are attaching to the first match */
if|if
condition|(
name|uaa
operator|->
name|info
operator|.
name|bIfaceIndex
operator|!=
name|i
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
return|return
operator|(
name|usbd_lookup_id_by_uaa
argument_list|(
name|wsp_devs
argument_list|,
sizeof|sizeof
argument_list|(
name|wsp_devs
argument_list|)
argument_list|,
name|uaa
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wsp_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|wsp_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|usb_attach_arg
modifier|*
name|uaa
init|=
name|device_get_ivars
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|usb_error_t
name|err
decl_stmt|;
name|void
modifier|*
name|d_ptr
init|=
name|NULL
decl_stmt|;
name|uint16_t
name|d_len
decl_stmt|;
name|DPRINTFN
argument_list|(
name|WSP_LLEVEL_INFO
argument_list|,
literal|"sc=%p\n"
argument_list|,
name|sc
argument_list|)
expr_stmt|;
comment|/* Get HID descriptor */
name|err
operator|=
name|usbd_req_get_hid_desc
argument_list|(
name|uaa
operator|->
name|device
argument_list|,
name|NULL
argument_list|,
operator|&
name|d_ptr
argument_list|,
operator|&
name|d_len
argument_list|,
name|M_TEMP
argument_list|,
name|uaa
operator|->
name|info
operator|.
name|bIfaceIndex
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|USB_ERR_NORMAL_COMPLETION
condition|)
block|{
comment|/* Get HID report descriptor length */
name|sc
operator|->
name|tp_datalen
operator|=
name|hid_report_size
argument_list|(
name|d_ptr
argument_list|,
name|d_len
argument_list|,
name|hid_input
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|d_ptr
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|tp_datalen
operator|<=
literal|0
operator|||
name|sc
operator|->
name|tp_datalen
operator|>
name|WSP_BUFFER_MAX
condition|)
block|{
name|DPRINTF
argument_list|(
literal|"Invalid datalength or too big "
literal|"datalength: %d\n"
argument_list|,
name|sc
operator|->
name|tp_datalen
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
block|}
else|else
block|{
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|sc
operator|->
name|sc_usb_device
operator|=
name|uaa
operator|->
name|device
expr_stmt|;
comment|/* get device specific configuration */
name|sc
operator|->
name|sc_params
operator|=
name|wsp_dev_params
operator|+
name|USB_GET_DRIVER_INFO
argument_list|(
name|uaa
argument_list|)
expr_stmt|;
comment|/* 	 * By default the touchpad behaves like a HID device, sending 	 * packets with reportID = 8. Such reports contain only 	 * limited information. They encode movement deltas and button 	 * events, but do not include data from the pressure 	 * sensors. The device input mode can be switched from HID 	 * reports to raw sensor data using vendor-specific USB 	 * control commands: 	 */
comment|/* 	 * During re-enumeration of the device we need to force the 	 * device back into HID mode before switching it to RAW 	 * mode. Else the device does not work like expected. 	 */
name|err
operator|=
name|wsp_set_device_mode
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|USB_ERR_NORMAL_COMPLETION
condition|)
block|{
name|DPRINTF
argument_list|(
literal|"Failed to set mode to HID MODE (%d)\n"
argument_list|,
name|err
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|err
operator|=
name|wsp_set_device_mode
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|USB_ERR_NORMAL_COMPLETION
condition|)
block|{
name|DPRINTF
argument_list|(
literal|"failed to set mode to RAW MODE (%d)\n"
argument_list|,
name|err
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|mtx_init
argument_list|(
operator|&
name|sc
operator|->
name|sc_mutex
argument_list|,
literal|"wspmtx"
argument_list|,
name|NULL
argument_list|,
name|MTX_DEF
operator||
name|MTX_RECURSE
argument_list|)
expr_stmt|;
name|err
operator|=
name|usbd_transfer_setup
argument_list|(
name|uaa
operator|->
name|device
argument_list|,
operator|&
name|uaa
operator|->
name|info
operator|.
name|bIfaceIndex
argument_list|,
name|sc
operator|->
name|sc_xfer
argument_list|,
name|wsp_config
argument_list|,
name|WSP_N_TRANSFER
argument_list|,
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|sc_mutex
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|DPRINTF
argument_list|(
literal|"error=%s\n"
argument_list|,
name|usbd_errstr
argument_list|(
name|err
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|detach
goto|;
block|}
if|if
condition|(
name|usb_fifo_attach
argument_list|(
name|sc
operator|->
name|sc_usb_device
argument_list|,
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|sc_mutex
argument_list|,
operator|&
name|wsp_fifo_methods
argument_list|,
operator|&
name|sc
operator|->
name|sc_fifo
argument_list|,
name|device_get_unit
argument_list|(
name|dev
argument_list|)
argument_list|,
operator|-
literal|1
argument_list|,
name|uaa
operator|->
name|info
operator|.
name|bIfaceIndex
argument_list|,
name|UID_ROOT
argument_list|,
name|GID_OPERATOR
argument_list|,
literal|0644
argument_list|)
condition|)
block|{
goto|goto
name|detach
goto|;
block|}
name|device_set_usb_desc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_hw
operator|.
name|buttons
operator|=
literal|3
expr_stmt|;
name|sc
operator|->
name|sc_hw
operator|.
name|iftype
operator|=
name|MOUSE_IF_USB
expr_stmt|;
name|sc
operator|->
name|sc_hw
operator|.
name|type
operator|=
name|MOUSE_PAD
expr_stmt|;
name|sc
operator|->
name|sc_hw
operator|.
name|model
operator|=
name|MOUSE_MODEL_GENERIC
expr_stmt|;
name|sc
operator|->
name|sc_mode
operator|.
name|protocol
operator|=
name|MOUSE_PROTO_MSC
expr_stmt|;
name|sc
operator|->
name|sc_mode
operator|.
name|rate
operator|=
operator|-
literal|1
expr_stmt|;
name|sc
operator|->
name|sc_mode
operator|.
name|resolution
operator|=
name|MOUSE_RES_UNKNOWN
expr_stmt|;
name|sc
operator|->
name|sc_mode
operator|.
name|packetsize
operator|=
name|MOUSE_MSC_PACKETSIZE
expr_stmt|;
name|sc
operator|->
name|sc_mode
operator|.
name|syncmask
index|[
literal|0
index|]
operator|=
name|MOUSE_MSC_SYNCMASK
expr_stmt|;
name|sc
operator|->
name|sc_mode
operator|.
name|syncmask
index|[
literal|1
index|]
operator|=
name|MOUSE_MSC_SYNC
expr_stmt|;
name|sc
operator|->
name|sc_touch
operator|=
name|WSP_UNTOUCH
expr_stmt|;
name|sc
operator|->
name|scr_mode
operator|=
name|WSP_SCR_NONE
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|detach
label|:
name|wsp_detach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wsp_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|wsp_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
operator|(
name|void
operator|)
name|wsp_set_device_mode
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|sc
operator|->
name|sc_mutex
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_state
operator|&
name|WSP_ENABLED
condition|)
name|wsp_disable
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|sc
operator|->
name|sc_mutex
argument_list|)
expr_stmt|;
name|usb_fifo_detach
argument_list|(
operator|&
name|sc
operator|->
name|sc_fifo
argument_list|)
expr_stmt|;
name|usbd_transfer_unsetup
argument_list|(
name|sc
operator|->
name|sc_xfer
argument_list|,
name|WSP_N_TRANSFER
argument_list|)
expr_stmt|;
name|mtx_destroy
argument_list|(
operator|&
name|sc
operator|->
name|sc_mutex
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wsp_intr_callback
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|,
name|usb_error_t
name|error
parameter_list|)
block|{
name|struct
name|wsp_softc
modifier|*
name|sc
init|=
name|usbd_xfer_softc
argument_list|(
name|xfer
argument_list|)
decl_stmt|;
specifier|const
name|struct
name|wsp_dev_params
modifier|*
name|params
init|=
name|sc
operator|->
name|sc_params
decl_stmt|;
name|struct
name|usb_page_cache
modifier|*
name|pc
decl_stmt|;
name|struct
name|tp_finger
modifier|*
name|f
decl_stmt|;
name|struct
name|tp_header
modifier|*
name|h
decl_stmt|;
name|struct
name|wsp_tuning
name|tun
init|=
name|wsp_tuning
decl_stmt|;
name|int
name|ntouch
init|=
literal|0
decl_stmt|;
comment|/* the finger number in touch */
name|int
name|ibt
init|=
literal|0
decl_stmt|;
comment|/* button status */
name|int
name|dx
init|=
literal|0
decl_stmt|;
name|int
name|dy
init|=
literal|0
decl_stmt|;
name|int
name|dz
init|=
literal|0
decl_stmt|;
name|int
name|rdx
init|=
literal|0
decl_stmt|;
name|int
name|rdy
init|=
literal|0
decl_stmt|;
name|int
name|rdz
init|=
literal|0
decl_stmt|;
name|int
name|len
decl_stmt|;
name|int
name|i
decl_stmt|;
name|wsp_runing_rangecheck
argument_list|(
operator|&
name|tun
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|dz_count
operator|==
literal|0
condition|)
name|sc
operator|->
name|dz_count
operator|=
name|WSP_DZ_MAX_COUNT
expr_stmt|;
name|usbd_xfer_status
argument_list|(
name|xfer
argument_list|,
operator|&
name|len
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|USB_GET_STATE
argument_list|(
name|xfer
argument_list|)
condition|)
block|{
case|case
name|USB_ST_TRANSFERRED
case|:
comment|/* copy out received data */
name|pc
operator|=
name|usbd_xfer_get_frame
argument_list|(
name|xfer
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|usbd_copy_out
argument_list|(
name|pc
argument_list|,
literal|0
argument_list|,
name|sc
operator|->
name|tp_data
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|len
operator|<
name|params
operator|->
name|tp_offset
operator|+
name|params
operator|->
name|tp_fsize
operator|)
operator|||
operator|(
operator|(
name|len
operator|-
name|params
operator|->
name|tp_offset
operator|)
operator|%
name|params
operator|->
name|tp_fsize
operator|)
operator|!=
literal|0
condition|)
block|{
name|DPRINTFN
argument_list|(
name|WSP_LLEVEL_INFO
argument_list|,
literal|"Invalid length: %d, %x, %x\n"
argument_list|,
name|len
argument_list|,
name|sc
operator|->
name|tp_data
index|[
literal|0
index|]
argument_list|,
name|sc
operator|->
name|tp_data
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
goto|goto
name|tr_setup
goto|;
block|}
if|if
condition|(
name|len
operator|<
name|sc
operator|->
name|tp_datalen
condition|)
block|{
comment|/* make sure we don't process old data */
name|memset
argument_list|(
name|sc
operator|->
name|tp_data
operator|+
name|len
argument_list|,
literal|0
argument_list|,
name|sc
operator|->
name|tp_datalen
operator|-
name|len
argument_list|)
expr_stmt|;
block|}
name|h
operator|=
operator|(
expr|struct
name|tp_header
operator|*
operator|)
operator|(
name|sc
operator|->
name|tp_data
operator|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|tp_type
operator|>=
name|TYPE2
condition|)
block|{
name|ibt
operator|=
name|sc
operator|->
name|tp_data
index|[
name|params
operator|->
name|tp_button
index|]
expr_stmt|;
name|ntouch
operator|=
name|sc
operator|->
name|tp_data
index|[
name|params
operator|->
name|tp_button
operator|-
literal|1
index|]
expr_stmt|;
block|}
comment|/* range check */
if|if
condition|(
name|ntouch
operator|<
literal|0
condition|)
name|ntouch
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|ntouch
operator|>
name|MAX_FINGERS
condition|)
name|ntouch
operator|=
name|MAX_FINGERS
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|!=
name|ntouch
condition|;
name|i
operator|++
control|)
block|{
name|f
operator|=
operator|(
expr|struct
name|tp_finger
operator|*
operator|)
operator|(
name|sc
operator|->
name|tp_data
operator|+
name|params
operator|->
name|tp_offset
operator|+
name|params
operator|->
name|tp_delta
operator|+
name|i
operator|*
name|params
operator|->
name|tp_fsize
operator|)
expr_stmt|;
comment|/* swap endianness, if any */
if|if
condition|(
name|le16toh
argument_list|(
literal|0x1234
argument_list|)
operator|!=
literal|0x1234
condition|)
block|{
name|f
operator|->
name|origin
operator|=
name|le16toh
argument_list|(
operator|(
name|uint16_t
operator|)
name|f
operator|->
name|origin
argument_list|)
expr_stmt|;
name|f
operator|->
name|abs_x
operator|=
name|le16toh
argument_list|(
operator|(
name|uint16_t
operator|)
name|f
operator|->
name|abs_x
argument_list|)
expr_stmt|;
name|f
operator|->
name|abs_y
operator|=
name|le16toh
argument_list|(
operator|(
name|uint16_t
operator|)
name|f
operator|->
name|abs_y
argument_list|)
expr_stmt|;
name|f
operator|->
name|rel_x
operator|=
name|le16toh
argument_list|(
operator|(
name|uint16_t
operator|)
name|f
operator|->
name|rel_x
argument_list|)
expr_stmt|;
name|f
operator|->
name|rel_y
operator|=
name|le16toh
argument_list|(
operator|(
name|uint16_t
operator|)
name|f
operator|->
name|rel_y
argument_list|)
expr_stmt|;
name|f
operator|->
name|tool_major
operator|=
name|le16toh
argument_list|(
operator|(
name|uint16_t
operator|)
name|f
operator|->
name|tool_major
argument_list|)
expr_stmt|;
name|f
operator|->
name|tool_minor
operator|=
name|le16toh
argument_list|(
operator|(
name|uint16_t
operator|)
name|f
operator|->
name|tool_minor
argument_list|)
expr_stmt|;
name|f
operator|->
name|orientation
operator|=
name|le16toh
argument_list|(
operator|(
name|uint16_t
operator|)
name|f
operator|->
name|orientation
argument_list|)
expr_stmt|;
name|f
operator|->
name|touch_major
operator|=
name|le16toh
argument_list|(
operator|(
name|uint16_t
operator|)
name|f
operator|->
name|touch_major
argument_list|)
expr_stmt|;
name|f
operator|->
name|touch_minor
operator|=
name|le16toh
argument_list|(
operator|(
name|uint16_t
operator|)
name|f
operator|->
name|touch_minor
argument_list|)
expr_stmt|;
name|f
operator|->
name|pressure
operator|=
name|le16toh
argument_list|(
operator|(
name|uint16_t
operator|)
name|f
operator|->
name|pressure
argument_list|)
expr_stmt|;
name|f
operator|->
name|multi
operator|=
name|le16toh
argument_list|(
operator|(
name|uint16_t
operator|)
name|f
operator|->
name|multi
argument_list|)
expr_stmt|;
block|}
name|DPRINTFN
argument_list|(
name|WSP_LLEVEL_INFO
argument_list|,
literal|"[%d]ibt=%d, taps=%d, o=%4d, ax=%5d, ay=%5d, "
literal|"rx=%5d, ry=%5d, tlmaj=%4d, tlmin=%4d, ot=%4x, "
literal|"tchmaj=%4d, tchmin=%4d, presure=%4d, m=%4x\n"
argument_list|,
name|i
argument_list|,
name|ibt
argument_list|,
name|ntouch
argument_list|,
name|f
operator|->
name|origin
argument_list|,
name|f
operator|->
name|abs_x
argument_list|,
name|f
operator|->
name|abs_y
argument_list|,
name|f
operator|->
name|rel_x
argument_list|,
name|f
operator|->
name|rel_y
argument_list|,
name|f
operator|->
name|tool_major
argument_list|,
name|f
operator|->
name|tool_minor
argument_list|,
name|f
operator|->
name|orientation
argument_list|,
name|f
operator|->
name|touch_major
argument_list|,
name|f
operator|->
name|touch_minor
argument_list|,
name|f
operator|->
name|pressure
argument_list|,
name|f
operator|->
name|multi
argument_list|)
expr_stmt|;
name|sc
operator|->
name|pos_x
index|[
name|i
index|]
operator|=
name|f
operator|->
name|abs_x
expr_stmt|;
name|sc
operator|->
name|pos_y
index|[
name|i
index|]
operator|=
operator|-
name|f
operator|->
name|abs_y
expr_stmt|;
name|sc
operator|->
name|index
index|[
name|i
index|]
operator|=
name|f
expr_stmt|;
block|}
name|sc
operator|->
name|sc_status
operator|.
name|flags
operator|&=
operator|~
name|MOUSE_POSCHANGED
expr_stmt|;
name|sc
operator|->
name|sc_status
operator|.
name|flags
operator|&=
operator|~
name|MOUSE_STDBUTTONSCHANGED
expr_stmt|;
name|sc
operator|->
name|sc_status
operator|.
name|obutton
operator|=
name|sc
operator|->
name|sc_status
operator|.
name|button
expr_stmt|;
name|sc
operator|->
name|sc_status
operator|.
name|button
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ibt
operator|!=
literal|0
condition|)
block|{
name|sc
operator|->
name|sc_status
operator|.
name|button
operator||=
name|MOUSE_BUTTON1DOWN
expr_stmt|;
name|sc
operator|->
name|ibtn
operator|=
literal|1
expr_stmt|;
block|}
name|sc
operator|->
name|intr_count
operator|++
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|ntaps
operator|<
name|ntouch
condition|)
block|{
switch|switch
condition|(
name|ntouch
condition|)
block|{
case|case
literal|1
case|:
if|if
condition|(
name|sc
operator|->
name|index
index|[
literal|0
index|]
operator|->
name|touch_major
operator|>
name|tun
operator|.
name|pressure_tap_threshold
operator|&&
name|sc
operator|->
name|index
index|[
literal|0
index|]
operator|->
name|tool_major
operator|<=
literal|1200
condition|)
name|sc
operator|->
name|ntaps
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|2
case|:
if|if
condition|(
name|sc
operator|->
name|index
index|[
literal|0
index|]
operator|->
name|touch_major
operator|>
name|tun
operator|.
name|pressure_tap_threshold
operator|-
literal|30
operator|&&
name|sc
operator|->
name|index
index|[
literal|1
index|]
operator|->
name|touch_major
operator|>
name|tun
operator|.
name|pressure_tap_threshold
operator|-
literal|30
condition|)
name|sc
operator|->
name|ntaps
operator|=
literal|2
expr_stmt|;
break|break;
case|case
literal|3
case|:
if|if
condition|(
name|sc
operator|->
name|index
index|[
literal|0
index|]
operator|->
name|touch_major
operator|>
name|tun
operator|.
name|pressure_tap_threshold
operator|-
literal|40
operator|&&
name|sc
operator|->
name|index
index|[
literal|1
index|]
operator|->
name|touch_major
operator|>
name|tun
operator|.
name|pressure_tap_threshold
operator|-
literal|40
operator|&&
name|sc
operator|->
name|index
index|[
literal|2
index|]
operator|->
name|touch_major
operator|>
name|tun
operator|.
name|pressure_tap_threshold
operator|-
literal|40
condition|)
name|sc
operator|->
name|ntaps
operator|=
literal|3
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
if|if
condition|(
name|ntouch
operator|==
literal|2
condition|)
block|{
name|sc
operator|->
name|distance
operator|=
name|max
argument_list|(
name|sc
operator|->
name|distance
argument_list|,
name|max
argument_list|(
name|abs
argument_list|(
name|sc
operator|->
name|pos_x
index|[
literal|0
index|]
operator|-
name|sc
operator|->
name|pos_x
index|[
literal|1
index|]
argument_list|)
argument_list|,
name|abs
argument_list|(
name|sc
operator|->
name|pos_y
index|[
literal|0
index|]
operator|-
name|sc
operator|->
name|pos_y
index|[
literal|1
index|]
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|index
index|[
literal|0
index|]
operator|->
name|touch_major
operator|<
name|tun
operator|.
name|pressure_untouch_threshold
operator|&&
name|sc
operator|->
name|sc_status
operator|.
name|button
operator|==
literal|0
condition|)
block|{
name|sc
operator|->
name|sc_touch
operator|=
name|WSP_UNTOUCH
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|intr_count
operator|<
name|WSP_TAP_MAX_COUNT
operator|&&
name|sc
operator|->
name|intr_count
operator|>
name|WSP_TAP_THRESHOLD
operator|&&
name|sc
operator|->
name|ntaps
operator|&&
name|sc
operator|->
name|ibtn
operator|==
literal|0
condition|)
block|{
comment|/* 				 * Add a pair of events (button-down and 				 * button-up). 				 */
switch|switch
condition|(
name|sc
operator|->
name|ntaps
condition|)
block|{
case|case
literal|1
case|:
if|if
condition|(
operator|!
operator|(
name|params
operator|->
name|caps
operator|&
name|HAS_INTEGRATED_BUTTON
operator|)
condition|)
block|{
name|wsp_add_to_queue
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|MOUSE_BUTTON1DOWN
argument_list|)
expr_stmt|;
name|DPRINTFN
argument_list|(
name|WSP_LLEVEL_INFO
argument_list|,
literal|"LEFT CLICK!\n"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|2
case|:
name|DPRINTFN
argument_list|(
name|WSP_LLEVEL_INFO
argument_list|,
literal|"sum_x=%5d, sum_y=%5d\n"
argument_list|,
name|sc
operator|->
name|dx_sum
argument_list|,
name|sc
operator|->
name|dy_sum
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|distance
operator|<
name|MAX_DISTANCE
operator|&&
name|abs
argument_list|(
name|sc
operator|->
name|dx_sum
argument_list|)
operator|<
literal|5
operator|&&
name|abs
argument_list|(
name|sc
operator|->
name|dy_sum
argument_list|)
operator|<
literal|5
condition|)
block|{
name|wsp_add_to_queue
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|MOUSE_BUTTON3DOWN
argument_list|)
expr_stmt|;
name|DPRINTFN
argument_list|(
name|WSP_LLEVEL_INFO
argument_list|,
literal|"RIGHT CLICK!\n"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|3
case|:
name|wsp_add_to_queue
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|MOUSE_BUTTON2DOWN
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|/* we don't handle taps of more than three fingers */
break|break;
block|}
name|wsp_add_to_queue
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* button release */
block|}
if|if
condition|(
operator|(
name|sc
operator|->
name|dt_sum
operator|/
name|tun
operator|.
name|scr_hor_threshold
operator|)
operator|!=
literal|0
operator|&&
name|sc
operator|->
name|ntaps
operator|==
literal|2
operator|&&
name|sc
operator|->
name|scr_mode
operator|==
name|WSP_SCR_HOR
condition|)
block|{
comment|/* 				 * translate T-axis into button presses 				 * until further 				 */
if|if
condition|(
name|sc
operator|->
name|dt_sum
operator|>
literal|0
condition|)
name|wsp_add_to_queue
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|1UL
operator|<<
literal|3
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|sc
operator|->
name|dt_sum
operator|<
literal|0
condition|)
name|wsp_add_to_queue
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|1UL
operator|<<
literal|4
argument_list|)
expr_stmt|;
block|}
name|sc
operator|->
name|dz_count
operator|=
name|WSP_DZ_MAX_COUNT
expr_stmt|;
name|sc
operator|->
name|dz_sum
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|intr_count
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|ibtn
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|ntaps
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|finger
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|distance
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|dt_sum
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|dx_sum
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|dy_sum
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|rdx
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|rdy
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|rdz
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|scr_mode
operator|=
name|WSP_SCR_NONE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sc
operator|->
name|index
index|[
literal|0
index|]
operator|->
name|touch_major
operator|>=
name|tun
operator|.
name|pressure_touch_threshold
operator|&&
name|sc
operator|->
name|sc_touch
operator|==
name|WSP_UNTOUCH
condition|)
block|{
comment|/* ignore first touch */
name|sc
operator|->
name|sc_touch
operator|=
name|WSP_FIRST_TOUCH
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sc
operator|->
name|index
index|[
literal|0
index|]
operator|->
name|touch_major
operator|>=
name|tun
operator|.
name|pressure_touch_threshold
operator|&&
name|sc
operator|->
name|sc_touch
operator|==
name|WSP_FIRST_TOUCH
condition|)
block|{
comment|/* ignore second touch */
name|sc
operator|->
name|sc_touch
operator|=
name|WSP_SECOND_TOUCH
expr_stmt|;
name|DPRINTFN
argument_list|(
name|WSP_LLEVEL_INFO
argument_list|,
literal|"Fist pre_x=%5d, pre_y=%5d\n"
argument_list|,
name|sc
operator|->
name|pre_pos_x
argument_list|,
name|sc
operator|->
name|pre_pos_y
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|sc
operator|->
name|sc_touch
operator|==
name|WSP_SECOND_TOUCH
condition|)
name|sc
operator|->
name|sc_touch
operator|=
name|WSP_TOUCHING
expr_stmt|;
if|if
condition|(
name|ntouch
operator|!=
literal|0
operator|&&
name|sc
operator|->
name|index
index|[
literal|0
index|]
operator|->
name|touch_major
operator|>=
name|tun
operator|.
name|pressure_touch_threshold
condition|)
block|{
name|dx
operator|=
name|sc
operator|->
name|pos_x
index|[
literal|0
index|]
operator|-
name|sc
operator|->
name|pre_pos_x
expr_stmt|;
name|dy
operator|=
name|sc
operator|->
name|pos_y
index|[
literal|0
index|]
operator|-
name|sc
operator|->
name|pre_pos_y
expr_stmt|;
comment|/* Ignore movement during button is releasing */
if|if
condition|(
name|sc
operator|->
name|ibtn
operator|!=
literal|0
operator|&&
name|sc
operator|->
name|sc_status
operator|.
name|button
operator|==
literal|0
condition|)
name|dx
operator|=
name|dy
operator|=
literal|0
expr_stmt|;
comment|/* Ignore movement if ntouch changed */
if|if
condition|(
name|sc
operator|->
name|o_ntouch
operator|!=
name|ntouch
condition|)
name|dx
operator|=
name|dy
operator|=
literal|0
expr_stmt|;
comment|/* Ignore unexpeted movement when typing */
if|if
condition|(
name|ntouch
operator|==
literal|1
operator|&&
name|sc
operator|->
name|index
index|[
literal|0
index|]
operator|->
name|tool_major
operator|>
literal|1200
condition|)
name|dx
operator|=
name|dy
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|ibtn
operator|!=
literal|0
operator|&&
name|ntouch
operator|==
literal|1
operator|&&
name|sc
operator|->
name|intr_count
operator|<
name|WSP_TAP_MAX_COUNT
operator|&&
name|abs
argument_list|(
name|sc
operator|->
name|dx_sum
argument_list|)
operator|<
literal|1
operator|&&
name|abs
argument_list|(
name|sc
operator|->
name|dy_sum
argument_list|)
operator|<
literal|1
condition|)
name|dx
operator|=
name|dy
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ntouch
operator|==
literal|2
operator|&&
name|sc
operator|->
name|sc_status
operator|.
name|button
operator|!=
literal|0
condition|)
block|{
name|dx
operator|=
name|sc
operator|->
name|pos_x
index|[
name|sc
operator|->
name|finger
index|]
operator|-
name|sc
operator|->
name|pre_pos_x
expr_stmt|;
name|dy
operator|=
name|sc
operator|->
name|pos_y
index|[
name|sc
operator|->
name|finger
index|]
operator|-
name|sc
operator|->
name|pre_pos_y
expr_stmt|;
comment|/* 					 * Ignore movement of switch finger or 					 * movement from ibt=0 to ibt=1 					 */
if|if
condition|(
name|sc
operator|->
name|index
index|[
literal|0
index|]
operator|->
name|origin
operator|==
literal|0
operator|||
name|sc
operator|->
name|index
index|[
literal|1
index|]
operator|->
name|origin
operator|==
literal|0
operator|||
name|sc
operator|->
name|sc_status
operator|.
name|obutton
operator|!=
name|sc
operator|->
name|sc_status
operator|.
name|button
condition|)
block|{
name|dx
operator|=
name|dy
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|finger
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|abs
argument_list|(
name|sc
operator|->
name|index
index|[
literal|0
index|]
operator|->
name|rel_x
argument_list|)
operator|+
name|abs
argument_list|(
name|sc
operator|->
name|index
index|[
literal|0
index|]
operator|->
name|rel_y
argument_list|)
operator|)
operator|<
operator|(
name|abs
argument_list|(
name|sc
operator|->
name|index
index|[
literal|1
index|]
operator|->
name|rel_x
argument_list|)
operator|+
name|abs
argument_list|(
name|sc
operator|->
name|index
index|[
literal|1
index|]
operator|->
name|rel_y
argument_list|)
operator|)
operator|&&
name|sc
operator|->
name|finger
operator|==
literal|0
condition|)
block|{
name|sc
operator|->
name|sc_touch
operator|=
name|WSP_SECOND_TOUCH
expr_stmt|;
name|dx
operator|=
name|dy
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|finger
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|abs
argument_list|(
name|sc
operator|->
name|index
index|[
literal|0
index|]
operator|->
name|rel_x
argument_list|)
operator|+
name|abs
argument_list|(
name|sc
operator|->
name|index
index|[
literal|0
index|]
operator|->
name|rel_y
argument_list|)
operator|)
operator|>=
operator|(
name|abs
argument_list|(
name|sc
operator|->
name|index
index|[
literal|1
index|]
operator|->
name|rel_x
argument_list|)
operator|+
name|abs
argument_list|(
name|sc
operator|->
name|index
index|[
literal|1
index|]
operator|->
name|rel_y
argument_list|)
operator|)
operator|&&
name|sc
operator|->
name|finger
operator|==
literal|1
condition|)
block|{
name|sc
operator|->
name|sc_touch
operator|=
name|WSP_SECOND_TOUCH
expr_stmt|;
name|dx
operator|=
name|dy
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|finger
operator|=
literal|0
expr_stmt|;
block|}
name|DPRINTFN
argument_list|(
name|WSP_LLEVEL_INFO
argument_list|,
literal|"dx=%5d, dy=%5d, mov=%5d\n"
argument_list|,
name|dx
argument_list|,
name|dy
argument_list|,
name|sc
operator|->
name|finger
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|dz_count
operator|--
condition|)
block|{
name|rdz
operator|=
operator|(
name|dy
operator|+
name|sc
operator|->
name|rdz
operator|)
operator|%
name|tun
operator|.
name|scale_factor
expr_stmt|;
name|sc
operator|->
name|dz_sum
operator|-=
operator|(
name|dy
operator|+
name|sc
operator|->
name|rdz
operator|)
operator|/
name|tun
operator|.
name|scale_factor
expr_stmt|;
name|sc
operator|->
name|rdz
operator|=
name|rdz
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|sc
operator|->
name|dz_sum
operator|/
name|tun
operator|.
name|z_factor
operator|)
operator|!=
literal|0
condition|)
name|sc
operator|->
name|dz_count
operator|=
literal|0
expr_stmt|;
block|}
name|rdx
operator|=
operator|(
name|dx
operator|+
name|sc
operator|->
name|rdx
operator|)
operator|%
name|tun
operator|.
name|scale_factor
expr_stmt|;
name|dx
operator|=
operator|(
name|dx
operator|+
name|sc
operator|->
name|rdx
operator|)
operator|/
name|tun
operator|.
name|scale_factor
expr_stmt|;
name|sc
operator|->
name|rdx
operator|=
name|rdx
expr_stmt|;
name|rdy
operator|=
operator|(
name|dy
operator|+
name|sc
operator|->
name|rdy
operator|)
operator|%
name|tun
operator|.
name|scale_factor
expr_stmt|;
name|dy
operator|=
operator|(
name|dy
operator|+
name|sc
operator|->
name|rdy
operator|)
operator|/
name|tun
operator|.
name|scale_factor
expr_stmt|;
name|sc
operator|->
name|rdy
operator|=
name|rdy
expr_stmt|;
name|sc
operator|->
name|dx_sum
operator|+=
name|dx
expr_stmt|;
name|sc
operator|->
name|dy_sum
operator|+=
name|dy
expr_stmt|;
if|if
condition|(
name|ntouch
operator|==
literal|2
operator|&&
name|sc
operator|->
name|sc_status
operator|.
name|button
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|scr_mode
operator|==
name|WSP_SCR_NONE
operator|&&
name|abs
argument_list|(
name|sc
operator|->
name|dx_sum
argument_list|)
operator|+
name|abs
argument_list|(
name|sc
operator|->
name|dy_sum
argument_list|)
operator|>
name|tun
operator|.
name|scr_hor_threshold
condition|)
name|sc
operator|->
name|scr_mode
operator|=
name|abs
argument_list|(
name|sc
operator|->
name|dx_sum
argument_list|)
operator|>
name|abs
argument_list|(
name|sc
operator|->
name|dy_sum
argument_list|)
operator|*
literal|2
condition|?
name|WSP_SCR_HOR
else|:
name|WSP_SCR_VER
expr_stmt|;
name|DPRINTFN
argument_list|(
name|WSP_LLEVEL_INFO
argument_list|,
literal|"scr_mode=%5d, count=%d, dx_sum=%d, dy_sum=%d\n"
argument_list|,
name|sc
operator|->
name|scr_mode
argument_list|,
name|sc
operator|->
name|intr_count
argument_list|,
name|sc
operator|->
name|dx_sum
argument_list|,
name|sc
operator|->
name|dy_sum
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|scr_mode
operator|==
name|WSP_SCR_HOR
condition|)
name|sc
operator|->
name|dt_sum
operator|+=
name|dx
expr_stmt|;
else|else
name|sc
operator|->
name|dt_sum
operator|=
literal|0
expr_stmt|;
name|dx
operator|=
name|dy
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|dz_count
operator|==
literal|0
condition|)
name|dz
operator|=
name|sc
operator|->
name|dz_sum
operator|/
name|tun
operator|.
name|z_factor
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|scr_mode
operator|==
name|WSP_SCR_HOR
operator|||
name|abs
argument_list|(
name|sc
operator|->
name|pos_x
index|[
literal|0
index|]
operator|-
name|sc
operator|->
name|pos_x
index|[
literal|1
index|]
argument_list|)
operator|>
name|MAX_DISTANCE
operator|||
name|abs
argument_list|(
name|sc
operator|->
name|pos_y
index|[
literal|0
index|]
operator|-
name|sc
operator|->
name|pos_y
index|[
literal|1
index|]
argument_list|)
operator|>
name|MAX_DISTANCE
condition|)
name|dz
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|ntouch
operator|==
literal|3
condition|)
name|dx
operator|=
name|dy
operator|=
name|dz
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|intr_count
operator|<
name|WSP_TAP_MAX_COUNT
operator|&&
name|abs
argument_list|(
name|dx
argument_list|)
operator|<
literal|3
operator|&&
name|abs
argument_list|(
name|dy
argument_list|)
operator|<
literal|3
operator|&&
name|abs
argument_list|(
name|dz
argument_list|)
operator|<
literal|3
condition|)
name|dx
operator|=
name|dy
operator|=
name|dz
operator|=
literal|0
expr_stmt|;
else|else
name|sc
operator|->
name|intr_count
operator|=
name|WSP_TAP_MAX_COUNT
expr_stmt|;
if|if
condition|(
name|dx
operator|||
name|dy
operator|||
name|dz
condition|)
name|sc
operator|->
name|sc_status
operator|.
name|flags
operator||=
name|MOUSE_POSCHANGED
expr_stmt|;
name|DPRINTFN
argument_list|(
name|WSP_LLEVEL_INFO
argument_list|,
literal|"dx=%5d, dy=%5d, dz=%5d, sc_touch=%x, btn=%x\n"
argument_list|,
name|dx
argument_list|,
name|dy
argument_list|,
name|dz
argument_list|,
name|sc
operator|->
name|sc_touch
argument_list|,
name|sc
operator|->
name|sc_status
operator|.
name|button
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_status
operator|.
name|dx
operator|+=
name|dx
expr_stmt|;
name|sc
operator|->
name|sc_status
operator|.
name|dy
operator|+=
name|dy
expr_stmt|;
name|sc
operator|->
name|sc_status
operator|.
name|dz
operator|+=
name|dz
expr_stmt|;
name|wsp_add_to_queue
argument_list|(
name|sc
argument_list|,
name|dx
argument_list|,
operator|-
name|dy
argument_list|,
name|dz
argument_list|,
name|sc
operator|->
name|sc_status
operator|.
name|button
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|dz_count
operator|==
literal|0
condition|)
block|{
name|sc
operator|->
name|dz_sum
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|rdz
operator|=
literal|0
expr_stmt|;
block|}
block|}
name|sc
operator|->
name|pre_pos_x
operator|=
name|sc
operator|->
name|pos_x
index|[
literal|0
index|]
expr_stmt|;
name|sc
operator|->
name|pre_pos_y
operator|=
name|sc
operator|->
name|pos_y
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|ntouch
operator|==
literal|2
operator|&&
name|sc
operator|->
name|sc_status
operator|.
name|button
operator|!=
literal|0
condition|)
block|{
name|sc
operator|->
name|pre_pos_x
operator|=
name|sc
operator|->
name|pos_x
index|[
name|sc
operator|->
name|finger
index|]
expr_stmt|;
name|sc
operator|->
name|pre_pos_y
operator|=
name|sc
operator|->
name|pos_y
index|[
name|sc
operator|->
name|finger
index|]
expr_stmt|;
block|}
name|sc
operator|->
name|o_ntouch
operator|=
name|ntouch
expr_stmt|;
case|case
name|USB_ST_SETUP
case|:
name|tr_setup
label|:
comment|/* check if we can put more data into the FIFO */
if|if
condition|(
name|usb_fifo_put_bytes_max
argument_list|(
name|sc
operator|->
name|sc_fifo
operator|.
name|fp
index|[
name|USB_FIFO_RX
index|]
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|usbd_xfer_set_frame_len
argument_list|(
name|xfer
argument_list|,
literal|0
argument_list|,
name|sc
operator|->
name|tp_datalen
argument_list|)
expr_stmt|;
name|usbd_transfer_submit
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
comment|/* Error */
if|if
condition|(
name|error
operator|!=
name|USB_ERR_CANCELLED
condition|)
block|{
comment|/* try clear stall first */
name|usbd_xfer_set_stall
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
goto|goto
name|tr_setup
goto|;
block|}
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wsp_add_to_queue
parameter_list|(
name|struct
name|wsp_softc
modifier|*
name|sc
parameter_list|,
name|int
name|dx
parameter_list|,
name|int
name|dy
parameter_list|,
name|int
name|dz
parameter_list|,
name|uint32_t
name|buttons_in
parameter_list|)
block|{
name|uint32_t
name|buttons_out
decl_stmt|;
name|uint8_t
name|buf
index|[
literal|8
index|]
decl_stmt|;
name|dx
operator|=
name|imin
argument_list|(
name|dx
argument_list|,
literal|254
argument_list|)
expr_stmt|;
name|dx
operator|=
name|imax
argument_list|(
name|dx
argument_list|,
operator|-
literal|256
argument_list|)
expr_stmt|;
name|dy
operator|=
name|imin
argument_list|(
name|dy
argument_list|,
literal|254
argument_list|)
expr_stmt|;
name|dy
operator|=
name|imax
argument_list|(
name|dy
argument_list|,
operator|-
literal|256
argument_list|)
expr_stmt|;
name|dz
operator|=
name|imin
argument_list|(
name|dz
argument_list|,
literal|126
argument_list|)
expr_stmt|;
name|dz
operator|=
name|imax
argument_list|(
name|dz
argument_list|,
operator|-
literal|128
argument_list|)
expr_stmt|;
name|buttons_out
operator|=
name|MOUSE_MSC_BUTTONS
expr_stmt|;
if|if
condition|(
name|buttons_in
operator|&
name|MOUSE_BUTTON1DOWN
condition|)
name|buttons_out
operator|&=
operator|~
name|MOUSE_MSC_BUTTON1UP
expr_stmt|;
elseif|else
if|if
condition|(
name|buttons_in
operator|&
name|MOUSE_BUTTON2DOWN
condition|)
name|buttons_out
operator|&=
operator|~
name|MOUSE_MSC_BUTTON2UP
expr_stmt|;
elseif|else
if|if
condition|(
name|buttons_in
operator|&
name|MOUSE_BUTTON3DOWN
condition|)
name|buttons_out
operator|&=
operator|~
name|MOUSE_MSC_BUTTON3UP
expr_stmt|;
comment|/* Encode the mouse data in standard format; refer to mouse(4) */
name|buf
index|[
literal|0
index|]
operator|=
name|sc
operator|->
name|sc_mode
operator|.
name|syncmask
index|[
literal|1
index|]
expr_stmt|;
name|buf
index|[
literal|0
index|]
operator||=
name|buttons_out
expr_stmt|;
name|buf
index|[
literal|1
index|]
operator|=
name|dx
operator|>>
literal|1
expr_stmt|;
name|buf
index|[
literal|2
index|]
operator|=
name|dy
operator|>>
literal|1
expr_stmt|;
name|buf
index|[
literal|3
index|]
operator|=
name|dx
operator|-
operator|(
name|dx
operator|>>
literal|1
operator|)
expr_stmt|;
name|buf
index|[
literal|4
index|]
operator|=
name|dy
operator|-
operator|(
name|dy
operator|>>
literal|1
operator|)
expr_stmt|;
comment|/* Encode extra bytes for level 1 */
if|if
condition|(
name|sc
operator|->
name|sc_mode
operator|.
name|level
operator|==
literal|1
condition|)
block|{
name|buf
index|[
literal|5
index|]
operator|=
name|dz
operator|>>
literal|1
expr_stmt|;
comment|/* dz / 2 */
name|buf
index|[
literal|6
index|]
operator|=
name|dz
operator|-
operator|(
name|dz
operator|>>
literal|1
operator|)
expr_stmt|;
comment|/* dz - (dz / 2) */
name|buf
index|[
literal|7
index|]
operator|=
operator|(
operator|(
operator|(
operator|~
name|buttons_in
operator|)
operator|>>
literal|3
operator|)
operator|&
name|MOUSE_SYS_EXTBUTTONS
operator|)
expr_stmt|;
block|}
name|usb_fifo_put_data_linear
argument_list|(
name|sc
operator|->
name|sc_fifo
operator|.
name|fp
index|[
name|USB_FIFO_RX
index|]
argument_list|,
name|buf
argument_list|,
name|sc
operator|->
name|sc_mode
operator|.
name|packetsize
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wsp_reset_buf
parameter_list|(
name|struct
name|wsp_softc
modifier|*
name|sc
parameter_list|)
block|{
comment|/* reset read queue */
name|usb_fifo_reset
argument_list|(
name|sc
operator|->
name|sc_fifo
operator|.
name|fp
index|[
name|USB_FIFO_RX
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wsp_start_read
parameter_list|(
name|struct
name|usb_fifo
modifier|*
name|fifo
parameter_list|)
block|{
name|struct
name|wsp_softc
modifier|*
name|sc
init|=
name|usb_fifo_softc
argument_list|(
name|fifo
argument_list|)
decl_stmt|;
name|int
name|rate
decl_stmt|;
comment|/* Check if we should override the default polling interval */
name|rate
operator|=
name|sc
operator|->
name|sc_pollrate
expr_stmt|;
comment|/* Range check rate */
if|if
condition|(
name|rate
operator|>
literal|1000
condition|)
name|rate
operator|=
literal|1000
expr_stmt|;
comment|/* Check for set rate */
if|if
condition|(
operator|(
name|rate
operator|>
literal|0
operator|)
operator|&&
operator|(
name|sc
operator|->
name|sc_xfer
index|[
name|WSP_INTR_DT
index|]
operator|!=
name|NULL
operator|)
condition|)
block|{
comment|/* Stop current transfer, if any */
name|usbd_transfer_stop
argument_list|(
name|sc
operator|->
name|sc_xfer
index|[
name|WSP_INTR_DT
index|]
argument_list|)
expr_stmt|;
comment|/* Set new interval */
name|usbd_xfer_set_interval
argument_list|(
name|sc
operator|->
name|sc_xfer
index|[
name|WSP_INTR_DT
index|]
argument_list|,
literal|1000
operator|/
name|rate
argument_list|)
expr_stmt|;
comment|/* Only set pollrate once */
name|sc
operator|->
name|sc_pollrate
operator|=
literal|0
expr_stmt|;
block|}
name|usbd_transfer_start
argument_list|(
name|sc
operator|->
name|sc_xfer
index|[
name|WSP_INTR_DT
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wsp_stop_read
parameter_list|(
name|struct
name|usb_fifo
modifier|*
name|fifo
parameter_list|)
block|{
name|struct
name|wsp_softc
modifier|*
name|sc
init|=
name|usb_fifo_softc
argument_list|(
name|fifo
argument_list|)
decl_stmt|;
name|usbd_transfer_stop
argument_list|(
name|sc
operator|->
name|sc_xfer
index|[
name|WSP_INTR_DT
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wsp_open
parameter_list|(
name|struct
name|usb_fifo
modifier|*
name|fifo
parameter_list|,
name|int
name|fflags
parameter_list|)
block|{
name|DPRINTFN
argument_list|(
name|WSP_LLEVEL_INFO
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fflags
operator|&
name|FREAD
condition|)
block|{
name|struct
name|wsp_softc
modifier|*
name|sc
init|=
name|usb_fifo_softc
argument_list|(
name|fifo
argument_list|)
decl_stmt|;
name|int
name|rc
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_state
operator|&
name|WSP_ENABLED
condition|)
return|return
operator|(
name|EBUSY
operator|)
return|;
if|if
condition|(
name|usb_fifo_alloc_buffer
argument_list|(
name|fifo
argument_list|,
name|WSP_FIFO_BUF_SIZE
argument_list|,
name|WSP_FIFO_QUEUE_MAXLEN
argument_list|)
condition|)
block|{
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
name|rc
operator|=
name|wsp_enable
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
literal|0
condition|)
block|{
name|usb_fifo_free_buffer
argument_list|(
name|fifo
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wsp_close
parameter_list|(
name|struct
name|usb_fifo
modifier|*
name|fifo
parameter_list|,
name|int
name|fflags
parameter_list|)
block|{
if|if
condition|(
name|fflags
operator|&
name|FREAD
condition|)
block|{
name|struct
name|wsp_softc
modifier|*
name|sc
init|=
name|usb_fifo_softc
argument_list|(
name|fifo
argument_list|)
decl_stmt|;
name|wsp_disable
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|usb_fifo_free_buffer
argument_list|(
name|fifo
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|wsp_ioctl
parameter_list|(
name|struct
name|usb_fifo
modifier|*
name|fifo
parameter_list|,
name|u_long
name|cmd
parameter_list|,
name|void
modifier|*
name|addr
parameter_list|,
name|int
name|fflags
parameter_list|)
block|{
name|struct
name|wsp_softc
modifier|*
name|sc
init|=
name|usb_fifo_softc
argument_list|(
name|fifo
argument_list|)
decl_stmt|;
name|mousemode_t
name|mode
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|sc
operator|->
name|sc_mutex
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|MOUSE_GETHWINFO
case|:
operator|*
operator|(
name|mousehw_t
operator|*
operator|)
name|addr
operator|=
name|sc
operator|->
name|sc_hw
expr_stmt|;
break|break;
case|case
name|MOUSE_GETMODE
case|:
operator|*
operator|(
name|mousemode_t
operator|*
operator|)
name|addr
operator|=
name|sc
operator|->
name|sc_mode
expr_stmt|;
break|break;
case|case
name|MOUSE_SETMODE
case|:
name|mode
operator|=
operator|*
operator|(
name|mousemode_t
operator|*
operator|)
name|addr
expr_stmt|;
if|if
condition|(
name|mode
operator|.
name|level
operator|==
operator|-
literal|1
condition|)
comment|/* Don't change the current setting */
empty_stmt|;
elseif|else
if|if
condition|(
operator|(
name|mode
operator|.
name|level
operator|<
literal|0
operator|)
operator|||
operator|(
name|mode
operator|.
name|level
operator|>
literal|1
operator|)
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|sc
operator|->
name|sc_mode
operator|.
name|level
operator|=
name|mode
operator|.
name|level
expr_stmt|;
name|sc
operator|->
name|sc_pollrate
operator|=
name|mode
operator|.
name|rate
expr_stmt|;
name|sc
operator|->
name|sc_hw
operator|.
name|buttons
operator|=
literal|3
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_mode
operator|.
name|level
operator|==
literal|0
condition|)
block|{
name|sc
operator|->
name|sc_mode
operator|.
name|protocol
operator|=
name|MOUSE_PROTO_MSC
expr_stmt|;
name|sc
operator|->
name|sc_mode
operator|.
name|packetsize
operator|=
name|MOUSE_MSC_PACKETSIZE
expr_stmt|;
name|sc
operator|->
name|sc_mode
operator|.
name|syncmask
index|[
literal|0
index|]
operator|=
name|MOUSE_MSC_SYNCMASK
expr_stmt|;
name|sc
operator|->
name|sc_mode
operator|.
name|syncmask
index|[
literal|1
index|]
operator|=
name|MOUSE_MSC_SYNC
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sc
operator|->
name|sc_mode
operator|.
name|level
operator|==
literal|1
condition|)
block|{
name|sc
operator|->
name|sc_mode
operator|.
name|protocol
operator|=
name|MOUSE_PROTO_SYSMOUSE
expr_stmt|;
name|sc
operator|->
name|sc_mode
operator|.
name|packetsize
operator|=
name|MOUSE_SYS_PACKETSIZE
expr_stmt|;
name|sc
operator|->
name|sc_mode
operator|.
name|syncmask
index|[
literal|0
index|]
operator|=
name|MOUSE_SYS_SYNCMASK
expr_stmt|;
name|sc
operator|->
name|sc_mode
operator|.
name|syncmask
index|[
literal|1
index|]
operator|=
name|MOUSE_SYS_SYNC
expr_stmt|;
block|}
name|wsp_reset_buf
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
case|case
name|MOUSE_GETLEVEL
case|:
operator|*
operator|(
name|int
operator|*
operator|)
name|addr
operator|=
name|sc
operator|->
name|sc_mode
operator|.
name|level
expr_stmt|;
break|break;
case|case
name|MOUSE_SETLEVEL
case|:
if|if
condition|(
operator|*
operator|(
name|int
operator|*
operator|)
name|addr
operator|<
literal|0
operator|||
operator|*
operator|(
name|int
operator|*
operator|)
name|addr
operator|>
literal|1
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|sc
operator|->
name|sc_mode
operator|.
name|level
operator|=
operator|*
operator|(
name|int
operator|*
operator|)
name|addr
expr_stmt|;
name|sc
operator|->
name|sc_hw
operator|.
name|buttons
operator|=
literal|3
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_mode
operator|.
name|level
operator|==
literal|0
condition|)
block|{
name|sc
operator|->
name|sc_mode
operator|.
name|protocol
operator|=
name|MOUSE_PROTO_MSC
expr_stmt|;
name|sc
operator|->
name|sc_mode
operator|.
name|packetsize
operator|=
name|MOUSE_MSC_PACKETSIZE
expr_stmt|;
name|sc
operator|->
name|sc_mode
operator|.
name|syncmask
index|[
literal|0
index|]
operator|=
name|MOUSE_MSC_SYNCMASK
expr_stmt|;
name|sc
operator|->
name|sc_mode
operator|.
name|syncmask
index|[
literal|1
index|]
operator|=
name|MOUSE_MSC_SYNC
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sc
operator|->
name|sc_mode
operator|.
name|level
operator|==
literal|1
condition|)
block|{
name|sc
operator|->
name|sc_mode
operator|.
name|protocol
operator|=
name|MOUSE_PROTO_SYSMOUSE
expr_stmt|;
name|sc
operator|->
name|sc_mode
operator|.
name|packetsize
operator|=
name|MOUSE_SYS_PACKETSIZE
expr_stmt|;
name|sc
operator|->
name|sc_mode
operator|.
name|syncmask
index|[
literal|0
index|]
operator|=
name|MOUSE_SYS_SYNCMASK
expr_stmt|;
name|sc
operator|->
name|sc_mode
operator|.
name|syncmask
index|[
literal|1
index|]
operator|=
name|MOUSE_SYS_SYNC
expr_stmt|;
block|}
name|wsp_reset_buf
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
case|case
name|MOUSE_GETSTATUS
case|:
block|{
name|mousestatus_t
modifier|*
name|status
init|=
operator|(
name|mousestatus_t
operator|*
operator|)
name|addr
decl_stmt|;
operator|*
name|status
operator|=
name|sc
operator|->
name|sc_status
expr_stmt|;
name|sc
operator|->
name|sc_status
operator|.
name|obutton
operator|=
name|sc
operator|->
name|sc_status
operator|.
name|button
expr_stmt|;
name|sc
operator|->
name|sc_status
operator|.
name|button
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_status
operator|.
name|dx
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_status
operator|.
name|dy
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_status
operator|.
name|dz
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|status
operator|->
name|dx
operator|||
name|status
operator|->
name|dy
operator|||
name|status
operator|->
name|dz
condition|)
name|status
operator|->
name|flags
operator||=
name|MOUSE_POSCHANGED
expr_stmt|;
if|if
condition|(
name|status
operator|->
name|button
operator|!=
name|status
operator|->
name|obutton
condition|)
name|status
operator|->
name|flags
operator||=
name|MOUSE_BUTTONSCHANGED
expr_stmt|;
break|break;
block|}
default|default:
name|error
operator|=
name|ENOTTY
expr_stmt|;
block|}
name|done
label|:
name|mtx_unlock
argument_list|(
operator|&
name|sc
operator|->
name|sc_mutex
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|device_method_t
name|wsp_methods
index|[]
init|=
block|{
comment|/* Device interface */
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|wsp_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|wsp_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|wsp_detach
argument_list|)
block|,
name|DEVMETHOD_END
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|wsp_driver
init|=
block|{
operator|.
name|name
operator|=
name|WSP_DRIVER_NAME
block|,
operator|.
name|methods
operator|=
name|wsp_methods
block|,
operator|.
name|size
operator|=
expr|sizeof
operator|(
expr|struct
name|wsp_softc
operator|)
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|wsp_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|wsp
argument_list|,
name|uhub
argument_list|,
name|wsp_driver
argument_list|,
name|wsp_devclass
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|wsp
argument_list|,
name|usb
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_VERSION
argument_list|(
name|wsp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|USB_PNP_HOST_INFO
argument_list|(
name|wsp_devs
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


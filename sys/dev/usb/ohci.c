begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	$NetBSD: ohci.c,v 1.27 1999/01/13 10:33:53 augustss Exp $	*/
end_comment

begin_comment
comment|/*	$FreeBSD$	*/
end_comment

begin_comment
comment|/*  * Copyright (c) 1998 The NetBSD Foundation, Inc.  * All rights reserved.  *  * This code is derived from software contributed to The NetBSD Foundation  * by Lennart Augustsson (augustss@carlstedt.se) at  * Carlstedt Research& Technology.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. All advertising materials mentioning features or use of this software  *    must display the following acknowledgement:  *        This product includes software developed by the NetBSD  *        Foundation, Inc. and its contributors.  * 4. Neither the name of The NetBSD Foundation nor the names of its  *    contributors may be used to endorse or promote products derived  *    from this software without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE NETBSD FOUNDATION, INC. AND CONTRIBUTORS  * ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED  * TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE FOUNDATION OR CONTRIBUTORS  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE  * POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_comment
comment|/*  * USB Open Host Controller driver.  *  * OHCI spec: ftp://ftp.compaq.com/pub/supportinformation/papers/hcir1_0a.exe  * USB spec: http://www.usb.org/developers/data/usb11.pdf  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__NetBSD__
argument_list|)
end_if

begin_include
include|#
directive|include
file|<sys/device.h>
end_include

begin_elif
elif|#
directive|elif
name|defined
argument_list|(
name|__FreeBSD__
argument_list|)
end_elif

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<sys/select.h>
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__FreeBSD__
argument_list|)
end_if

begin_include
include|#
directive|include
file|<machine/bus_pio.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus_memio.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/endian.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usbdi.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usbdivar.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb_quirks.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb_mem.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/ohcireg.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/ohcivar.h>
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__FreeBSD__
argument_list|)
end_if

begin_include
include|#
directive|include
file|<machine/clock.h>
end_include

begin_define
define|#
directive|define
name|delay
parameter_list|(
name|d
parameter_list|)
value|DELAY(d)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|OHCI_DEBUG
end_ifdef

begin_define
define|#
directive|define
name|DPRINTF
parameter_list|(
name|x
parameter_list|)
value|if (ohcidebug) logprintf x
end_define

begin_define
define|#
directive|define
name|DPRINTFN
parameter_list|(
name|n
parameter_list|,
name|x
parameter_list|)
value|if (ohcidebug>(n)) logprintf x
end_define

begin_decl_stmt
name|int
name|ohcidebug
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|DPRINTF
parameter_list|(
name|x
parameter_list|)
end_define

begin_define
define|#
directive|define
name|DPRINTFN
parameter_list|(
name|n
parameter_list|,
name|x
parameter_list|)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * The OHCI controller is little endian, so on big endian machines  * the data strored in memory needs to be swapped.  */
end_comment

begin_if
if|#
directive|if
name|BYTE_ORDER
operator|==
name|BIG_ENDIAN
end_if

begin_define
define|#
directive|define
name|LE
parameter_list|(
name|x
parameter_list|)
value|(bswap32(x))
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|LE
parameter_list|(
name|x
parameter_list|)
value|(x)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_struct_decl
struct_decl|struct
name|ohci_pipe
struct_decl|;
end_struct_decl

begin_decl_stmt
name|ohci_soft_ed_t
modifier|*
name|ohci_alloc_sed
name|__P
argument_list|(
operator|(
name|ohci_softc_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|ohci_free_sed
name|__P
argument_list|(
operator|(
name|ohci_softc_t
operator|*
operator|,
name|ohci_soft_ed_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|ohci_soft_td_t
modifier|*
name|ohci_alloc_std
name|__P
argument_list|(
operator|(
name|ohci_softc_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|ohci_free_std
name|__P
argument_list|(
operator|(
name|ohci_softc_t
operator|*
operator|,
name|ohci_soft_td_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|usbd_status
name|ohci_open
name|__P
argument_list|(
operator|(
name|usbd_pipe_handle
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|ohci_poll
name|__P
argument_list|(
operator|(
expr|struct
name|usbd_bus
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|ohci_waitintr
name|__P
argument_list|(
operator|(
name|ohci_softc_t
operator|*
operator|,
name|usbd_request_handle
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|ohci_rhsc
name|__P
argument_list|(
operator|(
name|ohci_softc_t
operator|*
operator|,
name|usbd_request_handle
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|ohci_process_done
name|__P
argument_list|(
operator|(
name|ohci_softc_t
operator|*
operator|,
name|ohci_physaddr_t
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|ohci_ii_done
name|__P
argument_list|(
operator|(
name|ohci_softc_t
operator|*
operator|,
name|usbd_request_handle
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|ohci_ctrl_done
name|__P
argument_list|(
operator|(
name|ohci_softc_t
operator|*
operator|,
name|usbd_request_handle
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|ohci_intr_done
name|__P
argument_list|(
operator|(
name|ohci_softc_t
operator|*
operator|,
name|usbd_request_handle
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|ohci_bulk_done
name|__P
argument_list|(
operator|(
name|ohci_softc_t
operator|*
operator|,
name|usbd_request_handle
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|usbd_status
name|ohci_device_request
name|__P
argument_list|(
operator|(
name|usbd_request_handle
name|reqh
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|ohci_add_ed
name|__P
argument_list|(
operator|(
name|ohci_soft_ed_t
operator|*
operator|,
name|ohci_soft_ed_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|ohci_rem_ed
name|__P
argument_list|(
operator|(
name|ohci_soft_ed_t
operator|*
operator|,
name|ohci_soft_ed_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|ohci_hash_add_td
name|__P
argument_list|(
operator|(
name|ohci_softc_t
operator|*
operator|,
name|ohci_soft_td_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|ohci_hash_rem_td
name|__P
argument_list|(
operator|(
name|ohci_softc_t
operator|*
operator|,
name|ohci_soft_td_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|ohci_soft_td_t
modifier|*
name|ohci_hash_find_td
name|__P
argument_list|(
operator|(
name|ohci_softc_t
operator|*
operator|,
name|ohci_physaddr_t
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|usbd_status
name|ohci_root_ctrl_transfer
name|__P
argument_list|(
operator|(
name|usbd_request_handle
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|usbd_status
name|ohci_root_ctrl_start
name|__P
argument_list|(
operator|(
name|usbd_request_handle
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|ohci_root_ctrl_abort
name|__P
argument_list|(
operator|(
name|usbd_request_handle
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|ohci_root_ctrl_close
name|__P
argument_list|(
operator|(
name|usbd_pipe_handle
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|usbd_status
name|ohci_root_intr_transfer
name|__P
argument_list|(
operator|(
name|usbd_request_handle
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|usbd_status
name|ohci_root_intr_start
name|__P
argument_list|(
operator|(
name|usbd_request_handle
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|ohci_root_intr_abort
name|__P
argument_list|(
operator|(
name|usbd_request_handle
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|ohci_root_intr_close
name|__P
argument_list|(
operator|(
name|usbd_pipe_handle
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|usbd_status
name|ohci_device_ctrl_transfer
name|__P
argument_list|(
operator|(
name|usbd_request_handle
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|usbd_status
name|ohci_device_ctrl_start
name|__P
argument_list|(
operator|(
name|usbd_request_handle
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|ohci_device_ctrl_abort
name|__P
argument_list|(
operator|(
name|usbd_request_handle
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|ohci_device_ctrl_close
name|__P
argument_list|(
operator|(
name|usbd_pipe_handle
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|usbd_status
name|ohci_device_bulk_transfer
name|__P
argument_list|(
operator|(
name|usbd_request_handle
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|usbd_status
name|ohci_device_bulk_start
name|__P
argument_list|(
operator|(
name|usbd_request_handle
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|ohci_device_bulk_abort
name|__P
argument_list|(
operator|(
name|usbd_request_handle
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|ohci_device_bulk_close
name|__P
argument_list|(
operator|(
name|usbd_pipe_handle
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|usbd_status
name|ohci_device_intr_transfer
name|__P
argument_list|(
operator|(
name|usbd_request_handle
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|usbd_status
name|ohci_device_intr_start
name|__P
argument_list|(
operator|(
name|usbd_request_handle
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|ohci_device_intr_abort
name|__P
argument_list|(
operator|(
name|usbd_request_handle
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|ohci_device_intr_close
name|__P
argument_list|(
operator|(
name|usbd_pipe_handle
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|usbd_status
name|ohci_device_setintr
name|__P
argument_list|(
operator|(
name|ohci_softc_t
operator|*
name|sc
operator|,
expr|struct
name|ohci_pipe
operator|*
name|pipe
operator|,
name|int
name|ival
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|ohci_str
name|__P
argument_list|(
operator|(
name|usb_string_descriptor_t
operator|*
operator|,
name|int
operator|,
name|char
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|ohci_timeout
name|__P
argument_list|(
operator|(
name|void
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|ohci_rhsc_able
name|__P
argument_list|(
operator|(
name|ohci_softc_t
operator|*
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|OHCI_DEBUG
end_ifdef

begin_decl_stmt
name|ohci_softc_t
modifier|*
name|thesc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|ohci_dumpregs
name|__P
argument_list|(
operator|(
name|ohci_softc_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|ohci_dump_tds
name|__P
argument_list|(
operator|(
name|ohci_soft_td_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|ohci_dump_td
name|__P
argument_list|(
operator|(
name|ohci_soft_td_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|ohci_dump_ed
name|__P
argument_list|(
operator|(
name|ohci_soft_ed_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|OWRITE4
parameter_list|(
name|sc
parameter_list|,
name|r
parameter_list|,
name|x
parameter_list|)
value|bus_space_write_4((sc)->iot, (sc)->ioh, (r), (x))
end_define

begin_define
define|#
directive|define
name|OREAD4
parameter_list|(
name|sc
parameter_list|,
name|r
parameter_list|)
value|bus_space_read_4((sc)->iot, (sc)->ioh, (r))
end_define

begin_define
define|#
directive|define
name|OREAD2
parameter_list|(
name|sc
parameter_list|,
name|r
parameter_list|)
value|bus_space_read_2((sc)->iot, (sc)->ioh, (r))
end_define

begin_comment
comment|/* Reverse the bits in a value 0 .. 31 */
end_comment

begin_decl_stmt
specifier|static
name|u_int8_t
name|revbits
index|[
name|OHCI_NO_INTRS
index|]
init|=
block|{
literal|0x00
block|,
literal|0x10
block|,
literal|0x08
block|,
literal|0x18
block|,
literal|0x04
block|,
literal|0x14
block|,
literal|0x0c
block|,
literal|0x1c
block|,
literal|0x02
block|,
literal|0x12
block|,
literal|0x0a
block|,
literal|0x1a
block|,
literal|0x06
block|,
literal|0x16
block|,
literal|0x0e
block|,
literal|0x1e
block|,
literal|0x01
block|,
literal|0x11
block|,
literal|0x09
block|,
literal|0x19
block|,
literal|0x05
block|,
literal|0x15
block|,
literal|0x0d
block|,
literal|0x1d
block|,
literal|0x03
block|,
literal|0x13
block|,
literal|0x0b
block|,
literal|0x1b
block|,
literal|0x07
block|,
literal|0x17
block|,
literal|0x0f
block|,
literal|0x1f
block|}
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|ohci_pipe
block|{
name|struct
name|usbd_pipe
name|pipe
decl_stmt|;
name|ohci_soft_ed_t
modifier|*
name|sed
decl_stmt|;
name|ohci_soft_td_t
modifier|*
name|tail
decl_stmt|;
comment|/* Info needed for different pipe kinds. */
union|union
block|{
comment|/* Control pipe */
struct|struct
block|{
name|usb_dma_t
name|datadma
decl_stmt|;
name|usb_dma_t
name|reqdma
decl_stmt|;
name|u_int
name|length
decl_stmt|;
name|ohci_soft_td_t
modifier|*
name|setup
decl_stmt|,
modifier|*
name|xfer
decl_stmt|,
modifier|*
name|stat
decl_stmt|;
block|}
name|ctl
struct|;
comment|/* Interrupt pipe */
struct|struct
block|{
name|usb_dma_t
name|datadma
decl_stmt|;
name|int
name|nslots
decl_stmt|;
name|int
name|pos
decl_stmt|;
block|}
name|intr
struct|;
comment|/* Bulk pipe */
struct|struct
block|{
name|usb_dma_t
name|datadma
decl_stmt|;
name|u_int
name|length
decl_stmt|;
block|}
name|bulk
struct|;
block|}
name|u
union|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|OHCI_INTR_ENDPT
value|1
end_define

begin_decl_stmt
name|struct
name|usbd_methods
name|ohci_root_ctrl_methods
init|=
block|{
name|ohci_root_ctrl_transfer
block|,
name|ohci_root_ctrl_start
block|,
name|ohci_root_ctrl_abort
block|,
name|ohci_root_ctrl_close
block|,
literal|0
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|usbd_methods
name|ohci_root_intr_methods
init|=
block|{
name|ohci_root_intr_transfer
block|,
name|ohci_root_intr_start
block|,
name|ohci_root_intr_abort
block|,
name|ohci_root_intr_close
block|,
literal|0
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|usbd_methods
name|ohci_device_ctrl_methods
init|=
block|{
name|ohci_device_ctrl_transfer
block|,
name|ohci_device_ctrl_start
block|,
name|ohci_device_ctrl_abort
block|,
name|ohci_device_ctrl_close
block|,
literal|0
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|usbd_methods
name|ohci_device_intr_methods
init|=
block|{
name|ohci_device_intr_transfer
block|,
name|ohci_device_intr_start
block|,
name|ohci_device_intr_abort
block|,
name|ohci_device_intr_close
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|usbd_methods
name|ohci_device_bulk_methods
init|=
block|{
name|ohci_device_bulk_transfer
block|,
name|ohci_device_bulk_start
block|,
name|ohci_device_bulk_abort
block|,
name|ohci_device_bulk_close
block|,
literal|0
block|, }
decl_stmt|;
end_decl_stmt

begin_function
name|ohci_soft_ed_t
modifier|*
name|ohci_alloc_sed
parameter_list|(
name|sc
parameter_list|)
name|ohci_softc_t
modifier|*
name|sc
decl_stmt|;
block|{
name|ohci_soft_ed_t
modifier|*
name|sed
decl_stmt|;
name|usbd_status
name|r
decl_stmt|;
name|int
name|i
decl_stmt|,
name|offs
decl_stmt|;
name|usb_dma_t
name|dma
decl_stmt|;
if|if
condition|(
operator|!
name|sc
operator|->
name|sc_freeeds
condition|)
block|{
name|DPRINTFN
argument_list|(
literal|2
argument_list|,
operator|(
literal|"ohci_alloc_sed: allocating chunk\n"
operator|)
argument_list|)
expr_stmt|;
name|sed
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|ohci_soft_ed_t
argument_list|)
operator|*
name|OHCI_ED_CHUNK
argument_list|,
name|M_USBDEV
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sed
condition|)
return|return
literal|0
return|;
name|r
operator|=
name|usb_allocmem
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
name|OHCI_ED_SIZE
operator|*
name|OHCI_ED_CHUNK
argument_list|,
name|OHCI_ED_ALIGN
argument_list|,
operator|&
name|dma
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|!=
name|USBD_NORMAL_COMPLETION
condition|)
block|{
name|free
argument_list|(
name|sed
argument_list|,
name|M_USBDEV
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|OHCI_ED_CHUNK
condition|;
name|i
operator|++
operator|,
name|sed
operator|++
control|)
block|{
name|offs
operator|=
name|i
operator|*
name|OHCI_ED_SIZE
expr_stmt|;
name|sed
operator|->
name|physaddr
operator|=
name|DMAADDR
argument_list|(
operator|&
name|dma
argument_list|)
operator|+
name|offs
expr_stmt|;
name|sed
operator|->
name|ed
operator|=
operator|(
name|ohci_ed_t
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|KERNADDR
argument_list|(
operator|&
name|dma
argument_list|)
operator|+
name|offs
operator|)
expr_stmt|;
name|sed
operator|->
name|next
operator|=
name|sc
operator|->
name|sc_freeeds
expr_stmt|;
name|sc
operator|->
name|sc_freeeds
operator|=
name|sed
expr_stmt|;
block|}
block|}
name|sed
operator|=
name|sc
operator|->
name|sc_freeeds
expr_stmt|;
name|sc
operator|->
name|sc_freeeds
operator|=
name|sed
operator|->
name|next
expr_stmt|;
name|memset
argument_list|(
name|sed
operator|->
name|ed
argument_list|,
literal|0
argument_list|,
name|OHCI_ED_SIZE
argument_list|)
expr_stmt|;
name|sed
operator|->
name|next
operator|=
literal|0
expr_stmt|;
return|return
name|sed
return|;
block|}
end_function

begin_function
name|void
name|ohci_free_sed
parameter_list|(
name|sc
parameter_list|,
name|sed
parameter_list|)
name|ohci_softc_t
modifier|*
name|sc
decl_stmt|;
name|ohci_soft_ed_t
modifier|*
name|sed
decl_stmt|;
block|{
name|sed
operator|->
name|next
operator|=
name|sc
operator|->
name|sc_freeeds
expr_stmt|;
name|sc
operator|->
name|sc_freeeds
operator|=
name|sed
expr_stmt|;
block|}
end_function

begin_function
name|ohci_soft_td_t
modifier|*
name|ohci_alloc_std
parameter_list|(
name|sc
parameter_list|)
name|ohci_softc_t
modifier|*
name|sc
decl_stmt|;
block|{
name|ohci_soft_td_t
modifier|*
name|std
decl_stmt|;
name|usbd_status
name|r
decl_stmt|;
name|int
name|i
decl_stmt|,
name|offs
decl_stmt|;
name|usb_dma_t
name|dma
decl_stmt|;
if|if
condition|(
operator|!
name|sc
operator|->
name|sc_freetds
condition|)
block|{
name|DPRINTFN
argument_list|(
literal|2
argument_list|,
operator|(
literal|"ohci_alloc_std: allocating chunk\n"
operator|)
argument_list|)
expr_stmt|;
name|std
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|ohci_soft_td_t
argument_list|)
operator|*
name|OHCI_TD_CHUNK
argument_list|,
name|M_USBDEV
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|std
condition|)
return|return
literal|0
return|;
name|r
operator|=
name|usb_allocmem
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
name|OHCI_TD_SIZE
operator|*
name|OHCI_TD_CHUNK
argument_list|,
name|OHCI_TD_ALIGN
argument_list|,
operator|&
name|dma
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|!=
name|USBD_NORMAL_COMPLETION
condition|)
block|{
name|free
argument_list|(
name|std
argument_list|,
name|M_USBDEV
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|OHCI_TD_CHUNK
condition|;
name|i
operator|++
operator|,
name|std
operator|++
control|)
block|{
name|offs
operator|=
name|i
operator|*
name|OHCI_TD_SIZE
expr_stmt|;
name|std
operator|->
name|physaddr
operator|=
name|DMAADDR
argument_list|(
operator|&
name|dma
argument_list|)
operator|+
name|offs
expr_stmt|;
name|std
operator|->
name|td
operator|=
operator|(
name|ohci_td_t
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|KERNADDR
argument_list|(
operator|&
name|dma
argument_list|)
operator|+
name|offs
operator|)
expr_stmt|;
name|std
operator|->
name|nexttd
operator|=
name|sc
operator|->
name|sc_freetds
expr_stmt|;
name|sc
operator|->
name|sc_freetds
operator|=
name|std
expr_stmt|;
block|}
block|}
name|std
operator|=
name|sc
operator|->
name|sc_freetds
expr_stmt|;
name|sc
operator|->
name|sc_freetds
operator|=
name|std
operator|->
name|nexttd
expr_stmt|;
name|memset
argument_list|(
name|std
operator|->
name|td
argument_list|,
literal|0
argument_list|,
name|OHCI_TD_SIZE
argument_list|)
expr_stmt|;
name|std
operator|->
name|nexttd
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|std
operator|)
return|;
block|}
end_function

begin_function
name|void
name|ohci_free_std
parameter_list|(
name|sc
parameter_list|,
name|std
parameter_list|)
name|ohci_softc_t
modifier|*
name|sc
decl_stmt|;
name|ohci_soft_td_t
modifier|*
name|std
decl_stmt|;
block|{
name|std
operator|->
name|nexttd
operator|=
name|sc
operator|->
name|sc_freetds
expr_stmt|;
name|sc
operator|->
name|sc_freetds
operator|=
name|std
expr_stmt|;
block|}
end_function

begin_function
name|usbd_status
name|ohci_init
parameter_list|(
name|sc
parameter_list|)
name|ohci_softc_t
modifier|*
name|sc
decl_stmt|;
block|{
name|ohci_soft_ed_t
modifier|*
name|sed
decl_stmt|,
modifier|*
name|psed
decl_stmt|;
name|usbd_status
name|r
decl_stmt|;
name|int
name|rev
decl_stmt|;
name|int
name|i
decl_stmt|;
name|u_int32_t
name|s
decl_stmt|,
name|ctl
decl_stmt|,
name|ival
decl_stmt|,
name|hcr
decl_stmt|,
name|fm
decl_stmt|,
name|per
decl_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"ohci_init: start\n"
operator|)
argument_list|)
expr_stmt|;
name|rev
operator|=
name|OREAD4
argument_list|(
name|sc
argument_list|,
name|OHCI_REVISION
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s: OHCI version %d.%d%s\n"
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_bus
operator|.
name|bdev
argument_list|)
argument_list|,
name|OHCI_REV_HI
argument_list|(
name|rev
argument_list|)
argument_list|,
name|OHCI_REV_LO
argument_list|(
name|rev
argument_list|)
argument_list|,
name|OHCI_REV_LEGACY
argument_list|(
name|rev
argument_list|)
condition|?
literal|", legacy support"
else|:
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|OHCI_REV_HI
argument_list|(
name|rev
argument_list|)
operator|!=
literal|1
operator|||
name|OHCI_REV_LO
argument_list|(
name|rev
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s: unsupported OHCI revision\n"
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_bus
operator|.
name|bdev
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|USBD_INVAL
operator|)
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|OHCI_HASH_SIZE
condition|;
name|i
operator|++
control|)
name|LIST_INIT
argument_list|(
operator|&
name|sc
operator|->
name|sc_hash_tds
index|[
name|i
index|]
argument_list|)
expr_stmt|;
comment|/* Allocate the HCCA area. */
name|r
operator|=
name|usb_allocmem
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
name|OHCI_HCCA_SIZE
argument_list|,
name|OHCI_HCCA_ALIGN
argument_list|,
operator|&
name|sc
operator|->
name|sc_hccadma
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|!=
name|USBD_NORMAL_COMPLETION
condition|)
return|return
operator|(
name|r
operator|)
return|;
name|sc
operator|->
name|sc_hcca
operator|=
operator|(
expr|struct
name|ohci_hcca
operator|*
operator|)
name|KERNADDR
argument_list|(
operator|&
name|sc
operator|->
name|sc_hccadma
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|sc
operator|->
name|sc_hcca
argument_list|,
literal|0
argument_list|,
name|OHCI_HCCA_SIZE
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_eintrs
operator|=
name|OHCI_NORMAL_INTRS
expr_stmt|;
name|sc
operator|->
name|sc_ctrl_head
operator|=
name|ohci_alloc_sed
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sc
operator|->
name|sc_ctrl_head
condition|)
block|{
name|r
operator|=
name|USBD_NOMEM
expr_stmt|;
goto|goto
name|bad1
goto|;
block|}
name|sc
operator|->
name|sc_ctrl_head
operator|->
name|ed
operator|->
name|ed_flags
operator||=
name|LE
argument_list|(
name|OHCI_ED_SKIP
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_bulk_head
operator|=
name|ohci_alloc_sed
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sc
operator|->
name|sc_bulk_head
condition|)
block|{
name|r
operator|=
name|USBD_NOMEM
expr_stmt|;
goto|goto
name|bad2
goto|;
block|}
name|sc
operator|->
name|sc_bulk_head
operator|->
name|ed
operator|->
name|ed_flags
operator||=
name|LE
argument_list|(
name|OHCI_ED_SKIP
argument_list|)
expr_stmt|;
comment|/* Allocate all the dummy EDs that make up the interrupt tree. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|OHCI_NO_EDS
condition|;
name|i
operator|++
control|)
block|{
name|sed
operator|=
name|ohci_alloc_sed
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sed
condition|)
block|{
while|while
condition|(
operator|--
name|i
operator|>=
literal|0
condition|)
name|ohci_free_sed
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|sc_eds
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|r
operator|=
name|USBD_NOMEM
expr_stmt|;
goto|goto
name|bad3
goto|;
block|}
comment|/* All ED fields are set to 0. */
name|sc
operator|->
name|sc_eds
index|[
name|i
index|]
operator|=
name|sed
expr_stmt|;
name|sed
operator|->
name|ed
operator|->
name|ed_flags
operator||=
name|LE
argument_list|(
name|OHCI_ED_SKIP
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|!=
literal|0
condition|)
block|{
name|psed
operator|=
name|sc
operator|->
name|sc_eds
index|[
operator|(
name|i
operator|-
literal|1
operator|)
operator|/
literal|2
index|]
expr_stmt|;
name|sed
operator|->
name|next
operator|=
name|psed
expr_stmt|;
name|sed
operator|->
name|ed
operator|->
name|ed_nexted
operator|=
name|LE
argument_list|(
name|psed
operator|->
name|physaddr
argument_list|)
expr_stmt|;
block|}
block|}
comment|/*  	 * Fill HCCA interrupt table.  The bit reversal is to get 	 * the tree set up properly to spread the interrupts. 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|OHCI_NO_INTRS
condition|;
name|i
operator|++
control|)
name|sc
operator|->
name|sc_hcca
operator|->
name|hcca_interrupt_table
index|[
name|revbits
index|[
name|i
index|]
index|]
operator|=
name|LE
argument_list|(
name|sc
operator|->
name|sc_eds
index|[
name|OHCI_NO_EDS
operator|-
name|OHCI_NO_INTRS
operator|+
name|i
index|]
operator|->
name|physaddr
argument_list|)
expr_stmt|;
comment|/* Determine in what context we are running. */
name|ctl
operator|=
name|OREAD4
argument_list|(
name|sc
argument_list|,
name|OHCI_CONTROL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctl
operator|&
name|OHCI_IR
condition|)
block|{
comment|/* SMM active, request change */
name|DPRINTF
argument_list|(
operator|(
literal|"ohci_init: SMM active, request owner change\n"
operator|)
argument_list|)
expr_stmt|;
name|s
operator|=
name|OREAD4
argument_list|(
name|sc
argument_list|,
name|OHCI_COMMAND_STATUS
argument_list|)
expr_stmt|;
name|OWRITE4
argument_list|(
name|sc
argument_list|,
name|OHCI_COMMAND_STATUS
argument_list|,
name|s
operator||
name|OHCI_OCR
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|100
operator|&&
operator|(
name|ctl
operator|&
name|OHCI_IR
operator|)
condition|;
name|i
operator|++
control|)
block|{
name|delay
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
name|ctl
operator|=
name|OREAD4
argument_list|(
name|sc
argument_list|,
name|OHCI_CONTROL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|ctl
operator|&
name|OHCI_IR
operator|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s: SMM does not respond, resetting\n"
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_bus
operator|.
name|bdev
argument_list|)
argument_list|)
expr_stmt|;
name|OWRITE4
argument_list|(
name|sc
argument_list|,
name|OHCI_CONTROL
argument_list|,
name|OHCI_HCFS_RESET
argument_list|)
expr_stmt|;
goto|goto
name|reset
goto|;
block|}
block|}
elseif|else
if|if
condition|(
operator|(
name|ctl
operator|&
name|OHCI_HCFS_MASK
operator|)
operator|!=
name|OHCI_HCFS_RESET
condition|)
block|{
comment|/* BIOS started controller. */
name|DPRINTF
argument_list|(
operator|(
literal|"ohci_init: BIOS active\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ctl
operator|&
name|OHCI_HCFS_MASK
operator|)
operator|!=
name|OHCI_HCFS_OPERATIONAL
condition|)
block|{
name|OWRITE4
argument_list|(
name|sc
argument_list|,
name|OHCI_CONTROL
argument_list|,
name|OHCI_HCFS_OPERATIONAL
argument_list|)
expr_stmt|;
name|delay
argument_list|(
name|USB_RESUME_DELAY
operator|*
literal|1000
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"ohci_init: cold started\n"
operator|)
argument_list|)
expr_stmt|;
name|reset
label|:
comment|/* Controller was cold started. */
name|delay
argument_list|(
name|USB_BUS_RESET_DELAY
operator|*
literal|1000
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * This reset should not be necessary according to the OHCI spec, but 	 * without it some controllers do not start. 	 */
name|DPRINTF
argument_list|(
operator|(
literal|"%s: resetting\n"
operator|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_bus
operator|.
name|bdev
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|OWRITE4
argument_list|(
name|sc
argument_list|,
name|OHCI_CONTROL
argument_list|,
name|OHCI_HCFS_RESET
argument_list|)
expr_stmt|;
name|delay
argument_list|(
name|USB_BUS_RESET_DELAY
operator|*
literal|1000
argument_list|)
expr_stmt|;
comment|/* We now own the host controller and the bus has been reset. */
name|ival
operator|=
name|OHCI_GET_IVAL
argument_list|(
name|OREAD4
argument_list|(
name|sc
argument_list|,
name|OHCI_FM_INTERVAL
argument_list|)
argument_list|)
expr_stmt|;
name|OWRITE4
argument_list|(
name|sc
argument_list|,
name|OHCI_COMMAND_STATUS
argument_list|,
name|OHCI_HCR
argument_list|)
expr_stmt|;
comment|/* Reset HC */
comment|/* Nominal time for a reset is 10 us. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|10
condition|;
name|i
operator|++
control|)
block|{
name|delay
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|hcr
operator|=
name|OREAD4
argument_list|(
name|sc
argument_list|,
name|OHCI_COMMAND_STATUS
argument_list|)
operator|&
name|OHCI_HCR
expr_stmt|;
if|if
condition|(
operator|!
name|hcr
condition|)
break|break;
block|}
if|if
condition|(
name|hcr
condition|)
block|{
name|printf
argument_list|(
literal|"%s: reset timeout\n"
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_bus
operator|.
name|bdev
argument_list|)
argument_list|)
expr_stmt|;
name|r
operator|=
name|USBD_IOERROR
expr_stmt|;
goto|goto
name|bad3
goto|;
block|}
ifdef|#
directive|ifdef
name|OHCI_DEBUG
name|thesc
operator|=
name|sc
expr_stmt|;
if|if
condition|(
name|ohcidebug
operator|>
literal|15
condition|)
name|ohci_dumpregs
argument_list|(
name|sc
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* The controller is now in suspend state, we have 2ms to finish. */
comment|/* Set up HC registers. */
name|OWRITE4
argument_list|(
name|sc
argument_list|,
name|OHCI_HCCA
argument_list|,
name|DMAADDR
argument_list|(
operator|&
name|sc
operator|->
name|sc_hccadma
argument_list|)
argument_list|)
expr_stmt|;
name|OWRITE4
argument_list|(
name|sc
argument_list|,
name|OHCI_CONTROL_HEAD_ED
argument_list|,
name|sc
operator|->
name|sc_ctrl_head
operator|->
name|physaddr
argument_list|)
expr_stmt|;
name|OWRITE4
argument_list|(
name|sc
argument_list|,
name|OHCI_BULK_HEAD_ED
argument_list|,
name|sc
operator|->
name|sc_bulk_head
operator|->
name|physaddr
argument_list|)
expr_stmt|;
name|OWRITE4
argument_list|(
name|sc
argument_list|,
name|OHCI_INTERRUPT_DISABLE
argument_list|,
name|OHCI_ALL_INTRS
argument_list|)
expr_stmt|;
name|OWRITE4
argument_list|(
name|sc
argument_list|,
name|OHCI_INTERRUPT_ENABLE
argument_list|,
name|sc
operator|->
name|sc_eintrs
operator||
name|OHCI_MIE
argument_list|)
expr_stmt|;
name|ctl
operator|=
name|OREAD4
argument_list|(
name|sc
argument_list|,
name|OHCI_CONTROL
argument_list|)
expr_stmt|;
name|ctl
operator|&=
operator|~
operator|(
name|OHCI_CBSR_MASK
operator||
name|OHCI_LES
operator||
name|OHCI_HCFS_MASK
operator||
name|OHCI_IR
operator|)
expr_stmt|;
name|ctl
operator||=
name|OHCI_PLE
operator||
name|OHCI_IE
operator||
name|OHCI_CLE
operator||
name|OHCI_BLE
operator||
name|OHCI_RATIO_1_4
operator||
name|OHCI_HCFS_OPERATIONAL
expr_stmt|;
comment|/* And finally start it! */
name|OWRITE4
argument_list|(
name|sc
argument_list|,
name|OHCI_CONTROL
argument_list|,
name|ctl
argument_list|)
expr_stmt|;
comment|/* 	 * The controller is now OPERATIONAL.  Set a some final 	 * registers that should be set earlier, but that the 	 * controller ignores when in the SUSPEND state. 	 */
name|fm
operator|=
operator|(
name|OREAD4
argument_list|(
name|sc
argument_list|,
name|OHCI_FM_INTERVAL
argument_list|)
operator|&
name|OHCI_FIT
operator|)
operator|^
name|OHCI_FIT
expr_stmt|;
name|fm
operator||=
name|OHCI_FSMPS
argument_list|(
name|ival
argument_list|)
operator||
name|ival
expr_stmt|;
name|OWRITE4
argument_list|(
name|sc
argument_list|,
name|OHCI_FM_INTERVAL
argument_list|,
name|fm
argument_list|)
expr_stmt|;
name|per
operator|=
name|OHCI_PERIODIC
argument_list|(
name|ival
argument_list|)
expr_stmt|;
comment|/* 90% periodic */
name|OWRITE4
argument_list|(
name|sc
argument_list|,
name|OHCI_PERIODIC_START
argument_list|,
name|per
argument_list|)
expr_stmt|;
name|OWRITE4
argument_list|(
name|sc
argument_list|,
name|OHCI_RH_STATUS
argument_list|,
name|OHCI_LPSC
argument_list|)
expr_stmt|;
comment|/* Enable port power */
name|sc
operator|->
name|sc_noport
operator|=
name|OHCI_GET_NDP
argument_list|(
name|OREAD4
argument_list|(
name|sc
argument_list|,
name|OHCI_RH_DESCRIPTOR_A
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|OHCI_DEBUG
if|if
condition|(
name|ohcidebug
operator|>
literal|5
condition|)
name|ohci_dumpregs
argument_list|(
name|sc
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* Set up the bus struct. */
name|sc
operator|->
name|sc_bus
operator|.
name|open_pipe
operator|=
name|ohci_open
expr_stmt|;
name|sc
operator|->
name|sc_bus
operator|.
name|pipe_size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ohci_pipe
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_bus
operator|.
name|do_poll
operator|=
name|ohci_poll
expr_stmt|;
return|return
operator|(
name|USBD_NORMAL_COMPLETION
operator|)
return|;
name|bad3
label|:
name|ohci_free_sed
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|sc_ctrl_head
argument_list|)
expr_stmt|;
name|bad2
label|:
name|ohci_free_sed
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|sc_bulk_head
argument_list|)
expr_stmt|;
name|bad1
label|:
name|usb_freemem
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
operator|&
name|sc
operator|->
name|sc_hccadma
argument_list|)
expr_stmt|;
return|return
operator|(
name|r
operator|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|OHCI_DEBUG
end_ifdef

begin_function_decl
name|void
name|ohcidump
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|void
name|ohcidump
parameter_list|(
name|void
parameter_list|)
block|{
name|ohci_dumpregs
argument_list|(
name|thesc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ohci_dumpregs
parameter_list|(
name|sc
parameter_list|)
name|ohci_softc_t
modifier|*
name|sc
decl_stmt|;
block|{
name|printf
argument_list|(
literal|"ohci_dumpregs: rev=0x%08x control=0x%08x command=0x%08x\n"
argument_list|,
name|OREAD4
argument_list|(
name|sc
argument_list|,
name|OHCI_REVISION
argument_list|)
argument_list|,
name|OREAD4
argument_list|(
name|sc
argument_list|,
name|OHCI_CONTROL
argument_list|)
argument_list|,
name|OREAD4
argument_list|(
name|sc
argument_list|,
name|OHCI_COMMAND_STATUS
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"               intrstat=0x%08x intre=0x%08x intrd=0x%08x\n"
argument_list|,
name|OREAD4
argument_list|(
name|sc
argument_list|,
name|OHCI_INTERRUPT_STATUS
argument_list|)
argument_list|,
name|OREAD4
argument_list|(
name|sc
argument_list|,
name|OHCI_INTERRUPT_ENABLE
argument_list|)
argument_list|,
name|OREAD4
argument_list|(
name|sc
argument_list|,
name|OHCI_INTERRUPT_DISABLE
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"               hcca=0x%08x percur=0x%08x ctrlhd=0x%08x\n"
argument_list|,
name|OREAD4
argument_list|(
name|sc
argument_list|,
name|OHCI_HCCA
argument_list|)
argument_list|,
name|OREAD4
argument_list|(
name|sc
argument_list|,
name|OHCI_PERIOD_CURRENT_ED
argument_list|)
argument_list|,
name|OREAD4
argument_list|(
name|sc
argument_list|,
name|OHCI_CONTROL_HEAD_ED
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"               ctrlcur=0x%08x bulkhd=0x%08x bulkcur=0x%08x\n"
argument_list|,
name|OREAD4
argument_list|(
name|sc
argument_list|,
name|OHCI_CONTROL_CURRENT_ED
argument_list|)
argument_list|,
name|OREAD4
argument_list|(
name|sc
argument_list|,
name|OHCI_BULK_HEAD_ED
argument_list|)
argument_list|,
name|OREAD4
argument_list|(
name|sc
argument_list|,
name|OHCI_BULK_CURRENT_ED
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"               done=0x%08x fmival=0x%08x fmrem=0x%08x\n"
argument_list|,
name|OREAD4
argument_list|(
name|sc
argument_list|,
name|OHCI_DONE_HEAD
argument_list|)
argument_list|,
name|OREAD4
argument_list|(
name|sc
argument_list|,
name|OHCI_FM_INTERVAL
argument_list|)
argument_list|,
name|OREAD4
argument_list|(
name|sc
argument_list|,
name|OHCI_FM_REMAINING
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"               fmnum=0x%08x perst=0x%08x lsthrs=0x%08x\n"
argument_list|,
name|OREAD4
argument_list|(
name|sc
argument_list|,
name|OHCI_FM_NUMBER
argument_list|)
argument_list|,
name|OREAD4
argument_list|(
name|sc
argument_list|,
name|OHCI_PERIODIC_START
argument_list|)
argument_list|,
name|OREAD4
argument_list|(
name|sc
argument_list|,
name|OHCI_LS_THRESHOLD
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"               desca=0x%08x descb=0x%08x stat=0x%08x\n"
argument_list|,
name|OREAD4
argument_list|(
name|sc
argument_list|,
name|OHCI_RH_DESCRIPTOR_A
argument_list|)
argument_list|,
name|OREAD4
argument_list|(
name|sc
argument_list|,
name|OHCI_RH_DESCRIPTOR_B
argument_list|)
argument_list|,
name|OREAD4
argument_list|(
name|sc
argument_list|,
name|OHCI_RH_STATUS
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"               port1=0x%08x port2=0x%08x\n"
argument_list|,
name|OREAD4
argument_list|(
name|sc
argument_list|,
name|OHCI_RH_PORT_STATUS
argument_list|(
literal|1
argument_list|)
argument_list|)
argument_list|,
name|OREAD4
argument_list|(
name|sc
argument_list|,
name|OHCI_RH_PORT_STATUS
argument_list|(
literal|2
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"         HCCA: frame_number=0x%04x done_head=0x%08x\n"
argument_list|,
name|LE
argument_list|(
name|sc
operator|->
name|sc_hcca
operator|->
name|hcca_frame_number
argument_list|)
argument_list|,
name|LE
argument_list|(
name|sc
operator|->
name|sc_hcca
operator|->
name|hcca_done_head
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|int
name|ohci_intr
parameter_list|(
name|p
parameter_list|)
name|void
modifier|*
name|p
decl_stmt|;
block|{
name|ohci_softc_t
modifier|*
name|sc
init|=
name|p
decl_stmt|;
name|u_int32_t
name|intrs
decl_stmt|,
name|eintrs
decl_stmt|;
name|ohci_physaddr_t
name|done
decl_stmt|;
comment|/* In case the interrupt occurs before initialization has completed. */
if|if
condition|(
name|sc
operator|==
name|NULL
operator|||
name|sc
operator|->
name|sc_hcca
operator|==
name|NULL
condition|)
block|{
comment|/* NWH added sc==0 */
ifdef|#
directive|ifdef
name|DIAGNOSTIC
name|printf
argument_list|(
literal|"ohci_intr: sc->sc_hcca == NULL\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|intrs
operator|=
literal|0
expr_stmt|;
name|done
operator|=
name|LE
argument_list|(
name|sc
operator|->
name|sc_hcca
operator|->
name|hcca_done_head
argument_list|)
expr_stmt|;
if|if
condition|(
name|done
operator|!=
literal|0
condition|)
block|{
name|sc
operator|->
name|sc_hcca
operator|->
name|hcca_done_head
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|done
operator|&
operator|~
name|OHCI_DONE_INTRS
condition|)
name|intrs
operator|=
name|OHCI_WDH
expr_stmt|;
if|if
condition|(
name|done
operator|&
name|OHCI_DONE_INTRS
condition|)
name|intrs
operator||=
name|OREAD4
argument_list|(
name|sc
argument_list|,
name|OHCI_INTERRUPT_STATUS
argument_list|)
expr_stmt|;
block|}
else|else
name|intrs
operator|=
name|OREAD4
argument_list|(
name|sc
argument_list|,
name|OHCI_INTERRUPT_STATUS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|intrs
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|intrs
operator|&=
operator|~
name|OHCI_MIE
expr_stmt|;
name|OWRITE4
argument_list|(
name|sc
argument_list|,
name|OHCI_INTERRUPT_STATUS
argument_list|,
name|intrs
argument_list|)
expr_stmt|;
comment|/* Acknowledge */
name|eintrs
operator|=
name|intrs
operator|&
name|sc
operator|->
name|sc_eintrs
expr_stmt|;
if|if
condition|(
operator|!
name|eintrs
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|sc
operator|->
name|sc_intrs
operator|++
expr_stmt|;
name|DPRINTFN
argument_list|(
literal|7
argument_list|,
operator|(
literal|"ohci_intr: sc=%p intrs=%x(%x) eintr=%x\n"
operator|,
name|sc
operator|,
operator|(
name|u_int
operator|)
name|intrs
operator|,
name|OREAD4
argument_list|(
name|sc
argument_list|,
name|OHCI_INTERRUPT_STATUS
argument_list|)
operator|,
operator|(
name|u_int
operator|)
name|eintrs
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|eintrs
operator|&
name|OHCI_SO
condition|)
block|{
name|printf
argument_list|(
literal|"%s: scheduling overrun\n"
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_bus
operator|.
name|bdev
argument_list|)
argument_list|)
expr_stmt|;
comment|/* XXX do what */
name|intrs
operator|&=
operator|~
name|OHCI_SO
expr_stmt|;
block|}
if|if
condition|(
name|eintrs
operator|&
name|OHCI_WDH
condition|)
block|{
name|ohci_process_done
argument_list|(
name|sc
argument_list|,
name|done
operator|&
operator|~
name|OHCI_DONE_INTRS
argument_list|)
expr_stmt|;
name|intrs
operator|&=
operator|~
name|OHCI_WDH
expr_stmt|;
block|}
if|if
condition|(
name|eintrs
operator|&
name|OHCI_RD
condition|)
block|{
comment|/* XXX process resume detect */
block|}
if|if
condition|(
name|eintrs
operator|&
name|OHCI_UE
condition|)
block|{
name|printf
argument_list|(
literal|"%s: unrecoverable error, controller halted\n"
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_bus
operator|.
name|bdev
argument_list|)
argument_list|)
expr_stmt|;
name|OWRITE4
argument_list|(
name|sc
argument_list|,
name|OHCI_CONTROL
argument_list|,
name|OHCI_HCFS_RESET
argument_list|)
expr_stmt|;
comment|/* XXX what else */
block|}
if|if
condition|(
name|eintrs
operator|&
name|OHCI_RHSC
condition|)
block|{
name|ohci_rhsc
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|sc_intrreqh
argument_list|)
expr_stmt|;
name|intrs
operator|&=
operator|~
name|OHCI_RHSC
expr_stmt|;
comment|/*  		 * Disable RHSC interrupt for now, because it will be 		 * on until the port has been reset. 		 */
name|ohci_rhsc_able
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
comment|/* Block unprocessed interrupts. XXX */
name|OWRITE4
argument_list|(
name|sc
argument_list|,
name|OHCI_INTERRUPT_DISABLE
argument_list|,
name|intrs
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_eintrs
operator|&=
operator|~
name|intrs
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
name|void
name|ohci_rhsc_able
parameter_list|(
name|sc
parameter_list|,
name|on
parameter_list|)
name|ohci_softc_t
modifier|*
name|sc
decl_stmt|;
name|int
name|on
decl_stmt|;
block|{
name|DPRINTFN
argument_list|(
literal|4
argument_list|,
operator|(
literal|"ohci_rhsc_able: on=%d\n"
operator|,
name|on
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|on
condition|)
block|{
name|sc
operator|->
name|sc_eintrs
operator||=
name|OHCI_RHSC
expr_stmt|;
name|OWRITE4
argument_list|(
name|sc
argument_list|,
name|OHCI_INTERRUPT_ENABLE
argument_list|,
name|OHCI_RHSC
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|sc
operator|->
name|sc_eintrs
operator|&=
operator|~
name|OHCI_RHSC
expr_stmt|;
name|OWRITE4
argument_list|(
name|sc
argument_list|,
name|OHCI_INTERRUPT_DISABLE
argument_list|,
name|OHCI_RHSC
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|OHCI_DEBUG
end_ifdef

begin_decl_stmt
name|char
modifier|*
name|ohci_cc_strs
index|[]
init|=
block|{
literal|"NO_ERROR"
block|,
literal|"CRC"
block|,
literal|"BIT_STUFFING"
block|,
literal|"DATA_TOGGLE_MISMATCH"
block|,
literal|"STALL"
block|,
literal|"DEVICE_NOT_RESPONDING"
block|,
literal|"PID_CHECK_FAILURE"
block|,
literal|"UNEXPECTED_PID"
block|,
literal|"DATA_OVERRUN"
block|,
literal|"DATA_UNDERRUN"
block|,
literal|"BUFFER_OVERRUN"
block|,
literal|"BUFFER_UNDERRUN"
block|,
literal|"NOT_ACCESSED"
block|, }
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|void
name|ohci_process_done
parameter_list|(
name|sc
parameter_list|,
name|done
parameter_list|)
name|ohci_softc_t
modifier|*
name|sc
decl_stmt|;
name|ohci_physaddr_t
name|done
decl_stmt|;
block|{
name|ohci_soft_td_t
modifier|*
name|std
decl_stmt|,
modifier|*
name|sdone
decl_stmt|;
name|usbd_request_handle
name|reqh
decl_stmt|;
name|int
name|len
decl_stmt|,
name|cc
decl_stmt|;
name|DPRINTFN
argument_list|(
literal|10
argument_list|,
operator|(
literal|"ohci_process_done: done=0x%08lx\n"
operator|,
operator|(
name|u_long
operator|)
name|done
operator|)
argument_list|)
expr_stmt|;
comment|/* Reverse the done list. */
for|for
control|(
name|sdone
operator|=
literal|0
init|;
name|done
condition|;
name|done
operator|=
name|LE
argument_list|(
name|std
operator|->
name|td
operator|->
name|td_nexttd
argument_list|)
control|)
block|{
name|std
operator|=
name|ohci_hash_find_td
argument_list|(
name|sc
argument_list|,
name|done
argument_list|)
expr_stmt|;
name|std
operator|->
name|dnext
operator|=
name|sdone
expr_stmt|;
name|sdone
operator|=
name|std
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|OHCI_DEBUG
if|if
condition|(
name|ohcidebug
operator|>
literal|11
condition|)
block|{
name|printf
argument_list|(
literal|"ohci_process_done: TD done:\n"
argument_list|)
expr_stmt|;
name|ohci_dump_tds
argument_list|(
name|sdone
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
for|for
control|(
name|std
operator|=
name|sdone
init|;
name|std
condition|;
name|std
operator|=
name|std
operator|->
name|dnext
control|)
block|{
name|reqh
operator|=
name|std
operator|->
name|reqh
expr_stmt|;
name|DPRINTFN
argument_list|(
literal|10
argument_list|,
operator|(
literal|"ohci_process_done: std=%p reqh=%p hcpriv=%p\n"
operator|,
name|std
operator|,
name|reqh
operator|,
name|reqh
operator|->
name|hcpriv
operator|)
argument_list|)
expr_stmt|;
name|cc
operator|=
name|OHCI_TD_GET_CC
argument_list|(
name|LE
argument_list|(
name|std
operator|->
name|td
operator|->
name|td_flags
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cc
operator|==
name|OHCI_CC_NO_ERROR
condition|)
block|{
if|if
condition|(
name|std
operator|->
name|td
operator|->
name|td_cbp
operator|==
literal|0
condition|)
name|len
operator|=
name|std
operator|->
name|len
expr_stmt|;
else|else
name|len
operator|=
name|LE
argument_list|(
name|std
operator|->
name|td
operator|->
name|td_be
argument_list|)
operator|-
name|LE
argument_list|(
name|std
operator|->
name|td
operator|->
name|td_cbp
argument_list|)
operator|+
literal|1
expr_stmt|;
comment|/*  			 * Only do a callback on the last stage of a transfer. 			 * Others have hcpriv = 0. 			 */
if|if
condition|(
operator|(
name|reqh
operator|->
name|pipe
operator|->
name|endpoint
operator|->
name|edesc
operator|->
name|bmAttributes
operator|&
name|UE_XFERTYPE
operator|)
operator|==
name|UE_CONTROL
condition|)
block|{
comment|/* For a control transfer the length is in 				 * the xfer stage */
if|if
condition|(
name|reqh
operator|->
name|hcpriv
operator|==
name|std
condition|)
block|{
name|reqh
operator|->
name|status
operator|=
name|USBD_NORMAL_COMPLETION
expr_stmt|;
name|ohci_ii_done
argument_list|(
name|sc
argument_list|,
name|reqh
argument_list|)
expr_stmt|;
block|}
else|else
name|reqh
operator|->
name|actlen
operator|=
name|len
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|reqh
operator|->
name|hcpriv
operator|==
name|std
condition|)
block|{
name|reqh
operator|->
name|actlen
operator|=
name|len
expr_stmt|;
name|reqh
operator|->
name|status
operator|=
name|USBD_NORMAL_COMPLETION
expr_stmt|;
name|ohci_ii_done
argument_list|(
name|sc
argument_list|,
name|reqh
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|ohci_soft_td_t
modifier|*
name|p
decl_stmt|,
modifier|*
name|n
decl_stmt|;
name|struct
name|ohci_pipe
modifier|*
name|opipe
init|=
operator|(
expr|struct
name|ohci_pipe
operator|*
operator|)
name|reqh
operator|->
name|pipe
decl_stmt|;
name|DPRINTFN
argument_list|(
operator|-
literal|1
argument_list|,
operator|(
literal|"ohci_process_done: error cc=%d (%s)\n"
operator|,
name|OHCI_TD_GET_CC
argument_list|(
name|LE
argument_list|(
name|std
operator|->
name|td
operator|->
name|td_flags
argument_list|)
argument_list|)
operator|,
name|ohci_cc_strs
index|[
name|OHCI_TD_GET_CC
argument_list|(
name|LE
argument_list|(
name|std
operator|->
name|td
operator|->
name|td_flags
argument_list|)
argument_list|)
index|]
operator|)
argument_list|)
expr_stmt|;
comment|/* 			 * Endpoint is halted.  First unlink all the TDs 			 * belonging to the failed transfer, and then restart 			 * the endpoint. 			 */
for|for
control|(
name|p
operator|=
name|std
operator|->
name|nexttd
init|;
name|p
operator|->
name|reqh
operator|==
name|reqh
condition|;
name|p
operator|=
name|n
control|)
block|{
name|n
operator|=
name|p
operator|->
name|nexttd
expr_stmt|;
name|ohci_hash_rem_td
argument_list|(
name|sc
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|ohci_free_std
argument_list|(
name|sc
argument_list|,
name|p
argument_list|)
expr_stmt|;
block|}
comment|/* clear halt */
name|opipe
operator|->
name|sed
operator|->
name|ed
operator|->
name|ed_headp
operator|=
name|LE
argument_list|(
name|p
operator|->
name|physaddr
argument_list|)
expr_stmt|;
name|OWRITE4
argument_list|(
name|sc
argument_list|,
name|OHCI_COMMAND_STATUS
argument_list|,
name|OHCI_CLF
argument_list|)
expr_stmt|;
if|if
condition|(
name|cc
operator|==
name|OHCI_CC_STALL
condition|)
name|reqh
operator|->
name|status
operator|=
name|USBD_STALLED
expr_stmt|;
else|else
name|reqh
operator|->
name|status
operator|=
name|USBD_IOERROR
expr_stmt|;
name|ohci_ii_done
argument_list|(
name|sc
argument_list|,
name|reqh
argument_list|)
expr_stmt|;
block|}
name|ohci_hash_rem_td
argument_list|(
name|sc
argument_list|,
name|std
argument_list|)
expr_stmt|;
name|ohci_free_std
argument_list|(
name|sc
argument_list|,
name|std
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|ohci_ii_done
parameter_list|(
name|sc
parameter_list|,
name|reqh
parameter_list|)
name|ohci_softc_t
modifier|*
name|sc
decl_stmt|;
name|usbd_request_handle
name|reqh
decl_stmt|;
block|{
switch|switch
condition|(
name|reqh
operator|->
name|pipe
operator|->
name|endpoint
operator|->
name|edesc
operator|->
name|bmAttributes
operator|&
name|UE_XFERTYPE
condition|)
block|{
case|case
name|UE_CONTROL
case|:
name|ohci_ctrl_done
argument_list|(
name|sc
argument_list|,
name|reqh
argument_list|)
expr_stmt|;
name|usb_start_next
argument_list|(
name|reqh
operator|->
name|pipe
argument_list|)
expr_stmt|;
break|break;
case|case
name|UE_INTERRUPT
case|:
name|ohci_intr_done
argument_list|(
name|sc
argument_list|,
name|reqh
argument_list|)
expr_stmt|;
break|break;
case|case
name|UE_BULK
case|:
name|ohci_bulk_done
argument_list|(
name|sc
argument_list|,
name|reqh
argument_list|)
expr_stmt|;
name|usb_start_next
argument_list|(
name|reqh
operator|->
name|pipe
argument_list|)
expr_stmt|;
break|break;
case|case
name|UE_ISOCHRONOUS
case|:
name|printf
argument_list|(
literal|"ohci_process_done: ISO done?\n"
argument_list|)
expr_stmt|;
name|usb_start_next
argument_list|(
name|reqh
operator|->
name|pipe
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* And finally execute callback. */
name|reqh
operator|->
name|xfercb
argument_list|(
name|reqh
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ohci_ctrl_done
parameter_list|(
name|sc
parameter_list|,
name|reqh
parameter_list|)
name|ohci_softc_t
modifier|*
name|sc
decl_stmt|;
name|usbd_request_handle
name|reqh
decl_stmt|;
block|{
name|struct
name|ohci_pipe
modifier|*
name|opipe
init|=
operator|(
expr|struct
name|ohci_pipe
operator|*
operator|)
name|reqh
operator|->
name|pipe
decl_stmt|;
name|u_int
name|len
init|=
name|opipe
operator|->
name|u
operator|.
name|ctl
operator|.
name|length
decl_stmt|;
name|usb_dma_t
modifier|*
name|dma
decl_stmt|;
name|DPRINTFN
argument_list|(
literal|10
argument_list|,
operator|(
literal|"ohci_ctrl_done: reqh=%p\n"
operator|,
name|reqh
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|reqh
operator|->
name|isreq
condition|)
block|{
name|panic
argument_list|(
literal|"ohci_ctrl_done: not a request\n"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|len
operator|!=
literal|0
condition|)
block|{
name|dma
operator|=
operator|&
name|opipe
operator|->
name|u
operator|.
name|ctl
operator|.
name|datadma
expr_stmt|;
if|if
condition|(
name|reqh
operator|->
name|request
operator|.
name|bmRequestType
operator|&
name|UT_READ
condition|)
name|memcpy
argument_list|(
name|reqh
operator|->
name|buffer
argument_list|,
name|KERNADDR
argument_list|(
name|dma
argument_list|)
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|usb_freemem
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
name|dma
argument_list|)
expr_stmt|;
block|}
name|usb_untimeout
argument_list|(
name|ohci_timeout
argument_list|,
name|reqh
argument_list|,
name|reqh
operator|->
name|timeout_handle
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ohci_intr_done
parameter_list|(
name|sc
parameter_list|,
name|reqh
parameter_list|)
name|ohci_softc_t
modifier|*
name|sc
decl_stmt|;
name|usbd_request_handle
name|reqh
decl_stmt|;
block|{
name|struct
name|ohci_pipe
modifier|*
name|opipe
init|=
operator|(
expr|struct
name|ohci_pipe
operator|*
operator|)
name|reqh
operator|->
name|pipe
decl_stmt|;
name|usb_dma_t
modifier|*
name|dma
decl_stmt|;
name|ohci_soft_ed_t
modifier|*
name|sed
init|=
name|opipe
operator|->
name|sed
decl_stmt|;
name|ohci_soft_td_t
modifier|*
name|xfer
decl_stmt|,
modifier|*
name|tail
decl_stmt|;
name|DPRINTFN
argument_list|(
literal|10
argument_list|,
operator|(
literal|"ohci_intr_done: reqh=%p, actlen=%d\n"
operator|,
name|reqh
operator|,
name|reqh
operator|->
name|actlen
operator|)
argument_list|)
expr_stmt|;
name|dma
operator|=
operator|&
name|opipe
operator|->
name|u
operator|.
name|intr
operator|.
name|datadma
expr_stmt|;
name|memcpy
argument_list|(
name|reqh
operator|->
name|buffer
argument_list|,
name|KERNADDR
argument_list|(
name|dma
argument_list|)
argument_list|,
name|reqh
operator|->
name|actlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|reqh
operator|->
name|pipe
operator|->
name|intrreqh
operator|==
name|reqh
condition|)
block|{
name|xfer
operator|=
name|opipe
operator|->
name|tail
expr_stmt|;
name|tail
operator|=
name|ohci_alloc_std
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* XXX should reuse TD */
if|if
condition|(
operator|!
name|tail
condition|)
block|{
name|reqh
operator|->
name|status
operator|=
name|USBD_NOMEM
expr_stmt|;
return|return;
block|}
name|tail
operator|->
name|reqh
operator|=
literal|0
expr_stmt|;
name|xfer
operator|->
name|td
operator|->
name|td_flags
operator|=
name|LE
argument_list|(
name|OHCI_TD_IN
operator||
name|OHCI_TD_NOCC
operator||
name|OHCI_TD_SET_DI
argument_list|(
literal|1
argument_list|)
operator||
name|OHCI_TD_TOGGLE_CARRY
argument_list|)
expr_stmt|;
if|if
condition|(
name|reqh
operator|->
name|flags
operator|&
name|USBD_SHORT_XFER_OK
condition|)
name|xfer
operator|->
name|td
operator|->
name|td_flags
operator||=
name|LE
argument_list|(
name|OHCI_TD_R
argument_list|)
expr_stmt|;
name|xfer
operator|->
name|td
operator|->
name|td_cbp
operator|=
name|LE
argument_list|(
name|DMAADDR
argument_list|(
name|dma
argument_list|)
argument_list|)
expr_stmt|;
name|xfer
operator|->
name|nexttd
operator|=
name|tail
expr_stmt|;
name|xfer
operator|->
name|td
operator|->
name|td_nexttd
operator|=
name|LE
argument_list|(
name|tail
operator|->
name|physaddr
argument_list|)
expr_stmt|;
name|xfer
operator|->
name|td
operator|->
name|td_be
operator|=
name|LE
argument_list|(
name|LE
argument_list|(
name|xfer
operator|->
name|td
operator|->
name|td_cbp
argument_list|)
operator|+
name|reqh
operator|->
name|length
operator|-
literal|1
argument_list|)
expr_stmt|;
name|xfer
operator|->
name|len
operator|=
name|reqh
operator|->
name|length
expr_stmt|;
name|xfer
operator|->
name|reqh
operator|=
name|reqh
expr_stmt|;
name|reqh
operator|->
name|hcpriv
operator|=
name|xfer
expr_stmt|;
name|ohci_hash_add_td
argument_list|(
name|sc
argument_list|,
name|xfer
argument_list|)
expr_stmt|;
name|sed
operator|->
name|ed
operator|->
name|ed_tailp
operator|=
name|LE
argument_list|(
name|tail
operator|->
name|physaddr
argument_list|)
expr_stmt|;
name|opipe
operator|->
name|tail
operator|=
name|tail
expr_stmt|;
block|}
else|else
block|{
name|usb_freemem
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
name|dma
argument_list|)
expr_stmt|;
name|usb_start_next
argument_list|(
name|reqh
operator|->
name|pipe
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|ohci_bulk_done
parameter_list|(
name|sc
parameter_list|,
name|reqh
parameter_list|)
name|ohci_softc_t
modifier|*
name|sc
decl_stmt|;
name|usbd_request_handle
name|reqh
decl_stmt|;
block|{
name|struct
name|ohci_pipe
modifier|*
name|opipe
init|=
operator|(
expr|struct
name|ohci_pipe
operator|*
operator|)
name|reqh
operator|->
name|pipe
decl_stmt|;
name|usb_dma_t
modifier|*
name|dma
decl_stmt|;
name|DPRINTFN
argument_list|(
literal|10
argument_list|,
operator|(
literal|"ohci_bulk_done: reqh=%p, actlen=%d\n"
operator|,
name|reqh
operator|,
name|reqh
operator|->
name|actlen
operator|)
argument_list|)
expr_stmt|;
name|dma
operator|=
operator|&
name|opipe
operator|->
name|u
operator|.
name|bulk
operator|.
name|datadma
expr_stmt|;
if|if
condition|(
name|reqh
operator|->
name|request
operator|.
name|bmRequestType
operator|&
name|UT_READ
condition|)
name|memcpy
argument_list|(
name|reqh
operator|->
name|buffer
argument_list|,
name|KERNADDR
argument_list|(
name|dma
argument_list|)
argument_list|,
name|reqh
operator|->
name|actlen
argument_list|)
expr_stmt|;
name|usb_freemem
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
name|dma
argument_list|)
expr_stmt|;
name|usb_untimeout
argument_list|(
name|ohci_timeout
argument_list|,
name|reqh
argument_list|,
name|reqh
operator|->
name|timeout_handle
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ohci_rhsc
parameter_list|(
name|sc
parameter_list|,
name|reqh
parameter_list|)
name|ohci_softc_t
modifier|*
name|sc
decl_stmt|;
name|usbd_request_handle
name|reqh
decl_stmt|;
block|{
name|usbd_pipe_handle
name|pipe
decl_stmt|;
name|struct
name|ohci_pipe
modifier|*
name|opipe
decl_stmt|;
name|u_char
modifier|*
name|p
decl_stmt|;
name|int
name|i
decl_stmt|,
name|m
decl_stmt|;
name|int
name|hstatus
decl_stmt|;
name|hstatus
operator|=
name|OREAD4
argument_list|(
name|sc
argument_list|,
name|OHCI_RH_STATUS
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"ohci_rhsc: sc=%p reqh=%p hstatus=0x%08x\n"
operator|,
name|sc
operator|,
name|reqh
operator|,
name|hstatus
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|reqh
operator|==
literal|0
condition|)
block|{
comment|/* Just ignore the change. */
return|return;
block|}
name|pipe
operator|=
name|reqh
operator|->
name|pipe
expr_stmt|;
name|opipe
operator|=
operator|(
expr|struct
name|ohci_pipe
operator|*
operator|)
name|pipe
expr_stmt|;
name|p
operator|=
name|KERNADDR
argument_list|(
operator|&
name|opipe
operator|->
name|u
operator|.
name|intr
operator|.
name|datadma
argument_list|)
expr_stmt|;
name|m
operator|=
name|min
argument_list|(
name|sc
operator|->
name|sc_noport
argument_list|,
name|reqh
operator|->
name|length
operator|*
literal|8
operator|-
literal|1
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|p
argument_list|,
literal|0
argument_list|,
name|reqh
operator|->
name|length
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
name|m
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|OREAD4
argument_list|(
name|sc
argument_list|,
name|OHCI_RH_PORT_STATUS
argument_list|(
name|i
argument_list|)
argument_list|)
operator|>>
literal|16
condition|)
name|p
index|[
name|i
operator|/
literal|8
index|]
operator||=
literal|1
operator|<<
operator|(
name|i
operator|%
literal|8
operator|)
expr_stmt|;
block|}
name|DPRINTF
argument_list|(
operator|(
literal|"ohci_rhsc: change=0x%02x\n"
operator|,
operator|*
name|p
operator|)
argument_list|)
expr_stmt|;
name|reqh
operator|->
name|actlen
operator|=
name|reqh
operator|->
name|length
expr_stmt|;
name|reqh
operator|->
name|status
operator|=
name|USBD_NORMAL_COMPLETION
expr_stmt|;
name|reqh
operator|->
name|xfercb
argument_list|(
name|reqh
argument_list|)
expr_stmt|;
if|if
condition|(
name|reqh
operator|->
name|pipe
operator|->
name|intrreqh
operator|!=
name|reqh
condition|)
block|{
name|sc
operator|->
name|sc_intrreqh
operator|=
literal|0
expr_stmt|;
name|usb_freemem
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
operator|&
name|opipe
operator|->
name|u
operator|.
name|intr
operator|.
name|datadma
argument_list|)
expr_stmt|;
name|usb_start_next
argument_list|(
name|reqh
operator|->
name|pipe
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Wait here until controller claims to have an interrupt.  * Then call ohci_intr and return.  Use timeout to avoid waiting  * too long.  */
end_comment

begin_function
name|void
name|ohci_waitintr
parameter_list|(
name|sc
parameter_list|,
name|reqh
parameter_list|)
name|ohci_softc_t
modifier|*
name|sc
decl_stmt|;
name|usbd_request_handle
name|reqh
decl_stmt|;
block|{
name|int
name|timo
init|=
name|reqh
operator|->
name|timeout
decl_stmt|;
name|int
name|usecs
decl_stmt|;
name|u_int32_t
name|intrs
decl_stmt|;
name|reqh
operator|->
name|status
operator|=
name|USBD_IN_PROGRESS
expr_stmt|;
for|for
control|(
name|usecs
operator|=
name|timo
operator|*
literal|1000000
operator|/
name|hz
init|;
name|usecs
operator|>
literal|0
condition|;
name|usecs
operator|-=
literal|1000
control|)
block|{
name|usb_delay_ms
argument_list|(
operator|&
name|sc
operator|->
name|sc_bus
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|intrs
operator|=
name|OREAD4
argument_list|(
name|sc
argument_list|,
name|OHCI_INTERRUPT_STATUS
argument_list|)
operator|&
name|sc
operator|->
name|sc_eintrs
expr_stmt|;
name|DPRINTFN
argument_list|(
literal|15
argument_list|,
operator|(
literal|"ohci_waitintr: 0x%04x\n"
operator|,
name|intrs
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|OHCI_DEBUG
if|if
condition|(
name|ohcidebug
operator|>
literal|15
condition|)
name|ohci_dumpregs
argument_list|(
name|sc
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|intrs
condition|)
block|{
name|ohci_intr
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|reqh
operator|->
name|status
operator|!=
name|USBD_IN_PROGRESS
condition|)
return|return;
block|}
block|}
comment|/* Timeout */
name|DPRINTF
argument_list|(
operator|(
literal|"ohci_waitintr: timeout\n"
operator|)
argument_list|)
expr_stmt|;
name|reqh
operator|->
name|status
operator|=
name|USBD_TIMEOUT
expr_stmt|;
name|ohci_ii_done
argument_list|(
name|sc
argument_list|,
name|reqh
argument_list|)
expr_stmt|;
comment|/* XXX should free TD */
block|}
end_function

begin_function
name|void
name|ohci_poll
parameter_list|(
name|bus
parameter_list|)
name|struct
name|usbd_bus
modifier|*
name|bus
decl_stmt|;
block|{
name|ohci_softc_t
modifier|*
name|sc
init|=
operator|(
name|ohci_softc_t
operator|*
operator|)
name|bus
decl_stmt|;
if|if
condition|(
name|OREAD4
argument_list|(
name|sc
argument_list|,
name|OHCI_INTERRUPT_STATUS
argument_list|)
operator|&
name|sc
operator|->
name|sc_eintrs
condition|)
name|ohci_intr
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|usbd_status
name|ohci_device_request
parameter_list|(
name|reqh
parameter_list|)
name|usbd_request_handle
name|reqh
decl_stmt|;
block|{
name|struct
name|ohci_pipe
modifier|*
name|opipe
init|=
operator|(
expr|struct
name|ohci_pipe
operator|*
operator|)
name|reqh
operator|->
name|pipe
decl_stmt|;
name|usb_device_request_t
modifier|*
name|req
init|=
operator|&
name|reqh
operator|->
name|request
decl_stmt|;
name|usbd_device_handle
name|dev
init|=
name|opipe
operator|->
name|pipe
operator|.
name|device
decl_stmt|;
name|ohci_softc_t
modifier|*
name|sc
init|=
operator|(
name|ohci_softc_t
operator|*
operator|)
name|dev
operator|->
name|bus
decl_stmt|;
name|int
name|addr
init|=
name|dev
operator|->
name|address
decl_stmt|;
name|ohci_soft_td_t
modifier|*
name|setup
decl_stmt|,
modifier|*
name|xfer
init|=
literal|0
decl_stmt|,
modifier|*
name|stat
decl_stmt|,
modifier|*
name|next
decl_stmt|,
modifier|*
name|tail
decl_stmt|;
name|ohci_soft_ed_t
modifier|*
name|sed
decl_stmt|;
name|usb_dma_t
modifier|*
name|dmap
decl_stmt|;
name|int
name|isread
decl_stmt|;
name|int
name|len
decl_stmt|;
name|usbd_status
name|r
decl_stmt|;
name|int
name|s
decl_stmt|;
name|isread
operator|=
name|req
operator|->
name|bmRequestType
operator|&
name|UT_READ
expr_stmt|;
name|len
operator|=
name|UGETW
argument_list|(
name|req
operator|->
name|wLength
argument_list|)
expr_stmt|;
name|DPRINTFN
argument_list|(
literal|3
argument_list|,
operator|(
literal|"ohci_device_control type=0x%02x, request=0x%02x, "
literal|"wValue=0x%04x, wIndex=0x%04x len=%d, addr=%d, endpt=%d\n"
operator|,
name|req
operator|->
name|bmRequestType
operator|,
name|req
operator|->
name|bRequest
operator|,
name|UGETW
argument_list|(
name|req
operator|->
name|wValue
argument_list|)
operator|,
name|UGETW
argument_list|(
name|req
operator|->
name|wIndex
argument_list|)
operator|,
name|len
operator|,
name|addr
operator|,
name|opipe
operator|->
name|pipe
operator|.
name|endpoint
operator|->
name|edesc
operator|->
name|bEndpointAddress
operator|)
argument_list|)
expr_stmt|;
name|setup
operator|=
name|opipe
operator|->
name|tail
expr_stmt|;
name|stat
operator|=
name|ohci_alloc_std
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|stat
condition|)
block|{
name|r
operator|=
name|USBD_NOMEM
expr_stmt|;
goto|goto
name|bad1
goto|;
block|}
name|tail
operator|=
name|ohci_alloc_std
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tail
condition|)
block|{
name|r
operator|=
name|USBD_NOMEM
expr_stmt|;
goto|goto
name|bad2
goto|;
block|}
name|tail
operator|->
name|reqh
operator|=
literal|0
expr_stmt|;
name|sed
operator|=
name|opipe
operator|->
name|sed
expr_stmt|;
name|dmap
operator|=
operator|&
name|opipe
operator|->
name|u
operator|.
name|ctl
operator|.
name|datadma
expr_stmt|;
name|opipe
operator|->
name|u
operator|.
name|ctl
operator|.
name|length
operator|=
name|len
expr_stmt|;
comment|/* Update device address and length since they may have changed. */
comment|/* XXX This only needs to be done once, but it's too early in open. */
name|sed
operator|->
name|ed
operator|->
name|ed_flags
operator|=
name|LE
argument_list|(
operator|(
name|LE
argument_list|(
name|sed
operator|->
name|ed
operator|->
name|ed_flags
argument_list|)
operator|&
operator|~
operator|(
name|OHCI_ED_ADDRMASK
operator||
name|OHCI_ED_MAXPMASK
operator|)
operator|)
operator||
name|OHCI_ED_SET_FA
argument_list|(
name|addr
argument_list|)
operator||
name|OHCI_ED_SET_MAXP
argument_list|(
name|UGETW
argument_list|(
name|opipe
operator|->
name|pipe
operator|.
name|endpoint
operator|->
name|edesc
operator|->
name|wMaxPacketSize
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Set up data transaction */
if|if
condition|(
name|len
operator|!=
literal|0
condition|)
block|{
name|xfer
operator|=
name|ohci_alloc_std
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|xfer
condition|)
block|{
name|r
operator|=
name|USBD_NOMEM
expr_stmt|;
goto|goto
name|bad3
goto|;
block|}
name|r
operator|=
name|usb_allocmem
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
name|len
argument_list|,
literal|0
argument_list|,
name|dmap
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|!=
name|USBD_NORMAL_COMPLETION
condition|)
goto|goto
name|bad4
goto|;
name|xfer
operator|->
name|td
operator|->
name|td_flags
operator|=
name|LE
argument_list|(
operator|(
name|isread
condition|?
name|OHCI_TD_IN
else|:
name|OHCI_TD_OUT
operator|)
operator||
name|OHCI_TD_NOCC
operator||
name|OHCI_TD_TOGGLE_1
operator||
name|OHCI_TD_NOINTR
operator||
operator|(
name|reqh
operator|->
name|flags
operator|&
name|USBD_SHORT_XFER_OK
condition|?
name|OHCI_TD_R
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|xfer
operator|->
name|td
operator|->
name|td_cbp
operator|=
name|LE
argument_list|(
name|DMAADDR
argument_list|(
name|dmap
argument_list|)
argument_list|)
expr_stmt|;
name|xfer
operator|->
name|nexttd
operator|=
name|stat
expr_stmt|;
name|xfer
operator|->
name|td
operator|->
name|td_nexttd
operator|=
name|LE
argument_list|(
name|stat
operator|->
name|physaddr
argument_list|)
expr_stmt|;
name|xfer
operator|->
name|td
operator|->
name|td_be
operator|=
name|LE
argument_list|(
name|LE
argument_list|(
name|xfer
operator|->
name|td
operator|->
name|td_cbp
argument_list|)
operator|+
name|len
operator|-
literal|1
argument_list|)
expr_stmt|;
name|xfer
operator|->
name|len
operator|=
name|len
expr_stmt|;
name|xfer
operator|->
name|reqh
operator|=
name|reqh
expr_stmt|;
name|next
operator|=
name|xfer
expr_stmt|;
block|}
else|else
name|next
operator|=
name|stat
expr_stmt|;
name|memcpy
argument_list|(
name|KERNADDR
argument_list|(
operator|&
name|opipe
operator|->
name|u
operator|.
name|ctl
operator|.
name|reqdma
argument_list|)
argument_list|,
name|req
argument_list|,
sizeof|sizeof
expr|*
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|isread
operator|&&
name|len
operator|!=
literal|0
condition|)
name|memcpy
argument_list|(
name|KERNADDR
argument_list|(
name|dmap
argument_list|)
argument_list|,
name|reqh
operator|->
name|buffer
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|setup
operator|->
name|td
operator|->
name|td_flags
operator|=
name|LE
argument_list|(
name|OHCI_TD_SETUP
operator||
name|OHCI_TD_NOCC
operator||
name|OHCI_TD_TOGGLE_0
operator||
name|OHCI_TD_NOINTR
argument_list|)
expr_stmt|;
name|setup
operator|->
name|td
operator|->
name|td_cbp
operator|=
name|LE
argument_list|(
name|DMAADDR
argument_list|(
operator|&
name|opipe
operator|->
name|u
operator|.
name|ctl
operator|.
name|reqdma
argument_list|)
argument_list|)
expr_stmt|;
name|setup
operator|->
name|nexttd
operator|=
name|next
expr_stmt|;
name|setup
operator|->
name|td
operator|->
name|td_nexttd
operator|=
name|LE
argument_list|(
name|next
operator|->
name|physaddr
argument_list|)
expr_stmt|;
name|setup
operator|->
name|td
operator|->
name|td_be
operator|=
name|LE
argument_list|(
name|LE
argument_list|(
name|setup
operator|->
name|td
operator|->
name|td_cbp
argument_list|)
operator|+
sizeof|sizeof
expr|*
name|req
operator|-
literal|1
argument_list|)
expr_stmt|;
name|setup
operator|->
name|len
operator|=
literal|0
expr_stmt|;
comment|/* XXX The number of byte we count */
name|setup
operator|->
name|reqh
operator|=
name|reqh
expr_stmt|;
name|stat
operator|->
name|td
operator|->
name|td_flags
operator|=
name|LE
argument_list|(
operator|(
name|isread
condition|?
name|OHCI_TD_OUT
else|:
name|OHCI_TD_IN
operator|)
operator||
name|OHCI_TD_NOCC
operator||
name|OHCI_TD_TOGGLE_1
operator||
name|OHCI_TD_SET_DI
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|stat
operator|->
name|td
operator|->
name|td_cbp
operator|=
literal|0
expr_stmt|;
name|stat
operator|->
name|nexttd
operator|=
name|tail
expr_stmt|;
name|stat
operator|->
name|td
operator|->
name|td_nexttd
operator|=
name|LE
argument_list|(
name|tail
operator|->
name|physaddr
argument_list|)
expr_stmt|;
name|stat
operator|->
name|td
operator|->
name|td_be
operator|=
literal|0
expr_stmt|;
name|stat
operator|->
name|len
operator|=
literal|0
expr_stmt|;
name|stat
operator|->
name|reqh
operator|=
name|reqh
expr_stmt|;
name|reqh
operator|->
name|hcpriv
operator|=
name|stat
expr_stmt|;
ifdef|#
directive|ifdef
name|OHCI_DEBUG
if|if
condition|(
name|ohcidebug
operator|>
literal|5
condition|)
block|{
name|printf
argument_list|(
literal|"ohci_device_request:\n"
argument_list|)
expr_stmt|;
name|ohci_dump_ed
argument_list|(
name|sed
argument_list|)
expr_stmt|;
name|ohci_dump_tds
argument_list|(
name|setup
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* Insert ED in schedule */
name|s
operator|=
name|splusb
argument_list|()
expr_stmt|;
name|ohci_hash_add_td
argument_list|(
name|sc
argument_list|,
name|setup
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|!=
literal|0
condition|)
name|ohci_hash_add_td
argument_list|(
name|sc
argument_list|,
name|xfer
argument_list|)
expr_stmt|;
name|ohci_hash_add_td
argument_list|(
name|sc
argument_list|,
name|stat
argument_list|)
expr_stmt|;
name|sed
operator|->
name|ed
operator|->
name|ed_tailp
operator|=
name|LE
argument_list|(
name|tail
operator|->
name|physaddr
argument_list|)
expr_stmt|;
name|opipe
operator|->
name|tail
operator|=
name|tail
expr_stmt|;
name|OWRITE4
argument_list|(
name|sc
argument_list|,
name|OHCI_COMMAND_STATUS
argument_list|,
name|OHCI_CLF
argument_list|)
expr_stmt|;
if|if
condition|(
name|reqh
operator|->
name|timeout
operator|&&
operator|!
name|sc
operator|->
name|sc_bus
operator|.
name|use_polling
condition|)
block|{
name|usb_timeout
argument_list|(
name|ohci_timeout
argument_list|,
name|reqh
argument_list|,
name|MS_TO_TICKS
argument_list|(
name|reqh
operator|->
name|timeout
argument_list|)
argument_list|,
name|reqh
operator|->
name|timeout_handle
argument_list|)
expr_stmt|;
block|}
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
ifdef|#
directive|ifdef
name|OHCI_DEBUG
block|if (ohcidebug> 15) { 		delay(5000); 		printf("ohci_device_request: status=%x\n", 		       OREAD4(sc, OHCI_COMMAND_STATUS)); 		ohci_dump_ed(sed); 		ohci_dump_tds(setup); 	}
endif|#
directive|endif
endif|#
directive|endif
return|return
operator|(
name|USBD_NORMAL_COMPLETION
operator|)
return|;
name|bad4
label|:
name|ohci_free_std
argument_list|(
name|sc
argument_list|,
name|xfer
argument_list|)
expr_stmt|;
name|bad3
label|:
name|ohci_free_std
argument_list|(
name|sc
argument_list|,
name|tail
argument_list|)
expr_stmt|;
name|bad2
label|:
name|ohci_free_std
argument_list|(
name|sc
argument_list|,
name|stat
argument_list|)
expr_stmt|;
name|bad1
label|:
return|return
operator|(
name|r
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Add an ED to the schedule.  Called at splusb().  */
end_comment

begin_function
name|void
name|ohci_add_ed
parameter_list|(
name|sed
parameter_list|,
name|head
parameter_list|)
name|ohci_soft_ed_t
modifier|*
name|sed
decl_stmt|;
name|ohci_soft_ed_t
modifier|*
name|head
decl_stmt|;
block|{
name|sed
operator|->
name|next
operator|=
name|head
operator|->
name|next
expr_stmt|;
name|sed
operator|->
name|ed
operator|->
name|ed_nexted
operator|=
name|head
operator|->
name|ed
operator|->
name|ed_nexted
expr_stmt|;
name|head
operator|->
name|next
operator|=
name|sed
expr_stmt|;
name|head
operator|->
name|ed
operator|->
name|ed_nexted
operator|=
name|LE
argument_list|(
name|sed
operator|->
name|physaddr
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Remove an ED from the schedule.  Called at splusb().  */
end_comment

begin_function
name|void
name|ohci_rem_ed
parameter_list|(
name|sed
parameter_list|,
name|head
parameter_list|)
name|ohci_soft_ed_t
modifier|*
name|sed
decl_stmt|;
name|ohci_soft_ed_t
modifier|*
name|head
decl_stmt|;
block|{
name|ohci_soft_ed_t
modifier|*
name|p
decl_stmt|;
comment|/* XXX */
for|for
control|(
name|p
operator|=
name|head
init|;
name|p
operator|&&
name|p
operator|->
name|next
operator|!=
name|sed
condition|;
name|p
operator|=
name|p
operator|->
name|next
control|)
empty_stmt|;
if|if
condition|(
operator|!
name|p
condition|)
name|panic
argument_list|(
literal|"ohci_rem_ed: ED not found\n"
argument_list|)
expr_stmt|;
name|p
operator|->
name|next
operator|=
name|sed
operator|->
name|next
expr_stmt|;
name|p
operator|->
name|ed
operator|->
name|ed_nexted
operator|=
name|sed
operator|->
name|ed
operator|->
name|ed_nexted
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * When a transfer is completed the TD is added to the done queue by  * the host controller.  This queue is the processed by software.  * Unfortunately the queue contains the physical address of the TD  * and we have no simple way to translate this back to a kernel address.  * To make the translation possible (and fast) we use a hash table of  * TDs currently in the schedule.  The physical address is used as the  * hash value.  */
end_comment

begin_define
define|#
directive|define
name|HASH
parameter_list|(
name|a
parameter_list|)
value|(((a)>> 4) % OHCI_HASH_SIZE)
end_define

begin_comment
comment|/* Called at splusb() */
end_comment

begin_function
name|void
name|ohci_hash_add_td
parameter_list|(
name|sc
parameter_list|,
name|std
parameter_list|)
name|ohci_softc_t
modifier|*
name|sc
decl_stmt|;
name|ohci_soft_td_t
modifier|*
name|std
decl_stmt|;
block|{
name|int
name|h
init|=
name|HASH
argument_list|(
name|std
operator|->
name|physaddr
argument_list|)
decl_stmt|;
name|LIST_INSERT_HEAD
argument_list|(
operator|&
name|sc
operator|->
name|sc_hash_tds
index|[
name|h
index|]
argument_list|,
name|std
argument_list|,
name|hnext
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Called at splusb() */
end_comment

begin_function
name|void
name|ohci_hash_rem_td
parameter_list|(
name|sc
parameter_list|,
name|std
parameter_list|)
name|ohci_softc_t
modifier|*
name|sc
decl_stmt|;
name|ohci_soft_td_t
modifier|*
name|std
decl_stmt|;
block|{
name|LIST_REMOVE
argument_list|(
name|std
argument_list|,
name|hnext
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|ohci_soft_td_t
modifier|*
name|ohci_hash_find_td
parameter_list|(
name|sc
parameter_list|,
name|a
parameter_list|)
name|ohci_softc_t
modifier|*
name|sc
decl_stmt|;
name|ohci_physaddr_t
name|a
decl_stmt|;
block|{
name|int
name|h
init|=
name|HASH
argument_list|(
name|a
argument_list|)
decl_stmt|;
name|ohci_soft_td_t
modifier|*
name|std
decl_stmt|;
for|for
control|(
name|std
operator|=
name|LIST_FIRST
argument_list|(
operator|&
name|sc
operator|->
name|sc_hash_tds
index|[
name|h
index|]
argument_list|)
init|;
name|std
operator|!=
literal|0
condition|;
name|std
operator|=
name|LIST_NEXT
argument_list|(
name|std
argument_list|,
name|hnext
argument_list|)
control|)
if|if
condition|(
name|std
operator|->
name|physaddr
operator|==
name|a
condition|)
return|return
operator|(
name|std
operator|)
return|;
name|panic
argument_list|(
literal|"ohci_hash_find_td: addr 0x%08lx not found\n"
argument_list|,
operator|(
name|u_long
operator|)
name|a
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ohci_timeout
parameter_list|(
name|addr
parameter_list|)
name|void
modifier|*
name|addr
decl_stmt|;
block|{
ifdef|#
directive|ifdef
name|OHCI_DEBUG
name|usbd_request_handle
modifier|*
name|reqh
init|=
name|addr
decl_stmt|;
endif|#
directive|endif
name|DPRINTF
argument_list|(
operator|(
literal|"ohci_timeout: reqh=%p\n"
operator|,
name|reqh
operator|)
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|int s;  	s = splusb();
comment|/* XXX need to inactivate TD before calling interrupt routine */
block|ohci_XXX_done(reqh); 	splx(s);
endif|#
directive|endif
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|OHCI_DEBUG
end_ifdef

begin_function
name|void
name|ohci_dump_tds
parameter_list|(
name|std
parameter_list|)
name|ohci_soft_td_t
modifier|*
name|std
decl_stmt|;
block|{
for|for
control|(
init|;
name|std
condition|;
name|std
operator|=
name|std
operator|->
name|nexttd
control|)
name|ohci_dump_td
argument_list|(
name|std
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ohci_dump_td
parameter_list|(
name|std
parameter_list|)
name|ohci_soft_td_t
modifier|*
name|std
decl_stmt|;
block|{
name|printf
argument_list|(
literal|"TD(%p) at %08lx: %b delay=%d ec=%d cc=%d\ncbp=0x%08lx "
literal|"nexttd=0x%08lx be=0x%08lx\n"
argument_list|,
name|std
argument_list|,
operator|(
name|u_long
operator|)
name|std
operator|->
name|physaddr
argument_list|,
operator|(
name|int
operator|)
name|LE
argument_list|(
name|std
operator|->
name|td
operator|->
name|td_flags
argument_list|)
argument_list|,
literal|"\20\23R\24OUT\25IN\31TOG1\32SETTOGGLE"
argument_list|,
name|OHCI_TD_GET_DI
argument_list|(
name|LE
argument_list|(
name|std
operator|->
name|td
operator|->
name|td_flags
argument_list|)
argument_list|)
argument_list|,
name|OHCI_TD_GET_EC
argument_list|(
name|LE
argument_list|(
name|std
operator|->
name|td
operator|->
name|td_flags
argument_list|)
argument_list|)
argument_list|,
name|OHCI_TD_GET_CC
argument_list|(
name|LE
argument_list|(
name|std
operator|->
name|td
operator|->
name|td_flags
argument_list|)
argument_list|)
argument_list|,
operator|(
name|u_long
operator|)
name|LE
argument_list|(
name|std
operator|->
name|td
operator|->
name|td_cbp
argument_list|)
argument_list|,
operator|(
name|u_long
operator|)
name|LE
argument_list|(
name|std
operator|->
name|td
operator|->
name|td_nexttd
argument_list|)
argument_list|,
operator|(
name|u_long
operator|)
name|LE
argument_list|(
name|std
operator|->
name|td
operator|->
name|td_be
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ohci_dump_ed
parameter_list|(
name|sed
parameter_list|)
name|ohci_soft_ed_t
modifier|*
name|sed
decl_stmt|;
block|{
name|printf
argument_list|(
literal|"ED(%p) at %08lx: addr=%d endpt=%d maxp=%d %b\ntailp=0x%08lx "
literal|"headp=%b nexted=0x%08lx\n"
argument_list|,
name|sed
argument_list|,
operator|(
name|u_long
operator|)
name|sed
operator|->
name|physaddr
argument_list|,
name|OHCI_ED_GET_FA
argument_list|(
name|LE
argument_list|(
name|sed
operator|->
name|ed
operator|->
name|ed_flags
argument_list|)
argument_list|)
argument_list|,
name|OHCI_ED_GET_EN
argument_list|(
name|LE
argument_list|(
name|sed
operator|->
name|ed
operator|->
name|ed_flags
argument_list|)
argument_list|)
argument_list|,
name|OHCI_ED_GET_MAXP
argument_list|(
name|LE
argument_list|(
name|sed
operator|->
name|ed
operator|->
name|ed_flags
argument_list|)
argument_list|)
argument_list|,
operator|(
name|int
operator|)
name|LE
argument_list|(
name|sed
operator|->
name|ed
operator|->
name|ed_flags
argument_list|)
argument_list|,
literal|"\20\14OUT\15IN\16LOWSPEED\17SKIP\20ISO"
argument_list|,
operator|(
name|u_long
operator|)
name|LE
argument_list|(
name|sed
operator|->
name|ed
operator|->
name|ed_tailp
argument_list|)
argument_list|,
operator|(
name|int
operator|)
name|LE
argument_list|(
name|sed
operator|->
name|ed
operator|->
name|ed_headp
argument_list|)
argument_list|,
literal|"\20\1HALT\2CARRY"
argument_list|,
operator|(
name|u_long
operator|)
name|LE
argument_list|(
name|sed
operator|->
name|ed
operator|->
name|ed_nexted
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|usbd_status
name|ohci_open
parameter_list|(
name|pipe
parameter_list|)
name|usbd_pipe_handle
name|pipe
decl_stmt|;
block|{
name|usbd_device_handle
name|dev
init|=
name|pipe
operator|->
name|device
decl_stmt|;
name|ohci_softc_t
modifier|*
name|sc
init|=
operator|(
name|ohci_softc_t
operator|*
operator|)
name|dev
operator|->
name|bus
decl_stmt|;
name|usb_endpoint_descriptor_t
modifier|*
name|ed
init|=
name|pipe
operator|->
name|endpoint
operator|->
name|edesc
decl_stmt|;
name|struct
name|ohci_pipe
modifier|*
name|opipe
init|=
operator|(
expr|struct
name|ohci_pipe
operator|*
operator|)
name|pipe
decl_stmt|;
name|u_int8_t
name|addr
init|=
name|dev
operator|->
name|address
decl_stmt|;
name|ohci_soft_ed_t
modifier|*
name|sed
decl_stmt|;
name|ohci_soft_td_t
modifier|*
name|std
decl_stmt|;
name|usbd_status
name|r
decl_stmt|;
name|int
name|s
decl_stmt|;
name|DPRINTFN
argument_list|(
literal|1
argument_list|,
operator|(
literal|"ohci_open: pipe=%p, addr=%d, endpt=%d (%d)\n"
operator|,
name|pipe
operator|,
name|addr
operator|,
name|ed
operator|->
name|bEndpointAddress
operator|,
name|sc
operator|->
name|sc_addr
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|addr
operator|==
name|sc
operator|->
name|sc_addr
condition|)
block|{
switch|switch
condition|(
name|ed
operator|->
name|bEndpointAddress
condition|)
block|{
case|case
name|USB_CONTROL_ENDPOINT
case|:
name|pipe
operator|->
name|methods
operator|=
operator|&
name|ohci_root_ctrl_methods
expr_stmt|;
break|break;
case|case
name|UE_IN
operator||
name|OHCI_INTR_ENDPT
case|:
name|pipe
operator|->
name|methods
operator|=
operator|&
name|ohci_root_intr_methods
expr_stmt|;
break|break;
default|default:
return|return
operator|(
name|USBD_INVAL
operator|)
return|;
block|}
block|}
else|else
block|{
name|sed
operator|=
name|ohci_alloc_sed
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|sed
operator|==
literal|0
condition|)
goto|goto
name|bad0
goto|;
name|std
operator|=
name|ohci_alloc_std
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|std
operator|==
literal|0
condition|)
goto|goto
name|bad1
goto|;
name|opipe
operator|->
name|sed
operator|=
name|sed
expr_stmt|;
name|opipe
operator|->
name|tail
operator|=
name|std
expr_stmt|;
name|sed
operator|->
name|ed
operator|->
name|ed_flags
operator|=
name|LE
argument_list|(
name|OHCI_ED_SET_FA
argument_list|(
name|addr
argument_list|)
operator||
name|OHCI_ED_SET_EN
argument_list|(
name|ed
operator|->
name|bEndpointAddress
argument_list|)
operator||
name|OHCI_ED_DIR_TD
operator||
operator|(
name|dev
operator|->
name|lowspeed
condition|?
name|OHCI_ED_SPEED
else|:
literal|0
operator|)
operator||
operator|(
operator|(
name|ed
operator|->
name|bmAttributes
operator|&
name|UE_XFERTYPE
operator|)
operator|==
name|UE_ISOCHRONOUS
condition|?
name|OHCI_ED_FORMAT_ISO
else|:
name|OHCI_ED_FORMAT_GEN
operator|)
operator||
name|OHCI_ED_SET_MAXP
argument_list|(
name|UGETW
argument_list|(
name|ed
operator|->
name|wMaxPacketSize
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|sed
operator|->
name|ed
operator|->
name|ed_headp
operator|=
name|sed
operator|->
name|ed
operator|->
name|ed_tailp
operator|=
name|LE
argument_list|(
name|std
operator|->
name|physaddr
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ed
operator|->
name|bmAttributes
operator|&
name|UE_XFERTYPE
condition|)
block|{
case|case
name|UE_CONTROL
case|:
name|pipe
operator|->
name|methods
operator|=
operator|&
name|ohci_device_ctrl_methods
expr_stmt|;
name|r
operator|=
name|usb_allocmem
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
sizeof|sizeof
argument_list|(
name|usb_device_request_t
argument_list|)
argument_list|,
literal|0
argument_list|,
operator|&
name|opipe
operator|->
name|u
operator|.
name|ctl
operator|.
name|reqdma
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|!=
name|USBD_NORMAL_COMPLETION
condition|)
goto|goto
name|bad
goto|;
name|s
operator|=
name|splusb
argument_list|()
expr_stmt|;
name|ohci_add_ed
argument_list|(
name|sed
argument_list|,
name|sc
operator|->
name|sc_ctrl_head
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
break|break;
case|case
name|UE_INTERRUPT
case|:
name|pipe
operator|->
name|methods
operator|=
operator|&
name|ohci_device_intr_methods
expr_stmt|;
return|return
operator|(
name|ohci_device_setintr
argument_list|(
name|sc
argument_list|,
name|opipe
argument_list|,
name|ed
operator|->
name|bInterval
argument_list|)
operator|)
return|;
case|case
name|UE_ISOCHRONOUS
case|:
name|printf
argument_list|(
literal|"ohci_open: open iso unimplemented\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|USBD_XXX
operator|)
return|;
case|case
name|UE_BULK
case|:
name|pipe
operator|->
name|methods
operator|=
operator|&
name|ohci_device_bulk_methods
expr_stmt|;
name|s
operator|=
name|splusb
argument_list|()
expr_stmt|;
name|ohci_add_ed
argument_list|(
name|sed
argument_list|,
name|sc
operator|->
name|sc_bulk_head
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
return|return
operator|(
name|USBD_NORMAL_COMPLETION
operator|)
return|;
name|bad
label|:
name|ohci_free_std
argument_list|(
name|sc
argument_list|,
name|std
argument_list|)
expr_stmt|;
name|bad1
label|:
name|ohci_free_sed
argument_list|(
name|sc
argument_list|,
name|sed
argument_list|)
expr_stmt|;
name|bad0
label|:
return|return
operator|(
name|USBD_NOMEM
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Data structures and routines to emulate the root hub.  */
end_comment

begin_decl_stmt
name|usb_device_descriptor_t
name|ohci_devd
init|=
block|{
name|USB_DEVICE_DESCRIPTOR_SIZE
block|,
name|UDESC_DEVICE
block|,
comment|/* type */
block|{
literal|0x00
block|,
literal|0x01
block|}
block|,
comment|/* USB version */
name|UCLASS_HUB
block|,
comment|/* class */
name|USUBCLASS_HUB
block|,
comment|/* subclass */
literal|0
block|,
comment|/* protocol */
literal|64
block|,
comment|/* max packet */
block|{
literal|0
block|}
block|,
block|{
literal|0
block|}
block|,
block|{
literal|0x00
block|,
literal|0x01
block|}
block|,
comment|/* device id */
literal|1
block|,
literal|2
block|,
literal|0
block|,
comment|/* string indicies */
literal|1
comment|/* # of configurations */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|usb_config_descriptor_t
name|ohci_confd
init|=
block|{
name|USB_CONFIG_DESCRIPTOR_SIZE
block|,
name|UDESC_CONFIG
block|,
block|{
name|USB_CONFIG_DESCRIPTOR_SIZE
operator|+
name|USB_INTERFACE_DESCRIPTOR_SIZE
operator|+
name|USB_ENDPOINT_DESCRIPTOR_SIZE
block|}
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|,
name|UC_SELF_POWERED
block|,
literal|0
comment|/* max power */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|usb_interface_descriptor_t
name|ohci_ifcd
init|=
block|{
name|USB_INTERFACE_DESCRIPTOR_SIZE
block|,
name|UDESC_INTERFACE
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
name|UCLASS_HUB
block|,
name|USUBCLASS_HUB
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|usb_endpoint_descriptor_t
name|ohci_endpd
init|=
block|{
name|USB_ENDPOINT_DESCRIPTOR_SIZE
block|,
name|UDESC_ENDPOINT
block|,
name|UE_IN
operator||
name|OHCI_INTR_ENDPT
block|,
name|UE_INTERRUPT
block|,
block|{
literal|8
block|,
literal|0
block|}
block|,
comment|/* max packet */
literal|255
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|usb_hub_descriptor_t
name|ohci_hubd
init|=
block|{
name|USB_HUB_DESCRIPTOR_SIZE
block|,
name|UDESC_HUB
block|,
literal|0
block|,
block|{
literal|0
block|,
literal|0
block|}
block|,
literal|0
block|,
literal|0
block|,
block|{
literal|0
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|ohci_str
parameter_list|(
name|p
parameter_list|,
name|l
parameter_list|,
name|s
parameter_list|)
name|usb_string_descriptor_t
modifier|*
name|p
decl_stmt|;
name|int
name|l
decl_stmt|;
name|char
modifier|*
name|s
decl_stmt|;
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|l
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|p
operator|->
name|bLength
operator|=
literal|2
operator|*
name|strlen
argument_list|(
name|s
argument_list|)
operator|+
literal|2
expr_stmt|;
if|if
condition|(
name|l
operator|==
literal|1
condition|)
return|return
operator|(
literal|1
operator|)
return|;
name|p
operator|->
name|bDescriptorType
operator|=
name|UDESC_STRING
expr_stmt|;
name|l
operator|-=
literal|2
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|s
index|[
name|i
index|]
operator|&&
name|l
operator|>
literal|1
condition|;
name|i
operator|++
operator|,
name|l
operator|-=
literal|2
control|)
name|USETW2
argument_list|(
name|p
operator|->
name|bString
index|[
name|i
index|]
argument_list|,
literal|0
argument_list|,
name|s
index|[
name|i
index|]
argument_list|)
expr_stmt|;
return|return
operator|(
literal|2
operator|*
name|i
operator|+
literal|2
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Simulate a hardware hub by handling all the necessary requests.  */
end_comment

begin_function
name|usbd_status
name|ohci_root_ctrl_transfer
parameter_list|(
name|reqh
parameter_list|)
name|usbd_request_handle
name|reqh
decl_stmt|;
block|{
name|int
name|s
decl_stmt|;
name|usbd_status
name|r
decl_stmt|;
name|s
operator|=
name|splusb
argument_list|()
expr_stmt|;
name|r
operator|=
name|usb_insert_transfer
argument_list|(
name|reqh
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|!=
name|USBD_NORMAL_COMPLETION
condition|)
return|return
operator|(
name|r
operator|)
return|;
else|else
return|return
operator|(
name|ohci_root_ctrl_start
argument_list|(
name|reqh
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|ohci_root_ctrl_start
parameter_list|(
name|reqh
parameter_list|)
name|usbd_request_handle
name|reqh
decl_stmt|;
block|{
name|ohci_softc_t
modifier|*
name|sc
init|=
operator|(
name|ohci_softc_t
operator|*
operator|)
name|reqh
operator|->
name|pipe
operator|->
name|device
operator|->
name|bus
decl_stmt|;
name|usb_device_request_t
modifier|*
name|req
decl_stmt|;
name|void
modifier|*
name|buf
decl_stmt|;
name|int
name|port
decl_stmt|,
name|i
decl_stmt|;
name|int
name|len
decl_stmt|,
name|value
decl_stmt|,
name|index
decl_stmt|,
name|l
decl_stmt|,
name|totlen
init|=
literal|0
decl_stmt|;
name|usb_port_status_t
name|ps
decl_stmt|;
name|usb_hub_descriptor_t
name|hubd
decl_stmt|;
name|usbd_status
name|r
decl_stmt|;
name|u_int32_t
name|v
decl_stmt|;
if|if
condition|(
operator|!
name|reqh
operator|->
name|isreq
condition|)
comment|/* XXX panic */
return|return
operator|(
name|USBD_INVAL
operator|)
return|;
name|req
operator|=
operator|&
name|reqh
operator|->
name|request
expr_stmt|;
name|buf
operator|=
name|reqh
operator|->
name|buffer
expr_stmt|;
name|DPRINTFN
argument_list|(
literal|4
argument_list|,
operator|(
literal|"ohci_root_ctrl_control type=0x%02x request=%02x\n"
operator|,
name|req
operator|->
name|bmRequestType
operator|,
name|req
operator|->
name|bRequest
operator|)
argument_list|)
expr_stmt|;
name|len
operator|=
name|UGETW
argument_list|(
name|req
operator|->
name|wLength
argument_list|)
expr_stmt|;
name|value
operator|=
name|UGETW
argument_list|(
name|req
operator|->
name|wValue
argument_list|)
expr_stmt|;
name|index
operator|=
name|UGETW
argument_list|(
name|req
operator|->
name|wIndex
argument_list|)
expr_stmt|;
define|#
directive|define
name|C
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|)
value|((x) | ((y)<< 8))
switch|switch
condition|(
name|C
argument_list|(
name|req
operator|->
name|bRequest
argument_list|,
name|req
operator|->
name|bmRequestType
argument_list|)
condition|)
block|{
case|case
name|C
argument_list|(
name|UR_CLEAR_FEATURE
argument_list|,
name|UT_WRITE_DEVICE
argument_list|)
case|:
case|case
name|C
argument_list|(
name|UR_CLEAR_FEATURE
argument_list|,
name|UT_WRITE_INTERFACE
argument_list|)
case|:
case|case
name|C
argument_list|(
name|UR_CLEAR_FEATURE
argument_list|,
name|UT_WRITE_ENDPOINT
argument_list|)
case|:
comment|/*  		 * DEVICE_REMOTE_WAKEUP and ENDPOINT_HALT are no-ops 		 * for the integrated root hub. 		 */
break|break;
case|case
name|C
argument_list|(
name|UR_GET_CONFIG
argument_list|,
name|UT_READ_DEVICE
argument_list|)
case|:
if|if
condition|(
name|len
operator|>
literal|0
condition|)
block|{
operator|*
operator|(
name|u_int8_t
operator|*
operator|)
name|buf
operator|=
name|sc
operator|->
name|sc_conf
expr_stmt|;
name|totlen
operator|=
literal|1
expr_stmt|;
block|}
break|break;
case|case
name|C
argument_list|(
name|UR_GET_DESCRIPTOR
argument_list|,
name|UT_READ_DEVICE
argument_list|)
case|:
name|DPRINTFN
argument_list|(
literal|8
argument_list|,
operator|(
literal|"ohci_root_ctrl_control wValue=0x%04x\n"
operator|,
name|value
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|value
operator|>>
literal|8
condition|)
block|{
case|case
name|UDESC_DEVICE
case|:
if|if
condition|(
operator|(
name|value
operator|&
literal|0xff
operator|)
operator|!=
literal|0
condition|)
block|{
name|r
operator|=
name|USBD_IOERROR
expr_stmt|;
goto|goto
name|ret
goto|;
block|}
name|totlen
operator|=
name|l
operator|=
name|min
argument_list|(
name|len
argument_list|,
name|USB_DEVICE_DESCRIPTOR_SIZE
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|buf
argument_list|,
operator|&
name|ohci_devd
argument_list|,
name|l
argument_list|)
expr_stmt|;
break|break;
case|case
name|UDESC_CONFIG
case|:
if|if
condition|(
operator|(
name|value
operator|&
literal|0xff
operator|)
operator|!=
literal|0
condition|)
block|{
name|r
operator|=
name|USBD_IOERROR
expr_stmt|;
goto|goto
name|ret
goto|;
block|}
name|totlen
operator|=
name|l
operator|=
name|min
argument_list|(
name|len
argument_list|,
name|USB_CONFIG_DESCRIPTOR_SIZE
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|buf
argument_list|,
operator|&
name|ohci_confd
argument_list|,
name|l
argument_list|)
expr_stmt|;
name|buf
operator|=
operator|(
name|char
operator|*
operator|)
name|buf
operator|+
name|l
expr_stmt|;
name|len
operator|-=
name|l
expr_stmt|;
name|l
operator|=
name|min
argument_list|(
name|len
argument_list|,
name|USB_INTERFACE_DESCRIPTOR_SIZE
argument_list|)
expr_stmt|;
name|totlen
operator|+=
name|l
expr_stmt|;
name|memcpy
argument_list|(
name|buf
argument_list|,
operator|&
name|ohci_ifcd
argument_list|,
name|l
argument_list|)
expr_stmt|;
name|buf
operator|=
operator|(
name|char
operator|*
operator|)
name|buf
operator|+
name|l
expr_stmt|;
name|len
operator|-=
name|l
expr_stmt|;
name|l
operator|=
name|min
argument_list|(
name|len
argument_list|,
name|USB_ENDPOINT_DESCRIPTOR_SIZE
argument_list|)
expr_stmt|;
name|totlen
operator|+=
name|l
expr_stmt|;
name|memcpy
argument_list|(
name|buf
argument_list|,
operator|&
name|ohci_endpd
argument_list|,
name|l
argument_list|)
expr_stmt|;
break|break;
case|case
name|UDESC_STRING
case|:
if|if
condition|(
name|len
operator|==
literal|0
condition|)
break|break;
operator|*
operator|(
name|u_int8_t
operator|*
operator|)
name|buf
operator|=
literal|0
expr_stmt|;
name|totlen
operator|=
literal|1
expr_stmt|;
switch|switch
condition|(
name|value
operator|&
literal|0xff
condition|)
block|{
case|case
literal|1
case|:
comment|/* Vendor */
name|totlen
operator|=
name|ohci_str
argument_list|(
name|buf
argument_list|,
name|len
argument_list|,
name|sc
operator|->
name|sc_vendor
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
comment|/* Product */
name|totlen
operator|=
name|ohci_str
argument_list|(
name|buf
argument_list|,
name|len
argument_list|,
literal|"OHCI root hub"
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
default|default:
name|r
operator|=
name|USBD_IOERROR
expr_stmt|;
goto|goto
name|ret
goto|;
block|}
break|break;
case|case
name|C
argument_list|(
name|UR_GET_INTERFACE
argument_list|,
name|UT_READ_INTERFACE
argument_list|)
case|:
if|if
condition|(
name|len
operator|>
literal|0
condition|)
block|{
operator|*
operator|(
name|u_int8_t
operator|*
operator|)
name|buf
operator|=
literal|0
expr_stmt|;
name|totlen
operator|=
literal|1
expr_stmt|;
block|}
break|break;
case|case
name|C
argument_list|(
name|UR_GET_STATUS
argument_list|,
name|UT_READ_DEVICE
argument_list|)
case|:
if|if
condition|(
name|len
operator|>
literal|1
condition|)
block|{
name|USETW
argument_list|(
operator|(
operator|(
name|usb_status_t
operator|*
operator|)
name|buf
operator|)
operator|->
name|wStatus
argument_list|,
name|UDS_SELF_POWERED
argument_list|)
expr_stmt|;
name|totlen
operator|=
literal|2
expr_stmt|;
block|}
break|break;
case|case
name|C
argument_list|(
name|UR_GET_STATUS
argument_list|,
name|UT_READ_INTERFACE
argument_list|)
case|:
case|case
name|C
argument_list|(
name|UR_GET_STATUS
argument_list|,
name|UT_READ_ENDPOINT
argument_list|)
case|:
if|if
condition|(
name|len
operator|>
literal|1
condition|)
block|{
name|USETW
argument_list|(
operator|(
operator|(
name|usb_status_t
operator|*
operator|)
name|buf
operator|)
operator|->
name|wStatus
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|totlen
operator|=
literal|2
expr_stmt|;
block|}
break|break;
case|case
name|C
argument_list|(
name|UR_SET_ADDRESS
argument_list|,
name|UT_WRITE_DEVICE
argument_list|)
case|:
if|if
condition|(
name|value
operator|>=
name|USB_MAX_DEVICES
condition|)
block|{
name|r
operator|=
name|USBD_IOERROR
expr_stmt|;
goto|goto
name|ret
goto|;
block|}
name|sc
operator|->
name|sc_addr
operator|=
name|value
expr_stmt|;
break|break;
case|case
name|C
argument_list|(
name|UR_SET_CONFIG
argument_list|,
name|UT_WRITE_DEVICE
argument_list|)
case|:
if|if
condition|(
name|value
operator|!=
literal|0
operator|&&
name|value
operator|!=
literal|1
condition|)
block|{
name|r
operator|=
name|USBD_IOERROR
expr_stmt|;
goto|goto
name|ret
goto|;
block|}
name|sc
operator|->
name|sc_conf
operator|=
name|value
expr_stmt|;
break|break;
case|case
name|C
argument_list|(
name|UR_SET_DESCRIPTOR
argument_list|,
name|UT_WRITE_DEVICE
argument_list|)
case|:
break|break;
case|case
name|C
argument_list|(
name|UR_SET_FEATURE
argument_list|,
name|UT_WRITE_DEVICE
argument_list|)
case|:
case|case
name|C
argument_list|(
name|UR_SET_FEATURE
argument_list|,
name|UT_WRITE_INTERFACE
argument_list|)
case|:
case|case
name|C
argument_list|(
name|UR_SET_FEATURE
argument_list|,
name|UT_WRITE_ENDPOINT
argument_list|)
case|:
name|r
operator|=
name|USBD_IOERROR
expr_stmt|;
goto|goto
name|ret
goto|;
case|case
name|C
argument_list|(
name|UR_SET_INTERFACE
argument_list|,
name|UT_WRITE_INTERFACE
argument_list|)
case|:
break|break;
case|case
name|C
argument_list|(
name|UR_SYNCH_FRAME
argument_list|,
name|UT_WRITE_ENDPOINT
argument_list|)
case|:
break|break;
comment|/* Hub requests */
case|case
name|C
argument_list|(
name|UR_CLEAR_FEATURE
argument_list|,
name|UT_WRITE_CLASS_DEVICE
argument_list|)
case|:
break|break;
case|case
name|C
argument_list|(
name|UR_CLEAR_FEATURE
argument_list|,
name|UT_WRITE_CLASS_OTHER
argument_list|)
case|:
name|DPRINTFN
argument_list|(
literal|8
argument_list|,
operator|(
literal|"ohci_root_ctrl_control: UR_CLEAR_PORT_FEATURE "
literal|"port=%d feature=%d\n"
operator|,
name|index
operator|,
name|value
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|index
operator|<
literal|1
operator|||
name|index
operator|>
name|sc
operator|->
name|sc_noport
condition|)
block|{
name|r
operator|=
name|USBD_IOERROR
expr_stmt|;
goto|goto
name|ret
goto|;
block|}
name|port
operator|=
name|OHCI_RH_PORT_STATUS
argument_list|(
name|index
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|value
condition|)
block|{
case|case
name|UHF_PORT_ENABLE
case|:
name|OWRITE4
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|UPS_CURRENT_CONNECT_STATUS
argument_list|)
expr_stmt|;
break|break;
case|case
name|UHF_PORT_SUSPEND
case|:
name|OWRITE4
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|UPS_OVERCURRENT_INDICATOR
argument_list|)
expr_stmt|;
break|break;
case|case
name|UHF_PORT_POWER
case|:
name|OWRITE4
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|UPS_LOW_SPEED
argument_list|)
expr_stmt|;
break|break;
case|case
name|UHF_C_PORT_CONNECTION
case|:
name|OWRITE4
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|UPS_C_CONNECT_STATUS
operator|<<
literal|16
argument_list|)
expr_stmt|;
break|break;
case|case
name|UHF_C_PORT_ENABLE
case|:
name|OWRITE4
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|UPS_C_PORT_ENABLED
operator|<<
literal|16
argument_list|)
expr_stmt|;
break|break;
case|case
name|UHF_C_PORT_SUSPEND
case|:
name|OWRITE4
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|UPS_C_SUSPEND
operator|<<
literal|16
argument_list|)
expr_stmt|;
break|break;
case|case
name|UHF_C_PORT_OVER_CURRENT
case|:
name|OWRITE4
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|UPS_C_OVERCURRENT_INDICATOR
operator|<<
literal|16
argument_list|)
expr_stmt|;
break|break;
case|case
name|UHF_C_PORT_RESET
case|:
name|OWRITE4
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|UPS_C_PORT_RESET
operator|<<
literal|16
argument_list|)
expr_stmt|;
break|break;
default|default:
name|r
operator|=
name|USBD_IOERROR
expr_stmt|;
goto|goto
name|ret
goto|;
block|}
switch|switch
condition|(
name|value
condition|)
block|{
case|case
name|UHF_C_PORT_CONNECTION
case|:
case|case
name|UHF_C_PORT_ENABLE
case|:
case|case
name|UHF_C_PORT_SUSPEND
case|:
case|case
name|UHF_C_PORT_OVER_CURRENT
case|:
case|case
name|UHF_C_PORT_RESET
case|:
comment|/* Enable RHSC interrupt if condition is cleared. */
if|if
condition|(
operator|(
name|OREAD4
argument_list|(
name|sc
argument_list|,
name|port
argument_list|)
operator|>>
literal|16
operator|)
operator|==
literal|0
condition|)
name|ohci_rhsc_able
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
break|break;
case|case
name|C
argument_list|(
name|UR_GET_DESCRIPTOR
argument_list|,
name|UT_READ_CLASS_DEVICE
argument_list|)
case|:
if|if
condition|(
name|value
operator|!=
literal|0
condition|)
block|{
name|r
operator|=
name|USBD_IOERROR
expr_stmt|;
goto|goto
name|ret
goto|;
block|}
name|v
operator|=
name|OREAD4
argument_list|(
name|sc
argument_list|,
name|OHCI_RH_DESCRIPTOR_A
argument_list|)
expr_stmt|;
name|hubd
operator|=
name|ohci_hubd
expr_stmt|;
name|hubd
operator|.
name|bNbrPorts
operator|=
name|sc
operator|->
name|sc_noport
expr_stmt|;
name|USETW
argument_list|(
name|hubd
operator|.
name|wHubCharacteristics
argument_list|,
operator|(
name|v
operator|&
name|OHCI_NPS
condition|?
name|UHD_PWR_NO_SWITCH
else|:
name|v
operator|&
name|OHCI_PSM
condition|?
name|UHD_PWR_GANGED
else|:
name|UHD_PWR_INDIVIDUAL
operator|)
comment|/* XXX overcurrent */
argument_list|)
expr_stmt|;
name|hubd
operator|.
name|bPwrOn2PwrGood
operator|=
name|OHCI_GET_POTPGT
argument_list|(
name|v
argument_list|)
expr_stmt|;
name|v
operator|=
name|OREAD4
argument_list|(
name|sc
argument_list|,
name|OHCI_RH_DESCRIPTOR_B
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|l
operator|=
name|sc
operator|->
name|sc_noport
init|;
name|l
operator|>
literal|0
condition|;
name|i
operator|++
operator|,
name|l
operator|-=
literal|8
operator|,
name|v
operator|>>=
literal|8
control|)
name|hubd
operator|.
name|DeviceRemovable
index|[
name|i
operator|++
index|]
operator|=
operator|(
name|u_int8_t
operator|)
name|v
expr_stmt|;
name|hubd
operator|.
name|bDescLength
operator|=
name|USB_HUB_DESCRIPTOR_SIZE
operator|+
name|i
expr_stmt|;
name|l
operator|=
name|min
argument_list|(
name|len
argument_list|,
name|hubd
operator|.
name|bDescLength
argument_list|)
expr_stmt|;
name|totlen
operator|=
name|l
expr_stmt|;
name|memcpy
argument_list|(
name|buf
argument_list|,
operator|&
name|hubd
argument_list|,
name|l
argument_list|)
expr_stmt|;
break|break;
case|case
name|C
argument_list|(
name|UR_GET_STATUS
argument_list|,
name|UT_READ_CLASS_DEVICE
argument_list|)
case|:
if|if
condition|(
name|len
operator|!=
literal|4
condition|)
block|{
name|r
operator|=
name|USBD_IOERROR
expr_stmt|;
goto|goto
name|ret
goto|;
block|}
name|memset
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|,
name|len
argument_list|)
expr_stmt|;
comment|/* ? XXX */
name|totlen
operator|=
name|len
expr_stmt|;
break|break;
case|case
name|C
argument_list|(
name|UR_GET_STATUS
argument_list|,
name|UT_READ_CLASS_OTHER
argument_list|)
case|:
name|DPRINTFN
argument_list|(
literal|8
argument_list|,
operator|(
literal|"ohci_root_ctrl_transfer: get port status i=%d\n"
operator|,
name|index
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|index
operator|<
literal|1
operator|||
name|index
operator|>
name|sc
operator|->
name|sc_noport
condition|)
block|{
name|r
operator|=
name|USBD_IOERROR
expr_stmt|;
goto|goto
name|ret
goto|;
block|}
if|if
condition|(
name|len
operator|!=
literal|4
condition|)
block|{
name|r
operator|=
name|USBD_IOERROR
expr_stmt|;
goto|goto
name|ret
goto|;
block|}
name|v
operator|=
name|OREAD4
argument_list|(
name|sc
argument_list|,
name|OHCI_RH_PORT_STATUS
argument_list|(
name|index
argument_list|)
argument_list|)
expr_stmt|;
name|DPRINTFN
argument_list|(
literal|8
argument_list|,
operator|(
literal|"ohci_root_ctrl_transfer: port status=0x%04x\n"
operator|,
name|v
operator|)
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|ps
operator|.
name|wPortStatus
argument_list|,
name|v
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|ps
operator|.
name|wPortChange
argument_list|,
name|v
operator|>>
literal|16
argument_list|)
expr_stmt|;
name|l
operator|=
name|min
argument_list|(
name|len
argument_list|,
sizeof|sizeof
name|ps
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|buf
argument_list|,
operator|&
name|ps
argument_list|,
name|l
argument_list|)
expr_stmt|;
name|totlen
operator|=
name|l
expr_stmt|;
break|break;
case|case
name|C
argument_list|(
name|UR_SET_DESCRIPTOR
argument_list|,
name|UT_WRITE_CLASS_DEVICE
argument_list|)
case|:
name|r
operator|=
name|USBD_IOERROR
expr_stmt|;
goto|goto
name|ret
goto|;
case|case
name|C
argument_list|(
name|UR_SET_FEATURE
argument_list|,
name|UT_WRITE_CLASS_DEVICE
argument_list|)
case|:
break|break;
case|case
name|C
argument_list|(
name|UR_SET_FEATURE
argument_list|,
name|UT_WRITE_CLASS_OTHER
argument_list|)
case|:
if|if
condition|(
name|index
operator|<
literal|1
operator|||
name|index
operator|>
name|sc
operator|->
name|sc_noport
condition|)
block|{
name|r
operator|=
name|USBD_IOERROR
expr_stmt|;
goto|goto
name|ret
goto|;
block|}
name|port
operator|=
name|OHCI_RH_PORT_STATUS
argument_list|(
name|index
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|value
condition|)
block|{
case|case
name|UHF_PORT_ENABLE
case|:
name|OWRITE4
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|UPS_PORT_ENABLED
argument_list|)
expr_stmt|;
break|break;
case|case
name|UHF_PORT_SUSPEND
case|:
name|OWRITE4
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|UPS_SUSPEND
argument_list|)
expr_stmt|;
break|break;
case|case
name|UHF_PORT_RESET
case|:
name|DPRINTFN
argument_list|(
literal|5
argument_list|,
operator|(
literal|"ohci_root_ctrl_transfer: reset port %d\n"
operator|,
name|index
operator|)
argument_list|)
expr_stmt|;
name|OWRITE4
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|UPS_RESET
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|10
condition|;
name|i
operator|++
control|)
block|{
name|usb_delay_ms
argument_list|(
operator|&
name|sc
operator|->
name|sc_bus
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|OREAD4
argument_list|(
name|sc
argument_list|,
name|port
argument_list|)
operator|&
name|UPS_RESET
operator|)
operator|==
literal|0
condition|)
break|break;
block|}
name|DPRINTFN
argument_list|(
literal|8
argument_list|,
operator|(
literal|"ohci port %d reset, status = 0x%04x\n"
operator|,
name|index
operator|,
name|OREAD4
argument_list|(
name|sc
argument_list|,
name|port
argument_list|)
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|UHF_PORT_POWER
case|:
name|DPRINTFN
argument_list|(
literal|2
argument_list|,
operator|(
literal|"ohci_root_ctrl_transfer: set port power "
literal|"%d\n"
operator|,
name|index
operator|)
argument_list|)
expr_stmt|;
name|OWRITE4
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|UPS_PORT_POWER
argument_list|)
expr_stmt|;
break|break;
default|default:
name|r
operator|=
name|USBD_IOERROR
expr_stmt|;
goto|goto
name|ret
goto|;
block|}
break|break;
default|default:
name|r
operator|=
name|USBD_IOERROR
expr_stmt|;
goto|goto
name|ret
goto|;
block|}
name|reqh
operator|->
name|actlen
operator|=
name|totlen
expr_stmt|;
name|r
operator|=
name|USBD_NORMAL_COMPLETION
expr_stmt|;
name|ret
label|:
name|reqh
operator|->
name|status
operator|=
name|r
expr_stmt|;
name|reqh
operator|->
name|xfercb
argument_list|(
name|reqh
argument_list|)
expr_stmt|;
name|usb_start_next
argument_list|(
name|reqh
operator|->
name|pipe
argument_list|)
expr_stmt|;
return|return
operator|(
name|USBD_IN_PROGRESS
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Abort a root control request. */
end_comment

begin_function
name|void
name|ohci_root_ctrl_abort
parameter_list|(
name|reqh
parameter_list|)
name|usbd_request_handle
name|reqh
decl_stmt|;
block|{
comment|/* Nothing to do, all transfers are synchronous. */
block|}
end_function

begin_comment
comment|/* Close the root pipe. */
end_comment

begin_function
name|void
name|ohci_root_ctrl_close
parameter_list|(
name|pipe
parameter_list|)
name|usbd_pipe_handle
name|pipe
decl_stmt|;
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"ohci_root_ctrl_close\n"
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|usbd_status
name|ohci_root_intr_transfer
parameter_list|(
name|reqh
parameter_list|)
name|usbd_request_handle
name|reqh
decl_stmt|;
block|{
name|int
name|s
decl_stmt|;
name|usbd_status
name|r
decl_stmt|;
name|s
operator|=
name|splusb
argument_list|()
expr_stmt|;
name|r
operator|=
name|usb_insert_transfer
argument_list|(
name|reqh
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|!=
name|USBD_NORMAL_COMPLETION
condition|)
return|return
operator|(
name|r
operator|)
return|;
else|else
return|return
operator|(
name|ohci_root_intr_start
argument_list|(
name|reqh
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|ohci_root_intr_start
parameter_list|(
name|reqh
parameter_list|)
name|usbd_request_handle
name|reqh
decl_stmt|;
block|{
name|usbd_pipe_handle
name|pipe
init|=
name|reqh
operator|->
name|pipe
decl_stmt|;
name|ohci_softc_t
modifier|*
name|sc
init|=
operator|(
name|ohci_softc_t
operator|*
operator|)
name|pipe
operator|->
name|device
operator|->
name|bus
decl_stmt|;
name|struct
name|ohci_pipe
modifier|*
name|upipe
init|=
operator|(
expr|struct
name|ohci_pipe
operator|*
operator|)
name|pipe
decl_stmt|;
name|usb_dma_t
modifier|*
name|dmap
decl_stmt|;
name|usbd_status
name|r
decl_stmt|;
name|int
name|len
decl_stmt|;
name|len
operator|=
name|reqh
operator|->
name|length
expr_stmt|;
name|dmap
operator|=
operator|&
name|upipe
operator|->
name|u
operator|.
name|intr
operator|.
name|datadma
expr_stmt|;
if|if
condition|(
name|len
operator|==
literal|0
condition|)
return|return
operator|(
name|USBD_INVAL
operator|)
return|;
comment|/* XXX should it be? */
name|r
operator|=
name|usb_allocmem
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
name|len
argument_list|,
literal|0
argument_list|,
name|dmap
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|!=
name|USBD_NORMAL_COMPLETION
condition|)
return|return
operator|(
name|r
operator|)
return|;
name|sc
operator|->
name|sc_intrreqh
operator|=
name|reqh
expr_stmt|;
return|return
operator|(
name|USBD_IN_PROGRESS
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Abort a root interrupt request. */
end_comment

begin_function
name|void
name|ohci_root_intr_abort
parameter_list|(
name|reqh
parameter_list|)
name|usbd_request_handle
name|reqh
decl_stmt|;
block|{
comment|/* No need to abort. */
block|}
end_function

begin_comment
comment|/* Close the root pipe. */
end_comment

begin_function
name|void
name|ohci_root_intr_close
parameter_list|(
name|pipe
parameter_list|)
name|usbd_pipe_handle
name|pipe
decl_stmt|;
block|{
name|ohci_softc_t
modifier|*
name|sc
init|=
operator|(
name|ohci_softc_t
operator|*
operator|)
name|pipe
operator|->
name|device
operator|->
name|bus
decl_stmt|;
name|sc
operator|->
name|sc_intrreqh
operator|=
literal|0
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"ohci_root_intr_close\n"
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/************************/
end_comment

begin_function
name|usbd_status
name|ohci_device_ctrl_transfer
parameter_list|(
name|reqh
parameter_list|)
name|usbd_request_handle
name|reqh
decl_stmt|;
block|{
name|int
name|s
decl_stmt|;
name|usbd_status
name|r
decl_stmt|;
name|s
operator|=
name|splusb
argument_list|()
expr_stmt|;
name|r
operator|=
name|usb_insert_transfer
argument_list|(
name|reqh
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|!=
name|USBD_NORMAL_COMPLETION
condition|)
return|return
operator|(
name|r
operator|)
return|;
else|else
return|return
operator|(
name|ohci_device_ctrl_start
argument_list|(
name|reqh
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|ohci_device_ctrl_start
parameter_list|(
name|reqh
parameter_list|)
name|usbd_request_handle
name|reqh
decl_stmt|;
block|{
name|ohci_softc_t
modifier|*
name|sc
init|=
operator|(
name|ohci_softc_t
operator|*
operator|)
name|reqh
operator|->
name|pipe
operator|->
name|device
operator|->
name|bus
decl_stmt|;
name|usbd_status
name|r
decl_stmt|;
if|if
condition|(
operator|!
name|reqh
operator|->
name|isreq
condition|)
block|{
comment|/* XXX panic */
name|printf
argument_list|(
literal|"ohci_device_ctrl_transfer: not a request\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|USBD_INVAL
operator|)
return|;
block|}
name|r
operator|=
name|ohci_device_request
argument_list|(
name|reqh
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|!=
name|USBD_NORMAL_COMPLETION
condition|)
return|return
operator|(
name|r
operator|)
return|;
if|if
condition|(
name|sc
operator|->
name|sc_bus
operator|.
name|use_polling
condition|)
name|ohci_waitintr
argument_list|(
name|sc
argument_list|,
name|reqh
argument_list|)
expr_stmt|;
return|return
operator|(
name|USBD_IN_PROGRESS
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Abort a device control request. */
end_comment

begin_function
name|void
name|ohci_device_ctrl_abort
parameter_list|(
name|reqh
parameter_list|)
name|usbd_request_handle
name|reqh
decl_stmt|;
block|{
comment|/* XXX inactivate */
name|usb_delay_ms
argument_list|(
name|reqh
operator|->
name|pipe
operator|->
name|device
operator|->
name|bus
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* make sure it is donw */
comment|/* XXX call done */
block|}
end_function

begin_comment
comment|/* Close a device control pipe. */
end_comment

begin_function
name|void
name|ohci_device_ctrl_close
parameter_list|(
name|pipe
parameter_list|)
name|usbd_pipe_handle
name|pipe
decl_stmt|;
block|{
name|struct
name|ohci_pipe
modifier|*
name|opipe
init|=
operator|(
expr|struct
name|ohci_pipe
operator|*
operator|)
name|pipe
decl_stmt|;
name|ohci_softc_t
modifier|*
name|sc
init|=
operator|(
name|ohci_softc_t
operator|*
operator|)
name|pipe
operator|->
name|device
operator|->
name|bus
decl_stmt|;
name|ohci_soft_ed_t
modifier|*
name|sed
init|=
name|opipe
operator|->
name|sed
decl_stmt|;
name|int
name|s
decl_stmt|;
name|s
operator|=
name|splusb
argument_list|()
expr_stmt|;
name|sed
operator|->
name|ed
operator|->
name|ed_flags
operator||=
name|LE
argument_list|(
name|OHCI_ED_SKIP
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|LE
argument_list|(
name|sed
operator|->
name|ed
operator|->
name|ed_tailp
argument_list|)
operator|&
name|OHCI_TAILMASK
operator|)
operator|!=
name|LE
argument_list|(
name|sed
operator|->
name|ed
operator|->
name|ed_headp
argument_list|)
condition|)
name|usb_delay_ms
argument_list|(
operator|&
name|sc
operator|->
name|sc_bus
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|ohci_rem_ed
argument_list|(
name|sed
argument_list|,
name|sc
operator|->
name|sc_ctrl_head
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|ohci_free_std
argument_list|(
name|sc
argument_list|,
name|opipe
operator|->
name|tail
argument_list|)
expr_stmt|;
name|ohci_free_sed
argument_list|(
name|sc
argument_list|,
name|opipe
operator|->
name|sed
argument_list|)
expr_stmt|;
comment|/* XXX free other resources */
block|}
end_function

begin_comment
comment|/************************/
end_comment

begin_function
name|usbd_status
name|ohci_device_bulk_transfer
parameter_list|(
name|reqh
parameter_list|)
name|usbd_request_handle
name|reqh
decl_stmt|;
block|{
name|int
name|s
decl_stmt|;
name|usbd_status
name|r
decl_stmt|;
name|s
operator|=
name|splusb
argument_list|()
expr_stmt|;
name|r
operator|=
name|usb_insert_transfer
argument_list|(
name|reqh
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|!=
name|USBD_NORMAL_COMPLETION
condition|)
return|return
operator|(
name|r
operator|)
return|;
else|else
return|return
operator|(
name|ohci_device_bulk_start
argument_list|(
name|reqh
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|ohci_device_bulk_start
parameter_list|(
name|reqh
parameter_list|)
name|usbd_request_handle
name|reqh
decl_stmt|;
block|{
name|struct
name|ohci_pipe
modifier|*
name|opipe
init|=
operator|(
expr|struct
name|ohci_pipe
operator|*
operator|)
name|reqh
operator|->
name|pipe
decl_stmt|;
name|usbd_device_handle
name|dev
init|=
name|opipe
operator|->
name|pipe
operator|.
name|device
decl_stmt|;
name|ohci_softc_t
modifier|*
name|sc
init|=
operator|(
name|ohci_softc_t
operator|*
operator|)
name|dev
operator|->
name|bus
decl_stmt|;
name|int
name|addr
init|=
name|dev
operator|->
name|address
decl_stmt|;
name|ohci_soft_td_t
modifier|*
name|xfer
decl_stmt|,
modifier|*
name|tail
decl_stmt|;
name|ohci_soft_ed_t
modifier|*
name|sed
decl_stmt|;
name|usb_dma_t
modifier|*
name|dmap
decl_stmt|;
name|usbd_status
name|r
decl_stmt|;
name|int
name|s
decl_stmt|,
name|len
decl_stmt|,
name|isread
decl_stmt|;
if|if
condition|(
name|reqh
operator|->
name|isreq
condition|)
block|{
comment|/* XXX panic */
name|printf
argument_list|(
literal|"ohci_device_bulk_transfer: a request\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|USBD_INVAL
operator|)
return|;
block|}
name|len
operator|=
name|reqh
operator|->
name|length
expr_stmt|;
name|dmap
operator|=
operator|&
name|opipe
operator|->
name|u
operator|.
name|bulk
operator|.
name|datadma
expr_stmt|;
name|isread
operator|=
name|reqh
operator|->
name|pipe
operator|->
name|endpoint
operator|->
name|edesc
operator|->
name|bEndpointAddress
operator|&
name|UE_IN
expr_stmt|;
name|sed
operator|=
name|opipe
operator|->
name|sed
expr_stmt|;
name|opipe
operator|->
name|u
operator|.
name|bulk
operator|.
name|length
operator|=
name|len
expr_stmt|;
name|r
operator|=
name|usb_allocmem
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
name|len
argument_list|,
literal|0
argument_list|,
name|dmap
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|!=
name|USBD_NORMAL_COMPLETION
condition|)
goto|goto
name|ret1
goto|;
name|tail
operator|=
name|ohci_alloc_std
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tail
condition|)
block|{
name|r
operator|=
name|USBD_NOMEM
expr_stmt|;
goto|goto
name|ret2
goto|;
block|}
name|tail
operator|->
name|reqh
operator|=
literal|0
expr_stmt|;
comment|/* Update device address */
name|sed
operator|->
name|ed
operator|->
name|ed_flags
operator|=
name|LE
argument_list|(
operator|(
name|LE
argument_list|(
name|sed
operator|->
name|ed
operator|->
name|ed_flags
argument_list|)
operator|&
operator|~
name|OHCI_ED_ADDRMASK
operator|)
operator||
name|OHCI_ED_SET_FA
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Set up data transaction */
name|xfer
operator|=
name|opipe
operator|->
name|tail
expr_stmt|;
name|xfer
operator|->
name|td
operator|->
name|td_flags
operator|=
name|LE
argument_list|(
operator|(
name|isread
condition|?
name|OHCI_TD_IN
else|:
name|OHCI_TD_OUT
operator|)
operator||
name|OHCI_TD_NOCC
operator||
name|OHCI_TD_SET_DI
argument_list|(
literal|1
argument_list|)
operator||
name|OHCI_TD_TOGGLE_CARRY
operator||
operator|(
name|reqh
operator|->
name|flags
operator|&
name|USBD_SHORT_XFER_OK
condition|?
name|OHCI_TD_R
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|xfer
operator|->
name|td
operator|->
name|td_cbp
operator|=
name|LE
argument_list|(
name|DMAADDR
argument_list|(
name|dmap
argument_list|)
argument_list|)
expr_stmt|;
name|xfer
operator|->
name|nexttd
operator|=
name|tail
expr_stmt|;
name|xfer
operator|->
name|td
operator|->
name|td_nexttd
operator|=
name|LE
argument_list|(
name|tail
operator|->
name|physaddr
argument_list|)
expr_stmt|;
name|xfer
operator|->
name|td
operator|->
name|td_be
operator|=
name|LE
argument_list|(
name|LE
argument_list|(
name|xfer
operator|->
name|td
operator|->
name|td_cbp
argument_list|)
operator|+
name|len
operator|-
literal|1
argument_list|)
expr_stmt|;
name|xfer
operator|->
name|len
operator|=
name|len
expr_stmt|;
name|xfer
operator|->
name|reqh
operator|=
name|reqh
expr_stmt|;
name|reqh
operator|->
name|hcpriv
operator|=
name|xfer
expr_stmt|;
if|if
condition|(
operator|!
name|isread
condition|)
name|memcpy
argument_list|(
name|KERNADDR
argument_list|(
name|dmap
argument_list|)
argument_list|,
name|reqh
operator|->
name|buffer
argument_list|,
name|len
argument_list|)
expr_stmt|;
comment|/* Insert ED in schedule */
name|s
operator|=
name|splusb
argument_list|()
expr_stmt|;
name|ohci_hash_add_td
argument_list|(
name|sc
argument_list|,
name|xfer
argument_list|)
expr_stmt|;
name|sed
operator|->
name|ed
operator|->
name|ed_tailp
operator|=
name|LE
argument_list|(
name|tail
operator|->
name|physaddr
argument_list|)
expr_stmt|;
name|opipe
operator|->
name|tail
operator|=
name|tail
expr_stmt|;
name|OWRITE4
argument_list|(
name|sc
argument_list|,
name|OHCI_COMMAND_STATUS
argument_list|,
name|OHCI_BLF
argument_list|)
expr_stmt|;
if|if
condition|(
name|reqh
operator|->
name|timeout
operator|&&
operator|!
name|sc
operator|->
name|sc_bus
operator|.
name|use_polling
condition|)
block|{
name|usb_timeout
argument_list|(
name|ohci_timeout
argument_list|,
name|reqh
argument_list|,
name|MS_TO_TICKS
argument_list|(
name|reqh
operator|->
name|timeout
argument_list|)
argument_list|,
name|reqh
operator|->
name|timeout_handle
argument_list|)
expr_stmt|;
block|}
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
operator|(
name|USBD_IN_PROGRESS
operator|)
return|;
name|ret2
label|:
name|usb_freemem
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
name|dmap
argument_list|)
expr_stmt|;
name|ret1
label|:
return|return
operator|(
name|r
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Abort a device bulk request. */
end_comment

begin_function
name|void
name|ohci_device_bulk_abort
parameter_list|(
name|reqh
parameter_list|)
name|usbd_request_handle
name|reqh
decl_stmt|;
block|{
if|#
directive|if
literal|0
block|sed->ed->ed_flags |= LE(OHCI_ED_SKIP); 	if ((LE(sed->ed->ed_tailp)& OHCI_TAILMASK) != LE(sed->ed->ed_headp)) 		usb_delay_ms(reqh->pipe->device->bus, 2);
endif|#
directive|endif
comment|/* XXX inactivate */
name|usb_delay_ms
argument_list|(
name|reqh
operator|->
name|pipe
operator|->
name|device
operator|->
name|bus
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* make sure it is done */
comment|/* XXX call done */
block|}
end_function

begin_comment
comment|/* Close a device bulk pipe. */
end_comment

begin_function
name|void
name|ohci_device_bulk_close
parameter_list|(
name|pipe
parameter_list|)
name|usbd_pipe_handle
name|pipe
decl_stmt|;
block|{
name|struct
name|ohci_pipe
modifier|*
name|opipe
init|=
operator|(
expr|struct
name|ohci_pipe
operator|*
operator|)
name|pipe
decl_stmt|;
name|usbd_device_handle
name|dev
init|=
name|opipe
operator|->
name|pipe
operator|.
name|device
decl_stmt|;
name|ohci_softc_t
modifier|*
name|sc
init|=
operator|(
name|ohci_softc_t
operator|*
operator|)
name|dev
operator|->
name|bus
decl_stmt|;
name|int
name|s
decl_stmt|;
name|s
operator|=
name|splusb
argument_list|()
expr_stmt|;
name|ohci_rem_ed
argument_list|(
name|opipe
operator|->
name|sed
argument_list|,
name|sc
operator|->
name|sc_bulk_head
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|ohci_free_std
argument_list|(
name|sc
argument_list|,
name|opipe
operator|->
name|tail
argument_list|)
expr_stmt|;
name|ohci_free_sed
argument_list|(
name|sc
argument_list|,
name|opipe
operator|->
name|sed
argument_list|)
expr_stmt|;
comment|/* XXX free other resources */
block|}
end_function

begin_comment
comment|/************************/
end_comment

begin_function
name|usbd_status
name|ohci_device_intr_transfer
parameter_list|(
name|reqh
parameter_list|)
name|usbd_request_handle
name|reqh
decl_stmt|;
block|{
name|int
name|s
decl_stmt|;
name|usbd_status
name|r
decl_stmt|;
name|s
operator|=
name|splusb
argument_list|()
expr_stmt|;
name|r
operator|=
name|usb_insert_transfer
argument_list|(
name|reqh
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|!=
name|USBD_NORMAL_COMPLETION
condition|)
return|return
operator|(
name|r
operator|)
return|;
else|else
return|return
operator|(
name|ohci_device_intr_start
argument_list|(
name|reqh
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|ohci_device_intr_start
parameter_list|(
name|reqh
parameter_list|)
name|usbd_request_handle
name|reqh
decl_stmt|;
block|{
name|struct
name|ohci_pipe
modifier|*
name|opipe
init|=
operator|(
expr|struct
name|ohci_pipe
operator|*
operator|)
name|reqh
operator|->
name|pipe
decl_stmt|;
name|usbd_device_handle
name|dev
init|=
name|opipe
operator|->
name|pipe
operator|.
name|device
decl_stmt|;
name|ohci_softc_t
modifier|*
name|sc
init|=
operator|(
name|ohci_softc_t
operator|*
operator|)
name|dev
operator|->
name|bus
decl_stmt|;
name|ohci_soft_ed_t
modifier|*
name|sed
init|=
name|opipe
operator|->
name|sed
decl_stmt|;
name|ohci_soft_td_t
modifier|*
name|xfer
decl_stmt|,
modifier|*
name|tail
decl_stmt|;
name|usb_dma_t
modifier|*
name|dmap
decl_stmt|;
name|usbd_status
name|r
decl_stmt|;
name|int
name|len
decl_stmt|;
name|int
name|s
decl_stmt|;
name|DPRINTFN
argument_list|(
literal|3
argument_list|,
operator|(
literal|"ohci_device_intr_transfer: reqh=%p buf=%p len=%d "
literal|"flags=%d priv=%p\n"
operator|,
name|reqh
operator|,
name|reqh
operator|->
name|buffer
operator|,
name|reqh
operator|->
name|length
operator|,
name|reqh
operator|->
name|flags
operator|,
name|reqh
operator|->
name|priv
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|reqh
operator|->
name|isreq
condition|)
name|panic
argument_list|(
literal|"ohci_device_intr_transfer: a request\n"
argument_list|)
expr_stmt|;
name|len
operator|=
name|reqh
operator|->
name|length
expr_stmt|;
name|dmap
operator|=
operator|&
name|opipe
operator|->
name|u
operator|.
name|intr
operator|.
name|datadma
expr_stmt|;
if|if
condition|(
name|len
operator|==
literal|0
condition|)
return|return
operator|(
name|USBD_INVAL
operator|)
return|;
comment|/* XXX should it be? */
name|xfer
operator|=
name|opipe
operator|->
name|tail
expr_stmt|;
name|tail
operator|=
name|ohci_alloc_std
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tail
condition|)
block|{
name|r
operator|=
name|USBD_NOMEM
expr_stmt|;
goto|goto
name|ret1
goto|;
block|}
name|tail
operator|->
name|reqh
operator|=
literal|0
expr_stmt|;
name|r
operator|=
name|usb_allocmem
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
name|len
argument_list|,
literal|0
argument_list|,
name|dmap
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|!=
name|USBD_NORMAL_COMPLETION
condition|)
goto|goto
name|ret2
goto|;
name|xfer
operator|->
name|td
operator|->
name|td_flags
operator|=
name|LE
argument_list|(
name|OHCI_TD_IN
operator||
name|OHCI_TD_NOCC
operator||
name|OHCI_TD_SET_DI
argument_list|(
literal|1
argument_list|)
operator||
name|OHCI_TD_TOGGLE_CARRY
argument_list|)
expr_stmt|;
if|if
condition|(
name|reqh
operator|->
name|flags
operator|&
name|USBD_SHORT_XFER_OK
condition|)
name|xfer
operator|->
name|td
operator|->
name|td_flags
operator||=
name|LE
argument_list|(
name|OHCI_TD_R
argument_list|)
expr_stmt|;
name|xfer
operator|->
name|td
operator|->
name|td_cbp
operator|=
name|LE
argument_list|(
name|DMAADDR
argument_list|(
name|dmap
argument_list|)
argument_list|)
expr_stmt|;
name|xfer
operator|->
name|nexttd
operator|=
name|tail
expr_stmt|;
name|xfer
operator|->
name|td
operator|->
name|td_nexttd
operator|=
name|LE
argument_list|(
name|tail
operator|->
name|physaddr
argument_list|)
expr_stmt|;
name|xfer
operator|->
name|td
operator|->
name|td_be
operator|=
name|LE
argument_list|(
name|LE
argument_list|(
name|xfer
operator|->
name|td
operator|->
name|td_cbp
argument_list|)
operator|+
name|len
operator|-
literal|1
argument_list|)
expr_stmt|;
name|xfer
operator|->
name|len
operator|=
name|len
expr_stmt|;
name|xfer
operator|->
name|reqh
operator|=
name|reqh
expr_stmt|;
name|reqh
operator|->
name|hcpriv
operator|=
name|xfer
expr_stmt|;
ifdef|#
directive|ifdef
name|OHCI_DEBUG
if|if
condition|(
name|ohcidebug
operator|>
literal|5
condition|)
block|{
name|printf
argument_list|(
literal|"ohci_device_intr_transfer:\n"
argument_list|)
expr_stmt|;
name|ohci_dump_ed
argument_list|(
name|sed
argument_list|)
expr_stmt|;
name|ohci_dump_tds
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* Insert ED in schedule */
name|s
operator|=
name|splusb
argument_list|()
expr_stmt|;
name|ohci_hash_add_td
argument_list|(
name|sc
argument_list|,
name|xfer
argument_list|)
expr_stmt|;
name|sed
operator|->
name|ed
operator|->
name|ed_tailp
operator|=
name|LE
argument_list|(
name|tail
operator|->
name|physaddr
argument_list|)
expr_stmt|;
name|opipe
operator|->
name|tail
operator|=
name|tail
expr_stmt|;
if|#
directive|if
literal|0
block|if (reqh->timeout&& !sc->sc_bus.use_polling) {                 usb_timeout(ohci_timeout, reqh, 			    MS_TO_TICKS(reqh->timeout), reqh->timeout_handle); 	}
endif|#
directive|endif
name|sed
operator|->
name|ed
operator|->
name|ed_flags
operator|&=
name|LE
argument_list|(
operator|~
name|OHCI_ED_SKIP
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
ifdef|#
directive|ifdef
name|OHCI_DEBUG
block|if (ohcidebug> 15) { 		delay(5000); 		printf("ohci_device_intr_transfer: status=%x\n", 		       OREAD4(sc, OHCI_COMMAND_STATUS)); 		ohci_dump_ed(sed); 		ohci_dump_tds(xfer); 	}
endif|#
directive|endif
endif|#
directive|endif
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
operator|(
name|USBD_IN_PROGRESS
operator|)
return|;
name|ret2
label|:
name|ohci_free_std
argument_list|(
name|sc
argument_list|,
name|xfer
argument_list|)
expr_stmt|;
name|ret1
label|:
return|return
operator|(
name|r
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Abort a device control request. */
end_comment

begin_function
name|void
name|ohci_device_intr_abort
parameter_list|(
name|reqh
parameter_list|)
name|usbd_request_handle
name|reqh
decl_stmt|;
block|{
comment|/* XXX inactivate */
name|usb_delay_ms
argument_list|(
name|reqh
operator|->
name|pipe
operator|->
name|device
operator|->
name|bus
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* make sure it is done */
if|if
condition|(
name|reqh
operator|->
name|pipe
operator|->
name|intrreqh
operator|==
name|reqh
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"ohci_device_intr_abort: remove\n"
operator|)
argument_list|)
expr_stmt|;
name|reqh
operator|->
name|pipe
operator|->
name|intrreqh
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* Close a device interrupt pipe. */
end_comment

begin_function
name|void
name|ohci_device_intr_close
parameter_list|(
name|pipe
parameter_list|)
name|usbd_pipe_handle
name|pipe
decl_stmt|;
block|{
name|struct
name|ohci_pipe
modifier|*
name|opipe
init|=
operator|(
expr|struct
name|ohci_pipe
operator|*
operator|)
name|pipe
decl_stmt|;
name|ohci_softc_t
modifier|*
name|sc
init|=
operator|(
name|ohci_softc_t
operator|*
operator|)
name|pipe
operator|->
name|device
operator|->
name|bus
decl_stmt|;
name|int
name|nslots
init|=
name|opipe
operator|->
name|u
operator|.
name|intr
operator|.
name|nslots
decl_stmt|;
name|int
name|pos
init|=
name|opipe
operator|->
name|u
operator|.
name|intr
operator|.
name|pos
decl_stmt|;
name|int
name|j
decl_stmt|;
name|ohci_soft_ed_t
modifier|*
name|p
decl_stmt|,
modifier|*
name|sed
init|=
name|opipe
operator|->
name|sed
decl_stmt|;
name|int
name|s
decl_stmt|;
name|DPRINTFN
argument_list|(
literal|1
argument_list|,
operator|(
literal|"ohci_device_intr_close: pipe=%p nslots=%d pos=%d\n"
operator|,
name|pipe
operator|,
name|nslots
operator|,
name|pos
operator|)
argument_list|)
expr_stmt|;
name|s
operator|=
name|splusb
argument_list|()
expr_stmt|;
name|sed
operator|->
name|ed
operator|->
name|ed_flags
operator||=
name|LE
argument_list|(
name|OHCI_ED_SKIP
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sed
operator|->
name|ed
operator|->
name|ed_tailp
operator|&
name|LE
argument_list|(
name|OHCI_TAILMASK
argument_list|)
operator|)
operator|!=
name|sed
operator|->
name|ed
operator|->
name|ed_headp
condition|)
name|usb_delay_ms
argument_list|(
operator|&
name|sc
operator|->
name|sc_bus
argument_list|,
literal|2
argument_list|)
expr_stmt|;
for|for
control|(
name|p
operator|=
name|sc
operator|->
name|sc_eds
index|[
name|pos
index|]
init|;
name|p
operator|&&
name|p
operator|->
name|next
operator|!=
name|sed
condition|;
name|p
operator|=
name|p
operator|->
name|next
control|)
empty_stmt|;
if|if
condition|(
operator|!
name|p
condition|)
name|panic
argument_list|(
literal|"ohci_device_intr_close: ED not found\n"
argument_list|)
expr_stmt|;
name|p
operator|->
name|next
operator|=
name|sed
operator|->
name|next
expr_stmt|;
name|p
operator|->
name|ed
operator|->
name|ed_nexted
operator|=
name|sed
operator|->
name|ed
operator|->
name|ed_nexted
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|nslots
condition|;
name|j
operator|++
control|)
operator|--
name|sc
operator|->
name|sc_bws
index|[
name|pos
operator|*
name|nslots
operator|+
name|j
index|]
expr_stmt|;
name|ohci_free_std
argument_list|(
name|sc
argument_list|,
name|opipe
operator|->
name|tail
argument_list|)
expr_stmt|;
name|ohci_free_sed
argument_list|(
name|sc
argument_list|,
name|opipe
operator|->
name|sed
argument_list|)
expr_stmt|;
comment|/* XXX free other resources */
block|}
end_function

begin_function
name|usbd_status
name|ohci_device_setintr
parameter_list|(
name|sc
parameter_list|,
name|opipe
parameter_list|,
name|ival
parameter_list|)
name|ohci_softc_t
modifier|*
name|sc
decl_stmt|;
name|struct
name|ohci_pipe
modifier|*
name|opipe
decl_stmt|;
name|int
name|ival
decl_stmt|;
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|s
decl_stmt|,
name|best
decl_stmt|;
name|u_int
name|npoll
decl_stmt|,
name|slow
decl_stmt|,
name|shigh
decl_stmt|,
name|nslots
decl_stmt|;
name|u_int
name|bestbw
decl_stmt|,
name|bw
decl_stmt|;
name|ohci_soft_ed_t
modifier|*
name|hsed
decl_stmt|,
modifier|*
name|sed
init|=
name|opipe
operator|->
name|sed
decl_stmt|;
name|DPRINTFN
argument_list|(
literal|2
argument_list|,
operator|(
literal|"ohci_setintr: pipe=%p\n"
operator|,
name|opipe
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ival
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"ohci_setintr: 0 interval\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|USBD_INVAL
operator|)
return|;
block|}
name|npoll
operator|=
name|OHCI_NO_INTRS
expr_stmt|;
while|while
condition|(
name|npoll
operator|>
name|ival
condition|)
name|npoll
operator|/=
literal|2
expr_stmt|;
name|DPRINTFN
argument_list|(
literal|2
argument_list|,
operator|(
literal|"ohci_setintr: ival=%d npoll=%d\n"
operator|,
name|ival
operator|,
name|npoll
operator|)
argument_list|)
expr_stmt|;
comment|/* 	 * We now know which level in the tree the ED must go into. 	 * Figure out which slot has most bandwidth left over. 	 * Slots to examine: 	 * npoll 	 * 1	0 	 * 2	1 2 	 * 4	3 4 5 6 	 * 8	7 8 9 10 11 12 13 14 	 * N    (N-1) .. (N-1+N-1) 	 */
name|slow
operator|=
name|npoll
operator|-
literal|1
expr_stmt|;
name|shigh
operator|=
name|slow
operator|+
name|npoll
expr_stmt|;
name|nslots
operator|=
name|OHCI_NO_INTRS
operator|/
name|npoll
expr_stmt|;
for|for
control|(
name|best
operator|=
name|i
operator|=
name|slow
operator|,
name|bestbw
operator|=
operator|~
literal|0
init|;
name|i
operator|<
name|shigh
condition|;
name|i
operator|++
control|)
block|{
name|bw
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|nslots
condition|;
name|j
operator|++
control|)
name|bw
operator|+=
name|sc
operator|->
name|sc_bws
index|[
name|i
operator|*
name|nslots
operator|+
name|j
index|]
expr_stmt|;
if|if
condition|(
name|bw
operator|<
name|bestbw
condition|)
block|{
name|best
operator|=
name|i
expr_stmt|;
name|bestbw
operator|=
name|bw
expr_stmt|;
block|}
block|}
name|DPRINTFN
argument_list|(
literal|2
argument_list|,
operator|(
literal|"ohci_setintr: best=%d(%d..%d) bestbw=%d\n"
operator|,
name|best
operator|,
name|slow
operator|,
name|shigh
operator|,
name|bestbw
operator|)
argument_list|)
expr_stmt|;
name|s
operator|=
name|splusb
argument_list|()
expr_stmt|;
name|hsed
operator|=
name|sc
operator|->
name|sc_eds
index|[
name|best
index|]
expr_stmt|;
name|sed
operator|->
name|next
operator|=
name|hsed
operator|->
name|next
expr_stmt|;
name|sed
operator|->
name|ed
operator|->
name|ed_nexted
operator|=
name|hsed
operator|->
name|ed
operator|->
name|ed_nexted
expr_stmt|;
name|hsed
operator|->
name|next
operator|=
name|sed
expr_stmt|;
name|hsed
operator|->
name|ed
operator|->
name|ed_nexted
operator|=
name|LE
argument_list|(
name|sed
operator|->
name|physaddr
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|nslots
condition|;
name|j
operator|++
control|)
operator|++
name|sc
operator|->
name|sc_bws
index|[
name|best
operator|*
name|nslots
operator|+
name|j
index|]
expr_stmt|;
name|opipe
operator|->
name|u
operator|.
name|intr
operator|.
name|nslots
operator|=
name|nslots
expr_stmt|;
name|opipe
operator|->
name|u
operator|.
name|intr
operator|.
name|pos
operator|=
name|best
expr_stmt|;
name|DPRINTFN
argument_list|(
literal|5
argument_list|,
operator|(
literal|"ohci_setintr: returns %p\n"
operator|,
name|opipe
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|USBD_NORMAL_COMPLETION
operator|)
return|;
block|}
end_function

end_unit


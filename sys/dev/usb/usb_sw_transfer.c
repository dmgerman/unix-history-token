begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* $FreeBSD$ */
end_comment

begin_comment
comment|/*-  * Copyright (c) 2008 Hans Petter Selasky. All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<dev/usb/usb_mfunc.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb_error.h>
end_include

begin_define
define|#
directive|define
name|USB_DEBUG_VAR
value|usb2_debug
end_define

begin_include
include|#
directive|include
file|<dev/usb/usb_core.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb_process.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb_busdma.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb_transfer.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb_sw_transfer.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb_device.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb_debug.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb_controller.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb_bus.h>
end_include

begin_comment
comment|/*------------------------------------------------------------------------*  *	usb2_sw_transfer - factored out code  *  * This function is basically used for the Virtual Root HUB, and can  * emulate control, bulk and interrupt endpoints. Data is exchanged  * using the "std->ptr" and "std->len" fields, that allows kernel  * virtual memory to be transferred. All state is kept in the  * structure pointed to by the "std" argument passed to this  * function. The "func" argument points to a function that is called  * back in the various states, so that the application using this  * function can get a chance to select the outcome. The "func"  * function is allowed to sleep, exiting all mutexes. If this function  * will sleep the "enter" and "start" methods must be marked  * non-cancelable, hence there is no extra cancelled checking in this  * function.  *------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|usb2_sw_transfer
parameter_list|(
name|struct
name|usb2_sw_transfer
modifier|*
name|std
parameter_list|,
name|usb2_sw_transfer_func_t
modifier|*
name|func
parameter_list|)
block|{
name|struct
name|usb2_xfer
modifier|*
name|xfer
decl_stmt|;
name|usb2_frlength_t
name|len
decl_stmt|;
name|uint8_t
name|shortpkt
init|=
literal|0
decl_stmt|;
name|xfer
operator|=
name|std
operator|->
name|xfer
expr_stmt|;
if|if
condition|(
name|xfer
operator|==
name|NULL
condition|)
block|{
comment|/* the transfer is gone */
name|DPRINTF
argument_list|(
literal|"xfer gone\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|USB_BUS_LOCK_ASSERT
argument_list|(
name|xfer
operator|->
name|xroot
operator|->
name|bus
argument_list|,
name|MA_OWNED
argument_list|)
expr_stmt|;
name|std
operator|->
name|xfer
operator|=
name|NULL
expr_stmt|;
comment|/* check for control transfer */
if|if
condition|(
name|xfer
operator|->
name|flags_int
operator|.
name|control_xfr
condition|)
block|{
comment|/* check if we are transferring the SETUP packet */
if|if
condition|(
name|xfer
operator|->
name|flags_int
operator|.
name|control_hdr
condition|)
block|{
comment|/* copy out the USB request */
if|if
condition|(
name|xfer
operator|->
name|frlengths
index|[
literal|0
index|]
operator|==
sizeof|sizeof
argument_list|(
name|std
operator|->
name|req
argument_list|)
condition|)
block|{
name|usb2_copy_out
argument_list|(
name|xfer
operator|->
name|frbuffers
argument_list|,
literal|0
argument_list|,
operator|&
name|std
operator|->
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|std
operator|->
name|req
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|std
operator|->
name|err
operator|=
name|USB_ERR_INVAL
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|xfer
operator|->
name|aframes
operator|=
literal|1
expr_stmt|;
name|std
operator|->
name|err
operator|=
literal|0
expr_stmt|;
name|std
operator|->
name|state
operator|=
name|USB_SW_TR_SETUP
expr_stmt|;
call|(
name|func
call|)
argument_list|(
name|xfer
argument_list|,
name|std
argument_list|)
expr_stmt|;
if|if
condition|(
name|std
operator|->
name|err
condition|)
block|{
goto|goto
name|done
goto|;
block|}
block|}
else|else
block|{
comment|/* skip the first frame in this case */
name|xfer
operator|->
name|aframes
operator|=
literal|1
expr_stmt|;
block|}
block|}
name|std
operator|->
name|err
operator|=
literal|0
expr_stmt|;
name|std
operator|->
name|state
operator|=
name|USB_SW_TR_PRE_DATA
expr_stmt|;
call|(
name|func
call|)
argument_list|(
name|xfer
argument_list|,
name|std
argument_list|)
expr_stmt|;
if|if
condition|(
name|std
operator|->
name|err
condition|)
block|{
goto|goto
name|done
goto|;
block|}
comment|/* Transfer data. Iterate accross all frames. */
while|while
condition|(
name|xfer
operator|->
name|aframes
operator|!=
name|xfer
operator|->
name|nframes
condition|)
block|{
name|len
operator|=
name|xfer
operator|->
name|frlengths
index|[
name|xfer
operator|->
name|aframes
index|]
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|std
operator|->
name|len
condition|)
block|{
name|len
operator|=
name|std
operator|->
name|len
expr_stmt|;
name|shortpkt
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|len
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|xfer
operator|->
name|endpoint
operator|&
operator|(
name|UE_DIR_IN
operator||
name|UE_DIR_OUT
operator|)
operator|)
operator|==
name|UE_DIR_IN
condition|)
block|{
name|usb2_copy_in
argument_list|(
name|xfer
operator|->
name|frbuffers
operator|+
name|xfer
operator|->
name|aframes
argument_list|,
literal|0
argument_list|,
name|std
operator|->
name|ptr
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|usb2_copy_out
argument_list|(
name|xfer
operator|->
name|frbuffers
operator|+
name|xfer
operator|->
name|aframes
argument_list|,
literal|0
argument_list|,
name|std
operator|->
name|ptr
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
block|}
name|std
operator|->
name|ptr
operator|+=
name|len
expr_stmt|;
name|std
operator|->
name|len
operator|-=
name|len
expr_stmt|;
name|xfer
operator|->
name|frlengths
index|[
name|xfer
operator|->
name|aframes
index|]
operator|=
name|len
expr_stmt|;
name|xfer
operator|->
name|aframes
operator|++
expr_stmt|;
if|if
condition|(
name|shortpkt
condition|)
block|{
break|break;
block|}
block|}
name|std
operator|->
name|err
operator|=
literal|0
expr_stmt|;
name|std
operator|->
name|state
operator|=
name|USB_SW_TR_POST_DATA
expr_stmt|;
call|(
name|func
call|)
argument_list|(
name|xfer
argument_list|,
name|std
argument_list|)
expr_stmt|;
if|if
condition|(
name|std
operator|->
name|err
condition|)
block|{
goto|goto
name|done
goto|;
block|}
comment|/* check if the control transfer is complete */
if|if
condition|(
name|xfer
operator|->
name|flags_int
operator|.
name|control_xfr
operator|&&
operator|!
name|xfer
operator|->
name|flags_int
operator|.
name|control_act
condition|)
block|{
name|std
operator|->
name|err
operator|=
literal|0
expr_stmt|;
name|std
operator|->
name|state
operator|=
name|USB_SW_TR_STATUS
expr_stmt|;
call|(
name|func
call|)
argument_list|(
name|xfer
argument_list|,
name|std
argument_list|)
expr_stmt|;
if|if
condition|(
name|std
operator|->
name|err
condition|)
block|{
goto|goto
name|done
goto|;
block|}
block|}
name|done
label|:
name|DPRINTF
argument_list|(
literal|"done err=%s\n"
argument_list|,
name|usb2_errstr
argument_list|(
name|std
operator|->
name|err
argument_list|)
argument_list|)
expr_stmt|;
name|std
operator|->
name|state
operator|=
name|USB_SW_TR_PRE_CALLBACK
expr_stmt|;
call|(
name|func
call|)
argument_list|(
name|xfer
argument_list|,
name|std
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


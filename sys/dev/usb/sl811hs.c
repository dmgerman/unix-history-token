begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	$NetBSD: sl811hs.c,v 1.5 2005/02/27 00:27:02 perry Exp $	*/
end_comment

begin_comment
comment|/*  * Copyright (c) 2001 The NetBSD Foundation, Inc.  * All rights reserved.  *  * This code is derived from software contributed to The NetBSD Foundation  * by Tetsuya Isaki.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. All advertising materials mentioning features or use of this software  *    must display the following acknowledgement:  *      This product includes software developed by the NetBSD  *      Foundation, Inc. and its contributors.  * 4. Neither the name of The NetBSD Foundation nor the names of its  *    contributors may be used to endorse or promote products derived  *    from this software without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE NETBSD FOUNDATION, INC. AND CONTRIBUTORS  * ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED  * TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE FOUNDATION OR CONTRIBUTORS  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE  * POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_comment
comment|/*  * ScanLogic SL811HS/T USB Host Controller  */
end_comment

begin_comment
comment|/*  * !! HIGHLY EXPERIMENTAL CODE !!  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_comment
comment|//_RCSID(0, "$NetBSD: sl811hs.c,v 1.5 2005/02/27 00:27:02 perry Exp $");
end_comment

begin_include
include|#
directive|include
file|"opt_slhci.h"
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/cpu.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usbdi.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usbdivar.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb_mem.h>
end_include

begin_include
include|#
directive|include
file|"usbdevs.h"
end_include

begin_include
include|#
directive|include
file|<dev/usb/sl811hsreg.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/sl811hsvar.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function_decl
specifier|static
specifier|inline
name|u_int8_t
name|sl11read
parameter_list|(
name|struct
name|slhci_softc
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|void
name|sl11write
parameter_list|(
name|struct
name|slhci_softc
modifier|*
parameter_list|,
name|int
parameter_list|,
name|u_int8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|void
name|sl11read_region
parameter_list|(
name|struct
name|slhci_softc
modifier|*
parameter_list|,
name|u_char
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|void
name|sl11write_region
parameter_list|(
name|struct
name|slhci_softc
modifier|*
parameter_list|,
name|int
parameter_list|,
name|u_char
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|sl11_reset
parameter_list|(
name|struct
name|slhci_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|sl11_speed
parameter_list|(
name|struct
name|slhci_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|slhci_open
parameter_list|(
name|usbd_pipe_handle
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|slhci_softintr
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|slhci_poll
parameter_list|(
name|struct
name|usbd_bus
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|slhci_poll_hub
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|slhci_poll_device
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|slhci_allocm
parameter_list|(
name|struct
name|usbd_bus
modifier|*
parameter_list|,
name|usb_dma_t
modifier|*
parameter_list|,
name|u_int32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|slhci_freem
parameter_list|(
name|struct
name|usbd_bus
modifier|*
parameter_list|,
name|usb_dma_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_xfer_handle
name|slhci_allocx
parameter_list|(
name|struct
name|usbd_bus
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|slhci_freex
parameter_list|(
name|struct
name|usbd_bus
modifier|*
parameter_list|,
name|usbd_xfer_handle
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|slhci_str
parameter_list|(
name|usb_string_descriptor_t
modifier|*
parameter_list|,
name|int
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|slhci_root_ctrl_transfer
parameter_list|(
name|usbd_xfer_handle
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|slhci_root_ctrl_start
parameter_list|(
name|usbd_xfer_handle
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|slhci_root_ctrl_abort
parameter_list|(
name|usbd_xfer_handle
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|slhci_root_ctrl_close
parameter_list|(
name|usbd_pipe_handle
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|slhci_root_ctrl_done
parameter_list|(
name|usbd_xfer_handle
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|slhci_root_intr_transfer
parameter_list|(
name|usbd_xfer_handle
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|slhci_root_intr_start
parameter_list|(
name|usbd_xfer_handle
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|slhci_root_intr_abort
parameter_list|(
name|usbd_xfer_handle
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|slhci_root_intr_close
parameter_list|(
name|usbd_pipe_handle
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|slhci_root_intr_done
parameter_list|(
name|usbd_xfer_handle
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|slhci_device_ctrl_transfer
parameter_list|(
name|usbd_xfer_handle
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|slhci_device_ctrl_start
parameter_list|(
name|usbd_xfer_handle
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|slhci_device_ctrl_abort
parameter_list|(
name|usbd_xfer_handle
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|slhci_device_ctrl_close
parameter_list|(
name|usbd_pipe_handle
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|slhci_device_ctrl_done
parameter_list|(
name|usbd_xfer_handle
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|slhci_device_intr_transfer
parameter_list|(
name|usbd_xfer_handle
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|slhci_device_intr_start
parameter_list|(
name|usbd_xfer_handle
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|slhci_device_intr_abort
parameter_list|(
name|usbd_xfer_handle
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|slhci_device_intr_close
parameter_list|(
name|usbd_pipe_handle
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|slhci_device_intr_done
parameter_list|(
name|usbd_xfer_handle
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|slhci_device_isoc_transfer
parameter_list|(
name|usbd_xfer_handle
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|slhci_device_isoc_start
parameter_list|(
name|usbd_xfer_handle
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|slhci_device_isoc_abort
parameter_list|(
name|usbd_xfer_handle
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|slhci_device_isoc_close
parameter_list|(
name|usbd_pipe_handle
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|slhci_device_isoc_done
parameter_list|(
name|usbd_xfer_handle
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|slhci_device_bulk_transfer
parameter_list|(
name|usbd_xfer_handle
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|slhci_device_bulk_start
parameter_list|(
name|usbd_xfer_handle
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|slhci_device_bulk_abort
parameter_list|(
name|usbd_xfer_handle
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|slhci_device_bulk_close
parameter_list|(
name|usbd_pipe_handle
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|slhci_device_bulk_done
parameter_list|(
name|usbd_xfer_handle
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|slhci_transaction
parameter_list|(
name|struct
name|slhci_softc
modifier|*
parameter_list|,
name|usbd_pipe_handle
parameter_list|,
name|u_int8_t
parameter_list|,
name|int
parameter_list|,
name|u_char
modifier|*
parameter_list|,
name|u_int8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|slhci_noop
parameter_list|(
name|usbd_pipe_handle
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|slhci_abort_xfer
parameter_list|(
name|usbd_xfer_handle
parameter_list|,
name|usbd_status
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|slhci_device_clear_toggle
parameter_list|(
name|usbd_pipe_handle
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|extern
name|int
name|usbdebug
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* For root hub */
end_comment

begin_define
define|#
directive|define
name|SLHCI_INTR_ENDPT
value|(1)
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|SLHCI_DEBUG
end_ifdef

begin_define
define|#
directive|define
name|D_TRACE
value|(0x0001)
end_define

begin_comment
comment|/* function trace */
end_comment

begin_define
define|#
directive|define
name|D_MSG
value|(0x0002)
end_define

begin_comment
comment|/* debug messages */
end_comment

begin_define
define|#
directive|define
name|D_XFER
value|(0x0004)
end_define

begin_comment
comment|/* transfer messages (noisy!) */
end_comment

begin_define
define|#
directive|define
name|D_MEM
value|(0x0008)
end_define

begin_comment
comment|/* memory allocation */
end_comment

begin_decl_stmt
name|int
name|slhci_debug
init|=
name|D_MSG
operator||
name|D_XFER
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|DPRINTF
parameter_list|(
name|z
parameter_list|,
name|x
parameter_list|)
value|if((slhci_debug&(z))!=0)printf x
end_define

begin_function_decl
name|void
name|print_req
parameter_list|(
name|usb_device_request_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|print_req_hub
parameter_list|(
name|usb_device_request_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|print_dumpreg
parameter_list|(
name|struct
name|slhci_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|print_xfer
parameter_list|(
name|usbd_xfer_handle
parameter_list|)
function_decl|;
end_function_decl

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|DPRINTF
parameter_list|(
name|z
parameter_list|,
name|x
parameter_list|)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* XXX: sync with argument */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|sltypestr
index|[]
init|=
block|{
literal|"SL11H/T"
block|,
literal|"SL811HS/T"
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|usbd_bus_methods
name|slhci_bus_methods
init|=
block|{
name|slhci_open
block|,
name|slhci_softintr
block|,
name|slhci_poll
block|,
name|slhci_allocm
block|,
name|slhci_freem
block|,
name|slhci_allocx
block|,
name|slhci_freex
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|usbd_pipe_methods
name|slhci_root_ctrl_methods
init|=
block|{
name|slhci_root_ctrl_transfer
block|,
name|slhci_root_ctrl_start
block|,
name|slhci_root_ctrl_abort
block|,
name|slhci_root_ctrl_close
block|,
name|slhci_noop
block|,
name|slhci_root_ctrl_done
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|usbd_pipe_methods
name|slhci_root_intr_methods
init|=
block|{
name|slhci_root_intr_transfer
block|,
name|slhci_root_intr_start
block|,
name|slhci_root_intr_abort
block|,
name|slhci_root_intr_close
block|,
name|slhci_noop
block|,
name|slhci_root_intr_done
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|usbd_pipe_methods
name|slhci_device_ctrl_methods
init|=
block|{
name|slhci_device_ctrl_transfer
block|,
name|slhci_device_ctrl_start
block|,
name|slhci_device_ctrl_abort
block|,
name|slhci_device_ctrl_close
block|,
name|slhci_noop
block|,
name|slhci_device_ctrl_done
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|usbd_pipe_methods
name|slhci_device_intr_methods
init|=
block|{
name|slhci_device_intr_transfer
block|,
name|slhci_device_intr_start
block|,
name|slhci_device_intr_abort
block|,
name|slhci_device_intr_close
block|,
name|slhci_device_clear_toggle
block|,
name|slhci_device_intr_done
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|usbd_pipe_methods
name|slhci_device_isoc_methods
init|=
block|{
name|slhci_device_isoc_transfer
block|,
name|slhci_device_isoc_start
block|,
name|slhci_device_isoc_abort
block|,
name|slhci_device_isoc_close
block|,
name|slhci_noop
block|,
name|slhci_device_isoc_done
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|usbd_pipe_methods
name|slhci_device_bulk_methods
init|=
block|{
name|slhci_device_bulk_transfer
block|,
name|slhci_device_bulk_start
block|,
name|slhci_device_bulk_abort
block|,
name|slhci_device_bulk_close
block|,
name|slhci_noop
block|,
name|slhci_device_bulk_done
block|, }
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|slhci_pipe
block|{
name|struct
name|usbd_pipe
name|pipe
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/*  * SL811HS Register read/write routine  */
end_comment

begin_function
specifier|static
specifier|inline
name|u_int8_t
name|sl11read
parameter_list|(
name|struct
name|slhci_softc
modifier|*
name|sc
parameter_list|,
name|int
name|reg
parameter_list|)
block|{
if|#
directive|if
literal|1
name|int
name|b
decl_stmt|;
name|DELAY
argument_list|(
literal|80
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|sc_iot
argument_list|,
name|sc
operator|->
name|sc_ioh
argument_list|,
name|SL11_IDX_ADDR
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|b
operator|=
name|bus_space_read_1
argument_list|(
name|sc
operator|->
name|sc_iot
argument_list|,
name|sc
operator|->
name|sc_ioh
argument_list|,
name|SL11_IDX_DATA
argument_list|)
expr_stmt|;
return|return
name|b
return|;
else|#
directive|else
name|outb
argument_list|(
literal|0x4000
argument_list|,
name|reg
operator|&
literal|0xff
argument_list|)
expr_stmt|;
return|return
operator|(
name|inb
argument_list|(
literal|0x4001
argument_list|)
operator|&
literal|0xff
operator|)
return|;
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|sl11write
parameter_list|(
name|struct
name|slhci_softc
modifier|*
name|sc
parameter_list|,
name|int
name|reg
parameter_list|,
name|u_int8_t
name|data
parameter_list|)
block|{
if|#
directive|if
literal|1
name|DELAY
argument_list|(
literal|80
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|sc_iot
argument_list|,
name|sc
operator|->
name|sc_ioh
argument_list|,
name|SL11_IDX_ADDR
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|sc_iot
argument_list|,
name|sc
operator|->
name|sc_ioh
argument_list|,
name|SL11_IDX_DATA
argument_list|,
name|data
argument_list|)
expr_stmt|;
else|#
directive|else
name|outb
argument_list|(
literal|0x4000
argument_list|,
name|reg
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|outb
argument_list|(
literal|0x4000
argument_list|,
name|data
operator|&
literal|0xff
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|sl11read_region
parameter_list|(
name|struct
name|slhci_softc
modifier|*
name|sc
parameter_list|,
name|u_char
modifier|*
name|buf
parameter_list|,
name|int
name|reg
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|sc_iot
argument_list|,
name|sc
operator|->
name|sc_ioh
argument_list|,
name|SL11_IDX_ADDR
argument_list|,
name|reg
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
name|buf
index|[
name|i
index|]
operator|=
name|bus_space_read_1
argument_list|(
name|sc
operator|->
name|sc_iot
argument_list|,
name|sc
operator|->
name|sc_ioh
argument_list|,
name|SL11_IDX_DATA
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|sl11write_region
parameter_list|(
name|struct
name|slhci_softc
modifier|*
name|sc
parameter_list|,
name|int
name|reg
parameter_list|,
name|u_char
modifier|*
name|buf
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|sc_iot
argument_list|,
name|sc
operator|->
name|sc_ioh
argument_list|,
name|SL11_IDX_ADDR
argument_list|,
name|reg
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|sc_iot
argument_list|,
name|sc
operator|->
name|sc_ioh
argument_list|,
name|SL11_IDX_DATA
argument_list|,
name|buf
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * USB bus reset. From sl811hs_appnote.pdf, p22  */
end_comment

begin_function
specifier|static
name|void
name|sl11_reset
parameter_list|(
name|struct
name|slhci_softc
modifier|*
name|sc
parameter_list|)
block|{
name|u_int8_t
name|r
decl_stmt|;
name|DPRINTF
argument_list|(
name|D_TRACE
argument_list|,
operator|(
literal|"%s() "
operator|,
name|__FUNCTION__
operator|)
argument_list|)
expr_stmt|;
comment|//	r = sl11read(sc, SL11_CTRL);
name|r
operator|=
literal|0
expr_stmt|;
name|sl11write
argument_list|(
name|sc
argument_list|,
name|SL11_CTRL
argument_list|,
name|r
operator||
name|SL11_CTRL_RESETENGINE
argument_list|)
expr_stmt|;
name|delay_ms
argument_list|(
literal|250
argument_list|)
expr_stmt|;
name|sl11write
argument_list|(
name|sc
argument_list|,
name|SL11_CTRL
argument_list|,
name|r
operator||
name|SL11_CTRL_JKSTATE
operator||
name|SL11_CTRL_RESETENGINE
argument_list|)
expr_stmt|;
name|delay_ms
argument_list|(
literal|150
argument_list|)
expr_stmt|;
name|sl11write
argument_list|(
name|sc
argument_list|,
name|SL11_CTRL
argument_list|,
name|r
operator||
name|SL11_CTRL_RESETENGINE
argument_list|)
expr_stmt|;
name|delay_ms
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|sl11write
argument_list|(
name|sc
argument_list|,
name|SL11_CTRL
argument_list|,
name|r
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Detect the speed of attached device.  */
end_comment

begin_function
specifier|static
name|void
name|sl11_speed
parameter_list|(
name|struct
name|slhci_softc
modifier|*
name|sc
parameter_list|)
block|{
name|u_int8_t
name|r
decl_stmt|;
name|sl11write
argument_list|(
name|sc
argument_list|,
name|SL11_ISR
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
name|r
operator|=
name|sl11read
argument_list|(
name|sc
argument_list|,
name|SL11_ISR
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|r
operator|&
name|SL11_ISR_RESET
operator|)
condition|)
block|{
name|DPRINTF
argument_list|(
name|D_MSG
argument_list|,
operator|(
literal|"NC "
operator|)
argument_list|)
expr_stmt|;
name|sl11write
argument_list|(
name|sc
argument_list|,
name|SL11_ISR
argument_list|,
name|SL11_ISR_RESET
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_connect
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|sl11read
argument_list|(
name|sc
argument_list|,
name|SL11_ISR
argument_list|)
operator|&
name|SL11_ISR_RESET
operator|)
condition|)
block|{
name|sl11write
argument_list|(
name|sc
argument_list|,
name|SL11_ISR
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|u_int8_t
name|pol
init|=
literal|0
decl_stmt|,
name|ctrl
init|=
literal|0
decl_stmt|;
name|sc
operator|->
name|sc_connect
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|r
operator|&
name|SL11_ISR_DATA
condition|)
block|{
name|DPRINTF
argument_list|(
name|D_MSG
argument_list|,
operator|(
literal|"FS "
operator|)
argument_list|)
expr_stmt|;
name|pol
operator|=
literal|0
expr_stmt|;
name|ctrl
operator|=
name|SL11_CTRL_EOF2
expr_stmt|;
name|sc
operator|->
name|sc_fullspeed
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|DPRINTF
argument_list|(
name|D_MSG
argument_list|,
operator|(
literal|"LS "
operator|)
argument_list|)
expr_stmt|;
name|pol
operator|=
name|SL811_CSOF_POLARITY
expr_stmt|;
name|ctrl
operator|=
name|SL11_CTRL_LOWSPEED
expr_stmt|;
name|sc
operator|->
name|sc_fullspeed
operator|=
literal|0
expr_stmt|;
block|}
name|sl11write
argument_list|(
name|sc
argument_list|,
name|SL811_CSOF
argument_list|,
name|pol
operator||
name|SL811_CSOF_MASTER
operator||
literal|0x2e
argument_list|)
expr_stmt|;
name|sl11write
argument_list|(
name|sc
argument_list|,
name|SL11_DATA
argument_list|,
literal|0xe0
argument_list|)
expr_stmt|;
name|sl11write
argument_list|(
name|sc
argument_list|,
name|SL11_CTRL
argument_list|,
name|ctrl
operator||
name|SL11_CTRL_ENABLESOF
argument_list|)
expr_stmt|;
block|}
name|sl11write
argument_list|(
name|sc
argument_list|,
name|SL11_E0PID
argument_list|,
operator|(
name|SL11_PID_SOF
operator|<<
literal|4
operator|)
operator|+
literal|0
argument_list|)
expr_stmt|;
name|sl11write
argument_list|(
name|sc
argument_list|,
name|SL11_E0DEV
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sl11write
argument_list|(
name|sc
argument_list|,
name|SL11_E0CTRL
argument_list|,
name|SL11_EPCTRL_ARM
argument_list|)
expr_stmt|;
name|delay_ms
argument_list|(
literal|30
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * If detect some known controller, return the type.  * If does not, return -1.  */
end_comment

begin_function
name|int
name|sl811hs_find
parameter_list|(
name|struct
name|slhci_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|rev
decl_stmt|;
name|sc
operator|->
name|sc_sltype
operator|=
operator|-
literal|1
expr_stmt|;
name|rev
operator|=
name|sl11read
argument_list|(
name|sc
argument_list|,
name|SL11_REV
argument_list|)
operator|>>
literal|4
expr_stmt|;
if|if
condition|(
name|rev
operator|>=
name|SLTYPE_SL11H
operator|&&
name|rev
operator|<=
name|SLTYPE_SL811HS_R14
condition|)
name|sc
operator|->
name|sc_sltype
operator|=
name|rev
expr_stmt|;
return|return
name|sc
operator|->
name|sc_sltype
return|;
block|}
end_function

begin_comment
comment|/*  * Attach SL11H/SL811HS. Return 0 if success.  */
end_comment

begin_function
name|int
name|slhci_attach
parameter_list|(
name|struct
name|slhci_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|rev
decl_stmt|;
comment|/* Detect and check the controller type */
name|rev
operator|=
name|sl811hs_find
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|rev
operator|==
operator|-
literal|1
condition|)
return|return
operator|-
literal|1
return|;
name|printf
argument_list|(
literal|"%s: ScanLogic %s USB Host Controller"
argument_list|,
name|device_get_nameunit
argument_list|(
name|sc
operator|->
name|sc_bus
operator|.
name|bdev
argument_list|)
argument_list|,
name|sltypestr
index|[
operator|(
name|rev
operator|>
literal|0
operator|)
index|]
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|rev
condition|)
block|{
case|case
name|SLTYPE_SL11H
case|:
break|break;
case|case
name|SLTYPE_SL811HS_R12
case|:
name|printf
argument_list|(
literal|" (rev 1.2)"
argument_list|)
expr_stmt|;
break|break;
case|case
name|SLTYPE_SL811HS_R14
case|:
name|printf
argument_list|(
literal|" (rev 1.4)"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|" (unknown revision)"
argument_list|)
expr_stmt|;
break|break;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
comment|/* Initialize sc */
name|sc
operator|->
name|sc_bus
operator|.
name|usbrev
operator|=
name|USBREV_1_1
expr_stmt|;
name|sc
operator|->
name|sc_bus
operator|.
name|methods
operator|=
operator|&
name|slhci_bus_methods
expr_stmt|;
name|sc
operator|->
name|sc_bus
operator|.
name|pipe_size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|slhci_pipe
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_bus
operator|.
name|parent_dmatag
operator|=
name|NULL
expr_stmt|;
comment|/* XXX */
name|sc
operator|->
name|sc_bus
operator|.
name|buffer_dmatag
operator|=
name|NULL
expr_stmt|;
comment|/* XXX */
name|STAILQ_INIT
argument_list|(
operator|&
name|sc
operator|->
name|sc_free_xfers
argument_list|)
expr_stmt|;
name|usb_callout_init
argument_list|(
name|sc
operator|->
name|sc_poll_handle
argument_list|)
expr_stmt|;
comment|/* Disable interrupt, then wait 40msec */
name|sl11write
argument_list|(
name|sc
argument_list|,
name|SL11_IER
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|delay_ms
argument_list|(
literal|40
argument_list|)
expr_stmt|;
comment|/* Initialize controller */
name|sl11write
argument_list|(
name|sc
argument_list|,
name|SL811_CSOF
argument_list|,
name|SL811_CSOF_MASTER
operator||
literal|0x2e
argument_list|)
expr_stmt|;
name|delay_ms
argument_list|(
literal|40
argument_list|)
expr_stmt|;
name|sl11write
argument_list|(
name|sc
argument_list|,
name|SL11_ISR
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
comment|/* Disable interrupt, then wait 40msec */
name|sl11write
argument_list|(
name|sc
argument_list|,
name|SL11_IER
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
comment|/* Reset USB engine */
name|sl11write
argument_list|(
name|sc
argument_list|,
name|SL11_CTRL
argument_list|,
name|SL11_CTRL_JKSTATE
operator||
name|SL11_CTRL_RESETENGINE
argument_list|)
expr_stmt|;
name|delay_ms
argument_list|(
literal|40
argument_list|)
expr_stmt|;
name|sl11write
argument_list|(
name|sc
argument_list|,
name|SL11_CTRL
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|delay_ms
argument_list|(
literal|10
argument_list|)
expr_stmt|;
comment|/* USB Bus reset for GET_PORT_STATUS */
name|sl11_reset
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_flags
operator|=
name|SLF_ATTACHED
expr_stmt|;
comment|/* Enable interrupt */
name|sl11write
argument_list|(
name|sc
argument_list|,
name|SL11_IER
argument_list|,
name|SL11_IER_INSERT
argument_list|)
expr_stmt|;
comment|/* x68k Nereid USB controller needs it */
if|if
condition|(
name|sc
operator|->
name|sc_enable_intr
condition|)
name|sc
operator|->
name|sc_enable_intr
argument_list|(
name|sc
operator|->
name|sc_arg
argument_list|,
name|INTR_ON
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|USB_DEBUG
name|usbdebug
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|slhci_intr
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|slhci_softc
modifier|*
name|sc
init|=
name|arg
decl_stmt|;
name|u_int8_t
name|r
decl_stmt|;
ifdef|#
directive|ifdef
name|SLHCI_DEBUG
name|char
name|bitbuf
index|[
literal|256
index|]
decl_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|SLF_ATTACHED
operator|)
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|r
operator|=
name|sl11read
argument_list|(
name|sc
argument_list|,
name|SL11_ISR
argument_list|)
expr_stmt|;
name|sl11write
argument_list|(
name|sc
argument_list|,
name|SL11_ISR
argument_list|,
name|SL11_ISR_DATA
operator||
name|SL11_ISR_SOFTIMER
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|r
operator|&
name|SL11_ISR_RESET
operator|)
condition|)
block|{
name|sc
operator|->
name|sc_flags
operator||=
name|SLF_RESET
expr_stmt|;
name|sl11write
argument_list|(
name|sc
argument_list|,
name|SL11_ISR
argument_list|,
name|SL11_ISR_RESET
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|r
operator|&
name|SL11_ISR_INSERT
operator|)
condition|)
block|{
name|sc
operator|->
name|sc_flags
operator||=
name|SLF_INSERT
expr_stmt|;
name|sl11write
argument_list|(
name|sc
argument_list|,
name|SL11_ISR
argument_list|,
name|SL11_ISR_INSERT
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|SLHCI_DEBUG
name|bitmask_snprintf
argument_list|(
name|r
argument_list|,
operator|(
name|sl11read
argument_list|(
name|sc
argument_list|,
name|SL11_CTRL
argument_list|)
operator|&
name|SL11_CTRL_SUSPEND
operator|)
condition|?
literal|"\20\x8"
literal|"D+\7RESUME\6INSERT\5SOF\4res\3"
literal|"BABBLE\2USBB\1USBA"
else|:
literal|"\20\x8"
literal|"D+\7RESET\6INSERT\5SOF\4res\3"
literal|"BABBLE\2USBB\1USBA"
argument_list|,
name|bitbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|bitbuf
argument_list|)
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
name|D_XFER
argument_list|,
operator|(
literal|"I=%s "
operator|,
name|bitbuf
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* SLHCI_DEBUG */
return|return
literal|0
return|;
block|}
end_function

begin_function
name|usbd_status
name|slhci_open
parameter_list|(
name|usbd_pipe_handle
name|pipe
parameter_list|)
block|{
name|usbd_device_handle
name|dev
init|=
name|pipe
operator|->
name|device
decl_stmt|;
name|struct
name|slhci_softc
modifier|*
name|sc
init|=
operator|(
expr|struct
name|slhci_softc
operator|*
operator|)
name|dev
operator|->
name|bus
decl_stmt|;
name|usb_endpoint_descriptor_t
modifier|*
name|ed
init|=
name|pipe
operator|->
name|endpoint
operator|->
name|edesc
decl_stmt|;
name|DPRINTF
argument_list|(
name|D_TRACE
argument_list|,
operator|(
literal|"slhci_open(addr=%d,ep=%d,scaddr=%d)"
operator|,
name|dev
operator|->
name|address
operator|,
name|ed
operator|->
name|bEndpointAddress
operator|,
name|sc
operator|->
name|sc_addr
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev
operator|->
name|address
operator|==
name|sc
operator|->
name|sc_addr
condition|)
block|{
switch|switch
condition|(
name|ed
operator|->
name|bEndpointAddress
condition|)
block|{
case|case
name|USB_CONTROL_ENDPOINT
case|:
name|pipe
operator|->
name|methods
operator|=
operator|&
name|slhci_root_ctrl_methods
expr_stmt|;
break|break;
case|case
name|UE_DIR_IN
operator||
name|SLHCI_INTR_ENDPT
case|:
name|pipe
operator|->
name|methods
operator|=
operator|&
name|slhci_root_intr_methods
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"open:endpointErr!\n"
argument_list|)
expr_stmt|;
return|return
name|USBD_INVAL
return|;
block|}
block|}
else|else
block|{
switch|switch
condition|(
name|ed
operator|->
name|bmAttributes
operator|&
name|UE_XFERTYPE
condition|)
block|{
case|case
name|UE_CONTROL
case|:
name|DPRINTF
argument_list|(
name|D_MSG
argument_list|,
operator|(
literal|"control "
operator|)
argument_list|)
expr_stmt|;
name|pipe
operator|->
name|methods
operator|=
operator|&
name|slhci_device_ctrl_methods
expr_stmt|;
break|break;
case|case
name|UE_INTERRUPT
case|:
name|DPRINTF
argument_list|(
name|D_MSG
argument_list|,
operator|(
literal|"interrupt "
operator|)
argument_list|)
expr_stmt|;
name|pipe
operator|->
name|methods
operator|=
operator|&
name|slhci_device_intr_methods
expr_stmt|;
break|break;
case|case
name|UE_ISOCHRONOUS
case|:
name|DPRINTF
argument_list|(
name|D_MSG
argument_list|,
operator|(
literal|"isochronous "
operator|)
argument_list|)
expr_stmt|;
name|pipe
operator|->
name|methods
operator|=
operator|&
name|slhci_device_isoc_methods
expr_stmt|;
break|break;
case|case
name|UE_BULK
case|:
name|DPRINTF
argument_list|(
name|D_MSG
argument_list|,
operator|(
literal|"bluk "
operator|)
argument_list|)
expr_stmt|;
name|pipe
operator|->
name|methods
operator|=
operator|&
name|slhci_device_bulk_methods
expr_stmt|;
break|break;
block|}
block|}
return|return
name|USBD_NORMAL_COMPLETION
return|;
block|}
end_function

begin_function
name|void
name|slhci_softintr
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|DPRINTF
argument_list|(
name|D_TRACE
argument_list|,
operator|(
literal|"%s()"
operator|,
name|__FUNCTION__
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|slhci_poll
parameter_list|(
name|struct
name|usbd_bus
modifier|*
name|bus
parameter_list|)
block|{
name|DPRINTF
argument_list|(
name|D_TRACE
argument_list|,
operator|(
literal|"%s()"
operator|,
name|__FUNCTION__
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Emulation of interrupt transfer for status change endpoint  * of root hub.  */
end_comment

begin_function
name|void
name|slhci_poll_hub
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|usbd_xfer_handle
name|xfer
init|=
name|arg
decl_stmt|;
name|usbd_pipe_handle
name|pipe
init|=
name|xfer
operator|->
name|pipe
decl_stmt|;
name|struct
name|slhci_softc
modifier|*
name|sc
init|=
operator|(
expr|struct
name|slhci_softc
operator|*
operator|)
name|pipe
operator|->
name|device
operator|->
name|bus
decl_stmt|;
name|int
name|s
decl_stmt|;
name|u_char
modifier|*
name|p
decl_stmt|;
name|usb_callout
argument_list|(
name|sc
operator|->
name|sc_poll_handle
argument_list|,
name|sc
operator|->
name|sc_interval
argument_list|,
name|slhci_poll_hub
argument_list|,
name|xfer
argument_list|)
expr_stmt|;
comment|/* USB spec 11.13.3 (p.260) */
name|p
operator|=
name|xfer
operator|->
name|buffer
expr_stmt|;
name|p
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_flags
operator|&
operator|(
name|SLF_INSERT
operator||
name|SLF_RESET
operator|)
operator|)
condition|)
block|{
name|p
index|[
literal|0
index|]
operator|=
literal|2
expr_stmt|;
name|DPRINTF
argument_list|(
name|D_TRACE
argument_list|,
operator|(
literal|"!"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* no change, return NAK */
if|if
condition|(
name|p
index|[
literal|0
index|]
operator|==
literal|0
condition|)
return|return;
name|xfer
operator|->
name|actlen
operator|=
literal|1
expr_stmt|;
name|xfer
operator|->
name|status
operator|=
name|USBD_NORMAL_COMPLETION
expr_stmt|;
name|s
operator|=
name|splusb
argument_list|()
expr_stmt|;
name|xfer
operator|->
name|device
operator|->
name|bus
operator|->
name|intr_context
operator|++
expr_stmt|;
name|usb_transfer_complete
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
name|xfer
operator|->
name|device
operator|->
name|bus
operator|->
name|intr_context
operator|--
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|usbd_status
name|slhci_allocm
parameter_list|(
name|struct
name|usbd_bus
modifier|*
name|bus
parameter_list|,
name|usb_dma_t
modifier|*
name|dma
parameter_list|,
name|u_int32_t
name|size
parameter_list|)
block|{
name|struct
name|slhci_softc
modifier|*
name|sc
init|=
operator|(
expr|struct
name|slhci_softc
operator|*
operator|)
name|bus
decl_stmt|;
name|DPRINTF
argument_list|(
name|D_MEM
argument_list|,
operator|(
literal|"SLallocm"
operator|)
argument_list|)
expr_stmt|;
return|return
name|usb_allocmem
argument_list|(
operator|&
name|sc
operator|->
name|sc_bus
argument_list|,
name|size
argument_list|,
literal|0
argument_list|,
name|dma
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|slhci_freem
parameter_list|(
name|struct
name|usbd_bus
modifier|*
name|bus
parameter_list|,
name|usb_dma_t
modifier|*
name|dma
parameter_list|)
block|{
name|struct
name|slhci_softc
modifier|*
name|sc
init|=
operator|(
expr|struct
name|slhci_softc
operator|*
operator|)
name|bus
decl_stmt|;
name|DPRINTF
argument_list|(
name|D_MEM
argument_list|,
operator|(
literal|"SLfreem"
operator|)
argument_list|)
expr_stmt|;
name|usb_freemem
argument_list|(
operator|&
name|sc
operator|->
name|sc_bus
argument_list|,
name|dma
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|usbd_xfer_handle
name|slhci_allocx
parameter_list|(
name|struct
name|usbd_bus
modifier|*
name|bus
parameter_list|)
block|{
name|struct
name|slhci_softc
modifier|*
name|sc
init|=
operator|(
expr|struct
name|slhci_softc
operator|*
operator|)
name|bus
decl_stmt|;
name|usbd_xfer_handle
name|xfer
decl_stmt|;
name|DPRINTF
argument_list|(
name|D_MEM
argument_list|,
operator|(
literal|"SLallocx"
operator|)
argument_list|)
expr_stmt|;
name|xfer
operator|=
name|STAILQ_FIRST
argument_list|(
operator|&
name|sc
operator|->
name|sc_free_xfers
argument_list|)
expr_stmt|;
if|if
condition|(
name|xfer
condition|)
block|{
name|STAILQ_REMOVE_HEAD
argument_list|(
operator|&
name|sc
operator|->
name|sc_free_xfers
argument_list|,
name|next
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DIAGNOSTIC
if|if
condition|(
name|xfer
operator|->
name|busy_free
operator|!=
name|XFER_FREE
condition|)
block|{
name|printf
argument_list|(
literal|"slhci_allocx: xfer=%p not free, 0x%08x\n"
argument_list|,
name|xfer
argument_list|,
name|xfer
operator|->
name|busy_free
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
block|}
else|else
block|{
name|xfer
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|xfer
argument_list|)
argument_list|,
name|M_USB
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|xfer
condition|)
block|{
name|memset
argument_list|(
name|xfer
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|xfer
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DIAGNOSTIC
name|xfer
operator|->
name|busy_free
operator|=
name|XFER_BUSY
expr_stmt|;
endif|#
directive|endif
block|}
return|return
name|xfer
return|;
block|}
end_function

begin_function
name|void
name|slhci_freex
parameter_list|(
name|struct
name|usbd_bus
modifier|*
name|bus
parameter_list|,
name|usbd_xfer_handle
name|xfer
parameter_list|)
block|{
name|struct
name|slhci_softc
modifier|*
name|sc
init|=
operator|(
expr|struct
name|slhci_softc
operator|*
operator|)
name|bus
decl_stmt|;
name|DPRINTF
argument_list|(
name|D_MEM
argument_list|,
operator|(
literal|"SLfreex"
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DIAGNOSTIC
if|if
condition|(
name|xfer
operator|->
name|busy_free
operator|!=
name|XFER_BUSY
condition|)
block|{
name|printf
argument_list|(
literal|"slhci_freex: xfer=%p not busy, 0x%08x\n"
argument_list|,
name|xfer
argument_list|,
name|xfer
operator|->
name|busy_free
argument_list|)
expr_stmt|;
return|return;
block|}
name|xfer
operator|->
name|busy_free
operator|=
name|XFER_FREE
expr_stmt|;
endif|#
directive|endif
name|STAILQ_INSERT_HEAD
argument_list|(
operator|&
name|sc
operator|->
name|sc_free_xfers
argument_list|,
name|xfer
argument_list|,
name|next
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|slhci_noop
parameter_list|(
name|usbd_pipe_handle
name|pipe
parameter_list|)
block|{
name|DPRINTF
argument_list|(
name|D_TRACE
argument_list|,
operator|(
literal|"%s()"
operator|,
name|__FUNCTION__
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Data structures and routines to emulate the root hub.  */
end_comment

begin_decl_stmt
name|usb_device_descriptor_t
name|slhci_devd
init|=
block|{
name|USB_DEVICE_DESCRIPTOR_SIZE
block|,
name|UDESC_DEVICE
block|,
comment|/* type */
block|{
literal|0x01
block|,
literal|0x01
block|}
block|,
comment|/* USB version */
name|UDCLASS_HUB
block|,
comment|/* class */
name|UDSUBCLASS_HUB
block|,
comment|/* subclass */
literal|0
block|,
comment|/* protocol */
literal|64
block|,
comment|/* max packet */
block|{
name|USB_VENDOR_SCANLOGIC
operator|&
literal|0xff
block|,
comment|/* vendor ID (low)  */
name|USB_VENDOR_SCANLOGIC
operator|>>
literal|8
block|}
block|,
comment|/* vendor ID (high) */
block|{
literal|0
block|}
comment|/* ? */
block|,
comment|/* product ID */
block|{
literal|0
block|}
block|,
comment|/* device */
literal|1
block|,
comment|/* index to manufacturer */
literal|2
block|,
comment|/* index to product */
literal|0
block|,
comment|/* index to serial number */
literal|1
comment|/* number of configurations */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|usb_config_descriptor_t
name|slhci_confd
init|=
block|{
name|USB_CONFIG_DESCRIPTOR_SIZE
block|,
name|UDESC_CONFIG
block|,
block|{
name|USB_CONFIG_DESCRIPTOR_SIZE
operator|+
name|USB_INTERFACE_DESCRIPTOR_SIZE
operator|+
name|USB_ENDPOINT_DESCRIPTOR_SIZE
block|}
block|,
literal|1
block|,
comment|/* number of interfaces */
literal|1
block|,
comment|/* configuration value */
literal|0
block|,
comment|/* index to configuration */
name|UC_SELF_POWERED
block|,
comment|/* attributes */
literal|15
comment|/* max current is 30mA... */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|usb_interface_descriptor_t
name|slhci_ifcd
init|=
block|{
name|USB_INTERFACE_DESCRIPTOR_SIZE
block|,
name|UDESC_INTERFACE
block|,
literal|0
block|,
comment|/* interface number */
literal|0
block|,
comment|/* alternate setting */
literal|1
block|,
comment|/* number of endpoint */
name|UICLASS_HUB
block|,
comment|/* class */
name|UISUBCLASS_HUB
block|,
comment|/* subclass */
literal|0
block|,
comment|/* protocol */
literal|0
comment|/* index to interface */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|usb_endpoint_descriptor_t
name|slhci_endpd
init|=
block|{
name|USB_ENDPOINT_DESCRIPTOR_SIZE
block|,
name|UDESC_ENDPOINT
block|,
name|UE_DIR_IN
operator||
name|SLHCI_INTR_ENDPT
block|,
comment|/* endpoint address */
name|UE_INTERRUPT
block|,
comment|/* attributes */
block|{
literal|8
block|}
block|,
comment|/* max packet size */
literal|255
comment|/* interval */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|usb_hub_descriptor_t
name|slhci_hubd
init|=
block|{
name|USB_HUB_DESCRIPTOR_SIZE
block|,
name|UDESC_HUB
block|,
literal|1
block|,
comment|/* number of ports */
block|{
name|UHD_PWR_INDIVIDUAL
operator||
name|UHD_OC_NONE
block|,
literal|0
block|}
block|,
comment|/* hub characteristics */
literal|20
comment|/* ? */
block|,
comment|/* 5:power on to power good */
literal|50
block|,
comment|/* 6:maximum current */
block|{
literal|0x00
block|}
block|,
comment|/* both ports are removable */
block|{
literal|0x00
block|}
comment|/* port power control mask */
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|slhci_str
parameter_list|(
name|usb_string_descriptor_t
modifier|*
name|p
parameter_list|,
name|int
name|l
parameter_list|,
specifier|const
name|char
modifier|*
name|s
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|l
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|p
operator|->
name|bLength
operator|=
literal|2
operator|*
name|strlen
argument_list|(
name|s
argument_list|)
operator|+
literal|2
expr_stmt|;
if|if
condition|(
name|l
operator|==
literal|1
condition|)
return|return
literal|1
return|;
name|p
operator|->
name|bDescriptorType
operator|=
name|UDESC_STRING
expr_stmt|;
name|l
operator|-=
literal|2
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|s
index|[
name|i
index|]
operator|&&
name|l
operator|>
literal|1
condition|;
name|i
operator|++
operator|,
name|l
operator|-=
literal|2
control|)
name|USETW2
argument_list|(
name|p
operator|->
name|bString
index|[
name|i
index|]
argument_list|,
literal|0
argument_list|,
name|s
index|[
name|i
index|]
argument_list|)
expr_stmt|;
return|return
literal|2
operator|*
name|i
operator|+
literal|2
return|;
block|}
end_function

begin_function
name|usbd_status
name|slhci_root_ctrl_transfer
parameter_list|(
name|usbd_xfer_handle
name|xfer
parameter_list|)
block|{
name|usbd_status
name|error
decl_stmt|;
name|DPRINTF
argument_list|(
name|D_TRACE
argument_list|,
operator|(
literal|"SLRCtrans "
operator|)
argument_list|)
expr_stmt|;
comment|/* Insert last in queue */
name|error
operator|=
name|usb_insert_transfer
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|DPRINTF
argument_list|(
name|D_MSG
argument_list|,
operator|(
literal|"usb_insert_transfer returns err! "
operator|)
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
comment|/* 	 * Pipe isn't running (otherwise error would be USBD_INPROG), 	 * so start it first. 	 */
return|return
name|slhci_root_ctrl_start
argument_list|(
name|STAILQ_FIRST
argument_list|(
operator|&
name|xfer
operator|->
name|pipe
operator|->
name|queue
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|slhci_root_ctrl_start
parameter_list|(
name|usbd_xfer_handle
name|xfer
parameter_list|)
block|{
name|struct
name|slhci_softc
modifier|*
name|sc
init|=
operator|(
expr|struct
name|slhci_softc
operator|*
operator|)
name|xfer
operator|->
name|pipe
operator|->
name|device
operator|->
name|bus
decl_stmt|;
name|usb_device_request_t
modifier|*
name|req
decl_stmt|;
name|int
name|len
decl_stmt|,
name|value
decl_stmt|,
name|index
decl_stmt|,
name|l
decl_stmt|,
name|s
decl_stmt|,
name|status
decl_stmt|;
name|int
name|totlen
init|=
literal|0
decl_stmt|;
name|void
modifier|*
name|buf
init|=
name|NULL
decl_stmt|;
name|usb_port_status_t
name|ps
decl_stmt|;
name|usbd_status
name|error
decl_stmt|;
name|char
name|slbuf
index|[
literal|50
index|]
decl_stmt|;
name|u_int8_t
name|r
decl_stmt|;
name|DPRINTF
argument_list|(
name|D_TRACE
argument_list|,
operator|(
literal|"SLRCstart "
operator|)
argument_list|)
expr_stmt|;
name|req
operator|=
operator|&
name|xfer
operator|->
name|request
expr_stmt|;
name|len
operator|=
name|UGETW
argument_list|(
name|req
operator|->
name|wLength
argument_list|)
expr_stmt|;
name|value
operator|=
name|UGETW
argument_list|(
name|req
operator|->
name|wValue
argument_list|)
expr_stmt|;
name|index
operator|=
name|UGETW
argument_list|(
name|req
operator|->
name|wIndex
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
condition|)
name|buf
operator|=
name|xfer
operator|->
name|buffer
expr_stmt|;
ifdef|#
directive|ifdef
name|SLHCI_DEBUG
if|if
condition|(
operator|(
name|slhci_debug
operator|&
name|D_TRACE
operator|)
condition|)
name|print_req_hub
argument_list|(
name|req
argument_list|)
expr_stmt|;
endif|#
directive|endif
define|#
directive|define
name|C
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|)
value|((x) | ((y)<< 8))
switch|switch
condition|(
name|C
argument_list|(
name|req
operator|->
name|bRequest
argument_list|,
name|req
operator|->
name|bmRequestType
argument_list|)
condition|)
block|{
case|case
name|C
argument_list|(
name|UR_CLEAR_FEATURE
argument_list|,
name|UT_WRITE_DEVICE
argument_list|)
case|:
case|case
name|C
argument_list|(
name|UR_CLEAR_FEATURE
argument_list|,
name|UT_WRITE_INTERFACE
argument_list|)
case|:
case|case
name|C
argument_list|(
name|UR_CLEAR_FEATURE
argument_list|,
name|UT_WRITE_ENDPOINT
argument_list|)
case|:
name|DPRINTF
argument_list|(
name|D_MSG
argument_list|,
operator|(
literal|"UR_CLEAR_FEATURE "
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|C
argument_list|(
name|UR_GET_CONFIG
argument_list|,
name|UT_READ_DEVICE
argument_list|)
case|:
name|DPRINTF
argument_list|(
name|D_MSG
argument_list|,
operator|(
literal|"UR_GET_CONFIG "
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
literal|0
condition|)
block|{
operator|*
operator|(
name|u_int8_t
operator|*
operator|)
name|buf
operator|=
name|sc
operator|->
name|sc_conf
expr_stmt|;
name|totlen
operator|=
literal|1
expr_stmt|;
block|}
break|break;
case|case
name|C
argument_list|(
name|UR_GET_DESCRIPTOR
argument_list|,
name|UT_READ_DEVICE
argument_list|)
case|:
switch|switch
condition|(
name|value
operator|>>
literal|8
condition|)
block|{
case|case
name|UDESC_DEVICE
case|:
name|DPRINTF
argument_list|(
name|D_MSG
argument_list|,
operator|(
literal|"UDESC_DEVICE "
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|value
operator|&
literal|0xff
operator|)
operator|!=
literal|0
condition|)
block|{
name|error
operator|=
name|USBD_IOERROR
expr_stmt|;
goto|goto
name|ret
goto|;
block|}
name|totlen
operator|=
name|l
operator|=
name|min
argument_list|(
name|len
argument_list|,
name|USB_DEVICE_DESCRIPTOR_SIZE
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|buf
argument_list|,
operator|&
name|slhci_devd
argument_list|,
name|l
argument_list|)
expr_stmt|;
break|break;
case|case
name|UDESC_CONFIG
case|:
name|DPRINTF
argument_list|(
name|D_MSG
argument_list|,
operator|(
literal|"UDESC_CONFIG "
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|value
operator|&
literal|0xff
operator|)
operator|!=
literal|0
condition|)
block|{
name|error
operator|=
name|USBD_IOERROR
expr_stmt|;
goto|goto
name|ret
goto|;
block|}
name|totlen
operator|=
name|l
operator|=
name|min
argument_list|(
name|len
argument_list|,
name|USB_CONFIG_DESCRIPTOR_SIZE
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|buf
argument_list|,
operator|&
name|slhci_confd
argument_list|,
name|l
argument_list|)
expr_stmt|;
name|buf
operator|=
operator|(
name|char
operator|*
operator|)
name|buf
operator|+
name|l
expr_stmt|;
name|len
operator|-=
name|l
expr_stmt|;
name|l
operator|=
name|min
argument_list|(
name|len
argument_list|,
name|USB_INTERFACE_DESCRIPTOR_SIZE
argument_list|)
expr_stmt|;
name|totlen
operator|+=
name|l
expr_stmt|;
name|memcpy
argument_list|(
name|buf
argument_list|,
operator|&
name|slhci_ifcd
argument_list|,
name|l
argument_list|)
expr_stmt|;
name|buf
operator|=
operator|(
name|char
operator|*
operator|)
name|buf
operator|+
name|l
expr_stmt|;
name|len
operator|-=
name|l
expr_stmt|;
name|l
operator|=
name|min
argument_list|(
name|len
argument_list|,
name|USB_ENDPOINT_DESCRIPTOR_SIZE
argument_list|)
expr_stmt|;
name|totlen
operator|+=
name|l
expr_stmt|;
name|memcpy
argument_list|(
name|buf
argument_list|,
operator|&
name|slhci_endpd
argument_list|,
name|l
argument_list|)
expr_stmt|;
break|break;
case|case
name|UDESC_STRING
case|:
name|DPRINTF
argument_list|(
name|D_MSG
argument_list|,
operator|(
literal|"UDESC_STR "
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|==
literal|0
condition|)
break|break;
operator|*
operator|(
name|u_int8_t
operator|*
operator|)
name|buf
operator|=
literal|0
expr_stmt|;
name|totlen
operator|=
literal|1
expr_stmt|;
switch|switch
condition|(
name|value
operator|&
literal|0xff
condition|)
block|{
case|case
literal|0
case|:
break|break;
case|case
literal|1
case|:
comment|/* Vendor */
name|totlen
operator|=
name|slhci_str
argument_list|(
name|buf
argument_list|,
name|len
argument_list|,
literal|"ScanLogic"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
comment|/* Product */
name|snprintf
argument_list|(
name|slbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|slbuf
argument_list|)
argument_list|,
literal|"%s root hub"
argument_list|,
name|sltypestr
index|[
name|sc
operator|->
name|sc_sltype
operator|>
literal|0
index|]
argument_list|)
expr_stmt|;
name|totlen
operator|=
name|slhci_str
argument_list|(
name|buf
argument_list|,
name|len
argument_list|,
name|slbuf
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"strerr%d "
argument_list|,
name|value
operator|&
literal|0xff
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
default|default:
name|printf
argument_list|(
literal|"unknownGetDescriptor=%x"
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|error
operator|=
name|USBD_IOERROR
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|C
argument_list|(
name|UR_GET_INTERFACE
argument_list|,
name|UT_READ_INTERFACE
argument_list|)
case|:
comment|/* Get Interface, 9.4.4 */
if|if
condition|(
name|len
operator|>
literal|0
condition|)
block|{
operator|*
operator|(
name|u_int8_t
operator|*
operator|)
name|buf
operator|=
literal|0
expr_stmt|;
name|totlen
operator|=
literal|1
expr_stmt|;
block|}
break|break;
case|case
name|C
argument_list|(
name|UR_GET_STATUS
argument_list|,
name|UT_READ_DEVICE
argument_list|)
case|:
comment|/* Get Status from device, 9.4.5 */
if|if
condition|(
name|len
operator|>
literal|1
condition|)
block|{
name|USETW
argument_list|(
operator|(
operator|(
name|usb_status_t
operator|*
operator|)
name|buf
operator|)
operator|->
name|wStatus
argument_list|,
name|UDS_SELF_POWERED
argument_list|)
expr_stmt|;
name|totlen
operator|=
literal|2
expr_stmt|;
block|}
break|break;
case|case
name|C
argument_list|(
name|UR_GET_STATUS
argument_list|,
name|UT_READ_INTERFACE
argument_list|)
case|:
case|case
name|C
argument_list|(
name|UR_GET_STATUS
argument_list|,
name|UT_READ_ENDPOINT
argument_list|)
case|:
comment|/* Get Status from interface, endpoint, 9.4.5 */
if|if
condition|(
name|len
operator|>
literal|1
condition|)
block|{
name|USETW
argument_list|(
operator|(
operator|(
name|usb_status_t
operator|*
operator|)
name|buf
operator|)
operator|->
name|wStatus
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|totlen
operator|=
literal|2
expr_stmt|;
block|}
break|break;
case|case
name|C
argument_list|(
name|UR_SET_ADDRESS
argument_list|,
name|UT_WRITE_DEVICE
argument_list|)
case|:
comment|/* Set Address, 9.4.6 */
name|DPRINTF
argument_list|(
name|D_MSG
argument_list|,
operator|(
literal|"UR_SET_ADDRESS "
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|>=
name|USB_MAX_DEVICES
condition|)
block|{
name|error
operator|=
name|USBD_IOERROR
expr_stmt|;
goto|goto
name|ret
goto|;
block|}
name|sc
operator|->
name|sc_addr
operator|=
name|value
expr_stmt|;
break|break;
case|case
name|C
argument_list|(
name|UR_SET_CONFIG
argument_list|,
name|UT_WRITE_DEVICE
argument_list|)
case|:
comment|/* Set Configuration, 9.4.7 */
name|DPRINTF
argument_list|(
name|D_MSG
argument_list|,
operator|(
literal|"UR_SET_CONFIG "
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|!=
literal|0
operator|&&
name|value
operator|!=
literal|1
condition|)
block|{
name|error
operator|=
name|USBD_IOERROR
expr_stmt|;
goto|goto
name|ret
goto|;
block|}
name|sc
operator|->
name|sc_conf
operator|=
name|value
expr_stmt|;
break|break;
case|case
name|C
argument_list|(
name|UR_SET_DESCRIPTOR
argument_list|,
name|UT_WRITE_DEVICE
argument_list|)
case|:
comment|/* Set Descriptor, 9.4.8, not supported */
name|DPRINTF
argument_list|(
name|D_MSG
argument_list|,
operator|(
literal|"UR_SET_DESCRIPTOR,WRITE_DEVICE not supported\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|C
argument_list|(
name|UR_SET_FEATURE
argument_list|,
name|UT_WRITE_DEVICE
argument_list|)
case|:
case|case
name|C
argument_list|(
name|UR_SET_FEATURE
argument_list|,
name|UT_WRITE_INTERFACE
argument_list|)
case|:
case|case
name|C
argument_list|(
name|UR_SET_FEATURE
argument_list|,
name|UT_WRITE_ENDPOINT
argument_list|)
case|:
comment|/* Set Feature, 9.4.9, not supported */
name|DPRINTF
argument_list|(
name|D_MSG
argument_list|,
operator|(
literal|"UR_SET_FEATURE not supported\n"
operator|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|USBD_IOERROR
expr_stmt|;
break|break;
case|case
name|C
argument_list|(
name|UR_SET_INTERFACE
argument_list|,
name|UT_WRITE_INTERFACE
argument_list|)
case|:
comment|/* Set Interface, 9.4.10, not supported */
break|break;
case|case
name|C
argument_list|(
name|UR_SYNCH_FRAME
argument_list|,
name|UT_WRITE_ENDPOINT
argument_list|)
case|:
comment|/* Synch Frame, 9.4.11, not supported */
break|break;
comment|/* 	 * Hub specific requests 	 */
case|case
name|C
argument_list|(
name|UR_CLEAR_FEATURE
argument_list|,
name|UT_WRITE_CLASS_DEVICE
argument_list|)
case|:
comment|/* Clear Hub Feature, 11.16.2.1, not supported */
name|DPRINTF
argument_list|(
name|D_MSG
argument_list|,
operator|(
literal|"ClearHubFeature not supported\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|C
argument_list|(
name|UR_CLEAR_FEATURE
argument_list|,
name|UT_WRITE_CLASS_OTHER
argument_list|)
case|:
comment|/* Clear Port Feature, 11.16.2.2 */
if|if
condition|(
name|index
operator|!=
literal|1
condition|)
block|{
name|error
operator|=
name|USBD_IOERROR
expr_stmt|;
goto|goto
name|ret
goto|;
block|}
switch|switch
condition|(
name|value
condition|)
block|{
case|case
name|UHF_PORT_POWER
case|:
name|DPRINTF
argument_list|(
name|D_MSG
argument_list|,
operator|(
literal|"POWER_OFF "
operator|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_powerstat
operator|=
name|POWER_OFF
expr_stmt|;
comment|/* x68k Nereid USB controller needs it */
if|if
condition|(
name|sc
operator|->
name|sc_enable_power
condition|)
name|sc
operator|->
name|sc_enable_power
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|sc_powerstat
argument_list|)
expr_stmt|;
break|break;
case|case
name|UHF_PORT_SUSPEND
case|:
name|DPRINTF
argument_list|(
name|D_MSG
argument_list|,
operator|(
literal|"SUSPEND "
operator|)
argument_list|)
expr_stmt|;
name|sl11write
argument_list|(
name|sc
argument_list|,
name|SL11_CTRL
argument_list|,
name|sl11read
argument_list|(
name|sc
argument_list|,
name|SL11_CTRL
argument_list|)
operator|&
operator|~
name|SL11_CTRL_SUSPEND
argument_list|)
expr_stmt|;
break|break;
case|case
name|UHF_C_PORT_CONNECTION
case|:
name|sc
operator|->
name|sc_change
operator|&=
operator|~
name|UPS_C_CONNECT_STATUS
expr_stmt|;
break|break;
case|case
name|UHF_C_PORT_RESET
case|:
name|sc
operator|->
name|sc_change
operator|&=
operator|~
name|UPS_C_PORT_RESET
expr_stmt|;
break|break;
case|case
name|UHF_PORT_ENABLE
case|:
break|break;
case|case
name|UHF_C_PORT_SUSPEND
case|:
case|case
name|UHF_C_PORT_ENABLE
case|:
case|case
name|UHF_C_PORT_OVER_CURRENT
case|:
default|default:
name|printf
argument_list|(
literal|"ClrPortFeatERR:value=0x%x "
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|error
operator|=
name|USBD_IOERROR
expr_stmt|;
break|break;
block|}
comment|//DPRINTF(D_XFER, ("CH=%04x ", sc->sc_change));
break|break;
case|case
name|C
argument_list|(
name|UR_GET_BUS_STATE
argument_list|,
name|UT_READ_CLASS_OTHER
argument_list|)
case|:
comment|/* Get Bus State, 11.16.2.3, not supported */
comment|/* shall return a STALL... */
break|break;
case|case
name|C
argument_list|(
name|UR_GET_DESCRIPTOR
argument_list|,
name|UT_READ_CLASS_DEVICE
argument_list|)
case|:
comment|/* Get Hub Descriptor, 11.16.2.4 */
if|if
condition|(
name|value
operator|!=
literal|0
condition|)
block|{
name|error
operator|=
name|USBD_IOERROR
expr_stmt|;
goto|goto
name|ret
goto|;
block|}
name|l
operator|=
name|min
argument_list|(
name|len
argument_list|,
name|USB_HUB_DESCRIPTOR_SIZE
argument_list|)
expr_stmt|;
name|totlen
operator|=
name|l
expr_stmt|;
name|memcpy
argument_list|(
name|buf
argument_list|,
operator|&
name|slhci_hubd
argument_list|,
name|l
argument_list|)
expr_stmt|;
break|break;
case|case
name|C
argument_list|(
name|UR_GET_STATUS
argument_list|,
name|UT_READ_CLASS_DEVICE
argument_list|)
case|:
comment|/* Get Hub Status, 11.16.2.5 */
name|DPRINTF
argument_list|(
name|D_MSG
argument_list|,
operator|(
literal|"UR_GET_STATUS RCD"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|!=
literal|4
condition|)
block|{
name|error
operator|=
name|USBD_IOERROR
expr_stmt|;
goto|goto
name|ret
goto|;
block|}
name|memset
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|totlen
operator|=
name|len
expr_stmt|;
break|break;
case|case
name|C
argument_list|(
name|UR_GET_STATUS
argument_list|,
name|UT_READ_CLASS_OTHER
argument_list|)
case|:
comment|/* Get Port Status, 11.16.2.6 */
if|if
condition|(
name|index
operator|!=
literal|1
operator|||
name|len
operator|!=
literal|4
condition|)
block|{
name|printf
argument_list|(
literal|"index=%d,len=%d "
argument_list|,
name|index
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|error
operator|=
name|USBD_IOERROR
expr_stmt|;
goto|goto
name|ret
goto|;
block|}
comment|/* 		 * change 		 * o port is always enabled. 		 * o cannot detect over current. 		 */
name|s
operator|=
name|splusb
argument_list|()
expr_stmt|;
name|sc
operator|->
name|sc_change
operator|&=
operator|~
operator|(
name|UPS_C_CONNECT_STATUS
operator||
name|UPS_C_PORT_RESET
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|SLF_INSERT
operator|)
condition|)
block|{
name|sc
operator|->
name|sc_flags
operator|&=
operator|~
name|SLF_INSERT
expr_stmt|;
name|sc
operator|->
name|sc_change
operator||=
name|UPS_C_CONNECT_STATUS
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|SLF_RESET
operator|)
condition|)
block|{
name|sc
operator|->
name|sc_flags
operator|&=
operator|~
name|SLF_RESET
expr_stmt|;
name|sc
operator|->
name|sc_change
operator||=
name|UPS_C_PORT_RESET
expr_stmt|;
block|}
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
comment|/* 		 * XXX It can recognize that device is detached, 		 * while there is sl11_speed() here. 		 */
if|if
condition|(
name|sc
operator|->
name|sc_change
condition|)
name|sl11_speed
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* 		 * status 		 * o port is always enabled. 		 * o cannot detect over current. 		 */
name|status
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_connect
condition|)
name|status
operator||=
name|UPS_CURRENT_CONNECT_STATUS
operator||
name|UPS_PORT_ENABLED
expr_stmt|;
name|r
operator|=
name|sl11read
argument_list|(
name|sc
argument_list|,
name|SL11_CTRL
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|&
name|SL11_CTRL_SUSPEND
condition|)
name|status
operator||=
name|UPS_SUSPEND
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_powerstat
condition|)
name|status
operator||=
name|UPS_PORT_POWER
expr_stmt|;
if|if
condition|(
operator|!
name|sc
operator|->
name|sc_fullspeed
condition|)
name|status
operator||=
name|UPS_LOW_SPEED
expr_stmt|;
comment|//DPRINTF(D_XFER, ("ST=%04x,CH=%04x ", status, sc->sc_change));
name|USETW
argument_list|(
name|ps
operator|.
name|wPortStatus
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|ps
operator|.
name|wPortChange
argument_list|,
name|sc
operator|->
name|sc_change
argument_list|)
expr_stmt|;
name|l
operator|=
name|min
argument_list|(
name|len
argument_list|,
sizeof|sizeof
argument_list|(
name|ps
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|buf
argument_list|,
operator|&
name|ps
argument_list|,
name|l
argument_list|)
expr_stmt|;
name|totlen
operator|=
name|l
expr_stmt|;
break|break;
case|case
name|C
argument_list|(
name|UR_SET_DESCRIPTOR
argument_list|,
name|UT_WRITE_CLASS_DEVICE
argument_list|)
case|:
comment|/* Set Hub Descriptor, 11.16.2.7, not supported */
comment|/* STALL ? */
name|error
operator|=
name|USBD_IOERROR
expr_stmt|;
break|break;
case|case
name|C
argument_list|(
name|UR_SET_FEATURE
argument_list|,
name|UT_WRITE_CLASS_DEVICE
argument_list|)
case|:
comment|/* Set Hub Feature, 11.16.2.8, not supported */
break|break;
case|case
name|C
argument_list|(
name|UR_SET_FEATURE
argument_list|,
name|UT_WRITE_CLASS_OTHER
argument_list|)
case|:
comment|/* Set Port Feature, 11.16.2.9 */
if|if
condition|(
name|index
operator|!=
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"index=%d "
argument_list|,
name|index
argument_list|)
expr_stmt|;
name|error
operator|=
name|USBD_IOERROR
expr_stmt|;
goto|goto
name|ret
goto|;
block|}
switch|switch
condition|(
name|value
condition|)
block|{
case|case
name|UHF_PORT_RESET
case|:
name|DPRINTF
argument_list|(
name|D_MSG
argument_list|,
operator|(
literal|"PORT_RESET "
operator|)
argument_list|)
expr_stmt|;
name|sl11_reset
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sl11_speed
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_change
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|UHF_PORT_POWER
case|:
name|DPRINTF
argument_list|(
name|D_MSG
argument_list|,
operator|(
literal|"PORT_POWER "
operator|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_powerstat
operator|=
name|POWER_ON
expr_stmt|;
comment|/* x68k Nereid USB controller needs it */
if|if
condition|(
name|sc
operator|->
name|sc_enable_power
condition|)
name|sc
operator|->
name|sc_enable_power
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|sc_powerstat
argument_list|)
expr_stmt|;
name|delay_ms
argument_list|(
literal|25
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"SetPortFeatERR=0x%x "
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|error
operator|=
name|USBD_IOERROR
expr_stmt|;
break|break;
block|}
break|break;
default|default:
name|DPRINTF
argument_list|(
name|D_MSG
argument_list|,
operator|(
literal|"ioerr(UR=%02x,UT=%02x) "
operator|,
name|req
operator|->
name|bRequest
operator|,
name|req
operator|->
name|bmRequestType
operator|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|USBD_IOERROR
expr_stmt|;
goto|goto
name|ret
goto|;
block|}
name|xfer
operator|->
name|actlen
operator|=
name|totlen
expr_stmt|;
name|error
operator|=
name|USBD_NORMAL_COMPLETION
expr_stmt|;
name|ret
label|:
name|xfer
operator|->
name|status
operator|=
name|error
expr_stmt|;
name|s
operator|=
name|splusb
argument_list|()
expr_stmt|;
name|usb_transfer_complete
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
name|USBD_IN_PROGRESS
return|;
block|}
end_function

begin_function
name|void
name|slhci_root_ctrl_abort
parameter_list|(
name|usbd_xfer_handle
name|xfer
parameter_list|)
block|{
name|DPRINTF
argument_list|(
name|D_TRACE
argument_list|,
operator|(
literal|"SLRCabort "
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|slhci_root_ctrl_close
parameter_list|(
name|usbd_pipe_handle
name|pipe
parameter_list|)
block|{
name|DPRINTF
argument_list|(
name|D_TRACE
argument_list|,
operator|(
literal|"SLRCclose "
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|slhci_root_ctrl_done
parameter_list|(
name|usbd_xfer_handle
name|xfer
parameter_list|)
block|{
name|DPRINTF
argument_list|(
name|D_TRACE
argument_list|,
operator|(
literal|"SLRCdone\n"
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|slhci_root_intr_transfer
parameter_list|(
name|usbd_xfer_handle
name|xfer
parameter_list|)
block|{
name|usbd_status
name|error
decl_stmt|;
name|DPRINTF
argument_list|(
name|D_TRACE
argument_list|,
operator|(
literal|"SLRItransfer "
operator|)
argument_list|)
expr_stmt|;
comment|/* Insert last in queue */
name|error
operator|=
name|usb_insert_transfer
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
comment|/* 	 * Pipe isn't running (otherwise error would be USBD_INPROG), 	 * start first. 	 */
return|return
name|slhci_root_intr_start
argument_list|(
name|STAILQ_FIRST
argument_list|(
operator|&
name|xfer
operator|->
name|pipe
operator|->
name|queue
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|slhci_root_intr_start
parameter_list|(
name|usbd_xfer_handle
name|xfer
parameter_list|)
block|{
name|usbd_pipe_handle
name|pipe
init|=
name|xfer
operator|->
name|pipe
decl_stmt|;
name|struct
name|slhci_softc
modifier|*
name|sc
init|=
operator|(
expr|struct
name|slhci_softc
operator|*
operator|)
name|pipe
operator|->
name|device
operator|->
name|bus
decl_stmt|;
name|DPRINTF
argument_list|(
name|D_TRACE
argument_list|,
operator|(
literal|"SLRIstart "
operator|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_interval
operator|=
name|MS_TO_TICKS
argument_list|(
name|xfer
operator|->
name|pipe
operator|->
name|endpoint
operator|->
name|edesc
operator|->
name|bInterval
argument_list|)
expr_stmt|;
name|usb_callout
argument_list|(
name|sc
operator|->
name|sc_poll_handle
argument_list|,
name|sc
operator|->
name|sc_interval
argument_list|,
name|slhci_poll_hub
argument_list|,
name|xfer
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_intr_xfer
operator|=
name|xfer
expr_stmt|;
return|return
name|USBD_IN_PROGRESS
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|slhci_root_intr_abort
parameter_list|(
name|usbd_xfer_handle
name|xfer
parameter_list|)
block|{
name|DPRINTF
argument_list|(
name|D_TRACE
argument_list|,
operator|(
literal|"SLRIabort "
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|slhci_root_intr_close
parameter_list|(
name|usbd_pipe_handle
name|pipe
parameter_list|)
block|{
name|struct
name|slhci_softc
modifier|*
name|sc
init|=
operator|(
expr|struct
name|slhci_softc
operator|*
operator|)
name|pipe
operator|->
name|device
operator|->
name|bus
decl_stmt|;
name|DPRINTF
argument_list|(
name|D_TRACE
argument_list|,
operator|(
literal|"SLRIclose "
operator|)
argument_list|)
expr_stmt|;
name|usb_uncallout
argument_list|(
name|sc
operator|->
name|sc_poll_handle
argument_list|,
name|slhci_poll_hub
argument_list|,
name|sc
operator|->
name|sc_intr_xfer
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_intr_xfer
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|slhci_root_intr_done
parameter_list|(
name|usbd_xfer_handle
name|xfer
parameter_list|)
block|{
comment|//DPRINTF(D_XFER, ("RIdn "));
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|slhci_device_ctrl_transfer
parameter_list|(
name|usbd_xfer_handle
name|xfer
parameter_list|)
block|{
name|usbd_status
name|error
decl_stmt|;
name|DPRINTF
argument_list|(
name|D_TRACE
argument_list|,
operator|(
literal|"C"
operator|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|usb_insert_transfer
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
return|return
name|slhci_device_ctrl_start
argument_list|(
name|STAILQ_FIRST
argument_list|(
operator|&
name|xfer
operator|->
name|pipe
operator|->
name|queue
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|slhci_device_ctrl_start
parameter_list|(
name|usbd_xfer_handle
name|xfer
parameter_list|)
block|{
name|usb_device_request_t
modifier|*
name|req
init|=
operator|&
name|xfer
operator|->
name|request
decl_stmt|;
name|usbd_pipe_handle
name|pipe
init|=
name|xfer
operator|->
name|pipe
decl_stmt|;
name|struct
name|slhci_softc
modifier|*
name|sc
init|=
operator|(
expr|struct
name|slhci_softc
operator|*
operator|)
name|pipe
operator|->
name|device
operator|->
name|bus
decl_stmt|;
name|usbd_status
name|status
init|=
name|USBD_NORMAL_COMPLETION
decl_stmt|;
name|u_char
modifier|*
name|buf
decl_stmt|;
name|int
name|pid
init|=
name|SL11_PID_OUT
decl_stmt|;
name|int
name|len
decl_stmt|,
name|actlen
decl_stmt|,
name|size
decl_stmt|;
name|int
name|s
decl_stmt|;
name|u_int8_t
name|toggle
init|=
literal|0
decl_stmt|;
name|DPRINTF
argument_list|(
name|D_TRACE
argument_list|,
operator|(
literal|"st "
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|SLHCI_DEBUG
if|if
condition|(
operator|(
name|slhci_debug
operator|&
name|D_TRACE
operator|)
condition|)
name|print_req_hub
argument_list|(
name|req
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* SETUP transaction */
if|if
condition|(
name|slhci_transaction
argument_list|(
name|sc
argument_list|,
name|pipe
argument_list|,
name|SL11_PID_SETUP
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|req
argument_list|)
argument_list|,
operator|(
name|u_char
operator|*
operator|)
name|req
argument_list|,
name|toggle
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|status
operator|=
name|USBD_IOERROR
expr_stmt|;
goto|goto
name|ret
goto|;
block|}
name|toggle
operator|^=
name|SL11_EPCTRL_DATATOGGLE
expr_stmt|;
comment|/* DATA transaction */
name|actlen
operator|=
literal|0
expr_stmt|;
name|len
operator|=
name|UGETW
argument_list|(
name|req
operator|->
name|wLength
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
condition|)
block|{
name|buf
operator|=
name|xfer
operator|->
name|buffer
expr_stmt|;
if|if
condition|(
name|req
operator|->
name|bmRequestType
operator|&
name|UT_READ
condition|)
name|pid
operator|=
name|SL11_PID_IN
expr_stmt|;
for|for
control|(
init|;
name|actlen
operator|<
name|len
condition|;
control|)
block|{
name|size
operator|=
name|min
argument_list|(
name|len
operator|-
name|actlen
argument_list|,
literal|8
comment|/* Minimum size */
argument_list|)
expr_stmt|;
if|if
condition|(
name|slhci_transaction
argument_list|(
name|sc
argument_list|,
name|pipe
argument_list|,
name|pid
argument_list|,
name|size
argument_list|,
name|buf
argument_list|,
name|toggle
argument_list|)
operator|==
operator|-
literal|1
condition|)
break|break;
name|toggle
operator|^=
name|SL11_EPCTRL_DATATOGGLE
expr_stmt|;
name|buf
operator|+=
name|size
expr_stmt|;
name|actlen
operator|+=
name|size
expr_stmt|;
block|}
block|}
name|xfer
operator|->
name|actlen
operator|=
name|actlen
expr_stmt|;
comment|/* ACK (status) */
if|if
condition|(
name|pid
operator|==
name|SL11_PID_IN
condition|)
name|pid
operator|=
name|SL11_PID_OUT
expr_stmt|;
else|else
name|pid
operator|=
name|SL11_PID_IN
expr_stmt|;
if|if
condition|(
name|slhci_transaction
argument_list|(
name|sc
argument_list|,
name|pipe
argument_list|,
name|pid
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|toggle
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|status
operator|=
name|USBD_IOERROR
expr_stmt|;
name|ret
label|:
name|xfer
operator|->
name|status
operator|=
name|status
expr_stmt|;
ifdef|#
directive|ifdef
name|SLHCI_DEBUG
if|if
condition|(
operator|(
name|slhci_debug
operator|&
name|D_TRACE
operator|)
operator|&&
name|UGETW
argument_list|(
name|req
operator|->
name|wLength
argument_list|)
operator|>
literal|0
condition|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|UGETW
argument_list|(
name|req
operator|->
name|wLength
argument_list|)
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"%02x"
argument_list|,
operator|(
operator|(
name|unsigned
name|char
operator|*
operator|)
name|xfer
operator|->
name|buffer
operator|)
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|s
operator|=
name|splusb
argument_list|()
expr_stmt|;
name|usb_transfer_complete
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
name|USBD_IN_PROGRESS
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|slhci_device_ctrl_abort
parameter_list|(
name|usbd_xfer_handle
name|xfer
parameter_list|)
block|{
name|DPRINTF
argument_list|(
name|D_TRACE
argument_list|,
operator|(
literal|"Cab "
operator|)
argument_list|)
expr_stmt|;
name|slhci_abort_xfer
argument_list|(
name|xfer
argument_list|,
name|USBD_CANCELLED
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|slhci_device_ctrl_close
parameter_list|(
name|usbd_pipe_handle
name|pipe
parameter_list|)
block|{
name|DPRINTF
argument_list|(
name|D_TRACE
argument_list|,
operator|(
literal|"Ccl "
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|slhci_device_ctrl_done
parameter_list|(
name|usbd_xfer_handle
name|xfer
parameter_list|)
block|{
name|DPRINTF
argument_list|(
name|D_TRACE
argument_list|,
operator|(
literal|"Cdn "
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|slhci_device_intr_transfer
parameter_list|(
name|usbd_xfer_handle
name|xfer
parameter_list|)
block|{
name|usbd_status
name|error
decl_stmt|;
name|DPRINTF
argument_list|(
name|D_TRACE
argument_list|,
operator|(
literal|"INTRtrans "
operator|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|usb_insert_transfer
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
return|return
name|slhci_device_intr_start
argument_list|(
name|STAILQ_FIRST
argument_list|(
operator|&
name|xfer
operator|->
name|pipe
operator|->
name|queue
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|slhci_device_intr_start
parameter_list|(
name|usbd_xfer_handle
name|xfer
parameter_list|)
block|{
name|usbd_pipe_handle
name|pipe
init|=
name|xfer
operator|->
name|pipe
decl_stmt|;
name|struct
name|slhci_xfer
modifier|*
name|sx
decl_stmt|;
name|DPRINTF
argument_list|(
name|D_TRACE
argument_list|,
operator|(
literal|"INTRstart "
operator|)
argument_list|)
expr_stmt|;
name|sx
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|sx
argument_list|)
argument_list|,
name|M_USB
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|sx
operator|==
name|NULL
condition|)
goto|goto
name|reterr
goto|;
name|memset
argument_list|(
name|sx
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|sx
argument_list|)
argument_list|)
expr_stmt|;
name|sx
operator|->
name|sx_xfer
operator|=
name|xfer
expr_stmt|;
name|xfer
operator|->
name|hcpriv
operator|=
name|sx
expr_stmt|;
comment|/* initialize callout */
name|usb_callout_init
argument_list|(
name|sx
operator|->
name|sx_callout_t
argument_list|)
expr_stmt|;
name|usb_callout
argument_list|(
name|sx
operator|->
name|sx_callout_t
argument_list|,
name|MS_TO_TICKS
argument_list|(
name|pipe
operator|->
name|endpoint
operator|->
name|edesc
operator|->
name|bInterval
argument_list|)
argument_list|,
name|slhci_poll_device
argument_list|,
name|sx
argument_list|)
expr_stmt|;
comment|/* ACK */
return|return
name|USBD_IN_PROGRESS
return|;
name|reterr
label|:
return|return
name|USBD_IOERROR
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|slhci_poll_device
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|slhci_xfer
modifier|*
name|sx
init|=
operator|(
expr|struct
name|slhci_xfer
operator|*
operator|)
name|arg
decl_stmt|;
name|usbd_xfer_handle
name|xfer
init|=
name|sx
operator|->
name|sx_xfer
decl_stmt|;
name|usbd_pipe_handle
name|pipe
init|=
name|xfer
operator|->
name|pipe
decl_stmt|;
name|struct
name|slhci_softc
modifier|*
name|sc
init|=
operator|(
expr|struct
name|slhci_softc
operator|*
operator|)
name|pipe
operator|->
name|device
operator|->
name|bus
decl_stmt|;
name|void
modifier|*
name|buf
decl_stmt|;
name|int
name|pid
decl_stmt|;
name|int
name|r
decl_stmt|;
name|int
name|s
decl_stmt|;
name|DPRINTF
argument_list|(
name|D_TRACE
argument_list|,
operator|(
literal|"pldev"
operator|)
argument_list|)
expr_stmt|;
name|usb_callout
argument_list|(
name|sx
operator|->
name|sx_callout_t
argument_list|,
name|MS_TO_TICKS
argument_list|(
name|pipe
operator|->
name|endpoint
operator|->
name|edesc
operator|->
name|bInterval
argument_list|)
argument_list|,
name|slhci_poll_device
argument_list|,
name|sx
argument_list|)
expr_stmt|;
comment|/* interrupt transfer */
name|pid
operator|=
operator|(
name|UE_GET_DIR
argument_list|(
name|pipe
operator|->
name|endpoint
operator|->
name|edesc
operator|->
name|bEndpointAddress
argument_list|)
operator|==
name|UE_DIR_IN
operator|)
condition|?
name|SL11_PID_IN
else|:
name|SL11_PID_OUT
expr_stmt|;
name|buf
operator|=
name|xfer
operator|->
name|buffer
expr_stmt|;
name|r
operator|=
name|slhci_transaction
argument_list|(
name|sc
argument_list|,
name|pipe
argument_list|,
name|pid
argument_list|,
name|xfer
operator|->
name|length
argument_list|,
name|buf
argument_list|,
literal|0
comment|/*toggle*/
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|<
literal|0
condition|)
block|{
name|DPRINTF
argument_list|(
name|D_MSG
argument_list|,
operator|(
literal|"%s error"
operator|,
name|__FUNCTION__
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* no change, return NAK */
if|if
condition|(
name|r
operator|==
literal|0
condition|)
return|return;
name|xfer
operator|->
name|status
operator|=
name|USBD_NORMAL_COMPLETION
expr_stmt|;
name|s
operator|=
name|splusb
argument_list|()
expr_stmt|;
name|xfer
operator|->
name|device
operator|->
name|bus
operator|->
name|intr_context
operator|++
expr_stmt|;
name|usb_transfer_complete
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
name|xfer
operator|->
name|device
operator|->
name|bus
operator|->
name|intr_context
operator|--
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|slhci_device_intr_abort
parameter_list|(
name|usbd_xfer_handle
name|xfer
parameter_list|)
block|{
name|struct
name|slhci_xfer
modifier|*
name|sx
decl_stmt|;
name|DPRINTF
argument_list|(
name|D_TRACE
argument_list|,
operator|(
literal|"INTRabort "
operator|)
argument_list|)
expr_stmt|;
name|sx
operator|=
name|xfer
operator|->
name|hcpriv
expr_stmt|;
if|if
condition|(
name|sx
condition|)
block|{
name|usb_uncallout
argument_list|(
name|sx
operator|->
name|sx_callout_t
argument_list|,
name|slhci_poll_device
argument_list|,
name|sx
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|sx
argument_list|,
name|M_USB
argument_list|)
expr_stmt|;
name|xfer
operator|->
name|hcpriv
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"%s: sx == NULL!\n"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
block|}
name|slhci_abort_xfer
argument_list|(
name|xfer
argument_list|,
name|USBD_CANCELLED
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|slhci_device_intr_close
parameter_list|(
name|usbd_pipe_handle
name|pipe
parameter_list|)
block|{
name|DPRINTF
argument_list|(
name|D_TRACE
argument_list|,
operator|(
literal|"INTRclose "
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|slhci_device_intr_done
parameter_list|(
name|usbd_xfer_handle
name|xfer
parameter_list|)
block|{
name|DPRINTF
argument_list|(
name|D_TRACE
argument_list|,
operator|(
literal|"INTRdone "
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|slhci_device_isoc_transfer
parameter_list|(
name|usbd_xfer_handle
name|xfer
parameter_list|)
block|{
name|DPRINTF
argument_list|(
name|D_TRACE
argument_list|,
operator|(
literal|"S"
operator|)
argument_list|)
expr_stmt|;
return|return
name|USBD_NORMAL_COMPLETION
return|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|slhci_device_isoc_start
parameter_list|(
name|usbd_xfer_handle
name|xfer
parameter_list|)
block|{
name|DPRINTF
argument_list|(
name|D_TRACE
argument_list|,
operator|(
literal|"st "
operator|)
argument_list|)
expr_stmt|;
return|return
name|USBD_NORMAL_COMPLETION
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|slhci_device_isoc_abort
parameter_list|(
name|usbd_xfer_handle
name|xfer
parameter_list|)
block|{
name|DPRINTF
argument_list|(
name|D_TRACE
argument_list|,
operator|(
literal|"Sab "
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|slhci_device_isoc_close
parameter_list|(
name|usbd_pipe_handle
name|pipe
parameter_list|)
block|{
name|DPRINTF
argument_list|(
name|D_TRACE
argument_list|,
operator|(
literal|"Scl "
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|slhci_device_isoc_done
parameter_list|(
name|usbd_xfer_handle
name|xfer
parameter_list|)
block|{
name|DPRINTF
argument_list|(
name|D_TRACE
argument_list|,
operator|(
literal|"Sdn "
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|slhci_device_bulk_transfer
parameter_list|(
name|usbd_xfer_handle
name|xfer
parameter_list|)
block|{
name|DPRINTF
argument_list|(
name|D_TRACE
argument_list|,
operator|(
literal|"B"
operator|)
argument_list|)
expr_stmt|;
return|return
name|USBD_NORMAL_COMPLETION
return|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|slhci_device_bulk_start
parameter_list|(
name|usbd_xfer_handle
name|xfer
parameter_list|)
block|{
name|DPRINTF
argument_list|(
name|D_TRACE
argument_list|,
operator|(
literal|"st "
operator|)
argument_list|)
expr_stmt|;
return|return
name|USBD_NORMAL_COMPLETION
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|slhci_device_bulk_abort
parameter_list|(
name|usbd_xfer_handle
name|xfer
parameter_list|)
block|{
name|DPRINTF
argument_list|(
name|D_TRACE
argument_list|,
operator|(
literal|"Bab "
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|slhci_device_bulk_close
parameter_list|(
name|usbd_pipe_handle
name|pipe
parameter_list|)
block|{
name|DPRINTF
argument_list|(
name|D_TRACE
argument_list|,
operator|(
literal|"Bcl "
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|slhci_device_bulk_done
parameter_list|(
name|usbd_xfer_handle
name|xfer
parameter_list|)
block|{
name|DPRINTF
argument_list|(
name|D_TRACE
argument_list|,
operator|(
literal|"Bdn "
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_define
define|#
directive|define
name|DATA0_RD
value|(0x03)
end_define

begin_define
define|#
directive|define
name|DATA0_WR
value|(0x07)
end_define

begin_define
define|#
directive|define
name|SLHCI_TIMEOUT
value|(5000)
end_define

begin_comment
comment|/*  * Do a transaction.  * return 1 if ACK, 0 if NAK, -1 if error.  */
end_comment

begin_function
specifier|static
name|int
name|slhci_transaction
parameter_list|(
name|struct
name|slhci_softc
modifier|*
name|sc
parameter_list|,
name|usbd_pipe_handle
name|pipe
parameter_list|,
name|u_int8_t
name|pid
parameter_list|,
name|int
name|len
parameter_list|,
name|u_char
modifier|*
name|buf
parameter_list|,
name|u_int8_t
name|toggle
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|SLHCI_DEBUG
name|char
name|str
index|[
literal|64
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
endif|#
directive|endif
name|int
name|timeout
decl_stmt|;
name|int
name|ls_via_hub
init|=
literal|0
decl_stmt|;
name|int
name|pl
decl_stmt|;
name|u_int8_t
name|isr
decl_stmt|;
name|u_int8_t
name|result
init|=
literal|0
decl_stmt|;
name|u_int8_t
name|devaddr
init|=
name|pipe
operator|->
name|device
operator|->
name|address
decl_stmt|;
name|u_int8_t
name|endpointaddr
init|=
name|pipe
operator|->
name|endpoint
operator|->
name|edesc
operator|->
name|bEndpointAddress
decl_stmt|;
name|u_int8_t
name|endpoint
decl_stmt|;
name|u_int8_t
name|cmd
init|=
name|DATA0_RD
decl_stmt|;
name|endpoint
operator|=
name|UE_GET_ADDR
argument_list|(
name|endpointaddr
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
name|D_XFER
argument_list|,
operator|(
literal|"\n(%x,%d%s%d,%d) "
operator|,
name|pid
operator|,
name|len
operator|,
operator|(
name|pid
operator|==
name|SL11_PID_IN
operator|)
condition|?
literal|"<-"
else|:
literal|"->"
operator|,
name|devaddr
operator|,
name|endpoint
operator|)
argument_list|)
expr_stmt|;
comment|/* Set registers */
name|sl11write
argument_list|(
name|sc
argument_list|,
name|SL11_E0ADDR
argument_list|,
literal|0x40
argument_list|)
expr_stmt|;
name|sl11write
argument_list|(
name|sc
argument_list|,
name|SL11_E0LEN
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|sl11write
argument_list|(
name|sc
argument_list|,
name|SL11_E0PID
argument_list|,
operator|(
name|pid
operator|<<
literal|4
operator|)
operator|+
name|endpoint
argument_list|)
expr_stmt|;
name|sl11write
argument_list|(
name|sc
argument_list|,
name|SL11_E0DEV
argument_list|,
name|devaddr
argument_list|)
expr_stmt|;
comment|/* Set buffer unless PID_IN */
if|if
condition|(
name|pid
operator|!=
name|SL11_PID_IN
condition|)
block|{
if|if
condition|(
name|len
operator|>
literal|0
condition|)
name|sl11write_region
argument_list|(
name|sc
argument_list|,
literal|0x40
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|cmd
operator|=
name|DATA0_WR
expr_stmt|;
block|}
comment|/* timing ? */
name|pl
operator|=
operator|(
name|len
operator|>>
literal|3
operator|)
operator|+
literal|3
expr_stmt|;
comment|/* Low speed device via HUB */
comment|/* XXX does not work... */
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_fullspeed
operator|)
operator|&&
name|pipe
operator|->
name|device
operator|->
name|speed
operator|==
name|USB_SPEED_LOW
condition|)
block|{
name|pl
operator|=
name|len
operator|+
literal|16
expr_stmt|;
name|cmd
operator||=
name|SL11_EPCTRL_PREAMBLE
expr_stmt|;
comment|/* 		 * SL811HS/T rev 1.2 has a bug, when it got PID_IN 		 * from LowSpeed device via HUB. 		 */
if|if
condition|(
name|sc
operator|->
name|sc_sltype
operator|==
name|SLTYPE_SL811HS_R12
operator|&&
name|pid
operator|==
name|SL11_PID_IN
condition|)
block|{
name|ls_via_hub
operator|=
literal|1
expr_stmt|;
name|DPRINTF
argument_list|(
name|D_MSG
argument_list|,
operator|(
literal|"LSvH "
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* timing ? */
if|if
condition|(
name|sl11read
argument_list|(
name|sc
argument_list|,
name|SL811_CSOF
argument_list|)
operator|<=
operator|(
name|u_int8_t
operator|)
name|pl
condition|)
name|cmd
operator||=
name|SL11_EPCTRL_SOF
expr_stmt|;
comment|/* Transfer */
name|sl11write
argument_list|(
name|sc
argument_list|,
name|SL11_ISR
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
name|sl11write
argument_list|(
name|sc
argument_list|,
name|SL11_E0CTRL
argument_list|,
name|cmd
operator||
name|toggle
argument_list|)
expr_stmt|;
comment|/* Polling */
for|for
control|(
name|timeout
operator|=
name|SLHCI_TIMEOUT
init|;
name|timeout
condition|;
name|timeout
operator|--
control|)
block|{
name|isr
operator|=
name|sl11read
argument_list|(
name|sc
argument_list|,
name|SL11_ISR
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|isr
operator|&
name|SL11_ISR_USBA
operator|)
condition|)
break|break;
block|}
comment|/* Check result status */
name|result
operator|=
name|sl11read
argument_list|(
name|sc
argument_list|,
name|SL11_E0STAT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|result
operator|&
name|SL11_EPSTAT_NAK
operator|)
operator|&&
name|ls_via_hub
condition|)
block|{
comment|/* Resend PID_IN within 20usec */
name|sl11write
argument_list|(
name|sc
argument_list|,
name|SL11_ISR
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
name|sl11write
argument_list|(
name|sc
argument_list|,
name|SL11_E0CTRL
argument_list|,
name|SL11_EPCTRL_ARM
argument_list|)
expr_stmt|;
block|}
name|sl11write
argument_list|(
name|sc
argument_list|,
name|SL11_ISR
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
name|D_XFER
argument_list|,
operator|(
literal|"t=%d i=%x "
operator|,
name|SLHCI_TIMEOUT
operator|-
name|timeout
operator|,
name|isr
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|SLHCI_DEBUG
name|bitmask_snprintf
argument_list|(
name|result
argument_list|,
literal|"\20\x8STALL\7NAK\6OV\5SETUP\4DATA1\3TIMEOUT\2ERR\1ACK"
argument_list|,
name|str
argument_list|,
sizeof|sizeof
argument_list|(
name|str
argument_list|)
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
name|D_XFER
argument_list|,
operator|(
literal|"STAT=%s "
operator|,
name|str
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|(
name|result
operator|&
name|SL11_EPSTAT_ERROR
operator|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
operator|(
name|result
operator|&
name|SL11_EPSTAT_NAK
operator|)
condition|)
return|return
literal|0
return|;
comment|/* Read buffer if PID_IN */
if|if
condition|(
name|pid
operator|==
name|SL11_PID_IN
operator|&&
name|len
operator|>
literal|0
condition|)
block|{
name|sl11read_region
argument_list|(
name|sc
argument_list|,
name|buf
argument_list|,
literal|0x40
argument_list|,
name|len
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|SLHCI_DEBUG
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
name|DPRINTF
argument_list|(
name|D_XFER
argument_list|,
operator|(
literal|"%02X "
operator|,
name|buf
index|[
name|i
index|]
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
return|return
literal|1
return|;
block|}
end_function

begin_function
name|void
name|slhci_abort_xfer
parameter_list|(
name|usbd_xfer_handle
name|xfer
parameter_list|,
name|usbd_status
name|status
parameter_list|)
block|{
name|xfer
operator|->
name|status
operator|=
name|status
expr_stmt|;
name|usb_transfer_complete
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|slhci_device_clear_toggle
parameter_list|(
name|usbd_pipe_handle
name|pipe
parameter_list|)
block|{
name|DPRINTF
argument_list|(
name|D_TRACE
argument_list|,
operator|(
literal|"SLdevice_clear_toggle "
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|SLHCI_DEBUG
end_ifdef

begin_function
name|void
name|print_req
parameter_list|(
name|usb_device_request_t
modifier|*
name|r
parameter_list|)
block|{
name|char
modifier|*
name|xmes
index|[]
init|=
block|{
literal|"GETSTAT"
block|,
literal|"CLRFEAT"
block|,
literal|"res"
block|,
literal|"SETFEAT"
block|,
literal|"res"
block|,
literal|"SETADDR"
block|,
literal|"GETDESC"
block|,
literal|"SETDESC"
block|,
literal|"GETCONF"
block|,
literal|"SETCONF"
block|,
literal|"GETIN/F"
block|,
literal|"SETIN/F"
block|,
literal|"SYNC_FR"
block|}
decl_stmt|;
name|int
name|req
decl_stmt|,
name|type
decl_stmt|,
name|value
decl_stmt|,
name|index
decl_stmt|,
name|len
decl_stmt|;
name|req
operator|=
name|r
operator|->
name|bRequest
expr_stmt|;
name|type
operator|=
name|r
operator|->
name|bmRequestType
expr_stmt|;
name|value
operator|=
name|UGETW
argument_list|(
name|r
operator|->
name|wValue
argument_list|)
expr_stmt|;
name|index
operator|=
name|UGETW
argument_list|(
name|r
operator|->
name|wIndex
argument_list|)
expr_stmt|;
name|len
operator|=
name|UGETW
argument_list|(
name|r
operator|->
name|wLength
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%x,%s,v=%d,i=%d,l=%d "
argument_list|,
name|type
argument_list|,
name|xmes
index|[
name|req
index|]
argument_list|,
name|value
argument_list|,
name|index
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|print_req_hub
parameter_list|(
name|usb_device_request_t
modifier|*
name|r
parameter_list|)
block|{
struct|struct
block|{
name|int
name|req
decl_stmt|;
name|int
name|type
decl_stmt|;
name|char
modifier|*
name|str
decl_stmt|;
block|}
name|conf
index|[]
init|=
block|{
block|{
literal|1
block|,
literal|0x20
block|,
literal|"ClrHubFeat"
block|}
block|,
block|{
literal|1
block|,
literal|0x23
block|,
literal|"ClrPortFeat"
block|}
block|,
block|{
literal|2
block|,
literal|0xa3
block|,
literal|"GetBusState"
block|}
block|,
block|{
literal|6
block|,
literal|0xa0
block|,
literal|"GetHubDesc"
block|}
block|,
block|{
literal|0
block|,
literal|0xa0
block|,
literal|"GetHubStat"
block|}
block|,
block|{
literal|0
block|,
literal|0xa3
block|,
literal|"GetPortStat"
block|}
block|,
block|{
literal|7
block|,
literal|0x20
block|,
literal|"SetHubDesc"
block|}
block|,
block|{
literal|3
block|,
literal|0x20
block|,
literal|"SetHubFeat"
block|}
block|,
block|{
literal|3
block|,
literal|0x23
block|,
literal|"SetPortFeat"
block|}
block|,
block|{
operator|-
literal|1
block|,
literal|0
block|,
name|NULL
block|}
block|, 	}
struct|;
name|int
name|i
decl_stmt|;
name|int
name|value
decl_stmt|,
name|index
decl_stmt|,
name|len
decl_stmt|;
name|value
operator|=
name|UGETW
argument_list|(
name|r
operator|->
name|wValue
argument_list|)
expr_stmt|;
name|index
operator|=
name|UGETW
argument_list|(
name|r
operator|->
name|wIndex
argument_list|)
expr_stmt|;
name|len
operator|=
name|UGETW
argument_list|(
name|r
operator|->
name|wLength
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|conf
index|[
name|i
index|]
operator|.
name|req
operator|==
operator|-
literal|1
condition|)
return|return
name|print_req
argument_list|(
name|r
argument_list|)
return|;
if|if
condition|(
name|r
operator|->
name|bmRequestType
operator|==
name|conf
index|[
name|i
index|]
operator|.
name|type
operator|&&
name|r
operator|->
name|bRequest
operator|==
name|conf
index|[
name|i
index|]
operator|.
name|req
condition|)
block|{
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|conf
index|[
name|i
index|]
operator|.
name|str
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|printf
argument_list|(
literal|",v=%d,i=%d,l=%d "
argument_list|,
name|value
argument_list|,
name|index
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|print_dumpreg
parameter_list|(
name|struct
name|slhci_softc
modifier|*
name|sc
parameter_list|)
block|{
name|printf
argument_list|(
literal|"00=%02x,01=%02x,02=%02x,03=%02x,04=%02x,"
literal|"08=%02x,09=%02x,0A=%02x,0B=%02x,0C=%02x,"
argument_list|,
name|sl11read
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
argument_list|,
name|sl11read
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|)
argument_list|,
name|sl11read
argument_list|(
name|sc
argument_list|,
literal|2
argument_list|)
argument_list|,
name|sl11read
argument_list|(
name|sc
argument_list|,
literal|3
argument_list|)
argument_list|,
name|sl11read
argument_list|(
name|sc
argument_list|,
literal|4
argument_list|)
argument_list|,
name|sl11read
argument_list|(
name|sc
argument_list|,
literal|8
argument_list|)
argument_list|,
name|sl11read
argument_list|(
name|sc
argument_list|,
literal|9
argument_list|)
argument_list|,
name|sl11read
argument_list|(
name|sc
argument_list|,
literal|10
argument_list|)
argument_list|,
name|sl11read
argument_list|(
name|sc
argument_list|,
literal|11
argument_list|)
argument_list|,
name|sl11read
argument_list|(
name|sc
argument_list|,
literal|12
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"CR1=%02x,IER=%02x,0D=%02x,0E=%02x,0F=%02x "
argument_list|,
name|sl11read
argument_list|(
name|sc
argument_list|,
literal|5
argument_list|)
argument_list|,
name|sl11read
argument_list|(
name|sc
argument_list|,
literal|6
argument_list|)
argument_list|,
name|sl11read
argument_list|(
name|sc
argument_list|,
literal|13
argument_list|)
argument_list|,
name|sl11read
argument_list|(
name|sc
argument_list|,
literal|14
argument_list|)
argument_list|,
name|sl11read
argument_list|(
name|sc
argument_list|,
literal|15
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|print_xfer
parameter_list|(
name|usbd_xfer_handle
name|xfer
parameter_list|)
block|{
name|printf
argument_list|(
literal|"xfer: length=%d, actlen=%d, flags=%x, timeout=%d,"
argument_list|,
name|xfer
operator|->
name|length
argument_list|,
name|xfer
operator|->
name|actlen
argument_list|,
name|xfer
operator|->
name|flags
argument_list|,
name|xfer
operator|->
name|timeout
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"request{ "
argument_list|)
expr_stmt|;
name|print_req_hub
argument_list|(
operator|&
name|xfer
operator|->
name|request
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"} "
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* SLHCI_DEBUG */
end_comment

end_unit


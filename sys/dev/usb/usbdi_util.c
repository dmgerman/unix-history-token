begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	$NetBSD: usbdi_util.c,v 1.42 2004/12/03 08:53:40 augustss Exp $	*/
end_comment

begin_comment
comment|/*-  * Copyright (c) 1998 The NetBSD Foundation, Inc.  * All rights reserved.  *  * This code is derived from software contributed to The NetBSD Foundation  * by Lennart Augustsson (lennart@augustsson.net) at  * Carlstedt Research& Technology.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. All advertising materials mentioning features or use of this software  *    must display the following acknowledgement:  *        This product includes software developed by the NetBSD  *        Foundation, Inc. and its contributors.  * 4. Neither the name of The NetBSD Foundation nor the names of its  *    contributors may be used to endorse or promote products derived  *    from this software without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE NETBSD FOUNDATION, INC. AND CONTRIBUTORS  * ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED  * TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE FOUNDATION OR CONTRIBUTORS  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE  * POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__NetBSD__
argument_list|)
operator|||
name|defined
argument_list|(
name|__OpenBSD__
argument_list|)
end_if

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/device.h>
end_include

begin_elif
elif|#
directive|elif
name|defined
argument_list|(
name|__FreeBSD__
argument_list|)
end_elif

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<dev/usb/usb.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usbhid.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usbdi.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usbdi_util.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|USB_DEBUG
end_ifdef

begin_define
define|#
directive|define
name|DPRINTF
parameter_list|(
name|x
parameter_list|)
value|if (usbdebug) logprintf x
end_define

begin_define
define|#
directive|define
name|DPRINTFN
parameter_list|(
name|n
parameter_list|,
name|x
parameter_list|)
value|if (usbdebug>(n)) logprintf x
end_define

begin_decl_stmt
specifier|extern
name|int
name|usbdebug
decl_stmt|;
end_decl_stmt

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|DPRINTF
parameter_list|(
name|x
parameter_list|)
end_define

begin_define
define|#
directive|define
name|DPRINTFN
parameter_list|(
name|n
parameter_list|,
name|x
parameter_list|)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|usbd_status
name|usbd_get_desc
parameter_list|(
name|usbd_device_handle
name|dev
parameter_list|,
name|int
name|type
parameter_list|,
name|int
name|index
parameter_list|,
name|int
name|len
parameter_list|,
name|void
modifier|*
name|desc
parameter_list|)
block|{
name|usb_device_request_t
name|req
decl_stmt|;
name|DPRINTFN
argument_list|(
literal|3
argument_list|,
operator|(
literal|"usbd_get_desc: type=%d, index=%d, len=%d\n"
operator|,
name|type
operator|,
name|index
operator|,
name|len
operator|)
argument_list|)
expr_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_READ_DEVICE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|UR_GET_DESCRIPTOR
expr_stmt|;
name|USETW2
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
name|type
argument_list|,
name|index
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|(
name|usbd_do_request
argument_list|(
name|dev
argument_list|,
operator|&
name|req
argument_list|,
name|desc
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|usbd_get_config_desc
parameter_list|(
name|usbd_device_handle
name|dev
parameter_list|,
name|int
name|confidx
parameter_list|,
name|usb_config_descriptor_t
modifier|*
name|d
parameter_list|)
block|{
name|usbd_status
name|err
decl_stmt|;
name|DPRINTFN
argument_list|(
literal|3
argument_list|,
operator|(
literal|"usbd_get_config_desc: confidx=%d\n"
operator|,
name|confidx
operator|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|usbd_get_desc
argument_list|(
name|dev
argument_list|,
name|UDESC_CONFIG
argument_list|,
name|confidx
argument_list|,
name|USB_CONFIG_DESCRIPTOR_SIZE
argument_list|,
name|d
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
operator|(
name|err
operator|)
return|;
if|if
condition|(
name|d
operator|->
name|bDescriptorType
operator|!=
name|UDESC_CONFIG
condition|)
block|{
name|DPRINTFN
argument_list|(
operator|-
literal|1
argument_list|,
operator|(
literal|"usbd_get_config_desc: confidx=%d, bad desc "
literal|"len=%d type=%d\n"
operator|,
name|confidx
operator|,
name|d
operator|->
name|bLength
operator|,
name|d
operator|->
name|bDescriptorType
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|USBD_INVAL
operator|)
return|;
block|}
return|return
operator|(
name|USBD_NORMAL_COMPLETION
operator|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|usbd_get_config_desc_full
parameter_list|(
name|usbd_device_handle
name|dev
parameter_list|,
name|int
name|conf
parameter_list|,
name|void
modifier|*
name|d
parameter_list|,
name|int
name|size
parameter_list|)
block|{
name|DPRINTFN
argument_list|(
literal|3
argument_list|,
operator|(
literal|"usbd_get_config_desc_full: conf=%d\n"
operator|,
name|conf
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|usbd_get_desc
argument_list|(
name|dev
argument_list|,
name|UDESC_CONFIG
argument_list|,
name|conf
argument_list|,
name|size
argument_list|,
name|d
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|usbd_get_device_desc
parameter_list|(
name|usbd_device_handle
name|dev
parameter_list|,
name|usb_device_descriptor_t
modifier|*
name|d
parameter_list|)
block|{
name|DPRINTFN
argument_list|(
literal|3
argument_list|,
operator|(
literal|"usbd_get_device_desc:\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|usbd_get_desc
argument_list|(
name|dev
argument_list|,
name|UDESC_DEVICE
argument_list|,
literal|0
argument_list|,
name|USB_DEVICE_DESCRIPTOR_SIZE
argument_list|,
name|d
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|usbd_get_device_status
parameter_list|(
name|usbd_device_handle
name|dev
parameter_list|,
name|usb_status_t
modifier|*
name|st
parameter_list|)
block|{
name|usb_device_request_t
name|req
decl_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_READ_DEVICE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|UR_GET_STATUS
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
sizeof|sizeof
argument_list|(
name|usb_status_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|usbd_do_request
argument_list|(
name|dev
argument_list|,
operator|&
name|req
argument_list|,
name|st
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|usbd_get_hub_status
parameter_list|(
name|usbd_device_handle
name|dev
parameter_list|,
name|usb_hub_status_t
modifier|*
name|st
parameter_list|)
block|{
name|usb_device_request_t
name|req
decl_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_READ_CLASS_DEVICE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|UR_GET_STATUS
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
sizeof|sizeof
argument_list|(
name|usb_hub_status_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|usbd_do_request
argument_list|(
name|dev
argument_list|,
operator|&
name|req
argument_list|,
name|st
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|usbd_set_address
parameter_list|(
name|usbd_device_handle
name|dev
parameter_list|,
name|int
name|addr
parameter_list|)
block|{
name|usb_device_request_t
name|req
decl_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_WRITE_DEVICE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|UR_SET_ADDRESS
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|usbd_do_request
argument_list|(
name|dev
argument_list|,
operator|&
name|req
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|usbd_get_port_status
parameter_list|(
name|usbd_device_handle
name|dev
parameter_list|,
name|int
name|port
parameter_list|,
name|usb_port_status_t
modifier|*
name|ps
parameter_list|)
block|{
name|usb_device_request_t
name|req
decl_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_READ_CLASS_OTHER
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|UR_GET_STATUS
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
sizeof|sizeof
expr|*
name|ps
argument_list|)
expr_stmt|;
return|return
operator|(
name|usbd_do_request
argument_list|(
name|dev
argument_list|,
operator|&
name|req
argument_list|,
name|ps
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|usbd_clear_hub_feature
parameter_list|(
name|usbd_device_handle
name|dev
parameter_list|,
name|int
name|sel
parameter_list|)
block|{
name|usb_device_request_t
name|req
decl_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_WRITE_CLASS_DEVICE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|UR_CLEAR_FEATURE
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
name|sel
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|usbd_do_request
argument_list|(
name|dev
argument_list|,
operator|&
name|req
argument_list|,
literal|0
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|usbd_set_hub_feature
parameter_list|(
name|usbd_device_handle
name|dev
parameter_list|,
name|int
name|sel
parameter_list|)
block|{
name|usb_device_request_t
name|req
decl_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_WRITE_CLASS_DEVICE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|UR_SET_FEATURE
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
name|sel
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|usbd_do_request
argument_list|(
name|dev
argument_list|,
operator|&
name|req
argument_list|,
literal|0
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|usbd_clear_port_feature
parameter_list|(
name|usbd_device_handle
name|dev
parameter_list|,
name|int
name|port
parameter_list|,
name|int
name|sel
parameter_list|)
block|{
name|usb_device_request_t
name|req
decl_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_WRITE_CLASS_OTHER
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|UR_CLEAR_FEATURE
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
name|sel
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|usbd_do_request
argument_list|(
name|dev
argument_list|,
operator|&
name|req
argument_list|,
literal|0
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|usbd_set_port_feature
parameter_list|(
name|usbd_device_handle
name|dev
parameter_list|,
name|int
name|port
parameter_list|,
name|int
name|sel
parameter_list|)
block|{
name|usb_device_request_t
name|req
decl_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_WRITE_CLASS_OTHER
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|UR_SET_FEATURE
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
name|sel
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|usbd_do_request
argument_list|(
name|dev
argument_list|,
operator|&
name|req
argument_list|,
literal|0
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|usbd_get_protocol
parameter_list|(
name|usbd_interface_handle
name|iface
parameter_list|,
name|u_int8_t
modifier|*
name|report
parameter_list|)
block|{
name|usb_interface_descriptor_t
modifier|*
name|id
init|=
name|usbd_get_interface_descriptor
argument_list|(
name|iface
argument_list|)
decl_stmt|;
name|usbd_device_handle
name|dev
decl_stmt|;
name|usb_device_request_t
name|req
decl_stmt|;
name|DPRINTFN
argument_list|(
literal|4
argument_list|,
operator|(
literal|"usbd_get_protocol: iface=%p, endpt=%d\n"
operator|,
name|iface
operator|,
name|id
operator|->
name|bInterfaceNumber
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|id
operator|==
name|NULL
condition|)
return|return
operator|(
name|USBD_IOERROR
operator|)
return|;
name|usbd_interface2device_handle
argument_list|(
name|iface
argument_list|,
operator|&
name|dev
argument_list|)
expr_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_READ_CLASS_INTERFACE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|UR_GET_PROTOCOL
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
name|id
operator|->
name|bInterfaceNumber
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
operator|(
name|usbd_do_request
argument_list|(
name|dev
argument_list|,
operator|&
name|req
argument_list|,
name|report
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|usbd_set_protocol
parameter_list|(
name|usbd_interface_handle
name|iface
parameter_list|,
name|int
name|report
parameter_list|)
block|{
name|usb_interface_descriptor_t
modifier|*
name|id
init|=
name|usbd_get_interface_descriptor
argument_list|(
name|iface
argument_list|)
decl_stmt|;
name|usbd_device_handle
name|dev
decl_stmt|;
name|usb_device_request_t
name|req
decl_stmt|;
name|DPRINTFN
argument_list|(
literal|4
argument_list|,
operator|(
literal|"usbd_set_protocol: iface=%p, report=%d, endpt=%d\n"
operator|,
name|iface
operator|,
name|report
operator|,
name|id
operator|->
name|bInterfaceNumber
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|id
operator|==
name|NULL
condition|)
return|return
operator|(
name|USBD_IOERROR
operator|)
return|;
name|usbd_interface2device_handle
argument_list|(
name|iface
argument_list|,
operator|&
name|dev
argument_list|)
expr_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_WRITE_CLASS_INTERFACE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|UR_SET_PROTOCOL
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
name|report
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
name|id
operator|->
name|bInterfaceNumber
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|usbd_do_request
argument_list|(
name|dev
argument_list|,
operator|&
name|req
argument_list|,
literal|0
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|usbd_set_report
parameter_list|(
name|usbd_interface_handle
name|iface
parameter_list|,
name|int
name|type
parameter_list|,
name|int
name|id
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|usb_interface_descriptor_t
modifier|*
name|ifd
init|=
name|usbd_get_interface_descriptor
argument_list|(
name|iface
argument_list|)
decl_stmt|;
name|usbd_device_handle
name|dev
decl_stmt|;
name|usb_device_request_t
name|req
decl_stmt|;
name|DPRINTFN
argument_list|(
literal|4
argument_list|,
operator|(
literal|"usbd_set_report: len=%d\n"
operator|,
name|len
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifd
operator|==
name|NULL
condition|)
return|return
operator|(
name|USBD_IOERROR
operator|)
return|;
name|usbd_interface2device_handle
argument_list|(
name|iface
argument_list|,
operator|&
name|dev
argument_list|)
expr_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_WRITE_CLASS_INTERFACE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|UR_SET_REPORT
expr_stmt|;
name|USETW2
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
name|type
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
name|ifd
operator|->
name|bInterfaceNumber
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|(
name|usbd_do_request
argument_list|(
name|dev
argument_list|,
operator|&
name|req
argument_list|,
name|data
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|usbd_set_report_async
parameter_list|(
name|usbd_interface_handle
name|iface
parameter_list|,
name|int
name|type
parameter_list|,
name|int
name|id
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|usb_interface_descriptor_t
modifier|*
name|ifd
init|=
name|usbd_get_interface_descriptor
argument_list|(
name|iface
argument_list|)
decl_stmt|;
name|usbd_device_handle
name|dev
decl_stmt|;
name|usb_device_request_t
name|req
decl_stmt|;
name|DPRINTFN
argument_list|(
literal|4
argument_list|,
operator|(
literal|"usbd_set_report_async: len=%d\n"
operator|,
name|len
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifd
operator|==
name|NULL
condition|)
return|return
operator|(
name|USBD_IOERROR
operator|)
return|;
name|usbd_interface2device_handle
argument_list|(
name|iface
argument_list|,
operator|&
name|dev
argument_list|)
expr_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_WRITE_CLASS_INTERFACE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|UR_SET_REPORT
expr_stmt|;
name|USETW2
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
name|type
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
name|ifd
operator|->
name|bInterfaceNumber
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|(
name|usbd_do_request_async
argument_list|(
name|dev
argument_list|,
operator|&
name|req
argument_list|,
name|data
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|usbd_get_report
parameter_list|(
name|usbd_interface_handle
name|iface
parameter_list|,
name|int
name|type
parameter_list|,
name|int
name|id
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|usb_interface_descriptor_t
modifier|*
name|ifd
init|=
name|usbd_get_interface_descriptor
argument_list|(
name|iface
argument_list|)
decl_stmt|;
name|usbd_device_handle
name|dev
decl_stmt|;
name|usb_device_request_t
name|req
decl_stmt|;
name|DPRINTFN
argument_list|(
literal|4
argument_list|,
operator|(
literal|"usbd_get_report: len=%d\n"
operator|,
name|len
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifd
operator|==
name|NULL
condition|)
return|return
operator|(
name|USBD_IOERROR
operator|)
return|;
name|usbd_interface2device_handle
argument_list|(
name|iface
argument_list|,
operator|&
name|dev
argument_list|)
expr_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_READ_CLASS_INTERFACE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|UR_GET_REPORT
expr_stmt|;
name|USETW2
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
name|type
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
name|ifd
operator|->
name|bInterfaceNumber
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|(
name|usbd_do_request
argument_list|(
name|dev
argument_list|,
operator|&
name|req
argument_list|,
name|data
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|usbd_set_idle
parameter_list|(
name|usbd_interface_handle
name|iface
parameter_list|,
name|int
name|duration
parameter_list|,
name|int
name|id
parameter_list|)
block|{
name|usb_interface_descriptor_t
modifier|*
name|ifd
init|=
name|usbd_get_interface_descriptor
argument_list|(
name|iface
argument_list|)
decl_stmt|;
name|usbd_device_handle
name|dev
decl_stmt|;
name|usb_device_request_t
name|req
decl_stmt|;
name|DPRINTFN
argument_list|(
literal|4
argument_list|,
operator|(
literal|"usbd_set_idle: %d %d\n"
operator|,
name|duration
operator|,
name|id
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifd
operator|==
name|NULL
condition|)
return|return
operator|(
name|USBD_IOERROR
operator|)
return|;
name|usbd_interface2device_handle
argument_list|(
name|iface
argument_list|,
operator|&
name|dev
argument_list|)
expr_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_WRITE_CLASS_INTERFACE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|UR_SET_IDLE
expr_stmt|;
name|USETW2
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
name|duration
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
name|ifd
operator|->
name|bInterfaceNumber
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|usbd_do_request
argument_list|(
name|dev
argument_list|,
operator|&
name|req
argument_list|,
literal|0
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|usbd_get_report_descriptor
parameter_list|(
name|usbd_device_handle
name|dev
parameter_list|,
name|int
name|ifcno
parameter_list|,
name|int
name|size
parameter_list|,
name|void
modifier|*
name|d
parameter_list|)
block|{
name|usb_device_request_t
name|req
decl_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_READ_INTERFACE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|UR_GET_DESCRIPTOR
expr_stmt|;
name|USETW2
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
name|UDESC_REPORT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* report id should be 0 */
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
name|ifcno
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
name|size
argument_list|)
expr_stmt|;
return|return
operator|(
name|usbd_do_request
argument_list|(
name|dev
argument_list|,
operator|&
name|req
argument_list|,
name|d
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|usb_hid_descriptor_t
modifier|*
name|usbd_get_hid_descriptor
parameter_list|(
name|usbd_interface_handle
name|ifc
parameter_list|)
block|{
name|usb_interface_descriptor_t
modifier|*
name|idesc
init|=
name|usbd_get_interface_descriptor
argument_list|(
name|ifc
argument_list|)
decl_stmt|;
name|usbd_device_handle
name|dev
decl_stmt|;
name|usb_config_descriptor_t
modifier|*
name|cdesc
decl_stmt|;
name|usb_hid_descriptor_t
modifier|*
name|hd
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
name|end
decl_stmt|;
if|if
condition|(
name|idesc
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|usbd_interface2device_handle
argument_list|(
name|ifc
argument_list|,
operator|&
name|dev
argument_list|)
expr_stmt|;
name|cdesc
operator|=
name|usbd_get_config_descriptor
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|p
operator|=
operator|(
name|char
operator|*
operator|)
name|idesc
operator|+
name|idesc
operator|->
name|bLength
expr_stmt|;
name|end
operator|=
operator|(
name|char
operator|*
operator|)
name|cdesc
operator|+
name|UGETW
argument_list|(
name|cdesc
operator|->
name|wTotalLength
argument_list|)
expr_stmt|;
for|for
control|(
init|;
name|p
operator|<
name|end
condition|;
name|p
operator|+=
name|hd
operator|->
name|bLength
control|)
block|{
name|hd
operator|=
operator|(
name|usb_hid_descriptor_t
operator|*
operator|)
name|p
expr_stmt|;
if|if
condition|(
name|p
operator|+
name|hd
operator|->
name|bLength
operator|<=
name|end
operator|&&
name|hd
operator|->
name|bDescriptorType
operator|==
name|UDESC_HID
condition|)
return|return
operator|(
name|hd
operator|)
return|;
if|if
condition|(
name|hd
operator|->
name|bDescriptorType
operator|==
name|UDESC_INTERFACE
condition|)
break|break;
block|}
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|usbd_read_report_desc
parameter_list|(
name|usbd_interface_handle
name|ifc
parameter_list|,
name|void
modifier|*
modifier|*
name|descp
parameter_list|,
name|int
modifier|*
name|sizep
parameter_list|,
name|struct
name|malloc_type
modifier|*
name|mem
parameter_list|)
block|{
name|usb_interface_descriptor_t
modifier|*
name|id
decl_stmt|;
name|usb_hid_descriptor_t
modifier|*
name|hid
decl_stmt|;
name|usbd_device_handle
name|dev
decl_stmt|;
name|usbd_status
name|err
decl_stmt|;
name|usbd_interface2device_handle
argument_list|(
name|ifc
argument_list|,
operator|&
name|dev
argument_list|)
expr_stmt|;
name|id
operator|=
name|usbd_get_interface_descriptor
argument_list|(
name|ifc
argument_list|)
expr_stmt|;
if|if
condition|(
name|id
operator|==
name|NULL
condition|)
return|return
operator|(
name|USBD_INVAL
operator|)
return|;
name|hid
operator|=
name|usbd_get_hid_descriptor
argument_list|(
name|ifc
argument_list|)
expr_stmt|;
if|if
condition|(
name|hid
operator|==
name|NULL
condition|)
return|return
operator|(
name|USBD_IOERROR
operator|)
return|;
operator|*
name|sizep
operator|=
name|UGETW
argument_list|(
name|hid
operator|->
name|descrs
index|[
literal|0
index|]
operator|.
name|wDescriptorLength
argument_list|)
expr_stmt|;
operator|*
name|descp
operator|=
name|malloc
argument_list|(
operator|*
name|sizep
argument_list|,
name|mem
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|descp
operator|==
name|NULL
condition|)
return|return
operator|(
name|USBD_NOMEM
operator|)
return|;
name|err
operator|=
name|usbd_get_report_descriptor
argument_list|(
name|dev
argument_list|,
name|id
operator|->
name|bInterfaceNumber
argument_list|,
operator|*
name|sizep
argument_list|,
operator|*
name|descp
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|free
argument_list|(
operator|*
name|descp
argument_list|,
name|mem
argument_list|)
expr_stmt|;
operator|*
name|descp
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
return|return
operator|(
name|USBD_NORMAL_COMPLETION
operator|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|usbd_get_config
parameter_list|(
name|usbd_device_handle
name|dev
parameter_list|,
name|u_int8_t
modifier|*
name|conf
parameter_list|)
block|{
name|usb_device_request_t
name|req
decl_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_READ_DEVICE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|UR_GET_CONFIG
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
operator|(
name|usbd_do_request
argument_list|(
name|dev
argument_list|,
operator|&
name|req
argument_list|,
name|conf
argument_list|)
operator|)
return|;
block|}
end_function

begin_function_decl
specifier|static
name|void
name|usbd_bulk_transfer_cb
parameter_list|(
name|usbd_xfer_handle
name|xfer
parameter_list|,
name|usbd_private_handle
name|priv
parameter_list|,
name|usbd_status
name|status
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|void
name|usbd_bulk_transfer_cb
parameter_list|(
name|usbd_xfer_handle
name|xfer
parameter_list|,
name|usbd_private_handle
name|priv
parameter_list|,
name|usbd_status
name|status
parameter_list|)
block|{
name|wakeup
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|usbd_status
name|usbd_bulk_transfer
parameter_list|(
name|usbd_xfer_handle
name|xfer
parameter_list|,
name|usbd_pipe_handle
name|pipe
parameter_list|,
name|u_int16_t
name|flags
parameter_list|,
name|u_int32_t
name|timeout
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|,
name|u_int32_t
modifier|*
name|size
parameter_list|,
name|char
modifier|*
name|lbl
parameter_list|)
block|{
name|usbd_status
name|err
decl_stmt|;
name|int
name|s
decl_stmt|,
name|error
decl_stmt|;
name|usbd_setup_xfer
argument_list|(
name|xfer
argument_list|,
name|pipe
argument_list|,
literal|0
argument_list|,
name|buf
argument_list|,
operator|*
name|size
argument_list|,
name|flags
argument_list|,
name|timeout
argument_list|,
name|usbd_bulk_transfer_cb
argument_list|)
expr_stmt|;
name|DPRINTFN
argument_list|(
literal|1
argument_list|,
operator|(
literal|"usbd_bulk_transfer: start transfer %d bytes\n"
operator|,
operator|*
name|size
operator|)
argument_list|)
expr_stmt|;
name|s
operator|=
name|splusb
argument_list|()
expr_stmt|;
comment|/* don't want callback until tsleep() */
name|err
operator|=
name|usbd_transfer
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|USBD_IN_PROGRESS
condition|)
block|{
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
name|error
operator|=
name|tsleep
argument_list|(
operator|(
name|caddr_t
operator|)
name|xfer
argument_list|,
name|PZERO
operator||
name|PCATCH
argument_list|,
name|lbl
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"usbd_bulk_transfer: tsleep=%d\n"
operator|,
name|error
operator|)
argument_list|)
expr_stmt|;
name|usbd_abort_pipe
argument_list|(
name|pipe
argument_list|)
expr_stmt|;
return|return
operator|(
name|USBD_INTERRUPTED
operator|)
return|;
block|}
name|usbd_get_xfer_status
argument_list|(
name|xfer
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|size
argument_list|,
operator|&
name|err
argument_list|)
expr_stmt|;
name|DPRINTFN
argument_list|(
literal|1
argument_list|,
operator|(
literal|"usbd_bulk_transfer: transferred %d\n"
operator|,
operator|*
name|size
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"usbd_bulk_transfer: error=%d\n"
operator|,
name|err
operator|)
argument_list|)
expr_stmt|;
name|usbd_clear_endpoint_stall
argument_list|(
name|pipe
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function_decl
specifier|static
name|void
name|usbd_intr_transfer_cb
parameter_list|(
name|usbd_xfer_handle
name|xfer
parameter_list|,
name|usbd_private_handle
name|priv
parameter_list|,
name|usbd_status
name|status
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|void
name|usbd_intr_transfer_cb
parameter_list|(
name|usbd_xfer_handle
name|xfer
parameter_list|,
name|usbd_private_handle
name|priv
parameter_list|,
name|usbd_status
name|status
parameter_list|)
block|{
name|wakeup
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|usbd_status
name|usbd_intr_transfer
parameter_list|(
name|usbd_xfer_handle
name|xfer
parameter_list|,
name|usbd_pipe_handle
name|pipe
parameter_list|,
name|u_int16_t
name|flags
parameter_list|,
name|u_int32_t
name|timeout
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|,
name|u_int32_t
modifier|*
name|size
parameter_list|,
name|char
modifier|*
name|lbl
parameter_list|)
block|{
name|usbd_status
name|err
decl_stmt|;
name|int
name|s
decl_stmt|,
name|error
decl_stmt|;
name|usbd_setup_xfer
argument_list|(
name|xfer
argument_list|,
name|pipe
argument_list|,
literal|0
argument_list|,
name|buf
argument_list|,
operator|*
name|size
argument_list|,
name|flags
argument_list|,
name|timeout
argument_list|,
name|usbd_intr_transfer_cb
argument_list|)
expr_stmt|;
name|DPRINTFN
argument_list|(
literal|1
argument_list|,
operator|(
literal|"usbd_intr_transfer: start transfer %d bytes\n"
operator|,
operator|*
name|size
operator|)
argument_list|)
expr_stmt|;
name|s
operator|=
name|splusb
argument_list|()
expr_stmt|;
comment|/* don't want callback until tsleep() */
name|err
operator|=
name|usbd_transfer
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|USBD_IN_PROGRESS
condition|)
block|{
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
name|error
operator|=
name|tsleep
argument_list|(
name|xfer
argument_list|,
name|PZERO
operator||
name|PCATCH
argument_list|,
name|lbl
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"usbd_intr_transfer: tsleep=%d\n"
operator|,
name|error
operator|)
argument_list|)
expr_stmt|;
name|usbd_abort_pipe
argument_list|(
name|pipe
argument_list|)
expr_stmt|;
return|return
operator|(
name|USBD_INTERRUPTED
operator|)
return|;
block|}
name|usbd_get_xfer_status
argument_list|(
name|xfer
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|size
argument_list|,
operator|&
name|err
argument_list|)
expr_stmt|;
name|DPRINTFN
argument_list|(
literal|1
argument_list|,
operator|(
literal|"usbd_intr_transfer: transferred %d\n"
operator|,
operator|*
name|size
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"usbd_intr_transfer: error=%d\n"
operator|,
name|err
operator|)
argument_list|)
expr_stmt|;
name|usbd_clear_endpoint_stall
argument_list|(
name|pipe
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
name|void
name|usb_detach_wait
parameter_list|(
name|device_t
name|dv
parameter_list|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"usb_detach_wait: waiting for %s\n"
operator|,
name|USBDEVPTRNAME
argument_list|(
name|dv
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tsleep
argument_list|(
name|dv
argument_list|,
name|PZERO
argument_list|,
literal|"usbdet"
argument_list|,
name|hz
operator|*
literal|60
argument_list|)
condition|)
name|printf
argument_list|(
literal|"usb_detach_wait: %s didn't detach\n"
argument_list|,
name|USBDEVPTRNAME
argument_list|(
name|dv
argument_list|)
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"usb_detach_wait: %s done\n"
operator|,
name|USBDEVPTRNAME
argument_list|(
name|dv
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|usb_detach_wakeup
parameter_list|(
name|device_t
name|dv
parameter_list|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"usb_detach_wakeup: for %s\n"
operator|,
name|USBDEVPTRNAME
argument_list|(
name|dv
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|wakeup
argument_list|(
name|dv
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|const
name|usb_descriptor_t
modifier|*
name|usb_find_desc
parameter_list|(
name|usbd_device_handle
name|dev
parameter_list|,
name|int
name|type
parameter_list|,
name|int
name|subtype
parameter_list|)
block|{
name|usbd_desc_iter_t
name|iter
decl_stmt|;
specifier|const
name|usb_descriptor_t
modifier|*
name|desc
decl_stmt|;
name|usb_desc_iter_init
argument_list|(
name|dev
argument_list|,
operator|&
name|iter
argument_list|)
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|desc
operator|=
name|usb_desc_iter_next
argument_list|(
operator|&
name|iter
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|desc
operator|||
operator|(
name|desc
operator|->
name|bDescriptorType
operator|==
name|type
operator|&&
operator|(
name|subtype
operator|==
name|USBD_SUBTYPE_ANY
operator|||
name|subtype
operator|==
name|desc
operator|->
name|bDescriptorSubtype
operator|)
operator|)
condition|)
break|break;
block|}
return|return
name|desc
return|;
block|}
end_function

end_unit


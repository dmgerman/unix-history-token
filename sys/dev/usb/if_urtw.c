begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2008 Weongyo Jeong<weongyo@FreeBSD.org>  *  * Permission to use, copy, modify, and distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES  * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF  * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR  * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES  * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN  * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF  * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|<sys/kdb.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<net/bpf.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_arp.h>
end_include

begin_include
include|#
directive|include
file|<net/ethernet.h>
end_include

begin_include
include|#
directive|include
file|<net/if_dl.h>
end_include

begin_include
include|#
directive|include
file|<net/if_media.h>
end_include

begin_include
include|#
directive|include
file|<net/if_types.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|INET
end_ifdef

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_systm.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_var.h>
end_include

begin_include
include|#
directive|include
file|<netinet/if_ether.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<net80211/ieee80211_var.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_regdomain.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_radiotap.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usbdi.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usbdi_util.h>
end_include

begin_include
include|#
directive|include
file|"usbdevs.h"
end_include

begin_include
include|#
directive|include
file|<dev/usb/if_urtwreg.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/if_urtwvar.h>
end_include

begin_expr_stmt
name|SYSCTL_NODE
argument_list|(
name|_hw_usb
argument_list|,
name|OID_AUTO
argument_list|,
name|urtw
argument_list|,
name|CTLFLAG_RW
argument_list|,
literal|0
argument_list|,
literal|"USB Realtek 8187L"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|URTW_DEBUG
end_ifdef

begin_decl_stmt
name|int
name|urtw_debug
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_hw_usb_urtw
argument_list|,
name|OID_AUTO
argument_list|,
name|debug
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|urtw_debug
argument_list|,
literal|0
argument_list|,
literal|"control debugging printfs"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"hw.usb.urtw.debug"
argument_list|,
operator|&
name|urtw_debug
argument_list|)
expr_stmt|;
end_expr_stmt

begin_enum
enum|enum
block|{
name|URTW_DEBUG_XMIT
init|=
literal|0x00000001
block|,
comment|/* basic xmit operation */
name|URTW_DEBUG_RECV
init|=
literal|0x00000002
block|,
comment|/* basic recv operation */
name|URTW_DEBUG_RESET
init|=
literal|0x00000004
block|,
comment|/* reset processing */
name|URTW_DEBUG_TX_PROC
init|=
literal|0x00000008
block|,
comment|/* tx ISR proc */
name|URTW_DEBUG_RX_PROC
init|=
literal|0x00000010
block|,
comment|/* rx ISR proc */
name|URTW_DEBUG_STATE
init|=
literal|0x00000020
block|,
comment|/* 802.11 state transitions */
name|URTW_DEBUG_STAT
init|=
literal|0x00000040
block|,
comment|/* statistic */
name|URTW_DEBUG_ANY
init|=
literal|0xffffffff
block|}
enum|;
end_enum

begin_define
define|#
directive|define
name|DPRINTF
parameter_list|(
name|sc
parameter_list|,
name|m
parameter_list|,
name|fmt
parameter_list|,
modifier|...
parameter_list|)
value|do {				\ 	if (sc->sc_debug& (m))					\ 		printf(fmt, __VA_ARGS__);			\ } while (0)
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|DPRINTF
parameter_list|(
name|sc
parameter_list|,
name|m
parameter_list|,
name|fmt
parameter_list|,
modifier|...
parameter_list|)
value|do {				\ 	(void) sc;						\ } while (0)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
name|int
name|urtw_preamble_mode
init|=
name|URTW_PREAMBLE_MODE_LONG
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_hw_usb_urtw
argument_list|,
name|OID_AUTO
argument_list|,
name|preamble_mode
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|urtw_preamble_mode
argument_list|,
literal|0
argument_list|,
literal|"set the preable mode (long or short)"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"hw.usb.urtw.preamble_mode"
argument_list|,
operator|&
name|urtw_preamble_mode
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* recognized device vendors/products */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|usb_devno
name|urtw_devs
index|[]
init|=
block|{
define|#
directive|define
name|URTW_DEV
parameter_list|(
name|v
parameter_list|,
name|p
parameter_list|)
value|{ USB_VENDOR_##v, USB_PRODUCT_##v##_##p }
name|URTW_DEV
argument_list|(
name|REALTEK
argument_list|,
name|RTL8187
argument_list|)
block|,
name|URTW_DEV
argument_list|(
argument|NETGEAR
argument_list|,
argument|WG111V2
argument_list|)
undef|#
directive|undef
name|URTW_DEV
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|urtw_read8_m
parameter_list|(
name|sc
parameter_list|,
name|val
parameter_list|,
name|data
parameter_list|)
value|do {			\ 	error = urtw_read8_c(sc, val, data);			\ 	if (error != 0)						\ 		goto fail;					\ } while (0)
end_define

begin_define
define|#
directive|define
name|urtw_write8_m
parameter_list|(
name|sc
parameter_list|,
name|val
parameter_list|,
name|data
parameter_list|)
value|do {			\ 	error = urtw_write8_c(sc, val, data);			\ 	if (error != 0)						\ 		goto fail;					\ } while (0)
end_define

begin_define
define|#
directive|define
name|urtw_read16_m
parameter_list|(
name|sc
parameter_list|,
name|val
parameter_list|,
name|data
parameter_list|)
value|do {			\ 	error = urtw_read16_c(sc, val, data);			\ 	if (error != 0)						\ 		goto fail;					\ } while (0)
end_define

begin_define
define|#
directive|define
name|urtw_write16_m
parameter_list|(
name|sc
parameter_list|,
name|val
parameter_list|,
name|data
parameter_list|)
value|do {			\ 	error = urtw_write16_c(sc, val, data);			\ 	if (error != 0)						\ 		goto fail;					\ } while (0)
end_define

begin_define
define|#
directive|define
name|urtw_read32_m
parameter_list|(
name|sc
parameter_list|,
name|val
parameter_list|,
name|data
parameter_list|)
value|do {			\ 	error = urtw_read32_c(sc, val, data);			\ 	if (error != 0)						\ 		goto fail;					\ } while (0)
end_define

begin_define
define|#
directive|define
name|urtw_write32_m
parameter_list|(
name|sc
parameter_list|,
name|val
parameter_list|,
name|data
parameter_list|)
value|do {			\ 	error = urtw_write32_c(sc, val, data);			\ 	if (error != 0)						\ 		goto fail;					\ } while (0)
end_define

begin_define
define|#
directive|define
name|urtw_8187_write_phy_ofdm
parameter_list|(
name|sc
parameter_list|,
name|val
parameter_list|,
name|data
parameter_list|)
value|do {		\ 	error = urtw_8187_write_phy_ofdm_c(sc, val, data);	\ 	if (error != 0)						\ 		goto fail;					\ } while (0)
end_define

begin_define
define|#
directive|define
name|urtw_8187_write_phy_cck
parameter_list|(
name|sc
parameter_list|,
name|val
parameter_list|,
name|data
parameter_list|)
value|do {		\ 	error = urtw_8187_write_phy_cck_c(sc, val, data);	\ 	if (error != 0)						\ 		goto fail;					\ } while (0)
end_define

begin_define
define|#
directive|define
name|urtw_8225_write
parameter_list|(
name|sc
parameter_list|,
name|val
parameter_list|,
name|data
parameter_list|)
value|do {			\ 	error = urtw_8225_write_c(sc, val, data);		\ 	if (error != 0)						\ 		goto fail;					\ } while (0)
end_define

begin_struct
struct|struct
name|urtw_pair
block|{
name|uint32_t
name|reg
decl_stmt|;
name|uint32_t
name|val
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|uint8_t
name|urtw_8225_agc
index|[]
init|=
block|{
literal|0x9e
block|,
literal|0x9e
block|,
literal|0x9e
block|,
literal|0x9e
block|,
literal|0x9e
block|,
literal|0x9e
block|,
literal|0x9e
block|,
literal|0x9e
block|,
literal|0x9d
block|,
literal|0x9c
block|,
literal|0x9b
block|,
literal|0x9a
block|,
literal|0x99
block|,
literal|0x98
block|,
literal|0x97
block|,
literal|0x96
block|,
literal|0x95
block|,
literal|0x94
block|,
literal|0x93
block|,
literal|0x92
block|,
literal|0x91
block|,
literal|0x90
block|,
literal|0x8f
block|,
literal|0x8e
block|,
literal|0x8d
block|,
literal|0x8c
block|,
literal|0x8b
block|,
literal|0x8a
block|,
literal|0x89
block|,
literal|0x88
block|,
literal|0x87
block|,
literal|0x86
block|,
literal|0x85
block|,
literal|0x84
block|,
literal|0x83
block|,
literal|0x82
block|,
literal|0x81
block|,
literal|0x80
block|,
literal|0x3f
block|,
literal|0x3e
block|,
literal|0x3d
block|,
literal|0x3c
block|,
literal|0x3b
block|,
literal|0x3a
block|,
literal|0x39
block|,
literal|0x38
block|,
literal|0x37
block|,
literal|0x36
block|,
literal|0x35
block|,
literal|0x34
block|,
literal|0x33
block|,
literal|0x32
block|,
literal|0x31
block|,
literal|0x30
block|,
literal|0x2f
block|,
literal|0x2e
block|,
literal|0x2d
block|,
literal|0x2c
block|,
literal|0x2b
block|,
literal|0x2a
block|,
literal|0x29
block|,
literal|0x28
block|,
literal|0x27
block|,
literal|0x26
block|,
literal|0x25
block|,
literal|0x24
block|,
literal|0x23
block|,
literal|0x22
block|,
literal|0x21
block|,
literal|0x20
block|,
literal|0x1f
block|,
literal|0x1e
block|,
literal|0x1d
block|,
literal|0x1c
block|,
literal|0x1b
block|,
literal|0x1a
block|,
literal|0x19
block|,
literal|0x18
block|,
literal|0x17
block|,
literal|0x16
block|,
literal|0x15
block|,
literal|0x14
block|,
literal|0x13
block|,
literal|0x12
block|,
literal|0x11
block|,
literal|0x10
block|,
literal|0x0f
block|,
literal|0x0e
block|,
literal|0x0d
block|,
literal|0x0c
block|,
literal|0x0b
block|,
literal|0x0a
block|,
literal|0x09
block|,
literal|0x08
block|,
literal|0x07
block|,
literal|0x06
block|,
literal|0x05
block|,
literal|0x04
block|,
literal|0x03
block|,
literal|0x02
block|,
literal|0x01
block|,
literal|0x01
block|,
literal|0x01
block|,
literal|0x01
block|,
literal|0x01
block|,
literal|0x01
block|,
literal|0x01
block|,
literal|0x01
block|,
literal|0x01
block|,
literal|0x01
block|,
literal|0x01
block|,
literal|0x01
block|,
literal|0x01
block|,
literal|0x01
block|,
literal|0x01
block|,
literal|0x01
block|,
literal|0x01
block|,
literal|0x01
block|,
literal|0x01
block|,
literal|0x01
block|,
literal|0x01
block|,
literal|0x01
block|,
literal|0x01
block|,
literal|0x01
block|,
literal|0x01
block|,
literal|0x01
block|,
literal|0x01
block|,
literal|0x01
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|uint32_t
name|urtw_8225_channel
index|[]
init|=
block|{
literal|0x0000
block|,
comment|/* dummy channel 0  */
literal|0x085c
block|,
comment|/* 1  */
literal|0x08dc
block|,
comment|/* 2  */
literal|0x095c
block|,
comment|/* 3  */
literal|0x09dc
block|,
comment|/* 4  */
literal|0x0a5c
block|,
comment|/* 5  */
literal|0x0adc
block|,
comment|/* 6  */
literal|0x0b5c
block|,
comment|/* 7  */
literal|0x0bdc
block|,
comment|/* 8  */
literal|0x0c5c
block|,
comment|/* 9  */
literal|0x0cdc
block|,
comment|/* 10  */
literal|0x0d5c
block|,
comment|/* 11  */
literal|0x0ddc
block|,
comment|/* 12  */
literal|0x0e5c
block|,
comment|/* 13  */
literal|0x0f72
block|,
comment|/* 14  */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|uint8_t
name|urtw_8225_gain
index|[]
init|=
block|{
literal|0x23
block|,
literal|0x88
block|,
literal|0x7c
block|,
literal|0xa5
block|,
comment|/* -82dbm  */
literal|0x23
block|,
literal|0x88
block|,
literal|0x7c
block|,
literal|0xb5
block|,
comment|/* -82dbm  */
literal|0x23
block|,
literal|0x88
block|,
literal|0x7c
block|,
literal|0xc5
block|,
comment|/* -82dbm  */
literal|0x33
block|,
literal|0x80
block|,
literal|0x79
block|,
literal|0xc5
block|,
comment|/* -78dbm  */
literal|0x43
block|,
literal|0x78
block|,
literal|0x76
block|,
literal|0xc5
block|,
comment|/* -74dbm  */
literal|0x53
block|,
literal|0x60
block|,
literal|0x73
block|,
literal|0xc5
block|,
comment|/* -70dbm  */
literal|0x63
block|,
literal|0x58
block|,
literal|0x70
block|,
literal|0xc5
block|,
comment|/* -66dbm  */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|urtw_pair
name|urtw_8225_rf_part1
index|[]
init|=
block|{
block|{
literal|0x00
block|,
literal|0x0067
block|}
block|,
block|{
literal|0x01
block|,
literal|0x0fe0
block|}
block|,
block|{
literal|0x02
block|,
literal|0x044d
block|}
block|,
block|{
literal|0x03
block|,
literal|0x0441
block|}
block|,
block|{
literal|0x04
block|,
literal|0x0486
block|}
block|,
block|{
literal|0x05
block|,
literal|0x0bc0
block|}
block|,
block|{
literal|0x06
block|,
literal|0x0ae6
block|}
block|,
block|{
literal|0x07
block|,
literal|0x082a
block|}
block|,
block|{
literal|0x08
block|,
literal|0x001f
block|}
block|,
block|{
literal|0x09
block|,
literal|0x0334
block|}
block|,
block|{
literal|0x0a
block|,
literal|0x0fd4
block|}
block|,
block|{
literal|0x0b
block|,
literal|0x0391
block|}
block|,
block|{
literal|0x0c
block|,
literal|0x0050
block|}
block|,
block|{
literal|0x0d
block|,
literal|0x06db
block|}
block|,
block|{
literal|0x0e
block|,
literal|0x0029
block|}
block|,
block|{
literal|0x0f
block|,
literal|0x0914
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|urtw_pair
name|urtw_8225_rf_part2
index|[]
init|=
block|{
block|{
literal|0x00
block|,
literal|0x01
block|}
block|,
block|{
literal|0x01
block|,
literal|0x02
block|}
block|,
block|{
literal|0x02
block|,
literal|0x42
block|}
block|,
block|{
literal|0x03
block|,
literal|0x00
block|}
block|,
block|{
literal|0x04
block|,
literal|0x00
block|}
block|,
block|{
literal|0x05
block|,
literal|0x00
block|}
block|,
block|{
literal|0x06
block|,
literal|0x40
block|}
block|,
block|{
literal|0x07
block|,
literal|0x00
block|}
block|,
block|{
literal|0x08
block|,
literal|0x40
block|}
block|,
block|{
literal|0x09
block|,
literal|0xfe
block|}
block|,
block|{
literal|0x0a
block|,
literal|0x09
block|}
block|,
block|{
literal|0x0b
block|,
literal|0x80
block|}
block|,
block|{
literal|0x0c
block|,
literal|0x01
block|}
block|,
block|{
literal|0x0e
block|,
literal|0xd3
block|}
block|,
block|{
literal|0x0f
block|,
literal|0x38
block|}
block|,
block|{
literal|0x10
block|,
literal|0x84
block|}
block|,
block|{
literal|0x11
block|,
literal|0x06
block|}
block|,
block|{
literal|0x12
block|,
literal|0x20
block|}
block|,
block|{
literal|0x13
block|,
literal|0x20
block|}
block|,
block|{
literal|0x14
block|,
literal|0x00
block|}
block|,
block|{
literal|0x15
block|,
literal|0x40
block|}
block|,
block|{
literal|0x16
block|,
literal|0x00
block|}
block|,
block|{
literal|0x17
block|,
literal|0x40
block|}
block|,
block|{
literal|0x18
block|,
literal|0xef
block|}
block|,
block|{
literal|0x19
block|,
literal|0x19
block|}
block|,
block|{
literal|0x1a
block|,
literal|0x20
block|}
block|,
block|{
literal|0x1b
block|,
literal|0x76
block|}
block|,
block|{
literal|0x1c
block|,
literal|0x04
block|}
block|,
block|{
literal|0x1e
block|,
literal|0x95
block|}
block|,
block|{
literal|0x1f
block|,
literal|0x75
block|}
block|,
block|{
literal|0x20
block|,
literal|0x1f
block|}
block|,
block|{
literal|0x21
block|,
literal|0x27
block|}
block|,
block|{
literal|0x22
block|,
literal|0x16
block|}
block|,
block|{
literal|0x24
block|,
literal|0x46
block|}
block|,
block|{
literal|0x25
block|,
literal|0x20
block|}
block|,
block|{
literal|0x26
block|,
literal|0x90
block|}
block|,
block|{
literal|0x27
block|,
literal|0x88
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|urtw_pair
name|urtw_8225_rf_part3
index|[]
init|=
block|{
block|{
literal|0x00
block|,
literal|0x98
block|}
block|,
block|{
literal|0x03
block|,
literal|0x20
block|}
block|,
block|{
literal|0x04
block|,
literal|0x7e
block|}
block|,
block|{
literal|0x05
block|,
literal|0x12
block|}
block|,
block|{
literal|0x06
block|,
literal|0xfc
block|}
block|,
block|{
literal|0x07
block|,
literal|0x78
block|}
block|,
block|{
literal|0x08
block|,
literal|0x2e
block|}
block|,
block|{
literal|0x10
block|,
literal|0x9b
block|}
block|,
block|{
literal|0x11
block|,
literal|0x88
block|}
block|,
block|{
literal|0x12
block|,
literal|0x47
block|}
block|,
block|{
literal|0x13
block|,
literal|0xd0
block|}
block|,
block|{
literal|0x19
block|,
literal|0x00
block|}
block|,
block|{
literal|0x1a
block|,
literal|0xa0
block|}
block|,
block|{
literal|0x1b
block|,
literal|0x08
block|}
block|,
block|{
literal|0x40
block|,
literal|0x86
block|}
block|,
block|{
literal|0x41
block|,
literal|0x8d
block|}
block|,
block|{
literal|0x42
block|,
literal|0x15
block|}
block|,
block|{
literal|0x43
block|,
literal|0x18
block|}
block|,
block|{
literal|0x44
block|,
literal|0x1f
block|}
block|,
block|{
literal|0x45
block|,
literal|0x1e
block|}
block|,
block|{
literal|0x46
block|,
literal|0x1a
block|}
block|,
block|{
literal|0x47
block|,
literal|0x15
block|}
block|,
block|{
literal|0x48
block|,
literal|0x10
block|}
block|,
block|{
literal|0x49
block|,
literal|0x0a
block|}
block|,
block|{
literal|0x4a
block|,
literal|0x05
block|}
block|,
block|{
literal|0x4b
block|,
literal|0x02
block|}
block|,
block|{
literal|0x4c
block|,
literal|0x05
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|uint16_t
name|urtw_8225_rxgain
index|[]
init|=
block|{
literal|0x0400
block|,
literal|0x0401
block|,
literal|0x0402
block|,
literal|0x0403
block|,
literal|0x0404
block|,
literal|0x0405
block|,
literal|0x0408
block|,
literal|0x0409
block|,
literal|0x040a
block|,
literal|0x040b
block|,
literal|0x0502
block|,
literal|0x0503
block|,
literal|0x0504
block|,
literal|0x0505
block|,
literal|0x0540
block|,
literal|0x0541
block|,
literal|0x0542
block|,
literal|0x0543
block|,
literal|0x0544
block|,
literal|0x0545
block|,
literal|0x0580
block|,
literal|0x0581
block|,
literal|0x0582
block|,
literal|0x0583
block|,
literal|0x0584
block|,
literal|0x0585
block|,
literal|0x0588
block|,
literal|0x0589
block|,
literal|0x058a
block|,
literal|0x058b
block|,
literal|0x0643
block|,
literal|0x0644
block|,
literal|0x0645
block|,
literal|0x0680
block|,
literal|0x0681
block|,
literal|0x0682
block|,
literal|0x0683
block|,
literal|0x0684
block|,
literal|0x0685
block|,
literal|0x0688
block|,
literal|0x0689
block|,
literal|0x068a
block|,
literal|0x068b
block|,
literal|0x068c
block|,
literal|0x0742
block|,
literal|0x0743
block|,
literal|0x0744
block|,
literal|0x0745
block|,
literal|0x0780
block|,
literal|0x0781
block|,
literal|0x0782
block|,
literal|0x0783
block|,
literal|0x0784
block|,
literal|0x0785
block|,
literal|0x0788
block|,
literal|0x0789
block|,
literal|0x078a
block|,
literal|0x078b
block|,
literal|0x078c
block|,
literal|0x078d
block|,
literal|0x0790
block|,
literal|0x0791
block|,
literal|0x0792
block|,
literal|0x0793
block|,
literal|0x0794
block|,
literal|0x0795
block|,
literal|0x0798
block|,
literal|0x0799
block|,
literal|0x079a
block|,
literal|0x079b
block|,
literal|0x079c
block|,
literal|0x079d
block|,
literal|0x07a0
block|,
literal|0x07a1
block|,
literal|0x07a2
block|,
literal|0x07a3
block|,
literal|0x07a4
block|,
literal|0x07a5
block|,
literal|0x07a8
block|,
literal|0x07a9
block|,
literal|0x07aa
block|,
literal|0x07ab
block|,
literal|0x07ac
block|,
literal|0x07ad
block|,
literal|0x07b0
block|,
literal|0x07b1
block|,
literal|0x07b2
block|,
literal|0x07b3
block|,
literal|0x07b4
block|,
literal|0x07b5
block|,
literal|0x07b8
block|,
literal|0x07b9
block|,
literal|0x07ba
block|,
literal|0x07bb
block|,
literal|0x07bb
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|uint8_t
name|urtw_8225_threshold
index|[]
init|=
block|{
literal|0x8d
block|,
literal|0x8d
block|,
literal|0x8d
block|,
literal|0x8d
block|,
literal|0x9d
block|,
literal|0xad
block|,
literal|0xbd
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|uint8_t
name|urtw_8225_tx_gain_cck_ofdm
index|[]
init|=
block|{
literal|0x02
block|,
literal|0x06
block|,
literal|0x0e
block|,
literal|0x1e
block|,
literal|0x3e
block|,
literal|0x7e
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|uint8_t
name|urtw_8225_txpwr_cck
index|[]
init|=
block|{
literal|0x18
block|,
literal|0x17
block|,
literal|0x15
block|,
literal|0x11
block|,
literal|0x0c
block|,
literal|0x08
block|,
literal|0x04
block|,
literal|0x02
block|,
literal|0x1b
block|,
literal|0x1a
block|,
literal|0x17
block|,
literal|0x13
block|,
literal|0x0e
block|,
literal|0x09
block|,
literal|0x04
block|,
literal|0x02
block|,
literal|0x1f
block|,
literal|0x1e
block|,
literal|0x1a
block|,
literal|0x15
block|,
literal|0x10
block|,
literal|0x0a
block|,
literal|0x05
block|,
literal|0x02
block|,
literal|0x22
block|,
literal|0x21
block|,
literal|0x1d
block|,
literal|0x18
block|,
literal|0x11
block|,
literal|0x0b
block|,
literal|0x06
block|,
literal|0x02
block|,
literal|0x26
block|,
literal|0x25
block|,
literal|0x21
block|,
literal|0x1b
block|,
literal|0x14
block|,
literal|0x0d
block|,
literal|0x06
block|,
literal|0x03
block|,
literal|0x2b
block|,
literal|0x2a
block|,
literal|0x25
block|,
literal|0x1e
block|,
literal|0x16
block|,
literal|0x0e
block|,
literal|0x07
block|,
literal|0x03
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|uint8_t
name|urtw_8225_txpwr_cck_ch14
index|[]
init|=
block|{
literal|0x18
block|,
literal|0x17
block|,
literal|0x15
block|,
literal|0x0c
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x1b
block|,
literal|0x1a
block|,
literal|0x17
block|,
literal|0x0e
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x1f
block|,
literal|0x1e
block|,
literal|0x1a
block|,
literal|0x0f
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x22
block|,
literal|0x21
block|,
literal|0x1d
block|,
literal|0x11
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x26
block|,
literal|0x25
block|,
literal|0x21
block|,
literal|0x13
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x2b
block|,
literal|0x2a
block|,
literal|0x25
block|,
literal|0x15
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|uint8_t
name|urtw_8225_txpwr_ofdm
index|[]
init|=
block|{
literal|0x80
block|,
literal|0x90
block|,
literal|0xa2
block|,
literal|0xb5
block|,
literal|0xcb
block|,
literal|0xe4
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|uint8_t
name|urtw_8225v2_gain_bg
index|[]
init|=
block|{
literal|0x23
block|,
literal|0x15
block|,
literal|0xa5
block|,
comment|/* -82-1dbm  */
literal|0x23
block|,
literal|0x15
block|,
literal|0xb5
block|,
comment|/* -82-2dbm  */
literal|0x23
block|,
literal|0x15
block|,
literal|0xc5
block|,
comment|/* -82-3dbm  */
literal|0x33
block|,
literal|0x15
block|,
literal|0xc5
block|,
comment|/* -78dbm  */
literal|0x43
block|,
literal|0x15
block|,
literal|0xc5
block|,
comment|/* -74dbm  */
literal|0x53
block|,
literal|0x15
block|,
literal|0xc5
block|,
comment|/* -70dbm  */
literal|0x63
block|,
literal|0x15
block|,
literal|0xc5
block|,
comment|/* -66dbm  */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|urtw_pair
name|urtw_8225v2_rf_part1
index|[]
init|=
block|{
block|{
literal|0x00
block|,
literal|0x02bf
block|}
block|,
block|{
literal|0x01
block|,
literal|0x0ee0
block|}
block|,
block|{
literal|0x02
block|,
literal|0x044d
block|}
block|,
block|{
literal|0x03
block|,
literal|0x0441
block|}
block|,
block|{
literal|0x04
block|,
literal|0x08c3
block|}
block|,
block|{
literal|0x05
block|,
literal|0x0c72
block|}
block|,
block|{
literal|0x06
block|,
literal|0x00e6
block|}
block|,
block|{
literal|0x07
block|,
literal|0x082a
block|}
block|,
block|{
literal|0x08
block|,
literal|0x003f
block|}
block|,
block|{
literal|0x09
block|,
literal|0x0335
block|}
block|,
block|{
literal|0x0a
block|,
literal|0x09d4
block|}
block|,
block|{
literal|0x0b
block|,
literal|0x07bb
block|}
block|,
block|{
literal|0x0c
block|,
literal|0x0850
block|}
block|,
block|{
literal|0x0d
block|,
literal|0x0cdf
block|}
block|,
block|{
literal|0x0e
block|,
literal|0x002b
block|}
block|,
block|{
literal|0x0f
block|,
literal|0x0114
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|urtw_pair
name|urtw_8225v2_rf_part2
index|[]
init|=
block|{
block|{
literal|0x00
block|,
literal|0x01
block|}
block|,
block|{
literal|0x01
block|,
literal|0x02
block|}
block|,
block|{
literal|0x02
block|,
literal|0x42
block|}
block|,
block|{
literal|0x03
block|,
literal|0x00
block|}
block|,
block|{
literal|0x04
block|,
literal|0x00
block|}
block|,
block|{
literal|0x05
block|,
literal|0x00
block|}
block|,
block|{
literal|0x06
block|,
literal|0x40
block|}
block|,
block|{
literal|0x07
block|,
literal|0x00
block|}
block|,
block|{
literal|0x08
block|,
literal|0x40
block|}
block|,
block|{
literal|0x09
block|,
literal|0xfe
block|}
block|,
block|{
literal|0x0a
block|,
literal|0x08
block|}
block|,
block|{
literal|0x0b
block|,
literal|0x80
block|}
block|,
block|{
literal|0x0c
block|,
literal|0x01
block|}
block|,
block|{
literal|0x0d
block|,
literal|0x43
block|}
block|,
block|{
literal|0x0e
block|,
literal|0xd3
block|}
block|,
block|{
literal|0x0f
block|,
literal|0x38
block|}
block|,
block|{
literal|0x10
block|,
literal|0x84
block|}
block|,
block|{
literal|0x11
block|,
literal|0x07
block|}
block|,
block|{
literal|0x12
block|,
literal|0x20
block|}
block|,
block|{
literal|0x13
block|,
literal|0x20
block|}
block|,
block|{
literal|0x14
block|,
literal|0x00
block|}
block|,
block|{
literal|0x15
block|,
literal|0x40
block|}
block|,
block|{
literal|0x16
block|,
literal|0x00
block|}
block|,
block|{
literal|0x17
block|,
literal|0x40
block|}
block|,
block|{
literal|0x18
block|,
literal|0xef
block|}
block|,
block|{
literal|0x19
block|,
literal|0x19
block|}
block|,
block|{
literal|0x1a
block|,
literal|0x20
block|}
block|,
block|{
literal|0x1b
block|,
literal|0x15
block|}
block|,
block|{
literal|0x1c
block|,
literal|0x04
block|}
block|,
block|{
literal|0x1d
block|,
literal|0xc5
block|}
block|,
block|{
literal|0x1e
block|,
literal|0x95
block|}
block|,
block|{
literal|0x1f
block|,
literal|0x75
block|}
block|,
block|{
literal|0x20
block|,
literal|0x1f
block|}
block|,
block|{
literal|0x21
block|,
literal|0x17
block|}
block|,
block|{
literal|0x22
block|,
literal|0x16
block|}
block|,
block|{
literal|0x23
block|,
literal|0x80
block|}
block|,
block|{
literal|0x24
block|,
literal|0x46
block|}
block|,
block|{
literal|0x25
block|,
literal|0x00
block|}
block|,
block|{
literal|0x26
block|,
literal|0x90
block|}
block|,
block|{
literal|0x27
block|,
literal|0x88
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|urtw_pair
name|urtw_8225v2_rf_part3
index|[]
init|=
block|{
block|{
literal|0x00
block|,
literal|0x98
block|}
block|,
block|{
literal|0x03
block|,
literal|0x20
block|}
block|,
block|{
literal|0x04
block|,
literal|0x7e
block|}
block|,
block|{
literal|0x05
block|,
literal|0x12
block|}
block|,
block|{
literal|0x06
block|,
literal|0xfc
block|}
block|,
block|{
literal|0x07
block|,
literal|0x78
block|}
block|,
block|{
literal|0x08
block|,
literal|0x2e
block|}
block|,
block|{
literal|0x09
block|,
literal|0x11
block|}
block|,
block|{
literal|0x0a
block|,
literal|0x17
block|}
block|,
block|{
literal|0x0b
block|,
literal|0x11
block|}
block|,
block|{
literal|0x10
block|,
literal|0x9b
block|}
block|,
block|{
literal|0x11
block|,
literal|0x88
block|}
block|,
block|{
literal|0x12
block|,
literal|0x47
block|}
block|,
block|{
literal|0x13
block|,
literal|0xd0
block|}
block|,
block|{
literal|0x19
block|,
literal|0x00
block|}
block|,
block|{
literal|0x1a
block|,
literal|0xa0
block|}
block|,
block|{
literal|0x1b
block|,
literal|0x08
block|}
block|,
block|{
literal|0x1d
block|,
literal|0x00
block|}
block|,
block|{
literal|0x40
block|,
literal|0x86
block|}
block|,
block|{
literal|0x41
block|,
literal|0x9d
block|}
block|,
block|{
literal|0x42
block|,
literal|0x15
block|}
block|,
block|{
literal|0x43
block|,
literal|0x18
block|}
block|,
block|{
literal|0x44
block|,
literal|0x36
block|}
block|,
block|{
literal|0x45
block|,
literal|0x35
block|}
block|,
block|{
literal|0x46
block|,
literal|0x2e
block|}
block|,
block|{
literal|0x47
block|,
literal|0x25
block|}
block|,
block|{
literal|0x48
block|,
literal|0x1c
block|}
block|,
block|{
literal|0x49
block|,
literal|0x12
block|}
block|,
block|{
literal|0x4a
block|,
literal|0x09
block|}
block|,
block|{
literal|0x4b
block|,
literal|0x04
block|}
block|,
block|{
literal|0x4c
block|,
literal|0x05
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|uint16_t
name|urtw_8225v2_rxgain
index|[]
init|=
block|{
literal|0x0000
block|,
literal|0x0001
block|,
literal|0x0002
block|,
literal|0x0003
block|,
literal|0x0004
block|,
literal|0x0005
block|,
literal|0x0008
block|,
literal|0x0009
block|,
literal|0x000a
block|,
literal|0x000b
block|,
literal|0x0102
block|,
literal|0x0103
block|,
literal|0x0104
block|,
literal|0x0105
block|,
literal|0x0140
block|,
literal|0x0141
block|,
literal|0x0142
block|,
literal|0x0143
block|,
literal|0x0144
block|,
literal|0x0145
block|,
literal|0x0180
block|,
literal|0x0181
block|,
literal|0x0182
block|,
literal|0x0183
block|,
literal|0x0184
block|,
literal|0x0185
block|,
literal|0x0188
block|,
literal|0x0189
block|,
literal|0x018a
block|,
literal|0x018b
block|,
literal|0x0243
block|,
literal|0x0244
block|,
literal|0x0245
block|,
literal|0x0280
block|,
literal|0x0281
block|,
literal|0x0282
block|,
literal|0x0283
block|,
literal|0x0284
block|,
literal|0x0285
block|,
literal|0x0288
block|,
literal|0x0289
block|,
literal|0x028a
block|,
literal|0x028b
block|,
literal|0x028c
block|,
literal|0x0342
block|,
literal|0x0343
block|,
literal|0x0344
block|,
literal|0x0345
block|,
literal|0x0380
block|,
literal|0x0381
block|,
literal|0x0382
block|,
literal|0x0383
block|,
literal|0x0384
block|,
literal|0x0385
block|,
literal|0x0388
block|,
literal|0x0389
block|,
literal|0x038a
block|,
literal|0x038b
block|,
literal|0x038c
block|,
literal|0x038d
block|,
literal|0x0390
block|,
literal|0x0391
block|,
literal|0x0392
block|,
literal|0x0393
block|,
literal|0x0394
block|,
literal|0x0395
block|,
literal|0x0398
block|,
literal|0x0399
block|,
literal|0x039a
block|,
literal|0x039b
block|,
literal|0x039c
block|,
literal|0x039d
block|,
literal|0x03a0
block|,
literal|0x03a1
block|,
literal|0x03a2
block|,
literal|0x03a3
block|,
literal|0x03a4
block|,
literal|0x03a5
block|,
literal|0x03a8
block|,
literal|0x03a9
block|,
literal|0x03aa
block|,
literal|0x03ab
block|,
literal|0x03ac
block|,
literal|0x03ad
block|,
literal|0x03b0
block|,
literal|0x03b1
block|,
literal|0x03b2
block|,
literal|0x03b3
block|,
literal|0x03b4
block|,
literal|0x03b5
block|,
literal|0x03b8
block|,
literal|0x03b9
block|,
literal|0x03ba
block|,
literal|0x03bb
block|,
literal|0x03bb
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|uint8_t
name|urtw_8225v2_tx_gain_cck_ofdm
index|[]
init|=
block|{
literal|0x00
block|,
literal|0x01
block|,
literal|0x02
block|,
literal|0x03
block|,
literal|0x04
block|,
literal|0x05
block|,
literal|0x06
block|,
literal|0x07
block|,
literal|0x08
block|,
literal|0x09
block|,
literal|0x0a
block|,
literal|0x0b
block|,
literal|0x0c
block|,
literal|0x0d
block|,
literal|0x0e
block|,
literal|0x0f
block|,
literal|0x10
block|,
literal|0x11
block|,
literal|0x12
block|,
literal|0x13
block|,
literal|0x14
block|,
literal|0x15
block|,
literal|0x16
block|,
literal|0x17
block|,
literal|0x18
block|,
literal|0x19
block|,
literal|0x1a
block|,
literal|0x1b
block|,
literal|0x1c
block|,
literal|0x1d
block|,
literal|0x1e
block|,
literal|0x1f
block|,
literal|0x20
block|,
literal|0x21
block|,
literal|0x22
block|,
literal|0x23
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|uint8_t
name|urtw_8225v2_txpwr_cck
index|[]
init|=
block|{
literal|0x36
block|,
literal|0x35
block|,
literal|0x2e
block|,
literal|0x25
block|,
literal|0x1c
block|,
literal|0x12
block|,
literal|0x09
block|,
literal|0x04
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|uint8_t
name|urtw_8225v2_txpwr_cck_ch14
index|[]
init|=
block|{
literal|0x36
block|,
literal|0x35
block|,
literal|0x2e
block|,
literal|0x1b
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|urtw_pair
name|urtw_ratetable
index|[]
init|=
block|{
block|{
literal|2
block|,
literal|0
block|}
block|,
block|{
literal|4
block|,
literal|1
block|}
block|,
block|{
literal|11
block|,
literal|2
block|}
block|,
block|{
literal|12
block|,
literal|4
block|}
block|,
block|{
literal|18
block|,
literal|5
block|}
block|,
block|{
literal|22
block|,
literal|3
block|}
block|,
block|{
literal|24
block|,
literal|6
block|}
block|,
block|{
literal|36
block|,
literal|7
block|}
block|,
block|{
literal|48
block|,
literal|8
block|}
block|,
block|{
literal|72
block|,
literal|9
block|}
block|,
block|{
literal|96
block|,
literal|10
block|}
block|,
block|{
literal|108
block|,
literal|11
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|struct
name|ieee80211vap
modifier|*
name|urtw_vap_create
parameter_list|(
name|struct
name|ieee80211com
modifier|*
parameter_list|,
specifier|const
name|char
name|name
index|[
name|IFNAMSIZ
index|]
parameter_list|,
name|int
name|unit
parameter_list|,
name|int
name|opmode
parameter_list|,
name|int
name|flags
parameter_list|,
specifier|const
name|uint8_t
name|bssid
index|[
name|IEEE80211_ADDR_LEN
index|]
parameter_list|,
specifier|const
name|uint8_t
name|mac
index|[
name|IEEE80211_ADDR_LEN
index|]
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtw_vap_delete
parameter_list|(
name|struct
name|ieee80211vap
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtw_init
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtw_stop
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|urtw_ioctl
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|,
name|u_long
parameter_list|,
name|caddr_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtw_start
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|urtw_alloc_rx_data_list
parameter_list|(
name|struct
name|urtw_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|urtw_alloc_tx_data_list
parameter_list|(
name|struct
name|urtw_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtw_free_data_list
parameter_list|(
name|struct
name|urtw_softc
modifier|*
parameter_list|,
name|usbd_pipe_handle
parameter_list|,
name|usbd_pipe_handle
parameter_list|,
name|struct
name|urtw_data
name|data
index|[]
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|urtw_raw_xmit
parameter_list|(
name|struct
name|ieee80211_node
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|,
specifier|const
name|struct
name|ieee80211_bpf_params
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtw_scan_start
parameter_list|(
name|struct
name|ieee80211com
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtw_scan_end
parameter_list|(
name|struct
name|ieee80211com
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtw_set_channel
parameter_list|(
name|struct
name|ieee80211com
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtw_update_mcast
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtw_rxeof
parameter_list|(
name|usbd_xfer_handle
parameter_list|,
name|usbd_private_handle
parameter_list|,
name|usbd_status
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|urtw_tx_start
parameter_list|(
name|struct
name|urtw_softc
modifier|*
parameter_list|,
name|struct
name|ieee80211_node
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtw_txeof_low
parameter_list|(
name|usbd_xfer_handle
parameter_list|,
name|usbd_private_handle
parameter_list|,
name|usbd_status
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtw_txeof_normal
parameter_list|(
name|usbd_xfer_handle
parameter_list|,
name|usbd_private_handle
parameter_list|,
name|usbd_status
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|urtw_newstate
parameter_list|(
name|struct
name|ieee80211vap
modifier|*
parameter_list|,
name|enum
name|ieee80211_state
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtw_ledtask
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtw_ledusbtask
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtw_ctxtask
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtw_task
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtw_watchdog
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtw_set_multi
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|urtw_isbmode
parameter_list|(
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
name|urtw_rate2rtl
parameter_list|(
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
name|urtw_rtl2rate
parameter_list|(
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|urtw_set_rate
parameter_list|(
name|struct
name|urtw_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|urtw_update_msr
parameter_list|(
name|struct
name|urtw_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|urtw_read8_c
parameter_list|(
name|struct
name|urtw_softc
modifier|*
parameter_list|,
name|int
parameter_list|,
name|uint8_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|urtw_read16_c
parameter_list|(
name|struct
name|urtw_softc
modifier|*
parameter_list|,
name|int
parameter_list|,
name|uint16_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|urtw_read32_c
parameter_list|(
name|struct
name|urtw_softc
modifier|*
parameter_list|,
name|int
parameter_list|,
name|uint32_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|urtw_write8_c
parameter_list|(
name|struct
name|urtw_softc
modifier|*
parameter_list|,
name|int
parameter_list|,
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|urtw_write16_c
parameter_list|(
name|struct
name|urtw_softc
modifier|*
parameter_list|,
name|int
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|urtw_write32_c
parameter_list|(
name|struct
name|urtw_softc
modifier|*
parameter_list|,
name|int
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|urtw_eprom_cs
parameter_list|(
name|struct
name|urtw_softc
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|urtw_eprom_ck
parameter_list|(
name|struct
name|urtw_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|urtw_eprom_sendbits
parameter_list|(
name|struct
name|urtw_softc
modifier|*
parameter_list|,
name|int16_t
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|urtw_eprom_read32
parameter_list|(
name|struct
name|urtw_softc
modifier|*
parameter_list|,
name|uint32_t
parameter_list|,
name|uint32_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|urtw_eprom_readbit
parameter_list|(
name|struct
name|urtw_softc
modifier|*
parameter_list|,
name|int16_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|urtw_eprom_writebit
parameter_list|(
name|struct
name|urtw_softc
modifier|*
parameter_list|,
name|int16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|urtw_get_macaddr
parameter_list|(
name|struct
name|urtw_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|urtw_get_txpwr
parameter_list|(
name|struct
name|urtw_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|urtw_get_rfchip
parameter_list|(
name|struct
name|urtw_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|urtw_led_init
parameter_list|(
name|struct
name|urtw_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|urtw_8185_rf_pins_enable
parameter_list|(
name|struct
name|urtw_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|urtw_8185_tx_antenna
parameter_list|(
name|struct
name|urtw_softc
modifier|*
parameter_list|,
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|urtw_8187_write_phy
parameter_list|(
name|struct
name|urtw_softc
modifier|*
parameter_list|,
name|uint8_t
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|urtw_8187_write_phy_ofdm_c
parameter_list|(
name|struct
name|urtw_softc
modifier|*
parameter_list|,
name|uint8_t
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|urtw_8187_write_phy_cck_c
parameter_list|(
name|struct
name|urtw_softc
modifier|*
parameter_list|,
name|uint8_t
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|urtw_8225_setgain
parameter_list|(
name|struct
name|urtw_softc
modifier|*
parameter_list|,
name|int16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|urtw_8225_usb_init
parameter_list|(
name|struct
name|urtw_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|urtw_8225_write_c
parameter_list|(
name|struct
name|urtw_softc
modifier|*
parameter_list|,
name|uint8_t
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|urtw_8225_write_s16
parameter_list|(
name|struct
name|urtw_softc
modifier|*
parameter_list|,
name|uint8_t
parameter_list|,
name|int
parameter_list|,
name|uint16_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|urtw_8225_read
parameter_list|(
name|struct
name|urtw_softc
modifier|*
parameter_list|,
name|uint8_t
parameter_list|,
name|uint32_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|urtw_8225_rf_init
parameter_list|(
name|struct
name|urtw_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|urtw_8225_rf_set_chan
parameter_list|(
name|struct
name|urtw_softc
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|urtw_8225_rf_set_sens
parameter_list|(
name|struct
name|urtw_softc
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|urtw_8225_set_txpwrlvl
parameter_list|(
name|struct
name|urtw_softc
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|urtw_8225v2_rf_init
parameter_list|(
name|struct
name|urtw_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|urtw_8225v2_rf_set_chan
parameter_list|(
name|struct
name|urtw_softc
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|urtw_8225v2_set_txpwrlvl
parameter_list|(
name|struct
name|urtw_softc
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|urtw_8225v2_setgain
parameter_list|(
name|struct
name|urtw_softc
modifier|*
parameter_list|,
name|int16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|urtw_8225_isv2
parameter_list|(
name|struct
name|urtw_softc
modifier|*
parameter_list|,
name|int
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|urtw_read8e
parameter_list|(
name|struct
name|urtw_softc
modifier|*
parameter_list|,
name|int
parameter_list|,
name|uint8_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|urtw_write8e
parameter_list|(
name|struct
name|urtw_softc
modifier|*
parameter_list|,
name|int
parameter_list|,
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|urtw_8180_set_anaparam
parameter_list|(
name|struct
name|urtw_softc
modifier|*
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|urtw_8185_set_anaparam2
parameter_list|(
name|struct
name|urtw_softc
modifier|*
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|urtw_open_pipes
parameter_list|(
name|struct
name|urtw_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|urtw_close_pipes
parameter_list|(
name|struct
name|urtw_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|urtw_intr_enable
parameter_list|(
name|struct
name|urtw_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|urtw_intr_disable
parameter_list|(
name|struct
name|urtw_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|urtw_reset
parameter_list|(
name|struct
name|urtw_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|urtw_led_on
parameter_list|(
name|struct
name|urtw_softc
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|urtw_led_ctl
parameter_list|(
name|struct
name|urtw_softc
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|urtw_led_blink
parameter_list|(
name|struct
name|urtw_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|urtw_led_mode0
parameter_list|(
name|struct
name|urtw_softc
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|urtw_led_mode1
parameter_list|(
name|struct
name|urtw_softc
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|urtw_led_mode2
parameter_list|(
name|struct
name|urtw_softc
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|urtw_led_mode3
parameter_list|(
name|struct
name|urtw_softc
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|urtw_rx_setconf
parameter_list|(
name|struct
name|urtw_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|urtw_rx_enable
parameter_list|(
name|struct
name|urtw_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usbd_status
name|urtw_tx_enable
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|int
name|urtw_match
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|usb_attach_arg
modifier|*
name|uaa
init|=
name|device_get_ivars
argument_list|(
name|dev
argument_list|)
decl_stmt|;
specifier|const
name|struct
name|usb_devno
modifier|*
name|ud
decl_stmt|;
if|if
condition|(
name|uaa
operator|->
name|iface
operator|!=
name|NULL
condition|)
return|return
name|UMATCH_NONE
return|;
name|ud
operator|=
name|usb_lookup
argument_list|(
name|urtw_devs
argument_list|,
name|uaa
operator|->
name|vendor
argument_list|,
name|uaa
operator|->
name|product
argument_list|)
expr_stmt|;
return|return
operator|(
name|ud
operator|!=
name|NULL
condition|?
name|UMATCH_VENDOR_PRODUCT
else|:
name|UMATCH_NONE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|urtw_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|struct
name|urtw_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|usb_attach_arg
modifier|*
name|uaa
init|=
name|device_get_ivars
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|uint8_t
name|bands
decl_stmt|;
name|uint32_t
name|data
decl_stmt|;
name|usbd_status
name|error
decl_stmt|;
name|sc
operator|->
name|sc_dev
operator|=
name|dev
expr_stmt|;
name|sc
operator|->
name|sc_udev
operator|=
name|uaa
operator|->
name|device
expr_stmt|;
ifdef|#
directive|ifdef
name|URTW_DEBUG
name|sc
operator|->
name|sc_debug
operator|=
name|urtw_debug
expr_stmt|;
endif|#
directive|endif
name|mtx_init
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|,
name|device_get_nameunit
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|MTX_NETWORK_LOCK
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
name|callout_init
argument_list|(
operator|&
name|sc
operator|->
name|sc_led_ch
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|callout_init
argument_list|(
operator|&
name|sc
operator|->
name|sc_watchdog_ch
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|usb_init_task
argument_list|(
operator|&
name|sc
operator|->
name|sc_ledtask
argument_list|,
name|urtw_ledusbtask
argument_list|,
name|sc
argument_list|)
expr_stmt|;
name|usb_init_task
argument_list|(
operator|&
name|sc
operator|->
name|sc_ctxtask
argument_list|,
name|urtw_ctxtask
argument_list|,
name|sc
argument_list|)
expr_stmt|;
name|usb_init_task
argument_list|(
operator|&
name|sc
operator|->
name|sc_task
argument_list|,
name|urtw_task
argument_list|,
name|sc
argument_list|)
expr_stmt|;
name|urtw_read32_m
argument_list|(
name|sc
argument_list|,
name|URTW_RX
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_epromtype
operator|=
operator|(
name|data
operator|&
name|URTW_RX_9356SEL
operator|)
condition|?
name|URTW_EEPROM_93C56
else|:
name|URTW_EEPROM_93C46
expr_stmt|;
name|error
operator|=
name|urtw_get_rfchip
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
name|error
operator|=
name|urtw_get_macaddr
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
name|error
operator|=
name|urtw_get_txpwr
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
name|error
operator|=
name|urtw_led_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
name|sc
operator|->
name|sc_rts_retry
operator|=
name|URTW_DEFAULT_RTS_RETRY
expr_stmt|;
name|sc
operator|->
name|sc_tx_retry
operator|=
name|URTW_DEFAULT_TX_RETRY
expr_stmt|;
name|sc
operator|->
name|sc_currate
operator|=
literal|3
expr_stmt|;
name|sc
operator|->
name|sc_preamble_mode
operator|=
name|urtw_preamble_mode
expr_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|sc_ifp
operator|=
name|if_alloc
argument_list|(
name|IFT_IEEE80211
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"can not allocate ifnet\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ENXIO
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|ifp
operator|->
name|if_softc
operator|=
name|sc
expr_stmt|;
name|if_initname
argument_list|(
name|ifp
argument_list|,
literal|"urtw"
argument_list|,
name|device_get_unit
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_flags
operator|=
name|IFF_BROADCAST
operator||
name|IFF_SIMPLEX
operator||
name|IFF_MULTICAST
operator||
name|IFF_NEEDSGIANT
expr_stmt|;
comment|/* USB stack is still under Giant lock */
name|ifp
operator|->
name|if_init
operator|=
name|urtw_init
expr_stmt|;
name|ifp
operator|->
name|if_ioctl
operator|=
name|urtw_ioctl
expr_stmt|;
name|ifp
operator|->
name|if_start
operator|=
name|urtw_start
expr_stmt|;
comment|/* XXX URTW_TX_DATA_LIST_COUNT */
name|IFQ_SET_MAXLEN
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|,
name|IFQ_MAXLEN
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_snd
operator|.
name|ifq_drv_maxlen
operator|=
name|IFQ_MAXLEN
expr_stmt|;
name|IFQ_SET_READY
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|)
expr_stmt|;
name|ic
operator|=
name|ifp
operator|->
name|if_l2com
expr_stmt|;
name|ic
operator|->
name|ic_ifp
operator|=
name|ifp
expr_stmt|;
name|ic
operator|->
name|ic_phytype
operator|=
name|IEEE80211_T_OFDM
expr_stmt|;
comment|/* not only, but not used */
name|ic
operator|->
name|ic_opmode
operator|=
name|IEEE80211_M_STA
expr_stmt|;
comment|/* default to BSS mode */
comment|/* set device capabilities */
name|ic
operator|->
name|ic_caps
operator|=
name|IEEE80211_C_STA
operator||
comment|/* station mode */
name|IEEE80211_C_MONITOR
operator||
comment|/* monitor mode supported */
name|IEEE80211_C_TXPMGT
operator||
comment|/* tx power management */
name|IEEE80211_C_SHPREAMBLE
operator||
comment|/* short preamble supported */
name|IEEE80211_C_SHSLOT
operator||
comment|/* short slot time supported */
name|IEEE80211_C_BGSCAN
operator||
comment|/* capable of bg scanning */
name|IEEE80211_C_WPA
expr_stmt|;
comment|/* 802.11i */
name|IEEE80211_ADDR_COPY
argument_list|(
name|ic
operator|->
name|ic_myaddr
argument_list|,
name|sc
operator|->
name|sc_bssid
argument_list|)
expr_stmt|;
name|bands
operator|=
literal|0
expr_stmt|;
name|setbit
argument_list|(
operator|&
name|bands
argument_list|,
name|IEEE80211_MODE_11B
argument_list|)
expr_stmt|;
name|setbit
argument_list|(
operator|&
name|bands
argument_list|,
name|IEEE80211_MODE_11G
argument_list|)
expr_stmt|;
name|ieee80211_init_channels
argument_list|(
name|ic
argument_list|,
name|NULL
argument_list|,
operator|&
name|bands
argument_list|)
expr_stmt|;
name|ieee80211_ifattach
argument_list|(
name|ic
argument_list|)
expr_stmt|;
name|ic
operator|->
name|ic_raw_xmit
operator|=
name|urtw_raw_xmit
expr_stmt|;
name|ic
operator|->
name|ic_scan_start
operator|=
name|urtw_scan_start
expr_stmt|;
name|ic
operator|->
name|ic_scan_end
operator|=
name|urtw_scan_end
expr_stmt|;
name|ic
operator|->
name|ic_set_channel
operator|=
name|urtw_set_channel
expr_stmt|;
name|ic
operator|->
name|ic_vap_create
operator|=
name|urtw_vap_create
expr_stmt|;
name|ic
operator|->
name|ic_vap_delete
operator|=
name|urtw_vap_delete
expr_stmt|;
name|ic
operator|->
name|ic_update_mcast
operator|=
name|urtw_update_mcast
expr_stmt|;
name|bpfattach
argument_list|(
name|ifp
argument_list|,
name|DLT_IEEE802_11_RADIO
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ieee80211_frame
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|sc_txtap
argument_list|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_rxtap_len
operator|=
sizeof|sizeof
name|sc
operator|->
name|sc_rxtap
expr_stmt|;
name|sc
operator|->
name|sc_rxtap
operator|.
name|wr_ihdr
operator|.
name|it_len
operator|=
name|htole16
argument_list|(
name|sc
operator|->
name|sc_rxtap_len
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_rxtap
operator|.
name|wr_ihdr
operator|.
name|it_present
operator|=
name|htole32
argument_list|(
name|URTW_RX_RADIOTAP_PRESENT
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_txtap_len
operator|=
sizeof|sizeof
name|sc
operator|->
name|sc_txtap
expr_stmt|;
name|sc
operator|->
name|sc_txtap
operator|.
name|wt_ihdr
operator|.
name|it_len
operator|=
name|htole16
argument_list|(
name|sc
operator|->
name|sc_txtap_len
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_txtap
operator|.
name|wt_ihdr
operator|.
name|it_present
operator|=
name|htole32
argument_list|(
name|URTW_TX_RADIOTAP_PRESENT
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|ieee80211_announce
argument_list|(
name|ic
argument_list|)
expr_stmt|;
name|usbd_add_drv_event
argument_list|(
name|USB_EVENT_DRIVER_ATTACH
argument_list|,
name|sc
operator|->
name|sc_udev
argument_list|,
name|sc
operator|->
name|sc_dev
argument_list|)
expr_stmt|;
name|fail
label|:
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|urtw_open_pipes
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|)
block|{
name|usbd_status
name|error
decl_stmt|;
comment|/* 	 * NB: there is no way to distinguish each pipes so we need to hardcode 	 * pipe numbers 	 */
comment|/* tx pipe - low priority packets  */
name|error
operator|=
name|usbd_open_pipe
argument_list|(
name|sc
operator|->
name|sc_iface
argument_list|,
literal|0x2
argument_list|,
name|USBD_EXCLUSIVE_USE
argument_list|,
operator|&
name|sc
operator|->
name|sc_txpipe_low
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not open Tx low pipe: %s\n"
argument_list|,
name|usbd_errstr
argument_list|(
name|error
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
comment|/* tx pipe - normal priority packets  */
name|error
operator|=
name|usbd_open_pipe
argument_list|(
name|sc
operator|->
name|sc_iface
argument_list|,
literal|0x3
argument_list|,
name|USBD_EXCLUSIVE_USE
argument_list|,
operator|&
name|sc
operator|->
name|sc_txpipe_normal
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not open Tx normal pipe: %s\n"
argument_list|,
name|usbd_errstr
argument_list|(
name|error
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
comment|/* rx pipe  */
name|error
operator|=
name|usbd_open_pipe
argument_list|(
name|sc
operator|->
name|sc_iface
argument_list|,
literal|0x81
argument_list|,
name|USBD_EXCLUSIVE_USE
argument_list|,
operator|&
name|sc
operator|->
name|sc_rxpipe
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not open Rx pipe: %s\n"
argument_list|,
name|usbd_errstr
argument_list|(
name|error
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|fail
label|:
operator|(
name|void
operator|)
name|urtw_close_pipes
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|urtw_close_pipes
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|)
block|{
name|usbd_status
name|error
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_rxpipe
operator|!=
name|NULL
condition|)
block|{
name|error
operator|=
name|usbd_close_pipe
argument_list|(
name|sc
operator|->
name|sc_rxpipe
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
name|sc
operator|->
name|sc_rxpipe
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|sc_txpipe_low
operator|!=
name|NULL
condition|)
block|{
name|error
operator|=
name|usbd_close_pipe
argument_list|(
name|sc
operator|->
name|sc_txpipe_low
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
name|sc
operator|->
name|sc_txpipe_low
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|sc_txpipe_normal
operator|!=
name|NULL
condition|)
block|{
name|error
operator|=
name|usbd_close_pipe
argument_list|(
name|sc
operator|->
name|sc_txpipe_normal
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
name|sc
operator|->
name|sc_txpipe_normal
operator|=
name|NULL
expr_stmt|;
block|}
name|fail
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|urtw_alloc_data_list
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|urtw_data
name|data
index|[]
parameter_list|,
name|int
name|ndata
parameter_list|,
name|int
name|maxsz
parameter_list|,
name|int
name|fillmbuf
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|error
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ndata
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|urtw_data
modifier|*
name|dp
init|=
operator|&
name|data
index|[
name|i
index|]
decl_stmt|;
name|dp
operator|->
name|sc
operator|=
name|sc
expr_stmt|;
name|dp
operator|->
name|xfer
operator|=
name|usbd_alloc_xfer
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|)
expr_stmt|;
if|if
condition|(
name|dp
operator|->
name|xfer
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not allocate xfer\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|fillmbuf
condition|)
block|{
name|dp
operator|->
name|m
operator|=
name|m_getcl
argument_list|(
name|M_DONTWAIT
argument_list|,
name|MT_DATA
argument_list|,
name|M_PKTHDR
argument_list|)
expr_stmt|;
if|if
condition|(
name|dp
operator|->
name|m
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not allocate rx mbuf\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|dp
operator|->
name|buf
operator|=
name|mtod
argument_list|(
name|dp
operator|->
name|m
argument_list|,
name|uint8_t
operator|*
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|dp
operator|->
name|m
operator|=
name|NULL
expr_stmt|;
name|dp
operator|->
name|buf
operator|=
name|usbd_alloc_buffer
argument_list|(
name|dp
operator|->
name|xfer
argument_list|,
name|maxsz
argument_list|)
expr_stmt|;
if|if
condition|(
name|dp
operator|->
name|buf
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not allocate buffer\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
operator|(
operator|(
name|unsigned
name|long
operator|)
name|dp
operator|->
name|buf
operator|)
operator|%
literal|4
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"warn: unaligned buffer %p\n"
argument_list|,
name|dp
operator|->
name|buf
argument_list|)
expr_stmt|;
block|}
name|dp
operator|->
name|ni
operator|=
name|NULL
expr_stmt|;
block|}
return|return
literal|0
return|;
name|fail
label|:
name|urtw_free_data_list
argument_list|(
name|sc
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|data
argument_list|,
name|ndata
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtw_free_data_list
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|,
name|usbd_pipe_handle
name|pipe1
parameter_list|,
name|usbd_pipe_handle
name|pipe2
parameter_list|,
name|struct
name|urtw_data
name|data
index|[]
parameter_list|,
name|int
name|ndata
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
comment|/* make sure no transfers are pending */
if|if
condition|(
name|pipe1
operator|!=
name|NULL
condition|)
name|usbd_abort_pipe
argument_list|(
name|pipe1
argument_list|)
expr_stmt|;
if|if
condition|(
name|pipe2
operator|!=
name|NULL
condition|)
name|usbd_abort_pipe
argument_list|(
name|pipe2
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ndata
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|urtw_data
modifier|*
name|dp
init|=
operator|&
name|data
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
name|dp
operator|->
name|xfer
operator|!=
name|NULL
condition|)
block|{
name|usbd_free_xfer
argument_list|(
name|dp
operator|->
name|xfer
argument_list|)
expr_stmt|;
name|dp
operator|->
name|xfer
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|dp
operator|->
name|m
operator|!=
name|NULL
condition|)
block|{
name|m_freem
argument_list|(
name|dp
operator|->
name|m
argument_list|)
expr_stmt|;
name|dp
operator|->
name|m
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|dp
operator|->
name|ni
operator|!=
name|NULL
condition|)
block|{
name|ieee80211_free_node
argument_list|(
name|dp
operator|->
name|ni
argument_list|)
expr_stmt|;
name|dp
operator|->
name|ni
operator|=
name|NULL
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|urtw_alloc_rx_data_list
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|)
block|{
return|return
name|urtw_alloc_data_list
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|sc_rxdata
argument_list|,
name|URTW_RX_DATA_LIST_COUNT
argument_list|,
name|MCLBYTES
argument_list|,
literal|1
comment|/* mbufs */
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtw_free_rx_data_list
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|)
block|{
name|urtw_free_data_list
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|sc_rxpipe
argument_list|,
name|NULL
argument_list|,
name|sc
operator|->
name|sc_rxdata
argument_list|,
name|URTW_RX_DATA_LIST_COUNT
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|urtw_alloc_tx_data_list
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|)
block|{
return|return
name|urtw_alloc_data_list
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|sc_txdata
argument_list|,
name|URTW_TX_DATA_LIST_COUNT
argument_list|,
name|URTW_TX_MAXSIZE
argument_list|,
literal|0
comment|/* no mbufs */
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtw_free_tx_data_list
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|)
block|{
name|urtw_free_data_list
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|sc_txpipe_low
argument_list|,
name|sc
operator|->
name|sc_txpipe_normal
argument_list|,
name|sc
operator|->
name|sc_txdata
argument_list|,
name|URTW_TX_DATA_LIST_COUNT
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|urtw_led_init
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|rev
decl_stmt|;
name|usbd_status
name|error
decl_stmt|;
name|urtw_read8_m
argument_list|(
name|sc
argument_list|,
name|URTW_PSR
argument_list|,
operator|&
name|sc
operator|->
name|sc_psr
argument_list|)
expr_stmt|;
name|error
operator|=
name|urtw_eprom_read32
argument_list|(
name|sc
argument_list|,
name|URTW_EPROM_SWREV
argument_list|,
operator|&
name|rev
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
switch|switch
condition|(
name|rev
operator|&
name|URTW_EPROM_CID_MASK
condition|)
block|{
case|case
name|URTW_EPROM_CID_ALPHA0
case|:
name|sc
operator|->
name|sc_strategy
operator|=
name|URTW_SW_LED_MODE1
expr_stmt|;
break|break;
case|case
name|URTW_EPROM_CID_SERCOMM_PS
case|:
name|sc
operator|->
name|sc_strategy
operator|=
name|URTW_SW_LED_MODE3
expr_stmt|;
break|break;
case|case
name|URTW_EPROM_CID_HW_LED
case|:
name|sc
operator|->
name|sc_strategy
operator|=
name|URTW_HW_LED
expr_stmt|;
break|break;
case|case
name|URTW_EPROM_CID_RSVD0
case|:
case|case
name|URTW_EPROM_CID_RSVD1
case|:
default|default:
name|sc
operator|->
name|sc_strategy
operator|=
name|URTW_SW_LED_MODE0
expr_stmt|;
break|break;
block|}
name|sc
operator|->
name|sc_gpio_ledpin
operator|=
name|URTW_LED_PIN_GPIO0
expr_stmt|;
name|fail
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/* XXX why we should allocalte memory buffer instead of using memory stack?  */
end_comment

begin_function
specifier|static
name|usbd_status
name|urtw_8225_write_s16
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|addr
parameter_list|,
name|int
name|index
parameter_list|,
name|uint16_t
modifier|*
name|data
parameter_list|)
block|{
name|uint8_t
modifier|*
name|buf
decl_stmt|;
name|uint16_t
name|data16
decl_stmt|;
name|usb_device_request_t
modifier|*
name|req
decl_stmt|;
name|usbd_status
name|error
init|=
literal|0
decl_stmt|;
name|data16
operator|=
operator|*
name|data
expr_stmt|;
name|req
operator|=
operator|(
name|usb_device_request_t
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|usb_device_request_t
argument_list|)
argument_list|,
name|M_80211_VAP
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not allocate a memory\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail0
goto|;
block|}
name|buf
operator|=
operator|(
name|uint8_t
operator|*
operator|)
name|malloc
argument_list|(
literal|2
argument_list|,
name|M_80211_VAP
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not allocate a memory\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
name|req
operator|->
name|bmRequestType
operator|=
name|UT_WRITE_VENDOR_DEVICE
expr_stmt|;
name|req
operator|->
name|bRequest
operator|=
name|URTW_8187_SETREGS_REQ
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|->
name|wValue
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|->
name|wIndex
argument_list|,
name|index
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|->
name|wLength
argument_list|,
sizeof|sizeof
argument_list|(
name|uint16_t
argument_list|)
argument_list|)
expr_stmt|;
name|buf
index|[
literal|0
index|]
operator|=
operator|(
name|data16
operator|&
literal|0x00ff
operator|)
expr_stmt|;
name|buf
index|[
literal|1
index|]
operator|=
operator|(
name|data16
operator|&
literal|0xff00
operator|)
operator|>>
literal|8
expr_stmt|;
name|error
operator|=
name|usbd_do_request
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
name|req
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|buf
argument_list|,
name|M_80211_VAP
argument_list|)
expr_stmt|;
name|fail1
label|:
name|free
argument_list|(
name|req
argument_list|,
name|M_80211_VAP
argument_list|)
expr_stmt|;
name|fail0
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|urtw_8225_read
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|addr
parameter_list|,
name|uint32_t
modifier|*
name|data
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int16_t
name|bit
decl_stmt|;
name|uint8_t
name|rlen
init|=
literal|12
decl_stmt|,
name|wlen
init|=
literal|6
decl_stmt|;
name|uint16_t
name|o1
decl_stmt|,
name|o2
decl_stmt|,
name|o3
decl_stmt|,
name|tmp
decl_stmt|;
name|uint32_t
name|d2w
init|=
operator|(
call|(
name|uint32_t
call|)
argument_list|(
name|addr
operator|&
literal|0x1f
argument_list|)
operator|)
operator|<<
literal|27
decl_stmt|;
name|uint32_t
name|mask
init|=
literal|0x80000000
decl_stmt|,
name|value
init|=
literal|0
decl_stmt|;
name|usbd_status
name|error
decl_stmt|;
name|urtw_read16_m
argument_list|(
name|sc
argument_list|,
name|URTW_RF_PINS_OUTPUT
argument_list|,
operator|&
name|o1
argument_list|)
expr_stmt|;
name|urtw_read16_m
argument_list|(
name|sc
argument_list|,
name|URTW_RF_PINS_ENABLE
argument_list|,
operator|&
name|o2
argument_list|)
expr_stmt|;
name|urtw_read16_m
argument_list|(
name|sc
argument_list|,
name|URTW_RF_PINS_SELECT
argument_list|,
operator|&
name|o3
argument_list|)
expr_stmt|;
name|urtw_write16_m
argument_list|(
name|sc
argument_list|,
name|URTW_RF_PINS_ENABLE
argument_list|,
name|o2
operator||
name|URTW_RF_PINS_MAGIC4
argument_list|)
expr_stmt|;
name|urtw_write16_m
argument_list|(
name|sc
argument_list|,
name|URTW_RF_PINS_SELECT
argument_list|,
name|o3
operator||
name|URTW_RF_PINS_MAGIC4
argument_list|)
expr_stmt|;
name|o1
operator|&=
operator|~
name|URTW_RF_PINS_MAGIC4
expr_stmt|;
name|urtw_write16_m
argument_list|(
name|sc
argument_list|,
name|URTW_RF_PINS_OUTPUT
argument_list|,
name|o1
operator||
name|URTW_BB_HOST_BANG_EN
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|5
argument_list|)
expr_stmt|;
name|urtw_write16_m
argument_list|(
name|sc
argument_list|,
name|URTW_RF_PINS_OUTPUT
argument_list|,
name|o1
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|5
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|wlen
operator|/
literal|2
operator|)
condition|;
name|i
operator|++
operator|,
name|mask
operator|=
name|mask
operator|>>
literal|1
control|)
block|{
name|bit
operator|=
operator|(
operator|(
name|d2w
operator|&
name|mask
operator|)
operator|!=
literal|0
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|urtw_write16_m
argument_list|(
name|sc
argument_list|,
name|URTW_RF_PINS_OUTPUT
argument_list|,
name|bit
operator||
name|o1
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|urtw_write16_m
argument_list|(
name|sc
argument_list|,
name|URTW_RF_PINS_OUTPUT
argument_list|,
name|bit
operator||
name|o1
operator||
name|URTW_BB_HOST_BANG_CLK
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|urtw_write16_m
argument_list|(
name|sc
argument_list|,
name|URTW_RF_PINS_OUTPUT
argument_list|,
name|bit
operator||
name|o1
operator||
name|URTW_BB_HOST_BANG_CLK
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|mask
operator|=
name|mask
operator|>>
literal|1
expr_stmt|;
if|if
condition|(
name|i
operator|==
literal|2
condition|)
break|break;
name|bit
operator|=
operator|(
operator|(
name|d2w
operator|&
name|mask
operator|)
operator|!=
literal|0
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|urtw_write16_m
argument_list|(
name|sc
argument_list|,
name|URTW_RF_PINS_OUTPUT
argument_list|,
name|bit
operator||
name|o1
operator||
name|URTW_BB_HOST_BANG_CLK
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|urtw_write16_m
argument_list|(
name|sc
argument_list|,
name|URTW_RF_PINS_OUTPUT
argument_list|,
name|bit
operator||
name|o1
operator||
name|URTW_BB_HOST_BANG_CLK
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|urtw_write16_m
argument_list|(
name|sc
argument_list|,
name|URTW_RF_PINS_OUTPUT
argument_list|,
name|bit
operator||
name|o1
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|urtw_write16_m
argument_list|(
name|sc
argument_list|,
name|URTW_RF_PINS_OUTPUT
argument_list|,
name|bit
operator||
name|o1
operator||
name|URTW_BB_HOST_BANG_RW
operator||
name|URTW_BB_HOST_BANG_CLK
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|urtw_write16_m
argument_list|(
name|sc
argument_list|,
name|URTW_RF_PINS_OUTPUT
argument_list|,
name|bit
operator||
name|o1
operator||
name|URTW_BB_HOST_BANG_RW
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|urtw_write16_m
argument_list|(
name|sc
argument_list|,
name|URTW_RF_PINS_OUTPUT
argument_list|,
name|o1
operator||
name|URTW_BB_HOST_BANG_RW
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|mask
operator|=
literal|0x800
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rlen
condition|;
name|i
operator|++
operator|,
name|mask
operator|=
name|mask
operator|>>
literal|1
control|)
block|{
name|urtw_write16_m
argument_list|(
name|sc
argument_list|,
name|URTW_RF_PINS_OUTPUT
argument_list|,
name|o1
operator||
name|URTW_BB_HOST_BANG_RW
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|urtw_write16_m
argument_list|(
name|sc
argument_list|,
name|URTW_RF_PINS_OUTPUT
argument_list|,
name|o1
operator||
name|URTW_BB_HOST_BANG_RW
operator||
name|URTW_BB_HOST_BANG_CLK
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|urtw_write16_m
argument_list|(
name|sc
argument_list|,
name|URTW_RF_PINS_OUTPUT
argument_list|,
name|o1
operator||
name|URTW_BB_HOST_BANG_RW
operator||
name|URTW_BB_HOST_BANG_CLK
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|urtw_write16_m
argument_list|(
name|sc
argument_list|,
name|URTW_RF_PINS_OUTPUT
argument_list|,
name|o1
operator||
name|URTW_BB_HOST_BANG_RW
operator||
name|URTW_BB_HOST_BANG_CLK
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|urtw_read16_m
argument_list|(
name|sc
argument_list|,
name|URTW_RF_PINS_INPUT
argument_list|,
operator|&
name|tmp
argument_list|)
expr_stmt|;
name|value
operator||=
operator|(
operator|(
name|tmp
operator|&
name|URTW_BB_HOST_BANG_CLK
operator|)
condition|?
name|mask
else|:
literal|0
operator|)
expr_stmt|;
name|urtw_write16_m
argument_list|(
name|sc
argument_list|,
name|URTW_RF_PINS_OUTPUT
argument_list|,
name|o1
operator||
name|URTW_BB_HOST_BANG_RW
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
name|urtw_write16_m
argument_list|(
name|sc
argument_list|,
name|URTW_RF_PINS_OUTPUT
argument_list|,
name|o1
operator||
name|URTW_BB_HOST_BANG_EN
operator||
name|URTW_BB_HOST_BANG_RW
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|urtw_write16_m
argument_list|(
name|sc
argument_list|,
name|URTW_RF_PINS_ENABLE
argument_list|,
name|o2
argument_list|)
expr_stmt|;
name|urtw_write16_m
argument_list|(
name|sc
argument_list|,
name|URTW_RF_PINS_SELECT
argument_list|,
name|o3
argument_list|)
expr_stmt|;
name|urtw_write16_m
argument_list|(
name|sc
argument_list|,
name|URTW_RF_PINS_OUTPUT
argument_list|,
name|URTW_RF_PINS_OUTPUT_MAGIC1
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|!=
name|NULL
condition|)
operator|*
name|data
operator|=
name|value
expr_stmt|;
name|fail
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|urtw_8225_write_c
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|addr
parameter_list|,
name|uint16_t
name|data
parameter_list|)
block|{
name|uint16_t
name|d80
decl_stmt|,
name|d82
decl_stmt|,
name|d84
decl_stmt|;
name|usbd_status
name|error
decl_stmt|;
name|urtw_read16_m
argument_list|(
name|sc
argument_list|,
name|URTW_RF_PINS_OUTPUT
argument_list|,
operator|&
name|d80
argument_list|)
expr_stmt|;
name|d80
operator|&=
name|URTW_RF_PINS_MAGIC1
expr_stmt|;
name|urtw_read16_m
argument_list|(
name|sc
argument_list|,
name|URTW_RF_PINS_ENABLE
argument_list|,
operator|&
name|d82
argument_list|)
expr_stmt|;
name|urtw_read16_m
argument_list|(
name|sc
argument_list|,
name|URTW_RF_PINS_SELECT
argument_list|,
operator|&
name|d84
argument_list|)
expr_stmt|;
name|d84
operator|&=
name|URTW_RF_PINS_MAGIC2
expr_stmt|;
name|urtw_write16_m
argument_list|(
name|sc
argument_list|,
name|URTW_RF_PINS_ENABLE
argument_list|,
name|d82
operator||
name|URTW_RF_PINS_MAGIC3
argument_list|)
expr_stmt|;
name|urtw_write16_m
argument_list|(
name|sc
argument_list|,
name|URTW_RF_PINS_SELECT
argument_list|,
name|d84
operator||
name|URTW_RF_PINS_MAGIC3
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|urtw_write16_m
argument_list|(
name|sc
argument_list|,
name|URTW_RF_PINS_OUTPUT
argument_list|,
name|d80
operator||
name|URTW_BB_HOST_BANG_EN
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|urtw_write16_m
argument_list|(
name|sc
argument_list|,
name|URTW_RF_PINS_OUTPUT
argument_list|,
name|d80
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|error
operator|=
name|urtw_8225_write_s16
argument_list|(
name|sc
argument_list|,
name|addr
argument_list|,
literal|0x8225
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
name|urtw_write16_m
argument_list|(
name|sc
argument_list|,
name|URTW_RF_PINS_OUTPUT
argument_list|,
name|d80
operator||
name|URTW_BB_HOST_BANG_EN
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|urtw_write16_m
argument_list|(
name|sc
argument_list|,
name|URTW_RF_PINS_OUTPUT
argument_list|,
name|d80
operator||
name|URTW_BB_HOST_BANG_EN
argument_list|)
expr_stmt|;
name|urtw_write16_m
argument_list|(
name|sc
argument_list|,
name|URTW_RF_PINS_SELECT
argument_list|,
name|d84
argument_list|)
expr_stmt|;
name|usbd_delay_ms
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|fail
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|urtw_8225_isv2
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|,
name|int
modifier|*
name|ret
parameter_list|)
block|{
name|uint32_t
name|data
decl_stmt|;
name|usbd_status
name|error
decl_stmt|;
operator|*
name|ret
operator|=
literal|1
expr_stmt|;
name|urtw_write16_m
argument_list|(
name|sc
argument_list|,
name|URTW_RF_PINS_OUTPUT
argument_list|,
name|URTW_RF_PINS_MAGIC5
argument_list|)
expr_stmt|;
name|urtw_write16_m
argument_list|(
name|sc
argument_list|,
name|URTW_RF_PINS_SELECT
argument_list|,
name|URTW_RF_PINS_MAGIC5
argument_list|)
expr_stmt|;
name|urtw_write16_m
argument_list|(
name|sc
argument_list|,
name|URTW_RF_PINS_ENABLE
argument_list|,
name|URTW_RF_PINS_MAGIC5
argument_list|)
expr_stmt|;
name|usbd_delay_ms
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
literal|500
argument_list|)
expr_stmt|;
name|urtw_8225_write
argument_list|(
name|sc
argument_list|,
name|URTW_8225_ADDR_0_MAGIC
argument_list|,
name|URTW_8225_ADDR_0_DATA_MAGIC1
argument_list|)
expr_stmt|;
name|error
operator|=
name|urtw_8225_read
argument_list|(
name|sc
argument_list|,
name|URTW_8225_ADDR_8_MAGIC
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|data
operator|!=
name|URTW_8225_ADDR_8_DATA_MAGIC1
condition|)
operator|*
name|ret
operator|=
literal|0
expr_stmt|;
else|else
block|{
name|error
operator|=
name|urtw_8225_read
argument_list|(
name|sc
argument_list|,
name|URTW_8225_ADDR_9_MAGIC
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|data
operator|!=
name|URTW_8225_ADDR_9_DATA_MAGIC1
condition|)
operator|*
name|ret
operator|=
literal|0
expr_stmt|;
block|}
name|urtw_8225_write
argument_list|(
name|sc
argument_list|,
name|URTW_8225_ADDR_0_MAGIC
argument_list|,
name|URTW_8225_ADDR_0_DATA_MAGIC2
argument_list|)
expr_stmt|;
name|fail
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|urtw_get_rfchip
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|uint32_t
name|data
decl_stmt|;
name|usbd_status
name|error
decl_stmt|;
name|error
operator|=
name|urtw_eprom_read32
argument_list|(
name|sc
argument_list|,
name|URTW_EPROM_RFCHIPID
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
switch|switch
condition|(
name|data
operator|&
literal|0xff
condition|)
block|{
case|case
name|URTW_EPROM_RFCHIPID_RTL8225U
case|:
name|error
operator|=
name|urtw_8225_isv2
argument_list|(
name|sc
argument_list|,
operator|&
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
name|sc
operator|->
name|sc_rf_init
operator|=
name|urtw_8225_rf_init
expr_stmt|;
name|sc
operator|->
name|sc_rf_set_sens
operator|=
name|urtw_8225_rf_set_sens
expr_stmt|;
name|sc
operator|->
name|sc_rf_set_chan
operator|=
name|urtw_8225_rf_set_chan
expr_stmt|;
block|}
else|else
block|{
name|sc
operator|->
name|sc_rf_init
operator|=
name|urtw_8225v2_rf_init
expr_stmt|;
name|sc
operator|->
name|sc_rf_set_chan
operator|=
name|urtw_8225v2_rf_set_chan
expr_stmt|;
block|}
name|sc
operator|->
name|sc_max_sens
operator|=
name|URTW_8225_RF_MAX_SENS
expr_stmt|;
name|sc
operator|->
name|sc_sens
operator|=
name|URTW_8225_RF_DEF_SENS
expr_stmt|;
break|break;
default|default:
name|panic
argument_list|(
literal|"unsupported RF chip %d\n"
argument_list|,
name|data
operator|&
literal|0xff
argument_list|)
expr_stmt|;
comment|/* never reach  */
block|}
name|fail
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|urtw_get_txpwr
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|uint32_t
name|data
decl_stmt|;
name|usbd_status
name|error
decl_stmt|;
name|error
operator|=
name|urtw_eprom_read32
argument_list|(
name|sc
argument_list|,
name|URTW_EPROM_TXPW_BASE
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
name|sc
operator|->
name|sc_txpwr_cck_base
operator|=
name|data
operator|&
literal|0xf
expr_stmt|;
name|sc
operator|->
name|sc_txpwr_ofdm_base
operator|=
operator|(
name|data
operator|>>
literal|4
operator|)
operator|&
literal|0xf
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
operator|,
name|j
operator|=
literal|0
init|;
name|i
operator|<
literal|6
condition|;
name|i
operator|+=
literal|2
operator|,
name|j
operator|++
control|)
block|{
name|error
operator|=
name|urtw_eprom_read32
argument_list|(
name|sc
argument_list|,
name|URTW_EPROM_TXPW0
operator|+
name|j
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
name|sc
operator|->
name|sc_txpwr_cck
index|[
name|i
index|]
operator|=
name|data
operator|&
literal|0xf
expr_stmt|;
name|sc
operator|->
name|sc_txpwr_cck
index|[
name|i
operator|+
literal|1
index|]
operator|=
operator|(
name|data
operator|&
literal|0xf00
operator|)
operator|>>
literal|8
expr_stmt|;
name|sc
operator|->
name|sc_txpwr_ofdm
index|[
name|i
index|]
operator|=
operator|(
name|data
operator|&
literal|0xf0
operator|)
operator|>>
literal|4
expr_stmt|;
name|sc
operator|->
name|sc_txpwr_ofdm
index|[
name|i
operator|+
literal|1
index|]
operator|=
operator|(
name|data
operator|&
literal|0xf000
operator|)
operator|>>
literal|12
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|1
operator|,
name|j
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|+=
literal|2
operator|,
name|j
operator|++
control|)
block|{
name|error
operator|=
name|urtw_eprom_read32
argument_list|(
name|sc
argument_list|,
name|URTW_EPROM_TXPW1
operator|+
name|j
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
name|sc
operator|->
name|sc_txpwr_cck
index|[
name|i
operator|+
literal|6
index|]
operator|=
name|data
operator|&
literal|0xf
expr_stmt|;
name|sc
operator|->
name|sc_txpwr_cck
index|[
name|i
operator|+
literal|6
operator|+
literal|1
index|]
operator|=
operator|(
name|data
operator|&
literal|0xf00
operator|)
operator|>>
literal|8
expr_stmt|;
name|sc
operator|->
name|sc_txpwr_ofdm
index|[
name|i
operator|+
literal|6
index|]
operator|=
operator|(
name|data
operator|&
literal|0xf0
operator|)
operator|>>
literal|4
expr_stmt|;
name|sc
operator|->
name|sc_txpwr_ofdm
index|[
name|i
operator|+
literal|6
operator|+
literal|1
index|]
operator|=
operator|(
name|data
operator|&
literal|0xf000
operator|)
operator|>>
literal|12
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|1
operator|,
name|j
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|+=
literal|2
operator|,
name|j
operator|++
control|)
block|{
name|error
operator|=
name|urtw_eprom_read32
argument_list|(
name|sc
argument_list|,
name|URTW_EPROM_TXPW2
operator|+
name|j
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
name|sc
operator|->
name|sc_txpwr_cck
index|[
name|i
operator|+
literal|6
operator|+
literal|4
index|]
operator|=
name|data
operator|&
literal|0xf
expr_stmt|;
name|sc
operator|->
name|sc_txpwr_cck
index|[
name|i
operator|+
literal|6
operator|+
literal|4
operator|+
literal|1
index|]
operator|=
operator|(
name|data
operator|&
literal|0xf00
operator|)
operator|>>
literal|8
expr_stmt|;
name|sc
operator|->
name|sc_txpwr_ofdm
index|[
name|i
operator|+
literal|6
operator|+
literal|4
index|]
operator|=
operator|(
name|data
operator|&
literal|0xf0
operator|)
operator|>>
literal|4
expr_stmt|;
name|sc
operator|->
name|sc_txpwr_ofdm
index|[
name|i
operator|+
literal|6
operator|+
literal|4
operator|+
literal|1
index|]
operator|=
operator|(
name|data
operator|&
literal|0xf000
operator|)
operator|>>
literal|12
expr_stmt|;
block|}
name|fail
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|urtw_get_macaddr
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|data
decl_stmt|;
name|usbd_status
name|error
decl_stmt|;
name|error
operator|=
name|urtw_eprom_read32
argument_list|(
name|sc
argument_list|,
name|URTW_EPROM_MACADDR
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
name|sc
operator|->
name|sc_bssid
index|[
literal|0
index|]
operator|=
name|data
operator|&
literal|0xff
expr_stmt|;
name|sc
operator|->
name|sc_bssid
index|[
literal|1
index|]
operator|=
operator|(
name|data
operator|&
literal|0xff00
operator|)
operator|>>
literal|8
expr_stmt|;
name|error
operator|=
name|urtw_eprom_read32
argument_list|(
name|sc
argument_list|,
name|URTW_EPROM_MACADDR
operator|+
literal|1
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
name|sc
operator|->
name|sc_bssid
index|[
literal|2
index|]
operator|=
name|data
operator|&
literal|0xff
expr_stmt|;
name|sc
operator|->
name|sc_bssid
index|[
literal|3
index|]
operator|=
operator|(
name|data
operator|&
literal|0xff00
operator|)
operator|>>
literal|8
expr_stmt|;
name|error
operator|=
name|urtw_eprom_read32
argument_list|(
name|sc
argument_list|,
name|URTW_EPROM_MACADDR
operator|+
literal|2
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
name|sc
operator|->
name|sc_bssid
index|[
literal|4
index|]
operator|=
name|data
operator|&
literal|0xff
expr_stmt|;
name|sc
operator|->
name|sc_bssid
index|[
literal|5
index|]
operator|=
operator|(
name|data
operator|&
literal|0xff00
operator|)
operator|>>
literal|8
expr_stmt|;
name|fail
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|urtw_eprom_read32
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|addr
parameter_list|,
name|uint32_t
modifier|*
name|data
parameter_list|)
block|{
define|#
directive|define
name|URTW_READCMD_LEN
value|3
name|int
name|addrlen
decl_stmt|,
name|i
decl_stmt|;
name|int16_t
name|addrstr
index|[
literal|8
index|]
decl_stmt|,
name|data16
decl_stmt|,
name|readcmd
index|[]
init|=
block|{
literal|1
block|,
literal|1
block|,
literal|0
block|}
decl_stmt|;
name|usbd_status
name|error
decl_stmt|;
comment|/* NB: make sure the buffer is initialized  */
operator|*
name|data
operator|=
literal|0
expr_stmt|;
comment|/* enable EPROM programming */
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_EPROM_CMD
argument_list|,
name|URTW_EPROM_CMD_PROGRAM_MODE
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
name|URTW_EPROM_DELAY
argument_list|)
expr_stmt|;
name|error
operator|=
name|urtw_eprom_cs
argument_list|(
name|sc
argument_list|,
name|URTW_EPROM_ENABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
name|error
operator|=
name|urtw_eprom_ck
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
name|error
operator|=
name|urtw_eprom_sendbits
argument_list|(
name|sc
argument_list|,
name|readcmd
argument_list|,
name|URTW_READCMD_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|sc
operator|->
name|sc_epromtype
operator|==
name|URTW_EEPROM_93C56
condition|)
block|{
name|addrlen
operator|=
literal|8
expr_stmt|;
name|addrstr
index|[
literal|0
index|]
operator|=
name|addr
operator|&
operator|(
literal|1
operator|<<
literal|7
operator|)
expr_stmt|;
name|addrstr
index|[
literal|1
index|]
operator|=
name|addr
operator|&
operator|(
literal|1
operator|<<
literal|6
operator|)
expr_stmt|;
name|addrstr
index|[
literal|2
index|]
operator|=
name|addr
operator|&
operator|(
literal|1
operator|<<
literal|5
operator|)
expr_stmt|;
name|addrstr
index|[
literal|3
index|]
operator|=
name|addr
operator|&
operator|(
literal|1
operator|<<
literal|4
operator|)
expr_stmt|;
name|addrstr
index|[
literal|4
index|]
operator|=
name|addr
operator|&
operator|(
literal|1
operator|<<
literal|3
operator|)
expr_stmt|;
name|addrstr
index|[
literal|5
index|]
operator|=
name|addr
operator|&
operator|(
literal|1
operator|<<
literal|2
operator|)
expr_stmt|;
name|addrstr
index|[
literal|6
index|]
operator|=
name|addr
operator|&
operator|(
literal|1
operator|<<
literal|1
operator|)
expr_stmt|;
name|addrstr
index|[
literal|7
index|]
operator|=
name|addr
operator|&
operator|(
literal|1
operator|<<
literal|0
operator|)
expr_stmt|;
block|}
else|else
block|{
name|addrlen
operator|=
literal|6
expr_stmt|;
name|addrstr
index|[
literal|0
index|]
operator|=
name|addr
operator|&
operator|(
literal|1
operator|<<
literal|5
operator|)
expr_stmt|;
name|addrstr
index|[
literal|1
index|]
operator|=
name|addr
operator|&
operator|(
literal|1
operator|<<
literal|4
operator|)
expr_stmt|;
name|addrstr
index|[
literal|2
index|]
operator|=
name|addr
operator|&
operator|(
literal|1
operator|<<
literal|3
operator|)
expr_stmt|;
name|addrstr
index|[
literal|3
index|]
operator|=
name|addr
operator|&
operator|(
literal|1
operator|<<
literal|2
operator|)
expr_stmt|;
name|addrstr
index|[
literal|4
index|]
operator|=
name|addr
operator|&
operator|(
literal|1
operator|<<
literal|1
operator|)
expr_stmt|;
name|addrstr
index|[
literal|5
index|]
operator|=
name|addr
operator|&
operator|(
literal|1
operator|<<
literal|0
operator|)
expr_stmt|;
block|}
name|error
operator|=
name|urtw_eprom_sendbits
argument_list|(
name|sc
argument_list|,
name|addrstr
argument_list|,
name|addrlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
name|error
operator|=
name|urtw_eprom_writebit
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
block|{
name|error
operator|=
name|urtw_eprom_ck
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
name|error
operator|=
name|urtw_eprom_readbit
argument_list|(
name|sc
argument_list|,
operator|&
name|data16
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
operator|(
operator|*
name|data
operator|)
operator||=
operator|(
name|data16
operator|<<
operator|(
literal|15
operator|-
name|i
operator|)
operator|)
expr_stmt|;
block|}
name|error
operator|=
name|urtw_eprom_cs
argument_list|(
name|sc
argument_list|,
name|URTW_EPROM_DISABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
name|error
operator|=
name|urtw_eprom_ck
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
comment|/* now disable EPROM programming */
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_EPROM_CMD
argument_list|,
name|URTW_EPROM_CMD_NORMAL_MODE
argument_list|)
expr_stmt|;
name|fail
label|:
return|return
operator|(
name|error
operator|)
return|;
undef|#
directive|undef
name|URTW_READCMD_LEN
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|urtw_eprom_readbit
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|,
name|int16_t
modifier|*
name|data
parameter_list|)
block|{
name|uint8_t
name|data8
decl_stmt|;
name|usbd_status
name|error
decl_stmt|;
name|urtw_read8_m
argument_list|(
name|sc
argument_list|,
name|URTW_EPROM_CMD
argument_list|,
operator|&
name|data8
argument_list|)
expr_stmt|;
operator|*
name|data
operator|=
operator|(
name|data8
operator|&
name|URTW_EPROM_READBIT
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|DELAY
argument_list|(
name|URTW_EPROM_DELAY
argument_list|)
expr_stmt|;
name|fail
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|urtw_eprom_sendbits
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|,
name|int16_t
modifier|*
name|buf
parameter_list|,
name|int
name|buflen
parameter_list|)
block|{
name|int
name|i
init|=
literal|0
decl_stmt|;
name|usbd_status
name|error
init|=
literal|0
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|buflen
condition|;
name|i
operator|++
control|)
block|{
name|error
operator|=
name|urtw_eprom_writebit
argument_list|(
name|sc
argument_list|,
name|buf
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
name|error
operator|=
name|urtw_eprom_ck
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
block|}
name|fail
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|urtw_eprom_writebit
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|,
name|int16_t
name|bit
parameter_list|)
block|{
name|uint8_t
name|data
decl_stmt|;
name|usbd_status
name|error
decl_stmt|;
name|urtw_read8_m
argument_list|(
name|sc
argument_list|,
name|URTW_EPROM_CMD
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|bit
operator|!=
literal|0
condition|)
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_EPROM_CMD
argument_list|,
name|data
operator||
name|URTW_EPROM_WRITEBIT
argument_list|)
expr_stmt|;
else|else
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_EPROM_CMD
argument_list|,
name|data
operator|&
operator|~
name|URTW_EPROM_WRITEBIT
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
name|URTW_EPROM_DELAY
argument_list|)
expr_stmt|;
name|fail
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|urtw_eprom_ck
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint8_t
name|data
decl_stmt|;
name|usbd_status
name|error
decl_stmt|;
comment|/* masking  */
name|urtw_read8_m
argument_list|(
name|sc
argument_list|,
name|URTW_EPROM_CMD
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_EPROM_CMD
argument_list|,
name|data
operator||
name|URTW_EPROM_CK
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
name|URTW_EPROM_DELAY
argument_list|)
expr_stmt|;
comment|/* unmasking  */
name|urtw_read8_m
argument_list|(
name|sc
argument_list|,
name|URTW_EPROM_CMD
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_EPROM_CMD
argument_list|,
name|data
operator|&
operator|~
name|URTW_EPROM_CK
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
name|URTW_EPROM_DELAY
argument_list|)
expr_stmt|;
name|fail
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|urtw_eprom_cs
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|,
name|int
name|able
parameter_list|)
block|{
name|uint8_t
name|data
decl_stmt|;
name|usbd_status
name|error
decl_stmt|;
name|urtw_read8_m
argument_list|(
name|sc
argument_list|,
name|URTW_EPROM_CMD
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|able
operator|==
name|URTW_EPROM_ENABLE
condition|)
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_EPROM_CMD
argument_list|,
name|data
operator||
name|URTW_EPROM_CS
argument_list|)
expr_stmt|;
else|else
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_EPROM_CMD
argument_list|,
name|data
operator|&
operator|~
name|URTW_EPROM_CS
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
name|URTW_EPROM_DELAY
argument_list|)
expr_stmt|;
name|fail
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|urtw_read8_c
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|,
name|int
name|val
parameter_list|,
name|uint8_t
modifier|*
name|data
parameter_list|)
block|{
name|usb_device_request_t
name|req
decl_stmt|;
name|usbd_status
name|error
decl_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_READ_VENDOR_DEVICE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|URTW_8187_GETREGS_REQ
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
name|val
operator||
literal|0xff00
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
sizeof|sizeof
argument_list|(
name|uint8_t
argument_list|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|usbd_do_request
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
operator|&
name|req
argument_list|,
name|data
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|urtw_read8e
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|,
name|int
name|val
parameter_list|,
name|uint8_t
modifier|*
name|data
parameter_list|)
block|{
name|usb_device_request_t
name|req
decl_stmt|;
name|usbd_status
name|error
decl_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_READ_VENDOR_DEVICE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|URTW_8187_GETREGS_REQ
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
name|val
operator||
literal|0xfe00
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
sizeof|sizeof
argument_list|(
name|uint8_t
argument_list|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|usbd_do_request
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
operator|&
name|req
argument_list|,
name|data
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|urtw_read16_c
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|,
name|int
name|val
parameter_list|,
name|uint16_t
modifier|*
name|data
parameter_list|)
block|{
name|usb_device_request_t
name|req
decl_stmt|;
name|usbd_status
name|error
decl_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_READ_VENDOR_DEVICE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|URTW_8187_GETREGS_REQ
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
name|val
operator||
literal|0xff00
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
sizeof|sizeof
argument_list|(
name|uint16_t
argument_list|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|usbd_do_request
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
operator|&
name|req
argument_list|,
name|data
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|urtw_read32_c
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|,
name|int
name|val
parameter_list|,
name|uint32_t
modifier|*
name|data
parameter_list|)
block|{
name|usb_device_request_t
name|req
decl_stmt|;
name|usbd_status
name|error
decl_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_READ_VENDOR_DEVICE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|URTW_8187_GETREGS_REQ
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
name|val
operator||
literal|0xff00
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|usbd_do_request
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
operator|&
name|req
argument_list|,
name|data
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|urtw_write8_c
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|,
name|int
name|val
parameter_list|,
name|uint8_t
name|data
parameter_list|)
block|{
name|usb_device_request_t
name|req
decl_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_WRITE_VENDOR_DEVICE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|URTW_8187_SETREGS_REQ
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
name|val
operator||
literal|0xff00
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
sizeof|sizeof
argument_list|(
name|uint8_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|usbd_do_request
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
operator|&
name|req
argument_list|,
operator|&
name|data
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|urtw_write8e
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|,
name|int
name|val
parameter_list|,
name|uint8_t
name|data
parameter_list|)
block|{
name|usb_device_request_t
name|req
decl_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_WRITE_VENDOR_DEVICE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|URTW_8187_SETREGS_REQ
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
name|val
operator||
literal|0xfe00
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
sizeof|sizeof
argument_list|(
name|uint8_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|usbd_do_request
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
operator|&
name|req
argument_list|,
operator|&
name|data
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|urtw_write16_c
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|,
name|int
name|val
parameter_list|,
name|uint16_t
name|data
parameter_list|)
block|{
name|usb_device_request_t
name|req
decl_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_WRITE_VENDOR_DEVICE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|URTW_8187_SETREGS_REQ
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
name|val
operator||
literal|0xff00
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
sizeof|sizeof
argument_list|(
name|uint16_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|usbd_do_request
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
operator|&
name|req
argument_list|,
operator|&
name|data
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|urtw_write32_c
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|,
name|int
name|val
parameter_list|,
name|uint32_t
name|data
parameter_list|)
block|{
name|usb_device_request_t
name|req
decl_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_WRITE_VENDOR_DEVICE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|URTW_8187_SETREGS_REQ
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
name|val
operator||
literal|0xff00
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|usbd_do_request
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
operator|&
name|req
argument_list|,
operator|&
name|data
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|urtw_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|urtw_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|ifp
operator|->
name|if_l2com
decl_stmt|;
if|if
condition|(
operator|!
name|device_is_attached
argument_list|(
name|dev
argument_list|)
condition|)
return|return
literal|0
return|;
name|urtw_stop
argument_list|(
name|ifp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|callout_drain
argument_list|(
operator|&
name|sc
operator|->
name|sc_led_ch
argument_list|)
expr_stmt|;
name|callout_drain
argument_list|(
operator|&
name|sc
operator|->
name|sc_watchdog_ch
argument_list|)
expr_stmt|;
name|usb_rem_task
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
operator|&
name|sc
operator|->
name|sc_ledtask
argument_list|)
expr_stmt|;
name|usb_rem_task
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
operator|&
name|sc
operator|->
name|sc_ctxtask
argument_list|)
expr_stmt|;
name|usb_rem_task
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
operator|&
name|sc
operator|->
name|sc_task
argument_list|)
expr_stmt|;
comment|/* abort and free xfers */
name|urtw_free_tx_data_list
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|urtw_free_rx_data_list
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|urtw_close_pipes
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|bpfdetach
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|ieee80211_ifdetach
argument_list|(
name|ic
argument_list|)
expr_stmt|;
name|if_free
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|mtx_destroy
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
name|usbd_add_drv_event
argument_list|(
name|USB_EVENT_DRIVER_DETACH
argument_list|,
name|sc
operator|->
name|sc_udev
argument_list|,
name|sc
operator|->
name|sc_dev
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|ieee80211vap
modifier|*
name|urtw_vap_create
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|,
specifier|const
name|char
name|name
index|[
name|IFNAMSIZ
index|]
parameter_list|,
name|int
name|unit
parameter_list|,
name|int
name|opmode
parameter_list|,
name|int
name|flags
parameter_list|,
specifier|const
name|uint8_t
name|bssid
index|[
name|IEEE80211_ADDR_LEN
index|]
parameter_list|,
specifier|const
name|uint8_t
name|mac
index|[
name|IEEE80211_ADDR_LEN
index|]
parameter_list|)
block|{
name|struct
name|urtw_vap
modifier|*
name|uvp
decl_stmt|;
name|struct
name|ieee80211vap
modifier|*
name|vap
decl_stmt|;
if|if
condition|(
operator|!
name|TAILQ_EMPTY
argument_list|(
operator|&
name|ic
operator|->
name|ic_vaps
argument_list|)
condition|)
comment|/* only one at a time */
return|return
operator|(
name|NULL
operator|)
return|;
name|uvp
operator|=
operator|(
expr|struct
name|urtw_vap
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|urtw_vap
argument_list|)
argument_list|,
name|M_80211_VAP
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|uvp
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|vap
operator|=
operator|&
name|uvp
operator|->
name|vap
expr_stmt|;
comment|/* enable s/w bmiss handling for sta mode */
name|ieee80211_vap_setup
argument_list|(
name|ic
argument_list|,
name|vap
argument_list|,
name|name
argument_list|,
name|unit
argument_list|,
name|opmode
argument_list|,
name|flags
operator||
name|IEEE80211_CLONE_NOBEACONS
argument_list|,
name|bssid
argument_list|,
name|mac
argument_list|)
expr_stmt|;
comment|/* override state transition machine */
name|uvp
operator|->
name|newstate
operator|=
name|vap
operator|->
name|iv_newstate
expr_stmt|;
name|vap
operator|->
name|iv_newstate
operator|=
name|urtw_newstate
expr_stmt|;
comment|/* complete setup */
name|ieee80211_vap_attach
argument_list|(
name|vap
argument_list|,
name|ieee80211_media_change
argument_list|,
name|ieee80211_media_status
argument_list|)
expr_stmt|;
name|ic
operator|->
name|ic_opmode
operator|=
name|opmode
expr_stmt|;
return|return
operator|(
name|vap
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtw_vap_delete
parameter_list|(
name|struct
name|ieee80211vap
modifier|*
name|vap
parameter_list|)
block|{
name|struct
name|urtw_vap
modifier|*
name|uvp
init|=
name|URTW_VAP
argument_list|(
name|vap
argument_list|)
decl_stmt|;
name|ieee80211_vap_detach
argument_list|(
name|vap
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|uvp
argument_list|,
name|M_80211_VAP
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|urtw_set_mode
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|mode
parameter_list|)
block|{
name|uint8_t
name|data
decl_stmt|;
name|usbd_status
name|error
decl_stmt|;
name|urtw_read8_m
argument_list|(
name|sc
argument_list|,
name|URTW_EPROM_CMD
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
name|data
operator|=
operator|(
name|data
operator|&
operator|~
name|URTW_EPROM_CMD_MASK
operator|)
operator||
operator|(
name|mode
operator|<<
name|URTW_EPROM_CMD_SHIFT
operator|)
expr_stmt|;
name|data
operator|=
name|data
operator|&
operator|~
operator|(
name|URTW_EPROM_CS
operator||
name|URTW_EPROM_CK
operator|)
expr_stmt|;
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_EPROM_CMD
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|fail
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|urtw_8180_set_anaparam
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|val
parameter_list|)
block|{
name|uint8_t
name|data
decl_stmt|;
name|usbd_status
name|error
decl_stmt|;
name|error
operator|=
name|urtw_set_mode
argument_list|(
name|sc
argument_list|,
name|URTW_EPROM_CMD_CONFIG
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
name|urtw_read8_m
argument_list|(
name|sc
argument_list|,
name|URTW_CONFIG3
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_CONFIG3
argument_list|,
name|data
operator||
name|URTW_CONFIG3_ANAPARAM_WRITE
argument_list|)
expr_stmt|;
name|urtw_write32_m
argument_list|(
name|sc
argument_list|,
name|URTW_ANAPARAM
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|urtw_read8_m
argument_list|(
name|sc
argument_list|,
name|URTW_CONFIG3
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_CONFIG3
argument_list|,
name|data
operator|&
operator|~
name|URTW_CONFIG3_ANAPARAM_WRITE
argument_list|)
expr_stmt|;
name|error
operator|=
name|urtw_set_mode
argument_list|(
name|sc
argument_list|,
name|URTW_EPROM_CMD_NORMAL
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
name|fail
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|urtw_8185_set_anaparam2
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|val
parameter_list|)
block|{
name|uint8_t
name|data
decl_stmt|;
name|usbd_status
name|error
decl_stmt|;
name|error
operator|=
name|urtw_set_mode
argument_list|(
name|sc
argument_list|,
name|URTW_EPROM_CMD_CONFIG
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
name|urtw_read8_m
argument_list|(
name|sc
argument_list|,
name|URTW_CONFIG3
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_CONFIG3
argument_list|,
name|data
operator||
name|URTW_CONFIG3_ANAPARAM_WRITE
argument_list|)
expr_stmt|;
name|urtw_write32_m
argument_list|(
name|sc
argument_list|,
name|URTW_ANAPARAM2
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|urtw_read8_m
argument_list|(
name|sc
argument_list|,
name|URTW_CONFIG3
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_CONFIG3
argument_list|,
name|data
operator|&
operator|~
name|URTW_CONFIG3_ANAPARAM_WRITE
argument_list|)
expr_stmt|;
name|error
operator|=
name|urtw_set_mode
argument_list|(
name|sc
argument_list|,
name|URTW_EPROM_CMD_NORMAL
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
name|fail
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|urtw_intr_disable
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|)
block|{
name|usbd_status
name|error
decl_stmt|;
name|urtw_write16_m
argument_list|(
name|sc
argument_list|,
name|URTW_INTR_MASK
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fail
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|urtw_reset
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint8_t
name|data
decl_stmt|;
name|usbd_status
name|error
decl_stmt|;
name|error
operator|=
name|urtw_8180_set_anaparam
argument_list|(
name|sc
argument_list|,
name|URTW_8225_ANAPARAM_ON
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
name|error
operator|=
name|urtw_8185_set_anaparam2
argument_list|(
name|sc
argument_list|,
name|URTW_8225_ANAPARAM2_ON
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
name|error
operator|=
name|urtw_intr_disable
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
name|usbd_delay_ms
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
literal|100
argument_list|)
expr_stmt|;
name|error
operator|=
name|urtw_write8e
argument_list|(
name|sc
argument_list|,
literal|0x18
argument_list|,
literal|0x10
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
name|error
operator|=
name|urtw_write8e
argument_list|(
name|sc
argument_list|,
literal|0x18
argument_list|,
literal|0x11
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
name|error
operator|=
name|urtw_write8e
argument_list|(
name|sc
argument_list|,
literal|0x18
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
name|usbd_delay_ms
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
literal|100
argument_list|)
expr_stmt|;
name|urtw_read8_m
argument_list|(
name|sc
argument_list|,
name|URTW_CMD
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
name|data
operator|=
operator|(
name|data
operator|&
literal|0x2
operator|)
operator||
name|URTW_CMD_RST
expr_stmt|;
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_CMD
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|usbd_delay_ms
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
literal|100
argument_list|)
expr_stmt|;
name|urtw_read8_m
argument_list|(
name|sc
argument_list|,
name|URTW_CMD
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|&
name|URTW_CMD_RST
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"reset timeout\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|error
operator|=
name|urtw_set_mode
argument_list|(
name|sc
argument_list|,
name|URTW_EPROM_CMD_LOAD
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
name|usbd_delay_ms
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
literal|100
argument_list|)
expr_stmt|;
name|error
operator|=
name|urtw_8180_set_anaparam
argument_list|(
name|sc
argument_list|,
name|URTW_8225_ANAPARAM_ON
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
name|error
operator|=
name|urtw_8185_set_anaparam2
argument_list|(
name|sc
argument_list|,
name|URTW_8225_ANAPARAM2_ON
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
name|fail
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|urtw_led_on
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|,
name|int
name|type
parameter_list|)
block|{
name|usbd_status
name|error
decl_stmt|;
if|if
condition|(
name|type
operator|==
name|URTW_LED_GPIO
condition|)
block|{
switch|switch
condition|(
name|sc
operator|->
name|sc_gpio_ledpin
condition|)
block|{
case|case
name|URTW_LED_PIN_GPIO0
case|:
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_GPIO
argument_list|,
literal|0x01
argument_list|)
expr_stmt|;
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_GP_ENABLE
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
break|break;
default|default:
name|panic
argument_list|(
literal|"unsupported LED PIN type 0x%x"
argument_list|,
name|sc
operator|->
name|sc_gpio_ledpin
argument_list|)
expr_stmt|;
comment|/* never reach  */
block|}
block|}
else|else
block|{
name|panic
argument_list|(
literal|"unsupported LED type 0x%x"
argument_list|,
name|type
argument_list|)
expr_stmt|;
comment|/* never reach  */
block|}
name|sc
operator|->
name|sc_gpio_ledon
operator|=
literal|1
expr_stmt|;
name|fail
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|urtw_led_off
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|,
name|int
name|type
parameter_list|)
block|{
name|usbd_status
name|error
decl_stmt|;
if|if
condition|(
name|type
operator|==
name|URTW_LED_GPIO
condition|)
block|{
switch|switch
condition|(
name|sc
operator|->
name|sc_gpio_ledpin
condition|)
block|{
case|case
name|URTW_LED_PIN_GPIO0
case|:
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_GPIO
argument_list|,
name|URTW_GPIO_DATA_MAGIC1
argument_list|)
expr_stmt|;
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_GP_ENABLE
argument_list|,
name|URTW_GP_ENABLE_DATA_MAGIC1
argument_list|)
expr_stmt|;
break|break;
default|default:
name|panic
argument_list|(
literal|"unsupported LED PIN type 0x%x"
argument_list|,
name|sc
operator|->
name|sc_gpio_ledpin
argument_list|)
expr_stmt|;
comment|/* never reach  */
block|}
block|}
else|else
block|{
name|panic
argument_list|(
literal|"unsupported LED type 0x%x"
argument_list|,
name|type
argument_list|)
expr_stmt|;
comment|/* never reach  */
block|}
name|sc
operator|->
name|sc_gpio_ledon
operator|=
literal|0
expr_stmt|;
name|fail
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|urtw_led_mode0
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
switch|switch
condition|(
name|mode
condition|)
block|{
case|case
name|URTW_LED_CTL_POWER_ON
case|:
name|sc
operator|->
name|sc_gpio_ledstate
operator|=
name|URTW_LED_POWER_ON_BLINK
expr_stmt|;
break|break;
case|case
name|URTW_LED_CTL_TX
case|:
if|if
condition|(
name|sc
operator|->
name|sc_gpio_ledinprogress
operator|==
literal|1
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|sc
operator|->
name|sc_gpio_ledstate
operator|=
name|URTW_LED_BLINK_NORMAL
expr_stmt|;
name|sc
operator|->
name|sc_gpio_blinktime
operator|=
literal|2
expr_stmt|;
break|break;
case|case
name|URTW_LED_CTL_LINK
case|:
name|sc
operator|->
name|sc_gpio_ledstate
operator|=
name|URTW_LED_ON
expr_stmt|;
break|break;
default|default:
name|panic
argument_list|(
literal|"unsupported LED mode 0x%x"
argument_list|,
name|mode
argument_list|)
expr_stmt|;
comment|/* never reach  */
block|}
switch|switch
condition|(
name|sc
operator|->
name|sc_gpio_ledstate
condition|)
block|{
case|case
name|URTW_LED_ON
case|:
if|if
condition|(
name|sc
operator|->
name|sc_gpio_ledinprogress
operator|!=
literal|0
condition|)
break|break;
name|urtw_led_on
argument_list|(
name|sc
argument_list|,
name|URTW_LED_GPIO
argument_list|)
expr_stmt|;
break|break;
case|case
name|URTW_LED_BLINK_NORMAL
case|:
if|if
condition|(
name|sc
operator|->
name|sc_gpio_ledinprogress
operator|!=
literal|0
condition|)
break|break;
name|sc
operator|->
name|sc_gpio_ledinprogress
operator|=
literal|1
expr_stmt|;
name|sc
operator|->
name|sc_gpio_blinkstate
operator|=
operator|(
name|sc
operator|->
name|sc_gpio_ledon
operator|!=
literal|0
operator|)
condition|?
name|URTW_LED_OFF
else|:
name|URTW_LED_ON
expr_stmt|;
name|callout_reset
argument_list|(
operator|&
name|sc
operator|->
name|sc_led_ch
argument_list|,
name|hz
argument_list|,
name|urtw_ledtask
argument_list|,
name|sc
argument_list|)
expr_stmt|;
break|break;
case|case
name|URTW_LED_POWER_ON_BLINK
case|:
name|urtw_led_on
argument_list|(
name|sc
argument_list|,
name|URTW_LED_GPIO
argument_list|)
expr_stmt|;
name|usbd_delay_ms
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
literal|100
argument_list|)
expr_stmt|;
name|urtw_led_off
argument_list|(
name|sc
argument_list|,
name|URTW_LED_GPIO
argument_list|)
expr_stmt|;
break|break;
default|default:
name|panic
argument_list|(
literal|"unknown LED status 0x%x"
argument_list|,
name|sc
operator|->
name|sc_gpio_ledstate
argument_list|)
expr_stmt|;
comment|/* never reach  */
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|urtw_led_mode1
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
return|return
operator|(
name|USBD_INVAL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|urtw_led_mode2
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
return|return
operator|(
name|USBD_INVAL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|urtw_led_mode3
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
return|return
operator|(
name|USBD_INVAL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|urtw_led_blink
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint8_t
name|ing
init|=
literal|0
decl_stmt|;
name|usbd_status
name|error
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_gpio_blinkstate
operator|==
name|URTW_LED_ON
condition|)
name|error
operator|=
name|urtw_led_on
argument_list|(
name|sc
argument_list|,
name|URTW_LED_GPIO
argument_list|)
expr_stmt|;
else|else
name|error
operator|=
name|urtw_led_off
argument_list|(
name|sc
argument_list|,
name|URTW_LED_GPIO
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_gpio_blinktime
operator|--
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_gpio_blinktime
operator|==
literal|0
condition|)
name|ing
operator|=
literal|1
expr_stmt|;
else|else
block|{
if|if
condition|(
name|sc
operator|->
name|sc_gpio_ledstate
operator|!=
name|URTW_LED_BLINK_NORMAL
operator|&&
name|sc
operator|->
name|sc_gpio_ledstate
operator|!=
name|URTW_LED_BLINK_SLOWLY
operator|&&
name|sc
operator|->
name|sc_gpio_ledstate
operator|!=
name|URTW_LED_BLINK_CM3
condition|)
name|ing
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|ing
operator|==
literal|1
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|sc_gpio_ledstate
operator|==
name|URTW_LED_ON
operator|&&
name|sc
operator|->
name|sc_gpio_ledon
operator|==
literal|0
condition|)
name|error
operator|=
name|urtw_led_on
argument_list|(
name|sc
argument_list|,
name|URTW_LED_GPIO
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|sc
operator|->
name|sc_gpio_ledstate
operator|==
name|URTW_LED_OFF
operator|&&
name|sc
operator|->
name|sc_gpio_ledon
operator|==
literal|1
condition|)
name|error
operator|=
name|urtw_led_off
argument_list|(
name|sc
argument_list|,
name|URTW_LED_GPIO
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_gpio_blinktime
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_gpio_ledinprogress
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|sc
operator|->
name|sc_gpio_blinkstate
operator|=
operator|(
name|sc
operator|->
name|sc_gpio_blinkstate
operator|!=
name|URTW_LED_ON
operator|)
condition|?
name|URTW_LED_ON
else|:
name|URTW_LED_OFF
expr_stmt|;
switch|switch
condition|(
name|sc
operator|->
name|sc_gpio_ledstate
condition|)
block|{
case|case
name|URTW_LED_BLINK_NORMAL
case|:
name|callout_reset
argument_list|(
operator|&
name|sc
operator|->
name|sc_led_ch
argument_list|,
name|hz
argument_list|,
name|urtw_ledtask
argument_list|,
name|sc
argument_list|)
expr_stmt|;
break|break;
default|default:
name|panic
argument_list|(
literal|"unknown LED status 0x%x"
argument_list|,
name|sc
operator|->
name|sc_gpio_ledstate
argument_list|)
expr_stmt|;
comment|/* never reach  */
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtw_ledusbtask
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|urtw_softc
modifier|*
name|sc
init|=
name|arg
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_strategy
operator|!=
name|URTW_SW_LED_MODE0
condition|)
name|panic
argument_list|(
literal|"could not process a LED strategy 0x%x"
argument_list|,
name|sc
operator|->
name|sc_strategy
argument_list|)
expr_stmt|;
name|urtw_led_blink
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtw_ledtask
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|urtw_softc
modifier|*
name|sc
init|=
name|arg
decl_stmt|;
comment|/* 	 * NB: to change a status of the led we need at least a sleep so we 	 * can't do it here 	 */
name|usb_add_task
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
operator|&
name|sc
operator|->
name|sc_ledtask
argument_list|,
name|USB_TASKQ_DRIVER
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|urtw_led_ctl
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|usbd_status
name|error
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|sc
operator|->
name|sc_strategy
condition|)
block|{
case|case
name|URTW_SW_LED_MODE0
case|:
name|error
operator|=
name|urtw_led_mode0
argument_list|(
name|sc
argument_list|,
name|mode
argument_list|)
expr_stmt|;
break|break;
case|case
name|URTW_SW_LED_MODE1
case|:
name|error
operator|=
name|urtw_led_mode1
argument_list|(
name|sc
argument_list|,
name|mode
argument_list|)
expr_stmt|;
break|break;
case|case
name|URTW_SW_LED_MODE2
case|:
name|error
operator|=
name|urtw_led_mode2
argument_list|(
name|sc
argument_list|,
name|mode
argument_list|)
expr_stmt|;
break|break;
case|case
name|URTW_SW_LED_MODE3
case|:
name|error
operator|=
name|urtw_led_mode3
argument_list|(
name|sc
argument_list|,
name|mode
argument_list|)
expr_stmt|;
break|break;
default|default:
name|panic
argument_list|(
literal|"unsupported LED mode %d\n"
argument_list|,
name|sc
operator|->
name|sc_strategy
argument_list|)
expr_stmt|;
comment|/* never reach  */
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|urtw_update_msr
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|ifp
operator|->
name|if_l2com
decl_stmt|;
name|uint8_t
name|data
decl_stmt|;
name|usbd_status
name|error
decl_stmt|;
name|urtw_read8_m
argument_list|(
name|sc
argument_list|,
name|URTW_MSR
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
name|data
operator|&=
operator|~
name|URTW_MSR_LINK_MASK
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_state
operator|==
name|IEEE80211_S_RUN
condition|)
block|{
switch|switch
condition|(
name|ic
operator|->
name|ic_opmode
condition|)
block|{
case|case
name|IEEE80211_M_STA
case|:
case|case
name|IEEE80211_M_MONITOR
case|:
name|data
operator||=
name|URTW_MSR_LINK_STA
expr_stmt|;
break|break;
case|case
name|IEEE80211_M_IBSS
case|:
name|data
operator||=
name|URTW_MSR_LINK_ADHOC
expr_stmt|;
break|break;
case|case
name|IEEE80211_M_HOSTAP
case|:
name|data
operator||=
name|URTW_MSR_LINK_HOSTAP
expr_stmt|;
break|break;
default|default:
name|panic
argument_list|(
literal|"unsupported operation mode 0x%x\n"
argument_list|,
name|ic
operator|->
name|ic_opmode
argument_list|)
expr_stmt|;
comment|/* never reach  */
block|}
block|}
else|else
name|data
operator||=
name|URTW_MSR_LINK_NONE
expr_stmt|;
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_MSR
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|fail
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint16_t
name|urtw_rate2rtl
parameter_list|(
name|int
name|rate
parameter_list|)
block|{
define|#
directive|define
name|N
parameter_list|(
name|a
parameter_list|)
value|(sizeof(a) / sizeof((a)[0]))
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|N
argument_list|(
name|urtw_ratetable
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|rate
operator|==
name|urtw_ratetable
index|[
name|i
index|]
operator|.
name|reg
condition|)
return|return
name|urtw_ratetable
index|[
name|i
index|]
operator|.
name|val
return|;
block|}
return|return
operator|(
literal|3
operator|)
return|;
undef|#
directive|undef
name|N
block|}
end_function

begin_function
specifier|static
name|uint16_t
name|urtw_rtl2rate
parameter_list|(
name|int
name|rate
parameter_list|)
block|{
define|#
directive|define
name|N
parameter_list|(
name|a
parameter_list|)
value|(sizeof(a) / sizeof((a)[0]))
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|N
argument_list|(
name|urtw_ratetable
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|rate
operator|==
name|urtw_ratetable
index|[
name|i
index|]
operator|.
name|val
condition|)
return|return
name|urtw_ratetable
index|[
name|i
index|]
operator|.
name|reg
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
undef|#
directive|undef
name|N
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|urtw_set_rate
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|basic_rate
decl_stmt|,
name|min_rr_rate
decl_stmt|,
name|max_rr_rate
decl_stmt|;
name|uint16_t
name|data
decl_stmt|;
name|usbd_status
name|error
decl_stmt|;
name|basic_rate
operator|=
name|urtw_rate2rtl
argument_list|(
literal|48
argument_list|)
expr_stmt|;
name|min_rr_rate
operator|=
name|urtw_rate2rtl
argument_list|(
literal|12
argument_list|)
expr_stmt|;
name|max_rr_rate
operator|=
name|urtw_rate2rtl
argument_list|(
literal|48
argument_list|)
expr_stmt|;
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_RESP_RATE
argument_list|,
name|max_rr_rate
operator|<<
name|URTW_RESP_MAX_RATE_SHIFT
operator||
name|min_rr_rate
operator|<<
name|URTW_RESP_MIN_RATE_SHIFT
argument_list|)
expr_stmt|;
name|urtw_read16_m
argument_list|(
name|sc
argument_list|,
name|URTW_BRSR
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
name|data
operator|&=
operator|~
name|URTW_BRSR_MBR_8185
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
name|basic_rate
condition|;
name|i
operator|++
control|)
name|data
operator||=
operator|(
literal|1
operator|<<
name|i
operator|)
expr_stmt|;
name|urtw_write16_m
argument_list|(
name|sc
argument_list|,
name|URTW_BRSR
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|fail
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|urtw_intr_enable
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|)
block|{
name|usbd_status
name|error
decl_stmt|;
name|urtw_write16_m
argument_list|(
name|sc
argument_list|,
name|URTW_INTR_MASK
argument_list|,
literal|0xffff
argument_list|)
expr_stmt|;
name|fail
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|urtw_adapter_start
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|ifp
operator|->
name|if_l2com
decl_stmt|;
name|usbd_status
name|error
decl_stmt|;
name|error
operator|=
name|urtw_reset
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_ADDR_MAGIC1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_GPIO
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* for led  */
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_ADDR_MAGIC1
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|error
operator|=
name|urtw_led_ctl
argument_list|(
name|sc
argument_list|,
name|URTW_LED_CTL_POWER_ON
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
name|error
operator|=
name|urtw_set_mode
argument_list|(
name|sc
argument_list|,
name|URTW_EPROM_CMD_CONFIG
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
comment|/* applying MAC address again.  */
name|urtw_write32_m
argument_list|(
name|sc
argument_list|,
name|URTW_MAC0
argument_list|,
operator|(
operator|(
name|uint32_t
operator|*
operator|)
name|ic
operator|->
name|ic_myaddr
operator|)
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|urtw_write16_m
argument_list|(
name|sc
argument_list|,
name|URTW_MAC4
argument_list|,
operator|(
operator|(
name|uint32_t
operator|*
operator|)
name|ic
operator|->
name|ic_myaddr
operator|)
index|[
literal|1
index|]
operator|&
literal|0xffff
argument_list|)
expr_stmt|;
name|error
operator|=
name|urtw_set_mode
argument_list|(
name|sc
argument_list|,
name|URTW_EPROM_CMD_NORMAL
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
name|error
operator|=
name|urtw_update_msr
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
name|urtw_write32_m
argument_list|(
name|sc
argument_list|,
name|URTW_INT_TIMEOUT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_WPA_CONFIG
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_RATE_FALLBACK
argument_list|,
literal|0x81
argument_list|)
expr_stmt|;
name|error
operator|=
name|urtw_set_rate
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
name|error
operator|=
name|sc
operator|->
name|sc_rf_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|sc
operator|->
name|sc_rf_set_sens
operator|!=
name|NULL
condition|)
name|sc
operator|->
name|sc_rf_set_sens
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|sc_sens
argument_list|)
expr_stmt|;
comment|/* XXX correct? to call write16  */
name|urtw_write16_m
argument_list|(
name|sc
argument_list|,
name|URTW_PSR
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|urtw_write16_m
argument_list|(
name|sc
argument_list|,
name|URTW_ADDR_MAGIC2
argument_list|,
literal|0x10
argument_list|)
expr_stmt|;
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_TALLY_SEL
argument_list|,
literal|0x80
argument_list|)
expr_stmt|;
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_ADDR_MAGIC3
argument_list|,
literal|0x60
argument_list|)
expr_stmt|;
comment|/* XXX correct? to call write16  */
name|urtw_write16_m
argument_list|(
name|sc
argument_list|,
name|URTW_PSR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_ADDR_MAGIC1
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|error
operator|=
name|urtw_intr_enable
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
name|fail
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|urtw_rx_setconf
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|ifp
operator|->
name|if_l2com
decl_stmt|;
name|uint32_t
name|data
decl_stmt|;
name|usbd_status
name|error
decl_stmt|;
name|urtw_read32_m
argument_list|(
name|sc
argument_list|,
name|URTW_RX
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
name|data
operator|=
name|data
operator|&
operator|~
name|URTW_RX_FILTER_MASK
expr_stmt|;
if|#
directive|if
literal|0
block|data = data | URTW_RX_FILTER_CTL;
endif|#
directive|endif
name|data
operator|=
name|data
operator||
name|URTW_RX_FILTER_MNG
operator||
name|URTW_RX_FILTER_DATA
expr_stmt|;
name|data
operator|=
name|data
operator||
name|URTW_RX_FILTER_BCAST
operator||
name|URTW_RX_FILTER_MCAST
expr_stmt|;
if|if
condition|(
name|ic
operator|->
name|ic_opmode
operator|==
name|IEEE80211_M_MONITOR
condition|)
block|{
name|data
operator|=
name|data
operator||
name|URTW_RX_FILTER_ICVERR
expr_stmt|;
name|data
operator|=
name|data
operator||
name|URTW_RX_FILTER_PWR
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|sc_crcmon
operator|==
literal|1
operator|&&
name|ic
operator|->
name|ic_opmode
operator|==
name|IEEE80211_M_MONITOR
condition|)
name|data
operator|=
name|data
operator||
name|URTW_RX_FILTER_CRCERR
expr_stmt|;
if|if
condition|(
name|ic
operator|->
name|ic_opmode
operator|==
name|IEEE80211_M_MONITOR
operator|||
operator|(
name|ifp
operator|->
name|if_flags
operator|&
operator|(
name|IFF_ALLMULTI
operator||
name|IFF_PROMISC
operator|)
operator|)
condition|)
block|{
name|data
operator|=
name|data
operator||
name|URTW_RX_FILTER_ALLMAC
expr_stmt|;
block|}
else|else
block|{
name|data
operator|=
name|data
operator||
name|URTW_RX_FILTER_NICMAC
expr_stmt|;
name|data
operator|=
name|data
operator||
name|URTW_RX_CHECK_BSSID
expr_stmt|;
block|}
name|data
operator|=
name|data
operator|&
operator|~
name|URTW_RX_FIFO_THRESHOLD_MASK
expr_stmt|;
name|data
operator|=
name|data
operator||
name|URTW_RX_FIFO_THRESHOLD_NONE
operator||
name|URTW_RX_AUTORESETPHY
expr_stmt|;
name|data
operator|=
name|data
operator|&
operator|~
name|URTW_MAX_RX_DMA_MASK
expr_stmt|;
name|data
operator|=
name|data
operator||
name|URTW_MAX_RX_DMA_2048
operator||
name|URTW_RCR_ONLYERLPKT
expr_stmt|;
name|urtw_write32_m
argument_list|(
name|sc
argument_list|,
name|URTW_RX
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|fail
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|urtw_rx_enable
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|struct
name|urtw_data
modifier|*
name|rxdata
decl_stmt|;
name|uint8_t
name|data
decl_stmt|;
name|usbd_status
name|error
decl_stmt|;
comment|/* 	 * Start up the receive pipe. 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|URTW_RX_DATA_LIST_COUNT
condition|;
name|i
operator|++
control|)
block|{
name|rxdata
operator|=
operator|&
name|sc
operator|->
name|sc_rxdata
index|[
name|i
index|]
expr_stmt|;
name|usbd_setup_xfer
argument_list|(
name|rxdata
operator|->
name|xfer
argument_list|,
name|sc
operator|->
name|sc_rxpipe
argument_list|,
name|rxdata
argument_list|,
name|rxdata
operator|->
name|buf
argument_list|,
name|MCLBYTES
argument_list|,
name|USBD_SHORT_XFER_OK
argument_list|,
name|USBD_NO_TIMEOUT
argument_list|,
name|urtw_rxeof
argument_list|)
expr_stmt|;
name|error
operator|=
name|usbd_transfer
argument_list|(
name|rxdata
operator|->
name|xfer
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|USBD_IN_PROGRESS
operator|&&
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not queue Rx transfer\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
block|}
name|error
operator|=
name|urtw_rx_setconf
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
name|urtw_read8_m
argument_list|(
name|sc
argument_list|,
name|URTW_CMD
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_CMD
argument_list|,
name|data
operator||
name|URTW_CMD_RX_ENABLE
argument_list|)
expr_stmt|;
name|fail
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|urtw_tx_enable
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint8_t
name|data8
decl_stmt|;
name|uint32_t
name|data
decl_stmt|;
name|usbd_status
name|error
decl_stmt|;
name|urtw_read8_m
argument_list|(
name|sc
argument_list|,
name|URTW_CW_CONF
argument_list|,
operator|&
name|data8
argument_list|)
expr_stmt|;
name|data8
operator|&=
operator|~
operator|(
name|URTW_CW_CONF_PERPACKET_CW
operator||
name|URTW_CW_CONF_PERPACKET_RETRY
operator|)
expr_stmt|;
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_CW_CONF
argument_list|,
name|data8
argument_list|)
expr_stmt|;
name|urtw_read8_m
argument_list|(
name|sc
argument_list|,
name|URTW_TX_AGC_CTL
argument_list|,
operator|&
name|data8
argument_list|)
expr_stmt|;
name|data8
operator|&=
operator|~
name|URTW_TX_AGC_CTL_PERPACKET_GAIN
expr_stmt|;
name|data8
operator|&=
operator|~
name|URTW_TX_AGC_CTL_PERPACKET_ANTSEL
expr_stmt|;
name|data8
operator|&=
operator|~
name|URTW_TX_AGC_CTL_FEEDBACK_ANT
expr_stmt|;
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_TX_AGC_CTL
argument_list|,
name|data8
argument_list|)
expr_stmt|;
name|urtw_read32_m
argument_list|(
name|sc
argument_list|,
name|URTW_TX_CONF
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
name|data
operator|&=
operator|~
name|URTW_TX_LOOPBACK_MASK
expr_stmt|;
name|data
operator||=
name|URTW_TX_LOOPBACK_NONE
expr_stmt|;
name|data
operator|&=
operator|~
operator|(
name|URTW_TX_DPRETRY_MASK
operator||
name|URTW_TX_RTSRETRY_MASK
operator|)
expr_stmt|;
name|data
operator||=
name|sc
operator|->
name|sc_tx_retry
operator|<<
name|URTW_TX_DPRETRY_SHIFT
expr_stmt|;
name|data
operator||=
name|sc
operator|->
name|sc_rts_retry
operator|<<
name|URTW_TX_RTSRETRY_SHIFT
expr_stmt|;
name|data
operator|&=
operator|~
operator|(
name|URTW_TX_NOCRC
operator||
name|URTW_TX_MXDMA_MASK
operator|)
expr_stmt|;
name|data
operator||=
name|URTW_TX_MXDMA_2048
operator||
name|URTW_TX_CWMIN
operator||
name|URTW_TX_DISCW
expr_stmt|;
name|data
operator|&=
operator|~
name|URTW_TX_SWPLCPLEN
expr_stmt|;
name|data
operator||=
name|URTW_TX_NOICV
expr_stmt|;
name|urtw_write32_m
argument_list|(
name|sc
argument_list|,
name|URTW_TX_CONF
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|urtw_read8_m
argument_list|(
name|sc
argument_list|,
name|URTW_CMD
argument_list|,
operator|&
name|data8
argument_list|)
expr_stmt|;
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_CMD
argument_list|,
name|data8
operator||
name|URTW_CMD_TX_ENABLE
argument_list|)
expr_stmt|;
name|fail
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtw_init
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|struct
name|urtw_softc
modifier|*
name|sc
init|=
name|arg
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|usbd_status
name|error
decl_stmt|;
name|urtw_stop
argument_list|(
name|ifp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|error
operator|=
name|urtw_adapter_start
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
comment|/* reset softc variables  */
name|sc
operator|->
name|sc_txidx
operator|=
name|sc
operator|->
name|sc_tx_low_queued
operator|=
name|sc
operator|->
name|sc_tx_normal_queued
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_txtimer
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|URTW_INIT_ONCE
operator|)
condition|)
block|{
name|error
operator|=
name|usbd_set_config_no
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
name|URTW_CONFIG_NO
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not set configuration no\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
comment|/* get the first interface handle */
name|error
operator|=
name|usbd_device2interface_handle
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
name|URTW_IFACE_INDEX
argument_list|,
operator|&
name|sc
operator|->
name|sc_iface
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not get interface handle\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|error
operator|=
name|urtw_open_pipes
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
name|ret
operator|=
name|urtw_alloc_rx_data_list
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
name|ret
operator|=
name|urtw_alloc_tx_data_list
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
name|sc
operator|->
name|sc_flags
operator||=
name|URTW_INIT_ONCE
expr_stmt|;
block|}
name|error
operator|=
name|urtw_rx_enable
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
name|error
operator|=
name|urtw_tx_enable
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_OACTIVE
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator||=
name|IFF_DRV_RUNNING
expr_stmt|;
name|callout_reset
argument_list|(
operator|&
name|sc
operator|->
name|sc_watchdog_ch
argument_list|,
name|hz
argument_list|,
name|urtw_watchdog
argument_list|,
name|sc
argument_list|)
expr_stmt|;
name|fail
label|:
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|urtw_set_multi
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|urtw_softc
modifier|*
name|sc
init|=
name|arg
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_UP
operator|)
condition|)
return|return;
comment|/* 	 * XXX don't know how to set a device.  Lack of docs.  Just try to set 	 * IFF_ALLMULTI flag here. 	 */
name|IF_ADDR_LOCK
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_flags
operator||=
name|IFF_ALLMULTI
expr_stmt|;
name|IF_ADDR_UNLOCK
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|urtw_ioctl
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|u_long
name|cmd
parameter_list|,
name|caddr_t
name|data
parameter_list|)
block|{
name|struct
name|urtw_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|ifp
operator|->
name|if_l2com
decl_stmt|;
name|struct
name|ifreq
modifier|*
name|ifr
init|=
operator|(
expr|struct
name|ifreq
operator|*
operator|)
name|data
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|,
name|startall
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|SIOCSIFFLAGS
case|:
name|mtx_lock
argument_list|(
operator|&
name|Giant
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_UP
condition|)
block|{
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
block|{
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_flags
operator|^
name|sc
operator|->
name|sc_if_flags
operator|)
operator|&
operator|(
name|IFF_ALLMULTI
operator||
name|IFF_PROMISC
operator|)
condition|)
name|urtw_set_multi
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|urtw_init
argument_list|(
name|ifp
operator|->
name|if_softc
argument_list|)
expr_stmt|;
name|startall
operator|=
literal|1
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
name|urtw_stop
argument_list|(
name|ifp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|sc
operator|->
name|sc_if_flags
operator|=
name|ifp
operator|->
name|if_flags
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|Giant
argument_list|)
expr_stmt|;
if|if
condition|(
name|startall
condition|)
name|ieee80211_start_all
argument_list|(
name|ic
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCGIFMEDIA
case|:
name|error
operator|=
name|ifmedia_ioctl
argument_list|(
name|ifp
argument_list|,
name|ifr
argument_list|,
operator|&
name|ic
operator|->
name|ic_media
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCGIFADDR
case|:
name|error
operator|=
name|ether_ioctl
argument_list|(
name|ifp
argument_list|,
name|cmd
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
default|default:
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
return|return
name|error
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtw_start
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|struct
name|urtw_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|ieee80211_node
modifier|*
name|ni
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
operator|==
literal|0
condition|)
return|return;
name|URTW_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|IFQ_DRV_DEQUEUE
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
break|break;
if|if
condition|(
name|sc
operator|->
name|sc_tx_low_queued
operator|>=
name|URTW_TX_DATA_LIST_COUNT
operator|||
name|sc
operator|->
name|sc_tx_normal_queued
operator|>=
name|URTW_TX_DATA_LIST_COUNT
condition|)
block|{
name|IFQ_DRV_PREPEND
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator||=
name|IFF_DRV_OACTIVE
expr_stmt|;
break|break;
block|}
name|ni
operator|=
operator|(
expr|struct
name|ieee80211_node
operator|*
operator|)
name|m
operator|->
name|m_pkthdr
operator|.
name|rcvif
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|rcvif
operator|=
name|NULL
expr_stmt|;
name|m
operator|=
name|ieee80211_encap
argument_list|(
name|ni
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
block|{
name|ieee80211_free_node
argument_list|(
name|ni
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_oerrors
operator|++
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|urtw_tx_start
argument_list|(
name|sc
argument_list|,
name|ni
argument_list|,
name|m
argument_list|,
name|URTW_PRIORITY_NORMAL
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|ieee80211_free_node
argument_list|(
name|ni
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_oerrors
operator|++
expr_stmt|;
break|break;
block|}
name|sc
operator|->
name|sc_txtimer
operator|=
literal|5
expr_stmt|;
block|}
name|URTW_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtw_txeof_low
parameter_list|(
name|usbd_xfer_handle
name|xfer
parameter_list|,
name|usbd_private_handle
name|priv
parameter_list|,
name|usbd_status
name|status
parameter_list|)
block|{
name|struct
name|urtw_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
name|struct
name|urtw_softc
modifier|*
name|sc
init|=
name|data
operator|->
name|sc
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
if|if
condition|(
name|status
operator|!=
name|USBD_NORMAL_COMPLETION
condition|)
block|{
if|if
condition|(
name|status
operator|==
name|USBD_NOT_STARTED
operator|||
name|status
operator|==
name|USBD_CANCELLED
condition|)
return|return;
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not transmit buffer: %s\n"
argument_list|,
name|usbd_errstr
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|USBD_STALLED
condition|)
name|usbd_clear_endpoint_stall_async
argument_list|(
name|sc
operator|->
name|sc_txpipe_low
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_oerrors
operator|++
expr_stmt|;
return|return;
block|}
comment|/* 	 * Do any tx complete callback.  Note this must be done before releasing 	 * the node reference. 	 */
name|m
operator|=
name|data
operator|->
name|m
expr_stmt|;
if|if
condition|(
name|m
operator|!=
name|NULL
operator|&&
name|m
operator|->
name|m_flags
operator|&
name|M_TXCB
condition|)
block|{
name|ieee80211_process_callback
argument_list|(
name|data
operator|->
name|ni
argument_list|,
name|m
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* XXX status? */
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|data
operator|->
name|m
operator|=
name|NULL
expr_stmt|;
block|}
name|ieee80211_free_node
argument_list|(
name|data
operator|->
name|ni
argument_list|)
expr_stmt|;
name|data
operator|->
name|ni
operator|=
name|NULL
expr_stmt|;
name|sc
operator|->
name|sc_txtimer
operator|=
literal|0
expr_stmt|;
name|ifp
operator|->
name|if_opackets
operator|++
expr_stmt|;
name|URTW_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_tx_low_queued
operator|--
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_OACTIVE
expr_stmt|;
name|URTW_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|urtw_start
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtw_txeof_normal
parameter_list|(
name|usbd_xfer_handle
name|xfer
parameter_list|,
name|usbd_private_handle
name|priv
parameter_list|,
name|usbd_status
name|status
parameter_list|)
block|{
name|struct
name|urtw_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
name|struct
name|urtw_softc
modifier|*
name|sc
init|=
name|data
operator|->
name|sc
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
if|if
condition|(
name|status
operator|!=
name|USBD_NORMAL_COMPLETION
condition|)
block|{
if|if
condition|(
name|status
operator|==
name|USBD_NOT_STARTED
operator|||
name|status
operator|==
name|USBD_CANCELLED
condition|)
return|return;
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not transmit buffer: %s\n"
argument_list|,
name|usbd_errstr
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|USBD_STALLED
condition|)
name|usbd_clear_endpoint_stall_async
argument_list|(
name|sc
operator|->
name|sc_txpipe_normal
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_oerrors
operator|++
expr_stmt|;
return|return;
block|}
comment|/* 	 * Do any tx complete callback.  Note this must be done before releasing 	 * the node reference. 	 */
name|m
operator|=
name|data
operator|->
name|m
expr_stmt|;
if|if
condition|(
name|m
operator|!=
name|NULL
operator|&&
name|m
operator|->
name|m_flags
operator|&
name|M_TXCB
condition|)
block|{
name|ieee80211_process_callback
argument_list|(
name|data
operator|->
name|ni
argument_list|,
name|m
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* XXX status? */
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|data
operator|->
name|m
operator|=
name|NULL
expr_stmt|;
block|}
name|ieee80211_free_node
argument_list|(
name|data
operator|->
name|ni
argument_list|)
expr_stmt|;
name|data
operator|->
name|ni
operator|=
name|NULL
expr_stmt|;
name|sc
operator|->
name|sc_txtimer
operator|=
literal|0
expr_stmt|;
name|ifp
operator|->
name|if_opackets
operator|++
expr_stmt|;
name|URTW_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_tx_normal_queued
operator|--
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_OACTIVE
expr_stmt|;
name|URTW_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|urtw_start
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|urtw_tx_start
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|ieee80211_node
modifier|*
name|ni
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m0
parameter_list|,
name|int
name|prior
parameter_list|)
block|{
name|int
name|xferlen
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|struct
name|ieee80211_frame
modifier|*
name|wh
init|=
name|mtod
argument_list|(
name|m0
argument_list|,
expr|struct
name|ieee80211_frame
operator|*
argument_list|)
decl_stmt|;
name|struct
name|ieee80211_key
modifier|*
name|k
decl_stmt|;
specifier|const
name|struct
name|ieee80211_txparam
modifier|*
name|tp
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|ifp
operator|->
name|if_l2com
decl_stmt|;
name|struct
name|ieee80211vap
modifier|*
name|vap
init|=
name|ni
operator|->
name|ni_vap
decl_stmt|;
name|struct
name|urtw_data
modifier|*
name|data
decl_stmt|;
name|usbd_status
name|error
decl_stmt|;
name|URTW_ASSERT_LOCKED
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* 	 * Software crypto. 	 */
if|if
condition|(
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator|&
name|IEEE80211_FC1_WEP
condition|)
block|{
name|k
operator|=
name|ieee80211_crypto_encap
argument_list|(
name|ni
argument_list|,
name|m0
argument_list|)
expr_stmt|;
if|if
condition|(
name|k
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"ieee80211_crypto_encap returns NULL.\n"
argument_list|)
expr_stmt|;
comment|/* XXX we don't expect the fragmented frames  */
name|m_freem
argument_list|(
name|m0
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOBUFS
operator|)
return|;
block|}
comment|/* in case packet header moved, reset pointer */
name|wh
operator|=
name|mtod
argument_list|(
name|m0
argument_list|,
expr|struct
name|ieee80211_frame
operator|*
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|bpf_peers_present
argument_list|(
name|ifp
operator|->
name|if_bpf
argument_list|)
condition|)
block|{
name|struct
name|urtw_tx_radiotap_header
modifier|*
name|tap
init|=
operator|&
name|sc
operator|->
name|sc_txtap
decl_stmt|;
comment|/* XXX Are variables correct?  */
name|tap
operator|->
name|wt_flags
operator|=
literal|0
expr_stmt|;
name|tap
operator|->
name|wt_chan_freq
operator|=
name|htole16
argument_list|(
name|ic
operator|->
name|ic_curchan
operator|->
name|ic_freq
argument_list|)
expr_stmt|;
name|tap
operator|->
name|wt_chan_flags
operator|=
name|htole16
argument_list|(
name|ic
operator|->
name|ic_curchan
operator|->
name|ic_flags
argument_list|)
expr_stmt|;
name|bpf_mtap2
argument_list|(
name|ifp
operator|->
name|if_bpf
argument_list|,
name|tap
argument_list|,
name|sc
operator|->
name|sc_txtap_len
argument_list|,
name|m0
argument_list|)
expr_stmt|;
block|}
name|xferlen
operator|=
name|m0
operator|->
name|m_pkthdr
operator|.
name|len
operator|+
literal|4
operator|*
literal|3
expr_stmt|;
if|if
condition|(
operator|(
literal|0
operator|==
name|xferlen
operator|%
literal|64
operator|)
operator|||
operator|(
literal|0
operator|==
name|xferlen
operator|%
literal|512
operator|)
condition|)
name|xferlen
operator|+=
literal|1
expr_stmt|;
name|data
operator|=
operator|&
name|sc
operator|->
name|sc_txdata
index|[
name|sc
operator|->
name|sc_txidx
index|]
expr_stmt|;
name|sc
operator|->
name|sc_txidx
operator|=
operator|(
name|sc
operator|->
name|sc_txidx
operator|+
literal|1
operator|)
operator|%
name|URTW_TX_DATA_LIST_COUNT
expr_stmt|;
name|bzero
argument_list|(
name|data
operator|->
name|buf
argument_list|,
name|URTW_TX_MAXSIZE
argument_list|)
expr_stmt|;
name|data
operator|->
name|buf
index|[
literal|0
index|]
operator|=
name|m0
operator|->
name|m_pkthdr
operator|.
name|len
operator|&
literal|0xff
expr_stmt|;
name|data
operator|->
name|buf
index|[
literal|1
index|]
operator|=
operator|(
name|m0
operator|->
name|m_pkthdr
operator|.
name|len
operator|&
literal|0x0f00
operator|)
operator|>>
literal|8
expr_stmt|;
name|data
operator|->
name|buf
index|[
literal|1
index|]
operator||=
operator|(
literal|1
operator|<<
literal|7
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|ic
operator|->
name|ic_flags
operator|&
name|IEEE80211_F_SHPREAMBLE
operator|)
operator|&&
operator|(
name|ni
operator|->
name|ni_capinfo
operator|&
name|IEEE80211_CAPINFO_SHORT_PREAMBLE
operator|)
operator|&&
operator|(
name|sc
operator|->
name|sc_preamble_mode
operator|==
name|URTW_PREAMBLE_MODE_SHORT
operator|)
operator|&&
operator|(
name|sc
operator|->
name|sc_currate
operator|!=
literal|0
operator|)
condition|)
name|data
operator|->
name|buf
index|[
literal|2
index|]
operator||=
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|m0
operator|->
name|m_pkthdr
operator|.
name|len
operator|>
name|vap
operator|->
name|iv_rtsthreshold
operator|)
operator|&&
name|prior
operator|==
name|URTW_PRIORITY_LOW
condition|)
name|panic
argument_list|(
literal|"TODO tx."
argument_list|)
expr_stmt|;
if|if
condition|(
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator|&
name|IEEE80211_FC1_MORE_FRAG
condition|)
name|data
operator|->
name|buf
index|[
literal|2
index|]
operator||=
operator|(
literal|1
operator|<<
literal|1
operator|)
expr_stmt|;
comment|/* RTS rate - 10 means we use a basic rate.  */
name|data
operator|->
name|buf
index|[
literal|2
index|]
operator||=
operator|(
name|urtw_rate2rtl
argument_list|(
literal|2
argument_list|)
operator|<<
literal|3
operator|)
expr_stmt|;
comment|/* 	 * XXX currently TX rate control depends on the rate value of 	 * RX descriptor because I don't know how to we can control TX rate 	 * in more smart way.  Please fix me you find a thing. 	 */
name|data
operator|->
name|buf
index|[
literal|3
index|]
operator|=
name|sc
operator|->
name|sc_currate
expr_stmt|;
if|if
condition|(
name|prior
operator|==
name|URTW_PRIORITY_NORMAL
condition|)
block|{
name|tp
operator|=
operator|&
name|vap
operator|->
name|iv_txparms
index|[
name|ieee80211_chan2mode
argument_list|(
name|ni
operator|->
name|ni_chan
argument_list|)
index|]
expr_stmt|;
if|if
condition|(
name|IEEE80211_IS_MULTICAST
argument_list|(
name|wh
operator|->
name|i_addr1
argument_list|)
condition|)
name|data
operator|->
name|buf
index|[
literal|3
index|]
operator|=
name|urtw_rate2rtl
argument_list|(
name|tp
operator|->
name|mcastrate
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|tp
operator|->
name|ucastrate
operator|!=
name|IEEE80211_FIXED_RATE_NONE
condition|)
name|data
operator|->
name|buf
index|[
literal|3
index|]
operator|=
name|urtw_rate2rtl
argument_list|(
name|tp
operator|->
name|ucastrate
argument_list|)
expr_stmt|;
block|}
name|data
operator|->
name|buf
index|[
literal|8
index|]
operator|=
literal|3
expr_stmt|;
comment|/* CW minimum  */
name|data
operator|->
name|buf
index|[
literal|8
index|]
operator||=
operator|(
literal|7
operator|<<
literal|4
operator|)
expr_stmt|;
comment|/* CW maximum  */
name|data
operator|->
name|buf
index|[
literal|9
index|]
operator||=
literal|11
expr_stmt|;
comment|/* retry limitation  */
name|m_copydata
argument_list|(
name|m0
argument_list|,
literal|0
argument_list|,
name|m0
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|data
operator|->
name|buf
index|[
literal|12
index|]
argument_list|)
expr_stmt|;
name|data
operator|->
name|ni
operator|=
name|ni
expr_stmt|;
name|data
operator|->
name|m
operator|=
name|m0
expr_stmt|;
name|usbd_setup_xfer
argument_list|(
name|data
operator|->
name|xfer
argument_list|,
operator|(
name|prior
operator|==
name|URTW_PRIORITY_LOW
operator|)
condition|?
name|sc
operator|->
name|sc_txpipe_low
else|:
name|sc
operator|->
name|sc_txpipe_normal
argument_list|,
name|data
argument_list|,
name|data
operator|->
name|buf
argument_list|,
name|xferlen
argument_list|,
name|USBD_FORCE_SHORT_XFER
operator||
name|USBD_NO_COPY
argument_list|,
name|URTW_DATA_TIMEOUT
argument_list|,
operator|(
name|prior
operator|==
name|URTW_PRIORITY_LOW
operator|)
condition|?
name|urtw_txeof_low
else|:
name|urtw_txeof_normal
argument_list|)
expr_stmt|;
name|error
operator|=
name|usbd_transfer
argument_list|(
name|data
operator|->
name|xfer
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|USBD_IN_PROGRESS
operator|&&
name|error
operator|!=
name|USBD_NORMAL_COMPLETION
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not send frame: %s\n"
argument_list|,
name|usbd_errstr
argument_list|(
name|error
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|EIO
return|;
block|}
name|error
operator|=
name|urtw_led_ctl
argument_list|(
name|sc
argument_list|,
name|URTW_LED_CTL_TX
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not control LED (%d)\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
name|prior
operator|==
name|URTW_PRIORITY_LOW
condition|)
name|sc
operator|->
name|sc_tx_low_queued
operator|++
expr_stmt|;
else|else
name|sc
operator|->
name|sc_tx_normal_queued
operator|++
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|urtw_raw_xmit
parameter_list|(
name|struct
name|ieee80211_node
modifier|*
name|ni
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
specifier|const
name|struct
name|ieee80211_bpf_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|ni
operator|->
name|ni_ic
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|ic
operator|->
name|ic_ifp
decl_stmt|;
name|struct
name|urtw_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
comment|/* prevent management frames from being sent if we're not ready */
if|if
condition|(
operator|!
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
condition|)
block|{
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|ieee80211_free_node
argument_list|(
name|ni
argument_list|)
expr_stmt|;
return|return
name|ENETDOWN
return|;
block|}
name|URTW_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_tx_low_queued
operator|>=
name|URTW_TX_DATA_LIST_COUNT
operator|||
name|sc
operator|->
name|sc_tx_normal_queued
operator|>=
name|URTW_TX_DATA_LIST_COUNT
condition|)
block|{
name|ifp
operator|->
name|if_drv_flags
operator||=
name|IFF_DRV_OACTIVE
expr_stmt|;
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|ieee80211_free_node
argument_list|(
name|ni
argument_list|)
expr_stmt|;
name|URTW_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOBUFS
operator|)
return|;
comment|/* XXX */
block|}
name|ifp
operator|->
name|if_opackets
operator|++
expr_stmt|;
if|if
condition|(
name|urtw_tx_start
argument_list|(
name|sc
argument_list|,
name|ni
argument_list|,
name|m
argument_list|,
name|URTW_PRIORITY_LOW
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|ieee80211_free_node
argument_list|(
name|ni
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_oerrors
operator|++
expr_stmt|;
name|URTW_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|EIO
operator|)
return|;
block|}
name|sc
operator|->
name|sc_txtimer
operator|=
literal|5
expr_stmt|;
name|URTW_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtw_scan_start
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|)
block|{
comment|/* XXX do nothing?  */
block|}
end_function

begin_function
specifier|static
name|void
name|urtw_scan_end
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|)
block|{
comment|/* XXX do nothing?  */
block|}
end_function

begin_function
specifier|static
name|void
name|urtw_set_channel
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|)
block|{
name|struct
name|urtw_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
comment|/* 	 * if the user set a channel explicitly using ifconfig(8) this function 	 * can be called earlier than we're expected that in some cases the 	 * initialization would be failed if setting a channel is called before 	 * the init have done. 	 */
if|if
condition|(
operator|!
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
condition|)
return|return;
name|sc
operator|->
name|sc_ctxarg
operator|=
name|URTW_SET_CHANNEL
expr_stmt|;
name|usb_add_task
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
operator|&
name|sc
operator|->
name|sc_ctxtask
argument_list|,
name|USB_TASKQ_DRIVER
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtw_update_mcast
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
comment|/* XXX do nothing?  */
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|urtw_8225_usb_init
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint8_t
name|data
decl_stmt|;
name|usbd_status
name|error
decl_stmt|;
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_RF_PINS_SELECT
operator|+
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_GPIO
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|error
operator|=
name|urtw_read8e
argument_list|(
name|sc
argument_list|,
literal|0x53
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
name|error
operator|=
name|urtw_write8e
argument_list|(
name|sc
argument_list|,
literal|0x53
argument_list|,
name|data
operator||
operator|(
literal|1
operator|<<
literal|7
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_RF_PINS_SELECT
operator|+
literal|1
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_GPIO
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_GP_ENABLE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|urtw_write16_m
argument_list|(
name|sc
argument_list|,
name|URTW_RF_PINS_OUTPUT
argument_list|,
literal|0x80
argument_list|)
expr_stmt|;
name|urtw_write16_m
argument_list|(
name|sc
argument_list|,
name|URTW_RF_PINS_SELECT
argument_list|,
literal|0x80
argument_list|)
expr_stmt|;
name|urtw_write16_m
argument_list|(
name|sc
argument_list|,
name|URTW_RF_PINS_ENABLE
argument_list|,
literal|0x80
argument_list|)
expr_stmt|;
name|usbd_delay_ms
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
literal|500
argument_list|)
expr_stmt|;
name|fail
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|urtw_8185_rf_pins_enable
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|)
block|{
name|usbd_status
name|error
init|=
literal|0
decl_stmt|;
name|urtw_write16_m
argument_list|(
name|sc
argument_list|,
name|URTW_RF_PINS_ENABLE
argument_list|,
literal|0x1ff7
argument_list|)
expr_stmt|;
name|fail
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|urtw_8187_write_phy
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|addr
parameter_list|,
name|uint32_t
name|data
parameter_list|)
block|{
name|uint32_t
name|phyw
decl_stmt|;
name|usbd_status
name|error
decl_stmt|;
name|phyw
operator|=
operator|(
operator|(
name|data
operator|<<
literal|8
operator|)
operator||
operator|(
name|addr
operator||
literal|0x80
operator|)
operator|)
expr_stmt|;
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_PHY_MAGIC4
argument_list|,
operator|(
operator|(
name|phyw
operator|&
literal|0xff000000
operator|)
operator|>>
literal|24
operator|)
argument_list|)
expr_stmt|;
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_PHY_MAGIC3
argument_list|,
operator|(
operator|(
name|phyw
operator|&
literal|0x00ff0000
operator|)
operator|>>
literal|16
operator|)
argument_list|)
expr_stmt|;
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_PHY_MAGIC2
argument_list|,
operator|(
operator|(
name|phyw
operator|&
literal|0x0000ff00
operator|)
operator|>>
literal|8
operator|)
argument_list|)
expr_stmt|;
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_PHY_MAGIC1
argument_list|,
operator|(
operator|(
name|phyw
operator|&
literal|0x000000ff
operator|)
operator|)
argument_list|)
expr_stmt|;
name|usbd_delay_ms
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|fail
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|urtw_8187_write_phy_ofdm_c
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|addr
parameter_list|,
name|uint32_t
name|data
parameter_list|)
block|{
name|data
operator|=
name|data
operator|&
literal|0xff
expr_stmt|;
return|return
name|urtw_8187_write_phy
argument_list|(
name|sc
argument_list|,
name|addr
argument_list|,
name|data
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|urtw_8187_write_phy_cck_c
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|addr
parameter_list|,
name|uint32_t
name|data
parameter_list|)
block|{
name|data
operator|=
name|data
operator|&
literal|0xff
expr_stmt|;
return|return
name|urtw_8187_write_phy
argument_list|(
name|sc
argument_list|,
name|addr
argument_list|,
name|data
operator||
literal|0x10000
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|urtw_8225_setgain
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|,
name|int16_t
name|gain
parameter_list|)
block|{
name|usbd_status
name|error
decl_stmt|;
name|urtw_8187_write_phy_ofdm
argument_list|(
name|sc
argument_list|,
literal|0x0d
argument_list|,
name|urtw_8225_gain
index|[
name|gain
operator|*
literal|4
index|]
argument_list|)
expr_stmt|;
name|urtw_8187_write_phy_ofdm
argument_list|(
name|sc
argument_list|,
literal|0x1b
argument_list|,
name|urtw_8225_gain
index|[
name|gain
operator|*
literal|4
operator|+
literal|2
index|]
argument_list|)
expr_stmt|;
name|urtw_8187_write_phy_ofdm
argument_list|(
name|sc
argument_list|,
literal|0x1d
argument_list|,
name|urtw_8225_gain
index|[
name|gain
operator|*
literal|4
operator|+
literal|3
index|]
argument_list|)
expr_stmt|;
name|urtw_8187_write_phy_ofdm
argument_list|(
name|sc
argument_list|,
literal|0x23
argument_list|,
name|urtw_8225_gain
index|[
name|gain
operator|*
literal|4
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
name|fail
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|urtw_8225_set_txpwrlvl
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|,
name|int
name|chan
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|idx
decl_stmt|,
name|set
decl_stmt|;
name|uint8_t
modifier|*
name|cck_pwltable
decl_stmt|;
name|uint8_t
name|cck_pwrlvl_max
decl_stmt|,
name|ofdm_pwrlvl_min
decl_stmt|,
name|ofdm_pwrlvl_max
decl_stmt|;
name|uint8_t
name|cck_pwrlvl
init|=
name|sc
operator|->
name|sc_txpwr_cck
index|[
name|chan
index|]
operator|&
literal|0xff
decl_stmt|;
name|uint8_t
name|ofdm_pwrlvl
init|=
name|sc
operator|->
name|sc_txpwr_ofdm
index|[
name|chan
index|]
operator|&
literal|0xff
decl_stmt|;
name|usbd_status
name|error
decl_stmt|;
name|cck_pwrlvl_max
operator|=
literal|11
expr_stmt|;
name|ofdm_pwrlvl_max
operator|=
literal|25
expr_stmt|;
comment|/* 12 -> 25  */
name|ofdm_pwrlvl_min
operator|=
literal|10
expr_stmt|;
comment|/* CCK power setting */
name|cck_pwrlvl
operator|=
operator|(
name|cck_pwrlvl
operator|>
name|cck_pwrlvl_max
operator|)
condition|?
name|cck_pwrlvl_max
else|:
name|cck_pwrlvl
expr_stmt|;
name|idx
operator|=
name|cck_pwrlvl
operator|%
literal|6
expr_stmt|;
name|set
operator|=
name|cck_pwrlvl
operator|/
literal|6
expr_stmt|;
name|cck_pwltable
operator|=
operator|(
name|chan
operator|==
literal|14
operator|)
condition|?
name|urtw_8225_txpwr_cck_ch14
else|:
name|urtw_8225_txpwr_cck
expr_stmt|;
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_TX_GAIN_CCK
argument_list|,
name|urtw_8225_tx_gain_cck_ofdm
index|[
name|set
index|]
operator|>>
literal|1
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
block|{
name|urtw_8187_write_phy_cck
argument_list|(
name|sc
argument_list|,
literal|0x44
operator|+
name|i
argument_list|,
name|cck_pwltable
index|[
name|idx
operator|*
literal|8
operator|+
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|usbd_delay_ms
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* OFDM power setting */
name|ofdm_pwrlvl
operator|=
operator|(
name|ofdm_pwrlvl
operator|>
operator|(
name|ofdm_pwrlvl_max
operator|-
name|ofdm_pwrlvl_min
operator|)
operator|)
condition|?
name|ofdm_pwrlvl_max
else|:
name|ofdm_pwrlvl
operator|+
name|ofdm_pwrlvl_min
expr_stmt|;
name|ofdm_pwrlvl
operator|=
operator|(
name|ofdm_pwrlvl
operator|>
literal|35
operator|)
condition|?
literal|35
else|:
name|ofdm_pwrlvl
expr_stmt|;
name|idx
operator|=
name|ofdm_pwrlvl
operator|%
literal|6
expr_stmt|;
name|set
operator|=
name|ofdm_pwrlvl
operator|/
literal|6
expr_stmt|;
name|error
operator|=
name|urtw_8185_set_anaparam2
argument_list|(
name|sc
argument_list|,
name|URTW_8225_ANAPARAM2_ON
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
name|urtw_8187_write_phy_ofdm
argument_list|(
name|sc
argument_list|,
literal|2
argument_list|,
literal|0x42
argument_list|)
expr_stmt|;
name|urtw_8187_write_phy_ofdm
argument_list|(
name|sc
argument_list|,
literal|6
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|urtw_8187_write_phy_ofdm
argument_list|(
name|sc
argument_list|,
literal|8
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_TX_GAIN_OFDM
argument_list|,
name|urtw_8225_tx_gain_cck_ofdm
index|[
name|set
index|]
operator|>>
literal|1
argument_list|)
expr_stmt|;
name|urtw_8187_write_phy_ofdm
argument_list|(
name|sc
argument_list|,
literal|0x5
argument_list|,
name|urtw_8225_txpwr_ofdm
index|[
name|idx
index|]
argument_list|)
expr_stmt|;
name|urtw_8187_write_phy_ofdm
argument_list|(
name|sc
argument_list|,
literal|0x7
argument_list|,
name|urtw_8225_txpwr_ofdm
index|[
name|idx
index|]
argument_list|)
expr_stmt|;
name|usbd_delay_ms
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|fail
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|urtw_8185_tx_antenna
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|ant
parameter_list|)
block|{
name|usbd_status
name|error
decl_stmt|;
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_TX_ANTENNA
argument_list|,
name|ant
argument_list|)
expr_stmt|;
name|usbd_delay_ms
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|fail
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|urtw_8225_rf_init
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|)
block|{
define|#
directive|define
name|N
parameter_list|(
name|a
parameter_list|)
value|(sizeof(a) / sizeof((a)[0]))
name|int
name|i
decl_stmt|;
name|uint16_t
name|data
decl_stmt|;
name|usbd_status
name|error
decl_stmt|;
name|error
operator|=
name|urtw_8180_set_anaparam
argument_list|(
name|sc
argument_list|,
name|URTW_8225_ANAPARAM_ON
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
name|error
operator|=
name|urtw_8225_usb_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
name|urtw_write32_m
argument_list|(
name|sc
argument_list|,
name|URTW_RF_TIMING
argument_list|,
literal|0x000a8008
argument_list|)
expr_stmt|;
name|urtw_read16_m
argument_list|(
name|sc
argument_list|,
name|URTW_BRSR
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
comment|/* XXX ??? */
name|urtw_write16_m
argument_list|(
name|sc
argument_list|,
name|URTW_BRSR
argument_list|,
literal|0xffff
argument_list|)
expr_stmt|;
name|urtw_write32_m
argument_list|(
name|sc
argument_list|,
name|URTW_RF_PARA
argument_list|,
literal|0x100044
argument_list|)
expr_stmt|;
name|error
operator|=
name|urtw_set_mode
argument_list|(
name|sc
argument_list|,
name|URTW_EPROM_CMD_CONFIG
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_CONFIG3
argument_list|,
literal|0x44
argument_list|)
expr_stmt|;
name|error
operator|=
name|urtw_set_mode
argument_list|(
name|sc
argument_list|,
name|URTW_EPROM_CMD_NORMAL
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
name|error
operator|=
name|urtw_8185_rf_pins_enable
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
name|usbd_delay_ms
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
literal|1000
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|N
argument_list|(
name|urtw_8225_rf_part1
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|urtw_8225_write
argument_list|(
name|sc
argument_list|,
name|urtw_8225_rf_part1
index|[
name|i
index|]
operator|.
name|reg
argument_list|,
name|urtw_8225_rf_part1
index|[
name|i
index|]
operator|.
name|val
argument_list|)
expr_stmt|;
name|usbd_delay_ms
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|usbd_delay_ms
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
literal|100
argument_list|)
expr_stmt|;
name|urtw_8225_write
argument_list|(
name|sc
argument_list|,
name|URTW_8225_ADDR_2_MAGIC
argument_list|,
name|URTW_8225_ADDR_2_DATA_MAGIC1
argument_list|)
expr_stmt|;
name|usbd_delay_ms
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
literal|200
argument_list|)
expr_stmt|;
name|urtw_8225_write
argument_list|(
name|sc
argument_list|,
name|URTW_8225_ADDR_2_MAGIC
argument_list|,
name|URTW_8225_ADDR_2_DATA_MAGIC2
argument_list|)
expr_stmt|;
name|usbd_delay_ms
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
literal|200
argument_list|)
expr_stmt|;
name|urtw_8225_write
argument_list|(
name|sc
argument_list|,
name|URTW_8225_ADDR_0_MAGIC
argument_list|,
name|URTW_8225_ADDR_0_DATA_MAGIC3
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|95
condition|;
name|i
operator|++
control|)
block|{
name|urtw_8225_write
argument_list|(
name|sc
argument_list|,
name|URTW_8225_ADDR_1_MAGIC
argument_list|,
call|(
name|uint8_t
call|)
argument_list|(
name|i
operator|+
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|urtw_8225_write
argument_list|(
name|sc
argument_list|,
name|URTW_8225_ADDR_2_MAGIC
argument_list|,
name|urtw_8225_rxgain
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|urtw_8225_write
argument_list|(
name|sc
argument_list|,
name|URTW_8225_ADDR_0_MAGIC
argument_list|,
name|URTW_8225_ADDR_0_DATA_MAGIC4
argument_list|)
expr_stmt|;
name|urtw_8225_write
argument_list|(
name|sc
argument_list|,
name|URTW_8225_ADDR_0_MAGIC
argument_list|,
name|URTW_8225_ADDR_0_DATA_MAGIC5
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|128
condition|;
name|i
operator|++
control|)
block|{
name|urtw_8187_write_phy_ofdm
argument_list|(
name|sc
argument_list|,
literal|0xb
argument_list|,
name|urtw_8225_agc
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|usbd_delay_ms
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|urtw_8187_write_phy_ofdm
argument_list|(
name|sc
argument_list|,
literal|0xa
argument_list|,
operator|(
name|uint8_t
operator|)
name|i
operator|+
literal|0x80
argument_list|)
expr_stmt|;
name|usbd_delay_ms
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|N
argument_list|(
name|urtw_8225_rf_part2
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|urtw_8187_write_phy_ofdm
argument_list|(
name|sc
argument_list|,
name|urtw_8225_rf_part2
index|[
name|i
index|]
operator|.
name|reg
argument_list|,
name|urtw_8225_rf_part2
index|[
name|i
index|]
operator|.
name|val
argument_list|)
expr_stmt|;
name|usbd_delay_ms
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|error
operator|=
name|urtw_8225_setgain
argument_list|(
name|sc
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|N
argument_list|(
name|urtw_8225_rf_part3
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|urtw_8187_write_phy_cck
argument_list|(
name|sc
argument_list|,
name|urtw_8225_rf_part3
index|[
name|i
index|]
operator|.
name|reg
argument_list|,
name|urtw_8225_rf_part3
index|[
name|i
index|]
operator|.
name|val
argument_list|)
expr_stmt|;
name|usbd_delay_ms
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_ADDR_MAGIC4
argument_list|,
literal|0x0d
argument_list|)
expr_stmt|;
name|error
operator|=
name|urtw_8225_set_txpwrlvl
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
name|urtw_8187_write_phy_cck
argument_list|(
name|sc
argument_list|,
literal|0x10
argument_list|,
literal|0x9b
argument_list|)
expr_stmt|;
name|usbd_delay_ms
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|urtw_8187_write_phy_ofdm
argument_list|(
name|sc
argument_list|,
literal|0x26
argument_list|,
literal|0x90
argument_list|)
expr_stmt|;
name|usbd_delay_ms
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* TX ant A, 0x0 for B */
name|error
operator|=
name|urtw_8185_tx_antenna
argument_list|(
name|sc
argument_list|,
literal|0x3
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
name|urtw_write32_m
argument_list|(
name|sc
argument_list|,
name|URTW_ADDR_MAGIC5
argument_list|,
literal|0x3dc00002
argument_list|)
expr_stmt|;
name|error
operator|=
name|urtw_8225_rf_set_chan
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|fail
label|:
return|return
operator|(
name|error
operator|)
return|;
undef|#
directive|undef
name|N
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|urtw_8225_rf_set_chan
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|,
name|int
name|chan
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|sc
operator|->
name|sc_ifp
operator|->
name|if_l2com
decl_stmt|;
name|struct
name|ieee80211_channel
modifier|*
name|c
init|=
name|ic
operator|->
name|ic_curchan
decl_stmt|;
name|usbd_status
name|error
decl_stmt|;
name|error
operator|=
name|urtw_8225_set_txpwrlvl
argument_list|(
name|sc
argument_list|,
name|chan
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
name|urtw_8225_write
argument_list|(
name|sc
argument_list|,
name|URTW_8225_ADDR_7_MAGIC
argument_list|,
name|urtw_8225_channel
index|[
name|chan
index|]
argument_list|)
expr_stmt|;
name|usbd_delay_ms
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_SIFS
argument_list|,
literal|0x22
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_state
operator|==
name|IEEE80211_S_ASSOC
operator|&&
name|ic
operator|->
name|ic_flags
operator|&
name|IEEE80211_F_SHSLOT
condition|)
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_SLOT
argument_list|,
literal|0x9
argument_list|)
expr_stmt|;
else|else
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_SLOT
argument_list|,
literal|0x14
argument_list|)
expr_stmt|;
if|if
condition|(
name|IEEE80211_IS_CHAN_G
argument_list|(
name|c
argument_list|)
condition|)
block|{
comment|/* for G */
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_DIFS
argument_list|,
literal|0x14
argument_list|)
expr_stmt|;
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_EIFS
argument_list|,
literal|0x5b
operator|-
literal|0x14
argument_list|)
expr_stmt|;
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_CW_VAL
argument_list|,
literal|0x73
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* for B */
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_DIFS
argument_list|,
literal|0x24
argument_list|)
expr_stmt|;
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_EIFS
argument_list|,
literal|0x5b
operator|-
literal|0x24
argument_list|)
expr_stmt|;
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_CW_VAL
argument_list|,
literal|0xa5
argument_list|)
expr_stmt|;
block|}
name|fail
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|urtw_8225_rf_set_sens
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|,
name|int
name|sens
parameter_list|)
block|{
name|usbd_status
name|error
decl_stmt|;
if|if
condition|(
name|sens
operator|<
literal|0
operator|||
name|sens
operator|>
literal|6
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|sens
operator|>
literal|4
condition|)
name|urtw_8225_write
argument_list|(
name|sc
argument_list|,
name|URTW_8225_ADDR_C_MAGIC
argument_list|,
name|URTW_8225_ADDR_C_DATA_MAGIC1
argument_list|)
expr_stmt|;
else|else
name|urtw_8225_write
argument_list|(
name|sc
argument_list|,
name|URTW_8225_ADDR_C_MAGIC
argument_list|,
name|URTW_8225_ADDR_C_DATA_MAGIC2
argument_list|)
expr_stmt|;
name|sens
operator|=
literal|6
operator|-
name|sens
expr_stmt|;
name|error
operator|=
name|urtw_8225_setgain
argument_list|(
name|sc
argument_list|,
name|sens
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
name|urtw_8187_write_phy_cck
argument_list|(
name|sc
argument_list|,
literal|0x41
argument_list|,
name|urtw_8225_threshold
index|[
name|sens
index|]
argument_list|)
expr_stmt|;
name|fail
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtw_stop
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|int
name|disable
parameter_list|)
block|{
name|struct
name|urtw_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
operator|(
name|IFF_DRV_RUNNING
operator||
name|IFF_DRV_OACTIVE
operator|)
expr_stmt|;
name|callout_stop
argument_list|(
operator|&
name|sc
operator|->
name|sc_led_ch
argument_list|)
expr_stmt|;
name|callout_stop
argument_list|(
operator|&
name|sc
operator|->
name|sc_watchdog_ch
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_rxpipe
operator|!=
name|NULL
condition|)
name|usbd_abort_pipe
argument_list|(
name|sc
operator|->
name|sc_rxpipe
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_txpipe_low
operator|!=
name|NULL
condition|)
name|usbd_abort_pipe
argument_list|(
name|sc
operator|->
name|sc_txpipe_low
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_txpipe_normal
operator|!=
name|NULL
condition|)
name|usbd_abort_pipe
argument_list|(
name|sc
operator|->
name|sc_txpipe_normal
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|urtw_isbmode
parameter_list|(
name|uint16_t
name|rate
parameter_list|)
block|{
name|rate
operator|=
name|urtw_rtl2rate
argument_list|(
name|rate
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
name|rate
operator|<=
literal|22
operator|&&
name|rate
operator|!=
literal|12
operator|&&
name|rate
operator|!=
literal|18
operator|)
operator|||
name|rate
operator|==
literal|44
operator|)
condition|?
operator|(
literal|1
operator|)
else|:
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtw_rxeof
parameter_list|(
name|usbd_xfer_handle
name|xfer
parameter_list|,
name|usbd_private_handle
name|priv
parameter_list|,
name|usbd_status
name|status
parameter_list|)
block|{
name|int
name|actlen
decl_stmt|,
name|flen
decl_stmt|,
name|len
decl_stmt|,
name|nf
decl_stmt|,
name|rssi
decl_stmt|;
name|struct
name|ieee80211_frame
modifier|*
name|wh
decl_stmt|;
name|struct
name|ieee80211_node
modifier|*
name|ni
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|,
modifier|*
name|mnew
decl_stmt|;
name|struct
name|urtw_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
name|struct
name|urtw_softc
modifier|*
name|sc
init|=
name|data
operator|->
name|sc
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|ifp
operator|->
name|if_l2com
decl_stmt|;
name|uint8_t
modifier|*
name|desc
decl_stmt|,
name|quality
decl_stmt|,
name|rate
decl_stmt|;
name|usbd_status
name|error
decl_stmt|;
if|if
condition|(
name|status
operator|!=
name|USBD_NORMAL_COMPLETION
condition|)
block|{
if|if
condition|(
name|status
operator|==
name|USBD_NOT_STARTED
operator|||
name|status
operator|==
name|USBD_CANCELLED
condition|)
return|return;
if|if
condition|(
name|status
operator|==
name|USBD_STALLED
condition|)
name|usbd_clear_endpoint_stall_async
argument_list|(
name|sc
operator|->
name|sc_rxpipe
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_ierrors
operator|++
expr_stmt|;
goto|goto
name|skip
goto|;
block|}
name|usbd_get_xfer_status
argument_list|(
name|xfer
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|actlen
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|actlen
operator|<
name|URTW_MIN_RXBUFSZ
condition|)
block|{
name|ifp
operator|->
name|if_ierrors
operator|++
expr_stmt|;
goto|goto
name|skip
goto|;
block|}
comment|/* 4 dword and 4 byte CRC  */
name|len
operator|=
name|actlen
operator|-
operator|(
literal|4
operator|*
literal|4
operator|)
expr_stmt|;
name|desc
operator|=
name|data
operator|->
name|buf
operator|+
name|len
expr_stmt|;
name|flen
operator|=
operator|(
operator|(
name|desc
index|[
literal|1
index|]
operator|&
literal|0x0f
operator|)
operator|<<
literal|8
operator|)
operator|+
operator|(
name|desc
index|[
literal|0
index|]
operator|&
literal|0xff
operator|)
expr_stmt|;
if|if
condition|(
name|flen
operator|>
name|actlen
condition|)
block|{
name|ifp
operator|->
name|if_ierrors
operator|++
expr_stmt|;
goto|goto
name|skip
goto|;
block|}
name|rate
operator|=
operator|(
name|desc
index|[
literal|2
index|]
operator|&
literal|0xf0
operator|)
operator|>>
literal|4
expr_stmt|;
name|quality
operator|=
name|desc
index|[
literal|4
index|]
operator|&
literal|0xff
expr_stmt|;
comment|/* XXX correct?  */
name|rssi
operator|=
operator|(
name|desc
index|[
literal|6
index|]
operator|&
literal|0xfe
operator|)
operator|>>
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|urtw_isbmode
argument_list|(
name|rate
argument_list|)
condition|)
block|{
name|rssi
operator|=
operator|(
name|rssi
operator|>
literal|90
operator|)
condition|?
literal|90
else|:
operator|(
operator|(
name|rssi
operator|<
literal|25
operator|)
condition|?
literal|25
else|:
name|rssi
operator|)
expr_stmt|;
name|rssi
operator|=
operator|(
operator|(
literal|90
operator|-
name|rssi
operator|)
operator|*
literal|100
operator|)
operator|/
literal|65
expr_stmt|;
block|}
else|else
block|{
name|rssi
operator|=
operator|(
name|rssi
operator|>
literal|90
operator|)
condition|?
literal|95
else|:
operator|(
operator|(
name|rssi
operator|<
literal|30
operator|)
condition|?
literal|30
else|:
name|rssi
operator|)
expr_stmt|;
name|rssi
operator|=
operator|(
operator|(
literal|95
operator|-
name|rssi
operator|)
operator|*
literal|100
operator|)
operator|/
literal|65
expr_stmt|;
block|}
name|mnew
operator|=
name|m_getcl
argument_list|(
name|M_DONTWAIT
argument_list|,
name|MT_DATA
argument_list|,
name|M_PKTHDR
argument_list|)
expr_stmt|;
if|if
condition|(
name|mnew
operator|==
name|NULL
condition|)
block|{
name|ifp
operator|->
name|if_ierrors
operator|++
expr_stmt|;
goto|goto
name|skip
goto|;
block|}
name|m
operator|=
name|data
operator|->
name|m
expr_stmt|;
name|data
operator|->
name|m
operator|=
name|mnew
expr_stmt|;
name|data
operator|->
name|buf
operator|=
name|mtod
argument_list|(
name|mnew
argument_list|,
name|uint8_t
operator|*
argument_list|)
expr_stmt|;
comment|/* finalize mbuf */
name|m
operator|->
name|m_pkthdr
operator|.
name|rcvif
operator|=
name|ifp
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|m
operator|->
name|m_len
operator|=
name|flen
operator|-
literal|4
expr_stmt|;
if|if
condition|(
name|bpf_peers_present
argument_list|(
name|ifp
operator|->
name|if_bpf
argument_list|)
condition|)
block|{
name|struct
name|urtw_rx_radiotap_header
modifier|*
name|tap
init|=
operator|&
name|sc
operator|->
name|sc_rxtap
decl_stmt|;
comment|/* XXX Are variables correct?  */
name|tap
operator|->
name|wr_chan_freq
operator|=
name|htole16
argument_list|(
name|ic
operator|->
name|ic_curchan
operator|->
name|ic_freq
argument_list|)
expr_stmt|;
name|tap
operator|->
name|wr_chan_flags
operator|=
name|htole16
argument_list|(
name|ic
operator|->
name|ic_curchan
operator|->
name|ic_flags
argument_list|)
expr_stmt|;
name|tap
operator|->
name|wr_dbm_antsignal
operator|=
operator|(
name|int8_t
operator|)
name|rssi
expr_stmt|;
name|bpf_mtap2
argument_list|(
name|ifp
operator|->
name|if_bpf
argument_list|,
name|tap
argument_list|,
name|sc
operator|->
name|sc_rxtap_len
argument_list|,
name|m
argument_list|)
expr_stmt|;
block|}
name|wh
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ieee80211_frame
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator|&
name|IEEE80211_FC0_TYPE_MASK
operator|)
operator|==
name|IEEE80211_FC0_TYPE_DATA
condition|)
name|sc
operator|->
name|sc_currate
operator|=
operator|(
name|rate
operator|>
literal|0
operator|)
condition|?
name|rate
else|:
name|sc
operator|->
name|sc_currate
expr_stmt|;
name|ni
operator|=
name|ieee80211_find_rxnode
argument_list|(
name|ic
argument_list|,
operator|(
expr|struct
name|ieee80211_frame_min
operator|*
operator|)
name|wh
argument_list|)
expr_stmt|;
comment|/* XXX correct?  */
name|nf
operator|=
operator|(
name|quality
operator|>
literal|64
operator|)
condition|?
literal|0
else|:
operator|(
operator|(
literal|64
operator|-
name|quality
operator|)
operator|*
literal|100
operator|)
operator|/
literal|64
expr_stmt|;
comment|/* send the frame to the 802.11 layer */
if|if
condition|(
name|ni
operator|!=
name|NULL
condition|)
block|{
operator|(
name|void
operator|)
name|ieee80211_input
argument_list|(
name|ni
argument_list|,
name|m
argument_list|,
name|rssi
argument_list|,
operator|-
name|nf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* node is no longer needed */
name|ieee80211_free_node
argument_list|(
name|ni
argument_list|)
expr_stmt|;
block|}
else|else
operator|(
name|void
operator|)
name|ieee80211_input_all
argument_list|(
name|ic
argument_list|,
name|m
argument_list|,
name|rssi
argument_list|,
operator|-
name|nf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|skip
label|:
comment|/* setup a new transfer */
name|usbd_setup_xfer
argument_list|(
name|xfer
argument_list|,
name|sc
operator|->
name|sc_rxpipe
argument_list|,
name|data
argument_list|,
name|data
operator|->
name|buf
argument_list|,
name|MCLBYTES
argument_list|,
name|USBD_SHORT_XFER_OK
argument_list|,
name|USBD_NO_TIMEOUT
argument_list|,
name|urtw_rxeof
argument_list|)
expr_stmt|;
name|error
operator|=
name|usbd_transfer
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|USBD_IN_PROGRESS
operator|&&
name|error
operator|!=
literal|0
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not queue Rx transfer\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|urtw_newstate
parameter_list|(
name|struct
name|ieee80211vap
modifier|*
name|vap
parameter_list|,
name|enum
name|ieee80211_state
name|nstate
parameter_list|,
name|int
name|arg
parameter_list|)
block|{
name|struct
name|urtw_vap
modifier|*
name|rvp
init|=
name|URTW_VAP
argument_list|(
name|vap
argument_list|)
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|vap
operator|->
name|iv_ic
decl_stmt|;
name|struct
name|urtw_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_ifp
operator|->
name|if_softc
decl_stmt|;
name|DPRINTF
argument_list|(
name|sc
argument_list|,
name|URTW_DEBUG_STATE
argument_list|,
literal|"%s: %s -> %s\n"
argument_list|,
name|__func__
argument_list|,
name|ieee80211_state_name
index|[
name|vap
operator|->
name|iv_state
index|]
argument_list|,
name|ieee80211_state_name
index|[
name|nstate
index|]
argument_list|)
expr_stmt|;
comment|/* do it in a process context */
name|sc
operator|->
name|sc_state
operator|=
name|nstate
expr_stmt|;
name|sc
operator|->
name|sc_arg
operator|=
name|arg
expr_stmt|;
if|if
condition|(
name|nstate
operator|==
name|IEEE80211_S_INIT
condition|)
block|{
name|rvp
operator|->
name|newstate
argument_list|(
name|vap
argument_list|,
name|nstate
argument_list|,
name|arg
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
else|else
block|{
name|usb_add_task
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
operator|&
name|sc
operator|->
name|sc_task
argument_list|,
name|USB_TASKQ_DRIVER
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINPROGRESS
operator|)
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|urtw_8225v2_setgain
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|,
name|int16_t
name|gain
parameter_list|)
block|{
name|uint8_t
modifier|*
name|gainp
decl_stmt|;
name|usbd_status
name|error
decl_stmt|;
comment|/* XXX for A?  */
name|gainp
operator|=
name|urtw_8225v2_gain_bg
expr_stmt|;
name|urtw_8187_write_phy_ofdm
argument_list|(
name|sc
argument_list|,
literal|0x0d
argument_list|,
name|gainp
index|[
name|gain
operator|*
literal|3
index|]
argument_list|)
expr_stmt|;
name|usbd_delay_ms
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|urtw_8187_write_phy_ofdm
argument_list|(
name|sc
argument_list|,
literal|0x1b
argument_list|,
name|gainp
index|[
name|gain
operator|*
literal|3
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
name|usbd_delay_ms
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|urtw_8187_write_phy_ofdm
argument_list|(
name|sc
argument_list|,
literal|0x1d
argument_list|,
name|gainp
index|[
name|gain
operator|*
literal|3
operator|+
literal|2
index|]
argument_list|)
expr_stmt|;
name|usbd_delay_ms
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|urtw_8187_write_phy_ofdm
argument_list|(
name|sc
argument_list|,
literal|0x21
argument_list|,
literal|0x17
argument_list|)
expr_stmt|;
name|usbd_delay_ms
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|fail
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|urtw_8225v2_set_txpwrlvl
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|,
name|int
name|chan
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|uint8_t
modifier|*
name|cck_pwrtable
decl_stmt|;
name|uint8_t
name|cck_pwrlvl_max
init|=
literal|15
decl_stmt|,
name|ofdm_pwrlvl_max
init|=
literal|25
decl_stmt|,
name|ofdm_pwrlvl_min
init|=
literal|10
decl_stmt|;
name|uint8_t
name|cck_pwrlvl
init|=
name|sc
operator|->
name|sc_txpwr_cck
index|[
name|chan
index|]
operator|&
literal|0xff
decl_stmt|;
name|uint8_t
name|ofdm_pwrlvl
init|=
name|sc
operator|->
name|sc_txpwr_ofdm
index|[
name|chan
index|]
operator|&
literal|0xff
decl_stmt|;
name|usbd_status
name|error
decl_stmt|;
comment|/* CCK power setting */
name|cck_pwrlvl
operator|=
operator|(
name|cck_pwrlvl
operator|>
name|cck_pwrlvl_max
operator|)
condition|?
name|cck_pwrlvl_max
else|:
name|cck_pwrlvl
expr_stmt|;
name|cck_pwrlvl
operator|+=
name|sc
operator|->
name|sc_txpwr_cck_base
expr_stmt|;
name|cck_pwrlvl
operator|=
operator|(
name|cck_pwrlvl
operator|>
literal|35
operator|)
condition|?
literal|35
else|:
name|cck_pwrlvl
expr_stmt|;
name|cck_pwrtable
operator|=
operator|(
name|chan
operator|==
literal|14
operator|)
condition|?
name|urtw_8225v2_txpwr_cck_ch14
else|:
name|urtw_8225v2_txpwr_cck
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
name|urtw_8187_write_phy_cck
argument_list|(
name|sc
argument_list|,
literal|0x44
operator|+
name|i
argument_list|,
name|cck_pwrtable
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_TX_GAIN_CCK
argument_list|,
name|urtw_8225v2_tx_gain_cck_ofdm
index|[
name|cck_pwrlvl
index|]
argument_list|)
expr_stmt|;
name|usbd_delay_ms
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* OFDM power setting */
name|ofdm_pwrlvl
operator|=
operator|(
name|ofdm_pwrlvl
operator|>
operator|(
name|ofdm_pwrlvl_max
operator|-
name|ofdm_pwrlvl_min
operator|)
operator|)
condition|?
name|ofdm_pwrlvl_max
else|:
name|ofdm_pwrlvl
operator|+
name|ofdm_pwrlvl_min
expr_stmt|;
name|ofdm_pwrlvl
operator|+=
name|sc
operator|->
name|sc_txpwr_ofdm_base
expr_stmt|;
name|ofdm_pwrlvl
operator|=
operator|(
name|ofdm_pwrlvl
operator|>
literal|35
operator|)
condition|?
literal|35
else|:
name|ofdm_pwrlvl
expr_stmt|;
name|error
operator|=
name|urtw_8185_set_anaparam2
argument_list|(
name|sc
argument_list|,
name|URTW_8225_ANAPARAM2_ON
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
name|urtw_8187_write_phy_ofdm
argument_list|(
name|sc
argument_list|,
literal|2
argument_list|,
literal|0x42
argument_list|)
expr_stmt|;
name|urtw_8187_write_phy_ofdm
argument_list|(
name|sc
argument_list|,
literal|5
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
name|urtw_8187_write_phy_ofdm
argument_list|(
name|sc
argument_list|,
literal|6
argument_list|,
literal|0x40
argument_list|)
expr_stmt|;
name|urtw_8187_write_phy_ofdm
argument_list|(
name|sc
argument_list|,
literal|7
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
name|urtw_8187_write_phy_ofdm
argument_list|(
name|sc
argument_list|,
literal|8
argument_list|,
literal|0x40
argument_list|)
expr_stmt|;
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_TX_GAIN_OFDM
argument_list|,
name|urtw_8225v2_tx_gain_cck_ofdm
index|[
name|ofdm_pwrlvl
index|]
argument_list|)
expr_stmt|;
name|usbd_delay_ms
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|fail
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|urtw_8225v2_rf_init
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|)
block|{
define|#
directive|define
name|N
parameter_list|(
name|a
parameter_list|)
value|(sizeof(a) / sizeof((a)[0]))
name|int
name|i
decl_stmt|;
name|uint16_t
name|data
decl_stmt|;
name|uint32_t
name|data32
decl_stmt|;
name|usbd_status
name|error
decl_stmt|;
name|error
operator|=
name|urtw_8180_set_anaparam
argument_list|(
name|sc
argument_list|,
name|URTW_8225_ANAPARAM_ON
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
name|error
operator|=
name|urtw_8225_usb_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
name|urtw_write32_m
argument_list|(
name|sc
argument_list|,
name|URTW_RF_TIMING
argument_list|,
literal|0x000a8008
argument_list|)
expr_stmt|;
name|urtw_read16_m
argument_list|(
name|sc
argument_list|,
name|URTW_BRSR
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
comment|/* XXX ??? */
name|urtw_write16_m
argument_list|(
name|sc
argument_list|,
name|URTW_BRSR
argument_list|,
literal|0xffff
argument_list|)
expr_stmt|;
name|urtw_write32_m
argument_list|(
name|sc
argument_list|,
name|URTW_RF_PARA
argument_list|,
literal|0x100044
argument_list|)
expr_stmt|;
name|error
operator|=
name|urtw_set_mode
argument_list|(
name|sc
argument_list|,
name|URTW_EPROM_CMD_CONFIG
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_CONFIG3
argument_list|,
literal|0x44
argument_list|)
expr_stmt|;
name|error
operator|=
name|urtw_set_mode
argument_list|(
name|sc
argument_list|,
name|URTW_EPROM_CMD_NORMAL
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
name|error
operator|=
name|urtw_8185_rf_pins_enable
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
name|usbd_delay_ms
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
literal|500
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|N
argument_list|(
name|urtw_8225v2_rf_part1
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|urtw_8225_write
argument_list|(
name|sc
argument_list|,
name|urtw_8225v2_rf_part1
index|[
name|i
index|]
operator|.
name|reg
argument_list|,
name|urtw_8225v2_rf_part1
index|[
name|i
index|]
operator|.
name|val
argument_list|)
expr_stmt|;
block|}
name|usbd_delay_ms
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
literal|50
argument_list|)
expr_stmt|;
name|urtw_8225_write
argument_list|(
name|sc
argument_list|,
name|URTW_8225_ADDR_0_MAGIC
argument_list|,
name|URTW_8225_ADDR_0_DATA_MAGIC1
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|95
condition|;
name|i
operator|++
control|)
block|{
name|urtw_8225_write
argument_list|(
name|sc
argument_list|,
name|URTW_8225_ADDR_1_MAGIC
argument_list|,
call|(
name|uint8_t
call|)
argument_list|(
name|i
operator|+
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|urtw_8225_write
argument_list|(
name|sc
argument_list|,
name|URTW_8225_ADDR_2_MAGIC
argument_list|,
name|urtw_8225v2_rxgain
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|urtw_8225_write
argument_list|(
name|sc
argument_list|,
name|URTW_8225_ADDR_3_MAGIC
argument_list|,
name|URTW_8225_ADDR_3_DATA_MAGIC1
argument_list|)
expr_stmt|;
name|urtw_8225_write
argument_list|(
name|sc
argument_list|,
name|URTW_8225_ADDR_5_MAGIC
argument_list|,
name|URTW_8225_ADDR_5_DATA_MAGIC1
argument_list|)
expr_stmt|;
name|urtw_8225_write
argument_list|(
name|sc
argument_list|,
name|URTW_8225_ADDR_0_MAGIC
argument_list|,
name|URTW_8225_ADDR_0_DATA_MAGIC2
argument_list|)
expr_stmt|;
name|urtw_8225_write
argument_list|(
name|sc
argument_list|,
name|URTW_8225_ADDR_2_MAGIC
argument_list|,
name|URTW_8225_ADDR_2_DATA_MAGIC1
argument_list|)
expr_stmt|;
name|usbd_delay_ms
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
literal|100
argument_list|)
expr_stmt|;
name|urtw_8225_write
argument_list|(
name|sc
argument_list|,
name|URTW_8225_ADDR_2_MAGIC
argument_list|,
name|URTW_8225_ADDR_2_DATA_MAGIC2
argument_list|)
expr_stmt|;
name|usbd_delay_ms
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
literal|100
argument_list|)
expr_stmt|;
name|error
operator|=
name|urtw_8225_read
argument_list|(
name|sc
argument_list|,
name|URTW_8225_ADDR_6_MAGIC
argument_list|,
operator|&
name|data32
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|data32
operator|!=
name|URTW_8225_ADDR_6_DATA_MAGIC1
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"expect 0xe6!! (0x%x)\n"
argument_list|,
name|data32
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|data32
operator|&
name|URTW_8225_ADDR_6_DATA_MAGIC2
operator|)
condition|)
block|{
name|urtw_8225_write
argument_list|(
name|sc
argument_list|,
name|URTW_8225_ADDR_2_MAGIC
argument_list|,
name|URTW_8225_ADDR_2_DATA_MAGIC1
argument_list|)
expr_stmt|;
name|usbd_delay_ms
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
literal|100
argument_list|)
expr_stmt|;
name|urtw_8225_write
argument_list|(
name|sc
argument_list|,
name|URTW_8225_ADDR_2_MAGIC
argument_list|,
name|URTW_8225_ADDR_2_DATA_MAGIC2
argument_list|)
expr_stmt|;
name|usbd_delay_ms
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
literal|50
argument_list|)
expr_stmt|;
name|error
operator|=
name|urtw_8225_read
argument_list|(
name|sc
argument_list|,
name|URTW_8225_ADDR_6_MAGIC
argument_list|,
operator|&
name|data32
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
operator|!
operator|(
name|data32
operator|&
name|URTW_8225_ADDR_6_DATA_MAGIC2
operator|)
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"RF calibration failed\n"
argument_list|)
expr_stmt|;
block|}
name|usbd_delay_ms
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
literal|100
argument_list|)
expr_stmt|;
name|urtw_8225_write
argument_list|(
name|sc
argument_list|,
name|URTW_8225_ADDR_0_MAGIC
argument_list|,
name|URTW_8225_ADDR_0_DATA_MAGIC6
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|128
condition|;
name|i
operator|++
control|)
block|{
name|urtw_8187_write_phy_ofdm
argument_list|(
name|sc
argument_list|,
literal|0xb
argument_list|,
name|urtw_8225_agc
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|urtw_8187_write_phy_ofdm
argument_list|(
name|sc
argument_list|,
literal|0xa
argument_list|,
operator|(
name|uint8_t
operator|)
name|i
operator|+
literal|0x80
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|N
argument_list|(
name|urtw_8225v2_rf_part2
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|urtw_8187_write_phy_ofdm
argument_list|(
name|sc
argument_list|,
name|urtw_8225v2_rf_part2
index|[
name|i
index|]
operator|.
name|reg
argument_list|,
name|urtw_8225v2_rf_part2
index|[
name|i
index|]
operator|.
name|val
argument_list|)
expr_stmt|;
block|}
name|error
operator|=
name|urtw_8225v2_setgain
argument_list|(
name|sc
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|N
argument_list|(
name|urtw_8225v2_rf_part3
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|urtw_8187_write_phy_cck
argument_list|(
name|sc
argument_list|,
name|urtw_8225v2_rf_part3
index|[
name|i
index|]
operator|.
name|reg
argument_list|,
name|urtw_8225v2_rf_part3
index|[
name|i
index|]
operator|.
name|val
argument_list|)
expr_stmt|;
block|}
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_ADDR_MAGIC4
argument_list|,
literal|0x0d
argument_list|)
expr_stmt|;
name|error
operator|=
name|urtw_8225v2_set_txpwrlvl
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
name|urtw_8187_write_phy_cck
argument_list|(
name|sc
argument_list|,
literal|0x10
argument_list|,
literal|0x9b
argument_list|)
expr_stmt|;
name|urtw_8187_write_phy_ofdm
argument_list|(
name|sc
argument_list|,
literal|0x26
argument_list|,
literal|0x90
argument_list|)
expr_stmt|;
comment|/* TX ant A, 0x0 for B */
name|error
operator|=
name|urtw_8185_tx_antenna
argument_list|(
name|sc
argument_list|,
literal|0x3
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
name|urtw_write32_m
argument_list|(
name|sc
argument_list|,
name|URTW_ADDR_MAGIC5
argument_list|,
literal|0x3dc00002
argument_list|)
expr_stmt|;
name|error
operator|=
name|urtw_8225_rf_set_chan
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|fail
label|:
return|return
operator|(
name|error
operator|)
return|;
undef|#
directive|undef
name|N
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|urtw_8225v2_rf_set_chan
parameter_list|(
name|struct
name|urtw_softc
modifier|*
name|sc
parameter_list|,
name|int
name|chan
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|sc
operator|->
name|sc_ifp
operator|->
name|if_l2com
decl_stmt|;
name|struct
name|ieee80211_channel
modifier|*
name|c
init|=
name|ic
operator|->
name|ic_curchan
decl_stmt|;
name|usbd_status
name|error
decl_stmt|;
name|error
operator|=
name|urtw_8225v2_set_txpwrlvl
argument_list|(
name|sc
argument_list|,
name|chan
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
name|urtw_8225_write
argument_list|(
name|sc
argument_list|,
name|URTW_8225_ADDR_7_MAGIC
argument_list|,
name|urtw_8225_channel
index|[
name|chan
index|]
argument_list|)
expr_stmt|;
name|usbd_delay_ms
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_SIFS
argument_list|,
literal|0x22
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_state
operator|==
name|IEEE80211_S_ASSOC
operator|&&
name|ic
operator|->
name|ic_flags
operator|&
name|IEEE80211_F_SHSLOT
condition|)
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_SLOT
argument_list|,
literal|0x9
argument_list|)
expr_stmt|;
else|else
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_SLOT
argument_list|,
literal|0x14
argument_list|)
expr_stmt|;
if|if
condition|(
name|IEEE80211_IS_CHAN_G
argument_list|(
name|c
argument_list|)
condition|)
block|{
comment|/* for G */
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_DIFS
argument_list|,
literal|0x14
argument_list|)
expr_stmt|;
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_EIFS
argument_list|,
literal|0x5b
operator|-
literal|0x14
argument_list|)
expr_stmt|;
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_CW_VAL
argument_list|,
literal|0x73
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* for B */
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_DIFS
argument_list|,
literal|0x24
argument_list|)
expr_stmt|;
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_EIFS
argument_list|,
literal|0x5b
operator|-
literal|0x24
argument_list|)
expr_stmt|;
name|urtw_write8_m
argument_list|(
name|sc
argument_list|,
name|URTW_CW_VAL
argument_list|,
literal|0xa5
argument_list|)
expr_stmt|;
block|}
name|fail
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtw_ctxtask
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|urtw_softc
modifier|*
name|sc
init|=
name|arg
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|ifp
operator|->
name|if_l2com
decl_stmt|;
name|uint32_t
name|data
decl_stmt|;
name|usbd_status
name|error
decl_stmt|;
switch|switch
condition|(
name|sc
operator|->
name|sc_ctxarg
condition|)
block|{
case|case
name|URTW_SET_CHANNEL
case|:
comment|/* 		 * during changing th channel we need to temporarily be disable  		 * TX. 		 */
name|urtw_read32_m
argument_list|(
name|sc
argument_list|,
name|URTW_TX_CONF
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
name|data
operator|&=
operator|~
name|URTW_TX_LOOPBACK_MASK
expr_stmt|;
name|urtw_write32_m
argument_list|(
name|sc
argument_list|,
name|URTW_TX_CONF
argument_list|,
name|data
operator||
name|URTW_TX_LOOPBACK_MAC
argument_list|)
expr_stmt|;
name|error
operator|=
name|sc
operator|->
name|sc_rf_set_chan
argument_list|(
name|sc
argument_list|,
name|ieee80211_chan2ieee
argument_list|(
name|ic
argument_list|,
name|ic
operator|->
name|ic_curchan
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
name|usbd_delay_ms
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|urtw_write32_m
argument_list|(
name|sc
argument_list|,
name|URTW_TX_CONF
argument_list|,
name|data
operator||
name|URTW_TX_LOOPBACK_NONE
argument_list|)
expr_stmt|;
break|break;
default|default:
name|panic
argument_list|(
literal|"unknown argument.\n"
argument_list|)
expr_stmt|;
block|}
name|fail
label|:
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not change the channel\n"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|urtw_task
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|urtw_softc
modifier|*
name|sc
init|=
name|arg
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|ifp
operator|->
name|if_l2com
decl_stmt|;
name|struct
name|ieee80211vap
modifier|*
name|vap
init|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|ic
operator|->
name|ic_vaps
argument_list|)
decl_stmt|;
name|struct
name|ieee80211_node
modifier|*
name|ni
init|=
name|vap
operator|->
name|iv_bss
decl_stmt|;
name|struct
name|urtw_vap
modifier|*
name|uvp
init|=
name|URTW_VAP
argument_list|(
name|vap
argument_list|)
decl_stmt|;
name|usbd_status
name|error
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|sc
operator|->
name|sc_state
condition|)
block|{
case|case
name|IEEE80211_S_RUN
case|:
comment|/* setting bssid.  */
name|urtw_write32_m
argument_list|(
name|sc
argument_list|,
name|URTW_BSSID
argument_list|,
operator|(
operator|(
name|uint32_t
operator|*
operator|)
name|ni
operator|->
name|ni_bssid
operator|)
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|urtw_write16_m
argument_list|(
name|sc
argument_list|,
name|URTW_BSSID
operator|+
literal|4
argument_list|,
operator|(
operator|(
name|uint16_t
operator|*
operator|)
name|ni
operator|->
name|ni_bssid
operator|)
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|urtw_update_msr
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* XXX maybe the below would be incorrect.  */
name|urtw_write16_m
argument_list|(
name|sc
argument_list|,
name|URTW_ATIM_WND
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|urtw_write16_m
argument_list|(
name|sc
argument_list|,
name|URTW_ATIM_TR_ITV
argument_list|,
literal|100
argument_list|)
expr_stmt|;
name|urtw_write16_m
argument_list|(
name|sc
argument_list|,
name|URTW_BEACON_INTERVAL
argument_list|,
literal|0x64
argument_list|)
expr_stmt|;
name|urtw_write16_m
argument_list|(
name|sc
argument_list|,
name|URTW_BEACON_INTERVAL_TIME
argument_list|,
literal|100
argument_list|)
expr_stmt|;
name|error
operator|=
name|urtw_led_ctl
argument_list|(
name|sc
argument_list|,
name|URTW_LED_CTL_LINK
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not control LED (%d)\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
name|fail
label|:
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"error duing processing RUN state."
argument_list|)
expr_stmt|;
name|IEEE80211_LOCK
argument_list|(
name|ic
argument_list|)
expr_stmt|;
name|uvp
operator|->
name|newstate
argument_list|(
name|vap
argument_list|,
name|sc
operator|->
name|sc_state
argument_list|,
name|sc
operator|->
name|sc_arg
argument_list|)
expr_stmt|;
if|if
condition|(
name|vap
operator|->
name|iv_newstate_cb
operator|!=
name|NULL
condition|)
name|vap
operator|->
name|iv_newstate_cb
argument_list|(
name|vap
argument_list|,
name|sc
operator|->
name|sc_state
argument_list|,
name|sc
operator|->
name|sc_arg
argument_list|)
expr_stmt|;
name|IEEE80211_UNLOCK
argument_list|(
name|ic
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtw_watchdog
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|urtw_softc
modifier|*
name|sc
init|=
name|arg
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_txtimer
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|sc
operator|->
name|sc_txtimer
operator|==
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"device timeout\n"
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_oerrors
operator|++
expr_stmt|;
return|return;
block|}
name|callout_reset
argument_list|(
operator|&
name|sc
operator|->
name|sc_watchdog_ch
argument_list|,
name|hz
argument_list|,
name|urtw_watchdog
argument_list|,
name|sc
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_decl_stmt
specifier|static
name|device_method_t
name|urtw_methods
index|[]
init|=
block|{
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|urtw_match
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|urtw_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|urtw_detach
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|urtw_driver
init|=
block|{
literal|"urtw"
block|,
name|urtw_methods
block|,
expr|sizeof
operator|(
expr|struct
name|urtw_softc
operator|)
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|urtw_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|urtw
argument_list|,
name|uhub
argument_list|,
name|urtw_driver
argument_list|,
name|urtw_devclass
argument_list|,
name|usbd_driver_load
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|urtw
argument_list|,
name|wlan
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|urtw
argument_list|,
name|usb
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2011 Anybots Inc  * written by Akinori Furukoshi<moonlightakkiy@yahoo.ca>  *  - ucom part is based on u3g.c  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<sys/condvar.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/taskqueue.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_types.h>
end_include

begin_include
include|#
directive|include
file|<net/netisr.h>
end_include

begin_include
include|#
directive|include
file|<net/bpf.h>
end_include

begin_include
include|#
directive|include
file|<net/ethernet.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip6.h>
end_include

begin_include
include|#
directive|include
file|<netinet/udp.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_ioctl.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usbdi.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usbdi_util.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb_cdc.h>
end_include

begin_include
include|#
directive|include
file|"usbdevs.h"
end_include

begin_define
define|#
directive|define
name|USB_DEBUG_VAR
value|usie_debug
end_define

begin_include
include|#
directive|include
file|<dev/usb/usb_debug.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb_process.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb_msctest.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/serial/usb_serial.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/net/if_usievar.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|USB_DEBUG
end_ifdef

begin_decl_stmt
specifier|static
name|int
name|usie_debug
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_expr_stmt
specifier|static
name|SYSCTL_NODE
argument_list|(
name|_hw_usb
argument_list|,
name|OID_AUTO
argument_list|,
name|usie
argument_list|,
name|CTLFLAG_RW
argument_list|,
literal|0
argument_list|,
literal|"sierra USB modem"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_hw_usb_usie
argument_list|,
name|OID_AUTO
argument_list|,
name|debug
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|usie_debug
argument_list|,
literal|0
argument_list|,
literal|"usie debug level"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* Sierra Wireless Direct IP modems */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|STRUCT_USB_HOST_ID
name|usie_devs
index|[]
init|=
block|{
define|#
directive|define
name|USIE_DEV
parameter_list|(
name|v
parameter_list|,
name|d
parameter_list|)
value|{				\     USB_VP(USB_VENDOR_##v, USB_PRODUCT_##v##_##d) }
name|USIE_DEV
argument_list|(
name|SIERRA
argument_list|,
name|MC8700
argument_list|)
block|,
name|USIE_DEV
argument_list|(
name|SIERRA
argument_list|,
name|TRUINSTALL
argument_list|)
block|,
name|USIE_DEV
argument_list|(
name|AIRPRIME
argument_list|,
name|USB308
argument_list|)
block|,
undef|#
directive|undef
name|USIE_DEV
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|device_probe_t
name|usie_probe
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|device_attach_t
name|usie_attach
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|device_detach_t
name|usie_detach
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|usie_free_softc
parameter_list|(
name|struct
name|usie_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|usie_free
parameter_list|(
name|struct
name|ucom_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|usie_uc_update_line_state
parameter_list|(
name|struct
name|ucom_softc
modifier|*
parameter_list|,
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|usie_uc_cfg_get_status
parameter_list|(
name|struct
name|ucom_softc
modifier|*
parameter_list|,
name|uint8_t
modifier|*
parameter_list|,
name|uint8_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|usie_uc_cfg_set_dtr
parameter_list|(
name|struct
name|ucom_softc
modifier|*
parameter_list|,
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|usie_uc_cfg_set_rts
parameter_list|(
name|struct
name|ucom_softc
modifier|*
parameter_list|,
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|usie_uc_cfg_open
parameter_list|(
name|struct
name|ucom_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|usie_uc_cfg_close
parameter_list|(
name|struct
name|ucom_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|usie_uc_start_read
parameter_list|(
name|struct
name|ucom_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|usie_uc_stop_read
parameter_list|(
name|struct
name|ucom_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|usie_uc_start_write
parameter_list|(
name|struct
name|ucom_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|usie_uc_stop_write
parameter_list|(
name|struct
name|ucom_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|usb_callback_t
name|usie_uc_tx_callback
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|usb_callback_t
name|usie_uc_rx_callback
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|usb_callback_t
name|usie_uc_status_callback
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|usb_callback_t
name|usie_if_tx_callback
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|usb_callback_t
name|usie_if_rx_callback
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|usb_callback_t
name|usie_if_status_callback
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|usie_if_sync_to
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|usie_if_sync_cb
parameter_list|(
name|void
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|usie_if_status_cb
parameter_list|(
name|void
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|usie_if_start
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|usie_if_output
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|,
name|struct
name|sockaddr
modifier|*
parameter_list|,
name|struct
name|route
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|usie_if_init
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|usie_if_stop
parameter_list|(
name|struct
name|usie_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|usie_if_ioctl
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|,
name|u_long
parameter_list|,
name|caddr_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|usie_do_request
parameter_list|(
name|struct
name|usie_softc
modifier|*
parameter_list|,
name|struct
name|usb_device_request
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|usie_if_cmd
parameter_list|(
name|struct
name|usie_softc
modifier|*
parameter_list|,
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|usie_cns_req
parameter_list|(
name|struct
name|usie_softc
modifier|*
parameter_list|,
name|uint32_t
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|usie_cns_rsp
parameter_list|(
name|struct
name|usie_softc
modifier|*
parameter_list|,
name|struct
name|usie_cns
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|usie_hip_rsp
parameter_list|(
name|struct
name|usie_softc
modifier|*
parameter_list|,
name|uint8_t
modifier|*
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|usie_driver_loaded
parameter_list|(
name|struct
name|module
modifier|*
parameter_list|,
name|int
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|usb_config
name|usie_uc_config
index|[
name|USIE_UC_N_XFER
index|]
init|=
block|{
index|[
name|USIE_UC_STATUS
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|UE_INTERRUPT
block|,
operator|.
name|endpoint
operator|=
name|UE_ADDR_ANY
block|,
operator|.
name|direction
operator|=
name|UE_DIR_IN
block|,
operator|.
name|bufsize
operator|=
literal|0
block|,
comment|/* use wMaxPacketSize */
operator|.
name|flags
operator|=
block|{
operator|.
name|pipe_bof
operator|=
literal|1
block|,
operator|.
name|short_xfer_ok
operator|=
literal|1
block|,}
block|,
operator|.
name|callback
operator|=
operator|&
name|usie_uc_status_callback
block|, 	}
block|,
index|[
name|USIE_UC_RX
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|UE_BULK
block|,
operator|.
name|endpoint
operator|=
name|UE_ADDR_ANY
block|,
operator|.
name|direction
operator|=
name|UE_DIR_IN
block|,
operator|.
name|bufsize
operator|=
name|USIE_BUFSIZE
block|,
operator|.
name|flags
operator|=
block|{
operator|.
name|pipe_bof
operator|=
literal|1
block|,
operator|.
name|short_xfer_ok
operator|=
literal|1
block|,
operator|.
name|proxy_buffer
operator|=
literal|1
block|,}
block|,
operator|.
name|callback
operator|=
operator|&
name|usie_uc_rx_callback
block|, 	}
block|,
index|[
name|USIE_UC_TX
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|UE_BULK
block|,
operator|.
name|endpoint
operator|=
name|UE_ADDR_ANY
block|,
operator|.
name|direction
operator|=
name|UE_DIR_OUT
block|,
operator|.
name|bufsize
operator|=
name|USIE_BUFSIZE
block|,
operator|.
name|flags
operator|=
block|{
operator|.
name|pipe_bof
operator|=
literal|1
block|,
operator|.
name|force_short_xfer
operator|=
literal|1
block|,}
block|,
operator|.
name|callback
operator|=
operator|&
name|usie_uc_tx_callback
block|, 	}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|usb_config
name|usie_if_config
index|[
name|USIE_IF_N_XFER
index|]
init|=
block|{
index|[
name|USIE_IF_STATUS
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|UE_INTERRUPT
block|,
operator|.
name|endpoint
operator|=
name|UE_ADDR_ANY
block|,
operator|.
name|direction
operator|=
name|UE_DIR_IN
block|,
operator|.
name|bufsize
operator|=
literal|0
block|,
comment|/* use wMaxPacketSize */
operator|.
name|flags
operator|=
block|{
operator|.
name|pipe_bof
operator|=
literal|1
block|,
operator|.
name|short_xfer_ok
operator|=
literal|1
block|,}
block|,
operator|.
name|callback
operator|=
operator|&
name|usie_if_status_callback
block|, 	}
block|,
index|[
name|USIE_IF_RX
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|UE_BULK
block|,
operator|.
name|endpoint
operator|=
name|UE_ADDR_ANY
block|,
operator|.
name|direction
operator|=
name|UE_DIR_IN
block|,
operator|.
name|bufsize
operator|=
name|USIE_BUFSIZE
block|,
operator|.
name|flags
operator|=
block|{
operator|.
name|pipe_bof
operator|=
literal|1
block|,
operator|.
name|short_xfer_ok
operator|=
literal|1
block|,}
block|,
operator|.
name|callback
operator|=
operator|&
name|usie_if_rx_callback
block|, 	}
block|,
index|[
name|USIE_IF_TX
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|UE_BULK
block|,
operator|.
name|endpoint
operator|=
name|UE_ADDR_ANY
block|,
operator|.
name|direction
operator|=
name|UE_DIR_OUT
block|,
operator|.
name|bufsize
operator|=
name|MAX
argument_list|(
name|USIE_BUFSIZE
argument_list|,
name|MCLBYTES
argument_list|)
block|,
operator|.
name|flags
operator|=
block|{
operator|.
name|pipe_bof
operator|=
literal|1
block|,
operator|.
name|force_short_xfer
operator|=
literal|1
block|,}
block|,
operator|.
name|callback
operator|=
operator|&
name|usie_if_tx_callback
block|, 	}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|device_method_t
name|usie_methods
index|[]
init|=
block|{
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|usie_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|usie_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|usie_detach
argument_list|)
block|,
name|DEVMETHOD_END
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|usie_driver
init|=
block|{
operator|.
name|name
operator|=
literal|"usie"
block|,
operator|.
name|methods
operator|=
name|usie_methods
block|,
operator|.
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|usie_softc
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|usie_devclass
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|eventhandler_tag
name|usie_etag
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|usie
argument_list|,
name|uhub
argument_list|,
name|usie_driver
argument_list|,
name|usie_devclass
argument_list|,
name|usie_driver_loaded
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|usie
argument_list|,
name|ucom
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|usie
argument_list|,
name|usb
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_VERSION
argument_list|(
name|usie
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|ucom_callback
name|usie_uc_callback
init|=
block|{
operator|.
name|ucom_cfg_get_status
operator|=
operator|&
name|usie_uc_cfg_get_status
block|,
operator|.
name|ucom_cfg_set_dtr
operator|=
operator|&
name|usie_uc_cfg_set_dtr
block|,
operator|.
name|ucom_cfg_set_rts
operator|=
operator|&
name|usie_uc_cfg_set_rts
block|,
operator|.
name|ucom_cfg_open
operator|=
operator|&
name|usie_uc_cfg_open
block|,
operator|.
name|ucom_cfg_close
operator|=
operator|&
name|usie_uc_cfg_close
block|,
operator|.
name|ucom_start_read
operator|=
operator|&
name|usie_uc_start_read
block|,
operator|.
name|ucom_stop_read
operator|=
operator|&
name|usie_uc_stop_read
block|,
operator|.
name|ucom_start_write
operator|=
operator|&
name|usie_uc_start_write
block|,
operator|.
name|ucom_stop_write
operator|=
operator|&
name|usie_uc_stop_write
block|,
operator|.
name|ucom_free
operator|=
operator|&
name|usie_free
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|usie_autoinst
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|struct
name|usb_device
modifier|*
name|udev
parameter_list|,
name|struct
name|usb_attach_arg
modifier|*
name|uaa
parameter_list|)
block|{
name|struct
name|usb_interface
modifier|*
name|iface
decl_stmt|;
name|struct
name|usb_interface_descriptor
modifier|*
name|id
decl_stmt|;
name|struct
name|usb_device_request
name|req
decl_stmt|;
name|int
name|err
decl_stmt|;
if|if
condition|(
name|uaa
operator|->
name|dev_state
operator|!=
name|UAA_DEV_READY
condition|)
return|return;
name|iface
operator|=
name|usbd_get_iface
argument_list|(
name|udev
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|iface
operator|==
name|NULL
condition|)
return|return;
name|id
operator|=
name|iface
operator|->
name|idesc
expr_stmt|;
if|if
condition|(
name|id
operator|==
name|NULL
operator|||
name|id
operator|->
name|bInterfaceClass
operator|!=
name|UICLASS_MASS
condition|)
return|return;
if|if
condition|(
name|usbd_lookup_id_by_uaa
argument_list|(
name|usie_devs
argument_list|,
sizeof|sizeof
argument_list|(
name|usie_devs
argument_list|)
argument_list|,
name|uaa
argument_list|)
operator|!=
literal|0
condition|)
return|return;
comment|/* no device match */
if|if
condition|(
name|bootverbose
condition|)
block|{
name|DPRINTF
argument_list|(
literal|"Ejecting %s %s\n"
argument_list|,
name|usb_get_manufacturer
argument_list|(
name|udev
argument_list|)
argument_list|,
name|usb_get_product
argument_list|(
name|udev
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|req
operator|.
name|bmRequestType
operator|=
name|UT_VENDOR
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|UR_SET_INTERFACE
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
name|UF_DEVICE_REMOTE_WAKEUP
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
name|UHF_PORT_CONNECTION
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* at this moment there is no mutex */
name|err
operator|=
name|usbd_do_request_flags
argument_list|(
name|udev
argument_list|,
name|NULL
argument_list|,
operator|&
name|req
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|250
comment|/* ms */
argument_list|)
expr_stmt|;
comment|/* success, mark the udev as disappearing */
if|if
condition|(
name|err
operator|==
literal|0
condition|)
name|uaa
operator|->
name|dev_state
operator|=
name|UAA_DEV_EJECTING
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|usie_probe
parameter_list|(
name|device_t
name|self
parameter_list|)
block|{
name|struct
name|usb_attach_arg
modifier|*
name|uaa
init|=
name|device_get_ivars
argument_list|(
name|self
argument_list|)
decl_stmt|;
if|if
condition|(
name|uaa
operator|->
name|usb_mode
operator|!=
name|USB_MODE_HOST
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
name|uaa
operator|->
name|info
operator|.
name|bConfigIndex
operator|!=
name|USIE_CNFG_INDEX
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
name|uaa
operator|->
name|info
operator|.
name|bIfaceIndex
operator|!=
name|USIE_IFACE_INDEX
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
name|uaa
operator|->
name|info
operator|.
name|bInterfaceClass
operator|!=
name|UICLASS_VENDOR
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
return|return
operator|(
name|usbd_lookup_id_by_uaa
argument_list|(
name|usie_devs
argument_list|,
sizeof|sizeof
argument_list|(
name|usie_devs
argument_list|)
argument_list|,
name|uaa
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|usie_attach
parameter_list|(
name|device_t
name|self
parameter_list|)
block|{
name|struct
name|usie_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|self
argument_list|)
decl_stmt|;
name|struct
name|usb_attach_arg
modifier|*
name|uaa
init|=
name|device_get_ivars
argument_list|(
name|self
argument_list|)
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|struct
name|usb_interface
modifier|*
name|iface
decl_stmt|;
name|struct
name|usb_interface_descriptor
modifier|*
name|id
decl_stmt|;
name|struct
name|usb_device_request
name|req
decl_stmt|;
name|int
name|err
decl_stmt|;
name|uint16_t
name|fwattr
decl_stmt|;
name|uint8_t
name|iface_index
decl_stmt|;
name|uint8_t
name|ifidx
decl_stmt|;
name|uint8_t
name|start
decl_stmt|;
name|device_set_usb_desc
argument_list|(
name|self
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_udev
operator|=
name|uaa
operator|->
name|device
expr_stmt|;
name|sc
operator|->
name|sc_dev
operator|=
name|self
expr_stmt|;
name|mtx_init
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|,
literal|"usie"
argument_list|,
name|MTX_NETWORK_LOCK
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
name|ucom_ref
argument_list|(
operator|&
name|sc
operator|->
name|sc_super_ucom
argument_list|)
expr_stmt|;
name|TASK_INIT
argument_list|(
operator|&
name|sc
operator|->
name|sc_if_status_task
argument_list|,
literal|0
argument_list|,
name|usie_if_status_cb
argument_list|,
name|sc
argument_list|)
expr_stmt|;
name|TASK_INIT
argument_list|(
operator|&
name|sc
operator|->
name|sc_if_sync_task
argument_list|,
literal|0
argument_list|,
name|usie_if_sync_cb
argument_list|,
name|sc
argument_list|)
expr_stmt|;
name|usb_callout_init_mtx
argument_list|(
operator|&
name|sc
operator|->
name|sc_if_sync_ch
argument_list|,
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
comment|/* set power mode to D0 */
name|req
operator|.
name|bmRequestType
operator|=
name|UT_WRITE_VENDOR_DEVICE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|USIE_POWER
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|usie_do_request
argument_list|(
name|sc
argument_list|,
operator|&
name|req
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|mtx_unlock
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
goto|goto
name|detach
goto|;
block|}
comment|/* read fw attr */
name|fwattr
operator|=
literal|0
expr_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_READ_VENDOR_DEVICE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|USIE_FW_ATTR
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
sizeof|sizeof
argument_list|(
name|fwattr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|usie_do_request
argument_list|(
name|sc
argument_list|,
operator|&
name|req
argument_list|,
operator|&
name|fwattr
argument_list|)
condition|)
block|{
name|mtx_unlock
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
goto|goto
name|detach
goto|;
block|}
name|mtx_unlock
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
comment|/* check DHCP supports */
name|DPRINTF
argument_list|(
literal|"fwattr=%x\n"
argument_list|,
name|fwattr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|fwattr
operator|&
name|USIE_FW_DHCP
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|self
argument_list|,
literal|"DHCP is not supported. A firmware upgrade might be needed.\n"
argument_list|)
expr_stmt|;
block|}
comment|/* find available interfaces */
name|sc
operator|->
name|sc_nucom
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|ifidx
operator|=
literal|0
init|;
name|ifidx
operator|<
name|USIE_IFACE_MAX
condition|;
name|ifidx
operator|++
control|)
block|{
name|iface
operator|=
name|usbd_get_iface
argument_list|(
name|uaa
operator|->
name|device
argument_list|,
name|ifidx
argument_list|)
expr_stmt|;
if|if
condition|(
name|iface
operator|==
name|NULL
condition|)
break|break;
name|id
operator|=
name|usbd_get_interface_descriptor
argument_list|(
name|iface
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|id
operator|==
name|NULL
operator|)
operator|||
operator|(
name|id
operator|->
name|bInterfaceClass
operator|!=
name|UICLASS_VENDOR
operator|)
condition|)
continue|continue;
comment|/* setup Direct IP transfer */
if|if
condition|(
name|id
operator|->
name|bInterfaceNumber
operator|>=
literal|7
operator|&&
name|id
operator|->
name|bNumEndpoints
operator|==
literal|3
condition|)
block|{
name|sc
operator|->
name|sc_if_ifnum
operator|=
name|id
operator|->
name|bInterfaceNumber
expr_stmt|;
name|iface_index
operator|=
name|ifidx
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"ifnum=%d, ifidx=%d\n"
argument_list|,
name|sc
operator|->
name|sc_if_ifnum
argument_list|,
name|ifidx
argument_list|)
expr_stmt|;
name|err
operator|=
name|usbd_transfer_setup
argument_list|(
name|uaa
operator|->
name|device
argument_list|,
operator|&
name|iface_index
argument_list|,
name|sc
operator|->
name|sc_if_xfer
argument_list|,
name|usie_if_config
argument_list|,
name|USIE_IF_N_XFER
argument_list|,
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
literal|0
condition|)
continue|continue;
name|device_printf
argument_list|(
name|self
argument_list|,
literal|"could not allocate USB transfers on "
literal|"iface_index=%d, err=%s\n"
argument_list|,
name|iface_index
argument_list|,
name|usbd_errstr
argument_list|(
name|err
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|detach
goto|;
block|}
comment|/* setup ucom */
if|if
condition|(
name|sc
operator|->
name|sc_nucom
operator|>=
name|USIE_UCOM_MAX
condition|)
continue|continue;
name|usbd_set_parent_iface
argument_list|(
name|uaa
operator|->
name|device
argument_list|,
name|ifidx
argument_list|,
name|uaa
operator|->
name|info
operator|.
name|bIfaceIndex
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"NumEndpoints=%d bInterfaceNumber=%d\n"
argument_list|,
name|id
operator|->
name|bNumEndpoints
argument_list|,
name|id
operator|->
name|bInterfaceNumber
argument_list|)
expr_stmt|;
if|if
condition|(
name|id
operator|->
name|bNumEndpoints
operator|==
literal|2
condition|)
block|{
name|sc
operator|->
name|sc_uc_xfer
index|[
name|sc
operator|->
name|sc_nucom
index|]
index|[
literal|0
index|]
operator|=
name|NULL
expr_stmt|;
name|start
operator|=
literal|1
expr_stmt|;
block|}
else|else
name|start
operator|=
literal|0
expr_stmt|;
name|err
operator|=
name|usbd_transfer_setup
argument_list|(
name|uaa
operator|->
name|device
argument_list|,
operator|&
name|ifidx
argument_list|,
name|sc
operator|->
name|sc_uc_xfer
index|[
name|sc
operator|->
name|sc_nucom
index|]
operator|+
name|start
argument_list|,
name|usie_uc_config
operator|+
name|start
argument_list|,
name|USIE_UC_N_XFER
operator|-
name|start
argument_list|,
operator|&
name|sc
operator|->
name|sc_ucom
index|[
name|sc
operator|->
name|sc_nucom
index|]
argument_list|,
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
block|{
name|DPRINTF
argument_list|(
literal|"usbd_transfer_setup error=%s\n"
argument_list|,
name|usbd_errstr
argument_list|(
name|err
argument_list|)
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|mtx_lock
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
for|for
control|(
init|;
name|start
operator|<
name|USIE_UC_N_XFER
condition|;
name|start
operator|++
control|)
name|usbd_xfer_set_stall
argument_list|(
name|sc
operator|->
name|sc_uc_xfer
index|[
name|sc
operator|->
name|sc_nucom
index|]
index|[
name|start
index|]
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_uc_ifnum
index|[
name|sc
operator|->
name|sc_nucom
index|]
operator|=
name|id
operator|->
name|bInterfaceNumber
expr_stmt|;
name|sc
operator|->
name|sc_nucom
operator|++
expr_stmt|;
comment|/* found a port */
block|}
if|if
condition|(
name|sc
operator|->
name|sc_nucom
operator|==
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|self
argument_list|,
literal|"no comports found\n"
argument_list|)
expr_stmt|;
goto|goto
name|detach
goto|;
block|}
name|err
operator|=
name|ucom_attach
argument_list|(
operator|&
name|sc
operator|->
name|sc_super_ucom
argument_list|,
name|sc
operator|->
name|sc_ucom
argument_list|,
name|sc
operator|->
name|sc_nucom
argument_list|,
name|sc
argument_list|,
operator|&
name|usie_uc_callback
argument_list|,
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
block|{
name|DPRINTF
argument_list|(
literal|"ucom_attach failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|detach
goto|;
block|}
name|DPRINTF
argument_list|(
literal|"Found %d interfaces.\n"
argument_list|,
name|sc
operator|->
name|sc_nucom
argument_list|)
expr_stmt|;
comment|/* setup ifnet (Direct IP) */
name|sc
operator|->
name|sc_ifp
operator|=
name|ifp
operator|=
name|if_alloc
argument_list|(
name|IFT_OTHER
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|self
argument_list|,
literal|"Could not allocate a network interface\n"
argument_list|)
expr_stmt|;
goto|goto
name|detach
goto|;
block|}
name|if_initname
argument_list|(
name|ifp
argument_list|,
literal|"usie"
argument_list|,
name|device_get_unit
argument_list|(
name|self
argument_list|)
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_softc
operator|=
name|sc
expr_stmt|;
name|ifp
operator|->
name|if_mtu
operator|=
name|USIE_MTU_MAX
expr_stmt|;
name|ifp
operator|->
name|if_flags
operator||=
name|IFF_NOARP
expr_stmt|;
name|ifp
operator|->
name|if_init
operator|=
name|usie_if_init
expr_stmt|;
name|ifp
operator|->
name|if_ioctl
operator|=
name|usie_if_ioctl
expr_stmt|;
name|ifp
operator|->
name|if_start
operator|=
name|usie_if_start
expr_stmt|;
name|ifp
operator|->
name|if_output
operator|=
name|usie_if_output
expr_stmt|;
name|IFQ_SET_MAXLEN
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|,
name|ifqmaxlen
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_snd
operator|.
name|ifq_drv_maxlen
operator|=
name|ifqmaxlen
expr_stmt|;
name|IFQ_SET_READY
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|)
expr_stmt|;
name|if_attach
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|bpfattach
argument_list|(
name|ifp
argument_list|,
name|DLT_RAW
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|fwattr
operator|&
name|USIE_PM_AUTO
condition|)
block|{
name|usbd_set_power_mode
argument_list|(
name|uaa
operator|->
name|device
argument_list|,
name|USB_POWER_MODE_SAVE
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"enabling automatic suspend and resume\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|usbd_set_power_mode
argument_list|(
name|uaa
operator|->
name|device
argument_list|,
name|USB_POWER_MODE_ON
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"USB power is always ON\n"
argument_list|)
expr_stmt|;
block|}
name|DPRINTF
argument_list|(
literal|"device attached\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|detach
label|:
name|usie_detach
argument_list|(
name|self
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|usie_detach
parameter_list|(
name|device_t
name|self
parameter_list|)
block|{
name|struct
name|usie_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|self
argument_list|)
decl_stmt|;
name|uint8_t
name|x
decl_stmt|;
comment|/* detach ifnet */
if|if
condition|(
name|sc
operator|->
name|sc_ifp
operator|!=
name|NULL
condition|)
block|{
name|usie_if_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|usbd_transfer_unsetup
argument_list|(
name|sc
operator|->
name|sc_if_xfer
argument_list|,
name|USIE_IF_N_XFER
argument_list|)
expr_stmt|;
name|bpfdetach
argument_list|(
name|sc
operator|->
name|sc_ifp
argument_list|)
expr_stmt|;
name|if_detach
argument_list|(
name|sc
operator|->
name|sc_ifp
argument_list|)
expr_stmt|;
name|if_free
argument_list|(
name|sc
operator|->
name|sc_ifp
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_ifp
operator|=
name|NULL
expr_stmt|;
block|}
comment|/* detach ucom */
if|if
condition|(
name|sc
operator|->
name|sc_nucom
operator|>
literal|0
condition|)
name|ucom_detach
argument_list|(
operator|&
name|sc
operator|->
name|sc_super_ucom
argument_list|,
name|sc
operator|->
name|sc_ucom
argument_list|)
expr_stmt|;
comment|/* stop all USB transfers */
name|usbd_transfer_unsetup
argument_list|(
name|sc
operator|->
name|sc_if_xfer
argument_list|,
name|USIE_IF_N_XFER
argument_list|)
expr_stmt|;
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|!=
name|USIE_UCOM_MAX
condition|;
name|x
operator|++
control|)
name|usbd_transfer_unsetup
argument_list|(
name|sc
operator|->
name|sc_uc_xfer
index|[
name|x
index|]
argument_list|,
name|USIE_UC_N_XFER
argument_list|)
expr_stmt|;
name|device_claim_softc
argument_list|(
name|self
argument_list|)
expr_stmt|;
name|usie_free_softc
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_expr_stmt
name|UCOM_UNLOAD_DRAIN
argument_list|(
name|usie
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|void
name|usie_free_softc
parameter_list|(
name|struct
name|usie_softc
modifier|*
name|sc
parameter_list|)
block|{
if|if
condition|(
name|ucom_unref
argument_list|(
operator|&
name|sc
operator|->
name|sc_super_ucom
argument_list|)
condition|)
block|{
name|mtx_destroy
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
name|device_free_softc
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|usie_free
parameter_list|(
name|struct
name|ucom_softc
modifier|*
name|ucom
parameter_list|)
block|{
name|usie_free_softc
argument_list|(
name|ucom
operator|->
name|sc_parent
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|usie_uc_update_line_state
parameter_list|(
name|struct
name|ucom_softc
modifier|*
name|ucom
parameter_list|,
name|uint8_t
name|ls
parameter_list|)
block|{
name|struct
name|usie_softc
modifier|*
name|sc
init|=
name|ucom
operator|->
name|sc_parent
decl_stmt|;
name|struct
name|usb_device_request
name|req
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_uc_xfer
index|[
name|ucom
operator|->
name|sc_subunit
index|]
index|[
name|USIE_UC_STATUS
index|]
operator|==
name|NULL
condition|)
return|return;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_WRITE_CLASS_INTERFACE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|USIE_LINK_STATE
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
name|ls
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
name|sc
operator|->
name|sc_uc_ifnum
index|[
name|ucom
operator|->
name|sc_subunit
index|]
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"sc_uc_ifnum=%d\n"
argument_list|,
name|sc
operator|->
name|sc_uc_ifnum
index|[
name|ucom
operator|->
name|sc_subunit
index|]
argument_list|)
expr_stmt|;
name|usie_do_request
argument_list|(
name|sc
argument_list|,
operator|&
name|req
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|usie_uc_cfg_get_status
parameter_list|(
name|struct
name|ucom_softc
modifier|*
name|ucom
parameter_list|,
name|uint8_t
modifier|*
name|lsr
parameter_list|,
name|uint8_t
modifier|*
name|msr
parameter_list|)
block|{
name|struct
name|usie_softc
modifier|*
name|sc
init|=
name|ucom
operator|->
name|sc_parent
decl_stmt|;
operator|*
name|msr
operator|=
name|sc
operator|->
name|sc_msr
expr_stmt|;
operator|*
name|lsr
operator|=
name|sc
operator|->
name|sc_lsr
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|usie_uc_cfg_set_dtr
parameter_list|(
name|struct
name|ucom_softc
modifier|*
name|ucom
parameter_list|,
name|uint8_t
name|flag
parameter_list|)
block|{
name|uint8_t
name|dtr
decl_stmt|;
name|dtr
operator|=
name|flag
condition|?
name|USIE_LS_DTR
else|:
literal|0
expr_stmt|;
name|usie_uc_update_line_state
argument_list|(
name|ucom
argument_list|,
name|dtr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|usie_uc_cfg_set_rts
parameter_list|(
name|struct
name|ucom_softc
modifier|*
name|ucom
parameter_list|,
name|uint8_t
name|flag
parameter_list|)
block|{
name|uint8_t
name|rts
decl_stmt|;
name|rts
operator|=
name|flag
condition|?
name|USIE_LS_RTS
else|:
literal|0
expr_stmt|;
name|usie_uc_update_line_state
argument_list|(
name|ucom
argument_list|,
name|rts
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|usie_uc_cfg_open
parameter_list|(
name|struct
name|ucom_softc
modifier|*
name|ucom
parameter_list|)
block|{
name|struct
name|usie_softc
modifier|*
name|sc
init|=
name|ucom
operator|->
name|sc_parent
decl_stmt|;
comment|/* usbd_transfer_start() is NULL safe */
name|usbd_transfer_start
argument_list|(
name|sc
operator|->
name|sc_uc_xfer
index|[
name|ucom
operator|->
name|sc_subunit
index|]
index|[
name|USIE_UC_STATUS
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|usie_uc_cfg_close
parameter_list|(
name|struct
name|ucom_softc
modifier|*
name|ucom
parameter_list|)
block|{
name|struct
name|usie_softc
modifier|*
name|sc
init|=
name|ucom
operator|->
name|sc_parent
decl_stmt|;
name|usbd_transfer_stop
argument_list|(
name|sc
operator|->
name|sc_uc_xfer
index|[
name|ucom
operator|->
name|sc_subunit
index|]
index|[
name|USIE_UC_STATUS
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|usie_uc_start_read
parameter_list|(
name|struct
name|ucom_softc
modifier|*
name|ucom
parameter_list|)
block|{
name|struct
name|usie_softc
modifier|*
name|sc
init|=
name|ucom
operator|->
name|sc_parent
decl_stmt|;
name|usbd_transfer_start
argument_list|(
name|sc
operator|->
name|sc_uc_xfer
index|[
name|ucom
operator|->
name|sc_subunit
index|]
index|[
name|USIE_UC_RX
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|usie_uc_stop_read
parameter_list|(
name|struct
name|ucom_softc
modifier|*
name|ucom
parameter_list|)
block|{
name|struct
name|usie_softc
modifier|*
name|sc
init|=
name|ucom
operator|->
name|sc_parent
decl_stmt|;
name|usbd_transfer_stop
argument_list|(
name|sc
operator|->
name|sc_uc_xfer
index|[
name|ucom
operator|->
name|sc_subunit
index|]
index|[
name|USIE_UC_RX
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|usie_uc_start_write
parameter_list|(
name|struct
name|ucom_softc
modifier|*
name|ucom
parameter_list|)
block|{
name|struct
name|usie_softc
modifier|*
name|sc
init|=
name|ucom
operator|->
name|sc_parent
decl_stmt|;
name|usbd_transfer_start
argument_list|(
name|sc
operator|->
name|sc_uc_xfer
index|[
name|ucom
operator|->
name|sc_subunit
index|]
index|[
name|USIE_UC_TX
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|usie_uc_stop_write
parameter_list|(
name|struct
name|ucom_softc
modifier|*
name|ucom
parameter_list|)
block|{
name|struct
name|usie_softc
modifier|*
name|sc
init|=
name|ucom
operator|->
name|sc_parent
decl_stmt|;
name|usbd_transfer_stop
argument_list|(
name|sc
operator|->
name|sc_uc_xfer
index|[
name|ucom
operator|->
name|sc_subunit
index|]
index|[
name|USIE_UC_TX
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|usie_uc_rx_callback
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|,
name|usb_error_t
name|error
parameter_list|)
block|{
name|struct
name|ucom_softc
modifier|*
name|ucom
init|=
name|usbd_xfer_softc
argument_list|(
name|xfer
argument_list|)
decl_stmt|;
name|struct
name|usie_softc
modifier|*
name|sc
init|=
name|ucom
operator|->
name|sc_parent
decl_stmt|;
name|struct
name|usb_page_cache
modifier|*
name|pc
decl_stmt|;
name|uint32_t
name|actlen
decl_stmt|;
name|usbd_xfer_status
argument_list|(
name|xfer
argument_list|,
operator|&
name|actlen
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|USB_GET_STATE
argument_list|(
name|xfer
argument_list|)
condition|)
block|{
case|case
name|USB_ST_TRANSFERRED
case|:
name|pc
operator|=
name|usbd_xfer_get_frame
argument_list|(
name|xfer
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* handle CnS response */
if|if
condition|(
name|ucom
operator|==
name|sc
operator|->
name|sc_ucom
operator|&&
name|actlen
operator|>=
name|USIE_HIPCNS_MIN
condition|)
block|{
name|DPRINTF
argument_list|(
literal|"transferred=%u\n"
argument_list|,
name|actlen
argument_list|)
expr_stmt|;
comment|/* check if it is really CnS reply */
name|usbd_copy_out
argument_list|(
name|pc
argument_list|,
literal|0
argument_list|,
name|sc
operator|->
name|sc_resp_temp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_resp_temp
index|[
literal|0
index|]
operator|==
name|USIE_HIP_FRM_CHR
condition|)
block|{
comment|/* verify actlen */
if|if
condition|(
name|actlen
operator|>
name|USIE_BUFSIZE
condition|)
name|actlen
operator|=
name|USIE_BUFSIZE
expr_stmt|;
comment|/* get complete message */
name|usbd_copy_out
argument_list|(
name|pc
argument_list|,
literal|0
argument_list|,
name|sc
operator|->
name|sc_resp_temp
argument_list|,
name|actlen
argument_list|)
expr_stmt|;
name|usie_hip_rsp
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|sc_resp_temp
argument_list|,
name|actlen
argument_list|)
expr_stmt|;
comment|/* need to fall though */
goto|goto
name|tr_setup
goto|;
block|}
comment|/* else call ucom_put_data() */
block|}
comment|/* standard ucom transfer */
name|ucom_put_data
argument_list|(
name|ucom
argument_list|,
name|pc
argument_list|,
literal|0
argument_list|,
name|actlen
argument_list|)
expr_stmt|;
comment|/* fall though */
case|case
name|USB_ST_SETUP
case|:
name|tr_setup
label|:
name|usbd_xfer_set_frame_len
argument_list|(
name|xfer
argument_list|,
literal|0
argument_list|,
name|usbd_xfer_max_len
argument_list|(
name|xfer
argument_list|)
argument_list|)
expr_stmt|;
name|usbd_transfer_submit
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|/* Error */
if|if
condition|(
name|error
operator|!=
name|USB_ERR_CANCELLED
condition|)
block|{
name|usbd_xfer_set_stall
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
goto|goto
name|tr_setup
goto|;
block|}
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|usie_uc_tx_callback
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|,
name|usb_error_t
name|error
parameter_list|)
block|{
name|struct
name|ucom_softc
modifier|*
name|ucom
init|=
name|usbd_xfer_softc
argument_list|(
name|xfer
argument_list|)
decl_stmt|;
name|struct
name|usb_page_cache
modifier|*
name|pc
decl_stmt|;
name|uint32_t
name|actlen
decl_stmt|;
switch|switch
condition|(
name|USB_GET_STATE
argument_list|(
name|xfer
argument_list|)
condition|)
block|{
case|case
name|USB_ST_TRANSFERRED
case|:
case|case
name|USB_ST_SETUP
case|:
name|tr_setup
label|:
name|pc
operator|=
name|usbd_xfer_get_frame
argument_list|(
name|xfer
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* handle CnS request */
name|struct
name|mbuf
modifier|*
name|m
init|=
name|usbd_xfer_get_priv
argument_list|(
name|xfer
argument_list|)
decl_stmt|;
if|if
condition|(
name|m
operator|!=
name|NULL
condition|)
block|{
name|usbd_m_copy_in
argument_list|(
name|pc
argument_list|,
literal|0
argument_list|,
name|m
argument_list|,
literal|0
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|)
expr_stmt|;
name|usbd_xfer_set_frame_len
argument_list|(
name|xfer
argument_list|,
literal|0
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|)
expr_stmt|;
name|usbd_xfer_set_priv
argument_list|(
name|xfer
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|usbd_transfer_submit
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* standard ucom transfer */
if|if
condition|(
name|ucom_get_data
argument_list|(
name|ucom
argument_list|,
name|pc
argument_list|,
literal|0
argument_list|,
name|USIE_BUFSIZE
argument_list|,
operator|&
name|actlen
argument_list|)
condition|)
block|{
name|usbd_xfer_set_frame_len
argument_list|(
name|xfer
argument_list|,
literal|0
argument_list|,
name|actlen
argument_list|)
expr_stmt|;
name|usbd_transfer_submit
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
comment|/* Error */
if|if
condition|(
name|error
operator|!=
name|USB_ERR_CANCELLED
condition|)
block|{
name|usbd_xfer_set_stall
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
goto|goto
name|tr_setup
goto|;
block|}
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|usie_uc_status_callback
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|,
name|usb_error_t
name|error
parameter_list|)
block|{
name|struct
name|usb_page_cache
modifier|*
name|pc
decl_stmt|;
struct|struct
block|{
name|struct
name|usb_device_request
name|req
decl_stmt|;
name|uint16_t
name|param
decl_stmt|;
block|}
name|st
struct|;
name|uint32_t
name|actlen
decl_stmt|;
name|uint16_t
name|param
decl_stmt|;
name|usbd_xfer_status
argument_list|(
name|xfer
argument_list|,
operator|&
name|actlen
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|USB_GET_STATE
argument_list|(
name|xfer
argument_list|)
condition|)
block|{
case|case
name|USB_ST_TRANSFERRED
case|:
name|DPRINTFN
argument_list|(
literal|4
argument_list|,
literal|"info received, actlen=%u\n"
argument_list|,
name|actlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|actlen
operator|<
sizeof|sizeof
argument_list|(
name|st
argument_list|)
condition|)
block|{
name|DPRINTF
argument_list|(
literal|"data too short actlen=%u\n"
argument_list|,
name|actlen
argument_list|)
expr_stmt|;
goto|goto
name|tr_setup
goto|;
block|}
name|pc
operator|=
name|usbd_xfer_get_frame
argument_list|(
name|xfer
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|usbd_copy_out
argument_list|(
name|pc
argument_list|,
literal|0
argument_list|,
operator|&
name|st
argument_list|,
sizeof|sizeof
argument_list|(
name|st
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|st
operator|.
name|req
operator|.
name|bmRequestType
operator|==
literal|0xa1
operator|&&
name|st
operator|.
name|req
operator|.
name|bRequest
operator|==
literal|0x20
condition|)
block|{
name|struct
name|ucom_softc
modifier|*
name|ucom
init|=
name|usbd_xfer_softc
argument_list|(
name|xfer
argument_list|)
decl_stmt|;
name|struct
name|usie_softc
modifier|*
name|sc
init|=
name|ucom
operator|->
name|sc_parent
decl_stmt|;
name|param
operator|=
name|le16toh
argument_list|(
name|st
operator|.
name|param
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"param=%x\n"
argument_list|,
name|param
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_msr
operator|=
name|sc
operator|->
name|sc_lsr
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_msr
operator||=
operator|(
name|param
operator|&
name|USIE_DCD
operator|)
condition|?
name|SER_DCD
else|:
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_msr
operator||=
operator|(
name|param
operator|&
name|USIE_DSR
operator|)
condition|?
name|SER_DSR
else|:
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_msr
operator||=
operator|(
name|param
operator|&
name|USIE_RI
operator|)
condition|?
name|SER_RI
else|:
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_msr
operator||=
operator|(
name|param
operator|&
name|USIE_CTS
operator|)
condition|?
literal|0
else|:
name|SER_CTS
expr_stmt|;
name|sc
operator|->
name|sc_msr
operator||=
operator|(
name|param
operator|&
name|USIE_RTS
operator|)
condition|?
name|SER_RTS
else|:
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_msr
operator||=
operator|(
name|param
operator|&
name|USIE_DTR
operator|)
condition|?
name|SER_DTR
else|:
literal|0
expr_stmt|;
block|}
comment|/* fall though */
case|case
name|USB_ST_SETUP
case|:
name|tr_setup
label|:
name|usbd_xfer_set_frame_len
argument_list|(
name|xfer
argument_list|,
literal|0
argument_list|,
name|usbd_xfer_max_len
argument_list|(
name|xfer
argument_list|)
argument_list|)
expr_stmt|;
name|usbd_transfer_submit
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|/* Error */
name|DPRINTF
argument_list|(
literal|"USB transfer error, %s\n"
argument_list|,
name|usbd_errstr
argument_list|(
name|error
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|USB_ERR_CANCELLED
condition|)
block|{
name|usbd_xfer_set_stall
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
goto|goto
name|tr_setup
goto|;
block|}
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|usie_if_rx_callback
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|,
name|usb_error_t
name|error
parameter_list|)
block|{
name|struct
name|usie_softc
modifier|*
name|sc
init|=
name|usbd_xfer_softc
argument_list|(
name|xfer
argument_list|)
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m0
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
init|=
name|NULL
decl_stmt|;
name|struct
name|usie_desc
modifier|*
name|rxd
decl_stmt|;
name|uint32_t
name|actlen
decl_stmt|;
name|uint16_t
name|err
decl_stmt|;
name|uint16_t
name|pkt
decl_stmt|;
name|uint16_t
name|ipl
decl_stmt|;
name|uint16_t
name|len
decl_stmt|;
name|uint16_t
name|diff
decl_stmt|;
name|uint8_t
name|pad
decl_stmt|;
name|uint8_t
name|ipv
decl_stmt|;
name|usbd_xfer_status
argument_list|(
name|xfer
argument_list|,
operator|&
name|actlen
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|USB_GET_STATE
argument_list|(
name|xfer
argument_list|)
condition|)
block|{
case|case
name|USB_ST_TRANSFERRED
case|:
name|DPRINTFN
argument_list|(
literal|15
argument_list|,
literal|"rx done, actlen=%u\n"
argument_list|,
name|actlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|actlen
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|usie_hip
argument_list|)
condition|)
block|{
name|DPRINTF
argument_list|(
literal|"data too short %u\n"
argument_list|,
name|actlen
argument_list|)
expr_stmt|;
goto|goto
name|tr_setup
goto|;
block|}
name|m
operator|=
name|sc
operator|->
name|sc_rxm
expr_stmt|;
name|sc
operator|->
name|sc_rxm
operator|=
name|NULL
expr_stmt|;
comment|/* fall though */
case|case
name|USB_ST_SETUP
case|:
name|tr_setup
label|:
if|if
condition|(
name|sc
operator|->
name|sc_rxm
operator|==
name|NULL
condition|)
block|{
name|sc
operator|->
name|sc_rxm
operator|=
name|m_getjcl
argument_list|(
name|M_DONTWAIT
argument_list|,
name|MT_DATA
argument_list|,
name|M_PKTHDR
argument_list|,
name|MJUMPAGESIZE
comment|/* could be bigger than MCLBYTES */
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|sc_rxm
operator|==
name|NULL
condition|)
block|{
name|DPRINTF
argument_list|(
literal|"could not allocate Rx mbuf\n"
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_ierrors
operator|++
expr_stmt|;
name|usbd_xfer_set_stall
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
name|usbd_xfer_set_frames
argument_list|(
name|xfer
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* 			 * Directly loading a mbuf cluster into DMA to 			 * save some data copying. This works because 			 * there is only one cluster. 			 */
name|usbd_xfer_set_frame_data
argument_list|(
name|xfer
argument_list|,
literal|0
argument_list|,
name|mtod
argument_list|(
name|sc
operator|->
name|sc_rxm
argument_list|,
name|caddr_t
argument_list|)
argument_list|,
name|MIN
argument_list|(
name|MJUMPAGESIZE
argument_list|,
name|USIE_RXSZ_MAX
argument_list|)
argument_list|)
expr_stmt|;
name|usbd_xfer_set_frames
argument_list|(
name|xfer
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|usbd_transfer_submit
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|/* Error */
name|DPRINTF
argument_list|(
literal|"USB transfer error, %s\n"
argument_list|,
name|usbd_errstr
argument_list|(
name|error
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|USB_ERR_CANCELLED
condition|)
block|{
comment|/* try to clear stall first */
name|usbd_xfer_set_stall
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_ierrors
operator|++
expr_stmt|;
goto|goto
name|tr_setup
goto|;
block|}
if|if
condition|(
name|sc
operator|->
name|sc_rxm
operator|!=
name|NULL
condition|)
block|{
name|m_freem
argument_list|(
name|sc
operator|->
name|sc_rxm
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_rxm
operator|=
name|NULL
expr_stmt|;
block|}
break|break;
block|}
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
return|return;
name|mtx_unlock
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|m
operator|->
name|m_len
operator|=
name|actlen
expr_stmt|;
name|err
operator|=
name|pkt
operator|=
literal|0
expr_stmt|;
comment|/* HW can aggregate multiple frames in a single USB xfer */
for|for
control|(
init|;
condition|;
control|)
block|{
name|rxd
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|usie_desc
operator|*
argument_list|)
expr_stmt|;
name|len
operator|=
name|be16toh
argument_list|(
name|rxd
operator|->
name|hip
operator|.
name|len
argument_list|)
operator|&
name|USIE_HIP_IP_LEN_MASK
expr_stmt|;
name|pad
operator|=
operator|(
name|rxd
operator|->
name|hip
operator|.
name|id
operator|&
name|USIE_HIP_PAD
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|ipl
operator|=
operator|(
name|len
operator|-
name|pad
operator|-
name|ETHER_HDR_LEN
operator|)
expr_stmt|;
if|if
condition|(
name|ipl
operator|>=
name|len
condition|)
block|{
name|DPRINTF
argument_list|(
literal|"Corrupt frame\n"
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
break|break;
block|}
name|diff
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|usie_desc
argument_list|)
operator|+
name|ipl
operator|+
name|pad
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|rxd
operator|->
name|hip
operator|.
name|id
operator|&
name|USIE_HIP_MASK
operator|)
operator|!=
name|USIE_HIP_IP
operator|)
operator|||
operator|(
name|be16toh
argument_list|(
name|rxd
operator|->
name|desc_type
argument_list|)
operator|&
name|USIE_TYPE_MASK
operator|)
operator|!=
name|USIE_IP_RX
condition|)
block|{
name|DPRINTF
argument_list|(
literal|"received wrong type of packet\n"
argument_list|)
expr_stmt|;
name|m
operator|->
name|m_data
operator|+=
name|diff
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
operator|(
name|m
operator|->
name|m_len
operator|-=
name|diff
operator|)
expr_stmt|;
name|err
operator|++
expr_stmt|;
if|if
condition|(
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|>
literal|0
condition|)
continue|continue;
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
name|be16toh
argument_list|(
name|rxd
operator|->
name|ethhdr
operator|.
name|ether_type
argument_list|)
condition|)
block|{
case|case
name|ETHERTYPE_IP
case|:
name|ipv
operator|=
name|NETISR_IP
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|INET6
case|case
name|ETHERTYPE_IPV6
case|:
name|ipv
operator|=
name|NETISR_IPV6
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
name|DPRINTF
argument_list|(
literal|"unsupported ether type\n"
argument_list|)
expr_stmt|;
name|err
operator|++
expr_stmt|;
break|break;
block|}
comment|/* the last packet */
if|if
condition|(
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|<=
name|diff
condition|)
block|{
name|m
operator|->
name|m_data
operator|+=
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|usie_desc
argument_list|)
operator|+
name|pad
operator|)
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|m
operator|->
name|m_len
operator|=
name|ipl
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|rcvif
operator|=
name|ifp
expr_stmt|;
name|BPF_MTAP
argument_list|(
name|sc
operator|->
name|sc_ifp
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|netisr_dispatch
argument_list|(
name|ipv
argument_list|,
name|m
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* copy aggregated frames to another mbuf */
name|m0
operator|=
name|m_getcl
argument_list|(
name|M_DONTWAIT
argument_list|,
name|MT_DATA
argument_list|,
name|M_PKTHDR
argument_list|)
expr_stmt|;
if|if
condition|(
name|__predict_false
argument_list|(
name|m0
operator|==
name|NULL
argument_list|)
condition|)
block|{
name|DPRINTF
argument_list|(
literal|"could not allocate mbuf\n"
argument_list|)
expr_stmt|;
name|err
operator|++
expr_stmt|;
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
break|break;
block|}
name|m_copydata
argument_list|(
name|m
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|usie_desc
argument_list|)
operator|+
name|pad
argument_list|,
name|ipl
argument_list|,
name|mtod
argument_list|(
name|m0
argument_list|,
name|caddr_t
argument_list|)
argument_list|)
expr_stmt|;
name|m0
operator|->
name|m_pkthdr
operator|.
name|rcvif
operator|=
name|ifp
expr_stmt|;
name|m0
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|m0
operator|->
name|m_len
operator|=
name|ipl
expr_stmt|;
name|BPF_MTAP
argument_list|(
name|sc
operator|->
name|sc_ifp
argument_list|,
name|m0
argument_list|)
expr_stmt|;
name|netisr_dispatch
argument_list|(
name|ipv
argument_list|,
name|m0
argument_list|)
expr_stmt|;
name|m
operator|->
name|m_data
operator|+=
name|diff
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
operator|(
name|m
operator|->
name|m_len
operator|-=
name|diff
operator|)
expr_stmt|;
block|}
name|mtx_lock
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_ierrors
operator|+=
name|err
expr_stmt|;
name|ifp
operator|->
name|if_ipackets
operator|+=
name|pkt
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|usie_if_tx_callback
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|,
name|usb_error_t
name|error
parameter_list|)
block|{
name|struct
name|usie_softc
modifier|*
name|sc
init|=
name|usbd_xfer_softc
argument_list|(
name|xfer
argument_list|)
decl_stmt|;
name|struct
name|usb_page_cache
modifier|*
name|pc
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|uint16_t
name|size
decl_stmt|;
switch|switch
condition|(
name|USB_GET_STATE
argument_list|(
name|xfer
argument_list|)
condition|)
block|{
case|case
name|USB_ST_TRANSFERRED
case|:
name|DPRINTFN
argument_list|(
literal|11
argument_list|,
literal|"transfer complete\n"
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_OACTIVE
expr_stmt|;
name|ifp
operator|->
name|if_opackets
operator|++
expr_stmt|;
comment|/* fall though */
case|case
name|USB_ST_SETUP
case|:
name|tr_setup
label|:
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
operator|==
literal|0
condition|)
break|break;
name|IFQ_DRV_DEQUEUE
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
break|break;
if|if
condition|(
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|>
call|(
name|int
call|)
argument_list|(
name|MCLBYTES
operator|-
name|ETHER_HDR_LEN
operator|+
name|ETHER_CRC_LEN
operator|-
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|sc_txd
argument_list|)
argument_list|)
condition|)
block|{
name|DPRINTF
argument_list|(
literal|"packet len is too big: %d\n"
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|)
expr_stmt|;
break|break;
block|}
name|pc
operator|=
name|usbd_xfer_get_frame
argument_list|(
name|xfer
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_txd
operator|.
name|hip
operator|.
name|len
operator|=
name|htobe16
argument_list|(
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|+
name|ETHER_HDR_LEN
operator|+
name|ETHER_CRC_LEN
argument_list|)
expr_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|sc_txd
argument_list|)
expr_stmt|;
name|usbd_copy_in
argument_list|(
name|pc
argument_list|,
literal|0
argument_list|,
operator|&
name|sc
operator|->
name|sc_txd
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|usbd_m_copy_in
argument_list|(
name|pc
argument_list|,
name|size
argument_list|,
name|m
argument_list|,
literal|0
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|)
expr_stmt|;
name|usbd_xfer_set_frame_len
argument_list|(
name|xfer
argument_list|,
literal|0
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|+
name|size
operator|+
name|ETHER_CRC_LEN
argument_list|)
expr_stmt|;
name|BPF_MTAP
argument_list|(
name|ifp
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|usbd_transfer_submit
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|/* Error */
name|DPRINTF
argument_list|(
literal|"USB transfer error, %s\n"
argument_list|,
name|usbd_errstr
argument_list|(
name|error
argument_list|)
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_oerrors
operator|++
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|USB_ERR_CANCELLED
condition|)
block|{
name|usbd_xfer_set_stall
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_ierrors
operator|++
expr_stmt|;
goto|goto
name|tr_setup
goto|;
block|}
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|usie_if_status_callback
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|,
name|usb_error_t
name|error
parameter_list|)
block|{
name|struct
name|usie_softc
modifier|*
name|sc
init|=
name|usbd_xfer_softc
argument_list|(
name|xfer
argument_list|)
decl_stmt|;
name|struct
name|usb_page_cache
modifier|*
name|pc
decl_stmt|;
name|struct
name|usb_cdc_notification
name|cdc
decl_stmt|;
name|uint32_t
name|actlen
decl_stmt|;
name|usbd_xfer_status
argument_list|(
name|xfer
argument_list|,
operator|&
name|actlen
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|USB_GET_STATE
argument_list|(
name|xfer
argument_list|)
condition|)
block|{
case|case
name|USB_ST_TRANSFERRED
case|:
name|DPRINTFN
argument_list|(
literal|4
argument_list|,
literal|"info received, actlen=%d\n"
argument_list|,
name|actlen
argument_list|)
expr_stmt|;
comment|/* usb_cdc_notification - .data[16] */
if|if
condition|(
name|actlen
operator|<
operator|(
sizeof|sizeof
argument_list|(
name|cdc
argument_list|)
operator|-
literal|16
operator|)
condition|)
block|{
name|DPRINTF
argument_list|(
literal|"data too short %d\n"
argument_list|,
name|actlen
argument_list|)
expr_stmt|;
goto|goto
name|tr_setup
goto|;
block|}
name|pc
operator|=
name|usbd_xfer_get_frame
argument_list|(
name|xfer
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|usbd_copy_out
argument_list|(
name|pc
argument_list|,
literal|0
argument_list|,
operator|&
name|cdc
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|cdc
argument_list|)
operator|-
literal|16
operator|)
argument_list|)
expr_stmt|;
name|DPRINTFN
argument_list|(
literal|4
argument_list|,
literal|"bNotification=%x\n"
argument_list|,
name|cdc
operator|.
name|bNotification
argument_list|)
expr_stmt|;
if|if
condition|(
name|cdc
operator|.
name|bNotification
operator|&
name|UCDC_N_RESPONSE_AVAILABLE
condition|)
block|{
name|taskqueue_enqueue
argument_list|(
name|taskqueue_thread
argument_list|,
operator|&
name|sc
operator|->
name|sc_if_status_task
argument_list|)
expr_stmt|;
block|}
comment|/* fall though */
case|case
name|USB_ST_SETUP
case|:
name|tr_setup
label|:
name|usbd_xfer_set_frame_len
argument_list|(
name|xfer
argument_list|,
literal|0
argument_list|,
name|usbd_xfer_max_len
argument_list|(
name|xfer
argument_list|)
argument_list|)
expr_stmt|;
name|usbd_transfer_submit
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|/* Error */
name|DPRINTF
argument_list|(
literal|"USB transfer error, %s\n"
argument_list|,
name|usbd_errstr
argument_list|(
name|error
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|USB_ERR_CANCELLED
condition|)
block|{
name|usbd_xfer_set_stall
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
goto|goto
name|tr_setup
goto|;
block|}
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|usie_if_sync_to
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|usie_softc
modifier|*
name|sc
init|=
name|arg
decl_stmt|;
name|taskqueue_enqueue
argument_list|(
name|taskqueue_thread
argument_list|,
operator|&
name|sc
operator|->
name|sc_if_sync_task
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|usie_if_sync_cb
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|int
name|pending
parameter_list|)
block|{
name|struct
name|usie_softc
modifier|*
name|sc
init|=
name|arg
decl_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
comment|/* call twice */
name|usie_if_cmd
argument_list|(
name|sc
argument_list|,
name|USIE_HIP_SYNC2M
argument_list|)
expr_stmt|;
name|usie_if_cmd
argument_list|(
name|sc
argument_list|,
name|USIE_HIP_SYNC2M
argument_list|)
expr_stmt|;
name|usb_callout_reset
argument_list|(
operator|&
name|sc
operator|->
name|sc_if_sync_ch
argument_list|,
literal|2
operator|*
name|hz
argument_list|,
name|usie_if_sync_to
argument_list|,
name|sc
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|usie_if_status_cb
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|int
name|pending
parameter_list|)
block|{
name|struct
name|usie_softc
modifier|*
name|sc
init|=
name|arg
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|struct
name|usb_device_request
name|req
decl_stmt|;
name|struct
name|usie_hip
modifier|*
name|hip
decl_stmt|;
name|struct
name|usie_lsi
modifier|*
name|lsi
decl_stmt|;
name|uint16_t
name|actlen
decl_stmt|;
name|uint8_t
name|ntries
decl_stmt|;
name|uint8_t
name|pad
decl_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_READ_CLASS_INTERFACE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|UCDC_GET_ENCAPSULATED_RESPONSE
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
name|sc
operator|->
name|sc_if_ifnum
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|sc_status_temp
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|!=
literal|10
condition|;
name|ntries
operator|++
control|)
block|{
name|int
name|err
decl_stmt|;
name|err
operator|=
name|usbd_do_request_flags
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|,
operator|&
name|req
argument_list|,
name|sc
operator|->
name|sc_status_temp
argument_list|,
name|USB_SHORT_XFER_OK
argument_list|,
operator|&
name|actlen
argument_list|,
name|USB_DEFAULT_TIMEOUT
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
literal|0
condition|)
break|break;
name|DPRINTF
argument_list|(
literal|"Control request failed: %s %d/10\n"
argument_list|,
name|usbd_errstr
argument_list|(
name|err
argument_list|)
argument_list|,
name|ntries
argument_list|)
expr_stmt|;
name|usb_pause_mtx
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|,
name|USB_MS_TO_TICKS
argument_list|(
literal|10
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ntries
operator|==
literal|10
condition|)
block|{
name|mtx_unlock
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"Timeout\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|hip
operator|=
operator|(
expr|struct
name|usie_hip
operator|*
operator|)
name|sc
operator|->
name|sc_status_temp
expr_stmt|;
name|pad
operator|=
operator|(
name|hip
operator|->
name|id
operator|&
name|USIE_HIP_PAD
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"hip.id=%x hip.len=%d actlen=%u pad=%d\n"
argument_list|,
name|hip
operator|->
name|id
argument_list|,
name|be16toh
argument_list|(
name|hip
operator|->
name|len
argument_list|)
argument_list|,
name|actlen
argument_list|,
name|pad
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|hip
operator|->
name|id
operator|&
name|USIE_HIP_MASK
condition|)
block|{
case|case
name|USIE_HIP_SYNC2H
case|:
name|usie_if_cmd
argument_list|(
name|sc
argument_list|,
name|USIE_HIP_SYNC2M
argument_list|)
expr_stmt|;
break|break;
case|case
name|USIE_HIP_RESTR
case|:
name|usb_callout_stop
argument_list|(
operator|&
name|sc
operator|->
name|sc_if_sync_ch
argument_list|)
expr_stmt|;
break|break;
case|case
name|USIE_HIP_UMTS
case|:
name|lsi
operator|=
operator|(
expr|struct
name|usie_lsi
operator|*
operator|)
operator|(
name|sc
operator|->
name|sc_status_temp
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|usie_hip
argument_list|)
operator|+
name|pad
operator|)
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"lsi.proto=%x lsi.len=%d\n"
argument_list|,
name|lsi
operator|->
name|proto
argument_list|,
name|be16toh
argument_list|(
name|lsi
operator|->
name|len
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|lsi
operator|->
name|proto
operator|!=
name|USIE_LSI_UMTS
condition|)
break|break;
if|if
condition|(
name|lsi
operator|->
name|area
operator|==
name|USIE_LSI_AREA_NO
operator|||
name|lsi
operator|->
name|area
operator|==
name|USIE_LSI_AREA_NODATA
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"no service available\n"
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|lsi
operator|->
name|state
operator|==
name|USIE_LSI_STATE_IDLE
condition|)
block|{
name|DPRINTF
argument_list|(
literal|"lsi.state=%x\n"
argument_list|,
name|lsi
operator|->
name|state
argument_list|)
expr_stmt|;
break|break;
block|}
name|DPRINTF
argument_list|(
literal|"ctx=%x\n"
argument_list|,
name|hip
operator|->
name|param
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_txd
operator|.
name|hip
operator|.
name|param
operator|=
name|hip
operator|->
name|param
expr_stmt|;
name|sc
operator|->
name|sc_net
operator|.
name|addr_len
operator|=
name|lsi
operator|->
name|pdp_addr_len
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|sc
operator|->
name|sc_net
operator|.
name|dns1_addr
argument_list|,
operator|&
name|lsi
operator|->
name|dns1_addr
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|sc
operator|->
name|sc_net
operator|.
name|dns2_addr
argument_list|,
operator|&
name|lsi
operator|->
name|dns2_addr
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|sc
operator|->
name|sc_net
operator|.
name|pdp_addr
argument_list|,
name|lsi
operator|->
name|pdp_addr
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|sc
operator|->
name|sc_net
operator|.
name|gw_addr
argument_list|,
name|lsi
operator|->
name|gw_addr
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_flags
operator||=
name|IFF_UP
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator||=
name|IFF_DRV_RUNNING
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"IP Addr=%d.%d.%d.%d\n"
argument_list|,
operator|*
name|lsi
operator|->
name|pdp_addr
argument_list|,
operator|*
operator|(
name|lsi
operator|->
name|pdp_addr
operator|+
literal|1
operator|)
argument_list|,
operator|*
operator|(
name|lsi
operator|->
name|pdp_addr
operator|+
literal|2
operator|)
argument_list|,
operator|*
operator|(
name|lsi
operator|->
name|pdp_addr
operator|+
literal|3
operator|)
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"Gateway Addr=%d.%d.%d.%d\n"
argument_list|,
operator|*
name|lsi
operator|->
name|gw_addr
argument_list|,
operator|*
operator|(
name|lsi
operator|->
name|gw_addr
operator|+
literal|1
operator|)
argument_list|,
operator|*
operator|(
name|lsi
operator|->
name|gw_addr
operator|+
literal|2
operator|)
argument_list|,
operator|*
operator|(
name|lsi
operator|->
name|gw_addr
operator|+
literal|3
operator|)
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"Prim NS Addr=%d.%d.%d.%d\n"
argument_list|,
operator|*
name|lsi
operator|->
name|dns1_addr
argument_list|,
operator|*
operator|(
name|lsi
operator|->
name|dns1_addr
operator|+
literal|1
operator|)
argument_list|,
operator|*
operator|(
name|lsi
operator|->
name|dns1_addr
operator|+
literal|2
operator|)
argument_list|,
operator|*
operator|(
name|lsi
operator|->
name|dns1_addr
operator|+
literal|3
operator|)
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"Scnd NS Addr=%d.%d.%d.%d\n"
argument_list|,
operator|*
name|lsi
operator|->
name|dns2_addr
argument_list|,
operator|*
operator|(
name|lsi
operator|->
name|dns2_addr
operator|+
literal|1
operator|)
argument_list|,
operator|*
operator|(
name|lsi
operator|->
name|dns2_addr
operator|+
literal|2
operator|)
argument_list|,
operator|*
operator|(
name|lsi
operator|->
name|dns2_addr
operator|+
literal|3
operator|)
argument_list|)
expr_stmt|;
name|usie_cns_req
argument_list|(
name|sc
argument_list|,
name|USIE_CNS_ID_RSSI
argument_list|,
name|USIE_CNS_OB_RSSI
argument_list|)
expr_stmt|;
break|break;
case|case
name|USIE_HIP_RCGI
case|:
comment|/* ignore, workaround for sloppy windows */
break|break;
default|default:
name|DPRINTF
argument_list|(
literal|"undefined msgid: %x\n"
argument_list|,
name|hip
operator|->
name|id
argument_list|)
expr_stmt|;
break|break;
block|}
name|mtx_unlock
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|usie_if_start
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|struct
name|usie_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
condition|)
block|{
name|DPRINTF
argument_list|(
literal|"Not running\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|mtx_lock
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
name|usbd_transfer_start
argument_list|(
name|sc
operator|->
name|sc_if_xfer
index|[
name|USIE_IF_TX
index|]
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
name|DPRINTFN
argument_list|(
literal|3
argument_list|,
literal|"interface started\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|usie_if_output
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|struct
name|sockaddr
modifier|*
name|dst
parameter_list|,
name|struct
name|route
modifier|*
name|ro
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|DPRINTF
argument_list|(
literal|"proto=%x\n"
argument_list|,
name|dst
operator|->
name|sa_family
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|dst
operator|->
name|sa_family
condition|)
block|{
ifdef|#
directive|ifdef
name|INET6
case|case
name|AF_INET6
empty_stmt|;
comment|/* fall though */
endif|#
directive|endif
case|case
name|AF_INET
case|:
break|break;
comment|/* silently drop dhclient packets */
case|case
name|AF_UNSPEC
case|:
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
comment|/* drop other packet types */
default|default:
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
name|EAFNOSUPPORT
operator|)
return|;
block|}
name|err
operator|=
call|(
name|ifp
operator|->
name|if_transmit
call|)
argument_list|(
name|ifp
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|ifp
operator|->
name|if_oerrors
operator|++
expr_stmt|;
return|return
operator|(
name|ENOBUFS
operator|)
return|;
block|}
name|ifp
operator|->
name|if_opackets
operator|++
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|usie_if_init
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|usie_softc
modifier|*
name|sc
init|=
name|arg
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|uint8_t
name|i
decl_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
comment|/* write tx descriptor */
name|sc
operator|->
name|sc_txd
operator|.
name|hip
operator|.
name|id
operator|=
name|USIE_HIP_CTX
expr_stmt|;
name|sc
operator|->
name|sc_txd
operator|.
name|hip
operator|.
name|param
operator|=
literal|0
expr_stmt|;
comment|/* init value */
name|sc
operator|->
name|sc_txd
operator|.
name|desc_type
operator|=
name|htobe16
argument_list|(
name|USIE_IP_TX
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|!=
name|USIE_IF_N_XFER
condition|;
name|i
operator|++
control|)
name|usbd_xfer_set_stall
argument_list|(
name|sc
operator|->
name|sc_if_xfer
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|usbd_transfer_start
argument_list|(
name|sc
operator|->
name|sc_uc_xfer
index|[
name|USIE_HIP_IF
index|]
index|[
name|USIE_UC_RX
index|]
argument_list|)
expr_stmt|;
name|usbd_transfer_start
argument_list|(
name|sc
operator|->
name|sc_if_xfer
index|[
name|USIE_IF_STATUS
index|]
argument_list|)
expr_stmt|;
name|usbd_transfer_start
argument_list|(
name|sc
operator|->
name|sc_if_xfer
index|[
name|USIE_IF_RX
index|]
argument_list|)
expr_stmt|;
comment|/* if not running, initiate the modem */
if|if
condition|(
operator|!
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
condition|)
name|usie_cns_req
argument_list|(
name|sc
argument_list|,
name|USIE_CNS_ID_INIT
argument_list|,
name|USIE_CNS_OB_LINK_UPDATE
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"ifnet initialized\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|usie_if_stop
parameter_list|(
name|struct
name|usie_softc
modifier|*
name|sc
parameter_list|)
block|{
name|usb_callout_drain
argument_list|(
operator|&
name|sc
operator|->
name|sc_if_sync_ch
argument_list|)
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
comment|/* usie_cns_req() clears IFF_* flags */
name|usie_cns_req
argument_list|(
name|sc
argument_list|,
name|USIE_CNS_ID_STOP
argument_list|,
name|USIE_CNS_OB_LINK_UPDATE
argument_list|)
expr_stmt|;
name|usbd_transfer_stop
argument_list|(
name|sc
operator|->
name|sc_if_xfer
index|[
name|USIE_IF_TX
index|]
argument_list|)
expr_stmt|;
name|usbd_transfer_stop
argument_list|(
name|sc
operator|->
name|sc_if_xfer
index|[
name|USIE_IF_RX
index|]
argument_list|)
expr_stmt|;
name|usbd_transfer_stop
argument_list|(
name|sc
operator|->
name|sc_if_xfer
index|[
name|USIE_IF_STATUS
index|]
argument_list|)
expr_stmt|;
comment|/* shutdown device */
name|usie_if_cmd
argument_list|(
name|sc
argument_list|,
name|USIE_HIP_DOWN
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|usie_if_ioctl
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|u_long
name|cmd
parameter_list|,
name|caddr_t
name|data
parameter_list|)
block|{
name|struct
name|usie_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|ieee80211req
modifier|*
name|ireq
decl_stmt|;
name|struct
name|ieee80211req_sta_info
name|si
decl_stmt|;
name|struct
name|ifmediareq
modifier|*
name|ifmr
decl_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|SIOCSIFFLAGS
case|:
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_UP
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
condition|)
name|usie_if_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
name|usie_if_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SIOCSIFCAP
case|:
if|if
condition|(
operator|!
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"Connect to the network first.\n"
argument_list|)
expr_stmt|;
break|break;
block|}
name|mtx_lock
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
name|usie_cns_req
argument_list|(
name|sc
argument_list|,
name|USIE_CNS_ID_RSSI
argument_list|,
name|USIE_CNS_OB_RSSI
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCG80211
case|:
name|ireq
operator|=
operator|(
expr|struct
name|ieee80211req
operator|*
operator|)
name|data
expr_stmt|;
if|if
condition|(
name|ireq
operator|->
name|i_type
operator|!=
name|IEEE80211_IOC_STA_INFO
condition|)
break|break;
name|memset
argument_list|(
operator|&
name|si
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|si
argument_list|)
argument_list|)
expr_stmt|;
name|si
operator|.
name|isi_len
operator|=
sizeof|sizeof
argument_list|(
name|si
argument_list|)
expr_stmt|;
comment|/* 		 * ifconfig expects RSSI in 0.5dBm units 		 * relative to the noise floor. 		 */
name|si
operator|.
name|isi_rssi
operator|=
literal|2
operator|*
name|sc
operator|->
name|sc_rssi
expr_stmt|;
if|if
condition|(
name|copyout
argument_list|(
operator|&
name|si
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
name|ireq
operator|->
name|i_data
operator|+
literal|8
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ieee80211req_sta_info
argument_list|)
argument_list|)
condition|)
name|DPRINTF
argument_list|(
literal|"copyout failed\n"
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"80211\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCGIFMEDIA
case|:
comment|/* to fool ifconfig */
name|ifmr
operator|=
operator|(
expr|struct
name|ifmediareq
operator|*
operator|)
name|data
expr_stmt|;
name|ifmr
operator|->
name|ifm_count
operator|=
literal|1
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"media\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCSIFADDR
case|:
case|case
name|SIOCSIFDSTADDR
case|:
break|break;
default|default:
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|usie_do_request
parameter_list|(
name|struct
name|usie_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|usb_device_request
modifier|*
name|req
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|int
name|err
init|=
literal|0
decl_stmt|;
name|int
name|ntries
decl_stmt|;
name|mtx_assert
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|,
name|MA_OWNED
argument_list|)
expr_stmt|;
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|!=
literal|10
condition|;
name|ntries
operator|++
control|)
block|{
name|err
operator|=
name|usbd_do_request
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|,
name|req
argument_list|,
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
literal|0
condition|)
break|break;
name|DPRINTF
argument_list|(
literal|"Control request failed: %s %d/10\n"
argument_list|,
name|usbd_errstr
argument_list|(
name|err
argument_list|)
argument_list|,
name|ntries
argument_list|)
expr_stmt|;
name|usb_pause_mtx
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|,
name|USB_MS_TO_TICKS
argument_list|(
literal|10
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|usie_if_cmd
parameter_list|(
name|struct
name|usie_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|cmd
parameter_list|)
block|{
name|struct
name|usb_device_request
name|req
decl_stmt|;
name|struct
name|usie_hip
name|msg
decl_stmt|;
name|msg
operator|.
name|len
operator|=
literal|0
expr_stmt|;
name|msg
operator|.
name|id
operator|=
name|cmd
expr_stmt|;
name|msg
operator|.
name|param
operator|=
literal|0
expr_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_WRITE_CLASS_INTERFACE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|UCDC_SEND_ENCAPSULATED_COMMAND
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
name|sc
operator|->
name|sc_if_ifnum
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"cmd=%x\n"
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
return|return
operator|(
name|usie_do_request
argument_list|(
name|sc
argument_list|,
operator|&
name|req
argument_list|,
operator|&
name|msg
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|usie_cns_req
parameter_list|(
name|struct
name|usie_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|id
parameter_list|,
name|uint16_t
name|obj
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|struct
name|usb_xfer
modifier|*
name|xfer
decl_stmt|;
name|struct
name|usie_hip
modifier|*
name|hip
decl_stmt|;
name|struct
name|usie_cns
modifier|*
name|cns
decl_stmt|;
name|uint8_t
modifier|*
name|param
decl_stmt|;
name|uint8_t
modifier|*
name|tmp
decl_stmt|;
name|uint8_t
name|cns_len
decl_stmt|;
name|m
operator|=
name|m_getcl
argument_list|(
name|M_DONTWAIT
argument_list|,
name|MT_DATA
argument_list|,
name|M_PKTHDR
argument_list|)
expr_stmt|;
if|if
condition|(
name|__predict_false
argument_list|(
name|m
operator|==
name|NULL
argument_list|)
condition|)
block|{
name|DPRINTF
argument_list|(
literal|"could not allocate mbuf\n"
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_ierrors
operator|++
expr_stmt|;
return|return;
block|}
comment|/* to align usie_hip{} on 32 bit */
name|m
operator|->
name|m_data
operator|+=
literal|3
expr_stmt|;
name|param
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
name|uint8_t
operator|*
argument_list|)
expr_stmt|;
operator|*
name|param
operator|++
operator|=
name|USIE_HIP_FRM_CHR
expr_stmt|;
name|hip
operator|=
operator|(
expr|struct
name|usie_hip
operator|*
operator|)
name|param
expr_stmt|;
name|cns
operator|=
operator|(
expr|struct
name|usie_cns
operator|*
operator|)
operator|(
name|hip
operator|+
literal|1
operator|)
expr_stmt|;
name|tmp
operator|=
name|param
operator|+
name|USIE_HIPCNS_MIN
operator|-
literal|2
expr_stmt|;
switch|switch
condition|(
name|obj
condition|)
block|{
case|case
name|USIE_CNS_OB_LINK_UPDATE
case|:
name|cns_len
operator|=
literal|2
expr_stmt|;
name|cns
operator|->
name|op
operator|=
name|USIE_CNS_OP_SET
expr_stmt|;
operator|*
name|tmp
operator|++
operator|=
literal|1
expr_stmt|;
comment|/* profile ID, always use 1 for now */
operator|*
name|tmp
operator|++
operator|=
name|id
operator|==
name|USIE_CNS_ID_INIT
condition|?
literal|1
else|:
literal|0
expr_stmt|;
break|break;
case|case
name|USIE_CNS_OB_PROF_WRITE
case|:
name|cns_len
operator|=
literal|245
expr_stmt|;
name|cns
operator|->
name|op
operator|=
name|USIE_CNS_OP_SET
expr_stmt|;
operator|*
name|tmp
operator|++
operator|=
literal|1
expr_stmt|;
comment|/* profile ID, always use 1 for now */
operator|*
name|tmp
operator|++
operator|=
literal|2
expr_stmt|;
name|memcpy
argument_list|(
name|tmp
argument_list|,
operator|&
name|sc
operator|->
name|sc_net
argument_list|,
literal|34
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|tmp
operator|+
literal|35
argument_list|,
literal|0
argument_list|,
literal|245
operator|-
literal|36
argument_list|)
expr_stmt|;
name|tmp
operator|+=
literal|243
expr_stmt|;
break|break;
case|case
name|USIE_CNS_OB_RSSI
case|:
name|cns_len
operator|=
literal|0
expr_stmt|;
name|cns
operator|->
name|op
operator|=
name|USIE_CNS_OP_REQ
expr_stmt|;
break|break;
default|default:
name|DPRINTF
argument_list|(
literal|"unsupported CnS object type\n"
argument_list|)
expr_stmt|;
return|return;
block|}
operator|*
name|tmp
operator|=
name|USIE_HIP_FRM_CHR
expr_stmt|;
name|hip
operator|->
name|len
operator|=
name|htobe16
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|usie_cns
argument_list|)
operator|+
name|cns_len
argument_list|)
expr_stmt|;
name|hip
operator|->
name|id
operator|=
name|USIE_HIP_CNS2M
expr_stmt|;
name|hip
operator|->
name|param
operator|=
literal|0
expr_stmt|;
comment|/* none for CnS */
name|cns
operator|->
name|obj
operator|=
name|htobe16
argument_list|(
name|obj
argument_list|)
expr_stmt|;
name|cns
operator|->
name|id
operator|=
name|htobe32
argument_list|(
name|id
argument_list|)
expr_stmt|;
name|cns
operator|->
name|len
operator|=
name|cns_len
expr_stmt|;
name|cns
operator|->
name|rsv0
operator|=
name|cns
operator|->
name|rsv1
operator|=
literal|0
expr_stmt|;
comment|/* always '0' */
name|param
operator|=
operator|(
name|uint8_t
operator|*
operator|)
operator|(
name|cns
operator|+
literal|1
operator|)
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"param: %16D\n"
argument_list|,
name|param
argument_list|,
literal|":"
argument_list|)
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|m
operator|->
name|m_len
operator|=
name|USIE_HIPCNS_MIN
operator|+
name|cns_len
operator|+
literal|2
expr_stmt|;
name|xfer
operator|=
name|sc
operator|->
name|sc_uc_xfer
index|[
name|USIE_HIP_IF
index|]
index|[
name|USIE_UC_TX
index|]
expr_stmt|;
if|if
condition|(
name|usbd_xfer_get_priv
argument_list|(
name|xfer
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|usbd_xfer_set_priv
argument_list|(
name|xfer
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|usbd_transfer_start
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DPRINTF
argument_list|(
literal|"Dropped CNS event\n"
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|usie_cns_rsp
parameter_list|(
name|struct
name|usie_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|usie_cns
modifier|*
name|cns
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|DPRINTF
argument_list|(
literal|"received CnS\n"
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|be16toh
argument_list|(
name|cns
operator|->
name|obj
argument_list|)
condition|)
block|{
case|case
name|USIE_CNS_OB_LINK_UPDATE
case|:
if|if
condition|(
name|be32toh
argument_list|(
name|cns
operator|->
name|id
argument_list|)
operator|&
name|USIE_CNS_ID_INIT
condition|)
name|usie_if_sync_to
argument_list|(
name|sc
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|be32toh
argument_list|(
name|cns
operator|->
name|id
argument_list|)
operator|&
name|USIE_CNS_ID_STOP
condition|)
block|{
name|ifp
operator|->
name|if_flags
operator|&=
operator|~
name|IFF_UP
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
operator|(
name|IFF_DRV_RUNNING
operator||
name|IFF_DRV_OACTIVE
operator|)
expr_stmt|;
block|}
else|else
name|DPRINTF
argument_list|(
literal|"undefined link update\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|USIE_CNS_OB_RSSI
case|:
name|sc
operator|->
name|sc_rssi
operator|=
name|be16toh
argument_list|(
operator|*
operator|(
name|int16_t
operator|*
operator|)
operator|(
name|cns
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_rssi
operator|<=
literal|0
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"No signal\n"
argument_list|)
expr_stmt|;
else|else
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"RSSI=%ddBm\n"
argument_list|,
name|sc
operator|->
name|sc_rssi
operator|-
literal|110
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|USIE_CNS_OB_PROF_WRITE
case|:
break|break;
case|case
name|USIE_CNS_OB_PDP_READ
case|:
break|break;
default|default:
name|DPRINTF
argument_list|(
literal|"undefined CnS\n"
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|usie_hip_rsp
parameter_list|(
name|struct
name|usie_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
modifier|*
name|rsp
parameter_list|,
name|uint32_t
name|len
parameter_list|)
block|{
name|struct
name|usie_hip
modifier|*
name|hip
decl_stmt|;
name|struct
name|usie_cns
modifier|*
name|cns
decl_stmt|;
name|uint32_t
name|i
decl_stmt|;
name|uint32_t
name|j
decl_stmt|;
name|uint32_t
name|off
decl_stmt|;
name|uint8_t
name|tmp
index|[
name|USIE_HIPCNS_MAX
index|]
name|__aligned
argument_list|(
literal|4
argument_list|)
decl_stmt|;
for|for
control|(
name|off
operator|=
literal|0
init|;
operator|(
name|off
operator|+
name|USIE_HIPCNS_MIN
operator|)
operator|<=
name|len
condition|;
name|off
operator|++
control|)
block|{
name|uint8_t
name|pad
decl_stmt|;
while|while
condition|(
operator|(
name|off
operator|<
name|len
operator|)
operator|&&
operator|(
name|rsp
index|[
name|off
index|]
operator|==
name|USIE_HIP_FRM_CHR
operator|)
condition|)
name|off
operator|++
expr_stmt|;
comment|/* Unstuff the bytes */
for|for
control|(
name|i
operator|=
name|j
operator|=
literal|0
init|;
operator|(
operator|(
name|i
operator|+
name|off
operator|)
operator|<
name|len
operator|)
operator|&&
operator|(
name|j
operator|<
name|USIE_HIPCNS_MAX
operator|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|rsp
index|[
name|i
operator|+
name|off
index|]
operator|==
name|USIE_HIP_FRM_CHR
condition|)
break|break;
if|if
condition|(
name|rsp
index|[
name|i
operator|+
name|off
index|]
operator|==
name|USIE_HIP_ESC_CHR
condition|)
block|{
if|if
condition|(
operator|(
name|i
operator|+
name|off
operator|+
literal|1
operator|)
operator|>=
name|len
condition|)
break|break;
name|tmp
index|[
name|j
operator|++
index|]
operator|=
name|rsp
index|[
name|i
operator|++
operator|+
name|off
operator|+
literal|1
index|]
operator|^
literal|0x20
expr_stmt|;
block|}
else|else
block|{
name|tmp
index|[
name|j
operator|++
index|]
operator|=
name|rsp
index|[
name|i
operator|+
name|off
index|]
expr_stmt|;
block|}
block|}
name|off
operator|+=
name|i
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"frame len=%d\n"
argument_list|,
name|j
argument_list|)
expr_stmt|;
if|if
condition|(
name|j
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|usie_hip
argument_list|)
condition|)
block|{
name|DPRINTF
argument_list|(
literal|"too little data\n"
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* 		 * Make sure we are not reading the stack if something 		 * is wrong. 		 */
name|memset
argument_list|(
name|tmp
operator|+
name|j
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|tmp
argument_list|)
operator|-
name|j
argument_list|)
expr_stmt|;
name|hip
operator|=
operator|(
expr|struct
name|usie_hip
operator|*
operator|)
name|tmp
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"hip: len=%d msgID=%02x, param=%02x\n"
argument_list|,
name|be16toh
argument_list|(
name|hip
operator|->
name|len
argument_list|)
argument_list|,
name|hip
operator|->
name|id
argument_list|,
name|hip
operator|->
name|param
argument_list|)
expr_stmt|;
name|pad
operator|=
operator|(
name|hip
operator|->
name|id
operator|&
name|USIE_HIP_PAD
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|hip
operator|->
name|id
operator|&
name|USIE_HIP_MASK
operator|)
operator|==
name|USIE_HIP_CNS2H
condition|)
block|{
name|cns
operator|=
operator|(
expr|struct
name|usie_cns
operator|*
operator|)
operator|(
operator|(
operator|(
name|uint8_t
operator|*
operator|)
operator|(
name|hip
operator|+
literal|1
operator|)
operator|)
operator|+
name|pad
operator|)
expr_stmt|;
if|if
condition|(
name|j
operator|<
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|usie_cns
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|usie_hip
argument_list|)
operator|+
name|pad
operator|)
condition|)
block|{
name|DPRINTF
argument_list|(
literal|"too little data\n"
argument_list|)
expr_stmt|;
break|break;
block|}
name|DPRINTF
argument_list|(
literal|"cns: obj=%04x, op=%02x, rsv0=%02x, "
literal|"app=%08x, rsv1=%02x, len=%d\n"
argument_list|,
name|be16toh
argument_list|(
name|cns
operator|->
name|obj
argument_list|)
argument_list|,
name|cns
operator|->
name|op
argument_list|,
name|cns
operator|->
name|rsv0
argument_list|,
name|be32toh
argument_list|(
name|cns
operator|->
name|id
argument_list|)
argument_list|,
name|cns
operator|->
name|rsv1
argument_list|,
name|cns
operator|->
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|cns
operator|->
name|op
operator|&
name|USIE_CNS_OP_ERR
condition|)
name|DPRINTF
argument_list|(
literal|"CnS error response\n"
argument_list|)
expr_stmt|;
else|else
name|usie_cns_rsp
argument_list|(
name|sc
argument_list|,
name|cns
argument_list|)
expr_stmt|;
name|i
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|usie_hip
argument_list|)
operator|+
name|pad
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|usie_cns
argument_list|)
expr_stmt|;
name|j
operator|=
name|cns
operator|->
name|len
expr_stmt|;
block|}
else|else
block|{
name|i
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|usie_hip
argument_list|)
operator|+
name|pad
expr_stmt|;
name|j
operator|=
name|be16toh
argument_list|(
name|hip
operator|->
name|len
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|USB_DEBUG
if|if
condition|(
name|usie_debug
operator|==
literal|0
condition|)
continue|continue;
while|while
condition|(
name|i
operator|<
name|USIE_HIPCNS_MAX
operator|&&
name|j
operator|>
literal|0
condition|)
block|{
name|DPRINTF
argument_list|(
literal|"param[0x%02x] = 0x%02x\n"
argument_list|,
name|i
argument_list|,
name|tmp
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|i
operator|++
expr_stmt|;
name|j
operator|--
expr_stmt|;
block|}
endif|#
directive|endif
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|usie_driver_loaded
parameter_list|(
name|struct
name|module
modifier|*
name|mod
parameter_list|,
name|int
name|what
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
switch|switch
condition|(
name|what
condition|)
block|{
case|case
name|MOD_LOAD
case|:
comment|/* register autoinstall handler */
name|usie_etag
operator|=
name|EVENTHANDLER_REGISTER
argument_list|(
name|usb_dev_configured
argument_list|,
name|usie_autoinst
argument_list|,
name|NULL
argument_list|,
name|EVENTHANDLER_PRI_ANY
argument_list|)
expr_stmt|;
break|break;
case|case
name|MOD_UNLOAD
case|:
name|EVENTHANDLER_DEREGISTER
argument_list|(
name|usb_dev_configured
argument_list|,
name|usie_etag
argument_list|)
expr_stmt|;
break|break;
default|default:
return|return
operator|(
name|EOPNOTSUPP
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


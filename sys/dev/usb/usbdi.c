begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	$NetBSD: usbdi.c,v 1.20 1999/01/08 11:58:26 augustss Exp $	*/
end_comment

begin_comment
comment|/*	FreeBSD $Id: usbdi.c,v 1.7 1999/01/07 23:31:42 n_hibma Exp $ */
end_comment

begin_comment
comment|/*  * Copyright (c) 1998 The NetBSD Foundation, Inc.  * All rights reserved.  *  * This code is derived from software contributed to The NetBSD Foundation  * by Lennart Augustsson (augustss@carlstedt.se) at  * Carlstedt Research& Technology.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. All advertising materials mentioning features or use of this software  *    must display the following acknowledgement:  *        This product includes software developed by the NetBSD  *        Foundation, Inc. and its contributors.  * 4. Neither the name of The NetBSD Foundation nor the names of its  *    contributors may be used to endorse or promote products derived  *    from this software without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE NETBSD FOUNDATION, INC. AND CONTRIBUTORS  * ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED  * TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE FOUNDATION OR CONTRIBUTORS  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE  * POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__NetBSD__
argument_list|)
end_if

begin_include
include|#
directive|include
file|<sys/device.h>
end_include

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usbdi.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usbdi_util.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usbdivar.h>
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__FreeBSD__
argument_list|)
end_if

begin_include
include|#
directive|include
file|"usb_if.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|USB_DEBUG
end_ifdef

begin_define
define|#
directive|define
name|DPRINTF
parameter_list|(
name|x
parameter_list|)
value|if (usbdebug) printf x
end_define

begin_define
define|#
directive|define
name|DPRINTFN
parameter_list|(
name|n
parameter_list|,
name|x
parameter_list|)
value|if (usbdebug>(n)) printf x
end_define

begin_decl_stmt
specifier|extern
name|int
name|usbdebug
decl_stmt|;
end_decl_stmt

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|DPRINTF
parameter_list|(
name|x
parameter_list|)
end_define

begin_define
define|#
directive|define
name|DPRINTFN
parameter_list|(
name|n
parameter_list|,
name|x
parameter_list|)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|static
name|usbd_status
name|usbd_ar_pipe
name|__P
argument_list|(
operator|(
name|usbd_pipe_handle
name|pipe
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|usbd_status
name|usbd_ar_iface
name|__P
argument_list|(
operator|(
name|usbd_interface_handle
name|iface
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|usbd_transfer_cb
name|__P
argument_list|(
operator|(
name|usbd_request_handle
name|reqh
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|usbd_sync_transfer_cb
name|__P
argument_list|(
operator|(
name|usbd_request_handle
name|reqh
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|usbd_status
name|usbd_do_transfer
name|__P
argument_list|(
operator|(
name|usbd_request_handle
name|reqh
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|usbd_do_request_async_cb
name|__P
argument_list|(
operator|(
name|usbd_request_handle
operator|,
name|usbd_private_handle
operator|,
name|usbd_status
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_expr_stmt
specifier|static
name|SIMPLEQ_HEAD
argument_list|(
argument_list|,
argument|usbd_request
argument_list|)
name|usbd_free_requests
expr_stmt|;
end_expr_stmt

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__FreeBSD__
argument_list|)
end_if

begin_define
define|#
directive|define
name|USB_CDEV_MAJOR
value|108
end_define

begin_decl_stmt
specifier|extern
name|struct
name|cdevsw
name|usb_cdevsw
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|usbd_status
name|usbd_open_pipe
parameter_list|(
name|iface
parameter_list|,
name|address
parameter_list|,
name|flags
parameter_list|,
name|pipe
parameter_list|)
name|usbd_interface_handle
name|iface
decl_stmt|;
name|u_int8_t
name|address
decl_stmt|;
name|u_int8_t
name|flags
decl_stmt|;
name|usbd_pipe_handle
modifier|*
name|pipe
decl_stmt|;
block|{
name|usbd_pipe_handle
name|p
decl_stmt|;
name|struct
name|usbd_endpoint
modifier|*
name|ep
decl_stmt|;
name|usbd_status
name|r
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|iface
operator|->
name|state
operator|!=
name|USBD_INTERFACE_ACTIVE
condition|)
return|return
operator|(
name|USBD_INTERFACE_NOT_ACTIVE
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|iface
operator|->
name|idesc
operator|->
name|bNumEndpoints
condition|;
name|i
operator|++
control|)
block|{
name|ep
operator|=
operator|&
name|iface
operator|->
name|endpoints
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|ep
operator|->
name|edesc
operator|->
name|bEndpointAddress
operator|==
name|address
condition|)
goto|goto
name|found
goto|;
block|}
return|return
operator|(
name|USBD_BAD_ADDRESS
operator|)
return|;
name|found
label|:
if|if
condition|(
operator|(
name|flags
operator|&
name|USBD_EXCLUSIVE_USE
operator|)
operator|&&
name|ep
operator|->
name|refcnt
operator|!=
literal|0
condition|)
return|return
operator|(
name|USBD_IN_USE
operator|)
return|;
name|r
operator|=
name|usbd_setup_pipe
argument_list|(
name|iface
operator|->
name|device
argument_list|,
name|iface
argument_list|,
name|ep
argument_list|,
operator|&
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|!=
name|USBD_NORMAL_COMPLETION
condition|)
return|return
operator|(
name|r
operator|)
return|;
name|LIST_INSERT_HEAD
argument_list|(
operator|&
name|iface
operator|->
name|pipes
argument_list|,
name|p
argument_list|,
name|next
argument_list|)
expr_stmt|;
operator|*
name|pipe
operator|=
name|p
expr_stmt|;
return|return
operator|(
name|USBD_NORMAL_COMPLETION
operator|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|usbd_open_pipe_intr
parameter_list|(
name|iface
parameter_list|,
name|address
parameter_list|,
name|flags
parameter_list|,
name|pipe
parameter_list|,
name|priv
parameter_list|,
name|buffer
parameter_list|,
name|length
parameter_list|,
name|cb
parameter_list|)
name|usbd_interface_handle
name|iface
decl_stmt|;
name|u_int8_t
name|address
decl_stmt|;
name|u_int8_t
name|flags
decl_stmt|;
name|usbd_pipe_handle
modifier|*
name|pipe
decl_stmt|;
name|usbd_private_handle
name|priv
decl_stmt|;
name|void
modifier|*
name|buffer
decl_stmt|;
name|u_int32_t
name|length
decl_stmt|;
name|usbd_callback
name|cb
decl_stmt|;
block|{
name|usbd_status
name|r
decl_stmt|;
name|usbd_request_handle
name|reqh
decl_stmt|;
name|usbd_pipe_handle
name|ipipe
decl_stmt|;
name|reqh
operator|=
name|usbd_alloc_request
argument_list|()
expr_stmt|;
if|if
condition|(
name|reqh
operator|==
literal|0
condition|)
return|return
operator|(
name|USBD_NOMEM
operator|)
return|;
name|r
operator|=
name|usbd_open_pipe
argument_list|(
name|iface
argument_list|,
name|address
argument_list|,
name|USBD_EXCLUSIVE_USE
argument_list|,
operator|&
name|ipipe
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|!=
name|USBD_NORMAL_COMPLETION
condition|)
goto|goto
name|bad1
goto|;
name|r
operator|=
name|usbd_setup_request
argument_list|(
name|reqh
argument_list|,
name|ipipe
argument_list|,
name|priv
argument_list|,
name|buffer
argument_list|,
name|length
argument_list|,
name|USBD_XFER_IN
operator||
name|flags
argument_list|,
name|USBD_NO_TIMEOUT
argument_list|,
name|cb
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|!=
name|USBD_NORMAL_COMPLETION
condition|)
goto|goto
name|bad2
goto|;
name|ipipe
operator|->
name|intrreqh
operator|=
name|reqh
expr_stmt|;
name|r
operator|=
name|usbd_transfer
argument_list|(
name|reqh
argument_list|)
expr_stmt|;
operator|*
name|pipe
operator|=
name|ipipe
expr_stmt|;
if|if
condition|(
name|r
operator|!=
name|USBD_IN_PROGRESS
condition|)
goto|goto
name|bad3
goto|;
return|return
operator|(
name|USBD_NORMAL_COMPLETION
operator|)
return|;
name|bad3
label|:
name|ipipe
operator|->
name|intrreqh
operator|=
literal|0
expr_stmt|;
name|bad2
label|:
name|usbd_close_pipe
argument_list|(
name|ipipe
argument_list|)
expr_stmt|;
name|bad1
label|:
name|usbd_free_request
argument_list|(
name|reqh
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
end_function

begin_function
name|usbd_status
name|usbd_open_pipe_iso
parameter_list|(
name|iface
parameter_list|,
name|address
parameter_list|,
name|flags
parameter_list|,
name|pipe
parameter_list|,
name|priv
parameter_list|,
name|bufsize
parameter_list|,
name|nbuf
parameter_list|,
name|cb
parameter_list|)
name|usbd_interface_handle
name|iface
decl_stmt|;
name|u_int8_t
name|address
decl_stmt|;
name|u_int8_t
name|flags
decl_stmt|;
name|usbd_pipe_handle
modifier|*
name|pipe
decl_stmt|;
name|usbd_private_handle
name|priv
decl_stmt|;
name|u_int32_t
name|bufsize
decl_stmt|;
name|u_int32_t
name|nbuf
decl_stmt|;
name|usbd_callback
name|cb
decl_stmt|;
block|{
name|usbd_status
name|r
decl_stmt|;
name|usbd_pipe_handle
name|p
decl_stmt|;
name|r
operator|=
name|usbd_open_pipe
argument_list|(
name|iface
argument_list|,
name|address
argument_list|,
name|USBD_EXCLUSIVE_USE
argument_list|,
operator|&
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|!=
name|USBD_NORMAL_COMPLETION
condition|)
return|return
operator|(
name|r
operator|)
return|;
if|if
condition|(
operator|!
name|p
operator|->
name|methods
operator|->
name|isobuf
condition|)
block|{
name|usbd_close_pipe
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return
operator|(
name|USBD_INVAL
operator|)
return|;
block|}
name|r
operator|=
name|p
operator|->
name|methods
operator|->
name|isobuf
argument_list|(
name|p
argument_list|,
name|bufsize
argument_list|,
name|nbuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|!=
name|USBD_NORMAL_COMPLETION
condition|)
block|{
name|usbd_close_pipe
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return
operator|(
name|r
operator|)
return|;
block|}
operator|*
name|pipe
operator|=
name|p
expr_stmt|;
return|return
name|r
return|;
block|}
end_function

begin_function
name|usbd_status
name|usbd_close_pipe
parameter_list|(
name|pipe
parameter_list|)
name|usbd_pipe_handle
name|pipe
decl_stmt|;
block|{
if|if
condition|(
name|pipe
operator|->
name|iface
operator|->
name|state
operator|!=
name|USBD_INTERFACE_ACTIVE
condition|)
return|return
operator|(
name|USBD_INTERFACE_NOT_ACTIVE
operator|)
return|;
if|if
condition|(
operator|--
name|pipe
operator|->
name|refcnt
operator|!=
literal|0
condition|)
return|return
operator|(
name|USBD_NORMAL_COMPLETION
operator|)
return|;
if|if
condition|(
name|SIMPLEQ_FIRST
argument_list|(
operator|&
name|pipe
operator|->
name|queue
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|USBD_PENDING_REQUESTS
operator|)
return|;
name|LIST_REMOVE
argument_list|(
name|pipe
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|pipe
operator|->
name|endpoint
operator|->
name|refcnt
operator|--
expr_stmt|;
name|pipe
operator|->
name|methods
operator|->
name|close
argument_list|(
name|pipe
argument_list|)
expr_stmt|;
if|if
condition|(
name|pipe
operator|->
name|intrreqh
condition|)
name|usbd_free_request
argument_list|(
name|pipe
operator|->
name|intrreqh
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|pipe
argument_list|,
name|M_USB
argument_list|)
expr_stmt|;
return|return
operator|(
name|USBD_NORMAL_COMPLETION
operator|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|usbd_transfer
parameter_list|(
name|reqh
parameter_list|)
name|usbd_request_handle
name|reqh
decl_stmt|;
block|{
name|reqh
operator|->
name|xfercb
operator|=
name|usbd_transfer_cb
expr_stmt|;
return|return
operator|(
name|usbd_do_transfer
argument_list|(
name|reqh
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|usbd_status
name|usbd_do_transfer
parameter_list|(
name|reqh
parameter_list|)
name|usbd_request_handle
name|reqh
decl_stmt|;
block|{
name|usbd_pipe_handle
name|pipe
init|=
name|reqh
operator|->
name|pipe
decl_stmt|;
name|DPRINTFN
argument_list|(
literal|10
argument_list|,
operator|(
literal|"usbd_do_transfer: reqh=%p\n"
operator|,
name|reqh
operator|)
argument_list|)
expr_stmt|;
name|reqh
operator|->
name|done
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|pipe
operator|->
name|methods
operator|->
name|transfer
argument_list|(
name|reqh
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|usbd_request_handle
name|usbd_alloc_request
parameter_list|()
block|{
name|usbd_request_handle
name|reqh
decl_stmt|;
name|reqh
operator|=
name|SIMPLEQ_FIRST
argument_list|(
operator|&
name|usbd_free_requests
argument_list|)
expr_stmt|;
if|if
condition|(
name|reqh
condition|)
name|SIMPLEQ_REMOVE_HEAD
argument_list|(
operator|&
name|usbd_free_requests
argument_list|,
name|reqh
argument_list|,
name|next
argument_list|)
expr_stmt|;
else|else
name|reqh
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|reqh
argument_list|)
argument_list|,
name|M_USB
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|reqh
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|memset
argument_list|(
name|reqh
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
expr|*
name|reqh
argument_list|)
expr_stmt|;
return|return
operator|(
name|reqh
operator|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|usbd_free_request
parameter_list|(
name|reqh
parameter_list|)
name|usbd_request_handle
name|reqh
decl_stmt|;
block|{
name|SIMPLEQ_INSERT_HEAD
argument_list|(
operator|&
name|usbd_free_requests
argument_list|,
name|reqh
argument_list|,
name|next
argument_list|)
expr_stmt|;
return|return
operator|(
name|USBD_NORMAL_COMPLETION
operator|)
return|;
block|}
end_function

begin_function_decl
name|usbd_status
name|usbd_setup_request
parameter_list|(
name|reqh
parameter_list|,
name|pipe
parameter_list|,
name|priv
parameter_list|,
name|buffer
parameter_list|,
name|length
parameter_list|,
name|flags
parameter_list|,
name|timeout
parameter_list|,
name|callback
parameter_list|)
name|usbd_request_handle
name|reqh
decl_stmt|;
name|usbd_pipe_handle
name|pipe
decl_stmt|;
name|usbd_private_handle
name|priv
decl_stmt|;
name|void
modifier|*
name|buffer
decl_stmt|;
name|u_int32_t
name|length
decl_stmt|;
name|u_int16_t
name|flags
decl_stmt|;
name|u_int32_t
name|timeout
decl_stmt|;
function_decl|void
parameter_list|(
function_decl|*callback
end_function_decl

begin_expr_stmt
unit|)
name|__P
argument_list|(
operator|(
name|usbd_request_handle
operator|,
name|usbd_private_handle
operator|,
name|usbd_status
operator|)
argument_list|)
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|reqh
operator|->
name|pipe
operator|=
name|pipe
expr_stmt|;
name|reqh
operator|->
name|isreq
operator|=
literal|0
expr_stmt|;
name|reqh
operator|->
name|priv
operator|=
name|priv
expr_stmt|;
name|reqh
operator|->
name|buffer
operator|=
name|buffer
expr_stmt|;
name|reqh
operator|->
name|length
operator|=
name|length
expr_stmt|;
name|reqh
operator|->
name|actlen
operator|=
literal|0
expr_stmt|;
name|reqh
operator|->
name|flags
operator|=
name|flags
expr_stmt|;
name|reqh
operator|->
name|callback
operator|=
name|callback
expr_stmt|;
name|reqh
operator|->
name|status
operator|=
name|USBD_NOT_STARTED
expr_stmt|;
name|reqh
operator|->
name|retries
operator|=
literal|1
expr_stmt|;
return|return
operator|(
name|USBD_NORMAL_COMPLETION
operator|)
return|;
block|}
end_block

begin_function
name|usbd_status
name|usbd_setup_device_request
parameter_list|(
name|reqh
parameter_list|,
name|req
parameter_list|)
name|usbd_request_handle
name|reqh
decl_stmt|;
name|usb_device_request_t
modifier|*
name|req
decl_stmt|;
block|{
name|reqh
operator|->
name|isreq
operator|=
literal|1
expr_stmt|;
name|reqh
operator|->
name|request
operator|=
operator|*
name|req
expr_stmt|;
return|return
operator|(
name|USBD_NORMAL_COMPLETION
operator|)
return|;
block|}
end_function

begin_function_decl
name|usbd_status
name|usbd_setup_default_request
parameter_list|(
name|reqh
parameter_list|,
name|dev
parameter_list|,
name|priv
parameter_list|,
name|timeout
parameter_list|,
name|req
parameter_list|,
name|buffer
parameter_list|,
name|length
parameter_list|,
name|flags
parameter_list|,
name|callback
parameter_list|)
name|usbd_request_handle
name|reqh
decl_stmt|;
name|usbd_device_handle
name|dev
decl_stmt|;
name|usbd_private_handle
name|priv
decl_stmt|;
name|u_int32_t
name|timeout
decl_stmt|;
name|usb_device_request_t
modifier|*
name|req
decl_stmt|;
name|void
modifier|*
name|buffer
decl_stmt|;
name|u_int32_t
name|length
decl_stmt|;
name|u_int16_t
name|flags
decl_stmt|;
function_decl|void
parameter_list|(
function_decl|*callback
end_function_decl

begin_expr_stmt
unit|)
name|__P
argument_list|(
operator|(
name|usbd_request_handle
operator|,
name|usbd_private_handle
operator|,
name|usbd_status
operator|)
argument_list|)
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|reqh
operator|->
name|pipe
operator|=
name|dev
operator|->
name|default_pipe
expr_stmt|;
name|reqh
operator|->
name|priv
operator|=
name|priv
expr_stmt|;
name|reqh
operator|->
name|buffer
operator|=
name|buffer
expr_stmt|;
name|reqh
operator|->
name|length
operator|=
name|length
expr_stmt|;
name|reqh
operator|->
name|actlen
operator|=
literal|0
expr_stmt|;
name|reqh
operator|->
name|flags
operator|=
name|flags
expr_stmt|;
name|reqh
operator|->
name|timeout
operator|=
name|timeout
expr_stmt|;
name|reqh
operator|->
name|status
operator|=
name|USBD_NOT_STARTED
expr_stmt|;
name|reqh
operator|->
name|callback
operator|=
name|callback
expr_stmt|;
name|reqh
operator|->
name|request
operator|=
operator|*
name|req
expr_stmt|;
name|reqh
operator|->
name|isreq
operator|=
literal|1
expr_stmt|;
name|reqh
operator|->
name|retries
operator|=
literal|1
expr_stmt|;
return|return
operator|(
name|USBD_NORMAL_COMPLETION
operator|)
return|;
block|}
end_block

begin_function
name|usbd_status
name|usbd_set_request_timeout
parameter_list|(
name|reqh
parameter_list|,
name|timeout
parameter_list|)
name|usbd_request_handle
name|reqh
decl_stmt|;
name|u_int32_t
name|timeout
decl_stmt|;
block|{
name|reqh
operator|->
name|timeout
operator|=
name|timeout
expr_stmt|;
return|return
operator|(
name|USBD_NORMAL_COMPLETION
operator|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|usbd_get_request_status
parameter_list|(
name|reqh
parameter_list|,
name|priv
parameter_list|,
name|buffer
parameter_list|,
name|count
parameter_list|,
name|status
parameter_list|)
name|usbd_request_handle
name|reqh
decl_stmt|;
name|usbd_private_handle
modifier|*
name|priv
decl_stmt|;
name|void
modifier|*
modifier|*
name|buffer
decl_stmt|;
name|u_int32_t
modifier|*
name|count
decl_stmt|;
name|usbd_status
modifier|*
name|status
decl_stmt|;
block|{
operator|*
name|priv
operator|=
name|reqh
operator|->
name|priv
expr_stmt|;
operator|*
name|buffer
operator|=
name|reqh
operator|->
name|buffer
expr_stmt|;
operator|*
name|count
operator|=
name|reqh
operator|->
name|actlen
expr_stmt|;
operator|*
name|status
operator|=
name|reqh
operator|->
name|status
expr_stmt|;
return|return
operator|(
name|USBD_NORMAL_COMPLETION
operator|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|usbd_request_device_data
parameter_list|(
name|reqh
parameter_list|,
name|req
parameter_list|)
name|usbd_request_handle
name|reqh
decl_stmt|;
name|usb_device_request_t
modifier|*
name|req
decl_stmt|;
block|{
if|if
condition|(
operator|!
name|reqh
operator|->
name|isreq
condition|)
return|return
operator|(
name|USBD_INVAL
operator|)
return|;
operator|*
name|req
operator|=
name|reqh
operator|->
name|request
expr_stmt|;
return|return
operator|(
name|USBD_NORMAL_COMPLETION
operator|)
return|;
block|}
end_function

begin_if
if|#
directive|if
literal|0
end_if

begin_endif
unit|usb_descriptor_t * usbd_get_descriptor(iface, desc_type) 	usbd_interface_handle *iface; 	u_int8_t desc_type; XX
endif|#
directive|endif
end_endif

begin_function
name|usb_config_descriptor_t
modifier|*
name|usbd_get_config_descriptor
parameter_list|(
name|dev
parameter_list|)
name|usbd_device_handle
name|dev
decl_stmt|;
block|{
return|return
operator|(
name|dev
operator|->
name|cdesc
operator|)
return|;
block|}
end_function

begin_function
name|usb_interface_descriptor_t
modifier|*
name|usbd_get_interface_descriptor
parameter_list|(
name|iface
parameter_list|)
name|usbd_interface_handle
name|iface
decl_stmt|;
block|{
return|return
operator|(
name|iface
operator|->
name|idesc
operator|)
return|;
block|}
end_function

begin_function
name|usb_device_descriptor_t
modifier|*
name|usbd_get_device_descriptor
parameter_list|(
name|dev
parameter_list|)
name|usbd_device_handle
name|dev
decl_stmt|;
block|{
return|return
operator|(
operator|&
name|dev
operator|->
name|ddesc
operator|)
return|;
block|}
end_function

begin_function
name|usb_endpoint_descriptor_t
modifier|*
name|usbd_interface2endpoint_descriptor
parameter_list|(
name|iface
parameter_list|,
name|index
parameter_list|)
name|usbd_interface_handle
name|iface
decl_stmt|;
name|u_int8_t
name|index
decl_stmt|;
block|{
if|if
condition|(
name|index
operator|>=
name|iface
operator|->
name|idesc
operator|->
name|bNumEndpoints
condition|)
return|return
operator|(
literal|0
operator|)
return|;
return|return
operator|(
name|iface
operator|->
name|endpoints
index|[
name|index
index|]
operator|.
name|edesc
operator|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|usbd_set_configuration
parameter_list|(
name|dev
parameter_list|,
name|conf
parameter_list|)
name|usbd_device_handle
name|dev
decl_stmt|;
name|u_int8_t
name|conf
decl_stmt|;
block|{
return|return
name|usbd_set_config_no
argument_list|(
name|dev
argument_list|,
name|conf
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|usbd_retry_request
parameter_list|(
name|reqh
parameter_list|,
name|retry_count
parameter_list|)
name|usbd_request_handle
name|reqh
decl_stmt|;
name|u_int32_t
name|retry_count
decl_stmt|;
block|{
name|usbd_status
name|r
decl_stmt|;
name|r
operator|=
name|usbd_set_pipe_state
argument_list|(
name|reqh
operator|->
name|pipe
argument_list|,
name|USBD_PIPE_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|!=
name|USBD_NORMAL_COMPLETION
condition|)
return|return
operator|(
name|r
operator|)
return|;
name|reqh
operator|->
name|retries
operator|=
name|retry_count
expr_stmt|;
return|return
operator|(
name|usbd_transfer
argument_list|(
name|reqh
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|usbd_abort_pipe
parameter_list|(
name|pipe
parameter_list|)
name|usbd_pipe_handle
name|pipe
decl_stmt|;
block|{
name|usbd_status
name|r
decl_stmt|;
name|int
name|s
decl_stmt|,
name|st
decl_stmt|;
if|if
condition|(
name|pipe
operator|->
name|iface
operator|->
name|state
operator|!=
name|USBD_INTERFACE_ACTIVE
condition|)
return|return
operator|(
name|USBD_INTERFACE_NOT_ACTIVE
operator|)
return|;
name|s
operator|=
name|splusb
argument_list|()
expr_stmt|;
name|st
operator|=
name|pipe
operator|->
name|state
expr_stmt|;
name|r
operator|=
name|usbd_ar_pipe
argument_list|(
name|pipe
argument_list|)
expr_stmt|;
name|pipe
operator|->
name|state
operator|=
name|st
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
operator|(
name|r
operator|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|usbd_abort_interface
parameter_list|(
name|iface
parameter_list|)
name|usbd_interface_handle
name|iface
decl_stmt|;
block|{
name|usbd_status
name|r
decl_stmt|;
name|int
name|s
decl_stmt|,
name|st
decl_stmt|;
name|s
operator|=
name|splusb
argument_list|()
expr_stmt|;
name|st
operator|=
name|iface
operator|->
name|state
expr_stmt|;
name|r
operator|=
name|usbd_ar_iface
argument_list|(
name|iface
argument_list|)
expr_stmt|;
name|iface
operator|->
name|state
operator|=
name|st
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
operator|(
name|r
operator|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|usbd_reset_pipe
parameter_list|(
name|pipe
parameter_list|)
name|usbd_pipe_handle
name|pipe
decl_stmt|;
block|{
name|usbd_status
name|r
decl_stmt|;
name|int
name|s
decl_stmt|;
if|if
condition|(
name|pipe
operator|->
name|iface
operator|->
name|state
operator|!=
name|USBD_INTERFACE_ACTIVE
condition|)
return|return
operator|(
name|USBD_INTERFACE_NOT_ACTIVE
operator|)
return|;
name|s
operator|=
name|splusb
argument_list|()
expr_stmt|;
name|r
operator|=
name|usbd_ar_pipe
argument_list|(
name|pipe
argument_list|)
expr_stmt|;
comment|/* XXX anything else */
name|pipe
operator|->
name|state
operator|=
name|USBD_PIPE_ACTIVE
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
operator|(
name|r
operator|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|usbd_reset_interface
parameter_list|(
name|iface
parameter_list|)
name|usbd_interface_handle
name|iface
decl_stmt|;
block|{
name|usbd_status
name|r
decl_stmt|;
name|int
name|s
decl_stmt|;
name|s
operator|=
name|splusb
argument_list|()
expr_stmt|;
name|r
operator|=
name|usbd_ar_iface
argument_list|(
name|iface
argument_list|)
expr_stmt|;
comment|/* XXX anything else */
name|iface
operator|->
name|state
operator|=
name|USBD_INTERFACE_ACTIVE
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
operator|(
name|r
operator|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|usbd_clear_endpoint_stall
parameter_list|(
name|pipe
parameter_list|)
name|usbd_pipe_handle
name|pipe
decl_stmt|;
block|{
name|usbd_device_handle
name|dev
init|=
name|pipe
operator|->
name|device
decl_stmt|;
name|usb_device_request_t
name|req
decl_stmt|;
name|usbd_status
name|r
decl_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_WRITE_ENDPOINT
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|UR_CLEAR_FEATURE
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
name|UF_ENDPOINT_HALT
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
name|pipe
operator|->
name|endpoint
operator|->
name|edesc
operator|->
name|bEndpointAddress
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|r
operator|=
name|usbd_do_request
argument_list|(
name|dev
argument_list|,
operator|&
name|req
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|XXX should we do this? 	if (r == USBD_NORMAL_COMPLETION) { 		pipe->state = USBD_PIPE_ACTIVE;
comment|/* XXX activate pipe */
block|}
endif|#
directive|endif
return|return
operator|(
name|r
operator|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|usbd_clear_endpoint_stall_async
parameter_list|(
name|pipe
parameter_list|)
name|usbd_pipe_handle
name|pipe
decl_stmt|;
block|{
name|usbd_device_handle
name|dev
init|=
name|pipe
operator|->
name|device
decl_stmt|;
name|usb_device_request_t
name|req
decl_stmt|;
name|usbd_status
name|r
decl_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_WRITE_ENDPOINT
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|UR_CLEAR_FEATURE
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
name|UF_ENDPOINT_HALT
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
name|pipe
operator|->
name|endpoint
operator|->
name|edesc
operator|->
name|bEndpointAddress
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|r
operator|=
name|usbd_do_request_async
argument_list|(
name|dev
argument_list|,
operator|&
name|req
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|r
operator|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|usbd_set_pipe_state
parameter_list|(
name|pipe
parameter_list|,
name|state
parameter_list|)
name|usbd_pipe_handle
name|pipe
decl_stmt|;
name|usbd_pipe_state
name|state
decl_stmt|;
block|{
name|int
name|s
decl_stmt|;
name|usbd_status
name|r
decl_stmt|;
name|usbd_request_handle
name|reqh
decl_stmt|;
if|if
condition|(
name|pipe
operator|->
name|iface
operator|->
name|state
operator|!=
name|USBD_INTERFACE_ACTIVE
condition|)
return|return
operator|(
name|USBD_INTERFACE_NOT_ACTIVE
operator|)
return|;
if|if
condition|(
name|state
operator|!=
name|USBD_PIPE_ACTIVE
operator|&&
name|state
operator|!=
name|USBD_PIPE_STALLED
operator|&&
name|state
operator|!=
name|USBD_PIPE_IDLE
condition|)
return|return
operator|(
name|USBD_INVAL
operator|)
return|;
name|pipe
operator|->
name|state
operator|=
name|state
expr_stmt|;
name|r
operator|=
name|USBD_NORMAL_COMPLETION
expr_stmt|;
if|if
condition|(
name|state
operator|==
name|USBD_PIPE_ACTIVE
condition|)
block|{
name|s
operator|=
name|splusb
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|pipe
operator|->
name|running
condition|)
block|{
name|reqh
operator|=
name|SIMPLEQ_FIRST
argument_list|(
operator|&
name|pipe
operator|->
name|queue
argument_list|)
expr_stmt|;
if|if
condition|(
name|reqh
operator|!=
literal|0
condition|)
block|{
name|pipe
operator|->
name|running
operator|=
literal|1
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|r
operator|=
name|pipe
operator|->
name|methods
operator|->
name|start
argument_list|(
name|reqh
argument_list|)
expr_stmt|;
block|}
else|else
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
else|else
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|r
operator|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|usbd_get_pipe_state
parameter_list|(
name|pipe
parameter_list|,
name|state
parameter_list|,
name|endpoint_state
parameter_list|,
name|request_count
parameter_list|)
name|usbd_pipe_handle
name|pipe
decl_stmt|;
name|usbd_pipe_state
modifier|*
name|state
decl_stmt|;
name|u_int32_t
modifier|*
name|endpoint_state
decl_stmt|;
name|u_int32_t
modifier|*
name|request_count
decl_stmt|;
block|{
name|int
name|n
decl_stmt|;
name|usbd_request_handle
name|r
decl_stmt|;
operator|*
name|state
operator|=
name|pipe
operator|->
name|state
expr_stmt|;
operator|*
name|endpoint_state
operator|=
name|pipe
operator|->
name|endpoint
operator|->
name|state
expr_stmt|;
for|for
control|(
name|r
operator|=
name|SIMPLEQ_FIRST
argument_list|(
operator|&
name|pipe
operator|->
name|queue
argument_list|)
operator|,
name|n
operator|=
literal|0
init|;
name|r
operator|!=
literal|0
condition|;
name|r
operator|=
name|SIMPLEQ_NEXT
argument_list|(
name|r
argument_list|,
name|next
argument_list|)
operator|,
name|n
operator|++
control|)
empty_stmt|;
operator|*
name|request_count
operator|=
name|n
expr_stmt|;
return|return
operator|(
name|USBD_NORMAL_COMPLETION
operator|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|usbd_set_interface_state
parameter_list|(
name|iface
parameter_list|,
name|state
parameter_list|)
name|usbd_interface_handle
name|iface
decl_stmt|;
name|usbd_interface_state
name|state
decl_stmt|;
block|{
name|int
name|ps
decl_stmt|;
name|usbd_pipe_handle
name|p
decl_stmt|;
if|if
condition|(
name|state
operator|==
name|USBD_INTERFACE_ACTIVE
condition|)
name|ps
operator|=
name|USBD_PIPE_ACTIVE
expr_stmt|;
elseif|else
if|if
condition|(
name|state
operator|==
name|USBD_INTERFACE_STALLED
condition|)
name|ps
operator|=
name|USBD_PIPE_STALLED
expr_stmt|;
elseif|else
if|if
condition|(
name|state
operator|==
name|USBD_INTERFACE_IDLE
condition|)
name|ps
operator|=
name|USBD_PIPE_IDLE
expr_stmt|;
else|else
return|return
operator|(
name|USBD_INVAL
operator|)
return|;
name|iface
operator|->
name|state
operator|=
name|USBD_INTERFACE_ACTIVE
expr_stmt|;
comment|/* to allow setting the pipe */
for|for
control|(
name|p
operator|=
name|LIST_FIRST
argument_list|(
operator|&
name|iface
operator|->
name|pipes
argument_list|)
init|;
name|p
operator|!=
literal|0
condition|;
name|p
operator|=
name|LIST_NEXT
argument_list|(
name|p
argument_list|,
name|next
argument_list|)
control|)
name|usbd_set_pipe_state
argument_list|(
name|p
argument_list|,
name|ps
argument_list|)
expr_stmt|;
name|iface
operator|->
name|state
operator|=
name|state
expr_stmt|;
return|return
operator|(
name|USBD_NORMAL_COMPLETION
operator|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|usbd_get_interface_state
parameter_list|(
name|iface
parameter_list|,
name|state
parameter_list|)
name|usbd_interface_handle
name|iface
decl_stmt|;
name|usbd_interface_state
modifier|*
name|state
decl_stmt|;
block|{
operator|*
name|state
operator|=
name|iface
operator|->
name|state
expr_stmt|;
return|return
operator|(
name|USBD_NORMAL_COMPLETION
operator|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|usbd_get_device_state
parameter_list|(
name|dev
parameter_list|,
name|state
parameter_list|)
name|usbd_device_handle
name|dev
decl_stmt|;
name|usbd_device_state
modifier|*
name|state
decl_stmt|;
block|{
operator|*
name|state
operator|=
name|dev
operator|->
name|state
expr_stmt|;
return|return
operator|(
name|USBD_NORMAL_COMPLETION
operator|)
return|;
block|}
end_function

begin_if
if|#
directive|if
literal|0
end_if

begin_endif
unit|usbd_status  usbd_set_device_state(dev, state) 	usbd_device_handle dev; 	usbd_device_state state; X
endif|#
directive|endif
end_endif

begin_function
name|usbd_status
name|usbd_device_address
parameter_list|(
name|dev
parameter_list|,
name|address
parameter_list|)
name|usbd_device_handle
name|dev
decl_stmt|;
name|u_int8_t
modifier|*
name|address
decl_stmt|;
block|{
operator|*
name|address
operator|=
name|dev
operator|->
name|address
expr_stmt|;
return|return
operator|(
name|USBD_NORMAL_COMPLETION
operator|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|usbd_endpoint_address
parameter_list|(
name|pipe
parameter_list|,
name|address
parameter_list|)
name|usbd_pipe_handle
name|pipe
decl_stmt|;
name|u_int8_t
modifier|*
name|address
decl_stmt|;
block|{
operator|*
name|address
operator|=
name|pipe
operator|->
name|endpoint
operator|->
name|edesc
operator|->
name|bEndpointAddress
expr_stmt|;
return|return
operator|(
name|USBD_NORMAL_COMPLETION
operator|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|usbd_endpoint_count
parameter_list|(
name|iface
parameter_list|,
name|count
parameter_list|)
name|usbd_interface_handle
name|iface
decl_stmt|;
name|u_int8_t
modifier|*
name|count
decl_stmt|;
block|{
operator|*
name|count
operator|=
name|iface
operator|->
name|idesc
operator|->
name|bNumEndpoints
expr_stmt|;
return|return
operator|(
name|USBD_NORMAL_COMPLETION
operator|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|usbd_interface_count
parameter_list|(
name|dev
parameter_list|,
name|count
parameter_list|)
name|usbd_device_handle
name|dev
decl_stmt|;
name|u_int8_t
modifier|*
name|count
decl_stmt|;
block|{
if|if
condition|(
operator|!
name|dev
operator|->
name|cdesc
condition|)
return|return
operator|(
name|USBD_NOT_CONFIGURED
operator|)
return|;
operator|*
name|count
operator|=
name|dev
operator|->
name|cdesc
operator|->
name|bNumInterface
expr_stmt|;
return|return
operator|(
name|USBD_NORMAL_COMPLETION
operator|)
return|;
block|}
end_function

begin_if
if|#
directive|if
literal|0
end_if

begin_endif
unit|u_int8_t  usbd_bus_count() { 	return (usb_bus_count()); }
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__NetBSD__
argument_list|)
end_if

begin_function
name|usbd_status
name|usbd_get_bus_handle
parameter_list|(
name|index
parameter_list|,
name|bus
parameter_list|)
name|u_int8_t
name|index
decl_stmt|;
name|usbd_bus_handle
modifier|*
name|bus
decl_stmt|;
block|{
return|return
operator|(
name|usb_get_bus_handle
argument_list|(
name|index
argument_list|,
name|bus
argument_list|)
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|usbd_status
name|usbd_get_root_hub
parameter_list|(
name|bus
parameter_list|,
name|dev
parameter_list|)
name|usbd_bus_handle
name|bus
decl_stmt|;
name|usbd_device_handle
modifier|*
name|dev
decl_stmt|;
block|{
operator|*
name|dev
operator|=
name|bus
operator|->
name|root_hub
expr_stmt|;
return|return
operator|(
name|USBD_NORMAL_COMPLETION
operator|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|usbd_port_count
parameter_list|(
name|dev
parameter_list|,
name|nports
parameter_list|)
name|usbd_device_handle
name|dev
decl_stmt|;
name|u_int8_t
modifier|*
name|nports
decl_stmt|;
block|{
if|if
condition|(
name|dev
operator|->
name|hub
operator|==
literal|0
condition|)
return|return
operator|(
name|USBD_INVAL
operator|)
return|;
operator|*
name|nports
operator|=
name|dev
operator|->
name|hub
operator|->
name|hubdesc
operator|.
name|bNbrPorts
expr_stmt|;
return|return
operator|(
name|USBD_NORMAL_COMPLETION
operator|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|usbd_hub2device_handle
parameter_list|(
name|dev
parameter_list|,
name|port
parameter_list|,
name|devp
parameter_list|)
name|usbd_device_handle
name|dev
decl_stmt|;
name|u_int8_t
name|port
decl_stmt|;
name|usbd_device_handle
modifier|*
name|devp
decl_stmt|;
block|{
if|if
condition|(
name|dev
operator|->
name|hub
operator|==
literal|0
operator|||
name|port
operator|>=
name|dev
operator|->
name|hub
operator|->
name|hubdesc
operator|.
name|bNbrPorts
operator|||
name|dev
operator|->
name|hub
operator|->
name|ports
index|[
name|port
index|]
operator|.
name|device
operator|==
literal|0
condition|)
return|return
operator|(
name|USBD_INVAL
operator|)
return|;
operator|*
name|devp
operator|=
name|dev
operator|->
name|hub
operator|->
name|ports
index|[
name|port
index|]
operator|.
name|device
expr_stmt|;
return|return
operator|(
name|USBD_NORMAL_COMPLETION
operator|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|usbd_request2pipe_handle
parameter_list|(
name|reqh
parameter_list|,
name|pipe
parameter_list|)
name|usbd_request_handle
name|reqh
decl_stmt|;
name|usbd_pipe_handle
modifier|*
name|pipe
decl_stmt|;
block|{
operator|*
name|pipe
operator|=
name|reqh
operator|->
name|pipe
expr_stmt|;
return|return
operator|(
name|USBD_NORMAL_COMPLETION
operator|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|usbd_pipe2interface_handle
parameter_list|(
name|pipe
parameter_list|,
name|iface
parameter_list|)
name|usbd_pipe_handle
name|pipe
decl_stmt|;
name|usbd_interface_handle
modifier|*
name|iface
decl_stmt|;
block|{
operator|*
name|iface
operator|=
name|pipe
operator|->
name|iface
expr_stmt|;
return|return
operator|(
name|USBD_NORMAL_COMPLETION
operator|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|usbd_interface2device_handle
parameter_list|(
name|iface
parameter_list|,
name|dev
parameter_list|)
name|usbd_interface_handle
name|iface
decl_stmt|;
name|usbd_device_handle
modifier|*
name|dev
decl_stmt|;
block|{
operator|*
name|dev
operator|=
name|iface
operator|->
name|device
expr_stmt|;
return|return
operator|(
name|USBD_NORMAL_COMPLETION
operator|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|usbd_device2bus_handle
parameter_list|(
name|dev
parameter_list|,
name|bus
parameter_list|)
name|usbd_device_handle
name|dev
decl_stmt|;
name|usbd_bus_handle
modifier|*
name|bus
decl_stmt|;
block|{
operator|*
name|bus
operator|=
name|dev
operator|->
name|bus
expr_stmt|;
return|return
operator|(
name|USBD_NORMAL_COMPLETION
operator|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|usbd_device2interface_handle
parameter_list|(
name|dev
parameter_list|,
name|ifaceno
parameter_list|,
name|iface
parameter_list|)
name|usbd_device_handle
name|dev
decl_stmt|;
name|u_int8_t
name|ifaceno
decl_stmt|;
name|usbd_interface_handle
modifier|*
name|iface
decl_stmt|;
block|{
if|if
condition|(
operator|!
name|dev
operator|->
name|cdesc
condition|)
return|return
operator|(
name|USBD_NOT_CONFIGURED
operator|)
return|;
if|if
condition|(
name|ifaceno
operator|>=
name|dev
operator|->
name|cdesc
operator|->
name|bNumInterface
condition|)
return|return
operator|(
name|USBD_INVAL
operator|)
return|;
operator|*
name|iface
operator|=
operator|&
name|dev
operator|->
name|ifaces
index|[
name|ifaceno
index|]
expr_stmt|;
return|return
operator|(
name|USBD_NORMAL_COMPLETION
operator|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|usbd_set_interface_private_handle
parameter_list|(
name|iface
parameter_list|,
name|priv
parameter_list|)
name|usbd_interface_handle
name|iface
decl_stmt|;
name|usbd_private_handle
name|priv
decl_stmt|;
block|{
name|iface
operator|->
name|priv
operator|=
name|priv
expr_stmt|;
return|return
operator|(
name|USBD_NORMAL_COMPLETION
operator|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|usbd_get_interface_private_handle
parameter_list|(
name|iface
parameter_list|,
name|priv
parameter_list|)
name|usbd_interface_handle
name|iface
decl_stmt|;
name|usbd_private_handle
modifier|*
name|priv
decl_stmt|;
block|{
operator|*
name|priv
operator|=
name|iface
operator|->
name|priv
expr_stmt|;
return|return
operator|(
name|USBD_NORMAL_COMPLETION
operator|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|usbd_reference_pipe
parameter_list|(
name|pipe
parameter_list|)
name|usbd_pipe_handle
name|pipe
decl_stmt|;
block|{
name|pipe
operator|->
name|refcnt
operator|++
expr_stmt|;
return|return
operator|(
name|USBD_NORMAL_COMPLETION
operator|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|usbd_dereference_pipe
parameter_list|(
name|pipe
parameter_list|)
name|usbd_pipe_handle
name|pipe
decl_stmt|;
block|{
name|pipe
operator|->
name|refcnt
operator|--
expr_stmt|;
return|return
operator|(
name|USBD_NORMAL_COMPLETION
operator|)
return|;
block|}
end_function

begin_function
name|usbd_lock_token
name|usbd_lock
parameter_list|()
block|{
return|return
operator|(
name|splusb
argument_list|()
operator|)
return|;
block|}
end_function

begin_function
name|void
name|usbd_unlock
parameter_list|(
name|tok
parameter_list|)
name|usbd_lock_token
name|tok
decl_stmt|;
block|{
name|splx
argument_list|(
name|tok
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* XXXX use altno */
end_comment

begin_function
name|usbd_status
name|usbd_set_interface
parameter_list|(
name|iface
parameter_list|,
name|altidx
parameter_list|)
name|usbd_interface_handle
name|iface
decl_stmt|;
name|int
name|altidx
decl_stmt|;
block|{
name|usb_device_request_t
name|req
decl_stmt|;
name|usbd_status
name|r
decl_stmt|;
if|if
condition|(
name|LIST_FIRST
argument_list|(
operator|&
name|iface
operator|->
name|pipes
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|USBD_IN_USE
operator|)
return|;
if|if
condition|(
name|iface
operator|->
name|endpoints
condition|)
name|free
argument_list|(
name|iface
operator|->
name|endpoints
argument_list|,
name|M_USB
argument_list|)
expr_stmt|;
name|iface
operator|->
name|endpoints
operator|=
literal|0
expr_stmt|;
name|iface
operator|->
name|idesc
operator|=
literal|0
expr_stmt|;
name|iface
operator|->
name|state
operator|=
name|USBD_INTERFACE_IDLE
expr_stmt|;
name|r
operator|=
name|usbd_fill_iface_data
argument_list|(
name|iface
operator|->
name|device
argument_list|,
name|iface
operator|->
name|index
argument_list|,
name|altidx
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|!=
name|USBD_NORMAL_COMPLETION
condition|)
return|return
operator|(
name|r
operator|)
return|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_WRITE_INTERFACE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|UR_SET_INTERFACE
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
name|iface
operator|->
name|idesc
operator|->
name|bAlternateSetting
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
name|iface
operator|->
name|idesc
operator|->
name|bInterfaceNumber
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|usbd_do_request
argument_list|(
name|iface
operator|->
name|device
argument_list|,
operator|&
name|req
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|usbd_get_no_alts
parameter_list|(
name|cdesc
parameter_list|,
name|ifaceno
parameter_list|)
name|usb_config_descriptor_t
modifier|*
name|cdesc
decl_stmt|;
name|int
name|ifaceno
decl_stmt|;
block|{
name|char
modifier|*
name|p
init|=
operator|(
name|char
operator|*
operator|)
name|cdesc
decl_stmt|;
name|char
modifier|*
name|end
init|=
name|p
operator|+
name|UGETW
argument_list|(
name|cdesc
operator|->
name|wTotalLength
argument_list|)
decl_stmt|;
name|usb_interface_descriptor_t
modifier|*
name|d
decl_stmt|;
name|int
name|n
decl_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|p
operator|<
name|end
condition|;
name|p
operator|+=
name|d
operator|->
name|bLength
control|)
block|{
name|d
operator|=
operator|(
name|usb_interface_descriptor_t
operator|*
operator|)
name|p
expr_stmt|;
if|if
condition|(
name|p
operator|+
name|d
operator|->
name|bLength
operator|<=
name|end
operator|&&
name|d
operator|->
name|bDescriptorType
operator|==
name|UDESC_INTERFACE
operator|&&
name|d
operator|->
name|bInterfaceNumber
operator|==
name|ifaceno
condition|)
name|n
operator|++
expr_stmt|;
block|}
return|return
operator|(
name|n
operator|)
return|;
block|}
end_function

begin_function
name|int
name|usbd_get_interface_altindex
parameter_list|(
name|iface
parameter_list|)
name|usbd_interface_handle
name|iface
decl_stmt|;
block|{
return|return
operator|(
name|iface
operator|->
name|altindex
operator|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|usbd_get_interface
parameter_list|(
name|iface
parameter_list|,
name|aiface
parameter_list|)
name|usbd_interface_handle
name|iface
decl_stmt|;
name|u_int8_t
modifier|*
name|aiface
decl_stmt|;
block|{
name|usb_device_request_t
name|req
decl_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_READ_INTERFACE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|UR_GET_INTERFACE
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
name|iface
operator|->
name|idesc
operator|->
name|bInterfaceNumber
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|usbd_do_request
argument_list|(
name|iface
operator|->
name|device
argument_list|,
operator|&
name|req
argument_list|,
name|aiface
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*** Internal routines ***/
end_comment

begin_comment
comment|/* Dequeue all pipe operations, called at splusb(). */
end_comment

begin_function
specifier|static
name|usbd_status
name|usbd_ar_pipe
parameter_list|(
name|pipe
parameter_list|)
name|usbd_pipe_handle
name|pipe
decl_stmt|;
block|{
name|usbd_request_handle
name|reqh
decl_stmt|;
if|#
directive|if
literal|0
block|for (;;) { 		reqh = SIMPLEQ_FIRST(&pipe->queue); 		if (reqh == 0) 			break; 		SIMPLEQ_REMOVE_HEAD(&pipe->queue, reqh, next); 		reqh->status = USBD_CANCELLED; 		if (reqh->callback) 			reqh->callback(reqh, reqh->priv, reqh->status); 	}
else|#
directive|else
while|while
condition|(
operator|(
name|reqh
operator|=
name|SIMPLEQ_FIRST
argument_list|(
operator|&
name|pipe
operator|->
name|queue
argument_list|)
operator|)
condition|)
block|{
name|pipe
operator|->
name|methods
operator|->
name|abort
argument_list|(
name|reqh
argument_list|)
expr_stmt|;
name|SIMPLEQ_REMOVE_HEAD
argument_list|(
operator|&
name|pipe
operator|->
name|queue
argument_list|,
name|reqh
argument_list|,
name|next
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
return|return
operator|(
name|USBD_NORMAL_COMPLETION
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Dequeue all interface operations, called at splusb(). */
end_comment

begin_function
specifier|static
name|usbd_status
name|usbd_ar_iface
parameter_list|(
name|iface
parameter_list|)
name|usbd_interface_handle
name|iface
decl_stmt|;
block|{
name|usbd_pipe_handle
name|p
decl_stmt|;
name|usbd_status
name|r
decl_stmt|,
name|ret
init|=
name|USBD_NORMAL_COMPLETION
decl_stmt|;
for|for
control|(
name|p
operator|=
name|LIST_FIRST
argument_list|(
operator|&
name|iface
operator|->
name|pipes
argument_list|)
init|;
name|p
operator|!=
literal|0
condition|;
name|p
operator|=
name|LIST_NEXT
argument_list|(
name|p
argument_list|,
name|next
argument_list|)
control|)
block|{
name|r
operator|=
name|usbd_ar_pipe
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|!=
name|USBD_NORMAL_COMPLETION
condition|)
name|ret
operator|=
name|r
expr_stmt|;
block|}
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|int
name|usbd_global_init_done
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|usbd_init
parameter_list|()
block|{
if|#
directive|if
name|defined
argument_list|(
name|__FreeBSD__
argument_list|)
name|dev_t
name|dev
decl_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|usbd_global_init_done
condition|)
block|{
name|usbd_global_init_done
operator|=
literal|1
expr_stmt|;
name|SIMPLEQ_INIT
argument_list|(
operator|&
name|usbd_free_requests
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|__FreeBSD__
argument_list|)
name|dev
operator|=
name|makedev
argument_list|(
name|USB_CDEV_MAJOR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|cdevsw_add
argument_list|(
operator|&
name|dev
argument_list|,
operator|&
name|usb_cdevsw
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|usbd_transfer_cb
parameter_list|(
name|reqh
parameter_list|)
name|usbd_request_handle
name|reqh
decl_stmt|;
block|{
name|usbd_pipe_handle
name|pipe
init|=
name|reqh
operator|->
name|pipe
decl_stmt|;
comment|/* Count completed transfers. */
operator|++
name|pipe
operator|->
name|device
operator|->
name|bus
operator|->
name|stats
operator|.
name|requests
index|[
name|pipe
operator|->
name|endpoint
operator|->
name|edesc
operator|->
name|bmAttributes
operator|&
name|UE_XFERTYPE
index|]
expr_stmt|;
comment|/* XXX check retry count */
name|reqh
operator|->
name|done
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|reqh
operator|->
name|status
operator|==
name|USBD_NORMAL_COMPLETION
operator|&&
name|reqh
operator|->
name|actlen
operator|<
name|reqh
operator|->
name|length
operator|&&
operator|!
operator|(
name|reqh
operator|->
name|flags
operator|&
name|USBD_SHORT_XFER_OK
operator|)
condition|)
block|{
name|DPRINTFN
argument_list|(
operator|-
literal|1
argument_list|,
operator|(
literal|"usbd_transfer_cb: short xfer %d<%d (bytes)\n"
operator|,
name|reqh
operator|->
name|actlen
operator|,
name|reqh
operator|->
name|length
operator|)
argument_list|)
expr_stmt|;
name|reqh
operator|->
name|status
operator|=
name|USBD_SHORT_XFER
expr_stmt|;
block|}
if|if
condition|(
name|reqh
operator|->
name|callback
condition|)
name|reqh
operator|->
name|callback
argument_list|(
name|reqh
argument_list|,
name|reqh
operator|->
name|priv
argument_list|,
name|reqh
operator|->
name|status
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|usbd_sync_transfer_cb
parameter_list|(
name|reqh
parameter_list|)
name|usbd_request_handle
name|reqh
decl_stmt|;
block|{
name|usbd_transfer_cb
argument_list|(
name|reqh
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|reqh
operator|->
name|pipe
operator|->
name|device
operator|->
name|bus
operator|->
name|use_polling
condition|)
name|wakeup
argument_list|(
name|reqh
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Like usbd_transfer(), but waits for completion. */
end_comment

begin_function
name|usbd_status
name|usbd_sync_transfer
parameter_list|(
name|reqh
parameter_list|)
name|usbd_request_handle
name|reqh
decl_stmt|;
block|{
name|usbd_status
name|r
decl_stmt|;
name|int
name|s
decl_stmt|;
name|reqh
operator|->
name|xfercb
operator|=
name|usbd_sync_transfer_cb
expr_stmt|;
name|r
operator|=
name|usbd_do_transfer
argument_list|(
name|reqh
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|!=
name|USBD_IN_PROGRESS
condition|)
return|return
operator|(
name|r
operator|)
return|;
name|s
operator|=
name|splusb
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|reqh
operator|->
name|done
condition|)
block|{
if|if
condition|(
name|reqh
operator|->
name|pipe
operator|->
name|device
operator|->
name|bus
operator|->
name|use_polling
condition|)
name|panic
argument_list|(
literal|"usbd_sync_transfer: not done\n"
argument_list|)
expr_stmt|;
name|tsleep
argument_list|(
name|reqh
argument_list|,
name|PRIBIO
argument_list|,
literal|"usbsyn"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
operator|(
name|reqh
operator|->
name|status
operator|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|usbd_do_request
parameter_list|(
name|dev
parameter_list|,
name|req
parameter_list|,
name|data
parameter_list|)
name|usbd_device_handle
name|dev
decl_stmt|;
name|usb_device_request_t
modifier|*
name|req
decl_stmt|;
name|void
modifier|*
name|data
decl_stmt|;
block|{
return|return
operator|(
name|usbd_do_request_flags
argument_list|(
name|dev
argument_list|,
name|req
argument_list|,
name|data
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|usbd_status
name|usbd_do_request_flags
parameter_list|(
name|dev
parameter_list|,
name|req
parameter_list|,
name|data
parameter_list|,
name|flags
parameter_list|,
name|actlen
parameter_list|)
name|usbd_device_handle
name|dev
decl_stmt|;
name|usb_device_request_t
modifier|*
name|req
decl_stmt|;
name|void
modifier|*
name|data
decl_stmt|;
name|u_int16_t
name|flags
decl_stmt|;
name|int
modifier|*
name|actlen
decl_stmt|;
block|{
name|usbd_request_handle
name|reqh
decl_stmt|;
name|usbd_status
name|r
decl_stmt|;
ifdef|#
directive|ifdef
name|DIAGNOSTIC
if|if
condition|(
operator|!
name|curproc
condition|)
block|{
name|printf
argument_list|(
literal|"usbd_do_request: not in process context\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|USBD_XXX
operator|)
return|;
block|}
endif|#
directive|endif
name|reqh
operator|=
name|usbd_alloc_request
argument_list|()
expr_stmt|;
if|if
condition|(
name|reqh
operator|==
literal|0
condition|)
return|return
operator|(
name|USBD_NOMEM
operator|)
return|;
name|r
operator|=
name|usbd_setup_default_request
argument_list|(
name|reqh
argument_list|,
name|dev
argument_list|,
literal|0
argument_list|,
name|USBD_DEFAULT_TIMEOUT
argument_list|,
name|req
argument_list|,
name|data
argument_list|,
name|UGETW
argument_list|(
name|req
operator|->
name|wLength
argument_list|)
argument_list|,
name|flags
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|!=
name|USBD_NORMAL_COMPLETION
condition|)
goto|goto
name|bad
goto|;
name|r
operator|=
name|usbd_sync_transfer
argument_list|(
name|reqh
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|USB_DEBUG
argument_list|)
operator|||
name|defined
argument_list|(
name|DIAGNOSTIC
argument_list|)
if|if
condition|(
name|reqh
operator|->
name|actlen
operator|>
name|reqh
operator|->
name|length
condition|)
name|printf
argument_list|(
literal|"usbd_do_request: overrun addr=%d type=0x%02x req=0x"
literal|"%02x val=%d index=%d rlen=%d length=%d actlen=%d\n"
argument_list|,
name|dev
operator|->
name|address
argument_list|,
name|reqh
operator|->
name|request
operator|.
name|bmRequestType
argument_list|,
name|reqh
operator|->
name|request
operator|.
name|bRequest
argument_list|,
name|UGETW
argument_list|(
name|reqh
operator|->
name|request
operator|.
name|wValue
argument_list|)
argument_list|,
name|UGETW
argument_list|(
name|reqh
operator|->
name|request
operator|.
name|wIndex
argument_list|)
argument_list|,
name|UGETW
argument_list|(
name|reqh
operator|->
name|request
operator|.
name|wLength
argument_list|)
argument_list|,
name|reqh
operator|->
name|length
argument_list|,
name|reqh
operator|->
name|actlen
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|actlen
condition|)
operator|*
name|actlen
operator|=
name|reqh
operator|->
name|actlen
expr_stmt|;
if|if
condition|(
name|r
operator|==
name|USBD_STALLED
condition|)
block|{
comment|/*  		 * The control endpoint has stalled.  Control endpoints 		 * should not halt, but some may do so anyway so clear 		 * any halt condition. 		 */
name|usb_device_request_t
name|treq
decl_stmt|;
name|usb_status_t
name|status
decl_stmt|;
name|u_int16_t
name|s
decl_stmt|;
name|usbd_status
name|nr
decl_stmt|;
name|treq
operator|.
name|bmRequestType
operator|=
name|UT_READ_ENDPOINT
expr_stmt|;
name|treq
operator|.
name|bRequest
operator|=
name|UR_GET_STATUS
expr_stmt|;
name|USETW
argument_list|(
name|treq
operator|.
name|wValue
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|treq
operator|.
name|wIndex
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|treq
operator|.
name|wLength
argument_list|,
sizeof|sizeof
argument_list|(
name|usb_status_t
argument_list|)
argument_list|)
expr_stmt|;
name|nr
operator|=
name|usbd_setup_default_request
argument_list|(
name|reqh
argument_list|,
name|dev
argument_list|,
literal|0
argument_list|,
name|USBD_DEFAULT_TIMEOUT
argument_list|,
operator|&
name|treq
argument_list|,
operator|&
name|status
argument_list|,
sizeof|sizeof
argument_list|(
name|usb_status_t
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|nr
operator|!=
name|USBD_NORMAL_COMPLETION
condition|)
goto|goto
name|bad
goto|;
name|nr
operator|=
name|usbd_sync_transfer
argument_list|(
name|reqh
argument_list|)
expr_stmt|;
if|if
condition|(
name|nr
operator|!=
name|USBD_NORMAL_COMPLETION
condition|)
goto|goto
name|bad
goto|;
name|s
operator|=
name|UGETW
argument_list|(
name|status
operator|.
name|wStatus
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"usbd_do_request: status = 0x%04x\n"
operator|,
name|s
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|s
operator|&
name|UES_HALT
operator|)
condition|)
goto|goto
name|bad
goto|;
name|treq
operator|.
name|bmRequestType
operator|=
name|UT_WRITE_ENDPOINT
expr_stmt|;
name|treq
operator|.
name|bRequest
operator|=
name|UR_CLEAR_FEATURE
expr_stmt|;
name|USETW
argument_list|(
name|treq
operator|.
name|wValue
argument_list|,
name|UF_ENDPOINT_HALT
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|treq
operator|.
name|wIndex
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|treq
operator|.
name|wLength
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|nr
operator|=
name|usbd_setup_default_request
argument_list|(
name|reqh
argument_list|,
name|dev
argument_list|,
literal|0
argument_list|,
name|USBD_DEFAULT_TIMEOUT
argument_list|,
operator|&
name|treq
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|nr
operator|!=
name|USBD_NORMAL_COMPLETION
condition|)
goto|goto
name|bad
goto|;
name|nr
operator|=
name|usbd_sync_transfer
argument_list|(
name|reqh
argument_list|)
expr_stmt|;
if|if
condition|(
name|nr
operator|!=
name|USBD_NORMAL_COMPLETION
condition|)
goto|goto
name|bad
goto|;
block|}
name|bad
label|:
name|usbd_free_request
argument_list|(
name|reqh
argument_list|)
expr_stmt|;
return|return
operator|(
name|r
operator|)
return|;
block|}
end_function

begin_function
name|void
name|usbd_do_request_async_cb
parameter_list|(
name|reqh
parameter_list|,
name|priv
parameter_list|,
name|status
parameter_list|)
name|usbd_request_handle
name|reqh
decl_stmt|;
name|usbd_private_handle
name|priv
decl_stmt|;
name|usbd_status
name|status
decl_stmt|;
block|{
if|#
directive|if
name|defined
argument_list|(
name|USB_DEBUG
argument_list|)
operator|||
name|defined
argument_list|(
name|DIAGNOSTIC
argument_list|)
if|if
condition|(
name|reqh
operator|->
name|actlen
operator|>
name|reqh
operator|->
name|length
condition|)
name|printf
argument_list|(
literal|"usbd_do_request: overrun addr=%d type=0x%02x req=0x"
literal|"%02x val=%d index=%d rlen=%d length=%d actlen=%d\n"
argument_list|,
name|reqh
operator|->
name|pipe
operator|->
name|device
operator|->
name|address
argument_list|,
name|reqh
operator|->
name|request
operator|.
name|bmRequestType
argument_list|,
name|reqh
operator|->
name|request
operator|.
name|bRequest
argument_list|,
name|UGETW
argument_list|(
name|reqh
operator|->
name|request
operator|.
name|wValue
argument_list|)
argument_list|,
name|UGETW
argument_list|(
name|reqh
operator|->
name|request
operator|.
name|wIndex
argument_list|)
argument_list|,
name|UGETW
argument_list|(
name|reqh
operator|->
name|request
operator|.
name|wLength
argument_list|)
argument_list|,
name|reqh
operator|->
name|length
argument_list|,
name|reqh
operator|->
name|actlen
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|usbd_free_request
argument_list|(
name|reqh
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Execute a request without waiting for completion.  * Can be used from interrupt context.  */
end_comment

begin_function
name|usbd_status
name|usbd_do_request_async
parameter_list|(
name|dev
parameter_list|,
name|req
parameter_list|,
name|data
parameter_list|)
name|usbd_device_handle
name|dev
decl_stmt|;
name|usb_device_request_t
modifier|*
name|req
decl_stmt|;
name|void
modifier|*
name|data
decl_stmt|;
block|{
name|usbd_request_handle
name|reqh
decl_stmt|;
name|usbd_status
name|r
decl_stmt|;
name|reqh
operator|=
name|usbd_alloc_request
argument_list|()
expr_stmt|;
if|if
condition|(
name|reqh
operator|==
literal|0
condition|)
return|return
operator|(
name|USBD_NOMEM
operator|)
return|;
name|r
operator|=
name|usbd_setup_default_request
argument_list|(
name|reqh
argument_list|,
name|dev
argument_list|,
literal|0
argument_list|,
name|USBD_DEFAULT_TIMEOUT
argument_list|,
name|req
argument_list|,
name|data
argument_list|,
name|UGETW
argument_list|(
name|req
operator|->
name|wLength
argument_list|)
argument_list|,
literal|0
argument_list|,
name|usbd_do_request_async_cb
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|!=
name|USBD_NORMAL_COMPLETION
condition|)
block|{
name|usbd_free_request
argument_list|(
name|reqh
argument_list|)
expr_stmt|;
return|return
operator|(
name|r
operator|)
return|;
block|}
name|r
operator|=
name|usbd_transfer
argument_list|(
name|reqh
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|!=
name|USBD_IN_PROGRESS
condition|)
return|return
operator|(
name|r
operator|)
return|;
return|return
operator|(
name|USBD_NORMAL_COMPLETION
operator|)
return|;
block|}
end_function

begin_function
name|struct
name|usbd_quirks
modifier|*
name|usbd_get_quirks
parameter_list|(
name|dev
parameter_list|)
name|usbd_device_handle
name|dev
decl_stmt|;
block|{
return|return
operator|(
name|dev
operator|->
name|quirks
operator|)
return|;
block|}
end_function

begin_function_decl
name|void
name|usbd_set_disco
parameter_list|(
name|p
parameter_list|,
name|hdl
parameter_list|,
name|data
parameter_list|)
name|usbd_pipe_handle
name|p
decl_stmt|;
function_decl|void
parameter_list|(
function_decl|*hdl
end_function_decl

begin_expr_stmt
unit|)
name|__P
argument_list|(
operator|(
name|void
operator|*
operator|)
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|void
modifier|*
name|data
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|p
operator|->
name|disco
operator|=
name|hdl
expr_stmt|;
name|p
operator|->
name|discoarg
operator|=
name|data
expr_stmt|;
block|}
end_block

begin_comment
comment|/* XXX do periodic free() of free list */
end_comment

begin_comment
comment|/*  * Called from keyboard driver when in polling mode.  */
end_comment

begin_function
name|void
name|usbd_dopoll
parameter_list|(
name|iface
parameter_list|)
name|usbd_interface_handle
name|iface
decl_stmt|;
block|{
name|iface
operator|->
name|device
operator|->
name|bus
operator|->
name|do_poll
argument_list|(
name|iface
operator|->
name|device
operator|->
name|bus
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|usbd_set_polling
parameter_list|(
name|iface
parameter_list|,
name|on
parameter_list|)
name|usbd_interface_handle
name|iface
decl_stmt|;
name|int
name|on
decl_stmt|;
block|{
name|iface
operator|->
name|device
operator|->
name|bus
operator|->
name|use_polling
operator|=
name|on
expr_stmt|;
block|}
end_function

begin_function
name|usb_endpoint_descriptor_t
modifier|*
name|usbd_get_endpoint_descriptor
parameter_list|(
name|iface
parameter_list|,
name|address
parameter_list|)
name|usbd_interface_handle
name|iface
decl_stmt|;
name|u_int8_t
name|address
decl_stmt|;
block|{
name|struct
name|usbd_endpoint
modifier|*
name|ep
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|iface
operator|->
name|idesc
operator|->
name|bNumEndpoints
condition|;
name|i
operator|++
control|)
block|{
name|ep
operator|=
operator|&
name|iface
operator|->
name|endpoints
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|ep
operator|->
name|edesc
operator|->
name|bEndpointAddress
operator|==
name|address
condition|)
return|return
operator|(
name|iface
operator|->
name|endpoints
index|[
name|i
index|]
operator|.
name|edesc
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__FreeBSD__
argument_list|)
end_if

begin_function
name|void
name|usbd_print_child
parameter_list|(
name|device_t
name|parent
parameter_list|,
name|device_t
name|child
parameter_list|)
block|{
comment|/* 	struct usb_softc *sc = device_get_softc(child); 	*/
name|printf
argument_list|(
literal|" at %s%d"
argument_list|,
name|device_get_name
argument_list|(
name|parent
argument_list|)
argument_list|,
name|device_get_unit
argument_list|(
name|parent
argument_list|)
argument_list|)
expr_stmt|;
comment|/* XXX How do we get to the usbd_device_handle??? 	usbd_device_handle dev = invalidadosch;  	printf(" addr %d", dev->addr);  	if (bootverbose) { 		if (dev->lowspeed) 			printf(", lowspeed"); 		if (dev->self_powered) 			printf(", self powered"); 		else 			printf(", %dmA", dev->power); 		printf(", config %d", dev->config); 	} 	 */
block|}
end_function

begin_comment
comment|/* Reconfigure all the USB busses in the system. */
end_comment

begin_function
name|int
name|usbd_driver_load
parameter_list|(
name|module_t
name|mod
parameter_list|,
name|int
name|what
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|devclass_t
name|usb_devclass
init|=
name|devclass_find
argument_list|(
literal|"usb"
argument_list|)
decl_stmt|;
name|devclass_t
name|ugen_devclass
init|=
name|devclass_find
argument_list|(
literal|"ugen"
argument_list|)
decl_stmt|;
name|device_t
modifier|*
name|devlist
decl_stmt|;
name|int
name|devcount
decl_stmt|;
name|int
name|error
decl_stmt|;
switch|switch
condition|(
name|what
condition|)
block|{
case|case
name|MOD_LOAD
case|:
case|case
name|MOD_UNLOAD
case|:
if|if
condition|(
operator|!
name|usb_devclass
condition|)
return|return
literal|0
return|;
comment|/* just ignore call */
if|if
condition|(
name|ugen_devclass
condition|)
block|{
comment|/* detach devices from generic driver if possible */
name|error
operator|=
name|devclass_get_devices
argument_list|(
name|ugen_devclass
argument_list|,
operator|&
name|devlist
argument_list|,
operator|&
name|devcount
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
for|for
control|(
name|devcount
operator|--
init|;
name|devcount
operator|>=
literal|0
condition|;
name|devcount
operator|--
control|)
operator|(
name|void
operator|)
name|DEVICE_DETACH
argument_list|(
name|devlist
index|[
name|devcount
index|]
argument_list|)
expr_stmt|;
block|}
name|error
operator|=
name|devclass_get_devices
argument_list|(
name|usb_devclass
argument_list|,
operator|&
name|devlist
argument_list|,
operator|&
name|devcount
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
literal|0
return|;
comment|/* XXX maybe transient, or error? */
for|for
control|(
name|devcount
operator|--
init|;
name|devcount
operator|>=
literal|0
condition|;
name|devcount
operator|--
control|)
name|USB_RECONFIGURE
argument_list|(
name|devlist
index|[
name|devcount
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|devlist
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
literal|0
return|;
comment|/* nothing to do by us */
block|}
end_function

begin_comment
comment|/* Set the description of the device including a malloc and copy. */
end_comment

begin_function
name|void
name|usbd_device_set_desc
parameter_list|(
name|device_t
name|device
parameter_list|,
name|char
modifier|*
name|devinfo
parameter_list|)
block|{
name|size_t
name|l
decl_stmt|;
name|char
modifier|*
name|desc
decl_stmt|;
if|if
condition|(
name|devinfo
condition|)
block|{
name|l
operator|=
name|strlen
argument_list|(
name|devinfo
argument_list|)
expr_stmt|;
name|desc
operator|=
name|malloc
argument_list|(
name|l
operator|+
literal|1
argument_list|,
name|M_USB
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|desc
condition|)
name|memcpy
argument_list|(
name|desc
argument_list|,
name|devinfo
argument_list|,
name|l
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
name|desc
operator|=
name|NULL
expr_stmt|;
name|device_set_desc
argument_list|(
name|device
argument_list|,
name|desc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|char
modifier|*
name|usbd_devname
parameter_list|(
name|bdevice
modifier|*
name|bdev
parameter_list|)
block|{
specifier|static
name|char
name|buf
index|[
literal|20
index|]
decl_stmt|;
comment|/* XXX a static buffer is not exactly a good idea, but the only 	 * thing that goes wrong is the string that is being printed 	 */
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%s%d"
argument_list|,
name|device_get_name
argument_list|(
operator|*
name|bdev
argument_list|)
argument_list|,
name|device_get_unit
argument_list|(
operator|*
name|bdev
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|buf
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

end_unit


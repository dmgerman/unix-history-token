begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2008,2010 Damien Bergamini<damien.bergamini@free.fr>  * ported to FreeBSD by Akinori Furukoshi<moonlightakkiy@yahoo.ca>  * USB Consulting, Hans Petter Selasky<hselasky@freebsd.org>  *  * Permission to use, copy, modify, and distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES  * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF  * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR  * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES  * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN  * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF  * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*-  * Ralink Technology RT2700U/RT2800U/RT3000U chipset driver.  * http://www.ralinktech.com/  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|<sys/linker.h>
end_include

begin_include
include|#
directive|include
file|<sys/firmware.h>
end_include

begin_include
include|#
directive|include
file|<sys/kdb.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<net/bpf.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_arp.h>
end_include

begin_include
include|#
directive|include
file|<net/ethernet.h>
end_include

begin_include
include|#
directive|include
file|<net/if_dl.h>
end_include

begin_include
include|#
directive|include
file|<net/if_media.h>
end_include

begin_include
include|#
directive|include
file|<net/if_types.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_systm.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_var.h>
end_include

begin_include
include|#
directive|include
file|<netinet/if_ether.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_var.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_regdomain.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_radiotap.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_ratectl.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usbdi.h>
end_include

begin_include
include|#
directive|include
file|"usbdevs.h"
end_include

begin_define
define|#
directive|define
name|USB_DEBUG_VAR
value|run_debug
end_define

begin_include
include|#
directive|include
file|<dev/usb/usb_debug.h>
end_include

begin_include
include|#
directive|include
file|"if_runreg.h"
end_include

begin_include
include|#
directive|include
file|"if_runvar.h"
end_include

begin_define
define|#
directive|define
name|nitems
parameter_list|(
name|_a
parameter_list|)
value|(sizeof((_a)) / sizeof((_a)[0]))
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|USB_DEBUG
end_ifdef

begin_define
define|#
directive|define
name|RUN_DEBUG
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|RUN_DEBUG
end_ifdef

begin_decl_stmt
name|int
name|run_debug
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|SYSCTL_NODE
argument_list|(
name|_hw_usb
argument_list|,
name|OID_AUTO
argument_list|,
name|run
argument_list|,
name|CTLFLAG_RW
argument_list|,
literal|0
argument_list|,
literal|"USB run"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_hw_usb_run
argument_list|,
name|OID_AUTO
argument_list|,
name|debug
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|run_debug
argument_list|,
literal|0
argument_list|,
literal|"run debug level"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|IEEE80211_HAS_ADDR4
parameter_list|(
name|wh
parameter_list|)
define|\
value|(((wh)->i_fc[1]& IEEE80211_FC1_DIR_MASK) == IEEE80211_FC1_DIR_DSTODS)
end_define

begin_comment
comment|/*  * Because of LOR in run_key_delete(), use atomic instead.  * '& RUN_CMDQ_MASQ' is to loop cmdq[].  */
end_comment

begin_define
define|#
directive|define
name|RUN_CMDQ_GET
parameter_list|(
name|c
parameter_list|)
value|(atomic_fetchadd_32((c), 1)& RUN_CMDQ_MASQ)
end_define

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|usb_device_id
name|run_devs
index|[]
init|=
block|{
define|#
directive|define
name|RUN_DEV
parameter_list|(
name|v
parameter_list|,
name|p
parameter_list|)
value|{ USB_VP(USB_VENDOR_##v, USB_PRODUCT_##v##_##p) }
name|RUN_DEV
argument_list|(
name|ABOCOM
argument_list|,
name|RT2770
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|ABOCOM
argument_list|,
name|RT2870
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|ABOCOM
argument_list|,
name|RT3070
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|ABOCOM
argument_list|,
name|RT3071
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|ABOCOM
argument_list|,
name|RT3072
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|ABOCOM2
argument_list|,
name|RT2870_1
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|ACCTON
argument_list|,
name|RT2770
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|ACCTON
argument_list|,
name|RT2870_1
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|ACCTON
argument_list|,
name|RT2870_2
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|ACCTON
argument_list|,
name|RT2870_3
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|ACCTON
argument_list|,
name|RT2870_4
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|ACCTON
argument_list|,
name|RT2870_5
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|ACCTON
argument_list|,
name|RT3070
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|ACCTON
argument_list|,
name|RT3070_1
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|ACCTON
argument_list|,
name|RT3070_2
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|ACCTON
argument_list|,
name|RT3070_3
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|ACCTON
argument_list|,
name|RT3070_4
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|ACCTON
argument_list|,
name|RT3070_5
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|AIRTIES
argument_list|,
name|RT3070
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|ALLWIN
argument_list|,
name|RT2070
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|ALLWIN
argument_list|,
name|RT2770
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|ALLWIN
argument_list|,
name|RT2870
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|ALLWIN
argument_list|,
name|RT3070
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|ALLWIN
argument_list|,
name|RT3071
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|ALLWIN
argument_list|,
name|RT3072
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|ALLWIN
argument_list|,
name|RT3572
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|AMIGO
argument_list|,
name|RT2870_1
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|AMIGO
argument_list|,
name|RT2870_2
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|AMIT
argument_list|,
name|CGWLUSB2GNR
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|AMIT
argument_list|,
name|RT2870_1
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|AMIT2
argument_list|,
name|RT2870
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|ASUS
argument_list|,
name|RT2870_1
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|ASUS
argument_list|,
name|RT2870_2
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|ASUS
argument_list|,
name|RT2870_3
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|ASUS
argument_list|,
name|RT2870_4
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|ASUS
argument_list|,
name|RT2870_5
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|ASUS
argument_list|,
name|USBN13
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|ASUS
argument_list|,
name|RT3070_1
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|ASUS2
argument_list|,
name|USBN11
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|AZUREWAVE
argument_list|,
name|RT2870_1
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|AZUREWAVE
argument_list|,
name|RT2870_2
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|AZUREWAVE
argument_list|,
name|RT3070_1
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|AZUREWAVE
argument_list|,
name|RT3070_2
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|AZUREWAVE
argument_list|,
name|RT3070_3
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|BELKIN
argument_list|,
name|F5D8053V3
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|BELKIN
argument_list|,
name|F5D8055
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|BELKIN
argument_list|,
name|F6D4050V1
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|BELKIN
argument_list|,
name|RT2870_1
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|BELKIN
argument_list|,
name|RT2870_2
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|CISCOLINKSYS2
argument_list|,
name|RT3070
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|CISCOLINKSYS3
argument_list|,
name|RT3070
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|CONCEPTRONIC2
argument_list|,
name|RT2870_1
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|CONCEPTRONIC2
argument_list|,
name|RT2870_2
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|CONCEPTRONIC2
argument_list|,
name|RT2870_3
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|CONCEPTRONIC2
argument_list|,
name|RT2870_4
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|CONCEPTRONIC2
argument_list|,
name|RT2870_5
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|CONCEPTRONIC2
argument_list|,
name|RT2870_6
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|CONCEPTRONIC2
argument_list|,
name|RT2870_7
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|CONCEPTRONIC2
argument_list|,
name|RT2870_8
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|CONCEPTRONIC2
argument_list|,
name|RT3070_1
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|CONCEPTRONIC2
argument_list|,
name|RT3070_2
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|CONCEPTRONIC2
argument_list|,
name|VIGORN61
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|COREGA
argument_list|,
name|CGWLUSB300GNM
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|COREGA
argument_list|,
name|RT2870_1
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|COREGA
argument_list|,
name|RT2870_2
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|COREGA
argument_list|,
name|RT2870_3
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|COREGA
argument_list|,
name|RT3070
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|CYBERTAN
argument_list|,
name|RT2870
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|DLINK
argument_list|,
name|RT2870
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|DLINK
argument_list|,
name|RT3072
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|DLINK2
argument_list|,
name|DWA130
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|DLINK2
argument_list|,
name|RT2870_1
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|DLINK2
argument_list|,
name|RT2870_2
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|DLINK2
argument_list|,
name|RT3070_1
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|DLINK2
argument_list|,
name|RT3070_2
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|DLINK2
argument_list|,
name|RT3070_3
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|DLINK2
argument_list|,
name|RT3070_4
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|DLINK2
argument_list|,
name|RT3070_5
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|DLINK2
argument_list|,
name|RT3072
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|DLINK2
argument_list|,
name|RT3072_1
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|EDIMAX
argument_list|,
name|EW7717
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|EDIMAX
argument_list|,
name|EW7718
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|EDIMAX
argument_list|,
name|RT2870_1
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|ENCORE
argument_list|,
name|RT3070_1
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|ENCORE
argument_list|,
name|RT3070_2
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|ENCORE
argument_list|,
name|RT3070_3
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|GIGABYTE
argument_list|,
name|GNWB31N
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|GIGABYTE
argument_list|,
name|GNWB32L
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|GIGABYTE
argument_list|,
name|RT2870_1
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|GIGASET
argument_list|,
name|RT3070_1
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|GIGASET
argument_list|,
name|RT3070_2
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|GUILLEMOT
argument_list|,
name|HWNU300
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|HAWKING
argument_list|,
name|HWUN2
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|HAWKING
argument_list|,
name|RT2870_1
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|HAWKING
argument_list|,
name|RT2870_2
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|HAWKING
argument_list|,
name|RT3070
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|IODATA
argument_list|,
name|RT3072_1
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|IODATA
argument_list|,
name|RT3072_2
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|IODATA
argument_list|,
name|RT3072_3
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|IODATA
argument_list|,
name|RT3072_4
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|LINKSYS4
argument_list|,
name|RT3070
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|LINKSYS4
argument_list|,
name|WUSB100
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|LINKSYS4
argument_list|,
name|WUSB54GCV3
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|LINKSYS4
argument_list|,
name|WUSB600N
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|LINKSYS4
argument_list|,
name|WUSB600NV2
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|LOGITEC
argument_list|,
name|RT2870_1
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|LOGITEC
argument_list|,
name|RT2870_2
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|LOGITEC
argument_list|,
name|RT2870_3
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|MELCO
argument_list|,
name|RT2870_1
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|MELCO
argument_list|,
name|RT2870_2
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|MELCO
argument_list|,
name|WLIUCAG300N
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|MELCO
argument_list|,
name|WLIUCG300N
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|MELCO
argument_list|,
name|WLIUCGN
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|MOTOROLA4
argument_list|,
name|RT2770
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|MOTOROLA4
argument_list|,
name|RT3070
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|MSI
argument_list|,
name|RT3070_1
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|MSI
argument_list|,
name|RT3070_2
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|MSI
argument_list|,
name|RT3070_3
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|MSI
argument_list|,
name|RT3070_4
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|MSI
argument_list|,
name|RT3070_5
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|MSI
argument_list|,
name|RT3070_6
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|MSI
argument_list|,
name|RT3070_7
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|MSI
argument_list|,
name|RT3070_8
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|MSI
argument_list|,
name|RT3070_9
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|MSI
argument_list|,
name|RT3070_10
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|MSI
argument_list|,
name|RT3070_11
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|OVISLINK
argument_list|,
name|RT3072
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|PARA
argument_list|,
name|RT3070
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|PEGATRON
argument_list|,
name|RT2870
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|PEGATRON
argument_list|,
name|RT3070
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|PEGATRON
argument_list|,
name|RT3070_2
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|PEGATRON
argument_list|,
name|RT3070_3
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|PHILIPS
argument_list|,
name|RT2870
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|PLANEX2
argument_list|,
name|GWUS300MINIS
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|PLANEX2
argument_list|,
name|GWUSMICRON
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|PLANEX2
argument_list|,
name|RT2870
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|PLANEX2
argument_list|,
name|RT3070
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|QCOM
argument_list|,
name|RT2870
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|QUANTA
argument_list|,
name|RT3070
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|RALINK
argument_list|,
name|RT2070
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|RALINK
argument_list|,
name|RT2770
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|RALINK
argument_list|,
name|RT2870
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|RALINK
argument_list|,
name|RT3070
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|RALINK
argument_list|,
name|RT3071
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|RALINK
argument_list|,
name|RT3072
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|RALINK
argument_list|,
name|RT3370
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|RALINK
argument_list|,
name|RT3572
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|RALINK
argument_list|,
name|RT8070
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|SAMSUNG2
argument_list|,
name|RT2870_1
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|SENAO
argument_list|,
name|RT2870_1
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|SENAO
argument_list|,
name|RT2870_2
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|SENAO
argument_list|,
name|RT2870_3
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|SENAO
argument_list|,
name|RT2870_4
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|SENAO
argument_list|,
name|RT3070
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|SENAO
argument_list|,
name|RT3071
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|SENAO
argument_list|,
name|RT3072_1
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|SENAO
argument_list|,
name|RT3072_2
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|SENAO
argument_list|,
name|RT3072_3
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|SENAO
argument_list|,
name|RT3072_4
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|SENAO
argument_list|,
name|RT3072_5
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|SITECOMEU
argument_list|,
name|RT2770
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|SITECOMEU
argument_list|,
name|RT2870_1
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|SITECOMEU
argument_list|,
name|RT2870_2
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|SITECOMEU
argument_list|,
name|RT2870_3
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|SITECOMEU
argument_list|,
name|RT2870_4
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|SITECOMEU
argument_list|,
name|RT3070
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|SITECOMEU
argument_list|,
name|RT3070_2
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|SITECOMEU
argument_list|,
name|RT3070_3
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|SITECOMEU
argument_list|,
name|RT3070_4
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|SITECOMEU
argument_list|,
name|RT3071
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|SITECOMEU
argument_list|,
name|RT3072_1
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|SITECOMEU
argument_list|,
name|RT3072_2
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|SITECOMEU
argument_list|,
name|RT3072_3
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|SITECOMEU
argument_list|,
name|RT3072_4
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|SITECOMEU
argument_list|,
name|RT3072_5
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|SITECOMEU
argument_list|,
name|RT3072_6
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|SITECOMEU
argument_list|,
name|WL608
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|SPARKLAN
argument_list|,
name|RT2870_1
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|SPARKLAN
argument_list|,
name|RT3070
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|SWEEX2
argument_list|,
name|LW153
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|SWEEX2
argument_list|,
name|LW303
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|SWEEX2
argument_list|,
name|LW313
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|TOSHIBA
argument_list|,
name|RT3070
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|UMEDIA
argument_list|,
name|RT2870_1
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|ZCOM
argument_list|,
name|RT2870_1
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|ZCOM
argument_list|,
name|RT2870_2
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|ZINWELL
argument_list|,
name|RT2870_1
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|ZINWELL
argument_list|,
name|RT2870_2
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|ZINWELL
argument_list|,
name|RT3070
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|ZINWELL
argument_list|,
name|RT3072_1
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|ZINWELL
argument_list|,
name|RT3072_2
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|ZYXEL
argument_list|,
name|RT2870_1
argument_list|)
block|,
name|RUN_DEV
argument_list|(
name|ZYXEL
argument_list|,
name|RT2870_2
argument_list|)
block|,
undef|#
directive|undef
name|RUN_DEV
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|device_probe_t
name|run_match
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|device_attach_t
name|run_attach
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|device_detach_t
name|run_detach
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|usb_callback_t
name|run_bulk_rx_callback
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|usb_callback_t
name|run_bulk_tx_callback0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|usb_callback_t
name|run_bulk_tx_callback1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|usb_callback_t
name|run_bulk_tx_callback2
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|usb_callback_t
name|run_bulk_tx_callback3
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|usb_callback_t
name|run_bulk_tx_callback4
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|usb_callback_t
name|run_bulk_tx_callback5
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|run_bulk_tx_callbackN
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|,
name|usb_error_t
name|error
parameter_list|,
name|unsigned
name|int
name|index
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|ieee80211vap
modifier|*
name|run_vap_create
parameter_list|(
name|struct
name|ieee80211com
modifier|*
parameter_list|,
specifier|const
name|char
name|name
index|[
name|IFNAMSIZ
index|]
parameter_list|,
name|int
name|unit
parameter_list|,
name|int
name|opmode
parameter_list|,
name|int
name|flags
parameter_list|,
specifier|const
name|uint8_t
name|bssid
index|[
name|IEEE80211_ADDR_LEN
index|]
parameter_list|,
specifier|const
name|uint8_t
name|mac
index|[
name|IEEE80211_ADDR_LEN
index|]
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run_vap_delete
parameter_list|(
name|struct
name|ieee80211vap
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run_cmdq_cb
parameter_list|(
name|void
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run_setup_tx_list
parameter_list|(
name|struct
name|run_softc
modifier|*
parameter_list|,
name|struct
name|run_endpoint_queue
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run_unsetup_tx_list
parameter_list|(
name|struct
name|run_softc
modifier|*
parameter_list|,
name|struct
name|run_endpoint_queue
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|run_load_microcode
parameter_list|(
name|struct
name|run_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|run_reset
parameter_list|(
name|struct
name|run_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usb_error_t
name|run_do_request
parameter_list|(
name|struct
name|run_softc
modifier|*
parameter_list|,
name|struct
name|usb_device_request
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|run_read
parameter_list|(
name|struct
name|run_softc
modifier|*
parameter_list|,
name|uint16_t
parameter_list|,
name|uint32_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|run_read_region_1
parameter_list|(
name|struct
name|run_softc
modifier|*
parameter_list|,
name|uint16_t
parameter_list|,
name|uint8_t
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|run_write_2
parameter_list|(
name|struct
name|run_softc
modifier|*
parameter_list|,
name|uint16_t
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|run_write
parameter_list|(
name|struct
name|run_softc
modifier|*
parameter_list|,
name|uint16_t
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|run_write_region_1
parameter_list|(
name|struct
name|run_softc
modifier|*
parameter_list|,
name|uint16_t
parameter_list|,
specifier|const
name|uint8_t
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|run_set_region_4
parameter_list|(
name|struct
name|run_softc
modifier|*
parameter_list|,
name|uint16_t
parameter_list|,
name|uint32_t
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|run_efuse_read_2
parameter_list|(
name|struct
name|run_softc
modifier|*
parameter_list|,
name|uint16_t
parameter_list|,
name|uint16_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|run_eeprom_read_2
parameter_list|(
name|struct
name|run_softc
modifier|*
parameter_list|,
name|uint16_t
parameter_list|,
name|uint16_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|run_rt2870_rf_write
parameter_list|(
name|struct
name|run_softc
modifier|*
parameter_list|,
name|uint8_t
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|run_rt3070_rf_read
parameter_list|(
name|struct
name|run_softc
modifier|*
parameter_list|,
name|uint8_t
parameter_list|,
name|uint8_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|run_rt3070_rf_write
parameter_list|(
name|struct
name|run_softc
modifier|*
parameter_list|,
name|uint8_t
parameter_list|,
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|run_bbp_read
parameter_list|(
name|struct
name|run_softc
modifier|*
parameter_list|,
name|uint8_t
parameter_list|,
name|uint8_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|run_bbp_write
parameter_list|(
name|struct
name|run_softc
modifier|*
parameter_list|,
name|uint8_t
parameter_list|,
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|run_mcu_cmd
parameter_list|(
name|struct
name|run_softc
modifier|*
parameter_list|,
name|uint8_t
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|const
name|char
modifier|*
name|run_get_rf
parameter_list|(
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|run_read_eeprom
parameter_list|(
name|struct
name|run_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|ieee80211_node
modifier|*
name|run_node_alloc
parameter_list|(
name|struct
name|ieee80211vap
modifier|*
parameter_list|,
specifier|const
name|uint8_t
name|mac
index|[
name|IEEE80211_ADDR_LEN
index|]
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|run_media_change
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|run_newstate
parameter_list|(
name|struct
name|ieee80211vap
modifier|*
parameter_list|,
name|enum
name|ieee80211_state
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|run_wme_update
parameter_list|(
name|struct
name|ieee80211com
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run_wme_update_cb
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run_key_update_begin
parameter_list|(
name|struct
name|ieee80211vap
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run_key_update_end
parameter_list|(
name|struct
name|ieee80211vap
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run_key_set_cb
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|run_key_set
parameter_list|(
name|struct
name|ieee80211vap
modifier|*
parameter_list|,
name|struct
name|ieee80211_key
modifier|*
parameter_list|,
specifier|const
name|uint8_t
name|mac
index|[
name|IEEE80211_ADDR_LEN
index|]
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run_key_delete_cb
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|run_key_delete
parameter_list|(
name|struct
name|ieee80211vap
modifier|*
parameter_list|,
name|struct
name|ieee80211_key
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run_ratectl_to
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run_ratectl_cb
parameter_list|(
name|void
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run_drain_fifo
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run_iter_func
parameter_list|(
name|void
modifier|*
parameter_list|,
name|struct
name|ieee80211_node
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run_newassoc_cb
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run_newassoc
parameter_list|(
name|struct
name|ieee80211_node
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run_rx_frame
parameter_list|(
name|struct
name|run_softc
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run_tx_free
parameter_list|(
name|struct
name|run_endpoint_queue
modifier|*
name|pq
parameter_list|,
name|struct
name|run_tx_data
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run_set_tx_desc
parameter_list|(
name|struct
name|run_softc
modifier|*
parameter_list|,
name|struct
name|run_tx_data
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|run_tx
parameter_list|(
name|struct
name|run_softc
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|,
name|struct
name|ieee80211_node
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|run_tx_mgt
parameter_list|(
name|struct
name|run_softc
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|,
name|struct
name|ieee80211_node
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|run_sendprot
parameter_list|(
name|struct
name|run_softc
modifier|*
parameter_list|,
specifier|const
name|struct
name|mbuf
modifier|*
parameter_list|,
name|struct
name|ieee80211_node
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|run_tx_param
parameter_list|(
name|struct
name|run_softc
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|,
name|struct
name|ieee80211_node
modifier|*
parameter_list|,
specifier|const
name|struct
name|ieee80211_bpf_params
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|run_raw_xmit
parameter_list|(
name|struct
name|ieee80211_node
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|,
specifier|const
name|struct
name|ieee80211_bpf_params
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run_start
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|run_ioctl
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|,
name|u_long
parameter_list|,
name|caddr_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run_set_agc
parameter_list|(
name|struct
name|run_softc
modifier|*
parameter_list|,
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run_select_chan_group
parameter_list|(
name|struct
name|run_softc
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run_set_rx_antenna
parameter_list|(
name|struct
name|run_softc
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run_rt2870_set_chan
parameter_list|(
name|struct
name|run_softc
modifier|*
parameter_list|,
name|u_int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run_rt3070_set_chan
parameter_list|(
name|struct
name|run_softc
modifier|*
parameter_list|,
name|u_int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run_rt3572_set_chan
parameter_list|(
name|struct
name|run_softc
modifier|*
parameter_list|,
name|u_int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|run_set_chan
parameter_list|(
name|struct
name|run_softc
modifier|*
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run_set_channel
parameter_list|(
name|struct
name|ieee80211com
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run_scan_start
parameter_list|(
name|struct
name|ieee80211com
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run_scan_end
parameter_list|(
name|struct
name|ieee80211com
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run_update_beacon
parameter_list|(
name|struct
name|ieee80211vap
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run_update_beacon_cb
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run_updateprot
parameter_list|(
name|struct
name|ieee80211com
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run_usb_timeout_cb
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run_reset_livelock
parameter_list|(
name|struct
name|run_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run_enable_tsf_sync
parameter_list|(
name|struct
name|run_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run_enable_mrr
parameter_list|(
name|struct
name|run_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run_set_txpreamble
parameter_list|(
name|struct
name|run_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run_set_basicrates
parameter_list|(
name|struct
name|run_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run_set_leds
parameter_list|(
name|struct
name|run_softc
modifier|*
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run_set_bssid
parameter_list|(
name|struct
name|run_softc
modifier|*
parameter_list|,
specifier|const
name|uint8_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run_set_macaddr
parameter_list|(
name|struct
name|run_softc
modifier|*
parameter_list|,
specifier|const
name|uint8_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run_updateslot
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run_update_mcast
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int8_t
name|run_rssi2dbm
parameter_list|(
name|struct
name|run_softc
modifier|*
parameter_list|,
name|uint8_t
parameter_list|,
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run_update_promisc_locked
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run_update_promisc
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|run_bbp_init
parameter_list|(
name|struct
name|run_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|run_rt3070_rf_init
parameter_list|(
name|struct
name|run_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|run_rt3070_filter_calib
parameter_list|(
name|struct
name|run_softc
modifier|*
parameter_list|,
name|uint8_t
parameter_list|,
name|uint8_t
parameter_list|,
name|uint8_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run_rt3070_rf_setup
parameter_list|(
name|struct
name|run_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|run_txrx_enable
parameter_list|(
name|struct
name|run_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run_init
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run_init_locked
parameter_list|(
name|struct
name|run_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run_stop
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|run_delay
parameter_list|(
name|struct
name|run_softc
modifier|*
parameter_list|,
name|unsigned
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_struct
specifier|static
specifier|const
struct|struct
block|{
name|uint16_t
name|reg
decl_stmt|;
name|uint32_t
name|val
decl_stmt|;
block|}
name|rt2870_def_mac
index|[]
init|=
block|{
name|RT2870_DEF_MAC
block|}
struct|;
end_struct

begin_struct
specifier|static
specifier|const
struct|struct
block|{
name|uint8_t
name|reg
decl_stmt|;
name|uint8_t
name|val
decl_stmt|;
block|}
name|rt2860_def_bbp
index|[]
init|=
block|{
name|RT2860_DEF_BBP
block|}
struct|;
end_struct

begin_struct
specifier|static
specifier|const
struct|struct
name|rfprog
block|{
name|uint8_t
name|chan
decl_stmt|;
name|uint32_t
name|r1
decl_stmt|,
name|r2
decl_stmt|,
name|r3
decl_stmt|,
name|r4
decl_stmt|;
block|}
name|rt2860_rf2850
index|[]
init|=
block|{
name|RT2860_RF2850
block|}
struct|;
end_struct

begin_struct
struct|struct
block|{
name|uint8_t
name|n
decl_stmt|,
name|r
decl_stmt|,
name|k
decl_stmt|;
block|}
name|rt3070_freqs
index|[]
init|=
block|{
name|RT3070_RF3052
block|}
struct|;
end_struct

begin_struct
specifier|static
specifier|const
struct|struct
block|{
name|uint8_t
name|reg
decl_stmt|;
name|uint8_t
name|val
decl_stmt|;
block|}
name|rt3070_def_rf
index|[]
init|=
block|{
name|RT3070_DEF_RF
block|}
struct|,
name|rt3572_def_rf
index|[]
init|=
block|{
name|RT3572_DEF_RF
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|usb_config
name|run_config
index|[
name|RUN_N_XFER
index|]
init|=
block|{
index|[
name|RUN_BULK_TX_BE
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|UE_BULK
block|,
operator|.
name|endpoint
operator|=
name|UE_ADDR_ANY
block|,
operator|.
name|ep_index
operator|=
literal|0
block|,
operator|.
name|direction
operator|=
name|UE_DIR_OUT
block|,
operator|.
name|bufsize
operator|=
name|RUN_MAX_TXSZ
block|,
operator|.
name|flags
operator|=
block|{
operator|.
name|pipe_bof
operator|=
literal|1
block|,
operator|.
name|force_short_xfer
operator|=
literal|1
block|,}
block|,
operator|.
name|callback
operator|=
name|run_bulk_tx_callback0
block|,
operator|.
name|timeout
operator|=
literal|5000
block|,
comment|/* ms */
block|}
block|,
index|[
name|RUN_BULK_TX_BK
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|UE_BULK
block|,
operator|.
name|endpoint
operator|=
name|UE_ADDR_ANY
block|,
operator|.
name|direction
operator|=
name|UE_DIR_OUT
block|,
operator|.
name|ep_index
operator|=
literal|1
block|,
operator|.
name|bufsize
operator|=
name|RUN_MAX_TXSZ
block|,
operator|.
name|flags
operator|=
block|{
operator|.
name|pipe_bof
operator|=
literal|1
block|,
operator|.
name|force_short_xfer
operator|=
literal|1
block|,}
block|,
operator|.
name|callback
operator|=
name|run_bulk_tx_callback1
block|,
operator|.
name|timeout
operator|=
literal|5000
block|,
comment|/* ms */
block|}
block|,
index|[
name|RUN_BULK_TX_VI
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|UE_BULK
block|,
operator|.
name|endpoint
operator|=
name|UE_ADDR_ANY
block|,
operator|.
name|direction
operator|=
name|UE_DIR_OUT
block|,
operator|.
name|ep_index
operator|=
literal|2
block|,
operator|.
name|bufsize
operator|=
name|RUN_MAX_TXSZ
block|,
operator|.
name|flags
operator|=
block|{
operator|.
name|pipe_bof
operator|=
literal|1
block|,
operator|.
name|force_short_xfer
operator|=
literal|1
block|,}
block|,
operator|.
name|callback
operator|=
name|run_bulk_tx_callback2
block|,
operator|.
name|timeout
operator|=
literal|5000
block|,
comment|/* ms */
block|}
block|,
index|[
name|RUN_BULK_TX_VO
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|UE_BULK
block|,
operator|.
name|endpoint
operator|=
name|UE_ADDR_ANY
block|,
operator|.
name|direction
operator|=
name|UE_DIR_OUT
block|,
operator|.
name|ep_index
operator|=
literal|3
block|,
operator|.
name|bufsize
operator|=
name|RUN_MAX_TXSZ
block|,
operator|.
name|flags
operator|=
block|{
operator|.
name|pipe_bof
operator|=
literal|1
block|,
operator|.
name|force_short_xfer
operator|=
literal|1
block|,}
block|,
operator|.
name|callback
operator|=
name|run_bulk_tx_callback3
block|,
operator|.
name|timeout
operator|=
literal|5000
block|,
comment|/* ms */
block|}
block|,
index|[
name|RUN_BULK_TX_HCCA
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|UE_BULK
block|,
operator|.
name|endpoint
operator|=
name|UE_ADDR_ANY
block|,
operator|.
name|direction
operator|=
name|UE_DIR_OUT
block|,
operator|.
name|ep_index
operator|=
literal|4
block|,
operator|.
name|bufsize
operator|=
name|RUN_MAX_TXSZ
block|,
operator|.
name|flags
operator|=
block|{
operator|.
name|pipe_bof
operator|=
literal|1
block|,
operator|.
name|force_short_xfer
operator|=
literal|1
block|,
operator|.
name|no_pipe_ok
operator|=
literal|1
block|,}
block|,
operator|.
name|callback
operator|=
name|run_bulk_tx_callback4
block|,
operator|.
name|timeout
operator|=
literal|5000
block|,
comment|/* ms */
block|}
block|,
index|[
name|RUN_BULK_TX_PRIO
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|UE_BULK
block|,
operator|.
name|endpoint
operator|=
name|UE_ADDR_ANY
block|,
operator|.
name|direction
operator|=
name|UE_DIR_OUT
block|,
operator|.
name|ep_index
operator|=
literal|5
block|,
operator|.
name|bufsize
operator|=
name|RUN_MAX_TXSZ
block|,
operator|.
name|flags
operator|=
block|{
operator|.
name|pipe_bof
operator|=
literal|1
block|,
operator|.
name|force_short_xfer
operator|=
literal|1
block|,
operator|.
name|no_pipe_ok
operator|=
literal|1
block|,}
block|,
operator|.
name|callback
operator|=
name|run_bulk_tx_callback5
block|,
operator|.
name|timeout
operator|=
literal|5000
block|,
comment|/* ms */
block|}
block|,
index|[
name|RUN_BULK_RX
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|UE_BULK
block|,
operator|.
name|endpoint
operator|=
name|UE_ADDR_ANY
block|,
operator|.
name|direction
operator|=
name|UE_DIR_IN
block|,
operator|.
name|bufsize
operator|=
name|RUN_MAX_RXSZ
block|,
operator|.
name|flags
operator|=
block|{
operator|.
name|pipe_bof
operator|=
literal|1
block|,
operator|.
name|short_xfer_ok
operator|=
literal|1
block|,}
block|,
operator|.
name|callback
operator|=
name|run_bulk_rx_callback
block|,     }
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|run_match
parameter_list|(
name|device_t
name|self
parameter_list|)
block|{
name|struct
name|usb_attach_arg
modifier|*
name|uaa
init|=
name|device_get_ivars
argument_list|(
name|self
argument_list|)
decl_stmt|;
if|if
condition|(
name|uaa
operator|->
name|usb_mode
operator|!=
name|USB_MODE_HOST
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
name|uaa
operator|->
name|info
operator|.
name|bConfigIndex
operator|!=
literal|0
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
name|uaa
operator|->
name|info
operator|.
name|bIfaceIndex
operator|!=
name|RT2860_IFACE_INDEX
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
return|return
operator|(
name|usbd_lookup_id_by_uaa
argument_list|(
name|run_devs
argument_list|,
sizeof|sizeof
argument_list|(
name|run_devs
argument_list|)
argument_list|,
name|uaa
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|run_attach
parameter_list|(
name|device_t
name|self
parameter_list|)
block|{
name|struct
name|run_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|self
argument_list|)
decl_stmt|;
name|struct
name|usb_attach_arg
modifier|*
name|uaa
init|=
name|device_get_ivars
argument_list|(
name|self
argument_list|)
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|uint32_t
name|ver
decl_stmt|;
name|int
name|i
decl_stmt|,
name|ntries
decl_stmt|,
name|error
decl_stmt|;
name|uint8_t
name|iface_index
decl_stmt|,
name|bands
decl_stmt|;
name|device_set_usb_desc
argument_list|(
name|self
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_udev
operator|=
name|uaa
operator|->
name|device
expr_stmt|;
name|sc
operator|->
name|sc_dev
operator|=
name|self
expr_stmt|;
name|mtx_init
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|,
name|device_get_nameunit
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|MTX_NETWORK_LOCK
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
name|iface_index
operator|=
name|RT2860_IFACE_INDEX
expr_stmt|;
name|error
operator|=
name|usbd_transfer_setup
argument_list|(
name|uaa
operator|->
name|device
argument_list|,
operator|&
name|iface_index
argument_list|,
name|sc
operator|->
name|sc_xfer
argument_list|,
name|run_config
argument_list|,
name|RUN_N_XFER
argument_list|,
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|self
argument_list|,
literal|"could not allocate USB transfers, "
literal|"err=%s\n"
argument_list|,
name|usbd_errstr
argument_list|(
name|error
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|detach
goto|;
block|}
name|RUN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* wait for the chip to settle */
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|100
condition|;
name|ntries
operator|++
control|)
block|{
if|if
condition|(
name|run_read
argument_list|(
name|sc
argument_list|,
name|RT2860_ASIC_VER_ID
argument_list|,
operator|&
name|ver
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|RUN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
goto|goto
name|detach
goto|;
block|}
if|if
condition|(
name|ver
operator|!=
literal|0
operator|&&
name|ver
operator|!=
literal|0xffffffff
condition|)
break|break;
name|run_delay
argument_list|(
name|sc
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ntries
operator|==
literal|100
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"timeout waiting for NIC to initialize\n"
argument_list|)
expr_stmt|;
name|RUN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
goto|goto
name|detach
goto|;
block|}
name|sc
operator|->
name|mac_ver
operator|=
name|ver
operator|>>
literal|16
expr_stmt|;
name|sc
operator|->
name|mac_rev
operator|=
name|ver
operator|&
literal|0xffff
expr_stmt|;
comment|/* retrieve RF rev. no and various other things from EEPROM */
name|run_read_eeprom
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"MAC/BBP RT%04X (rev 0x%04X), RF %s (MIMO %dT%dR), address %s\n"
argument_list|,
name|sc
operator|->
name|mac_ver
argument_list|,
name|sc
operator|->
name|mac_rev
argument_list|,
name|run_get_rf
argument_list|(
name|sc
operator|->
name|rf_rev
argument_list|)
argument_list|,
name|sc
operator|->
name|ntxchains
argument_list|,
name|sc
operator|->
name|nrxchains
argument_list|,
name|ether_sprintf
argument_list|(
name|sc
operator|->
name|sc_bssid
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|run_load_microcode
argument_list|(
name|sc
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not load 8051 microcode\n"
argument_list|)
expr_stmt|;
name|RUN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
goto|goto
name|detach
goto|;
block|}
name|RUN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|sc_ifp
operator|=
name|if_alloc
argument_list|(
name|IFT_IEEE80211
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"can not if_alloc()\n"
argument_list|)
expr_stmt|;
goto|goto
name|detach
goto|;
block|}
name|ic
operator|=
name|ifp
operator|->
name|if_l2com
expr_stmt|;
name|ifp
operator|->
name|if_softc
operator|=
name|sc
expr_stmt|;
name|if_initname
argument_list|(
name|ifp
argument_list|,
literal|"run"
argument_list|,
name|device_get_unit
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_flags
operator|=
name|IFF_BROADCAST
operator||
name|IFF_SIMPLEX
operator||
name|IFF_MULTICAST
expr_stmt|;
name|ifp
operator|->
name|if_init
operator|=
name|run_init
expr_stmt|;
name|ifp
operator|->
name|if_ioctl
operator|=
name|run_ioctl
expr_stmt|;
name|ifp
operator|->
name|if_start
operator|=
name|run_start
expr_stmt|;
name|IFQ_SET_MAXLEN
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|,
name|ifqmaxlen
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_snd
operator|.
name|ifq_drv_maxlen
operator|=
name|ifqmaxlen
expr_stmt|;
name|IFQ_SET_READY
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|)
expr_stmt|;
name|ic
operator|->
name|ic_ifp
operator|=
name|ifp
expr_stmt|;
name|ic
operator|->
name|ic_phytype
operator|=
name|IEEE80211_T_OFDM
expr_stmt|;
comment|/* not only, but not used */
name|ic
operator|->
name|ic_opmode
operator|=
name|IEEE80211_M_STA
expr_stmt|;
comment|/* default to BSS mode */
comment|/* set device capabilities */
name|ic
operator|->
name|ic_caps
operator|=
name|IEEE80211_C_STA
operator||
comment|/* station mode supported */
name|IEEE80211_C_MONITOR
operator||
comment|/* monitor mode supported */
name|IEEE80211_C_IBSS
operator||
name|IEEE80211_C_HOSTAP
operator||
name|IEEE80211_C_WDS
operator||
comment|/* 4-address traffic works */
name|IEEE80211_C_MBSS
operator||
name|IEEE80211_C_SHPREAMBLE
operator||
comment|/* short preamble supported */
name|IEEE80211_C_SHSLOT
operator||
comment|/* short slot time supported */
name|IEEE80211_C_WME
operator||
comment|/* WME */
name|IEEE80211_C_WPA
operator||
comment|/* WPA1|WPA2(RSN) */
name|IEEE80211_C_RATECTL
expr_stmt|;
comment|/* use ratectl */
name|ic
operator|->
name|ic_cryptocaps
operator|=
name|IEEE80211_CRYPTO_WEP
operator||
name|IEEE80211_CRYPTO_AES_CCM
operator||
name|IEEE80211_CRYPTO_TKIPMIC
operator||
name|IEEE80211_CRYPTO_TKIP
expr_stmt|;
name|ic
operator|->
name|ic_flags
operator||=
name|IEEE80211_F_DATAPAD
expr_stmt|;
name|ic
operator|->
name|ic_flags_ext
operator||=
name|IEEE80211_FEXT_SWBMISS
expr_stmt|;
name|bands
operator|=
literal|0
expr_stmt|;
name|setbit
argument_list|(
operator|&
name|bands
argument_list|,
name|IEEE80211_MODE_11B
argument_list|)
expr_stmt|;
name|setbit
argument_list|(
operator|&
name|bands
argument_list|,
name|IEEE80211_MODE_11G
argument_list|)
expr_stmt|;
name|ieee80211_init_channels
argument_list|(
name|ic
argument_list|,
name|NULL
argument_list|,
operator|&
name|bands
argument_list|)
expr_stmt|;
comment|/* 	 * Do this by own because h/w supports 	 * more channels than ieee80211_init_channels() 	 */
if|if
condition|(
name|sc
operator|->
name|rf_rev
operator|==
name|RT2860_RF_2750
operator|||
name|sc
operator|->
name|rf_rev
operator|==
name|RT2860_RF_2850
operator|||
name|sc
operator|->
name|rf_rev
operator|==
name|RT3070_RF_3052
condition|)
block|{
comment|/* set supported .11a rates */
for|for
control|(
name|i
operator|=
literal|14
init|;
name|i
operator|<
name|nitems
argument_list|(
name|rt2860_rf2850
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|uint8_t
name|chan
init|=
name|rt2860_rf2850
index|[
name|i
index|]
operator|.
name|chan
decl_stmt|;
name|ic
operator|->
name|ic_channels
index|[
name|ic
operator|->
name|ic_nchans
index|]
operator|.
name|ic_freq
operator|=
name|ieee80211_ieee2mhz
argument_list|(
name|chan
argument_list|,
name|IEEE80211_CHAN_A
argument_list|)
expr_stmt|;
name|ic
operator|->
name|ic_channels
index|[
name|ic
operator|->
name|ic_nchans
index|]
operator|.
name|ic_ieee
operator|=
name|chan
expr_stmt|;
name|ic
operator|->
name|ic_channels
index|[
name|ic
operator|->
name|ic_nchans
index|]
operator|.
name|ic_flags
operator|=
name|IEEE80211_CHAN_A
expr_stmt|;
name|ic
operator|->
name|ic_channels
index|[
name|ic
operator|->
name|ic_nchans
index|]
operator|.
name|ic_extieee
operator|=
literal|0
expr_stmt|;
name|ic
operator|->
name|ic_nchans
operator|++
expr_stmt|;
block|}
block|}
name|ieee80211_ifattach
argument_list|(
name|ic
argument_list|,
name|sc
operator|->
name|sc_bssid
argument_list|)
expr_stmt|;
name|ic
operator|->
name|ic_scan_start
operator|=
name|run_scan_start
expr_stmt|;
name|ic
operator|->
name|ic_scan_end
operator|=
name|run_scan_end
expr_stmt|;
name|ic
operator|->
name|ic_set_channel
operator|=
name|run_set_channel
expr_stmt|;
name|ic
operator|->
name|ic_node_alloc
operator|=
name|run_node_alloc
expr_stmt|;
name|ic
operator|->
name|ic_newassoc
operator|=
name|run_newassoc
expr_stmt|;
comment|//ic->ic_updateslot = run_updateslot;
name|ic
operator|->
name|ic_update_mcast
operator|=
name|run_update_mcast
expr_stmt|;
name|ic
operator|->
name|ic_wme
operator|.
name|wme_update
operator|=
name|run_wme_update
expr_stmt|;
name|ic
operator|->
name|ic_raw_xmit
operator|=
name|run_raw_xmit
expr_stmt|;
name|ic
operator|->
name|ic_update_promisc
operator|=
name|run_update_promisc
expr_stmt|;
name|ic
operator|->
name|ic_vap_create
operator|=
name|run_vap_create
expr_stmt|;
name|ic
operator|->
name|ic_vap_delete
operator|=
name|run_vap_delete
expr_stmt|;
name|ieee80211_radiotap_attach
argument_list|(
name|ic
argument_list|,
operator|&
name|sc
operator|->
name|sc_txtap
operator|.
name|wt_ihdr
argument_list|,
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|sc_txtap
argument_list|)
argument_list|,
name|RUN_TX_RADIOTAP_PRESENT
argument_list|,
operator|&
name|sc
operator|->
name|sc_rxtap
operator|.
name|wr_ihdr
argument_list|,
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|sc_rxtap
argument_list|)
argument_list|,
name|RUN_RX_RADIOTAP_PRESENT
argument_list|)
expr_stmt|;
name|TASK_INIT
argument_list|(
operator|&
name|sc
operator|->
name|cmdq_task
argument_list|,
literal|0
argument_list|,
name|run_cmdq_cb
argument_list|,
name|sc
argument_list|)
expr_stmt|;
name|TASK_INIT
argument_list|(
operator|&
name|sc
operator|->
name|ratectl_task
argument_list|,
literal|0
argument_list|,
name|run_ratectl_cb
argument_list|,
name|sc
argument_list|)
expr_stmt|;
name|callout_init
argument_list|(
operator|(
expr|struct
name|callout
operator|*
operator|)
operator|&
name|sc
operator|->
name|ratectl_ch
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|ieee80211_announce
argument_list|(
name|ic
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|detach
label|:
name|run_detach
argument_list|(
name|self
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|run_detach
parameter_list|(
name|device_t
name|self
parameter_list|)
block|{
name|struct
name|run_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|self
argument_list|)
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* stop all USB transfers */
name|usbd_transfer_unsetup
argument_list|(
name|sc
operator|->
name|sc_xfer
argument_list|,
name|RUN_N_XFER
argument_list|)
expr_stmt|;
name|RUN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|ratectl_run
operator|=
name|RUN_RATECTL_OFF
expr_stmt|;
name|sc
operator|->
name|cmdq_run
operator|=
name|sc
operator|->
name|cmdq_key_set
operator|=
name|RUN_CMDQ_ABORT
expr_stmt|;
comment|/* free TX list, if any */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|!=
name|RUN_EP_QUEUES
condition|;
name|i
operator|++
control|)
name|run_unsetup_tx_list
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|sc_epq
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|RUN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
condition|)
block|{
name|ic
operator|=
name|ifp
operator|->
name|if_l2com
expr_stmt|;
comment|/* drain tasks */
name|usb_callout_drain
argument_list|(
operator|&
name|sc
operator|->
name|ratectl_ch
argument_list|)
expr_stmt|;
name|ieee80211_draintask
argument_list|(
name|ic
argument_list|,
operator|&
name|sc
operator|->
name|cmdq_task
argument_list|)
expr_stmt|;
name|ieee80211_draintask
argument_list|(
name|ic
argument_list|,
operator|&
name|sc
operator|->
name|ratectl_task
argument_list|)
expr_stmt|;
name|ieee80211_ifdetach
argument_list|(
name|ic
argument_list|)
expr_stmt|;
name|if_free
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
block|}
name|mtx_destroy
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|ieee80211vap
modifier|*
name|run_vap_create
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|,
specifier|const
name|char
name|name
index|[
name|IFNAMSIZ
index|]
parameter_list|,
name|int
name|unit
parameter_list|,
name|int
name|opmode
parameter_list|,
name|int
name|flags
parameter_list|,
specifier|const
name|uint8_t
name|bssid
index|[
name|IEEE80211_ADDR_LEN
index|]
parameter_list|,
specifier|const
name|uint8_t
name|mac
index|[
name|IEEE80211_ADDR_LEN
index|]
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|ic
operator|->
name|ic_ifp
decl_stmt|;
name|struct
name|run_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|run_vap
modifier|*
name|rvp
decl_stmt|;
name|struct
name|ieee80211vap
modifier|*
name|vap
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|rvp_cnt
operator|>=
name|RUN_VAP_MAX
condition|)
block|{
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"number of VAPs maxed out\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
switch|switch
condition|(
name|opmode
condition|)
block|{
case|case
name|IEEE80211_M_STA
case|:
comment|/* enable s/w bmiss handling for sta mode */
name|flags
operator||=
name|IEEE80211_CLONE_NOBEACONS
expr_stmt|;
comment|/* fall though */
case|case
name|IEEE80211_M_IBSS
case|:
case|case
name|IEEE80211_M_MONITOR
case|:
case|case
name|IEEE80211_M_HOSTAP
case|:
case|case
name|IEEE80211_M_MBSS
case|:
comment|/* other than WDS vaps, only one at a time */
if|if
condition|(
operator|!
name|TAILQ_EMPTY
argument_list|(
operator|&
name|ic
operator|->
name|ic_vaps
argument_list|)
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
break|break;
case|case
name|IEEE80211_M_WDS
case|:
name|TAILQ_FOREACH
argument_list|(
argument|vap
argument_list|,
argument|&ic->ic_vaps
argument_list|,
argument|iv_next
argument_list|)
block|{
if|if
condition|(
name|vap
operator|->
name|iv_opmode
operator|!=
name|IEEE80211_M_HOSTAP
condition|)
continue|continue;
comment|/* WDS vap's always share the local mac address. */
name|flags
operator|&=
operator|~
name|IEEE80211_CLONE_BSSID
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|vap
operator|==
name|NULL
condition|)
block|{
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"wds only supported in ap mode\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
break|break;
default|default:
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"unknown opmode %d\n"
argument_list|,
name|opmode
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|rvp
operator|=
operator|(
expr|struct
name|run_vap
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|run_vap
argument_list|)
argument_list|,
name|M_80211_VAP
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|rvp
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|vap
operator|=
operator|&
name|rvp
operator|->
name|vap
expr_stmt|;
name|ieee80211_vap_setup
argument_list|(
name|ic
argument_list|,
name|vap
argument_list|,
name|name
argument_list|,
name|unit
argument_list|,
name|opmode
argument_list|,
name|flags
argument_list|,
name|bssid
argument_list|,
name|mac
argument_list|)
expr_stmt|;
name|vap
operator|->
name|iv_key_update_begin
operator|=
name|run_key_update_begin
expr_stmt|;
name|vap
operator|->
name|iv_key_update_end
operator|=
name|run_key_update_end
expr_stmt|;
name|vap
operator|->
name|iv_update_beacon
operator|=
name|run_update_beacon
expr_stmt|;
name|vap
operator|->
name|iv_max_aid
operator|=
name|RT2870_WCID_MAX
expr_stmt|;
comment|/* 	 * To delete the right key from h/w, we need wcid. 	 * Luckily, there is unused space in ieee80211_key{}, wk_pad, 	 * and matching wcid will be written into there. So, cast 	 * some spells to remove 'const' from ieee80211_key{} 	 */
name|vap
operator|->
name|iv_key_delete
operator|=
operator|(
name|void
operator|*
operator|)
name|run_key_delete
expr_stmt|;
name|vap
operator|->
name|iv_key_set
operator|=
operator|(
name|void
operator|*
operator|)
name|run_key_set
expr_stmt|;
comment|/* override state transition machine */
name|rvp
operator|->
name|newstate
operator|=
name|vap
operator|->
name|iv_newstate
expr_stmt|;
name|vap
operator|->
name|iv_newstate
operator|=
name|run_newstate
expr_stmt|;
name|ieee80211_ratectl_init
argument_list|(
name|vap
argument_list|)
expr_stmt|;
name|ieee80211_ratectl_setinterval
argument_list|(
name|vap
argument_list|,
literal|1000
comment|/* 1 sec */
argument_list|)
expr_stmt|;
comment|/* complete setup */
name|ieee80211_vap_attach
argument_list|(
name|vap
argument_list|,
name|run_media_change
argument_list|,
name|ieee80211_media_status
argument_list|)
expr_stmt|;
comment|/* make sure id is always unique */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RUN_VAP_MAX
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|sc
operator|->
name|rvp_bmap
operator|&
literal|1
operator|<<
name|i
operator|)
operator|==
literal|0
condition|)
block|{
name|sc
operator|->
name|rvp_bmap
operator||=
literal|1
operator|<<
name|i
expr_stmt|;
name|rvp
operator|->
name|rvp_id
operator|=
name|i
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|sc
operator|->
name|rvp_cnt
operator|++
operator|==
literal|0
condition|)
name|ic
operator|->
name|ic_opmode
operator|=
name|opmode
expr_stmt|;
if|if
condition|(
name|opmode
operator|==
name|IEEE80211_M_HOSTAP
condition|)
name|sc
operator|->
name|cmdq_run
operator|=
name|RUN_CMDQ_GO
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"rvp_id=%d bmap=%x rvp_cnt=%d\n"
argument_list|,
name|rvp
operator|->
name|rvp_id
argument_list|,
name|sc
operator|->
name|rvp_bmap
argument_list|,
name|sc
operator|->
name|rvp_cnt
argument_list|)
expr_stmt|;
return|return
operator|(
name|vap
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|run_vap_delete
parameter_list|(
name|struct
name|ieee80211vap
modifier|*
name|vap
parameter_list|)
block|{
name|struct
name|run_vap
modifier|*
name|rvp
init|=
name|RUN_VAP
argument_list|(
name|vap
argument_list|)
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
decl_stmt|;
name|struct
name|run_softc
modifier|*
name|sc
decl_stmt|;
name|uint8_t
name|rvp_id
decl_stmt|;
if|if
condition|(
name|vap
operator|==
name|NULL
condition|)
return|return;
name|ic
operator|=
name|vap
operator|->
name|iv_ic
expr_stmt|;
name|ifp
operator|=
name|ic
operator|->
name|ic_ifp
expr_stmt|;
name|sc
operator|=
name|ifp
operator|->
name|if_softc
expr_stmt|;
name|RUN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|rvp_id
operator|=
name|rvp
operator|->
name|rvp_id
expr_stmt|;
name|sc
operator|->
name|ratectl_run
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|rvp_id
operator|)
expr_stmt|;
name|sc
operator|->
name|rvp_bmap
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|rvp_id
operator|)
expr_stmt|;
name|run_set_region_4
argument_list|(
name|sc
argument_list|,
name|RT2860_SKEY
argument_list|(
name|rvp_id
argument_list|,
literal|0
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|128
argument_list|)
expr_stmt|;
name|run_set_region_4
argument_list|(
name|sc
argument_list|,
name|RT2860_BCN_BASE
argument_list|(
name|rvp_id
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|512
argument_list|)
expr_stmt|;
operator|--
name|sc
operator|->
name|rvp_cnt
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"vap=%p rvp_id=%d bmap=%x rvp_cnt=%d\n"
argument_list|,
name|vap
argument_list|,
name|rvp_id
argument_list|,
name|sc
operator|->
name|rvp_bmap
argument_list|,
name|sc
operator|->
name|rvp_cnt
argument_list|)
expr_stmt|;
name|RUN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ieee80211_ratectl_deinit
argument_list|(
name|vap
argument_list|)
expr_stmt|;
name|ieee80211_vap_detach
argument_list|(
name|vap
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|rvp
argument_list|,
name|M_80211_VAP
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * There are numbers of functions need to be called in context thread.  * Rather than creating taskqueue event for each of those functions,  * here is all-for-one taskqueue callback function. This function  * gurantees deferred functions are executed in the same order they  * were enqueued.  * '& RUN_CMDQ_MASQ' is to loop cmdq[].  */
end_comment

begin_function
specifier|static
name|void
name|run_cmdq_cb
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|int
name|pending
parameter_list|)
block|{
name|struct
name|run_softc
modifier|*
name|sc
init|=
name|arg
decl_stmt|;
name|uint8_t
name|i
decl_stmt|;
comment|/* call cmdq[].func locked */
name|RUN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|sc
operator|->
name|cmdq_exec
init|;
name|sc
operator|->
name|cmdq
index|[
name|i
index|]
operator|.
name|func
operator|&&
name|pending
condition|;
name|i
operator|=
name|sc
operator|->
name|cmdq_exec
operator|,
name|pending
operator|--
control|)
block|{
name|DPRINTFN
argument_list|(
literal|6
argument_list|,
literal|"cmdq_exec=%d pending=%d\n"
argument_list|,
name|i
argument_list|,
name|pending
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|cmdq_run
operator|==
name|RUN_CMDQ_GO
condition|)
block|{
comment|/* 			 * If arg0 is NULL, callback func needs more 			 * than one arg. So, pass ptr to cmdq struct. 			 */
if|if
condition|(
name|sc
operator|->
name|cmdq
index|[
name|i
index|]
operator|.
name|arg0
condition|)
name|sc
operator|->
name|cmdq
index|[
name|i
index|]
operator|.
name|func
argument_list|(
name|sc
operator|->
name|cmdq
index|[
name|i
index|]
operator|.
name|arg0
argument_list|)
expr_stmt|;
else|else
name|sc
operator|->
name|cmdq
index|[
name|i
index|]
operator|.
name|func
argument_list|(
operator|&
name|sc
operator|->
name|cmdq
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|sc
operator|->
name|cmdq
index|[
name|i
index|]
operator|.
name|arg0
operator|=
name|NULL
expr_stmt|;
name|sc
operator|->
name|cmdq
index|[
name|i
index|]
operator|.
name|func
operator|=
name|NULL
expr_stmt|;
name|sc
operator|->
name|cmdq_exec
operator|++
expr_stmt|;
name|sc
operator|->
name|cmdq_exec
operator|&=
name|RUN_CMDQ_MASQ
expr_stmt|;
block|}
name|RUN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|run_setup_tx_list
parameter_list|(
name|struct
name|run_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|run_endpoint_queue
modifier|*
name|pq
parameter_list|)
block|{
name|struct
name|run_tx_data
modifier|*
name|data
decl_stmt|;
name|memset
argument_list|(
name|pq
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|pq
argument_list|)
argument_list|)
expr_stmt|;
name|STAILQ_INIT
argument_list|(
operator|&
name|pq
operator|->
name|tx_qh
argument_list|)
expr_stmt|;
name|STAILQ_INIT
argument_list|(
operator|&
name|pq
operator|->
name|tx_fh
argument_list|)
expr_stmt|;
for|for
control|(
name|data
operator|=
operator|&
name|pq
operator|->
name|tx_data
index|[
literal|0
index|]
init|;
name|data
operator|<
operator|&
name|pq
operator|->
name|tx_data
index|[
name|RUN_TX_RING_COUNT
index|]
condition|;
name|data
operator|++
control|)
block|{
name|data
operator|->
name|sc
operator|=
name|sc
expr_stmt|;
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|pq
operator|->
name|tx_fh
argument_list|,
name|data
argument_list|,
name|next
argument_list|)
expr_stmt|;
block|}
name|pq
operator|->
name|tx_nfree
operator|=
name|RUN_TX_RING_COUNT
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|run_unsetup_tx_list
parameter_list|(
name|struct
name|run_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|run_endpoint_queue
modifier|*
name|pq
parameter_list|)
block|{
name|struct
name|run_tx_data
modifier|*
name|data
decl_stmt|;
comment|/* make sure any subsequent use of the queues will fail */
name|pq
operator|->
name|tx_nfree
operator|=
literal|0
expr_stmt|;
name|STAILQ_INIT
argument_list|(
operator|&
name|pq
operator|->
name|tx_fh
argument_list|)
expr_stmt|;
name|STAILQ_INIT
argument_list|(
operator|&
name|pq
operator|->
name|tx_qh
argument_list|)
expr_stmt|;
comment|/* free up all node references and mbufs */
for|for
control|(
name|data
operator|=
operator|&
name|pq
operator|->
name|tx_data
index|[
literal|0
index|]
init|;
name|data
operator|<
operator|&
name|pq
operator|->
name|tx_data
index|[
name|RUN_TX_RING_COUNT
index|]
condition|;
name|data
operator|++
control|)
block|{
if|if
condition|(
name|data
operator|->
name|m
operator|!=
name|NULL
condition|)
block|{
name|m_freem
argument_list|(
name|data
operator|->
name|m
argument_list|)
expr_stmt|;
name|data
operator|->
name|m
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|data
operator|->
name|ni
operator|!=
name|NULL
condition|)
block|{
name|ieee80211_free_node
argument_list|(
name|data
operator|->
name|ni
argument_list|)
expr_stmt|;
name|data
operator|->
name|ni
operator|=
name|NULL
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|int
name|run_load_microcode
parameter_list|(
name|struct
name|run_softc
modifier|*
name|sc
parameter_list|)
block|{
name|usb_device_request_t
name|req
decl_stmt|;
specifier|const
name|struct
name|firmware
modifier|*
name|fw
decl_stmt|;
specifier|const
name|u_char
modifier|*
name|base
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
name|int
name|ntries
decl_stmt|,
name|error
decl_stmt|;
specifier|const
name|uint64_t
modifier|*
name|temp
decl_stmt|;
name|uint64_t
name|bytes
decl_stmt|;
name|RUN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|fw
operator|=
name|firmware_get
argument_list|(
literal|"runfw"
argument_list|)
expr_stmt|;
name|RUN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|fw
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"failed loadfirmware of file %s\n"
argument_list|,
literal|"runfw"
argument_list|)
expr_stmt|;
return|return
name|ENOENT
return|;
block|}
if|if
condition|(
name|fw
operator|->
name|datasize
operator|!=
literal|8192
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"invalid firmware size (should be 8KB)\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
comment|/* 	 * RT3071/RT3072 use a different firmware 	 * run-rt2870 (8KB) contains both, 	 * first half (4KB) is for rt2870, 	 * last half is for rt3071. 	 */
name|base
operator|=
name|fw
operator|->
name|data
expr_stmt|;
if|if
condition|(
operator|(
name|sc
operator|->
name|mac_ver
operator|)
operator|!=
literal|0x2860
operator|&&
operator|(
name|sc
operator|->
name|mac_ver
operator|)
operator|!=
literal|0x2872
operator|&&
operator|(
name|sc
operator|->
name|mac_ver
operator|)
operator|!=
literal|0x3070
condition|)
block|{
name|base
operator|+=
literal|4096
expr_stmt|;
block|}
comment|/* cheap sanity check */
name|temp
operator|=
name|fw
operator|->
name|data
expr_stmt|;
name|bytes
operator|=
operator|*
name|temp
expr_stmt|;
if|if
condition|(
name|bytes
operator|!=
name|be64toh
argument_list|(
literal|0xffffff0210280210
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"firmware checksum failed\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|run_read
argument_list|(
name|sc
argument_list|,
name|RT2860_ASIC_VER_ID
argument_list|,
operator|&
name|tmp
argument_list|)
expr_stmt|;
comment|/* write microcode image */
name|run_write_region_1
argument_list|(
name|sc
argument_list|,
name|RT2870_FW_BASE
argument_list|,
name|base
argument_list|,
literal|4096
argument_list|)
expr_stmt|;
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_H2M_MAILBOX_CID
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_H2M_MAILBOX_STATUS
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_WRITE_VENDOR_DEVICE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|RT2870_RESET
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|usbd_do_request
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|,
operator|&
name|req
argument_list|,
name|NULL
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"firmware reset failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|run_delay
argument_list|(
name|sc
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_H2M_MAILBOX
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|run_mcu_cmd
argument_list|(
name|sc
argument_list|,
name|RT2860_MCU_CMD_RFRESET
argument_list|,
literal|0
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
comment|/* wait until microcontroller is ready */
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|1000
condition|;
name|ntries
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|run_read
argument_list|(
name|sc
argument_list|,
name|RT2860_SYS_CTRL
argument_list|,
operator|&
name|tmp
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|tmp
operator|&
name|RT2860_MCU_READY
condition|)
break|break;
name|run_delay
argument_list|(
name|sc
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ntries
operator|==
literal|1000
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"timeout waiting for MCU to initialize\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|ETIMEDOUT
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"firmware %s loaded\n"
argument_list|,
operator|(
name|base
operator|==
name|fw
operator|->
name|data
operator|)
condition|?
literal|"RT2870"
else|:
literal|"RT3071"
argument_list|)
expr_stmt|;
name|fail
label|:
name|firmware_put
argument_list|(
name|fw
argument_list|,
name|FIRMWARE_UNLOAD
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
name|int
name|run_reset
parameter_list|(
name|struct
name|run_softc
modifier|*
name|sc
parameter_list|)
block|{
name|usb_device_request_t
name|req
decl_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_WRITE_VENDOR_DEVICE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|RT2870_RESET
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|usbd_do_request
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|,
operator|&
name|req
argument_list|,
name|NULL
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|usb_error_t
name|run_do_request
parameter_list|(
name|struct
name|run_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|usb_device_request
modifier|*
name|req
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|usb_error_t
name|err
decl_stmt|;
name|int
name|ntries
init|=
literal|10
decl_stmt|;
name|RUN_LOCK_ASSERT
argument_list|(
name|sc
argument_list|,
name|MA_OWNED
argument_list|)
expr_stmt|;
while|while
condition|(
name|ntries
operator|--
condition|)
block|{
name|err
operator|=
name|usbd_do_request_flags
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|,
name|req
argument_list|,
name|data
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|250
comment|/* ms */
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
literal|0
condition|)
break|break;
name|DPRINTFN
argument_list|(
literal|1
argument_list|,
literal|"Control request failed, %s (retrying)\n"
argument_list|,
name|usbd_errstr
argument_list|(
name|err
argument_list|)
argument_list|)
expr_stmt|;
name|run_delay
argument_list|(
name|sc
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|run_read
parameter_list|(
name|struct
name|run_softc
modifier|*
name|sc
parameter_list|,
name|uint16_t
name|reg
parameter_list|,
name|uint32_t
modifier|*
name|val
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
name|int
name|error
decl_stmt|;
name|error
operator|=
name|run_read_region_1
argument_list|(
name|sc
argument_list|,
name|reg
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|tmp
argument_list|,
sizeof|sizeof
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
operator|*
name|val
operator|=
name|le32toh
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
else|else
operator|*
name|val
operator|=
literal|0xffffffff
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|run_read_region_1
parameter_list|(
name|struct
name|run_softc
modifier|*
name|sc
parameter_list|,
name|uint16_t
name|reg
parameter_list|,
name|uint8_t
modifier|*
name|buf
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|usb_device_request_t
name|req
decl_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_READ_VENDOR_DEVICE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|RT2870_READ_REGION_1
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|(
name|run_do_request
argument_list|(
name|sc
argument_list|,
operator|&
name|req
argument_list|,
name|buf
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|run_write_2
parameter_list|(
name|struct
name|run_softc
modifier|*
name|sc
parameter_list|,
name|uint16_t
name|reg
parameter_list|,
name|uint16_t
name|val
parameter_list|)
block|{
name|usb_device_request_t
name|req
decl_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_WRITE_VENDOR_DEVICE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|RT2870_WRITE_2
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|run_do_request
argument_list|(
name|sc
argument_list|,
operator|&
name|req
argument_list|,
name|NULL
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|run_write
parameter_list|(
name|struct
name|run_softc
modifier|*
name|sc
parameter_list|,
name|uint16_t
name|reg
parameter_list|,
name|uint32_t
name|val
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|run_write_2
argument_list|(
name|sc
argument_list|,
name|reg
argument_list|,
name|val
operator|&
literal|0xffff
argument_list|)
operator|)
operator|==
literal|0
condition|)
name|error
operator|=
name|run_write_2
argument_list|(
name|sc
argument_list|,
name|reg
operator|+
literal|2
argument_list|,
name|val
operator|>>
literal|16
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|run_write_region_1
parameter_list|(
name|struct
name|run_softc
modifier|*
name|sc
parameter_list|,
name|uint16_t
name|reg
parameter_list|,
specifier|const
name|uint8_t
modifier|*
name|buf
parameter_list|,
name|int
name|len
parameter_list|)
block|{
if|#
directive|if
literal|1
name|int
name|i
decl_stmt|,
name|error
init|=
literal|0
decl_stmt|;
comment|/* 	 * NB: the WRITE_REGION_1 command is not stable on RT2860. 	 * We thus issue multiple WRITE_2 commands instead. 	 */
name|KASSERT
argument_list|(
operator|(
name|len
operator|&
literal|1
operator|)
operator|==
literal|0
argument_list|,
operator|(
literal|"run_write_region_1: Data too long.\n"
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
operator|&&
name|error
operator|==
literal|0
condition|;
name|i
operator|+=
literal|2
control|)
name|error
operator|=
name|run_write_2
argument_list|(
name|sc
argument_list|,
name|reg
operator|+
name|i
argument_list|,
name|buf
index|[
name|i
index|]
operator||
name|buf
index|[
name|i
operator|+
literal|1
index|]
operator|<<
literal|8
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
else|#
directive|else
name|usb_device_request_t
name|req
decl_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_WRITE_VENDOR_DEVICE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|RT2870_WRITE_REGION_1
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|(
name|run_do_request
argument_list|(
name|sc
argument_list|,
operator|&
name|req
argument_list|,
name|buf
argument_list|)
operator|)
return|;
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|int
name|run_set_region_4
parameter_list|(
name|struct
name|run_softc
modifier|*
name|sc
parameter_list|,
name|uint16_t
name|reg
parameter_list|,
name|uint32_t
name|val
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|error
init|=
literal|0
decl_stmt|;
name|KASSERT
argument_list|(
operator|(
name|len
operator|&
literal|3
operator|)
operator|==
literal|0
argument_list|,
operator|(
literal|"run_set_region_4: Invalid data length.\n"
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
operator|&&
name|error
operator|==
literal|0
condition|;
name|i
operator|+=
literal|4
control|)
name|error
operator|=
name|run_write
argument_list|(
name|sc
argument_list|,
name|reg
operator|+
name|i
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Read 16-bit from eFUSE ROM (RT3070 only.) */
end_comment

begin_function
specifier|static
name|int
name|run_efuse_read_2
parameter_list|(
name|struct
name|run_softc
modifier|*
name|sc
parameter_list|,
name|uint16_t
name|addr
parameter_list|,
name|uint16_t
modifier|*
name|val
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
name|uint16_t
name|reg
decl_stmt|;
name|int
name|error
decl_stmt|,
name|ntries
decl_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|run_read
argument_list|(
name|sc
argument_list|,
name|RT3070_EFUSE_CTRL
argument_list|,
operator|&
name|tmp
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|addr
operator|*=
literal|2
expr_stmt|;
comment|/*- 	 * Read one 16-byte block into registers EFUSE_DATA[0-3]: 	 * DATA0: F E D C 	 * DATA1: B A 9 8 	 * DATA2: 7 6 5 4 	 * DATA3: 3 2 1 0 	 */
name|tmp
operator|&=
operator|~
operator|(
name|RT3070_EFSROM_MODE_MASK
operator||
name|RT3070_EFSROM_AIN_MASK
operator|)
expr_stmt|;
name|tmp
operator||=
operator|(
name|addr
operator|&
operator|~
literal|0xf
operator|)
operator|<<
name|RT3070_EFSROM_AIN_SHIFT
operator||
name|RT3070_EFSROM_KICK
expr_stmt|;
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT3070_EFUSE_CTRL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|100
condition|;
name|ntries
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|run_read
argument_list|(
name|sc
argument_list|,
name|RT3070_EFUSE_CTRL
argument_list|,
operator|&
name|tmp
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
if|if
condition|(
operator|!
operator|(
name|tmp
operator|&
name|RT3070_EFSROM_KICK
operator|)
condition|)
break|break;
name|run_delay
argument_list|(
name|sc
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ntries
operator|==
literal|100
condition|)
return|return
operator|(
name|ETIMEDOUT
operator|)
return|;
if|if
condition|(
operator|(
name|tmp
operator|&
name|RT3070_EFUSE_AOUT_MASK
operator|)
operator|==
name|RT3070_EFUSE_AOUT_MASK
condition|)
block|{
operator|*
name|val
operator|=
literal|0xffff
expr_stmt|;
comment|/* address not found */
return|return
operator|(
literal|0
operator|)
return|;
block|}
comment|/* determine to which 32-bit register our 16-bit word belongs */
name|reg
operator|=
name|RT3070_EFUSE_DATA3
operator|-
operator|(
name|addr
operator|&
literal|0xc
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|run_read
argument_list|(
name|sc
argument_list|,
name|reg
argument_list|,
operator|&
name|tmp
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
operator|*
name|val
operator|=
operator|(
name|addr
operator|&
literal|2
operator|)
condition|?
name|tmp
operator|>>
literal|16
else|:
name|tmp
operator|&
literal|0xffff
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|run_eeprom_read_2
parameter_list|(
name|struct
name|run_softc
modifier|*
name|sc
parameter_list|,
name|uint16_t
name|addr
parameter_list|,
name|uint16_t
modifier|*
name|val
parameter_list|)
block|{
name|usb_device_request_t
name|req
decl_stmt|;
name|uint16_t
name|tmp
decl_stmt|;
name|int
name|error
decl_stmt|;
name|addr
operator|*=
literal|2
expr_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_READ_VENDOR_DEVICE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|RT2870_EEPROM_READ
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
sizeof|sizeof
name|tmp
argument_list|)
expr_stmt|;
name|error
operator|=
name|usbd_do_request
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|,
operator|&
name|req
argument_list|,
operator|&
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
operator|*
name|val
operator|=
name|le16toh
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
else|else
operator|*
name|val
operator|=
literal|0xffff
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|__inline
name|int
name|run_srom_read
parameter_list|(
name|struct
name|run_softc
modifier|*
name|sc
parameter_list|,
name|uint16_t
name|addr
parameter_list|,
name|uint16_t
modifier|*
name|val
parameter_list|)
block|{
comment|/* either eFUSE ROM or EEPROM */
return|return
name|sc
operator|->
name|sc_srom_read
argument_list|(
name|sc
argument_list|,
name|addr
argument_list|,
name|val
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|run_rt2870_rf_write
parameter_list|(
name|struct
name|run_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|reg
parameter_list|,
name|uint32_t
name|val
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
name|int
name|error
decl_stmt|,
name|ntries
decl_stmt|;
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|10
condition|;
name|ntries
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|run_read
argument_list|(
name|sc
argument_list|,
name|RT2860_RF_CSR_CFG0
argument_list|,
operator|&
name|tmp
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
if|if
condition|(
operator|!
operator|(
name|tmp
operator|&
name|RT2860_RF_REG_CTRL
operator|)
condition|)
break|break;
block|}
if|if
condition|(
name|ntries
operator|==
literal|10
condition|)
return|return
operator|(
name|ETIMEDOUT
operator|)
return|;
comment|/* RF registers are 24-bit on the RT2860 */
name|tmp
operator|=
name|RT2860_RF_REG_CTRL
operator||
literal|24
operator|<<
name|RT2860_RF_REG_WIDTH_SHIFT
operator||
operator|(
name|val
operator|&
literal|0x3fffff
operator|)
operator|<<
literal|2
operator||
operator|(
name|reg
operator|&
literal|3
operator|)
expr_stmt|;
return|return
operator|(
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_RF_CSR_CFG0
argument_list|,
name|tmp
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|run_rt3070_rf_read
parameter_list|(
name|struct
name|run_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|reg
parameter_list|,
name|uint8_t
modifier|*
name|val
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
name|int
name|error
decl_stmt|,
name|ntries
decl_stmt|;
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|100
condition|;
name|ntries
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|run_read
argument_list|(
name|sc
argument_list|,
name|RT3070_RF_CSR_CFG
argument_list|,
operator|&
name|tmp
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
if|if
condition|(
operator|!
operator|(
name|tmp
operator|&
name|RT3070_RF_KICK
operator|)
condition|)
break|break;
block|}
if|if
condition|(
name|ntries
operator|==
literal|100
condition|)
return|return
operator|(
name|ETIMEDOUT
operator|)
return|;
name|tmp
operator|=
name|RT3070_RF_KICK
operator||
name|reg
operator|<<
literal|8
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT3070_RF_CSR_CFG
argument_list|,
name|tmp
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|100
condition|;
name|ntries
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|run_read
argument_list|(
name|sc
argument_list|,
name|RT3070_RF_CSR_CFG
argument_list|,
operator|&
name|tmp
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
if|if
condition|(
operator|!
operator|(
name|tmp
operator|&
name|RT3070_RF_KICK
operator|)
condition|)
break|break;
block|}
if|if
condition|(
name|ntries
operator|==
literal|100
condition|)
return|return
operator|(
name|ETIMEDOUT
operator|)
return|;
operator|*
name|val
operator|=
name|tmp
operator|&
literal|0xff
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|run_rt3070_rf_write
parameter_list|(
name|struct
name|run_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|reg
parameter_list|,
name|uint8_t
name|val
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
name|int
name|error
decl_stmt|,
name|ntries
decl_stmt|;
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|10
condition|;
name|ntries
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|run_read
argument_list|(
name|sc
argument_list|,
name|RT3070_RF_CSR_CFG
argument_list|,
operator|&
name|tmp
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
if|if
condition|(
operator|!
operator|(
name|tmp
operator|&
name|RT3070_RF_KICK
operator|)
condition|)
break|break;
block|}
if|if
condition|(
name|ntries
operator|==
literal|10
condition|)
return|return
operator|(
name|ETIMEDOUT
operator|)
return|;
name|tmp
operator|=
name|RT3070_RF_WRITE
operator||
name|RT3070_RF_KICK
operator||
name|reg
operator|<<
literal|8
operator||
name|val
expr_stmt|;
return|return
operator|(
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT3070_RF_CSR_CFG
argument_list|,
name|tmp
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|run_bbp_read
parameter_list|(
name|struct
name|run_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|reg
parameter_list|,
name|uint8_t
modifier|*
name|val
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
name|int
name|ntries
decl_stmt|,
name|error
decl_stmt|;
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|10
condition|;
name|ntries
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|run_read
argument_list|(
name|sc
argument_list|,
name|RT2860_BBP_CSR_CFG
argument_list|,
operator|&
name|tmp
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
if|if
condition|(
operator|!
operator|(
name|tmp
operator|&
name|RT2860_BBP_CSR_KICK
operator|)
condition|)
break|break;
block|}
if|if
condition|(
name|ntries
operator|==
literal|10
condition|)
return|return
operator|(
name|ETIMEDOUT
operator|)
return|;
name|tmp
operator|=
name|RT2860_BBP_CSR_READ
operator||
name|RT2860_BBP_CSR_KICK
operator||
name|reg
operator|<<
literal|8
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_BBP_CSR_CFG
argument_list|,
name|tmp
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|10
condition|;
name|ntries
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|run_read
argument_list|(
name|sc
argument_list|,
name|RT2860_BBP_CSR_CFG
argument_list|,
operator|&
name|tmp
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
if|if
condition|(
operator|!
operator|(
name|tmp
operator|&
name|RT2860_BBP_CSR_KICK
operator|)
condition|)
break|break;
block|}
if|if
condition|(
name|ntries
operator|==
literal|10
condition|)
return|return
operator|(
name|ETIMEDOUT
operator|)
return|;
operator|*
name|val
operator|=
name|tmp
operator|&
literal|0xff
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|run_bbp_write
parameter_list|(
name|struct
name|run_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|reg
parameter_list|,
name|uint8_t
name|val
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
name|int
name|ntries
decl_stmt|,
name|error
decl_stmt|;
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|10
condition|;
name|ntries
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|run_read
argument_list|(
name|sc
argument_list|,
name|RT2860_BBP_CSR_CFG
argument_list|,
operator|&
name|tmp
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
if|if
condition|(
operator|!
operator|(
name|tmp
operator|&
name|RT2860_BBP_CSR_KICK
operator|)
condition|)
break|break;
block|}
if|if
condition|(
name|ntries
operator|==
literal|10
condition|)
return|return
operator|(
name|ETIMEDOUT
operator|)
return|;
name|tmp
operator|=
name|RT2860_BBP_CSR_KICK
operator||
name|reg
operator|<<
literal|8
operator||
name|val
expr_stmt|;
return|return
operator|(
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_BBP_CSR_CFG
argument_list|,
name|tmp
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Send a command to the 8051 microcontroller unit.  */
end_comment

begin_function
specifier|static
name|int
name|run_mcu_cmd
parameter_list|(
name|struct
name|run_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|cmd
parameter_list|,
name|uint16_t
name|arg
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
name|int
name|error
decl_stmt|,
name|ntries
decl_stmt|;
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|100
condition|;
name|ntries
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|run_read
argument_list|(
name|sc
argument_list|,
name|RT2860_H2M_MAILBOX
argument_list|,
operator|&
name|tmp
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|error
return|;
if|if
condition|(
operator|!
operator|(
name|tmp
operator|&
name|RT2860_H2M_BUSY
operator|)
condition|)
break|break;
block|}
if|if
condition|(
name|ntries
operator|==
literal|100
condition|)
return|return
name|ETIMEDOUT
return|;
name|tmp
operator|=
name|RT2860_H2M_BUSY
operator||
name|RT2860_TOKEN_NO_INTR
operator|<<
literal|16
operator||
name|arg
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_H2M_MAILBOX
argument_list|,
name|tmp
argument_list|)
operator|)
operator|==
literal|0
condition|)
name|error
operator|=
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_HOST_CMD
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Add `delta' (signed) to each 4-bit sub-word of a 32-bit word.  * Used to adjust per-rate Tx power registers.  */
end_comment

begin_function
specifier|static
name|__inline
name|uint32_t
name|b4inc
parameter_list|(
name|uint32_t
name|b32
parameter_list|,
name|int8_t
name|delta
parameter_list|)
block|{
name|int8_t
name|i
decl_stmt|,
name|b4
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
block|{
name|b4
operator|=
name|b32
operator|&
literal|0xf
expr_stmt|;
name|b4
operator|+=
name|delta
expr_stmt|;
if|if
condition|(
name|b4
operator|<
literal|0
condition|)
name|b4
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|b4
operator|>
literal|0xf
condition|)
name|b4
operator|=
literal|0xf
expr_stmt|;
name|b32
operator|=
name|b32
operator|>>
literal|4
operator||
name|b4
operator|<<
literal|28
expr_stmt|;
block|}
return|return
operator|(
name|b32
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|run_get_rf
parameter_list|(
name|int
name|rev
parameter_list|)
block|{
switch|switch
condition|(
name|rev
condition|)
block|{
case|case
name|RT2860_RF_2820
case|:
return|return
literal|"RT2820"
return|;
case|case
name|RT2860_RF_2850
case|:
return|return
literal|"RT2850"
return|;
case|case
name|RT2860_RF_2720
case|:
return|return
literal|"RT2720"
return|;
case|case
name|RT2860_RF_2750
case|:
return|return
literal|"RT2750"
return|;
case|case
name|RT3070_RF_3020
case|:
return|return
literal|"RT3020"
return|;
case|case
name|RT3070_RF_2020
case|:
return|return
literal|"RT2020"
return|;
case|case
name|RT3070_RF_3021
case|:
return|return
literal|"RT3021"
return|;
case|case
name|RT3070_RF_3022
case|:
return|return
literal|"RT3022"
return|;
case|case
name|RT3070_RF_3052
case|:
return|return
literal|"RT3052"
return|;
block|}
return|return
operator|(
literal|"unknown"
operator|)
return|;
block|}
end_function

begin_function
name|int
name|run_read_eeprom
parameter_list|(
name|struct
name|run_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int8_t
name|delta_2ghz
decl_stmt|,
name|delta_5ghz
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
name|uint16_t
name|val
decl_stmt|;
name|int
name|ridx
decl_stmt|,
name|ant
decl_stmt|,
name|i
decl_stmt|;
comment|/* check whether the ROM is eFUSE ROM or EEPROM */
name|sc
operator|->
name|sc_srom_read
operator|=
name|run_eeprom_read_2
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|mac_ver
operator|>=
literal|0x3070
condition|)
block|{
name|run_read
argument_list|(
name|sc
argument_list|,
name|RT3070_EFUSE_CTRL
argument_list|,
operator|&
name|tmp
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"EFUSE_CTRL=0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|&
name|RT3070_SEL_EFUSE
condition|)
name|sc
operator|->
name|sc_srom_read
operator|=
name|run_efuse_read_2
expr_stmt|;
block|}
comment|/* read ROM version */
name|run_srom_read
argument_list|(
name|sc
argument_list|,
name|RT2860_EEPROM_VERSION
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"EEPROM rev=%d, FAE=%d\n"
argument_list|,
name|val
operator|&
literal|0xff
argument_list|,
name|val
operator|>>
literal|8
argument_list|)
expr_stmt|;
comment|/* read MAC address */
name|run_srom_read
argument_list|(
name|sc
argument_list|,
name|RT2860_EEPROM_MAC01
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_bssid
index|[
literal|0
index|]
operator|=
name|val
operator|&
literal|0xff
expr_stmt|;
name|sc
operator|->
name|sc_bssid
index|[
literal|1
index|]
operator|=
name|val
operator|>>
literal|8
expr_stmt|;
name|run_srom_read
argument_list|(
name|sc
argument_list|,
name|RT2860_EEPROM_MAC23
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_bssid
index|[
literal|2
index|]
operator|=
name|val
operator|&
literal|0xff
expr_stmt|;
name|sc
operator|->
name|sc_bssid
index|[
literal|3
index|]
operator|=
name|val
operator|>>
literal|8
expr_stmt|;
name|run_srom_read
argument_list|(
name|sc
argument_list|,
name|RT2860_EEPROM_MAC45
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_bssid
index|[
literal|4
index|]
operator|=
name|val
operator|&
literal|0xff
expr_stmt|;
name|sc
operator|->
name|sc_bssid
index|[
literal|5
index|]
operator|=
name|val
operator|>>
literal|8
expr_stmt|;
comment|/* read vender BBP settings */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|10
condition|;
name|i
operator|++
control|)
block|{
name|run_srom_read
argument_list|(
name|sc
argument_list|,
name|RT2860_EEPROM_BBP_BASE
operator|+
name|i
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|sc
operator|->
name|bbp
index|[
name|i
index|]
operator|.
name|val
operator|=
name|val
operator|&
literal|0xff
expr_stmt|;
name|sc
operator|->
name|bbp
index|[
name|i
index|]
operator|.
name|reg
operator|=
name|val
operator|>>
literal|8
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"BBP%d=0x%02x\n"
argument_list|,
name|sc
operator|->
name|bbp
index|[
name|i
index|]
operator|.
name|reg
argument_list|,
name|sc
operator|->
name|bbp
index|[
name|i
index|]
operator|.
name|val
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|mac_ver
operator|>=
literal|0x3071
condition|)
block|{
comment|/* read vendor RF settings */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|10
condition|;
name|i
operator|++
control|)
block|{
name|run_srom_read
argument_list|(
name|sc
argument_list|,
name|RT3071_EEPROM_RF_BASE
operator|+
name|i
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|sc
operator|->
name|rf
index|[
name|i
index|]
operator|.
name|val
operator|=
name|val
operator|&
literal|0xff
expr_stmt|;
name|sc
operator|->
name|rf
index|[
name|i
index|]
operator|.
name|reg
operator|=
name|val
operator|>>
literal|8
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"RF%d=0x%02x\n"
argument_list|,
name|sc
operator|->
name|rf
index|[
name|i
index|]
operator|.
name|reg
argument_list|,
name|sc
operator|->
name|rf
index|[
name|i
index|]
operator|.
name|val
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* read RF frequency offset from EEPROM */
name|run_srom_read
argument_list|(
name|sc
argument_list|,
name|RT2860_EEPROM_FREQ_LEDS
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|sc
operator|->
name|freq
operator|=
operator|(
operator|(
name|val
operator|&
literal|0xff
operator|)
operator|!=
literal|0xff
operator|)
condition|?
name|val
operator|&
literal|0xff
else|:
literal|0
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"EEPROM freq offset %d\n"
argument_list|,
name|sc
operator|->
name|freq
operator|&
literal|0xff
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|>>
literal|8
operator|!=
literal|0xff
condition|)
block|{
comment|/* read LEDs operating mode */
name|sc
operator|->
name|leds
operator|=
name|val
operator|>>
literal|8
expr_stmt|;
name|run_srom_read
argument_list|(
name|sc
argument_list|,
name|RT2860_EEPROM_LED1
argument_list|,
operator|&
name|sc
operator|->
name|led
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|run_srom_read
argument_list|(
name|sc
argument_list|,
name|RT2860_EEPROM_LED2
argument_list|,
operator|&
name|sc
operator|->
name|led
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|run_srom_read
argument_list|(
name|sc
argument_list|,
name|RT2860_EEPROM_LED3
argument_list|,
operator|&
name|sc
operator|->
name|led
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* broken EEPROM, use default settings */
name|sc
operator|->
name|leds
operator|=
literal|0x01
expr_stmt|;
name|sc
operator|->
name|led
index|[
literal|0
index|]
operator|=
literal|0x5555
expr_stmt|;
name|sc
operator|->
name|led
index|[
literal|1
index|]
operator|=
literal|0x2221
expr_stmt|;
name|sc
operator|->
name|led
index|[
literal|2
index|]
operator|=
literal|0x5627
expr_stmt|;
comment|/* differs from RT2860 */
block|}
name|DPRINTF
argument_list|(
literal|"EEPROM LED mode=0x%02x, LEDs=0x%04x/0x%04x/0x%04x\n"
argument_list|,
name|sc
operator|->
name|leds
argument_list|,
name|sc
operator|->
name|led
index|[
literal|0
index|]
argument_list|,
name|sc
operator|->
name|led
index|[
literal|1
index|]
argument_list|,
name|sc
operator|->
name|led
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
comment|/* read RF information */
name|run_srom_read
argument_list|(
name|sc
argument_list|,
name|RT2860_EEPROM_ANTENNA
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|==
literal|0xffff
condition|)
block|{
name|DPRINTF
argument_list|(
literal|"invalid EEPROM antenna info, using default\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|mac_ver
operator|==
literal|0x3572
condition|)
block|{
comment|/* default to RF3052 2T2R */
name|sc
operator|->
name|rf_rev
operator|=
name|RT3070_RF_3052
expr_stmt|;
name|sc
operator|->
name|ntxchains
operator|=
literal|2
expr_stmt|;
name|sc
operator|->
name|nrxchains
operator|=
literal|2
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sc
operator|->
name|mac_ver
operator|>=
literal|0x3070
condition|)
block|{
comment|/* default to RF3020 1T1R */
name|sc
operator|->
name|rf_rev
operator|=
name|RT3070_RF_3020
expr_stmt|;
name|sc
operator|->
name|ntxchains
operator|=
literal|1
expr_stmt|;
name|sc
operator|->
name|nrxchains
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
comment|/* default to RF2820 1T2R */
name|sc
operator|->
name|rf_rev
operator|=
name|RT2860_RF_2820
expr_stmt|;
name|sc
operator|->
name|ntxchains
operator|=
literal|1
expr_stmt|;
name|sc
operator|->
name|nrxchains
operator|=
literal|2
expr_stmt|;
block|}
block|}
else|else
block|{
name|sc
operator|->
name|rf_rev
operator|=
operator|(
name|val
operator|>>
literal|8
operator|)
operator|&
literal|0xf
expr_stmt|;
name|sc
operator|->
name|ntxchains
operator|=
operator|(
name|val
operator|>>
literal|4
operator|)
operator|&
literal|0xf
expr_stmt|;
name|sc
operator|->
name|nrxchains
operator|=
name|val
operator|&
literal|0xf
expr_stmt|;
block|}
name|DPRINTF
argument_list|(
literal|"EEPROM RF rev=0x%02x chains=%dT%dR\n"
argument_list|,
name|sc
operator|->
name|rf_rev
argument_list|,
name|sc
operator|->
name|ntxchains
argument_list|,
name|sc
operator|->
name|nrxchains
argument_list|)
expr_stmt|;
comment|/* check if RF supports automatic Tx access gain control */
name|run_srom_read
argument_list|(
name|sc
argument_list|,
name|RT2860_EEPROM_CONFIG
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"EEPROM CFG 0x%04x\n"
argument_list|,
name|val
argument_list|)
expr_stmt|;
comment|/* check if driver should patch the DAC issue */
if|if
condition|(
operator|(
name|val
operator|>>
literal|8
operator|)
operator|!=
literal|0xff
condition|)
name|sc
operator|->
name|patch_dac
operator|=
operator|(
name|val
operator|>>
literal|15
operator|)
operator|&
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|val
operator|&
literal|0xff
operator|)
operator|!=
literal|0xff
condition|)
block|{
name|sc
operator|->
name|ext_5ghz_lna
operator|=
operator|(
name|val
operator|>>
literal|3
operator|)
operator|&
literal|1
expr_stmt|;
name|sc
operator|->
name|ext_2ghz_lna
operator|=
operator|(
name|val
operator|>>
literal|2
operator|)
operator|&
literal|1
expr_stmt|;
comment|/* check if RF supports automatic Tx access gain control */
name|sc
operator|->
name|calib_2ghz
operator|=
name|sc
operator|->
name|calib_5ghz
operator|=
operator|(
name|val
operator|>>
literal|1
operator|)
operator|&
literal|1
expr_stmt|;
comment|/* check if we have a hardware radio switch */
name|sc
operator|->
name|rfswitch
operator|=
name|val
operator|&
literal|1
expr_stmt|;
block|}
comment|/* read power settings for 2GHz channels */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|14
condition|;
name|i
operator|+=
literal|2
control|)
block|{
name|run_srom_read
argument_list|(
name|sc
argument_list|,
name|RT2860_EEPROM_PWR2GHZ_BASE1
operator|+
name|i
operator|/
literal|2
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|sc
operator|->
name|txpow1
index|[
name|i
operator|+
literal|0
index|]
operator|=
call|(
name|int8_t
call|)
argument_list|(
name|val
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|sc
operator|->
name|txpow1
index|[
name|i
operator|+
literal|1
index|]
operator|=
call|(
name|int8_t
call|)
argument_list|(
name|val
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|run_srom_read
argument_list|(
name|sc
argument_list|,
name|RT2860_EEPROM_PWR2GHZ_BASE2
operator|+
name|i
operator|/
literal|2
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|sc
operator|->
name|txpow2
index|[
name|i
operator|+
literal|0
index|]
operator|=
call|(
name|int8_t
call|)
argument_list|(
name|val
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|sc
operator|->
name|txpow2
index|[
name|i
operator|+
literal|1
index|]
operator|=
call|(
name|int8_t
call|)
argument_list|(
name|val
operator|>>
literal|8
argument_list|)
expr_stmt|;
block|}
comment|/* fix broken Tx power entries */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|14
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|sc
operator|->
name|txpow1
index|[
name|i
index|]
operator|<
literal|0
operator|||
name|sc
operator|->
name|txpow1
index|[
name|i
index|]
operator|>
literal|31
condition|)
name|sc
operator|->
name|txpow1
index|[
name|i
index|]
operator|=
literal|5
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|txpow2
index|[
name|i
index|]
operator|<
literal|0
operator|||
name|sc
operator|->
name|txpow2
index|[
name|i
index|]
operator|>
literal|31
condition|)
name|sc
operator|->
name|txpow2
index|[
name|i
index|]
operator|=
literal|5
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"chan %d: power1=%d, power2=%d\n"
argument_list|,
name|rt2860_rf2850
index|[
name|i
index|]
operator|.
name|chan
argument_list|,
name|sc
operator|->
name|txpow1
index|[
name|i
index|]
argument_list|,
name|sc
operator|->
name|txpow2
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
comment|/* read power settings for 5GHz channels */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|40
condition|;
name|i
operator|+=
literal|2
control|)
block|{
name|run_srom_read
argument_list|(
name|sc
argument_list|,
name|RT2860_EEPROM_PWR5GHZ_BASE1
operator|+
name|i
operator|/
literal|2
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|sc
operator|->
name|txpow1
index|[
name|i
operator|+
literal|14
index|]
operator|=
call|(
name|int8_t
call|)
argument_list|(
name|val
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|sc
operator|->
name|txpow1
index|[
name|i
operator|+
literal|15
index|]
operator|=
call|(
name|int8_t
call|)
argument_list|(
name|val
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|run_srom_read
argument_list|(
name|sc
argument_list|,
name|RT2860_EEPROM_PWR5GHZ_BASE2
operator|+
name|i
operator|/
literal|2
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|sc
operator|->
name|txpow2
index|[
name|i
operator|+
literal|14
index|]
operator|=
call|(
name|int8_t
call|)
argument_list|(
name|val
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|sc
operator|->
name|txpow2
index|[
name|i
operator|+
literal|15
index|]
operator|=
call|(
name|int8_t
call|)
argument_list|(
name|val
operator|>>
literal|8
argument_list|)
expr_stmt|;
block|}
comment|/* fix broken Tx power entries */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|40
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|sc
operator|->
name|txpow1
index|[
literal|14
operator|+
name|i
index|]
operator|<
operator|-
literal|7
operator|||
name|sc
operator|->
name|txpow1
index|[
literal|14
operator|+
name|i
index|]
operator|>
literal|15
condition|)
name|sc
operator|->
name|txpow1
index|[
literal|14
operator|+
name|i
index|]
operator|=
literal|5
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|txpow2
index|[
literal|14
operator|+
name|i
index|]
operator|<
operator|-
literal|7
operator|||
name|sc
operator|->
name|txpow2
index|[
literal|14
operator|+
name|i
index|]
operator|>
literal|15
condition|)
name|sc
operator|->
name|txpow2
index|[
literal|14
operator|+
name|i
index|]
operator|=
literal|5
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"chan %d: power1=%d, power2=%d\n"
argument_list|,
name|rt2860_rf2850
index|[
literal|14
operator|+
name|i
index|]
operator|.
name|chan
argument_list|,
name|sc
operator|->
name|txpow1
index|[
literal|14
operator|+
name|i
index|]
argument_list|,
name|sc
operator|->
name|txpow2
index|[
literal|14
operator|+
name|i
index|]
argument_list|)
expr_stmt|;
block|}
comment|/* read Tx power compensation for each Tx rate */
name|run_srom_read
argument_list|(
name|sc
argument_list|,
name|RT2860_EEPROM_DELTAPWR
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|delta_2ghz
operator|=
name|delta_5ghz
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|val
operator|&
literal|0xff
operator|)
operator|!=
literal|0xff
operator|&&
operator|(
name|val
operator|&
literal|0x80
operator|)
condition|)
block|{
name|delta_2ghz
operator|=
name|val
operator|&
literal|0xf
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|val
operator|&
literal|0x40
operator|)
condition|)
comment|/* negative number */
name|delta_2ghz
operator|=
operator|-
name|delta_2ghz
expr_stmt|;
block|}
name|val
operator|>>=
literal|8
expr_stmt|;
if|if
condition|(
operator|(
name|val
operator|&
literal|0xff
operator|)
operator|!=
literal|0xff
operator|&&
operator|(
name|val
operator|&
literal|0x80
operator|)
condition|)
block|{
name|delta_5ghz
operator|=
name|val
operator|&
literal|0xf
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|val
operator|&
literal|0x40
operator|)
condition|)
comment|/* negative number */
name|delta_5ghz
operator|=
operator|-
name|delta_5ghz
expr_stmt|;
block|}
name|DPRINTF
argument_list|(
literal|"power compensation=%d (2GHz), %d (5GHz)\n"
argument_list|,
name|delta_2ghz
argument_list|,
name|delta_5ghz
argument_list|)
expr_stmt|;
for|for
control|(
name|ridx
operator|=
literal|0
init|;
name|ridx
operator|<
literal|5
condition|;
name|ridx
operator|++
control|)
block|{
name|uint32_t
name|reg
decl_stmt|;
name|run_srom_read
argument_list|(
name|sc
argument_list|,
name|RT2860_EEPROM_RPWR
operator|+
name|ridx
operator|*
literal|2
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|reg
operator|=
name|val
expr_stmt|;
name|run_srom_read
argument_list|(
name|sc
argument_list|,
name|RT2860_EEPROM_RPWR
operator|+
name|ridx
operator|*
literal|2
operator|+
literal|1
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|reg
operator||=
operator|(
name|uint32_t
operator|)
name|val
operator|<<
literal|16
expr_stmt|;
name|sc
operator|->
name|txpow20mhz
index|[
name|ridx
index|]
operator|=
name|reg
expr_stmt|;
name|sc
operator|->
name|txpow40mhz_2ghz
index|[
name|ridx
index|]
operator|=
name|b4inc
argument_list|(
name|reg
argument_list|,
name|delta_2ghz
argument_list|)
expr_stmt|;
name|sc
operator|->
name|txpow40mhz_5ghz
index|[
name|ridx
index|]
operator|=
name|b4inc
argument_list|(
name|reg
argument_list|,
name|delta_5ghz
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"ridx %d: power 20MHz=0x%08x, 40MHz/2GHz=0x%08x, "
literal|"40MHz/5GHz=0x%08x\n"
argument_list|,
name|ridx
argument_list|,
name|sc
operator|->
name|txpow20mhz
index|[
name|ridx
index|]
argument_list|,
name|sc
operator|->
name|txpow40mhz_2ghz
index|[
name|ridx
index|]
argument_list|,
name|sc
operator|->
name|txpow40mhz_5ghz
index|[
name|ridx
index|]
argument_list|)
expr_stmt|;
block|}
comment|/* read RSSI offsets and LNA gains from EEPROM */
name|run_srom_read
argument_list|(
name|sc
argument_list|,
name|RT2860_EEPROM_RSSI1_2GHZ
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|sc
operator|->
name|rssi_2ghz
index|[
literal|0
index|]
operator|=
name|val
operator|&
literal|0xff
expr_stmt|;
comment|/* Ant A */
name|sc
operator|->
name|rssi_2ghz
index|[
literal|1
index|]
operator|=
name|val
operator|>>
literal|8
expr_stmt|;
comment|/* Ant B */
name|run_srom_read
argument_list|(
name|sc
argument_list|,
name|RT2860_EEPROM_RSSI2_2GHZ
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|mac_ver
operator|>=
literal|0x3070
condition|)
block|{
comment|/* 		 * On RT3070 chips (limited to 2 Rx chains), this ROM 		 * field contains the Tx mixer gain for the 2GHz band. 		 */
if|if
condition|(
operator|(
name|val
operator|&
literal|0xff
operator|)
operator|!=
literal|0xff
condition|)
name|sc
operator|->
name|txmixgain_2ghz
operator|=
name|val
operator|&
literal|0x7
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"tx mixer gain=%u (2GHz)\n"
argument_list|,
name|sc
operator|->
name|txmixgain_2ghz
argument_list|)
expr_stmt|;
block|}
else|else
name|sc
operator|->
name|rssi_2ghz
index|[
literal|2
index|]
operator|=
name|val
operator|&
literal|0xff
expr_stmt|;
comment|/* Ant C */
name|sc
operator|->
name|lna
index|[
literal|2
index|]
operator|=
name|val
operator|>>
literal|8
expr_stmt|;
comment|/* channel group 2 */
name|run_srom_read
argument_list|(
name|sc
argument_list|,
name|RT2860_EEPROM_RSSI1_5GHZ
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|sc
operator|->
name|rssi_5ghz
index|[
literal|0
index|]
operator|=
name|val
operator|&
literal|0xff
expr_stmt|;
comment|/* Ant A */
name|sc
operator|->
name|rssi_5ghz
index|[
literal|1
index|]
operator|=
name|val
operator|>>
literal|8
expr_stmt|;
comment|/* Ant B */
name|run_srom_read
argument_list|(
name|sc
argument_list|,
name|RT2860_EEPROM_RSSI2_5GHZ
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|mac_ver
operator|==
literal|0x3572
condition|)
block|{
comment|/* 		 * On RT3572 chips (limited to 2 Rx chains), this ROM 		 * field contains the Tx mixer gain for the 5GHz band. 		 */
if|if
condition|(
operator|(
name|val
operator|&
literal|0xff
operator|)
operator|!=
literal|0xff
condition|)
name|sc
operator|->
name|txmixgain_5ghz
operator|=
name|val
operator|&
literal|0x7
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"tx mixer gain=%u (5GHz)\n"
argument_list|,
name|sc
operator|->
name|txmixgain_5ghz
argument_list|)
expr_stmt|;
block|}
else|else
name|sc
operator|->
name|rssi_5ghz
index|[
literal|2
index|]
operator|=
name|val
operator|&
literal|0xff
expr_stmt|;
comment|/* Ant C */
name|sc
operator|->
name|lna
index|[
literal|3
index|]
operator|=
name|val
operator|>>
literal|8
expr_stmt|;
comment|/* channel group 3 */
name|run_srom_read
argument_list|(
name|sc
argument_list|,
name|RT2860_EEPROM_LNA
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|sc
operator|->
name|lna
index|[
literal|0
index|]
operator|=
name|val
operator|&
literal|0xff
expr_stmt|;
comment|/* channel group 0 */
name|sc
operator|->
name|lna
index|[
literal|1
index|]
operator|=
name|val
operator|>>
literal|8
expr_stmt|;
comment|/* channel group 1 */
comment|/* fix broken 5GHz LNA entries */
if|if
condition|(
name|sc
operator|->
name|lna
index|[
literal|2
index|]
operator|==
literal|0
operator|||
name|sc
operator|->
name|lna
index|[
literal|2
index|]
operator|==
literal|0xff
condition|)
block|{
name|DPRINTF
argument_list|(
literal|"invalid LNA for channel group %d\n"
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|sc
operator|->
name|lna
index|[
literal|2
index|]
operator|=
name|sc
operator|->
name|lna
index|[
literal|1
index|]
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|lna
index|[
literal|3
index|]
operator|==
literal|0
operator|||
name|sc
operator|->
name|lna
index|[
literal|3
index|]
operator|==
literal|0xff
condition|)
block|{
name|DPRINTF
argument_list|(
literal|"invalid LNA for channel group %d\n"
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|sc
operator|->
name|lna
index|[
literal|3
index|]
operator|=
name|sc
operator|->
name|lna
index|[
literal|1
index|]
expr_stmt|;
block|}
comment|/* fix broken RSSI offset entries */
for|for
control|(
name|ant
operator|=
literal|0
init|;
name|ant
operator|<
literal|3
condition|;
name|ant
operator|++
control|)
block|{
if|if
condition|(
name|sc
operator|->
name|rssi_2ghz
index|[
name|ant
index|]
operator|<
operator|-
literal|10
operator|||
name|sc
operator|->
name|rssi_2ghz
index|[
name|ant
index|]
operator|>
literal|10
condition|)
block|{
name|DPRINTF
argument_list|(
literal|"invalid RSSI%d offset: %d (2GHz)\n"
argument_list|,
name|ant
operator|+
literal|1
argument_list|,
name|sc
operator|->
name|rssi_2ghz
index|[
name|ant
index|]
argument_list|)
expr_stmt|;
name|sc
operator|->
name|rssi_2ghz
index|[
name|ant
index|]
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|rssi_5ghz
index|[
name|ant
index|]
operator|<
operator|-
literal|10
operator|||
name|sc
operator|->
name|rssi_5ghz
index|[
name|ant
index|]
operator|>
literal|10
condition|)
block|{
name|DPRINTF
argument_list|(
literal|"invalid RSSI%d offset: %d (5GHz)\n"
argument_list|,
name|ant
operator|+
literal|1
argument_list|,
name|sc
operator|->
name|rssi_5ghz
index|[
name|ant
index|]
argument_list|)
expr_stmt|;
name|sc
operator|->
name|rssi_5ghz
index|[
name|ant
index|]
operator|=
literal|0
expr_stmt|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|struct
name|ieee80211_node
modifier|*
name|run_node_alloc
parameter_list|(
name|struct
name|ieee80211vap
modifier|*
name|vap
parameter_list|,
specifier|const
name|uint8_t
name|mac
index|[
name|IEEE80211_ADDR_LEN
index|]
parameter_list|)
block|{
return|return
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|run_node
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|run_media_change
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|struct
name|ieee80211vap
modifier|*
name|vap
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|vap
operator|->
name|iv_ic
decl_stmt|;
specifier|const
name|struct
name|ieee80211_txparam
modifier|*
name|tp
decl_stmt|;
name|struct
name|run_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|run_node
modifier|*
name|rn
init|=
operator|(
name|void
operator|*
operator|)
name|vap
operator|->
name|iv_bss
decl_stmt|;
name|uint8_t
name|rate
decl_stmt|,
name|ridx
decl_stmt|;
name|int
name|error
decl_stmt|;
name|RUN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|error
operator|=
name|ieee80211_media_change
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|ENETRESET
condition|)
block|{
name|RUN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|tp
operator|=
operator|&
name|vap
operator|->
name|iv_txparms
index|[
name|ieee80211_chan2mode
argument_list|(
name|ic
operator|->
name|ic_curchan
argument_list|)
index|]
expr_stmt|;
if|if
condition|(
name|tp
operator|->
name|ucastrate
operator|!=
name|IEEE80211_FIXED_RATE_NONE
condition|)
block|{
name|rate
operator|=
name|ic
operator|->
name|ic_sup_rates
index|[
name|ic
operator|->
name|ic_curmode
index|]
operator|.
name|rs_rates
index|[
name|tp
operator|->
name|ucastrate
index|]
operator|&
name|IEEE80211_RATE_VAL
expr_stmt|;
for|for
control|(
name|ridx
operator|=
literal|0
init|;
name|ridx
operator|<
name|RT2860_RIDX_MAX
condition|;
name|ridx
operator|++
control|)
if|if
condition|(
name|rt2860_rates
index|[
name|ridx
index|]
operator|.
name|rate
operator|==
name|rate
condition|)
break|break;
name|rn
operator|->
name|fix_ridx
operator|=
name|ridx
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"rate=%d, fix_ridx=%d\n"
argument_list|,
name|rate
argument_list|,
name|rn
operator|->
name|fix_ridx
argument_list|)
expr_stmt|;
block|}
if|#
directive|if
literal|0
block|if ((ifp->if_flags& IFF_UP)&& 	    (ifp->if_drv_flags&  IFF_DRV_RUNNING)){ 		run_init_locked(sc); 	}
endif|#
directive|endif
name|RUN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|run_newstate
parameter_list|(
name|struct
name|ieee80211vap
modifier|*
name|vap
parameter_list|,
name|enum
name|ieee80211_state
name|nstate
parameter_list|,
name|int
name|arg
parameter_list|)
block|{
specifier|const
name|struct
name|ieee80211_txparam
modifier|*
name|tp
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|vap
operator|->
name|iv_ic
decl_stmt|;
name|struct
name|run_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|run_vap
modifier|*
name|rvp
init|=
name|RUN_VAP
argument_list|(
name|vap
argument_list|)
decl_stmt|;
name|enum
name|ieee80211_state
name|ostate
decl_stmt|;
name|struct
name|ieee80211_node
modifier|*
name|ni
decl_stmt|;
name|uint32_t
name|sta
index|[
literal|3
index|]
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
name|uint8_t
name|ratectl
decl_stmt|;
name|uint8_t
name|restart_ratectl
init|=
literal|0
decl_stmt|;
name|uint8_t
name|bid
init|=
literal|1
operator|<<
name|rvp
operator|->
name|rvp_id
decl_stmt|;
name|ostate
operator|=
name|vap
operator|->
name|iv_state
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"%s -> %s\n"
argument_list|,
name|ieee80211_state_name
index|[
name|ostate
index|]
argument_list|,
name|ieee80211_state_name
index|[
name|nstate
index|]
argument_list|)
expr_stmt|;
name|IEEE80211_UNLOCK
argument_list|(
name|ic
argument_list|)
expr_stmt|;
name|RUN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ratectl
operator|=
name|sc
operator|->
name|ratectl_run
expr_stmt|;
comment|/* remember current state */
name|sc
operator|->
name|ratectl_run
operator|=
name|RUN_RATECTL_OFF
expr_stmt|;
name|usb_callout_stop
argument_list|(
operator|&
name|sc
operator|->
name|ratectl_ch
argument_list|)
expr_stmt|;
if|if
condition|(
name|ostate
operator|==
name|IEEE80211_S_RUN
condition|)
block|{
comment|/* turn link LED off */
name|run_set_leds
argument_list|(
name|sc
argument_list|,
name|RT2860_LED_RADIO
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|nstate
condition|)
block|{
case|case
name|IEEE80211_S_INIT
case|:
name|restart_ratectl
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|ostate
operator|!=
name|IEEE80211_S_RUN
condition|)
break|break;
name|ratectl
operator|&=
operator|~
name|bid
expr_stmt|;
name|sc
operator|->
name|runbmap
operator|&=
operator|~
name|bid
expr_stmt|;
comment|/* abort TSF synchronization if there is no vap running */
if|if
condition|(
operator|--
name|sc
operator|->
name|running
operator|==
literal|0
condition|)
block|{
name|run_read
argument_list|(
name|sc
argument_list|,
name|RT2860_BCN_TIME_CFG
argument_list|,
operator|&
name|tmp
argument_list|)
expr_stmt|;
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_BCN_TIME_CFG
argument_list|,
name|tmp
operator|&
operator|~
operator|(
name|RT2860_BCN_TX_EN
operator||
name|RT2860_TSF_TIMER_EN
operator||
name|RT2860_TBTT_TIMER_EN
operator|)
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|IEEE80211_S_RUN
case|:
name|ni
operator|=
name|vap
operator|->
name|iv_bss
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|sc
operator|->
name|runbmap
operator|&
name|bid
operator|)
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|running
operator|++
condition|)
name|restart_ratectl
operator|=
literal|1
expr_stmt|;
name|sc
operator|->
name|runbmap
operator||=
name|bid
expr_stmt|;
block|}
switch|switch
condition|(
name|vap
operator|->
name|iv_opmode
condition|)
block|{
case|case
name|IEEE80211_M_HOSTAP
case|:
case|case
name|IEEE80211_M_MBSS
case|:
name|sc
operator|->
name|ap_running
operator||=
name|bid
expr_stmt|;
name|ic
operator|->
name|ic_opmode
operator|=
name|vap
operator|->
name|iv_opmode
expr_stmt|;
name|run_update_beacon_cb
argument_list|(
name|vap
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_M_IBSS
case|:
name|sc
operator|->
name|adhoc_running
operator||=
name|bid
expr_stmt|;
if|if
condition|(
operator|!
name|sc
operator|->
name|ap_running
condition|)
name|ic
operator|->
name|ic_opmode
operator|=
name|vap
operator|->
name|iv_opmode
expr_stmt|;
name|run_update_beacon_cb
argument_list|(
name|vap
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_M_STA
case|:
name|sc
operator|->
name|sta_running
operator||=
name|bid
expr_stmt|;
if|if
condition|(
operator|!
name|sc
operator|->
name|ap_running
operator|&&
operator|!
name|sc
operator|->
name|adhoc_running
condition|)
name|ic
operator|->
name|ic_opmode
operator|=
name|vap
operator|->
name|iv_opmode
expr_stmt|;
comment|/* read statistic counters (clear on read) */
name|run_read_region_1
argument_list|(
name|sc
argument_list|,
name|RT2860_TX_STA_CNT0
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
name|sta
argument_list|,
sizeof|sizeof
name|sta
argument_list|)
expr_stmt|;
break|break;
default|default:
name|ic
operator|->
name|ic_opmode
operator|=
name|vap
operator|->
name|iv_opmode
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|vap
operator|->
name|iv_opmode
operator|!=
name|IEEE80211_M_MONITOR
condition|)
block|{
name|run_updateslot
argument_list|(
name|ic
operator|->
name|ic_ifp
argument_list|)
expr_stmt|;
name|run_enable_mrr
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|run_set_txpreamble
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|run_set_basicrates
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|IEEE80211_ADDR_COPY
argument_list|(
name|sc
operator|->
name|sc_bssid
argument_list|,
name|ni
operator|->
name|ni_bssid
argument_list|)
expr_stmt|;
name|run_set_bssid
argument_list|(
name|sc
argument_list|,
name|ni
operator|->
name|ni_bssid
argument_list|)
expr_stmt|;
name|run_enable_tsf_sync
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* enable automatic rate adaptation */
name|tp
operator|=
operator|&
name|vap
operator|->
name|iv_txparms
index|[
name|ieee80211_chan2mode
argument_list|(
name|ic
operator|->
name|ic_curchan
argument_list|)
index|]
expr_stmt|;
if|if
condition|(
name|tp
operator|->
name|ucastrate
operator|==
name|IEEE80211_FIXED_RATE_NONE
condition|)
name|ratectl
operator||=
name|bid
expr_stmt|;
block|}
comment|/* turn link LED on */
name|run_set_leds
argument_list|(
name|sc
argument_list|,
name|RT2860_LED_RADIO
operator||
operator|(
name|IEEE80211_IS_CHAN_2GHZ
argument_list|(
name|ic
operator|->
name|ic_curchan
argument_list|)
condition|?
name|RT2860_LED_LINK_2GHZ
else|:
name|RT2860_LED_LINK_5GHZ
operator|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|DPRINTFN
argument_list|(
literal|6
argument_list|,
literal|"undefined case\n"
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* restart amrr for running VAPs */
if|if
condition|(
operator|(
name|sc
operator|->
name|ratectl_run
operator|=
name|ratectl
operator|)
operator|&&
name|restart_ratectl
condition|)
name|usb_callout_reset
argument_list|(
operator|&
name|sc
operator|->
name|ratectl_ch
argument_list|,
name|hz
argument_list|,
name|run_ratectl_to
argument_list|,
name|sc
argument_list|)
expr_stmt|;
name|RUN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|IEEE80211_LOCK
argument_list|(
name|ic
argument_list|)
expr_stmt|;
return|return
operator|(
name|rvp
operator|->
name|newstate
argument_list|(
name|vap
argument_list|,
name|nstate
argument_list|,
name|arg
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|void
name|run_wme_update_cb
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|arg
decl_stmt|;
name|struct
name|run_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|ieee80211_wme_state
modifier|*
name|wmesp
init|=
operator|&
name|ic
operator|->
name|ic_wme
decl_stmt|;
name|int
name|aci
decl_stmt|,
name|error
init|=
literal|0
decl_stmt|;
name|RUN_LOCK_ASSERT
argument_list|(
name|sc
argument_list|,
name|MA_OWNED
argument_list|)
expr_stmt|;
comment|/* update MAC TX configuration registers */
for|for
control|(
name|aci
operator|=
literal|0
init|;
name|aci
operator|<
name|WME_NUM_AC
condition|;
name|aci
operator|++
control|)
block|{
name|error
operator|=
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_EDCA_AC_CFG
argument_list|(
name|aci
argument_list|)
argument_list|,
name|wmesp
operator|->
name|wme_params
index|[
name|aci
index|]
operator|.
name|wmep_logcwmax
operator|<<
literal|16
operator||
name|wmesp
operator|->
name|wme_params
index|[
name|aci
index|]
operator|.
name|wmep_logcwmin
operator|<<
literal|12
operator||
name|wmesp
operator|->
name|wme_params
index|[
name|aci
index|]
operator|.
name|wmep_aifsn
operator|<<
literal|8
operator||
name|wmesp
operator|->
name|wme_params
index|[
name|aci
index|]
operator|.
name|wmep_txopLimit
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|err
goto|;
block|}
comment|/* update SCH/DMA registers too */
name|error
operator|=
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_WMM_AIFSN_CFG
argument_list|,
name|wmesp
operator|->
name|wme_params
index|[
name|WME_AC_VO
index|]
operator|.
name|wmep_aifsn
operator|<<
literal|12
operator||
name|wmesp
operator|->
name|wme_params
index|[
name|WME_AC_VI
index|]
operator|.
name|wmep_aifsn
operator|<<
literal|8
operator||
name|wmesp
operator|->
name|wme_params
index|[
name|WME_AC_BK
index|]
operator|.
name|wmep_aifsn
operator|<<
literal|4
operator||
name|wmesp
operator|->
name|wme_params
index|[
name|WME_AC_BE
index|]
operator|.
name|wmep_aifsn
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|err
goto|;
name|error
operator|=
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_WMM_CWMIN_CFG
argument_list|,
name|wmesp
operator|->
name|wme_params
index|[
name|WME_AC_VO
index|]
operator|.
name|wmep_logcwmin
operator|<<
literal|12
operator||
name|wmesp
operator|->
name|wme_params
index|[
name|WME_AC_VI
index|]
operator|.
name|wmep_logcwmin
operator|<<
literal|8
operator||
name|wmesp
operator|->
name|wme_params
index|[
name|WME_AC_BK
index|]
operator|.
name|wmep_logcwmin
operator|<<
literal|4
operator||
name|wmesp
operator|->
name|wme_params
index|[
name|WME_AC_BE
index|]
operator|.
name|wmep_logcwmin
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|err
goto|;
name|error
operator|=
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_WMM_CWMAX_CFG
argument_list|,
name|wmesp
operator|->
name|wme_params
index|[
name|WME_AC_VO
index|]
operator|.
name|wmep_logcwmax
operator|<<
literal|12
operator||
name|wmesp
operator|->
name|wme_params
index|[
name|WME_AC_VI
index|]
operator|.
name|wmep_logcwmax
operator|<<
literal|8
operator||
name|wmesp
operator|->
name|wme_params
index|[
name|WME_AC_BK
index|]
operator|.
name|wmep_logcwmax
operator|<<
literal|4
operator||
name|wmesp
operator|->
name|wme_params
index|[
name|WME_AC_BE
index|]
operator|.
name|wmep_logcwmax
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|err
goto|;
name|error
operator|=
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_WMM_TXOP0_CFG
argument_list|,
name|wmesp
operator|->
name|wme_params
index|[
name|WME_AC_BK
index|]
operator|.
name|wmep_txopLimit
operator|<<
literal|16
operator||
name|wmesp
operator|->
name|wme_params
index|[
name|WME_AC_BE
index|]
operator|.
name|wmep_txopLimit
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|err
goto|;
name|error
operator|=
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_WMM_TXOP1_CFG
argument_list|,
name|wmesp
operator|->
name|wme_params
index|[
name|WME_AC_VO
index|]
operator|.
name|wmep_txopLimit
operator|<<
literal|16
operator||
name|wmesp
operator|->
name|wme_params
index|[
name|WME_AC_VI
index|]
operator|.
name|wmep_txopLimit
argument_list|)
expr_stmt|;
name|err
label|:
if|if
condition|(
name|error
condition|)
name|DPRINTF
argument_list|(
literal|"WME update failed\n"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|run_wme_update
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|)
block|{
name|struct
name|run_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_ifp
operator|->
name|if_softc
decl_stmt|;
comment|/* sometime called wothout lock */
if|if
condition|(
name|mtx_owned
argument_list|(
operator|&
name|ic
operator|->
name|ic_comlock
operator|.
name|mtx
argument_list|)
condition|)
block|{
name|uint32_t
name|i
init|=
name|RUN_CMDQ_GET
argument_list|(
operator|&
name|sc
operator|->
name|cmdq_store
argument_list|)
decl_stmt|;
name|DPRINTF
argument_list|(
literal|"cmdq_store=%d\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|sc
operator|->
name|cmdq
index|[
name|i
index|]
operator|.
name|func
operator|=
name|run_wme_update_cb
expr_stmt|;
name|sc
operator|->
name|cmdq
index|[
name|i
index|]
operator|.
name|arg0
operator|=
name|ic
expr_stmt|;
name|ieee80211_runtask
argument_list|(
name|ic
argument_list|,
operator|&
name|sc
operator|->
name|cmdq_task
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|RUN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|run_wme_update_cb
argument_list|(
name|ic
argument_list|)
expr_stmt|;
name|RUN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* return whatever, upper layer desn't care anyway */
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|run_key_update_begin
parameter_list|(
name|struct
name|ieee80211vap
modifier|*
name|vap
parameter_list|)
block|{
comment|/* 	 * To avoid out-of-order events, both run_key_set() and 	 * _delete() are deferred and handled by run_cmdq_cb(). 	 * So, there is nothing we need to do here. 	 */
block|}
end_function

begin_function
specifier|static
name|void
name|run_key_update_end
parameter_list|(
name|struct
name|ieee80211vap
modifier|*
name|vap
parameter_list|)
block|{
comment|/* null */
block|}
end_function

begin_function
specifier|static
name|void
name|run_key_set_cb
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|run_cmdq
modifier|*
name|cmdq
init|=
name|arg
decl_stmt|;
name|struct
name|ieee80211vap
modifier|*
name|vap
init|=
name|cmdq
operator|->
name|arg1
decl_stmt|;
name|struct
name|ieee80211_key
modifier|*
name|k
init|=
name|cmdq
operator|->
name|k
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|vap
operator|->
name|iv_ic
decl_stmt|;
name|struct
name|run_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|ieee80211_node
modifier|*
name|ni
decl_stmt|;
name|uint32_t
name|attr
decl_stmt|;
name|uint16_t
name|base
decl_stmt|,
name|associd
decl_stmt|;
name|uint8_t
name|mode
decl_stmt|,
name|wcid
decl_stmt|,
name|iv
index|[
literal|8
index|]
decl_stmt|;
name|RUN_LOCK_ASSERT
argument_list|(
name|sc
argument_list|,
name|MA_OWNED
argument_list|)
expr_stmt|;
if|if
condition|(
name|vap
operator|->
name|iv_opmode
operator|==
name|IEEE80211_M_HOSTAP
condition|)
name|ni
operator|=
name|ieee80211_find_vap_node
argument_list|(
operator|&
name|ic
operator|->
name|ic_sta
argument_list|,
name|vap
argument_list|,
name|cmdq
operator|->
name|mac
argument_list|)
expr_stmt|;
else|else
name|ni
operator|=
name|vap
operator|->
name|iv_bss
expr_stmt|;
name|associd
operator|=
operator|(
name|ni
operator|!=
name|NULL
operator|)
condition|?
name|ni
operator|->
name|ni_associd
else|:
literal|0
expr_stmt|;
comment|/* map net80211 cipher to RT2860 security mode */
switch|switch
condition|(
name|k
operator|->
name|wk_cipher
operator|->
name|ic_cipher
condition|)
block|{
case|case
name|IEEE80211_CIPHER_WEP
case|:
if|if
condition|(
name|k
operator|->
name|wk_keylen
operator|<
literal|8
condition|)
name|mode
operator|=
name|RT2860_MODE_WEP40
expr_stmt|;
else|else
name|mode
operator|=
name|RT2860_MODE_WEP104
expr_stmt|;
break|break;
case|case
name|IEEE80211_CIPHER_TKIP
case|:
name|mode
operator|=
name|RT2860_MODE_TKIP
expr_stmt|;
break|break;
case|case
name|IEEE80211_CIPHER_AES_CCM
case|:
name|mode
operator|=
name|RT2860_MODE_AES_CCMP
expr_stmt|;
break|break;
default|default:
name|DPRINTF
argument_list|(
literal|"undefined case\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|DPRINTFN
argument_list|(
literal|1
argument_list|,
literal|"associd=%x, keyix=%d, mode=%x, type=%s, tx=%s, rx=%s\n"
argument_list|,
name|associd
argument_list|,
name|k
operator|->
name|wk_keyix
argument_list|,
name|mode
argument_list|,
operator|(
name|k
operator|->
name|wk_flags
operator|&
name|IEEE80211_KEY_GROUP
operator|)
condition|?
literal|"group"
else|:
literal|"pairwise"
argument_list|,
operator|(
name|k
operator|->
name|wk_flags
operator|&
name|IEEE80211_KEY_XMIT
operator|)
condition|?
literal|"on"
else|:
literal|"off"
argument_list|,
operator|(
name|k
operator|->
name|wk_flags
operator|&
name|IEEE80211_KEY_RECV
operator|)
condition|?
literal|"on"
else|:
literal|"off"
argument_list|)
expr_stmt|;
if|if
condition|(
name|k
operator|->
name|wk_flags
operator|&
name|IEEE80211_KEY_GROUP
condition|)
block|{
name|wcid
operator|=
literal|0
expr_stmt|;
comment|/* NB: update WCID0 for group keys */
name|base
operator|=
name|RT2860_SKEY
argument_list|(
name|RUN_VAP
argument_list|(
name|vap
argument_list|)
operator|->
name|rvp_id
argument_list|,
name|k
operator|->
name|wk_keyix
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wcid
operator|=
name|RUN_AID2WCID
argument_list|(
name|associd
argument_list|)
expr_stmt|;
name|base
operator|=
name|RT2860_PKEY
argument_list|(
name|wcid
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|k
operator|->
name|wk_cipher
operator|->
name|ic_cipher
operator|==
name|IEEE80211_CIPHER_TKIP
condition|)
block|{
if|if
condition|(
name|run_write_region_1
argument_list|(
name|sc
argument_list|,
name|base
argument_list|,
name|k
operator|->
name|wk_key
argument_list|,
literal|16
argument_list|)
condition|)
return|return;
if|if
condition|(
name|run_write_region_1
argument_list|(
name|sc
argument_list|,
name|base
operator|+
literal|16
argument_list|,
operator|&
name|k
operator|->
name|wk_key
index|[
literal|16
index|]
argument_list|,
literal|8
argument_list|)
condition|)
comment|/* wk_txmic */
return|return;
if|if
condition|(
name|run_write_region_1
argument_list|(
name|sc
argument_list|,
name|base
operator|+
literal|24
argument_list|,
operator|&
name|k
operator|->
name|wk_key
index|[
literal|24
index|]
argument_list|,
literal|8
argument_list|)
condition|)
comment|/* wk_rxmic */
return|return;
block|}
else|else
block|{
comment|/* roundup len to 16-bit: XXX fix write_region_1() instead */
if|if
condition|(
name|run_write_region_1
argument_list|(
name|sc
argument_list|,
name|base
argument_list|,
name|k
operator|->
name|wk_key
argument_list|,
operator|(
name|k
operator|->
name|wk_keylen
operator|+
literal|1
operator|)
operator|&
operator|~
literal|1
argument_list|)
condition|)
return|return;
block|}
if|if
condition|(
operator|!
operator|(
name|k
operator|->
name|wk_flags
operator|&
name|IEEE80211_KEY_GROUP
operator|)
operator|||
operator|(
name|k
operator|->
name|wk_flags
operator|&
operator|(
name|IEEE80211_KEY_XMIT
operator||
name|IEEE80211_KEY_RECV
operator|)
operator|)
condition|)
block|{
comment|/* set initial packet number in IV+EIV */
if|if
condition|(
name|k
operator|->
name|wk_cipher
operator|==
name|IEEE80211_CIPHER_WEP
condition|)
block|{
name|memset
argument_list|(
name|iv
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|iv
argument_list|)
expr_stmt|;
name|iv
index|[
literal|3
index|]
operator|=
name|vap
operator|->
name|iv_def_txkey
operator|<<
literal|6
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|k
operator|->
name|wk_cipher
operator|->
name|ic_cipher
operator|==
name|IEEE80211_CIPHER_TKIP
condition|)
block|{
name|iv
index|[
literal|0
index|]
operator|=
name|k
operator|->
name|wk_keytsc
operator|>>
literal|8
expr_stmt|;
name|iv
index|[
literal|1
index|]
operator|=
operator|(
name|iv
index|[
literal|0
index|]
operator||
literal|0x20
operator|)
operator|&
literal|0x7f
expr_stmt|;
name|iv
index|[
literal|2
index|]
operator|=
name|k
operator|->
name|wk_keytsc
expr_stmt|;
block|}
else|else
comment|/* CCMP */
block|{
name|iv
index|[
literal|0
index|]
operator|=
name|k
operator|->
name|wk_keytsc
expr_stmt|;
name|iv
index|[
literal|1
index|]
operator|=
name|k
operator|->
name|wk_keytsc
operator|>>
literal|8
expr_stmt|;
name|iv
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
block|}
name|iv
index|[
literal|3
index|]
operator|=
name|k
operator|->
name|wk_keyix
operator|<<
literal|6
operator||
name|IEEE80211_WEP_EXTIV
expr_stmt|;
name|iv
index|[
literal|4
index|]
operator|=
name|k
operator|->
name|wk_keytsc
operator|>>
literal|16
expr_stmt|;
name|iv
index|[
literal|5
index|]
operator|=
name|k
operator|->
name|wk_keytsc
operator|>>
literal|24
expr_stmt|;
name|iv
index|[
literal|6
index|]
operator|=
name|k
operator|->
name|wk_keytsc
operator|>>
literal|32
expr_stmt|;
name|iv
index|[
literal|7
index|]
operator|=
name|k
operator|->
name|wk_keytsc
operator|>>
literal|40
expr_stmt|;
block|}
if|if
condition|(
name|run_write_region_1
argument_list|(
name|sc
argument_list|,
name|RT2860_IVEIV
argument_list|(
name|wcid
argument_list|)
argument_list|,
name|iv
argument_list|,
literal|8
argument_list|)
condition|)
return|return;
block|}
if|if
condition|(
name|k
operator|->
name|wk_flags
operator|&
name|IEEE80211_KEY_GROUP
condition|)
block|{
comment|/* install group key */
if|if
condition|(
name|run_read
argument_list|(
name|sc
argument_list|,
name|RT2860_SKEY_MODE_0_7
argument_list|,
operator|&
name|attr
argument_list|)
condition|)
return|return;
name|attr
operator|&=
operator|~
operator|(
literal|0xf
operator|<<
operator|(
name|k
operator|->
name|wk_keyix
operator|*
literal|4
operator|)
operator|)
expr_stmt|;
name|attr
operator||=
name|mode
operator|<<
operator|(
name|k
operator|->
name|wk_keyix
operator|*
literal|4
operator|)
expr_stmt|;
if|if
condition|(
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_SKEY_MODE_0_7
argument_list|,
name|attr
argument_list|)
condition|)
return|return;
block|}
else|else
block|{
comment|/* install pairwise key */
if|if
condition|(
name|run_read
argument_list|(
name|sc
argument_list|,
name|RT2860_WCID_ATTR
argument_list|(
name|wcid
argument_list|)
argument_list|,
operator|&
name|attr
argument_list|)
condition|)
return|return;
name|attr
operator|=
operator|(
name|attr
operator|&
operator|~
literal|0xf
operator|)
operator||
operator|(
name|mode
operator|<<
literal|1
operator|)
operator||
name|RT2860_RX_PKEY_EN
expr_stmt|;
if|if
condition|(
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_WCID_ATTR
argument_list|(
name|wcid
argument_list|)
argument_list|,
name|attr
argument_list|)
condition|)
return|return;
block|}
comment|/* TODO create a pass-thru key entry? */
comment|/* need wcid to delete the right key later */
name|k
operator|->
name|wk_pad
operator|=
name|wcid
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Don't have to be deferred, but in order to keep order of  * execution, i.e. with run_key_delete(), defer this and let  * run_cmdq_cb() maintain the order.  *  * return 0 on error  */
end_comment

begin_function
specifier|static
name|int
name|run_key_set
parameter_list|(
name|struct
name|ieee80211vap
modifier|*
name|vap
parameter_list|,
name|struct
name|ieee80211_key
modifier|*
name|k
parameter_list|,
specifier|const
name|uint8_t
name|mac
index|[
name|IEEE80211_ADDR_LEN
index|]
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|vap
operator|->
name|iv_ic
decl_stmt|;
name|struct
name|run_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_ifp
operator|->
name|if_softc
decl_stmt|;
name|uint32_t
name|i
decl_stmt|;
name|i
operator|=
name|RUN_CMDQ_GET
argument_list|(
operator|&
name|sc
operator|->
name|cmdq_store
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"cmdq_store=%d\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|sc
operator|->
name|cmdq
index|[
name|i
index|]
operator|.
name|func
operator|=
name|run_key_set_cb
expr_stmt|;
name|sc
operator|->
name|cmdq
index|[
name|i
index|]
operator|.
name|arg0
operator|=
name|NULL
expr_stmt|;
name|sc
operator|->
name|cmdq
index|[
name|i
index|]
operator|.
name|arg1
operator|=
name|vap
expr_stmt|;
name|sc
operator|->
name|cmdq
index|[
name|i
index|]
operator|.
name|k
operator|=
name|k
expr_stmt|;
name|IEEE80211_ADDR_COPY
argument_list|(
name|sc
operator|->
name|cmdq
index|[
name|i
index|]
operator|.
name|mac
argument_list|,
name|mac
argument_list|)
expr_stmt|;
name|ieee80211_runtask
argument_list|(
name|ic
argument_list|,
operator|&
name|sc
operator|->
name|cmdq_task
argument_list|)
expr_stmt|;
comment|/* 	 * To make sure key will be set when hostapd 	 * calls iv_key_set() before if_init(). 	 */
if|if
condition|(
name|vap
operator|->
name|iv_opmode
operator|==
name|IEEE80211_M_HOSTAP
condition|)
block|{
name|RUN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|cmdq_key_set
operator|=
name|RUN_CMDQ_GO
expr_stmt|;
name|RUN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * If wlan is destroyed without being brought down i.e. without  * wlan down or wpa_cli terminate, this function is called after  * vap is gone. Don't refer it.  */
end_comment

begin_function
specifier|static
name|void
name|run_key_delete_cb
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|run_cmdq
modifier|*
name|cmdq
init|=
name|arg
decl_stmt|;
name|struct
name|run_softc
modifier|*
name|sc
init|=
name|cmdq
operator|->
name|arg1
decl_stmt|;
name|struct
name|ieee80211_key
modifier|*
name|k
init|=
operator|&
name|cmdq
operator|->
name|key
decl_stmt|;
name|uint32_t
name|attr
decl_stmt|;
name|uint8_t
name|wcid
decl_stmt|;
name|RUN_LOCK_ASSERT
argument_list|(
name|sc
argument_list|,
name|MA_OWNED
argument_list|)
expr_stmt|;
if|if
condition|(
name|k
operator|->
name|wk_flags
operator|&
name|IEEE80211_KEY_GROUP
condition|)
block|{
comment|/* remove group key */
name|DPRINTF
argument_list|(
literal|"removing group key\n"
argument_list|)
expr_stmt|;
name|run_read
argument_list|(
name|sc
argument_list|,
name|RT2860_SKEY_MODE_0_7
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
name|attr
operator|&=
operator|~
operator|(
literal|0xf
operator|<<
operator|(
name|k
operator|->
name|wk_keyix
operator|*
literal|4
operator|)
operator|)
expr_stmt|;
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_SKEY_MODE_0_7
argument_list|,
name|attr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* remove pairwise key */
name|DPRINTF
argument_list|(
literal|"removing key for wcid %x\n"
argument_list|,
name|k
operator|->
name|wk_pad
argument_list|)
expr_stmt|;
comment|/* matching wcid was written to wk_pad in run_key_set() */
name|wcid
operator|=
name|k
operator|->
name|wk_pad
expr_stmt|;
name|run_read
argument_list|(
name|sc
argument_list|,
name|RT2860_WCID_ATTR
argument_list|(
name|wcid
argument_list|)
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
name|attr
operator|&=
operator|~
literal|0xf
expr_stmt|;
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_WCID_ATTR
argument_list|(
name|wcid
argument_list|)
argument_list|,
name|attr
argument_list|)
expr_stmt|;
name|run_set_region_4
argument_list|(
name|sc
argument_list|,
name|RT2860_WCID_ENTRY
argument_list|(
name|wcid
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|8
argument_list|)
expr_stmt|;
block|}
name|k
operator|->
name|wk_pad
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * return 0 on error  */
end_comment

begin_function
specifier|static
name|int
name|run_key_delete
parameter_list|(
name|struct
name|ieee80211vap
modifier|*
name|vap
parameter_list|,
name|struct
name|ieee80211_key
modifier|*
name|k
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|vap
operator|->
name|iv_ic
decl_stmt|;
name|struct
name|run_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|ieee80211_key
modifier|*
name|k0
decl_stmt|;
name|uint32_t
name|i
decl_stmt|;
comment|/* 	 * When called back, key might be gone. So, make a copy 	 * of some values need to delete keys before deferring. 	 * But, because of LOR with node lock, cannot use lock here. 	 * So, use atomic instead. 	 */
name|i
operator|=
name|RUN_CMDQ_GET
argument_list|(
operator|&
name|sc
operator|->
name|cmdq_store
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"cmdq_store=%d\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|sc
operator|->
name|cmdq
index|[
name|i
index|]
operator|.
name|func
operator|=
name|run_key_delete_cb
expr_stmt|;
name|sc
operator|->
name|cmdq
index|[
name|i
index|]
operator|.
name|arg0
operator|=
name|NULL
expr_stmt|;
name|sc
operator|->
name|cmdq
index|[
name|i
index|]
operator|.
name|arg1
operator|=
name|sc
expr_stmt|;
name|k0
operator|=
operator|&
name|sc
operator|->
name|cmdq
index|[
name|i
index|]
operator|.
name|key
expr_stmt|;
name|k0
operator|->
name|wk_flags
operator|=
name|k
operator|->
name|wk_flags
expr_stmt|;
name|k0
operator|->
name|wk_keyix
operator|=
name|k
operator|->
name|wk_keyix
expr_stmt|;
comment|/* matching wcid was written to wk_pad in run_key_set() */
name|k0
operator|->
name|wk_pad
operator|=
name|k
operator|->
name|wk_pad
expr_stmt|;
name|ieee80211_runtask
argument_list|(
name|ic
argument_list|,
operator|&
name|sc
operator|->
name|cmdq_task
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
comment|/* return fake success */
block|}
end_function

begin_function
specifier|static
name|void
name|run_ratectl_to
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|run_softc
modifier|*
name|sc
init|=
name|arg
decl_stmt|;
comment|/* do it in a process context, so it can go sleep */
name|ieee80211_runtask
argument_list|(
name|sc
operator|->
name|sc_ifp
operator|->
name|if_l2com
argument_list|,
operator|&
name|sc
operator|->
name|ratectl_task
argument_list|)
expr_stmt|;
comment|/* next timeout will be rescheduled in the callback task */
block|}
end_function

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|void
name|run_ratectl_cb
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|int
name|pending
parameter_list|)
block|{
name|struct
name|run_softc
modifier|*
name|sc
init|=
name|arg
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|sc
operator|->
name|sc_ifp
operator|->
name|if_l2com
decl_stmt|;
name|struct
name|ieee80211vap
modifier|*
name|vap
init|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|ic
operator|->
name|ic_vaps
argument_list|)
decl_stmt|;
if|if
condition|(
name|vap
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|sc
operator|->
name|rvp_cnt
operator|<=
literal|1
operator|&&
name|vap
operator|->
name|iv_opmode
operator|==
name|IEEE80211_M_STA
condition|)
name|run_iter_func
argument_list|(
name|sc
argument_list|,
name|vap
operator|->
name|iv_bss
argument_list|)
expr_stmt|;
else|else
block|{
comment|/* 		 * run_reset_livelock() doesn't do anything with AMRR, 		 * but Ralink wants us to call it every 1 sec. So, we 		 * piggyback here rather than creating another callout. 		 * Livelock may occur only in HOSTAP or IBSS mode 		 * (when h/w is sending beacons). 		 */
name|RUN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|run_reset_livelock
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* just in case, there are some stats to drain */
name|run_drain_fifo
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|RUN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ieee80211_iterate_nodes
argument_list|(
operator|&
name|ic
operator|->
name|ic_sta
argument_list|,
name|run_iter_func
argument_list|,
name|sc
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|ratectl_run
operator|!=
name|RUN_RATECTL_OFF
condition|)
name|usb_callout_reset
argument_list|(
operator|&
name|sc
operator|->
name|ratectl_ch
argument_list|,
name|hz
argument_list|,
name|run_ratectl_to
argument_list|,
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|run_drain_fifo
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|run_softc
modifier|*
name|sc
init|=
name|arg
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|struct
name|ieee80211_node
modifier|*
name|ni
init|=
name|sc
operator|->
name|sc_ni
index|[
literal|0
index|]
decl_stmt|;
comment|/* make compiler happy */
name|uint32_t
name|stat
decl_stmt|;
name|int
name|retrycnt
init|=
literal|0
decl_stmt|;
name|uint8_t
name|wcid
decl_stmt|,
name|mcs
decl_stmt|,
name|pid
decl_stmt|;
name|RUN_LOCK_ASSERT
argument_list|(
name|sc
argument_list|,
name|MA_OWNED
argument_list|)
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
comment|/* drain Tx status FIFO (maxsize = 16) */
name|run_read
argument_list|(
name|sc
argument_list|,
name|RT2860_TX_STAT_FIFO
argument_list|,
operator|&
name|stat
argument_list|)
expr_stmt|;
name|DPRINTFN
argument_list|(
literal|4
argument_list|,
literal|"tx stat 0x%08x\n"
argument_list|,
name|stat
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|stat
operator|&
name|RT2860_TXQ_VLD
operator|)
condition|)
break|break;
name|wcid
operator|=
operator|(
name|stat
operator|>>
name|RT2860_TXQ_WCID_SHIFT
operator|)
operator|&
literal|0xff
expr_stmt|;
comment|/* if no ACK was requested, no feedback is available */
if|if
condition|(
operator|!
operator|(
name|stat
operator|&
name|RT2860_TXQ_ACKREQ
operator|)
operator|||
name|wcid
operator|>
name|RT2870_WCID_MAX
operator|||
name|wcid
operator|==
literal|0
condition|)
continue|continue;
name|ni
operator|=
name|sc
operator|->
name|sc_ni
index|[
name|wcid
index|]
expr_stmt|;
if|if
condition|(
name|ni
operator|->
name|ni_rctls
operator|==
name|NULL
condition|)
continue|continue;
comment|/* update per-STA AMRR stats */
if|if
condition|(
name|stat
operator|&
name|RT2860_TXQ_OK
condition|)
block|{
comment|/* 			 * Check if there were retries, ie if the Tx 			 * success rate is different from the requested 			 * rate. Note that it works only because we do 			 * not allow rate fallback from OFDM to CCK. 			 */
name|mcs
operator|=
operator|(
name|stat
operator|>>
name|RT2860_TXQ_MCS_SHIFT
operator|)
operator|&
literal|0x7f
expr_stmt|;
name|pid
operator|=
operator|(
name|stat
operator|>>
name|RT2860_TXQ_PID_SHIFT
operator|)
operator|&
literal|0xf
expr_stmt|;
if|if
condition|(
name|mcs
operator|+
literal|1
operator|!=
name|pid
condition|)
name|retrycnt
operator|=
literal|1
expr_stmt|;
name|ieee80211_ratectl_tx_complete
argument_list|(
name|ni
operator|->
name|ni_vap
argument_list|,
name|ni
argument_list|,
name|IEEE80211_RATECTL_TX_SUCCESS
argument_list|,
operator|&
name|retrycnt
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|retrycnt
operator|=
literal|1
expr_stmt|;
name|ieee80211_ratectl_tx_complete
argument_list|(
name|ni
operator|->
name|ni_vap
argument_list|,
name|ni
argument_list|,
name|IEEE80211_RATECTL_TX_FAILURE
argument_list|,
operator|&
name|retrycnt
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_oerrors
operator|++
expr_stmt|;
block|}
block|}
name|DPRINTFN
argument_list|(
literal|3
argument_list|,
literal|"count=%d\n"
argument_list|,
name|sc
operator|->
name|fifo_cnt
argument_list|)
expr_stmt|;
name|sc
operator|->
name|fifo_cnt
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|run_iter_func
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|struct
name|ieee80211_node
modifier|*
name|ni
parameter_list|)
block|{
name|struct
name|run_softc
modifier|*
name|sc
init|=
name|arg
decl_stmt|;
name|struct
name|ieee80211vap
modifier|*
name|vap
init|=
name|ni
operator|->
name|ni_vap
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|ni
operator|->
name|ni_ic
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|ic
operator|->
name|ic_ifp
decl_stmt|;
name|struct
name|run_node
modifier|*
name|rn
init|=
operator|(
name|void
operator|*
operator|)
name|ni
decl_stmt|;
name|uint32_t
name|sta
index|[
literal|3
index|]
decl_stmt|;
name|int
name|txcnt
init|=
literal|0
decl_stmt|,
name|success
init|=
literal|0
decl_stmt|,
name|retrycnt
init|=
literal|0
decl_stmt|;
name|int
name|error
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|rvp_cnt
operator|<=
literal|1
operator|&&
operator|(
name|vap
operator|->
name|iv_opmode
operator|==
name|IEEE80211_M_IBSS
operator|||
name|vap
operator|->
name|iv_opmode
operator|==
name|IEEE80211_M_STA
operator|)
condition|)
block|{
name|RUN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* read statistic counters (clear on read) and update AMRR state */
name|error
operator|=
name|run_read_region_1
argument_list|(
name|sc
argument_list|,
name|RT2860_TX_STA_CNT0
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
name|sta
argument_list|,
sizeof|sizeof
name|sta
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return;
name|DPRINTFN
argument_list|(
literal|3
argument_list|,
literal|"retrycnt=%d txcnt=%d failcnt=%d\n"
argument_list|,
name|le32toh
argument_list|(
name|sta
index|[
literal|1
index|]
argument_list|)
operator|>>
literal|16
argument_list|,
name|le32toh
argument_list|(
name|sta
index|[
literal|1
index|]
argument_list|)
operator|&
literal|0xffff
argument_list|,
name|le32toh
argument_list|(
name|sta
index|[
literal|0
index|]
argument_list|)
operator|&
literal|0xffff
argument_list|)
expr_stmt|;
comment|/* count failed TX as errors */
name|ifp
operator|->
name|if_oerrors
operator|+=
name|le32toh
argument_list|(
name|sta
index|[
literal|0
index|]
argument_list|)
operator|&
literal|0xffff
expr_stmt|;
name|retrycnt
operator|=
operator|(
name|le32toh
argument_list|(
name|sta
index|[
literal|0
index|]
argument_list|)
operator|&
literal|0xffff
operator|)
operator|+
comment|/* failed TX count */
operator|(
name|le32toh
argument_list|(
name|sta
index|[
literal|1
index|]
argument_list|)
operator|>>
literal|16
operator|)
expr_stmt|;
comment|/* TX retransmission count */
name|txcnt
operator|=
name|retrycnt
operator|+
operator|(
name|le32toh
argument_list|(
name|sta
index|[
literal|1
index|]
argument_list|)
operator|&
literal|0xffff
operator|)
expr_stmt|;
comment|/* successful TX count */
name|success
operator|=
operator|(
name|le32toh
argument_list|(
name|sta
index|[
literal|1
index|]
argument_list|)
operator|>>
literal|16
operator|)
operator|+
operator|(
name|le32toh
argument_list|(
name|sta
index|[
literal|1
index|]
argument_list|)
operator|&
literal|0xffff
operator|)
expr_stmt|;
name|ieee80211_ratectl_tx_update
argument_list|(
name|vap
argument_list|,
name|ni
argument_list|,
operator|&
name|txcnt
argument_list|,
operator|&
name|success
argument_list|,
operator|&
name|retrycnt
argument_list|)
expr_stmt|;
name|RUN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
name|rn
operator|->
name|amrr_ridx
operator|=
name|ieee80211_ratectl_rate
argument_list|(
name|ni
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|DPRINTFN
argument_list|(
literal|3
argument_list|,
literal|"ridx=%d\n"
argument_list|,
name|rn
operator|->
name|amrr_ridx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|run_newassoc_cb
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|run_cmdq
modifier|*
name|cmdq
init|=
name|arg
decl_stmt|;
name|struct
name|ieee80211_node
modifier|*
name|ni
init|=
name|cmdq
operator|->
name|arg1
decl_stmt|;
name|struct
name|run_softc
modifier|*
name|sc
init|=
name|ni
operator|->
name|ni_vap
operator|->
name|iv_ic
operator|->
name|ic_ifp
operator|->
name|if_softc
decl_stmt|;
name|uint8_t
name|wcid
init|=
name|cmdq
operator|->
name|wcid
decl_stmt|;
name|RUN_LOCK_ASSERT
argument_list|(
name|sc
argument_list|,
name|MA_OWNED
argument_list|)
expr_stmt|;
name|run_write_region_1
argument_list|(
name|sc
argument_list|,
name|RT2860_WCID_ENTRY
argument_list|(
name|wcid
argument_list|)
argument_list|,
name|ni
operator|->
name|ni_macaddr
argument_list|,
name|IEEE80211_ADDR_LEN
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|run_newassoc
parameter_list|(
name|struct
name|ieee80211_node
modifier|*
name|ni
parameter_list|,
name|int
name|isnew
parameter_list|)
block|{
name|struct
name|run_node
modifier|*
name|rn
init|=
operator|(
name|void
operator|*
operator|)
name|ni
decl_stmt|;
name|struct
name|ieee80211_rateset
modifier|*
name|rs
init|=
operator|&
name|ni
operator|->
name|ni_rates
decl_stmt|;
name|struct
name|ieee80211vap
modifier|*
name|vap
init|=
name|ni
operator|->
name|ni_vap
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|vap
operator|->
name|iv_ic
decl_stmt|;
name|struct
name|run_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_ifp
operator|->
name|if_softc
decl_stmt|;
name|uint8_t
name|rate
decl_stmt|;
name|uint8_t
name|ridx
decl_stmt|;
name|uint8_t
name|wcid
init|=
name|RUN_AID2WCID
argument_list|(
name|ni
operator|->
name|ni_associd
argument_list|)
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
if|if
condition|(
name|wcid
operator|>
name|RT2870_WCID_MAX
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"wcid=%d out of range\n"
argument_list|,
name|wcid
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* only interested in true associations */
if|if
condition|(
name|isnew
operator|&&
name|ni
operator|->
name|ni_associd
operator|!=
literal|0
condition|)
block|{
comment|/* 		 * This function could is called though timeout function. 		 * Need to defer. 		 */
name|uint32_t
name|cnt
init|=
name|RUN_CMDQ_GET
argument_list|(
operator|&
name|sc
operator|->
name|cmdq_store
argument_list|)
decl_stmt|;
name|DPRINTF
argument_list|(
literal|"cmdq_store=%d\n"
argument_list|,
name|cnt
argument_list|)
expr_stmt|;
name|sc
operator|->
name|cmdq
index|[
name|cnt
index|]
operator|.
name|func
operator|=
name|run_newassoc_cb
expr_stmt|;
name|sc
operator|->
name|cmdq
index|[
name|cnt
index|]
operator|.
name|arg0
operator|=
name|NULL
expr_stmt|;
name|sc
operator|->
name|cmdq
index|[
name|cnt
index|]
operator|.
name|arg1
operator|=
name|ni
expr_stmt|;
name|sc
operator|->
name|cmdq
index|[
name|cnt
index|]
operator|.
name|wcid
operator|=
name|wcid
expr_stmt|;
name|ieee80211_runtask
argument_list|(
name|ic
argument_list|,
operator|&
name|sc
operator|->
name|cmdq_task
argument_list|)
expr_stmt|;
block|}
name|DPRINTF
argument_list|(
literal|"new assoc isnew=%d associd=%x addr=%s\n"
argument_list|,
name|isnew
argument_list|,
name|ni
operator|->
name|ni_associd
argument_list|,
name|ether_sprintf
argument_list|(
name|ni
operator|->
name|ni_macaddr
argument_list|)
argument_list|)
expr_stmt|;
name|ieee80211_ratectl_node_init
argument_list|(
name|ni
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_ni
index|[
name|wcid
index|]
operator|=
name|ni
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rs
operator|->
name|rs_nrates
condition|;
name|i
operator|++
control|)
block|{
name|rate
operator|=
name|rs
operator|->
name|rs_rates
index|[
name|i
index|]
operator|&
name|IEEE80211_RATE_VAL
expr_stmt|;
comment|/* convert 802.11 rate to hardware rate index */
for|for
control|(
name|ridx
operator|=
literal|0
init|;
name|ridx
operator|<
name|RT2860_RIDX_MAX
condition|;
name|ridx
operator|++
control|)
if|if
condition|(
name|rt2860_rates
index|[
name|ridx
index|]
operator|.
name|rate
operator|==
name|rate
condition|)
break|break;
name|rn
operator|->
name|ridx
index|[
name|i
index|]
operator|=
name|ridx
expr_stmt|;
comment|/* determine rate of control response frames */
for|for
control|(
name|j
operator|=
name|i
init|;
name|j
operator|>=
literal|0
condition|;
name|j
operator|--
control|)
block|{
if|if
condition|(
operator|(
name|rs
operator|->
name|rs_rates
index|[
name|j
index|]
operator|&
name|IEEE80211_RATE_BASIC
operator|)
operator|&&
name|rt2860_rates
index|[
name|rn
operator|->
name|ridx
index|[
name|i
index|]
index|]
operator|.
name|phy
operator|==
name|rt2860_rates
index|[
name|rn
operator|->
name|ridx
index|[
name|j
index|]
index|]
operator|.
name|phy
condition|)
break|break;
block|}
if|if
condition|(
name|j
operator|>=
literal|0
condition|)
block|{
name|rn
operator|->
name|ctl_ridx
index|[
name|i
index|]
operator|=
name|rn
operator|->
name|ridx
index|[
name|j
index|]
expr_stmt|;
block|}
else|else
block|{
comment|/* no basic rate found, use mandatory one */
name|rn
operator|->
name|ctl_ridx
index|[
name|i
index|]
operator|=
name|rt2860_rates
index|[
name|ridx
index|]
operator|.
name|ctl_ridx
expr_stmt|;
block|}
name|DPRINTF
argument_list|(
literal|"rate=0x%02x ridx=%d ctl_ridx=%d\n"
argument_list|,
name|rs
operator|->
name|rs_rates
index|[
name|i
index|]
argument_list|,
name|rn
operator|->
name|ridx
index|[
name|i
index|]
argument_list|,
name|rn
operator|->
name|ctl_ridx
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|rate
operator|=
name|vap
operator|->
name|iv_txparms
index|[
name|ieee80211_chan2mode
argument_list|(
name|ic
operator|->
name|ic_curchan
argument_list|)
index|]
operator|.
name|mgmtrate
expr_stmt|;
for|for
control|(
name|ridx
operator|=
literal|0
init|;
name|ridx
operator|<
name|RT2860_RIDX_MAX
condition|;
name|ridx
operator|++
control|)
if|if
condition|(
name|rt2860_rates
index|[
name|ridx
index|]
operator|.
name|rate
operator|==
name|rate
condition|)
break|break;
name|rn
operator|->
name|mgt_ridx
operator|=
name|ridx
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"rate=%d, mgmt_ridx=%d\n"
argument_list|,
name|rate
argument_list|,
name|rn
operator|->
name|mgt_ridx
argument_list|)
expr_stmt|;
name|usb_callout_reset
argument_list|(
operator|&
name|sc
operator|->
name|ratectl_ch
argument_list|,
name|hz
argument_list|,
name|run_ratectl_to
argument_list|,
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Return the Rx chain with the highest RSSI for a given frame.  */
end_comment

begin_function
specifier|static
name|__inline
name|uint8_t
name|run_maxrssi_chain
parameter_list|(
name|struct
name|run_softc
modifier|*
name|sc
parameter_list|,
specifier|const
name|struct
name|rt2860_rxwi
modifier|*
name|rxwi
parameter_list|)
block|{
name|uint8_t
name|rxchain
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|nrxchains
operator|>
literal|1
condition|)
block|{
if|if
condition|(
name|rxwi
operator|->
name|rssi
index|[
literal|1
index|]
operator|>
name|rxwi
operator|->
name|rssi
index|[
name|rxchain
index|]
condition|)
name|rxchain
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|nrxchains
operator|>
literal|2
condition|)
if|if
condition|(
name|rxwi
operator|->
name|rssi
index|[
literal|2
index|]
operator|>
name|rxwi
operator|->
name|rssi
index|[
name|rxchain
index|]
condition|)
name|rxchain
operator|=
literal|2
expr_stmt|;
block|}
return|return
operator|(
name|rxchain
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|run_rx_frame
parameter_list|(
name|struct
name|run_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|uint32_t
name|dmalen
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|ifp
operator|->
name|if_l2com
decl_stmt|;
name|struct
name|ieee80211_frame
modifier|*
name|wh
decl_stmt|;
name|struct
name|ieee80211_node
modifier|*
name|ni
decl_stmt|;
name|struct
name|rt2870_rxd
modifier|*
name|rxd
decl_stmt|;
name|struct
name|rt2860_rxwi
modifier|*
name|rxwi
decl_stmt|;
name|uint32_t
name|flags
decl_stmt|;
name|uint16_t
name|len
decl_stmt|,
name|phy
decl_stmt|;
name|uint8_t
name|ant
decl_stmt|,
name|rssi
decl_stmt|;
name|int8_t
name|nf
decl_stmt|;
name|rxwi
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|rt2860_rxwi
operator|*
argument_list|)
expr_stmt|;
name|len
operator|=
name|le16toh
argument_list|(
name|rxwi
operator|->
name|len
argument_list|)
operator|&
literal|0xfff
expr_stmt|;
if|if
condition|(
name|__predict_false
argument_list|(
name|len
operator|>
name|dmalen
argument_list|)
condition|)
block|{
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_ierrors
operator|++
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"bad RXWI length %u> %u\n"
argument_list|,
name|len
argument_list|,
name|dmalen
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Rx descriptor is located at the end */
name|rxd
operator|=
operator|(
expr|struct
name|rt2870_rxd
operator|*
operator|)
operator|(
name|mtod
argument_list|(
name|m
argument_list|,
name|caddr_t
argument_list|)
operator|+
name|dmalen
operator|)
expr_stmt|;
name|flags
operator|=
name|le32toh
argument_list|(
name|rxd
operator|->
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|__predict_false
argument_list|(
name|flags
operator|&
operator|(
name|RT2860_RX_CRCERR
operator||
name|RT2860_RX_ICVERR
operator|)
argument_list|)
condition|)
block|{
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_ierrors
operator|++
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"%s error.\n"
argument_list|,
operator|(
name|flags
operator|&
name|RT2860_RX_CRCERR
operator|)
condition|?
literal|"CRC"
else|:
literal|"ICV"
argument_list|)
expr_stmt|;
return|return;
block|}
name|m
operator|->
name|m_data
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|rt2860_rxwi
argument_list|)
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|m
operator|->
name|m_len
operator|-=
sizeof|sizeof
argument_list|(
expr|struct
name|rt2860_rxwi
argument_list|)
expr_stmt|;
name|wh
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ieee80211_frame
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator|&
name|IEEE80211_FC1_WEP
condition|)
block|{
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator|&=
operator|~
name|IEEE80211_FC1_WEP
expr_stmt|;
name|m
operator|->
name|m_flags
operator||=
name|M_WEP
expr_stmt|;
block|}
if|if
condition|(
name|flags
operator|&
name|RT2860_RX_L2PAD
condition|)
block|{
name|DPRINTFN
argument_list|(
literal|8
argument_list|,
literal|"received RT2860_RX_L2PAD frame\n"
argument_list|)
expr_stmt|;
name|len
operator|+=
literal|2
expr_stmt|;
block|}
name|ni
operator|=
name|ieee80211_find_rxnode
argument_list|(
name|ic
argument_list|,
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ieee80211_frame_min
operator|*
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|__predict_false
argument_list|(
name|flags
operator|&
name|RT2860_RX_MICERR
argument_list|)
condition|)
block|{
comment|/* report MIC failures to net80211 for TKIP */
if|if
condition|(
name|ni
operator|!=
name|NULL
condition|)
name|ieee80211_notify_michael_failure
argument_list|(
name|ni
operator|->
name|ni_vap
argument_list|,
name|wh
argument_list|,
name|rxwi
operator|->
name|keyidx
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_ierrors
operator|++
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"MIC error. Someone is lying.\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|ant
operator|=
name|run_maxrssi_chain
argument_list|(
name|sc
argument_list|,
name|rxwi
argument_list|)
expr_stmt|;
name|rssi
operator|=
name|rxwi
operator|->
name|rssi
index|[
name|ant
index|]
expr_stmt|;
name|nf
operator|=
name|run_rssi2dbm
argument_list|(
name|sc
argument_list|,
name|rssi
argument_list|,
name|ant
argument_list|)
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|rcvif
operator|=
name|ifp
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|m
operator|->
name|m_len
operator|=
name|len
expr_stmt|;
if|if
condition|(
name|ni
operator|!=
name|NULL
condition|)
block|{
operator|(
name|void
operator|)
name|ieee80211_input
argument_list|(
name|ni
argument_list|,
name|m
argument_list|,
name|rssi
argument_list|,
name|nf
argument_list|)
expr_stmt|;
name|ieee80211_free_node
argument_list|(
name|ni
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|(
name|void
operator|)
name|ieee80211_input_all
argument_list|(
name|ic
argument_list|,
name|m
argument_list|,
name|rssi
argument_list|,
name|nf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|__predict_false
argument_list|(
name|ieee80211_radiotap_active
argument_list|(
name|ic
argument_list|)
argument_list|)
condition|)
block|{
name|struct
name|run_rx_radiotap_header
modifier|*
name|tap
init|=
operator|&
name|sc
operator|->
name|sc_rxtap
decl_stmt|;
name|tap
operator|->
name|wr_flags
operator|=
literal|0
expr_stmt|;
name|tap
operator|->
name|wr_chan_freq
operator|=
name|htole16
argument_list|(
name|ic
operator|->
name|ic_bsschan
operator|->
name|ic_freq
argument_list|)
expr_stmt|;
name|tap
operator|->
name|wr_chan_flags
operator|=
name|htole16
argument_list|(
name|ic
operator|->
name|ic_bsschan
operator|->
name|ic_flags
argument_list|)
expr_stmt|;
name|tap
operator|->
name|wr_antsignal
operator|=
name|rssi
expr_stmt|;
name|tap
operator|->
name|wr_antenna
operator|=
name|ant
expr_stmt|;
name|tap
operator|->
name|wr_dbm_antsignal
operator|=
name|run_rssi2dbm
argument_list|(
name|sc
argument_list|,
name|rssi
argument_list|,
name|ant
argument_list|)
expr_stmt|;
name|tap
operator|->
name|wr_rate
operator|=
literal|2
expr_stmt|;
comment|/* in case it can't be found below */
name|phy
operator|=
name|le16toh
argument_list|(
name|rxwi
operator|->
name|phy
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|phy
operator|&
name|RT2860_PHY_MODE
condition|)
block|{
case|case
name|RT2860_PHY_CCK
case|:
switch|switch
condition|(
operator|(
name|phy
operator|&
name|RT2860_PHY_MCS
operator|)
operator|&
operator|~
name|RT2860_PHY_SHPRE
condition|)
block|{
case|case
literal|0
case|:
name|tap
operator|->
name|wr_rate
operator|=
literal|2
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|tap
operator|->
name|wr_rate
operator|=
literal|4
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|tap
operator|->
name|wr_rate
operator|=
literal|11
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|tap
operator|->
name|wr_rate
operator|=
literal|22
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|phy
operator|&
name|RT2860_PHY_SHPRE
condition|)
name|tap
operator|->
name|wr_flags
operator||=
name|IEEE80211_RADIOTAP_F_SHORTPRE
expr_stmt|;
break|break;
case|case
name|RT2860_PHY_OFDM
case|:
switch|switch
condition|(
name|phy
operator|&
name|RT2860_PHY_MCS
condition|)
block|{
case|case
literal|0
case|:
name|tap
operator|->
name|wr_rate
operator|=
literal|12
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|tap
operator|->
name|wr_rate
operator|=
literal|18
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|tap
operator|->
name|wr_rate
operator|=
literal|24
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|tap
operator|->
name|wr_rate
operator|=
literal|36
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|tap
operator|->
name|wr_rate
operator|=
literal|48
expr_stmt|;
break|break;
case|case
literal|5
case|:
name|tap
operator|->
name|wr_rate
operator|=
literal|72
expr_stmt|;
break|break;
case|case
literal|6
case|:
name|tap
operator|->
name|wr_rate
operator|=
literal|96
expr_stmt|;
break|break;
case|case
literal|7
case|:
name|tap
operator|->
name|wr_rate
operator|=
literal|108
expr_stmt|;
break|break;
block|}
break|break;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|run_bulk_rx_callback
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|,
name|usb_error_t
name|error
parameter_list|)
block|{
name|struct
name|run_softc
modifier|*
name|sc
init|=
name|usbd_xfer_softc
argument_list|(
name|xfer
argument_list|)
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
init|=
name|NULL
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m0
decl_stmt|;
name|uint32_t
name|dmalen
decl_stmt|;
name|int
name|xferlen
decl_stmt|;
name|usbd_xfer_status
argument_list|(
name|xfer
argument_list|,
operator|&
name|xferlen
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|USB_GET_STATE
argument_list|(
name|xfer
argument_list|)
condition|)
block|{
case|case
name|USB_ST_TRANSFERRED
case|:
name|DPRINTFN
argument_list|(
literal|15
argument_list|,
literal|"rx done, actlen=%d\n"
argument_list|,
name|xferlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|xferlen
operator|<
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|rt2860_rxwi
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|rt2870_rxd
argument_list|)
condition|)
block|{
name|DPRINTF
argument_list|(
literal|"xfer too short %d\n"
argument_list|,
name|xferlen
argument_list|)
expr_stmt|;
goto|goto
name|tr_setup
goto|;
block|}
name|m
operator|=
name|sc
operator|->
name|rx_m
expr_stmt|;
name|sc
operator|->
name|rx_m
operator|=
name|NULL
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|USB_ST_SETUP
case|:
name|tr_setup
label|:
if|if
condition|(
name|sc
operator|->
name|rx_m
operator|==
name|NULL
condition|)
block|{
name|sc
operator|->
name|rx_m
operator|=
name|m_getjcl
argument_list|(
name|M_DONTWAIT
argument_list|,
name|MT_DATA
argument_list|,
name|M_PKTHDR
argument_list|,
name|MJUMPAGESIZE
comment|/* xfer can be bigger than MCLBYTES */
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|rx_m
operator|==
name|NULL
condition|)
block|{
name|DPRINTF
argument_list|(
literal|"could not allocate mbuf - idle with stall\n"
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_ierrors
operator|++
expr_stmt|;
name|usbd_xfer_set_stall
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
name|usbd_xfer_set_frames
argument_list|(
name|xfer
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* 			 * Directly loading a mbuf cluster into DMA to 			 * save some data copying. This works because 			 * there is only one cluster. 			 */
name|usbd_xfer_set_frame_data
argument_list|(
name|xfer
argument_list|,
literal|0
argument_list|,
name|mtod
argument_list|(
name|sc
operator|->
name|rx_m
argument_list|,
name|caddr_t
argument_list|)
argument_list|,
name|RUN_MAX_RXSZ
argument_list|)
expr_stmt|;
name|usbd_xfer_set_frames
argument_list|(
name|xfer
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|usbd_transfer_submit
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|/* Error */
if|if
condition|(
name|error
operator|!=
name|USB_ERR_CANCELLED
condition|)
block|{
comment|/* try to clear stall first */
name|usbd_xfer_set_stall
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
name|USB_ERR_TIMEOUT
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"device timeout\n"
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_ierrors
operator|++
expr_stmt|;
goto|goto
name|tr_setup
goto|;
block|}
if|if
condition|(
name|sc
operator|->
name|rx_m
operator|!=
name|NULL
condition|)
block|{
name|m_freem
argument_list|(
name|sc
operator|->
name|rx_m
argument_list|)
expr_stmt|;
name|sc
operator|->
name|rx_m
operator|=
name|NULL
expr_stmt|;
block|}
break|break;
block|}
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
return|return;
comment|/* inputting all the frames must be last */
name|RUN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|m
operator|->
name|m_len
operator|=
name|xferlen
expr_stmt|;
comment|/* HW can aggregate multiple 802.11 frames in a single USB xfer */
for|for
control|(
init|;
condition|;
control|)
block|{
name|dmalen
operator|=
name|le32toh
argument_list|(
operator|*
name|mtod
argument_list|(
name|m
argument_list|,
name|uint32_t
operator|*
argument_list|)
argument_list|)
operator|&
literal|0xffff
expr_stmt|;
if|if
condition|(
operator|(
name|dmalen
operator|==
literal|0
operator|)
operator|||
operator|(
operator|(
name|dmalen
operator|&
literal|3
operator|)
operator|!=
literal|0
operator|)
condition|)
block|{
name|DPRINTF
argument_list|(
literal|"bad DMA length %u\n"
argument_list|,
name|dmalen
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|(
name|dmalen
operator|+
literal|8
operator|)
operator|>
name|xferlen
condition|)
block|{
name|DPRINTF
argument_list|(
literal|"bad DMA length %u> %d\n"
argument_list|,
name|dmalen
operator|+
literal|8
argument_list|,
name|xferlen
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* If it is the last one or a single frame, we won't copy. */
if|if
condition|(
operator|(
name|xferlen
operator|-=
name|dmalen
operator|+
literal|8
operator|)
operator|<=
literal|8
condition|)
block|{
comment|/* trim 32-bit DMA-len header */
name|m
operator|->
name|m_data
operator|+=
literal|4
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|m
operator|->
name|m_len
operator|-=
literal|4
expr_stmt|;
name|run_rx_frame
argument_list|(
name|sc
argument_list|,
name|m
argument_list|,
name|dmalen
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* copy aggregated frames to another mbuf */
name|m0
operator|=
name|m_getcl
argument_list|(
name|M_DONTWAIT
argument_list|,
name|MT_DATA
argument_list|,
name|M_PKTHDR
argument_list|)
expr_stmt|;
if|if
condition|(
name|__predict_false
argument_list|(
name|m0
operator|==
name|NULL
argument_list|)
condition|)
block|{
name|DPRINTF
argument_list|(
literal|"could not allocate mbuf\n"
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_ierrors
operator|++
expr_stmt|;
break|break;
block|}
name|m_copydata
argument_list|(
name|m
argument_list|,
literal|4
comment|/* skip 32-bit DMA-len header */
argument_list|,
name|dmalen
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|rt2870_rxd
argument_list|)
argument_list|,
name|mtod
argument_list|(
name|m0
argument_list|,
name|caddr_t
argument_list|)
argument_list|)
expr_stmt|;
name|m0
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|m0
operator|->
name|m_len
operator|=
name|dmalen
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|rt2870_rxd
argument_list|)
expr_stmt|;
name|run_rx_frame
argument_list|(
name|sc
argument_list|,
name|m0
argument_list|,
name|dmalen
argument_list|)
expr_stmt|;
comment|/* update data ptr */
name|m
operator|->
name|m_data
operator|+=
name|dmalen
operator|+
literal|8
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|m
operator|->
name|m_len
operator|-=
name|dmalen
operator|+
literal|8
expr_stmt|;
block|}
name|RUN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|run_tx_free
parameter_list|(
name|struct
name|run_endpoint_queue
modifier|*
name|pq
parameter_list|,
name|struct
name|run_tx_data
modifier|*
name|data
parameter_list|,
name|int
name|txerr
parameter_list|)
block|{
if|if
condition|(
name|data
operator|->
name|m
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|data
operator|->
name|m
operator|->
name|m_flags
operator|&
name|M_TXCB
condition|)
name|ieee80211_process_callback
argument_list|(
name|data
operator|->
name|ni
argument_list|,
name|data
operator|->
name|m
argument_list|,
name|txerr
condition|?
name|ETIMEDOUT
else|:
literal|0
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|data
operator|->
name|m
argument_list|)
expr_stmt|;
name|data
operator|->
name|m
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|ni
operator|==
name|NULL
condition|)
block|{
name|DPRINTF
argument_list|(
literal|"no node\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ieee80211_free_node
argument_list|(
name|data
operator|->
name|ni
argument_list|)
expr_stmt|;
name|data
operator|->
name|ni
operator|=
name|NULL
expr_stmt|;
block|}
block|}
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|pq
operator|->
name|tx_fh
argument_list|,
name|data
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|pq
operator|->
name|tx_nfree
operator|++
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|run_bulk_tx_callbackN
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|,
name|usb_error_t
name|error
parameter_list|,
name|unsigned
name|int
name|index
parameter_list|)
block|{
name|struct
name|run_softc
modifier|*
name|sc
init|=
name|usbd_xfer_softc
argument_list|(
name|xfer
argument_list|)
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|ifp
operator|->
name|if_l2com
decl_stmt|;
name|struct
name|run_tx_data
modifier|*
name|data
decl_stmt|;
name|struct
name|ieee80211vap
modifier|*
name|vap
init|=
name|NULL
decl_stmt|;
name|struct
name|usb_page_cache
modifier|*
name|pc
decl_stmt|;
name|struct
name|run_endpoint_queue
modifier|*
name|pq
init|=
operator|&
name|sc
operator|->
name|sc_epq
index|[
name|index
index|]
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|usb_frlength_t
name|size
decl_stmt|;
name|unsigned
name|int
name|len
decl_stmt|;
name|int
name|actlen
decl_stmt|;
name|int
name|sumlen
decl_stmt|;
name|usbd_xfer_status
argument_list|(
name|xfer
argument_list|,
operator|&
name|actlen
argument_list|,
operator|&
name|sumlen
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|USB_GET_STATE
argument_list|(
name|xfer
argument_list|)
condition|)
block|{
case|case
name|USB_ST_TRANSFERRED
case|:
name|DPRINTFN
argument_list|(
literal|11
argument_list|,
literal|"transfer complete: %d "
literal|"bytes @ index %d\n"
argument_list|,
name|actlen
argument_list|,
name|index
argument_list|)
expr_stmt|;
name|data
operator|=
name|usbd_xfer_get_priv
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
name|run_tx_free
argument_list|(
name|pq
argument_list|,
name|data
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_OACTIVE
expr_stmt|;
name|usbd_xfer_set_priv
argument_list|(
name|xfer
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_opackets
operator|++
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|USB_ST_SETUP
case|:
name|tr_setup
label|:
name|data
operator|=
name|STAILQ_FIRST
argument_list|(
operator|&
name|pq
operator|->
name|tx_qh
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
break|break;
name|STAILQ_REMOVE_HEAD
argument_list|(
operator|&
name|pq
operator|->
name|tx_qh
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|m
operator|=
name|data
operator|->
name|m
expr_stmt|;
if|if
condition|(
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|>
name|RUN_MAX_TXSZ
condition|)
block|{
name|DPRINTF
argument_list|(
literal|"data overflow, %u bytes\n"
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_oerrors
operator|++
expr_stmt|;
name|run_tx_free
argument_list|(
name|pq
argument_list|,
name|data
argument_list|,
literal|1
argument_list|)
expr_stmt|;
goto|goto
name|tr_setup
goto|;
block|}
name|pc
operator|=
name|usbd_xfer_get_frame
argument_list|(
name|xfer
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
name|data
operator|->
name|desc
argument_list|)
expr_stmt|;
name|usbd_copy_in
argument_list|(
name|pc
argument_list|,
literal|0
argument_list|,
operator|&
name|data
operator|->
name|desc
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|usbd_m_copy_in
argument_list|(
name|pc
argument_list|,
name|size
argument_list|,
name|m
argument_list|,
literal|0
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|)
expr_stmt|;
name|vap
operator|=
name|data
operator|->
name|ni
operator|->
name|ni_vap
expr_stmt|;
if|if
condition|(
name|ieee80211_radiotap_active_vap
argument_list|(
name|vap
argument_list|)
condition|)
block|{
name|struct
name|run_tx_radiotap_header
modifier|*
name|tap
init|=
operator|&
name|sc
operator|->
name|sc_txtap
decl_stmt|;
name|struct
name|rt2860_txwi
modifier|*
name|txwi
init|=
operator|(
expr|struct
name|rt2860_txwi
operator|*
operator|)
operator|(
operator|&
name|data
operator|->
name|desc
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|rt2870_txd
argument_list|)
operator|)
decl_stmt|;
name|tap
operator|->
name|wt_flags
operator|=
literal|0
expr_stmt|;
name|tap
operator|->
name|wt_rate
operator|=
name|rt2860_rates
index|[
name|data
operator|->
name|ridx
index|]
operator|.
name|rate
expr_stmt|;
name|tap
operator|->
name|wt_chan_freq
operator|=
name|htole16
argument_list|(
name|vap
operator|->
name|iv_bss
operator|->
name|ni_chan
operator|->
name|ic_freq
argument_list|)
expr_stmt|;
name|tap
operator|->
name|wt_chan_flags
operator|=
name|htole16
argument_list|(
name|vap
operator|->
name|iv_bss
operator|->
name|ni_chan
operator|->
name|ic_flags
argument_list|)
expr_stmt|;
name|tap
operator|->
name|wt_hwqueue
operator|=
name|index
expr_stmt|;
if|if
condition|(
name|le16toh
argument_list|(
name|txwi
operator|->
name|phy
argument_list|)
operator|&
name|RT2860_PHY_SHPRE
condition|)
name|tap
operator|->
name|wt_flags
operator||=
name|IEEE80211_RADIOTAP_F_SHORTPRE
expr_stmt|;
name|ieee80211_radiotap_tx
argument_list|(
name|vap
argument_list|,
name|m
argument_list|)
expr_stmt|;
block|}
comment|/* align end on a 4-bytes boundary */
name|len
operator|=
operator|(
name|size
operator|+
name|IEEE80211_CRC_LEN
operator|+
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|+
literal|3
operator|)
operator|&
operator|~
literal|3
expr_stmt|;
name|DPRINTFN
argument_list|(
literal|11
argument_list|,
literal|"sending frame len=%u xferlen=%u @ index %d\n"
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|,
name|len
argument_list|,
name|index
argument_list|)
expr_stmt|;
name|usbd_xfer_set_frame_len
argument_list|(
name|xfer
argument_list|,
literal|0
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|usbd_xfer_set_priv
argument_list|(
name|xfer
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|usbd_transfer_submit
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
name|RUN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|run_start
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|RUN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
default|default:
name|DPRINTF
argument_list|(
literal|"USB transfer error, %s\n"
argument_list|,
name|usbd_errstr
argument_list|(
name|error
argument_list|)
argument_list|)
expr_stmt|;
name|data
operator|=
name|usbd_xfer_get_priv
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_oerrors
operator|++
expr_stmt|;
if|if
condition|(
name|data
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|data
operator|->
name|ni
operator|!=
name|NULL
condition|)
name|vap
operator|=
name|data
operator|->
name|ni
operator|->
name|ni_vap
expr_stmt|;
name|run_tx_free
argument_list|(
name|pq
argument_list|,
name|data
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|usbd_xfer_set_priv
argument_list|(
name|xfer
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|vap
operator|==
name|NULL
condition|)
name|vap
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|ic
operator|->
name|ic_vaps
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|USB_ERR_CANCELLED
condition|)
block|{
if|if
condition|(
name|error
operator|==
name|USB_ERR_TIMEOUT
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"device timeout\n"
argument_list|)
expr_stmt|;
name|uint32_t
name|i
init|=
name|RUN_CMDQ_GET
argument_list|(
operator|&
name|sc
operator|->
name|cmdq_store
argument_list|)
decl_stmt|;
name|DPRINTF
argument_list|(
literal|"cmdq_store=%d\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|sc
operator|->
name|cmdq
index|[
name|i
index|]
operator|.
name|func
operator|=
name|run_usb_timeout_cb
expr_stmt|;
name|sc
operator|->
name|cmdq
index|[
name|i
index|]
operator|.
name|arg0
operator|=
name|vap
expr_stmt|;
name|ieee80211_runtask
argument_list|(
name|ic
argument_list|,
operator|&
name|sc
operator|->
name|cmdq_task
argument_list|)
expr_stmt|;
block|}
comment|/* 			 * Try to clear stall first, also if other 			 * errors occur, hence clearing stall 			 * introduces a 50 ms delay: 			 */
name|usbd_xfer_set_stall
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
goto|goto
name|tr_setup
goto|;
block|}
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|run_bulk_tx_callback0
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|,
name|usb_error_t
name|error
parameter_list|)
block|{
name|run_bulk_tx_callbackN
argument_list|(
name|xfer
argument_list|,
name|error
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|run_bulk_tx_callback1
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|,
name|usb_error_t
name|error
parameter_list|)
block|{
name|run_bulk_tx_callbackN
argument_list|(
name|xfer
argument_list|,
name|error
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|run_bulk_tx_callback2
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|,
name|usb_error_t
name|error
parameter_list|)
block|{
name|run_bulk_tx_callbackN
argument_list|(
name|xfer
argument_list|,
name|error
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|run_bulk_tx_callback3
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|,
name|usb_error_t
name|error
parameter_list|)
block|{
name|run_bulk_tx_callbackN
argument_list|(
name|xfer
argument_list|,
name|error
argument_list|,
literal|3
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|run_bulk_tx_callback4
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|,
name|usb_error_t
name|error
parameter_list|)
block|{
name|run_bulk_tx_callbackN
argument_list|(
name|xfer
argument_list|,
name|error
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|run_bulk_tx_callback5
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|,
name|usb_error_t
name|error
parameter_list|)
block|{
name|run_bulk_tx_callbackN
argument_list|(
name|xfer
argument_list|,
name|error
argument_list|,
literal|5
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|run_set_tx_desc
parameter_list|(
name|struct
name|run_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|run_tx_data
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|mbuf
modifier|*
name|m
init|=
name|data
operator|->
name|m
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|sc
operator|->
name|sc_ifp
operator|->
name|if_l2com
decl_stmt|;
name|struct
name|ieee80211vap
modifier|*
name|vap
init|=
name|data
operator|->
name|ni
operator|->
name|ni_vap
decl_stmt|;
name|struct
name|ieee80211_frame
modifier|*
name|wh
decl_stmt|;
name|struct
name|rt2870_txd
modifier|*
name|txd
decl_stmt|;
name|struct
name|rt2860_txwi
modifier|*
name|txwi
decl_stmt|;
name|uint16_t
name|xferlen
decl_stmt|;
name|uint16_t
name|mcs
decl_stmt|;
name|uint8_t
name|ridx
init|=
name|data
operator|->
name|ridx
decl_stmt|;
name|uint8_t
name|pad
decl_stmt|;
comment|/* get MCS code from rate index */
name|mcs
operator|=
name|rt2860_rates
index|[
name|ridx
index|]
operator|.
name|mcs
expr_stmt|;
name|xferlen
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|txwi
argument_list|)
operator|+
name|m
operator|->
name|m_pkthdr
operator|.
name|len
expr_stmt|;
comment|/* roundup to 32-bit alignment */
name|xferlen
operator|=
operator|(
name|xferlen
operator|+
literal|3
operator|)
operator|&
operator|~
literal|3
expr_stmt|;
name|txd
operator|=
operator|(
expr|struct
name|rt2870_txd
operator|*
operator|)
operator|&
name|data
operator|->
name|desc
expr_stmt|;
name|txd
operator|->
name|len
operator|=
name|htole16
argument_list|(
name|xferlen
argument_list|)
expr_stmt|;
name|wh
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ieee80211_frame
operator|*
argument_list|)
expr_stmt|;
comment|/* 	 * Ether both are true or both are false, the header 	 * are nicely aligned to 32-bit. So, no L2 padding. 	 */
if|if
condition|(
name|IEEE80211_HAS_ADDR4
argument_list|(
name|wh
argument_list|)
operator|==
name|IEEE80211_QOS_HAS_SEQ
argument_list|(
name|wh
argument_list|)
condition|)
name|pad
operator|=
literal|0
expr_stmt|;
else|else
name|pad
operator|=
literal|2
expr_stmt|;
comment|/* setup TX Wireless Information */
name|txwi
operator|=
operator|(
expr|struct
name|rt2860_txwi
operator|*
operator|)
operator|(
name|txd
operator|+
literal|1
operator|)
expr_stmt|;
name|txwi
operator|->
name|len
operator|=
name|htole16
argument_list|(
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|-
name|pad
argument_list|)
expr_stmt|;
if|if
condition|(
name|rt2860_rates
index|[
name|ridx
index|]
operator|.
name|phy
operator|==
name|IEEE80211_T_DS
condition|)
block|{
name|txwi
operator|->
name|phy
operator|=
name|htole16
argument_list|(
name|RT2860_PHY_CCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|ridx
operator|!=
name|RT2860_RIDX_CCK1
operator|&&
operator|(
name|ic
operator|->
name|ic_flags
operator|&
name|IEEE80211_F_SHPREAMBLE
operator|)
condition|)
name|mcs
operator||=
name|RT2860_PHY_SHPRE
expr_stmt|;
block|}
else|else
name|txwi
operator|->
name|phy
operator|=
name|htole16
argument_list|(
name|RT2860_PHY_OFDM
argument_list|)
expr_stmt|;
name|txwi
operator|->
name|phy
operator||=
name|htole16
argument_list|(
name|mcs
argument_list|)
expr_stmt|;
comment|/* check if RTS/CTS or CTS-to-self protection is required */
if|if
condition|(
operator|!
name|IEEE80211_IS_MULTICAST
argument_list|(
name|wh
operator|->
name|i_addr1
argument_list|)
operator|&&
operator|(
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|+
name|IEEE80211_CRC_LEN
operator|>
name|vap
operator|->
name|iv_rtsthreshold
operator|||
operator|(
operator|(
name|ic
operator|->
name|ic_flags
operator|&
name|IEEE80211_F_USEPROT
operator|)
operator|&&
name|rt2860_rates
index|[
name|ridx
index|]
operator|.
name|phy
operator|==
name|IEEE80211_T_OFDM
operator|)
operator|)
condition|)
name|txwi
operator|->
name|txop
operator||=
name|RT2860_TX_TXOP_HT
expr_stmt|;
else|else
name|txwi
operator|->
name|txop
operator||=
name|RT2860_TX_TXOP_BACKOFF
expr_stmt|;
if|if
condition|(
name|vap
operator|->
name|iv_opmode
operator|!=
name|IEEE80211_M_STA
operator|&&
operator|!
name|IEEE80211_QOS_HAS_SEQ
argument_list|(
name|wh
argument_list|)
condition|)
name|txwi
operator|->
name|xflags
operator||=
name|RT2860_TX_NSEQ
expr_stmt|;
block|}
end_function

begin_comment
comment|/* This function must be called locked */
end_comment

begin_function
specifier|static
name|int
name|run_tx
parameter_list|(
name|struct
name|run_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|struct
name|ieee80211_node
modifier|*
name|ni
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|sc
operator|->
name|sc_ifp
operator|->
name|if_l2com
decl_stmt|;
name|struct
name|ieee80211vap
modifier|*
name|vap
init|=
name|ni
operator|->
name|ni_vap
decl_stmt|;
name|struct
name|ieee80211_frame
modifier|*
name|wh
decl_stmt|;
name|struct
name|ieee80211_channel
modifier|*
name|chan
decl_stmt|;
specifier|const
name|struct
name|ieee80211_txparam
modifier|*
name|tp
decl_stmt|;
name|struct
name|run_node
modifier|*
name|rn
init|=
operator|(
name|void
operator|*
operator|)
name|ni
decl_stmt|;
name|struct
name|run_tx_data
modifier|*
name|data
decl_stmt|;
name|struct
name|rt2870_txd
modifier|*
name|txd
decl_stmt|;
name|struct
name|rt2860_txwi
modifier|*
name|txwi
decl_stmt|;
name|uint16_t
name|qos
decl_stmt|;
name|uint16_t
name|dur
decl_stmt|;
name|uint16_t
name|qid
decl_stmt|;
name|uint8_t
name|type
decl_stmt|;
name|uint8_t
name|tid
decl_stmt|;
name|uint8_t
name|ridx
decl_stmt|;
name|uint8_t
name|ctl_ridx
decl_stmt|;
name|uint8_t
name|qflags
decl_stmt|;
name|uint8_t
name|xflags
init|=
literal|0
decl_stmt|;
name|int
name|hasqos
decl_stmt|;
name|RUN_LOCK_ASSERT
argument_list|(
name|sc
argument_list|,
name|MA_OWNED
argument_list|)
expr_stmt|;
name|wh
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ieee80211_frame
operator|*
argument_list|)
expr_stmt|;
name|type
operator|=
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator|&
name|IEEE80211_FC0_TYPE_MASK
expr_stmt|;
comment|/* 	 * There are 7 bulk endpoints: 1 for RX 	 * and 6 for TX (4 EDCAs + HCCA + Prio). 	 * Update 03-14-2009:  some devices like the Planex GW-US300MiniS 	 * seem to have only 4 TX bulk endpoints (Fukaumi Naoki). 	 */
if|if
condition|(
operator|(
name|hasqos
operator|=
name|IEEE80211_QOS_HAS_SEQ
argument_list|(
name|wh
argument_list|)
operator|)
condition|)
block|{
name|uint8_t
modifier|*
name|frm
decl_stmt|;
if|if
condition|(
name|IEEE80211_HAS_ADDR4
argument_list|(
name|wh
argument_list|)
condition|)
name|frm
operator|=
operator|(
operator|(
expr|struct
name|ieee80211_qosframe_addr4
operator|*
operator|)
name|wh
operator|)
operator|->
name|i_qos
expr_stmt|;
else|else
name|frm
operator|=
operator|(
operator|(
expr|struct
name|ieee80211_qosframe
operator|*
operator|)
name|wh
operator|)
operator|->
name|i_qos
expr_stmt|;
name|qos
operator|=
name|le16toh
argument_list|(
operator|*
operator|(
specifier|const
name|uint16_t
operator|*
operator|)
name|frm
argument_list|)
expr_stmt|;
name|tid
operator|=
name|qos
operator|&
name|IEEE80211_QOS_TID
expr_stmt|;
name|qid
operator|=
name|TID_TO_WME_AC
argument_list|(
name|tid
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|qos
operator|=
literal|0
expr_stmt|;
name|tid
operator|=
literal|0
expr_stmt|;
name|qid
operator|=
name|WME_AC_BE
expr_stmt|;
block|}
name|qflags
operator|=
operator|(
name|qid
operator|<
literal|4
operator|)
condition|?
name|RT2860_TX_QSEL_EDCA
else|:
name|RT2860_TX_QSEL_HCCA
expr_stmt|;
name|DPRINTFN
argument_list|(
literal|8
argument_list|,
literal|"qos %d\tqid %d\ttid %d\tqflags %x\n"
argument_list|,
name|qos
argument_list|,
name|qid
argument_list|,
name|tid
argument_list|,
name|qflags
argument_list|)
expr_stmt|;
name|chan
operator|=
operator|(
name|ni
operator|->
name|ni_chan
operator|!=
name|IEEE80211_CHAN_ANYC
operator|)
condition|?
name|ni
operator|->
name|ni_chan
else|:
name|ic
operator|->
name|ic_curchan
expr_stmt|;
name|tp
operator|=
operator|&
name|vap
operator|->
name|iv_txparms
index|[
name|ieee80211_chan2mode
argument_list|(
name|chan
argument_list|)
index|]
expr_stmt|;
comment|/* pickup a rate index */
if|if
condition|(
name|IEEE80211_IS_MULTICAST
argument_list|(
name|wh
operator|->
name|i_addr1
argument_list|)
operator|||
name|type
operator|!=
name|IEEE80211_FC0_TYPE_DATA
condition|)
block|{
name|ridx
operator|=
operator|(
name|ic
operator|->
name|ic_curmode
operator|==
name|IEEE80211_MODE_11A
operator|)
condition|?
name|RT2860_RIDX_OFDM6
else|:
name|RT2860_RIDX_CCK1
expr_stmt|;
name|ctl_ridx
operator|=
name|rt2860_rates
index|[
name|ridx
index|]
operator|.
name|ctl_ridx
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|tp
operator|->
name|ucastrate
operator|!=
name|IEEE80211_FIXED_RATE_NONE
condition|)
name|ridx
operator|=
name|rn
operator|->
name|fix_ridx
expr_stmt|;
else|else
name|ridx
operator|=
name|rn
operator|->
name|amrr_ridx
expr_stmt|;
name|ctl_ridx
operator|=
name|rt2860_rates
index|[
name|ridx
index|]
operator|.
name|ctl_ridx
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|IEEE80211_IS_MULTICAST
argument_list|(
name|wh
operator|->
name|i_addr1
argument_list|)
operator|&&
operator|(
operator|!
name|hasqos
operator|||
operator|(
name|qos
operator|&
name|IEEE80211_QOS_ACKPOLICY
operator|)
operator|!=
name|IEEE80211_QOS_ACKPOLICY_NOACK
operator|)
condition|)
block|{
name|xflags
operator||=
name|RT2860_TX_ACK
expr_stmt|;
if|if
condition|(
name|ic
operator|->
name|ic_flags
operator|&
name|IEEE80211_F_SHPREAMBLE
condition|)
name|dur
operator|=
name|rt2860_rates
index|[
name|ctl_ridx
index|]
operator|.
name|sp_ack_dur
expr_stmt|;
else|else
name|dur
operator|=
name|rt2860_rates
index|[
name|ctl_ridx
index|]
operator|.
name|lp_ack_dur
expr_stmt|;
operator|*
operator|(
name|uint16_t
operator|*
operator|)
name|wh
operator|->
name|i_dur
operator|=
name|htole16
argument_list|(
name|dur
argument_list|)
expr_stmt|;
block|}
comment|/* reserve slots for mgmt packets, just in case */
if|if
condition|(
name|sc
operator|->
name|sc_epq
index|[
name|qid
index|]
operator|.
name|tx_nfree
operator|<
literal|3
condition|)
block|{
name|DPRINTFN
argument_list|(
literal|10
argument_list|,
literal|"tx ring %d is full\n"
argument_list|,
name|qid
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|data
operator|=
name|STAILQ_FIRST
argument_list|(
operator|&
name|sc
operator|->
name|sc_epq
index|[
name|qid
index|]
operator|.
name|tx_fh
argument_list|)
expr_stmt|;
name|STAILQ_REMOVE_HEAD
argument_list|(
operator|&
name|sc
operator|->
name|sc_epq
index|[
name|qid
index|]
operator|.
name|tx_fh
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_epq
index|[
name|qid
index|]
operator|.
name|tx_nfree
operator|--
expr_stmt|;
name|txd
operator|=
operator|(
expr|struct
name|rt2870_txd
operator|*
operator|)
operator|&
name|data
operator|->
name|desc
expr_stmt|;
name|txd
operator|->
name|flags
operator|=
name|qflags
expr_stmt|;
name|txwi
operator|=
operator|(
expr|struct
name|rt2860_txwi
operator|*
operator|)
operator|(
name|txd
operator|+
literal|1
operator|)
expr_stmt|;
name|txwi
operator|->
name|xflags
operator|=
name|xflags
expr_stmt|;
name|txwi
operator|->
name|wcid
operator|=
name|IEEE80211_IS_MULTICAST
argument_list|(
name|wh
operator|->
name|i_addr1
argument_list|)
condition|?
literal|0
else|:
name|RUN_AID2WCID
argument_list|(
name|ni
operator|->
name|ni_associd
argument_list|)
expr_stmt|;
comment|/* clear leftover garbage bits */
name|txwi
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
name|txwi
operator|->
name|txop
operator|=
literal|0
expr_stmt|;
name|data
operator|->
name|m
operator|=
name|m
expr_stmt|;
name|data
operator|->
name|ni
operator|=
name|ni
expr_stmt|;
name|data
operator|->
name|ridx
operator|=
name|ridx
expr_stmt|;
name|run_set_tx_desc
argument_list|(
name|sc
argument_list|,
name|data
argument_list|)
expr_stmt|;
comment|/* 	 * The chip keeps track of 2 kind of Tx stats, 	 *  * TX_STAT_FIFO, for per WCID stats, and 	 *  * TX_STA_CNT0 for all-TX-in-one stats. 	 * 	 * To use FIFO stats, we need to store MCS into the driver-private  	 * PacketID field. So that, we can tell whose stats when we read them.  	 * We add 1 to the MCS because setting the PacketID field to 0 means  	 * that we don't want feedback in TX_STAT_FIFO.  	 * And, that's what we want for STA mode, since TX_STA_CNT0 does the job.  	 *  	 * FIFO stats doesn't count Tx with WCID 0xff, so we do this in run_tx().  	 */
if|if
condition|(
name|sc
operator|->
name|rvp_cnt
operator|>
literal|1
operator|||
name|vap
operator|->
name|iv_opmode
operator|==
name|IEEE80211_M_HOSTAP
operator|||
name|vap
operator|->
name|iv_opmode
operator|==
name|IEEE80211_M_MBSS
condition|)
block|{
name|uint16_t
name|pid
init|=
operator|(
name|rt2860_rates
index|[
name|ridx
index|]
operator|.
name|mcs
operator|+
literal|1
operator|)
operator|&
literal|0xf
decl_stmt|;
name|txwi
operator|->
name|len
operator||=
name|htole16
argument_list|(
name|pid
operator|<<
name|RT2860_TX_PID_SHIFT
argument_list|)
expr_stmt|;
comment|/* 		 * Unlike PCI based devices, we don't get any interrupt from 		 * USB devices, so we simulate FIFO-is-full interrupt here. 		 * Ralink recomends to drain FIFO stats every 100 ms, but 16 slots 		 * quickly get fulled. To prevent overflow, increment a counter on 		 * every FIFO stat request, so we know how many slots are left. 		 * We do this only in HOSTAP or multiple vap mode since FIFO stats 		 * are used only in those modes. 		 * We just drain stats. AMRR gets updated every 1 sec by 		 * run_ratectl_cb() via callout. 		 * Call it early. Otherwise overflow. 		 */
if|if
condition|(
name|sc
operator|->
name|fifo_cnt
operator|++
operator|==
literal|10
condition|)
block|{
comment|/* 			 * With multiple vaps or if_bridge, if_start() is called 			 * with a non-sleepable lock, tcpinp. So, need to defer. 			 */
name|uint32_t
name|i
init|=
name|RUN_CMDQ_GET
argument_list|(
operator|&
name|sc
operator|->
name|cmdq_store
argument_list|)
decl_stmt|;
name|DPRINTFN
argument_list|(
literal|6
argument_list|,
literal|"cmdq_store=%d\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|sc
operator|->
name|cmdq
index|[
name|i
index|]
operator|.
name|func
operator|=
name|run_drain_fifo
expr_stmt|;
name|sc
operator|->
name|cmdq
index|[
name|i
index|]
operator|.
name|arg0
operator|=
name|sc
expr_stmt|;
name|ieee80211_runtask
argument_list|(
name|ic
argument_list|,
operator|&
name|sc
operator|->
name|cmdq_task
argument_list|)
expr_stmt|;
block|}
block|}
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|sc
operator|->
name|sc_epq
index|[
name|qid
index|]
operator|.
name|tx_qh
argument_list|,
name|data
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|usbd_transfer_start
argument_list|(
name|sc
operator|->
name|sc_xfer
index|[
name|qid
index|]
argument_list|)
expr_stmt|;
name|DPRINTFN
argument_list|(
literal|8
argument_list|,
literal|"sending data frame len=%d rate=%d qid=%d\n"
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|+
call|(
name|int
call|)
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|rt2870_txd
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|rt2860_rxwi
argument_list|)
argument_list|)
argument_list|,
name|rt2860_rates
index|[
name|ridx
index|]
operator|.
name|rate
argument_list|,
name|qid
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|run_tx_mgt
parameter_list|(
name|struct
name|run_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|struct
name|ieee80211_node
modifier|*
name|ni
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|ifp
operator|->
name|if_l2com
decl_stmt|;
name|struct
name|run_node
modifier|*
name|rn
init|=
operator|(
name|void
operator|*
operator|)
name|ni
decl_stmt|;
name|struct
name|run_tx_data
modifier|*
name|data
decl_stmt|;
name|struct
name|ieee80211_frame
modifier|*
name|wh
decl_stmt|;
name|struct
name|rt2870_txd
modifier|*
name|txd
decl_stmt|;
name|struct
name|rt2860_txwi
modifier|*
name|txwi
decl_stmt|;
name|uint16_t
name|dur
decl_stmt|;
name|uint8_t
name|ridx
init|=
name|rn
operator|->
name|mgt_ridx
decl_stmt|;
name|uint8_t
name|type
decl_stmt|;
name|uint8_t
name|xflags
init|=
literal|0
decl_stmt|;
name|uint8_t
name|wflags
init|=
literal|0
decl_stmt|;
name|RUN_LOCK_ASSERT
argument_list|(
name|sc
argument_list|,
name|MA_OWNED
argument_list|)
expr_stmt|;
name|wh
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ieee80211_frame
operator|*
argument_list|)
expr_stmt|;
name|type
operator|=
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator|&
name|IEEE80211_FC0_TYPE_MASK
expr_stmt|;
comment|/* tell hardware to add timestamp for probe responses */
if|if
condition|(
operator|(
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator|&
operator|(
name|IEEE80211_FC0_TYPE_MASK
operator||
name|IEEE80211_FC0_SUBTYPE_MASK
operator|)
operator|)
operator|==
operator|(
name|IEEE80211_FC0_TYPE_MGT
operator||
name|IEEE80211_FC0_SUBTYPE_PROBE_RESP
operator|)
condition|)
name|wflags
operator||=
name|RT2860_TX_TS
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|IEEE80211_IS_MULTICAST
argument_list|(
name|wh
operator|->
name|i_addr1
argument_list|)
condition|)
block|{
name|xflags
operator||=
name|RT2860_TX_ACK
expr_stmt|;
name|dur
operator|=
name|ieee80211_ack_duration
argument_list|(
name|ic
operator|->
name|ic_rt
argument_list|,
name|rt2860_rates
index|[
name|ridx
index|]
operator|.
name|rate
argument_list|,
name|ic
operator|->
name|ic_flags
operator|&
name|IEEE80211_F_SHPREAMBLE
argument_list|)
expr_stmt|;
operator|*
operator|(
name|uint16_t
operator|*
operator|)
name|wh
operator|->
name|i_dur
operator|=
name|htole16
argument_list|(
name|dur
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|sc_epq
index|[
literal|0
index|]
operator|.
name|tx_nfree
operator|==
literal|0
condition|)
block|{
comment|/* let caller free mbuf */
name|ifp
operator|->
name|if_drv_flags
operator||=
name|IFF_DRV_OACTIVE
expr_stmt|;
return|return
operator|(
name|EIO
operator|)
return|;
block|}
name|data
operator|=
name|STAILQ_FIRST
argument_list|(
operator|&
name|sc
operator|->
name|sc_epq
index|[
literal|0
index|]
operator|.
name|tx_fh
argument_list|)
expr_stmt|;
name|STAILQ_REMOVE_HEAD
argument_list|(
operator|&
name|sc
operator|->
name|sc_epq
index|[
literal|0
index|]
operator|.
name|tx_fh
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_epq
index|[
literal|0
index|]
operator|.
name|tx_nfree
operator|--
expr_stmt|;
name|txd
operator|=
operator|(
expr|struct
name|rt2870_txd
operator|*
operator|)
operator|&
name|data
operator|->
name|desc
expr_stmt|;
name|txd
operator|->
name|flags
operator|=
name|RT2860_TX_QSEL_EDCA
expr_stmt|;
name|txwi
operator|=
operator|(
expr|struct
name|rt2860_txwi
operator|*
operator|)
operator|(
name|txd
operator|+
literal|1
operator|)
expr_stmt|;
name|txwi
operator|->
name|wcid
operator|=
literal|0xff
expr_stmt|;
name|txwi
operator|->
name|flags
operator|=
name|wflags
expr_stmt|;
name|txwi
operator|->
name|xflags
operator|=
name|xflags
expr_stmt|;
name|txwi
operator|->
name|txop
operator|=
literal|0
expr_stmt|;
comment|/* clear leftover garbage bits */
name|data
operator|->
name|m
operator|=
name|m
expr_stmt|;
name|data
operator|->
name|ni
operator|=
name|ni
expr_stmt|;
name|data
operator|->
name|ridx
operator|=
name|ridx
expr_stmt|;
name|run_set_tx_desc
argument_list|(
name|sc
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|DPRINTFN
argument_list|(
literal|10
argument_list|,
literal|"sending mgt frame len=%d rate=%d\n"
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|+
call|(
name|int
call|)
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|rt2870_txd
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|rt2860_rxwi
argument_list|)
argument_list|)
argument_list|,
name|rt2860_rates
index|[
name|ridx
index|]
operator|.
name|rate
argument_list|)
expr_stmt|;
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|sc
operator|->
name|sc_epq
index|[
literal|0
index|]
operator|.
name|tx_qh
argument_list|,
name|data
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|usbd_transfer_start
argument_list|(
name|sc
operator|->
name|sc_xfer
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|run_sendprot
parameter_list|(
name|struct
name|run_softc
modifier|*
name|sc
parameter_list|,
specifier|const
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|struct
name|ieee80211_node
modifier|*
name|ni
parameter_list|,
name|int
name|prot
parameter_list|,
name|int
name|rate
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|ni
operator|->
name|ni_ic
decl_stmt|;
name|struct
name|ieee80211_frame
modifier|*
name|wh
decl_stmt|;
name|struct
name|run_tx_data
modifier|*
name|data
decl_stmt|;
name|struct
name|rt2870_txd
modifier|*
name|txd
decl_stmt|;
name|struct
name|rt2860_txwi
modifier|*
name|txwi
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|mprot
decl_stmt|;
name|int
name|ridx
decl_stmt|;
name|int
name|protrate
decl_stmt|;
name|int
name|ackrate
decl_stmt|;
name|int
name|pktlen
decl_stmt|;
name|int
name|isshort
decl_stmt|;
name|uint16_t
name|dur
decl_stmt|;
name|uint8_t
name|type
decl_stmt|;
name|uint8_t
name|wflags
init|=
literal|0
decl_stmt|;
name|uint8_t
name|xflags
init|=
literal|0
decl_stmt|;
name|RUN_LOCK_ASSERT
argument_list|(
name|sc
argument_list|,
name|MA_OWNED
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|prot
operator|==
name|IEEE80211_PROT_RTSCTS
operator|||
name|prot
operator|==
name|IEEE80211_PROT_CTSONLY
argument_list|,
operator|(
literal|"protection %d"
operator|,
name|prot
operator|)
argument_list|)
expr_stmt|;
name|wh
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ieee80211_frame
operator|*
argument_list|)
expr_stmt|;
name|pktlen
operator|=
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|+
name|IEEE80211_CRC_LEN
expr_stmt|;
name|type
operator|=
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator|&
name|IEEE80211_FC0_TYPE_MASK
expr_stmt|;
name|protrate
operator|=
name|ieee80211_ctl_rate
argument_list|(
name|ic
operator|->
name|ic_rt
argument_list|,
name|rate
argument_list|)
expr_stmt|;
name|ackrate
operator|=
name|ieee80211_ack_rate
argument_list|(
name|ic
operator|->
name|ic_rt
argument_list|,
name|rate
argument_list|)
expr_stmt|;
name|isshort
operator|=
operator|(
name|ic
operator|->
name|ic_flags
operator|&
name|IEEE80211_F_SHPREAMBLE
operator|)
operator|!=
literal|0
expr_stmt|;
name|dur
operator|=
name|ieee80211_compute_duration
argument_list|(
name|ic
operator|->
name|ic_rt
argument_list|,
name|pktlen
argument_list|,
name|rate
argument_list|,
name|isshort
argument_list|)
operator|+
name|ieee80211_ack_duration
argument_list|(
name|ic
operator|->
name|ic_rt
argument_list|,
name|rate
argument_list|,
name|isshort
argument_list|)
expr_stmt|;
name|wflags
operator|=
name|RT2860_TX_FRAG
expr_stmt|;
comment|/* check that there are free slots before allocating the mbuf */
if|if
condition|(
name|sc
operator|->
name|sc_epq
index|[
literal|0
index|]
operator|.
name|tx_nfree
operator|==
literal|0
condition|)
block|{
comment|/* let caller free mbuf */
name|sc
operator|->
name|sc_ifp
operator|->
name|if_drv_flags
operator||=
name|IFF_DRV_OACTIVE
expr_stmt|;
return|return
operator|(
name|ENOBUFS
operator|)
return|;
block|}
if|if
condition|(
name|prot
operator|==
name|IEEE80211_PROT_RTSCTS
condition|)
block|{
comment|/* NB: CTS is the same size as an ACK */
name|dur
operator|+=
name|ieee80211_ack_duration
argument_list|(
name|ic
operator|->
name|ic_rt
argument_list|,
name|rate
argument_list|,
name|isshort
argument_list|)
expr_stmt|;
name|xflags
operator||=
name|RT2860_TX_ACK
expr_stmt|;
name|mprot
operator|=
name|ieee80211_alloc_rts
argument_list|(
name|ic
argument_list|,
name|wh
operator|->
name|i_addr1
argument_list|,
name|wh
operator|->
name|i_addr2
argument_list|,
name|dur
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|mprot
operator|=
name|ieee80211_alloc_cts
argument_list|(
name|ic
argument_list|,
name|ni
operator|->
name|ni_vap
operator|->
name|iv_myaddr
argument_list|,
name|dur
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mprot
operator|==
name|NULL
condition|)
block|{
name|sc
operator|->
name|sc_ifp
operator|->
name|if_oerrors
operator|++
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"could not allocate mbuf\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOBUFS
operator|)
return|;
block|}
name|data
operator|=
name|STAILQ_FIRST
argument_list|(
operator|&
name|sc
operator|->
name|sc_epq
index|[
literal|0
index|]
operator|.
name|tx_fh
argument_list|)
expr_stmt|;
name|STAILQ_REMOVE_HEAD
argument_list|(
operator|&
name|sc
operator|->
name|sc_epq
index|[
literal|0
index|]
operator|.
name|tx_fh
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_epq
index|[
literal|0
index|]
operator|.
name|tx_nfree
operator|--
expr_stmt|;
name|txd
operator|=
operator|(
expr|struct
name|rt2870_txd
operator|*
operator|)
operator|&
name|data
operator|->
name|desc
expr_stmt|;
name|txd
operator|->
name|flags
operator|=
name|RT2860_TX_QSEL_EDCA
expr_stmt|;
name|txwi
operator|=
operator|(
expr|struct
name|rt2860_txwi
operator|*
operator|)
operator|(
name|txd
operator|+
literal|1
operator|)
expr_stmt|;
name|txwi
operator|->
name|wcid
operator|=
literal|0xff
expr_stmt|;
name|txwi
operator|->
name|flags
operator|=
name|wflags
expr_stmt|;
name|txwi
operator|->
name|xflags
operator|=
name|xflags
expr_stmt|;
name|txwi
operator|->
name|txop
operator|=
literal|0
expr_stmt|;
comment|/* clear leftover garbage bits */
name|data
operator|->
name|m
operator|=
name|mprot
expr_stmt|;
name|data
operator|->
name|ni
operator|=
name|ieee80211_ref_node
argument_list|(
name|ni
argument_list|)
expr_stmt|;
for|for
control|(
name|ridx
operator|=
literal|0
init|;
name|ridx
operator|<
name|RT2860_RIDX_MAX
condition|;
name|ridx
operator|++
control|)
if|if
condition|(
name|rt2860_rates
index|[
name|ridx
index|]
operator|.
name|rate
operator|==
name|protrate
condition|)
break|break;
name|data
operator|->
name|ridx
operator|=
name|ridx
expr_stmt|;
name|run_set_tx_desc
argument_list|(
name|sc
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|DPRINTFN
argument_list|(
literal|1
argument_list|,
literal|"sending prot len=%u rate=%u\n"
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|,
name|rate
argument_list|)
expr_stmt|;
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|sc
operator|->
name|sc_epq
index|[
literal|0
index|]
operator|.
name|tx_qh
argument_list|,
name|data
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|usbd_transfer_start
argument_list|(
name|sc
operator|->
name|sc_xfer
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|run_tx_param
parameter_list|(
name|struct
name|run_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|struct
name|ieee80211_node
modifier|*
name|ni
parameter_list|,
specifier|const
name|struct
name|ieee80211_bpf_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|ni
operator|->
name|ni_ic
decl_stmt|;
name|struct
name|ieee80211_frame
modifier|*
name|wh
decl_stmt|;
name|struct
name|run_tx_data
modifier|*
name|data
decl_stmt|;
name|struct
name|rt2870_txd
modifier|*
name|txd
decl_stmt|;
name|struct
name|rt2860_txwi
modifier|*
name|txwi
decl_stmt|;
name|uint8_t
name|type
decl_stmt|;
name|uint8_t
name|ridx
decl_stmt|;
name|uint8_t
name|rate
decl_stmt|;
name|uint8_t
name|opflags
init|=
literal|0
decl_stmt|;
name|uint8_t
name|xflags
init|=
literal|0
decl_stmt|;
name|int
name|error
decl_stmt|;
name|RUN_LOCK_ASSERT
argument_list|(
name|sc
argument_list|,
name|MA_OWNED
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|params
operator|!=
name|NULL
argument_list|,
operator|(
literal|"no raw xmit params"
operator|)
argument_list|)
expr_stmt|;
name|wh
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ieee80211_frame
operator|*
argument_list|)
expr_stmt|;
name|type
operator|=
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator|&
name|IEEE80211_FC0_TYPE_MASK
expr_stmt|;
name|rate
operator|=
name|params
operator|->
name|ibp_rate0
expr_stmt|;
if|if
condition|(
operator|!
name|ieee80211_isratevalid
argument_list|(
name|ic
operator|->
name|ic_rt
argument_list|,
name|rate
argument_list|)
condition|)
block|{
comment|/* let caller free mbuf */
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|params
operator|->
name|ibp_flags
operator|&
name|IEEE80211_BPF_NOACK
operator|)
operator|==
literal|0
condition|)
name|xflags
operator||=
name|RT2860_TX_ACK
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|ibp_flags
operator|&
operator|(
name|IEEE80211_BPF_RTS
operator||
name|IEEE80211_BPF_CTS
operator|)
condition|)
block|{
name|error
operator|=
name|run_sendprot
argument_list|(
name|sc
argument_list|,
name|m
argument_list|,
name|ni
argument_list|,
name|params
operator|->
name|ibp_flags
operator|&
name|IEEE80211_BPF_RTS
condition|?
name|IEEE80211_PROT_RTSCTS
else|:
name|IEEE80211_PROT_CTSONLY
argument_list|,
name|rate
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
comment|/* let caller free mbuf */
return|return
name|error
return|;
block|}
name|opflags
operator||=
comment|/*XXX RT2573_TX_LONG_RETRY |*/
name|RT2860_TX_TXOP_SIFS
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|sc_epq
index|[
literal|0
index|]
operator|.
name|tx_nfree
operator|==
literal|0
condition|)
block|{
comment|/* let caller free mbuf */
name|sc
operator|->
name|sc_ifp
operator|->
name|if_drv_flags
operator||=
name|IFF_DRV_OACTIVE
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"sending raw frame, but tx ring is full\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EIO
operator|)
return|;
block|}
name|data
operator|=
name|STAILQ_FIRST
argument_list|(
operator|&
name|sc
operator|->
name|sc_epq
index|[
literal|0
index|]
operator|.
name|tx_fh
argument_list|)
expr_stmt|;
name|STAILQ_REMOVE_HEAD
argument_list|(
operator|&
name|sc
operator|->
name|sc_epq
index|[
literal|0
index|]
operator|.
name|tx_fh
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_epq
index|[
literal|0
index|]
operator|.
name|tx_nfree
operator|--
expr_stmt|;
name|txd
operator|=
operator|(
expr|struct
name|rt2870_txd
operator|*
operator|)
operator|&
name|data
operator|->
name|desc
expr_stmt|;
name|txd
operator|->
name|flags
operator|=
name|RT2860_TX_QSEL_EDCA
expr_stmt|;
name|txwi
operator|=
operator|(
expr|struct
name|rt2860_txwi
operator|*
operator|)
operator|(
name|txd
operator|+
literal|1
operator|)
expr_stmt|;
name|txwi
operator|->
name|wcid
operator|=
literal|0xff
expr_stmt|;
name|txwi
operator|->
name|xflags
operator|=
name|xflags
expr_stmt|;
name|txwi
operator|->
name|txop
operator|=
name|opflags
expr_stmt|;
name|txwi
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
comment|/* clear leftover garbage bits */
name|data
operator|->
name|m
operator|=
name|m
expr_stmt|;
name|data
operator|->
name|ni
operator|=
name|ni
expr_stmt|;
for|for
control|(
name|ridx
operator|=
literal|0
init|;
name|ridx
operator|<
name|RT2860_RIDX_MAX
condition|;
name|ridx
operator|++
control|)
if|if
condition|(
name|rt2860_rates
index|[
name|ridx
index|]
operator|.
name|rate
operator|==
name|rate
condition|)
break|break;
name|data
operator|->
name|ridx
operator|=
name|ridx
expr_stmt|;
name|run_set_tx_desc
argument_list|(
name|sc
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|DPRINTFN
argument_list|(
literal|10
argument_list|,
literal|"sending raw frame len=%u rate=%u\n"
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|,
name|rate
argument_list|)
expr_stmt|;
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|sc
operator|->
name|sc_epq
index|[
literal|0
index|]
operator|.
name|tx_qh
argument_list|,
name|data
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|usbd_transfer_start
argument_list|(
name|sc
operator|->
name|sc_xfer
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|run_raw_xmit
parameter_list|(
name|struct
name|ieee80211_node
modifier|*
name|ni
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
specifier|const
name|struct
name|ieee80211_bpf_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|ni
operator|->
name|ni_ic
operator|->
name|ic_ifp
decl_stmt|;
name|struct
name|run_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|RUN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* prevent management frames from being sent if we're not ready */
if|if
condition|(
operator|!
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
condition|)
block|{
name|error
operator|=
name|ENETDOWN
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|params
operator|==
name|NULL
condition|)
block|{
comment|/* tx mgt packet */
if|if
condition|(
operator|(
name|error
operator|=
name|run_tx_mgt
argument_list|(
name|sc
argument_list|,
name|m
argument_list|,
name|ni
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|ifp
operator|->
name|if_oerrors
operator|++
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"mgt tx failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
block|}
else|else
block|{
comment|/* tx raw packet with param */
if|if
condition|(
operator|(
name|error
operator|=
name|run_tx_param
argument_list|(
name|sc
argument_list|,
name|m
argument_list|,
name|ni
argument_list|,
name|params
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|ifp
operator|->
name|if_oerrors
operator|++
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"tx with param failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
block|}
name|ifp
operator|->
name|if_opackets
operator|++
expr_stmt|;
name|done
label|:
name|RUN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|m
operator|!=
name|NULL
condition|)
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|ieee80211_free_node
argument_list|(
name|ni
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|run_start
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|struct
name|run_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|ieee80211_node
modifier|*
name|ni
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|RUN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
operator|==
literal|0
condition|)
block|{
name|RUN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return;
block|}
for|for
control|(
init|;
condition|;
control|)
block|{
comment|/* send data frames */
name|IFQ_DRV_DEQUEUE
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
break|break;
name|ni
operator|=
operator|(
expr|struct
name|ieee80211_node
operator|*
operator|)
name|m
operator|->
name|m_pkthdr
operator|.
name|rcvif
expr_stmt|;
if|if
condition|(
name|run_tx
argument_list|(
name|sc
argument_list|,
name|m
argument_list|,
name|ni
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|IFQ_DRV_PREPEND
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator||=
name|IFF_DRV_OACTIVE
expr_stmt|;
break|break;
block|}
block|}
name|RUN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|run_ioctl
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|u_long
name|cmd
parameter_list|,
name|caddr_t
name|data
parameter_list|)
block|{
name|struct
name|run_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|sc
operator|->
name|sc_ifp
operator|->
name|if_l2com
decl_stmt|;
name|struct
name|ifreq
modifier|*
name|ifr
init|=
operator|(
expr|struct
name|ifreq
operator|*
operator|)
name|data
decl_stmt|;
name|int
name|startall
init|=
literal|0
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|SIOCSIFFLAGS
case|:
name|RUN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_UP
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
condition|)
block|{
name|startall
operator|=
literal|1
expr_stmt|;
name|run_init_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
else|else
name|run_update_promisc_locked
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|&&
operator|(
name|ic
operator|->
name|ic_nrunning
operator|==
literal|0
operator|||
name|sc
operator|->
name|rvp_cnt
operator|<=
literal|1
operator|)
condition|)
block|{
name|run_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
block|}
name|RUN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|startall
condition|)
name|ieee80211_start_all
argument_list|(
name|ic
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCGIFMEDIA
case|:
name|error
operator|=
name|ifmedia_ioctl
argument_list|(
name|ifp
argument_list|,
name|ifr
argument_list|,
operator|&
name|ic
operator|->
name|ic_media
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCGIFADDR
case|:
name|error
operator|=
name|ether_ioctl
argument_list|(
name|ifp
argument_list|,
name|cmd
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
default|default:
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|run_set_agc
parameter_list|(
name|struct
name|run_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|agc
parameter_list|)
block|{
name|uint8_t
name|bbp
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|mac_ver
operator|==
literal|0x3572
condition|)
block|{
name|run_bbp_read
argument_list|(
name|sc
argument_list|,
literal|27
argument_list|,
operator|&
name|bbp
argument_list|)
expr_stmt|;
name|bbp
operator|&=
operator|~
operator|(
literal|0x3
operator|<<
literal|5
operator|)
expr_stmt|;
name|run_bbp_write
argument_list|(
name|sc
argument_list|,
literal|27
argument_list|,
name|bbp
operator||
literal|0
operator|<<
literal|5
argument_list|)
expr_stmt|;
comment|/* select Rx0 */
name|run_bbp_write
argument_list|(
name|sc
argument_list|,
literal|66
argument_list|,
name|agc
argument_list|)
expr_stmt|;
name|run_bbp_write
argument_list|(
name|sc
argument_list|,
literal|27
argument_list|,
name|bbp
operator||
literal|1
operator|<<
literal|5
argument_list|)
expr_stmt|;
comment|/* select Rx1 */
name|run_bbp_write
argument_list|(
name|sc
argument_list|,
literal|66
argument_list|,
name|agc
argument_list|)
expr_stmt|;
block|}
else|else
name|run_bbp_write
argument_list|(
name|sc
argument_list|,
literal|66
argument_list|,
name|agc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|run_select_chan_group
parameter_list|(
name|struct
name|run_softc
modifier|*
name|sc
parameter_list|,
name|int
name|group
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
name|uint8_t
name|agc
decl_stmt|;
name|run_bbp_write
argument_list|(
name|sc
argument_list|,
literal|62
argument_list|,
literal|0x37
operator|-
name|sc
operator|->
name|lna
index|[
name|group
index|]
argument_list|)
expr_stmt|;
name|run_bbp_write
argument_list|(
name|sc
argument_list|,
literal|63
argument_list|,
literal|0x37
operator|-
name|sc
operator|->
name|lna
index|[
name|group
index|]
argument_list|)
expr_stmt|;
name|run_bbp_write
argument_list|(
name|sc
argument_list|,
literal|64
argument_list|,
literal|0x37
operator|-
name|sc
operator|->
name|lna
index|[
name|group
index|]
argument_list|)
expr_stmt|;
name|run_bbp_write
argument_list|(
name|sc
argument_list|,
literal|86
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
if|if
condition|(
name|group
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|ext_2ghz_lna
condition|)
block|{
name|run_bbp_write
argument_list|(
name|sc
argument_list|,
literal|82
argument_list|,
literal|0x62
argument_list|)
expr_stmt|;
name|run_bbp_write
argument_list|(
name|sc
argument_list|,
literal|75
argument_list|,
literal|0x46
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|run_bbp_write
argument_list|(
name|sc
argument_list|,
literal|82
argument_list|,
literal|0x84
argument_list|)
expr_stmt|;
name|run_bbp_write
argument_list|(
name|sc
argument_list|,
literal|75
argument_list|,
literal|0x50
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|sc
operator|->
name|mac_ver
operator|==
literal|0x3572
condition|)
name|run_bbp_write
argument_list|(
name|sc
argument_list|,
literal|82
argument_list|,
literal|0x94
argument_list|)
expr_stmt|;
else|else
name|run_bbp_write
argument_list|(
name|sc
argument_list|,
literal|82
argument_list|,
literal|0xf2
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|ext_5ghz_lna
condition|)
name|run_bbp_write
argument_list|(
name|sc
argument_list|,
literal|75
argument_list|,
literal|0x46
argument_list|)
expr_stmt|;
else|else
name|run_bbp_write
argument_list|(
name|sc
argument_list|,
literal|75
argument_list|,
literal|0x50
argument_list|)
expr_stmt|;
block|}
name|run_read
argument_list|(
name|sc
argument_list|,
name|RT2860_TX_BAND_CFG
argument_list|,
operator|&
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
operator|(
name|RT2860_5G_BAND_SEL_N
operator||
name|RT2860_5G_BAND_SEL_P
operator|)
expr_stmt|;
name|tmp
operator||=
operator|(
name|group
operator|==
literal|0
operator|)
condition|?
name|RT2860_5G_BAND_SEL_N
else|:
name|RT2860_5G_BAND_SEL_P
expr_stmt|;
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_TX_BAND_CFG
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* enable appropriate Power Amplifiers and Low Noise Amplifiers */
name|tmp
operator|=
name|RT2860_RFTR_EN
operator||
name|RT2860_TRSW_EN
operator||
name|RT2860_LNA_PE0_EN
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|nrxchains
operator|>
literal|1
condition|)
name|tmp
operator||=
name|RT2860_LNA_PE1_EN
expr_stmt|;
if|if
condition|(
name|group
operator|==
literal|0
condition|)
block|{
comment|/* 2GHz */
name|tmp
operator||=
name|RT2860_PA_PE_G0_EN
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|ntxchains
operator|>
literal|1
condition|)
name|tmp
operator||=
name|RT2860_PA_PE_G1_EN
expr_stmt|;
block|}
else|else
block|{
comment|/* 5GHz */
name|tmp
operator||=
name|RT2860_PA_PE_A0_EN
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|ntxchains
operator|>
literal|1
condition|)
name|tmp
operator||=
name|RT2860_PA_PE_A1_EN
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|mac_ver
operator|==
literal|0x3572
condition|)
block|{
name|run_rt3070_rf_write
argument_list|(
name|sc
argument_list|,
literal|8
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_TX_PIN_CFG
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|run_rt3070_rf_write
argument_list|(
name|sc
argument_list|,
literal|8
argument_list|,
literal|0x80
argument_list|)
expr_stmt|;
block|}
else|else
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_TX_PIN_CFG
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* set initial AGC value */
if|if
condition|(
name|group
operator|==
literal|0
condition|)
block|{
comment|/* 2GHz band */
if|if
condition|(
name|sc
operator|->
name|mac_ver
operator|>=
literal|0x3070
condition|)
name|agc
operator|=
literal|0x1c
operator|+
name|sc
operator|->
name|lna
index|[
literal|0
index|]
operator|*
literal|2
expr_stmt|;
else|else
name|agc
operator|=
literal|0x2e
operator|+
name|sc
operator|->
name|lna
index|[
literal|0
index|]
expr_stmt|;
block|}
else|else
block|{
comment|/* 5GHz band */
if|if
condition|(
name|sc
operator|->
name|mac_ver
operator|==
literal|0x3572
condition|)
name|agc
operator|=
literal|0x22
operator|+
operator|(
name|sc
operator|->
name|lna
index|[
name|group
index|]
operator|*
literal|5
operator|)
operator|/
literal|3
expr_stmt|;
else|else
name|agc
operator|=
literal|0x32
operator|+
operator|(
name|sc
operator|->
name|lna
index|[
name|group
index|]
operator|*
literal|5
operator|)
operator|/
literal|3
expr_stmt|;
block|}
name|run_set_agc
argument_list|(
name|sc
argument_list|,
name|agc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|run_rt2870_set_chan
parameter_list|(
name|struct
name|run_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|chan
parameter_list|)
block|{
specifier|const
name|struct
name|rfprog
modifier|*
name|rfprog
init|=
name|rt2860_rf2850
decl_stmt|;
name|uint32_t
name|r2
decl_stmt|,
name|r3
decl_stmt|,
name|r4
decl_stmt|;
name|int8_t
name|txpow1
decl_stmt|,
name|txpow2
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* find the settings for this channel (we know it exists) */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|rfprog
index|[
name|i
index|]
operator|.
name|chan
operator|!=
name|chan
condition|;
name|i
operator|++
control|)
empty_stmt|;
name|r2
operator|=
name|rfprog
index|[
name|i
index|]
operator|.
name|r2
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|ntxchains
operator|==
literal|1
condition|)
name|r2
operator||=
literal|1
operator|<<
literal|12
expr_stmt|;
comment|/* 1T: disable Tx chain 2 */
if|if
condition|(
name|sc
operator|->
name|nrxchains
operator|==
literal|1
condition|)
name|r2
operator||=
literal|1
operator|<<
literal|15
operator||
literal|1
operator|<<
literal|4
expr_stmt|;
comment|/* 1R: disable Rx chains 2& 3 */
elseif|else
if|if
condition|(
name|sc
operator|->
name|nrxchains
operator|==
literal|2
condition|)
name|r2
operator||=
literal|1
operator|<<
literal|4
expr_stmt|;
comment|/* 2R: disable Rx chain 3 */
comment|/* use Tx power values from EEPROM */
name|txpow1
operator|=
name|sc
operator|->
name|txpow1
index|[
name|i
index|]
expr_stmt|;
name|txpow2
operator|=
name|sc
operator|->
name|txpow2
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|chan
operator|>
literal|14
condition|)
block|{
if|if
condition|(
name|txpow1
operator|>=
literal|0
condition|)
name|txpow1
operator|=
name|txpow1
operator|<<
literal|1
operator||
literal|1
expr_stmt|;
else|else
name|txpow1
operator|=
operator|(
literal|7
operator|+
name|txpow1
operator|)
operator|<<
literal|1
expr_stmt|;
if|if
condition|(
name|txpow2
operator|>=
literal|0
condition|)
name|txpow2
operator|=
name|txpow2
operator|<<
literal|1
operator||
literal|1
expr_stmt|;
else|else
name|txpow2
operator|=
operator|(
literal|7
operator|+
name|txpow2
operator|)
operator|<<
literal|1
expr_stmt|;
block|}
name|r3
operator|=
name|rfprog
index|[
name|i
index|]
operator|.
name|r3
operator||
name|txpow1
operator|<<
literal|7
expr_stmt|;
name|r4
operator|=
name|rfprog
index|[
name|i
index|]
operator|.
name|r4
operator||
name|sc
operator|->
name|freq
operator|<<
literal|13
operator||
name|txpow2
operator|<<
literal|4
expr_stmt|;
name|run_rt2870_rf_write
argument_list|(
name|sc
argument_list|,
name|RT2860_RF1
argument_list|,
name|rfprog
index|[
name|i
index|]
operator|.
name|r1
argument_list|)
expr_stmt|;
name|run_rt2870_rf_write
argument_list|(
name|sc
argument_list|,
name|RT2860_RF2
argument_list|,
name|r2
argument_list|)
expr_stmt|;
name|run_rt2870_rf_write
argument_list|(
name|sc
argument_list|,
name|RT2860_RF3
argument_list|,
name|r3
argument_list|)
expr_stmt|;
name|run_rt2870_rf_write
argument_list|(
name|sc
argument_list|,
name|RT2860_RF4
argument_list|,
name|r4
argument_list|)
expr_stmt|;
name|run_delay
argument_list|(
name|sc
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|run_rt2870_rf_write
argument_list|(
name|sc
argument_list|,
name|RT2860_RF1
argument_list|,
name|rfprog
index|[
name|i
index|]
operator|.
name|r1
argument_list|)
expr_stmt|;
name|run_rt2870_rf_write
argument_list|(
name|sc
argument_list|,
name|RT2860_RF2
argument_list|,
name|r2
argument_list|)
expr_stmt|;
name|run_rt2870_rf_write
argument_list|(
name|sc
argument_list|,
name|RT2860_RF3
argument_list|,
name|r3
operator||
literal|1
argument_list|)
expr_stmt|;
name|run_rt2870_rf_write
argument_list|(
name|sc
argument_list|,
name|RT2860_RF4
argument_list|,
name|r4
argument_list|)
expr_stmt|;
name|run_delay
argument_list|(
name|sc
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|run_rt2870_rf_write
argument_list|(
name|sc
argument_list|,
name|RT2860_RF1
argument_list|,
name|rfprog
index|[
name|i
index|]
operator|.
name|r1
argument_list|)
expr_stmt|;
name|run_rt2870_rf_write
argument_list|(
name|sc
argument_list|,
name|RT2860_RF2
argument_list|,
name|r2
argument_list|)
expr_stmt|;
name|run_rt2870_rf_write
argument_list|(
name|sc
argument_list|,
name|RT2860_RF3
argument_list|,
name|r3
argument_list|)
expr_stmt|;
name|run_rt2870_rf_write
argument_list|(
name|sc
argument_list|,
name|RT2860_RF4
argument_list|,
name|r4
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|run_rt3070_set_chan
parameter_list|(
name|struct
name|run_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|chan
parameter_list|)
block|{
name|int8_t
name|txpow1
decl_stmt|,
name|txpow2
decl_stmt|;
name|uint8_t
name|rf
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* RT3070 is 2GHz only */
name|KASSERT
argument_list|(
name|chan
operator|>=
literal|1
operator|&&
name|chan
operator|<=
literal|14
argument_list|,
operator|(
literal|"wrong channel selected\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* find the settings for this channel (we know it exists) */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|rt2860_rf2850
index|[
name|i
index|]
operator|.
name|chan
operator|!=
name|chan
condition|;
name|i
operator|++
control|)
empty_stmt|;
comment|/* use Tx power values from EEPROM */
name|txpow1
operator|=
name|sc
operator|->
name|txpow1
index|[
name|i
index|]
expr_stmt|;
name|txpow2
operator|=
name|sc
operator|->
name|txpow2
index|[
name|i
index|]
expr_stmt|;
name|run_rt3070_rf_write
argument_list|(
name|sc
argument_list|,
literal|2
argument_list|,
name|rt3070_freqs
index|[
name|i
index|]
operator|.
name|n
argument_list|)
expr_stmt|;
name|run_rt3070_rf_write
argument_list|(
name|sc
argument_list|,
literal|3
argument_list|,
name|rt3070_freqs
index|[
name|i
index|]
operator|.
name|k
argument_list|)
expr_stmt|;
name|run_rt3070_rf_read
argument_list|(
name|sc
argument_list|,
literal|6
argument_list|,
operator|&
name|rf
argument_list|)
expr_stmt|;
name|rf
operator|=
operator|(
name|rf
operator|&
operator|~
literal|0x03
operator|)
operator||
name|rt3070_freqs
index|[
name|i
index|]
operator|.
name|r
expr_stmt|;
name|run_rt3070_rf_write
argument_list|(
name|sc
argument_list|,
literal|6
argument_list|,
name|rf
argument_list|)
expr_stmt|;
comment|/* set Tx0 power */
name|run_rt3070_rf_read
argument_list|(
name|sc
argument_list|,
literal|12
argument_list|,
operator|&
name|rf
argument_list|)
expr_stmt|;
name|rf
operator|=
operator|(
name|rf
operator|&
operator|~
literal|0x1f
operator|)
operator||
name|txpow1
expr_stmt|;
name|run_rt3070_rf_write
argument_list|(
name|sc
argument_list|,
literal|12
argument_list|,
name|rf
argument_list|)
expr_stmt|;
comment|/* set Tx1 power */
name|run_rt3070_rf_read
argument_list|(
name|sc
argument_list|,
literal|13
argument_list|,
operator|&
name|rf
argument_list|)
expr_stmt|;
name|rf
operator|=
operator|(
name|rf
operator|&
operator|~
literal|0x1f
operator|)
operator||
name|txpow2
expr_stmt|;
name|run_rt3070_rf_write
argument_list|(
name|sc
argument_list|,
literal|13
argument_list|,
name|rf
argument_list|)
expr_stmt|;
name|run_rt3070_rf_read
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|,
operator|&
name|rf
argument_list|)
expr_stmt|;
name|rf
operator|&=
operator|~
literal|0xfc
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|ntxchains
operator|==
literal|1
condition|)
name|rf
operator||=
literal|1
operator|<<
literal|7
operator||
literal|1
operator|<<
literal|5
expr_stmt|;
comment|/* 1T: disable Tx chains 2& 3 */
elseif|else
if|if
condition|(
name|sc
operator|->
name|ntxchains
operator|==
literal|2
condition|)
name|rf
operator||=
literal|1
operator|<<
literal|7
expr_stmt|;
comment|/* 2T: disable Tx chain 3 */
if|if
condition|(
name|sc
operator|->
name|nrxchains
operator|==
literal|1
condition|)
name|rf
operator||=
literal|1
operator|<<
literal|6
operator||
literal|1
operator|<<
literal|4
expr_stmt|;
comment|/* 1R: disable Rx chains 2& 3 */
elseif|else
if|if
condition|(
name|sc
operator|->
name|nrxchains
operator|==
literal|2
condition|)
name|rf
operator||=
literal|1
operator|<<
literal|6
expr_stmt|;
comment|/* 2R: disable Rx chain 3 */
name|run_rt3070_rf_write
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|,
name|rf
argument_list|)
expr_stmt|;
comment|/* set RF offset */
name|run_rt3070_rf_read
argument_list|(
name|sc
argument_list|,
literal|23
argument_list|,
operator|&
name|rf
argument_list|)
expr_stmt|;
name|rf
operator|=
operator|(
name|rf
operator|&
operator|~
literal|0x7f
operator|)
operator||
name|sc
operator|->
name|freq
expr_stmt|;
name|run_rt3070_rf_write
argument_list|(
name|sc
argument_list|,
literal|23
argument_list|,
name|rf
argument_list|)
expr_stmt|;
comment|/* program RF filter */
name|run_rt3070_rf_read
argument_list|(
name|sc
argument_list|,
literal|24
argument_list|,
operator|&
name|rf
argument_list|)
expr_stmt|;
comment|/* Tx */
name|rf
operator|=
operator|(
name|rf
operator|&
operator|~
literal|0x3f
operator|)
operator||
name|sc
operator|->
name|rf24_20mhz
expr_stmt|;
name|run_rt3070_rf_write
argument_list|(
name|sc
argument_list|,
literal|24
argument_list|,
name|rf
argument_list|)
expr_stmt|;
name|run_rt3070_rf_read
argument_list|(
name|sc
argument_list|,
literal|31
argument_list|,
operator|&
name|rf
argument_list|)
expr_stmt|;
comment|/* Rx */
name|rf
operator|=
operator|(
name|rf
operator|&
operator|~
literal|0x3f
operator|)
operator||
name|sc
operator|->
name|rf24_20mhz
expr_stmt|;
name|run_rt3070_rf_write
argument_list|(
name|sc
argument_list|,
literal|31
argument_list|,
name|rf
argument_list|)
expr_stmt|;
comment|/* enable RF tuning */
name|run_rt3070_rf_read
argument_list|(
name|sc
argument_list|,
literal|7
argument_list|,
operator|&
name|rf
argument_list|)
expr_stmt|;
name|run_rt3070_rf_write
argument_list|(
name|sc
argument_list|,
literal|7
argument_list|,
name|rf
operator||
literal|0x01
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|run_rt3572_set_chan
parameter_list|(
name|struct
name|run_softc
modifier|*
name|sc
parameter_list|,
name|u_int
name|chan
parameter_list|)
block|{
name|int8_t
name|txpow1
decl_stmt|,
name|txpow2
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
name|uint8_t
name|rf
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* find the settings for this channel (we know it exists) */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|rt2860_rf2850
index|[
name|i
index|]
operator|.
name|chan
operator|!=
name|chan
condition|;
name|i
operator|++
control|)
empty_stmt|;
comment|/* use Tx power values from EEPROM */
name|txpow1
operator|=
name|sc
operator|->
name|txpow1
index|[
name|i
index|]
expr_stmt|;
name|txpow2
operator|=
name|sc
operator|->
name|txpow2
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|chan
operator|<=
literal|14
condition|)
block|{
name|run_bbp_write
argument_list|(
name|sc
argument_list|,
literal|25
argument_list|,
name|sc
operator|->
name|bbp25
argument_list|)
expr_stmt|;
name|run_bbp_write
argument_list|(
name|sc
argument_list|,
literal|26
argument_list|,
name|sc
operator|->
name|bbp26
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* enable IQ phase correction */
name|run_bbp_write
argument_list|(
name|sc
argument_list|,
literal|25
argument_list|,
literal|0x09
argument_list|)
expr_stmt|;
name|run_bbp_write
argument_list|(
name|sc
argument_list|,
literal|26
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
block|}
name|run_rt3070_rf_write
argument_list|(
name|sc
argument_list|,
literal|2
argument_list|,
name|rt3070_freqs
index|[
name|i
index|]
operator|.
name|n
argument_list|)
expr_stmt|;
name|run_rt3070_rf_write
argument_list|(
name|sc
argument_list|,
literal|3
argument_list|,
name|rt3070_freqs
index|[
name|i
index|]
operator|.
name|k
argument_list|)
expr_stmt|;
name|run_rt3070_rf_read
argument_list|(
name|sc
argument_list|,
literal|6
argument_list|,
operator|&
name|rf
argument_list|)
expr_stmt|;
name|rf
operator|=
operator|(
name|rf
operator|&
operator|~
literal|0x0f
operator|)
operator||
name|rt3070_freqs
index|[
name|i
index|]
operator|.
name|r
expr_stmt|;
name|rf
operator||=
operator|(
name|chan
operator|<=
literal|14
operator|)
condition|?
literal|0x08
else|:
literal|0x04
expr_stmt|;
name|run_rt3070_rf_write
argument_list|(
name|sc
argument_list|,
literal|6
argument_list|,
name|rf
argument_list|)
expr_stmt|;
comment|/* set PLL mode */
name|run_rt3070_rf_read
argument_list|(
name|sc
argument_list|,
literal|5
argument_list|,
operator|&
name|rf
argument_list|)
expr_stmt|;
name|rf
operator|&=
operator|~
operator|(
literal|0x08
operator||
literal|0x04
operator|)
expr_stmt|;
name|rf
operator||=
operator|(
name|chan
operator|<=
literal|14
operator|)
condition|?
literal|0x04
else|:
literal|0x08
expr_stmt|;
name|run_rt3070_rf_write
argument_list|(
name|sc
argument_list|,
literal|5
argument_list|,
name|rf
argument_list|)
expr_stmt|;
comment|/* set Tx power for chain 0 */
if|if
condition|(
name|chan
operator|<=
literal|14
condition|)
name|rf
operator|=
literal|0x60
operator||
name|txpow1
expr_stmt|;
else|else
name|rf
operator|=
literal|0xe0
operator||
operator|(
name|txpow1
operator|&
literal|0xc
operator|)
operator|<<
literal|1
operator||
operator|(
name|txpow1
operator|&
literal|0x3
operator|)
expr_stmt|;
name|run_rt3070_rf_write
argument_list|(
name|sc
argument_list|,
literal|12
argument_list|,
name|rf
argument_list|)
expr_stmt|;
comment|/* set Tx power for chain 1 */
if|if
condition|(
name|chan
operator|<=
literal|14
condition|)
name|rf
operator|=
literal|0x60
operator||
name|txpow2
expr_stmt|;
else|else
name|rf
operator|=
literal|0xe0
operator||
operator|(
name|txpow2
operator|&
literal|0xc
operator|)
operator|<<
literal|1
operator||
operator|(
name|txpow2
operator|&
literal|0x3
operator|)
expr_stmt|;
name|run_rt3070_rf_write
argument_list|(
name|sc
argument_list|,
literal|13
argument_list|,
name|rf
argument_list|)
expr_stmt|;
comment|/* set Tx/Rx streams */
name|run_rt3070_rf_read
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|,
operator|&
name|rf
argument_list|)
expr_stmt|;
name|rf
operator|&=
operator|~
literal|0xfc
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|ntxchains
operator|==
literal|1
condition|)
name|rf
operator||=
literal|1
operator|<<
literal|7
operator||
literal|1
operator|<<
literal|5
expr_stmt|;
comment|/* 1T: disable Tx chains 2& 3 */
elseif|else
if|if
condition|(
name|sc
operator|->
name|ntxchains
operator|==
literal|2
condition|)
name|rf
operator||=
literal|1
operator|<<
literal|7
expr_stmt|;
comment|/* 2T: disable Tx chain 3 */
if|if
condition|(
name|sc
operator|->
name|nrxchains
operator|==
literal|1
condition|)
name|rf
operator||=
literal|1
operator|<<
literal|6
operator||
literal|1
operator|<<
literal|4
expr_stmt|;
comment|/* 1R: disable Rx chains 2& 3 */
elseif|else
if|if
condition|(
name|sc
operator|->
name|nrxchains
operator|==
literal|2
condition|)
name|rf
operator||=
literal|1
operator|<<
literal|6
expr_stmt|;
comment|/* 2R: disable Rx chain 3 */
name|run_rt3070_rf_write
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|,
name|rf
argument_list|)
expr_stmt|;
comment|/* set RF offset */
name|run_rt3070_rf_read
argument_list|(
name|sc
argument_list|,
literal|23
argument_list|,
operator|&
name|rf
argument_list|)
expr_stmt|;
name|rf
operator|=
operator|(
name|rf
operator|&
operator|~
literal|0x7f
operator|)
operator||
name|sc
operator|->
name|freq
expr_stmt|;
name|run_rt3070_rf_write
argument_list|(
name|sc
argument_list|,
literal|23
argument_list|,
name|rf
argument_list|)
expr_stmt|;
comment|/* program RF filter */
name|rf
operator|=
name|sc
operator|->
name|rf24_20mhz
expr_stmt|;
name|run_rt3070_rf_write
argument_list|(
name|sc
argument_list|,
literal|24
argument_list|,
name|rf
argument_list|)
expr_stmt|;
comment|/* Tx */
name|run_rt3070_rf_write
argument_list|(
name|sc
argument_list|,
literal|31
argument_list|,
name|rf
argument_list|)
expr_stmt|;
comment|/* Rx */
comment|/* enable RF tuning */
name|run_rt3070_rf_read
argument_list|(
name|sc
argument_list|,
literal|7
argument_list|,
operator|&
name|rf
argument_list|)
expr_stmt|;
name|rf
operator|=
operator|(
name|chan
operator|<=
literal|14
operator|)
condition|?
literal|0xd8
else|:
operator|(
operator|(
name|rf
operator|&
operator|~
literal|0xc8
operator|)
operator||
literal|0x14
operator|)
expr_stmt|;
name|run_rt3070_rf_write
argument_list|(
name|sc
argument_list|,
literal|7
argument_list|,
name|rf
argument_list|)
expr_stmt|;
comment|/* TSSI */
name|rf
operator|=
operator|(
name|chan
operator|<=
literal|14
operator|)
condition|?
literal|0xc3
else|:
literal|0xc0
expr_stmt|;
name|run_rt3070_rf_write
argument_list|(
name|sc
argument_list|,
literal|9
argument_list|,
name|rf
argument_list|)
expr_stmt|;
comment|/* set loop filter 1 */
name|run_rt3070_rf_write
argument_list|(
name|sc
argument_list|,
literal|10
argument_list|,
literal|0xf1
argument_list|)
expr_stmt|;
comment|/* set loop filter 2 */
name|run_rt3070_rf_write
argument_list|(
name|sc
argument_list|,
literal|11
argument_list|,
operator|(
name|chan
operator|<=
literal|14
operator|)
condition|?
literal|0xb9
else|:
literal|0x00
argument_list|)
expr_stmt|;
comment|/* set tx_mx2_ic */
name|run_rt3070_rf_write
argument_list|(
name|sc
argument_list|,
literal|15
argument_list|,
operator|(
name|chan
operator|<=
literal|14
operator|)
condition|?
literal|0x53
else|:
literal|0x43
argument_list|)
expr_stmt|;
comment|/* set tx_mx1_ic */
if|if
condition|(
name|chan
operator|<=
literal|14
condition|)
name|rf
operator|=
literal|0x48
operator||
name|sc
operator|->
name|txmixgain_2ghz
expr_stmt|;
else|else
name|rf
operator|=
literal|0x78
operator||
name|sc
operator|->
name|txmixgain_5ghz
expr_stmt|;
name|run_rt3070_rf_write
argument_list|(
name|sc
argument_list|,
literal|16
argument_list|,
name|rf
argument_list|)
expr_stmt|;
comment|/* set tx_lo1 */
name|run_rt3070_rf_write
argument_list|(
name|sc
argument_list|,
literal|17
argument_list|,
literal|0x23
argument_list|)
expr_stmt|;
comment|/* set tx_lo2 */
if|if
condition|(
name|chan
operator|<=
literal|14
condition|)
name|rf
operator|=
literal|0x93
expr_stmt|;
elseif|else
if|if
condition|(
name|chan
operator|<=
literal|64
condition|)
name|rf
operator|=
literal|0xb7
expr_stmt|;
elseif|else
if|if
condition|(
name|chan
operator|<=
literal|128
condition|)
name|rf
operator|=
literal|0x74
expr_stmt|;
else|else
name|rf
operator|=
literal|0x72
expr_stmt|;
name|run_rt3070_rf_write
argument_list|(
name|sc
argument_list|,
literal|19
argument_list|,
name|rf
argument_list|)
expr_stmt|;
comment|/* set rx_lo1 */
if|if
condition|(
name|chan
operator|<=
literal|14
condition|)
name|rf
operator|=
literal|0xb3
expr_stmt|;
elseif|else
if|if
condition|(
name|chan
operator|<=
literal|64
condition|)
name|rf
operator|=
literal|0xf6
expr_stmt|;
elseif|else
if|if
condition|(
name|chan
operator|<=
literal|128
condition|)
name|rf
operator|=
literal|0xf4
expr_stmt|;
else|else
name|rf
operator|=
literal|0xf3
expr_stmt|;
name|run_rt3070_rf_write
argument_list|(
name|sc
argument_list|,
literal|20
argument_list|,
name|rf
argument_list|)
expr_stmt|;
comment|/* set pfd_delay */
if|if
condition|(
name|chan
operator|<=
literal|14
condition|)
name|rf
operator|=
literal|0x15
expr_stmt|;
elseif|else
if|if
condition|(
name|chan
operator|<=
literal|64
condition|)
name|rf
operator|=
literal|0x3d
expr_stmt|;
else|else
name|rf
operator|=
literal|0x01
expr_stmt|;
name|run_rt3070_rf_write
argument_list|(
name|sc
argument_list|,
literal|25
argument_list|,
name|rf
argument_list|)
expr_stmt|;
comment|/* set rx_lo2 */
name|run_rt3070_rf_write
argument_list|(
name|sc
argument_list|,
literal|26
argument_list|,
operator|(
name|chan
operator|<=
literal|14
operator|)
condition|?
literal|0x85
else|:
literal|0x87
argument_list|)
expr_stmt|;
comment|/* set ldo_rf_vc */
name|run_rt3070_rf_write
argument_list|(
name|sc
argument_list|,
literal|27
argument_list|,
operator|(
name|chan
operator|<=
literal|14
operator|)
condition|?
literal|0x00
else|:
literal|0x01
argument_list|)
expr_stmt|;
comment|/* set drv_cc */
name|run_rt3070_rf_write
argument_list|(
name|sc
argument_list|,
literal|29
argument_list|,
operator|(
name|chan
operator|<=
literal|14
operator|)
condition|?
literal|0x9b
else|:
literal|0x9f
argument_list|)
expr_stmt|;
name|run_read
argument_list|(
name|sc
argument_list|,
name|RT2860_GPIO_CTRL
argument_list|,
operator|&
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
literal|0x8080
expr_stmt|;
if|if
condition|(
name|chan
operator|<=
literal|14
condition|)
name|tmp
operator||=
literal|0x80
expr_stmt|;
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_GPIO_CTRL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* enable RF tuning */
name|run_rt3070_rf_read
argument_list|(
name|sc
argument_list|,
literal|7
argument_list|,
operator|&
name|rf
argument_list|)
expr_stmt|;
name|run_rt3070_rf_write
argument_list|(
name|sc
argument_list|,
literal|7
argument_list|,
name|rf
operator||
literal|0x01
argument_list|)
expr_stmt|;
name|run_delay
argument_list|(
name|sc
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|run_set_rx_antenna
parameter_list|(
name|struct
name|run_softc
modifier|*
name|sc
parameter_list|,
name|int
name|aux
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
if|if
condition|(
name|aux
condition|)
block|{
name|run_mcu_cmd
argument_list|(
name|sc
argument_list|,
name|RT2860_MCU_CMD_ANTSEL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|run_read
argument_list|(
name|sc
argument_list|,
name|RT2860_GPIO_CTRL
argument_list|,
operator|&
name|tmp
argument_list|)
expr_stmt|;
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_GPIO_CTRL
argument_list|,
operator|(
name|tmp
operator|&
operator|~
literal|0x0808
operator|)
operator||
literal|0x08
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|run_mcu_cmd
argument_list|(
name|sc
argument_list|,
name|RT2860_MCU_CMD_ANTSEL
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|run_read
argument_list|(
name|sc
argument_list|,
name|RT2860_GPIO_CTRL
argument_list|,
operator|&
name|tmp
argument_list|)
expr_stmt|;
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_GPIO_CTRL
argument_list|,
name|tmp
operator|&
operator|~
literal|0x0808
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|run_set_chan
parameter_list|(
name|struct
name|run_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
name|c
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|sc
operator|->
name|sc_ifp
operator|->
name|if_l2com
decl_stmt|;
name|uint32_t
name|chan
decl_stmt|,
name|group
decl_stmt|;
name|chan
operator|=
name|ieee80211_chan2ieee
argument_list|(
name|ic
argument_list|,
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
name|chan
operator|==
literal|0
operator|||
name|chan
operator|==
name|IEEE80211_CHAN_ANY
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
name|sc
operator|->
name|mac_ver
operator|==
literal|0x3572
condition|)
name|run_rt3572_set_chan
argument_list|(
name|sc
argument_list|,
name|chan
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|sc
operator|->
name|mac_ver
operator|>=
literal|0x3070
condition|)
name|run_rt3070_set_chan
argument_list|(
name|sc
argument_list|,
name|chan
argument_list|)
expr_stmt|;
else|else
name|run_rt2870_set_chan
argument_list|(
name|sc
argument_list|,
name|chan
argument_list|)
expr_stmt|;
comment|/* determine channel group */
if|if
condition|(
name|chan
operator|<=
literal|14
condition|)
name|group
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|chan
operator|<=
literal|64
condition|)
name|group
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|chan
operator|<=
literal|128
condition|)
name|group
operator|=
literal|2
expr_stmt|;
else|else
name|group
operator|=
literal|3
expr_stmt|;
comment|/* XXX necessary only when group has changed! */
name|run_select_chan_group
argument_list|(
name|sc
argument_list|,
name|group
argument_list|)
expr_stmt|;
name|run_delay
argument_list|(
name|sc
argument_list|,
literal|10
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|run_set_channel
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|)
block|{
name|struct
name|run_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_ifp
operator|->
name|if_softc
decl_stmt|;
name|RUN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|run_set_chan
argument_list|(
name|sc
argument_list|,
name|ic
operator|->
name|ic_curchan
argument_list|)
expr_stmt|;
name|RUN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|run_scan_start
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|)
block|{
name|struct
name|run_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_ifp
operator|->
name|if_softc
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
name|RUN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* abort TSF synchronization */
name|run_read
argument_list|(
name|sc
argument_list|,
name|RT2860_BCN_TIME_CFG
argument_list|,
operator|&
name|tmp
argument_list|)
expr_stmt|;
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_BCN_TIME_CFG
argument_list|,
name|tmp
operator|&
operator|~
operator|(
name|RT2860_BCN_TX_EN
operator||
name|RT2860_TSF_TIMER_EN
operator||
name|RT2860_TBTT_TIMER_EN
operator|)
argument_list|)
expr_stmt|;
name|run_set_bssid
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|sc_ifp
operator|->
name|if_broadcastaddr
argument_list|)
expr_stmt|;
name|RUN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|run_scan_end
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|)
block|{
name|struct
name|run_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_ifp
operator|->
name|if_softc
decl_stmt|;
name|RUN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|run_enable_tsf_sync
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* XXX keep local copy */
name|run_set_bssid
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|sc_bssid
argument_list|)
expr_stmt|;
name|RUN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*  * Could be called from ieee80211_node_timeout()  * (non-sleepable thread)  */
end_comment

begin_function
specifier|static
name|void
name|run_update_beacon
parameter_list|(
name|struct
name|ieee80211vap
modifier|*
name|vap
parameter_list|,
name|int
name|item
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|vap
operator|->
name|iv_ic
decl_stmt|;
name|struct
name|run_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_ifp
operator|->
name|if_softc
decl_stmt|;
name|uint32_t
name|i
decl_stmt|;
name|i
operator|=
name|RUN_CMDQ_GET
argument_list|(
operator|&
name|sc
operator|->
name|cmdq_store
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"cmdq_store=%d\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|sc
operator|->
name|cmdq
index|[
name|i
index|]
operator|.
name|func
operator|=
name|run_update_beacon_cb
expr_stmt|;
name|sc
operator|->
name|cmdq
index|[
name|i
index|]
operator|.
name|arg0
operator|=
name|vap
expr_stmt|;
name|ieee80211_runtask
argument_list|(
name|ic
argument_list|,
operator|&
name|sc
operator|->
name|cmdq_task
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|run_update_beacon_cb
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|ieee80211vap
modifier|*
name|vap
init|=
name|arg
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|vap
operator|->
name|iv_ic
decl_stmt|;
name|struct
name|run_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|rt2860_txwi
name|txwi
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|uint8_t
name|ridx
decl_stmt|;
if|if
condition|(
name|vap
operator|->
name|iv_bss
operator|->
name|ni_chan
operator|==
name|IEEE80211_CHAN_ANYC
condition|)
return|return;
if|if
condition|(
operator|(
name|m
operator|=
name|ieee80211_beacon_alloc
argument_list|(
name|vap
operator|->
name|iv_bss
argument_list|,
operator|&
name|RUN_VAP
argument_list|(
name|vap
argument_list|)
operator|->
name|bo
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return;
name|memset
argument_list|(
operator|&
name|txwi
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|txwi
argument_list|)
expr_stmt|;
name|txwi
operator|.
name|wcid
operator|=
literal|0xff
expr_stmt|;
name|txwi
operator|.
name|len
operator|=
name|htole16
argument_list|(
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|)
expr_stmt|;
comment|/* send beacons at the lowest available rate */
name|ridx
operator|=
operator|(
name|ic
operator|->
name|ic_curmode
operator|==
name|IEEE80211_MODE_11A
operator|)
condition|?
name|RT2860_RIDX_OFDM6
else|:
name|RT2860_RIDX_CCK1
expr_stmt|;
name|txwi
operator|.
name|phy
operator|=
name|htole16
argument_list|(
name|rt2860_rates
index|[
name|ridx
index|]
operator|.
name|mcs
argument_list|)
expr_stmt|;
if|if
condition|(
name|rt2860_rates
index|[
name|ridx
index|]
operator|.
name|phy
operator|==
name|IEEE80211_T_OFDM
condition|)
name|txwi
operator|.
name|phy
operator||=
name|htole16
argument_list|(
name|RT2860_PHY_OFDM
argument_list|)
expr_stmt|;
name|txwi
operator|.
name|txop
operator|=
name|RT2860_TX_TXOP_HT
expr_stmt|;
name|txwi
operator|.
name|flags
operator|=
name|RT2860_TX_TS
expr_stmt|;
name|txwi
operator|.
name|xflags
operator|=
name|RT2860_TX_NSEQ
expr_stmt|;
name|run_write_region_1
argument_list|(
name|sc
argument_list|,
name|RT2860_BCN_BASE
argument_list|(
name|RUN_VAP
argument_list|(
name|vap
argument_list|)
operator|->
name|rvp_id
argument_list|)
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|txwi
argument_list|,
sizeof|sizeof
name|txwi
argument_list|)
expr_stmt|;
name|run_write_region_1
argument_list|(
name|sc
argument_list|,
name|RT2860_BCN_BASE
argument_list|(
name|RUN_VAP
argument_list|(
name|vap
argument_list|)
operator|->
name|rvp_id
argument_list|)
operator|+
sizeof|sizeof
name|txwi
argument_list|,
name|mtod
argument_list|(
name|m
argument_list|,
name|uint8_t
operator|*
argument_list|)
argument_list|,
operator|(
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|+
literal|1
operator|)
operator|&
operator|~
literal|1
argument_list|)
expr_stmt|;
comment|/* roundup len */
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|run_updateprot
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|)
block|{
name|struct
name|run_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_ifp
operator|->
name|if_softc
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
name|tmp
operator|=
name|RT2860_RTSTH_EN
operator||
name|RT2860_PROT_NAV_SHORT
operator||
name|RT2860_TXOP_ALLOW_ALL
expr_stmt|;
comment|/* setup protection frame rate (MCS code) */
name|tmp
operator||=
operator|(
name|ic
operator|->
name|ic_curmode
operator|==
name|IEEE80211_MODE_11A
operator|)
condition|?
name|rt2860_rates
index|[
name|RT2860_RIDX_OFDM6
index|]
operator|.
name|mcs
else|:
name|rt2860_rates
index|[
name|RT2860_RIDX_CCK11
index|]
operator|.
name|mcs
expr_stmt|;
comment|/* CCK frames don't require protection */
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_CCK_PROT_CFG
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|ic
operator|->
name|ic_flags
operator|&
name|IEEE80211_F_USEPROT
condition|)
block|{
if|if
condition|(
name|ic
operator|->
name|ic_protmode
operator|==
name|IEEE80211_PROT_RTSCTS
condition|)
name|tmp
operator||=
name|RT2860_PROT_CTRL_RTS_CTS
expr_stmt|;
elseif|else
if|if
condition|(
name|ic
operator|->
name|ic_protmode
operator|==
name|IEEE80211_PROT_CTSONLY
condition|)
name|tmp
operator||=
name|RT2860_PROT_CTRL_CTS
expr_stmt|;
block|}
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_OFDM_PROT_CFG
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|run_usb_timeout_cb
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|ieee80211vap
modifier|*
name|vap
init|=
name|arg
decl_stmt|;
name|struct
name|run_softc
modifier|*
name|sc
init|=
name|vap
operator|->
name|iv_ic
operator|->
name|ic_ifp
operator|->
name|if_softc
decl_stmt|;
name|RUN_LOCK_ASSERT
argument_list|(
name|sc
argument_list|,
name|MA_OWNED
argument_list|)
expr_stmt|;
if|if
condition|(
name|vap
operator|->
name|iv_state
operator|==
name|IEEE80211_S_RUN
operator|&&
name|vap
operator|->
name|iv_opmode
operator|!=
name|IEEE80211_M_STA
condition|)
name|run_reset_livelock
argument_list|(
name|sc
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|vap
operator|->
name|iv_state
operator|==
name|IEEE80211_S_SCAN
condition|)
block|{
name|DPRINTF
argument_list|(
literal|"timeout caused by scan\n"
argument_list|)
expr_stmt|;
comment|/* cancel bgscan */
name|ieee80211_cancel_scan
argument_list|(
name|vap
argument_list|)
expr_stmt|;
block|}
else|else
name|DPRINTF
argument_list|(
literal|"timeout by unknown cause\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|run_reset_livelock
parameter_list|(
name|struct
name|run_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
name|RUN_LOCK_ASSERT
argument_list|(
name|sc
argument_list|,
name|MA_OWNED
argument_list|)
expr_stmt|;
comment|/* 	 * In IBSS or HostAP modes (when the hardware sends beacons), the MAC 	 * can run into a livelock and start sending CTS-to-self frames like 	 * crazy if protection is enabled.  Reset MAC/BBP for a while 	 */
name|run_read
argument_list|(
name|sc
argument_list|,
name|RT2860_DEBUG
argument_list|,
operator|&
name|tmp
argument_list|)
expr_stmt|;
name|DPRINTFN
argument_list|(
literal|3
argument_list|,
literal|"debug reg %08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|tmp
operator|&
operator|(
literal|1
operator|<<
literal|29
operator|)
operator|)
operator|&&
operator|(
name|tmp
operator|&
operator|(
literal|1
operator|<<
literal|7
operator||
literal|1
operator|<<
literal|5
operator|)
operator|)
condition|)
block|{
name|DPRINTF
argument_list|(
literal|"CTS-to-self livelock detected\n"
argument_list|)
expr_stmt|;
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_MAC_SYS_CTRL
argument_list|,
name|RT2860_MAC_SRST
argument_list|)
expr_stmt|;
name|run_delay
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_MAC_SYS_CTRL
argument_list|,
name|RT2860_MAC_RX_EN
operator||
name|RT2860_MAC_TX_EN
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|run_update_promisc_locked
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|struct
name|run_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
name|run_read
argument_list|(
name|sc
argument_list|,
name|RT2860_RX_FILTR_CFG
argument_list|,
operator|&
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|RT2860_DROP_UC_NOME
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_PROMISC
condition|)
name|tmp
operator|&=
operator|~
name|RT2860_DROP_UC_NOME
expr_stmt|;
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_RX_FILTR_CFG
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"%s promiscuous mode\n"
argument_list|,
operator|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_PROMISC
operator|)
condition|?
literal|"entering"
else|:
literal|"leaving"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|run_update_promisc
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|struct
name|run_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
operator|==
literal|0
condition|)
return|return;
name|RUN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|run_update_promisc_locked
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|RUN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|run_enable_tsf_sync
parameter_list|(
name|struct
name|run_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|sc
operator|->
name|sc_ifp
operator|->
name|if_l2com
decl_stmt|;
name|struct
name|ieee80211vap
modifier|*
name|vap
init|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|ic
operator|->
name|ic_vaps
argument_list|)
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
name|DPRINTF
argument_list|(
literal|"rvp_id=%d ic_opmode=%d\n"
argument_list|,
name|RUN_VAP
argument_list|(
name|vap
argument_list|)
operator|->
name|rvp_id
argument_list|,
name|ic
operator|->
name|ic_opmode
argument_list|)
expr_stmt|;
name|run_read
argument_list|(
name|sc
argument_list|,
name|RT2860_BCN_TIME_CFG
argument_list|,
operator|&
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
literal|0x1fffff
expr_stmt|;
name|tmp
operator||=
name|vap
operator|->
name|iv_bss
operator|->
name|ni_intval
operator|*
literal|16
expr_stmt|;
name|tmp
operator||=
name|RT2860_TSF_TIMER_EN
operator||
name|RT2860_TBTT_TIMER_EN
expr_stmt|;
if|if
condition|(
name|ic
operator|->
name|ic_opmode
operator|==
name|IEEE80211_M_STA
condition|)
block|{
comment|/* 		 * Local TSF is always updated with remote TSF on beacon 		 * reception. 		 */
name|tmp
operator||=
literal|1
operator|<<
name|RT2860_TSF_SYNC_MODE_SHIFT
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ic
operator|->
name|ic_opmode
operator|==
name|IEEE80211_M_IBSS
condition|)
block|{
name|tmp
operator||=
name|RT2860_BCN_TX_EN
expr_stmt|;
comment|/* 	         * Local TSF is updated with remote TSF on beacon reception 	         * only if the remote TSF is greater than local TSF. 	         */
name|tmp
operator||=
literal|2
operator|<<
name|RT2860_TSF_SYNC_MODE_SHIFT
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ic
operator|->
name|ic_opmode
operator|==
name|IEEE80211_M_HOSTAP
operator|||
name|ic
operator|->
name|ic_opmode
operator|==
name|IEEE80211_M_MBSS
condition|)
block|{
name|tmp
operator||=
name|RT2860_BCN_TX_EN
expr_stmt|;
comment|/* SYNC with nobody */
name|tmp
operator||=
literal|3
operator|<<
name|RT2860_TSF_SYNC_MODE_SHIFT
expr_stmt|;
block|}
else|else
block|{
name|DPRINTF
argument_list|(
literal|"Enabling TSF failed. undefined opmode\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_BCN_TIME_CFG
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|run_enable_mrr
parameter_list|(
name|struct
name|run_softc
modifier|*
name|sc
parameter_list|)
block|{
define|#
directive|define
name|CCK
parameter_list|(
name|mcs
parameter_list|)
value|(mcs)
define|#
directive|define
name|OFDM
parameter_list|(
name|mcs
parameter_list|)
value|(1<< 3 | (mcs))
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_LG_FBK_CFG0
argument_list|,
name|OFDM
argument_list|(
literal|6
argument_list|)
operator|<<
literal|28
operator||
comment|/* 54->48 */
name|OFDM
argument_list|(
literal|5
argument_list|)
operator|<<
literal|24
operator||
comment|/* 48->36 */
name|OFDM
argument_list|(
literal|4
argument_list|)
operator|<<
literal|20
operator||
comment|/* 36->24 */
name|OFDM
argument_list|(
literal|3
argument_list|)
operator|<<
literal|16
operator||
comment|/* 24->18 */
name|OFDM
argument_list|(
literal|2
argument_list|)
operator|<<
literal|12
operator||
comment|/* 18->12 */
name|OFDM
argument_list|(
literal|1
argument_list|)
operator|<<
literal|8
operator||
comment|/* 12-> 9 */
name|OFDM
argument_list|(
literal|0
argument_list|)
operator|<<
literal|4
operator||
comment|/*  9-> 6 */
name|OFDM
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
comment|/*  6-> 6 */
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_LG_FBK_CFG1
argument_list|,
name|CCK
argument_list|(
literal|2
argument_list|)
operator|<<
literal|12
operator||
comment|/* 11->5.5 */
name|CCK
argument_list|(
literal|1
argument_list|)
operator|<<
literal|8
operator||
comment|/* 5.5-> 2 */
name|CCK
argument_list|(
literal|0
argument_list|)
operator|<<
literal|4
operator||
comment|/*   2-> 1 */
name|CCK
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
comment|/*   1-> 1 */
undef|#
directive|undef
name|OFDM
undef|#
directive|undef
name|CCK
block|}
end_function

begin_function
specifier|static
name|void
name|run_set_txpreamble
parameter_list|(
name|struct
name|run_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|sc
operator|->
name|sc_ifp
operator|->
name|if_l2com
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
name|run_read
argument_list|(
name|sc
argument_list|,
name|RT2860_AUTO_RSP_CFG
argument_list|,
operator|&
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|ic
operator|->
name|ic_flags
operator|&
name|IEEE80211_F_SHPREAMBLE
condition|)
name|tmp
operator||=
name|RT2860_CCK_SHORT_EN
expr_stmt|;
else|else
name|tmp
operator|&=
operator|~
name|RT2860_CCK_SHORT_EN
expr_stmt|;
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_AUTO_RSP_CFG
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|run_set_basicrates
parameter_list|(
name|struct
name|run_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|sc
operator|->
name|sc_ifp
operator|->
name|if_l2com
decl_stmt|;
comment|/* set basic rates mask */
if|if
condition|(
name|ic
operator|->
name|ic_curmode
operator|==
name|IEEE80211_MODE_11B
condition|)
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_LEGACY_BASIC_RATE
argument_list|,
literal|0x003
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|ic
operator|->
name|ic_curmode
operator|==
name|IEEE80211_MODE_11A
condition|)
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_LEGACY_BASIC_RATE
argument_list|,
literal|0x150
argument_list|)
expr_stmt|;
else|else
comment|/* 11g */
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_LEGACY_BASIC_RATE
argument_list|,
literal|0x15f
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|run_set_leds
parameter_list|(
name|struct
name|run_softc
modifier|*
name|sc
parameter_list|,
name|uint16_t
name|which
parameter_list|)
block|{
operator|(
name|void
operator|)
name|run_mcu_cmd
argument_list|(
name|sc
argument_list|,
name|RT2860_MCU_CMD_LEDS
argument_list|,
name|which
operator||
operator|(
name|sc
operator|->
name|leds
operator|&
literal|0x7f
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|run_set_bssid
parameter_list|(
name|struct
name|run_softc
modifier|*
name|sc
parameter_list|,
specifier|const
name|uint8_t
modifier|*
name|bssid
parameter_list|)
block|{
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_MAC_BSSID_DW0
argument_list|,
name|bssid
index|[
literal|0
index|]
operator||
name|bssid
index|[
literal|1
index|]
operator|<<
literal|8
operator||
name|bssid
index|[
literal|2
index|]
operator|<<
literal|16
operator||
name|bssid
index|[
literal|3
index|]
operator|<<
literal|24
argument_list|)
expr_stmt|;
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_MAC_BSSID_DW1
argument_list|,
name|bssid
index|[
literal|4
index|]
operator||
name|bssid
index|[
literal|5
index|]
operator|<<
literal|8
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|run_set_macaddr
parameter_list|(
name|struct
name|run_softc
modifier|*
name|sc
parameter_list|,
specifier|const
name|uint8_t
modifier|*
name|addr
parameter_list|)
block|{
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_MAC_ADDR_DW0
argument_list|,
name|addr
index|[
literal|0
index|]
operator||
name|addr
index|[
literal|1
index|]
operator|<<
literal|8
operator||
name|addr
index|[
literal|2
index|]
operator|<<
literal|16
operator||
name|addr
index|[
literal|3
index|]
operator|<<
literal|24
argument_list|)
expr_stmt|;
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_MAC_ADDR_DW1
argument_list|,
name|addr
index|[
literal|4
index|]
operator||
name|addr
index|[
literal|5
index|]
operator|<<
literal|8
operator||
literal|0xff
operator|<<
literal|16
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|void
name|run_updateslot
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|struct
name|run_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|ifp
operator|->
name|if_l2com
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
name|run_read
argument_list|(
name|sc
argument_list|,
name|RT2860_BKOFF_SLOT_CFG
argument_list|,
operator|&
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
literal|0xff
expr_stmt|;
name|tmp
operator||=
operator|(
name|ic
operator|->
name|ic_flags
operator|&
name|IEEE80211_F_SHSLOT
operator|)
condition|?
literal|9
else|:
literal|20
expr_stmt|;
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_BKOFF_SLOT_CFG
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|run_update_mcast
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
comment|/* h/w filter supports getting everything or nothing */
name|ifp
operator|->
name|if_flags
operator||=
name|IFF_ALLMULTI
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int8_t
name|run_rssi2dbm
parameter_list|(
name|struct
name|run_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|rssi
parameter_list|,
name|uint8_t
name|rxchain
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|sc
operator|->
name|sc_ifp
operator|->
name|if_l2com
decl_stmt|;
name|struct
name|ieee80211_channel
modifier|*
name|c
init|=
name|ic
operator|->
name|ic_curchan
decl_stmt|;
name|int
name|delta
decl_stmt|;
if|if
condition|(
name|IEEE80211_IS_CHAN_5GHZ
argument_list|(
name|c
argument_list|)
condition|)
block|{
name|uint32_t
name|chan
init|=
name|ieee80211_chan2ieee
argument_list|(
name|ic
argument_list|,
name|c
argument_list|)
decl_stmt|;
name|delta
operator|=
name|sc
operator|->
name|rssi_5ghz
index|[
name|rxchain
index|]
expr_stmt|;
comment|/* determine channel group */
if|if
condition|(
name|chan
operator|<=
literal|64
condition|)
name|delta
operator|-=
name|sc
operator|->
name|lna
index|[
literal|1
index|]
expr_stmt|;
elseif|else
if|if
condition|(
name|chan
operator|<=
literal|128
condition|)
name|delta
operator|-=
name|sc
operator|->
name|lna
index|[
literal|2
index|]
expr_stmt|;
else|else
name|delta
operator|-=
name|sc
operator|->
name|lna
index|[
literal|3
index|]
expr_stmt|;
block|}
else|else
name|delta
operator|=
name|sc
operator|->
name|rssi_2ghz
index|[
name|rxchain
index|]
operator|-
name|sc
operator|->
name|lna
index|[
literal|0
index|]
expr_stmt|;
return|return
operator|(
operator|-
literal|12
operator|-
name|delta
operator|-
name|rssi
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|run_bbp_init
parameter_list|(
name|struct
name|run_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|error
decl_stmt|,
name|ntries
decl_stmt|;
name|uint8_t
name|bbp0
decl_stmt|;
comment|/* wait for BBP to wake up */
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|20
condition|;
name|ntries
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|run_bbp_read
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
operator|&
name|bbp0
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|error
return|;
if|if
condition|(
name|bbp0
operator|!=
literal|0
operator|&&
name|bbp0
operator|!=
literal|0xff
condition|)
break|break;
block|}
if|if
condition|(
name|ntries
operator|==
literal|20
condition|)
return|return
operator|(
name|ETIMEDOUT
operator|)
return|;
comment|/* initialize BBP registers to default values */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nitems
argument_list|(
name|rt2860_def_bbp
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|run_bbp_write
argument_list|(
name|sc
argument_list|,
name|rt2860_def_bbp
index|[
name|i
index|]
operator|.
name|reg
argument_list|,
name|rt2860_def_bbp
index|[
name|i
index|]
operator|.
name|val
argument_list|)
expr_stmt|;
block|}
comment|/* fix BBP84 for RT2860E */
if|if
condition|(
name|sc
operator|->
name|mac_ver
operator|==
literal|0x2860
operator|&&
name|sc
operator|->
name|mac_rev
operator|!=
literal|0x0101
condition|)
name|run_bbp_write
argument_list|(
name|sc
argument_list|,
literal|84
argument_list|,
literal|0x19
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|mac_ver
operator|>=
literal|0x3070
condition|)
block|{
name|run_bbp_write
argument_list|(
name|sc
argument_list|,
literal|79
argument_list|,
literal|0x13
argument_list|)
expr_stmt|;
name|run_bbp_write
argument_list|(
name|sc
argument_list|,
literal|80
argument_list|,
literal|0x05
argument_list|)
expr_stmt|;
name|run_bbp_write
argument_list|(
name|sc
argument_list|,
literal|81
argument_list|,
literal|0x33
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sc
operator|->
name|mac_ver
operator|==
literal|0x2860
operator|&&
name|sc
operator|->
name|mac_rev
operator|==
literal|0x0100
condition|)
block|{
name|run_bbp_write
argument_list|(
name|sc
argument_list|,
literal|69
argument_list|,
literal|0x16
argument_list|)
expr_stmt|;
name|run_bbp_write
argument_list|(
name|sc
argument_list|,
literal|73
argument_list|,
literal|0x12
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|run_rt3070_rf_init
parameter_list|(
name|struct
name|run_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
name|uint8_t
name|rf
decl_stmt|,
name|target
decl_stmt|,
name|bbp4
decl_stmt|;
name|int
name|i
decl_stmt|;
name|run_rt3070_rf_read
argument_list|(
name|sc
argument_list|,
literal|30
argument_list|,
operator|&
name|rf
argument_list|)
expr_stmt|;
comment|/* toggle RF R30 bit 7 */
name|run_rt3070_rf_write
argument_list|(
name|sc
argument_list|,
literal|30
argument_list|,
name|rf
operator||
literal|0x80
argument_list|)
expr_stmt|;
name|run_delay
argument_list|(
name|sc
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|run_rt3070_rf_write
argument_list|(
name|sc
argument_list|,
literal|30
argument_list|,
name|rf
operator|&
operator|~
literal|0x80
argument_list|)
expr_stmt|;
comment|/* initialize RF registers to default value */
if|if
condition|(
name|sc
operator|->
name|mac_ver
operator|==
literal|0x3572
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nitems
argument_list|(
name|rt3572_def_rf
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|run_rt3070_rf_write
argument_list|(
name|sc
argument_list|,
name|rt3572_def_rf
index|[
name|i
index|]
operator|.
name|reg
argument_list|,
name|rt3572_def_rf
index|[
name|i
index|]
operator|.
name|val
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nitems
argument_list|(
name|rt3070_def_rf
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|run_rt3070_rf_write
argument_list|(
name|sc
argument_list|,
name|rt3070_def_rf
index|[
name|i
index|]
operator|.
name|reg
argument_list|,
name|rt3070_def_rf
index|[
name|i
index|]
operator|.
name|val
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|sc
operator|->
name|mac_ver
operator|==
literal|0x3070
condition|)
block|{
comment|/* change voltage from 1.2V to 1.35V for RT3070 */
name|run_read
argument_list|(
name|sc
argument_list|,
name|RT3070_LDO_CFG0
argument_list|,
operator|&
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
operator|(
name|tmp
operator|&
operator|~
literal|0x0f000000
operator|)
operator||
literal|0x0d000000
expr_stmt|;
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT3070_LDO_CFG0
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sc
operator|->
name|mac_ver
operator|==
literal|0x3071
condition|)
block|{
name|run_rt3070_rf_read
argument_list|(
name|sc
argument_list|,
literal|6
argument_list|,
operator|&
name|rf
argument_list|)
expr_stmt|;
name|run_rt3070_rf_write
argument_list|(
name|sc
argument_list|,
literal|6
argument_list|,
name|rf
operator||
literal|0x40
argument_list|)
expr_stmt|;
name|run_rt3070_rf_write
argument_list|(
name|sc
argument_list|,
literal|31
argument_list|,
literal|0x14
argument_list|)
expr_stmt|;
name|run_read
argument_list|(
name|sc
argument_list|,
name|RT3070_LDO_CFG0
argument_list|,
operator|&
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
literal|0x1f000000
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|mac_rev
operator|<
literal|0x0211
condition|)
name|tmp
operator||=
literal|0x0d000000
expr_stmt|;
comment|/* 1.3V */
else|else
name|tmp
operator||=
literal|0x01000000
expr_stmt|;
comment|/* 1.2V */
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT3070_LDO_CFG0
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* patch LNA_PE_G1 */
name|run_read
argument_list|(
name|sc
argument_list|,
name|RT3070_GPIO_SWITCH
argument_list|,
operator|&
name|tmp
argument_list|)
expr_stmt|;
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT3070_GPIO_SWITCH
argument_list|,
name|tmp
operator|&
operator|~
literal|0x20
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sc
operator|->
name|mac_ver
operator|==
literal|0x3572
condition|)
block|{
name|run_rt3070_rf_read
argument_list|(
name|sc
argument_list|,
literal|6
argument_list|,
operator|&
name|rf
argument_list|)
expr_stmt|;
name|run_rt3070_rf_write
argument_list|(
name|sc
argument_list|,
literal|6
argument_list|,
name|rf
operator||
literal|0x40
argument_list|)
expr_stmt|;
comment|/* increase voltage from 1.2V to 1.35V */
name|run_read
argument_list|(
name|sc
argument_list|,
name|RT3070_LDO_CFG0
argument_list|,
operator|&
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
operator|(
name|tmp
operator|&
operator|~
literal|0x1f000000
operator|)
operator||
literal|0x0d000000
expr_stmt|;
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT3070_LDO_CFG0
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|mac_rev
operator|<
literal|0x0211
operator|||
operator|!
name|sc
operator|->
name|patch_dac
condition|)
block|{
name|run_delay
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* wait for 1msec */
comment|/* decrease voltage back to 1.2V */
name|tmp
operator|=
operator|(
name|tmp
operator|&
operator|~
literal|0x1f000000
operator|)
operator||
literal|0x01000000
expr_stmt|;
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT3070_LDO_CFG0
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* select 20MHz bandwidth */
name|run_rt3070_rf_read
argument_list|(
name|sc
argument_list|,
literal|31
argument_list|,
operator|&
name|rf
argument_list|)
expr_stmt|;
name|run_rt3070_rf_write
argument_list|(
name|sc
argument_list|,
literal|31
argument_list|,
name|rf
operator|&
operator|~
literal|0x20
argument_list|)
expr_stmt|;
comment|/* calibrate filter for 20MHz bandwidth */
name|sc
operator|->
name|rf24_20mhz
operator|=
literal|0x1f
expr_stmt|;
comment|/* default value */
name|target
operator|=
operator|(
name|sc
operator|->
name|mac_ver
operator|<
literal|0x3071
operator|)
condition|?
literal|0x16
else|:
literal|0x13
expr_stmt|;
name|run_rt3070_filter_calib
argument_list|(
name|sc
argument_list|,
literal|0x07
argument_list|,
name|target
argument_list|,
operator|&
name|sc
operator|->
name|rf24_20mhz
argument_list|)
expr_stmt|;
comment|/* select 40MHz bandwidth */
name|run_bbp_read
argument_list|(
name|sc
argument_list|,
literal|4
argument_list|,
operator|&
name|bbp4
argument_list|)
expr_stmt|;
name|run_bbp_write
argument_list|(
name|sc
argument_list|,
literal|4
argument_list|,
operator|(
name|bbp4
operator|&
operator|~
literal|0x08
operator|)
operator||
literal|0x10
argument_list|)
expr_stmt|;
name|run_rt3070_rf_read
argument_list|(
name|sc
argument_list|,
literal|31
argument_list|,
operator|&
name|rf
argument_list|)
expr_stmt|;
name|run_rt3070_rf_write
argument_list|(
name|sc
argument_list|,
literal|31
argument_list|,
name|rf
operator||
literal|0x20
argument_list|)
expr_stmt|;
comment|/* calibrate filter for 40MHz bandwidth */
name|sc
operator|->
name|rf24_40mhz
operator|=
literal|0x2f
expr_stmt|;
comment|/* default value */
name|target
operator|=
operator|(
name|sc
operator|->
name|mac_ver
operator|<
literal|0x3071
operator|)
condition|?
literal|0x19
else|:
literal|0x15
expr_stmt|;
name|run_rt3070_filter_calib
argument_list|(
name|sc
argument_list|,
literal|0x27
argument_list|,
name|target
argument_list|,
operator|&
name|sc
operator|->
name|rf24_40mhz
argument_list|)
expr_stmt|;
comment|/* go back to 20MHz bandwidth */
name|run_bbp_read
argument_list|(
name|sc
argument_list|,
literal|4
argument_list|,
operator|&
name|bbp4
argument_list|)
expr_stmt|;
name|run_bbp_write
argument_list|(
name|sc
argument_list|,
literal|4
argument_list|,
name|bbp4
operator|&
operator|~
literal|0x18
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|mac_ver
operator|==
literal|0x3572
condition|)
block|{
comment|/* save default BBP registers 25 and 26 values */
name|run_bbp_read
argument_list|(
name|sc
argument_list|,
literal|25
argument_list|,
operator|&
name|sc
operator|->
name|bbp25
argument_list|)
expr_stmt|;
name|run_bbp_read
argument_list|(
name|sc
argument_list|,
literal|26
argument_list|,
operator|&
name|sc
operator|->
name|bbp26
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sc
operator|->
name|mac_rev
operator|<
literal|0x0211
condition|)
name|run_rt3070_rf_write
argument_list|(
name|sc
argument_list|,
literal|27
argument_list|,
literal|0x03
argument_list|)
expr_stmt|;
name|run_read
argument_list|(
name|sc
argument_list|,
name|RT3070_OPT_14
argument_list|,
operator|&
name|tmp
argument_list|)
expr_stmt|;
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT3070_OPT_14
argument_list|,
name|tmp
operator||
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|mac_ver
operator|==
literal|0x3070
operator|||
name|sc
operator|->
name|mac_ver
operator|==
literal|0x3071
condition|)
block|{
name|run_rt3070_rf_read
argument_list|(
name|sc
argument_list|,
literal|17
argument_list|,
operator|&
name|rf
argument_list|)
expr_stmt|;
name|rf
operator|&=
operator|~
name|RT3070_TX_LO1
expr_stmt|;
if|if
condition|(
operator|(
name|sc
operator|->
name|mac_ver
operator|==
literal|0x3070
operator|||
operator|(
name|sc
operator|->
name|mac_ver
operator|==
literal|0x3071
operator|&&
name|sc
operator|->
name|mac_rev
operator|>=
literal|0x0211
operator|)
operator|)
operator|&&
operator|!
name|sc
operator|->
name|ext_2ghz_lna
condition|)
name|rf
operator||=
literal|0x20
expr_stmt|;
comment|/* fix for long range Rx issue */
if|if
condition|(
name|sc
operator|->
name|txmixgain_2ghz
operator|>=
literal|1
condition|)
name|rf
operator|=
operator|(
name|rf
operator|&
operator|~
literal|0x7
operator|)
operator||
name|sc
operator|->
name|txmixgain_2ghz
expr_stmt|;
name|run_rt3070_rf_write
argument_list|(
name|sc
argument_list|,
literal|17
argument_list|,
name|rf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|mac_rev
operator|==
literal|0x3071
condition|)
block|{
name|run_rt3070_rf_read
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|,
operator|&
name|rf
argument_list|)
expr_stmt|;
name|rf
operator|&=
operator|~
operator|(
name|RT3070_RX0_PD
operator||
name|RT3070_TX0_PD
operator|)
expr_stmt|;
name|rf
operator||=
name|RT3070_RF_BLOCK
operator||
name|RT3070_RX1_PD
operator||
name|RT3070_TX1_PD
expr_stmt|;
name|run_rt3070_rf_write
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|,
name|rf
argument_list|)
expr_stmt|;
name|run_rt3070_rf_read
argument_list|(
name|sc
argument_list|,
literal|15
argument_list|,
operator|&
name|rf
argument_list|)
expr_stmt|;
name|run_rt3070_rf_write
argument_list|(
name|sc
argument_list|,
literal|15
argument_list|,
name|rf
operator|&
operator|~
name|RT3070_TX_LO2
argument_list|)
expr_stmt|;
name|run_rt3070_rf_read
argument_list|(
name|sc
argument_list|,
literal|20
argument_list|,
operator|&
name|rf
argument_list|)
expr_stmt|;
name|run_rt3070_rf_write
argument_list|(
name|sc
argument_list|,
literal|20
argument_list|,
name|rf
operator|&
operator|~
name|RT3070_RX_LO1
argument_list|)
expr_stmt|;
name|run_rt3070_rf_read
argument_list|(
name|sc
argument_list|,
literal|21
argument_list|,
operator|&
name|rf
argument_list|)
expr_stmt|;
name|run_rt3070_rf_write
argument_list|(
name|sc
argument_list|,
literal|21
argument_list|,
name|rf
operator|&
operator|~
name|RT3070_RX_LO2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|mac_ver
operator|==
literal|0x3070
operator|||
name|sc
operator|->
name|mac_ver
operator|==
literal|0x3071
condition|)
block|{
comment|/* fix Tx to Rx IQ glitch by raising RF voltage */
name|run_rt3070_rf_read
argument_list|(
name|sc
argument_list|,
literal|27
argument_list|,
operator|&
name|rf
argument_list|)
expr_stmt|;
name|rf
operator|&=
operator|~
literal|0x77
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|mac_rev
operator|<
literal|0x0211
condition|)
name|rf
operator||=
literal|0x03
expr_stmt|;
name|run_rt3070_rf_write
argument_list|(
name|sc
argument_list|,
literal|27
argument_list|,
name|rf
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|run_rt3070_filter_calib
parameter_list|(
name|struct
name|run_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|init
parameter_list|,
name|uint8_t
name|target
parameter_list|,
name|uint8_t
modifier|*
name|val
parameter_list|)
block|{
name|uint8_t
name|rf22
decl_stmt|,
name|rf24
decl_stmt|;
name|uint8_t
name|bbp55_pb
decl_stmt|,
name|bbp55_sb
decl_stmt|,
name|delta
decl_stmt|;
name|int
name|ntries
decl_stmt|;
comment|/* program filter */
name|run_rt3070_rf_read
argument_list|(
name|sc
argument_list|,
literal|24
argument_list|,
operator|&
name|rf24
argument_list|)
expr_stmt|;
name|rf24
operator|=
operator|(
name|rf24
operator|&
literal|0xc0
operator|)
operator||
name|init
expr_stmt|;
comment|/* initial filter value */
name|run_rt3070_rf_write
argument_list|(
name|sc
argument_list|,
literal|24
argument_list|,
name|rf24
argument_list|)
expr_stmt|;
comment|/* enable baseband loopback mode */
name|run_rt3070_rf_read
argument_list|(
name|sc
argument_list|,
literal|22
argument_list|,
operator|&
name|rf22
argument_list|)
expr_stmt|;
name|run_rt3070_rf_write
argument_list|(
name|sc
argument_list|,
literal|22
argument_list|,
name|rf22
operator||
literal|0x01
argument_list|)
expr_stmt|;
comment|/* set power and frequency of passband test tone */
name|run_bbp_write
argument_list|(
name|sc
argument_list|,
literal|24
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|100
condition|;
name|ntries
operator|++
control|)
block|{
comment|/* transmit test tone */
name|run_bbp_write
argument_list|(
name|sc
argument_list|,
literal|25
argument_list|,
literal|0x90
argument_list|)
expr_stmt|;
name|run_delay
argument_list|(
name|sc
argument_list|,
literal|10
argument_list|)
expr_stmt|;
comment|/* read received power */
name|run_bbp_read
argument_list|(
name|sc
argument_list|,
literal|55
argument_list|,
operator|&
name|bbp55_pb
argument_list|)
expr_stmt|;
if|if
condition|(
name|bbp55_pb
operator|!=
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|ntries
operator|==
literal|100
condition|)
return|return
name|ETIMEDOUT
return|;
comment|/* set power and frequency of stopband test tone */
name|run_bbp_write
argument_list|(
name|sc
argument_list|,
literal|24
argument_list|,
literal|0x06
argument_list|)
expr_stmt|;
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|100
condition|;
name|ntries
operator|++
control|)
block|{
comment|/* transmit test tone */
name|run_bbp_write
argument_list|(
name|sc
argument_list|,
literal|25
argument_list|,
literal|0x90
argument_list|)
expr_stmt|;
name|run_delay
argument_list|(
name|sc
argument_list|,
literal|10
argument_list|)
expr_stmt|;
comment|/* read received power */
name|run_bbp_read
argument_list|(
name|sc
argument_list|,
literal|55
argument_list|,
operator|&
name|bbp55_sb
argument_list|)
expr_stmt|;
name|delta
operator|=
name|bbp55_pb
operator|-
name|bbp55_sb
expr_stmt|;
if|if
condition|(
name|delta
operator|>
name|target
condition|)
break|break;
comment|/* reprogram filter */
name|rf24
operator|++
expr_stmt|;
name|run_rt3070_rf_write
argument_list|(
name|sc
argument_list|,
literal|24
argument_list|,
name|rf24
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ntries
operator|<
literal|100
condition|)
block|{
if|if
condition|(
name|rf24
operator|!=
name|init
condition|)
name|rf24
operator|--
expr_stmt|;
comment|/* backtrack */
operator|*
name|val
operator|=
name|rf24
expr_stmt|;
name|run_rt3070_rf_write
argument_list|(
name|sc
argument_list|,
literal|24
argument_list|,
name|rf24
argument_list|)
expr_stmt|;
block|}
comment|/* restore initial state */
name|run_bbp_write
argument_list|(
name|sc
argument_list|,
literal|24
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
comment|/* disable baseband loopback mode */
name|run_rt3070_rf_read
argument_list|(
name|sc
argument_list|,
literal|22
argument_list|,
operator|&
name|rf22
argument_list|)
expr_stmt|;
name|run_rt3070_rf_write
argument_list|(
name|sc
argument_list|,
literal|22
argument_list|,
name|rf22
operator|&
operator|~
literal|0x01
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|run_rt3070_rf_setup
parameter_list|(
name|struct
name|run_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint8_t
name|bbp
decl_stmt|,
name|rf
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|mac_ver
operator|==
literal|0x3572
condition|)
block|{
comment|/* enable DC filter */
if|if
condition|(
name|sc
operator|->
name|mac_rev
operator|>=
literal|0x0201
condition|)
name|run_bbp_write
argument_list|(
name|sc
argument_list|,
literal|103
argument_list|,
literal|0xc0
argument_list|)
expr_stmt|;
name|run_bbp_read
argument_list|(
name|sc
argument_list|,
literal|138
argument_list|,
operator|&
name|bbp
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|ntxchains
operator|==
literal|1
condition|)
name|bbp
operator||=
literal|0x20
expr_stmt|;
comment|/* turn off DAC1 */
if|if
condition|(
name|sc
operator|->
name|nrxchains
operator|==
literal|1
condition|)
name|bbp
operator|&=
operator|~
literal|0x02
expr_stmt|;
comment|/* turn off ADC1 */
name|run_bbp_write
argument_list|(
name|sc
argument_list|,
literal|138
argument_list|,
name|bbp
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|mac_rev
operator|>=
literal|0x0211
condition|)
block|{
comment|/* improve power consumption */
name|run_bbp_read
argument_list|(
name|sc
argument_list|,
literal|31
argument_list|,
operator|&
name|bbp
argument_list|)
expr_stmt|;
name|run_bbp_write
argument_list|(
name|sc
argument_list|,
literal|31
argument_list|,
name|bbp
operator|&
operator|~
literal|0x03
argument_list|)
expr_stmt|;
block|}
name|run_rt3070_rf_read
argument_list|(
name|sc
argument_list|,
literal|16
argument_list|,
operator|&
name|rf
argument_list|)
expr_stmt|;
name|rf
operator|=
operator|(
name|rf
operator|&
operator|~
literal|0x07
operator|)
operator||
name|sc
operator|->
name|txmixgain_2ghz
expr_stmt|;
name|run_rt3070_rf_write
argument_list|(
name|sc
argument_list|,
literal|16
argument_list|,
name|rf
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sc
operator|->
name|mac_ver
operator|==
literal|0x3071
condition|)
block|{
comment|/* enable DC filter */
if|if
condition|(
name|sc
operator|->
name|mac_rev
operator|>=
literal|0x0201
condition|)
name|run_bbp_write
argument_list|(
name|sc
argument_list|,
literal|103
argument_list|,
literal|0xc0
argument_list|)
expr_stmt|;
name|run_bbp_read
argument_list|(
name|sc
argument_list|,
literal|138
argument_list|,
operator|&
name|bbp
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|ntxchains
operator|==
literal|1
condition|)
name|bbp
operator||=
literal|0x20
expr_stmt|;
comment|/* turn off DAC1 */
if|if
condition|(
name|sc
operator|->
name|nrxchains
operator|==
literal|1
condition|)
name|bbp
operator|&=
operator|~
literal|0x02
expr_stmt|;
comment|/* turn off ADC1 */
name|run_bbp_write
argument_list|(
name|sc
argument_list|,
literal|138
argument_list|,
name|bbp
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|mac_rev
operator|>=
literal|0x0211
condition|)
block|{
comment|/* improve power consumption */
name|run_bbp_read
argument_list|(
name|sc
argument_list|,
literal|31
argument_list|,
operator|&
name|bbp
argument_list|)
expr_stmt|;
name|run_bbp_write
argument_list|(
name|sc
argument_list|,
literal|31
argument_list|,
name|bbp
operator|&
operator|~
literal|0x03
argument_list|)
expr_stmt|;
block|}
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_TX_SW_CFG1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|mac_rev
operator|<
literal|0x0211
condition|)
block|{
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_TX_SW_CFG2
argument_list|,
name|sc
operator|->
name|patch_dac
condition|?
literal|0x2c
else|:
literal|0x0f
argument_list|)
expr_stmt|;
block|}
else|else
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_TX_SW_CFG2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sc
operator|->
name|mac_ver
operator|==
literal|0x3070
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|mac_rev
operator|>=
literal|0x0201
condition|)
block|{
comment|/* enable DC filter */
name|run_bbp_write
argument_list|(
name|sc
argument_list|,
literal|103
argument_list|,
literal|0xc0
argument_list|)
expr_stmt|;
comment|/* improve power consumption */
name|run_bbp_read
argument_list|(
name|sc
argument_list|,
literal|31
argument_list|,
operator|&
name|bbp
argument_list|)
expr_stmt|;
name|run_bbp_write
argument_list|(
name|sc
argument_list|,
literal|31
argument_list|,
name|bbp
operator|&
operator|~
literal|0x03
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|mac_rev
operator|<
literal|0x0211
condition|)
block|{
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_TX_SW_CFG1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_TX_SW_CFG2
argument_list|,
literal|0x2c
argument_list|)
expr_stmt|;
block|}
else|else
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_TX_SW_CFG2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
comment|/* initialize RF registers from ROM for>=RT3071*/
if|if
condition|(
name|sc
operator|->
name|mac_ver
operator|>=
literal|0x3071
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|10
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|sc
operator|->
name|rf
index|[
name|i
index|]
operator|.
name|reg
operator|==
literal|0
operator|||
name|sc
operator|->
name|rf
index|[
name|i
index|]
operator|.
name|reg
operator|==
literal|0xff
condition|)
continue|continue;
name|run_rt3070_rf_write
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|rf
index|[
name|i
index|]
operator|.
name|reg
argument_list|,
name|sc
operator|->
name|rf
index|[
name|i
index|]
operator|.
name|val
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|run_txrx_enable
parameter_list|(
name|struct
name|run_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|sc
operator|->
name|sc_ifp
operator|->
name|if_l2com
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
name|int
name|error
decl_stmt|,
name|ntries
decl_stmt|;
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_MAC_SYS_CTRL
argument_list|,
name|RT2860_MAC_TX_EN
argument_list|)
expr_stmt|;
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|200
condition|;
name|ntries
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|run_read
argument_list|(
name|sc
argument_list|,
name|RT2860_WPDMA_GLO_CFG
argument_list|,
operator|&
name|tmp
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|error
return|;
if|if
condition|(
operator|(
name|tmp
operator|&
operator|(
name|RT2860_TX_DMA_BUSY
operator||
name|RT2860_RX_DMA_BUSY
operator|)
operator|)
operator|==
literal|0
condition|)
break|break;
name|run_delay
argument_list|(
name|sc
argument_list|,
literal|50
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ntries
operator|==
literal|200
condition|)
return|return
name|ETIMEDOUT
return|;
name|run_delay
argument_list|(
name|sc
argument_list|,
literal|50
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|RT2860_RX_DMA_EN
operator||
name|RT2860_TX_DMA_EN
operator||
name|RT2860_TX_WB_DDONE
expr_stmt|;
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_WPDMA_GLO_CFG
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* enable Rx bulk aggregation (set timeout and limit) */
name|tmp
operator|=
name|RT2860_USB_TX_EN
operator||
name|RT2860_USB_RX_EN
operator||
name|RT2860_USB_RX_AGG_EN
operator||
name|RT2860_USB_RX_AGG_TO
argument_list|(
literal|128
argument_list|)
operator||
name|RT2860_USB_RX_AGG_LMT
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_USB_DMA_CFG
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* set Rx filter */
name|tmp
operator|=
name|RT2860_DROP_CRC_ERR
operator||
name|RT2860_DROP_PHY_ERR
expr_stmt|;
if|if
condition|(
name|ic
operator|->
name|ic_opmode
operator|!=
name|IEEE80211_M_MONITOR
condition|)
block|{
name|tmp
operator||=
name|RT2860_DROP_UC_NOME
operator||
name|RT2860_DROP_DUPL
operator||
name|RT2860_DROP_CTS
operator||
name|RT2860_DROP_BA
operator||
name|RT2860_DROP_ACK
operator||
name|RT2860_DROP_VER_ERR
operator||
name|RT2860_DROP_CTRL_RSV
operator||
name|RT2860_DROP_CFACK
operator||
name|RT2860_DROP_CFEND
expr_stmt|;
if|if
condition|(
name|ic
operator|->
name|ic_opmode
operator|==
name|IEEE80211_M_STA
condition|)
name|tmp
operator||=
name|RT2860_DROP_RTS
operator||
name|RT2860_DROP_PSPOLL
expr_stmt|;
block|}
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_RX_FILTR_CFG
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_MAC_SYS_CTRL
argument_list|,
name|RT2860_MAC_RX_EN
operator||
name|RT2860_MAC_TX_EN
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|run_init_locked
parameter_list|(
name|struct
name|run_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|ifp
operator|->
name|if_l2com
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
name|uint8_t
name|bbp1
decl_stmt|,
name|bbp3
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|ridx
decl_stmt|;
name|int
name|ntries
decl_stmt|;
if|if
condition|(
name|ic
operator|->
name|ic_nrunning
operator|>
literal|1
condition|)
return|return;
name|run_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|100
condition|;
name|ntries
operator|++
control|)
block|{
if|if
condition|(
name|run_read
argument_list|(
name|sc
argument_list|,
name|RT2860_ASIC_VER_ID
argument_list|,
operator|&
name|tmp
argument_list|)
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|tmp
operator|!=
literal|0
operator|&&
name|tmp
operator|!=
literal|0xffffffff
condition|)
break|break;
name|run_delay
argument_list|(
name|sc
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ntries
operator|==
literal|100
condition|)
goto|goto
name|fail
goto|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|!=
name|RUN_EP_QUEUES
condition|;
name|i
operator|++
control|)
name|run_setup_tx_list
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|sc_epq
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|run_set_macaddr
argument_list|(
name|sc
argument_list|,
name|IF_LLADDR
argument_list|(
name|ifp
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|100
condition|;
name|ntries
operator|++
control|)
block|{
if|if
condition|(
name|run_read
argument_list|(
name|sc
argument_list|,
name|RT2860_WPDMA_GLO_CFG
argument_list|,
operator|&
name|tmp
argument_list|)
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
operator|(
name|tmp
operator|&
operator|(
name|RT2860_TX_DMA_BUSY
operator||
name|RT2860_RX_DMA_BUSY
operator|)
operator|)
operator|==
literal|0
condition|)
break|break;
name|run_delay
argument_list|(
name|sc
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ntries
operator|==
literal|100
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"timeout waiting for DMA engine\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|tmp
operator|&=
literal|0xff0
expr_stmt|;
name|tmp
operator||=
name|RT2860_TX_WB_DDONE
expr_stmt|;
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_WPDMA_GLO_CFG
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* turn off PME_OEN to solve high-current issue */
name|run_read
argument_list|(
name|sc
argument_list|,
name|RT2860_SYS_CTRL
argument_list|,
operator|&
name|tmp
argument_list|)
expr_stmt|;
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_SYS_CTRL
argument_list|,
name|tmp
operator|&
operator|~
name|RT2860_PME_OEN
argument_list|)
expr_stmt|;
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_MAC_SYS_CTRL
argument_list|,
name|RT2860_BBP_HRST
operator||
name|RT2860_MAC_SRST
argument_list|)
expr_stmt|;
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_USB_DMA_CFG
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|run_reset
argument_list|(
name|sc
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not reset chipset\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_MAC_SYS_CTRL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* init Tx power for all Tx rates (from EEPROM) */
for|for
control|(
name|ridx
operator|=
literal|0
init|;
name|ridx
operator|<
literal|5
condition|;
name|ridx
operator|++
control|)
block|{
if|if
condition|(
name|sc
operator|->
name|txpow20mhz
index|[
name|ridx
index|]
operator|==
literal|0xffffffff
condition|)
continue|continue;
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_TX_PWR_CFG
argument_list|(
name|ridx
argument_list|)
argument_list|,
name|sc
operator|->
name|txpow20mhz
index|[
name|ridx
index|]
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nitems
argument_list|(
name|rt2870_def_mac
argument_list|)
condition|;
name|i
operator|++
control|)
name|run_write
argument_list|(
name|sc
argument_list|,
name|rt2870_def_mac
index|[
name|i
index|]
operator|.
name|reg
argument_list|,
name|rt2870_def_mac
index|[
name|i
index|]
operator|.
name|val
argument_list|)
expr_stmt|;
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_WMM_AIFSN_CFG
argument_list|,
literal|0x00002273
argument_list|)
expr_stmt|;
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_WMM_CWMIN_CFG
argument_list|,
literal|0x00002344
argument_list|)
expr_stmt|;
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_WMM_CWMAX_CFG
argument_list|,
literal|0x000034aa
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|mac_ver
operator|>=
literal|0x3070
condition|)
block|{
comment|/* set delay of PA_PE assertion to 1us (unit of 0.25us) */
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_TX_SW_CFG0
argument_list|,
literal|4
operator|<<
name|RT2860_DLY_PAPE_EN_SHIFT
argument_list|)
expr_stmt|;
block|}
comment|/* wait while MAC is busy */
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|100
condition|;
name|ntries
operator|++
control|)
block|{
if|if
condition|(
name|run_read
argument_list|(
name|sc
argument_list|,
name|RT2860_MAC_STATUS_REG
argument_list|,
operator|&
name|tmp
argument_list|)
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
operator|!
operator|(
name|tmp
operator|&
operator|(
name|RT2860_RX_STATUS_BUSY
operator||
name|RT2860_TX_STATUS_BUSY
operator|)
operator|)
condition|)
break|break;
name|run_delay
argument_list|(
name|sc
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ntries
operator|==
literal|100
condition|)
goto|goto
name|fail
goto|;
comment|/* clear Host to MCU mailbox */
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_H2M_BBPAGENT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_H2M_MAILBOX
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|run_delay
argument_list|(
name|sc
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|run_bbp_init
argument_list|(
name|sc
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not initialize BBP\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
comment|/* abort TSF synchronization */
name|run_read
argument_list|(
name|sc
argument_list|,
name|RT2860_BCN_TIME_CFG
argument_list|,
operator|&
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
operator|(
name|RT2860_BCN_TX_EN
operator||
name|RT2860_TSF_TIMER_EN
operator||
name|RT2860_TBTT_TIMER_EN
operator|)
expr_stmt|;
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_BCN_TIME_CFG
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* clear RX WCID search table */
name|run_set_region_4
argument_list|(
name|sc
argument_list|,
name|RT2860_WCID_ENTRY
argument_list|(
literal|0
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|512
argument_list|)
expr_stmt|;
comment|/* clear WCID attribute table */
name|run_set_region_4
argument_list|(
name|sc
argument_list|,
name|RT2860_WCID_ATTR
argument_list|(
literal|0
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|8
operator|*
literal|32
argument_list|)
expr_stmt|;
comment|/* hostapd sets a key before init. So, don't clear it. */
if|if
condition|(
name|sc
operator|->
name|cmdq_key_set
operator|!=
name|RUN_CMDQ_GO
condition|)
block|{
comment|/* clear shared key table */
name|run_set_region_4
argument_list|(
name|sc
argument_list|,
name|RT2860_SKEY
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|8
operator|*
literal|32
argument_list|)
expr_stmt|;
comment|/* clear shared key mode */
name|run_set_region_4
argument_list|(
name|sc
argument_list|,
name|RT2860_SKEY_MODE_0_7
argument_list|,
literal|0
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
name|run_read
argument_list|(
name|sc
argument_list|,
name|RT2860_US_CYC_CNT
argument_list|,
operator|&
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
operator|(
name|tmp
operator|&
operator|~
literal|0xff
operator|)
operator||
literal|0x1e
expr_stmt|;
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_US_CYC_CNT
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|mac_rev
operator|!=
literal|0x0101
condition|)
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_TXOP_CTRL_CFG
argument_list|,
literal|0x0000583f
argument_list|)
expr_stmt|;
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_WMM_TXOP0_CFG
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_WMM_TXOP1_CFG
argument_list|,
literal|48
operator|<<
literal|16
operator||
literal|96
argument_list|)
expr_stmt|;
comment|/* write vendor-specific BBP values (from EEPROM) */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|10
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|sc
operator|->
name|bbp
index|[
name|i
index|]
operator|.
name|reg
operator|==
literal|0
operator|||
name|sc
operator|->
name|bbp
index|[
name|i
index|]
operator|.
name|reg
operator|==
literal|0xff
condition|)
continue|continue;
name|run_bbp_write
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|bbp
index|[
name|i
index|]
operator|.
name|reg
argument_list|,
name|sc
operator|->
name|bbp
index|[
name|i
index|]
operator|.
name|val
argument_list|)
expr_stmt|;
block|}
comment|/* select Main antenna for 1T1R devices */
if|if
condition|(
name|sc
operator|->
name|rf_rev
operator|==
name|RT3070_RF_3020
condition|)
name|run_set_rx_antenna
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* send LEDs operating mode to microcontroller */
operator|(
name|void
operator|)
name|run_mcu_cmd
argument_list|(
name|sc
argument_list|,
name|RT2860_MCU_CMD_LED1
argument_list|,
name|sc
operator|->
name|led
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|run_mcu_cmd
argument_list|(
name|sc
argument_list|,
name|RT2860_MCU_CMD_LED2
argument_list|,
name|sc
operator|->
name|led
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|run_mcu_cmd
argument_list|(
name|sc
argument_list|,
name|RT2860_MCU_CMD_LED3
argument_list|,
name|sc
operator|->
name|led
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|mac_ver
operator|>=
literal|0x3070
condition|)
name|run_rt3070_rf_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* disable non-existing Rx chains */
name|run_bbp_read
argument_list|(
name|sc
argument_list|,
literal|3
argument_list|,
operator|&
name|bbp3
argument_list|)
expr_stmt|;
name|bbp3
operator|&=
operator|~
operator|(
literal|1
operator|<<
literal|3
operator||
literal|1
operator|<<
literal|4
operator|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|nrxchains
operator|==
literal|2
condition|)
name|bbp3
operator||=
literal|1
operator|<<
literal|3
expr_stmt|;
elseif|else
if|if
condition|(
name|sc
operator|->
name|nrxchains
operator|==
literal|3
condition|)
name|bbp3
operator||=
literal|1
operator|<<
literal|4
expr_stmt|;
name|run_bbp_write
argument_list|(
name|sc
argument_list|,
literal|3
argument_list|,
name|bbp3
argument_list|)
expr_stmt|;
comment|/* disable non-existing Tx chains */
name|run_bbp_read
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|,
operator|&
name|bbp1
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|ntxchains
operator|==
literal|1
condition|)
name|bbp1
operator|&=
operator|~
operator|(
literal|1
operator|<<
literal|3
operator||
literal|1
operator|<<
literal|4
operator|)
expr_stmt|;
name|run_bbp_write
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|,
name|bbp1
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|mac_ver
operator|>=
literal|0x3070
condition|)
name|run_rt3070_rf_setup
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* select default channel */
name|run_set_chan
argument_list|(
name|sc
argument_list|,
name|ic
operator|->
name|ic_curchan
argument_list|)
expr_stmt|;
comment|/* setup initial protection mode */
name|run_updateprot
argument_list|(
name|ic
argument_list|)
expr_stmt|;
comment|/* turn radio LED on */
name|run_set_leds
argument_list|(
name|sc
argument_list|,
name|RT2860_LED_RADIO
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_OACTIVE
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator||=
name|IFF_DRV_RUNNING
expr_stmt|;
name|sc
operator|->
name|cmdq_run
operator|=
name|RUN_CMDQ_GO
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|!=
name|RUN_N_XFER
condition|;
name|i
operator|++
control|)
name|usbd_xfer_set_stall
argument_list|(
name|sc
operator|->
name|sc_xfer
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|usbd_transfer_start
argument_list|(
name|sc
operator|->
name|sc_xfer
index|[
name|RUN_BULK_RX
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|run_txrx_enable
argument_list|(
name|sc
argument_list|)
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
return|return;
name|fail
label|:
name|run_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|run_init
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|run_softc
modifier|*
name|sc
init|=
name|arg
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|ifp
operator|->
name|if_l2com
decl_stmt|;
name|RUN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|run_init_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|RUN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
name|ieee80211_start_all
argument_list|(
name|ic
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|run_stop
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|run_softc
modifier|*
name|sc
init|=
operator|(
expr|struct
name|run_softc
operator|*
operator|)
name|arg
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|ntries
decl_stmt|;
name|RUN_LOCK_ASSERT
argument_list|(
name|sc
argument_list|,
name|MA_OWNED
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
name|run_set_leds
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* turn all LEDs off */
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
operator|(
name|IFF_DRV_RUNNING
operator||
name|IFF_DRV_OACTIVE
operator|)
expr_stmt|;
name|sc
operator|->
name|ratectl_run
operator|=
name|RUN_RATECTL_OFF
expr_stmt|;
name|sc
operator|->
name|cmdq_run
operator|=
name|sc
operator|->
name|cmdq_key_set
expr_stmt|;
name|RUN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RUN_N_XFER
condition|;
name|i
operator|++
control|)
name|usbd_transfer_drain
argument_list|(
name|sc
operator|->
name|sc_xfer
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|RUN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|rx_m
operator|!=
name|NULL
condition|)
block|{
name|m_free
argument_list|(
name|sc
operator|->
name|rx_m
argument_list|)
expr_stmt|;
name|sc
operator|->
name|rx_m
operator|=
name|NULL
expr_stmt|;
block|}
comment|/* disable Tx/Rx */
name|run_read
argument_list|(
name|sc
argument_list|,
name|RT2860_MAC_SYS_CTRL
argument_list|,
operator|&
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
operator|(
name|RT2860_MAC_RX_EN
operator||
name|RT2860_MAC_TX_EN
operator|)
expr_stmt|;
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_MAC_SYS_CTRL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* wait for pending Tx to complete */
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|100
condition|;
name|ntries
operator|++
control|)
block|{
if|if
condition|(
name|run_read
argument_list|(
name|sc
argument_list|,
name|RT2860_TXRXQ_PCNT
argument_list|,
operator|&
name|tmp
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|DPRINTF
argument_list|(
literal|"Cannot read Tx queue count\n"
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|(
name|tmp
operator|&
name|RT2860_TX2Q_PCNT_MASK
operator|)
operator|==
literal|0
condition|)
block|{
name|DPRINTF
argument_list|(
literal|"All Tx cleared\n"
argument_list|)
expr_stmt|;
break|break;
block|}
name|run_delay
argument_list|(
name|sc
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ntries
operator|>=
literal|100
condition|)
name|DPRINTF
argument_list|(
literal|"There are still pending Tx\n"
argument_list|)
expr_stmt|;
name|run_delay
argument_list|(
name|sc
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_USB_DMA_CFG
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_MAC_SYS_CTRL
argument_list|,
name|RT2860_BBP_HRST
operator||
name|RT2860_MAC_SRST
argument_list|)
expr_stmt|;
name|run_write
argument_list|(
name|sc
argument_list|,
name|RT2860_MAC_SYS_CTRL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|!=
name|RUN_EP_QUEUES
condition|;
name|i
operator|++
control|)
name|run_unsetup_tx_list
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|sc_epq
index|[
name|i
index|]
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|run_delay
parameter_list|(
name|struct
name|run_softc
modifier|*
name|sc
parameter_list|,
name|unsigned
name|int
name|ms
parameter_list|)
block|{
name|usb_pause_mtx
argument_list|(
name|mtx_owned
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
condition|?
operator|&
name|sc
operator|->
name|sc_mtx
else|:
name|NULL
argument_list|,
name|USB_MS_TO_TICKS
argument_list|(
name|ms
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
name|device_method_t
name|run_methods
index|[]
init|=
block|{
comment|/* Device interface */
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|run_match
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|run_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|run_detach
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|run_driver
init|=
block|{
literal|"run"
block|,
name|run_methods
block|,
expr|sizeof
operator|(
expr|struct
name|run_softc
operator|)
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|run_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|run
argument_list|,
name|uhub
argument_list|,
name|run_driver
argument_list|,
name|run_devclass
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|run
argument_list|,
name|wlan
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|run
argument_list|,
name|usb
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|run
argument_list|,
name|firmware
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_VERSION
argument_list|(
name|run
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	$OpenBSD: if_urtwn.c,v 1.16 2011/02/10 17:26:40 jakemsr Exp $	*/
end_comment

begin_comment
comment|/*-  * Copyright (c) 2010 Damien Bergamini<damien.bergamini@free.fr>  * Copyright (c) 2014 Kevin Lo<kevlo@FreeBSD.org>  *  * Permission to use, copy, modify, and distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES  * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF  * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR  * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES  * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN  * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF  * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*  * Driver for Realtek RTL8188CE-VAU/RTL8188CUS/RTL8188EU/RTL8188RU/RTL8192CU.  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|<sys/linker.h>
end_include

begin_include
include|#
directive|include
file|<sys/firmware.h>
end_include

begin_include
include|#
directive|include
file|<sys/kdb.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<net/bpf.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_var.h>
end_include

begin_include
include|#
directive|include
file|<net/if_arp.h>
end_include

begin_include
include|#
directive|include
file|<net/ethernet.h>
end_include

begin_include
include|#
directive|include
file|<net/if_dl.h>
end_include

begin_include
include|#
directive|include
file|<net/if_media.h>
end_include

begin_include
include|#
directive|include
file|<net/if_types.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_systm.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_var.h>
end_include

begin_include
include|#
directive|include
file|<netinet/if_ether.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_var.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_regdomain.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_radiotap.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_ratectl.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usbdi.h>
end_include

begin_include
include|#
directive|include
file|"usbdevs.h"
end_include

begin_define
define|#
directive|define
name|USB_DEBUG_VAR
value|urtwn_debug
end_define

begin_include
include|#
directive|include
file|<dev/usb/usb_debug.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/wlan/if_urtwnreg.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|USB_DEBUG
end_ifdef

begin_decl_stmt
specifier|static
name|int
name|urtwn_debug
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|SYSCTL_NODE
argument_list|(
name|_hw_usb
argument_list|,
name|OID_AUTO
argument_list|,
name|urtwn
argument_list|,
name|CTLFLAG_RW
argument_list|,
literal|0
argument_list|,
literal|"USB urtwn"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_hw_usb_urtwn
argument_list|,
name|OID_AUTO
argument_list|,
name|debug
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|urtwn_debug
argument_list|,
literal|0
argument_list|,
literal|"Debug level"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|URTWN_RSSI
parameter_list|(
name|r
parameter_list|)
value|(r) - 110
end_define

begin_define
define|#
directive|define
name|IEEE80211_HAS_ADDR4
parameter_list|(
name|wh
parameter_list|)
define|\
value|(((wh)->i_fc[1]& IEEE80211_FC1_DIR_MASK) == IEEE80211_FC1_DIR_DSTODS)
end_define

begin_comment
comment|/* various supported device vendors/products */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|STRUCT_USB_HOST_ID
name|urtwn_devs
index|[]
init|=
block|{
define|#
directive|define
name|URTWN_DEV
parameter_list|(
name|v
parameter_list|,
name|p
parameter_list|)
value|{ USB_VP(USB_VENDOR_##v, USB_PRODUCT_##v##_##p) }
define|#
directive|define
name|URTWN_RTL8188E_DEV
parameter_list|(
name|v
parameter_list|,
name|p
parameter_list|)
define|\
value|{ USB_VPI(USB_VENDOR_##v, USB_PRODUCT_##v##_##p, URTWN_RTL8188E) }
define|#
directive|define
name|URTWN_RTL8188E
value|1
name|URTWN_DEV
argument_list|(
name|ABOCOM
argument_list|,
name|RTL8188CU_1
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|ABOCOM
argument_list|,
name|RTL8188CU_2
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|ABOCOM
argument_list|,
name|RTL8192CU
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|ASUS
argument_list|,
name|RTL8192CU
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|AZUREWAVE
argument_list|,
name|RTL8188CE_1
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|AZUREWAVE
argument_list|,
name|RTL8188CE_2
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|AZUREWAVE
argument_list|,
name|RTL8188CU
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|BELKIN
argument_list|,
name|F7D2102
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|BELKIN
argument_list|,
name|RTL8188CU
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|BELKIN
argument_list|,
name|RTL8192CU
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|CHICONY
argument_list|,
name|RTL8188CUS_1
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|CHICONY
argument_list|,
name|RTL8188CUS_2
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|CHICONY
argument_list|,
name|RTL8188CUS_3
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|CHICONY
argument_list|,
name|RTL8188CUS_4
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|CHICONY
argument_list|,
name|RTL8188CUS_5
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|COREGA
argument_list|,
name|RTL8192CU
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|DLINK
argument_list|,
name|RTL8188CU
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|DLINK
argument_list|,
name|RTL8192CU_1
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|DLINK
argument_list|,
name|RTL8192CU_2
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|DLINK
argument_list|,
name|RTL8192CU_3
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|DLINK
argument_list|,
name|DWA131B
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|EDIMAX
argument_list|,
name|EW7811UN
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|EDIMAX
argument_list|,
name|RTL8192CU
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|FEIXUN
argument_list|,
name|RTL8188CU
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|FEIXUN
argument_list|,
name|RTL8192CU
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|GUILLEMOT
argument_list|,
name|HWNUP150
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|HAWKING
argument_list|,
name|RTL8192CU
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|HP3
argument_list|,
name|RTL8188CU
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|NETGEAR
argument_list|,
name|WNA1000M
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|NETGEAR
argument_list|,
name|RTL8192CU
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|NETGEAR4
argument_list|,
name|RTL8188CU
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|NOVATECH
argument_list|,
name|RTL8188CU
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|PLANEX2
argument_list|,
name|RTL8188CU_1
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|PLANEX2
argument_list|,
name|RTL8188CU_2
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|PLANEX2
argument_list|,
name|RTL8188CU_3
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|PLANEX2
argument_list|,
name|RTL8188CU_4
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|PLANEX2
argument_list|,
name|RTL8188CUS
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|PLANEX2
argument_list|,
name|RTL8192CU
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|REALTEK
argument_list|,
name|RTL8188CE_0
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|REALTEK
argument_list|,
name|RTL8188CE_1
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|REALTEK
argument_list|,
name|RTL8188CTV
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|REALTEK
argument_list|,
name|RTL8188CU_0
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|REALTEK
argument_list|,
name|RTL8188CU_1
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|REALTEK
argument_list|,
name|RTL8188CU_2
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|REALTEK
argument_list|,
name|RTL8188CU_COMBO
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|REALTEK
argument_list|,
name|RTL8188CUS
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|REALTEK
argument_list|,
name|RTL8188RU_1
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|REALTEK
argument_list|,
name|RTL8188RU_2
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|REALTEK
argument_list|,
name|RTL8191CU
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|REALTEK
argument_list|,
name|RTL8192CE
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|REALTEK
argument_list|,
name|RTL8192CU
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|REALTEK
argument_list|,
name|RTL8188CU_0
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|SITECOMEU
argument_list|,
name|RTL8188CU_1
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|SITECOMEU
argument_list|,
name|RTL8188CU_2
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|SITECOMEU
argument_list|,
name|RTL8192CU
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|TRENDNET
argument_list|,
name|RTL8188CU
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|TRENDNET
argument_list|,
name|RTL8192CU
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|ZYXEL
argument_list|,
name|RTL8192CU
argument_list|)
block|,
comment|/* URTWN_RTL8188E */
name|URTWN_RTL8188E_DEV
argument_list|(
name|REALTEK
argument_list|,
name|RTL8188ETV
argument_list|)
block|,
name|URTWN_RTL8188E_DEV
argument_list|(
name|REALTEK
argument_list|,
name|RTL8188EU
argument_list|)
block|,
undef|#
directive|undef
name|URTWN_RTL8188E_DEV
undef|#
directive|undef
name|URTWN_DEV
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|device_probe_t
name|urtwn_match
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|device_attach_t
name|urtwn_attach
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|device_detach_t
name|urtwn_detach
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|usb_callback_t
name|urtwn_bulk_tx_callback
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|usb_callback_t
name|urtwn_bulk_rx_callback
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|usb_error_t
name|urtwn_do_request
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|usb_device_request
modifier|*
name|req
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|ieee80211vap
modifier|*
name|urtwn_vap_create
parameter_list|(
name|struct
name|ieee80211com
modifier|*
parameter_list|,
specifier|const
name|char
index|[
name|IFNAMSIZ
index|]
parameter_list|,
name|int
parameter_list|,
name|enum
name|ieee80211_opmode
parameter_list|,
name|int
parameter_list|,
specifier|const
name|uint8_t
index|[
name|IEEE80211_ADDR_LEN
index|]
parameter_list|,
specifier|const
name|uint8_t
index|[
name|IEEE80211_ADDR_LEN
index|]
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_vap_delete
parameter_list|(
name|struct
name|ieee80211vap
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|mbuf
modifier|*
name|urtwn_rx_frame
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|uint8_t
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|mbuf
modifier|*
name|urtwn_rxeof
parameter_list|(
name|struct
name|usb_xfer
modifier|*
parameter_list|,
name|struct
name|urtwn_data
modifier|*
parameter_list|,
name|int
modifier|*
parameter_list|,
name|int8_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_txeof
parameter_list|(
name|struct
name|usb_xfer
modifier|*
parameter_list|,
name|struct
name|urtwn_data
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|urtwn_alloc_list
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|struct
name|urtwn_data
type|[]
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|urtwn_alloc_rx_list
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|urtwn_alloc_tx_list
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_free_tx_list
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_free_rx_list
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_free_list
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|struct
name|urtwn_data
name|data
index|[]
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|urtwn_data
modifier|*
name|_urtwn_getbuf
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|urtwn_data
modifier|*
name|urtwn_getbuf
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|urtwn_write_region_1
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|uint16_t
parameter_list|,
name|uint8_t
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_write_1
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|uint16_t
parameter_list|,
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_write_2
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|uint16_t
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_write_4
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|uint16_t
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|urtwn_read_region_1
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|uint16_t
parameter_list|,
name|uint8_t
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint8_t
name|urtwn_read_1
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
name|urtwn_read_2
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|urtwn_read_4
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|urtwn_fw_cmd
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|uint8_t
parameter_list|,
specifier|const
name|void
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_r92c_rf_write
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|int
parameter_list|,
name|uint8_t
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_r88e_rf_write
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|int
parameter_list|,
name|uint8_t
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|urtwn_rf_read
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|int
parameter_list|,
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|urtwn_llt_write
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|uint32_t
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint8_t
name|urtwn_efuse_read_1
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_efuse_read
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_efuse_switch_power
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|urtwn_read_chipid
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_read_rom
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_r88e_read_rom
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|urtwn_ra_init
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_tsf_sync_enable
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_set_led
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|urtwn_newstate
parameter_list|(
name|struct
name|ieee80211vap
modifier|*
parameter_list|,
name|enum
name|ieee80211_state
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_watchdog
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_update_avgrssi
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int8_t
name|urtwn_get_rssi
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|int
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int8_t
name|urtwn_r88e_get_rssi
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|int
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|urtwn_tx_start
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|struct
name|ieee80211_node
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|,
name|struct
name|urtwn_data
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_start
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_start_locked
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|,
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|urtwn_ioctl
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|,
name|u_long
parameter_list|,
name|caddr_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|urtwn_r92c_power_on
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|urtwn_r88e_power_on
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|urtwn_llt_init
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_fw_reset
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_r88e_fw_reset
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|urtwn_fw_loadpage
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|int
parameter_list|,
specifier|const
name|uint8_t
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|urtwn_load_firmware
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|urtwn_r92c_dma_init
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|urtwn_r88e_dma_init
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_mac_init
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_bb_init
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_rf_init
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_cam_init
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_pa_bias_init
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_rxfilter_init
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_edca_init
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_write_txpower
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|int
parameter_list|,
name|uint16_t
index|[]
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_get_txpower
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|int
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
parameter_list|,
name|uint16_t
index|[]
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_r88e_get_txpower
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|int
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
parameter_list|,
name|uint16_t
index|[]
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_set_txpower
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_scan_start
parameter_list|(
name|struct
name|ieee80211com
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_scan_end
parameter_list|(
name|struct
name|ieee80211com
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_set_channel
parameter_list|(
name|struct
name|ieee80211com
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_set_chan
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_update_mcast
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_iq_calib
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_lc_calib
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_init
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_init_locked
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_stop
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_stop_locked
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_abort_xfers
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|urtwn_raw_xmit
parameter_list|(
name|struct
name|ieee80211_node
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|,
specifier|const
name|struct
name|ieee80211_bpf_params
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* Aliases. */
end_comment

begin_define
define|#
directive|define
name|urtwn_bb_write
value|urtwn_write_4
end_define

begin_define
define|#
directive|define
name|urtwn_bb_read
value|urtwn_read_4
end_define

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|usb_config
name|urtwn_config
index|[
name|URTWN_N_TRANSFER
index|]
init|=
block|{
index|[
name|URTWN_BULK_RX
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|UE_BULK
block|,
operator|.
name|endpoint
operator|=
name|UE_ADDR_ANY
block|,
operator|.
name|direction
operator|=
name|UE_DIR_IN
block|,
operator|.
name|bufsize
operator|=
name|URTWN_RXBUFSZ
block|,
operator|.
name|flags
operator|=
block|{
operator|.
name|pipe_bof
operator|=
literal|1
block|,
operator|.
name|short_xfer_ok
operator|=
literal|1
block|}
block|,
operator|.
name|callback
operator|=
name|urtwn_bulk_rx_callback
block|, 	}
block|,
index|[
name|URTWN_BULK_TX_BE
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|UE_BULK
block|,
operator|.
name|endpoint
operator|=
literal|0x03
block|,
operator|.
name|direction
operator|=
name|UE_DIR_OUT
block|,
operator|.
name|bufsize
operator|=
name|URTWN_TXBUFSZ
block|,
operator|.
name|flags
operator|=
block|{
operator|.
name|ext_buffer
operator|=
literal|1
block|,
operator|.
name|pipe_bof
operator|=
literal|1
block|,
operator|.
name|force_short_xfer
operator|=
literal|1
block|}
block|,
operator|.
name|callback
operator|=
name|urtwn_bulk_tx_callback
block|,
operator|.
name|timeout
operator|=
name|URTWN_TX_TIMEOUT
block|,
comment|/* ms */
block|}
block|,
index|[
name|URTWN_BULK_TX_BK
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|UE_BULK
block|,
operator|.
name|endpoint
operator|=
literal|0x03
block|,
operator|.
name|direction
operator|=
name|UE_DIR_OUT
block|,
operator|.
name|bufsize
operator|=
name|URTWN_TXBUFSZ
block|,
operator|.
name|flags
operator|=
block|{
operator|.
name|ext_buffer
operator|=
literal|1
block|,
operator|.
name|pipe_bof
operator|=
literal|1
block|,
operator|.
name|force_short_xfer
operator|=
literal|1
block|, 		}
block|,
operator|.
name|callback
operator|=
name|urtwn_bulk_tx_callback
block|,
operator|.
name|timeout
operator|=
name|URTWN_TX_TIMEOUT
block|,
comment|/* ms */
block|}
block|,
index|[
name|URTWN_BULK_TX_VI
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|UE_BULK
block|,
operator|.
name|endpoint
operator|=
literal|0x02
block|,
operator|.
name|direction
operator|=
name|UE_DIR_OUT
block|,
operator|.
name|bufsize
operator|=
name|URTWN_TXBUFSZ
block|,
operator|.
name|flags
operator|=
block|{
operator|.
name|ext_buffer
operator|=
literal|1
block|,
operator|.
name|pipe_bof
operator|=
literal|1
block|,
operator|.
name|force_short_xfer
operator|=
literal|1
block|}
block|,
operator|.
name|callback
operator|=
name|urtwn_bulk_tx_callback
block|,
operator|.
name|timeout
operator|=
name|URTWN_TX_TIMEOUT
block|,
comment|/* ms */
block|}
block|,
index|[
name|URTWN_BULK_TX_VO
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|UE_BULK
block|,
operator|.
name|endpoint
operator|=
literal|0x02
block|,
operator|.
name|direction
operator|=
name|UE_DIR_OUT
block|,
operator|.
name|bufsize
operator|=
name|URTWN_TXBUFSZ
block|,
operator|.
name|flags
operator|=
block|{
operator|.
name|ext_buffer
operator|=
literal|1
block|,
operator|.
name|pipe_bof
operator|=
literal|1
block|,
operator|.
name|force_short_xfer
operator|=
literal|1
block|}
block|,
operator|.
name|callback
operator|=
name|urtwn_bulk_tx_callback
block|,
operator|.
name|timeout
operator|=
name|URTWN_TX_TIMEOUT
block|,
comment|/* ms */
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|urtwn_match
parameter_list|(
name|device_t
name|self
parameter_list|)
block|{
name|struct
name|usb_attach_arg
modifier|*
name|uaa
init|=
name|device_get_ivars
argument_list|(
name|self
argument_list|)
decl_stmt|;
if|if
condition|(
name|uaa
operator|->
name|usb_mode
operator|!=
name|USB_MODE_HOST
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
name|uaa
operator|->
name|info
operator|.
name|bConfigIndex
operator|!=
name|URTWN_CONFIG_INDEX
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
name|uaa
operator|->
name|info
operator|.
name|bIfaceIndex
operator|!=
name|URTWN_IFACE_INDEX
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
return|return
operator|(
name|usbd_lookup_id_by_uaa
argument_list|(
name|urtwn_devs
argument_list|,
sizeof|sizeof
argument_list|(
name|urtwn_devs
argument_list|)
argument_list|,
name|uaa
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|urtwn_attach
parameter_list|(
name|device_t
name|self
parameter_list|)
block|{
name|struct
name|usb_attach_arg
modifier|*
name|uaa
init|=
name|device_get_ivars
argument_list|(
name|self
argument_list|)
decl_stmt|;
name|struct
name|urtwn_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|self
argument_list|)
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
decl_stmt|;
name|uint8_t
name|iface_index
decl_stmt|,
name|bands
decl_stmt|;
name|int
name|error
decl_stmt|;
name|device_set_usb_desc
argument_list|(
name|self
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_udev
operator|=
name|uaa
operator|->
name|device
expr_stmt|;
name|sc
operator|->
name|sc_dev
operator|=
name|self
expr_stmt|;
if|if
condition|(
name|USB_GET_DRIVER_INFO
argument_list|(
name|uaa
argument_list|)
operator|==
name|URTWN_RTL8188E
condition|)
name|sc
operator|->
name|chip
operator||=
name|URTWN_CHIP_88E
expr_stmt|;
name|mtx_init
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|,
name|device_get_nameunit
argument_list|(
name|self
argument_list|)
argument_list|,
name|MTX_NETWORK_LOCK
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
name|callout_init
argument_list|(
operator|&
name|sc
operator|->
name|sc_watchdog_ch
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|iface_index
operator|=
name|URTWN_IFACE_INDEX
expr_stmt|;
name|error
operator|=
name|usbd_transfer_setup
argument_list|(
name|uaa
operator|->
name|device
argument_list|,
operator|&
name|iface_index
argument_list|,
name|sc
operator|->
name|sc_xfer
argument_list|,
name|urtwn_config
argument_list|,
name|URTWN_N_TRANSFER
argument_list|,
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|self
argument_list|,
literal|"could not allocate USB transfers, "
literal|"err=%s\n"
argument_list|,
name|usbd_errstr
argument_list|(
name|error
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|detach
goto|;
block|}
name|URTWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|error
operator|=
name|urtwn_read_chipid
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"unsupported test chip\n"
argument_list|)
expr_stmt|;
name|URTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
goto|goto
name|detach
goto|;
block|}
comment|/* Determine number of Tx/Rx chains. */
if|if
condition|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_92C
condition|)
block|{
name|sc
operator|->
name|ntxchains
operator|=
operator|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_92C_1T2R
operator|)
condition|?
literal|1
else|:
literal|2
expr_stmt|;
name|sc
operator|->
name|nrxchains
operator|=
literal|2
expr_stmt|;
block|}
else|else
block|{
name|sc
operator|->
name|ntxchains
operator|=
literal|1
expr_stmt|;
name|sc
operator|->
name|nrxchains
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
condition|)
name|urtwn_r88e_read_rom
argument_list|(
name|sc
argument_list|)
expr_stmt|;
else|else
name|urtwn_read_rom
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"MAC/BB RTL%s, RF 6052 %dT%dR\n"
argument_list|,
operator|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_92C
operator|)
condition|?
literal|"8192CU"
else|:
operator|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
operator|)
condition|?
literal|"8188EU"
else|:
operator|(
name|sc
operator|->
name|board_type
operator|==
name|R92C_BOARD_TYPE_HIGHPA
operator|)
condition|?
literal|"8188RU"
else|:
operator|(
name|sc
operator|->
name|board_type
operator|==
name|R92C_BOARD_TYPE_MINICARD
operator|)
condition|?
literal|"8188CE-VAU"
else|:
literal|"8188CUS"
argument_list|,
name|sc
operator|->
name|ntxchains
argument_list|,
name|sc
operator|->
name|nrxchains
argument_list|)
expr_stmt|;
name|URTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|sc_ifp
operator|=
name|if_alloc
argument_list|(
name|IFT_IEEE80211
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"can not if_alloc()\n"
argument_list|)
expr_stmt|;
goto|goto
name|detach
goto|;
block|}
name|ic
operator|=
name|ifp
operator|->
name|if_l2com
expr_stmt|;
name|ifp
operator|->
name|if_softc
operator|=
name|sc
expr_stmt|;
name|if_initname
argument_list|(
name|ifp
argument_list|,
literal|"urtwn"
argument_list|,
name|device_get_unit
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_flags
operator|=
name|IFF_BROADCAST
operator||
name|IFF_SIMPLEX
operator||
name|IFF_MULTICAST
expr_stmt|;
name|ifp
operator|->
name|if_init
operator|=
name|urtwn_init
expr_stmt|;
name|ifp
operator|->
name|if_ioctl
operator|=
name|urtwn_ioctl
expr_stmt|;
name|ifp
operator|->
name|if_start
operator|=
name|urtwn_start
expr_stmt|;
name|IFQ_SET_MAXLEN
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|,
name|ifqmaxlen
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_snd
operator|.
name|ifq_drv_maxlen
operator|=
name|ifqmaxlen
expr_stmt|;
name|IFQ_SET_READY
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|)
expr_stmt|;
name|ic
operator|->
name|ic_ifp
operator|=
name|ifp
expr_stmt|;
name|ic
operator|->
name|ic_phytype
operator|=
name|IEEE80211_T_OFDM
expr_stmt|;
comment|/* not only, but not used */
name|ic
operator|->
name|ic_opmode
operator|=
name|IEEE80211_M_STA
expr_stmt|;
comment|/* default to BSS mode */
comment|/* set device capabilities */
name|ic
operator|->
name|ic_caps
operator|=
name|IEEE80211_C_STA
comment|/* station mode */
operator||
name|IEEE80211_C_MONITOR
comment|/* monitor mode */
operator||
name|IEEE80211_C_SHPREAMBLE
comment|/* short preamble supported */
operator||
name|IEEE80211_C_SHSLOT
comment|/* short slot time supported */
operator||
name|IEEE80211_C_BGSCAN
comment|/* capable of bg scanning */
operator||
name|IEEE80211_C_WPA
comment|/* 802.11i */
expr_stmt|;
name|bands
operator|=
literal|0
expr_stmt|;
name|setbit
argument_list|(
operator|&
name|bands
argument_list|,
name|IEEE80211_MODE_11B
argument_list|)
expr_stmt|;
name|setbit
argument_list|(
operator|&
name|bands
argument_list|,
name|IEEE80211_MODE_11G
argument_list|)
expr_stmt|;
name|ieee80211_init_channels
argument_list|(
name|ic
argument_list|,
name|NULL
argument_list|,
operator|&
name|bands
argument_list|)
expr_stmt|;
name|ieee80211_ifattach
argument_list|(
name|ic
argument_list|,
name|sc
operator|->
name|sc_bssid
argument_list|)
expr_stmt|;
name|ic
operator|->
name|ic_raw_xmit
operator|=
name|urtwn_raw_xmit
expr_stmt|;
name|ic
operator|->
name|ic_scan_start
operator|=
name|urtwn_scan_start
expr_stmt|;
name|ic
operator|->
name|ic_scan_end
operator|=
name|urtwn_scan_end
expr_stmt|;
name|ic
operator|->
name|ic_set_channel
operator|=
name|urtwn_set_channel
expr_stmt|;
name|ic
operator|->
name|ic_vap_create
operator|=
name|urtwn_vap_create
expr_stmt|;
name|ic
operator|->
name|ic_vap_delete
operator|=
name|urtwn_vap_delete
expr_stmt|;
name|ic
operator|->
name|ic_update_mcast
operator|=
name|urtwn_update_mcast
expr_stmt|;
name|ieee80211_radiotap_attach
argument_list|(
name|ic
argument_list|,
operator|&
name|sc
operator|->
name|sc_txtap
operator|.
name|wt_ihdr
argument_list|,
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|sc_txtap
argument_list|)
argument_list|,
name|URTWN_TX_RADIOTAP_PRESENT
argument_list|,
operator|&
name|sc
operator|->
name|sc_rxtap
operator|.
name|wr_ihdr
argument_list|,
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|sc_rxtap
argument_list|)
argument_list|,
name|URTWN_RX_RADIOTAP_PRESENT
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|ieee80211_announce
argument_list|(
name|ic
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|detach
label|:
name|urtwn_detach
argument_list|(
name|self
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
comment|/* failure */
block|}
end_function

begin_function
specifier|static
name|int
name|urtwn_detach
parameter_list|(
name|device_t
name|self
parameter_list|)
block|{
name|struct
name|urtwn_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|self
argument_list|)
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|ifp
operator|->
name|if_l2com
decl_stmt|;
name|unsigned
name|int
name|x
decl_stmt|;
comment|/* Prevent further ioctls. */
name|URTWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_flags
operator||=
name|URTWN_DETACHED
expr_stmt|;
name|URTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|urtwn_stop
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|callout_drain
argument_list|(
operator|&
name|sc
operator|->
name|sc_watchdog_ch
argument_list|)
expr_stmt|;
comment|/* Prevent further allocations from RX/TX data lists. */
name|URTWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|STAILQ_INIT
argument_list|(
operator|&
name|sc
operator|->
name|sc_tx_active
argument_list|)
expr_stmt|;
name|STAILQ_INIT
argument_list|(
operator|&
name|sc
operator|->
name|sc_tx_inactive
argument_list|)
expr_stmt|;
name|STAILQ_INIT
argument_list|(
operator|&
name|sc
operator|->
name|sc_tx_pending
argument_list|)
expr_stmt|;
name|STAILQ_INIT
argument_list|(
operator|&
name|sc
operator|->
name|sc_rx_active
argument_list|)
expr_stmt|;
name|STAILQ_INIT
argument_list|(
operator|&
name|sc
operator|->
name|sc_rx_inactive
argument_list|)
expr_stmt|;
name|URTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* drain USB transfers */
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|!=
name|URTWN_N_TRANSFER
condition|;
name|x
operator|++
control|)
name|usbd_transfer_drain
argument_list|(
name|sc
operator|->
name|sc_xfer
index|[
name|x
index|]
argument_list|)
expr_stmt|;
comment|/* Free data buffers. */
name|URTWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|urtwn_free_tx_list
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|urtwn_free_rx_list
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|URTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* stop all USB transfers */
name|usbd_transfer_unsetup
argument_list|(
name|sc
operator|->
name|sc_xfer
argument_list|,
name|URTWN_N_TRANSFER
argument_list|)
expr_stmt|;
name|ieee80211_ifdetach
argument_list|(
name|ic
argument_list|)
expr_stmt|;
name|if_free
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|mtx_destroy
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_free_tx_list
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|urtwn_free_list
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|sc_tx
argument_list|,
name|URTWN_TX_LIST_COUNT
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_free_rx_list
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|urtwn_free_list
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|sc_rx
argument_list|,
name|URTWN_RX_LIST_COUNT
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_free_list
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|urtwn_data
name|data
index|[]
parameter_list|,
name|int
name|ndata
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ndata
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|urtwn_data
modifier|*
name|dp
init|=
operator|&
name|data
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
name|dp
operator|->
name|buf
operator|!=
name|NULL
condition|)
block|{
name|free
argument_list|(
name|dp
operator|->
name|buf
argument_list|,
name|M_USBDEV
argument_list|)
expr_stmt|;
name|dp
operator|->
name|buf
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|dp
operator|->
name|ni
operator|!=
name|NULL
condition|)
block|{
name|ieee80211_free_node
argument_list|(
name|dp
operator|->
name|ni
argument_list|)
expr_stmt|;
name|dp
operator|->
name|ni
operator|=
name|NULL
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|usb_error_t
name|urtwn_do_request
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|usb_device_request
modifier|*
name|req
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|usb_error_t
name|err
decl_stmt|;
name|int
name|ntries
init|=
literal|10
decl_stmt|;
name|URTWN_ASSERT_LOCKED
argument_list|(
name|sc
argument_list|)
expr_stmt|;
while|while
condition|(
name|ntries
operator|--
condition|)
block|{
name|err
operator|=
name|usbd_do_request_flags
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|,
name|req
argument_list|,
name|data
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|250
comment|/* ms */
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
literal|0
condition|)
break|break;
name|DPRINTFN
argument_list|(
literal|1
argument_list|,
literal|"Control request failed, %s (retrying)\n"
argument_list|,
name|usbd_errstr
argument_list|(
name|err
argument_list|)
argument_list|)
expr_stmt|;
name|usb_pause_mtx
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|,
name|hz
operator|/
literal|100
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|ieee80211vap
modifier|*
name|urtwn_vap_create
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|,
specifier|const
name|char
name|name
index|[
name|IFNAMSIZ
index|]
parameter_list|,
name|int
name|unit
parameter_list|,
name|enum
name|ieee80211_opmode
name|opmode
parameter_list|,
name|int
name|flags
parameter_list|,
specifier|const
name|uint8_t
name|bssid
index|[
name|IEEE80211_ADDR_LEN
index|]
parameter_list|,
specifier|const
name|uint8_t
name|mac
index|[
name|IEEE80211_ADDR_LEN
index|]
parameter_list|)
block|{
name|struct
name|urtwn_vap
modifier|*
name|uvp
decl_stmt|;
name|struct
name|ieee80211vap
modifier|*
name|vap
decl_stmt|;
if|if
condition|(
operator|!
name|TAILQ_EMPTY
argument_list|(
operator|&
name|ic
operator|->
name|ic_vaps
argument_list|)
condition|)
comment|/* only one at a time */
return|return
operator|(
name|NULL
operator|)
return|;
name|uvp
operator|=
operator|(
expr|struct
name|urtwn_vap
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|urtwn_vap
argument_list|)
argument_list|,
name|M_80211_VAP
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|uvp
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|vap
operator|=
operator|&
name|uvp
operator|->
name|vap
expr_stmt|;
comment|/* enable s/w bmiss handling for sta mode */
if|if
condition|(
name|ieee80211_vap_setup
argument_list|(
name|ic
argument_list|,
name|vap
argument_list|,
name|name
argument_list|,
name|unit
argument_list|,
name|opmode
argument_list|,
name|flags
operator||
name|IEEE80211_CLONE_NOBEACONS
argument_list|,
name|bssid
argument_list|,
name|mac
argument_list|)
operator|!=
literal|0
condition|)
block|{
comment|/* out of memory */
name|free
argument_list|(
name|uvp
argument_list|,
name|M_80211_VAP
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
comment|/* override state transition machine */
name|uvp
operator|->
name|newstate
operator|=
name|vap
operator|->
name|iv_newstate
expr_stmt|;
name|vap
operator|->
name|iv_newstate
operator|=
name|urtwn_newstate
expr_stmt|;
comment|/* complete setup */
name|ieee80211_vap_attach
argument_list|(
name|vap
argument_list|,
name|ieee80211_media_change
argument_list|,
name|ieee80211_media_status
argument_list|)
expr_stmt|;
name|ic
operator|->
name|ic_opmode
operator|=
name|opmode
expr_stmt|;
return|return
operator|(
name|vap
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_vap_delete
parameter_list|(
name|struct
name|ieee80211vap
modifier|*
name|vap
parameter_list|)
block|{
name|struct
name|urtwn_vap
modifier|*
name|uvp
init|=
name|URTWN_VAP
argument_list|(
name|vap
argument_list|)
decl_stmt|;
name|ieee80211_vap_detach
argument_list|(
name|vap
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|uvp
argument_list|,
name|M_80211_VAP
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|mbuf
modifier|*
name|urtwn_rx_frame
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
modifier|*
name|buf
parameter_list|,
name|int
name|pktlen
parameter_list|,
name|int
modifier|*
name|rssi_p
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|ifp
operator|->
name|if_l2com
decl_stmt|;
name|struct
name|ieee80211_frame
modifier|*
name|wh
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|struct
name|r92c_rx_stat
modifier|*
name|stat
decl_stmt|;
name|uint32_t
name|rxdw0
decl_stmt|,
name|rxdw3
decl_stmt|;
name|uint8_t
name|rate
decl_stmt|;
name|int8_t
name|rssi
init|=
literal|0
decl_stmt|;
name|int
name|infosz
decl_stmt|;
comment|/* 	 * don't pass packets to the ieee80211 framework if the driver isn't 	 * RUNNING. 	 */
if|if
condition|(
operator|!
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|stat
operator|=
operator|(
expr|struct
name|r92c_rx_stat
operator|*
operator|)
name|buf
expr_stmt|;
name|rxdw0
operator|=
name|le32toh
argument_list|(
name|stat
operator|->
name|rxdw0
argument_list|)
expr_stmt|;
name|rxdw3
operator|=
name|le32toh
argument_list|(
name|stat
operator|->
name|rxdw3
argument_list|)
expr_stmt|;
if|if
condition|(
name|rxdw0
operator|&
operator|(
name|R92C_RXDW0_CRCERR
operator||
name|R92C_RXDW0_ICVERR
operator|)
condition|)
block|{
comment|/* 		 * This should not happen since we setup our Rx filter 		 * to not receive these frames. 		 */
name|ifp
operator|->
name|if_ierrors
operator|++
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|rate
operator|=
name|MS
argument_list|(
name|rxdw3
argument_list|,
name|R92C_RXDW3_RATE
argument_list|)
expr_stmt|;
name|infosz
operator|=
name|MS
argument_list|(
name|rxdw0
argument_list|,
name|R92C_RXDW0_INFOSZ
argument_list|)
operator|*
literal|8
expr_stmt|;
comment|/* Get RSSI from PHY status descriptor if present. */
if|if
condition|(
name|infosz
operator|!=
literal|0
operator|&&
operator|(
name|rxdw0
operator|&
name|R92C_RXDW0_PHYST
operator|)
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
condition|)
name|rssi
operator|=
name|urtwn_r88e_get_rssi
argument_list|(
name|sc
argument_list|,
name|rate
argument_list|,
operator|&
name|stat
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
else|else
name|rssi
operator|=
name|urtwn_get_rssi
argument_list|(
name|sc
argument_list|,
name|rate
argument_list|,
operator|&
name|stat
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
comment|/* Update our average RSSI. */
name|urtwn_update_avgrssi
argument_list|(
name|sc
argument_list|,
name|rate
argument_list|,
name|rssi
argument_list|)
expr_stmt|;
comment|/* 		 * Convert the RSSI to a range that will be accepted 		 * by net80211. 		 */
name|rssi
operator|=
name|URTWN_RSSI
argument_list|(
name|rssi
argument_list|)
expr_stmt|;
block|}
name|m
operator|=
name|m_getcl
argument_list|(
name|M_NOWAIT
argument_list|,
name|MT_DATA
argument_list|,
name|M_PKTHDR
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not create RX mbuf\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
comment|/* Finalize mbuf. */
name|m
operator|->
name|m_pkthdr
operator|.
name|rcvif
operator|=
name|ifp
expr_stmt|;
name|wh
operator|=
operator|(
expr|struct
name|ieee80211_frame
operator|*
operator|)
operator|(
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|stat
index|[
literal|1
index|]
operator|+
name|infosz
operator|)
expr_stmt|;
name|memcpy
argument_list|(
name|mtod
argument_list|(
name|m
argument_list|,
name|uint8_t
operator|*
argument_list|)
argument_list|,
name|wh
argument_list|,
name|pktlen
argument_list|)
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|m
operator|->
name|m_len
operator|=
name|pktlen
expr_stmt|;
if|if
condition|(
name|ieee80211_radiotap_active
argument_list|(
name|ic
argument_list|)
condition|)
block|{
name|struct
name|urtwn_rx_radiotap_header
modifier|*
name|tap
init|=
operator|&
name|sc
operator|->
name|sc_rxtap
decl_stmt|;
name|tap
operator|->
name|wr_flags
operator|=
literal|0
expr_stmt|;
comment|/* Map HW rate index to 802.11 rate. */
if|if
condition|(
operator|!
operator|(
name|rxdw3
operator|&
name|R92C_RXDW3_HT
operator|)
condition|)
block|{
switch|switch
condition|(
name|rate
condition|)
block|{
comment|/* CCK. */
case|case
literal|0
case|:
name|tap
operator|->
name|wr_rate
operator|=
literal|2
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|tap
operator|->
name|wr_rate
operator|=
literal|4
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|tap
operator|->
name|wr_rate
operator|=
literal|11
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|tap
operator|->
name|wr_rate
operator|=
literal|22
expr_stmt|;
break|break;
comment|/* OFDM. */
case|case
literal|4
case|:
name|tap
operator|->
name|wr_rate
operator|=
literal|12
expr_stmt|;
break|break;
case|case
literal|5
case|:
name|tap
operator|->
name|wr_rate
operator|=
literal|18
expr_stmt|;
break|break;
case|case
literal|6
case|:
name|tap
operator|->
name|wr_rate
operator|=
literal|24
expr_stmt|;
break|break;
case|case
literal|7
case|:
name|tap
operator|->
name|wr_rate
operator|=
literal|36
expr_stmt|;
break|break;
case|case
literal|8
case|:
name|tap
operator|->
name|wr_rate
operator|=
literal|48
expr_stmt|;
break|break;
case|case
literal|9
case|:
name|tap
operator|->
name|wr_rate
operator|=
literal|72
expr_stmt|;
break|break;
case|case
literal|10
case|:
name|tap
operator|->
name|wr_rate
operator|=
literal|96
expr_stmt|;
break|break;
case|case
literal|11
case|:
name|tap
operator|->
name|wr_rate
operator|=
literal|108
expr_stmt|;
break|break;
block|}
block|}
elseif|else
if|if
condition|(
name|rate
operator|>=
literal|12
condition|)
block|{
comment|/* MCS0~15. */
comment|/* Bit 7 set means HT MCS instead of rate. */
name|tap
operator|->
name|wr_rate
operator|=
literal|0x80
operator||
operator|(
name|rate
operator|-
literal|12
operator|)
expr_stmt|;
block|}
name|tap
operator|->
name|wr_dbm_antsignal
operator|=
name|rssi
expr_stmt|;
name|tap
operator|->
name|wr_chan_freq
operator|=
name|htole16
argument_list|(
name|ic
operator|->
name|ic_curchan
operator|->
name|ic_freq
argument_list|)
expr_stmt|;
name|tap
operator|->
name|wr_chan_flags
operator|=
name|htole16
argument_list|(
name|ic
operator|->
name|ic_curchan
operator|->
name|ic_flags
argument_list|)
expr_stmt|;
block|}
operator|*
name|rssi_p
operator|=
name|rssi
expr_stmt|;
return|return
operator|(
name|m
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|mbuf
modifier|*
name|urtwn_rxeof
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|,
name|struct
name|urtwn_data
modifier|*
name|data
parameter_list|,
name|int
modifier|*
name|rssi
parameter_list|,
name|int8_t
modifier|*
name|nf
parameter_list|)
block|{
name|struct
name|urtwn_softc
modifier|*
name|sc
init|=
name|data
operator|->
name|sc
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|struct
name|r92c_rx_stat
modifier|*
name|stat
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|,
modifier|*
name|m0
init|=
name|NULL
decl_stmt|,
modifier|*
name|prevm
init|=
name|NULL
decl_stmt|;
name|uint32_t
name|rxdw0
decl_stmt|;
name|uint8_t
modifier|*
name|buf
decl_stmt|;
name|int
name|len
decl_stmt|,
name|totlen
decl_stmt|,
name|pktlen
decl_stmt|,
name|infosz
decl_stmt|,
name|npkts
decl_stmt|;
name|usbd_xfer_status
argument_list|(
name|xfer
argument_list|,
operator|&
name|len
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|stat
argument_list|)
condition|)
block|{
name|ifp
operator|->
name|if_ierrors
operator|++
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|buf
operator|=
name|data
operator|->
name|buf
expr_stmt|;
comment|/* Get the number of encapsulated frames. */
name|stat
operator|=
operator|(
expr|struct
name|r92c_rx_stat
operator|*
operator|)
name|buf
expr_stmt|;
name|npkts
operator|=
name|MS
argument_list|(
name|le32toh
argument_list|(
name|stat
operator|->
name|rxdw2
argument_list|)
argument_list|,
name|R92C_RXDW2_PKTCNT
argument_list|)
expr_stmt|;
name|DPRINTFN
argument_list|(
literal|6
argument_list|,
literal|"Rx %d frames in one chunk\n"
argument_list|,
name|npkts
argument_list|)
expr_stmt|;
comment|/* Process all of them. */
while|while
condition|(
name|npkts
operator|--
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|stat
argument_list|)
condition|)
break|break;
name|stat
operator|=
operator|(
expr|struct
name|r92c_rx_stat
operator|*
operator|)
name|buf
expr_stmt|;
name|rxdw0
operator|=
name|le32toh
argument_list|(
name|stat
operator|->
name|rxdw0
argument_list|)
expr_stmt|;
name|pktlen
operator|=
name|MS
argument_list|(
name|rxdw0
argument_list|,
name|R92C_RXDW0_PKTLEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|pktlen
operator|==
literal|0
condition|)
break|break;
name|infosz
operator|=
name|MS
argument_list|(
name|rxdw0
argument_list|,
name|R92C_RXDW0_INFOSZ
argument_list|)
operator|*
literal|8
expr_stmt|;
comment|/* Make sure everything fits in xfer. */
name|totlen
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|stat
argument_list|)
operator|+
name|infosz
operator|+
name|pktlen
expr_stmt|;
if|if
condition|(
name|totlen
operator|>
name|len
condition|)
break|break;
name|m
operator|=
name|urtwn_rx_frame
argument_list|(
name|sc
argument_list|,
name|buf
argument_list|,
name|pktlen
argument_list|,
name|rssi
argument_list|)
expr_stmt|;
if|if
condition|(
name|m0
operator|==
name|NULL
condition|)
name|m0
operator|=
name|m
expr_stmt|;
if|if
condition|(
name|prevm
operator|==
name|NULL
condition|)
name|prevm
operator|=
name|m
expr_stmt|;
else|else
block|{
name|prevm
operator|->
name|m_next
operator|=
name|m
expr_stmt|;
name|prevm
operator|=
name|m
expr_stmt|;
block|}
comment|/* Next chunk is 128-byte aligned. */
name|totlen
operator|=
operator|(
name|totlen
operator|+
literal|127
operator|)
operator|&
operator|~
literal|127
expr_stmt|;
name|buf
operator|+=
name|totlen
expr_stmt|;
name|len
operator|-=
name|totlen
expr_stmt|;
block|}
return|return
operator|(
name|m0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_bulk_rx_callback
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|,
name|usb_error_t
name|error
parameter_list|)
block|{
name|struct
name|urtwn_softc
modifier|*
name|sc
init|=
name|usbd_xfer_softc
argument_list|(
name|xfer
argument_list|)
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|ifp
operator|->
name|if_l2com
decl_stmt|;
name|struct
name|ieee80211_frame
modifier|*
name|wh
decl_stmt|;
name|struct
name|ieee80211_node
modifier|*
name|ni
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
init|=
name|NULL
decl_stmt|,
modifier|*
name|next
decl_stmt|;
name|struct
name|urtwn_data
modifier|*
name|data
decl_stmt|;
name|int8_t
name|nf
decl_stmt|;
name|int
name|rssi
init|=
literal|1
decl_stmt|;
name|URTWN_ASSERT_LOCKED
argument_list|(
name|sc
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|USB_GET_STATE
argument_list|(
name|xfer
argument_list|)
condition|)
block|{
case|case
name|USB_ST_TRANSFERRED
case|:
name|data
operator|=
name|STAILQ_FIRST
argument_list|(
operator|&
name|sc
operator|->
name|sc_rx_active
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
goto|goto
name|tr_setup
goto|;
name|STAILQ_REMOVE_HEAD
argument_list|(
operator|&
name|sc
operator|->
name|sc_rx_active
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|m
operator|=
name|urtwn_rxeof
argument_list|(
name|xfer
argument_list|,
name|data
argument_list|,
operator|&
name|rssi
argument_list|,
operator|&
name|nf
argument_list|)
expr_stmt|;
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|sc
operator|->
name|sc_rx_inactive
argument_list|,
name|data
argument_list|,
name|next
argument_list|)
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|USB_ST_SETUP
case|:
name|tr_setup
label|:
name|data
operator|=
name|STAILQ_FIRST
argument_list|(
operator|&
name|sc
operator|->
name|sc_rx_inactive
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
block|{
name|KASSERT
argument_list|(
name|m
operator|==
name|NULL
argument_list|,
operator|(
literal|"mbuf isn't NULL"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|STAILQ_REMOVE_HEAD
argument_list|(
operator|&
name|sc
operator|->
name|sc_rx_inactive
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|sc
operator|->
name|sc_rx_active
argument_list|,
name|data
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|usbd_xfer_set_frame_data
argument_list|(
name|xfer
argument_list|,
literal|0
argument_list|,
name|data
operator|->
name|buf
argument_list|,
name|usbd_xfer_max_len
argument_list|(
name|xfer
argument_list|)
argument_list|)
expr_stmt|;
name|usbd_transfer_submit
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
comment|/* 		 * To avoid LOR we should unlock our private mutex here to call 		 * ieee80211_input() because here is at the end of a USB 		 * callback and safe to unlock. 		 */
name|URTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
while|while
condition|(
name|m
operator|!=
name|NULL
condition|)
block|{
name|next
operator|=
name|m
operator|->
name|m_next
expr_stmt|;
name|m
operator|->
name|m_next
operator|=
name|NULL
expr_stmt|;
name|wh
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ieee80211_frame
operator|*
argument_list|)
expr_stmt|;
name|ni
operator|=
name|ieee80211_find_rxnode
argument_list|(
name|ic
argument_list|,
operator|(
expr|struct
name|ieee80211_frame_min
operator|*
operator|)
name|wh
argument_list|)
expr_stmt|;
name|nf
operator|=
name|URTWN_NOISE_FLOOR
expr_stmt|;
if|if
condition|(
name|ni
operator|!=
name|NULL
condition|)
block|{
operator|(
name|void
operator|)
name|ieee80211_input
argument_list|(
name|ni
argument_list|,
name|m
argument_list|,
name|rssi
argument_list|,
name|nf
argument_list|)
expr_stmt|;
name|ieee80211_free_node
argument_list|(
name|ni
argument_list|)
expr_stmt|;
block|}
else|else
operator|(
name|void
operator|)
name|ieee80211_input_all
argument_list|(
name|ic
argument_list|,
name|m
argument_list|,
name|rssi
argument_list|,
name|nf
argument_list|)
expr_stmt|;
name|m
operator|=
name|next
expr_stmt|;
block|}
name|URTWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|/* needs it to the inactive queue due to a error. */
name|data
operator|=
name|STAILQ_FIRST
argument_list|(
operator|&
name|sc
operator|->
name|sc_rx_active
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|!=
name|NULL
condition|)
block|{
name|STAILQ_REMOVE_HEAD
argument_list|(
operator|&
name|sc
operator|->
name|sc_rx_active
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|sc
operator|->
name|sc_rx_inactive
argument_list|,
name|data
argument_list|,
name|next
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|error
operator|!=
name|USB_ERR_CANCELLED
condition|)
block|{
name|usbd_xfer_set_stall
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_ierrors
operator|++
expr_stmt|;
goto|goto
name|tr_setup
goto|;
block|}
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_txeof
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|,
name|struct
name|urtwn_data
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|urtwn_softc
modifier|*
name|sc
init|=
name|usbd_xfer_softc
argument_list|(
name|xfer
argument_list|)
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|URTWN_ASSERT_LOCKED
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* 	 * Do any tx complete callback.  Note this must be done before releasing 	 * the node reference. 	 */
if|if
condition|(
name|data
operator|->
name|m
condition|)
block|{
name|m
operator|=
name|data
operator|->
name|m
expr_stmt|;
if|if
condition|(
name|m
operator|->
name|m_flags
operator|&
name|M_TXCB
condition|)
block|{
comment|/* XXX status? */
name|ieee80211_process_callback
argument_list|(
name|data
operator|->
name|ni
argument_list|,
name|m
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|data
operator|->
name|m
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|data
operator|->
name|ni
condition|)
block|{
name|ieee80211_free_node
argument_list|(
name|data
operator|->
name|ni
argument_list|)
expr_stmt|;
name|data
operator|->
name|ni
operator|=
name|NULL
expr_stmt|;
block|}
name|sc
operator|->
name|sc_txtimer
operator|=
literal|0
expr_stmt|;
name|ifp
operator|->
name|if_opackets
operator|++
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_OACTIVE
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_bulk_tx_callback
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|,
name|usb_error_t
name|error
parameter_list|)
block|{
name|struct
name|urtwn_softc
modifier|*
name|sc
init|=
name|usbd_xfer_softc
argument_list|(
name|xfer
argument_list|)
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|struct
name|urtwn_data
modifier|*
name|data
decl_stmt|;
name|URTWN_ASSERT_LOCKED
argument_list|(
name|sc
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|USB_GET_STATE
argument_list|(
name|xfer
argument_list|)
condition|)
block|{
case|case
name|USB_ST_TRANSFERRED
case|:
name|data
operator|=
name|STAILQ_FIRST
argument_list|(
operator|&
name|sc
operator|->
name|sc_tx_active
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
goto|goto
name|tr_setup
goto|;
name|STAILQ_REMOVE_HEAD
argument_list|(
operator|&
name|sc
operator|->
name|sc_tx_active
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|urtwn_txeof
argument_list|(
name|xfer
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|sc
operator|->
name|sc_tx_inactive
argument_list|,
name|data
argument_list|,
name|next
argument_list|)
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|USB_ST_SETUP
case|:
name|tr_setup
label|:
name|data
operator|=
name|STAILQ_FIRST
argument_list|(
operator|&
name|sc
operator|->
name|sc_tx_pending
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
block|{
name|DPRINTF
argument_list|(
literal|"%s: empty pending queue\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return;
block|}
name|STAILQ_REMOVE_HEAD
argument_list|(
operator|&
name|sc
operator|->
name|sc_tx_pending
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|sc
operator|->
name|sc_tx_active
argument_list|,
name|data
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|usbd_xfer_set_frame_data
argument_list|(
name|xfer
argument_list|,
literal|0
argument_list|,
name|data
operator|->
name|buf
argument_list|,
name|data
operator|->
name|buflen
argument_list|)
expr_stmt|;
name|usbd_transfer_submit
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
name|urtwn_start_locked
argument_list|(
name|ifp
argument_list|,
name|sc
argument_list|)
expr_stmt|;
break|break;
default|default:
name|data
operator|=
name|STAILQ_FIRST
argument_list|(
operator|&
name|sc
operator|->
name|sc_tx_active
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
goto|goto
name|tr_setup
goto|;
if|if
condition|(
name|data
operator|->
name|ni
operator|!=
name|NULL
condition|)
block|{
name|ieee80211_free_node
argument_list|(
name|data
operator|->
name|ni
argument_list|)
expr_stmt|;
name|data
operator|->
name|ni
operator|=
name|NULL
expr_stmt|;
name|ifp
operator|->
name|if_oerrors
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|error
operator|!=
name|USB_ERR_CANCELLED
condition|)
block|{
name|usbd_xfer_set_stall
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
goto|goto
name|tr_setup
goto|;
block|}
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|struct
name|urtwn_data
modifier|*
name|_urtwn_getbuf
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|urtwn_data
modifier|*
name|bf
decl_stmt|;
name|bf
operator|=
name|STAILQ_FIRST
argument_list|(
operator|&
name|sc
operator|->
name|sc_tx_inactive
argument_list|)
expr_stmt|;
if|if
condition|(
name|bf
operator|!=
name|NULL
condition|)
name|STAILQ_REMOVE_HEAD
argument_list|(
operator|&
name|sc
operator|->
name|sc_tx_inactive
argument_list|,
name|next
argument_list|)
expr_stmt|;
else|else
name|bf
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|bf
operator|==
name|NULL
condition|)
name|DPRINTF
argument_list|(
literal|"%s: %s\n"
argument_list|,
name|__func__
argument_list|,
literal|"out of xmit buffers"
argument_list|)
expr_stmt|;
return|return
operator|(
name|bf
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|urtwn_data
modifier|*
name|urtwn_getbuf
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|urtwn_data
modifier|*
name|bf
decl_stmt|;
name|URTWN_ASSERT_LOCKED
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|bf
operator|=
name|_urtwn_getbuf
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|bf
operator|==
name|NULL
condition|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|DPRINTF
argument_list|(
literal|"%s: stop queue\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator||=
name|IFF_DRV_OACTIVE
expr_stmt|;
block|}
return|return
operator|(
name|bf
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|urtwn_write_region_1
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|uint16_t
name|addr
parameter_list|,
name|uint8_t
modifier|*
name|buf
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|usb_device_request_t
name|req
decl_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_WRITE_VENDOR_DEVICE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|R92C_REQ_REGS
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|(
name|urtwn_do_request
argument_list|(
name|sc
argument_list|,
operator|&
name|req
argument_list|,
name|buf
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_write_1
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|uint16_t
name|addr
parameter_list|,
name|uint8_t
name|val
parameter_list|)
block|{
name|urtwn_write_region_1
argument_list|(
name|sc
argument_list|,
name|addr
argument_list|,
operator|&
name|val
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_write_2
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|uint16_t
name|addr
parameter_list|,
name|uint16_t
name|val
parameter_list|)
block|{
name|val
operator|=
name|htole16
argument_list|(
name|val
argument_list|)
expr_stmt|;
name|urtwn_write_region_1
argument_list|(
name|sc
argument_list|,
name|addr
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|val
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_write_4
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|uint16_t
name|addr
parameter_list|,
name|uint32_t
name|val
parameter_list|)
block|{
name|val
operator|=
name|htole32
argument_list|(
name|val
argument_list|)
expr_stmt|;
name|urtwn_write_region_1
argument_list|(
name|sc
argument_list|,
name|addr
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|val
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|urtwn_read_region_1
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|uint16_t
name|addr
parameter_list|,
name|uint8_t
modifier|*
name|buf
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|usb_device_request_t
name|req
decl_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_READ_VENDOR_DEVICE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|R92C_REQ_REGS
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|(
name|urtwn_do_request
argument_list|(
name|sc
argument_list|,
operator|&
name|req
argument_list|,
name|buf
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|urtwn_read_1
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|uint16_t
name|addr
parameter_list|)
block|{
name|uint8_t
name|val
decl_stmt|;
if|if
condition|(
name|urtwn_read_region_1
argument_list|(
name|sc
argument_list|,
name|addr
argument_list|,
operator|&
name|val
argument_list|,
literal|1
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
literal|0xff
operator|)
return|;
return|return
operator|(
name|val
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint16_t
name|urtwn_read_2
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|uint16_t
name|addr
parameter_list|)
block|{
name|uint16_t
name|val
decl_stmt|;
if|if
condition|(
name|urtwn_read_region_1
argument_list|(
name|sc
argument_list|,
name|addr
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|val
argument_list|,
literal|2
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
literal|0xffff
operator|)
return|;
return|return
operator|(
name|le16toh
argument_list|(
name|val
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|urtwn_read_4
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|uint16_t
name|addr
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|;
if|if
condition|(
name|urtwn_read_region_1
argument_list|(
name|sc
argument_list|,
name|addr
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|val
argument_list|,
literal|4
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
literal|0xffffffff
operator|)
return|;
return|return
operator|(
name|le32toh
argument_list|(
name|val
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|urtwn_fw_cmd
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|id
parameter_list|,
specifier|const
name|void
modifier|*
name|buf
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|struct
name|r92c_fw_cmd
name|cmd
decl_stmt|;
name|int
name|ntries
decl_stmt|;
comment|/* Wait for current FW box to be empty. */
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|100
condition|;
name|ntries
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_HMETFR
argument_list|)
operator|&
operator|(
literal|1
operator|<<
name|sc
operator|->
name|fwcur
operator|)
operator|)
condition|)
break|break;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ntries
operator|==
literal|100
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not send firmware command\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ETIMEDOUT
operator|)
return|;
block|}
name|memset
argument_list|(
operator|&
name|cmd
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|cmd
argument_list|)
argument_list|)
expr_stmt|;
name|cmd
operator|.
name|id
operator|=
name|id
expr_stmt|;
if|if
condition|(
name|len
operator|>
literal|3
condition|)
name|cmd
operator|.
name|id
operator||=
name|R92C_CMD_FLAG_EXT
expr_stmt|;
name|KASSERT
argument_list|(
name|len
operator|<=
sizeof|sizeof
argument_list|(
name|cmd
operator|.
name|msg
argument_list|)
argument_list|,
operator|(
literal|"urtwn_fw_cmd\n"
operator|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|cmd
operator|.
name|msg
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
comment|/* Write the first word last since that will trigger the FW. */
name|urtwn_write_region_1
argument_list|(
name|sc
argument_list|,
name|R92C_HMEBOX_EXT
argument_list|(
name|sc
operator|->
name|fwcur
argument_list|)
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|cmd
operator|+
literal|4
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|urtwn_write_region_1
argument_list|(
name|sc
argument_list|,
name|R92C_HMEBOX
argument_list|(
name|sc
operator|->
name|fwcur
argument_list|)
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|cmd
operator|+
literal|0
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|sc
operator|->
name|fwcur
operator|=
operator|(
name|sc
operator|->
name|fwcur
operator|+
literal|1
operator|)
operator|%
name|R92C_H2C_NBOX
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|__inline
name|void
name|urtwn_rf_write
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|int
name|chain
parameter_list|,
name|uint8_t
name|addr
parameter_list|,
name|uint32_t
name|val
parameter_list|)
block|{
name|sc
operator|->
name|sc_rf_write
argument_list|(
name|sc
argument_list|,
name|chain
argument_list|,
name|addr
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_r92c_rf_write
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|int
name|chain
parameter_list|,
name|uint8_t
name|addr
parameter_list|,
name|uint32_t
name|val
parameter_list|)
block|{
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_LSSI_PARAM
argument_list|(
name|chain
argument_list|)
argument_list|,
name|SM
argument_list|(
name|R92C_LSSI_PARAM_ADDR
argument_list|,
name|addr
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_LSSI_PARAM_DATA
argument_list|,
name|val
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_r88e_rf_write
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|int
name|chain
parameter_list|,
name|uint8_t
name|addr
parameter_list|,
name|uint32_t
name|val
parameter_list|)
block|{
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_LSSI_PARAM
argument_list|(
name|chain
argument_list|)
argument_list|,
name|SM
argument_list|(
name|R88E_LSSI_PARAM_ADDR
argument_list|,
name|addr
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_LSSI_PARAM_DATA
argument_list|,
name|val
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|urtwn_rf_read
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|int
name|chain
parameter_list|,
name|uint8_t
name|addr
parameter_list|)
block|{
name|uint32_t
name|reg
index|[
name|R92C_MAX_CHAINS
index|]
decl_stmt|,
name|val
decl_stmt|;
name|reg
index|[
literal|0
index|]
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_HSSI_PARAM2
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|chain
operator|!=
literal|0
condition|)
name|reg
index|[
name|chain
index|]
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_HSSI_PARAM2
argument_list|(
name|chain
argument_list|)
argument_list|)
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_HSSI_PARAM2
argument_list|(
literal|0
argument_list|)
argument_list|,
name|reg
index|[
literal|0
index|]
operator|&
operator|~
name|R92C_HSSI_PARAM2_READ_EDGE
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_HSSI_PARAM2
argument_list|(
name|chain
argument_list|)
argument_list|,
name|RW
argument_list|(
name|reg
index|[
name|chain
index|]
argument_list|,
name|R92C_HSSI_PARAM2_READ_ADDR
argument_list|,
name|addr
argument_list|)
operator||
name|R92C_HSSI_PARAM2_READ_EDGE
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_HSSI_PARAM2
argument_list|(
literal|0
argument_list|)
argument_list|,
name|reg
index|[
literal|0
index|]
operator||
name|R92C_HSSI_PARAM2_READ_EDGE
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
if|if
condition|(
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_HSSI_PARAM1
argument_list|(
name|chain
argument_list|)
argument_list|)
operator|&
name|R92C_HSSI_PARAM1_PI
condition|)
name|val
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_HSPI_READBACK
argument_list|(
name|chain
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|val
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_LSSI_READBACK
argument_list|(
name|chain
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|MS
argument_list|(
name|val
argument_list|,
name|R92C_LSSI_READBACK_DATA
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|urtwn_llt_write
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|addr
parameter_list|,
name|uint32_t
name|data
parameter_list|)
block|{
name|int
name|ntries
decl_stmt|;
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_LLT_INIT
argument_list|,
name|SM
argument_list|(
name|R92C_LLT_INIT_OP
argument_list|,
name|R92C_LLT_INIT_OP_WRITE
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_LLT_INIT_ADDR
argument_list|,
name|addr
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_LLT_INIT_DATA
argument_list|,
name|data
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Wait for write operation to complete. */
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|20
condition|;
name|ntries
operator|++
control|)
block|{
if|if
condition|(
name|MS
argument_list|(
name|urtwn_read_4
argument_list|(
name|sc
argument_list|,
name|R92C_LLT_INIT
argument_list|)
argument_list|,
name|R92C_LLT_INIT_OP
argument_list|)
operator|==
name|R92C_LLT_INIT_OP_NO_ACTIVE
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|DELAY
argument_list|(
literal|5
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|ETIMEDOUT
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|urtwn_efuse_read_1
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|uint16_t
name|addr
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
name|int
name|ntries
decl_stmt|;
name|reg
operator|=
name|urtwn_read_4
argument_list|(
name|sc
argument_list|,
name|R92C_EFUSE_CTRL
argument_list|)
expr_stmt|;
name|reg
operator|=
name|RW
argument_list|(
name|reg
argument_list|,
name|R92C_EFUSE_CTRL_ADDR
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
name|R92C_EFUSE_CTRL_VALID
expr_stmt|;
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_EFUSE_CTRL
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Wait for read operation to complete. */
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|100
condition|;
name|ntries
operator|++
control|)
block|{
name|reg
operator|=
name|urtwn_read_4
argument_list|(
name|sc
argument_list|,
name|R92C_EFUSE_CTRL
argument_list|)
expr_stmt|;
if|if
condition|(
name|reg
operator|&
name|R92C_EFUSE_CTRL_VALID
condition|)
return|return
operator|(
name|MS
argument_list|(
name|reg
argument_list|,
name|R92C_EFUSE_CTRL_DATA
argument_list|)
operator|)
return|;
name|DELAY
argument_list|(
literal|5
argument_list|)
expr_stmt|;
block|}
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not read efuse byte at address 0x%x\n"
argument_list|,
name|addr
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0xff
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_efuse_read
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint8_t
modifier|*
name|rom
init|=
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|sc
operator|->
name|rom
decl_stmt|;
name|uint16_t
name|addr
init|=
literal|0
decl_stmt|;
name|uint32_t
name|reg
decl_stmt|;
name|uint8_t
name|off
decl_stmt|,
name|msk
decl_stmt|;
name|int
name|i
decl_stmt|;
name|urtwn_efuse_switch_power
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|sc
operator|->
name|rom
argument_list|,
literal|0xff
argument_list|,
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|rom
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|addr
operator|<
literal|512
condition|)
block|{
name|reg
operator|=
name|urtwn_efuse_read_1
argument_list|(
name|sc
argument_list|,
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|reg
operator|==
literal|0xff
condition|)
break|break;
name|addr
operator|++
expr_stmt|;
name|off
operator|=
name|reg
operator|>>
literal|4
expr_stmt|;
name|msk
operator|=
name|reg
operator|&
literal|0xf
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|msk
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
condition|)
continue|continue;
name|rom
index|[
name|off
operator|*
literal|8
operator|+
name|i
operator|*
literal|2
operator|+
literal|0
index|]
operator|=
name|urtwn_efuse_read_1
argument_list|(
name|sc
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|addr
operator|++
expr_stmt|;
name|rom
index|[
name|off
operator|*
literal|8
operator|+
name|i
operator|*
literal|2
operator|+
literal|1
index|]
operator|=
name|urtwn_efuse_read_1
argument_list|(
name|sc
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|addr
operator|++
expr_stmt|;
block|}
block|}
ifdef|#
directive|ifdef
name|URTWN_DEBUG
if|if
condition|(
name|urtwn_debug
operator|>=
literal|2
condition|)
block|{
comment|/* Dump ROM content. */
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|rom
argument_list|)
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"%02x:"
argument_list|,
name|rom
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_efuse_switch_power
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
name|reg
operator|=
name|urtwn_read_2
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_ISO_CTRL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|reg
operator|&
name|R92C_SYS_ISO_CTRL_PWC_EV12V
operator|)
condition|)
block|{
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_ISO_CTRL
argument_list|,
name|reg
operator||
name|R92C_SYS_ISO_CTRL_PWC_EV12V
argument_list|)
expr_stmt|;
block|}
name|reg
operator|=
name|urtwn_read_2
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_FUNC_EN
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|reg
operator|&
name|R92C_SYS_FUNC_EN_ELDR
operator|)
condition|)
block|{
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_FUNC_EN
argument_list|,
name|reg
operator||
name|R92C_SYS_FUNC_EN_ELDR
argument_list|)
expr_stmt|;
block|}
name|reg
operator|=
name|urtwn_read_2
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_CLKR
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|reg
operator|&
operator|(
name|R92C_SYS_CLKR_LOADER_EN
operator||
name|R92C_SYS_CLKR_ANA8M
operator|)
operator|)
operator|!=
operator|(
name|R92C_SYS_CLKR_LOADER_EN
operator||
name|R92C_SYS_CLKR_ANA8M
operator|)
condition|)
block|{
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_CLKR
argument_list|,
name|reg
operator||
name|R92C_SYS_CLKR_LOADER_EN
operator||
name|R92C_SYS_CLKR_ANA8M
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|urtwn_read_chipid
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|reg
operator|=
name|urtwn_read_4
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_CFG
argument_list|)
expr_stmt|;
if|if
condition|(
name|reg
operator|&
name|R92C_SYS_CFG_TRP_VAUX_EN
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
if|if
condition|(
name|reg
operator|&
name|R92C_SYS_CFG_TYPE_92C
condition|)
block|{
name|sc
operator|->
name|chip
operator||=
name|URTWN_CHIP_92C
expr_stmt|;
comment|/* Check if it is a castrated 8192C. */
if|if
condition|(
name|MS
argument_list|(
name|urtwn_read_4
argument_list|(
name|sc
argument_list|,
name|R92C_HPON_FSM
argument_list|)
argument_list|,
name|R92C_HPON_FSM_CHIP_BONDING_ID
argument_list|)
operator|==
name|R92C_HPON_FSM_CHIP_BONDING_ID_92C_1T2R
condition|)
name|sc
operator|->
name|chip
operator||=
name|URTWN_CHIP_92C_1T2R
expr_stmt|;
block|}
if|if
condition|(
name|reg
operator|&
name|R92C_SYS_CFG_VENDOR_UMC
condition|)
block|{
name|sc
operator|->
name|chip
operator||=
name|URTWN_CHIP_UMC
expr_stmt|;
if|if
condition|(
name|MS
argument_list|(
name|reg
argument_list|,
name|R92C_SYS_CFG_CHIP_VER_RTL
argument_list|)
operator|==
literal|0
condition|)
name|sc
operator|->
name|chip
operator||=
name|URTWN_CHIP_UMC_A_CUT
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_read_rom
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|r92c_rom
modifier|*
name|rom
init|=
operator|&
name|sc
operator|->
name|rom
decl_stmt|;
comment|/* Read full ROM image. */
name|urtwn_efuse_read
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* XXX Weird but this is what the vendor driver does. */
name|sc
operator|->
name|pa_setting
operator|=
name|urtwn_efuse_read_1
argument_list|(
name|sc
argument_list|,
literal|0x1fa
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"PA setting=0x%x\n"
argument_list|,
name|sc
operator|->
name|pa_setting
argument_list|)
expr_stmt|;
name|sc
operator|->
name|board_type
operator|=
name|MS
argument_list|(
name|rom
operator|->
name|rf_opt1
argument_list|,
name|R92C_ROM_RF1_BOARD_TYPE
argument_list|)
expr_stmt|;
name|sc
operator|->
name|regulatory
operator|=
name|MS
argument_list|(
name|rom
operator|->
name|rf_opt1
argument_list|,
name|R92C_ROM_RF1_REGULATORY
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"regulatory type=%d\n"
argument_list|,
name|sc
operator|->
name|regulatory
argument_list|)
expr_stmt|;
name|IEEE80211_ADDR_COPY
argument_list|(
name|sc
operator|->
name|sc_bssid
argument_list|,
name|rom
operator|->
name|macaddr
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_rf_write
operator|=
name|urtwn_r92c_rf_write
expr_stmt|;
name|sc
operator|->
name|sc_power_on
operator|=
name|urtwn_r92c_power_on
expr_stmt|;
name|sc
operator|->
name|sc_dma_init
operator|=
name|urtwn_r92c_dma_init
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_r88e_read_rom
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint8_t
modifier|*
name|rom
init|=
name|sc
operator|->
name|r88e_rom
decl_stmt|;
name|uint16_t
name|addr
init|=
literal|0
decl_stmt|;
name|uint32_t
name|reg
decl_stmt|;
name|uint8_t
name|off
decl_stmt|,
name|msk
decl_stmt|,
name|tmp
decl_stmt|;
name|int
name|i
decl_stmt|;
name|urtwn_efuse_switch_power
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Read full ROM image. */
name|memset
argument_list|(
operator|&
name|sc
operator|->
name|r88e_rom
argument_list|,
literal|0xff
argument_list|,
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|r88e_rom
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|addr
operator|<
literal|1024
condition|)
block|{
name|reg
operator|=
name|urtwn_efuse_read_1
argument_list|(
name|sc
argument_list|,
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|reg
operator|==
literal|0xff
condition|)
break|break;
name|addr
operator|++
expr_stmt|;
if|if
condition|(
operator|(
name|reg
operator|&
literal|0x1f
operator|)
operator|==
literal|0x0f
condition|)
block|{
name|tmp
operator|=
operator|(
name|reg
operator|&
literal|0xe0
operator|)
operator|>>
literal|5
expr_stmt|;
name|reg
operator|=
name|urtwn_efuse_read_1
argument_list|(
name|sc
argument_list|,
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|reg
operator|&
literal|0x0f
operator|)
operator|!=
literal|0x0f
condition|)
name|off
operator|=
operator|(
operator|(
name|reg
operator|&
literal|0xf0
operator|)
operator|>>
literal|1
operator|)
operator||
name|tmp
expr_stmt|;
name|addr
operator|++
expr_stmt|;
block|}
else|else
name|off
operator|=
name|reg
operator|>>
literal|4
expr_stmt|;
name|msk
operator|=
name|reg
operator|&
literal|0xf
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|msk
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
condition|)
continue|continue;
name|rom
index|[
name|off
operator|*
literal|8
operator|+
name|i
operator|*
literal|2
operator|+
literal|0
index|]
operator|=
name|urtwn_efuse_read_1
argument_list|(
name|sc
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|addr
operator|++
expr_stmt|;
name|rom
index|[
name|off
operator|*
literal|8
operator|+
name|i
operator|*
literal|2
operator|+
literal|1
index|]
operator|=
name|urtwn_efuse_read_1
argument_list|(
name|sc
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|addr
operator|++
expr_stmt|;
block|}
block|}
name|addr
operator|=
literal|0x10
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|6
condition|;
name|i
operator|++
control|)
name|sc
operator|->
name|cck_tx_pwr
index|[
name|i
index|]
operator|=
name|sc
operator|->
name|r88e_rom
index|[
name|addr
operator|++
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|5
condition|;
name|i
operator|++
control|)
name|sc
operator|->
name|ht40_tx_pwr
index|[
name|i
index|]
operator|=
name|sc
operator|->
name|r88e_rom
index|[
name|addr
operator|++
index|]
expr_stmt|;
name|sc
operator|->
name|bw20_tx_pwr_diff
operator|=
operator|(
name|sc
operator|->
name|r88e_rom
index|[
name|addr
index|]
operator|&
literal|0xf0
operator|)
operator|>>
literal|4
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|bw20_tx_pwr_diff
operator|&
literal|0x08
condition|)
name|sc
operator|->
name|bw20_tx_pwr_diff
operator||=
literal|0xf0
expr_stmt|;
name|sc
operator|->
name|ofdm_tx_pwr_diff
operator|=
operator|(
name|sc
operator|->
name|r88e_rom
index|[
name|addr
index|]
operator|&
literal|0xf
operator|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|ofdm_tx_pwr_diff
operator|&
literal|0x08
condition|)
name|sc
operator|->
name|ofdm_tx_pwr_diff
operator||=
literal|0xf0
expr_stmt|;
name|sc
operator|->
name|regulatory
operator|=
name|MS
argument_list|(
name|sc
operator|->
name|r88e_rom
index|[
literal|0xc1
index|]
argument_list|,
name|R92C_ROM_RF1_REGULATORY
argument_list|)
expr_stmt|;
name|IEEE80211_ADDR_COPY
argument_list|(
name|sc
operator|->
name|sc_bssid
argument_list|,
operator|&
name|sc
operator|->
name|r88e_rom
index|[
literal|0xd7
index|]
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_rf_write
operator|=
name|urtwn_r88e_rf_write
expr_stmt|;
name|sc
operator|->
name|sc_power_on
operator|=
name|urtwn_r88e_power_on
expr_stmt|;
name|sc
operator|->
name|sc_dma_init
operator|=
name|urtwn_r88e_dma_init
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Initialize rate adaptation in firmware.  */
end_comment

begin_function
specifier|static
name|int
name|urtwn_ra_init
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
specifier|static
specifier|const
name|uint8_t
name|map
index|[]
init|=
block|{
literal|2
block|,
literal|4
block|,
literal|11
block|,
literal|22
block|,
literal|12
block|,
literal|18
block|,
literal|24
block|,
literal|36
block|,
literal|48
block|,
literal|72
block|,
literal|96
block|,
literal|108
block|}
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|sc
operator|->
name|sc_ifp
operator|->
name|if_l2com
decl_stmt|;
name|struct
name|ieee80211vap
modifier|*
name|vap
init|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|ic
operator|->
name|ic_vaps
argument_list|)
decl_stmt|;
name|struct
name|ieee80211_node
modifier|*
name|ni
decl_stmt|;
name|struct
name|ieee80211_rateset
modifier|*
name|rs
decl_stmt|;
name|struct
name|r92c_fw_cmd_macid_cfg
name|cmd
decl_stmt|;
name|uint32_t
name|rates
decl_stmt|,
name|basicrates
decl_stmt|;
name|uint8_t
name|mode
decl_stmt|;
name|int
name|maxrate
decl_stmt|,
name|maxbasicrate
decl_stmt|,
name|error
decl_stmt|,
name|i
decl_stmt|,
name|j
decl_stmt|;
name|ni
operator|=
name|ieee80211_ref_node
argument_list|(
name|vap
operator|->
name|iv_bss
argument_list|)
expr_stmt|;
name|rs
operator|=
operator|&
name|ni
operator|->
name|ni_rates
expr_stmt|;
comment|/* Get normal and basic rates mask. */
name|rates
operator|=
name|basicrates
operator|=
literal|0
expr_stmt|;
name|maxrate
operator|=
name|maxbasicrate
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rs
operator|->
name|rs_nrates
condition|;
name|i
operator|++
control|)
block|{
comment|/* Convert 802.11 rate to HW rate index. */
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|nitems
argument_list|(
name|map
argument_list|)
condition|;
name|j
operator|++
control|)
if|if
condition|(
operator|(
name|rs
operator|->
name|rs_rates
index|[
name|i
index|]
operator|&
name|IEEE80211_RATE_VAL
operator|)
operator|==
name|map
index|[
name|j
index|]
condition|)
break|break;
if|if
condition|(
name|j
operator|==
name|nitems
argument_list|(
name|map
argument_list|)
condition|)
comment|/* Unknown rate, skip. */
continue|continue;
name|rates
operator||=
literal|1
operator|<<
name|j
expr_stmt|;
if|if
condition|(
name|j
operator|>
name|maxrate
condition|)
name|maxrate
operator|=
name|j
expr_stmt|;
if|if
condition|(
name|rs
operator|->
name|rs_rates
index|[
name|i
index|]
operator|&
name|IEEE80211_RATE_BASIC
condition|)
block|{
name|basicrates
operator||=
literal|1
operator|<<
name|j
expr_stmt|;
if|if
condition|(
name|j
operator|>
name|maxbasicrate
condition|)
name|maxbasicrate
operator|=
name|j
expr_stmt|;
block|}
block|}
if|if
condition|(
name|ic
operator|->
name|ic_curmode
operator|==
name|IEEE80211_MODE_11B
condition|)
name|mode
operator|=
name|R92C_RAID_11B
expr_stmt|;
else|else
name|mode
operator|=
name|R92C_RAID_11BG
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"mode=0x%x rates=0x%08x, basicrates=0x%08x\n"
argument_list|,
name|mode
argument_list|,
name|rates
argument_list|,
name|basicrates
argument_list|)
expr_stmt|;
comment|/* Set rates mask for group addressed frames. */
name|cmd
operator|.
name|macid
operator|=
name|URTWN_MACID_BC
operator||
name|URTWN_MACID_VALID
expr_stmt|;
name|cmd
operator|.
name|mask
operator|=
name|htole32
argument_list|(
name|mode
operator|<<
literal|28
operator||
name|basicrates
argument_list|)
expr_stmt|;
name|error
operator|=
name|urtwn_fw_cmd
argument_list|(
name|sc
argument_list|,
name|R92C_CMD_MACID_CONFIG
argument_list|,
operator|&
name|cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|cmd
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|ieee80211_free_node
argument_list|(
name|ni
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not add broadcast station\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
comment|/* Set initial MRR rate. */
name|DPRINTF
argument_list|(
literal|"maxbasicrate=%d\n"
argument_list|,
name|maxbasicrate
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_INIDATA_RATE_SEL
argument_list|(
name|URTWN_MACID_BC
argument_list|)
argument_list|,
name|maxbasicrate
argument_list|)
expr_stmt|;
comment|/* Set rates mask for unicast frames. */
name|cmd
operator|.
name|macid
operator|=
name|URTWN_MACID_BSS
operator||
name|URTWN_MACID_VALID
expr_stmt|;
name|cmd
operator|.
name|mask
operator|=
name|htole32
argument_list|(
name|mode
operator|<<
literal|28
operator||
name|rates
argument_list|)
expr_stmt|;
name|error
operator|=
name|urtwn_fw_cmd
argument_list|(
name|sc
argument_list|,
name|R92C_CMD_MACID_CONFIG
argument_list|,
operator|&
name|cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|cmd
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|ieee80211_free_node
argument_list|(
name|ni
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not add BSS station\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
comment|/* Set initial MRR rate. */
name|DPRINTF
argument_list|(
literal|"maxrate=%d\n"
argument_list|,
name|maxrate
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_INIDATA_RATE_SEL
argument_list|(
name|URTWN_MACID_BSS
argument_list|)
argument_list|,
name|maxrate
argument_list|)
expr_stmt|;
comment|/* Indicate highest supported rate. */
name|ni
operator|->
name|ni_txrate
operator|=
name|rs
operator|->
name|rs_rates
index|[
name|rs
operator|->
name|rs_nrates
operator|-
literal|1
index|]
expr_stmt|;
name|ieee80211_free_node
argument_list|(
name|ni
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|void
name|urtwn_tsf_sync_enable
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|ifp
operator|->
name|if_l2com
decl_stmt|;
name|struct
name|ieee80211vap
modifier|*
name|vap
init|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|ic
operator|->
name|ic_vaps
argument_list|)
decl_stmt|;
name|struct
name|ieee80211_node
modifier|*
name|ni
init|=
name|vap
operator|->
name|iv_bss
decl_stmt|;
name|uint64_t
name|tsf
decl_stmt|;
comment|/* Enable TSF synchronization. */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_BCN_CTRL
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_BCN_CTRL
argument_list|)
operator|&
operator|~
name|R92C_BCN_CTRL_DIS_TSF_UDT0
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_BCN_CTRL
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_BCN_CTRL
argument_list|)
operator|&
operator|~
name|R92C_BCN_CTRL_EN_BCN
argument_list|)
expr_stmt|;
comment|/* Set initial TSF. */
name|memcpy
argument_list|(
operator|&
name|tsf
argument_list|,
name|ni
operator|->
name|ni_tstamp
operator|.
name|data
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|tsf
operator|=
name|le64toh
argument_list|(
name|tsf
argument_list|)
expr_stmt|;
name|tsf
operator|=
name|tsf
operator|-
operator|(
name|tsf
operator|%
operator|(
name|vap
operator|->
name|iv_bss
operator|->
name|ni_intval
operator|*
name|IEEE80211_DUR_TU
operator|)
operator|)
expr_stmt|;
name|tsf
operator|-=
name|IEEE80211_DUR_TU
expr_stmt|;
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_TSFTR
operator|+
literal|0
argument_list|,
name|tsf
argument_list|)
expr_stmt|;
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_TSFTR
operator|+
literal|4
argument_list|,
name|tsf
operator|>>
literal|32
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_BCN_CTRL
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_BCN_CTRL
argument_list|)
operator||
name|R92C_BCN_CTRL_EN_BCN
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_set_led
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|int
name|led
parameter_list|,
name|int
name|on
parameter_list|)
block|{
name|uint8_t
name|reg
decl_stmt|;
if|if
condition|(
name|led
operator|==
name|URTWN_LED_LINK
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
condition|)
block|{
name|reg
operator|=
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_LEDCFG2
argument_list|)
operator|&
literal|0xf0
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_LEDCFG2
argument_list|,
name|reg
operator||
literal|0x60
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|on
condition|)
block|{
name|reg
operator|=
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_LEDCFG2
argument_list|)
operator|&
literal|0x90
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_LEDCFG2
argument_list|,
name|reg
operator||
name|R92C_LEDCFG0_DIS
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_MAC_PINMUX_CFG
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_MAC_PINMUX_CFG
argument_list|)
operator|&
literal|0xfe
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|reg
operator|=
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_LEDCFG0
argument_list|)
operator|&
literal|0x70
expr_stmt|;
if|if
condition|(
operator|!
name|on
condition|)
name|reg
operator||=
name|R92C_LEDCFG0_DIS
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_LEDCFG0
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
name|sc
operator|->
name|ledlink
operator|=
name|on
expr_stmt|;
comment|/* Save LED state. */
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|urtwn_newstate
parameter_list|(
name|struct
name|ieee80211vap
modifier|*
name|vap
parameter_list|,
name|enum
name|ieee80211_state
name|nstate
parameter_list|,
name|int
name|arg
parameter_list|)
block|{
name|struct
name|urtwn_vap
modifier|*
name|uvp
init|=
name|URTWN_VAP
argument_list|(
name|vap
argument_list|)
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|vap
operator|->
name|iv_ic
decl_stmt|;
name|struct
name|urtwn_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|ieee80211_node
modifier|*
name|ni
decl_stmt|;
name|enum
name|ieee80211_state
name|ostate
decl_stmt|;
name|uint32_t
name|reg
decl_stmt|;
name|ostate
operator|=
name|vap
operator|->
name|iv_state
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"%s -> %s\n"
argument_list|,
name|ieee80211_state_name
index|[
name|ostate
index|]
argument_list|,
name|ieee80211_state_name
index|[
name|nstate
index|]
argument_list|)
expr_stmt|;
name|IEEE80211_UNLOCK
argument_list|(
name|ic
argument_list|)
expr_stmt|;
name|URTWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|callout_stop
argument_list|(
operator|&
name|sc
operator|->
name|sc_watchdog_ch
argument_list|)
expr_stmt|;
if|if
condition|(
name|ostate
operator|==
name|IEEE80211_S_RUN
condition|)
block|{
comment|/* Turn link LED off. */
name|urtwn_set_led
argument_list|(
name|sc
argument_list|,
name|URTWN_LED_LINK
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Set media status to 'No Link'. */
name|reg
operator|=
name|urtwn_read_4
argument_list|(
name|sc
argument_list|,
name|R92C_CR
argument_list|)
expr_stmt|;
name|reg
operator|=
name|RW
argument_list|(
name|reg
argument_list|,
name|R92C_CR_NETTYPE
argument_list|,
name|R92C_CR_NETTYPE_NOLINK
argument_list|)
expr_stmt|;
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_CR
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Stop Rx of data frames. */
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_RXFLTMAP2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Rest TSF. */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_DUAL_TSF_RST
argument_list|,
literal|0x03
argument_list|)
expr_stmt|;
comment|/* Disable TSF synchronization. */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_BCN_CTRL
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_BCN_CTRL
argument_list|)
operator||
name|R92C_BCN_CTRL_DIS_TSF_UDT0
argument_list|)
expr_stmt|;
comment|/* Reset EDCA parameters. */
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_EDCA_VO_PARAM
argument_list|,
literal|0x002f3217
argument_list|)
expr_stmt|;
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_EDCA_VI_PARAM
argument_list|,
literal|0x005e4317
argument_list|)
expr_stmt|;
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_EDCA_BE_PARAM
argument_list|,
literal|0x00105320
argument_list|)
expr_stmt|;
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_EDCA_BK_PARAM
argument_list|,
literal|0x0000a444
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|nstate
condition|)
block|{
case|case
name|IEEE80211_S_INIT
case|:
comment|/* Turn link LED off. */
name|urtwn_set_led
argument_list|(
name|sc
argument_list|,
name|URTWN_LED_LINK
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_S_SCAN
case|:
if|if
condition|(
name|ostate
operator|!=
name|IEEE80211_S_SCAN
condition|)
block|{
comment|/* Allow Rx from any BSSID. */
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_RCR
argument_list|,
name|urtwn_read_4
argument_list|(
name|sc
argument_list|,
name|R92C_RCR
argument_list|)
operator|&
operator|~
operator|(
name|R92C_RCR_CBSSID_DATA
operator||
name|R92C_RCR_CBSSID_BCN
operator|)
argument_list|)
expr_stmt|;
comment|/* Set gain for scanning. */
name|reg
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_AGCCORE1
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|reg
operator|=
name|RW
argument_list|(
name|reg
argument_list|,
name|R92C_OFDM0_AGCCORE1_GAIN
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_AGCCORE1
argument_list|(
literal|0
argument_list|)
argument_list|,
name|reg
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
operator|)
condition|)
block|{
name|reg
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_AGCCORE1
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|reg
operator|=
name|RW
argument_list|(
name|reg
argument_list|,
name|R92C_OFDM0_AGCCORE1_GAIN
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_AGCCORE1
argument_list|(
literal|1
argument_list|)
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Make link LED blink during scan. */
name|urtwn_set_led
argument_list|(
name|sc
argument_list|,
name|URTWN_LED_LINK
argument_list|,
operator|!
name|sc
operator|->
name|ledlink
argument_list|)
expr_stmt|;
comment|/* Pause AC Tx queues. */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_TXPAUSE
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_TXPAUSE
argument_list|)
operator||
literal|0x0f
argument_list|)
expr_stmt|;
name|urtwn_set_chan
argument_list|(
name|sc
argument_list|,
name|ic
operator|->
name|ic_curchan
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_S_AUTH
case|:
comment|/* Set initial gain under link. */
name|reg
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_AGCCORE1
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|reg
operator|=
name|RW
argument_list|(
name|reg
argument_list|,
name|R92C_OFDM0_AGCCORE1_GAIN
argument_list|,
literal|0x32
argument_list|)
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_AGCCORE1
argument_list|(
literal|0
argument_list|)
argument_list|,
name|reg
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
operator|)
condition|)
block|{
name|reg
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_AGCCORE1
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|reg
operator|=
name|RW
argument_list|(
name|reg
argument_list|,
name|R92C_OFDM0_AGCCORE1_GAIN
argument_list|,
literal|0x32
argument_list|)
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_AGCCORE1
argument_list|(
literal|1
argument_list|)
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
name|urtwn_set_chan
argument_list|(
name|sc
argument_list|,
name|ic
operator|->
name|ic_curchan
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_S_RUN
case|:
if|if
condition|(
name|vap
operator|->
name|iv_opmode
operator|==
name|IEEE80211_M_MONITOR
condition|)
block|{
comment|/* Enable Rx of data frames. */
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_RXFLTMAP2
argument_list|,
literal|0xffff
argument_list|)
expr_stmt|;
comment|/* Turn link LED on. */
name|urtwn_set_led
argument_list|(
name|sc
argument_list|,
name|URTWN_LED_LINK
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
block|}
name|ni
operator|=
name|ieee80211_ref_node
argument_list|(
name|vap
operator|->
name|iv_bss
argument_list|)
expr_stmt|;
comment|/* Set media status to 'Associated'. */
name|reg
operator|=
name|urtwn_read_4
argument_list|(
name|sc
argument_list|,
name|R92C_CR
argument_list|)
expr_stmt|;
name|reg
operator|=
name|RW
argument_list|(
name|reg
argument_list|,
name|R92C_CR_NETTYPE
argument_list|,
name|R92C_CR_NETTYPE_INFRA
argument_list|)
expr_stmt|;
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_CR
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Set BSSID. */
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_BSSID
operator|+
literal|0
argument_list|,
name|LE_READ_4
argument_list|(
operator|&
name|ni
operator|->
name|ni_bssid
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_BSSID
operator|+
literal|4
argument_list|,
name|LE_READ_2
argument_list|(
operator|&
name|ni
operator|->
name|ni_bssid
index|[
literal|4
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ic
operator|->
name|ic_curmode
operator|==
name|IEEE80211_MODE_11B
condition|)
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_INIRTS_RATE_SEL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
comment|/* 802.11b/g */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_INIRTS_RATE_SEL
argument_list|,
literal|3
argument_list|)
expr_stmt|;
comment|/* Enable Rx of data frames. */
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_RXFLTMAP2
argument_list|,
literal|0xffff
argument_list|)
expr_stmt|;
comment|/* Flush all AC queues. */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_TXPAUSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Set beacon interval. */
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_BCN_INTERVAL
argument_list|,
name|ni
operator|->
name|ni_intval
argument_list|)
expr_stmt|;
comment|/* Allow Rx from our BSSID only. */
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_RCR
argument_list|,
name|urtwn_read_4
argument_list|(
name|sc
argument_list|,
name|R92C_RCR
argument_list|)
operator||
name|R92C_RCR_CBSSID_DATA
operator||
name|R92C_RCR_CBSSID_BCN
argument_list|)
expr_stmt|;
comment|/* Enable TSF synchronization. */
name|urtwn_tsf_sync_enable
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_SIFS_CCK
operator|+
literal|1
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_SIFS_OFDM
operator|+
literal|1
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_SPEC_SIFS
operator|+
literal|1
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_MAC_SPEC_SIFS
operator|+
literal|1
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_R2T_SIFS
operator|+
literal|1
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_T2T_SIFS
operator|+
literal|1
argument_list|,
literal|10
argument_list|)
expr_stmt|;
comment|/* Intialize rate adaptation. */
if|if
condition|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
condition|)
name|ni
operator|->
name|ni_txrate
operator|=
name|ni
operator|->
name|ni_rates
operator|.
name|rs_rates
index|[
name|ni
operator|->
name|ni_rates
operator|.
name|rs_nrates
operator|-
literal|1
index|]
expr_stmt|;
else|else
name|urtwn_ra_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Turn link LED on. */
name|urtwn_set_led
argument_list|(
name|sc
argument_list|,
name|URTWN_LED_LINK
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|sc
operator|->
name|avg_pwdb
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* Reset average RSSI. */
comment|/* Reset temperature calibration state machine. */
name|sc
operator|->
name|thcal_state
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|thcal_lctemp
operator|=
literal|0
expr_stmt|;
name|ieee80211_free_node
argument_list|(
name|ni
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
name|URTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|IEEE80211_LOCK
argument_list|(
name|ic
argument_list|)
expr_stmt|;
return|return
operator|(
name|uvp
operator|->
name|newstate
argument_list|(
name|vap
argument_list|,
name|nstate
argument_list|,
name|arg
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_watchdog
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|urtwn_softc
modifier|*
name|sc
init|=
name|arg
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_txtimer
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|sc
operator|->
name|sc_txtimer
operator|==
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"device timeout\n"
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_oerrors
operator|++
expr_stmt|;
return|return;
block|}
name|callout_reset
argument_list|(
operator|&
name|sc
operator|->
name|sc_watchdog_ch
argument_list|,
name|hz
argument_list|,
name|urtwn_watchdog
argument_list|,
name|sc
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_update_avgrssi
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|int
name|rate
parameter_list|,
name|int8_t
name|rssi
parameter_list|)
block|{
name|int
name|pwdb
decl_stmt|;
comment|/* Convert antenna signal to percentage. */
if|if
condition|(
name|rssi
operator|<=
operator|-
literal|100
operator|||
name|rssi
operator|>=
literal|20
condition|)
name|pwdb
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|rssi
operator|>=
literal|0
condition|)
name|pwdb
operator|=
literal|100
expr_stmt|;
else|else
name|pwdb
operator|=
literal|100
operator|+
name|rssi
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
operator|)
condition|)
block|{
if|if
condition|(
name|rate
operator|<=
literal|3
condition|)
block|{
comment|/* CCK gain is smaller than OFDM/MCS gain. */
name|pwdb
operator|+=
literal|6
expr_stmt|;
if|if
condition|(
name|pwdb
operator|>
literal|100
condition|)
name|pwdb
operator|=
literal|100
expr_stmt|;
if|if
condition|(
name|pwdb
operator|<=
literal|14
condition|)
name|pwdb
operator|-=
literal|4
expr_stmt|;
elseif|else
if|if
condition|(
name|pwdb
operator|<=
literal|26
condition|)
name|pwdb
operator|-=
literal|8
expr_stmt|;
elseif|else
if|if
condition|(
name|pwdb
operator|<=
literal|34
condition|)
name|pwdb
operator|-=
literal|6
expr_stmt|;
elseif|else
if|if
condition|(
name|pwdb
operator|<=
literal|42
condition|)
name|pwdb
operator|-=
literal|2
expr_stmt|;
block|}
block|}
if|if
condition|(
name|sc
operator|->
name|avg_pwdb
operator|==
operator|-
literal|1
condition|)
comment|/* Init. */
name|sc
operator|->
name|avg_pwdb
operator|=
name|pwdb
expr_stmt|;
elseif|else
if|if
condition|(
name|sc
operator|->
name|avg_pwdb
operator|<
name|pwdb
condition|)
name|sc
operator|->
name|avg_pwdb
operator|=
operator|(
operator|(
name|sc
operator|->
name|avg_pwdb
operator|*
literal|19
operator|+
name|pwdb
operator|)
operator|/
literal|20
operator|)
operator|+
literal|1
expr_stmt|;
else|else
name|sc
operator|->
name|avg_pwdb
operator|=
operator|(
operator|(
name|sc
operator|->
name|avg_pwdb
operator|*
literal|19
operator|+
name|pwdb
operator|)
operator|/
literal|20
operator|)
expr_stmt|;
name|DPRINTFN
argument_list|(
literal|4
argument_list|,
literal|"PWDB=%d EMA=%d\n"
argument_list|,
name|pwdb
argument_list|,
name|sc
operator|->
name|avg_pwdb
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int8_t
name|urtwn_get_rssi
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|int
name|rate
parameter_list|,
name|void
modifier|*
name|physt
parameter_list|)
block|{
specifier|static
specifier|const
name|int8_t
name|cckoff
index|[]
init|=
block|{
literal|16
block|,
operator|-
literal|12
block|,
operator|-
literal|26
block|,
operator|-
literal|46
block|}
decl_stmt|;
name|struct
name|r92c_rx_phystat
modifier|*
name|phy
decl_stmt|;
name|struct
name|r92c_rx_cck
modifier|*
name|cck
decl_stmt|;
name|uint8_t
name|rpt
decl_stmt|;
name|int8_t
name|rssi
decl_stmt|;
if|if
condition|(
name|rate
operator|<=
literal|3
condition|)
block|{
name|cck
operator|=
operator|(
expr|struct
name|r92c_rx_cck
operator|*
operator|)
name|physt
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_flags
operator|&
name|URTWN_FLAG_CCK_HIPWR
condition|)
block|{
name|rpt
operator|=
operator|(
name|cck
operator|->
name|agc_rpt
operator|>>
literal|5
operator|)
operator|&
literal|0x3
expr_stmt|;
name|rssi
operator|=
operator|(
name|cck
operator|->
name|agc_rpt
operator|&
literal|0x1f
operator|)
operator|<<
literal|1
expr_stmt|;
block|}
else|else
block|{
name|rpt
operator|=
operator|(
name|cck
operator|->
name|agc_rpt
operator|>>
literal|6
operator|)
operator|&
literal|0x3
expr_stmt|;
name|rssi
operator|=
name|cck
operator|->
name|agc_rpt
operator|&
literal|0x3e
expr_stmt|;
block|}
name|rssi
operator|=
name|cckoff
index|[
name|rpt
index|]
operator|-
name|rssi
expr_stmt|;
block|}
else|else
block|{
comment|/* OFDM/HT. */
name|phy
operator|=
operator|(
expr|struct
name|r92c_rx_phystat
operator|*
operator|)
name|physt
expr_stmt|;
name|rssi
operator|=
operator|(
operator|(
name|le32toh
argument_list|(
name|phy
operator|->
name|phydw1
argument_list|)
operator|>>
literal|1
operator|)
operator|&
literal|0x7f
operator|)
operator|-
literal|110
expr_stmt|;
block|}
return|return
operator|(
name|rssi
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int8_t
name|urtwn_r88e_get_rssi
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|int
name|rate
parameter_list|,
name|void
modifier|*
name|physt
parameter_list|)
block|{
name|struct
name|r92c_rx_phystat
modifier|*
name|phy
decl_stmt|;
name|struct
name|r88e_rx_cck
modifier|*
name|cck
decl_stmt|;
name|uint8_t
name|cck_agc_rpt
decl_stmt|,
name|lna_idx
decl_stmt|,
name|vga_idx
decl_stmt|;
name|int8_t
name|rssi
decl_stmt|;
if|if
condition|(
name|rate
operator|<=
literal|3
condition|)
block|{
name|cck
operator|=
operator|(
expr|struct
name|r88e_rx_cck
operator|*
operator|)
name|physt
expr_stmt|;
name|cck_agc_rpt
operator|=
name|cck
operator|->
name|agc_rpt
expr_stmt|;
name|lna_idx
operator|=
operator|(
name|cck_agc_rpt
operator|&
literal|0xe0
operator|)
operator|>>
literal|5
expr_stmt|;
name|vga_idx
operator|=
name|cck_agc_rpt
operator|&
literal|0x1f
expr_stmt|;
switch|switch
condition|(
name|lna_idx
condition|)
block|{
case|case
literal|7
case|:
if|if
condition|(
name|vga_idx
operator|<=
literal|27
condition|)
name|rssi
operator|=
operator|-
literal|100
operator|+
literal|2
operator|*
operator|(
literal|27
operator|-
name|vga_idx
operator|)
expr_stmt|;
else|else
name|rssi
operator|=
operator|-
literal|100
expr_stmt|;
break|break;
case|case
literal|6
case|:
name|rssi
operator|=
operator|-
literal|48
operator|+
literal|2
operator|*
operator|(
literal|2
operator|-
name|vga_idx
operator|)
expr_stmt|;
break|break;
case|case
literal|5
case|:
name|rssi
operator|=
operator|-
literal|42
operator|+
literal|2
operator|*
operator|(
literal|7
operator|-
name|vga_idx
operator|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|rssi
operator|=
operator|-
literal|36
operator|+
literal|2
operator|*
operator|(
literal|7
operator|-
name|vga_idx
operator|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|rssi
operator|=
operator|-
literal|24
operator|+
literal|2
operator|*
operator|(
literal|7
operator|-
name|vga_idx
operator|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|rssi
operator|=
operator|-
literal|12
operator|+
literal|2
operator|*
operator|(
literal|5
operator|-
name|vga_idx
operator|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|rssi
operator|=
literal|8
operator|-
operator|(
literal|2
operator|*
name|vga_idx
operator|)
expr_stmt|;
break|break;
case|case
literal|0
case|:
name|rssi
operator|=
literal|14
operator|-
operator|(
literal|2
operator|*
name|vga_idx
operator|)
expr_stmt|;
break|break;
block|}
name|rssi
operator|+=
literal|6
expr_stmt|;
block|}
else|else
block|{
comment|/* OFDM/HT. */
name|phy
operator|=
operator|(
expr|struct
name|r92c_rx_phystat
operator|*
operator|)
name|physt
expr_stmt|;
name|rssi
operator|=
operator|(
operator|(
name|le32toh
argument_list|(
name|phy
operator|->
name|phydw1
argument_list|)
operator|>>
literal|1
operator|)
operator|&
literal|0x7f
operator|)
operator|-
literal|110
expr_stmt|;
block|}
return|return
operator|(
name|rssi
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|urtwn_tx_start
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|ieee80211_node
modifier|*
name|ni
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m0
parameter_list|,
name|struct
name|urtwn_data
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|struct
name|ieee80211_frame
modifier|*
name|wh
decl_stmt|;
name|struct
name|ieee80211_key
modifier|*
name|k
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|ifp
operator|->
name|if_l2com
decl_stmt|;
name|struct
name|ieee80211vap
modifier|*
name|vap
init|=
name|ni
operator|->
name|ni_vap
decl_stmt|;
name|struct
name|usb_xfer
modifier|*
name|xfer
decl_stmt|;
name|struct
name|r92c_tx_desc
modifier|*
name|txd
decl_stmt|;
name|uint8_t
name|raid
decl_stmt|,
name|type
decl_stmt|;
name|uint16_t
name|sum
decl_stmt|;
name|int
name|i
decl_stmt|,
name|hasqos
decl_stmt|,
name|xferlen
decl_stmt|;
name|struct
name|usb_xfer
modifier|*
name|urtwn_pipes
index|[
literal|4
index|]
init|=
block|{
name|sc
operator|->
name|sc_xfer
index|[
name|URTWN_BULK_TX_BE
index|]
block|,
name|sc
operator|->
name|sc_xfer
index|[
name|URTWN_BULK_TX_BK
index|]
block|,
name|sc
operator|->
name|sc_xfer
index|[
name|URTWN_BULK_TX_VI
index|]
block|,
name|sc
operator|->
name|sc_xfer
index|[
name|URTWN_BULK_TX_VO
index|]
block|}
decl_stmt|;
name|URTWN_ASSERT_LOCKED
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* 	 * Software crypto. 	 */
name|wh
operator|=
name|mtod
argument_list|(
name|m0
argument_list|,
expr|struct
name|ieee80211_frame
operator|*
argument_list|)
expr_stmt|;
name|type
operator|=
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator|&
name|IEEE80211_FC0_TYPE_MASK
expr_stmt|;
if|if
condition|(
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator|&
name|IEEE80211_FC1_PROTECTED
condition|)
block|{
name|k
operator|=
name|ieee80211_crypto_encap
argument_list|(
name|ni
argument_list|,
name|m0
argument_list|)
expr_stmt|;
if|if
condition|(
name|k
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"ieee80211_crypto_encap returns NULL.\n"
argument_list|)
expr_stmt|;
comment|/* XXX we don't expect the fragmented frames */
name|m_freem
argument_list|(
name|m0
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOBUFS
operator|)
return|;
block|}
comment|/* in case packet header moved, reset pointer */
name|wh
operator|=
name|mtod
argument_list|(
name|m0
argument_list|,
expr|struct
name|ieee80211_frame
operator|*
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|IEEE80211_FC0_TYPE_CTL
case|:
case|case
name|IEEE80211_FC0_TYPE_MGT
case|:
name|xfer
operator|=
name|sc
operator|->
name|sc_xfer
index|[
name|URTWN_BULK_TX_VO
index|]
expr_stmt|;
break|break;
default|default:
name|KASSERT
argument_list|(
name|M_WME_GETAC
argument_list|(
name|m0
argument_list|)
operator|<
literal|4
argument_list|,
operator|(
literal|"unsupported WME pipe %d"
operator|,
name|M_WME_GETAC
argument_list|(
name|m0
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|xfer
operator|=
name|urtwn_pipes
index|[
name|M_WME_GETAC
argument_list|(
name|m0
argument_list|)
index|]
expr_stmt|;
break|break;
block|}
name|hasqos
operator|=
literal|0
expr_stmt|;
comment|/* Fill Tx descriptor. */
name|txd
operator|=
operator|(
expr|struct
name|r92c_tx_desc
operator|*
operator|)
name|data
operator|->
name|buf
expr_stmt|;
name|memset
argument_list|(
name|txd
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|txd
argument_list|)
argument_list|)
expr_stmt|;
name|txd
operator|->
name|txdw0
operator||=
name|htole32
argument_list|(
name|SM
argument_list|(
name|R92C_TXDW0_PKTLEN
argument_list|,
name|m0
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXDW0_OFFSET
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|txd
argument_list|)
argument_list|)
operator||
name|R92C_TXDW0_OWN
operator||
name|R92C_TXDW0_FSG
operator||
name|R92C_TXDW0_LSG
argument_list|)
expr_stmt|;
if|if
condition|(
name|IEEE80211_IS_MULTICAST
argument_list|(
name|wh
operator|->
name|i_addr1
argument_list|)
condition|)
name|txd
operator|->
name|txdw0
operator||=
name|htole32
argument_list|(
name|R92C_TXDW0_BMCAST
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|IEEE80211_IS_MULTICAST
argument_list|(
name|wh
operator|->
name|i_addr1
argument_list|)
operator|&&
name|type
operator|==
name|IEEE80211_FC0_TYPE_DATA
condition|)
block|{
if|if
condition|(
name|ic
operator|->
name|ic_curmode
operator|==
name|IEEE80211_MODE_11B
condition|)
name|raid
operator|=
name|R92C_RAID_11B
expr_stmt|;
else|else
name|raid
operator|=
name|R92C_RAID_11BG
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
condition|)
block|{
name|txd
operator|->
name|txdw1
operator||=
name|htole32
argument_list|(
name|SM
argument_list|(
name|R88E_TXDW1_MACID
argument_list|,
name|URTWN_MACID_BSS
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXDW1_QSEL
argument_list|,
name|R92C_TXDW1_QSEL_BE
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXDW1_RAID
argument_list|,
name|raid
argument_list|)
argument_list|)
expr_stmt|;
name|txd
operator|->
name|txdw2
operator||=
name|htole32
argument_list|(
name|R88E_TXDW2_AGGBK
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|txd
operator|->
name|txdw1
operator||=
name|htole32
argument_list|(
name|SM
argument_list|(
name|R92C_TXDW1_MACID
argument_list|,
name|URTWN_MACID_BSS
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXDW1_QSEL
argument_list|,
name|R92C_TXDW1_QSEL_BE
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXDW1_RAID
argument_list|,
name|raid
argument_list|)
operator||
name|R92C_TXDW1_AGGBK
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ic
operator|->
name|ic_flags
operator|&
name|IEEE80211_F_USEPROT
condition|)
block|{
if|if
condition|(
name|ic
operator|->
name|ic_protmode
operator|==
name|IEEE80211_PROT_CTSONLY
condition|)
block|{
name|txd
operator|->
name|txdw4
operator||=
name|htole32
argument_list|(
name|R92C_TXDW4_CTS2SELF
operator||
name|R92C_TXDW4_HWRTSEN
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ic
operator|->
name|ic_protmode
operator|==
name|IEEE80211_PROT_RTSCTS
condition|)
block|{
name|txd
operator|->
name|txdw4
operator||=
name|htole32
argument_list|(
name|R92C_TXDW4_RTSEN
operator||
name|R92C_TXDW4_HWRTSEN
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Send RTS at OFDM24. */
name|txd
operator|->
name|txdw4
operator||=
name|htole32
argument_list|(
name|SM
argument_list|(
name|R92C_TXDW4_RTSRATE
argument_list|,
literal|8
argument_list|)
argument_list|)
expr_stmt|;
name|txd
operator|->
name|txdw5
operator||=
name|htole32
argument_list|(
literal|0x0001ff00
argument_list|)
expr_stmt|;
comment|/* Send data at OFDM54. */
if|if
condition|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
condition|)
name|txd
operator|->
name|txdw5
operator||=
name|htole32
argument_list|(
literal|0x13
operator|&
literal|0x3f
argument_list|)
expr_stmt|;
else|else
name|txd
operator|->
name|txdw5
operator||=
name|htole32
argument_list|(
name|SM
argument_list|(
name|R92C_TXDW5_DATARATE
argument_list|,
literal|11
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|txd
operator|->
name|txdw1
operator||=
name|htole32
argument_list|(
name|SM
argument_list|(
name|R92C_TXDW1_MACID
argument_list|,
literal|0
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXDW1_QSEL
argument_list|,
name|R92C_TXDW1_QSEL_MGNT
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXDW1_RAID
argument_list|,
name|R92C_RAID_11B
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Force CCK1. */
name|txd
operator|->
name|txdw4
operator||=
name|htole32
argument_list|(
name|R92C_TXDW4_DRVRATE
argument_list|)
expr_stmt|;
name|txd
operator|->
name|txdw5
operator||=
name|htole32
argument_list|(
name|SM
argument_list|(
name|R92C_TXDW5_DATARATE
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* Set sequence number (already little endian). */
name|txd
operator|->
name|txdseq
operator||=
operator|*
operator|(
name|uint16_t
operator|*
operator|)
name|wh
operator|->
name|i_seq
expr_stmt|;
if|if
condition|(
operator|!
name|hasqos
condition|)
block|{
comment|/* Use HW sequence numbering for non-QoS frames. */
name|txd
operator|->
name|txdw4
operator||=
name|htole32
argument_list|(
name|R92C_TXDW4_HWSEQ
argument_list|)
expr_stmt|;
name|txd
operator|->
name|txdseq
operator||=
name|htole16
argument_list|(
literal|0x8000
argument_list|)
expr_stmt|;
block|}
else|else
name|txd
operator|->
name|txdw4
operator||=
name|htole32
argument_list|(
name|R92C_TXDW4_QOS
argument_list|)
expr_stmt|;
comment|/* Compute Tx descriptor checksum. */
name|sum
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|txd
argument_list|)
operator|/
literal|2
condition|;
name|i
operator|++
control|)
name|sum
operator|^=
operator|(
operator|(
name|uint16_t
operator|*
operator|)
name|txd
operator|)
index|[
name|i
index|]
expr_stmt|;
name|txd
operator|->
name|txdsum
operator|=
name|sum
expr_stmt|;
comment|/* NB: already little endian. */
if|if
condition|(
name|ieee80211_radiotap_active_vap
argument_list|(
name|vap
argument_list|)
condition|)
block|{
name|struct
name|urtwn_tx_radiotap_header
modifier|*
name|tap
init|=
operator|&
name|sc
operator|->
name|sc_txtap
decl_stmt|;
name|tap
operator|->
name|wt_flags
operator|=
literal|0
expr_stmt|;
name|tap
operator|->
name|wt_chan_freq
operator|=
name|htole16
argument_list|(
name|ic
operator|->
name|ic_curchan
operator|->
name|ic_freq
argument_list|)
expr_stmt|;
name|tap
operator|->
name|wt_chan_flags
operator|=
name|htole16
argument_list|(
name|ic
operator|->
name|ic_curchan
operator|->
name|ic_flags
argument_list|)
expr_stmt|;
name|ieee80211_radiotap_tx
argument_list|(
name|vap
argument_list|,
name|m0
argument_list|)
expr_stmt|;
block|}
name|xferlen
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|txd
argument_list|)
operator|+
name|m0
operator|->
name|m_pkthdr
operator|.
name|len
expr_stmt|;
name|m_copydata
argument_list|(
name|m0
argument_list|,
literal|0
argument_list|,
name|m0
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|txd
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|data
operator|->
name|buflen
operator|=
name|xferlen
expr_stmt|;
name|data
operator|->
name|ni
operator|=
name|ni
expr_stmt|;
name|data
operator|->
name|m
operator|=
name|m0
expr_stmt|;
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|sc
operator|->
name|sc_tx_pending
argument_list|,
name|data
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|usbd_transfer_start
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_start
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|struct
name|urtwn_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
operator|==
literal|0
condition|)
return|return;
name|URTWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|urtwn_start_locked
argument_list|(
name|ifp
argument_list|,
name|sc
argument_list|)
expr_stmt|;
name|URTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_start_locked
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ieee80211_node
modifier|*
name|ni
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|struct
name|urtwn_data
modifier|*
name|bf
decl_stmt|;
name|URTWN_ASSERT_LOCKED
argument_list|(
name|sc
argument_list|)
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|IFQ_DRV_DEQUEUE
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
break|break;
name|bf
operator|=
name|urtwn_getbuf
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|bf
operator|==
name|NULL
condition|)
block|{
name|IFQ_DRV_PREPEND
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|,
name|m
argument_list|)
expr_stmt|;
break|break;
block|}
name|ni
operator|=
operator|(
expr|struct
name|ieee80211_node
operator|*
operator|)
name|m
operator|->
name|m_pkthdr
operator|.
name|rcvif
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|rcvif
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|urtwn_tx_start
argument_list|(
name|sc
argument_list|,
name|ni
argument_list|,
name|m
argument_list|,
name|bf
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|ifp
operator|->
name|if_oerrors
operator|++
expr_stmt|;
name|STAILQ_INSERT_HEAD
argument_list|(
operator|&
name|sc
operator|->
name|sc_tx_inactive
argument_list|,
name|bf
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|ieee80211_free_node
argument_list|(
name|ni
argument_list|)
expr_stmt|;
break|break;
block|}
name|sc
operator|->
name|sc_txtimer
operator|=
literal|5
expr_stmt|;
name|callout_reset
argument_list|(
operator|&
name|sc
operator|->
name|sc_watchdog_ch
argument_list|,
name|hz
argument_list|,
name|urtwn_watchdog
argument_list|,
name|sc
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|urtwn_ioctl
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|u_long
name|cmd
parameter_list|,
name|caddr_t
name|data
parameter_list|)
block|{
name|struct
name|urtwn_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|ifp
operator|->
name|if_l2com
decl_stmt|;
name|struct
name|ifreq
modifier|*
name|ifr
init|=
operator|(
expr|struct
name|ifreq
operator|*
operator|)
name|data
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|,
name|startall
init|=
literal|0
decl_stmt|;
name|URTWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|error
operator|=
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|URTWN_DETACHED
operator|)
condition|?
name|ENXIO
else|:
literal|0
expr_stmt|;
name|URTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|SIOCSIFFLAGS
case|:
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_UP
condition|)
block|{
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
operator|==
literal|0
condition|)
block|{
name|urtwn_init
argument_list|(
name|ifp
operator|->
name|if_softc
argument_list|)
expr_stmt|;
name|startall
operator|=
literal|1
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
name|urtwn_stop
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|startall
condition|)
name|ieee80211_start_all
argument_list|(
name|ic
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCGIFMEDIA
case|:
name|error
operator|=
name|ifmedia_ioctl
argument_list|(
name|ifp
argument_list|,
name|ifr
argument_list|,
operator|&
name|ic
operator|->
name|ic_media
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCGIFADDR
case|:
name|error
operator|=
name|ether_ioctl
argument_list|(
name|ifp
argument_list|,
name|cmd
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
default|default:
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|urtwn_alloc_list
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|urtwn_data
name|data
index|[]
parameter_list|,
name|int
name|ndata
parameter_list|,
name|int
name|maxsz
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|error
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ndata
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|urtwn_data
modifier|*
name|dp
init|=
operator|&
name|data
index|[
name|i
index|]
decl_stmt|;
name|dp
operator|->
name|sc
operator|=
name|sc
expr_stmt|;
name|dp
operator|->
name|m
operator|=
name|NULL
expr_stmt|;
name|dp
operator|->
name|buf
operator|=
name|malloc
argument_list|(
name|maxsz
argument_list|,
name|M_USBDEV
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|dp
operator|->
name|buf
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not allocate buffer\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|dp
operator|->
name|ni
operator|=
name|NULL
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|fail
label|:
name|urtwn_free_list
argument_list|(
name|sc
argument_list|,
name|data
argument_list|,
name|ndata
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|urtwn_alloc_rx_list
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|error
decl_stmt|,
name|i
decl_stmt|;
name|error
operator|=
name|urtwn_alloc_list
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|sc_rx
argument_list|,
name|URTWN_RX_LIST_COUNT
argument_list|,
name|URTWN_RXBUFSZ
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|STAILQ_INIT
argument_list|(
operator|&
name|sc
operator|->
name|sc_rx_active
argument_list|)
expr_stmt|;
name|STAILQ_INIT
argument_list|(
operator|&
name|sc
operator|->
name|sc_rx_inactive
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|URTWN_RX_LIST_COUNT
condition|;
name|i
operator|++
control|)
name|STAILQ_INSERT_HEAD
argument_list|(
operator|&
name|sc
operator|->
name|sc_rx_inactive
argument_list|,
operator|&
name|sc
operator|->
name|sc_rx
index|[
name|i
index|]
argument_list|,
name|next
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|urtwn_alloc_tx_list
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|error
decl_stmt|,
name|i
decl_stmt|;
name|error
operator|=
name|urtwn_alloc_list
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|sc_tx
argument_list|,
name|URTWN_TX_LIST_COUNT
argument_list|,
name|URTWN_TXBUFSZ
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|STAILQ_INIT
argument_list|(
operator|&
name|sc
operator|->
name|sc_tx_active
argument_list|)
expr_stmt|;
name|STAILQ_INIT
argument_list|(
operator|&
name|sc
operator|->
name|sc_tx_inactive
argument_list|)
expr_stmt|;
name|STAILQ_INIT
argument_list|(
operator|&
name|sc
operator|->
name|sc_tx_pending
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|URTWN_TX_LIST_COUNT
condition|;
name|i
operator|++
control|)
name|STAILQ_INSERT_HEAD
argument_list|(
operator|&
name|sc
operator|->
name|sc_tx_inactive
argument_list|,
operator|&
name|sc
operator|->
name|sc_tx
index|[
name|i
index|]
argument_list|,
name|next
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|__inline
name|int
name|urtwn_power_on
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
return|return
name|sc
operator|->
name|sc_power_on
argument_list|(
name|sc
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|urtwn_r92c_power_on
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
name|int
name|ntries
decl_stmt|;
comment|/* Wait for autoload done bit. */
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|1000
condition|;
name|ntries
operator|++
control|)
block|{
if|if
condition|(
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_APS_FSMCO
argument_list|)
operator|&
name|R92C_APS_FSMCO_PFM_ALDN
condition|)
break|break;
name|DELAY
argument_list|(
literal|5
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ntries
operator|==
literal|1000
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"timeout waiting for chip autoload\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ETIMEDOUT
operator|)
return|;
block|}
comment|/* Unlock ISO/CLK/Power control register. */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_RSV_CTRL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Move SPS into PWM mode. */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_SPS0_CTRL
argument_list|,
literal|0x2b
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
name|reg
operator|=
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_LDOV12D_CTRL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|reg
operator|&
name|R92C_LDOV12D_CTRL_LDV12_EN
operator|)
condition|)
block|{
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_LDOV12D_CTRL
argument_list|,
name|reg
operator||
name|R92C_LDOV12D_CTRL_LDV12_EN
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_ISO_CTRL
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_ISO_CTRL
argument_list|)
operator|&
operator|~
name|R92C_SYS_ISO_CTRL_MD2PP
argument_list|)
expr_stmt|;
block|}
comment|/* Auto enable WLAN. */
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_APS_FSMCO
argument_list|,
name|urtwn_read_2
argument_list|(
name|sc
argument_list|,
name|R92C_APS_FSMCO
argument_list|)
operator||
name|R92C_APS_FSMCO_APFM_ONMAC
argument_list|)
expr_stmt|;
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|1000
condition|;
name|ntries
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|urtwn_read_2
argument_list|(
name|sc
argument_list|,
name|R92C_APS_FSMCO
argument_list|)
operator|&
name|R92C_APS_FSMCO_APFM_ONMAC
operator|)
condition|)
break|break;
name|DELAY
argument_list|(
literal|5
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ntries
operator|==
literal|1000
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"timeout waiting for MAC auto ON\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ETIMEDOUT
operator|)
return|;
block|}
comment|/* Enable radio, GPIO and LED functions. */
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_APS_FSMCO
argument_list|,
name|R92C_APS_FSMCO_AFSM_HSUS
operator||
name|R92C_APS_FSMCO_PDN_EN
operator||
name|R92C_APS_FSMCO_PFM_ALDN
argument_list|)
expr_stmt|;
comment|/* Release RF digital isolation. */
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_ISO_CTRL
argument_list|,
name|urtwn_read_2
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_ISO_CTRL
argument_list|)
operator|&
operator|~
name|R92C_SYS_ISO_CTRL_DIOR
argument_list|)
expr_stmt|;
comment|/* Initialize MAC. */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_APSD_CTRL
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_APSD_CTRL
argument_list|)
operator|&
operator|~
name|R92C_APSD_CTRL_OFF
argument_list|)
expr_stmt|;
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|200
condition|;
name|ntries
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_APSD_CTRL
argument_list|)
operator|&
name|R92C_APSD_CTRL_OFF_STATUS
operator|)
condition|)
break|break;
name|DELAY
argument_list|(
literal|5
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ntries
operator|==
literal|200
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"timeout waiting for MAC initialization\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ETIMEDOUT
operator|)
return|;
block|}
comment|/* Enable MAC DMA/WMAC/SCHEDULE/SEC blocks. */
name|reg
operator|=
name|urtwn_read_2
argument_list|(
name|sc
argument_list|,
name|R92C_CR
argument_list|)
expr_stmt|;
name|reg
operator||=
name|R92C_CR_HCI_TXDMA_EN
operator||
name|R92C_CR_HCI_RXDMA_EN
operator||
name|R92C_CR_TXDMA_EN
operator||
name|R92C_CR_RXDMA_EN
operator||
name|R92C_CR_PROTOCOL_EN
operator||
name|R92C_CR_SCHEDULE_EN
operator||
name|R92C_CR_MACTXEN
operator||
name|R92C_CR_MACRXEN
operator||
name|R92C_CR_ENSEC
expr_stmt|;
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_CR
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
literal|0xfe10
argument_list|,
literal|0x19
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|urtwn_r88e_power_on
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint8_t
name|val
decl_stmt|;
name|uint32_t
name|reg
decl_stmt|;
name|int
name|ntries
decl_stmt|;
comment|/* Wait for power ready bit. */
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|5000
condition|;
name|ntries
operator|++
control|)
block|{
name|val
operator|=
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
literal|0x6
argument_list|)
operator|&
literal|0x2
expr_stmt|;
if|if
condition|(
name|val
operator|==
literal|0x2
condition|)
break|break;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ntries
operator|==
literal|5000
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"timeout waiting for chip power up\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ETIMEDOUT
operator|)
return|;
block|}
comment|/* Reset BB. */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_FUNC_EN
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_FUNC_EN
argument_list|)
operator|&
operator|~
operator|(
name|R92C_SYS_FUNC_EN_BBRSTB
operator||
name|R92C_SYS_FUNC_EN_BB_GLB_RST
operator|)
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
literal|0x26
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
literal|0x26
argument_list|)
operator||
literal|0x80
argument_list|)
expr_stmt|;
comment|/* Disable HWPDN. */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
literal|0x5
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
literal|0x5
argument_list|)
operator|&
operator|~
literal|0x80
argument_list|)
expr_stmt|;
comment|/* Disable WL suspend. */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
literal|0x5
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
literal|0x5
argument_list|)
operator|&
operator|~
literal|0x18
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
literal|0x5
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
literal|0x5
argument_list|)
operator||
literal|0x1
argument_list|)
expr_stmt|;
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|5000
condition|;
name|ntries
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
literal|0x5
argument_list|)
operator|&
literal|0x1
operator|)
condition|)
break|break;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ntries
operator|==
literal|5000
condition|)
return|return
operator|(
name|ETIMEDOUT
operator|)
return|;
comment|/* Enable LDO normal mode. */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
literal|0x23
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
literal|0x23
argument_list|)
operator|&
operator|~
literal|0x10
argument_list|)
expr_stmt|;
comment|/* Enable MAC DMA/WMAC/SCHEDULE/SEC blocks. */
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_CR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|reg
operator|=
name|urtwn_read_2
argument_list|(
name|sc
argument_list|,
name|R92C_CR
argument_list|)
expr_stmt|;
name|reg
operator||=
name|R92C_CR_HCI_TXDMA_EN
operator||
name|R92C_CR_HCI_RXDMA_EN
operator||
name|R92C_CR_TXDMA_EN
operator||
name|R92C_CR_RXDMA_EN
operator||
name|R92C_CR_PROTOCOL_EN
operator||
name|R92C_CR_SCHEDULE_EN
operator||
name|R92C_CR_ENSEC
operator||
name|R92C_CR_CALTMR_EN
expr_stmt|;
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_CR
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|urtwn_llt_init
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|error
decl_stmt|,
name|page_count
decl_stmt|,
name|pktbuf_count
decl_stmt|;
name|page_count
operator|=
operator|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
operator|)
condition|?
name|R88E_TX_PAGE_COUNT
else|:
name|R92C_TX_PAGE_COUNT
expr_stmt|;
name|pktbuf_count
operator|=
operator|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
operator|)
condition|?
name|R88E_TXPKTBUF_COUNT
else|:
name|R92C_TXPKTBUF_COUNT
expr_stmt|;
comment|/* Reserve pages [0; page_count]. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|page_count
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|urtwn_llt_write
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|i
operator|+
literal|1
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
block|}
comment|/* NB: 0xff indicates end-of-list. */
if|if
condition|(
operator|(
name|error
operator|=
name|urtwn_llt_write
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
literal|0xff
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
comment|/* 	 * Use pages [page_count + 1; pktbuf_count - 1] 	 * as ring buffer. 	 */
for|for
control|(
operator|++
name|i
init|;
name|i
operator|<
name|pktbuf_count
operator|-
literal|1
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|urtwn_llt_write
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|i
operator|+
literal|1
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
block|}
comment|/* Make the last page point to the beginning of the ring buffer. */
name|error
operator|=
name|urtwn_llt_write
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|page_count
operator|+
literal|1
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_fw_reset
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint16_t
name|reg
decl_stmt|;
name|int
name|ntries
decl_stmt|;
comment|/* Tell 8051 to reset itself. */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_HMETFR
operator|+
literal|3
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
comment|/* Wait until 8051 resets by itself. */
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|100
condition|;
name|ntries
operator|++
control|)
block|{
name|reg
operator|=
name|urtwn_read_2
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_FUNC_EN
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|reg
operator|&
name|R92C_SYS_FUNC_EN_CPUEN
operator|)
condition|)
return|return;
name|DELAY
argument_list|(
literal|50
argument_list|)
expr_stmt|;
block|}
comment|/* Force 8051 reset. */
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_FUNC_EN
argument_list|,
name|reg
operator|&
operator|~
name|R92C_SYS_FUNC_EN_CPUEN
argument_list|)
expr_stmt|;
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_FUNC_EN
argument_list|,
name|urtwn_read_2
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_FUNC_EN
argument_list|)
operator||
name|R92C_SYS_FUNC_EN_CPUEN
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_r88e_fw_reset
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint16_t
name|reg
decl_stmt|;
name|reg
operator|=
name|urtwn_read_2
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_FUNC_EN
argument_list|)
expr_stmt|;
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_FUNC_EN
argument_list|,
name|reg
operator|&
operator|~
name|R92C_SYS_FUNC_EN_CPUEN
argument_list|)
expr_stmt|;
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_FUNC_EN
argument_list|,
name|reg
operator||
name|R92C_SYS_FUNC_EN_CPUEN
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|urtwn_fw_loadpage
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|int
name|page
parameter_list|,
specifier|const
name|uint8_t
modifier|*
name|buf
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
name|int
name|off
decl_stmt|,
name|mlen
decl_stmt|,
name|error
init|=
literal|0
decl_stmt|;
name|reg
operator|=
name|urtwn_read_4
argument_list|(
name|sc
argument_list|,
name|R92C_MCUFWDL
argument_list|)
expr_stmt|;
name|reg
operator|=
name|RW
argument_list|(
name|reg
argument_list|,
name|R92C_MCUFWDL_PAGE
argument_list|,
name|page
argument_list|)
expr_stmt|;
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_MCUFWDL
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|off
operator|=
name|R92C_FW_START_ADDR
expr_stmt|;
while|while
condition|(
name|len
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|len
operator|>
literal|196
condition|)
name|mlen
operator|=
literal|196
expr_stmt|;
elseif|else
if|if
condition|(
name|len
operator|>
literal|4
condition|)
name|mlen
operator|=
literal|4
expr_stmt|;
else|else
name|mlen
operator|=
literal|1
expr_stmt|;
comment|/* XXX fix this deconst */
name|error
operator|=
name|urtwn_write_region_1
argument_list|(
name|sc
argument_list|,
name|off
argument_list|,
name|__DECONST
argument_list|(
name|uint8_t
operator|*
argument_list|,
name|buf
argument_list|)
argument_list|,
name|mlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
break|break;
name|off
operator|+=
name|mlen
expr_stmt|;
name|buf
operator|+=
name|mlen
expr_stmt|;
name|len
operator|-=
name|mlen
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|urtwn_load_firmware
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
specifier|const
name|struct
name|firmware
modifier|*
name|fw
decl_stmt|;
specifier|const
name|struct
name|r92c_fw_hdr
modifier|*
name|hdr
decl_stmt|;
specifier|const
name|char
modifier|*
name|imagename
decl_stmt|;
specifier|const
name|u_char
modifier|*
name|ptr
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|uint32_t
name|reg
decl_stmt|;
name|int
name|mlen
decl_stmt|,
name|ntries
decl_stmt|,
name|page
decl_stmt|,
name|error
decl_stmt|;
name|URTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Read firmware image from the filesystem. */
if|if
condition|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
condition|)
name|imagename
operator|=
literal|"urtwn-rtl8188eufw"
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|sc
operator|->
name|chip
operator|&
operator|(
name|URTWN_CHIP_UMC_A_CUT
operator||
name|URTWN_CHIP_92C
operator|)
operator|)
operator|==
name|URTWN_CHIP_UMC_A_CUT
condition|)
name|imagename
operator|=
literal|"urtwn-rtl8192cfwU"
expr_stmt|;
else|else
name|imagename
operator|=
literal|"urtwn-rtl8192cfwT"
expr_stmt|;
name|fw
operator|=
name|firmware_get
argument_list|(
name|imagename
argument_list|)
expr_stmt|;
name|URTWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|fw
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"failed loadfirmware of file %s\n"
argument_list|,
name|imagename
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOENT
operator|)
return|;
block|}
name|len
operator|=
name|fw
operator|->
name|datasize
expr_stmt|;
if|if
condition|(
name|len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"firmware too short\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|ptr
operator|=
name|fw
operator|->
name|data
expr_stmt|;
name|hdr
operator|=
operator|(
specifier|const
expr|struct
name|r92c_fw_hdr
operator|*
operator|)
name|ptr
expr_stmt|;
comment|/* Check if there is a valid FW header and skip it. */
if|if
condition|(
operator|(
name|le16toh
argument_list|(
name|hdr
operator|->
name|signature
argument_list|)
operator|>>
literal|4
operator|)
operator|==
literal|0x88c
operator|||
operator|(
name|le16toh
argument_list|(
name|hdr
operator|->
name|signature
argument_list|)
operator|>>
literal|4
operator|)
operator|==
literal|0x88e
operator|||
operator|(
name|le16toh
argument_list|(
name|hdr
operator|->
name|signature
argument_list|)
operator|>>
literal|4
operator|)
operator|==
literal|0x92c
condition|)
block|{
name|DPRINTF
argument_list|(
literal|"FW V%d.%d %02d-%02d %02d:%02d\n"
argument_list|,
name|le16toh
argument_list|(
name|hdr
operator|->
name|version
argument_list|)
argument_list|,
name|le16toh
argument_list|(
name|hdr
operator|->
name|subversion
argument_list|)
argument_list|,
name|hdr
operator|->
name|month
argument_list|,
name|hdr
operator|->
name|date
argument_list|,
name|hdr
operator|->
name|hour
argument_list|,
name|hdr
operator|->
name|minute
argument_list|)
expr_stmt|;
name|ptr
operator|+=
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
expr_stmt|;
name|len
operator|-=
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_MCUFWDL
argument_list|)
operator|&
name|R92C_MCUFWDL_RAM_DL_SEL
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
condition|)
name|urtwn_r88e_fw_reset
argument_list|(
name|sc
argument_list|)
expr_stmt|;
else|else
name|urtwn_fw_reset
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_MCUFWDL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_MCUFWDL
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_MCUFWDL
argument_list|)
operator||
name|R92C_MCUFWDL_EN
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_MCUFWDL
operator|+
literal|2
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_MCUFWDL
operator|+
literal|2
argument_list|)
operator|&
operator|~
literal|0x08
argument_list|)
expr_stmt|;
comment|/* Reset the FWDL checksum. */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_MCUFWDL
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_MCUFWDL
argument_list|)
operator||
name|R92C_MCUFWDL_CHKSUM_RPT
argument_list|)
expr_stmt|;
for|for
control|(
name|page
operator|=
literal|0
init|;
name|len
operator|>
literal|0
condition|;
name|page
operator|++
control|)
block|{
name|mlen
operator|=
name|min
argument_list|(
name|len
argument_list|,
name|R92C_FW_PAGE_SIZE
argument_list|)
expr_stmt|;
name|error
operator|=
name|urtwn_fw_loadpage
argument_list|(
name|sc
argument_list|,
name|page
argument_list|,
name|ptr
argument_list|,
name|mlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not load firmware page\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|ptr
operator|+=
name|mlen
expr_stmt|;
name|len
operator|-=
name|mlen
expr_stmt|;
block|}
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_MCUFWDL
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_MCUFWDL
argument_list|)
operator|&
operator|~
name|R92C_MCUFWDL_EN
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_MCUFWDL
operator|+
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Wait for checksum report. */
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|1000
condition|;
name|ntries
operator|++
control|)
block|{
if|if
condition|(
name|urtwn_read_4
argument_list|(
name|sc
argument_list|,
name|R92C_MCUFWDL
argument_list|)
operator|&
name|R92C_MCUFWDL_CHKSUM_RPT
condition|)
break|break;
name|DELAY
argument_list|(
literal|5
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ntries
operator|==
literal|1000
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"timeout waiting for checksum report\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|ETIMEDOUT
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|reg
operator|=
name|urtwn_read_4
argument_list|(
name|sc
argument_list|,
name|R92C_MCUFWDL
argument_list|)
expr_stmt|;
name|reg
operator|=
operator|(
name|reg
operator|&
operator|~
name|R92C_MCUFWDL_WINTINI_RDY
operator|)
operator||
name|R92C_MCUFWDL_RDY
expr_stmt|;
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_MCUFWDL
argument_list|,
name|reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
condition|)
name|urtwn_r88e_fw_reset
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Wait for firmware readiness. */
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|1000
condition|;
name|ntries
operator|++
control|)
block|{
if|if
condition|(
name|urtwn_read_4
argument_list|(
name|sc
argument_list|,
name|R92C_MCUFWDL
argument_list|)
operator|&
name|R92C_MCUFWDL_WINTINI_RDY
condition|)
break|break;
name|DELAY
argument_list|(
literal|5
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ntries
operator|==
literal|1000
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"timeout waiting for firmware readiness\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|ETIMEDOUT
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|fail
label|:
name|firmware_put
argument_list|(
name|fw
argument_list|,
name|FIRMWARE_UNLOAD
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|__inline
name|int
name|urtwn_dma_init
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
return|return
name|sc
operator|->
name|sc_dma_init
argument_list|(
name|sc
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|urtwn_r92c_dma_init
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|hashq
decl_stmt|,
name|hasnq
decl_stmt|,
name|haslq
decl_stmt|,
name|nqueues
decl_stmt|,
name|nqpages
decl_stmt|,
name|nrempages
decl_stmt|;
name|uint32_t
name|reg
decl_stmt|;
name|int
name|error
decl_stmt|;
comment|/* Initialize LLT table. */
name|error
operator|=
name|urtwn_llt_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
comment|/* Get Tx queues to USB endpoints mapping. */
name|hashq
operator|=
name|hasnq
operator|=
name|haslq
operator|=
literal|0
expr_stmt|;
name|reg
operator|=
name|urtwn_read_2
argument_list|(
name|sc
argument_list|,
name|R92C_USB_EP
operator|+
literal|1
argument_list|)
expr_stmt|;
name|DPRINTFN
argument_list|(
literal|2
argument_list|,
literal|"USB endpoints mapping 0x%x\n"
argument_list|,
name|reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|MS
argument_list|(
name|reg
argument_list|,
name|R92C_USB_EP_HQ
argument_list|)
operator|!=
literal|0
condition|)
name|hashq
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|MS
argument_list|(
name|reg
argument_list|,
name|R92C_USB_EP_NQ
argument_list|)
operator|!=
literal|0
condition|)
name|hasnq
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|MS
argument_list|(
name|reg
argument_list|,
name|R92C_USB_EP_LQ
argument_list|)
operator|!=
literal|0
condition|)
name|haslq
operator|=
literal|1
expr_stmt|;
name|nqueues
operator|=
name|hashq
operator|+
name|hasnq
operator|+
name|haslq
expr_stmt|;
if|if
condition|(
name|nqueues
operator|==
literal|0
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
comment|/* Get the number of pages for each queue. */
name|nqpages
operator|=
operator|(
name|R92C_TX_PAGE_COUNT
operator|-
name|R92C_PUBQ_NPAGES
operator|)
operator|/
name|nqueues
expr_stmt|;
comment|/* The remaining pages are assigned to the high priority queue. */
name|nrempages
operator|=
operator|(
name|R92C_TX_PAGE_COUNT
operator|-
name|R92C_PUBQ_NPAGES
operator|)
operator|%
name|nqueues
expr_stmt|;
comment|/* Set number of pages for normal priority queue. */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_RQPN_NPQ
argument_list|,
name|hasnq
condition|?
name|nqpages
else|:
literal|0
argument_list|)
expr_stmt|;
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_RQPN
argument_list|,
comment|/* Set number of pages for public queue. */
name|SM
argument_list|(
name|R92C_RQPN_PUBQ
argument_list|,
name|R92C_PUBQ_NPAGES
argument_list|)
operator||
comment|/* Set number of pages for high priority queue. */
name|SM
argument_list|(
name|R92C_RQPN_HPQ
argument_list|,
name|hashq
condition|?
name|nqpages
operator|+
name|nrempages
else|:
literal|0
argument_list|)
operator||
comment|/* Set number of pages for low priority queue. */
name|SM
argument_list|(
name|R92C_RQPN_LPQ
argument_list|,
name|haslq
condition|?
name|nqpages
else|:
literal|0
argument_list|)
operator||
comment|/* Load values. */
name|R92C_RQPN_LD
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_TXPKTBUF_BCNQ_BDNY
argument_list|,
name|R92C_TX_PAGE_BOUNDARY
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_TXPKTBUF_MGQ_BDNY
argument_list|,
name|R92C_TX_PAGE_BOUNDARY
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_TXPKTBUF_WMAC_LBK_BF_HD
argument_list|,
name|R92C_TX_PAGE_BOUNDARY
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_TRXFF_BNDY
argument_list|,
name|R92C_TX_PAGE_BOUNDARY
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_TDECTRL
operator|+
literal|1
argument_list|,
name|R92C_TX_PAGE_BOUNDARY
argument_list|)
expr_stmt|;
comment|/* Set queue to USB pipe mapping. */
name|reg
operator|=
name|urtwn_read_2
argument_list|(
name|sc
argument_list|,
name|R92C_TRXDMA_CTRL
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
name|R92C_TRXDMA_CTRL_QMAP_M
expr_stmt|;
if|if
condition|(
name|nqueues
operator|==
literal|1
condition|)
block|{
if|if
condition|(
name|hashq
condition|)
name|reg
operator||=
name|R92C_TRXDMA_CTRL_QMAP_HQ
expr_stmt|;
elseif|else
if|if
condition|(
name|hasnq
condition|)
name|reg
operator||=
name|R92C_TRXDMA_CTRL_QMAP_NQ
expr_stmt|;
else|else
name|reg
operator||=
name|R92C_TRXDMA_CTRL_QMAP_LQ
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|nqueues
operator|==
literal|2
condition|)
block|{
comment|/* All 2-endpoints configs have a high priority queue. */
if|if
condition|(
operator|!
name|hashq
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
if|if
condition|(
name|hasnq
condition|)
name|reg
operator||=
name|R92C_TRXDMA_CTRL_QMAP_HQ_NQ
expr_stmt|;
else|else
name|reg
operator||=
name|R92C_TRXDMA_CTRL_QMAP_HQ_LQ
expr_stmt|;
block|}
else|else
name|reg
operator||=
name|R92C_TRXDMA_CTRL_QMAP_3EP
expr_stmt|;
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_TRXDMA_CTRL
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Set Tx/Rx transfer page boundary. */
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_TRXFF_BNDY
operator|+
literal|2
argument_list|,
literal|0x27ff
argument_list|)
expr_stmt|;
comment|/* Set Tx/Rx transfer page size. */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_PBP
argument_list|,
name|SM
argument_list|(
name|R92C_PBP_PSRX
argument_list|,
name|R92C_PBP_128
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_PBP_PSTX
argument_list|,
name|R92C_PBP_128
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|urtwn_r88e_dma_init
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|usb_interface
modifier|*
name|iface
decl_stmt|;
name|uint32_t
name|reg
decl_stmt|;
name|int
name|nqueues
decl_stmt|;
name|int
name|error
decl_stmt|;
comment|/* Initialize LLT table. */
name|error
operator|=
name|urtwn_llt_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
comment|/* Get Tx queues to USB endpoints mapping. */
name|iface
operator|=
name|usbd_get_iface
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|nqueues
operator|=
name|iface
operator|->
name|idesc
operator|->
name|bNumEndpoints
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|nqueues
operator|==
literal|0
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
comment|/* Set number of pages for normal priority queue. */
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_RQPN_NPQ
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_RQPN_NPQ
argument_list|,
literal|0x000d
argument_list|)
expr_stmt|;
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_RQPN
argument_list|,
literal|0x808e000d
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_TXPKTBUF_BCNQ_BDNY
argument_list|,
name|R88E_TX_PAGE_BOUNDARY
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_TXPKTBUF_MGQ_BDNY
argument_list|,
name|R88E_TX_PAGE_BOUNDARY
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_TXPKTBUF_WMAC_LBK_BF_HD
argument_list|,
name|R88E_TX_PAGE_BOUNDARY
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_TRXFF_BNDY
argument_list|,
name|R88E_TX_PAGE_BOUNDARY
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_TDECTRL
operator|+
literal|1
argument_list|,
name|R88E_TX_PAGE_BOUNDARY
argument_list|)
expr_stmt|;
comment|/* Set queue to USB pipe mapping. */
name|reg
operator|=
name|urtwn_read_2
argument_list|(
name|sc
argument_list|,
name|R92C_TRXDMA_CTRL
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
name|R92C_TRXDMA_CTRL_QMAP_M
expr_stmt|;
if|if
condition|(
name|nqueues
operator|==
literal|1
condition|)
name|reg
operator||=
name|R92C_TRXDMA_CTRL_QMAP_LQ
expr_stmt|;
elseif|else
if|if
condition|(
name|nqueues
operator|==
literal|2
condition|)
name|reg
operator||=
name|R92C_TRXDMA_CTRL_QMAP_HQ_NQ
expr_stmt|;
else|else
name|reg
operator||=
name|R92C_TRXDMA_CTRL_QMAP_3EP
expr_stmt|;
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_TRXDMA_CTRL
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Set Tx/Rx transfer page boundary. */
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_TRXFF_BNDY
operator|+
literal|2
argument_list|,
literal|0x23ff
argument_list|)
expr_stmt|;
comment|/* Set Tx/Rx transfer page size. */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_PBP
argument_list|,
name|SM
argument_list|(
name|R92C_PBP_PSRX
argument_list|,
name|R92C_PBP_128
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_PBP_PSTX
argument_list|,
name|R92C_PBP_128
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_mac_init
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
comment|/* Write MAC initialization values. */
if|if
condition|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nitems
argument_list|(
name|rtl8188eu_mac
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|rtl8188eu_mac
index|[
name|i
index|]
operator|.
name|reg
argument_list|,
name|rtl8188eu_mac
index|[
name|i
index|]
operator|.
name|val
argument_list|)
expr_stmt|;
block|}
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_MAX_AGGR_NUM
argument_list|,
literal|0x07
argument_list|)
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nitems
argument_list|(
name|rtl8192cu_mac
argument_list|)
condition|;
name|i
operator|++
control|)
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|rtl8192cu_mac
index|[
name|i
index|]
operator|.
name|reg
argument_list|,
name|rtl8192cu_mac
index|[
name|i
index|]
operator|.
name|val
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_bb_init
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
specifier|const
name|struct
name|urtwn_bb_prog
modifier|*
name|prog
decl_stmt|;
name|uint32_t
name|reg
decl_stmt|;
name|uint8_t
name|crystalcap
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* Enable BB and RF. */
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_FUNC_EN
argument_list|,
name|urtwn_read_2
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_FUNC_EN
argument_list|)
operator||
name|R92C_SYS_FUNC_EN_BBRSTB
operator||
name|R92C_SYS_FUNC_EN_BB_GLB_RST
operator||
name|R92C_SYS_FUNC_EN_DIO_RF
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
operator|)
condition|)
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_AFE_PLL_CTRL
argument_list|,
literal|0xdb83
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_RF_CTRL
argument_list|,
name|R92C_RF_CTRL_EN
operator||
name|R92C_RF_CTRL_RSTB
operator||
name|R92C_RF_CTRL_SDMRSTB
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_FUNC_EN
argument_list|,
name|R92C_SYS_FUNC_EN_USBA
operator||
name|R92C_SYS_FUNC_EN_USBD
operator||
name|R92C_SYS_FUNC_EN_BB_GLB_RST
operator||
name|R92C_SYS_FUNC_EN_BBRSTB
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
operator|)
condition|)
block|{
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_LDOHCI12_CTRL
argument_list|,
literal|0x0f
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
literal|0x15
argument_list|,
literal|0xe9
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_AFE_XTAL_CTRL
operator|+
literal|1
argument_list|,
literal|0x80
argument_list|)
expr_stmt|;
block|}
comment|/* Select BB programming based on board type. */
if|if
condition|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
condition|)
name|prog
operator|=
operator|&
name|rtl8188eu_bb_prog
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
operator|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_92C
operator|)
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|board_type
operator|==
name|R92C_BOARD_TYPE_MINICARD
condition|)
name|prog
operator|=
operator|&
name|rtl8188ce_bb_prog
expr_stmt|;
elseif|else
if|if
condition|(
name|sc
operator|->
name|board_type
operator|==
name|R92C_BOARD_TYPE_HIGHPA
condition|)
name|prog
operator|=
operator|&
name|rtl8188ru_bb_prog
expr_stmt|;
else|else
name|prog
operator|=
operator|&
name|rtl8188cu_bb_prog
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|sc
operator|->
name|board_type
operator|==
name|R92C_BOARD_TYPE_MINICARD
condition|)
name|prog
operator|=
operator|&
name|rtl8192ce_bb_prog
expr_stmt|;
else|else
name|prog
operator|=
operator|&
name|rtl8192cu_bb_prog
expr_stmt|;
block|}
comment|/* Write BB initialization values. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|prog
operator|->
name|count
condition|;
name|i
operator|++
control|)
block|{
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|prog
operator|->
name|regs
index|[
name|i
index|]
argument_list|,
name|prog
operator|->
name|vals
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_92C_1T2R
condition|)
block|{
comment|/* 8192C 1T only configuration. */
name|reg
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_TXINFO
argument_list|)
expr_stmt|;
name|reg
operator|=
operator|(
name|reg
operator|&
operator|~
literal|0x00000003
operator|)
operator||
literal|0x2
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_TXINFO
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA1_TXINFO
argument_list|)
expr_stmt|;
name|reg
operator|=
operator|(
name|reg
operator|&
operator|~
literal|0x00300033
operator|)
operator||
literal|0x00200022
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA1_TXINFO
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_CCK0_AFESETTING
argument_list|)
expr_stmt|;
name|reg
operator|=
operator|(
name|reg
operator|&
operator|~
literal|0xff000000
operator|)
operator||
literal|0x45
operator|<<
literal|24
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_CCK0_AFESETTING
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_TRXPATHENA
argument_list|)
expr_stmt|;
name|reg
operator|=
operator|(
name|reg
operator|&
operator|~
literal|0x000000ff
operator|)
operator||
literal|0x23
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_TRXPATHENA
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_AGCPARAM1
argument_list|)
expr_stmt|;
name|reg
operator|=
operator|(
name|reg
operator|&
operator|~
literal|0x00000030
operator|)
operator||
literal|1
operator|<<
literal|4
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_AGCPARAM1
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
literal|0xe74
argument_list|)
expr_stmt|;
name|reg
operator|=
operator|(
name|reg
operator|&
operator|~
literal|0x0c000000
operator|)
operator||
literal|2
operator|<<
literal|26
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
literal|0xe74
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
literal|0xe78
argument_list|)
expr_stmt|;
name|reg
operator|=
operator|(
name|reg
operator|&
operator|~
literal|0x0c000000
operator|)
operator||
literal|2
operator|<<
literal|26
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
literal|0xe78
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
literal|0xe7c
argument_list|)
expr_stmt|;
name|reg
operator|=
operator|(
name|reg
operator|&
operator|~
literal|0x0c000000
operator|)
operator||
literal|2
operator|<<
literal|26
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
literal|0xe7c
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
literal|0xe80
argument_list|)
expr_stmt|;
name|reg
operator|=
operator|(
name|reg
operator|&
operator|~
literal|0x0c000000
operator|)
operator||
literal|2
operator|<<
literal|26
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
literal|0xe80
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
literal|0xe88
argument_list|)
expr_stmt|;
name|reg
operator|=
operator|(
name|reg
operator|&
operator|~
literal|0x0c000000
operator|)
operator||
literal|2
operator|<<
literal|26
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
literal|0xe88
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
comment|/* Write AGC values. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|prog
operator|->
name|agccount
condition|;
name|i
operator|++
control|)
block|{
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_AGCRSSITABLE
argument_list|,
name|prog
operator|->
name|agcvals
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
condition|)
block|{
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_AGCCORE1
argument_list|(
literal|0
argument_list|)
argument_list|,
literal|0x69553422
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_AGCCORE1
argument_list|(
literal|0
argument_list|)
argument_list|,
literal|0x69553420
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|crystalcap
operator|=
name|sc
operator|->
name|r88e_rom
index|[
literal|0xb9
index|]
expr_stmt|;
if|if
condition|(
name|crystalcap
operator|==
literal|0xff
condition|)
name|crystalcap
operator|=
literal|0x20
expr_stmt|;
name|crystalcap
operator|&=
literal|0x3f
expr_stmt|;
name|reg
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_AFE_XTAL_CTRL
argument_list|)
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_AFE_XTAL_CTRL
argument_list|,
name|RW
argument_list|(
name|reg
argument_list|,
name|R92C_AFE_XTAL_CTRL_ADDR
argument_list|,
name|crystalcap
operator||
name|crystalcap
operator|<<
literal|6
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_HSSI_PARAM2
argument_list|(
literal|0
argument_list|)
argument_list|)
operator|&
name|R92C_HSSI_PARAM2_CCK_HIPWR
condition|)
name|sc
operator|->
name|sc_flags
operator||=
name|URTWN_FLAG_CCK_HIPWR
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|urtwn_rf_init
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
specifier|const
name|struct
name|urtwn_rf_prog
modifier|*
name|prog
decl_stmt|;
name|uint32_t
name|reg
decl_stmt|,
name|type
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|idx
decl_stmt|,
name|off
decl_stmt|;
comment|/* Select RF programming based on board type. */
if|if
condition|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
condition|)
name|prog
operator|=
name|rtl8188eu_rf_prog
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
operator|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_92C
operator|)
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|board_type
operator|==
name|R92C_BOARD_TYPE_MINICARD
condition|)
name|prog
operator|=
name|rtl8188ce_rf_prog
expr_stmt|;
elseif|else
if|if
condition|(
name|sc
operator|->
name|board_type
operator|==
name|R92C_BOARD_TYPE_HIGHPA
condition|)
name|prog
operator|=
name|rtl8188ru_rf_prog
expr_stmt|;
else|else
name|prog
operator|=
name|rtl8188cu_rf_prog
expr_stmt|;
block|}
else|else
name|prog
operator|=
name|rtl8192ce_rf_prog
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|nrxchains
condition|;
name|i
operator|++
control|)
block|{
comment|/* Save RF_ENV control type. */
name|idx
operator|=
name|i
operator|/
literal|2
expr_stmt|;
name|off
operator|=
operator|(
name|i
operator|%
literal|2
operator|)
operator|*
literal|16
expr_stmt|;
name|reg
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_RFIFACESW
argument_list|(
name|idx
argument_list|)
argument_list|)
expr_stmt|;
name|type
operator|=
operator|(
name|reg
operator|>>
name|off
operator|)
operator|&
literal|0x10
expr_stmt|;
comment|/* Set RF_ENV enable. */
name|reg
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_RFIFACEOE
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
name|reg
operator||=
literal|0x100000
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_RFIFACEOE
argument_list|(
name|i
argument_list|)
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
comment|/* Set RF_ENV output high. */
name|reg
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_RFIFACEOE
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
name|reg
operator||=
literal|0x10
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_RFIFACEOE
argument_list|(
name|i
argument_list|)
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
comment|/* Set address and data lengths of RF registers. */
name|reg
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_HSSI_PARAM2
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
name|R92C_HSSI_PARAM2_ADDR_LENGTH
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_HSSI_PARAM2
argument_list|(
name|i
argument_list|)
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|reg
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_HSSI_PARAM2
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
name|R92C_HSSI_PARAM2_DATA_LENGTH
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_HSSI_PARAM2
argument_list|(
name|i
argument_list|)
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
comment|/* Write RF initialization values for this chain. */
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|prog
index|[
name|i
index|]
operator|.
name|count
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|prog
index|[
name|i
index|]
operator|.
name|regs
index|[
name|j
index|]
operator|>=
literal|0xf9
operator|&&
name|prog
index|[
name|i
index|]
operator|.
name|regs
index|[
name|j
index|]
operator|<=
literal|0xfe
condition|)
block|{
comment|/* 				 * These are fake RF registers offsets that 				 * indicate a delay is required. 				 */
name|usb_pause_mtx
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|,
literal|50
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|urtwn_rf_write
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|prog
index|[
name|i
index|]
operator|.
name|regs
index|[
name|j
index|]
argument_list|,
name|prog
index|[
name|i
index|]
operator|.
name|vals
index|[
name|j
index|]
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* Restore RF_ENV control type. */
name|reg
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_RFIFACESW
argument_list|(
name|idx
argument_list|)
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
operator|(
literal|0x10
operator|<<
name|off
operator|)
operator||
operator|(
name|type
operator|<<
name|off
operator|)
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_RFIFACESW
argument_list|(
name|idx
argument_list|)
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Cache RF register CHNLBW. */
name|sc
operator|->
name|rf_chnlbw
index|[
name|i
index|]
operator|=
name|urtwn_rf_read
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|R92C_RF_CHNLBW
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|sc
operator|->
name|chip
operator|&
operator|(
name|URTWN_CHIP_UMC_A_CUT
operator||
name|URTWN_CHIP_92C
operator|)
operator|)
operator|==
name|URTWN_CHIP_UMC_A_CUT
condition|)
block|{
name|urtwn_rf_write
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
name|R92C_RF_RX_G1
argument_list|,
literal|0x30255
argument_list|)
expr_stmt|;
name|urtwn_rf_write
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
name|R92C_RF_RX_G2
argument_list|,
literal|0x50a00
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_cam_init
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
comment|/* Invalidate all CAM entries. */
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_CAMCMD
argument_list|,
name|R92C_CAMCMD_POLLING
operator||
name|R92C_CAMCMD_CLR
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_pa_bias_init
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint8_t
name|reg
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|nrxchains
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|sc
operator|->
name|pa_setting
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
condition|)
continue|continue;
name|urtwn_rf_write
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|R92C_RF_IPA
argument_list|,
literal|0x0f406
argument_list|)
expr_stmt|;
name|urtwn_rf_write
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|R92C_RF_IPA
argument_list|,
literal|0x4f406
argument_list|)
expr_stmt|;
name|urtwn_rf_write
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|R92C_RF_IPA
argument_list|,
literal|0x8f406
argument_list|)
expr_stmt|;
name|urtwn_rf_write
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|R92C_RF_IPA
argument_list|,
literal|0xcf406
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|(
name|sc
operator|->
name|pa_setting
operator|&
literal|0x10
operator|)
condition|)
block|{
name|reg
operator|=
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
literal|0x16
argument_list|)
expr_stmt|;
name|reg
operator|=
operator|(
name|reg
operator|&
operator|~
literal|0xf0
operator|)
operator||
literal|0x90
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
literal|0x16
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_rxfilter_init
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
comment|/* Initialize Rx filter. */
comment|/* TODO: use better filter for monitor mode. */
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_RCR
argument_list|,
name|R92C_RCR_AAP
operator||
name|R92C_RCR_APM
operator||
name|R92C_RCR_AM
operator||
name|R92C_RCR_AB
operator||
name|R92C_RCR_APP_ICV
operator||
name|R92C_RCR_AMF
operator||
name|R92C_RCR_HTC_LOC_CTRL
operator||
name|R92C_RCR_APP_MIC
operator||
name|R92C_RCR_APP_PHYSTS
argument_list|)
expr_stmt|;
comment|/* Accept all multicast frames. */
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_MAR
operator|+
literal|0
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_MAR
operator|+
literal|4
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
comment|/* Accept all management frames. */
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_RXFLTMAP0
argument_list|,
literal|0xffff
argument_list|)
expr_stmt|;
comment|/* Reject all control frames. */
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_RXFLTMAP1
argument_list|,
literal|0x0000
argument_list|)
expr_stmt|;
comment|/* Accept all data frames. */
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_RXFLTMAP2
argument_list|,
literal|0xffff
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_edca_init
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_SPEC_SIFS
argument_list|,
literal|0x100a
argument_list|)
expr_stmt|;
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_MAC_SPEC_SIFS
argument_list|,
literal|0x100a
argument_list|)
expr_stmt|;
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_SIFS_CCK
argument_list|,
literal|0x100a
argument_list|)
expr_stmt|;
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_SIFS_OFDM
argument_list|,
literal|0x100a
argument_list|)
expr_stmt|;
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_EDCA_BE_PARAM
argument_list|,
literal|0x005ea42b
argument_list|)
expr_stmt|;
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_EDCA_BK_PARAM
argument_list|,
literal|0x0000a44f
argument_list|)
expr_stmt|;
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_EDCA_VI_PARAM
argument_list|,
literal|0x005ea324
argument_list|)
expr_stmt|;
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_EDCA_VO_PARAM
argument_list|,
literal|0x002fa226
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|urtwn_write_txpower
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|int
name|chain
parameter_list|,
name|uint16_t
name|power
index|[
name|URTWN_RIDX_COUNT
index|]
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
comment|/* Write per-CCK rate Tx power. */
if|if
condition|(
name|chain
operator|==
literal|0
condition|)
block|{
name|reg
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_TXAGC_A_CCK1_MCS32
argument_list|)
expr_stmt|;
name|reg
operator|=
name|RW
argument_list|(
name|reg
argument_list|,
name|R92C_TXAGC_A_CCK1
argument_list|,
name|power
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_TXAGC_A_CCK1_MCS32
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_TXAGC_B_CCK11_A_CCK2_11
argument_list|)
expr_stmt|;
name|reg
operator|=
name|RW
argument_list|(
name|reg
argument_list|,
name|R92C_TXAGC_A_CCK2
argument_list|,
name|power
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|reg
operator|=
name|RW
argument_list|(
name|reg
argument_list|,
name|R92C_TXAGC_A_CCK55
argument_list|,
name|power
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|reg
operator|=
name|RW
argument_list|(
name|reg
argument_list|,
name|R92C_TXAGC_A_CCK11
argument_list|,
name|power
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_TXAGC_B_CCK11_A_CCK2_11
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|reg
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_TXAGC_B_CCK1_55_MCS32
argument_list|)
expr_stmt|;
name|reg
operator|=
name|RW
argument_list|(
name|reg
argument_list|,
name|R92C_TXAGC_B_CCK1
argument_list|,
name|power
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|reg
operator|=
name|RW
argument_list|(
name|reg
argument_list|,
name|R92C_TXAGC_B_CCK2
argument_list|,
name|power
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|reg
operator|=
name|RW
argument_list|(
name|reg
argument_list|,
name|R92C_TXAGC_B_CCK55
argument_list|,
name|power
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_TXAGC_B_CCK1_55_MCS32
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_TXAGC_B_CCK11_A_CCK2_11
argument_list|)
expr_stmt|;
name|reg
operator|=
name|RW
argument_list|(
name|reg
argument_list|,
name|R92C_TXAGC_B_CCK11
argument_list|,
name|power
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_TXAGC_B_CCK11_A_CCK2_11
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
comment|/* Write per-OFDM rate Tx power. */
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_TXAGC_RATE18_06
argument_list|(
name|chain
argument_list|)
argument_list|,
name|SM
argument_list|(
name|R92C_TXAGC_RATE06
argument_list|,
name|power
index|[
literal|4
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXAGC_RATE09
argument_list|,
name|power
index|[
literal|5
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXAGC_RATE12
argument_list|,
name|power
index|[
literal|6
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXAGC_RATE18
argument_list|,
name|power
index|[
literal|7
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_TXAGC_RATE54_24
argument_list|(
name|chain
argument_list|)
argument_list|,
name|SM
argument_list|(
name|R92C_TXAGC_RATE24
argument_list|,
name|power
index|[
literal|8
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXAGC_RATE36
argument_list|,
name|power
index|[
literal|9
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXAGC_RATE48
argument_list|,
name|power
index|[
literal|10
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXAGC_RATE54
argument_list|,
name|power
index|[
literal|11
index|]
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Write per-MCS Tx power. */
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_TXAGC_MCS03_MCS00
argument_list|(
name|chain
argument_list|)
argument_list|,
name|SM
argument_list|(
name|R92C_TXAGC_MCS00
argument_list|,
name|power
index|[
literal|12
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXAGC_MCS01
argument_list|,
name|power
index|[
literal|13
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXAGC_MCS02
argument_list|,
name|power
index|[
literal|14
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXAGC_MCS03
argument_list|,
name|power
index|[
literal|15
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_TXAGC_MCS07_MCS04
argument_list|(
name|chain
argument_list|)
argument_list|,
name|SM
argument_list|(
name|R92C_TXAGC_MCS04
argument_list|,
name|power
index|[
literal|16
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXAGC_MCS05
argument_list|,
name|power
index|[
literal|17
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXAGC_MCS06
argument_list|,
name|power
index|[
literal|18
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXAGC_MCS07
argument_list|,
name|power
index|[
literal|19
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_TXAGC_MCS11_MCS08
argument_list|(
name|chain
argument_list|)
argument_list|,
name|SM
argument_list|(
name|R92C_TXAGC_MCS08
argument_list|,
name|power
index|[
literal|20
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXAGC_MCS09
argument_list|,
name|power
index|[
literal|21
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXAGC_MCS10
argument_list|,
name|power
index|[
literal|22
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXAGC_MCS11
argument_list|,
name|power
index|[
literal|23
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_TXAGC_MCS15_MCS12
argument_list|(
name|chain
argument_list|)
argument_list|,
name|SM
argument_list|(
name|R92C_TXAGC_MCS12
argument_list|,
name|power
index|[
literal|24
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXAGC_MCS13
argument_list|,
name|power
index|[
literal|25
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXAGC_MCS14
argument_list|,
name|power
index|[
literal|26
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXAGC_MCS15
argument_list|,
name|power
index|[
literal|27
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|urtwn_get_txpower
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|int
name|chain
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
name|c
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
name|extc
parameter_list|,
name|uint16_t
name|power
index|[
name|URTWN_RIDX_COUNT
index|]
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|sc
operator|->
name|sc_ifp
operator|->
name|if_l2com
decl_stmt|;
name|struct
name|r92c_rom
modifier|*
name|rom
init|=
operator|&
name|sc
operator|->
name|rom
decl_stmt|;
name|uint16_t
name|cckpow
decl_stmt|,
name|ofdmpow
decl_stmt|,
name|htpow
decl_stmt|,
name|diff
decl_stmt|,
name|max
decl_stmt|;
specifier|const
name|struct
name|urtwn_txpwr
modifier|*
name|base
decl_stmt|;
name|int
name|ridx
decl_stmt|,
name|chan
decl_stmt|,
name|group
decl_stmt|;
comment|/* Determine channel group. */
name|chan
operator|=
name|ieee80211_chan2ieee
argument_list|(
name|ic
argument_list|,
name|c
argument_list|)
expr_stmt|;
comment|/* XXX center freq! */
if|if
condition|(
name|chan
operator|<=
literal|3
condition|)
name|group
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|chan
operator|<=
literal|9
condition|)
name|group
operator|=
literal|1
expr_stmt|;
else|else
name|group
operator|=
literal|2
expr_stmt|;
comment|/* Get original Tx power based on board type and RF chain. */
if|if
condition|(
operator|!
operator|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_92C
operator|)
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|board_type
operator|==
name|R92C_BOARD_TYPE_HIGHPA
condition|)
name|base
operator|=
operator|&
name|rtl8188ru_txagc
index|[
name|chain
index|]
expr_stmt|;
else|else
name|base
operator|=
operator|&
name|rtl8192cu_txagc
index|[
name|chain
index|]
expr_stmt|;
block|}
else|else
name|base
operator|=
operator|&
name|rtl8192cu_txagc
index|[
name|chain
index|]
expr_stmt|;
name|memset
argument_list|(
name|power
argument_list|,
literal|0
argument_list|,
name|URTWN_RIDX_COUNT
operator|*
sizeof|sizeof
argument_list|(
name|power
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|regulatory
operator|==
literal|0
condition|)
block|{
for|for
control|(
name|ridx
operator|=
literal|0
init|;
name|ridx
operator|<=
literal|3
condition|;
name|ridx
operator|++
control|)
name|power
index|[
name|ridx
index|]
operator|=
name|base
operator|->
name|pwr
index|[
literal|0
index|]
index|[
name|ridx
index|]
expr_stmt|;
block|}
for|for
control|(
name|ridx
operator|=
literal|4
init|;
name|ridx
operator|<
name|URTWN_RIDX_COUNT
condition|;
name|ridx
operator|++
control|)
block|{
if|if
condition|(
name|sc
operator|->
name|regulatory
operator|==
literal|3
condition|)
block|{
name|power
index|[
name|ridx
index|]
operator|=
name|base
operator|->
name|pwr
index|[
literal|0
index|]
index|[
name|ridx
index|]
expr_stmt|;
comment|/* Apply vendor limits. */
if|if
condition|(
name|extc
operator|!=
name|NULL
condition|)
name|max
operator|=
name|rom
operator|->
name|ht40_max_pwr
index|[
name|group
index|]
expr_stmt|;
else|else
name|max
operator|=
name|rom
operator|->
name|ht20_max_pwr
index|[
name|group
index|]
expr_stmt|;
name|max
operator|=
operator|(
name|max
operator|>>
operator|(
name|chain
operator|*
literal|4
operator|)
operator|)
operator|&
literal|0xf
expr_stmt|;
if|if
condition|(
name|power
index|[
name|ridx
index|]
operator|>
name|max
condition|)
name|power
index|[
name|ridx
index|]
operator|=
name|max
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sc
operator|->
name|regulatory
operator|==
literal|1
condition|)
block|{
if|if
condition|(
name|extc
operator|==
name|NULL
condition|)
name|power
index|[
name|ridx
index|]
operator|=
name|base
operator|->
name|pwr
index|[
name|group
index|]
index|[
name|ridx
index|]
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sc
operator|->
name|regulatory
operator|!=
literal|2
condition|)
name|power
index|[
name|ridx
index|]
operator|=
name|base
operator|->
name|pwr
index|[
literal|0
index|]
index|[
name|ridx
index|]
expr_stmt|;
block|}
comment|/* Compute per-CCK rate Tx power. */
name|cckpow
operator|=
name|rom
operator|->
name|cck_tx_pwr
index|[
name|chain
index|]
index|[
name|group
index|]
expr_stmt|;
for|for
control|(
name|ridx
operator|=
literal|0
init|;
name|ridx
operator|<=
literal|3
condition|;
name|ridx
operator|++
control|)
block|{
name|power
index|[
name|ridx
index|]
operator|+=
name|cckpow
expr_stmt|;
if|if
condition|(
name|power
index|[
name|ridx
index|]
operator|>
name|R92C_MAX_TX_PWR
condition|)
name|power
index|[
name|ridx
index|]
operator|=
name|R92C_MAX_TX_PWR
expr_stmt|;
block|}
name|htpow
operator|=
name|rom
operator|->
name|ht40_1s_tx_pwr
index|[
name|chain
index|]
index|[
name|group
index|]
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|ntxchains
operator|>
literal|1
condition|)
block|{
comment|/* Apply reduction for 2 spatial streams. */
name|diff
operator|=
name|rom
operator|->
name|ht40_2s_tx_pwr_diff
index|[
name|group
index|]
expr_stmt|;
name|diff
operator|=
operator|(
name|diff
operator|>>
operator|(
name|chain
operator|*
literal|4
operator|)
operator|)
operator|&
literal|0xf
expr_stmt|;
name|htpow
operator|=
operator|(
name|htpow
operator|>
name|diff
operator|)
condition|?
name|htpow
operator|-
name|diff
else|:
literal|0
expr_stmt|;
block|}
comment|/* Compute per-OFDM rate Tx power. */
name|diff
operator|=
name|rom
operator|->
name|ofdm_tx_pwr_diff
index|[
name|group
index|]
expr_stmt|;
name|diff
operator|=
operator|(
name|diff
operator|>>
operator|(
name|chain
operator|*
literal|4
operator|)
operator|)
operator|&
literal|0xf
expr_stmt|;
name|ofdmpow
operator|=
name|htpow
operator|+
name|diff
expr_stmt|;
comment|/* HT->OFDM correction. */
for|for
control|(
name|ridx
operator|=
literal|4
init|;
name|ridx
operator|<=
literal|11
condition|;
name|ridx
operator|++
control|)
block|{
name|power
index|[
name|ridx
index|]
operator|+=
name|ofdmpow
expr_stmt|;
if|if
condition|(
name|power
index|[
name|ridx
index|]
operator|>
name|R92C_MAX_TX_PWR
condition|)
name|power
index|[
name|ridx
index|]
operator|=
name|R92C_MAX_TX_PWR
expr_stmt|;
block|}
comment|/* Compute per-MCS Tx power. */
if|if
condition|(
name|extc
operator|==
name|NULL
condition|)
block|{
name|diff
operator|=
name|rom
operator|->
name|ht20_tx_pwr_diff
index|[
name|group
index|]
expr_stmt|;
name|diff
operator|=
operator|(
name|diff
operator|>>
operator|(
name|chain
operator|*
literal|4
operator|)
operator|)
operator|&
literal|0xf
expr_stmt|;
name|htpow
operator|+=
name|diff
expr_stmt|;
comment|/* HT40->HT20 correction. */
block|}
for|for
control|(
name|ridx
operator|=
literal|12
init|;
name|ridx
operator|<=
literal|27
condition|;
name|ridx
operator|++
control|)
block|{
name|power
index|[
name|ridx
index|]
operator|+=
name|htpow
expr_stmt|;
if|if
condition|(
name|power
index|[
name|ridx
index|]
operator|>
name|R92C_MAX_TX_PWR
condition|)
name|power
index|[
name|ridx
index|]
operator|=
name|R92C_MAX_TX_PWR
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|URTWN_DEBUG
if|if
condition|(
name|urtwn_debug
operator|>=
literal|4
condition|)
block|{
comment|/* Dump per-rate Tx power values. */
name|printf
argument_list|(
literal|"Tx power for chain %d:\n"
argument_list|,
name|chain
argument_list|)
expr_stmt|;
for|for
control|(
name|ridx
operator|=
literal|0
init|;
name|ridx
operator|<
name|URTWN_RIDX_COUNT
condition|;
name|ridx
operator|++
control|)
name|printf
argument_list|(
literal|"Rate %d = %u\n"
argument_list|,
name|ridx
argument_list|,
name|power
index|[
name|ridx
index|]
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
block|}
end_function

begin_function
name|void
name|urtwn_r88e_get_txpower
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|int
name|chain
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
name|c
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
name|extc
parameter_list|,
name|uint16_t
name|power
index|[
name|URTWN_RIDX_COUNT
index|]
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|sc
operator|->
name|sc_ifp
operator|->
name|if_l2com
decl_stmt|;
name|uint16_t
name|cckpow
decl_stmt|,
name|ofdmpow
decl_stmt|,
name|bw20pow
decl_stmt|,
name|htpow
decl_stmt|;
specifier|const
name|struct
name|urtwn_r88e_txpwr
modifier|*
name|base
decl_stmt|;
name|int
name|ridx
decl_stmt|,
name|chan
decl_stmt|,
name|group
decl_stmt|;
comment|/* Determine channel group. */
name|chan
operator|=
name|ieee80211_chan2ieee
argument_list|(
name|ic
argument_list|,
name|c
argument_list|)
expr_stmt|;
comment|/* XXX center freq! */
if|if
condition|(
name|chan
operator|<=
literal|2
condition|)
name|group
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|chan
operator|<=
literal|5
condition|)
name|group
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|chan
operator|<=
literal|8
condition|)
name|group
operator|=
literal|2
expr_stmt|;
elseif|else
if|if
condition|(
name|chan
operator|<=
literal|11
condition|)
name|group
operator|=
literal|3
expr_stmt|;
elseif|else
if|if
condition|(
name|chan
operator|<=
literal|13
condition|)
name|group
operator|=
literal|4
expr_stmt|;
else|else
name|group
operator|=
literal|5
expr_stmt|;
comment|/* Get original Tx power based on board type and RF chain. */
name|base
operator|=
operator|&
name|rtl8188eu_txagc
index|[
name|chain
index|]
expr_stmt|;
name|memset
argument_list|(
name|power
argument_list|,
literal|0
argument_list|,
name|URTWN_RIDX_COUNT
operator|*
sizeof|sizeof
argument_list|(
name|power
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|regulatory
operator|==
literal|0
condition|)
block|{
for|for
control|(
name|ridx
operator|=
literal|0
init|;
name|ridx
operator|<=
literal|3
condition|;
name|ridx
operator|++
control|)
name|power
index|[
name|ridx
index|]
operator|=
name|base
operator|->
name|pwr
index|[
literal|0
index|]
index|[
name|ridx
index|]
expr_stmt|;
block|}
for|for
control|(
name|ridx
operator|=
literal|4
init|;
name|ridx
operator|<
name|URTWN_RIDX_COUNT
condition|;
name|ridx
operator|++
control|)
block|{
if|if
condition|(
name|sc
operator|->
name|regulatory
operator|==
literal|3
condition|)
name|power
index|[
name|ridx
index|]
operator|=
name|base
operator|->
name|pwr
index|[
literal|0
index|]
index|[
name|ridx
index|]
expr_stmt|;
elseif|else
if|if
condition|(
name|sc
operator|->
name|regulatory
operator|==
literal|1
condition|)
block|{
if|if
condition|(
name|extc
operator|==
name|NULL
condition|)
name|power
index|[
name|ridx
index|]
operator|=
name|base
operator|->
name|pwr
index|[
name|group
index|]
index|[
name|ridx
index|]
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sc
operator|->
name|regulatory
operator|!=
literal|2
condition|)
name|power
index|[
name|ridx
index|]
operator|=
name|base
operator|->
name|pwr
index|[
literal|0
index|]
index|[
name|ridx
index|]
expr_stmt|;
block|}
comment|/* Compute per-CCK rate Tx power. */
name|cckpow
operator|=
name|sc
operator|->
name|cck_tx_pwr
index|[
name|group
index|]
expr_stmt|;
for|for
control|(
name|ridx
operator|=
literal|0
init|;
name|ridx
operator|<=
literal|3
condition|;
name|ridx
operator|++
control|)
block|{
name|power
index|[
name|ridx
index|]
operator|+=
name|cckpow
expr_stmt|;
if|if
condition|(
name|power
index|[
name|ridx
index|]
operator|>
name|R92C_MAX_TX_PWR
condition|)
name|power
index|[
name|ridx
index|]
operator|=
name|R92C_MAX_TX_PWR
expr_stmt|;
block|}
name|htpow
operator|=
name|sc
operator|->
name|ht40_tx_pwr
index|[
name|group
index|]
expr_stmt|;
comment|/* Compute per-OFDM rate Tx power. */
name|ofdmpow
operator|=
name|htpow
operator|+
name|sc
operator|->
name|ofdm_tx_pwr_diff
expr_stmt|;
for|for
control|(
name|ridx
operator|=
literal|4
init|;
name|ridx
operator|<=
literal|11
condition|;
name|ridx
operator|++
control|)
block|{
name|power
index|[
name|ridx
index|]
operator|+=
name|ofdmpow
expr_stmt|;
if|if
condition|(
name|power
index|[
name|ridx
index|]
operator|>
name|R92C_MAX_TX_PWR
condition|)
name|power
index|[
name|ridx
index|]
operator|=
name|R92C_MAX_TX_PWR
expr_stmt|;
block|}
name|bw20pow
operator|=
name|htpow
operator|+
name|sc
operator|->
name|bw20_tx_pwr_diff
expr_stmt|;
for|for
control|(
name|ridx
operator|=
literal|12
init|;
name|ridx
operator|<=
literal|27
condition|;
name|ridx
operator|++
control|)
block|{
name|power
index|[
name|ridx
index|]
operator|+=
name|bw20pow
expr_stmt|;
if|if
condition|(
name|power
index|[
name|ridx
index|]
operator|>
name|R92C_MAX_TX_PWR
condition|)
name|power
index|[
name|ridx
index|]
operator|=
name|R92C_MAX_TX_PWR
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|urtwn_set_txpower
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
name|c
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
name|extc
parameter_list|)
block|{
name|uint16_t
name|power
index|[
name|URTWN_RIDX_COUNT
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|ntxchains
condition|;
name|i
operator|++
control|)
block|{
comment|/* Compute per-rate Tx power values. */
if|if
condition|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
condition|)
name|urtwn_r88e_get_txpower
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|c
argument_list|,
name|extc
argument_list|,
name|power
argument_list|)
expr_stmt|;
else|else
name|urtwn_get_txpower
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|c
argument_list|,
name|extc
argument_list|,
name|power
argument_list|)
expr_stmt|;
comment|/* Write per-rate Tx power values to hardware. */
name|urtwn_write_txpower
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|power
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_scan_start
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|)
block|{
comment|/* XXX do nothing?  */
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_scan_end
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|)
block|{
comment|/* XXX do nothing?  */
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_set_channel
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|)
block|{
name|struct
name|urtwn_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_ifp
operator|->
name|if_softc
decl_stmt|;
name|URTWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|urtwn_set_chan
argument_list|(
name|sc
argument_list|,
name|ic
operator|->
name|ic_curchan
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|URTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_update_mcast
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
comment|/* XXX do nothing?  */
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_set_chan
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
name|c
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
name|extc
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|sc
operator|->
name|sc_ifp
operator|->
name|if_l2com
decl_stmt|;
name|uint32_t
name|reg
decl_stmt|;
name|u_int
name|chan
decl_stmt|;
name|int
name|i
decl_stmt|;
name|chan
operator|=
name|ieee80211_chan2ieee
argument_list|(
name|ic
argument_list|,
name|c
argument_list|)
expr_stmt|;
comment|/* XXX center freq! */
if|if
condition|(
name|chan
operator|==
literal|0
operator|||
name|chan
operator|==
name|IEEE80211_CHAN_ANY
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: invalid channel %x\n"
argument_list|,
name|__func__
argument_list|,
name|chan
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Set Tx power for this new channel. */
name|urtwn_set_txpower
argument_list|(
name|sc
argument_list|,
name|c
argument_list|,
name|extc
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|nrxchains
condition|;
name|i
operator|++
control|)
block|{
name|urtwn_rf_write
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|R92C_RF_CHNLBW
argument_list|,
name|RW
argument_list|(
name|sc
operator|->
name|rf_chnlbw
index|[
name|i
index|]
argument_list|,
name|R92C_RF_CHNLBW_CHNL
argument_list|,
name|chan
argument_list|)
argument_list|)
expr_stmt|;
block|}
ifndef|#
directive|ifndef
name|IEEE80211_NO_HT
if|if
condition|(
name|extc
operator|!=
name|NULL
condition|)
block|{
comment|/* Is secondary channel below or above primary? */
name|int
name|prichlo
init|=
name|c
operator|->
name|ic_freq
operator|<
name|extc
operator|->
name|ic_freq
decl_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_BWOPMODE
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_BWOPMODE
argument_list|)
operator|&
operator|~
name|R92C_BWOPMODE_20MHZ
argument_list|)
expr_stmt|;
name|reg
operator|=
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_RRSR
operator|+
literal|2
argument_list|)
expr_stmt|;
name|reg
operator|=
operator|(
name|reg
operator|&
operator|~
literal|0x6f
operator|)
operator||
operator|(
name|prichlo
condition|?
literal|1
else|:
literal|2
operator|)
operator|<<
literal|5
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_RRSR
operator|+
literal|2
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_RFMOD
argument_list|,
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_RFMOD
argument_list|)
operator||
name|R92C_RFMOD_40MHZ
argument_list|)
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA1_RFMOD
argument_list|,
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA1_RFMOD
argument_list|)
operator||
name|R92C_RFMOD_40MHZ
argument_list|)
expr_stmt|;
comment|/* Set CCK side band. */
name|reg
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_CCK0_SYSTEM
argument_list|)
expr_stmt|;
name|reg
operator|=
operator|(
name|reg
operator|&
operator|~
literal|0x00000010
operator|)
operator||
operator|(
name|prichlo
condition|?
literal|0
else|:
literal|1
operator|)
operator|<<
literal|4
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_CCK0_SYSTEM
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM1_LSTF
argument_list|)
expr_stmt|;
name|reg
operator|=
operator|(
name|reg
operator|&
operator|~
literal|0x00000c00
operator|)
operator||
operator|(
name|prichlo
condition|?
literal|1
else|:
literal|2
operator|)
operator|<<
literal|10
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM1_LSTF
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_ANAPARAM2
argument_list|,
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_ANAPARAM2
argument_list|)
operator|&
operator|~
name|R92C_FPGA0_ANAPARAM2_CBW20
argument_list|)
expr_stmt|;
name|reg
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
literal|0x818
argument_list|)
expr_stmt|;
name|reg
operator|=
operator|(
name|reg
operator|&
operator|~
literal|0x0c000000
operator|)
operator||
operator|(
name|prichlo
condition|?
literal|2
else|:
literal|1
operator|)
operator|<<
literal|26
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
literal|0x818
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Select 40MHz bandwidth. */
name|urtwn_rf_write
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
name|R92C_RF_CHNLBW
argument_list|,
operator|(
name|sc
operator|->
name|rf_chnlbw
index|[
literal|0
index|]
operator|&
operator|~
literal|0xfff
operator|)
operator||
name|chan
argument_list|)
expr_stmt|;
block|}
else|else
endif|#
directive|endif
block|{
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_BWOPMODE
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_BWOPMODE
argument_list|)
operator||
name|R92C_BWOPMODE_20MHZ
argument_list|)
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_RFMOD
argument_list|,
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_RFMOD
argument_list|)
operator|&
operator|~
name|R92C_RFMOD_40MHZ
argument_list|)
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA1_RFMOD
argument_list|,
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA1_RFMOD
argument_list|)
operator|&
operator|~
name|R92C_RFMOD_40MHZ
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
operator|)
condition|)
block|{
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_ANAPARAM2
argument_list|,
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_ANAPARAM2
argument_list|)
operator||
name|R92C_FPGA0_ANAPARAM2_CBW20
argument_list|)
expr_stmt|;
block|}
comment|/* Select 20MHz bandwidth. */
name|urtwn_rf_write
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
name|R92C_RF_CHNLBW
argument_list|,
operator|(
name|sc
operator|->
name|rf_chnlbw
index|[
literal|0
index|]
operator|&
operator|~
literal|0xfff
operator|)
operator||
name|chan
operator||
operator|(
operator|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
operator|)
condition|?
name|R88E_RF_CHNLBW_BW20
else|:
name|R92C_RF_CHNLBW_BW20
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_iq_calib
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
comment|/* TODO */
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_lc_calib
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|rf_ac
index|[
literal|2
index|]
decl_stmt|;
name|uint8_t
name|txmode
decl_stmt|;
name|int
name|i
decl_stmt|;
name|txmode
operator|=
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM1_LSTF
operator|+
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|txmode
operator|&
literal|0x70
operator|)
operator|!=
literal|0
condition|)
block|{
comment|/* Disable all continuous Tx. */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM1_LSTF
operator|+
literal|3
argument_list|,
name|txmode
operator|&
operator|~
literal|0x70
argument_list|)
expr_stmt|;
comment|/* Set RF mode to standby mode. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|nrxchains
condition|;
name|i
operator|++
control|)
block|{
name|rf_ac
index|[
name|i
index|]
operator|=
name|urtwn_rf_read
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|R92C_RF_AC
argument_list|)
expr_stmt|;
name|urtwn_rf_write
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|R92C_RF_AC
argument_list|,
name|RW
argument_list|(
name|rf_ac
index|[
name|i
index|]
argument_list|,
name|R92C_RF_AC_MODE
argument_list|,
name|R92C_RF_AC_MODE_STANDBY
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* Block all Tx queues. */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_TXPAUSE
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
block|}
comment|/* Start calibration. */
name|urtwn_rf_write
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
name|R92C_RF_CHNLBW
argument_list|,
name|urtwn_rf_read
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
name|R92C_RF_CHNLBW
argument_list|)
operator||
name|R92C_RF_CHNLBW_LCSTART
argument_list|)
expr_stmt|;
comment|/* Give calibration the time to complete. */
name|usb_pause_mtx
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|,
literal|100
argument_list|)
expr_stmt|;
comment|/* Restore configuration. */
if|if
condition|(
operator|(
name|txmode
operator|&
literal|0x70
operator|)
operator|!=
literal|0
condition|)
block|{
comment|/* Restore Tx mode. */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM1_LSTF
operator|+
literal|3
argument_list|,
name|txmode
argument_list|)
expr_stmt|;
comment|/* Restore RF mode. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|nrxchains
condition|;
name|i
operator|++
control|)
name|urtwn_rf_write
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|R92C_RF_AC
argument_list|,
name|rf_ac
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Unblock all Tx queues. */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_TXPAUSE
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_init_locked
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|urtwn_softc
modifier|*
name|sc
init|=
name|arg
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|uint32_t
name|reg
decl_stmt|;
name|int
name|error
decl_stmt|;
name|URTWN_ASSERT_LOCKED
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
name|urtwn_stop_locked
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
comment|/* Init firmware commands ring. */
name|sc
operator|->
name|fwcur
operator|=
literal|0
expr_stmt|;
comment|/* Allocate Tx/Rx buffers. */
name|error
operator|=
name|urtwn_alloc_rx_list
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
name|error
operator|=
name|urtwn_alloc_tx_list
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
comment|/* Power on adapter. */
name|error
operator|=
name|urtwn_power_on
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
comment|/* Initialize DMA. */
name|error
operator|=
name|urtwn_dma_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
comment|/* Set info size in Rx descriptors (in 64-bit words). */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_RX_DRVINFO_SZ
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/* Init interrupts. */
if|if
condition|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
condition|)
block|{
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R88E_HISR
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R88E_HIMR
argument_list|,
name|R88E_HIMR_CPWM
operator||
name|R88E_HIMR_CPWM2
operator||
name|R88E_HIMR_TBDER
operator||
name|R88E_HIMR_PSTIMEOUT
argument_list|)
expr_stmt|;
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R88E_HIMRE
argument_list|,
name|R88E_HIMRE_RXFOVW
operator||
name|R88E_HIMRE_TXFOVW
operator||
name|R88E_HIMRE_RXERR
operator||
name|R88E_HIMRE_TXERR
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_USB_SPECIAL_OPTION
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_USB_SPECIAL_OPTION
argument_list|)
operator||
name|R92C_USB_SPECIAL_OPTION_INT_BULK_SEL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_HISR
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_HIMR
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
block|}
comment|/* Set MAC address. */
name|urtwn_write_region_1
argument_list|(
name|sc
argument_list|,
name|R92C_MACID
argument_list|,
name|IF_LLADDR
argument_list|(
name|ifp
argument_list|)
argument_list|,
name|IEEE80211_ADDR_LEN
argument_list|)
expr_stmt|;
comment|/* Set initial network type. */
name|reg
operator|=
name|urtwn_read_4
argument_list|(
name|sc
argument_list|,
name|R92C_CR
argument_list|)
expr_stmt|;
name|reg
operator|=
name|RW
argument_list|(
name|reg
argument_list|,
name|R92C_CR_NETTYPE
argument_list|,
name|R92C_CR_NETTYPE_INFRA
argument_list|)
expr_stmt|;
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_CR
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|urtwn_rxfilter_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|reg
operator|=
name|urtwn_read_4
argument_list|(
name|sc
argument_list|,
name|R92C_RRSR
argument_list|)
expr_stmt|;
name|reg
operator|=
name|RW
argument_list|(
name|reg
argument_list|,
name|R92C_RRSR_RATE_BITMAP
argument_list|,
name|R92C_RRSR_RATE_CCK_ONLY_1M
argument_list|)
expr_stmt|;
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_RRSR
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Set short/long retry limits. */
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_RL
argument_list|,
name|SM
argument_list|(
name|R92C_RL_SRL
argument_list|,
literal|0x30
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_RL_LRL
argument_list|,
literal|0x30
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Initialize EDCA parameters. */
name|urtwn_edca_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Setup rate fallback. */
if|if
condition|(
operator|!
operator|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
operator|)
condition|)
block|{
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_DARFRC
operator|+
literal|0
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_DARFRC
operator|+
literal|4
argument_list|,
literal|0x10080404
argument_list|)
expr_stmt|;
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_RARFRC
operator|+
literal|0
argument_list|,
literal|0x04030201
argument_list|)
expr_stmt|;
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_RARFRC
operator|+
literal|4
argument_list|,
literal|0x08070605
argument_list|)
expr_stmt|;
block|}
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_FWHW_TXQ_CTRL
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_FWHW_TXQ_CTRL
argument_list|)
operator||
name|R92C_FWHW_TXQ_CTRL_AMPDU_RTY_NEW
argument_list|)
expr_stmt|;
comment|/* Set ACK timeout. */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_ACKTO
argument_list|,
literal|0x40
argument_list|)
expr_stmt|;
comment|/* Setup USB aggregation. */
name|reg
operator|=
name|urtwn_read_4
argument_list|(
name|sc
argument_list|,
name|R92C_TDECTRL
argument_list|)
expr_stmt|;
name|reg
operator|=
name|RW
argument_list|(
name|reg
argument_list|,
name|R92C_TDECTRL_BLK_DESC_NUM
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_TDECTRL
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_TRXDMA_CTRL
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_TRXDMA_CTRL
argument_list|)
operator||
name|R92C_TRXDMA_CTRL_RXDMA_AGG_EN
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_USB_SPECIAL_OPTION
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_USB_SPECIAL_OPTION
argument_list|)
operator||
name|R92C_USB_SPECIAL_OPTION_AGG_EN
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_RXDMA_AGG_PG_TH
argument_list|,
literal|48
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
condition|)
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_RXDMA_AGG_PG_TH
operator|+
literal|1
argument_list|,
literal|4
argument_list|)
expr_stmt|;
else|else
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_USB_DMA_AGG_TO
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_USB_AGG_TH
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_USB_AGG_TO
argument_list|,
literal|6
argument_list|)
expr_stmt|;
comment|/* Initialize beacon parameters. */
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_BCN_CTRL
argument_list|,
literal|0x1010
argument_list|)
expr_stmt|;
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_TBTT_PROHIBIT
argument_list|,
literal|0x6404
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_DRVERLYINT
argument_list|,
literal|0x05
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_BCNDMATIM
argument_list|,
literal|0x02
argument_list|)
expr_stmt|;
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_BCNTCFG
argument_list|,
literal|0x660f
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
operator|)
condition|)
block|{
comment|/* Setup AMPDU aggregation. */
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_AGGLEN_LMT
argument_list|,
literal|0x99997631
argument_list|)
expr_stmt|;
comment|/* MCS7~0 */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_AGGR_BREAK_TIME
argument_list|,
literal|0x16
argument_list|)
expr_stmt|;
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_MAX_AGGR_NUM
argument_list|,
literal|0x0708
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_BCN_MAX_ERR
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
block|}
comment|/* Load 8051 microcode. */
name|error
operator|=
name|urtwn_load_firmware
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
comment|/* Initialize MAC/BB/RF blocks. */
name|urtwn_mac_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|urtwn_bb_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|urtwn_rf_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
condition|)
block|{
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_CR
argument_list|,
name|urtwn_read_2
argument_list|(
name|sc
argument_list|,
name|R92C_CR
argument_list|)
operator||
name|R92C_CR_MACTXEN
operator||
name|R92C_CR_MACRXEN
argument_list|)
expr_stmt|;
block|}
comment|/* Turn CCK and OFDM blocks on. */
name|reg
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_RFMOD
argument_list|)
expr_stmt|;
name|reg
operator||=
name|R92C_RFMOD_CCK_EN
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_RFMOD
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_RFMOD
argument_list|)
expr_stmt|;
name|reg
operator||=
name|R92C_RFMOD_OFDM_EN
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_RFMOD
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Clear per-station keys table. */
name|urtwn_cam_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Enable hardware sequence numbering. */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_HWSEQ_CTRL
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
comment|/* Perform LO and IQ calibrations. */
name|urtwn_iq_calib
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Perform LC calibration. */
name|urtwn_lc_calib
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Fix USB interference issue. */
if|if
condition|(
operator|!
operator|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
operator|)
condition|)
block|{
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
literal|0xfe40
argument_list|,
literal|0xe0
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
literal|0xfe41
argument_list|,
literal|0x8d
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
literal|0xfe42
argument_list|,
literal|0x80
argument_list|)
expr_stmt|;
name|urtwn_pa_bias_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
comment|/* Initialize GPIO setting. */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_GPIO_MUXCFG
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_GPIO_MUXCFG
argument_list|)
operator|&
operator|~
name|R92C_GPIO_MUXCFG_ENBT
argument_list|)
expr_stmt|;
comment|/* Fix for lower temperature. */
if|if
condition|(
operator|!
operator|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
operator|)
condition|)
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
literal|0x15
argument_list|,
literal|0xe9
argument_list|)
expr_stmt|;
name|usbd_transfer_start
argument_list|(
name|sc
operator|->
name|sc_xfer
index|[
name|URTWN_BULK_RX
index|]
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_OACTIVE
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator||=
name|IFF_DRV_RUNNING
expr_stmt|;
name|callout_reset
argument_list|(
operator|&
name|sc
operator|->
name|sc_watchdog_ch
argument_list|,
name|hz
argument_list|,
name|urtwn_watchdog
argument_list|,
name|sc
argument_list|)
expr_stmt|;
name|fail
label|:
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_init
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|urtwn_softc
modifier|*
name|sc
init|=
name|arg
decl_stmt|;
name|URTWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|urtwn_init_locked
argument_list|(
name|arg
argument_list|)
expr_stmt|;
name|URTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_stop_locked
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|struct
name|urtwn_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|URTWN_ASSERT_LOCKED
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
operator|(
name|IFF_DRV_RUNNING
operator||
name|IFF_DRV_OACTIVE
operator|)
expr_stmt|;
name|callout_stop
argument_list|(
operator|&
name|sc
operator|->
name|sc_watchdog_ch
argument_list|)
expr_stmt|;
name|urtwn_abort_xfers
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_stop
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|struct
name|urtwn_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|URTWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|urtwn_stop_locked
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|URTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_abort_xfers
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|URTWN_ASSERT_LOCKED
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* abort any pending transfers */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|URTWN_N_TRANSFER
condition|;
name|i
operator|++
control|)
name|usbd_transfer_stop
argument_list|(
name|sc
operator|->
name|sc_xfer
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|urtwn_raw_xmit
parameter_list|(
name|struct
name|ieee80211_node
modifier|*
name|ni
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
specifier|const
name|struct
name|ieee80211_bpf_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|ni
operator|->
name|ni_ic
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|ic
operator|->
name|ic_ifp
decl_stmt|;
name|struct
name|urtwn_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|urtwn_data
modifier|*
name|bf
decl_stmt|;
comment|/* prevent management frames from being sent if we're not ready */
if|if
condition|(
operator|!
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
condition|)
block|{
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|ieee80211_free_node
argument_list|(
name|ni
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENETDOWN
operator|)
return|;
block|}
name|URTWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|bf
operator|=
name|urtwn_getbuf
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|bf
operator|==
name|NULL
condition|)
block|{
name|ieee80211_free_node
argument_list|(
name|ni
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|URTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOBUFS
operator|)
return|;
block|}
name|ifp
operator|->
name|if_opackets
operator|++
expr_stmt|;
if|if
condition|(
name|urtwn_tx_start
argument_list|(
name|sc
argument_list|,
name|ni
argument_list|,
name|m
argument_list|,
name|bf
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|ieee80211_free_node
argument_list|(
name|ni
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_oerrors
operator|++
expr_stmt|;
name|STAILQ_INSERT_HEAD
argument_list|(
operator|&
name|sc
operator|->
name|sc_tx_inactive
argument_list|,
name|bf
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|URTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|EIO
operator|)
return|;
block|}
name|URTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_txtimer
operator|=
literal|5
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|device_method_t
name|urtwn_methods
index|[]
init|=
block|{
comment|/* Device interface */
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|urtwn_match
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|urtwn_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|urtwn_detach
argument_list|)
block|,
name|DEVMETHOD_END
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|urtwn_driver
init|=
block|{
literal|"urtwn"
block|,
name|urtwn_methods
block|,
expr|sizeof
operator|(
expr|struct
name|urtwn_softc
operator|)
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|urtwn_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|urtwn
argument_list|,
name|uhub
argument_list|,
name|urtwn_driver
argument_list|,
name|urtwn_devclass
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|urtwn
argument_list|,
name|usb
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|urtwn
argument_list|,
name|wlan
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|urtwn
argument_list|,
name|firmware
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_VERSION
argument_list|(
name|urtwn
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


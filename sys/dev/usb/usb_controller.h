begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* $FreeBSD$ */
end_comment

begin_comment
comment|/*-  * Copyright (c) 2008 Hans Petter Selasky. All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|_USB_CONTROLLER_H_
end_ifndef

begin_define
define|#
directive|define
name|_USB_CONTROLLER_H_
end_define

begin_comment
comment|/* defines */
end_comment

begin_define
define|#
directive|define
name|USB_BUS_DMA_TAG_MAX
value|8
end_define

begin_comment
comment|/* structure prototypes  */
end_comment

begin_struct_decl
struct_decl|struct
name|usb_bus
struct_decl|;
end_struct_decl

begin_struct_decl
struct_decl|struct
name|usb_page
struct_decl|;
end_struct_decl

begin_struct_decl
struct_decl|struct
name|usb_endpoint
struct_decl|;
end_struct_decl

begin_struct_decl
struct_decl|struct
name|usb_page_cache
struct_decl|;
end_struct_decl

begin_struct_decl
struct_decl|struct
name|usb_setup_params
struct_decl|;
end_struct_decl

begin_struct_decl
struct_decl|struct
name|usb_hw_ep_profile
struct_decl|;
end_struct_decl

begin_struct_decl
struct_decl|struct
name|usb_fs_isoc_schedule
struct_decl|;
end_struct_decl

begin_struct_decl
struct_decl|struct
name|usb_endpoint_descriptor
struct_decl|;
end_struct_decl

begin_comment
comment|/* typedefs */
end_comment

begin_typedef
typedef|typedef
name|void
function_decl|(
name|usb_bus_mem_sub_cb_t
function_decl|)
parameter_list|(
name|struct
name|usb_bus
modifier|*
name|bus
parameter_list|,
name|struct
name|usb_page_cache
modifier|*
name|pc
parameter_list|,
name|struct
name|usb_page
modifier|*
name|pg
parameter_list|,
name|usb_size_t
name|size
parameter_list|,
name|usb_size_t
name|align
parameter_list|)
function_decl|;
end_typedef

begin_typedef
typedef|typedef
name|void
function_decl|(
name|usb_bus_mem_cb_t
function_decl|)
parameter_list|(
name|struct
name|usb_bus
modifier|*
name|bus
parameter_list|,
name|usb_bus_mem_sub_cb_t
modifier|*
name|scb
parameter_list|)
function_decl|;
end_typedef

begin_comment
comment|/*  * The following structure is used to define all the USB BUS  * callbacks.  */
end_comment

begin_struct
struct|struct
name|usb_bus_methods
block|{
comment|/* USB Device and Host mode - Mandatory */
name|usb_handle_req_t
modifier|*
name|roothub_exec
decl_stmt|;
name|void
function_decl|(
modifier|*
name|endpoint_init
function_decl|)
parameter_list|(
name|struct
name|usb_device
modifier|*
parameter_list|,
name|struct
name|usb_endpoint_descriptor
modifier|*
parameter_list|,
name|struct
name|usb_endpoint
modifier|*
parameter_list|)
function_decl|;
name|void
function_decl|(
modifier|*
name|xfer_setup
function_decl|)
parameter_list|(
name|struct
name|usb_setup_params
modifier|*
parameter_list|)
function_decl|;
name|void
function_decl|(
modifier|*
name|xfer_unsetup
function_decl|)
parameter_list|(
name|struct
name|usb_xfer
modifier|*
parameter_list|)
function_decl|;
name|void
function_decl|(
modifier|*
name|get_dma_delay
function_decl|)
parameter_list|(
name|struct
name|usb_device
modifier|*
parameter_list|,
name|uint32_t
modifier|*
parameter_list|)
function_decl|;
name|void
function_decl|(
modifier|*
name|device_suspend
function_decl|)
parameter_list|(
name|struct
name|usb_device
modifier|*
parameter_list|)
function_decl|;
name|void
function_decl|(
modifier|*
name|device_resume
function_decl|)
parameter_list|(
name|struct
name|usb_device
modifier|*
parameter_list|)
function_decl|;
name|void
function_decl|(
modifier|*
name|set_hw_power
function_decl|)
parameter_list|(
name|struct
name|usb_bus
modifier|*
parameter_list|)
function_decl|;
name|void
function_decl|(
modifier|*
name|set_hw_power_sleep
function_decl|)
parameter_list|(
name|struct
name|usb_bus
modifier|*
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
comment|/* 	 * The following flag is set if one or more control transfers are 	 * active: 	 */
define|#
directive|define
name|USB_HW_POWER_CONTROL
value|0x01
comment|/* 	 * The following flag is set if one or more bulk transfers are 	 * active: 	 */
define|#
directive|define
name|USB_HW_POWER_BULK
value|0x02
comment|/* 	 * The following flag is set if one or more interrupt transfers are 	 * active: 	 */
define|#
directive|define
name|USB_HW_POWER_INTERRUPT
value|0x04
comment|/* 	 * The following flag is set if one or more isochronous transfers 	 * are active: 	 */
define|#
directive|define
name|USB_HW_POWER_ISOC
value|0x08
comment|/* 	 * The following flag is set if one or more non-root-HUB devices  	 * are present on the given USB bus: 	 */
define|#
directive|define
name|USB_HW_POWER_NON_ROOT_HUB
value|0x10
comment|/* 	 * The following flag is set if we are suspending 	 */
define|#
directive|define
name|USB_HW_POWER_SUSPEND
value|0x20
comment|/* 	 * The following flag is set if we are resuming 	 */
define|#
directive|define
name|USB_HW_POWER_RESUME
value|0x40
comment|/* 	 * The following flag is set if we are shutting down 	 */
define|#
directive|define
name|USB_HW_POWER_SHUTDOWN
value|0x60
comment|/* USB Device mode only - Mandatory */
name|void
function_decl|(
modifier|*
name|get_hw_ep_profile
function_decl|)
parameter_list|(
name|struct
name|usb_device
modifier|*
name|udev
parameter_list|,
specifier|const
name|struct
name|usb_hw_ep_profile
modifier|*
modifier|*
name|ppf
parameter_list|,
name|uint8_t
name|ep_addr
parameter_list|)
function_decl|;
name|void
function_decl|(
modifier|*
name|xfer_stall
function_decl|)
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|)
function_decl|;
name|void
function_decl|(
modifier|*
name|set_stall
function_decl|)
parameter_list|(
name|struct
name|usb_device
modifier|*
name|udev
parameter_list|,
name|struct
name|usb_endpoint
modifier|*
name|ep
parameter_list|,
name|uint8_t
modifier|*
name|did_stall
parameter_list|)
function_decl|;
comment|/* USB Device mode mandatory. USB Host mode optional. */
name|void
function_decl|(
modifier|*
name|clear_stall
function_decl|)
parameter_list|(
name|struct
name|usb_device
modifier|*
name|udev
parameter_list|,
name|struct
name|usb_endpoint
modifier|*
name|ep
parameter_list|)
function_decl|;
comment|/* Optional transfer polling support */
name|void
function_decl|(
modifier|*
name|xfer_poll
function_decl|)
parameter_list|(
name|struct
name|usb_bus
modifier|*
parameter_list|)
function_decl|;
comment|/* Optional fixed power mode support */
name|void
function_decl|(
modifier|*
name|get_power_mode
function_decl|)
parameter_list|(
name|struct
name|usb_device
modifier|*
name|udev
parameter_list|,
name|int8_t
modifier|*
name|pmode
parameter_list|)
function_decl|;
comment|/* Optional endpoint uninit */
name|void
function_decl|(
modifier|*
name|endpoint_uninit
function_decl|)
parameter_list|(
name|struct
name|usb_device
modifier|*
parameter_list|,
name|struct
name|usb_endpoint
modifier|*
parameter_list|)
function_decl|;
comment|/* Optional device init */
name|usb_error_t
function_decl|(
modifier|*
name|device_init
function_decl|)
parameter_list|(
name|struct
name|usb_device
modifier|*
parameter_list|)
function_decl|;
comment|/* Optional device uninit */
name|void
function_decl|(
modifier|*
name|device_uninit
function_decl|)
parameter_list|(
name|struct
name|usb_device
modifier|*
parameter_list|)
function_decl|;
comment|/* Optional for device and host mode */
name|void
function_decl|(
modifier|*
name|start_dma_delay
function_decl|)
parameter_list|(
name|struct
name|usb_xfer
modifier|*
parameter_list|)
function_decl|;
name|void
function_decl|(
modifier|*
name|device_state_change
function_decl|)
parameter_list|(
name|struct
name|usb_device
modifier|*
parameter_list|)
function_decl|;
comment|/* Optional for host mode */
name|usb_error_t
function_decl|(
modifier|*
name|set_address
function_decl|)
parameter_list|(
name|struct
name|usb_device
modifier|*
parameter_list|,
name|struct
name|mtx
modifier|*
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
comment|/* Optional for device and host mode */
name|usb_error_t
function_decl|(
modifier|*
name|set_endpoint_mode
function_decl|)
parameter_list|(
name|struct
name|usb_device
modifier|*
parameter_list|,
name|struct
name|usb_endpoint
modifier|*
parameter_list|,
name|uint8_t
parameter_list|)
function_decl|;
block|}
struct|;
end_struct

begin_comment
comment|/*  * The following structure is used to define all the USB pipe  * callbacks.  */
end_comment

begin_struct
struct|struct
name|usb_pipe_methods
block|{
comment|/* Mandatory USB Device and Host mode callbacks: */
name|void
function_decl|(
modifier|*
name|open
function_decl|)
parameter_list|(
name|struct
name|usb_xfer
modifier|*
parameter_list|)
function_decl|;
name|void
function_decl|(
modifier|*
name|close
function_decl|)
parameter_list|(
name|struct
name|usb_xfer
modifier|*
parameter_list|)
function_decl|;
name|void
function_decl|(
modifier|*
name|enter
function_decl|)
parameter_list|(
name|struct
name|usb_xfer
modifier|*
parameter_list|)
function_decl|;
name|void
function_decl|(
modifier|*
name|start
function_decl|)
parameter_list|(
name|struct
name|usb_xfer
modifier|*
parameter_list|)
function_decl|;
comment|/* Optional */
name|void
modifier|*
name|info
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/*  * The following structure keeps information about what a hardware USB  * endpoint supports.  */
end_comment

begin_struct
struct|struct
name|usb_hw_ep_profile
block|{
name|uint16_t
name|max_in_frame_size
decl_stmt|;
comment|/* IN-token direction */
name|uint16_t
name|max_out_frame_size
decl_stmt|;
comment|/* OUT-token direction */
name|uint8_t
name|is_simplex
range|:
literal|1
decl_stmt|;
name|uint8_t
name|support_multi_buffer
range|:
literal|1
decl_stmt|;
name|uint8_t
name|support_bulk
range|:
literal|1
decl_stmt|;
name|uint8_t
name|support_control
range|:
literal|1
decl_stmt|;
name|uint8_t
name|support_interrupt
range|:
literal|1
decl_stmt|;
name|uint8_t
name|support_isochronous
range|:
literal|1
decl_stmt|;
name|uint8_t
name|support_in
range|:
literal|1
decl_stmt|;
comment|/* IN-token is supported */
name|uint8_t
name|support_out
range|:
literal|1
decl_stmt|;
comment|/* OUT-token is supported */
block|}
struct|;
end_struct

begin_comment
comment|/* prototypes */
end_comment

begin_function_decl
name|void
name|usb_bus_mem_flush_all
parameter_list|(
name|struct
name|usb_bus
modifier|*
name|bus
parameter_list|,
name|usb_bus_mem_cb_t
modifier|*
name|cb
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|uint8_t
name|usb_bus_mem_alloc_all
parameter_list|(
name|struct
name|usb_bus
modifier|*
name|bus
parameter_list|,
name|bus_dma_tag_t
name|dmat
parameter_list|,
name|usb_bus_mem_cb_t
modifier|*
name|cb
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|usb_bus_mem_free_all
parameter_list|(
name|struct
name|usb_bus
modifier|*
name|bus
parameter_list|,
name|usb_bus_mem_cb_t
modifier|*
name|cb
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|uint16_t
name|usb_isoc_time_expand
parameter_list|(
name|struct
name|usb_bus
modifier|*
name|bus
parameter_list|,
name|uint16_t
name|isoc_time_curr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|usb_bus_reset_async_locked
parameter_list|(
name|struct
name|usb_bus
modifier|*
name|bus
parameter_list|)
function_decl|;
end_function_decl

begin_if
if|#
directive|if
name|USB_HAVE_TT_SUPPORT
end_if

begin_function_decl
name|uint8_t
name|usbd_fs_isoc_schedule_alloc_slot
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|isoc_xfer
parameter_list|,
name|uint16_t
name|isoc_time
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* _USB_CONTROLLER_H_ */
end_comment

end_unit


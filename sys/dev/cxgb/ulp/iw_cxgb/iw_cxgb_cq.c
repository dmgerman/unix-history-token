begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/**************************************************************************  Copyright (c) 2007, Chelsio Inc. All rights reserved.  Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:   1. Redistributions of source code must retain the above copyright notice,     this list of conditions and the following disclaimer.   2. Neither the name of the Chelsio Corporation nor the names of its     contributors may be used to endorse or promote products derived from     this software without specific prior written permission.  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  ***************************************************************************/
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/pciio.h>
end_include

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus_dma.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioccom.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<sys/rwlock.h>
end_include

begin_include
include|#
directive|include
file|<sys/linker.h>
end_include

begin_include
include|#
directive|include
file|<sys/firmware.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_include
include|#
directive|include
file|<sys/smp.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/syslog.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<sys/taskqueue.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<sys/libkern.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<contrib/rdma/ib_verbs.h>
end_include

begin_include
include|#
directive|include
file|<contrib/rdma/ib_umem.h>
end_include

begin_include
include|#
directive|include
file|<contrib/rdma/ib_user_verbs.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_DEFINED
end_ifdef

begin_include
include|#
directive|include
file|<cxgb_include.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_wr.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_hal.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_provider.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_cm.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_resource.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_user.h>
end_include

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<dev/cxgb/cxgb_include.h>
end_include

begin_include
include|#
directive|include
file|<dev/cxgb/ulp/iw_cxgb/iw_cxgb_wr.h>
end_include

begin_include
include|#
directive|include
file|<dev/cxgb/ulp/iw_cxgb/iw_cxgb_hal.h>
end_include

begin_include
include|#
directive|include
file|<dev/cxgb/ulp/iw_cxgb/iw_cxgb_provider.h>
end_include

begin_include
include|#
directive|include
file|<dev/cxgb/ulp/iw_cxgb/iw_cxgb_cm.h>
end_include

begin_include
include|#
directive|include
file|<dev/cxgb/ulp/iw_cxgb/iw_cxgb.h>
end_include

begin_include
include|#
directive|include
file|<dev/cxgb/ulp/iw_cxgb/iw_cxgb_resource.h>
end_include

begin_include
include|#
directive|include
file|<dev/cxgb/ulp/iw_cxgb/iw_cxgb_user.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * Get one cq entry from cxio and map it to openib.  *  * Returns:  *	0			cqe returned  *	-ENOBUFS		EMPTY;  *	-EAGAIN		        caller must try again  *	any other neg errno	fatal error  */
end_comment

begin_function
specifier|static
name|int
name|iwch_poll_cq_one
parameter_list|(
name|struct
name|iwch_dev
modifier|*
name|rhp
parameter_list|,
name|struct
name|iwch_cq
modifier|*
name|chp
parameter_list|,
name|struct
name|ib_wc
modifier|*
name|wc
parameter_list|)
block|{
name|struct
name|iwch_qp
modifier|*
name|qhp
init|=
name|NULL
decl_stmt|;
name|struct
name|t3_cqe
name|cqe
decl_stmt|,
modifier|*
name|rd_cqe
decl_stmt|;
name|struct
name|t3_wq
modifier|*
name|wq
decl_stmt|;
name|u32
name|credit
init|=
literal|0
decl_stmt|;
name|u8
name|cqe_flushed
decl_stmt|;
name|u64
name|cookie
decl_stmt|;
name|int
name|ret
init|=
literal|1
decl_stmt|;
name|rd_cqe
operator|=
name|cxio_next_cqe
argument_list|(
operator|&
name|chp
operator|->
name|cq
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rd_cqe
condition|)
return|return
literal|0
return|;
name|qhp
operator|=
name|get_qhp
argument_list|(
name|rhp
argument_list|,
name|CQE_QPID
argument_list|(
operator|*
name|rd_cqe
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|qhp
condition|)
name|wq
operator|=
name|NULL
expr_stmt|;
else|else
block|{
name|mtx_lock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
name|wq
operator|=
operator|&
operator|(
name|qhp
operator|->
name|wq
operator|)
expr_stmt|;
block|}
name|ret
operator|=
name|cxio_poll_cq
argument_list|(
name|wq
argument_list|,
operator|&
operator|(
name|chp
operator|->
name|cq
operator|)
argument_list|,
operator|&
name|cqe
argument_list|,
operator|&
name|cqe_flushed
argument_list|,
operator|&
name|cookie
argument_list|,
operator|&
name|credit
argument_list|)
expr_stmt|;
if|if
condition|(
name|t3a_device
argument_list|(
name|chp
operator|->
name|rhp
argument_list|)
operator|&&
name|credit
condition|)
block|{
name|CTR3
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s updating %d cq credits on id %d"
argument_list|,
name|__FUNCTION__
argument_list|,
name|credit
argument_list|,
name|chp
operator|->
name|cq
operator|.
name|cqid
argument_list|)
expr_stmt|;
name|cxio_hal_cq_op
argument_list|(
operator|&
name|rhp
operator|->
name|rdev
argument_list|,
operator|&
name|chp
operator|->
name|cq
argument_list|,
name|CQ_CREDIT_UPDATE
argument_list|,
name|credit
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ret
condition|)
block|{
name|ret
operator|=
operator|-
name|EAGAIN
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
literal|1
expr_stmt|;
name|wc
operator|->
name|wr_id
operator|=
name|cookie
expr_stmt|;
name|wc
operator|->
name|qp
operator|=
operator|&
name|qhp
operator|->
name|ibqp
expr_stmt|;
name|wc
operator|->
name|vendor_err
operator|=
name|CQE_STATUS
argument_list|(
name|cqe
argument_list|)
expr_stmt|;
name|CTR4
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"iwch_poll_cq_one qpid 0x%x type %d opcode %d status 0x%x"
argument_list|,
name|CQE_QPID
argument_list|(
name|cqe
argument_list|)
argument_list|,
name|CQE_TYPE
argument_list|(
name|cqe
argument_list|)
argument_list|,
name|CQE_OPCODE
argument_list|(
name|cqe
argument_list|)
argument_list|,
name|CQE_STATUS
argument_list|(
name|cqe
argument_list|)
argument_list|)
expr_stmt|;
name|CTR3
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"wrid hi 0x%x lo 0x%x cookie 0x%llx"
argument_list|,
name|CQE_WRID_HI
argument_list|(
name|cqe
argument_list|)
argument_list|,
name|CQE_WRID_LOW
argument_list|(
name|cqe
argument_list|)
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|cookie
argument_list|)
expr_stmt|;
if|if
condition|(
name|CQE_TYPE
argument_list|(
name|cqe
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|CQE_STATUS
argument_list|(
name|cqe
argument_list|)
condition|)
name|wc
operator|->
name|byte_len
operator|=
name|CQE_LEN
argument_list|(
name|cqe
argument_list|)
expr_stmt|;
else|else
name|wc
operator|->
name|byte_len
operator|=
literal|0
expr_stmt|;
name|wc
operator|->
name|opcode
operator|=
name|IB_WC_RECV
expr_stmt|;
block|}
else|else
block|{
switch|switch
condition|(
name|CQE_OPCODE
argument_list|(
name|cqe
argument_list|)
condition|)
block|{
case|case
name|T3_RDMA_WRITE
case|:
name|wc
operator|->
name|opcode
operator|=
name|IB_WC_RDMA_WRITE
expr_stmt|;
break|break;
case|case
name|T3_READ_REQ
case|:
name|wc
operator|->
name|opcode
operator|=
name|IB_WC_RDMA_READ
expr_stmt|;
name|wc
operator|->
name|byte_len
operator|=
name|CQE_LEN
argument_list|(
name|cqe
argument_list|)
expr_stmt|;
break|break;
case|case
name|T3_SEND
case|:
case|case
name|T3_SEND_WITH_SE
case|:
name|wc
operator|->
name|opcode
operator|=
name|IB_WC_SEND
expr_stmt|;
break|break;
case|case
name|T3_BIND_MW
case|:
name|wc
operator|->
name|opcode
operator|=
name|IB_WC_BIND_MW
expr_stmt|;
break|break;
comment|/* these aren't supported yet */
case|case
name|T3_SEND_WITH_INV
case|:
case|case
name|T3_SEND_WITH_SE_INV
case|:
case|case
name|T3_LOCAL_INV
case|:
case|case
name|T3_FAST_REGISTER
case|:
default|default:
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"Unexpected opcode %d "
literal|"in the CQE received for QPID=0x%0x\n"
argument_list|,
name|CQE_OPCODE
argument_list|(
name|cqe
argument_list|)
argument_list|,
name|CQE_QPID
argument_list|(
name|cqe
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
if|if
condition|(
name|cqe_flushed
condition|)
name|wc
operator|->
name|status
operator|=
name|IB_WC_WR_FLUSH_ERR
expr_stmt|;
else|else
block|{
switch|switch
condition|(
name|CQE_STATUS
argument_list|(
name|cqe
argument_list|)
condition|)
block|{
case|case
name|TPT_ERR_SUCCESS
case|:
name|wc
operator|->
name|status
operator|=
name|IB_WC_SUCCESS
expr_stmt|;
break|break;
case|case
name|TPT_ERR_STAG
case|:
name|wc
operator|->
name|status
operator|=
name|IB_WC_LOC_ACCESS_ERR
expr_stmt|;
break|break;
case|case
name|TPT_ERR_PDID
case|:
name|wc
operator|->
name|status
operator|=
name|IB_WC_LOC_PROT_ERR
expr_stmt|;
break|break;
case|case
name|TPT_ERR_QPID
case|:
case|case
name|TPT_ERR_ACCESS
case|:
name|wc
operator|->
name|status
operator|=
name|IB_WC_LOC_ACCESS_ERR
expr_stmt|;
break|break;
case|case
name|TPT_ERR_WRAP
case|:
name|wc
operator|->
name|status
operator|=
name|IB_WC_GENERAL_ERR
expr_stmt|;
break|break;
case|case
name|TPT_ERR_BOUND
case|:
name|wc
operator|->
name|status
operator|=
name|IB_WC_LOC_LEN_ERR
expr_stmt|;
break|break;
case|case
name|TPT_ERR_INVALIDATE_SHARED_MR
case|:
case|case
name|TPT_ERR_INVALIDATE_MR_WITH_MW_BOUND
case|:
name|wc
operator|->
name|status
operator|=
name|IB_WC_MW_BIND_ERR
expr_stmt|;
break|break;
case|case
name|TPT_ERR_CRC
case|:
case|case
name|TPT_ERR_MARKER
case|:
case|case
name|TPT_ERR_PDU_LEN_ERR
case|:
case|case
name|TPT_ERR_OUT_OF_RQE
case|:
case|case
name|TPT_ERR_DDP_VERSION
case|:
case|case
name|TPT_ERR_RDMA_VERSION
case|:
case|case
name|TPT_ERR_DDP_QUEUE_NUM
case|:
case|case
name|TPT_ERR_MSN
case|:
case|case
name|TPT_ERR_TBIT
case|:
case|case
name|TPT_ERR_MO
case|:
case|case
name|TPT_ERR_MSN_RANGE
case|:
case|case
name|TPT_ERR_IRD_OVERFLOW
case|:
case|case
name|TPT_ERR_OPCODE
case|:
name|wc
operator|->
name|status
operator|=
name|IB_WC_FATAL_ERR
expr_stmt|;
break|break;
case|case
name|TPT_ERR_SWFLUSH
case|:
name|wc
operator|->
name|status
operator|=
name|IB_WC_WR_FLUSH_ERR
expr_stmt|;
break|break;
default|default:
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"Unexpected cqe_status 0x%x for "
literal|"QPID=0x%0x\n"
argument_list|,
name|CQE_STATUS
argument_list|(
name|cqe
argument_list|)
argument_list|,
name|CQE_QPID
argument_list|(
name|cqe
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
block|}
block|}
name|out
label|:
if|if
condition|(
name|wq
condition|)
name|mtx_unlock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|iwch_poll_cq
parameter_list|(
name|struct
name|ib_cq
modifier|*
name|ibcq
parameter_list|,
name|int
name|num_entries
parameter_list|,
name|struct
name|ib_wc
modifier|*
name|wc
parameter_list|)
block|{
name|struct
name|iwch_dev
modifier|*
name|rhp
decl_stmt|;
name|struct
name|iwch_cq
modifier|*
name|chp
decl_stmt|;
name|int
name|npolled
decl_stmt|;
name|int
name|err
init|=
literal|0
decl_stmt|;
name|chp
operator|=
name|to_iwch_cq
argument_list|(
name|ibcq
argument_list|)
expr_stmt|;
name|rhp
operator|=
name|chp
operator|->
name|rhp
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|chp
operator|->
name|lock
argument_list|)
expr_stmt|;
for|for
control|(
name|npolled
operator|=
literal|0
init|;
name|npolled
operator|<
name|num_entries
condition|;
operator|++
name|npolled
control|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|int
name|i
init|=
literal|0
decl_stmt|;
endif|#
directive|endif
comment|/* 		 * Because T3 can post CQEs that are _not_ associated 		 * with a WR, we might have to poll again after removing 		 * one of these. 		 */
do|do
block|{
name|err
operator|=
name|iwch_poll_cq_one
argument_list|(
name|rhp
argument_list|,
name|chp
argument_list|,
name|wc
operator|+
name|npolled
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|PANIC_IF
argument_list|(
operator|++
name|i
operator|>
literal|1000
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
do|while
condition|(
name|err
operator|==
operator|-
name|EAGAIN
condition|)
do|;
if|if
condition|(
name|err
operator|<=
literal|0
condition|)
break|break;
block|}
name|mtx_unlock
argument_list|(
operator|&
name|chp
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|<
literal|0
condition|)
block|{
return|return
name|err
return|;
block|}
else|else
block|{
return|return
name|npolled
return|;
block|}
block|}
end_function

end_unit


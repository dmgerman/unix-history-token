begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/**************************************************************************  Copyright (c) 2007, Chelsio Inc. All rights reserved.  Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:   1. Redistributions of source code must retain the above copyright notice,     this list of conditions and the following disclaimer.   2. Neither the name of the Chelsio Corporation nor the names of its     contributors may be used to endorse or promote products derived from     this software without specific prior written permission.  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  ***************************************************************************/
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/pciio.h>
end_include

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus_dma.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioccom.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<sys/rwlock.h>
end_include

begin_include
include|#
directive|include
file|<sys/linker.h>
end_include

begin_include
include|#
directive|include
file|<sys/firmware.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_include
include|#
directive|include
file|<sys/smp.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/syslog.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<sys/taskqueue.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<sys/libkern.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<contrib/rdma/ib_verbs.h>
end_include

begin_include
include|#
directive|include
file|<contrib/rdma/ib_umem.h>
end_include

begin_include
include|#
directive|include
file|<contrib/rdma/ib_user_verbs.h>
end_include

begin_include
include|#
directive|include
file|<cxgb_include.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_wr.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_hal.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_provider.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_cm.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_resource.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_user.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|needed
end_ifdef

begin_decl_stmt
specifier|static
name|struct
name|buf_ring
modifier|*
name|rhdl_fifo
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|mtx
name|rhdl_fifo_lock
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|RANDOM_SIZE
value|16
end_define

begin_function
specifier|static
name|int
name|__cxio_init_resource_fifo
parameter_list|(
name|struct
name|buf_ring
modifier|*
modifier|*
name|fifo
parameter_list|,
name|struct
name|mtx
modifier|*
name|fifo_lock
parameter_list|,
name|u32
name|nr
parameter_list|,
name|u32
name|skip_low
parameter_list|,
name|u32
name|skip_high
parameter_list|,
name|int
name|randomize
parameter_list|)
block|{
name|u32
name|i
decl_stmt|,
name|j
decl_stmt|,
name|idx
decl_stmt|;
name|u32
name|random_bytes
decl_stmt|;
name|u32
name|rarray
index|[
literal|16
index|]
decl_stmt|;
name|mtx_init
argument_list|(
name|fifo_lock
argument_list|,
literal|"cxio fifo"
argument_list|,
name|NULL
argument_list|,
name|MTX_DEF
operator||
name|MTX_DUPOK
argument_list|)
expr_stmt|;
operator|*
name|fifo
operator|=
name|buf_ring_alloc
argument_list|(
name|nr
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
argument_list|,
name|fifo_lock
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|fifo
operator|==
name|NULL
condition|)
return|return
operator|(
operator|-
name|ENOMEM
operator|)
return|;
if|#
directive|if
literal|0
block|for (i = 0; i< skip_low + skip_high; i++) { 		u32 entry = 0; 		 		buf_ring_enqueue(*fifo, (uintptr_t) entry); 	}
endif|#
directive|endif
if|if
condition|(
name|randomize
condition|)
block|{
name|j
operator|=
literal|0
expr_stmt|;
name|random_bytes
operator|=
name|random
argument_list|()
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RANDOM_SIZE
condition|;
name|i
operator|++
control|)
name|rarray
index|[
name|i
index|]
operator|=
name|i
operator|+
name|skip_low
expr_stmt|;
for|for
control|(
name|i
operator|=
name|skip_low
operator|+
name|RANDOM_SIZE
init|;
name|i
operator|<
name|nr
operator|-
name|skip_high
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|j
operator|>=
name|RANDOM_SIZE
condition|)
block|{
name|j
operator|=
literal|0
expr_stmt|;
name|random_bytes
operator|=
name|random
argument_list|()
expr_stmt|;
block|}
name|idx
operator|=
operator|(
name|random_bytes
operator|>>
operator|(
name|j
operator|*
literal|2
operator|)
operator|)
operator|&
literal|0xF
expr_stmt|;
name|buf_ring_enqueue
argument_list|(
operator|*
name|fifo
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|rarray
index|[
name|idx
index|]
argument_list|)
expr_stmt|;
name|rarray
index|[
name|idx
index|]
operator|=
name|i
expr_stmt|;
name|j
operator|++
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RANDOM_SIZE
condition|;
name|i
operator|++
control|)
name|buf_ring_enqueue
argument_list|(
operator|*
name|fifo
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|rarray
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
else|else
for|for
control|(
name|i
operator|=
name|skip_low
init|;
name|i
operator|<
name|nr
operator|-
name|skip_high
condition|;
name|i
operator|++
control|)
name|buf_ring_enqueue
argument_list|(
operator|*
name|fifo
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|i
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|for (i = 0; i< skip_low + skip_high; i++) 		buf_ring_dequeue_sc(*fifo);
endif|#
directive|endif
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cxio_init_resource_fifo
parameter_list|(
name|struct
name|buf_ring
modifier|*
modifier|*
name|fifo
parameter_list|,
name|struct
name|mtx
modifier|*
name|fifo_lock
parameter_list|,
name|u32
name|nr
parameter_list|,
name|u32
name|skip_low
parameter_list|,
name|u32
name|skip_high
parameter_list|)
block|{
return|return
operator|(
name|__cxio_init_resource_fifo
argument_list|(
name|fifo
argument_list|,
name|fifo_lock
argument_list|,
name|nr
argument_list|,
name|skip_low
argument_list|,
name|skip_high
argument_list|,
literal|0
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cxio_init_resource_fifo_random
parameter_list|(
name|struct
name|buf_ring
modifier|*
modifier|*
name|fifo
parameter_list|,
name|struct
name|mtx
modifier|*
name|fifo_lock
parameter_list|,
name|u32
name|nr
parameter_list|,
name|u32
name|skip_low
parameter_list|,
name|u32
name|skip_high
parameter_list|)
block|{
return|return
operator|(
name|__cxio_init_resource_fifo
argument_list|(
name|fifo
argument_list|,
name|fifo_lock
argument_list|,
name|nr
argument_list|,
name|skip_low
argument_list|,
name|skip_high
argument_list|,
literal|1
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cxio_init_qpid_fifo
parameter_list|(
name|struct
name|cxio_rdev
modifier|*
name|rdev_p
parameter_list|)
block|{
name|u32
name|i
decl_stmt|;
name|mtx_init
argument_list|(
operator|&
name|rdev_p
operator|->
name|rscp
operator|->
name|qpid_fifo_lock
argument_list|,
literal|"qpid fifo"
argument_list|,
name|NULL
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
name|rdev_p
operator|->
name|rscp
operator|->
name|qpid_fifo
operator|=
name|buf_ring_alloc
argument_list|(
name|T3_MAX_NUM_QP
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
argument_list|,
operator|&
name|rdev_p
operator|->
name|rscp
operator|->
name|qpid_fifo_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev_p
operator|->
name|rscp
operator|->
name|qpid_fifo
operator|==
name|NULL
condition|)
return|return
operator|(
operator|-
name|ENOMEM
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|16
init|;
name|i
operator|<
name|T3_MAX_NUM_QP
condition|;
name|i
operator|++
control|)
if|if
condition|(
operator|!
operator|(
name|i
operator|&
name|rdev_p
operator|->
name|qpmask
operator|)
condition|)
name|buf_ring_enqueue
argument_list|(
name|rdev_p
operator|->
name|rscp
operator|->
name|qpid_fifo
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|i
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|needed
end_ifdef

begin_function
name|int
name|cxio_hal_init_rhdl_resource
parameter_list|(
name|u32
name|nr_rhdl
parameter_list|)
block|{
return|return
name|cxio_init_resource_fifo
argument_list|(
operator|&
name|rhdl_fifo
argument_list|,
operator|&
name|rhdl_fifo_lock
argument_list|,
name|nr_rhdl
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|cxio_hal_destroy_rhdl_resource
parameter_list|(
name|void
parameter_list|)
block|{
name|buf_ring_free
argument_list|(
name|rhdl_fifo
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* nr_* must be power of 2 */
end_comment

begin_function
name|int
name|cxio_hal_init_resource
parameter_list|(
name|struct
name|cxio_rdev
modifier|*
name|rdev_p
parameter_list|,
name|u32
name|nr_tpt
parameter_list|,
name|u32
name|nr_pbl
parameter_list|,
name|u32
name|nr_rqt
parameter_list|,
name|u32
name|nr_qpid
parameter_list|,
name|u32
name|nr_cqid
parameter_list|,
name|u32
name|nr_pdid
parameter_list|)
block|{
name|int
name|err
init|=
literal|0
decl_stmt|;
name|struct
name|cxio_hal_resource
modifier|*
name|rscp
decl_stmt|;
name|rscp
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|rscp
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rscp
condition|)
return|return
operator|(
operator|-
name|ENOMEM
operator|)
return|;
name|rdev_p
operator|->
name|rscp
operator|=
name|rscp
expr_stmt|;
name|err
operator|=
name|cxio_init_resource_fifo_random
argument_list|(
operator|&
name|rscp
operator|->
name|tpt_fifo
argument_list|,
operator|&
name|rscp
operator|->
name|tpt_fifo_lock
argument_list|,
name|nr_tpt
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|tpt_err
goto|;
name|err
operator|=
name|cxio_init_qpid_fifo
argument_list|(
name|rdev_p
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|qpid_err
goto|;
name|err
operator|=
name|cxio_init_resource_fifo
argument_list|(
operator|&
name|rscp
operator|->
name|cqid_fifo
argument_list|,
operator|&
name|rscp
operator|->
name|cqid_fifo_lock
argument_list|,
name|nr_cqid
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|cqid_err
goto|;
name|err
operator|=
name|cxio_init_resource_fifo
argument_list|(
operator|&
name|rscp
operator|->
name|pdid_fifo
argument_list|,
operator|&
name|rscp
operator|->
name|pdid_fifo_lock
argument_list|,
name|nr_pdid
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|pdid_err
goto|;
return|return
literal|0
return|;
name|pdid_err
label|:
name|buf_ring_free
argument_list|(
name|rscp
operator|->
name|cqid_fifo
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|cqid_err
label|:
name|buf_ring_free
argument_list|(
name|rscp
operator|->
name|qpid_fifo
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|qpid_err
label|:
name|buf_ring_free
argument_list|(
name|rscp
operator|->
name|tpt_fifo
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|tpt_err
label|:
return|return
operator|(
operator|-
name|ENOMEM
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * returns 0 if no resource available  */
end_comment

begin_function
specifier|static
name|u32
name|cxio_hal_get_resource
parameter_list|(
name|struct
name|buf_ring
modifier|*
name|fifo
parameter_list|,
name|struct
name|mtx
modifier|*
name|lock
parameter_list|)
block|{
name|u32
name|entry
decl_stmt|;
name|mtx_lock
argument_list|(
name|lock
argument_list|)
expr_stmt|;
name|entry
operator|=
operator|(
name|u32
operator|)
operator|(
name|uintptr_t
operator|)
name|buf_ring_dequeue_sc
argument_list|(
name|fifo
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
name|lock
argument_list|)
expr_stmt|;
return|return
name|entry
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|cxio_hal_put_resource
parameter_list|(
name|struct
name|buf_ring
modifier|*
name|fifo
parameter_list|,
name|u32
name|entry
parameter_list|,
name|struct
name|mtx
modifier|*
name|lock
parameter_list|)
block|{
name|mtx_lock
argument_list|(
name|lock
argument_list|)
expr_stmt|;
name|buf_ring_enqueue
argument_list|(
name|fifo
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|entry
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
name|lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|u32
name|cxio_hal_get_stag
parameter_list|(
name|struct
name|cxio_hal_resource
modifier|*
name|rscp
parameter_list|)
block|{
return|return
name|cxio_hal_get_resource
argument_list|(
name|rscp
operator|->
name|tpt_fifo
argument_list|,
operator|&
name|rscp
operator|->
name|tpt_fifo_lock
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|cxio_hal_put_stag
parameter_list|(
name|struct
name|cxio_hal_resource
modifier|*
name|rscp
parameter_list|,
name|u32
name|stag
parameter_list|)
block|{
name|cxio_hal_put_resource
argument_list|(
name|rscp
operator|->
name|tpt_fifo
argument_list|,
name|stag
argument_list|,
operator|&
name|rscp
operator|->
name|tpt_fifo_lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|u32
name|cxio_hal_get_qpid
parameter_list|(
name|struct
name|cxio_hal_resource
modifier|*
name|rscp
parameter_list|)
block|{
name|u32
name|qpid
init|=
name|cxio_hal_get_resource
argument_list|(
name|rscp
operator|->
name|qpid_fifo
argument_list|,
operator|&
name|rscp
operator|->
name|qpid_fifo_lock
argument_list|)
decl_stmt|;
name|CTR2
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s qpid 0x%x"
argument_list|,
name|__FUNCTION__
argument_list|,
name|qpid
argument_list|)
expr_stmt|;
return|return
name|qpid
return|;
block|}
end_function

begin_function
name|void
name|cxio_hal_put_qpid
parameter_list|(
name|struct
name|cxio_hal_resource
modifier|*
name|rscp
parameter_list|,
name|u32
name|qpid
parameter_list|)
block|{
name|CTR2
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s qpid 0x%x"
argument_list|,
name|__FUNCTION__
argument_list|,
name|qpid
argument_list|)
expr_stmt|;
name|cxio_hal_put_resource
argument_list|(
name|rscp
operator|->
name|qpid_fifo
argument_list|,
name|qpid
argument_list|,
operator|&
name|rscp
operator|->
name|qpid_fifo_lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|u32
name|cxio_hal_get_cqid
parameter_list|(
name|struct
name|cxio_hal_resource
modifier|*
name|rscp
parameter_list|)
block|{
return|return
name|cxio_hal_get_resource
argument_list|(
name|rscp
operator|->
name|cqid_fifo
argument_list|,
operator|&
name|rscp
operator|->
name|cqid_fifo_lock
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|cxio_hal_put_cqid
parameter_list|(
name|struct
name|cxio_hal_resource
modifier|*
name|rscp
parameter_list|,
name|u32
name|cqid
parameter_list|)
block|{
name|cxio_hal_put_resource
argument_list|(
name|rscp
operator|->
name|cqid_fifo
argument_list|,
name|cqid
argument_list|,
operator|&
name|rscp
operator|->
name|cqid_fifo_lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|u32
name|cxio_hal_get_pdid
parameter_list|(
name|struct
name|cxio_hal_resource
modifier|*
name|rscp
parameter_list|)
block|{
return|return
name|cxio_hal_get_resource
argument_list|(
name|rscp
operator|->
name|pdid_fifo
argument_list|,
operator|&
name|rscp
operator|->
name|pdid_fifo_lock
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|cxio_hal_put_pdid
parameter_list|(
name|struct
name|cxio_hal_resource
modifier|*
name|rscp
parameter_list|,
name|u32
name|pdid
parameter_list|)
block|{
name|cxio_hal_put_resource
argument_list|(
name|rscp
operator|->
name|pdid_fifo
argument_list|,
name|pdid
argument_list|,
operator|&
name|rscp
operator|->
name|pdid_fifo_lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|cxio_hal_destroy_resource
parameter_list|(
name|struct
name|cxio_hal_resource
modifier|*
name|rscp
parameter_list|)
block|{
name|buf_ring_free
argument_list|(
name|rscp
operator|->
name|tpt_fifo
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|buf_ring_free
argument_list|(
name|rscp
operator|->
name|cqid_fifo
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|buf_ring_free
argument_list|(
name|rscp
operator|->
name|qpid_fifo
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|buf_ring_free
argument_list|(
name|rscp
operator|->
name|pdid_fifo
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|rscp
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * PBL Memory Manager.  Uses Linux generic allocator.  */
end_comment

begin_define
define|#
directive|define
name|MIN_PBL_SHIFT
value|8
end_define

begin_comment
comment|/* 256B == min PBL size (32 entries) */
end_comment

begin_define
define|#
directive|define
name|PBL_CHUNK
value|2*1024*1024
end_define

begin_function
name|u32
name|cxio_hal_pblpool_alloc
parameter_list|(
name|struct
name|cxio_rdev
modifier|*
name|rdev_p
parameter_list|,
name|int
name|size
parameter_list|)
block|{
name|unsigned
name|long
name|addr
init|=
name|gen_pool_alloc
argument_list|(
name|rdev_p
operator|->
name|pbl_pool
argument_list|,
name|size
argument_list|)
decl_stmt|;
name|CTR3
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s addr 0x%x size %d"
argument_list|,
name|__FUNCTION__
argument_list|,
operator|(
name|u32
operator|)
name|addr
argument_list|,
name|size
argument_list|)
expr_stmt|;
return|return
operator|(
name|u32
operator|)
name|addr
return|;
block|}
end_function

begin_function
name|void
name|cxio_hal_pblpool_free
parameter_list|(
name|struct
name|cxio_rdev
modifier|*
name|rdev_p
parameter_list|,
name|u32
name|addr
parameter_list|,
name|int
name|size
parameter_list|)
block|{
name|CTR3
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s addr 0x%x size %d"
argument_list|,
name|__FUNCTION__
argument_list|,
name|addr
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|gen_pool_free
argument_list|(
name|rdev_p
operator|->
name|pbl_pool
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|addr
argument_list|,
name|size
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|cxio_hal_pblpool_create
parameter_list|(
name|struct
name|cxio_rdev
modifier|*
name|rdev_p
parameter_list|)
block|{
name|rdev_p
operator|->
name|pbl_pool
operator|=
name|gen_pool_create
argument_list|(
name|rdev_p
operator|->
name|rnic_info
operator|.
name|pbl_base
argument_list|,
name|MIN_PBL_SHIFT
argument_list|,
name|rdev_p
operator|->
name|rnic_info
operator|.
name|pbl_top
operator|-
name|rdev_p
operator|->
name|rnic_info
operator|.
name|pbl_base
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|if (rdev_p->pbl_pool) { 		 		unsigned long i; 		for (i = rdev_p->rnic_info.pbl_base; 		     i<= rdev_p->rnic_info.pbl_top - PBL_CHUNK + 1; 		     i += PBL_CHUNK) 			gen_pool_add(rdev_p->pbl_pool, i, PBL_CHUNK, -1); 	}
endif|#
directive|endif
return|return
name|rdev_p
operator|->
name|pbl_pool
condition|?
literal|0
else|:
operator|(
operator|-
name|ENOMEM
operator|)
return|;
block|}
end_function

begin_function
name|void
name|cxio_hal_pblpool_destroy
parameter_list|(
name|struct
name|cxio_rdev
modifier|*
name|rdev_p
parameter_list|)
block|{
name|gen_pool_destroy
argument_list|(
name|rdev_p
operator|->
name|pbl_pool
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * RQT Memory Manager.  Uses Linux generic allocator.  */
end_comment

begin_define
define|#
directive|define
name|MIN_RQT_SHIFT
value|10
end_define

begin_comment
comment|/* 1KB == mini RQT size (16 entries) */
end_comment

begin_define
define|#
directive|define
name|RQT_CHUNK
value|2*1024*1024
end_define

begin_function
name|u32
name|cxio_hal_rqtpool_alloc
parameter_list|(
name|struct
name|cxio_rdev
modifier|*
name|rdev_p
parameter_list|,
name|int
name|size
parameter_list|)
block|{
name|unsigned
name|long
name|addr
init|=
name|gen_pool_alloc
argument_list|(
name|rdev_p
operator|->
name|rqt_pool
argument_list|,
name|size
operator|<<
literal|6
argument_list|)
decl_stmt|;
name|CTR3
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s addr 0x%x size %d"
argument_list|,
name|__FUNCTION__
argument_list|,
operator|(
name|u32
operator|)
name|addr
argument_list|,
name|size
operator|<<
literal|6
argument_list|)
expr_stmt|;
return|return
operator|(
name|u32
operator|)
name|addr
return|;
block|}
end_function

begin_function
name|void
name|cxio_hal_rqtpool_free
parameter_list|(
name|struct
name|cxio_rdev
modifier|*
name|rdev_p
parameter_list|,
name|u32
name|addr
parameter_list|,
name|int
name|size
parameter_list|)
block|{
name|CTR3
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s addr 0x%x size %d"
argument_list|,
name|__FUNCTION__
argument_list|,
name|addr
argument_list|,
name|size
operator|<<
literal|6
argument_list|)
expr_stmt|;
name|gen_pool_free
argument_list|(
name|rdev_p
operator|->
name|rqt_pool
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|addr
argument_list|,
name|size
operator|<<
literal|6
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|cxio_hal_rqtpool_create
parameter_list|(
name|struct
name|cxio_rdev
modifier|*
name|rdev_p
parameter_list|)
block|{
name|rdev_p
operator|->
name|rqt_pool
operator|=
name|gen_pool_create
argument_list|(
name|rdev_p
operator|->
name|rnic_info
operator|.
name|rqt_base
argument_list|,
name|MIN_RQT_SHIFT
argument_list|,
name|rdev_p
operator|->
name|rnic_info
operator|.
name|rqt_top
operator|-
name|rdev_p
operator|->
name|rnic_info
operator|.
name|rqt_base
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|if (rdev_p->rqt_pool) { 		unsigned long i;  		for (i = rdev_p->rnic_info.rqt_base; 		     i<= rdev_p->rnic_info.rqt_top - RQT_CHUNK + 1; 		     i += RQT_CHUNK) 			gen_pool_add(rdev_p->rqt_pool, i, RQT_CHUNK, -1); 	}
endif|#
directive|endif
return|return
name|rdev_p
operator|->
name|rqt_pool
condition|?
literal|0
else|:
operator|(
operator|-
name|ENOMEM
operator|)
return|;
block|}
end_function

begin_function
name|void
name|cxio_hal_rqtpool_destroy
parameter_list|(
name|struct
name|cxio_rdev
modifier|*
name|rdev_p
parameter_list|)
block|{
name|gen_pool_destroy
argument_list|(
name|rdev_p
operator|->
name|rqt_pool
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/**************************************************************************  Copyright (c) 2007, Chelsio Inc. All rights reserved.  Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:   1. Redistributions of source code must retain the above copyright notice,     this list of conditions and the following disclaimer.   2. Neither the name of the Chelsio Corporation nor the names of its     contributors may be used to endorse or promote products derived from     this software without specific prior written permission.  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  ***************************************************************************/
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"opt_inet.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|TCP_OFFLOAD
end_ifdef

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/pciio.h>
end_include

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioccom.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<sys/rwlock.h>
end_include

begin_include
include|#
directive|include
file|<sys/linker.h>
end_include

begin_include
include|#
directive|include
file|<sys/firmware.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/socketvar.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_include
include|#
directive|include
file|<sys/smp.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/syslog.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<sys/taskqueue.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<net/route.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_systm.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/toecore.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_pcb.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip_var.h>
end_include

begin_include
include|#
directive|include
file|<netinet/tcp_var.h>
end_include

begin_include
include|#
directive|include
file|<netinet/tcp.h>
end_include

begin_include
include|#
directive|include
file|<netinet/tcpip.h>
end_include

begin_include
include|#
directive|include
file|<rdma/ib_verbs.h>
end_include

begin_include
include|#
directive|include
file|<rdma/ib_umem.h>
end_include

begin_include
include|#
directive|include
file|<rdma/ib_user_verbs.h>
end_include

begin_include
include|#
directive|include
file|<linux/idr.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_ib_intfc.h>
end_include

begin_include
include|#
directive|include
file|<cxgb_include.h>
end_include

begin_include
include|#
directive|include
file|<ulp/tom/cxgb_l2t.h>
end_include

begin_include
include|#
directive|include
file|<ulp/tom/cxgb_toepcb.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_wr.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_hal.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_provider.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_cm.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_resource.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_user.h>
end_include

begin_define
define|#
directive|define
name|NO_SUPPORT
value|-1
end_define

begin_function
specifier|static
name|int
name|build_rdma_send
parameter_list|(
name|union
name|t3_wr
modifier|*
name|wqe
parameter_list|,
name|struct
name|ib_send_wr
modifier|*
name|wr
parameter_list|,
name|u8
modifier|*
name|flit_cnt
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|u32
name|plen
decl_stmt|;
switch|switch
condition|(
name|wr
operator|->
name|opcode
condition|)
block|{
case|case
name|IB_WR_SEND
case|:
if|if
condition|(
name|wr
operator|->
name|send_flags
operator|&
name|IB_SEND_SOLICITED
condition|)
name|wqe
operator|->
name|send
operator|.
name|rdmaop
operator|=
name|T3_SEND_WITH_SE
expr_stmt|;
else|else
name|wqe
operator|->
name|send
operator|.
name|rdmaop
operator|=
name|T3_SEND
expr_stmt|;
name|wqe
operator|->
name|send
operator|.
name|rem_stag
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|IB_WR_SEND_WITH_IMM
case|:
if|if
condition|(
name|wr
operator|->
name|send_flags
operator|&
name|IB_SEND_SOLICITED
condition|)
name|wqe
operator|->
name|send
operator|.
name|rdmaop
operator|=
name|T3_SEND_WITH_SE_INV
expr_stmt|;
else|else
name|wqe
operator|->
name|send
operator|.
name|rdmaop
operator|=
name|T3_SEND_WITH_INV
expr_stmt|;
name|wqe
operator|->
name|send
operator|.
name|rem_stag
operator|=
literal|0
expr_stmt|;
break|break;
default|default:
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|wr
operator|->
name|num_sge
operator|>
name|T3_MAX_SGE
condition|)
return|return
operator|(
operator|-
name|EINVAL
operator|)
return|;
name|wqe
operator|->
name|send
operator|.
name|reserved
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|wqe
operator|->
name|send
operator|.
name|reserved
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|wqe
operator|->
name|send
operator|.
name|reserved
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|plen
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|wr
operator|->
name|num_sge
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|plen
operator|+
name|wr
operator|->
name|sg_list
index|[
name|i
index|]
operator|.
name|length
operator|)
operator|<
name|plen
condition|)
block|{
return|return
operator|(
operator|-
name|EMSGSIZE
operator|)
return|;
block|}
name|plen
operator|+=
name|wr
operator|->
name|sg_list
index|[
name|i
index|]
operator|.
name|length
expr_stmt|;
name|wqe
operator|->
name|send
operator|.
name|sgl
index|[
name|i
index|]
operator|.
name|stag
operator|=
name|htobe32
argument_list|(
name|wr
operator|->
name|sg_list
index|[
name|i
index|]
operator|.
name|lkey
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|send
operator|.
name|sgl
index|[
name|i
index|]
operator|.
name|len
operator|=
name|htobe32
argument_list|(
name|wr
operator|->
name|sg_list
index|[
name|i
index|]
operator|.
name|length
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|send
operator|.
name|sgl
index|[
name|i
index|]
operator|.
name|to
operator|=
name|htobe64
argument_list|(
name|wr
operator|->
name|sg_list
index|[
name|i
index|]
operator|.
name|addr
argument_list|)
expr_stmt|;
block|}
name|wqe
operator|->
name|send
operator|.
name|num_sgle
operator|=
name|htobe32
argument_list|(
name|wr
operator|->
name|num_sge
argument_list|)
expr_stmt|;
operator|*
name|flit_cnt
operator|=
literal|4
operator|+
operator|(
operator|(
name|wr
operator|->
name|num_sge
operator|)
operator|<<
literal|1
operator|)
expr_stmt|;
name|wqe
operator|->
name|send
operator|.
name|plen
operator|=
name|htobe32
argument_list|(
name|plen
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|build_rdma_write
parameter_list|(
name|union
name|t3_wr
modifier|*
name|wqe
parameter_list|,
name|struct
name|ib_send_wr
modifier|*
name|wr
parameter_list|,
name|u8
modifier|*
name|flit_cnt
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|u32
name|plen
decl_stmt|;
if|if
condition|(
name|wr
operator|->
name|num_sge
operator|>
name|T3_MAX_SGE
condition|)
return|return
operator|(
operator|-
name|EINVAL
operator|)
return|;
name|wqe
operator|->
name|write
operator|.
name|rdmaop
operator|=
name|T3_RDMA_WRITE
expr_stmt|;
name|wqe
operator|->
name|write
operator|.
name|reserved
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|wqe
operator|->
name|write
operator|.
name|reserved
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|wqe
operator|->
name|write
operator|.
name|reserved
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|wqe
operator|->
name|write
operator|.
name|stag_sink
operator|=
name|htobe32
argument_list|(
name|wr
operator|->
name|wr
operator|.
name|rdma
operator|.
name|rkey
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|write
operator|.
name|to_sink
operator|=
name|htobe64
argument_list|(
name|wr
operator|->
name|wr
operator|.
name|rdma
operator|.
name|remote_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|wr
operator|->
name|opcode
operator|==
name|IB_WR_RDMA_WRITE_WITH_IMM
condition|)
block|{
name|plen
operator|=
literal|4
expr_stmt|;
name|wqe
operator|->
name|write
operator|.
name|sgl
index|[
literal|0
index|]
operator|.
name|stag
operator|=
name|wr
operator|->
name|ex
operator|.
name|imm_data
expr_stmt|;
name|wqe
operator|->
name|write
operator|.
name|sgl
index|[
literal|0
index|]
operator|.
name|len
operator|=
literal|0
expr_stmt|;
name|wqe
operator|->
name|write
operator|.
name|num_sgle
operator|=
literal|0
expr_stmt|;
operator|*
name|flit_cnt
operator|=
literal|6
expr_stmt|;
block|}
else|else
block|{
name|plen
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|wr
operator|->
name|num_sge
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|plen
operator|+
name|wr
operator|->
name|sg_list
index|[
name|i
index|]
operator|.
name|length
operator|)
operator|<
name|plen
condition|)
block|{
return|return
operator|(
operator|-
name|EMSGSIZE
operator|)
return|;
block|}
name|plen
operator|+=
name|wr
operator|->
name|sg_list
index|[
name|i
index|]
operator|.
name|length
expr_stmt|;
name|wqe
operator|->
name|write
operator|.
name|sgl
index|[
name|i
index|]
operator|.
name|stag
operator|=
name|htobe32
argument_list|(
name|wr
operator|->
name|sg_list
index|[
name|i
index|]
operator|.
name|lkey
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|write
operator|.
name|sgl
index|[
name|i
index|]
operator|.
name|len
operator|=
name|htobe32
argument_list|(
name|wr
operator|->
name|sg_list
index|[
name|i
index|]
operator|.
name|length
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|write
operator|.
name|sgl
index|[
name|i
index|]
operator|.
name|to
operator|=
name|htobe64
argument_list|(
name|wr
operator|->
name|sg_list
index|[
name|i
index|]
operator|.
name|addr
argument_list|)
expr_stmt|;
block|}
name|wqe
operator|->
name|write
operator|.
name|num_sgle
operator|=
name|htobe32
argument_list|(
name|wr
operator|->
name|num_sge
argument_list|)
expr_stmt|;
operator|*
name|flit_cnt
operator|=
literal|5
operator|+
operator|(
operator|(
name|wr
operator|->
name|num_sge
operator|)
operator|<<
literal|1
operator|)
expr_stmt|;
block|}
name|wqe
operator|->
name|write
operator|.
name|plen
operator|=
name|htobe32
argument_list|(
name|plen
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|build_rdma_read
parameter_list|(
name|union
name|t3_wr
modifier|*
name|wqe
parameter_list|,
name|struct
name|ib_send_wr
modifier|*
name|wr
parameter_list|,
name|u8
modifier|*
name|flit_cnt
parameter_list|)
block|{
if|if
condition|(
name|wr
operator|->
name|num_sge
operator|>
literal|1
condition|)
return|return
operator|(
operator|-
name|EINVAL
operator|)
return|;
name|wqe
operator|->
name|read
operator|.
name|rdmaop
operator|=
name|T3_READ_REQ
expr_stmt|;
name|wqe
operator|->
name|read
operator|.
name|reserved
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|wqe
operator|->
name|read
operator|.
name|reserved
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|wqe
operator|->
name|read
operator|.
name|reserved
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|wqe
operator|->
name|read
operator|.
name|rem_stag
operator|=
name|htobe32
argument_list|(
name|wr
operator|->
name|wr
operator|.
name|rdma
operator|.
name|rkey
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|read
operator|.
name|rem_to
operator|=
name|htobe64
argument_list|(
name|wr
operator|->
name|wr
operator|.
name|rdma
operator|.
name|remote_addr
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|read
operator|.
name|local_stag
operator|=
name|htobe32
argument_list|(
name|wr
operator|->
name|sg_list
index|[
literal|0
index|]
operator|.
name|lkey
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|read
operator|.
name|local_len
operator|=
name|htobe32
argument_list|(
name|wr
operator|->
name|sg_list
index|[
literal|0
index|]
operator|.
name|length
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|read
operator|.
name|local_to
operator|=
name|htobe64
argument_list|(
name|wr
operator|->
name|sg_list
index|[
literal|0
index|]
operator|.
name|addr
argument_list|)
expr_stmt|;
operator|*
name|flit_cnt
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|t3_rdma_read_wr
argument_list|)
operator|>>
literal|3
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|iwch_sgl2pbl_map
parameter_list|(
name|struct
name|iwch_dev
modifier|*
name|rhp
parameter_list|,
name|struct
name|ib_sge
modifier|*
name|sg_list
parameter_list|,
name|u32
name|num_sgle
parameter_list|,
name|u32
modifier|*
name|pbl_addr
parameter_list|,
name|u8
modifier|*
name|page_size
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|struct
name|iwch_mr
modifier|*
name|mhp
decl_stmt|;
name|u64
name|offset
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_sgle
condition|;
name|i
operator|++
control|)
block|{
name|mhp
operator|=
name|get_mhp
argument_list|(
name|rhp
argument_list|,
operator|(
name|sg_list
index|[
name|i
index|]
operator|.
name|lkey
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mhp
condition|)
block|{
name|CTR2
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s %d"
argument_list|,
name|__FUNCTION__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
name|EIO
operator|)
return|;
block|}
if|if
condition|(
operator|!
name|mhp
operator|->
name|attr
operator|.
name|state
condition|)
block|{
name|CTR2
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s %d"
argument_list|,
name|__FUNCTION__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
name|EIO
operator|)
return|;
block|}
if|if
condition|(
name|mhp
operator|->
name|attr
operator|.
name|zbva
condition|)
block|{
name|CTR2
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s %d"
argument_list|,
name|__FUNCTION__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
name|EIO
operator|)
return|;
block|}
if|if
condition|(
name|sg_list
index|[
name|i
index|]
operator|.
name|addr
operator|<
name|mhp
operator|->
name|attr
operator|.
name|va_fbo
condition|)
block|{
name|CTR2
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s %d"
argument_list|,
name|__FUNCTION__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
name|EINVAL
operator|)
return|;
block|}
if|if
condition|(
name|sg_list
index|[
name|i
index|]
operator|.
name|addr
operator|+
operator|(
operator|(
name|u64
operator|)
name|sg_list
index|[
name|i
index|]
operator|.
name|length
operator|)
operator|<
name|sg_list
index|[
name|i
index|]
operator|.
name|addr
condition|)
block|{
name|CTR2
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s %d"
argument_list|,
name|__FUNCTION__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
name|EINVAL
operator|)
return|;
block|}
if|if
condition|(
name|sg_list
index|[
name|i
index|]
operator|.
name|addr
operator|+
operator|(
operator|(
name|u64
operator|)
name|sg_list
index|[
name|i
index|]
operator|.
name|length
operator|)
operator|>
name|mhp
operator|->
name|attr
operator|.
name|va_fbo
operator|+
operator|(
operator|(
name|u64
operator|)
name|mhp
operator|->
name|attr
operator|.
name|len
operator|)
condition|)
block|{
name|CTR2
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s %d"
argument_list|,
name|__FUNCTION__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
name|EINVAL
operator|)
return|;
block|}
name|offset
operator|=
name|sg_list
index|[
name|i
index|]
operator|.
name|addr
operator|-
name|mhp
operator|->
name|attr
operator|.
name|va_fbo
expr_stmt|;
name|offset
operator|+=
name|mhp
operator|->
name|attr
operator|.
name|va_fbo
operator|&
operator|(
operator|(
literal|1UL
operator|<<
operator|(
literal|12
operator|+
name|mhp
operator|->
name|attr
operator|.
name|page_size
operator|)
operator|)
operator|-
literal|1
operator|)
expr_stmt|;
name|pbl_addr
index|[
name|i
index|]
operator|=
operator|(
operator|(
name|mhp
operator|->
name|attr
operator|.
name|pbl_addr
operator|-
name|rhp
operator|->
name|rdev
operator|.
name|rnic_info
operator|.
name|pbl_base
operator|)
operator|>>
literal|3
operator|)
operator|+
operator|(
name|offset
operator|>>
operator|(
literal|12
operator|+
name|mhp
operator|->
name|attr
operator|.
name|page_size
operator|)
operator|)
expr_stmt|;
name|page_size
index|[
name|i
index|]
operator|=
name|mhp
operator|->
name|attr
operator|.
name|page_size
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|build_rdma_recv
parameter_list|(
name|struct
name|iwch_qp
modifier|*
name|qhp
parameter_list|,
name|union
name|t3_wr
modifier|*
name|wqe
parameter_list|,
name|struct
name|ib_recv_wr
modifier|*
name|wr
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|err
init|=
literal|0
decl_stmt|;
name|u32
name|pbl_addr
index|[
name|T3_MAX_SGE
index|]
decl_stmt|;
name|u8
name|page_size
index|[
name|T3_MAX_SGE
index|]
decl_stmt|;
if|if
condition|(
name|wr
operator|->
name|num_sge
operator|>
name|T3_MAX_SGE
condition|)
return|return
operator|(
operator|-
name|EINVAL
operator|)
return|;
name|err
operator|=
name|iwch_sgl2pbl_map
argument_list|(
name|qhp
operator|->
name|rhp
argument_list|,
name|wr
operator|->
name|sg_list
argument_list|,
name|wr
operator|->
name|num_sge
argument_list|,
name|pbl_addr
argument_list|,
name|page_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
name|wqe
operator|->
name|recv
operator|.
name|pagesz
index|[
literal|0
index|]
operator|=
name|page_size
index|[
literal|0
index|]
expr_stmt|;
name|wqe
operator|->
name|recv
operator|.
name|pagesz
index|[
literal|1
index|]
operator|=
name|page_size
index|[
literal|1
index|]
expr_stmt|;
name|wqe
operator|->
name|recv
operator|.
name|pagesz
index|[
literal|2
index|]
operator|=
name|page_size
index|[
literal|2
index|]
expr_stmt|;
name|wqe
operator|->
name|recv
operator|.
name|pagesz
index|[
literal|3
index|]
operator|=
name|page_size
index|[
literal|3
index|]
expr_stmt|;
name|wqe
operator|->
name|recv
operator|.
name|num_sgle
operator|=
name|htobe32
argument_list|(
name|wr
operator|->
name|num_sge
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|wr
operator|->
name|num_sge
condition|;
name|i
operator|++
control|)
block|{
name|wqe
operator|->
name|recv
operator|.
name|sgl
index|[
name|i
index|]
operator|.
name|stag
operator|=
name|htobe32
argument_list|(
name|wr
operator|->
name|sg_list
index|[
name|i
index|]
operator|.
name|lkey
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|recv
operator|.
name|sgl
index|[
name|i
index|]
operator|.
name|len
operator|=
name|htobe32
argument_list|(
name|wr
operator|->
name|sg_list
index|[
name|i
index|]
operator|.
name|length
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|recv
operator|.
name|sgl
index|[
name|i
index|]
operator|.
name|to
operator|=
name|htobe64
argument_list|(
operator|(
operator|(
name|u32
operator|)
name|wr
operator|->
name|sg_list
index|[
name|i
index|]
operator|.
name|addr
operator|)
operator|&
operator|(
operator|(
literal|1UL
operator|<<
operator|(
literal|12
operator|+
name|page_size
index|[
name|i
index|]
operator|)
operator|)
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
comment|/* pbl_addr is the adapters address in the PBL */
name|wqe
operator|->
name|recv
operator|.
name|pbl_addr
index|[
name|i
index|]
operator|=
name|cpu_to_be32
argument_list|(
name|pbl_addr
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
for|for
control|(
init|;
name|i
operator|<
name|T3_MAX_SGE
condition|;
name|i
operator|++
control|)
block|{
name|wqe
operator|->
name|recv
operator|.
name|sgl
index|[
name|i
index|]
operator|.
name|stag
operator|=
literal|0
expr_stmt|;
name|wqe
operator|->
name|recv
operator|.
name|sgl
index|[
name|i
index|]
operator|.
name|len
operator|=
literal|0
expr_stmt|;
name|wqe
operator|->
name|recv
operator|.
name|sgl
index|[
name|i
index|]
operator|.
name|to
operator|=
literal|0
expr_stmt|;
name|wqe
operator|->
name|recv
operator|.
name|pbl_addr
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
block|}
name|qhp
operator|->
name|wq
operator|.
name|rq
index|[
name|Q_PTR2IDX
argument_list|(
name|qhp
operator|->
name|wq
operator|.
name|rq_wptr
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|rq_size_log2
argument_list|)
index|]
operator|.
name|wr_id
operator|=
name|wr
operator|->
name|wr_id
expr_stmt|;
name|qhp
operator|->
name|wq
operator|.
name|rq
index|[
name|Q_PTR2IDX
argument_list|(
name|qhp
operator|->
name|wq
operator|.
name|rq_wptr
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|rq_size_log2
argument_list|)
index|]
operator|.
name|pbl_addr
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|build_zero_stag_recv
parameter_list|(
name|struct
name|iwch_qp
modifier|*
name|qhp
parameter_list|,
name|union
name|t3_wr
modifier|*
name|wqe
parameter_list|,
name|struct
name|ib_recv_wr
modifier|*
name|wr
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|u32
name|pbl_addr
decl_stmt|;
name|u32
name|pbl_offset
decl_stmt|;
comment|/*          * The T3 HW requires the PBL in the HW recv descriptor to reference          * a PBL entry.  So we allocate the max needed PBL memory here and pass          * it to the uP in the recv WR.  The uP will build the PBL and setup          * the HW recv descriptor.          */
name|pbl_addr
operator|=
name|cxio_hal_pblpool_alloc
argument_list|(
operator|&
name|qhp
operator|->
name|rhp
operator|->
name|rdev
argument_list|,
name|T3_STAG0_PBL_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pbl_addr
condition|)
return|return
operator|-
name|ENOMEM
return|;
comment|/*          * Compute the 8B aligned offset.          */
name|pbl_offset
operator|=
operator|(
name|pbl_addr
operator|-
name|qhp
operator|->
name|rhp
operator|->
name|rdev
operator|.
name|rnic_info
operator|.
name|pbl_base
operator|)
operator|>>
literal|3
expr_stmt|;
name|wqe
operator|->
name|recv
operator|.
name|num_sgle
operator|=
name|cpu_to_be32
argument_list|(
name|wr
operator|->
name|num_sge
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|wr
operator|->
name|num_sge
condition|;
name|i
operator|++
control|)
block|{
comment|/*                  * Use a 128MB page size. This and an imposed 128MB                  * sge length limit allows us to require only a 2-entry HW                  * PBL for each SGE.  This restriction is acceptable since                  * since it is not possible to allocate 128MB of contiguous                  * DMA coherent memory!                  */
if|if
condition|(
name|wr
operator|->
name|sg_list
index|[
name|i
index|]
operator|.
name|length
operator|>
name|T3_STAG0_MAX_PBE_LEN
condition|)
return|return
operator|-
name|EINVAL
return|;
name|wqe
operator|->
name|recv
operator|.
name|pagesz
index|[
name|i
index|]
operator|=
name|T3_STAG0_PAGE_SHIFT
expr_stmt|;
comment|/*                  * T3 restricts a recv to all zero-stag or all non-zero-stag.                  */
if|if
condition|(
name|wr
operator|->
name|sg_list
index|[
name|i
index|]
operator|.
name|lkey
operator|!=
literal|0
condition|)
return|return
operator|-
name|EINVAL
return|;
name|wqe
operator|->
name|recv
operator|.
name|sgl
index|[
name|i
index|]
operator|.
name|stag
operator|=
literal|0
expr_stmt|;
name|wqe
operator|->
name|recv
operator|.
name|sgl
index|[
name|i
index|]
operator|.
name|len
operator|=
name|htobe32
argument_list|(
name|wr
operator|->
name|sg_list
index|[
name|i
index|]
operator|.
name|length
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|recv
operator|.
name|sgl
index|[
name|i
index|]
operator|.
name|to
operator|=
name|htobe64
argument_list|(
name|wr
operator|->
name|sg_list
index|[
name|i
index|]
operator|.
name|addr
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|recv
operator|.
name|pbl_addr
index|[
name|i
index|]
operator|=
name|htobe32
argument_list|(
name|pbl_offset
argument_list|)
expr_stmt|;
name|pbl_offset
operator|+=
literal|2
expr_stmt|;
block|}
for|for
control|(
init|;
name|i
operator|<
name|T3_MAX_SGE
condition|;
name|i
operator|++
control|)
block|{
name|wqe
operator|->
name|recv
operator|.
name|pagesz
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|wqe
operator|->
name|recv
operator|.
name|sgl
index|[
name|i
index|]
operator|.
name|stag
operator|=
literal|0
expr_stmt|;
name|wqe
operator|->
name|recv
operator|.
name|sgl
index|[
name|i
index|]
operator|.
name|len
operator|=
literal|0
expr_stmt|;
name|wqe
operator|->
name|recv
operator|.
name|sgl
index|[
name|i
index|]
operator|.
name|to
operator|=
literal|0
expr_stmt|;
name|wqe
operator|->
name|recv
operator|.
name|pbl_addr
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
block|}
name|qhp
operator|->
name|wq
operator|.
name|rq
index|[
name|Q_PTR2IDX
argument_list|(
name|qhp
operator|->
name|wq
operator|.
name|rq_wptr
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|rq_size_log2
argument_list|)
index|]
operator|.
name|wr_id
operator|=
name|wr
operator|->
name|wr_id
expr_stmt|;
name|qhp
operator|->
name|wq
operator|.
name|rq
index|[
name|Q_PTR2IDX
argument_list|(
name|qhp
operator|->
name|wq
operator|.
name|rq_wptr
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|rq_size_log2
argument_list|)
index|]
operator|.
name|pbl_addr
operator|=
name|pbl_addr
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|iwch_post_send
parameter_list|(
name|struct
name|ib_qp
modifier|*
name|ibqp
parameter_list|,
name|struct
name|ib_send_wr
modifier|*
name|wr
parameter_list|,
name|struct
name|ib_send_wr
modifier|*
modifier|*
name|bad_wr
parameter_list|)
block|{
name|int
name|err
init|=
literal|0
decl_stmt|;
name|u8
name|t3_wr_flit_cnt
init|=
literal|0
decl_stmt|;
name|enum
name|t3_wr_opcode
name|t3_wr_opcode
init|=
literal|0
decl_stmt|;
name|enum
name|t3_wr_flags
name|t3_wr_flags
decl_stmt|;
name|struct
name|iwch_qp
modifier|*
name|qhp
decl_stmt|;
name|u32
name|idx
decl_stmt|;
name|union
name|t3_wr
modifier|*
name|wqe
decl_stmt|;
name|u32
name|num_wrs
decl_stmt|;
name|struct
name|t3_swsq
modifier|*
name|sqp
decl_stmt|;
name|qhp
operator|=
name|to_iwch_qp
argument_list|(
name|ibqp
argument_list|)
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|qhp
operator|->
name|attr
operator|.
name|state
operator|>
name|IWCH_QP_STATE_RTS
condition|)
block|{
name|mtx_unlock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
name|err
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|num_wrs
operator|=
name|Q_FREECNT
argument_list|(
name|qhp
operator|->
name|wq
operator|.
name|sq_rptr
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|sq_wptr
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|sq_size_log2
argument_list|)
expr_stmt|;
if|if
condition|(
name|num_wrs
operator|==
literal|0
condition|)
block|{
name|mtx_unlock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
name|err
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
while|while
condition|(
name|wr
condition|)
block|{
if|if
condition|(
name|num_wrs
operator|==
literal|0
condition|)
block|{
name|err
operator|=
operator|-
name|ENOMEM
expr_stmt|;
break|break;
block|}
name|idx
operator|=
name|Q_PTR2IDX
argument_list|(
name|qhp
operator|->
name|wq
operator|.
name|wptr
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|size_log2
argument_list|)
expr_stmt|;
name|wqe
operator|=
operator|(
expr|union
name|t3_wr
operator|*
operator|)
operator|(
name|qhp
operator|->
name|wq
operator|.
name|queue
operator|+
name|idx
operator|)
expr_stmt|;
name|t3_wr_flags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|wr
operator|->
name|send_flags
operator|&
name|IB_SEND_SOLICITED
condition|)
name|t3_wr_flags
operator||=
name|T3_SOLICITED_EVENT_FLAG
expr_stmt|;
if|if
condition|(
name|wr
operator|->
name|send_flags
operator|&
name|IB_SEND_FENCE
condition|)
name|t3_wr_flags
operator||=
name|T3_READ_FENCE_FLAG
expr_stmt|;
if|if
condition|(
name|wr
operator|->
name|send_flags
operator|&
name|IB_SEND_SIGNALED
condition|)
name|t3_wr_flags
operator||=
name|T3_COMPLETION_FLAG
expr_stmt|;
name|sqp
operator|=
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|+
name|Q_PTR2IDX
argument_list|(
name|qhp
operator|->
name|wq
operator|.
name|sq_wptr
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|sq_size_log2
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|wr
operator|->
name|opcode
condition|)
block|{
case|case
name|IB_WR_SEND
case|:
case|case
name|IB_WR_SEND_WITH_IMM
case|:
name|t3_wr_opcode
operator|=
name|T3_WR_SEND
expr_stmt|;
name|err
operator|=
name|build_rdma_send
argument_list|(
name|wqe
argument_list|,
name|wr
argument_list|,
operator|&
name|t3_wr_flit_cnt
argument_list|)
expr_stmt|;
break|break;
case|case
name|IB_WR_RDMA_WRITE
case|:
case|case
name|IB_WR_RDMA_WRITE_WITH_IMM
case|:
name|t3_wr_opcode
operator|=
name|T3_WR_WRITE
expr_stmt|;
name|err
operator|=
name|build_rdma_write
argument_list|(
name|wqe
argument_list|,
name|wr
argument_list|,
operator|&
name|t3_wr_flit_cnt
argument_list|)
expr_stmt|;
break|break;
case|case
name|IB_WR_RDMA_READ
case|:
name|t3_wr_opcode
operator|=
name|T3_WR_READ
expr_stmt|;
name|t3_wr_flags
operator|=
literal|0
expr_stmt|;
comment|/* T3 reads are always signaled */
name|err
operator|=
name|build_rdma_read
argument_list|(
name|wqe
argument_list|,
name|wr
argument_list|,
operator|&
name|t3_wr_flit_cnt
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
break|break;
name|sqp
operator|->
name|read_len
operator|=
name|wqe
operator|->
name|read
operator|.
name|local_len
expr_stmt|;
if|if
condition|(
operator|!
name|qhp
operator|->
name|wq
operator|.
name|oldest_read
condition|)
name|qhp
operator|->
name|wq
operator|.
name|oldest_read
operator|=
name|sqp
expr_stmt|;
break|break;
default|default:
name|CTR2
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s post of type=%d TBD!"
argument_list|,
name|__FUNCTION__
argument_list|,
name|wr
operator|->
name|opcode
argument_list|)
expr_stmt|;
name|err
operator|=
operator|-
name|EINVAL
expr_stmt|;
block|}
if|if
condition|(
name|err
condition|)
break|break;
name|wqe
operator|->
name|send
operator|.
name|wrid
operator|.
name|id0
operator|.
name|hi
operator|=
name|qhp
operator|->
name|wq
operator|.
name|sq_wptr
expr_stmt|;
name|sqp
operator|->
name|wr_id
operator|=
name|wr
operator|->
name|wr_id
expr_stmt|;
name|sqp
operator|->
name|opcode
operator|=
name|wr2opcode
argument_list|(
name|t3_wr_opcode
argument_list|)
expr_stmt|;
name|sqp
operator|->
name|sq_wptr
operator|=
name|qhp
operator|->
name|wq
operator|.
name|sq_wptr
expr_stmt|;
name|sqp
operator|->
name|complete
operator|=
literal|0
expr_stmt|;
name|sqp
operator|->
name|signaled
operator|=
operator|(
name|wr
operator|->
name|send_flags
operator|&
name|IB_SEND_SIGNALED
operator|)
expr_stmt|;
name|build_fw_riwrh
argument_list|(
operator|(
name|void
operator|*
operator|)
name|wqe
argument_list|,
name|t3_wr_opcode
argument_list|,
name|t3_wr_flags
argument_list|,
name|Q_GENBIT
argument_list|(
name|qhp
operator|->
name|wq
operator|.
name|wptr
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|size_log2
argument_list|)
argument_list|,
literal|0
argument_list|,
name|t3_wr_flit_cnt
argument_list|)
expr_stmt|;
name|CTR5
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s cookie 0x%llx wq idx 0x%x swsq idx %ld opcode %d"
argument_list|,
name|__FUNCTION__
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|wr
operator|->
name|wr_id
argument_list|,
name|idx
argument_list|,
name|Q_PTR2IDX
argument_list|(
name|qhp
operator|->
name|wq
operator|.
name|sq_wptr
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|sq_size_log2
argument_list|)
argument_list|,
name|sqp
operator|->
name|opcode
argument_list|)
expr_stmt|;
name|wr
operator|=
name|wr
operator|->
name|next
expr_stmt|;
name|num_wrs
operator|--
expr_stmt|;
operator|++
operator|(
name|qhp
operator|->
name|wq
operator|.
name|wptr
operator|)
expr_stmt|;
operator|++
operator|(
name|qhp
operator|->
name|wq
operator|.
name|sq_wptr
operator|)
expr_stmt|;
block|}
name|mtx_unlock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
name|ring_doorbell
argument_list|(
name|qhp
operator|->
name|wq
operator|.
name|doorbell
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|qpid
argument_list|)
expr_stmt|;
name|out
label|:
if|if
condition|(
name|err
condition|)
operator|*
name|bad_wr
operator|=
name|wr
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|int
name|iwch_post_receive
parameter_list|(
name|struct
name|ib_qp
modifier|*
name|ibqp
parameter_list|,
name|struct
name|ib_recv_wr
modifier|*
name|wr
parameter_list|,
name|struct
name|ib_recv_wr
modifier|*
modifier|*
name|bad_wr
parameter_list|)
block|{
name|int
name|err
init|=
literal|0
decl_stmt|;
name|struct
name|iwch_qp
modifier|*
name|qhp
decl_stmt|;
name|u32
name|idx
decl_stmt|;
name|union
name|t3_wr
modifier|*
name|wqe
decl_stmt|;
name|u32
name|num_wrs
decl_stmt|;
name|qhp
operator|=
name|to_iwch_qp
argument_list|(
name|ibqp
argument_list|)
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|qhp
operator|->
name|attr
operator|.
name|state
operator|>
name|IWCH_QP_STATE_RTS
condition|)
block|{
name|mtx_unlock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
name|err
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|num_wrs
operator|=
name|Q_FREECNT
argument_list|(
name|qhp
operator|->
name|wq
operator|.
name|rq_rptr
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|rq_wptr
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|rq_size_log2
argument_list|)
operator|-
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|wr
condition|)
block|{
name|mtx_unlock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
name|err
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
while|while
condition|(
name|wr
condition|)
block|{
if|if
condition|(
name|wr
operator|->
name|num_sge
operator|>
name|T3_MAX_SGE
condition|)
block|{
name|err
operator|=
operator|-
name|EINVAL
expr_stmt|;
break|break;
block|}
name|idx
operator|=
name|Q_PTR2IDX
argument_list|(
name|qhp
operator|->
name|wq
operator|.
name|wptr
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|size_log2
argument_list|)
expr_stmt|;
name|wqe
operator|=
operator|(
expr|union
name|t3_wr
operator|*
operator|)
operator|(
name|qhp
operator|->
name|wq
operator|.
name|queue
operator|+
name|idx
operator|)
expr_stmt|;
if|if
condition|(
name|num_wrs
condition|)
block|{
if|if
condition|(
name|wr
operator|->
name|sg_list
index|[
literal|0
index|]
operator|.
name|lkey
condition|)
name|err
operator|=
name|build_rdma_recv
argument_list|(
name|qhp
argument_list|,
name|wqe
argument_list|,
name|wr
argument_list|)
expr_stmt|;
else|else
name|err
operator|=
name|build_zero_stag_recv
argument_list|(
name|qhp
argument_list|,
name|wqe
argument_list|,
name|wr
argument_list|)
expr_stmt|;
block|}
else|else
name|err
operator|=
operator|-
name|ENOMEM
expr_stmt|;
if|if
condition|(
name|err
condition|)
break|break;
name|build_fw_riwrh
argument_list|(
operator|(
name|void
operator|*
operator|)
name|wqe
argument_list|,
name|T3_WR_RCV
argument_list|,
name|T3_COMPLETION_FLAG
argument_list|,
name|Q_GENBIT
argument_list|(
name|qhp
operator|->
name|wq
operator|.
name|wptr
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|size_log2
argument_list|)
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|t3_receive_wr
argument_list|)
operator|>>
literal|3
argument_list|)
expr_stmt|;
name|CTR6
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s cookie 0x%llx idx 0x%x rq_wptr 0x%x rw_rptr 0x%x "
literal|"wqe %p "
argument_list|,
name|__FUNCTION__
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|wr
operator|->
name|wr_id
argument_list|,
name|idx
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|rq_wptr
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|rq_rptr
argument_list|,
name|wqe
argument_list|)
expr_stmt|;
operator|++
operator|(
name|qhp
operator|->
name|wq
operator|.
name|rq_wptr
operator|)
expr_stmt|;
operator|++
operator|(
name|qhp
operator|->
name|wq
operator|.
name|wptr
operator|)
expr_stmt|;
name|wr
operator|=
name|wr
operator|->
name|next
expr_stmt|;
name|num_wrs
operator|--
expr_stmt|;
block|}
name|mtx_unlock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
name|ring_doorbell
argument_list|(
name|qhp
operator|->
name|wq
operator|.
name|doorbell
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|qpid
argument_list|)
expr_stmt|;
name|out
label|:
if|if
condition|(
name|err
condition|)
operator|*
name|bad_wr
operator|=
name|wr
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|int
name|iwch_bind_mw
parameter_list|(
name|struct
name|ib_qp
modifier|*
name|qp
parameter_list|,
name|struct
name|ib_mw
modifier|*
name|mw
parameter_list|,
name|struct
name|ib_mw_bind
modifier|*
name|mw_bind
parameter_list|)
block|{
name|struct
name|iwch_dev
modifier|*
name|rhp
decl_stmt|;
name|struct
name|iwch_mw
modifier|*
name|mhp
decl_stmt|;
name|struct
name|iwch_qp
modifier|*
name|qhp
decl_stmt|;
name|union
name|t3_wr
modifier|*
name|wqe
decl_stmt|;
name|u32
name|pbl_addr
decl_stmt|;
name|u8
name|page_size
decl_stmt|;
name|u32
name|num_wrs
decl_stmt|;
name|struct
name|ib_sge
name|sgl
decl_stmt|;
name|int
name|err
init|=
literal|0
decl_stmt|;
name|enum
name|t3_wr_flags
name|t3_wr_flags
decl_stmt|;
name|u32
name|idx
decl_stmt|;
name|struct
name|t3_swsq
modifier|*
name|sqp
decl_stmt|;
name|qhp
operator|=
name|to_iwch_qp
argument_list|(
name|qp
argument_list|)
expr_stmt|;
name|mhp
operator|=
name|to_iwch_mw
argument_list|(
name|mw
argument_list|)
expr_stmt|;
name|rhp
operator|=
name|qhp
operator|->
name|rhp
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|qhp
operator|->
name|attr
operator|.
name|state
operator|>
name|IWCH_QP_STATE_RTS
condition|)
block|{
name|mtx_unlock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
name|EINVAL
operator|)
return|;
block|}
name|num_wrs
operator|=
name|Q_FREECNT
argument_list|(
name|qhp
operator|->
name|wq
operator|.
name|sq_rptr
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|sq_wptr
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|sq_size_log2
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|num_wrs
operator|)
operator|==
literal|0
condition|)
block|{
name|mtx_unlock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
name|ENOMEM
operator|)
return|;
block|}
name|idx
operator|=
name|Q_PTR2IDX
argument_list|(
name|qhp
operator|->
name|wq
operator|.
name|wptr
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|size_log2
argument_list|)
expr_stmt|;
name|CTR4
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s: idx 0x%0x, mw 0x%p, mw_bind 0x%p"
argument_list|,
name|__FUNCTION__
argument_list|,
name|idx
argument_list|,
name|mw
argument_list|,
name|mw_bind
argument_list|)
expr_stmt|;
name|wqe
operator|=
operator|(
expr|union
name|t3_wr
operator|*
operator|)
operator|(
name|qhp
operator|->
name|wq
operator|.
name|queue
operator|+
name|idx
operator|)
expr_stmt|;
name|t3_wr_flags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|mw_bind
operator|->
name|send_flags
operator|&
name|IB_SEND_SIGNALED
condition|)
name|t3_wr_flags
operator|=
name|T3_COMPLETION_FLAG
expr_stmt|;
name|sgl
operator|.
name|addr
operator|=
name|mw_bind
operator|->
name|bind_info
operator|.
name|addr
expr_stmt|;
name|sgl
operator|.
name|lkey
operator|=
name|mw_bind
operator|->
name|bind_info
operator|.
name|mr
operator|->
name|lkey
expr_stmt|;
name|sgl
operator|.
name|length
operator|=
name|mw_bind
operator|->
name|bind_info
operator|.
name|length
expr_stmt|;
name|wqe
operator|->
name|bind
operator|.
name|reserved
operator|=
literal|0
expr_stmt|;
name|wqe
operator|->
name|bind
operator|.
name|type
operator|=
name|T3_VA_BASED_TO
expr_stmt|;
comment|/* TBD: check perms */
name|wqe
operator|->
name|bind
operator|.
name|perms
operator|=
name|iwch_ib_to_mwbind_access
argument_list|(
name|mw_bind
operator|->
name|bind_info
operator|.
name|mw_access_flags
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|bind
operator|.
name|mr_stag
operator|=
name|htobe32
argument_list|(
name|mw_bind
operator|->
name|bind_info
operator|.
name|mr
operator|->
name|lkey
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|bind
operator|.
name|mw_stag
operator|=
name|htobe32
argument_list|(
name|mw
operator|->
name|rkey
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|bind
operator|.
name|mw_len
operator|=
name|htobe32
argument_list|(
name|mw_bind
operator|->
name|bind_info
operator|.
name|length
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|bind
operator|.
name|mw_va
operator|=
name|htobe64
argument_list|(
name|mw_bind
operator|->
name|bind_info
operator|.
name|addr
argument_list|)
expr_stmt|;
name|err
operator|=
name|iwch_sgl2pbl_map
argument_list|(
name|rhp
argument_list|,
operator|&
name|sgl
argument_list|,
literal|1
argument_list|,
operator|&
name|pbl_addr
argument_list|,
operator|&
name|page_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|mtx_unlock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
name|wqe
operator|->
name|send
operator|.
name|wrid
operator|.
name|id0
operator|.
name|hi
operator|=
name|qhp
operator|->
name|wq
operator|.
name|sq_wptr
expr_stmt|;
name|sqp
operator|=
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|+
name|Q_PTR2IDX
argument_list|(
name|qhp
operator|->
name|wq
operator|.
name|sq_wptr
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|sq_size_log2
argument_list|)
expr_stmt|;
name|sqp
operator|->
name|wr_id
operator|=
name|mw_bind
operator|->
name|wr_id
expr_stmt|;
name|sqp
operator|->
name|opcode
operator|=
name|T3_BIND_MW
expr_stmt|;
name|sqp
operator|->
name|sq_wptr
operator|=
name|qhp
operator|->
name|wq
operator|.
name|sq_wptr
expr_stmt|;
name|sqp
operator|->
name|complete
operator|=
literal|0
expr_stmt|;
name|sqp
operator|->
name|signaled
operator|=
operator|(
name|mw_bind
operator|->
name|send_flags
operator|&
name|IB_SEND_SIGNALED
operator|)
expr_stmt|;
name|wqe
operator|->
name|bind
operator|.
name|mr_pbl_addr
operator|=
name|htobe32
argument_list|(
name|pbl_addr
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|bind
operator|.
name|mr_pagesz
operator|=
name|page_size
expr_stmt|;
name|wqe
operator|->
name|flit
index|[
name|T3_SQ_COOKIE_FLIT
index|]
operator|=
name|mw_bind
operator|->
name|wr_id
expr_stmt|;
name|build_fw_riwrh
argument_list|(
operator|(
name|void
operator|*
operator|)
name|wqe
argument_list|,
name|T3_WR_BIND
argument_list|,
name|t3_wr_flags
argument_list|,
name|Q_GENBIT
argument_list|(
name|qhp
operator|->
name|wq
operator|.
name|wptr
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|size_log2
argument_list|)
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|t3_bind_mw_wr
argument_list|)
operator|>>
literal|3
argument_list|)
expr_stmt|;
operator|++
operator|(
name|qhp
operator|->
name|wq
operator|.
name|wptr
operator|)
expr_stmt|;
operator|++
operator|(
name|qhp
operator|->
name|wq
operator|.
name|sq_wptr
operator|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
name|ring_doorbell
argument_list|(
name|qhp
operator|->
name|wq
operator|.
name|doorbell
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|qpid
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|build_term_codes
parameter_list|(
name|struct
name|respQ_msg_t
modifier|*
name|rsp_msg
parameter_list|,
name|u8
modifier|*
name|layer_type
parameter_list|,
name|u8
modifier|*
name|ecode
parameter_list|)
block|{
name|int
name|status
init|=
name|TPT_ERR_INTERNAL_ERR
decl_stmt|;
name|int
name|tagged
init|=
literal|0
decl_stmt|;
name|int
name|opcode
init|=
operator|-
literal|1
decl_stmt|;
name|int
name|rqtype
init|=
literal|0
decl_stmt|;
name|int
name|send_inv
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|rsp_msg
condition|)
block|{
name|status
operator|=
name|CQE_STATUS
argument_list|(
name|rsp_msg
operator|->
name|cqe
argument_list|)
expr_stmt|;
name|opcode
operator|=
name|CQE_OPCODE
argument_list|(
name|rsp_msg
operator|->
name|cqe
argument_list|)
expr_stmt|;
name|rqtype
operator|=
name|RQ_TYPE
argument_list|(
name|rsp_msg
operator|->
name|cqe
argument_list|)
expr_stmt|;
name|send_inv
operator|=
operator|(
name|opcode
operator|==
name|T3_SEND_WITH_INV
operator|)
operator|||
operator|(
name|opcode
operator|==
name|T3_SEND_WITH_SE_INV
operator|)
expr_stmt|;
name|tagged
operator|=
operator|(
name|opcode
operator|==
name|T3_RDMA_WRITE
operator|)
operator|||
operator|(
name|rqtype
operator|&&
operator|(
name|opcode
operator|==
name|T3_READ_RESP
operator|)
operator|)
expr_stmt|;
block|}
switch|switch
condition|(
name|status
condition|)
block|{
case|case
name|TPT_ERR_STAG
case|:
if|if
condition|(
name|send_inv
condition|)
block|{
operator|*
name|layer_type
operator|=
name|LAYER_RDMAP
operator||
name|RDMAP_REMOTE_OP
expr_stmt|;
operator|*
name|ecode
operator|=
name|RDMAP_CANT_INV_STAG
expr_stmt|;
block|}
else|else
block|{
operator|*
name|layer_type
operator|=
name|LAYER_RDMAP
operator||
name|RDMAP_REMOTE_PROT
expr_stmt|;
operator|*
name|ecode
operator|=
name|RDMAP_INV_STAG
expr_stmt|;
block|}
break|break;
case|case
name|TPT_ERR_PDID
case|:
operator|*
name|layer_type
operator|=
name|LAYER_RDMAP
operator||
name|RDMAP_REMOTE_PROT
expr_stmt|;
if|if
condition|(
operator|(
name|opcode
operator|==
name|T3_SEND_WITH_INV
operator|)
operator|||
operator|(
name|opcode
operator|==
name|T3_SEND_WITH_SE_INV
operator|)
condition|)
operator|*
name|ecode
operator|=
name|RDMAP_CANT_INV_STAG
expr_stmt|;
else|else
operator|*
name|ecode
operator|=
name|RDMAP_STAG_NOT_ASSOC
expr_stmt|;
break|break;
case|case
name|TPT_ERR_QPID
case|:
operator|*
name|layer_type
operator|=
name|LAYER_RDMAP
operator||
name|RDMAP_REMOTE_PROT
expr_stmt|;
operator|*
name|ecode
operator|=
name|RDMAP_STAG_NOT_ASSOC
expr_stmt|;
break|break;
case|case
name|TPT_ERR_ACCESS
case|:
operator|*
name|layer_type
operator|=
name|LAYER_RDMAP
operator||
name|RDMAP_REMOTE_PROT
expr_stmt|;
operator|*
name|ecode
operator|=
name|RDMAP_ACC_VIOL
expr_stmt|;
break|break;
case|case
name|TPT_ERR_WRAP
case|:
operator|*
name|layer_type
operator|=
name|LAYER_RDMAP
operator||
name|RDMAP_REMOTE_PROT
expr_stmt|;
operator|*
name|ecode
operator|=
name|RDMAP_TO_WRAP
expr_stmt|;
break|break;
case|case
name|TPT_ERR_BOUND
case|:
if|if
condition|(
name|tagged
condition|)
block|{
operator|*
name|layer_type
operator|=
name|LAYER_DDP
operator||
name|DDP_TAGGED_ERR
expr_stmt|;
operator|*
name|ecode
operator|=
name|DDPT_BASE_BOUNDS
expr_stmt|;
block|}
else|else
block|{
operator|*
name|layer_type
operator|=
name|LAYER_RDMAP
operator||
name|RDMAP_REMOTE_PROT
expr_stmt|;
operator|*
name|ecode
operator|=
name|RDMAP_BASE_BOUNDS
expr_stmt|;
block|}
break|break;
case|case
name|TPT_ERR_INVALIDATE_SHARED_MR
case|:
case|case
name|TPT_ERR_INVALIDATE_MR_WITH_MW_BOUND
case|:
operator|*
name|layer_type
operator|=
name|LAYER_RDMAP
operator||
name|RDMAP_REMOTE_OP
expr_stmt|;
operator|*
name|ecode
operator|=
name|RDMAP_CANT_INV_STAG
expr_stmt|;
break|break;
case|case
name|TPT_ERR_ECC
case|:
case|case
name|TPT_ERR_ECC_PSTAG
case|:
case|case
name|TPT_ERR_INTERNAL_ERR
case|:
operator|*
name|layer_type
operator|=
name|LAYER_RDMAP
operator||
name|RDMAP_LOCAL_CATA
expr_stmt|;
operator|*
name|ecode
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|TPT_ERR_OUT_OF_RQE
case|:
operator|*
name|layer_type
operator|=
name|LAYER_DDP
operator||
name|DDP_UNTAGGED_ERR
expr_stmt|;
operator|*
name|ecode
operator|=
name|DDPU_INV_MSN_NOBUF
expr_stmt|;
break|break;
case|case
name|TPT_ERR_PBL_ADDR_BOUND
case|:
operator|*
name|layer_type
operator|=
name|LAYER_DDP
operator||
name|DDP_TAGGED_ERR
expr_stmt|;
operator|*
name|ecode
operator|=
name|DDPT_BASE_BOUNDS
expr_stmt|;
break|break;
case|case
name|TPT_ERR_CRC
case|:
operator|*
name|layer_type
operator|=
name|LAYER_MPA
operator||
name|DDP_LLP
expr_stmt|;
operator|*
name|ecode
operator|=
name|MPA_CRC_ERR
expr_stmt|;
break|break;
case|case
name|TPT_ERR_MARKER
case|:
operator|*
name|layer_type
operator|=
name|LAYER_MPA
operator||
name|DDP_LLP
expr_stmt|;
operator|*
name|ecode
operator|=
name|MPA_MARKER_ERR
expr_stmt|;
break|break;
case|case
name|TPT_ERR_PDU_LEN_ERR
case|:
operator|*
name|layer_type
operator|=
name|LAYER_DDP
operator||
name|DDP_UNTAGGED_ERR
expr_stmt|;
operator|*
name|ecode
operator|=
name|DDPU_MSG_TOOBIG
expr_stmt|;
break|break;
case|case
name|TPT_ERR_DDP_VERSION
case|:
if|if
condition|(
name|tagged
condition|)
block|{
operator|*
name|layer_type
operator|=
name|LAYER_DDP
operator||
name|DDP_TAGGED_ERR
expr_stmt|;
operator|*
name|ecode
operator|=
name|DDPT_INV_VERS
expr_stmt|;
block|}
else|else
block|{
operator|*
name|layer_type
operator|=
name|LAYER_DDP
operator||
name|DDP_UNTAGGED_ERR
expr_stmt|;
operator|*
name|ecode
operator|=
name|DDPU_INV_VERS
expr_stmt|;
block|}
break|break;
case|case
name|TPT_ERR_RDMA_VERSION
case|:
operator|*
name|layer_type
operator|=
name|LAYER_RDMAP
operator||
name|RDMAP_REMOTE_OP
expr_stmt|;
operator|*
name|ecode
operator|=
name|RDMAP_INV_VERS
expr_stmt|;
break|break;
case|case
name|TPT_ERR_OPCODE
case|:
operator|*
name|layer_type
operator|=
name|LAYER_RDMAP
operator||
name|RDMAP_REMOTE_OP
expr_stmt|;
operator|*
name|ecode
operator|=
name|RDMAP_INV_OPCODE
expr_stmt|;
break|break;
case|case
name|TPT_ERR_DDP_QUEUE_NUM
case|:
operator|*
name|layer_type
operator|=
name|LAYER_DDP
operator||
name|DDP_UNTAGGED_ERR
expr_stmt|;
operator|*
name|ecode
operator|=
name|DDPU_INV_QN
expr_stmt|;
break|break;
case|case
name|TPT_ERR_MSN
case|:
case|case
name|TPT_ERR_MSN_GAP
case|:
case|case
name|TPT_ERR_MSN_RANGE
case|:
case|case
name|TPT_ERR_IRD_OVERFLOW
case|:
operator|*
name|layer_type
operator|=
name|LAYER_DDP
operator||
name|DDP_UNTAGGED_ERR
expr_stmt|;
operator|*
name|ecode
operator|=
name|DDPU_INV_MSN_RANGE
expr_stmt|;
break|break;
case|case
name|TPT_ERR_TBIT
case|:
operator|*
name|layer_type
operator|=
name|LAYER_DDP
operator||
name|DDP_LOCAL_CATA
expr_stmt|;
operator|*
name|ecode
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|TPT_ERR_MO
case|:
operator|*
name|layer_type
operator|=
name|LAYER_DDP
operator||
name|DDP_UNTAGGED_ERR
expr_stmt|;
operator|*
name|ecode
operator|=
name|DDPU_INV_MO
expr_stmt|;
break|break;
default|default:
operator|*
name|layer_type
operator|=
name|LAYER_RDMAP
operator||
name|DDP_LOCAL_CATA
expr_stmt|;
operator|*
name|ecode
operator|=
literal|0
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/*  * This posts a TERMINATE with layer=RDMA, type=catastrophic.  */
end_comment

begin_function
name|int
name|iwch_post_terminate
parameter_list|(
name|struct
name|iwch_qp
modifier|*
name|qhp
parameter_list|,
name|struct
name|respQ_msg_t
modifier|*
name|rsp_msg
parameter_list|)
block|{
name|union
name|t3_wr
modifier|*
name|wqe
decl_stmt|;
name|struct
name|terminate_message
modifier|*
name|term
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|struct
name|ofld_hdr
modifier|*
name|oh
decl_stmt|;
name|CTR3
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s: tid %u, %p"
argument_list|,
name|__func__
argument_list|,
name|qhp
operator|->
name|ep
operator|->
name|hwtid
argument_list|,
name|rsp_msg
argument_list|)
expr_stmt|;
name|m
operator|=
name|m_gethdr
argument_list|(
name|M_NOWAIT
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"%s cannot send TERMINATE!\n"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
name|ENOMEM
operator|)
return|;
block|}
name|oh
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ofld_hdr
operator|*
argument_list|)
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|m
operator|->
name|m_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|oh
argument_list|)
operator|+
literal|40
expr_stmt|;
name|oh
operator|->
name|flags
operator|=
name|V_HDR_NDESC
argument_list|(
literal|1
argument_list|)
operator||
name|V_HDR_CTRL
argument_list|(
name|CPL_PRIORITY_DATA
argument_list|)
operator||
name|V_HDR_QSET
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|wqe
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
name|oh
operator|+
literal|1
operator|)
expr_stmt|;
name|memset
argument_list|(
name|wqe
argument_list|,
literal|0
argument_list|,
literal|40
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|send
operator|.
name|rdmaop
operator|=
name|T3_TERMINATE
expr_stmt|;
comment|/* immediate data length */
name|wqe
operator|->
name|send
operator|.
name|plen
operator|=
name|htonl
argument_list|(
literal|4
argument_list|)
expr_stmt|;
comment|/* immediate data starts here. */
name|term
operator|=
operator|(
expr|struct
name|terminate_message
operator|*
operator|)
name|wqe
operator|->
name|send
operator|.
name|sgl
expr_stmt|;
name|build_term_codes
argument_list|(
name|rsp_msg
argument_list|,
operator|&
name|term
operator|->
name|layer_etype
argument_list|,
operator|&
name|term
operator|->
name|ecode
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|send
operator|.
name|wrh
operator|.
name|op_seop_flags
operator|=
name|htobe32
argument_list|(
name|V_FW_RIWR_OP
argument_list|(
name|T3_WR_SEND
argument_list|)
operator||
name|V_FW_RIWR_FLAGS
argument_list|(
name|T3_COMPLETION_FLAG
operator||
name|T3_NOTIFY_FLAG
argument_list|)
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|send
operator|.
name|wrh
operator|.
name|gen_tid_len
operator|=
name|htobe32
argument_list|(
name|V_FW_RIWR_TID
argument_list|(
name|qhp
operator|->
name|ep
operator|->
name|hwtid
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|t3_offload_tx
argument_list|(
name|qhp
operator|->
name|rhp
operator|->
name|rdev
operator|.
name|adap
argument_list|,
name|m
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  * Assumes qhp lock is held.  */
end_comment

begin_function
specifier|static
name|void
name|__flush_qp
parameter_list|(
name|struct
name|iwch_qp
modifier|*
name|qhp
parameter_list|,
name|struct
name|iwch_cq
modifier|*
name|rchp
parameter_list|,
name|struct
name|iwch_cq
modifier|*
name|schp
parameter_list|)
block|{
name|int
name|count
decl_stmt|;
name|int
name|flushed
decl_stmt|;
name|CTR4
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s qhp %p rchp %p schp %p"
argument_list|,
name|__FUNCTION__
argument_list|,
name|qhp
argument_list|,
name|rchp
argument_list|,
name|schp
argument_list|)
expr_stmt|;
comment|/* take a ref on the qhp since we must release the lock */
name|qhp
operator|->
name|refcnt
operator|++
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
comment|/* locking hierarchy: cq lock first, then qp lock. */
name|mtx_lock
argument_list|(
operator|&
name|rchp
operator|->
name|lock
argument_list|)
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
name|cxio_flush_hw_cq
argument_list|(
operator|&
name|rchp
operator|->
name|cq
argument_list|)
expr_stmt|;
name|cxio_count_rcqes
argument_list|(
operator|&
name|rchp
operator|->
name|cq
argument_list|,
operator|&
name|qhp
operator|->
name|wq
argument_list|,
operator|&
name|count
argument_list|)
expr_stmt|;
name|flushed
operator|=
name|cxio_flush_rq
argument_list|(
operator|&
name|qhp
operator|->
name|wq
argument_list|,
operator|&
name|rchp
operator|->
name|cq
argument_list|,
name|count
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|rchp
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|flushed
condition|)
call|(
modifier|*
name|rchp
operator|->
name|ibcq
operator|.
name|comp_handler
call|)
argument_list|(
operator|&
name|rchp
operator|->
name|ibcq
argument_list|,
name|rchp
operator|->
name|ibcq
operator|.
name|cq_context
argument_list|)
expr_stmt|;
comment|/* locking hierarchy: cq lock first, then qp lock. */
name|mtx_lock
argument_list|(
operator|&
name|schp
operator|->
name|lock
argument_list|)
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
name|cxio_flush_hw_cq
argument_list|(
operator|&
name|schp
operator|->
name|cq
argument_list|)
expr_stmt|;
name|cxio_count_scqes
argument_list|(
operator|&
name|schp
operator|->
name|cq
argument_list|,
operator|&
name|qhp
operator|->
name|wq
argument_list|,
operator|&
name|count
argument_list|)
expr_stmt|;
name|flushed
operator|=
name|cxio_flush_sq
argument_list|(
operator|&
name|qhp
operator|->
name|wq
argument_list|,
operator|&
name|schp
operator|->
name|cq
argument_list|,
name|count
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|schp
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|flushed
condition|)
call|(
modifier|*
name|schp
operator|->
name|ibcq
operator|.
name|comp_handler
call|)
argument_list|(
operator|&
name|schp
operator|->
name|ibcq
argument_list|,
name|schp
operator|->
name|ibcq
operator|.
name|cq_context
argument_list|)
expr_stmt|;
comment|/* deref */
name|mtx_lock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
operator|--
name|qhp
operator|->
name|refcnt
operator|==
literal|0
condition|)
name|wakeup
argument_list|(
name|qhp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|flush_qp
parameter_list|(
name|struct
name|iwch_qp
modifier|*
name|qhp
parameter_list|)
block|{
name|struct
name|iwch_cq
modifier|*
name|rchp
decl_stmt|,
modifier|*
name|schp
decl_stmt|;
name|rchp
operator|=
name|get_chp
argument_list|(
name|qhp
operator|->
name|rhp
argument_list|,
name|qhp
operator|->
name|attr
operator|.
name|rcq
argument_list|)
expr_stmt|;
name|schp
operator|=
name|get_chp
argument_list|(
name|qhp
operator|->
name|rhp
argument_list|,
name|qhp
operator|->
name|attr
operator|.
name|scq
argument_list|)
expr_stmt|;
if|if
condition|(
name|qhp
operator|->
name|ibqp
operator|.
name|uobject
condition|)
block|{
name|cxio_set_wq_in_error
argument_list|(
operator|&
name|qhp
operator|->
name|wq
argument_list|)
expr_stmt|;
name|cxio_set_cq_in_error
argument_list|(
operator|&
name|rchp
operator|->
name|cq
argument_list|)
expr_stmt|;
call|(
modifier|*
name|rchp
operator|->
name|ibcq
operator|.
name|comp_handler
call|)
argument_list|(
operator|&
name|rchp
operator|->
name|ibcq
argument_list|,
name|rchp
operator|->
name|ibcq
operator|.
name|cq_context
argument_list|)
expr_stmt|;
if|if
condition|(
name|schp
operator|!=
name|rchp
condition|)
block|{
name|cxio_set_cq_in_error
argument_list|(
operator|&
name|schp
operator|->
name|cq
argument_list|)
expr_stmt|;
call|(
modifier|*
name|schp
operator|->
name|ibcq
operator|.
name|comp_handler
call|)
argument_list|(
operator|&
name|schp
operator|->
name|ibcq
argument_list|,
name|schp
operator|->
name|ibcq
operator|.
name|cq_context
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
name|__flush_qp
argument_list|(
name|qhp
argument_list|,
name|rchp
argument_list|,
name|schp
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Return non zero if at least one RECV was pre-posted.  */
end_comment

begin_function
specifier|static
name|int
name|rqes_posted
parameter_list|(
name|struct
name|iwch_qp
modifier|*
name|qhp
parameter_list|)
block|{
name|union
name|t3_wr
modifier|*
name|wqe
init|=
name|qhp
operator|->
name|wq
operator|.
name|queue
decl_stmt|;
name|u16
name|count
init|=
literal|0
decl_stmt|;
while|while
condition|(
operator|(
name|count
operator|+
literal|1
operator|)
operator|!=
literal|0
operator|&&
name|fw_riwrh_opcode
argument_list|(
operator|(
expr|struct
name|fw_riwrh
operator|*
operator|)
name|wqe
argument_list|)
operator|==
name|T3_WR_RCV
condition|)
block|{
name|count
operator|++
expr_stmt|;
name|wqe
operator|++
expr_stmt|;
block|}
return|return
name|count
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rdma_init
parameter_list|(
name|struct
name|iwch_dev
modifier|*
name|rhp
parameter_list|,
name|struct
name|iwch_qp
modifier|*
name|qhp
parameter_list|,
name|enum
name|iwch_qp_attr_mask
name|mask
parameter_list|,
name|struct
name|iwch_qp_attributes
modifier|*
name|attrs
parameter_list|)
block|{
name|struct
name|t3_rdma_init_attr
name|init_attr
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|struct
name|socket
modifier|*
name|so
init|=
name|qhp
operator|->
name|ep
operator|->
name|com
operator|.
name|so
decl_stmt|;
name|struct
name|inpcb
modifier|*
name|inp
init|=
name|sotoinpcb
argument_list|(
name|so
argument_list|)
decl_stmt|;
name|struct
name|tcpcb
modifier|*
name|tp
decl_stmt|;
name|struct
name|toepcb
modifier|*
name|toep
decl_stmt|;
name|init_attr
operator|.
name|tid
operator|=
name|qhp
operator|->
name|ep
operator|->
name|hwtid
expr_stmt|;
name|init_attr
operator|.
name|qpid
operator|=
name|qhp
operator|->
name|wq
operator|.
name|qpid
expr_stmt|;
name|init_attr
operator|.
name|pdid
operator|=
name|qhp
operator|->
name|attr
operator|.
name|pd
expr_stmt|;
name|init_attr
operator|.
name|scqid
operator|=
name|qhp
operator|->
name|attr
operator|.
name|scq
expr_stmt|;
name|init_attr
operator|.
name|rcqid
operator|=
name|qhp
operator|->
name|attr
operator|.
name|rcq
expr_stmt|;
name|init_attr
operator|.
name|rq_addr
operator|=
name|qhp
operator|->
name|wq
operator|.
name|rq_addr
expr_stmt|;
name|init_attr
operator|.
name|rq_size
operator|=
literal|1
operator|<<
name|qhp
operator|->
name|wq
operator|.
name|rq_size_log2
expr_stmt|;
name|init_attr
operator|.
name|mpaattrs
operator|=
name|uP_RI_MPA_IETF_ENABLE
operator||
name|qhp
operator|->
name|attr
operator|.
name|mpa_attr
operator|.
name|recv_marker_enabled
operator||
operator|(
name|qhp
operator|->
name|attr
operator|.
name|mpa_attr
operator|.
name|xmit_marker_enabled
operator|<<
literal|1
operator|)
operator||
operator|(
name|qhp
operator|->
name|attr
operator|.
name|mpa_attr
operator|.
name|crc_enabled
operator|<<
literal|2
operator|)
expr_stmt|;
name|init_attr
operator|.
name|qpcaps
operator|=
name|uP_RI_QP_RDMA_READ_ENABLE
operator||
name|uP_RI_QP_RDMA_WRITE_ENABLE
operator||
name|uP_RI_QP_BIND_ENABLE
expr_stmt|;
if|if
condition|(
operator|!
name|qhp
operator|->
name|ibqp
operator|.
name|uobject
condition|)
name|init_attr
operator|.
name|qpcaps
operator||=
name|uP_RI_QP_STAG0_ENABLE
expr_stmt|;
name|init_attr
operator|.
name|tcp_emss
operator|=
name|qhp
operator|->
name|ep
operator|->
name|emss
expr_stmt|;
name|init_attr
operator|.
name|ord
operator|=
name|qhp
operator|->
name|attr
operator|.
name|max_ord
expr_stmt|;
name|init_attr
operator|.
name|ird
operator|=
name|qhp
operator|->
name|attr
operator|.
name|max_ird
expr_stmt|;
name|init_attr
operator|.
name|qp_dma_addr
operator|=
name|qhp
operator|->
name|wq
operator|.
name|dma_addr
expr_stmt|;
name|init_attr
operator|.
name|qp_dma_size
operator|=
operator|(
literal|1UL
operator|<<
name|qhp
operator|->
name|wq
operator|.
name|size_log2
operator|)
expr_stmt|;
name|init_attr
operator|.
name|rqe_count
operator|=
name|rqes_posted
argument_list|(
name|qhp
argument_list|)
expr_stmt|;
name|init_attr
operator|.
name|flags
operator|=
name|qhp
operator|->
name|attr
operator|.
name|mpa_attr
operator|.
name|initiator
condition|?
name|MPA_INITIATOR
else|:
literal|0
expr_stmt|;
name|init_attr
operator|.
name|rtr_type
operator|=
literal|0
expr_stmt|;
name|tp
operator|=
name|intotcpcb
argument_list|(
name|inp
argument_list|)
expr_stmt|;
name|toep
operator|=
name|tp
operator|->
name|t_toe
expr_stmt|;
name|init_attr
operator|.
name|chan
operator|=
name|toep
operator|->
name|tp_l2t
operator|->
name|smt_idx
expr_stmt|;
name|init_attr
operator|.
name|irs
operator|=
name|qhp
operator|->
name|ep
operator|->
name|rcv_seq
expr_stmt|;
name|CTR5
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s init_attr.rq_addr 0x%x init_attr.rq_size = %d "
literal|"flags 0x%x qpcaps 0x%x"
argument_list|,
name|__FUNCTION__
argument_list|,
name|init_attr
operator|.
name|rq_addr
argument_list|,
name|init_attr
operator|.
name|rq_size
argument_list|,
name|init_attr
operator|.
name|flags
argument_list|,
name|init_attr
operator|.
name|qpcaps
argument_list|)
expr_stmt|;
name|ret
operator|=
name|cxio_rdma_init
argument_list|(
operator|&
name|rhp
operator|->
name|rdev
argument_list|,
operator|&
name|init_attr
argument_list|,
name|qhp
operator|->
name|ep
operator|->
name|com
operator|.
name|so
argument_list|)
expr_stmt|;
name|CTR2
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s ret %d"
argument_list|,
name|__FUNCTION__
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|iwch_modify_qp
parameter_list|(
name|struct
name|iwch_dev
modifier|*
name|rhp
parameter_list|,
name|struct
name|iwch_qp
modifier|*
name|qhp
parameter_list|,
name|enum
name|iwch_qp_attr_mask
name|mask
parameter_list|,
name|struct
name|iwch_qp_attributes
modifier|*
name|attrs
parameter_list|,
name|int
name|internal
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|struct
name|iwch_qp_attributes
name|newattr
init|=
name|qhp
operator|->
name|attr
decl_stmt|;
name|int
name|disconnect
init|=
literal|0
decl_stmt|;
name|int
name|terminate
init|=
literal|0
decl_stmt|;
name|int
name|abort
init|=
literal|0
decl_stmt|;
name|int
name|free
init|=
literal|0
decl_stmt|;
name|struct
name|iwch_ep
modifier|*
name|ep
init|=
name|NULL
decl_stmt|;
name|CTR6
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s qhp %p qpid 0x%x ep %p state %d -> %d"
argument_list|,
name|__FUNCTION__
argument_list|,
name|qhp
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|qpid
argument_list|,
name|qhp
operator|->
name|ep
argument_list|,
name|qhp
operator|->
name|attr
operator|.
name|state
argument_list|,
operator|(
name|mask
operator|&
name|IWCH_QP_ATTR_NEXT_STATE
operator|)
condition|?
name|attrs
operator|->
name|next_state
else|:
operator|-
literal|1
argument_list|)
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
comment|/* Process attr changes if in IDLE */
if|if
condition|(
name|mask
operator|&
name|IWCH_QP_ATTR_VALID_MODIFY
condition|)
block|{
if|if
condition|(
name|qhp
operator|->
name|attr
operator|.
name|state
operator|!=
name|IWCH_QP_STATE_IDLE
condition|)
block|{
name|ret
operator|=
operator|-
name|EIO
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|mask
operator|&
name|IWCH_QP_ATTR_ENABLE_RDMA_READ
condition|)
name|newattr
operator|.
name|enable_rdma_read
operator|=
name|attrs
operator|->
name|enable_rdma_read
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|IWCH_QP_ATTR_ENABLE_RDMA_WRITE
condition|)
name|newattr
operator|.
name|enable_rdma_write
operator|=
name|attrs
operator|->
name|enable_rdma_write
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|IWCH_QP_ATTR_ENABLE_RDMA_BIND
condition|)
name|newattr
operator|.
name|enable_bind
operator|=
name|attrs
operator|->
name|enable_bind
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|IWCH_QP_ATTR_MAX_ORD
condition|)
block|{
if|if
condition|(
name|attrs
operator|->
name|max_ord
operator|>
name|rhp
operator|->
name|attr
operator|.
name|max_rdma_read_qp_depth
condition|)
block|{
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|newattr
operator|.
name|max_ord
operator|=
name|attrs
operator|->
name|max_ord
expr_stmt|;
block|}
if|if
condition|(
name|mask
operator|&
name|IWCH_QP_ATTR_MAX_IRD
condition|)
block|{
if|if
condition|(
name|attrs
operator|->
name|max_ird
operator|>
name|rhp
operator|->
name|attr
operator|.
name|max_rdma_reads_per_qp
condition|)
block|{
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|newattr
operator|.
name|max_ird
operator|=
name|attrs
operator|->
name|max_ird
expr_stmt|;
block|}
name|qhp
operator|->
name|attr
operator|=
name|newattr
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|(
name|mask
operator|&
name|IWCH_QP_ATTR_NEXT_STATE
operator|)
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
name|qhp
operator|->
name|attr
operator|.
name|state
operator|==
name|attrs
operator|->
name|next_state
condition|)
goto|goto
name|out
goto|;
switch|switch
condition|(
name|qhp
operator|->
name|attr
operator|.
name|state
condition|)
block|{
case|case
name|IWCH_QP_STATE_IDLE
case|:
switch|switch
condition|(
name|attrs
operator|->
name|next_state
condition|)
block|{
case|case
name|IWCH_QP_STATE_RTS
case|:
if|if
condition|(
operator|!
operator|(
name|mask
operator|&
name|IWCH_QP_ATTR_LLP_STREAM_HANDLE
operator|)
condition|)
block|{
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
operator|!
operator|(
name|mask
operator|&
name|IWCH_QP_ATTR_MPA_ATTR
operator|)
condition|)
block|{
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|qhp
operator|->
name|attr
operator|.
name|mpa_attr
operator|=
name|attrs
operator|->
name|mpa_attr
expr_stmt|;
name|qhp
operator|->
name|attr
operator|.
name|llp_stream_handle
operator|=
name|attrs
operator|->
name|llp_stream_handle
expr_stmt|;
name|qhp
operator|->
name|ep
operator|=
name|qhp
operator|->
name|attr
operator|.
name|llp_stream_handle
expr_stmt|;
name|qhp
operator|->
name|attr
operator|.
name|state
operator|=
name|IWCH_QP_STATE_RTS
expr_stmt|;
comment|/* 			 * Ref the endpoint here and deref when we 			 * disassociate the endpoint from the QP.  This 			 * happens in CLOSING->IDLE transition or *->ERROR 			 * transition. 			 */
name|get_ep
argument_list|(
operator|&
name|qhp
operator|->
name|ep
operator|->
name|com
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
name|ret
operator|=
name|rdma_init
argument_list|(
name|rhp
argument_list|,
name|qhp
argument_list|,
name|mask
argument_list|,
name|attrs
argument_list|)
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err
goto|;
break|break;
case|case
name|IWCH_QP_STATE_ERROR
case|:
name|qhp
operator|->
name|attr
operator|.
name|state
operator|=
name|IWCH_QP_STATE_ERROR
expr_stmt|;
name|flush_qp
argument_list|(
name|qhp
argument_list|)
expr_stmt|;
break|break;
default|default:
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
break|break;
case|case
name|IWCH_QP_STATE_RTS
case|:
switch|switch
condition|(
name|attrs
operator|->
name|next_state
condition|)
block|{
case|case
name|IWCH_QP_STATE_CLOSING
case|:
name|PANIC_IF
argument_list|(
name|atomic_load_acq_int
argument_list|(
operator|&
name|qhp
operator|->
name|ep
operator|->
name|com
operator|.
name|refcount
argument_list|)
operator|<
literal|2
argument_list|)
expr_stmt|;
name|qhp
operator|->
name|attr
operator|.
name|state
operator|=
name|IWCH_QP_STATE_CLOSING
expr_stmt|;
if|if
condition|(
operator|!
name|internal
condition|)
block|{
name|abort
operator|=
literal|0
expr_stmt|;
name|disconnect
operator|=
literal|1
expr_stmt|;
name|ep
operator|=
name|qhp
operator|->
name|ep
expr_stmt|;
name|get_ep
argument_list|(
operator|&
name|ep
operator|->
name|com
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|IWCH_QP_STATE_TERMINATE
case|:
name|qhp
operator|->
name|attr
operator|.
name|state
operator|=
name|IWCH_QP_STATE_TERMINATE
expr_stmt|;
if|if
condition|(
name|qhp
operator|->
name|ibqp
operator|.
name|uobject
condition|)
name|cxio_set_wq_in_error
argument_list|(
operator|&
name|qhp
operator|->
name|wq
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|internal
condition|)
name|terminate
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|IWCH_QP_STATE_ERROR
case|:
name|qhp
operator|->
name|attr
operator|.
name|state
operator|=
name|IWCH_QP_STATE_ERROR
expr_stmt|;
if|if
condition|(
operator|!
name|internal
condition|)
block|{
name|abort
operator|=
literal|1
expr_stmt|;
name|disconnect
operator|=
literal|1
expr_stmt|;
name|ep
operator|=
name|qhp
operator|->
name|ep
expr_stmt|;
name|get_ep
argument_list|(
operator|&
name|ep
operator|->
name|com
argument_list|)
expr_stmt|;
block|}
goto|goto
name|err
goto|;
break|break;
default|default:
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
break|break;
case|case
name|IWCH_QP_STATE_CLOSING
case|:
if|if
condition|(
operator|!
name|internal
condition|)
block|{
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
switch|switch
condition|(
name|attrs
operator|->
name|next_state
condition|)
block|{
case|case
name|IWCH_QP_STATE_IDLE
case|:
name|flush_qp
argument_list|(
name|qhp
argument_list|)
expr_stmt|;
name|qhp
operator|->
name|attr
operator|.
name|state
operator|=
name|IWCH_QP_STATE_IDLE
expr_stmt|;
name|qhp
operator|->
name|attr
operator|.
name|llp_stream_handle
operator|=
name|NULL
expr_stmt|;
name|put_ep
argument_list|(
operator|&
name|qhp
operator|->
name|ep
operator|->
name|com
argument_list|)
expr_stmt|;
name|qhp
operator|->
name|ep
operator|=
name|NULL
expr_stmt|;
name|wakeup
argument_list|(
name|qhp
argument_list|)
expr_stmt|;
break|break;
case|case
name|IWCH_QP_STATE_ERROR
case|:
goto|goto
name|err
goto|;
default|default:
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|err
goto|;
block|}
break|break;
case|case
name|IWCH_QP_STATE_ERROR
case|:
if|if
condition|(
name|attrs
operator|->
name|next_state
operator|!=
name|IWCH_QP_STATE_IDLE
condition|)
block|{
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
operator|!
name|Q_EMPTY
argument_list|(
name|qhp
operator|->
name|wq
operator|.
name|sq_rptr
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|sq_wptr
argument_list|)
operator|||
operator|!
name|Q_EMPTY
argument_list|(
name|qhp
operator|->
name|wq
operator|.
name|rq_rptr
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|rq_wptr
argument_list|)
condition|)
block|{
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|qhp
operator|->
name|attr
operator|.
name|state
operator|=
name|IWCH_QP_STATE_IDLE
expr_stmt|;
name|memset
argument_list|(
operator|&
name|qhp
operator|->
name|attr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|qhp
operator|->
name|attr
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|IWCH_QP_STATE_TERMINATE
case|:
if|if
condition|(
operator|!
name|internal
condition|)
block|{
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
goto|goto
name|err
goto|;
break|break;
default|default:
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"%s in a bad state %d\n"
argument_list|,
name|__FUNCTION__
argument_list|,
name|qhp
operator|->
name|attr
operator|.
name|state
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|err
goto|;
break|break;
block|}
goto|goto
name|out
goto|;
name|err
label|:
name|CTR3
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s disassociating ep %p qpid 0x%x"
argument_list|,
name|__FUNCTION__
argument_list|,
name|qhp
operator|->
name|ep
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|qpid
argument_list|)
expr_stmt|;
comment|/* disassociate the LLP connection */
name|qhp
operator|->
name|attr
operator|.
name|llp_stream_handle
operator|=
name|NULL
expr_stmt|;
name|ep
operator|=
name|qhp
operator|->
name|ep
expr_stmt|;
name|qhp
operator|->
name|ep
operator|=
name|NULL
expr_stmt|;
name|qhp
operator|->
name|attr
operator|.
name|state
operator|=
name|IWCH_QP_STATE_ERROR
expr_stmt|;
name|free
operator|=
literal|1
expr_stmt|;
name|wakeup
argument_list|(
name|qhp
argument_list|)
expr_stmt|;
name|PANIC_IF
argument_list|(
operator|!
name|ep
argument_list|)
expr_stmt|;
name|flush_qp
argument_list|(
name|qhp
argument_list|)
expr_stmt|;
name|out
label|:
name|mtx_unlock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|terminate
condition|)
name|iwch_post_terminate
argument_list|(
name|qhp
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* 	 * If disconnect is 1, then we need to initiate a disconnect 	 * on the EP.  This can be a normal close (RTS->CLOSING) or 	 * an abnormal close (RTS/CLOSING->ERROR). 	 */
if|if
condition|(
name|disconnect
condition|)
block|{
name|iwch_ep_disconnect
argument_list|(
name|ep
argument_list|,
name|abort
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
name|put_ep
argument_list|(
operator|&
name|ep
operator|->
name|com
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * If free is 1, then we've disassociated the EP from the QP 	 * and we need to dereference the EP. 	 */
if|if
condition|(
name|free
condition|)
name|put_ep
argument_list|(
operator|&
name|ep
operator|->
name|com
argument_list|)
expr_stmt|;
name|CTR2
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s exit state %d"
argument_list|,
name|__FUNCTION__
argument_list|,
name|qhp
operator|->
name|attr
operator|.
name|state
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

end_unit


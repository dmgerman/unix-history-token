begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/**************************************************************************  Copyright (c) 2007, Chelsio Inc. All rights reserved.  Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:   1. Redistributions of source code must retain the above copyright notice,     this list of conditions and the following disclaimer.   2. Neither the name of the Chelsio Corporation nor the names of its     contributors may be used to endorse or promote products derived from     this software without specific prior written permission.  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  ***************************************************************************/
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"opt_inet.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|TCP_OFFLOAD
end_ifdef

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/pciio.h>
end_include

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus_dma.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioccom.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<sys/rwlock.h>
end_include

begin_include
include|#
directive|include
file|<sys/linker.h>
end_include

begin_include
include|#
directive|include
file|<sys/firmware.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_include
include|#
directive|include
file|<sys/smp.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/syslog.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<sys/taskqueue.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm.h>
end_include

begin_include
include|#
directive|include
file|<vm/pmap.h>
end_include

begin_include
include|#
directive|include
file|<rdma/ib_verbs.h>
end_include

begin_include
include|#
directive|include
file|<rdma/ib_umem.h>
end_include

begin_include
include|#
directive|include
file|<rdma/ib_user_verbs.h>
end_include

begin_include
include|#
directive|include
file|<linux/idr.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_ib_intfc.h>
end_include

begin_include
include|#
directive|include
file|<cxgb_include.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_wr.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_hal.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_provider.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_cm.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_resource.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_user.h>
end_include

begin_function
specifier|static
name|int
name|iwch_modify_port
parameter_list|(
name|struct
name|ib_device
modifier|*
name|ibdev
parameter_list|,
name|u8
name|port
parameter_list|,
name|int
name|port_modify_mask
parameter_list|,
name|struct
name|ib_port_modify
modifier|*
name|props
parameter_list|)
block|{
return|return
operator|(
operator|-
name|ENOSYS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|ib_ah
modifier|*
name|iwch_ah_create
parameter_list|(
name|struct
name|ib_pd
modifier|*
name|pd
parameter_list|,
name|struct
name|ib_ah_attr
modifier|*
name|ah_attr
parameter_list|)
block|{
return|return
name|ERR_PTR
argument_list|(
operator|-
name|ENOSYS
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|iwch_ah_destroy
parameter_list|(
name|struct
name|ib_ah
modifier|*
name|ah
parameter_list|)
block|{
return|return
operator|(
operator|-
name|ENOSYS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|iwch_multicast_attach
parameter_list|(
name|struct
name|ib_qp
modifier|*
name|ibqp
parameter_list|,
name|union
name|ib_gid
modifier|*
name|gid
parameter_list|,
name|u16
name|lid
parameter_list|)
block|{
return|return
operator|(
operator|-
name|ENOSYS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|iwch_multicast_detach
parameter_list|(
name|struct
name|ib_qp
modifier|*
name|ibqp
parameter_list|,
name|union
name|ib_gid
modifier|*
name|gid
parameter_list|,
name|u16
name|lid
parameter_list|)
block|{
return|return
operator|(
operator|-
name|ENOSYS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|iwch_process_mad
parameter_list|(
name|struct
name|ib_device
modifier|*
name|ibdev
parameter_list|,
name|int
name|mad_flags
parameter_list|,
name|u8
name|port_num
parameter_list|,
name|struct
name|ib_wc
modifier|*
name|in_wc
parameter_list|,
name|struct
name|ib_grh
modifier|*
name|in_grh
parameter_list|,
name|struct
name|ib_mad
modifier|*
name|in_mad
parameter_list|,
name|struct
name|ib_mad
modifier|*
name|out_mad
parameter_list|)
block|{
return|return
operator|(
operator|-
name|ENOSYS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|iwch_dealloc_ucontext
parameter_list|(
name|struct
name|ib_ucontext
modifier|*
name|context
parameter_list|)
block|{
name|struct
name|iwch_dev
modifier|*
name|rhp
init|=
name|to_iwch_dev
argument_list|(
name|context
operator|->
name|device
argument_list|)
decl_stmt|;
name|struct
name|iwch_ucontext
modifier|*
name|ucontext
init|=
name|to_iwch_ucontext
argument_list|(
name|context
argument_list|)
decl_stmt|;
name|struct
name|iwch_mm_entry
modifier|*
name|mm
decl_stmt|,
modifier|*
name|tmp
decl_stmt|;
name|CTR2
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s context %p"
argument_list|,
name|__FUNCTION__
argument_list|,
name|context
argument_list|)
expr_stmt|;
name|TAILQ_FOREACH_SAFE
argument_list|(
argument|mm
argument_list|,
argument|&ucontext->mmaps
argument_list|,
argument|entry
argument_list|,
argument|tmp
argument_list|)
block|{
name|TAILQ_REMOVE
argument_list|(
operator|&
name|ucontext
operator|->
name|mmaps
argument_list|,
name|mm
argument_list|,
name|entry
argument_list|)
expr_stmt|;
name|cxfree
argument_list|(
name|mm
argument_list|)
expr_stmt|;
block|}
name|cxio_release_ucontext
argument_list|(
operator|&
name|rhp
operator|->
name|rdev
argument_list|,
operator|&
name|ucontext
operator|->
name|uctx
argument_list|)
expr_stmt|;
name|cxfree
argument_list|(
name|ucontext
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|ib_ucontext
modifier|*
name|iwch_alloc_ucontext
parameter_list|(
name|struct
name|ib_device
modifier|*
name|ibdev
parameter_list|,
name|struct
name|ib_udata
modifier|*
name|udata
parameter_list|)
block|{
name|struct
name|iwch_ucontext
modifier|*
name|context
decl_stmt|;
name|struct
name|iwch_dev
modifier|*
name|rhp
init|=
name|to_iwch_dev
argument_list|(
name|ibdev
argument_list|)
decl_stmt|;
name|CTR2
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s ibdev %p"
argument_list|,
name|__FUNCTION__
argument_list|,
name|ibdev
argument_list|)
expr_stmt|;
name|context
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|context
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_ZERO
operator||
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|context
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|ENOMEM
argument_list|)
return|;
name|cxio_init_ucontext
argument_list|(
operator|&
name|rhp
operator|->
name|rdev
argument_list|,
operator|&
name|context
operator|->
name|uctx
argument_list|)
expr_stmt|;
name|TAILQ_INIT
argument_list|(
operator|&
name|context
operator|->
name|mmaps
argument_list|)
expr_stmt|;
name|mtx_init
argument_list|(
operator|&
name|context
operator|->
name|mmap_lock
argument_list|,
literal|"ucontext mmap"
argument_list|,
name|NULL
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
return|return
operator|&
name|context
operator|->
name|ibucontext
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|iwch_destroy_cq
parameter_list|(
name|struct
name|ib_cq
modifier|*
name|ib_cq
parameter_list|)
block|{
name|struct
name|iwch_cq
modifier|*
name|chp
decl_stmt|;
name|CTR2
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s ib_cq %p"
argument_list|,
name|__FUNCTION__
argument_list|,
name|ib_cq
argument_list|)
expr_stmt|;
name|chp
operator|=
name|to_iwch_cq
argument_list|(
name|ib_cq
argument_list|)
expr_stmt|;
name|remove_handle
argument_list|(
name|chp
operator|->
name|rhp
argument_list|,
operator|&
name|chp
operator|->
name|rhp
operator|->
name|cqidr
argument_list|,
name|chp
operator|->
name|cq
operator|.
name|cqid
argument_list|)
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|chp
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
operator|--
name|chp
operator|->
name|refcnt
condition|)
name|msleep
argument_list|(
name|chp
argument_list|,
operator|&
name|chp
operator|->
name|lock
argument_list|,
literal|0
argument_list|,
literal|"iwch_destroy_cq"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|chp
operator|->
name|lock
argument_list|)
expr_stmt|;
name|cxio_destroy_cq
argument_list|(
operator|&
name|chp
operator|->
name|rhp
operator|->
name|rdev
argument_list|,
operator|&
name|chp
operator|->
name|cq
argument_list|)
expr_stmt|;
name|cxfree
argument_list|(
name|chp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|ib_cq
modifier|*
name|iwch_create_cq
parameter_list|(
name|struct
name|ib_device
modifier|*
name|ibdev
parameter_list|,
name|struct
name|ib_cq_init_attr
modifier|*
name|attr
parameter_list|,
name|struct
name|ib_ucontext
modifier|*
name|ib_context
parameter_list|,
name|struct
name|ib_udata
modifier|*
name|udata
parameter_list|)
block|{
name|struct
name|iwch_dev
modifier|*
name|rhp
decl_stmt|;
name|struct
name|iwch_cq
modifier|*
name|chp
decl_stmt|;
name|struct
name|iwch_create_cq_resp
name|uresp
decl_stmt|;
name|struct
name|iwch_create_cq_req
name|ureq
decl_stmt|;
name|struct
name|iwch_ucontext
modifier|*
name|ucontext
init|=
name|NULL
decl_stmt|;
specifier|static
name|int
name|warned
decl_stmt|;
name|size_t
name|resplen
decl_stmt|;
name|int
name|entries
init|=
name|attr
operator|->
name|cqe
decl_stmt|;
name|CTR3
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s ib_dev %p entries %d"
argument_list|,
name|__FUNCTION__
argument_list|,
name|ibdev
argument_list|,
name|entries
argument_list|)
expr_stmt|;
name|rhp
operator|=
name|to_iwch_dev
argument_list|(
name|ibdev
argument_list|)
expr_stmt|;
name|chp
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|chp
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|chp
condition|)
block|{
return|return
name|ERR_PTR
argument_list|(
operator|-
name|ENOMEM
argument_list|)
return|;
block|}
if|if
condition|(
name|ib_context
condition|)
block|{
name|ucontext
operator|=
name|to_iwch_ucontext
argument_list|(
name|ib_context
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|t3a_device
argument_list|(
name|rhp
argument_list|)
condition|)
block|{
if|if
condition|(
name|ib_copy_from_udata
argument_list|(
operator|&
name|ureq
argument_list|,
name|udata
argument_list|,
sizeof|sizeof
argument_list|(
name|ureq
argument_list|)
argument_list|)
condition|)
block|{
name|cxfree
argument_list|(
name|chp
argument_list|)
expr_stmt|;
return|return
name|ERR_PTR
argument_list|(
operator|-
name|EFAULT
argument_list|)
return|;
block|}
name|chp
operator|->
name|user_rptr_addr
operator|=
operator|(
name|u32
comment|/*__user */
operator|*
operator|)
operator|(
name|unsigned
name|long
operator|)
name|ureq
operator|.
name|user_rptr_addr
expr_stmt|;
block|}
block|}
if|if
condition|(
name|t3a_device
argument_list|(
name|rhp
argument_list|)
condition|)
block|{
comment|/* 		 * T3A: Add some fluff to handle extra CQEs inserted 		 * for various errors. 		 * Additional CQE possibilities: 		 *      TERMINATE, 		 *      incoming RDMA WRITE Failures 		 *      incoming RDMA READ REQUEST FAILUREs 		 * NOTE: We cannot ensure the CQ won't overflow. 		 */
name|entries
operator|+=
literal|16
expr_stmt|;
block|}
name|entries
operator|=
name|roundup_pow_of_two
argument_list|(
name|entries
argument_list|)
expr_stmt|;
name|chp
operator|->
name|cq
operator|.
name|size_log2
operator|=
name|ilog2
argument_list|(
name|entries
argument_list|)
expr_stmt|;
if|if
condition|(
name|cxio_create_cq
argument_list|(
operator|&
name|rhp
operator|->
name|rdev
argument_list|,
operator|&
name|chp
operator|->
name|cq
argument_list|,
operator|!
name|ucontext
argument_list|)
condition|)
block|{
name|cxfree
argument_list|(
name|chp
argument_list|)
expr_stmt|;
return|return
name|ERR_PTR
argument_list|(
operator|-
name|ENOMEM
argument_list|)
return|;
block|}
name|chp
operator|->
name|rhp
operator|=
name|rhp
expr_stmt|;
name|chp
operator|->
name|ibcq
operator|.
name|cqe
operator|=
literal|1
operator|<<
name|chp
operator|->
name|cq
operator|.
name|size_log2
expr_stmt|;
name|mtx_init
argument_list|(
operator|&
name|chp
operator|->
name|lock
argument_list|,
literal|"cxgb cq"
argument_list|,
name|NULL
argument_list|,
name|MTX_DEF
operator||
name|MTX_DUPOK
argument_list|)
expr_stmt|;
name|chp
operator|->
name|refcnt
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|insert_handle
argument_list|(
name|rhp
argument_list|,
operator|&
name|rhp
operator|->
name|cqidr
argument_list|,
name|chp
argument_list|,
name|chp
operator|->
name|cq
operator|.
name|cqid
argument_list|)
condition|)
block|{
name|cxio_destroy_cq
argument_list|(
operator|&
name|chp
operator|->
name|rhp
operator|->
name|rdev
argument_list|,
operator|&
name|chp
operator|->
name|cq
argument_list|)
expr_stmt|;
name|cxfree
argument_list|(
name|chp
argument_list|)
expr_stmt|;
return|return
name|ERR_PTR
argument_list|(
operator|-
name|ENOMEM
argument_list|)
return|;
block|}
if|if
condition|(
name|ucontext
condition|)
block|{
name|struct
name|iwch_mm_entry
modifier|*
name|mm
decl_stmt|;
name|mm
operator|=
name|kmalloc
argument_list|(
sizeof|sizeof
expr|*
name|mm
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mm
condition|)
block|{
name|iwch_destroy_cq
argument_list|(
operator|&
name|chp
operator|->
name|ibcq
argument_list|)
expr_stmt|;
return|return
name|ERR_PTR
argument_list|(
operator|-
name|ENOMEM
argument_list|)
return|;
block|}
name|uresp
operator|.
name|cqid
operator|=
name|chp
operator|->
name|cq
operator|.
name|cqid
expr_stmt|;
name|uresp
operator|.
name|size_log2
operator|=
name|chp
operator|->
name|cq
operator|.
name|size_log2
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|ucontext
operator|->
name|mmap_lock
argument_list|)
expr_stmt|;
name|uresp
operator|.
name|key
operator|=
name|ucontext
operator|->
name|key
expr_stmt|;
name|ucontext
operator|->
name|key
operator|+=
name|PAGE_SIZE
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|ucontext
operator|->
name|mmap_lock
argument_list|)
expr_stmt|;
name|mm
operator|->
name|key
operator|=
name|uresp
operator|.
name|key
expr_stmt|;
name|mm
operator|->
name|addr
operator|=
name|vtophys
argument_list|(
name|chp
operator|->
name|cq
operator|.
name|queue
argument_list|)
expr_stmt|;
if|if
condition|(
name|udata
operator|->
name|outlen
operator|<
sizeof|sizeof
name|uresp
condition|)
block|{
if|if
condition|(
operator|!
name|warned
operator|++
condition|)
name|CTR1
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s Warning - "
literal|"downlevel libcxgb3 (non-fatal).\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|mm
operator|->
name|len
operator|=
name|PAGE_ALIGN
argument_list|(
operator|(
literal|1UL
operator|<<
name|uresp
operator|.
name|size_log2
operator|)
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|t3_cqe
argument_list|)
argument_list|)
expr_stmt|;
name|resplen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|iwch_create_cq_resp_v0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|mm
operator|->
name|len
operator|=
name|PAGE_ALIGN
argument_list|(
operator|(
operator|(
literal|1UL
operator|<<
name|uresp
operator|.
name|size_log2
operator|)
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|t3_cqe
argument_list|)
argument_list|)
expr_stmt|;
name|uresp
operator|.
name|memsize
operator|=
name|mm
operator|->
name|len
expr_stmt|;
name|resplen
operator|=
sizeof|sizeof
name|uresp
expr_stmt|;
block|}
if|if
condition|(
name|ib_copy_to_udata
argument_list|(
name|udata
argument_list|,
operator|&
name|uresp
argument_list|,
name|resplen
argument_list|)
condition|)
block|{
name|cxfree
argument_list|(
name|mm
argument_list|)
expr_stmt|;
name|iwch_destroy_cq
argument_list|(
operator|&
name|chp
operator|->
name|ibcq
argument_list|)
expr_stmt|;
return|return
name|ERR_PTR
argument_list|(
operator|-
name|EFAULT
argument_list|)
return|;
block|}
name|insert_mmap
argument_list|(
name|ucontext
argument_list|,
name|mm
argument_list|)
expr_stmt|;
block|}
name|CTR4
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"created cqid 0x%0x chp %p size 0x%0x, dma_addr 0x%0llx"
argument_list|,
name|chp
operator|->
name|cq
operator|.
name|cqid
argument_list|,
name|chp
argument_list|,
operator|(
literal|1
operator|<<
name|chp
operator|->
name|cq
operator|.
name|size_log2
operator|)
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|chp
operator|->
name|cq
operator|.
name|dma_addr
argument_list|)
expr_stmt|;
return|return
operator|&
name|chp
operator|->
name|ibcq
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|iwch_resize_cq
parameter_list|(
name|struct
name|ib_cq
modifier|*
name|cq
name|__unused
parameter_list|,
name|int
name|cqe
name|__unused
parameter_list|,
name|struct
name|ib_udata
modifier|*
name|udata
name|__unused
parameter_list|)
block|{
return|return
operator|(
operator|-
name|ENOSYS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|iwch_arm_cq
parameter_list|(
name|struct
name|ib_cq
modifier|*
name|ibcq
parameter_list|,
name|enum
name|ib_cq_notify_flags
name|flags
parameter_list|)
block|{
name|struct
name|iwch_dev
modifier|*
name|rhp
decl_stmt|;
name|struct
name|iwch_cq
modifier|*
name|chp
decl_stmt|;
name|enum
name|t3_cq_opcode
name|cq_op
decl_stmt|;
name|int
name|err
decl_stmt|;
name|u32
name|rptr
decl_stmt|;
name|chp
operator|=
name|to_iwch_cq
argument_list|(
name|ibcq
argument_list|)
expr_stmt|;
name|rhp
operator|=
name|chp
operator|->
name|rhp
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|IB_CQ_SOLICITED_MASK
operator|)
operator|==
name|IB_CQ_SOLICITED
condition|)
name|cq_op
operator|=
name|CQ_ARM_SE
expr_stmt|;
else|else
name|cq_op
operator|=
name|CQ_ARM_AN
expr_stmt|;
if|if
condition|(
name|chp
operator|->
name|user_rptr_addr
condition|)
block|{
if|if
condition|(
name|copyin
argument_list|(
operator|&
name|rptr
argument_list|,
name|chp
operator|->
name|user_rptr_addr
argument_list|,
literal|4
argument_list|)
condition|)
return|return
operator|(
operator|-
name|EFAULT
operator|)
return|;
name|mtx_lock
argument_list|(
operator|&
name|chp
operator|->
name|lock
argument_list|)
expr_stmt|;
name|chp
operator|->
name|cq
operator|.
name|rptr
operator|=
name|rptr
expr_stmt|;
block|}
else|else
name|mtx_lock
argument_list|(
operator|&
name|chp
operator|->
name|lock
argument_list|)
expr_stmt|;
name|CTR2
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s rptr 0x%x"
argument_list|,
name|__FUNCTION__
argument_list|,
name|chp
operator|->
name|cq
operator|.
name|rptr
argument_list|)
expr_stmt|;
name|err
operator|=
name|cxio_hal_cq_op
argument_list|(
operator|&
name|rhp
operator|->
name|rdev
argument_list|,
operator|&
name|chp
operator|->
name|cq
argument_list|,
name|cq_op
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|chp
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|<
literal|0
condition|)
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"Error %d rearming CQID 0x%x\n"
argument_list|,
name|err
argument_list|,
name|chp
operator|->
name|cq
operator|.
name|cqid
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|>
literal|0
operator|&&
operator|!
operator|(
name|flags
operator|&
name|IB_CQ_REPORT_MISSED_EVENTS
operator|)
condition|)
name|err
operator|=
literal|0
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|iwch_mmap
parameter_list|(
name|struct
name|ib_ucontext
modifier|*
name|context
name|__unused
parameter_list|,
name|struct
name|vm_area_struct
modifier|*
name|vma
name|__unused
parameter_list|)
block|{
return|return
operator|(
operator|-
name|ENOSYS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|iwch_deallocate_pd
parameter_list|(
name|struct
name|ib_pd
modifier|*
name|pd
parameter_list|)
block|{
name|struct
name|iwch_dev
modifier|*
name|rhp
decl_stmt|;
name|struct
name|iwch_pd
modifier|*
name|php
decl_stmt|;
name|php
operator|=
name|to_iwch_pd
argument_list|(
name|pd
argument_list|)
expr_stmt|;
name|rhp
operator|=
name|php
operator|->
name|rhp
expr_stmt|;
name|CTR3
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s ibpd %p pdid 0x%x"
argument_list|,
name|__FUNCTION__
argument_list|,
name|pd
argument_list|,
name|php
operator|->
name|pdid
argument_list|)
expr_stmt|;
name|cxio_hal_put_pdid
argument_list|(
name|rhp
operator|->
name|rdev
operator|.
name|rscp
argument_list|,
name|php
operator|->
name|pdid
argument_list|)
expr_stmt|;
name|cxfree
argument_list|(
name|php
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|ib_pd
modifier|*
name|iwch_allocate_pd
parameter_list|(
name|struct
name|ib_device
modifier|*
name|ibdev
parameter_list|,
name|struct
name|ib_ucontext
modifier|*
name|context
parameter_list|,
name|struct
name|ib_udata
modifier|*
name|udata
parameter_list|)
block|{
name|struct
name|iwch_pd
modifier|*
name|php
decl_stmt|;
name|u32
name|pdid
decl_stmt|;
name|struct
name|iwch_dev
modifier|*
name|rhp
decl_stmt|;
name|CTR2
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s ibdev %p"
argument_list|,
name|__FUNCTION__
argument_list|,
name|ibdev
argument_list|)
expr_stmt|;
name|rhp
operator|=
operator|(
expr|struct
name|iwch_dev
operator|*
operator|)
name|ibdev
expr_stmt|;
name|pdid
operator|=
name|cxio_hal_get_pdid
argument_list|(
name|rhp
operator|->
name|rdev
operator|.
name|rscp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pdid
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|EINVAL
argument_list|)
return|;
name|php
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|php
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_ZERO
operator||
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|php
condition|)
block|{
name|cxio_hal_put_pdid
argument_list|(
name|rhp
operator|->
name|rdev
operator|.
name|rscp
argument_list|,
name|pdid
argument_list|)
expr_stmt|;
return|return
name|ERR_PTR
argument_list|(
operator|-
name|ENOMEM
argument_list|)
return|;
block|}
name|php
operator|->
name|pdid
operator|=
name|pdid
expr_stmt|;
name|php
operator|->
name|rhp
operator|=
name|rhp
expr_stmt|;
if|if
condition|(
name|context
condition|)
block|{
if|if
condition|(
name|ib_copy_to_udata
argument_list|(
name|udata
argument_list|,
operator|&
name|php
operator|->
name|pdid
argument_list|,
sizeof|sizeof
argument_list|(
name|__u32
argument_list|)
argument_list|)
condition|)
block|{
name|iwch_deallocate_pd
argument_list|(
operator|&
name|php
operator|->
name|ibpd
argument_list|)
expr_stmt|;
return|return
name|ERR_PTR
argument_list|(
operator|-
name|EFAULT
argument_list|)
return|;
block|}
block|}
name|CTR3
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s pdid 0x%0x ptr 0x%p"
argument_list|,
name|__FUNCTION__
argument_list|,
name|pdid
argument_list|,
name|php
argument_list|)
expr_stmt|;
return|return
operator|&
name|php
operator|->
name|ibpd
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|iwch_dereg_mr
parameter_list|(
name|struct
name|ib_mr
modifier|*
name|ib_mr
parameter_list|)
block|{
name|struct
name|iwch_dev
modifier|*
name|rhp
decl_stmt|;
name|struct
name|iwch_mr
modifier|*
name|mhp
decl_stmt|;
name|u32
name|mmid
decl_stmt|;
name|CTR2
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s ib_mr %p"
argument_list|,
name|__FUNCTION__
argument_list|,
name|ib_mr
argument_list|)
expr_stmt|;
comment|/* There can be no memory windows */
if|if
condition|(
name|atomic_load_acq_int
argument_list|(
operator|&
name|ib_mr
operator|->
name|usecnt
operator|.
name|counter
argument_list|)
condition|)
return|return
operator|(
operator|-
name|EINVAL
operator|)
return|;
name|mhp
operator|=
name|to_iwch_mr
argument_list|(
name|ib_mr
argument_list|)
expr_stmt|;
name|rhp
operator|=
name|mhp
operator|->
name|rhp
expr_stmt|;
name|mmid
operator|=
name|mhp
operator|->
name|attr
operator|.
name|stag
operator|>>
literal|8
expr_stmt|;
name|cxio_dereg_mem
argument_list|(
operator|&
name|rhp
operator|->
name|rdev
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|stag
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|pbl_size
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|pbl_addr
argument_list|)
expr_stmt|;
name|iwch_free_pbl
argument_list|(
name|mhp
argument_list|)
expr_stmt|;
name|remove_handle
argument_list|(
name|rhp
argument_list|,
operator|&
name|rhp
operator|->
name|mmidr
argument_list|,
name|mmid
argument_list|)
expr_stmt|;
if|if
condition|(
name|mhp
operator|->
name|kva
condition|)
name|cxfree
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|(
name|unsigned
name|long
operator|)
name|mhp
operator|->
name|kva
argument_list|)
expr_stmt|;
if|if
condition|(
name|mhp
operator|->
name|umem
condition|)
name|ib_umem_release
argument_list|(
name|mhp
operator|->
name|umem
argument_list|)
expr_stmt|;
name|CTR3
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s mmid 0x%x ptr %p"
argument_list|,
name|__FUNCTION__
argument_list|,
name|mmid
argument_list|,
name|mhp
argument_list|)
expr_stmt|;
name|cxfree
argument_list|(
name|mhp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|ib_mr
modifier|*
name|iwch_register_phys_mem
parameter_list|(
name|struct
name|ib_pd
modifier|*
name|pd
parameter_list|,
name|struct
name|ib_phys_buf
modifier|*
name|buffer_list
parameter_list|,
name|int
name|num_phys_buf
parameter_list|,
name|int
name|acc
parameter_list|,
name|u64
modifier|*
name|iova_start
parameter_list|)
block|{
name|__be64
modifier|*
name|page_list
decl_stmt|;
name|int
name|shift
decl_stmt|;
name|u64
name|total_size
decl_stmt|;
name|int
name|npages
decl_stmt|;
name|struct
name|iwch_dev
modifier|*
name|rhp
decl_stmt|;
name|struct
name|iwch_pd
modifier|*
name|php
decl_stmt|;
name|struct
name|iwch_mr
modifier|*
name|mhp
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|CTR2
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s ib_pd %p"
argument_list|,
name|__FUNCTION__
argument_list|,
name|pd
argument_list|)
expr_stmt|;
name|php
operator|=
name|to_iwch_pd
argument_list|(
name|pd
argument_list|)
expr_stmt|;
name|rhp
operator|=
name|php
operator|->
name|rhp
expr_stmt|;
name|mhp
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|mhp
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_ZERO
operator||
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mhp
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|ENOMEM
argument_list|)
return|;
name|mhp
operator|->
name|rhp
operator|=
name|rhp
expr_stmt|;
comment|/* First check that we have enough alignment */
if|if
condition|(
operator|(
operator|*
name|iova_start
operator|&
operator|~
name|PAGE_MASK
operator|)
operator|!=
operator|(
name|buffer_list
index|[
literal|0
index|]
operator|.
name|addr
operator|&
operator|~
name|PAGE_MASK
operator|)
condition|)
block|{
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|num_phys_buf
operator|>
literal|1
operator|&&
operator|(
operator|(
name|buffer_list
index|[
literal|0
index|]
operator|.
name|addr
operator|+
name|buffer_list
index|[
literal|0
index|]
operator|.
name|size
operator|)
operator|&
operator|~
name|PAGE_MASK
operator|)
condition|)
block|{
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|ret
operator|=
name|build_phys_page_list
argument_list|(
name|buffer_list
argument_list|,
name|num_phys_buf
argument_list|,
name|iova_start
argument_list|,
operator|&
name|total_size
argument_list|,
operator|&
name|npages
argument_list|,
operator|&
name|shift
argument_list|,
operator|&
name|page_list
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err
goto|;
name|ret
operator|=
name|iwch_alloc_pbl
argument_list|(
name|mhp
argument_list|,
name|npages
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|cxfree
argument_list|(
name|page_list
argument_list|)
expr_stmt|;
goto|goto
name|err_pbl
goto|;
block|}
name|ret
operator|=
name|iwch_write_pbl
argument_list|(
name|mhp
argument_list|,
name|page_list
argument_list|,
name|npages
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|cxfree
argument_list|(
name|page_list
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err
goto|;
name|mhp
operator|->
name|attr
operator|.
name|pdid
operator|=
name|php
operator|->
name|pdid
expr_stmt|;
name|mhp
operator|->
name|attr
operator|.
name|zbva
operator|=
literal|0
expr_stmt|;
name|mhp
operator|->
name|attr
operator|.
name|perms
operator|=
name|iwch_ib_to_tpt_access
argument_list|(
name|acc
argument_list|)
expr_stmt|;
name|mhp
operator|->
name|attr
operator|.
name|va_fbo
operator|=
operator|*
name|iova_start
expr_stmt|;
name|mhp
operator|->
name|attr
operator|.
name|page_size
operator|=
name|shift
operator|-
literal|12
expr_stmt|;
name|mhp
operator|->
name|attr
operator|.
name|len
operator|=
operator|(
name|u32
operator|)
name|total_size
expr_stmt|;
name|mhp
operator|->
name|attr
operator|.
name|pbl_size
operator|=
name|npages
expr_stmt|;
name|ret
operator|=
name|iwch_register_mem
argument_list|(
name|rhp
argument_list|,
name|php
argument_list|,
name|mhp
argument_list|,
name|shift
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err_pbl
goto|;
return|return
operator|&
name|mhp
operator|->
name|ibmr
return|;
name|err_pbl
label|:
name|iwch_free_pbl
argument_list|(
name|mhp
argument_list|)
expr_stmt|;
name|err
label|:
name|cxfree
argument_list|(
name|mhp
argument_list|)
expr_stmt|;
return|return
name|ERR_PTR
argument_list|(
name|ret
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|iwch_reregister_phys_mem
parameter_list|(
name|struct
name|ib_mr
modifier|*
name|mr
parameter_list|,
name|int
name|mr_rereg_mask
parameter_list|,
name|struct
name|ib_pd
modifier|*
name|pd
parameter_list|,
name|struct
name|ib_phys_buf
modifier|*
name|buffer_list
parameter_list|,
name|int
name|num_phys_buf
parameter_list|,
name|int
name|acc
parameter_list|,
name|u64
modifier|*
name|iova_start
parameter_list|)
block|{
name|struct
name|iwch_mr
name|mh
decl_stmt|,
modifier|*
name|mhp
decl_stmt|;
name|struct
name|iwch_pd
modifier|*
name|php
decl_stmt|;
name|struct
name|iwch_dev
modifier|*
name|rhp
decl_stmt|;
name|__be64
modifier|*
name|page_list
init|=
name|NULL
decl_stmt|;
name|int
name|shift
init|=
literal|0
decl_stmt|;
name|u64
name|total_size
decl_stmt|;
name|int
name|npages
init|=
literal|0
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|CTR3
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s ib_mr %p ib_pd %p"
argument_list|,
name|__FUNCTION__
argument_list|,
name|mr
argument_list|,
name|pd
argument_list|)
expr_stmt|;
comment|/* There can be no memory windows */
if|if
condition|(
name|atomic_load_acq_int
argument_list|(
operator|&
name|mr
operator|->
name|usecnt
operator|.
name|counter
argument_list|)
condition|)
return|return
operator|(
operator|-
name|EINVAL
operator|)
return|;
name|mhp
operator|=
name|to_iwch_mr
argument_list|(
name|mr
argument_list|)
expr_stmt|;
name|rhp
operator|=
name|mhp
operator|->
name|rhp
expr_stmt|;
name|php
operator|=
name|to_iwch_pd
argument_list|(
name|mr
operator|->
name|pd
argument_list|)
expr_stmt|;
comment|/* make sure we are on the same adapter */
if|if
condition|(
name|rhp
operator|!=
name|php
operator|->
name|rhp
condition|)
return|return
operator|(
operator|-
name|EINVAL
operator|)
return|;
name|memcpy
argument_list|(
operator|&
name|mh
argument_list|,
name|mhp
argument_list|,
sizeof|sizeof
expr|*
name|mhp
argument_list|)
expr_stmt|;
if|if
condition|(
name|mr_rereg_mask
operator|&
name|IB_MR_REREG_PD
condition|)
name|php
operator|=
name|to_iwch_pd
argument_list|(
name|pd
argument_list|)
expr_stmt|;
if|if
condition|(
name|mr_rereg_mask
operator|&
name|IB_MR_REREG_ACCESS
condition|)
name|mh
operator|.
name|attr
operator|.
name|perms
operator|=
name|iwch_ib_to_tpt_access
argument_list|(
name|acc
argument_list|)
expr_stmt|;
if|if
condition|(
name|mr_rereg_mask
operator|&
name|IB_MR_REREG_TRANS
condition|)
block|{
name|ret
operator|=
name|build_phys_page_list
argument_list|(
name|buffer_list
argument_list|,
name|num_phys_buf
argument_list|,
name|iova_start
argument_list|,
operator|&
name|total_size
argument_list|,
operator|&
name|npages
argument_list|,
operator|&
name|shift
argument_list|,
operator|&
name|page_list
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
block|}
name|ret
operator|=
name|iwch_reregister_mem
argument_list|(
name|rhp
argument_list|,
name|php
argument_list|,
operator|&
name|mh
argument_list|,
name|shift
argument_list|,
name|npages
argument_list|)
expr_stmt|;
name|cxfree
argument_list|(
name|page_list
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
return|return
name|ret
return|;
block|}
if|if
condition|(
name|mr_rereg_mask
operator|&
name|IB_MR_REREG_PD
condition|)
name|mhp
operator|->
name|attr
operator|.
name|pdid
operator|=
name|php
operator|->
name|pdid
expr_stmt|;
if|if
condition|(
name|mr_rereg_mask
operator|&
name|IB_MR_REREG_ACCESS
condition|)
name|mhp
operator|->
name|attr
operator|.
name|perms
operator|=
name|iwch_ib_to_tpt_access
argument_list|(
name|acc
argument_list|)
expr_stmt|;
if|if
condition|(
name|mr_rereg_mask
operator|&
name|IB_MR_REREG_TRANS
condition|)
block|{
name|mhp
operator|->
name|attr
operator|.
name|zbva
operator|=
literal|0
expr_stmt|;
name|mhp
operator|->
name|attr
operator|.
name|va_fbo
operator|=
operator|*
name|iova_start
expr_stmt|;
name|mhp
operator|->
name|attr
operator|.
name|page_size
operator|=
name|shift
operator|-
literal|12
expr_stmt|;
name|mhp
operator|->
name|attr
operator|.
name|len
operator|=
operator|(
name|u32
operator|)
name|total_size
expr_stmt|;
name|mhp
operator|->
name|attr
operator|.
name|pbl_size
operator|=
name|npages
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|ib_mr
modifier|*
name|iwch_reg_user_mr
parameter_list|(
name|struct
name|ib_pd
modifier|*
name|pd
parameter_list|,
name|u64
name|start
parameter_list|,
name|u64
name|length
parameter_list|,
name|u64
name|virt
parameter_list|,
name|int
name|acc
parameter_list|,
name|struct
name|ib_udata
modifier|*
name|udata
parameter_list|,
name|int
name|mr_id
parameter_list|)
block|{
name|__be64
modifier|*
name|pages
decl_stmt|;
name|int
name|shift
decl_stmt|,
name|n
decl_stmt|,
name|len
decl_stmt|;
name|int
name|i
decl_stmt|,
name|k
decl_stmt|,
name|entry
decl_stmt|;
name|int
name|err
init|=
literal|0
decl_stmt|;
name|struct
name|iwch_dev
modifier|*
name|rhp
decl_stmt|;
name|struct
name|iwch_pd
modifier|*
name|php
decl_stmt|;
name|struct
name|iwch_mr
modifier|*
name|mhp
decl_stmt|;
name|struct
name|iwch_reg_user_mr_resp
name|uresp
decl_stmt|;
name|struct
name|scatterlist
modifier|*
name|sg
decl_stmt|;
name|CTR2
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s ib_pd %p"
argument_list|,
name|__FUNCTION__
argument_list|,
name|pd
argument_list|)
expr_stmt|;
name|php
operator|=
name|to_iwch_pd
argument_list|(
name|pd
argument_list|)
expr_stmt|;
name|rhp
operator|=
name|php
operator|->
name|rhp
expr_stmt|;
name|mhp
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|mhp
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mhp
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|ENOMEM
argument_list|)
return|;
name|mhp
operator|->
name|rhp
operator|=
name|rhp
expr_stmt|;
name|mhp
operator|->
name|umem
operator|=
name|ib_umem_get
argument_list|(
name|pd
operator|->
name|uobject
operator|->
name|context
argument_list|,
name|start
argument_list|,
name|length
argument_list|,
name|acc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|mhp
operator|->
name|umem
argument_list|)
condition|)
block|{
name|err
operator|=
name|PTR_ERR
argument_list|(
name|mhp
operator|->
name|umem
argument_list|)
expr_stmt|;
name|cxfree
argument_list|(
name|mhp
argument_list|)
expr_stmt|;
return|return
name|ERR_PTR
argument_list|(
operator|-
name|err
argument_list|)
return|;
block|}
name|shift
operator|=
name|ffs
argument_list|(
name|mhp
operator|->
name|umem
operator|->
name|page_size
argument_list|)
operator|-
literal|1
expr_stmt|;
name|n
operator|=
name|mhp
operator|->
name|umem
operator|->
name|nmap
expr_stmt|;
name|err
operator|=
name|iwch_alloc_pbl
argument_list|(
name|mhp
argument_list|,
name|n
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|err
goto|;
name|pages
operator|=
operator|(
name|__be64
operator|*
operator|)
name|kmalloc
argument_list|(
name|n
operator|*
sizeof|sizeof
argument_list|(
name|u64
argument_list|)
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pages
condition|)
block|{
name|err
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|err_pbl
goto|;
block|}
name|i
operator|=
name|n
operator|=
literal|0
expr_stmt|;
name|for_each_sg
argument_list|(
argument|mhp->umem->sg_head.sgl
argument_list|,
argument|sg
argument_list|,
argument|mhp->umem->nmap
argument_list|,
argument|entry
argument_list|)
block|{
name|len
operator|=
name|sg_dma_len
argument_list|(
name|sg
argument_list|)
operator|>>
name|shift
expr_stmt|;
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
name|len
condition|;
operator|++
name|k
control|)
block|{
name|pages
index|[
name|i
operator|++
index|]
operator|=
name|cpu_to_be64
argument_list|(
name|sg_dma_address
argument_list|(
name|sg
argument_list|)
operator|+
name|mhp
operator|->
name|umem
operator|->
name|page_size
operator|*
name|k
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
name|PAGE_SIZE
operator|/
sizeof|sizeof
expr|*
name|pages
condition|)
block|{
name|err
operator|=
name|iwch_write_pbl
argument_list|(
name|mhp
argument_list|,
name|pages
argument_list|,
name|i
argument_list|,
name|n
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|pbl_done
goto|;
name|n
operator|+=
name|i
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
block|}
block|}
block|}
if|#
directive|if
literal|0
block|TAILQ_FOREACH(chunk,&mhp->umem->chunk_list, entry) 		for (j = 0; j< chunk->nmap; ++j) { 			len = sg_dma_len(&chunk->page_list[j])>> shift; 			for (k = 0; k< len; ++k) { 				pages[i++] = htobe64(sg_dma_address(&chunk->page_list[j]) + 					mhp->umem->page_size * k); 				if (i == PAGE_SIZE / sizeof *pages) { 					err = iwch_write_pbl(mhp, pages, i, n); 					if (err) 						goto pbl_done; 					n += i; 					i = 0; 				} 			} 		}
endif|#
directive|endif
if|if
condition|(
name|i
condition|)
name|err
operator|=
name|iwch_write_pbl
argument_list|(
name|mhp
argument_list|,
name|pages
argument_list|,
name|i
argument_list|,
name|n
argument_list|)
expr_stmt|;
name|pbl_done
label|:
name|cxfree
argument_list|(
name|pages
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|err_pbl
goto|;
name|mhp
operator|->
name|attr
operator|.
name|pdid
operator|=
name|php
operator|->
name|pdid
expr_stmt|;
name|mhp
operator|->
name|attr
operator|.
name|zbva
operator|=
literal|0
expr_stmt|;
name|mhp
operator|->
name|attr
operator|.
name|perms
operator|=
name|iwch_ib_to_tpt_access
argument_list|(
name|acc
argument_list|)
expr_stmt|;
name|mhp
operator|->
name|attr
operator|.
name|va_fbo
operator|=
name|virt
expr_stmt|;
name|mhp
operator|->
name|attr
operator|.
name|page_size
operator|=
name|shift
operator|-
literal|12
expr_stmt|;
name|mhp
operator|->
name|attr
operator|.
name|len
operator|=
operator|(
name|u32
operator|)
name|length
expr_stmt|;
name|err
operator|=
name|iwch_register_mem
argument_list|(
name|rhp
argument_list|,
name|php
argument_list|,
name|mhp
argument_list|,
name|shift
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|err_pbl
goto|;
if|if
condition|(
name|udata
operator|&&
operator|!
name|t3a_device
argument_list|(
name|rhp
argument_list|)
condition|)
block|{
name|uresp
operator|.
name|pbl_addr
operator|=
operator|(
name|mhp
operator|->
name|attr
operator|.
name|pbl_addr
operator|-
name|rhp
operator|->
name|rdev
operator|.
name|rnic_info
operator|.
name|pbl_base
operator|)
operator|>>
literal|3
expr_stmt|;
name|CTR2
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s user resp pbl_addr 0x%x"
argument_list|,
name|__FUNCTION__
argument_list|,
name|uresp
operator|.
name|pbl_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ib_copy_to_udata
argument_list|(
name|udata
argument_list|,
operator|&
name|uresp
argument_list|,
sizeof|sizeof
argument_list|(
name|uresp
argument_list|)
argument_list|)
condition|)
block|{
name|iwch_dereg_mr
argument_list|(
operator|&
name|mhp
operator|->
name|ibmr
argument_list|)
expr_stmt|;
name|err
operator|=
name|EFAULT
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
return|return
operator|&
name|mhp
operator|->
name|ibmr
return|;
name|err_pbl
label|:
name|iwch_free_pbl
argument_list|(
name|mhp
argument_list|)
expr_stmt|;
name|err
label|:
name|ib_umem_release
argument_list|(
name|mhp
operator|->
name|umem
argument_list|)
expr_stmt|;
name|cxfree
argument_list|(
name|mhp
argument_list|)
expr_stmt|;
return|return
name|ERR_PTR
argument_list|(
operator|-
name|err
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|ib_mr
modifier|*
name|iwch_get_dma_mr
parameter_list|(
name|struct
name|ib_pd
modifier|*
name|pd
parameter_list|,
name|int
name|acc
parameter_list|)
block|{
name|struct
name|ib_phys_buf
name|bl
decl_stmt|;
name|u64
name|kva
decl_stmt|;
name|struct
name|ib_mr
modifier|*
name|ibmr
decl_stmt|;
name|CTR2
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s ib_pd %p"
argument_list|,
name|__FUNCTION__
argument_list|,
name|pd
argument_list|)
expr_stmt|;
comment|/* 	 * T3 only supports 32 bits of size. 	 */
name|bl
operator|.
name|size
operator|=
literal|0xffffffff
expr_stmt|;
name|bl
operator|.
name|addr
operator|=
literal|0
expr_stmt|;
name|kva
operator|=
literal|0
expr_stmt|;
name|ibmr
operator|=
name|iwch_register_phys_mem
argument_list|(
name|pd
argument_list|,
operator|&
name|bl
argument_list|,
literal|1
argument_list|,
name|acc
argument_list|,
operator|&
name|kva
argument_list|)
expr_stmt|;
return|return
name|ibmr
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|ib_mw
modifier|*
name|iwch_alloc_mw
parameter_list|(
name|struct
name|ib_pd
modifier|*
name|pd
parameter_list|,
name|enum
name|ib_mw_type
name|type
parameter_list|)
block|{
name|struct
name|iwch_dev
modifier|*
name|rhp
decl_stmt|;
name|struct
name|iwch_pd
modifier|*
name|php
decl_stmt|;
name|struct
name|iwch_mw
modifier|*
name|mhp
decl_stmt|;
name|u32
name|mmid
decl_stmt|;
name|u32
name|stag
init|=
literal|0
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|php
operator|=
name|to_iwch_pd
argument_list|(
name|pd
argument_list|)
expr_stmt|;
name|rhp
operator|=
name|php
operator|->
name|rhp
expr_stmt|;
name|mhp
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|mhp
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_ZERO
operator||
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mhp
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|ENOMEM
argument_list|)
return|;
name|ret
operator|=
name|cxio_allocate_window
argument_list|(
operator|&
name|rhp
operator|->
name|rdev
argument_list|,
operator|&
name|stag
argument_list|,
name|php
operator|->
name|pdid
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|cxfree
argument_list|(
name|mhp
argument_list|)
expr_stmt|;
return|return
name|ERR_PTR
argument_list|(
operator|-
name|ret
argument_list|)
return|;
block|}
name|mhp
operator|->
name|rhp
operator|=
name|rhp
expr_stmt|;
name|mhp
operator|->
name|attr
operator|.
name|pdid
operator|=
name|php
operator|->
name|pdid
expr_stmt|;
name|mhp
operator|->
name|attr
operator|.
name|type
operator|=
name|TPT_MW
expr_stmt|;
name|mhp
operator|->
name|attr
operator|.
name|stag
operator|=
name|stag
expr_stmt|;
name|mmid
operator|=
operator|(
name|stag
operator|)
operator|>>
literal|8
expr_stmt|;
name|mhp
operator|->
name|ibmw
operator|.
name|rkey
operator|=
name|stag
expr_stmt|;
if|if
condition|(
name|insert_handle
argument_list|(
name|rhp
argument_list|,
operator|&
name|rhp
operator|->
name|mmidr
argument_list|,
name|mhp
argument_list|,
name|mmid
argument_list|)
condition|)
block|{
name|cxio_deallocate_window
argument_list|(
operator|&
name|rhp
operator|->
name|rdev
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|stag
argument_list|)
expr_stmt|;
name|cxfree
argument_list|(
name|mhp
argument_list|)
expr_stmt|;
return|return
name|ERR_PTR
argument_list|(
operator|-
name|ENOMEM
argument_list|)
return|;
block|}
name|CTR4
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s mmid 0x%x mhp %p stag 0x%x"
argument_list|,
name|__FUNCTION__
argument_list|,
name|mmid
argument_list|,
name|mhp
argument_list|,
name|stag
argument_list|)
expr_stmt|;
return|return
operator|&
operator|(
name|mhp
operator|->
name|ibmw
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|iwch_dealloc_mw
parameter_list|(
name|struct
name|ib_mw
modifier|*
name|mw
parameter_list|)
block|{
name|struct
name|iwch_dev
modifier|*
name|rhp
decl_stmt|;
name|struct
name|iwch_mw
modifier|*
name|mhp
decl_stmt|;
name|u32
name|mmid
decl_stmt|;
name|mhp
operator|=
name|to_iwch_mw
argument_list|(
name|mw
argument_list|)
expr_stmt|;
name|rhp
operator|=
name|mhp
operator|->
name|rhp
expr_stmt|;
name|mmid
operator|=
operator|(
name|mw
operator|->
name|rkey
operator|)
operator|>>
literal|8
expr_stmt|;
name|cxio_deallocate_window
argument_list|(
operator|&
name|rhp
operator|->
name|rdev
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|stag
argument_list|)
expr_stmt|;
name|remove_handle
argument_list|(
name|rhp
argument_list|,
operator|&
name|rhp
operator|->
name|mmidr
argument_list|,
name|mmid
argument_list|)
expr_stmt|;
name|cxfree
argument_list|(
name|mhp
argument_list|)
expr_stmt|;
name|CTR4
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s ib_mw %p mmid 0x%x ptr %p"
argument_list|,
name|__FUNCTION__
argument_list|,
name|mw
argument_list|,
name|mmid
argument_list|,
name|mhp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|iwch_destroy_qp
parameter_list|(
name|struct
name|ib_qp
modifier|*
name|ib_qp
parameter_list|)
block|{
name|struct
name|iwch_dev
modifier|*
name|rhp
decl_stmt|;
name|struct
name|iwch_qp
modifier|*
name|qhp
decl_stmt|;
name|struct
name|iwch_qp_attributes
name|attrs
decl_stmt|;
name|struct
name|iwch_ucontext
modifier|*
name|ucontext
decl_stmt|;
name|qhp
operator|=
name|to_iwch_qp
argument_list|(
name|ib_qp
argument_list|)
expr_stmt|;
name|rhp
operator|=
name|qhp
operator|->
name|rhp
expr_stmt|;
name|attrs
operator|.
name|next_state
operator|=
name|IWCH_QP_STATE_ERROR
expr_stmt|;
name|iwch_modify_qp
argument_list|(
name|rhp
argument_list|,
name|qhp
argument_list|,
name|IWCH_QP_ATTR_NEXT_STATE
argument_list|,
operator|&
name|attrs
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|qhp
operator|->
name|ep
condition|)
name|msleep
argument_list|(
name|qhp
argument_list|,
operator|&
name|qhp
operator|->
name|lock
argument_list|,
literal|0
argument_list|,
literal|"iwch_destroy_qp1"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
name|remove_handle
argument_list|(
name|rhp
argument_list|,
operator|&
name|rhp
operator|->
name|qpidr
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|qpid
argument_list|)
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
operator|--
name|qhp
operator|->
name|refcnt
condition|)
name|msleep
argument_list|(
name|qhp
argument_list|,
operator|&
name|qhp
operator|->
name|lock
argument_list|,
literal|0
argument_list|,
literal|"iwch_destroy_qp2"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
name|ucontext
operator|=
name|ib_qp
operator|->
name|uobject
condition|?
name|to_iwch_ucontext
argument_list|(
name|ib_qp
operator|->
name|uobject
operator|->
name|context
argument_list|)
else|:
name|NULL
expr_stmt|;
name|cxio_destroy_qp
argument_list|(
operator|&
name|rhp
operator|->
name|rdev
argument_list|,
operator|&
name|qhp
operator|->
name|wq
argument_list|,
name|ucontext
condition|?
operator|&
name|ucontext
operator|->
name|uctx
else|:
operator|&
name|rhp
operator|->
name|rdev
operator|.
name|uctx
argument_list|)
expr_stmt|;
name|CTR4
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s ib_qp %p qpid 0x%0x qhp %p"
argument_list|,
name|__FUNCTION__
argument_list|,
name|ib_qp
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|qpid
argument_list|,
name|qhp
argument_list|)
expr_stmt|;
name|cxfree
argument_list|(
name|qhp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|ib_qp
modifier|*
name|iwch_create_qp
parameter_list|(
name|struct
name|ib_pd
modifier|*
name|pd
parameter_list|,
name|struct
name|ib_qp_init_attr
modifier|*
name|attrs
parameter_list|,
name|struct
name|ib_udata
modifier|*
name|udata
parameter_list|)
block|{
name|struct
name|iwch_dev
modifier|*
name|rhp
decl_stmt|;
name|struct
name|iwch_qp
modifier|*
name|qhp
decl_stmt|;
name|struct
name|iwch_pd
modifier|*
name|php
decl_stmt|;
name|struct
name|iwch_cq
modifier|*
name|schp
decl_stmt|;
name|struct
name|iwch_cq
modifier|*
name|rchp
decl_stmt|;
name|struct
name|iwch_create_qp_resp
name|uresp
decl_stmt|;
name|int
name|wqsize
decl_stmt|,
name|sqsize
decl_stmt|,
name|rqsize
decl_stmt|;
name|struct
name|iwch_ucontext
modifier|*
name|ucontext
decl_stmt|;
name|CTR2
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s ib_pd %p"
argument_list|,
name|__FUNCTION__
argument_list|,
name|pd
argument_list|)
expr_stmt|;
if|if
condition|(
name|attrs
operator|->
name|qp_type
operator|!=
name|IB_QPT_RC
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|EINVAL
argument_list|)
return|;
name|php
operator|=
name|to_iwch_pd
argument_list|(
name|pd
argument_list|)
expr_stmt|;
name|rhp
operator|=
name|php
operator|->
name|rhp
expr_stmt|;
name|schp
operator|=
name|get_chp
argument_list|(
name|rhp
argument_list|,
operator|(
operator|(
expr|struct
name|iwch_cq
operator|*
operator|)
name|attrs
operator|->
name|send_cq
operator|)
operator|->
name|cq
operator|.
name|cqid
argument_list|)
expr_stmt|;
name|rchp
operator|=
name|get_chp
argument_list|(
name|rhp
argument_list|,
operator|(
operator|(
expr|struct
name|iwch_cq
operator|*
operator|)
name|attrs
operator|->
name|recv_cq
operator|)
operator|->
name|cq
operator|.
name|cqid
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|schp
operator|||
operator|!
name|rchp
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|EINVAL
argument_list|)
return|;
comment|/* The RQT size must be # of entries + 1 rounded up to a power of two */
name|rqsize
operator|=
name|roundup_pow_of_two
argument_list|(
name|attrs
operator|->
name|cap
operator|.
name|max_recv_wr
argument_list|)
expr_stmt|;
if|if
condition|(
name|rqsize
operator|==
name|attrs
operator|->
name|cap
operator|.
name|max_recv_wr
condition|)
name|rqsize
operator|=
name|roundup_pow_of_two
argument_list|(
name|attrs
operator|->
name|cap
operator|.
name|max_recv_wr
operator|+
literal|1
argument_list|)
expr_stmt|;
comment|/* T3 doesn't support RQT depth< 16 */
if|if
condition|(
name|rqsize
operator|<
literal|16
condition|)
name|rqsize
operator|=
literal|16
expr_stmt|;
if|if
condition|(
name|rqsize
operator|>
name|T3_MAX_RQ_SIZE
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|EINVAL
argument_list|)
return|;
if|if
condition|(
name|attrs
operator|->
name|cap
operator|.
name|max_inline_data
operator|>
name|T3_MAX_INLINE
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|EINVAL
argument_list|)
return|;
comment|/* 	 * NOTE: The SQ and total WQ sizes don't need to be 	 * a power of two.  However, all the code assumes 	 * they are. EG: Q_FREECNT() and friends. 	 */
name|sqsize
operator|=
name|roundup_pow_of_two
argument_list|(
name|attrs
operator|->
name|cap
operator|.
name|max_send_wr
argument_list|)
expr_stmt|;
name|wqsize
operator|=
name|roundup_pow_of_two
argument_list|(
name|rqsize
operator|+
name|sqsize
argument_list|)
expr_stmt|;
name|CTR4
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s wqsize %d sqsize %d rqsize %d"
argument_list|,
name|__FUNCTION__
argument_list|,
name|wqsize
argument_list|,
name|sqsize
argument_list|,
name|rqsize
argument_list|)
expr_stmt|;
name|qhp
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|qhp
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_ZERO
operator||
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|qhp
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|ENOMEM
argument_list|)
return|;
name|qhp
operator|->
name|wq
operator|.
name|size_log2
operator|=
name|ilog2
argument_list|(
name|wqsize
argument_list|)
expr_stmt|;
name|qhp
operator|->
name|wq
operator|.
name|rq_size_log2
operator|=
name|ilog2
argument_list|(
name|rqsize
argument_list|)
expr_stmt|;
name|qhp
operator|->
name|wq
operator|.
name|sq_size_log2
operator|=
name|ilog2
argument_list|(
name|sqsize
argument_list|)
expr_stmt|;
name|ucontext
operator|=
name|pd
operator|->
name|uobject
condition|?
name|to_iwch_ucontext
argument_list|(
name|pd
operator|->
name|uobject
operator|->
name|context
argument_list|)
else|:
name|NULL
expr_stmt|;
if|if
condition|(
name|cxio_create_qp
argument_list|(
operator|&
name|rhp
operator|->
name|rdev
argument_list|,
operator|!
name|udata
argument_list|,
operator|&
name|qhp
operator|->
name|wq
argument_list|,
name|ucontext
condition|?
operator|&
name|ucontext
operator|->
name|uctx
else|:
operator|&
name|rhp
operator|->
name|rdev
operator|.
name|uctx
argument_list|)
condition|)
block|{
name|cxfree
argument_list|(
name|qhp
argument_list|)
expr_stmt|;
return|return
name|ERR_PTR
argument_list|(
operator|-
name|ENOMEM
argument_list|)
return|;
block|}
name|attrs
operator|->
name|cap
operator|.
name|max_recv_wr
operator|=
name|rqsize
operator|-
literal|1
expr_stmt|;
name|attrs
operator|->
name|cap
operator|.
name|max_send_wr
operator|=
name|sqsize
expr_stmt|;
name|attrs
operator|->
name|cap
operator|.
name|max_inline_data
operator|=
name|T3_MAX_INLINE
expr_stmt|;
name|qhp
operator|->
name|rhp
operator|=
name|rhp
expr_stmt|;
name|qhp
operator|->
name|attr
operator|.
name|pd
operator|=
name|php
operator|->
name|pdid
expr_stmt|;
name|qhp
operator|->
name|attr
operator|.
name|scq
operator|=
operator|(
operator|(
expr|struct
name|iwch_cq
operator|*
operator|)
name|attrs
operator|->
name|send_cq
operator|)
operator|->
name|cq
operator|.
name|cqid
expr_stmt|;
name|qhp
operator|->
name|attr
operator|.
name|rcq
operator|=
operator|(
operator|(
expr|struct
name|iwch_cq
operator|*
operator|)
name|attrs
operator|->
name|recv_cq
operator|)
operator|->
name|cq
operator|.
name|cqid
expr_stmt|;
name|qhp
operator|->
name|attr
operator|.
name|sq_num_entries
operator|=
name|attrs
operator|->
name|cap
operator|.
name|max_send_wr
expr_stmt|;
name|qhp
operator|->
name|attr
operator|.
name|rq_num_entries
operator|=
name|attrs
operator|->
name|cap
operator|.
name|max_recv_wr
expr_stmt|;
name|qhp
operator|->
name|attr
operator|.
name|sq_max_sges
operator|=
name|attrs
operator|->
name|cap
operator|.
name|max_send_sge
expr_stmt|;
name|qhp
operator|->
name|attr
operator|.
name|sq_max_sges_rdma_write
operator|=
name|attrs
operator|->
name|cap
operator|.
name|max_send_sge
expr_stmt|;
name|qhp
operator|->
name|attr
operator|.
name|rq_max_sges
operator|=
name|attrs
operator|->
name|cap
operator|.
name|max_recv_sge
expr_stmt|;
name|qhp
operator|->
name|attr
operator|.
name|state
operator|=
name|IWCH_QP_STATE_IDLE
expr_stmt|;
name|qhp
operator|->
name|attr
operator|.
name|next_state
operator|=
name|IWCH_QP_STATE_IDLE
expr_stmt|;
comment|/* 	 * XXX - These don't get passed in from the openib user 	 * at create time.  The CM sets them via a QP modify. 	 * Need to fix...  I think the CM should 	 */
name|qhp
operator|->
name|attr
operator|.
name|enable_rdma_read
operator|=
literal|1
expr_stmt|;
name|qhp
operator|->
name|attr
operator|.
name|enable_rdma_write
operator|=
literal|1
expr_stmt|;
name|qhp
operator|->
name|attr
operator|.
name|enable_bind
operator|=
literal|1
expr_stmt|;
name|qhp
operator|->
name|attr
operator|.
name|max_ord
operator|=
literal|1
expr_stmt|;
name|qhp
operator|->
name|attr
operator|.
name|max_ird
operator|=
literal|1
expr_stmt|;
name|mtx_init
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|,
literal|"cxgb qp"
argument_list|,
name|NULL
argument_list|,
name|MTX_DEF
operator||
name|MTX_DUPOK
argument_list|)
expr_stmt|;
name|qhp
operator|->
name|refcnt
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|insert_handle
argument_list|(
name|rhp
argument_list|,
operator|&
name|rhp
operator|->
name|qpidr
argument_list|,
name|qhp
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|qpid
argument_list|)
condition|)
block|{
name|cxio_destroy_qp
argument_list|(
operator|&
name|rhp
operator|->
name|rdev
argument_list|,
operator|&
name|qhp
operator|->
name|wq
argument_list|,
name|ucontext
condition|?
operator|&
name|ucontext
operator|->
name|uctx
else|:
operator|&
name|rhp
operator|->
name|rdev
operator|.
name|uctx
argument_list|)
expr_stmt|;
name|cxfree
argument_list|(
name|qhp
argument_list|)
expr_stmt|;
return|return
name|ERR_PTR
argument_list|(
operator|-
name|ENOMEM
argument_list|)
return|;
block|}
if|if
condition|(
name|udata
condition|)
block|{
name|struct
name|iwch_mm_entry
modifier|*
name|mm1
decl_stmt|,
modifier|*
name|mm2
decl_stmt|;
name|mm1
operator|=
name|kmalloc
argument_list|(
sizeof|sizeof
expr|*
name|mm1
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mm1
condition|)
block|{
name|iwch_destroy_qp
argument_list|(
operator|&
name|qhp
operator|->
name|ibqp
argument_list|)
expr_stmt|;
return|return
name|ERR_PTR
argument_list|(
operator|-
name|ENOMEM
argument_list|)
return|;
block|}
name|mm2
operator|=
name|kmalloc
argument_list|(
sizeof|sizeof
expr|*
name|mm2
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mm2
condition|)
block|{
name|cxfree
argument_list|(
name|mm1
argument_list|)
expr_stmt|;
name|iwch_destroy_qp
argument_list|(
operator|&
name|qhp
operator|->
name|ibqp
argument_list|)
expr_stmt|;
return|return
name|ERR_PTR
argument_list|(
operator|-
name|ENOMEM
argument_list|)
return|;
block|}
name|uresp
operator|.
name|qpid
operator|=
name|qhp
operator|->
name|wq
operator|.
name|qpid
expr_stmt|;
name|uresp
operator|.
name|size_log2
operator|=
name|qhp
operator|->
name|wq
operator|.
name|size_log2
expr_stmt|;
name|uresp
operator|.
name|sq_size_log2
operator|=
name|qhp
operator|->
name|wq
operator|.
name|sq_size_log2
expr_stmt|;
name|uresp
operator|.
name|rq_size_log2
operator|=
name|qhp
operator|->
name|wq
operator|.
name|rq_size_log2
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|ucontext
operator|->
name|mmap_lock
argument_list|)
expr_stmt|;
name|uresp
operator|.
name|key
operator|=
name|ucontext
operator|->
name|key
expr_stmt|;
name|ucontext
operator|->
name|key
operator|+=
name|PAGE_SIZE
expr_stmt|;
name|uresp
operator|.
name|db_key
operator|=
name|ucontext
operator|->
name|key
expr_stmt|;
name|ucontext
operator|->
name|key
operator|+=
name|PAGE_SIZE
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|ucontext
operator|->
name|mmap_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|ib_copy_to_udata
argument_list|(
name|udata
argument_list|,
operator|&
name|uresp
argument_list|,
sizeof|sizeof
argument_list|(
name|uresp
argument_list|)
argument_list|)
condition|)
block|{
name|cxfree
argument_list|(
name|mm1
argument_list|)
expr_stmt|;
name|cxfree
argument_list|(
name|mm2
argument_list|)
expr_stmt|;
name|iwch_destroy_qp
argument_list|(
operator|&
name|qhp
operator|->
name|ibqp
argument_list|)
expr_stmt|;
return|return
name|ERR_PTR
argument_list|(
operator|-
name|EFAULT
argument_list|)
return|;
block|}
name|mm1
operator|->
name|key
operator|=
name|uresp
operator|.
name|key
expr_stmt|;
name|mm1
operator|->
name|addr
operator|=
name|vtophys
argument_list|(
name|qhp
operator|->
name|wq
operator|.
name|queue
argument_list|)
expr_stmt|;
name|mm1
operator|->
name|len
operator|=
name|PAGE_ALIGN
argument_list|(
name|wqsize
operator|*
sizeof|sizeof
argument_list|(
expr|union
name|t3_wr
argument_list|)
argument_list|)
expr_stmt|;
name|insert_mmap
argument_list|(
name|ucontext
argument_list|,
name|mm1
argument_list|)
expr_stmt|;
name|mm2
operator|->
name|key
operator|=
name|uresp
operator|.
name|db_key
expr_stmt|;
name|mm2
operator|->
name|addr
operator|=
name|qhp
operator|->
name|wq
operator|.
name|udb
operator|&
name|PAGE_MASK
expr_stmt|;
name|mm2
operator|->
name|len
operator|=
name|PAGE_SIZE
expr_stmt|;
name|insert_mmap
argument_list|(
name|ucontext
argument_list|,
name|mm2
argument_list|)
expr_stmt|;
block|}
name|qhp
operator|->
name|ibqp
operator|.
name|qp_num
operator|=
name|qhp
operator|->
name|wq
operator|.
name|qpid
expr_stmt|;
name|callout_init
argument_list|(
operator|&
operator|(
name|qhp
operator|->
name|timer
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|CTR6
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"sq_num_entries %d, rq_num_entries %d "
literal|"qpid 0x%0x qhp %p dma_addr 0x%llx size %d"
argument_list|,
name|qhp
operator|->
name|attr
operator|.
name|sq_num_entries
argument_list|,
name|qhp
operator|->
name|attr
operator|.
name|rq_num_entries
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|qpid
argument_list|,
name|qhp
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|qhp
operator|->
name|wq
operator|.
name|dma_addr
argument_list|,
literal|1
operator|<<
name|qhp
operator|->
name|wq
operator|.
name|size_log2
argument_list|)
expr_stmt|;
return|return
operator|&
name|qhp
operator|->
name|ibqp
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|iwch_ib_modify_qp
parameter_list|(
name|struct
name|ib_qp
modifier|*
name|ibqp
parameter_list|,
name|struct
name|ib_qp_attr
modifier|*
name|attr
parameter_list|,
name|int
name|attr_mask
parameter_list|,
name|struct
name|ib_udata
modifier|*
name|udata
parameter_list|)
block|{
name|struct
name|iwch_dev
modifier|*
name|rhp
decl_stmt|;
name|struct
name|iwch_qp
modifier|*
name|qhp
decl_stmt|;
name|enum
name|iwch_qp_attr_mask
name|mask
init|=
literal|0
decl_stmt|;
name|struct
name|iwch_qp_attributes
name|attrs
decl_stmt|;
name|CTR2
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s ib_qp %p"
argument_list|,
name|__FUNCTION__
argument_list|,
name|ibqp
argument_list|)
expr_stmt|;
comment|/* iwarp does not support the RTR state */
if|if
condition|(
operator|(
name|attr_mask
operator|&
name|IB_QP_STATE
operator|)
operator|&&
operator|(
name|attr
operator|->
name|qp_state
operator|==
name|IB_QPS_RTR
operator|)
condition|)
name|attr_mask
operator|&=
operator|~
name|IB_QP_STATE
expr_stmt|;
comment|/* Make sure we still have something left to do */
if|if
condition|(
operator|!
name|attr_mask
condition|)
return|return
literal|0
return|;
name|memset
argument_list|(
operator|&
name|attrs
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|attrs
argument_list|)
expr_stmt|;
name|qhp
operator|=
name|to_iwch_qp
argument_list|(
name|ibqp
argument_list|)
expr_stmt|;
name|rhp
operator|=
name|qhp
operator|->
name|rhp
expr_stmt|;
name|attrs
operator|.
name|next_state
operator|=
name|iwch_convert_state
argument_list|(
name|attr
operator|->
name|qp_state
argument_list|)
expr_stmt|;
name|attrs
operator|.
name|enable_rdma_read
operator|=
operator|(
name|attr
operator|->
name|qp_access_flags
operator|&
name|IB_ACCESS_REMOTE_READ
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|attrs
operator|.
name|enable_rdma_write
operator|=
operator|(
name|attr
operator|->
name|qp_access_flags
operator|&
name|IB_ACCESS_REMOTE_WRITE
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|attrs
operator|.
name|enable_bind
operator|=
operator|(
name|attr
operator|->
name|qp_access_flags
operator|&
name|IB_ACCESS_MW_BIND
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|mask
operator||=
operator|(
name|attr_mask
operator|&
name|IB_QP_STATE
operator|)
condition|?
name|IWCH_QP_ATTR_NEXT_STATE
else|:
literal|0
expr_stmt|;
name|mask
operator||=
operator|(
name|attr_mask
operator|&
name|IB_QP_ACCESS_FLAGS
operator|)
condition|?
operator|(
name|IWCH_QP_ATTR_ENABLE_RDMA_READ
operator||
name|IWCH_QP_ATTR_ENABLE_RDMA_WRITE
operator||
name|IWCH_QP_ATTR_ENABLE_RDMA_BIND
operator|)
else|:
literal|0
expr_stmt|;
return|return
name|iwch_modify_qp
argument_list|(
name|rhp
argument_list|,
name|qhp
argument_list|,
name|mask
argument_list|,
operator|&
name|attrs
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|iwch_qp_add_ref
parameter_list|(
name|struct
name|ib_qp
modifier|*
name|qp
parameter_list|)
block|{
name|CTR2
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s ib_qp %p"
argument_list|,
name|__FUNCTION__
argument_list|,
name|qp
argument_list|)
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|to_iwch_qp
argument_list|(
name|qp
argument_list|)
operator|->
name|lock
argument_list|)
expr_stmt|;
name|to_iwch_qp
argument_list|(
name|qp
argument_list|)
operator|->
name|refcnt
operator|++
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|to_iwch_qp
argument_list|(
name|qp
argument_list|)
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|iwch_qp_rem_ref
parameter_list|(
name|struct
name|ib_qp
modifier|*
name|qp
parameter_list|)
block|{
name|CTR2
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s ib_qp %p"
argument_list|,
name|__FUNCTION__
argument_list|,
name|qp
argument_list|)
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|to_iwch_qp
argument_list|(
name|qp
argument_list|)
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
operator|--
name|to_iwch_qp
argument_list|(
name|qp
argument_list|)
operator|->
name|refcnt
operator|==
literal|0
condition|)
name|wakeup
argument_list|(
name|to_iwch_qp
argument_list|(
name|qp
argument_list|)
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|to_iwch_qp
argument_list|(
name|qp
argument_list|)
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|ib_qp
modifier|*
name|iwch_get_qp
parameter_list|(
name|struct
name|ib_device
modifier|*
name|dev
parameter_list|,
name|int
name|qpn
parameter_list|)
block|{
name|CTR3
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s ib_dev %p qpn 0x%x"
argument_list|,
name|__FUNCTION__
argument_list|,
name|dev
argument_list|,
name|qpn
argument_list|)
expr_stmt|;
return|return
operator|(
expr|struct
name|ib_qp
operator|*
operator|)
name|get_qhp
argument_list|(
name|to_iwch_dev
argument_list|(
name|dev
argument_list|)
argument_list|,
name|qpn
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|iwch_query_pkey
parameter_list|(
name|struct
name|ib_device
modifier|*
name|ibdev
parameter_list|,
name|u8
name|port
parameter_list|,
name|u16
name|index
parameter_list|,
name|u16
modifier|*
name|pkey
parameter_list|)
block|{
name|CTR2
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s ibdev %p"
argument_list|,
name|__FUNCTION__
argument_list|,
name|ibdev
argument_list|)
expr_stmt|;
operator|*
name|pkey
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|iwch_query_gid
parameter_list|(
name|struct
name|ib_device
modifier|*
name|ibdev
parameter_list|,
name|u8
name|port
parameter_list|,
name|int
name|index
parameter_list|,
name|union
name|ib_gid
modifier|*
name|gid
parameter_list|)
block|{
name|struct
name|iwch_dev
modifier|*
name|dev
decl_stmt|;
name|struct
name|port_info
modifier|*
name|pi
decl_stmt|;
name|struct
name|adapter
modifier|*
name|sc
decl_stmt|;
name|CTR5
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s ibdev %p, port %d, index %d, gid %p"
argument_list|,
name|__FUNCTION__
argument_list|,
name|ibdev
argument_list|,
name|port
argument_list|,
name|index
argument_list|,
name|gid
argument_list|)
expr_stmt|;
name|dev
operator|=
name|to_iwch_dev
argument_list|(
name|ibdev
argument_list|)
expr_stmt|;
name|sc
operator|=
name|dev
operator|->
name|rdev
operator|.
name|adap
expr_stmt|;
name|PANIC_IF
argument_list|(
name|port
operator|==
literal|0
operator|||
name|port
operator|>
literal|2
argument_list|)
expr_stmt|;
name|pi
operator|=
operator|&
name|sc
operator|->
name|port
index|[
name|port
operator|-
literal|1
index|]
expr_stmt|;
name|memset
argument_list|(
operator|&
operator|(
name|gid
operator|->
name|raw
index|[
literal|0
index|]
operator|)
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|gid
operator|->
name|raw
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
operator|(
name|gid
operator|->
name|raw
index|[
literal|0
index|]
operator|)
argument_list|,
name|pi
operator|->
name|hw_addr
argument_list|,
literal|6
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|iwch_query_device
parameter_list|(
name|struct
name|ib_device
modifier|*
name|ibdev
parameter_list|,
name|struct
name|ib_device_attr
modifier|*
name|props
parameter_list|)
block|{
name|struct
name|iwch_dev
modifier|*
name|dev
decl_stmt|;
name|struct
name|adapter
modifier|*
name|sc
decl_stmt|;
name|CTR2
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s ibdev %p"
argument_list|,
name|__FUNCTION__
argument_list|,
name|ibdev
argument_list|)
expr_stmt|;
name|dev
operator|=
name|to_iwch_dev
argument_list|(
name|ibdev
argument_list|)
expr_stmt|;
name|sc
operator|=
name|dev
operator|->
name|rdev
operator|.
name|adap
expr_stmt|;
name|memset
argument_list|(
name|props
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
expr|*
name|props
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|props
operator|->
name|sys_image_guid
argument_list|,
name|sc
operator|->
name|port
index|[
literal|0
index|]
operator|.
name|hw_addr
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|props
operator|->
name|device_cap_flags
operator|=
name|dev
operator|->
name|device_cap_flags
expr_stmt|;
name|props
operator|->
name|page_size_cap
operator|=
name|dev
operator|->
name|attr
operator|.
name|mem_pgsizes_bitmask
expr_stmt|;
name|props
operator|->
name|vendor_id
operator|=
name|pci_get_vendor
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
expr_stmt|;
name|props
operator|->
name|vendor_part_id
operator|=
name|pci_get_device
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
expr_stmt|;
name|props
operator|->
name|max_mr_size
operator|=
name|dev
operator|->
name|attr
operator|.
name|max_mr_size
expr_stmt|;
name|props
operator|->
name|max_qp
operator|=
name|dev
operator|->
name|attr
operator|.
name|max_qps
expr_stmt|;
name|props
operator|->
name|max_qp_wr
operator|=
name|dev
operator|->
name|attr
operator|.
name|max_wrs
expr_stmt|;
name|props
operator|->
name|max_sge
operator|=
name|dev
operator|->
name|attr
operator|.
name|max_sge_per_wr
expr_stmt|;
name|props
operator|->
name|max_sge_rd
operator|=
literal|1
expr_stmt|;
name|props
operator|->
name|max_qp_rd_atom
operator|=
name|dev
operator|->
name|attr
operator|.
name|max_rdma_reads_per_qp
expr_stmt|;
name|props
operator|->
name|max_qp_init_rd_atom
operator|=
name|dev
operator|->
name|attr
operator|.
name|max_rdma_reads_per_qp
expr_stmt|;
name|props
operator|->
name|max_cq
operator|=
name|dev
operator|->
name|attr
operator|.
name|max_cqs
expr_stmt|;
name|props
operator|->
name|max_cqe
operator|=
name|dev
operator|->
name|attr
operator|.
name|max_cqes_per_cq
expr_stmt|;
name|props
operator|->
name|max_mr
operator|=
name|dev
operator|->
name|attr
operator|.
name|max_mem_regs
expr_stmt|;
name|props
operator|->
name|max_pd
operator|=
name|dev
operator|->
name|attr
operator|.
name|max_pds
expr_stmt|;
name|props
operator|->
name|local_ca_ack_delay
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|iwch_query_port
parameter_list|(
name|struct
name|ib_device
modifier|*
name|ibdev
parameter_list|,
name|u8
name|port
parameter_list|,
name|struct
name|ib_port_attr
modifier|*
name|props
parameter_list|)
block|{
name|CTR2
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s ibdev %p"
argument_list|,
name|__FUNCTION__
argument_list|,
name|ibdev
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|props
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ib_port_attr
argument_list|)
argument_list|)
expr_stmt|;
name|props
operator|->
name|max_mtu
operator|=
name|IB_MTU_4096
expr_stmt|;
name|props
operator|->
name|active_mtu
operator|=
name|IB_MTU_2048
expr_stmt|;
name|props
operator|->
name|state
operator|=
name|IB_PORT_ACTIVE
expr_stmt|;
name|props
operator|->
name|port_cap_flags
operator|=
name|IB_PORT_CM_SUP
operator||
name|IB_PORT_SNMP_TUNNEL_SUP
operator||
name|IB_PORT_REINIT_SUP
operator||
name|IB_PORT_DEVICE_MGMT_SUP
operator||
name|IB_PORT_VENDOR_CLASS_SUP
operator||
name|IB_PORT_BOOT_MGMT_SUP
expr_stmt|;
name|props
operator|->
name|gid_tbl_len
operator|=
literal|1
expr_stmt|;
name|props
operator|->
name|pkey_tbl_len
operator|=
literal|1
expr_stmt|;
name|props
operator|->
name|active_width
operator|=
literal|2
expr_stmt|;
name|props
operator|->
name|active_speed
operator|=
literal|2
expr_stmt|;
name|props
operator|->
name|max_msg_sz
operator|=
operator|-
literal|1
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|iwch_register_device
parameter_list|(
name|struct
name|iwch_dev
modifier|*
name|dev
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|struct
name|adapter
modifier|*
name|sc
init|=
name|dev
operator|->
name|rdev
operator|.
name|adap
decl_stmt|;
name|CTR2
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s iwch_dev %p"
argument_list|,
name|__FUNCTION__
argument_list|,
name|dev
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|dev
operator|->
name|ibdev
operator|.
name|name
argument_list|,
literal|"cxgb3_%d"
argument_list|,
name|IB_DEVICE_NAME_MAX
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|dev
operator|->
name|ibdev
operator|.
name|node_guid
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|dev
operator|->
name|ibdev
operator|.
name|node_guid
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|dev
operator|->
name|ibdev
operator|.
name|node_guid
argument_list|,
name|sc
operator|->
name|port
index|[
literal|0
index|]
operator|.
name|hw_addr
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|dev
operator|->
name|device_cap_flags
operator|=
operator|(
name|IB_DEVICE_LOCAL_DMA_LKEY
operator||
name|IB_DEVICE_MEM_WINDOW
operator|)
expr_stmt|;
name|dev
operator|->
name|ibdev
operator|.
name|uverbs_cmd_mask
operator|=
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_GET_CONTEXT
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_QUERY_DEVICE
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_QUERY_PORT
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_ALLOC_PD
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_DEALLOC_PD
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_REG_MR
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_DEREG_MR
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_CREATE_COMP_CHANNEL
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_CREATE_CQ
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_DESTROY_CQ
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_REQ_NOTIFY_CQ
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_CREATE_QP
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_MODIFY_QP
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_POLL_CQ
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_DESTROY_QP
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_POST_SEND
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_POST_RECV
operator|)
expr_stmt|;
name|dev
operator|->
name|ibdev
operator|.
name|node_type
operator|=
name|RDMA_NODE_RNIC
expr_stmt|;
name|memcpy
argument_list|(
name|dev
operator|->
name|ibdev
operator|.
name|node_desc
argument_list|,
name|IWCH_NODE_DESC
argument_list|,
sizeof|sizeof
argument_list|(
name|IWCH_NODE_DESC
argument_list|)
argument_list|)
expr_stmt|;
name|dev
operator|->
name|ibdev
operator|.
name|phys_port_cnt
operator|=
name|sc
operator|->
name|params
operator|.
name|nports
expr_stmt|;
name|dev
operator|->
name|ibdev
operator|.
name|num_comp_vectors
operator|=
literal|1
expr_stmt|;
name|dev
operator|->
name|ibdev
operator|.
name|dma_device
operator|=
name|dev
operator|->
name|rdev
operator|.
name|adap
operator|->
name|dev
expr_stmt|;
name|dev
operator|->
name|ibdev
operator|.
name|query_device
operator|=
name|iwch_query_device
expr_stmt|;
name|dev
operator|->
name|ibdev
operator|.
name|query_port
operator|=
name|iwch_query_port
expr_stmt|;
name|dev
operator|->
name|ibdev
operator|.
name|modify_port
operator|=
name|iwch_modify_port
expr_stmt|;
name|dev
operator|->
name|ibdev
operator|.
name|query_pkey
operator|=
name|iwch_query_pkey
expr_stmt|;
name|dev
operator|->
name|ibdev
operator|.
name|query_gid
operator|=
name|iwch_query_gid
expr_stmt|;
name|dev
operator|->
name|ibdev
operator|.
name|alloc_ucontext
operator|=
name|iwch_alloc_ucontext
expr_stmt|;
name|dev
operator|->
name|ibdev
operator|.
name|dealloc_ucontext
operator|=
name|iwch_dealloc_ucontext
expr_stmt|;
name|dev
operator|->
name|ibdev
operator|.
name|mmap
operator|=
name|iwch_mmap
expr_stmt|;
name|dev
operator|->
name|ibdev
operator|.
name|alloc_pd
operator|=
name|iwch_allocate_pd
expr_stmt|;
name|dev
operator|->
name|ibdev
operator|.
name|dealloc_pd
operator|=
name|iwch_deallocate_pd
expr_stmt|;
name|dev
operator|->
name|ibdev
operator|.
name|create_ah
operator|=
name|iwch_ah_create
expr_stmt|;
name|dev
operator|->
name|ibdev
operator|.
name|destroy_ah
operator|=
name|iwch_ah_destroy
expr_stmt|;
name|dev
operator|->
name|ibdev
operator|.
name|create_qp
operator|=
name|iwch_create_qp
expr_stmt|;
name|dev
operator|->
name|ibdev
operator|.
name|modify_qp
operator|=
name|iwch_ib_modify_qp
expr_stmt|;
name|dev
operator|->
name|ibdev
operator|.
name|destroy_qp
operator|=
name|iwch_destroy_qp
expr_stmt|;
name|dev
operator|->
name|ibdev
operator|.
name|create_cq
operator|=
name|iwch_create_cq
expr_stmt|;
name|dev
operator|->
name|ibdev
operator|.
name|destroy_cq
operator|=
name|iwch_destroy_cq
expr_stmt|;
name|dev
operator|->
name|ibdev
operator|.
name|resize_cq
operator|=
name|iwch_resize_cq
expr_stmt|;
name|dev
operator|->
name|ibdev
operator|.
name|poll_cq
operator|=
name|iwch_poll_cq
expr_stmt|;
name|dev
operator|->
name|ibdev
operator|.
name|get_dma_mr
operator|=
name|iwch_get_dma_mr
expr_stmt|;
name|dev
operator|->
name|ibdev
operator|.
name|reg_phys_mr
operator|=
name|iwch_register_phys_mem
expr_stmt|;
name|dev
operator|->
name|ibdev
operator|.
name|rereg_phys_mr
operator|=
name|iwch_reregister_phys_mem
expr_stmt|;
name|dev
operator|->
name|ibdev
operator|.
name|reg_user_mr
operator|=
name|iwch_reg_user_mr
expr_stmt|;
name|dev
operator|->
name|ibdev
operator|.
name|dereg_mr
operator|=
name|iwch_dereg_mr
expr_stmt|;
name|dev
operator|->
name|ibdev
operator|.
name|alloc_mw
operator|=
name|iwch_alloc_mw
expr_stmt|;
name|dev
operator|->
name|ibdev
operator|.
name|bind_mw
operator|=
name|iwch_bind_mw
expr_stmt|;
name|dev
operator|->
name|ibdev
operator|.
name|dealloc_mw
operator|=
name|iwch_dealloc_mw
expr_stmt|;
name|dev
operator|->
name|ibdev
operator|.
name|attach_mcast
operator|=
name|iwch_multicast_attach
expr_stmt|;
name|dev
operator|->
name|ibdev
operator|.
name|detach_mcast
operator|=
name|iwch_multicast_detach
expr_stmt|;
name|dev
operator|->
name|ibdev
operator|.
name|process_mad
operator|=
name|iwch_process_mad
expr_stmt|;
name|dev
operator|->
name|ibdev
operator|.
name|req_notify_cq
operator|=
name|iwch_arm_cq
expr_stmt|;
name|dev
operator|->
name|ibdev
operator|.
name|post_send
operator|=
name|iwch_post_send
expr_stmt|;
name|dev
operator|->
name|ibdev
operator|.
name|post_recv
operator|=
name|iwch_post_receive
expr_stmt|;
name|dev
operator|->
name|ibdev
operator|.
name|uverbs_abi_ver
operator|=
name|IWCH_UVERBS_ABI_VERSION
expr_stmt|;
name|dev
operator|->
name|ibdev
operator|.
name|iwcm
operator|=
name|kmalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|iw_cm_verbs
argument_list|)
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dev
operator|->
name|ibdev
operator|.
name|iwcm
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
name|dev
operator|->
name|ibdev
operator|.
name|iwcm
operator|->
name|connect
operator|=
name|iwch_connect
expr_stmt|;
name|dev
operator|->
name|ibdev
operator|.
name|iwcm
operator|->
name|accept
operator|=
name|iwch_accept_cr
expr_stmt|;
name|dev
operator|->
name|ibdev
operator|.
name|iwcm
operator|->
name|reject
operator|=
name|iwch_reject_cr
expr_stmt|;
name|dev
operator|->
name|ibdev
operator|.
name|iwcm
operator|->
name|create_listen
operator|=
name|iwch_create_listen
expr_stmt|;
name|dev
operator|->
name|ibdev
operator|.
name|iwcm
operator|->
name|destroy_listen
operator|=
name|iwch_destroy_listen
expr_stmt|;
name|dev
operator|->
name|ibdev
operator|.
name|iwcm
operator|->
name|add_ref
operator|=
name|iwch_qp_add_ref
expr_stmt|;
name|dev
operator|->
name|ibdev
operator|.
name|iwcm
operator|->
name|rem_ref
operator|=
name|iwch_qp_rem_ref
expr_stmt|;
name|dev
operator|->
name|ibdev
operator|.
name|iwcm
operator|->
name|get_qp
operator|=
name|iwch_get_qp
expr_stmt|;
name|ret
operator|=
name|ib_register_device
argument_list|(
operator|&
name|dev
operator|->
name|ibdev
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|bail1
goto|;
return|return
operator|(
literal|0
operator|)
return|;
name|bail1
label|:
name|cxfree
argument_list|(
name|dev
operator|->
name|ibdev
operator|.
name|iwcm
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
name|void
name|iwch_unregister_device
parameter_list|(
name|struct
name|iwch_dev
modifier|*
name|dev
parameter_list|)
block|{
name|ib_unregister_device
argument_list|(
operator|&
name|dev
operator|->
name|ibdev
argument_list|)
expr_stmt|;
name|cxfree
argument_list|(
name|dev
operator|->
name|ibdev
operator|.
name|iwcm
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

end_unit


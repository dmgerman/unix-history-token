begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/**************************************************************************  Copyright (c) 2007, Chelsio Inc. All rights reserved.  Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:   1. Redistributions of source code must retain the above copyright notice,     this list of conditions and the following disclaimer.   2. Neither the name of the Chelsio Corporation nor the names of its     contributors may be used to endorse or promote products derived from     this software without specific prior written permission.  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  ***************************************************************************/
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"opt_inet.h"
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/pciio.h>
end_include

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioccom.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<sys/rwlock.h>
end_include

begin_include
include|#
directive|include
file|<sys/linker.h>
end_include

begin_include
include|#
directive|include
file|<sys/firmware.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_include
include|#
directive|include
file|<sys/smp.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/syslog.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<sys/taskqueue.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<sys/libkern.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<rdma/ib_verbs.h>
end_include

begin_include
include|#
directive|include
file|<rdma/ib_umem.h>
end_include

begin_include
include|#
directive|include
file|<rdma/ib_user_verbs.h>
end_include

begin_include
include|#
directive|include
file|<linux/idr.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_ib_intfc.h>
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|INVARIANTS
argument_list|)
operator|&&
name|defined
argument_list|(
name|TCP_OFFLOAD
argument_list|)
end_if

begin_include
include|#
directive|include
file|<cxgb_include.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_wr.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_hal.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_provider.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_cm.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_resource.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_user.h>
end_include

begin_function
specifier|static
name|int
name|cxio_rdma_get_mem
parameter_list|(
name|struct
name|cxio_rdev
modifier|*
name|rdev
parameter_list|,
name|struct
name|ch_mem_range
modifier|*
name|m
parameter_list|)
block|{
name|struct
name|adapter
modifier|*
name|sc
init|=
name|rdev
operator|->
name|adap
decl_stmt|;
name|struct
name|mc7
modifier|*
name|mem
decl_stmt|;
if|if
condition|(
operator|(
name|m
operator|->
name|addr
operator|&
literal|7
operator|)
operator|||
operator|(
name|m
operator|->
name|len
operator|&
literal|7
operator|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
name|m
operator|->
name|mem_id
operator|==
name|MEM_CM
condition|)
name|mem
operator|=
operator|&
name|sc
operator|->
name|cm
expr_stmt|;
elseif|else
if|if
condition|(
name|m
operator|->
name|mem_id
operator|==
name|MEM_PMRX
condition|)
name|mem
operator|=
operator|&
name|sc
operator|->
name|pmrx
expr_stmt|;
elseif|else
if|if
condition|(
name|m
operator|->
name|mem_id
operator|==
name|MEM_PMTX
condition|)
name|mem
operator|=
operator|&
name|sc
operator|->
name|pmtx
expr_stmt|;
else|else
return|return
operator|(
name|EINVAL
operator|)
return|;
return|return
operator|(
name|t3_mc7_bd_read
argument_list|(
name|mem
argument_list|,
name|m
operator|->
name|addr
operator|/
literal|8
argument_list|,
name|m
operator|->
name|len
operator|/
literal|8
argument_list|,
operator|(
name|u64
operator|*
operator|)
name|m
operator|->
name|buf
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|void
name|cxio_dump_tpt
parameter_list|(
name|struct
name|cxio_rdev
modifier|*
name|rdev
parameter_list|,
name|uint32_t
name|stag
parameter_list|)
block|{
name|struct
name|ch_mem_range
name|m
decl_stmt|;
name|u64
modifier|*
name|data
decl_stmt|;
name|u32
name|addr
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|int
name|size
init|=
literal|32
decl_stmt|;
name|m
operator|.
name|buf
operator|=
name|malloc
argument_list|(
name|size
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|.
name|buf
operator|==
name|NULL
condition|)
block|{
name|CTR1
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s couldn't allocate memory."
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
return|return;
block|}
name|m
operator|.
name|mem_id
operator|=
name|MEM_PMRX
expr_stmt|;
name|m
operator|.
name|addr
operator|=
operator|(
name|stag
operator|>>
literal|8
operator|)
operator|*
literal|32
operator|+
name|rdev
operator|->
name|rnic_info
operator|.
name|tpt_base
expr_stmt|;
name|m
operator|.
name|len
operator|=
name|size
expr_stmt|;
name|CTR3
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s TPT addr 0x%x len %d"
argument_list|,
name|__FUNCTION__
argument_list|,
name|m
operator|.
name|addr
argument_list|,
name|m
operator|.
name|len
argument_list|)
expr_stmt|;
name|rc
operator|=
name|cxio_rdma_get_mem
argument_list|(
name|rdev
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|CTR2
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s toectl returned error %d"
argument_list|,
name|__FUNCTION__
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|m
operator|.
name|buf
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
return|return;
block|}
name|data
operator|=
operator|(
name|u64
operator|*
operator|)
name|m
operator|.
name|buf
expr_stmt|;
name|addr
operator|=
name|m
operator|.
name|addr
expr_stmt|;
while|while
condition|(
name|size
operator|>
literal|0
condition|)
block|{
name|CTR2
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"TPT %08x: %016llx"
argument_list|,
name|addr
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
operator|*
name|data
argument_list|)
expr_stmt|;
name|size
operator|-=
literal|8
expr_stmt|;
name|data
operator|++
expr_stmt|;
name|addr
operator|+=
literal|8
expr_stmt|;
block|}
name|free
argument_list|(
name|m
operator|.
name|buf
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|cxio_dump_pbl
parameter_list|(
name|struct
name|cxio_rdev
modifier|*
name|rdev
parameter_list|,
name|uint32_t
name|pbl_addr
parameter_list|,
name|uint32_t
name|len
parameter_list|,
name|u8
name|shift
parameter_list|)
block|{
name|struct
name|ch_mem_range
name|m
decl_stmt|;
name|u64
modifier|*
name|data
decl_stmt|;
name|u32
name|addr
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|int
name|size
decl_stmt|,
name|npages
decl_stmt|;
name|shift
operator|+=
literal|12
expr_stmt|;
name|npages
operator|=
operator|(
name|len
operator|+
operator|(
literal|1ULL
operator|<<
name|shift
operator|)
operator|-
literal|1
operator|)
operator|>>
name|shift
expr_stmt|;
name|size
operator|=
name|npages
operator|*
sizeof|sizeof
argument_list|(
name|u64
argument_list|)
expr_stmt|;
name|m
operator|.
name|buf
operator|=
name|malloc
argument_list|(
name|size
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|.
name|buf
operator|==
name|NULL
condition|)
block|{
name|CTR1
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s couldn't allocate memory."
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
return|return;
block|}
name|m
operator|.
name|mem_id
operator|=
name|MEM_PMRX
expr_stmt|;
name|m
operator|.
name|addr
operator|=
name|pbl_addr
expr_stmt|;
name|m
operator|.
name|len
operator|=
name|size
expr_stmt|;
name|CTR4
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s PBL addr 0x%x len %d depth %d"
argument_list|,
name|__FUNCTION__
argument_list|,
name|m
operator|.
name|addr
argument_list|,
name|m
operator|.
name|len
argument_list|,
name|npages
argument_list|)
expr_stmt|;
name|rc
operator|=
name|cxio_rdma_get_mem
argument_list|(
name|rdev
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|CTR2
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s toectl returned error %d"
argument_list|,
name|__FUNCTION__
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|m
operator|.
name|buf
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
return|return;
block|}
name|data
operator|=
operator|(
name|u64
operator|*
operator|)
name|m
operator|.
name|buf
expr_stmt|;
name|addr
operator|=
name|m
operator|.
name|addr
expr_stmt|;
while|while
condition|(
name|size
operator|>
literal|0
condition|)
block|{
name|CTR2
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"PBL %08x: %016llx"
argument_list|,
name|addr
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
operator|*
name|data
argument_list|)
expr_stmt|;
name|size
operator|-=
literal|8
expr_stmt|;
name|data
operator|++
expr_stmt|;
name|addr
operator|+=
literal|8
expr_stmt|;
block|}
name|free
argument_list|(
name|m
operator|.
name|buf
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|cxio_dump_wqe
parameter_list|(
name|union
name|t3_wr
modifier|*
name|wqe
parameter_list|)
block|{
name|uint64_t
modifier|*
name|data
init|=
operator|(
name|uint64_t
operator|*
operator|)
name|wqe
decl_stmt|;
name|uint32_t
name|size
init|=
call|(
name|uint32_t
call|)
argument_list|(
name|be64toh
argument_list|(
operator|*
name|data
argument_list|)
operator|&
literal|0xff
argument_list|)
decl_stmt|;
if|if
condition|(
name|size
operator|==
literal|0
condition|)
name|size
operator|=
literal|8
expr_stmt|;
while|while
condition|(
name|size
operator|>
literal|0
condition|)
block|{
name|CTR2
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"WQE %p: %016llx"
argument_list|,
name|data
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|be64toh
argument_list|(
operator|*
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|size
operator|--
expr_stmt|;
name|data
operator|++
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|cxio_dump_wce
parameter_list|(
name|struct
name|t3_cqe
modifier|*
name|wce
parameter_list|)
block|{
name|uint64_t
modifier|*
name|data
init|=
operator|(
name|uint64_t
operator|*
operator|)
name|wce
decl_stmt|;
name|int
name|size
init|=
sizeof|sizeof
argument_list|(
operator|*
name|wce
argument_list|)
decl_stmt|;
while|while
condition|(
name|size
operator|>
literal|0
condition|)
block|{
name|CTR2
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"WCE %p: %016llx"
argument_list|,
name|data
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|be64toh
argument_list|(
operator|*
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|size
operator|-=
literal|8
expr_stmt|;
name|data
operator|++
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|cxio_dump_rqt
parameter_list|(
name|struct
name|cxio_rdev
modifier|*
name|rdev
parameter_list|,
name|uint32_t
name|hwtid
parameter_list|,
name|int
name|nents
parameter_list|)
block|{
name|struct
name|ch_mem_range
name|m
decl_stmt|;
name|int
name|size
init|=
name|nents
operator|*
literal|64
decl_stmt|;
name|u64
modifier|*
name|data
decl_stmt|;
name|u32
name|addr
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|m
operator|.
name|buf
operator|=
name|malloc
argument_list|(
name|size
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|.
name|buf
operator|==
name|NULL
condition|)
block|{
name|CTR1
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s couldn't allocate memory."
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
return|return;
block|}
name|m
operator|.
name|mem_id
operator|=
name|MEM_PMRX
expr_stmt|;
name|m
operator|.
name|addr
operator|=
operator|(
operator|(
name|hwtid
operator|)
operator|<<
literal|10
operator|)
operator|+
name|rdev
operator|->
name|rnic_info
operator|.
name|rqt_base
expr_stmt|;
name|m
operator|.
name|len
operator|=
name|size
expr_stmt|;
name|CTR3
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s RQT addr 0x%x len %d"
argument_list|,
name|__FUNCTION__
argument_list|,
name|m
operator|.
name|addr
argument_list|,
name|m
operator|.
name|len
argument_list|)
expr_stmt|;
name|rc
operator|=
name|cxio_rdma_get_mem
argument_list|(
name|rdev
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|CTR2
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s toectl returned error %d"
argument_list|,
name|__FUNCTION__
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|m
operator|.
name|buf
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
return|return;
block|}
name|data
operator|=
operator|(
name|u64
operator|*
operator|)
name|m
operator|.
name|buf
expr_stmt|;
name|addr
operator|=
name|m
operator|.
name|addr
expr_stmt|;
while|while
condition|(
name|size
operator|>
literal|0
condition|)
block|{
name|CTR2
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"RQT %08x: %016llx"
argument_list|,
name|addr
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
operator|*
name|data
argument_list|)
expr_stmt|;
name|size
operator|-=
literal|8
expr_stmt|;
name|data
operator|++
expr_stmt|;
name|addr
operator|+=
literal|8
expr_stmt|;
block|}
name|free
argument_list|(
name|m
operator|.
name|buf
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|cxio_dump_tcb
parameter_list|(
name|struct
name|cxio_rdev
modifier|*
name|rdev
parameter_list|,
name|uint32_t
name|hwtid
parameter_list|)
block|{
name|struct
name|ch_mem_range
name|m
decl_stmt|;
name|int
name|size
init|=
name|TCB_SIZE
decl_stmt|;
name|uint32_t
modifier|*
name|data
decl_stmt|;
name|uint32_t
name|addr
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|m
operator|.
name|buf
operator|=
name|malloc
argument_list|(
name|size
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|.
name|buf
operator|==
name|NULL
condition|)
block|{
name|CTR1
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s couldn't allocate memory."
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
return|return;
block|}
name|m
operator|.
name|mem_id
operator|=
name|MEM_CM
expr_stmt|;
name|m
operator|.
name|addr
operator|=
name|hwtid
operator|*
name|size
expr_stmt|;
name|m
operator|.
name|len
operator|=
name|size
expr_stmt|;
name|CTR3
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s TCB %d len %d"
argument_list|,
name|__FUNCTION__
argument_list|,
name|m
operator|.
name|addr
argument_list|,
name|m
operator|.
name|len
argument_list|)
expr_stmt|;
name|rc
operator|=
name|cxio_rdma_get_mem
argument_list|(
name|rdev
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|CTR2
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s toectl returned error %d"
argument_list|,
name|__FUNCTION__
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|m
operator|.
name|buf
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
return|return;
block|}
name|data
operator|=
operator|(
name|uint32_t
operator|*
operator|)
name|m
operator|.
name|buf
expr_stmt|;
name|addr
operator|=
name|m
operator|.
name|addr
expr_stmt|;
while|while
condition|(
name|size
operator|>
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%2u: %08x %08x %08x %08x %08x %08x %08x %08x\n"
argument_list|,
name|addr
argument_list|,
operator|*
operator|(
name|data
operator|+
literal|2
operator|)
argument_list|,
operator|*
operator|(
name|data
operator|+
literal|3
operator|)
argument_list|,
operator|*
operator|(
name|data
operator|)
argument_list|,
operator|*
operator|(
name|data
operator|+
literal|1
operator|)
argument_list|,
operator|*
operator|(
name|data
operator|+
literal|6
operator|)
argument_list|,
operator|*
operator|(
name|data
operator|+
literal|7
operator|)
argument_list|,
operator|*
operator|(
name|data
operator|+
literal|4
operator|)
argument_list|,
operator|*
operator|(
name|data
operator|+
literal|5
operator|)
argument_list|)
expr_stmt|;
name|size
operator|-=
literal|32
expr_stmt|;
name|data
operator|+=
literal|8
expr_stmt|;
name|addr
operator|+=
literal|32
expr_stmt|;
block|}
name|free
argument_list|(
name|m
operator|.
name|buf
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

end_unit


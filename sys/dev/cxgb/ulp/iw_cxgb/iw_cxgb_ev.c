begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/**************************************************************************  Copyright (c) 2007, Chelsio Inc. All rights reserved.  Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:   1. Redistributions of source code must retain the above copyright notice,     this list of conditions and the following disclaimer.   2. Neither the name of the Chelsio Corporation nor the names of its     contributors may be used to endorse or promote products derived from     this software without specific prior written permission.  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  ***************************************************************************/
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"opt_inet.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|TCP_OFFLOAD
end_ifdef

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/pciio.h>
end_include

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioccom.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<sys/rwlock.h>
end_include

begin_include
include|#
directive|include
file|<sys/linker.h>
end_include

begin_include
include|#
directive|include
file|<sys/firmware.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_include
include|#
directive|include
file|<sys/smp.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/syslog.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<sys/taskqueue.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<sys/libkern.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<rdma/ib_verbs.h>
end_include

begin_include
include|#
directive|include
file|<rdma/ib_umem.h>
end_include

begin_include
include|#
directive|include
file|<rdma/ib_user_verbs.h>
end_include

begin_include
include|#
directive|include
file|<linux/idr.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_ib_intfc.h>
end_include

begin_include
include|#
directive|include
file|<cxgb_include.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_wr.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_hal.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_provider.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_cm.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_resource.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_user.h>
end_include

begin_function
specifier|static
name|void
name|post_qp_event
parameter_list|(
name|struct
name|iwch_dev
modifier|*
name|rnicp
parameter_list|,
name|struct
name|iwch_qp
modifier|*
name|qhp
parameter_list|,
name|struct
name|iwch_cq
modifier|*
name|chp
parameter_list|,
name|struct
name|respQ_msg_t
modifier|*
name|rsp_msg
parameter_list|,
name|enum
name|ib_event_type
name|ib_event
parameter_list|,
name|int
name|send_term
parameter_list|)
block|{
name|struct
name|ib_event
name|event
decl_stmt|;
name|struct
name|iwch_qp_attributes
name|attrs
decl_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|rnicp
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|qhp
condition|)
block|{
name|CTR3
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s unaffiliated error 0x%x qpid 0x%x\n"
argument_list|,
name|__func__
argument_list|,
name|CQE_STATUS
argument_list|(
name|rsp_msg
operator|->
name|cqe
argument_list|)
argument_list|,
name|CQE_QPID
argument_list|(
name|rsp_msg
operator|->
name|cqe
argument_list|)
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|rnicp
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|(
name|qhp
operator|->
name|attr
operator|.
name|state
operator|==
name|IWCH_QP_STATE_ERROR
operator|)
operator|||
operator|(
name|qhp
operator|->
name|attr
operator|.
name|state
operator|==
name|IWCH_QP_STATE_TERMINATE
operator|)
condition|)
block|{
name|CTR4
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s AE received after RTS - "
literal|"qp state %d qpid 0x%x status 0x%x"
argument_list|,
name|__FUNCTION__
argument_list|,
name|qhp
operator|->
name|attr
operator|.
name|state
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|qpid
argument_list|,
name|CQE_STATUS
argument_list|(
name|rsp_msg
operator|->
name|cqe
argument_list|)
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|rnicp
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return;
block|}
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"%s - AE qpid 0x%x opcode %d status 0x%x "
literal|"type %d wrid.hi 0x%x wrid.lo 0x%x \n"
argument_list|,
name|__FUNCTION__
argument_list|,
name|CQE_QPID
argument_list|(
name|rsp_msg
operator|->
name|cqe
argument_list|)
argument_list|,
name|CQE_OPCODE
argument_list|(
name|rsp_msg
operator|->
name|cqe
argument_list|)
argument_list|,
name|CQE_STATUS
argument_list|(
name|rsp_msg
operator|->
name|cqe
argument_list|)
argument_list|,
name|CQE_TYPE
argument_list|(
name|rsp_msg
operator|->
name|cqe
argument_list|)
argument_list|,
name|CQE_WRID_HI
argument_list|(
name|rsp_msg
operator|->
name|cqe
argument_list|)
argument_list|,
name|CQE_WRID_LOW
argument_list|(
name|rsp_msg
operator|->
name|cqe
argument_list|)
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|rnicp
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|qhp
operator|->
name|attr
operator|.
name|state
operator|==
name|IWCH_QP_STATE_RTS
condition|)
block|{
name|attrs
operator|.
name|next_state
operator|=
name|IWCH_QP_STATE_TERMINATE
expr_stmt|;
name|iwch_modify_qp
argument_list|(
name|qhp
operator|->
name|rhp
argument_list|,
name|qhp
argument_list|,
name|IWCH_QP_ATTR_NEXT_STATE
argument_list|,
operator|&
name|attrs
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|send_term
condition|)
name|iwch_post_terminate
argument_list|(
name|qhp
argument_list|,
name|rsp_msg
argument_list|)
expr_stmt|;
block|}
name|event
operator|.
name|event
operator|=
name|ib_event
expr_stmt|;
name|event
operator|.
name|device
operator|=
name|chp
operator|->
name|ibcq
operator|.
name|device
expr_stmt|;
if|if
condition|(
name|ib_event
operator|==
name|IB_EVENT_CQ_ERR
condition|)
name|event
operator|.
name|element
operator|.
name|cq
operator|=
operator|&
name|chp
operator|->
name|ibcq
expr_stmt|;
else|else
name|event
operator|.
name|element
operator|.
name|qp
operator|=
operator|&
name|qhp
operator|->
name|ibqp
expr_stmt|;
if|if
condition|(
name|qhp
operator|->
name|ibqp
operator|.
name|event_handler
condition|)
call|(
modifier|*
name|qhp
operator|->
name|ibqp
operator|.
name|event_handler
call|)
argument_list|(
operator|&
name|event
argument_list|,
name|qhp
operator|->
name|ibqp
operator|.
name|qp_context
argument_list|)
expr_stmt|;
call|(
modifier|*
name|chp
operator|->
name|ibcq
operator|.
name|comp_handler
call|)
argument_list|(
operator|&
name|chp
operator|->
name|ibcq
argument_list|,
name|chp
operator|->
name|ibcq
operator|.
name|cq_context
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|iwch_ev_dispatch
parameter_list|(
name|struct
name|iwch_dev
modifier|*
name|rnicp
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|)
block|{
name|struct
name|respQ_msg_t
modifier|*
name|rsp_msg
init|=
operator|(
expr|struct
name|respQ_msg_t
operator|*
operator|)
name|m
operator|->
name|m_data
decl_stmt|;
name|struct
name|iwch_cq
modifier|*
name|chp
decl_stmt|;
name|struct
name|iwch_qp
modifier|*
name|qhp
decl_stmt|;
name|u32
name|cqid
init|=
name|RSPQ_CQID
argument_list|(
name|rsp_msg
argument_list|)
decl_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|rnicp
operator|->
name|lock
argument_list|)
expr_stmt|;
name|chp
operator|=
name|get_chp
argument_list|(
name|rnicp
argument_list|,
name|cqid
argument_list|)
expr_stmt|;
name|qhp
operator|=
name|get_qhp
argument_list|(
name|rnicp
argument_list|,
name|CQE_QPID
argument_list|(
name|rsp_msg
operator|->
name|cqe
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|chp
operator|||
operator|!
name|qhp
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"BAD AE cqid 0x%x qpid 0x%x opcode %d "
literal|"status 0x%x type %d wrid.hi 0x%x wrid.lo 0x%x \n"
argument_list|,
name|cqid
argument_list|,
name|CQE_QPID
argument_list|(
name|rsp_msg
operator|->
name|cqe
argument_list|)
argument_list|,
name|CQE_OPCODE
argument_list|(
name|rsp_msg
operator|->
name|cqe
argument_list|)
argument_list|,
name|CQE_STATUS
argument_list|(
name|rsp_msg
operator|->
name|cqe
argument_list|)
argument_list|,
name|CQE_TYPE
argument_list|(
name|rsp_msg
operator|->
name|cqe
argument_list|)
argument_list|,
name|CQE_WRID_HI
argument_list|(
name|rsp_msg
operator|->
name|cqe
argument_list|)
argument_list|,
name|CQE_WRID_LOW
argument_list|(
name|rsp_msg
operator|->
name|cqe
argument_list|)
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|rnicp
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return;
block|}
name|iwch_qp_add_ref
argument_list|(
operator|&
name|qhp
operator|->
name|ibqp
argument_list|)
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|chp
operator|->
name|lock
argument_list|)
expr_stmt|;
operator|++
name|chp
operator|->
name|refcnt
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|chp
operator|->
name|lock
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|rnicp
operator|->
name|lock
argument_list|)
expr_stmt|;
comment|/* 	 * 1) completion of our sending a TERMINATE. 	 * 2) incoming TERMINATE message. 	 */
if|if
condition|(
operator|(
name|CQE_OPCODE
argument_list|(
name|rsp_msg
operator|->
name|cqe
argument_list|)
operator|==
name|T3_TERMINATE
operator|)
operator|&&
operator|(
name|CQE_STATUS
argument_list|(
name|rsp_msg
operator|->
name|cqe
argument_list|)
operator|==
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|SQ_TYPE
argument_list|(
name|rsp_msg
operator|->
name|cqe
argument_list|)
condition|)
block|{
name|CTR3
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s QPID 0x%x ep %p disconnecting"
argument_list|,
name|__FUNCTION__
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|qpid
argument_list|,
name|qhp
operator|->
name|ep
argument_list|)
expr_stmt|;
name|iwch_ep_disconnect
argument_list|(
name|qhp
operator|->
name|ep
argument_list|,
literal|0
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|CTR2
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s post REQ_ERR AE QPID 0x%x"
argument_list|,
name|__FUNCTION__
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|qpid
argument_list|)
expr_stmt|;
name|post_qp_event
argument_list|(
name|rnicp
argument_list|,
name|qhp
argument_list|,
name|chp
argument_list|,
name|rsp_msg
argument_list|,
name|IB_EVENT_QP_REQ_ERR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|iwch_ep_disconnect
argument_list|(
name|qhp
operator|->
name|ep
argument_list|,
literal|0
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
block|}
goto|goto
name|done
goto|;
block|}
comment|/* Bad incoming Read request */
if|if
condition|(
name|SQ_TYPE
argument_list|(
name|rsp_msg
operator|->
name|cqe
argument_list|)
operator|&&
operator|(
name|CQE_OPCODE
argument_list|(
name|rsp_msg
operator|->
name|cqe
argument_list|)
operator|==
name|T3_READ_RESP
operator|)
condition|)
block|{
name|post_qp_event
argument_list|(
name|rnicp
argument_list|,
name|qhp
argument_list|,
name|chp
argument_list|,
name|rsp_msg
argument_list|,
name|IB_EVENT_QP_REQ_ERR
argument_list|,
literal|1
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
comment|/* Bad incoming write */
if|if
condition|(
name|RQ_TYPE
argument_list|(
name|rsp_msg
operator|->
name|cqe
argument_list|)
operator|&&
operator|(
name|CQE_OPCODE
argument_list|(
name|rsp_msg
operator|->
name|cqe
argument_list|)
operator|==
name|T3_RDMA_WRITE
operator|)
condition|)
block|{
name|post_qp_event
argument_list|(
name|rnicp
argument_list|,
name|qhp
argument_list|,
name|chp
argument_list|,
name|rsp_msg
argument_list|,
name|IB_EVENT_QP_REQ_ERR
argument_list|,
literal|1
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
switch|switch
condition|(
name|CQE_STATUS
argument_list|(
name|rsp_msg
operator|->
name|cqe
argument_list|)
condition|)
block|{
comment|/* Completion Events */
case|case
name|TPT_ERR_SUCCESS
case|:
if|#
directive|if
literal|0
comment|/* 		 * Confirm the destination entry if this is a RECV completion. 		 */
block|if (qhp->ep&& SQ_TYPE(rsp_msg->cqe)) 			dst_confirm(qhp->ep->dst);
endif|#
directive|endif
call|(
modifier|*
name|chp
operator|->
name|ibcq
operator|.
name|comp_handler
call|)
argument_list|(
operator|&
name|chp
operator|->
name|ibcq
argument_list|,
name|chp
operator|->
name|ibcq
operator|.
name|cq_context
argument_list|)
expr_stmt|;
break|break;
case|case
name|TPT_ERR_STAG
case|:
case|case
name|TPT_ERR_PDID
case|:
case|case
name|TPT_ERR_QPID
case|:
case|case
name|TPT_ERR_ACCESS
case|:
case|case
name|TPT_ERR_WRAP
case|:
case|case
name|TPT_ERR_BOUND
case|:
case|case
name|TPT_ERR_INVALIDATE_SHARED_MR
case|:
case|case
name|TPT_ERR_INVALIDATE_MR_WITH_MW_BOUND
case|:
name|post_qp_event
argument_list|(
name|rnicp
argument_list|,
name|qhp
argument_list|,
name|chp
argument_list|,
name|rsp_msg
argument_list|,
name|IB_EVENT_QP_ACCESS_ERR
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
comment|/* Device Fatal Errors */
case|case
name|TPT_ERR_ECC
case|:
case|case
name|TPT_ERR_ECC_PSTAG
case|:
case|case
name|TPT_ERR_INTERNAL_ERR
case|:
name|post_qp_event
argument_list|(
name|rnicp
argument_list|,
name|qhp
argument_list|,
name|chp
argument_list|,
name|rsp_msg
argument_list|,
name|IB_EVENT_DEVICE_FATAL
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
comment|/* QP Fatal Errors */
case|case
name|TPT_ERR_OUT_OF_RQE
case|:
case|case
name|TPT_ERR_PBL_ADDR_BOUND
case|:
case|case
name|TPT_ERR_CRC
case|:
case|case
name|TPT_ERR_MARKER
case|:
case|case
name|TPT_ERR_PDU_LEN_ERR
case|:
case|case
name|TPT_ERR_DDP_VERSION
case|:
case|case
name|TPT_ERR_RDMA_VERSION
case|:
case|case
name|TPT_ERR_OPCODE
case|:
case|case
name|TPT_ERR_DDP_QUEUE_NUM
case|:
case|case
name|TPT_ERR_MSN
case|:
case|case
name|TPT_ERR_TBIT
case|:
case|case
name|TPT_ERR_MO
case|:
case|case
name|TPT_ERR_MSN_GAP
case|:
case|case
name|TPT_ERR_MSN_RANGE
case|:
case|case
name|TPT_ERR_RQE_ADDR_BOUND
case|:
case|case
name|TPT_ERR_IRD_OVERFLOW
case|:
name|post_qp_event
argument_list|(
name|rnicp
argument_list|,
name|qhp
argument_list|,
name|chp
argument_list|,
name|rsp_msg
argument_list|,
name|IB_EVENT_QP_FATAL
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
default|default:
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"Unknown T3 status 0x%x QPID 0x%x\n"
argument_list|,
name|CQE_STATUS
argument_list|(
name|rsp_msg
operator|->
name|cqe
argument_list|)
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|qpid
argument_list|)
expr_stmt|;
name|post_qp_event
argument_list|(
name|rnicp
argument_list|,
name|qhp
argument_list|,
name|chp
argument_list|,
name|rsp_msg
argument_list|,
name|IB_EVENT_QP_FATAL
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
block|}
name|done
label|:
name|mtx_lock
argument_list|(
operator|&
name|chp
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
operator|--
name|chp
operator|->
name|refcnt
operator|==
literal|0
condition|)
name|wakeup
argument_list|(
name|chp
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|chp
operator|->
name|lock
argument_list|)
expr_stmt|;
name|iwch_qp_rem_ref
argument_list|(
operator|&
name|qhp
operator|->
name|ibqp
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/**************************************************************************  Copyright (c) 2007, Chelsio Inc. All rights reserved.  Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:   1. Redistributions of source code must retain the above copyright notice,     this list of conditions and the following disclaimer.   2. Neither the name of the Chelsio Corporation nor the names of its     contributors may be used to endorse or promote products derived from     this software without specific prior written permission.  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  ***************************************************************************/
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/pciio.h>
end_include

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus_dma.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioccom.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/rwlock.h>
end_include

begin_include
include|#
directive|include
file|<sys/linker.h>
end_include

begin_include
include|#
directive|include
file|<sys/firmware.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_include
include|#
directive|include
file|<sys/smp.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/syslog.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<sys/taskqueue.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm.h>
end_include

begin_include
include|#
directive|include
file|<vm/pmap.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<contrib/rdma/ib_verbs.h>
end_include

begin_include
include|#
directive|include
file|<cxgb_include.h>
end_include

begin_include
include|#
directive|include
file|<ulp/tom/cxgb_l2t.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_wr.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_hal.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_provider.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_cm.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_resource.h>
end_include

begin_expr_stmt
specifier|static
name|TAILQ_HEAD
argument_list|(
argument_list|,
argument|cxio_rdev
argument_list|)
name|rdev_list
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|cxio_hal_ev_callback_func_t
name|cxio_ev_cb
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|struct
name|cxio_rdev
modifier|*
name|cxio_hal_find_rdev_by_name
parameter_list|(
name|char
modifier|*
name|dev_name
parameter_list|)
block|{
name|struct
name|cxio_rdev
modifier|*
name|rdev
decl_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|rdev
argument_list|,
argument|&rdev_list
argument_list|,
argument|entry
argument_list|)
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|rdev
operator|->
name|dev_name
argument_list|,
name|dev_name
argument_list|)
condition|)
return|return
name|rdev
return|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|struct
name|cxio_rdev
modifier|*
name|cxio_hal_find_rdev_by_t3cdev
parameter_list|(
name|struct
name|t3cdev
modifier|*
name|tdev
parameter_list|)
block|{
name|struct
name|cxio_rdev
modifier|*
name|rdev
decl_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|rdev
argument_list|,
argument|&rdev_list
argument_list|,
argument|entry
argument_list|)
if|if
condition|(
name|rdev
operator|->
name|t3cdev_p
operator|==
name|tdev
condition|)
return|return
name|rdev
return|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|int
name|cxio_hal_cq_op
parameter_list|(
name|struct
name|cxio_rdev
modifier|*
name|rdev_p
parameter_list|,
name|struct
name|t3_cq
modifier|*
name|cq
parameter_list|,
name|enum
name|t3_cq_opcode
name|op
parameter_list|,
name|u32
name|credit
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|struct
name|t3_cqe
modifier|*
name|cqe
decl_stmt|;
name|u32
name|rptr
decl_stmt|;
name|struct
name|rdma_cq_op
name|setup
decl_stmt|;
name|setup
operator|.
name|id
operator|=
name|cq
operator|->
name|cqid
expr_stmt|;
name|setup
operator|.
name|credits
operator|=
operator|(
name|op
operator|==
name|CQ_CREDIT_UPDATE
operator|)
condition|?
name|credit
else|:
literal|0
expr_stmt|;
name|setup
operator|.
name|op
operator|=
name|op
expr_stmt|;
name|ret
operator|=
name|rdev_p
operator|->
name|t3cdev_p
operator|->
name|ctl
argument_list|(
name|rdev_p
operator|->
name|t3cdev_p
argument_list|,
name|RDMA_CQ_OP
argument_list|,
operator|&
name|setup
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ret
operator|<
literal|0
operator|)
operator|||
operator|(
name|op
operator|==
name|CQ_CREDIT_UPDATE
operator|)
condition|)
return|return
operator|(
name|ret
operator|)
return|;
comment|/* 	 * If the rearm returned an index other than our current index, 	 * then there might be CQE's in flight (being DMA'd).  We must wait 	 * here for them to complete or the consumer can miss a notification. 	 */
if|if
condition|(
name|Q_PTR2IDX
argument_list|(
operator|(
name|cq
operator|->
name|rptr
operator|)
argument_list|,
name|cq
operator|->
name|size_log2
argument_list|)
operator|!=
name|ret
condition|)
block|{
name|int
name|i
init|=
literal|0
decl_stmt|;
name|rptr
operator|=
name|cq
operator|->
name|rptr
expr_stmt|;
comment|/* 		 * Keep the generation correct by bumping rptr until it 		 * matches the index returned by the rearm - 1. 		 */
while|while
condition|(
name|Q_PTR2IDX
argument_list|(
operator|(
name|rptr
operator|+
literal|1
operator|)
argument_list|,
name|cq
operator|->
name|size_log2
argument_list|)
operator|!=
name|ret
condition|)
name|rptr
operator|++
expr_stmt|;
comment|/* 		 * Now rptr is the index for the (last) cqe that was 		 * in-flight at the time the HW rearmed the CQ.  We 		 * spin until that CQE is valid. 		 */
name|cqe
operator|=
name|cq
operator|->
name|queue
operator|+
name|Q_PTR2IDX
argument_list|(
name|rptr
argument_list|,
name|cq
operator|->
name|size_log2
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
name|CQ_VLD_ENTRY
argument_list|(
name|rptr
argument_list|,
name|cq
operator|->
name|size_log2
argument_list|,
name|cqe
argument_list|)
condition|)
block|{
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|++
operator|>
literal|1000000
condition|)
block|{
name|PANIC_IF
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"%s: stalled rnic\n"
argument_list|,
name|rdev_p
operator|->
name|dev_name
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
name|EIO
operator|)
return|;
block|}
block|}
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cxio_hal_clear_cq_ctx
parameter_list|(
name|struct
name|cxio_rdev
modifier|*
name|rdev_p
parameter_list|,
name|u32
name|cqid
parameter_list|)
block|{
name|struct
name|rdma_cq_setup
name|setup
decl_stmt|;
name|setup
operator|.
name|id
operator|=
name|cqid
expr_stmt|;
name|setup
operator|.
name|base_addr
operator|=
literal|0
expr_stmt|;
comment|/* NULL address */
name|setup
operator|.
name|size
operator|=
literal|0
expr_stmt|;
comment|/* disaable the CQ */
name|setup
operator|.
name|credits
operator|=
literal|0
expr_stmt|;
name|setup
operator|.
name|credit_thres
operator|=
literal|0
expr_stmt|;
name|setup
operator|.
name|ovfl_mode
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|rdev_p
operator|->
name|t3cdev_p
operator|->
name|ctl
argument_list|(
name|rdev_p
operator|->
name|t3cdev_p
argument_list|,
name|RDMA_CQ_SETUP
argument_list|,
operator|&
name|setup
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cxio_hal_clear_qp_ctx
parameter_list|(
name|struct
name|cxio_rdev
modifier|*
name|rdev_p
parameter_list|,
name|u32
name|qpid
parameter_list|)
block|{
name|u64
name|sge_cmd
decl_stmt|;
name|struct
name|t3_modify_qp_wr
modifier|*
name|wqe
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
init|=
name|m_gethdr
argument_list|(
name|MT_DATA
argument_list|,
name|M_NOWAIT
argument_list|)
decl_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
block|{
name|CTR1
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s m_gethdr failed"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
name|ENOMEM
operator|)
return|;
block|}
name|wqe
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|t3_modify_qp_wr
operator|*
argument_list|)
expr_stmt|;
name|m
operator|->
name|m_len
operator|=
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|wqe
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|wqe
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|wqe
argument_list|)
argument_list|)
expr_stmt|;
name|build_fw_riwrh
argument_list|(
operator|(
expr|struct
name|fw_riwrh
operator|*
operator|)
name|wqe
argument_list|,
name|T3_WR_QP_MOD
argument_list|,
literal|3
argument_list|,
literal|0
argument_list|,
name|qpid
argument_list|,
literal|7
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|flags
operator|=
name|htobe32
argument_list|(
name|MODQP_WRITE_EC
argument_list|)
expr_stmt|;
name|sge_cmd
operator|=
name|qpid
operator|<<
literal|8
operator||
literal|3
expr_stmt|;
name|wqe
operator|->
name|sge_cmd
operator|=
name|htobe64
argument_list|(
name|sge_cmd
argument_list|)
expr_stmt|;
name|m_set_priority
argument_list|(
name|m
argument_list|,
name|CPL_PRIORITY_CONTROL
argument_list|)
expr_stmt|;
name|m_set_sgl
argument_list|(
name|m
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|m_set_sgllen
argument_list|(
name|m
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|cxgb_ofld_send
argument_list|(
name|rdev_p
operator|->
name|t3cdev_p
argument_list|,
name|m
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|cxio_create_cq
parameter_list|(
name|struct
name|cxio_rdev
modifier|*
name|rdev_p
parameter_list|,
name|struct
name|t3_cq
modifier|*
name|cq
parameter_list|)
block|{
name|struct
name|rdma_cq_setup
name|setup
decl_stmt|;
name|int
name|size
init|=
operator|(
literal|1UL
operator|<<
operator|(
name|cq
operator|->
name|size_log2
operator|)
operator|)
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|t3_cqe
argument_list|)
decl_stmt|;
name|cq
operator|->
name|cqid
operator|=
name|cxio_hal_get_cqid
argument_list|(
name|rdev_p
operator|->
name|rscp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cq
operator|->
name|cqid
condition|)
return|return
operator|(
operator|-
name|ENOMEM
operator|)
return|;
name|cq
operator|->
name|sw_queue
operator|=
name|malloc
argument_list|(
name|size
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cq
operator|->
name|sw_queue
condition|)
return|return
operator|(
operator|-
name|ENOMEM
operator|)
return|;
if|#
directive|if
literal|0
block|cq->queue = dma_alloc_coherent(rdev_p->rnic_info.pdev, 					     (1UL<< (cq->size_log2)) * 					     sizeof(struct t3_cqe),&(cq->dma_addr), M_NOWAIT);
else|#
directive|else
name|cq
operator|->
name|queue
operator|=
name|contigmalloc
argument_list|(
operator|(
literal|1UL
operator|<<
operator|(
name|cq
operator|->
name|size_log2
operator|)
operator|)
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|t3_cqe
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
argument_list|,
literal|0ul
argument_list|,
operator|~
literal|0ul
argument_list|,
literal|4096
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|cq
operator|->
name|queue
condition|)
name|cq
operator|->
name|dma_addr
operator|=
name|vtophys
argument_list|(
name|cq
operator|->
name|queue
argument_list|)
expr_stmt|;
else|else
block|{
name|free
argument_list|(
name|cq
operator|->
name|sw_queue
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
name|ENOMEM
operator|)
return|;
block|}
endif|#
directive|endif
ifdef|#
directive|ifdef
name|notyet
name|pci_unmap_addr_set
argument_list|(
name|cq
argument_list|,
name|mapping
argument_list|,
name|cq
operator|->
name|dma_addr
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|memset
argument_list|(
name|cq
operator|->
name|queue
argument_list|,
literal|0
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|setup
operator|.
name|id
operator|=
name|cq
operator|->
name|cqid
expr_stmt|;
name|setup
operator|.
name|base_addr
operator|=
call|(
name|u64
call|)
argument_list|(
name|cq
operator|->
name|dma_addr
argument_list|)
expr_stmt|;
name|setup
operator|.
name|size
operator|=
literal|1UL
operator|<<
name|cq
operator|->
name|size_log2
expr_stmt|;
name|setup
operator|.
name|credits
operator|=
literal|65535
expr_stmt|;
name|setup
operator|.
name|credit_thres
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|rdev_p
operator|->
name|t3cdev_p
operator|->
name|type
operator|!=
name|T3A
condition|)
name|setup
operator|.
name|ovfl_mode
operator|=
literal|0
expr_stmt|;
else|else
name|setup
operator|.
name|ovfl_mode
operator|=
literal|1
expr_stmt|;
return|return
operator|(
name|rdev_p
operator|->
name|t3cdev_p
operator|->
name|ctl
argument_list|(
name|rdev_p
operator|->
name|t3cdev_p
argument_list|,
name|RDMA_CQ_SETUP
argument_list|,
operator|&
name|setup
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|cxio_resize_cq
parameter_list|(
name|struct
name|cxio_rdev
modifier|*
name|rdev_p
parameter_list|,
name|struct
name|t3_cq
modifier|*
name|cq
parameter_list|)
block|{
name|struct
name|rdma_cq_setup
name|setup
decl_stmt|;
name|setup
operator|.
name|id
operator|=
name|cq
operator|->
name|cqid
expr_stmt|;
name|setup
operator|.
name|base_addr
operator|=
call|(
name|u64
call|)
argument_list|(
name|cq
operator|->
name|dma_addr
argument_list|)
expr_stmt|;
name|setup
operator|.
name|size
operator|=
literal|1UL
operator|<<
name|cq
operator|->
name|size_log2
expr_stmt|;
name|setup
operator|.
name|credits
operator|=
name|setup
operator|.
name|size
expr_stmt|;
name|setup
operator|.
name|credit_thres
operator|=
name|setup
operator|.
name|size
expr_stmt|;
comment|/* TBD: overflow recovery */
name|setup
operator|.
name|ovfl_mode
operator|=
literal|1
expr_stmt|;
return|return
operator|(
name|rdev_p
operator|->
name|t3cdev_p
operator|->
name|ctl
argument_list|(
name|rdev_p
operator|->
name|t3cdev_p
argument_list|,
name|RDMA_CQ_SETUP
argument_list|,
operator|&
name|setup
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|u32
name|get_qpid
parameter_list|(
name|struct
name|cxio_rdev
modifier|*
name|rdev_p
parameter_list|,
name|struct
name|cxio_ucontext
modifier|*
name|uctx
parameter_list|)
block|{
name|struct
name|cxio_qpid
modifier|*
name|entry
decl_stmt|;
name|u32
name|qpid
decl_stmt|;
name|int
name|i
decl_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|uctx
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|TAILQ_EMPTY
argument_list|(
operator|&
name|uctx
operator|->
name|qpids
argument_list|)
condition|)
block|{
name|entry
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|uctx
operator|->
name|qpids
argument_list|)
expr_stmt|;
name|TAILQ_REMOVE
argument_list|(
operator|&
name|uctx
operator|->
name|qpids
argument_list|,
name|entry
argument_list|,
name|entry
argument_list|)
expr_stmt|;
name|qpid
operator|=
name|entry
operator|->
name|qpid
expr_stmt|;
name|free
argument_list|(
name|entry
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|qpid
operator|=
name|cxio_hal_get_qpid
argument_list|(
name|rdev_p
operator|->
name|rscp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|qpid
condition|)
goto|goto
name|out
goto|;
for|for
control|(
name|i
operator|=
name|qpid
operator|+
literal|1
init|;
name|i
operator|&
name|rdev_p
operator|->
name|qpmask
condition|;
name|i
operator|++
control|)
block|{
name|entry
operator|=
name|malloc
argument_list|(
sizeof|sizeof
expr|*
name|entry
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|entry
condition|)
break|break;
name|entry
operator|->
name|qpid
operator|=
name|i
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|uctx
operator|->
name|qpids
argument_list|,
name|entry
argument_list|,
name|entry
argument_list|)
expr_stmt|;
block|}
block|}
name|out
label|:
name|mtx_unlock
argument_list|(
operator|&
name|uctx
operator|->
name|lock
argument_list|)
expr_stmt|;
name|CTR2
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s qpid 0x%x"
argument_list|,
name|__FUNCTION__
argument_list|,
name|qpid
argument_list|)
expr_stmt|;
return|return
name|qpid
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|put_qpid
parameter_list|(
name|struct
name|cxio_rdev
modifier|*
name|rdev_p
parameter_list|,
name|u32
name|qpid
parameter_list|,
name|struct
name|cxio_ucontext
modifier|*
name|uctx
parameter_list|)
block|{
name|struct
name|cxio_qpid
modifier|*
name|entry
decl_stmt|;
name|entry
operator|=
name|malloc
argument_list|(
sizeof|sizeof
expr|*
name|entry
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
name|CTR2
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s qpid 0x%x"
argument_list|,
name|__FUNCTION__
argument_list|,
name|qpid
argument_list|)
expr_stmt|;
name|entry
operator|->
name|qpid
operator|=
name|qpid
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|uctx
operator|->
name|lock
argument_list|)
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|uctx
operator|->
name|qpids
argument_list|,
name|entry
argument_list|,
name|entry
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|uctx
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|cxio_release_ucontext
parameter_list|(
name|struct
name|cxio_rdev
modifier|*
name|rdev_p
parameter_list|,
name|struct
name|cxio_ucontext
modifier|*
name|uctx
parameter_list|)
block|{
name|struct
name|cxio_qpid
modifier|*
name|pos
decl_stmt|,
modifier|*
name|tmp
decl_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|uctx
operator|->
name|lock
argument_list|)
expr_stmt|;
name|TAILQ_FOREACH_SAFE
argument_list|(
argument|pos
argument_list|,
argument|&uctx->qpids
argument_list|,
argument|entry
argument_list|,
argument|tmp
argument_list|)
block|{
name|TAILQ_REMOVE
argument_list|(
operator|&
name|uctx
operator|->
name|qpids
argument_list|,
name|pos
argument_list|,
name|entry
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|pos
operator|->
name|qpid
operator|&
name|rdev_p
operator|->
name|qpmask
operator|)
condition|)
name|cxio_hal_put_qpid
argument_list|(
name|rdev_p
operator|->
name|rscp
argument_list|,
name|pos
operator|->
name|qpid
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|pos
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
block|}
name|mtx_unlock
argument_list|(
operator|&
name|uctx
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|cxio_init_ucontext
parameter_list|(
name|struct
name|cxio_rdev
modifier|*
name|rdev_p
parameter_list|,
name|struct
name|cxio_ucontext
modifier|*
name|uctx
parameter_list|)
block|{
name|TAILQ_INIT
argument_list|(
operator|&
name|uctx
operator|->
name|qpids
argument_list|)
expr_stmt|;
name|mtx_init
argument_list|(
operator|&
name|uctx
operator|->
name|lock
argument_list|,
literal|"cxio uctx"
argument_list|,
name|NULL
argument_list|,
name|MTX_DEF
operator||
name|MTX_DUPOK
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|cxio_create_qp
parameter_list|(
name|struct
name|cxio_rdev
modifier|*
name|rdev_p
parameter_list|,
name|u32
name|kernel_domain
parameter_list|,
name|struct
name|t3_wq
modifier|*
name|wq
parameter_list|,
name|struct
name|cxio_ucontext
modifier|*
name|uctx
parameter_list|)
block|{
name|int
name|depth
init|=
literal|1UL
operator|<<
name|wq
operator|->
name|size_log2
decl_stmt|;
name|int
name|rqsize
init|=
literal|1UL
operator|<<
name|wq
operator|->
name|rq_size_log2
decl_stmt|;
name|wq
operator|->
name|qpid
operator|=
name|get_qpid
argument_list|(
name|rdev_p
argument_list|,
name|uctx
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wq
operator|->
name|qpid
condition|)
return|return
operator|(
operator|-
name|ENOMEM
operator|)
return|;
name|wq
operator|->
name|rq
operator|=
name|malloc
argument_list|(
name|depth
operator|*
sizeof|sizeof
argument_list|(
name|u64
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wq
operator|->
name|rq
condition|)
goto|goto
name|err1
goto|;
name|wq
operator|->
name|rq_addr
operator|=
name|cxio_hal_rqtpool_alloc
argument_list|(
name|rdev_p
argument_list|,
name|rqsize
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wq
operator|->
name|rq_addr
condition|)
goto|goto
name|err2
goto|;
name|wq
operator|->
name|sq
operator|=
name|malloc
argument_list|(
name|depth
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|t3_swsq
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wq
operator|->
name|sq
condition|)
goto|goto
name|err3
goto|;
if|#
directive|if
literal|0
block|wq->queue = dma_alloc_coherent(rdev_p->rnic_info.pdev, 					     depth * sizeof(union t3_wr),&(wq->dma_addr), M_NOWAIT);
else|#
directive|else
name|wq
operator|->
name|queue
operator|=
name|contigmalloc
argument_list|(
name|depth
operator|*
sizeof|sizeof
argument_list|(
expr|union
name|t3_wr
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
argument_list|,
literal|0ul
argument_list|,
operator|~
literal|0ul
argument_list|,
literal|4096
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|wq
operator|->
name|queue
condition|)
name|wq
operator|->
name|dma_addr
operator|=
name|vtophys
argument_list|(
name|wq
operator|->
name|queue
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|wq
operator|->
name|queue
condition|)
goto|goto
name|err4
goto|;
name|memset
argument_list|(
name|wq
operator|->
name|queue
argument_list|,
literal|0
argument_list|,
name|depth
operator|*
sizeof|sizeof
argument_list|(
expr|union
name|t3_wr
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|notyet
name|pci_unmap_addr_set
argument_list|(
name|wq
argument_list|,
name|mapping
argument_list|,
name|wq
operator|->
name|dma_addr
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|wq
operator|->
name|doorbell
operator|=
name|rdev_p
operator|->
name|rnic_info
operator|.
name|kdb_addr
expr_stmt|;
if|if
condition|(
operator|!
name|kernel_domain
condition|)
name|wq
operator|->
name|udb
operator|=
operator|(
name|u64
operator|)
name|rdev_p
operator|->
name|rnic_info
operator|.
name|udbell_physbase
operator|+
operator|(
name|wq
operator|->
name|qpid
operator|<<
name|rdev_p
operator|->
name|qpshift
operator|)
expr_stmt|;
name|CTR4
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s qpid 0x%x doorbell 0x%p udb 0x%llx"
argument_list|,
name|__FUNCTION__
argument_list|,
name|wq
operator|->
name|qpid
argument_list|,
name|wq
operator|->
name|doorbell
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|wq
operator|->
name|udb
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|err4
label|:
name|free
argument_list|(
name|wq
operator|->
name|sq
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|err3
label|:
name|cxio_hal_rqtpool_free
argument_list|(
name|rdev_p
argument_list|,
name|wq
operator|->
name|rq_addr
argument_list|,
name|rqsize
argument_list|)
expr_stmt|;
name|err2
label|:
name|free
argument_list|(
name|wq
operator|->
name|rq
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|err1
label|:
name|put_qpid
argument_list|(
name|rdev_p
argument_list|,
name|wq
operator|->
name|qpid
argument_list|,
name|uctx
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
name|ENOMEM
operator|)
return|;
block|}
end_function

begin_function
name|int
name|cxio_destroy_cq
parameter_list|(
name|struct
name|cxio_rdev
modifier|*
name|rdev_p
parameter_list|,
name|struct
name|t3_cq
modifier|*
name|cq
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|err
operator|=
name|cxio_hal_clear_cq_ctx
argument_list|(
name|rdev_p
argument_list|,
name|cq
operator|->
name|cqid
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cq
operator|->
name|sw_queue
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|dma_free_coherent(&(rdev_p->rnic_info.pdev), 	    (1UL<< (cq->size_log2)) 			  * sizeof(struct t3_cqe), cq->queue,
comment|/* pci_unmap_addr(cq, mapping)*/
block|0);
else|#
directive|else
name|contigfree
argument_list|(
name|cq
operator|->
name|queue
argument_list|,
operator|(
literal|1UL
operator|<<
operator|(
name|cq
operator|->
name|size_log2
operator|)
operator|)
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|t3_cqe
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|cxio_hal_put_cqid
argument_list|(
name|rdev_p
operator|->
name|rscp
argument_list|,
name|cq
operator|->
name|cqid
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|int
name|cxio_destroy_qp
parameter_list|(
name|struct
name|cxio_rdev
modifier|*
name|rdev_p
parameter_list|,
name|struct
name|t3_wq
modifier|*
name|wq
parameter_list|,
name|struct
name|cxio_ucontext
modifier|*
name|uctx
parameter_list|)
block|{
if|#
directive|if
literal|0
block|dma_free_coherent(&(rdev_p->rnic_info.pdev), 			  (1UL<< (wq->size_log2)) 			  * sizeof(union t3_wr), wq->queue,
comment|/* pci_unmap_addr(wq, mapping)*/
block|0);
else|#
directive|else
name|contigfree
argument_list|(
name|wq
operator|->
name|queue
argument_list|,
operator|(
literal|1UL
operator|<<
operator|(
name|wq
operator|->
name|size_log2
operator|)
operator|)
operator|*
sizeof|sizeof
argument_list|(
expr|union
name|t3_wr
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|free
argument_list|(
name|wq
operator|->
name|sq
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|cxio_hal_rqtpool_free
argument_list|(
name|rdev_p
argument_list|,
name|wq
operator|->
name|rq_addr
argument_list|,
operator|(
literal|1UL
operator|<<
name|wq
operator|->
name|rq_size_log2
operator|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|wq
operator|->
name|rq
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|put_qpid
argument_list|(
name|rdev_p
argument_list|,
name|wq
operator|->
name|qpid
argument_list|,
name|uctx
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|insert_recv_cqe
parameter_list|(
name|struct
name|t3_wq
modifier|*
name|wq
parameter_list|,
name|struct
name|t3_cq
modifier|*
name|cq
parameter_list|)
block|{
name|struct
name|t3_cqe
name|cqe
decl_stmt|;
name|CTR5
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s wq %p cq %p sw_rptr 0x%x sw_wptr 0x%x"
argument_list|,
name|__FUNCTION__
argument_list|,
name|wq
argument_list|,
name|cq
argument_list|,
name|cq
operator|->
name|sw_rptr
argument_list|,
name|cq
operator|->
name|sw_wptr
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|cqe
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|cqe
argument_list|)
argument_list|)
expr_stmt|;
name|cqe
operator|.
name|header
operator|=
name|htobe32
argument_list|(
name|V_CQE_STATUS
argument_list|(
name|TPT_ERR_SWFLUSH
argument_list|)
operator||
name|V_CQE_OPCODE
argument_list|(
name|T3_SEND
argument_list|)
operator||
name|V_CQE_TYPE
argument_list|(
literal|0
argument_list|)
operator||
name|V_CQE_SWCQE
argument_list|(
literal|1
argument_list|)
operator||
name|V_CQE_QPID
argument_list|(
name|wq
operator|->
name|qpid
argument_list|)
operator||
name|V_CQE_GENBIT
argument_list|(
name|Q_GENBIT
argument_list|(
name|cq
operator|->
name|sw_wptr
argument_list|,
name|cq
operator|->
name|size_log2
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
operator|*
operator|(
name|cq
operator|->
name|sw_queue
operator|+
name|Q_PTR2IDX
argument_list|(
name|cq
operator|->
name|sw_wptr
argument_list|,
name|cq
operator|->
name|size_log2
argument_list|)
operator|)
operator|=
name|cqe
expr_stmt|;
name|cq
operator|->
name|sw_wptr
operator|++
expr_stmt|;
block|}
end_function

begin_function
name|void
name|cxio_flush_rq
parameter_list|(
name|struct
name|t3_wq
modifier|*
name|wq
parameter_list|,
name|struct
name|t3_cq
modifier|*
name|cq
parameter_list|,
name|int
name|count
parameter_list|)
block|{
name|u32
name|ptr
decl_stmt|;
name|CTR3
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s wq %p cq %p"
argument_list|,
name|__FUNCTION__
argument_list|,
name|wq
argument_list|,
name|cq
argument_list|)
expr_stmt|;
comment|/* flush RQ */
name|CTR4
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s rq_rptr %u rq_wptr %u skip count %u"
argument_list|,
name|__FUNCTION__
argument_list|,
name|wq
operator|->
name|rq_rptr
argument_list|,
name|wq
operator|->
name|rq_wptr
argument_list|,
name|count
argument_list|)
expr_stmt|;
name|ptr
operator|=
name|wq
operator|->
name|rq_rptr
operator|+
name|count
expr_stmt|;
while|while
condition|(
name|ptr
operator|++
operator|!=
name|wq
operator|->
name|rq_wptr
condition|)
name|insert_recv_cqe
argument_list|(
name|wq
argument_list|,
name|cq
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|insert_sq_cqe
parameter_list|(
name|struct
name|t3_wq
modifier|*
name|wq
parameter_list|,
name|struct
name|t3_cq
modifier|*
name|cq
parameter_list|,
name|struct
name|t3_swsq
modifier|*
name|sqp
parameter_list|)
block|{
name|struct
name|t3_cqe
name|cqe
decl_stmt|;
name|CTR5
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s wq %p cq %p sw_rptr 0x%x sw_wptr 0x%x"
argument_list|,
name|__FUNCTION__
argument_list|,
name|wq
argument_list|,
name|cq
argument_list|,
name|cq
operator|->
name|sw_rptr
argument_list|,
name|cq
operator|->
name|sw_wptr
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|cqe
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|cqe
argument_list|)
argument_list|)
expr_stmt|;
name|cqe
operator|.
name|header
operator|=
name|htobe32
argument_list|(
name|V_CQE_STATUS
argument_list|(
name|TPT_ERR_SWFLUSH
argument_list|)
operator||
name|V_CQE_OPCODE
argument_list|(
name|sqp
operator|->
name|opcode
argument_list|)
operator||
name|V_CQE_TYPE
argument_list|(
literal|1
argument_list|)
operator||
name|V_CQE_SWCQE
argument_list|(
literal|1
argument_list|)
operator||
name|V_CQE_QPID
argument_list|(
name|wq
operator|->
name|qpid
argument_list|)
operator||
name|V_CQE_GENBIT
argument_list|(
name|Q_GENBIT
argument_list|(
name|cq
operator|->
name|sw_wptr
argument_list|,
name|cq
operator|->
name|size_log2
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|cqe
operator|.
name|u
operator|.
name|scqe
operator|.
name|wrid_hi
operator|=
name|sqp
operator|->
name|sq_wptr
expr_stmt|;
operator|*
operator|(
name|cq
operator|->
name|sw_queue
operator|+
name|Q_PTR2IDX
argument_list|(
name|cq
operator|->
name|sw_wptr
argument_list|,
name|cq
operator|->
name|size_log2
argument_list|)
operator|)
operator|=
name|cqe
expr_stmt|;
name|cq
operator|->
name|sw_wptr
operator|++
expr_stmt|;
block|}
end_function

begin_function
name|void
name|cxio_flush_sq
parameter_list|(
name|struct
name|t3_wq
modifier|*
name|wq
parameter_list|,
name|struct
name|t3_cq
modifier|*
name|cq
parameter_list|,
name|int
name|count
parameter_list|)
block|{
name|__u32
name|ptr
decl_stmt|;
name|struct
name|t3_swsq
modifier|*
name|sqp
init|=
name|wq
operator|->
name|sq
operator|+
name|Q_PTR2IDX
argument_list|(
name|wq
operator|->
name|sq_rptr
argument_list|,
name|wq
operator|->
name|sq_size_log2
argument_list|)
decl_stmt|;
name|ptr
operator|=
name|wq
operator|->
name|sq_rptr
operator|+
name|count
expr_stmt|;
name|sqp
operator|+=
name|count
expr_stmt|;
while|while
condition|(
name|ptr
operator|!=
name|wq
operator|->
name|sq_wptr
condition|)
block|{
name|insert_sq_cqe
argument_list|(
name|wq
argument_list|,
name|cq
argument_list|,
name|sqp
argument_list|)
expr_stmt|;
name|sqp
operator|++
expr_stmt|;
name|ptr
operator|++
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Move all CQEs from the HWCQ into the SWCQ.  */
end_comment

begin_function
name|void
name|cxio_flush_hw_cq
parameter_list|(
name|struct
name|t3_cq
modifier|*
name|cq
parameter_list|)
block|{
name|struct
name|t3_cqe
modifier|*
name|cqe
decl_stmt|,
modifier|*
name|swcqe
decl_stmt|;
name|CTR3
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s cq %p cqid 0x%x"
argument_list|,
name|__FUNCTION__
argument_list|,
name|cq
argument_list|,
name|cq
operator|->
name|cqid
argument_list|)
expr_stmt|;
name|cqe
operator|=
name|cxio_next_hw_cqe
argument_list|(
name|cq
argument_list|)
expr_stmt|;
while|while
condition|(
name|cqe
condition|)
block|{
name|CTR3
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s flushing hwcq rptr 0x%x to swcq wptr 0x%x"
argument_list|,
name|__FUNCTION__
argument_list|,
name|cq
operator|->
name|rptr
argument_list|,
name|cq
operator|->
name|sw_wptr
argument_list|)
expr_stmt|;
name|swcqe
operator|=
name|cq
operator|->
name|sw_queue
operator|+
name|Q_PTR2IDX
argument_list|(
name|cq
operator|->
name|sw_wptr
argument_list|,
name|cq
operator|->
name|size_log2
argument_list|)
expr_stmt|;
operator|*
name|swcqe
operator|=
operator|*
name|cqe
expr_stmt|;
name|swcqe
operator|->
name|header
operator||=
name|htobe32
argument_list|(
name|V_CQE_SWCQE
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|cq
operator|->
name|sw_wptr
operator|++
expr_stmt|;
name|cq
operator|->
name|rptr
operator|++
expr_stmt|;
name|cqe
operator|=
name|cxio_next_hw_cqe
argument_list|(
name|cq
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|cqe_completes_wr
parameter_list|(
name|struct
name|t3_cqe
modifier|*
name|cqe
parameter_list|,
name|struct
name|t3_wq
modifier|*
name|wq
parameter_list|)
block|{
if|if
condition|(
name|CQE_OPCODE
argument_list|(
operator|*
name|cqe
argument_list|)
operator|==
name|T3_TERMINATE
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|(
name|CQE_OPCODE
argument_list|(
operator|*
name|cqe
argument_list|)
operator|==
name|T3_RDMA_WRITE
operator|)
operator|&&
name|RQ_TYPE
argument_list|(
operator|*
name|cqe
argument_list|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|(
name|CQE_OPCODE
argument_list|(
operator|*
name|cqe
argument_list|)
operator|==
name|T3_READ_RESP
operator|)
operator|&&
name|SQ_TYPE
argument_list|(
operator|*
name|cqe
argument_list|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|(
name|CQE_OPCODE
argument_list|(
operator|*
name|cqe
argument_list|)
operator|==
name|T3_SEND
operator|)
operator|&&
name|RQ_TYPE
argument_list|(
operator|*
name|cqe
argument_list|)
operator|&&
name|Q_EMPTY
argument_list|(
name|wq
operator|->
name|rq_rptr
argument_list|,
name|wq
operator|->
name|rq_wptr
argument_list|)
condition|)
return|return
literal|0
return|;
return|return
literal|1
return|;
block|}
end_function

begin_function
name|void
name|cxio_count_scqes
parameter_list|(
name|struct
name|t3_cq
modifier|*
name|cq
parameter_list|,
name|struct
name|t3_wq
modifier|*
name|wq
parameter_list|,
name|int
modifier|*
name|count
parameter_list|)
block|{
name|struct
name|t3_cqe
modifier|*
name|cqe
decl_stmt|;
name|u32
name|ptr
decl_stmt|;
operator|*
name|count
operator|=
literal|0
expr_stmt|;
name|ptr
operator|=
name|cq
operator|->
name|sw_rptr
expr_stmt|;
while|while
condition|(
operator|!
name|Q_EMPTY
argument_list|(
name|ptr
argument_list|,
name|cq
operator|->
name|sw_wptr
argument_list|)
condition|)
block|{
name|cqe
operator|=
name|cq
operator|->
name|sw_queue
operator|+
operator|(
name|Q_PTR2IDX
argument_list|(
name|ptr
argument_list|,
name|cq
operator|->
name|size_log2
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|SQ_TYPE
argument_list|(
operator|*
name|cqe
argument_list|)
operator|||
operator|(
name|CQE_OPCODE
argument_list|(
operator|*
name|cqe
argument_list|)
operator|==
name|T3_READ_RESP
operator|)
operator|)
operator|&&
operator|(
name|CQE_QPID
argument_list|(
operator|*
name|cqe
argument_list|)
operator|==
name|wq
operator|->
name|qpid
operator|)
condition|)
operator|(
operator|*
name|count
operator|)
operator|++
expr_stmt|;
name|ptr
operator|++
expr_stmt|;
block|}
name|CTR3
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s cq %p count %d"
argument_list|,
name|__FUNCTION__
argument_list|,
name|cq
argument_list|,
operator|*
name|count
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|cxio_count_rcqes
parameter_list|(
name|struct
name|t3_cq
modifier|*
name|cq
parameter_list|,
name|struct
name|t3_wq
modifier|*
name|wq
parameter_list|,
name|int
modifier|*
name|count
parameter_list|)
block|{
name|struct
name|t3_cqe
modifier|*
name|cqe
decl_stmt|;
name|u32
name|ptr
decl_stmt|;
operator|*
name|count
operator|=
literal|0
expr_stmt|;
name|CTR2
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s count zero %d"
argument_list|,
name|__FUNCTION__
argument_list|,
operator|*
name|count
argument_list|)
expr_stmt|;
name|ptr
operator|=
name|cq
operator|->
name|sw_rptr
expr_stmt|;
while|while
condition|(
operator|!
name|Q_EMPTY
argument_list|(
name|ptr
argument_list|,
name|cq
operator|->
name|sw_wptr
argument_list|)
condition|)
block|{
name|cqe
operator|=
name|cq
operator|->
name|sw_queue
operator|+
operator|(
name|Q_PTR2IDX
argument_list|(
name|ptr
argument_list|,
name|cq
operator|->
name|size_log2
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
name|RQ_TYPE
argument_list|(
operator|*
name|cqe
argument_list|)
operator|&&
operator|(
name|CQE_OPCODE
argument_list|(
operator|*
name|cqe
argument_list|)
operator|!=
name|T3_READ_RESP
operator|)
operator|&&
operator|(
name|CQE_QPID
argument_list|(
operator|*
name|cqe
argument_list|)
operator|==
name|wq
operator|->
name|qpid
operator|)
operator|&&
name|cqe_completes_wr
argument_list|(
name|cqe
argument_list|,
name|wq
argument_list|)
condition|)
operator|(
operator|*
name|count
operator|)
operator|++
expr_stmt|;
name|ptr
operator|++
expr_stmt|;
block|}
name|CTR3
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s cq %p count %d"
argument_list|,
name|__FUNCTION__
argument_list|,
name|cq
argument_list|,
operator|*
name|count
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|cxio_hal_init_ctrl_cq
parameter_list|(
name|struct
name|cxio_rdev
modifier|*
name|rdev_p
parameter_list|)
block|{
name|struct
name|rdma_cq_setup
name|setup
decl_stmt|;
name|setup
operator|.
name|id
operator|=
literal|0
expr_stmt|;
name|setup
operator|.
name|base_addr
operator|=
literal|0
expr_stmt|;
comment|/* NULL address */
name|setup
operator|.
name|size
operator|=
literal|1
expr_stmt|;
comment|/* enable the CQ */
name|setup
operator|.
name|credits
operator|=
literal|0
expr_stmt|;
comment|/* force SGE to redirect to RspQ and interrupt */
name|setup
operator|.
name|credit_thres
operator|=
literal|0
expr_stmt|;
name|setup
operator|.
name|ovfl_mode
operator|=
literal|1
expr_stmt|;
return|return
operator|(
name|rdev_p
operator|->
name|t3cdev_p
operator|->
name|ctl
argument_list|(
name|rdev_p
operator|->
name|t3cdev_p
argument_list|,
name|RDMA_CQ_SETUP
argument_list|,
operator|&
name|setup
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cxio_hal_init_ctrl_qp
parameter_list|(
name|struct
name|cxio_rdev
modifier|*
name|rdev_p
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|u64
name|sge_cmd
decl_stmt|,
name|ctx0
decl_stmt|,
name|ctx1
decl_stmt|;
name|u64
name|base_addr
decl_stmt|;
name|struct
name|t3_modify_qp_wr
modifier|*
name|wqe
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|m
operator|=
name|m_gethdr
argument_list|(
name|MT_DATA
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
block|{
name|CTR1
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s m_gethdr failed"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
name|ENOMEM
operator|)
return|;
block|}
name|err
operator|=
name|cxio_hal_init_ctrl_cq
argument_list|(
name|rdev_p
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|CTR2
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s err %d initializing ctrl_cq"
argument_list|,
name|__FUNCTION__
argument_list|,
name|err
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|#
directive|if
literal|0
block|rdev_p->ctrl_qp.workq = dma_alloc_coherent( 		rdev_p->rnic_info.pdev, 		    (1<< T3_CTRL_QP_SIZE_LOG2) * 		    sizeof(union t3_wr),&(rdev_p->ctrl_qp.dma_addr), 		    M_NOWAIT);
else|#
directive|else
name|rdev_p
operator|->
name|ctrl_qp
operator|.
name|workq
operator|=
name|contigmalloc
argument_list|(
operator|(
literal|1
operator|<<
name|T3_CTRL_QP_SIZE_LOG2
operator|)
operator|*
sizeof|sizeof
argument_list|(
expr|union
name|t3_wr
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
argument_list|,
literal|0ul
argument_list|,
operator|~
literal|0ul
argument_list|,
literal|4096
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev_p
operator|->
name|ctrl_qp
operator|.
name|workq
condition|)
name|rdev_p
operator|->
name|ctrl_qp
operator|.
name|dma_addr
operator|=
name|vtophys
argument_list|(
name|rdev_p
operator|->
name|ctrl_qp
operator|.
name|workq
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|rdev_p
operator|->
name|ctrl_qp
operator|.
name|workq
condition|)
block|{
name|CTR1
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s dma_alloc_coherent failed"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
name|err
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|#
directive|if
literal|0
block|pci_unmap_addr_set(&rdev_p->ctrl_qp, mapping, 			   rdev_p->ctrl_qp.dma_addr);
endif|#
directive|endif
name|rdev_p
operator|->
name|ctrl_qp
operator|.
name|doorbell
operator|=
operator|(
name|void
comment|/*__iomem */
operator|*
operator|)
name|rdev_p
operator|->
name|rnic_info
operator|.
name|kdb_addr
expr_stmt|;
name|memset
argument_list|(
name|rdev_p
operator|->
name|ctrl_qp
operator|.
name|workq
argument_list|,
literal|0
argument_list|,
operator|(
literal|1
operator|<<
name|T3_CTRL_QP_SIZE_LOG2
operator|)
operator|*
sizeof|sizeof
argument_list|(
expr|union
name|t3_wr
argument_list|)
argument_list|)
expr_stmt|;
name|mtx_init
argument_list|(
operator|&
name|rdev_p
operator|->
name|ctrl_qp
operator|.
name|lock
argument_list|,
literal|"ctl-qp lock"
argument_list|,
name|NULL
argument_list|,
name|MTX_DEF
operator||
name|MTX_DUPOK
argument_list|)
expr_stmt|;
comment|/* update HW Ctrl QP context */
name|base_addr
operator|=
name|rdev_p
operator|->
name|ctrl_qp
operator|.
name|dma_addr
expr_stmt|;
name|base_addr
operator|>>=
literal|12
expr_stmt|;
name|ctx0
operator|=
operator|(
name|V_EC_SIZE
argument_list|(
operator|(
literal|1
operator|<<
name|T3_CTRL_QP_SIZE_LOG2
operator|)
argument_list|)
operator||
name|V_EC_BASE_LO
argument_list|(
operator|(
name|u32
operator|)
name|base_addr
operator|&
literal|0xffff
argument_list|)
operator|)
expr_stmt|;
name|ctx0
operator|<<=
literal|32
expr_stmt|;
name|ctx0
operator||=
name|V_EC_CREDITS
argument_list|(
name|FW_WR_NUM
argument_list|)
expr_stmt|;
name|base_addr
operator|>>=
literal|16
expr_stmt|;
name|ctx1
operator|=
operator|(
name|u32
operator|)
name|base_addr
expr_stmt|;
name|base_addr
operator|>>=
literal|32
expr_stmt|;
name|ctx1
operator||=
operator|(
call|(
name|u64
call|)
argument_list|(
name|V_EC_BASE_HI
argument_list|(
operator|(
name|u32
operator|)
name|base_addr
operator|&
literal|0xf
argument_list|)
operator||
name|V_EC_RESPQ
argument_list|(
literal|0
argument_list|)
operator||
name|V_EC_TYPE
argument_list|(
literal|0
argument_list|)
operator||
name|V_EC_GEN
argument_list|(
literal|1
argument_list|)
operator||
name|V_EC_UP_TOKEN
argument_list|(
name|T3_CTL_QP_TID
argument_list|)
operator||
name|F_EC_VALID
argument_list|)
operator|)
operator|<<
literal|32
expr_stmt|;
name|wqe
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|t3_modify_qp_wr
operator|*
argument_list|)
expr_stmt|;
name|m
operator|->
name|m_len
operator|=
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|wqe
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|wqe
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|wqe
argument_list|)
argument_list|)
expr_stmt|;
name|build_fw_riwrh
argument_list|(
operator|(
expr|struct
name|fw_riwrh
operator|*
operator|)
name|wqe
argument_list|,
name|T3_WR_QP_MOD
argument_list|,
literal|3
argument_list|,
literal|0
argument_list|,
name|T3_CTL_QP_TID
argument_list|,
literal|7
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|flags
operator|=
name|htobe32
argument_list|(
name|MODQP_WRITE_EC
argument_list|)
expr_stmt|;
name|sge_cmd
operator|=
operator|(
literal|3ULL
operator|<<
literal|56
operator|)
operator||
name|FW_RI_SGEEC_START
operator|<<
literal|8
operator||
literal|3
expr_stmt|;
name|wqe
operator|->
name|sge_cmd
operator|=
name|htobe64
argument_list|(
name|sge_cmd
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|ctx1
operator|=
name|htobe64
argument_list|(
name|ctx1
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|ctx0
operator|=
name|htobe64
argument_list|(
name|ctx0
argument_list|)
expr_stmt|;
name|CTR3
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"CtrlQP dma_addr 0x%llx workq %p size %d"
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|rdev_p
operator|->
name|ctrl_qp
operator|.
name|dma_addr
argument_list|,
name|rdev_p
operator|->
name|ctrl_qp
operator|.
name|workq
argument_list|,
literal|1
operator|<<
name|T3_CTRL_QP_SIZE_LOG2
argument_list|)
expr_stmt|;
name|m_set_priority
argument_list|(
name|m
argument_list|,
name|CPL_PRIORITY_CONTROL
argument_list|)
expr_stmt|;
name|m_set_sgl
argument_list|(
name|m
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|m_set_sgllen
argument_list|(
name|m
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|cxgb_ofld_send
argument_list|(
name|rdev_p
operator|->
name|t3cdev_p
argument_list|,
name|m
argument_list|)
operator|)
return|;
name|err
label|:
name|m_free
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cxio_hal_destroy_ctrl_qp
parameter_list|(
name|struct
name|cxio_rdev
modifier|*
name|rdev_p
parameter_list|)
block|{
if|#
directive|if
literal|0
block|dma_free_coherent(&(rdev_p->rnic_info.pdev), 			  (1UL<< T3_CTRL_QP_SIZE_LOG2) 			  * sizeof(union t3_wr), rdev_p->ctrl_qp.workq,
comment|/* pci_unmap_addr(&rdev_p->ctrl_qp, mapping)*/
block|0);
else|#
directive|else
name|contigfree
argument_list|(
name|rdev_p
operator|->
name|ctrl_qp
operator|.
name|workq
argument_list|,
operator|(
literal|1UL
operator|<<
name|T3_CTRL_QP_SIZE_LOG2
operator|)
operator|*
sizeof|sizeof
argument_list|(
expr|union
name|t3_wr
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|cxio_hal_clear_qp_ctx
argument_list|(
name|rdev_p
argument_list|,
name|T3_CTRL_QP_ID
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* write len bytes of data into addr (32B aligned address)  * If data is NULL, clear len byte of memory to zero.  * caller aquires the ctrl_qp lock before the call  */
end_comment

begin_function
specifier|static
name|int
name|cxio_hal_ctrl_qp_write_mem
parameter_list|(
name|struct
name|cxio_rdev
modifier|*
name|rdev_p
parameter_list|,
name|u32
name|addr
parameter_list|,
name|u32
name|len
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|int
name|completion
parameter_list|)
block|{
name|u32
name|i
decl_stmt|,
name|nr_wqe
decl_stmt|,
name|copy_len
decl_stmt|;
name|u8
modifier|*
name|copy_data
decl_stmt|;
name|u8
name|wr_len
decl_stmt|,
name|utx_len
decl_stmt|;
comment|/* lenght in 8 byte flit */
name|enum
name|t3_wr_flags
name|flag
decl_stmt|;
name|__be64
modifier|*
name|wqe
decl_stmt|;
name|u64
name|utx_cmd
decl_stmt|;
name|addr
operator|&=
literal|0x7FFFFFF
expr_stmt|;
name|nr_wqe
operator|=
name|len
operator|%
literal|96
condition|?
name|len
operator|/
literal|96
operator|+
literal|1
else|:
name|len
operator|/
literal|96
expr_stmt|;
comment|/* 96B max per WQE */
name|CTR6
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"cxio_hal_ctrl_qp_write_mem wptr 0x%x rptr 0x%x len %d, nr_wqe %d data %p addr 0x%0x"
argument_list|,
name|rdev_p
operator|->
name|ctrl_qp
operator|.
name|wptr
argument_list|,
name|rdev_p
operator|->
name|ctrl_qp
operator|.
name|rptr
argument_list|,
name|len
argument_list|,
name|nr_wqe
argument_list|,
name|data
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|utx_len
operator|=
literal|3
expr_stmt|;
comment|/* in 32B unit */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nr_wqe
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|Q_FULL
argument_list|(
name|rdev_p
operator|->
name|ctrl_qp
operator|.
name|rptr
argument_list|,
name|rdev_p
operator|->
name|ctrl_qp
operator|.
name|wptr
argument_list|,
name|T3_CTRL_QP_SIZE_LOG2
argument_list|)
condition|)
block|{
name|CTR4
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s ctrl_qp full wtpr 0x%0x rptr 0x%0x, "
literal|"wait for more space i %d"
argument_list|,
name|__FUNCTION__
argument_list|,
name|rdev_p
operator|->
name|ctrl_qp
operator|.
name|wptr
argument_list|,
name|rdev_p
operator|->
name|ctrl_qp
operator|.
name|rptr
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|cxio_wait
argument_list|(
operator|&
name|rdev_p
operator|->
name|ctrl_qp
argument_list|,
operator|&
name|rdev_p
operator|->
name|ctrl_qp
operator|.
name|lock
argument_list|,
operator|!
name|Q_FULL
argument_list|(
name|rdev_p
operator|->
name|ctrl_qp
operator|.
name|rptr
argument_list|,
name|rdev_p
operator|->
name|ctrl_qp
operator|.
name|wptr
argument_list|,
name|T3_CTRL_QP_SIZE_LOG2
argument_list|)
argument_list|)
condition|)
block|{
name|CTR1
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s ctrl_qp workq interrupted"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
name|ERESTART
operator|)
return|;
block|}
name|CTR2
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s ctrl_qp wakeup, continue posting work request "
literal|"i %d"
argument_list|,
name|__FUNCTION__
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
name|wqe
operator|=
operator|(
name|__be64
operator|*
operator|)
operator|(
name|rdev_p
operator|->
name|ctrl_qp
operator|.
name|workq
operator|+
operator|(
name|rdev_p
operator|->
name|ctrl_qp
operator|.
name|wptr
operator|%
operator|(
literal|1
operator|<<
name|T3_CTRL_QP_SIZE_LOG2
operator|)
operator|)
operator|)
expr_stmt|;
name|flag
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|i
operator|==
operator|(
name|nr_wqe
operator|-
literal|1
operator|)
condition|)
block|{
comment|/* last WQE */
name|flag
operator|=
name|completion
condition|?
name|T3_COMPLETION_FLAG
else|:
literal|0
expr_stmt|;
if|if
condition|(
name|len
operator|%
literal|32
condition|)
name|utx_len
operator|=
name|len
operator|/
literal|32
operator|+
literal|1
expr_stmt|;
else|else
name|utx_len
operator|=
name|len
operator|/
literal|32
expr_stmt|;
block|}
comment|/* 		 * Force a CQE to return the credit to the workq in case 		 * we posted more than half the max QP size of WRs 		 */
if|if
condition|(
operator|(
name|i
operator|!=
literal|0
operator|)
operator|&&
operator|(
name|i
operator|%
operator|(
operator|(
operator|(
literal|1
operator|<<
name|T3_CTRL_QP_SIZE_LOG2
operator|)
operator|)
operator|>>
literal|1
operator|)
operator|==
literal|0
operator|)
condition|)
block|{
name|flag
operator|=
name|T3_COMPLETION_FLAG
expr_stmt|;
name|CTR2
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s force completion at i %d"
argument_list|,
name|__FUNCTION__
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
comment|/* build the utx mem command */
name|wqe
operator|+=
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|t3_bypass_wr
argument_list|)
operator|>>
literal|3
operator|)
expr_stmt|;
name|utx_cmd
operator|=
operator|(
name|T3_UTX_MEM_WRITE
operator|<<
literal|28
operator|)
operator||
operator|(
name|addr
operator|+
name|i
operator|*
literal|3
operator|)
expr_stmt|;
name|utx_cmd
operator|<<=
literal|32
expr_stmt|;
name|utx_cmd
operator||=
operator|(
name|utx_len
operator|<<
literal|28
operator|)
operator||
operator|(
operator|(
name|utx_len
operator|<<
literal|2
operator|)
operator|+
literal|1
operator|)
expr_stmt|;
operator|*
name|wqe
operator|=
name|htobe64
argument_list|(
name|utx_cmd
argument_list|)
expr_stmt|;
name|wqe
operator|++
expr_stmt|;
name|copy_data
operator|=
operator|(
name|u8
operator|*
operator|)
name|data
operator|+
name|i
operator|*
literal|96
expr_stmt|;
name|copy_len
operator|=
name|len
operator|>
literal|96
condition|?
literal|96
else|:
name|len
expr_stmt|;
comment|/* clear memory content if data is NULL */
if|if
condition|(
name|data
condition|)
name|memcpy
argument_list|(
name|wqe
argument_list|,
name|copy_data
argument_list|,
name|copy_len
argument_list|)
expr_stmt|;
else|else
name|memset
argument_list|(
name|wqe
argument_list|,
literal|0
argument_list|,
name|copy_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|copy_len
operator|%
literal|32
condition|)
name|memset
argument_list|(
operator|(
operator|(
name|u8
operator|*
operator|)
name|wqe
operator|)
operator|+
name|copy_len
argument_list|,
literal|0
argument_list|,
literal|32
operator|-
operator|(
name|copy_len
operator|%
literal|32
operator|)
argument_list|)
expr_stmt|;
name|wr_len
operator|=
operator|(
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|t3_bypass_wr
argument_list|)
operator|)
operator|>>
literal|3
operator|)
operator|+
literal|1
operator|+
operator|(
name|utx_len
operator|<<
literal|2
operator|)
expr_stmt|;
name|wqe
operator|=
operator|(
name|__be64
operator|*
operator|)
operator|(
name|rdev_p
operator|->
name|ctrl_qp
operator|.
name|workq
operator|+
operator|(
name|rdev_p
operator|->
name|ctrl_qp
operator|.
name|wptr
operator|%
operator|(
literal|1
operator|<<
name|T3_CTRL_QP_SIZE_LOG2
operator|)
operator|)
operator|)
expr_stmt|;
comment|/* wptr in the WRID[31:0] */
operator|(
operator|(
expr|union
name|t3_wrid
operator|*
operator|)
operator|(
name|wqe
operator|+
literal|1
operator|)
operator|)
operator|->
name|id0
operator|.
name|low
operator|=
name|rdev_p
operator|->
name|ctrl_qp
operator|.
name|wptr
expr_stmt|;
comment|/* 		 * This must be the last write with a memory barrier 		 * for the genbit 		 */
name|build_fw_riwrh
argument_list|(
operator|(
expr|struct
name|fw_riwrh
operator|*
operator|)
name|wqe
argument_list|,
name|T3_WR_BP
argument_list|,
name|flag
argument_list|,
name|Q_GENBIT
argument_list|(
name|rdev_p
operator|->
name|ctrl_qp
operator|.
name|wptr
argument_list|,
name|T3_CTRL_QP_SIZE_LOG2
argument_list|)
argument_list|,
name|T3_CTRL_QP_ID
argument_list|,
name|wr_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|flag
operator|==
name|T3_COMPLETION_FLAG
condition|)
name|ring_doorbell
argument_list|(
name|rdev_p
operator|->
name|ctrl_qp
operator|.
name|doorbell
argument_list|,
name|T3_CTRL_QP_ID
argument_list|)
expr_stmt|;
name|len
operator|-=
literal|96
expr_stmt|;
name|rdev_p
operator|->
name|ctrl_qp
operator|.
name|wptr
operator|++
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* IN: stag key, pdid, perm, zbva, to, len, page_size, pbl, and pbl_size  * OUT: stag index, actual pbl_size, pbl_addr allocated.  * TBD: shared memory region support  */
end_comment

begin_function
specifier|static
name|int
name|__cxio_tpt_op
parameter_list|(
name|struct
name|cxio_rdev
modifier|*
name|rdev_p
parameter_list|,
name|u32
name|reset_tpt_entry
parameter_list|,
name|u32
modifier|*
name|stag
parameter_list|,
name|u8
name|stag_state
parameter_list|,
name|u32
name|pdid
parameter_list|,
name|enum
name|tpt_mem_type
name|type
parameter_list|,
name|enum
name|tpt_mem_perm
name|perm
parameter_list|,
name|u32
name|zbva
parameter_list|,
name|u64
name|to
parameter_list|,
name|u32
name|len
parameter_list|,
name|u8
name|page_size
parameter_list|,
name|__be64
modifier|*
name|pbl
parameter_list|,
name|u32
modifier|*
name|pbl_size
parameter_list|,
name|u32
modifier|*
name|pbl_addr
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|struct
name|tpt_entry
name|tpt
decl_stmt|;
name|u32
name|stag_idx
decl_stmt|;
name|u32
name|wptr
decl_stmt|;
name|int
name|rereg
init|=
operator|(
operator|*
name|stag
operator|!=
name|T3_STAG_UNSET
operator|)
decl_stmt|;
name|stag_state
operator|=
name|stag_state
operator|>
literal|0
expr_stmt|;
name|stag_idx
operator|=
operator|(
operator|*
name|stag
operator|)
operator|>>
literal|8
expr_stmt|;
if|if
condition|(
operator|(
operator|!
name|reset_tpt_entry
operator|)
operator|&&
operator|!
operator|(
operator|*
name|stag
operator|!=
name|T3_STAG_UNSET
operator|)
condition|)
block|{
name|stag_idx
operator|=
name|cxio_hal_get_stag
argument_list|(
name|rdev_p
operator|->
name|rscp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|stag_idx
condition|)
return|return
operator|(
operator|-
name|ENOMEM
operator|)
return|;
operator|*
name|stag
operator|=
operator|(
name|stag_idx
operator|<<
literal|8
operator|)
operator||
operator|(
operator|(
operator|*
name|stag
operator|)
operator|&
literal|0xFF
operator|)
expr_stmt|;
block|}
name|CTR5
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s stag_state 0x%0x type 0x%0x pdid 0x%0x, stag_idx 0x%x"
argument_list|,
name|__FUNCTION__
argument_list|,
name|stag_state
argument_list|,
name|type
argument_list|,
name|pdid
argument_list|,
name|stag_idx
argument_list|)
expr_stmt|;
if|if
condition|(
name|reset_tpt_entry
condition|)
name|cxio_hal_pblpool_free
argument_list|(
name|rdev_p
argument_list|,
operator|*
name|pbl_addr
argument_list|,
operator|*
name|pbl_size
operator|<<
literal|3
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|rereg
condition|)
block|{
operator|*
name|pbl_addr
operator|=
name|cxio_hal_pblpool_alloc
argument_list|(
name|rdev_p
argument_list|,
operator|*
name|pbl_size
operator|<<
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|pbl_addr
condition|)
block|{
return|return
operator|(
operator|-
name|ENOMEM
operator|)
return|;
block|}
block|}
name|mtx_lock
argument_list|(
operator|&
name|rdev_p
operator|->
name|ctrl_qp
operator|.
name|lock
argument_list|)
expr_stmt|;
comment|/* write PBL first if any - update pbl only if pbl list exist */
if|if
condition|(
name|pbl
condition|)
block|{
name|CTR4
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s *pdb_addr 0x%x, pbl_base 0x%x, pbl_size %d"
argument_list|,
name|__FUNCTION__
argument_list|,
operator|*
name|pbl_addr
argument_list|,
name|rdev_p
operator|->
name|rnic_info
operator|.
name|pbl_base
argument_list|,
operator|*
name|pbl_size
argument_list|)
expr_stmt|;
name|err
operator|=
name|cxio_hal_ctrl_qp_write_mem
argument_list|(
name|rdev_p
argument_list|,
operator|(
operator|*
name|pbl_addr
operator|>>
literal|5
operator|)
argument_list|,
operator|(
operator|*
name|pbl_size
operator|<<
literal|3
operator|)
argument_list|,
name|pbl
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|ret
goto|;
block|}
comment|/* write TPT entry */
if|if
condition|(
name|reset_tpt_entry
condition|)
name|memset
argument_list|(
operator|&
name|tpt
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|tpt
argument_list|)
argument_list|)
expr_stmt|;
else|else
block|{
name|tpt
operator|.
name|valid_stag_pdid
operator|=
name|htobe32
argument_list|(
name|F_TPT_VALID
operator||
name|V_TPT_STAG_KEY
argument_list|(
operator|(
operator|*
name|stag
operator|)
operator|&
name|M_TPT_STAG_KEY
argument_list|)
operator||
name|V_TPT_STAG_STATE
argument_list|(
name|stag_state
argument_list|)
operator||
name|V_TPT_STAG_TYPE
argument_list|(
name|type
argument_list|)
operator||
name|V_TPT_PDID
argument_list|(
name|pdid
argument_list|)
argument_list|)
expr_stmt|;
name|PANIC_IF
argument_list|(
name|page_size
operator|>=
literal|28
argument_list|)
expr_stmt|;
name|tpt
operator|.
name|flags_pagesize_qpid
operator|=
name|htobe32
argument_list|(
name|V_TPT_PERM
argument_list|(
name|perm
argument_list|)
operator||
name|F_TPT_MW_BIND_ENABLE
operator||
name|V_TPT_ADDR_TYPE
argument_list|(
operator|(
name|zbva
condition|?
name|TPT_ZBTO
else|:
name|TPT_VATO
operator|)
argument_list|)
operator||
name|V_TPT_PAGE_SIZE
argument_list|(
name|page_size
argument_list|)
argument_list|)
expr_stmt|;
name|tpt
operator|.
name|rsvd_pbl_addr
operator|=
name|reset_tpt_entry
condition|?
literal|0
else|:
name|htobe32
argument_list|(
name|V_TPT_PBL_ADDR
argument_list|(
name|PBL_OFF
argument_list|(
name|rdev_p
argument_list|,
operator|*
name|pbl_addr
argument_list|)
operator|>>
literal|3
argument_list|)
argument_list|)
expr_stmt|;
name|tpt
operator|.
name|len
operator|=
name|htobe32
argument_list|(
name|len
argument_list|)
expr_stmt|;
name|tpt
operator|.
name|va_hi
operator|=
name|htobe32
argument_list|(
call|(
name|u32
call|)
argument_list|(
name|to
operator|>>
literal|32
argument_list|)
argument_list|)
expr_stmt|;
name|tpt
operator|.
name|va_low_or_fbo
operator|=
name|htobe32
argument_list|(
call|(
name|u32
call|)
argument_list|(
name|to
operator|&
literal|0xFFFFFFFFULL
argument_list|)
argument_list|)
expr_stmt|;
name|tpt
operator|.
name|rsvd_bind_cnt_or_pstag
operator|=
literal|0
expr_stmt|;
name|tpt
operator|.
name|rsvd_pbl_size
operator|=
name|reset_tpt_entry
condition|?
literal|0
else|:
name|htobe32
argument_list|(
name|V_TPT_PBL_SIZE
argument_list|(
operator|(
operator|*
name|pbl_size
operator|)
operator|>>
literal|2
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|err
operator|=
name|cxio_hal_ctrl_qp_write_mem
argument_list|(
name|rdev_p
argument_list|,
name|stag_idx
operator|+
operator|(
name|rdev_p
operator|->
name|rnic_info
operator|.
name|tpt_base
operator|>>
literal|5
operator|)
argument_list|,
sizeof|sizeof
argument_list|(
name|tpt
argument_list|)
argument_list|,
operator|&
name|tpt
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* release the stag index to free pool */
if|if
condition|(
name|reset_tpt_entry
condition|)
name|cxio_hal_put_stag
argument_list|(
name|rdev_p
operator|->
name|rscp
argument_list|,
name|stag_idx
argument_list|)
expr_stmt|;
name|ret
label|:
name|wptr
operator|=
name|rdev_p
operator|->
name|ctrl_qp
operator|.
name|wptr
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|rdev_p
operator|->
name|ctrl_qp
operator|.
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|err
condition|)
if|if
condition|(
name|cxio_wait
argument_list|(
operator|&
name|rdev_p
operator|->
name|ctrl_qp
argument_list|,
operator|&
name|rdev_p
operator|->
name|ctrl_qp
operator|.
name|lock
argument_list|,
name|SEQ32_GE
argument_list|(
name|rdev_p
operator|->
name|ctrl_qp
operator|.
name|rptr
argument_list|,
name|wptr
argument_list|)
argument_list|)
condition|)
return|return
operator|(
operator|-
name|ERESTART
operator|)
return|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|int
name|cxio_register_phys_mem
parameter_list|(
name|struct
name|cxio_rdev
modifier|*
name|rdev_p
parameter_list|,
name|u32
modifier|*
name|stag
parameter_list|,
name|u32
name|pdid
parameter_list|,
name|enum
name|tpt_mem_perm
name|perm
parameter_list|,
name|u32
name|zbva
parameter_list|,
name|u64
name|to
parameter_list|,
name|u32
name|len
parameter_list|,
name|u8
name|page_size
parameter_list|,
name|__be64
modifier|*
name|pbl
parameter_list|,
name|u32
modifier|*
name|pbl_size
parameter_list|,
name|u32
modifier|*
name|pbl_addr
parameter_list|)
block|{
operator|*
name|stag
operator|=
name|T3_STAG_UNSET
expr_stmt|;
return|return
name|__cxio_tpt_op
argument_list|(
name|rdev_p
argument_list|,
literal|0
argument_list|,
name|stag
argument_list|,
literal|1
argument_list|,
name|pdid
argument_list|,
name|TPT_NON_SHARED_MR
argument_list|,
name|perm
argument_list|,
name|zbva
argument_list|,
name|to
argument_list|,
name|len
argument_list|,
name|page_size
argument_list|,
name|pbl
argument_list|,
name|pbl_size
argument_list|,
name|pbl_addr
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|cxio_reregister_phys_mem
parameter_list|(
name|struct
name|cxio_rdev
modifier|*
name|rdev_p
parameter_list|,
name|u32
modifier|*
name|stag
parameter_list|,
name|u32
name|pdid
parameter_list|,
name|enum
name|tpt_mem_perm
name|perm
parameter_list|,
name|u32
name|zbva
parameter_list|,
name|u64
name|to
parameter_list|,
name|u32
name|len
parameter_list|,
name|u8
name|page_size
parameter_list|,
name|__be64
modifier|*
name|pbl
parameter_list|,
name|u32
modifier|*
name|pbl_size
parameter_list|,
name|u32
modifier|*
name|pbl_addr
parameter_list|)
block|{
return|return
name|__cxio_tpt_op
argument_list|(
name|rdev_p
argument_list|,
literal|0
argument_list|,
name|stag
argument_list|,
literal|1
argument_list|,
name|pdid
argument_list|,
name|TPT_NON_SHARED_MR
argument_list|,
name|perm
argument_list|,
name|zbva
argument_list|,
name|to
argument_list|,
name|len
argument_list|,
name|page_size
argument_list|,
name|pbl
argument_list|,
name|pbl_size
argument_list|,
name|pbl_addr
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|cxio_dereg_mem
parameter_list|(
name|struct
name|cxio_rdev
modifier|*
name|rdev_p
parameter_list|,
name|u32
name|stag
parameter_list|,
name|u32
name|pbl_size
parameter_list|,
name|u32
name|pbl_addr
parameter_list|)
block|{
return|return
name|__cxio_tpt_op
argument_list|(
name|rdev_p
argument_list|,
literal|1
argument_list|,
operator|&
name|stag
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0ULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
operator|&
name|pbl_size
argument_list|,
operator|&
name|pbl_addr
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|cxio_allocate_window
parameter_list|(
name|struct
name|cxio_rdev
modifier|*
name|rdev_p
parameter_list|,
name|u32
modifier|*
name|stag
parameter_list|,
name|u32
name|pdid
parameter_list|)
block|{
name|u32
name|pbl_size
init|=
literal|0
decl_stmt|;
operator|*
name|stag
operator|=
name|T3_STAG_UNSET
expr_stmt|;
return|return
name|__cxio_tpt_op
argument_list|(
name|rdev_p
argument_list|,
literal|0
argument_list|,
name|stag
argument_list|,
literal|0
argument_list|,
name|pdid
argument_list|,
name|TPT_MW
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0ULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
operator|&
name|pbl_size
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|cxio_deallocate_window
parameter_list|(
name|struct
name|cxio_rdev
modifier|*
name|rdev_p
parameter_list|,
name|u32
name|stag
parameter_list|)
block|{
return|return
name|__cxio_tpt_op
argument_list|(
name|rdev_p
argument_list|,
literal|1
argument_list|,
operator|&
name|stag
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0ULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|cxio_rdma_init
parameter_list|(
name|struct
name|cxio_rdev
modifier|*
name|rdev_p
parameter_list|,
name|struct
name|t3_rdma_init_attr
modifier|*
name|attr
parameter_list|)
block|{
name|struct
name|t3_rdma_init_wr
modifier|*
name|wqe
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
init|=
name|m_gethdr
argument_list|(
name|MT_DATA
argument_list|,
name|M_NOWAIT
argument_list|)
decl_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
return|return
operator|(
operator|-
name|ENOMEM
operator|)
return|;
name|CTR2
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s rdev_p %p"
argument_list|,
name|__FUNCTION__
argument_list|,
name|rdev_p
argument_list|)
expr_stmt|;
name|wqe
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|t3_rdma_init_wr
operator|*
argument_list|)
expr_stmt|;
name|m
operator|->
name|m_len
operator|=
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|wqe
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|wrh
operator|.
name|op_seop_flags
operator|=
name|htobe32
argument_list|(
name|V_FW_RIWR_OP
argument_list|(
name|T3_WR_INIT
argument_list|)
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|wrh
operator|.
name|gen_tid_len
operator|=
name|htobe32
argument_list|(
name|V_FW_RIWR_TID
argument_list|(
name|attr
operator|->
name|tid
argument_list|)
operator||
name|V_FW_RIWR_LEN
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|wqe
argument_list|)
operator|>>
literal|3
argument_list|)
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|wrid
operator|.
name|id1
operator|=
literal|0
expr_stmt|;
name|wqe
operator|->
name|qpid
operator|=
name|htobe32
argument_list|(
name|attr
operator|->
name|qpid
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|pdid
operator|=
name|htobe32
argument_list|(
name|attr
operator|->
name|pdid
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|scqid
operator|=
name|htobe32
argument_list|(
name|attr
operator|->
name|scqid
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|rcqid
operator|=
name|htobe32
argument_list|(
name|attr
operator|->
name|rcqid
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|rq_addr
operator|=
name|htobe32
argument_list|(
name|attr
operator|->
name|rq_addr
operator|-
name|rdev_p
operator|->
name|rnic_info
operator|.
name|rqt_base
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|rq_size
operator|=
name|htobe32
argument_list|(
name|attr
operator|->
name|rq_size
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|mpaattrs
operator|=
name|attr
operator|->
name|mpaattrs
expr_stmt|;
name|wqe
operator|->
name|qpcaps
operator|=
name|attr
operator|->
name|qpcaps
expr_stmt|;
name|wqe
operator|->
name|ulpdu_size
operator|=
name|htobe16
argument_list|(
name|attr
operator|->
name|tcp_emss
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|flags
operator|=
name|htobe32
argument_list|(
name|attr
operator|->
name|flags
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|ord
operator|=
name|htobe32
argument_list|(
name|attr
operator|->
name|ord
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|ird
operator|=
name|htobe32
argument_list|(
name|attr
operator|->
name|ird
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|qp_dma_addr
operator|=
name|htobe64
argument_list|(
name|attr
operator|->
name|qp_dma_addr
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|qp_dma_size
operator|=
name|htobe32
argument_list|(
name|attr
operator|->
name|qp_dma_size
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|irs
operator|=
name|htobe32
argument_list|(
name|attr
operator|->
name|irs
argument_list|)
expr_stmt|;
name|m_set_priority
argument_list|(
name|m
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* 0=>ToeQ; 1=>CtrlQ */
name|m_set_sgl
argument_list|(
name|m
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|m_set_sgllen
argument_list|(
name|m
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|cxgb_ofld_send
argument_list|(
name|rdev_p
operator|->
name|t3cdev_p
argument_list|,
name|m
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|void
name|cxio_register_ev_cb
parameter_list|(
name|cxio_hal_ev_callback_func_t
name|ev_cb
parameter_list|)
block|{
name|cxio_ev_cb
operator|=
name|ev_cb
expr_stmt|;
block|}
end_function

begin_function
name|void
name|cxio_unregister_ev_cb
parameter_list|(
name|cxio_hal_ev_callback_func_t
name|ev_cb
parameter_list|)
block|{
name|cxio_ev_cb
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|cxio_hal_ev_handler
parameter_list|(
name|struct
name|t3cdev
modifier|*
name|t3cdev_p
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|)
block|{
specifier|static
name|int
name|cnt
decl_stmt|;
name|struct
name|cxio_rdev
modifier|*
name|rdev_p
init|=
name|NULL
decl_stmt|;
name|struct
name|respQ_msg_t
modifier|*
name|rsp_msg
init|=
operator|(
expr|struct
name|respQ_msg_t
operator|*
operator|)
name|m
operator|->
name|m_data
decl_stmt|;
name|CTR6
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s cq_id 0x%x cq_ptr 0x%x genbit %0x overflow %0x an %0x"
argument_list|,
name|__FUNCTION__
argument_list|,
name|RSPQ_CQID
argument_list|(
name|rsp_msg
argument_list|)
argument_list|,
name|RSPQ_CQPTR
argument_list|(
name|rsp_msg
argument_list|)
argument_list|,
name|RSPQ_GENBIT
argument_list|(
name|rsp_msg
argument_list|)
argument_list|,
name|RSPQ_OVERFLOW
argument_list|(
name|rsp_msg
argument_list|)
argument_list|,
name|RSPQ_AN
argument_list|(
name|rsp_msg
argument_list|)
argument_list|)
expr_stmt|;
name|CTR4
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"se %0x notify %0x cqbranch %0x creditth %0x"
argument_list|,
name|RSPQ_SE
argument_list|(
name|rsp_msg
argument_list|)
argument_list|,
name|RSPQ_NOTIFY
argument_list|(
name|rsp_msg
argument_list|)
argument_list|,
name|RSPQ_CQBRANCH
argument_list|(
name|rsp_msg
argument_list|)
argument_list|,
name|RSPQ_CREDIT_THRESH
argument_list|(
name|rsp_msg
argument_list|)
argument_list|)
expr_stmt|;
name|CTR4
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"CQE: QPID 0x%0x type 0x%0x status 0x%0x opcode %d"
argument_list|,
name|CQE_QPID
argument_list|(
name|rsp_msg
operator|->
name|cqe
argument_list|)
argument_list|,
name|CQE_TYPE
argument_list|(
name|rsp_msg
operator|->
name|cqe
argument_list|)
argument_list|,
name|CQE_STATUS
argument_list|(
name|rsp_msg
operator|->
name|cqe
argument_list|)
argument_list|,
name|CQE_OPCODE
argument_list|(
name|rsp_msg
operator|->
name|cqe
argument_list|)
argument_list|)
expr_stmt|;
name|CTR3
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"len 0x%0x wrid_hi_stag 0x%x wrid_low_msn 0x%x"
argument_list|,
name|CQE_LEN
argument_list|(
name|rsp_msg
operator|->
name|cqe
argument_list|)
argument_list|,
name|CQE_WRID_HI
argument_list|(
name|rsp_msg
operator|->
name|cqe
argument_list|)
argument_list|,
name|CQE_WRID_LOW
argument_list|(
name|rsp_msg
operator|->
name|cqe
argument_list|)
argument_list|)
expr_stmt|;
name|rdev_p
operator|=
operator|(
expr|struct
name|cxio_rdev
operator|*
operator|)
name|t3cdev_p
operator|->
name|ulp
expr_stmt|;
if|if
condition|(
operator|!
name|rdev_p
condition|)
block|{
name|CTR2
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s called by t3cdev %p with null ulp"
argument_list|,
name|__FUNCTION__
argument_list|,
name|t3cdev_p
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|CQE_QPID
argument_list|(
name|rsp_msg
operator|->
name|cqe
argument_list|)
operator|==
name|T3_CTRL_QP_ID
condition|)
block|{
name|mtx_lock
argument_list|(
operator|&
name|rdev_p
operator|->
name|ctrl_qp
operator|.
name|lock
argument_list|)
expr_stmt|;
name|rdev_p
operator|->
name|ctrl_qp
operator|.
name|rptr
operator|=
name|CQE_WRID_LOW
argument_list|(
name|rsp_msg
operator|->
name|cqe
argument_list|)
operator|+
literal|1
expr_stmt|;
name|wakeup
argument_list|(
operator|&
name|rdev_p
operator|->
name|ctrl_qp
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|rdev_p
operator|->
name|ctrl_qp
operator|.
name|lock
argument_list|)
expr_stmt|;
name|m_free
argument_list|(
name|m
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|CQE_QPID
argument_list|(
name|rsp_msg
operator|->
name|cqe
argument_list|)
operator|==
literal|0xfff8
condition|)
name|m_free
argument_list|(
name|m
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|cxio_ev_cb
condition|)
call|(
modifier|*
name|cxio_ev_cb
call|)
argument_list|(
name|rdev_p
argument_list|,
name|m
argument_list|)
expr_stmt|;
else|else
name|m_free
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|cnt
operator|++
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Caller takes care of locking if needed */
end_comment

begin_function
name|int
name|cxio_rdev_open
parameter_list|(
name|struct
name|cxio_rdev
modifier|*
name|rdev_p
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|int
name|err
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|rdev_p
operator|->
name|dev_name
argument_list|)
condition|)
block|{
if|if
condition|(
name|cxio_hal_find_rdev_by_name
argument_list|(
name|rdev_p
operator|->
name|dev_name
argument_list|)
condition|)
block|{
return|return
operator|(
operator|-
name|EBUSY
operator|)
return|;
block|}
name|ifp
operator|=
name|rdev_p
operator|->
name|ifp
expr_stmt|;
if|if
condition|(
name|ifp
operator|==
name|NULL
condition|)
return|return
operator|(
operator|-
name|EINVAL
operator|)
return|;
name|if_free
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rdev_p
operator|->
name|t3cdev_p
condition|)
block|{
if|if
condition|(
name|cxio_hal_find_rdev_by_t3cdev
argument_list|(
name|rdev_p
operator|->
name|t3cdev_p
argument_list|)
condition|)
return|return
operator|(
operator|-
name|EBUSY
operator|)
return|;
name|ifp
operator|=
name|rdev_p
operator|->
name|t3cdev_p
operator|->
name|lldev
expr_stmt|;
name|strncpy
argument_list|(
name|rdev_p
operator|->
name|dev_name
argument_list|,
name|rdev_p
operator|->
name|t3cdev_p
operator|->
name|name
argument_list|,
name|T3_MAX_DEV_NAME_LEN
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|CTR1
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s t3cdev_p or dev_name must be set"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
name|EINVAL
operator|)
return|;
block|}
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|rdev_list
argument_list|,
name|rdev_p
argument_list|,
name|entry
argument_list|)
expr_stmt|;
name|CTR2
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s opening rnic dev %s"
argument_list|,
name|__FUNCTION__
argument_list|,
name|rdev_p
operator|->
name|dev_name
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|rdev_p
operator|->
name|ctrl_qp
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|rdev_p
operator|->
name|ctrl_qp
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rdev_p
operator|->
name|t3cdev_p
condition|)
name|rdev_p
operator|->
name|t3cdev_p
operator|=
name|T3CDEV
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|rdev_p
operator|->
name|t3cdev_p
operator|->
name|ulp
operator|=
operator|(
name|void
operator|*
operator|)
name|rdev_p
expr_stmt|;
name|err
operator|=
name|rdev_p
operator|->
name|t3cdev_p
operator|->
name|ctl
argument_list|(
name|rdev_p
operator|->
name|t3cdev_p
argument_list|,
name|RDMA_GET_PARAMS
argument_list|,
operator|&
operator|(
name|rdev_p
operator|->
name|rnic_info
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"%s t3cdev_p(%p)->ctl returned error %d.\n"
argument_list|,
name|__FUNCTION__
argument_list|,
name|rdev_p
operator|->
name|t3cdev_p
argument_list|,
name|err
argument_list|)
expr_stmt|;
goto|goto
name|err1
goto|;
block|}
name|err
operator|=
name|rdev_p
operator|->
name|t3cdev_p
operator|->
name|ctl
argument_list|(
name|rdev_p
operator|->
name|t3cdev_p
argument_list|,
name|GET_PORTS
argument_list|,
operator|&
operator|(
name|rdev_p
operator|->
name|port_info
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"%s t3cdev_p(%p)->ctl returned error %d.\n"
argument_list|,
name|__FUNCTION__
argument_list|,
name|rdev_p
operator|->
name|t3cdev_p
argument_list|,
name|err
argument_list|)
expr_stmt|;
goto|goto
name|err1
goto|;
block|}
comment|/* 	 * qpshift is the number of bits to shift the qpid left in order 	 * to get the correct address of the doorbell for that qp. 	 */
name|cxio_init_ucontext
argument_list|(
name|rdev_p
argument_list|,
operator|&
name|rdev_p
operator|->
name|uctx
argument_list|)
expr_stmt|;
name|rdev_p
operator|->
name|qpshift
operator|=
name|PAGE_SHIFT
operator|-
name|ilog2
argument_list|(
literal|65536
operator|>>
name|ilog2
argument_list|(
name|rdev_p
operator|->
name|rnic_info
operator|.
name|udbell_len
operator|>>
name|PAGE_SHIFT
argument_list|)
argument_list|)
expr_stmt|;
name|rdev_p
operator|->
name|qpnr
operator|=
name|rdev_p
operator|->
name|rnic_info
operator|.
name|udbell_len
operator|>>
name|PAGE_SHIFT
expr_stmt|;
name|rdev_p
operator|->
name|qpmask
operator|=
operator|(
literal|65536
operator|>>
name|ilog2
argument_list|(
name|rdev_p
operator|->
name|qpnr
argument_list|)
operator|)
operator|-
literal|1
expr_stmt|;
name|CTR4
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"cxio_rdev_open rnic %s info: tpt_base 0x%0x tpt_top 0x%0x num stags %d"
argument_list|,
name|rdev_p
operator|->
name|dev_name
argument_list|,
name|rdev_p
operator|->
name|rnic_info
operator|.
name|tpt_base
argument_list|,
name|rdev_p
operator|->
name|rnic_info
operator|.
name|tpt_top
argument_list|,
name|cxio_num_stags
argument_list|(
name|rdev_p
argument_list|)
argument_list|)
expr_stmt|;
name|CTR4
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"pbl_base 0x%0x pbl_top 0x%0x rqt_base 0x%0x, rqt_top 0x%0x"
argument_list|,
name|rdev_p
operator|->
name|rnic_info
operator|.
name|pbl_base
argument_list|,
name|rdev_p
operator|->
name|rnic_info
operator|.
name|pbl_top
argument_list|,
name|rdev_p
operator|->
name|rnic_info
operator|.
name|rqt_base
argument_list|,
name|rdev_p
operator|->
name|rnic_info
operator|.
name|rqt_top
argument_list|)
expr_stmt|;
name|CTR6
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"udbell_len 0x%0x udbell_physbase 0x%lx kdb_addr %p qpshift %lu "
literal|"qpnr %d qpmask 0x%x"
argument_list|,
name|rdev_p
operator|->
name|rnic_info
operator|.
name|udbell_len
argument_list|,
name|rdev_p
operator|->
name|rnic_info
operator|.
name|udbell_physbase
argument_list|,
name|rdev_p
operator|->
name|rnic_info
operator|.
name|kdb_addr
argument_list|,
name|rdev_p
operator|->
name|qpshift
argument_list|,
name|rdev_p
operator|->
name|qpnr
argument_list|,
name|rdev_p
operator|->
name|qpmask
argument_list|)
expr_stmt|;
name|err
operator|=
name|cxio_hal_init_ctrl_qp
argument_list|(
name|rdev_p
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"%s error %d initializing ctrl_qp.\n"
argument_list|,
name|__FUNCTION__
argument_list|,
name|err
argument_list|)
expr_stmt|;
goto|goto
name|err1
goto|;
block|}
name|err
operator|=
name|cxio_hal_init_resource
argument_list|(
name|rdev_p
argument_list|,
name|cxio_num_stags
argument_list|(
name|rdev_p
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|T3_MAX_NUM_QP
argument_list|,
name|T3_MAX_NUM_CQ
argument_list|,
name|T3_MAX_NUM_PD
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"%s error %d initializing hal resources.\n"
argument_list|,
name|__FUNCTION__
argument_list|,
name|err
argument_list|)
expr_stmt|;
goto|goto
name|err2
goto|;
block|}
name|err
operator|=
name|cxio_hal_pblpool_create
argument_list|(
name|rdev_p
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"%s error %d initializing pbl mem pool.\n"
argument_list|,
name|__FUNCTION__
argument_list|,
name|err
argument_list|)
expr_stmt|;
goto|goto
name|err3
goto|;
block|}
name|err
operator|=
name|cxio_hal_rqtpool_create
argument_list|(
name|rdev_p
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"%s error %d initializing rqt mem pool.\n"
argument_list|,
name|__FUNCTION__
argument_list|,
name|err
argument_list|)
expr_stmt|;
goto|goto
name|err4
goto|;
block|}
return|return
literal|0
return|;
name|err4
label|:
name|cxio_hal_pblpool_destroy
argument_list|(
name|rdev_p
argument_list|)
expr_stmt|;
name|err3
label|:
name|cxio_hal_destroy_resource
argument_list|(
name|rdev_p
operator|->
name|rscp
argument_list|)
expr_stmt|;
name|err2
label|:
name|cxio_hal_destroy_ctrl_qp
argument_list|(
name|rdev_p
argument_list|)
expr_stmt|;
name|err1
label|:
name|TAILQ_REMOVE
argument_list|(
operator|&
name|rdev_list
argument_list|,
name|rdev_p
argument_list|,
name|entry
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|void
name|cxio_rdev_close
parameter_list|(
name|struct
name|cxio_rdev
modifier|*
name|rdev_p
parameter_list|)
block|{
if|if
condition|(
name|rdev_p
condition|)
block|{
name|cxio_hal_pblpool_destroy
argument_list|(
name|rdev_p
argument_list|)
expr_stmt|;
name|cxio_hal_rqtpool_destroy
argument_list|(
name|rdev_p
argument_list|)
expr_stmt|;
name|TAILQ_REMOVE
argument_list|(
operator|&
name|rdev_list
argument_list|,
name|rdev_p
argument_list|,
name|entry
argument_list|)
expr_stmt|;
name|rdev_p
operator|->
name|t3cdev_p
operator|->
name|ulp
operator|=
name|NULL
expr_stmt|;
name|cxio_hal_destroy_ctrl_qp
argument_list|(
name|rdev_p
argument_list|)
expr_stmt|;
name|cxio_hal_destroy_resource
argument_list|(
name|rdev_p
operator|->
name|rscp
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|cxio_hal_init
parameter_list|(
name|void
parameter_list|)
block|{
name|TAILQ_INIT
argument_list|(
operator|&
name|rdev_list
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|needed
if|if
condition|(
name|cxio_hal_init_rhdl_resource
argument_list|(
name|T3_MAX_NUM_RI
argument_list|)
condition|)
return|return
operator|(
operator|-
name|ENOMEM
operator|)
return|;
endif|#
directive|endif
name|t3_register_cpl_handler
argument_list|(
name|CPL_ASYNC_NOTIF
argument_list|,
name|cxio_hal_ev_handler
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|cxio_hal_exit
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|cxio_rdev
modifier|*
name|rdev
decl_stmt|,
modifier|*
name|tmp
decl_stmt|;
name|t3_register_cpl_handler
argument_list|(
name|CPL_ASYNC_NOTIF
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TAILQ_FOREACH_SAFE
argument_list|(
argument|rdev
argument_list|,
argument|&rdev_list
argument_list|,
argument|entry
argument_list|,
argument|tmp
argument_list|)
name|cxio_rdev_close
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|needed
name|cxio_hal_destroy_rhdl_resource
argument_list|()
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|void
name|flush_completed_wrs
parameter_list|(
name|struct
name|t3_wq
modifier|*
name|wq
parameter_list|,
name|struct
name|t3_cq
modifier|*
name|cq
parameter_list|)
block|{
name|struct
name|t3_swsq
modifier|*
name|sqp
decl_stmt|;
name|__u32
name|ptr
init|=
name|wq
operator|->
name|sq_rptr
decl_stmt|;
name|int
name|count
init|=
name|Q_COUNT
argument_list|(
name|wq
operator|->
name|sq_rptr
argument_list|,
name|wq
operator|->
name|sq_wptr
argument_list|)
decl_stmt|;
name|sqp
operator|=
name|wq
operator|->
name|sq
operator|+
name|Q_PTR2IDX
argument_list|(
name|ptr
argument_list|,
name|wq
operator|->
name|sq_size_log2
argument_list|)
expr_stmt|;
while|while
condition|(
name|count
operator|--
condition|)
if|if
condition|(
operator|!
name|sqp
operator|->
name|signaled
condition|)
block|{
name|ptr
operator|++
expr_stmt|;
name|sqp
operator|=
name|wq
operator|->
name|sq
operator|+
name|Q_PTR2IDX
argument_list|(
name|ptr
argument_list|,
name|wq
operator|->
name|sq_size_log2
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sqp
operator|->
name|complete
condition|)
block|{
comment|/* 			 * Insert this completed cqe into the swcq. 			 */
name|CTR3
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s moving cqe into swcq sq idx %ld cq idx %ld"
argument_list|,
name|__FUNCTION__
argument_list|,
name|Q_PTR2IDX
argument_list|(
name|ptr
argument_list|,
name|wq
operator|->
name|sq_size_log2
argument_list|)
argument_list|,
name|Q_PTR2IDX
argument_list|(
name|cq
operator|->
name|sw_wptr
argument_list|,
name|cq
operator|->
name|size_log2
argument_list|)
argument_list|)
expr_stmt|;
name|sqp
operator|->
name|cqe
operator|.
name|header
operator||=
name|htonl
argument_list|(
name|V_CQE_SWCQE
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
operator|*
operator|(
name|cq
operator|->
name|sw_queue
operator|+
name|Q_PTR2IDX
argument_list|(
name|cq
operator|->
name|sw_wptr
argument_list|,
name|cq
operator|->
name|size_log2
argument_list|)
operator|)
operator|=
name|sqp
operator|->
name|cqe
expr_stmt|;
name|cq
operator|->
name|sw_wptr
operator|++
expr_stmt|;
name|sqp
operator|->
name|signaled
operator|=
literal|0
expr_stmt|;
break|break;
block|}
else|else
break|break;
block|}
end_function

begin_function
specifier|static
name|void
name|create_read_req_cqe
parameter_list|(
name|struct
name|t3_wq
modifier|*
name|wq
parameter_list|,
name|struct
name|t3_cqe
modifier|*
name|hw_cqe
parameter_list|,
name|struct
name|t3_cqe
modifier|*
name|read_cqe
parameter_list|)
block|{
name|read_cqe
operator|->
name|u
operator|.
name|scqe
operator|.
name|wrid_hi
operator|=
name|wq
operator|->
name|oldest_read
operator|->
name|sq_wptr
expr_stmt|;
name|read_cqe
operator|->
name|len
operator|=
name|wq
operator|->
name|oldest_read
operator|->
name|read_len
expr_stmt|;
name|read_cqe
operator|->
name|header
operator|=
name|htonl
argument_list|(
name|V_CQE_QPID
argument_list|(
name|CQE_QPID
argument_list|(
operator|*
name|hw_cqe
argument_list|)
argument_list|)
operator||
name|V_CQE_SWCQE
argument_list|(
name|SW_CQE
argument_list|(
operator|*
name|hw_cqe
argument_list|)
argument_list|)
operator||
name|V_CQE_OPCODE
argument_list|(
name|T3_READ_REQ
argument_list|)
operator||
name|V_CQE_TYPE
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Return a ptr to the next read wr in the SWSQ or NULL.  */
end_comment

begin_function
specifier|static
name|void
name|advance_oldest_read
parameter_list|(
name|struct
name|t3_wq
modifier|*
name|wq
parameter_list|)
block|{
name|u32
name|rptr
init|=
name|wq
operator|->
name|oldest_read
operator|-
name|wq
operator|->
name|sq
operator|+
literal|1
decl_stmt|;
name|u32
name|wptr
init|=
name|Q_PTR2IDX
argument_list|(
name|wq
operator|->
name|sq_wptr
argument_list|,
name|wq
operator|->
name|sq_size_log2
argument_list|)
decl_stmt|;
while|while
condition|(
name|Q_PTR2IDX
argument_list|(
name|rptr
argument_list|,
name|wq
operator|->
name|sq_size_log2
argument_list|)
operator|!=
name|wptr
condition|)
block|{
name|wq
operator|->
name|oldest_read
operator|=
name|wq
operator|->
name|sq
operator|+
name|Q_PTR2IDX
argument_list|(
name|rptr
argument_list|,
name|wq
operator|->
name|sq_size_log2
argument_list|)
expr_stmt|;
if|if
condition|(
name|wq
operator|->
name|oldest_read
operator|->
name|opcode
operator|==
name|T3_READ_REQ
condition|)
return|return;
name|rptr
operator|++
expr_stmt|;
block|}
name|wq
operator|->
name|oldest_read
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * cxio_poll_cq  *  * Caller must:  *     check the validity of the first CQE,  *     supply the wq assicated with the qpid.  *  * credit: cq credit to return to sge.  * cqe_flushed: 1 iff the CQE is flushed.  * cqe: copy of the polled CQE.  *  * return value:  *     0       CQE returned,  *    -1       CQE skipped, try again.  */
end_comment

begin_function
name|int
name|cxio_poll_cq
parameter_list|(
name|struct
name|t3_wq
modifier|*
name|wq
parameter_list|,
name|struct
name|t3_cq
modifier|*
name|cq
parameter_list|,
name|struct
name|t3_cqe
modifier|*
name|cqe
parameter_list|,
name|u8
modifier|*
name|cqe_flushed
parameter_list|,
name|u64
modifier|*
name|cookie
parameter_list|,
name|u32
modifier|*
name|credit
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|struct
name|t3_cqe
modifier|*
name|hw_cqe
decl_stmt|,
name|read_cqe
decl_stmt|;
operator|*
name|cqe_flushed
operator|=
literal|0
expr_stmt|;
operator|*
name|credit
operator|=
literal|0
expr_stmt|;
name|hw_cqe
operator|=
name|cxio_next_cqe
argument_list|(
name|cq
argument_list|)
expr_stmt|;
name|CTR5
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"cxio_poll_cq CQE OOO %d qpid 0x%0x genbit %d type %d status 0x%0x"
argument_list|,
name|CQE_OOO
argument_list|(
operator|*
name|hw_cqe
argument_list|)
argument_list|,
name|CQE_QPID
argument_list|(
operator|*
name|hw_cqe
argument_list|)
argument_list|,
name|CQE_GENBIT
argument_list|(
operator|*
name|hw_cqe
argument_list|)
argument_list|,
name|CQE_TYPE
argument_list|(
operator|*
name|hw_cqe
argument_list|)
argument_list|,
name|CQE_STATUS
argument_list|(
operator|*
name|hw_cqe
argument_list|)
argument_list|)
expr_stmt|;
name|CTR4
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"opcode 0x%0x len 0x%0x wrid_hi_stag 0x%x wrid_low_msn 0x%x"
argument_list|,
name|CQE_OPCODE
argument_list|(
operator|*
name|hw_cqe
argument_list|)
argument_list|,
name|CQE_LEN
argument_list|(
operator|*
name|hw_cqe
argument_list|)
argument_list|,
name|CQE_WRID_HI
argument_list|(
operator|*
name|hw_cqe
argument_list|)
argument_list|,
name|CQE_WRID_LOW
argument_list|(
operator|*
name|hw_cqe
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * skip cqe's not affiliated with a QP. 	 */
if|if
condition|(
name|wq
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|skip_cqe
goto|;
block|}
comment|/* 	 * Gotta tweak READ completions: 	 *	1) the cqe doesn't contain the sq_wptr from the wr. 	 *	2) opcode not reflected from the wr. 	 *	3) read_len not reflected from the wr. 	 *	4) cq_type is RQ_TYPE not SQ_TYPE. 	 */
if|if
condition|(
name|RQ_TYPE
argument_list|(
operator|*
name|hw_cqe
argument_list|)
operator|&&
operator|(
name|CQE_OPCODE
argument_list|(
operator|*
name|hw_cqe
argument_list|)
operator|==
name|T3_READ_RESP
operator|)
condition|)
block|{
comment|/* 		 * Don't write to the HWCQ, so create a new read req CQE 		 * in local memory. 		 */
name|create_read_req_cqe
argument_list|(
name|wq
argument_list|,
name|hw_cqe
argument_list|,
operator|&
name|read_cqe
argument_list|)
expr_stmt|;
name|hw_cqe
operator|=
operator|&
name|read_cqe
expr_stmt|;
name|advance_oldest_read
argument_list|(
name|wq
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * T3A: Discard TERMINATE CQEs. 	 */
if|if
condition|(
name|CQE_OPCODE
argument_list|(
operator|*
name|hw_cqe
argument_list|)
operator|==
name|T3_TERMINATE
condition|)
block|{
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
name|wq
operator|->
name|error
operator|=
literal|1
expr_stmt|;
goto|goto
name|skip_cqe
goto|;
block|}
if|if
condition|(
name|CQE_STATUS
argument_list|(
operator|*
name|hw_cqe
argument_list|)
operator|||
name|wq
operator|->
name|error
condition|)
block|{
operator|*
name|cqe_flushed
operator|=
name|wq
operator|->
name|error
expr_stmt|;
name|wq
operator|->
name|error
operator|=
literal|1
expr_stmt|;
comment|/* 		 * T3A inserts errors into the CQE.  We cannot return 		 * these as work completions. 		 */
comment|/* incoming write failures */
if|if
condition|(
operator|(
name|CQE_OPCODE
argument_list|(
operator|*
name|hw_cqe
argument_list|)
operator|==
name|T3_RDMA_WRITE
operator|)
operator|&&
name|RQ_TYPE
argument_list|(
operator|*
name|hw_cqe
argument_list|)
condition|)
block|{
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|skip_cqe
goto|;
block|}
comment|/* incoming read request failures */
if|if
condition|(
operator|(
name|CQE_OPCODE
argument_list|(
operator|*
name|hw_cqe
argument_list|)
operator|==
name|T3_READ_RESP
operator|)
operator|&&
name|SQ_TYPE
argument_list|(
operator|*
name|hw_cqe
argument_list|)
condition|)
block|{
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|skip_cqe
goto|;
block|}
comment|/* incoming SEND with no receive posted failures */
if|if
condition|(
operator|(
name|CQE_OPCODE
argument_list|(
operator|*
name|hw_cqe
argument_list|)
operator|==
name|T3_SEND
operator|)
operator|&&
name|RQ_TYPE
argument_list|(
operator|*
name|hw_cqe
argument_list|)
operator|&&
name|Q_EMPTY
argument_list|(
name|wq
operator|->
name|rq_rptr
argument_list|,
name|wq
operator|->
name|rq_wptr
argument_list|)
condition|)
block|{
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|skip_cqe
goto|;
block|}
goto|goto
name|proc_cqe
goto|;
block|}
comment|/* 	 * RECV completion. 	 */
if|if
condition|(
name|RQ_TYPE
argument_list|(
operator|*
name|hw_cqe
argument_list|)
condition|)
block|{
comment|/* 		 * HW only validates 4 bits of MSN.  So we must validate that 		 * the MSN in the SEND is the next expected MSN.  If its not, 		 * then we complete this with TPT_ERR_MSN and mark the wq in 		 * error. 		 */
if|if
condition|(
name|__predict_false
argument_list|(
operator|(
name|CQE_WRID_MSN
argument_list|(
operator|*
name|hw_cqe
argument_list|)
operator|!=
operator|(
name|wq
operator|->
name|rq_rptr
operator|+
literal|1
operator|)
operator|)
argument_list|)
condition|)
block|{
name|wq
operator|->
name|error
operator|=
literal|1
expr_stmt|;
name|hw_cqe
operator|->
name|header
operator||=
name|htonl
argument_list|(
name|V_CQE_STATUS
argument_list|(
name|TPT_ERR_MSN
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|proc_cqe
goto|;
block|}
goto|goto
name|proc_cqe
goto|;
block|}
comment|/* 	 * If we get here its a send completion. 	 * 	 * Handle out of order completion. These get stuffed 	 * in the SW SQ. Then the SW SQ is walked to move any 	 * now in-order completions into the SW CQ.  This handles 	 * 2 cases: 	 *	1) reaping unsignaled WRs when the first subsequent 	 *	   signaled WR is completed. 	 *	2) out of order read completions. 	 */
if|if
condition|(
operator|!
name|SW_CQE
argument_list|(
operator|*
name|hw_cqe
argument_list|)
operator|&&
operator|(
name|CQE_WRID_SQ_WPTR
argument_list|(
operator|*
name|hw_cqe
argument_list|)
operator|!=
name|wq
operator|->
name|sq_rptr
operator|)
condition|)
block|{
name|struct
name|t3_swsq
modifier|*
name|sqp
decl_stmt|;
name|CTR2
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s out of order completion going in swsq at idx %ld"
argument_list|,
name|__FUNCTION__
argument_list|,
name|Q_PTR2IDX
argument_list|(
name|CQE_WRID_SQ_WPTR
argument_list|(
operator|*
name|hw_cqe
argument_list|)
argument_list|,
name|wq
operator|->
name|sq_size_log2
argument_list|)
argument_list|)
expr_stmt|;
name|sqp
operator|=
name|wq
operator|->
name|sq
operator|+
name|Q_PTR2IDX
argument_list|(
name|CQE_WRID_SQ_WPTR
argument_list|(
operator|*
name|hw_cqe
argument_list|)
argument_list|,
name|wq
operator|->
name|sq_size_log2
argument_list|)
expr_stmt|;
name|sqp
operator|->
name|cqe
operator|=
operator|*
name|hw_cqe
expr_stmt|;
name|sqp
operator|->
name|complete
operator|=
literal|1
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|flush_wq
goto|;
block|}
name|proc_cqe
label|:
operator|*
name|cqe
operator|=
operator|*
name|hw_cqe
expr_stmt|;
comment|/* 	 * Reap the associated WR(s) that are freed up with this 	 * completion. 	 */
if|if
condition|(
name|SQ_TYPE
argument_list|(
operator|*
name|hw_cqe
argument_list|)
condition|)
block|{
name|wq
operator|->
name|sq_rptr
operator|=
name|CQE_WRID_SQ_WPTR
argument_list|(
operator|*
name|hw_cqe
argument_list|)
expr_stmt|;
name|CTR2
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s completing sq idx %ld"
argument_list|,
name|__FUNCTION__
argument_list|,
name|Q_PTR2IDX
argument_list|(
name|wq
operator|->
name|sq_rptr
argument_list|,
name|wq
operator|->
name|sq_size_log2
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|cookie
operator|=
operator|(
name|wq
operator|->
name|sq
operator|+
name|Q_PTR2IDX
argument_list|(
name|wq
operator|->
name|sq_rptr
argument_list|,
name|wq
operator|->
name|sq_size_log2
argument_list|)
operator|)
operator|->
name|wr_id
expr_stmt|;
name|wq
operator|->
name|sq_rptr
operator|++
expr_stmt|;
block|}
else|else
block|{
name|CTR2
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s completing rq idx %ld"
argument_list|,
name|__FUNCTION__
argument_list|,
name|Q_PTR2IDX
argument_list|(
name|wq
operator|->
name|rq_rptr
argument_list|,
name|wq
operator|->
name|rq_size_log2
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|cookie
operator|=
operator|*
operator|(
name|wq
operator|->
name|rq
operator|+
name|Q_PTR2IDX
argument_list|(
name|wq
operator|->
name|rq_rptr
argument_list|,
name|wq
operator|->
name|rq_size_log2
argument_list|)
operator|)
expr_stmt|;
name|wq
operator|->
name|rq_rptr
operator|++
expr_stmt|;
block|}
name|flush_wq
label|:
comment|/* 	 * Flush any completed cqes that are now in-order. 	 */
name|flush_completed_wrs
argument_list|(
name|wq
argument_list|,
name|cq
argument_list|)
expr_stmt|;
name|skip_cqe
label|:
if|if
condition|(
name|SW_CQE
argument_list|(
operator|*
name|hw_cqe
argument_list|)
condition|)
block|{
name|CTR4
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s cq %p cqid 0x%x skip sw cqe sw_rptr 0x%x"
argument_list|,
name|__FUNCTION__
argument_list|,
name|cq
argument_list|,
name|cq
operator|->
name|cqid
argument_list|,
name|cq
operator|->
name|sw_rptr
argument_list|)
expr_stmt|;
operator|++
name|cq
operator|->
name|sw_rptr
expr_stmt|;
block|}
else|else
block|{
name|CTR4
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s cq %p cqid 0x%x skip hw cqe rptr 0x%x"
argument_list|,
name|__FUNCTION__
argument_list|,
name|cq
argument_list|,
name|cq
operator|->
name|cqid
argument_list|,
name|cq
operator|->
name|rptr
argument_list|)
expr_stmt|;
operator|++
name|cq
operator|->
name|rptr
expr_stmt|;
comment|/* 		 * T3A: compute credits. 		 */
if|if
condition|(
operator|(
operator|(
name|cq
operator|->
name|rptr
operator|-
name|cq
operator|->
name|wptr
operator|)
operator|>
operator|(
literal|1
operator|<<
operator|(
name|cq
operator|->
name|size_log2
operator|-
literal|1
operator|)
operator|)
operator|)
operator|||
operator|(
operator|(
name|cq
operator|->
name|rptr
operator|-
name|cq
operator|->
name|wptr
operator|)
operator|>=
literal|128
operator|)
condition|)
block|{
operator|*
name|credit
operator|=
name|cq
operator|->
name|rptr
operator|-
name|cq
operator|->
name|wptr
expr_stmt|;
name|cq
operator|->
name|wptr
operator|=
name|cq
operator|->
name|rptr
expr_stmt|;
block|}
block|}
return|return
name|ret
return|;
block|}
end_function

end_unit


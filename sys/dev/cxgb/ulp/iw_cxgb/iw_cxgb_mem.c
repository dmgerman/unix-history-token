begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/**************************************************************************  Copyright (c) 2007, Chelsio Inc. All rights reserved.  Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:   1. Redistributions of source code must retain the above copyright notice,     this list of conditions and the following disclaimer.   2. Neither the name of the Chelsio Corporation nor the names of its     contributors may be used to endorse or promote products derived from     this software without specific prior written permission.  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  ***************************************************************************/
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"opt_inet.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|TCP_OFFLOAD
end_ifdef

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/pciio.h>
end_include

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioccom.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<sys/rwlock.h>
end_include

begin_include
include|#
directive|include
file|<sys/linker.h>
end_include

begin_include
include|#
directive|include
file|<sys/firmware.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_include
include|#
directive|include
file|<sys/smp.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/syslog.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<sys/taskqueue.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<sys/libkern.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<rdma/ib_verbs.h>
end_include

begin_include
include|#
directive|include
file|<rdma/ib_umem.h>
end_include

begin_include
include|#
directive|include
file|<rdma/ib_user_verbs.h>
end_include

begin_include
include|#
directive|include
file|<linux/idr.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_ib_intfc.h>
end_include

begin_include
include|#
directive|include
file|<cxgb_include.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_wr.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_hal.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_provider.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_cm.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_resource.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_user.h>
end_include

begin_function
specifier|static
name|int
name|iwch_finish_mem_reg
parameter_list|(
name|struct
name|iwch_mr
modifier|*
name|mhp
parameter_list|,
name|u32
name|stag
parameter_list|)
block|{
name|u32
name|mmid
decl_stmt|;
name|mhp
operator|->
name|attr
operator|.
name|state
operator|=
literal|1
expr_stmt|;
name|mhp
operator|->
name|attr
operator|.
name|stag
operator|=
name|stag
expr_stmt|;
name|mmid
operator|=
name|stag
operator|>>
literal|8
expr_stmt|;
name|mhp
operator|->
name|ibmr
operator|.
name|rkey
operator|=
name|mhp
operator|->
name|ibmr
operator|.
name|lkey
operator|=
name|stag
expr_stmt|;
name|CTR3
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s mmid 0x%x mhp %p"
argument_list|,
name|__func__
argument_list|,
name|mmid
argument_list|,
name|mhp
argument_list|)
expr_stmt|;
return|return
name|insert_handle
argument_list|(
name|mhp
operator|->
name|rhp
argument_list|,
operator|&
name|mhp
operator|->
name|rhp
operator|->
name|mmidr
argument_list|,
name|mhp
argument_list|,
name|mmid
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|iwch_register_mem
parameter_list|(
name|struct
name|iwch_dev
modifier|*
name|rhp
parameter_list|,
name|struct
name|iwch_pd
modifier|*
name|php
parameter_list|,
name|struct
name|iwch_mr
modifier|*
name|mhp
parameter_list|,
name|int
name|shift
parameter_list|)
block|{
name|u32
name|stag
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|cxio_register_phys_mem
argument_list|(
operator|&
name|rhp
operator|->
name|rdev
argument_list|,
operator|&
name|stag
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|pdid
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|perms
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|zbva
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|va_fbo
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|len
argument_list|,
name|shift
operator|-
literal|12
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|pbl_size
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|pbl_addr
argument_list|)
condition|)
return|return
operator|(
operator|-
name|ENOMEM
operator|)
return|;
name|ret
operator|=
name|iwch_finish_mem_reg
argument_list|(
name|mhp
argument_list|,
name|stag
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|cxio_dereg_mem
argument_list|(
operator|&
name|rhp
operator|->
name|rdev
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|stag
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|pbl_size
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|pbl_addr
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|iwch_reregister_mem
parameter_list|(
name|struct
name|iwch_dev
modifier|*
name|rhp
parameter_list|,
name|struct
name|iwch_pd
modifier|*
name|php
parameter_list|,
name|struct
name|iwch_mr
modifier|*
name|mhp
parameter_list|,
name|int
name|shift
parameter_list|,
name|int
name|npages
parameter_list|)
block|{
name|u32
name|stag
decl_stmt|;
name|int
name|ret
decl_stmt|;
comment|/* We could support this... */
if|if
condition|(
name|npages
operator|>
name|mhp
operator|->
name|attr
operator|.
name|pbl_size
condition|)
return|return
operator|(
operator|-
name|ENOMEM
operator|)
return|;
name|stag
operator|=
name|mhp
operator|->
name|attr
operator|.
name|stag
expr_stmt|;
if|if
condition|(
name|cxio_reregister_phys_mem
argument_list|(
operator|&
name|rhp
operator|->
name|rdev
argument_list|,
operator|&
name|stag
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|pdid
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|perms
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|zbva
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|va_fbo
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|len
argument_list|,
name|shift
operator|-
literal|12
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|pbl_size
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|pbl_addr
argument_list|)
condition|)
return|return
operator|(
operator|-
name|ENOMEM
operator|)
return|;
name|ret
operator|=
name|iwch_finish_mem_reg
argument_list|(
name|mhp
argument_list|,
name|stag
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|cxio_dereg_mem
argument_list|(
operator|&
name|rhp
operator|->
name|rdev
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|stag
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|pbl_size
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|pbl_addr
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|iwch_alloc_pbl
parameter_list|(
name|struct
name|iwch_mr
modifier|*
name|mhp
parameter_list|,
name|int
name|npages
parameter_list|)
block|{
name|mhp
operator|->
name|attr
operator|.
name|pbl_addr
operator|=
name|cxio_hal_pblpool_alloc
argument_list|(
operator|&
name|mhp
operator|->
name|rhp
operator|->
name|rdev
argument_list|,
name|npages
operator|<<
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mhp
operator|->
name|attr
operator|.
name|pbl_addr
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|mhp
operator|->
name|attr
operator|.
name|pbl_size
operator|=
name|npages
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|iwch_free_pbl
parameter_list|(
name|struct
name|iwch_mr
modifier|*
name|mhp
parameter_list|)
block|{
name|cxio_hal_pblpool_free
argument_list|(
operator|&
name|mhp
operator|->
name|rhp
operator|->
name|rdev
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|pbl_addr
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|pbl_size
operator|<<
literal|3
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|iwch_write_pbl
parameter_list|(
name|struct
name|iwch_mr
modifier|*
name|mhp
parameter_list|,
name|__be64
modifier|*
name|pages
parameter_list|,
name|int
name|npages
parameter_list|,
name|int
name|offset
parameter_list|)
block|{
return|return
name|cxio_write_pbl
argument_list|(
operator|&
name|mhp
operator|->
name|rhp
operator|->
name|rdev
argument_list|,
name|pages
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|pbl_addr
operator|+
operator|(
name|offset
operator|<<
literal|3
operator|)
argument_list|,
name|npages
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|build_phys_page_list
parameter_list|(
name|struct
name|ib_phys_buf
modifier|*
name|buffer_list
parameter_list|,
name|int
name|num_phys_buf
parameter_list|,
name|u64
modifier|*
name|iova_start
parameter_list|,
name|u64
modifier|*
name|total_size
parameter_list|,
name|int
modifier|*
name|npages
parameter_list|,
name|int
modifier|*
name|shift
parameter_list|,
name|__be64
modifier|*
modifier|*
name|page_list
parameter_list|)
block|{
name|u64
name|mask
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|n
decl_stmt|;
name|mask
operator|=
literal|0
expr_stmt|;
operator|*
name|total_size
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_phys_buf
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|i
operator|!=
literal|0
operator|&&
name|buffer_list
index|[
name|i
index|]
operator|.
name|addr
operator|&
operator|~
name|PAGE_MASK
condition|)
return|return
operator|(
operator|-
name|EINVAL
operator|)
return|;
if|if
condition|(
name|i
operator|!=
literal|0
operator|&&
name|i
operator|!=
name|num_phys_buf
operator|-
literal|1
operator|&&
operator|(
name|buffer_list
index|[
name|i
index|]
operator|.
name|size
operator|&
operator|~
name|PAGE_MASK
operator|)
condition|)
return|return
operator|(
operator|-
name|EINVAL
operator|)
return|;
operator|*
name|total_size
operator|+=
name|buffer_list
index|[
name|i
index|]
operator|.
name|size
expr_stmt|;
if|if
condition|(
name|i
operator|>
literal|0
condition|)
name|mask
operator||=
name|buffer_list
index|[
name|i
index|]
operator|.
name|addr
expr_stmt|;
else|else
name|mask
operator||=
name|buffer_list
index|[
name|i
index|]
operator|.
name|addr
operator|&
name|PAGE_MASK
expr_stmt|;
if|if
condition|(
name|i
operator|!=
name|num_phys_buf
operator|-
literal|1
condition|)
name|mask
operator||=
name|buffer_list
index|[
name|i
index|]
operator|.
name|addr
operator|+
name|buffer_list
index|[
name|i
index|]
operator|.
name|size
expr_stmt|;
else|else
name|mask
operator||=
operator|(
name|buffer_list
index|[
name|i
index|]
operator|.
name|addr
operator|+
name|buffer_list
index|[
name|i
index|]
operator|.
name|size
operator|+
name|PAGE_SIZE
operator|-
literal|1
operator|)
operator|&
name|PAGE_MASK
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|total_size
operator|>
literal|0xFFFFFFFFULL
condition|)
return|return
operator|(
operator|-
name|ENOMEM
operator|)
return|;
comment|/* Find largest page shift we can use to cover buffers */
for|for
control|(
operator|*
name|shift
operator|=
name|PAGE_SHIFT
init|;
operator|*
name|shift
operator|<
literal|27
condition|;
operator|++
operator|(
operator|*
name|shift
operator|)
control|)
if|if
condition|(
operator|(
literal|1ULL
operator|<<
operator|*
name|shift
operator|)
operator|&
name|mask
condition|)
break|break;
name|buffer_list
index|[
literal|0
index|]
operator|.
name|size
operator|+=
name|buffer_list
index|[
literal|0
index|]
operator|.
name|addr
operator|&
operator|(
operator|(
literal|1ULL
operator|<<
operator|*
name|shift
operator|)
operator|-
literal|1
operator|)
expr_stmt|;
name|buffer_list
index|[
literal|0
index|]
operator|.
name|addr
operator|&=
operator|~
literal|0ull
operator|<<
operator|*
name|shift
expr_stmt|;
operator|*
name|npages
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_phys_buf
condition|;
operator|++
name|i
control|)
operator|*
name|npages
operator|+=
operator|(
name|buffer_list
index|[
name|i
index|]
operator|.
name|size
operator|+
operator|(
literal|1ULL
operator|<<
operator|*
name|shift
operator|)
operator|-
literal|1
operator|)
operator|>>
operator|*
name|shift
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|npages
condition|)
return|return
operator|(
operator|-
name|EINVAL
operator|)
return|;
operator|*
name|page_list
operator|=
name|kmalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|u64
argument_list|)
operator|*
operator|*
name|npages
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|page_list
condition|)
return|return
operator|(
operator|-
name|ENOMEM
operator|)
return|;
name|n
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_phys_buf
condition|;
operator|++
name|i
control|)
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
operator|(
name|buffer_list
index|[
name|i
index|]
operator|.
name|size
operator|+
operator|(
literal|1ULL
operator|<<
operator|*
name|shift
operator|)
operator|-
literal|1
operator|)
operator|>>
operator|*
name|shift
condition|;
operator|++
name|j
control|)
operator|(
operator|*
name|page_list
operator|)
index|[
name|n
operator|++
index|]
operator|=
name|htobe64
argument_list|(
name|buffer_list
index|[
name|i
index|]
operator|.
name|addr
operator|+
operator|(
operator|(
name|u64
operator|)
name|j
operator|<<
operator|*
name|shift
operator|)
argument_list|)
expr_stmt|;
name|CTR6
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s va 0x%llx mask 0x%llx shift %d len %lld pbl_size %d"
argument_list|,
name|__FUNCTION__
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
operator|*
name|iova_start
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|mask
argument_list|,
operator|*
name|shift
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
operator|*
name|total_size
argument_list|,
operator|*
name|npages
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

end_unit


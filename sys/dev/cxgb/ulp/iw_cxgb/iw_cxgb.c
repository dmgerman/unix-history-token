begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/**************************************************************************  Copyright (c) 2007, Chelsio Inc. All rights reserved.  Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:   1. Redistributions of source code must retain the above copyright notice,     this list of conditions and the following disclaimer.   2. Neither the name of the Chelsio Corporation nor the names of its     contributors may be used to endorse or promote products derived from     this software without specific prior written permission.  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  ***************************************************************************/
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/pciio.h>
end_include

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus_dma.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioccom.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/rwlock.h>
end_include

begin_include
include|#
directive|include
file|<sys/linker.h>
end_include

begin_include
include|#
directive|include
file|<sys/firmware.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_include
include|#
directive|include
file|<sys/smp.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<sys/taskqueue.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/eventhandler.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_var.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<contrib/rdma/ib_verbs.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_DEFINED
end_ifdef

begin_include
include|#
directive|include
file|<cxgb_include.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_wr.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_hal.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_provider.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_cm.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb.h>
end_include

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<dev/cxgb/cxgb_include.h>
end_include

begin_include
include|#
directive|include
file|<dev/cxgb/ulp/iw_cxgb/iw_cxgb_wr.h>
end_include

begin_include
include|#
directive|include
file|<dev/cxgb/ulp/iw_cxgb/iw_cxgb_hal.h>
end_include

begin_include
include|#
directive|include
file|<dev/cxgb/ulp/iw_cxgb/iw_cxgb_provider.h>
end_include

begin_include
include|#
directive|include
file|<dev/cxgb/ulp/iw_cxgb/iw_cxgb_cm.h>
end_include

begin_include
include|#
directive|include
file|<dev/cxgb/ulp/iw_cxgb/iw_cxgb.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * XXX :-/  *   */
end_comment

begin_define
define|#
directive|define
name|idr_init
parameter_list|(
name|x
parameter_list|)
end_define

begin_decl_stmt
name|cxgb_cpl_handler_func
name|t3c_handlers
index|[
name|NUM_CPL_CMDS
index|]
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|open_rnic_dev
parameter_list|(
name|struct
name|t3cdev
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|close_rnic_dev
parameter_list|(
name|struct
name|t3cdev
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_expr_stmt
specifier|static
name|TAILQ_HEAD
argument_list|(
argument_list|,
argument|iwch_dev
argument_list|)
name|dev_list
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|struct
name|mtx
name|dev_mutex
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|eventhandler_tag
name|event_tag
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|rnic_init
parameter_list|(
name|struct
name|iwch_dev
modifier|*
name|rnicp
parameter_list|)
block|{
name|CTR2
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s iwch_dev %p"
argument_list|,
name|__FUNCTION__
argument_list|,
name|rnicp
argument_list|)
expr_stmt|;
name|idr_init
argument_list|(
operator|&
name|rnicp
operator|->
name|cqidr
argument_list|)
expr_stmt|;
name|idr_init
argument_list|(
operator|&
name|rnicp
operator|->
name|qpidr
argument_list|)
expr_stmt|;
name|idr_init
argument_list|(
operator|&
name|rnicp
operator|->
name|mmidr
argument_list|)
expr_stmt|;
name|mtx_init
argument_list|(
operator|&
name|rnicp
operator|->
name|lock
argument_list|,
literal|"iwch rnic lock"
argument_list|,
name|NULL
argument_list|,
name|MTX_DEF
operator||
name|MTX_DUPOK
argument_list|)
expr_stmt|;
name|rnicp
operator|->
name|attr
operator|.
name|vendor_id
operator|=
literal|0x168
expr_stmt|;
name|rnicp
operator|->
name|attr
operator|.
name|vendor_part_id
operator|=
literal|7
expr_stmt|;
name|rnicp
operator|->
name|attr
operator|.
name|max_qps
operator|=
name|T3_MAX_NUM_QP
operator|-
literal|32
expr_stmt|;
name|rnicp
operator|->
name|attr
operator|.
name|max_wrs
operator|=
operator|(
literal|1UL
operator|<<
literal|24
operator|)
operator|-
literal|1
expr_stmt|;
name|rnicp
operator|->
name|attr
operator|.
name|max_sge_per_wr
operator|=
name|T3_MAX_SGE
expr_stmt|;
name|rnicp
operator|->
name|attr
operator|.
name|max_sge_per_rdma_write_wr
operator|=
name|T3_MAX_SGE
expr_stmt|;
name|rnicp
operator|->
name|attr
operator|.
name|max_cqs
operator|=
name|T3_MAX_NUM_CQ
operator|-
literal|1
expr_stmt|;
name|rnicp
operator|->
name|attr
operator|.
name|max_cqes_per_cq
operator|=
operator|(
literal|1UL
operator|<<
literal|24
operator|)
operator|-
literal|1
expr_stmt|;
name|rnicp
operator|->
name|attr
operator|.
name|max_mem_regs
operator|=
name|cxio_num_stags
argument_list|(
operator|&
name|rnicp
operator|->
name|rdev
argument_list|)
expr_stmt|;
name|rnicp
operator|->
name|attr
operator|.
name|max_phys_buf_entries
operator|=
name|T3_MAX_PBL_SIZE
expr_stmt|;
name|rnicp
operator|->
name|attr
operator|.
name|max_pds
operator|=
name|T3_MAX_NUM_PD
operator|-
literal|1
expr_stmt|;
name|rnicp
operator|->
name|attr
operator|.
name|mem_pgsizes_bitmask
operator|=
literal|0x7FFF
expr_stmt|;
comment|/* 4KB-128MB */
name|rnicp
operator|->
name|attr
operator|.
name|can_resize_wq
operator|=
literal|0
expr_stmt|;
name|rnicp
operator|->
name|attr
operator|.
name|max_rdma_reads_per_qp
operator|=
literal|8
expr_stmt|;
name|rnicp
operator|->
name|attr
operator|.
name|max_rdma_read_resources
operator|=
name|rnicp
operator|->
name|attr
operator|.
name|max_rdma_reads_per_qp
operator|*
name|rnicp
operator|->
name|attr
operator|.
name|max_qps
expr_stmt|;
name|rnicp
operator|->
name|attr
operator|.
name|max_rdma_read_qp_depth
operator|=
literal|8
expr_stmt|;
comment|/* IRD */
name|rnicp
operator|->
name|attr
operator|.
name|max_rdma_read_depth
operator|=
name|rnicp
operator|->
name|attr
operator|.
name|max_rdma_read_qp_depth
operator|*
name|rnicp
operator|->
name|attr
operator|.
name|max_qps
expr_stmt|;
name|rnicp
operator|->
name|attr
operator|.
name|rq_overflow_handled
operator|=
literal|0
expr_stmt|;
name|rnicp
operator|->
name|attr
operator|.
name|can_modify_ird
operator|=
literal|0
expr_stmt|;
name|rnicp
operator|->
name|attr
operator|.
name|can_modify_ord
operator|=
literal|0
expr_stmt|;
name|rnicp
operator|->
name|attr
operator|.
name|max_mem_windows
operator|=
name|rnicp
operator|->
name|attr
operator|.
name|max_mem_regs
operator|-
literal|1
expr_stmt|;
name|rnicp
operator|->
name|attr
operator|.
name|stag0_value
operator|=
literal|1
expr_stmt|;
name|rnicp
operator|->
name|attr
operator|.
name|zbva_support
operator|=
literal|1
expr_stmt|;
name|rnicp
operator|->
name|attr
operator|.
name|local_invalidate_fence
operator|=
literal|1
expr_stmt|;
name|rnicp
operator|->
name|attr
operator|.
name|cq_overflow_detection
operator|=
literal|1
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|open_rnic_dev
parameter_list|(
name|struct
name|t3cdev
modifier|*
name|tdev
parameter_list|)
block|{
name|struct
name|iwch_dev
modifier|*
name|rnicp
decl_stmt|;
specifier|static
name|int
name|vers_printed
decl_stmt|;
name|CTR2
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s t3cdev %p"
argument_list|,
name|__FUNCTION__
argument_list|,
name|tdev
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|vers_printed
operator|++
condition|)
name|printf
argument_list|(
literal|"Chelsio T3 RDMA Driver - version %s\n"
argument_list|,
name|DRV_VERSION
argument_list|)
expr_stmt|;
name|rnicp
operator|=
operator|(
expr|struct
name|iwch_dev
operator|*
operator|)
name|ib_alloc_device
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|rnicp
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rnicp
condition|)
block|{
name|printf
argument_list|(
literal|"Cannot allocate ib device\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|rnicp
operator|->
name|rdev
operator|.
name|ulp
operator|=
name|rnicp
expr_stmt|;
name|rnicp
operator|->
name|rdev
operator|.
name|t3cdev_p
operator|=
name|tdev
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|dev_mutex
argument_list|)
expr_stmt|;
if|if
condition|(
name|cxio_rdev_open
argument_list|(
operator|&
name|rnicp
operator|->
name|rdev
argument_list|)
condition|)
block|{
name|mtx_unlock
argument_list|(
operator|&
name|dev_mutex
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Unable to open CXIO rdev\n"
argument_list|)
expr_stmt|;
name|ib_dealloc_device
argument_list|(
operator|&
name|rnicp
operator|->
name|ibdev
argument_list|)
expr_stmt|;
return|return;
block|}
name|rnic_init
argument_list|(
name|rnicp
argument_list|)
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|dev_list
argument_list|,
name|rnicp
argument_list|,
name|entry
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|dev_mutex
argument_list|)
expr_stmt|;
if|if
condition|(
name|iwch_register_device
argument_list|(
name|rnicp
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Unable to register device\n"
argument_list|)
expr_stmt|;
name|close_rnic_dev
argument_list|(
name|tdev
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|notyet
name|printf
argument_list|(
literal|"Initialized device %s\n"
argument_list|,
name|pci_name
argument_list|(
name|rnicp
operator|->
name|rdev
operator|.
name|rnic_info
operator|.
name|pdev
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|close_rnic_dev
parameter_list|(
name|struct
name|t3cdev
modifier|*
name|tdev
parameter_list|)
block|{
name|struct
name|iwch_dev
modifier|*
name|dev
decl_stmt|,
modifier|*
name|tmp
decl_stmt|;
name|CTR2
argument_list|(
name|KTR_IW_CXGB
argument_list|,
literal|"%s t3cdev %p"
argument_list|,
name|__FUNCTION__
argument_list|,
name|tdev
argument_list|)
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|dev_mutex
argument_list|)
expr_stmt|;
name|TAILQ_FOREACH_SAFE
argument_list|(
argument|dev
argument_list|,
argument|&dev_list
argument_list|,
argument|entry
argument_list|,
argument|tmp
argument_list|)
block|{
if|if
condition|(
name|dev
operator|->
name|rdev
operator|.
name|t3cdev_p
operator|==
name|tdev
condition|)
block|{
ifdef|#
directive|ifdef
name|notyet
name|list_del
argument_list|(
operator|&
name|dev
operator|->
name|entry
argument_list|)
expr_stmt|;
name|iwch_unregister_device
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|cxio_rdev_close
argument_list|(
operator|&
name|dev
operator|->
name|rdev
argument_list|)
expr_stmt|;
name|idr_destroy
argument_list|(
operator|&
name|dev
operator|->
name|cqidr
argument_list|)
expr_stmt|;
name|idr_destroy
argument_list|(
operator|&
name|dev
operator|->
name|qpidr
argument_list|)
expr_stmt|;
name|idr_destroy
argument_list|(
operator|&
name|dev
operator|->
name|mmidr
argument_list|)
expr_stmt|;
name|ib_dealloc_device
argument_list|(
operator|&
name|dev
operator|->
name|ibdev
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
block|}
block|}
name|mtx_unlock
argument_list|(
operator|&
name|dev_mutex
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|ifaddr_event_handler_t
name|ifaddr_event_handler
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|printf
argument_list|(
literal|"%s if name %s \n"
argument_list|,
name|__FUNCTION__
argument_list|,
name|ifp
operator|->
name|if_xname
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_capabilities
operator|&
name|IFCAP_TOE4
condition|)
block|{
name|KASSERT
argument_list|(
name|T3CDEV
argument_list|(
name|ifp
argument_list|)
operator|!=
name|NULL
argument_list|,
operator|(
literal|"null t3cdev ptr!"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cxio_hal_find_rdev_by_t3cdev
argument_list|(
name|T3CDEV
argument_list|(
name|ifp
argument_list|)
argument_list|)
operator|==
name|NULL
condition|)
name|open_rnic_dev
argument_list|(
name|T3CDEV
argument_list|(
name|ifp
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|iwch_init_module
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|printf
argument_list|(
literal|"%s enter\n"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
name|TAILQ_INIT
argument_list|(
operator|&
name|dev_list
argument_list|)
expr_stmt|;
name|mtx_init
argument_list|(
operator|&
name|dev_mutex
argument_list|,
literal|"iwch dev_list lock"
argument_list|,
name|NULL
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
name|err
operator|=
name|cxio_hal_init
argument_list|()
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
name|err
operator|=
name|iwch_cm_init
argument_list|()
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
name|cxio_register_ev_cb
argument_list|(
name|iwch_ev_dispatch
argument_list|)
expr_stmt|;
comment|/* Register for ifaddr events to dynamically add TOE devs */
name|event_tag
operator|=
name|EVENTHANDLER_REGISTER
argument_list|(
name|ifaddr_event
argument_list|,
name|ifaddr_event_handler
argument_list|,
name|NULL
argument_list|,
name|EVENTHANDLER_PRI_ANY
argument_list|)
expr_stmt|;
comment|/* Register existing TOE interfaces by walking the ifnet chain */
name|IFNET_RLOCK
argument_list|()
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|ifp
argument_list|,
argument|&ifnet
argument_list|,
argument|if_link
argument_list|)
block|{
operator|(
name|void
operator|)
name|ifaddr_event_handler
argument_list|(
name|NULL
argument_list|,
name|ifp
argument_list|)
expr_stmt|;
block|}
name|IFNET_RUNLOCK
argument_list|()
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|iwch_exit_module
parameter_list|(
name|void
parameter_list|)
block|{
name|EVENTHANDLER_DEREGISTER
argument_list|(
name|ifaddr_event
argument_list|,
name|event_tag
argument_list|)
expr_stmt|;
name|cxio_unregister_ev_cb
argument_list|(
name|iwch_ev_dispatch
argument_list|)
expr_stmt|;
name|iwch_cm_term
argument_list|()
expr_stmt|;
name|cxio_hal_exit
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|iwch_load
parameter_list|(
name|module_t
name|mod
parameter_list|,
name|int
name|cmd
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|int
name|err
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|MOD_LOAD
case|:
name|printf
argument_list|(
literal|"Loading iw_cxgb.\n"
argument_list|)
expr_stmt|;
name|iwch_init_module
argument_list|()
expr_stmt|;
break|break;
case|case
name|MOD_QUIESCE
case|:
break|break;
case|case
name|MOD_UNLOAD
case|:
name|printf
argument_list|(
literal|"Unloading iw_cxgb.\n"
argument_list|)
expr_stmt|;
name|iwch_exit_module
argument_list|()
expr_stmt|;
break|break;
case|case
name|MOD_SHUTDOWN
case|:
break|break;
default|default:
name|err
operator|=
name|EOPNOTSUPP
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|moduledata_t
name|mod_data
init|=
block|{
literal|"iw_cxgb"
block|,
name|iwch_load
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|MODULE_VERSION
argument_list|(
name|iw_cxgb
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DECLARE_MODULE
argument_list|(
name|iw_cxgb
argument_list|,
name|mod_data
argument_list|,
name|SI_SUB_EXEC
argument_list|,
name|SI_ORDER_ANY
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|iw_cxgb
argument_list|,
name|rdma_core
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|iw_cxgb
argument_list|,
name|if_cxgb
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|iw_cxgb
argument_list|,
name|t3_tom
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


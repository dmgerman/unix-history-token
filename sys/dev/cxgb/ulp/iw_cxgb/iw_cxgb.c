begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/**************************************************************************  Copyright (c) 2007, Chelsio Inc. All rights reserved.  Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:   1. Redistributions of source code must retain the above copyright notice,     this list of conditions and the following disclaimer.   2. Neither the name of the Chelsio Corporation nor the names of its     contributors may be used to endorse or promote products derived from     this software without specific prior written permission.  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  ***************************************************************************/
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"opt_inet.h"
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/pciio.h>
end_include

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus_dma.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioccom.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/rwlock.h>
end_include

begin_include
include|#
directive|include
file|<sys/linker.h>
end_include

begin_include
include|#
directive|include
file|<sys/firmware.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_include
include|#
directive|include
file|<sys/smp.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<sys/taskqueue.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/eventhandler.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/toecore.h>
end_include

begin_include
include|#
directive|include
file|<rdma/ib_verbs.h>
end_include

begin_include
include|#
directive|include
file|<linux/idr.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_ib_intfc.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|TCP_OFFLOAD
end_ifdef

begin_include
include|#
directive|include
file|<cxgb_include.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_wr.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_hal.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_provider.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb_cm.h>
end_include

begin_include
include|#
directive|include
file|<ulp/iw_cxgb/iw_cxgb.h>
end_include

begin_function_decl
specifier|static
name|int
name|iwch_mod_load
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|iwch_mod_unload
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|iwch_activate
parameter_list|(
name|struct
name|adapter
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|iwch_deactivate
parameter_list|(
name|struct
name|adapter
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|struct
name|uld_info
name|iwch_uld_info
init|=
block|{
operator|.
name|uld_id
operator|=
name|ULD_IWARP
block|,
operator|.
name|activate
operator|=
name|iwch_activate
block|,
operator|.
name|deactivate
operator|=
name|iwch_deactivate
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|rnic_init
parameter_list|(
name|struct
name|iwch_dev
modifier|*
name|rnicp
parameter_list|)
block|{
name|idr_init
argument_list|(
operator|&
name|rnicp
operator|->
name|cqidr
argument_list|)
expr_stmt|;
name|idr_init
argument_list|(
operator|&
name|rnicp
operator|->
name|qpidr
argument_list|)
expr_stmt|;
name|idr_init
argument_list|(
operator|&
name|rnicp
operator|->
name|mmidr
argument_list|)
expr_stmt|;
name|mtx_init
argument_list|(
operator|&
name|rnicp
operator|->
name|lock
argument_list|,
literal|"iwch rnic lock"
argument_list|,
name|NULL
argument_list|,
name|MTX_DEF
operator||
name|MTX_DUPOK
argument_list|)
expr_stmt|;
name|rnicp
operator|->
name|attr
operator|.
name|vendor_id
operator|=
literal|0x168
expr_stmt|;
name|rnicp
operator|->
name|attr
operator|.
name|vendor_part_id
operator|=
literal|7
expr_stmt|;
name|rnicp
operator|->
name|attr
operator|.
name|max_qps
operator|=
name|T3_MAX_NUM_QP
operator|-
literal|32
expr_stmt|;
name|rnicp
operator|->
name|attr
operator|.
name|max_wrs
operator|=
name|T3_MAX_QP_DEPTH
expr_stmt|;
name|rnicp
operator|->
name|attr
operator|.
name|max_sge_per_wr
operator|=
name|T3_MAX_SGE
expr_stmt|;
name|rnicp
operator|->
name|attr
operator|.
name|max_sge_per_rdma_write_wr
operator|=
name|T3_MAX_SGE
expr_stmt|;
name|rnicp
operator|->
name|attr
operator|.
name|max_cqs
operator|=
name|T3_MAX_NUM_CQ
operator|-
literal|1
expr_stmt|;
name|rnicp
operator|->
name|attr
operator|.
name|max_cqes_per_cq
operator|=
name|T3_MAX_CQ_DEPTH
expr_stmt|;
name|rnicp
operator|->
name|attr
operator|.
name|max_mem_regs
operator|=
name|cxio_num_stags
argument_list|(
operator|&
name|rnicp
operator|->
name|rdev
argument_list|)
expr_stmt|;
name|rnicp
operator|->
name|attr
operator|.
name|max_phys_buf_entries
operator|=
name|T3_MAX_PBL_SIZE
expr_stmt|;
name|rnicp
operator|->
name|attr
operator|.
name|max_pds
operator|=
name|T3_MAX_NUM_PD
operator|-
literal|1
expr_stmt|;
name|rnicp
operator|->
name|attr
operator|.
name|mem_pgsizes_bitmask
operator|=
name|T3_PAGESIZE_MASK
expr_stmt|;
name|rnicp
operator|->
name|attr
operator|.
name|max_mr_size
operator|=
name|T3_MAX_MR_SIZE
expr_stmt|;
name|rnicp
operator|->
name|attr
operator|.
name|can_resize_wq
operator|=
literal|0
expr_stmt|;
name|rnicp
operator|->
name|attr
operator|.
name|max_rdma_reads_per_qp
operator|=
literal|8
expr_stmt|;
name|rnicp
operator|->
name|attr
operator|.
name|max_rdma_read_resources
operator|=
name|rnicp
operator|->
name|attr
operator|.
name|max_rdma_reads_per_qp
operator|*
name|rnicp
operator|->
name|attr
operator|.
name|max_qps
expr_stmt|;
name|rnicp
operator|->
name|attr
operator|.
name|max_rdma_read_qp_depth
operator|=
literal|8
expr_stmt|;
comment|/* IRD */
name|rnicp
operator|->
name|attr
operator|.
name|max_rdma_read_depth
operator|=
name|rnicp
operator|->
name|attr
operator|.
name|max_rdma_read_qp_depth
operator|*
name|rnicp
operator|->
name|attr
operator|.
name|max_qps
expr_stmt|;
name|rnicp
operator|->
name|attr
operator|.
name|rq_overflow_handled
operator|=
literal|0
expr_stmt|;
name|rnicp
operator|->
name|attr
operator|.
name|can_modify_ird
operator|=
literal|0
expr_stmt|;
name|rnicp
operator|->
name|attr
operator|.
name|can_modify_ord
operator|=
literal|0
expr_stmt|;
name|rnicp
operator|->
name|attr
operator|.
name|max_mem_windows
operator|=
name|rnicp
operator|->
name|attr
operator|.
name|max_mem_regs
operator|-
literal|1
expr_stmt|;
name|rnicp
operator|->
name|attr
operator|.
name|stag0_value
operator|=
literal|1
expr_stmt|;
name|rnicp
operator|->
name|attr
operator|.
name|zbva_support
operator|=
literal|1
expr_stmt|;
name|rnicp
operator|->
name|attr
operator|.
name|local_invalidate_fence
operator|=
literal|1
expr_stmt|;
name|rnicp
operator|->
name|attr
operator|.
name|cq_overflow_detection
operator|=
literal|1
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|rnic_uninit
parameter_list|(
name|struct
name|iwch_dev
modifier|*
name|rnicp
parameter_list|)
block|{
name|idr_destroy
argument_list|(
operator|&
name|rnicp
operator|->
name|cqidr
argument_list|)
expr_stmt|;
name|idr_destroy
argument_list|(
operator|&
name|rnicp
operator|->
name|qpidr
argument_list|)
expr_stmt|;
name|idr_destroy
argument_list|(
operator|&
name|rnicp
operator|->
name|mmidr
argument_list|)
expr_stmt|;
name|mtx_destroy
argument_list|(
operator|&
name|rnicp
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|iwch_activate
parameter_list|(
name|struct
name|adapter
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|iwch_dev
modifier|*
name|rnicp
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|KASSERT
argument_list|(
operator|!
name|isset
argument_list|(
operator|&
name|sc
operator|->
name|offload_map
argument_list|,
name|MAX_NPORTS
argument_list|)
argument_list|,
operator|(
literal|"%s: iWARP already activated on %s"
operator|,
name|__func__
operator|,
name|device_get_nameunit
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|rnicp
operator|=
operator|(
expr|struct
name|iwch_dev
operator|*
operator|)
name|ib_alloc_device
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|rnicp
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rnicp
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
name|sc
operator|->
name|iwarp_softc
operator|=
name|rnicp
expr_stmt|;
name|rnicp
operator|->
name|rdev
operator|.
name|adap
operator|=
name|sc
expr_stmt|;
name|cxio_hal_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|iwch_cm_init_cpl
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|rc
operator|=
name|cxio_rdev_open
argument_list|(
operator|&
name|rnicp
operator|->
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Unable to open CXIO rdev\n"
argument_list|)
expr_stmt|;
goto|goto
name|err1
goto|;
block|}
name|rnic_init
argument_list|(
name|rnicp
argument_list|)
expr_stmt|;
name|rc
operator|=
name|iwch_register_device
argument_list|(
name|rnicp
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Unable to register device\n"
argument_list|)
expr_stmt|;
goto|goto
name|err2
goto|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|err2
label|:
name|rnic_uninit
argument_list|(
name|rnicp
argument_list|)
expr_stmt|;
name|cxio_rdev_close
argument_list|(
operator|&
name|rnicp
operator|->
name|rdev
argument_list|)
expr_stmt|;
name|err1
label|:
name|cxio_hal_uninit
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|iwch_cm_term_cpl
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|iwarp_softc
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|iwch_deactivate
parameter_list|(
name|struct
name|adapter
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|iwch_dev
modifier|*
name|rnicp
decl_stmt|;
name|rnicp
operator|=
name|sc
operator|->
name|iwarp_softc
expr_stmt|;
name|iwch_unregister_device
argument_list|(
name|rnicp
argument_list|)
expr_stmt|;
name|rnic_uninit
argument_list|(
name|rnicp
argument_list|)
expr_stmt|;
name|cxio_rdev_close
argument_list|(
operator|&
name|rnicp
operator|->
name|rdev
argument_list|)
expr_stmt|;
name|cxio_hal_uninit
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|iwch_cm_term_cpl
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ib_dealloc_device
argument_list|(
operator|&
name|rnicp
operator|->
name|ibdev
argument_list|)
expr_stmt|;
name|sc
operator|->
name|iwarp_softc
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|iwch_activate_all
parameter_list|(
name|struct
name|adapter
modifier|*
name|sc
parameter_list|,
name|void
modifier|*
name|arg
name|__unused
parameter_list|)
block|{
name|ADAPTER_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sc
operator|->
name|open_device_map
operator|&
name|sc
operator|->
name|offload_map
operator|)
operator|!=
literal|0
operator|&&
name|t3_activate_uld
argument_list|(
name|sc
argument_list|,
name|ULD_IWARP
argument_list|)
operator|==
literal|0
condition|)
name|setbit
argument_list|(
operator|&
name|sc
operator|->
name|offload_map
argument_list|,
name|MAX_NPORTS
argument_list|)
expr_stmt|;
name|ADAPTER_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|iwch_deactivate_all
parameter_list|(
name|struct
name|adapter
modifier|*
name|sc
parameter_list|,
name|void
modifier|*
name|arg
name|__unused
parameter_list|)
block|{
name|ADAPTER_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|isset
argument_list|(
operator|&
name|sc
operator|->
name|offload_map
argument_list|,
name|MAX_NPORTS
argument_list|)
operator|&&
name|t3_deactivate_uld
argument_list|(
name|sc
argument_list|,
name|ULD_IWARP
argument_list|)
operator|==
literal|0
condition|)
name|clrbit
argument_list|(
operator|&
name|sc
operator|->
name|offload_map
argument_list|,
name|MAX_NPORTS
argument_list|)
expr_stmt|;
name|ADAPTER_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|iwch_mod_load
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|rc
decl_stmt|;
name|rc
operator|=
name|iwch_cm_init
argument_list|()
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
literal|0
condition|)
return|return
operator|(
name|rc
operator|)
return|;
name|rc
operator|=
name|t3_register_uld
argument_list|(
operator|&
name|iwch_uld_info
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
literal|0
condition|)
block|{
name|iwch_cm_term
argument_list|()
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
name|t3_iterate
argument_list|(
name|iwch_activate_all
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|iwch_mod_unload
parameter_list|(
name|void
parameter_list|)
block|{
name|t3_iterate
argument_list|(
name|iwch_deactivate_all
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|iwch_cm_term
argument_list|()
expr_stmt|;
if|if
condition|(
name|t3_unregister_uld
argument_list|(
operator|&
name|iwch_uld_info
argument_list|)
operator|==
name|EBUSY
condition|)
return|return
operator|(
name|EBUSY
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* TCP_OFFLOAD */
end_comment

begin_undef
undef|#
directive|undef
name|MODULE_VERSION
end_undef

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_function
specifier|static
name|int
name|iwch_modevent
parameter_list|(
name|module_t
name|mod
parameter_list|,
name|int
name|cmd
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|int
name|rc
init|=
literal|0
decl_stmt|;
ifdef|#
directive|ifdef
name|TCP_OFFLOAD
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|MOD_LOAD
case|:
name|rc
operator|=
name|iwch_mod_load
argument_list|()
expr_stmt|;
if|if
condition|(
name|rc
condition|)
name|printf
argument_list|(
literal|"iw_cxgb: Chelsio T3 RDMA Driver failed to load\n"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"iw_cxgb: Chelsio T3 RDMA Driver loaded\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|MOD_UNLOAD
case|:
name|rc
operator|=
name|iwch_mod_unload
argument_list|()
expr_stmt|;
if|if
condition|(
name|rc
condition|)
name|printf
argument_list|(
literal|"iw_cxgb: Chelsio T3 RDMA Driver failed to unload\n"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"iw_cxgb: Chelsio T3 RDMA Driver unloaded\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|rc
operator|=
name|EINVAL
expr_stmt|;
block|}
else|#
directive|else
name|printf
argument_list|(
literal|"iw_cxgb: compiled without TCP_OFFLOAD support.\n"
argument_list|)
expr_stmt|;
name|rc
operator|=
name|EOPNOTSUPP
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|moduledata_t
name|iwch_mod_data
init|=
block|{
literal|"iw_cxgb"
block|,
name|iwch_modevent
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|MODULE_VERSION
argument_list|(
name|iw_cxgb
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DECLARE_MODULE
argument_list|(
name|iw_cxgb
argument_list|,
name|iwch_mod_data
argument_list|,
name|SI_SUB_EXEC
argument_list|,
name|SI_ORDER_ANY
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|t3_tom
argument_list|,
name|cxgbc
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|iw_cxgb
argument_list|,
name|toecore
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|iw_cxgb
argument_list|,
name|t3_tom
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


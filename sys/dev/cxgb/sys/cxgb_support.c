begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/**************************************************************************  Copyright (c) 2007, Chelsio Inc. All rights reserved.  Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:   1. Redistributions of source code must retain the above copyright notice,     this list of conditions and the following disclaimer.   2. Neither the name of the Chelsio Corporation nor the names of its     contributors may be used to endorse or promote products derived from     this software without specific prior written permission.   THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  ***************************************************************************/
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/sched.h>
end_include

begin_include
include|#
directive|include
file|<sys/smp.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm.h>
end_include

begin_include
include|#
directive|include
file|<vm/pmap.h>
end_include

begin_include
include|#
directive|include
file|<cxgb_include.h>
end_include

begin_include
include|#
directive|include
file|<sys/mvec.h>
end_include

begin_decl_stmt
specifier|extern
name|int
name|cxgb_use_16k_clusters
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|cxgb_pcpu_cache_enable
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|buf_stack
block|{
name|caddr_t
modifier|*
name|bs_stack
decl_stmt|;
specifier|volatile
name|int
name|bs_head
decl_stmt|;
name|int
name|bs_size
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|__inline
name|int
name|buf_stack_push
parameter_list|(
name|struct
name|buf_stack
modifier|*
name|bs
parameter_list|,
name|caddr_t
name|buf
parameter_list|)
block|{
if|if
condition|(
name|bs
operator|->
name|bs_head
operator|+
literal|1
operator|>=
name|bs
operator|->
name|bs_size
condition|)
return|return
operator|(
name|ENOSPC
operator|)
return|;
name|bs
operator|->
name|bs_stack
index|[
operator|++
operator|(
name|bs
operator|->
name|bs_head
operator|)
index|]
operator|=
name|buf
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|__inline
name|caddr_t
name|buf_stack_pop
parameter_list|(
name|struct
name|buf_stack
modifier|*
name|bs
parameter_list|)
block|{
if|if
condition|(
name|bs
operator|->
name|bs_head
operator|<
literal|0
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
return|return
operator|(
name|bs
operator|->
name|bs_stack
index|[
operator|(
name|bs
operator|->
name|bs_head
operator|)
operator|--
index|]
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Stack is full  *  */
end_comment

begin_function
specifier|static
name|__inline
name|int
name|buf_stack_avail
parameter_list|(
name|struct
name|buf_stack
modifier|*
name|bs
parameter_list|)
block|{
return|return
operator|(
name|bs
operator|->
name|bs_size
operator|-
name|bs
operator|->
name|bs_head
operator|-
literal|1
operator|)
return|;
block|}
end_function

begin_struct
struct|struct
name|cxgb_cache_pcpu
block|{
name|struct
name|buf_stack
name|ccp_jumbo_free
decl_stmt|;
name|struct
name|buf_stack
name|ccp_cluster_free
decl_stmt|;
name|uma_zone_t
name|ccp_jumbo_zone
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|cxgb_cache_system
block|{
name|struct
name|cxgb_cache_pcpu
name|ccs_array
index|[
literal|0
index|]
decl_stmt|;
block|}
modifier|*
name|cxgb_caches
struct|;
end_struct

begin_function
specifier|static
name|int
name|buf_stack_init
parameter_list|(
name|struct
name|buf_stack
modifier|*
name|bs
parameter_list|,
name|int
name|size
parameter_list|)
block|{
name|bs
operator|->
name|bs_size
operator|=
name|size
expr_stmt|;
name|bs
operator|->
name|bs_head
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|bs
operator|->
name|bs_stack
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|caddr_t
argument_list|)
operator|*
name|size
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|buf_stack_deinit
parameter_list|(
name|struct
name|buf_stack
modifier|*
name|bs
parameter_list|)
block|{
if|if
condition|(
name|bs
operator|->
name|bs_stack
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|bs
operator|->
name|bs_stack
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|cxgb_cache_pcpu_init
parameter_list|(
name|struct
name|cxgb_cache_pcpu
modifier|*
name|ccp
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|buf_stack_init
argument_list|(
operator|&
name|ccp
operator|->
name|ccp_jumbo_free
argument_list|,
operator|(
name|JUMBO_Q_SIZE
operator|>>
literal|2
operator|)
argument_list|)
operator|)
condition|)
return|return
operator|(
name|err
operator|)
return|;
if|if
condition|(
operator|(
name|err
operator|=
name|buf_stack_init
argument_list|(
operator|&
name|ccp
operator|->
name|ccp_cluster_free
argument_list|,
operator|(
name|FL_Q_SIZE
operator|>>
literal|2
operator|)
argument_list|)
operator|)
condition|)
return|return
operator|(
name|err
operator|)
return|;
if|#
directive|if
name|__FreeBSD_version
operator|>
literal|800000
if|if
condition|(
name|cxgb_use_16k_clusters
condition|)
name|ccp
operator|->
name|ccp_jumbo_zone
operator|=
name|zone_jumbo16
expr_stmt|;
else|else
name|ccp
operator|->
name|ccp_jumbo_zone
operator|=
name|zone_jumbo9
expr_stmt|;
else|#
directive|else
name|ccp
operator|->
name|ccp_jumbo_zone
operator|=
name|zone_jumbop
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|cxgb_cache_pcpu_deinit
parameter_list|(
name|struct
name|cxgb_cache_pcpu
modifier|*
name|ccp
parameter_list|)
block|{
name|void
modifier|*
name|cl
decl_stmt|;
while|while
condition|(
operator|(
name|cl
operator|=
name|buf_stack_pop
argument_list|(
operator|&
name|ccp
operator|->
name|ccp_jumbo_free
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
name|uma_zfree
argument_list|(
name|ccp
operator|->
name|ccp_jumbo_zone
argument_list|,
name|cl
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|cl
operator|=
name|buf_stack_pop
argument_list|(
operator|&
name|ccp
operator|->
name|ccp_cluster_free
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
name|uma_zfree
argument_list|(
name|zone_clust
argument_list|,
name|cl
argument_list|)
expr_stmt|;
name|buf_stack_deinit
argument_list|(
operator|&
name|ccp
operator|->
name|ccp_jumbo_free
argument_list|)
expr_stmt|;
name|buf_stack_deinit
argument_list|(
operator|&
name|ccp
operator|->
name|ccp_cluster_free
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
name|int
name|inited
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|cxgb_cache_init
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|err
decl_stmt|;
if|if
condition|(
name|inited
operator|++
operator|>
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
operator|(
name|cxgb_caches
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|cxgb_cache_pcpu
argument_list|)
operator|*
name|mp_ncpus
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|mp_ncpus
condition|;
name|i
operator|++
control|)
if|if
condition|(
operator|(
name|err
operator|=
name|cxgb_cache_pcpu_init
argument_list|(
operator|&
name|cxgb_caches
operator|->
name|ccs_array
index|[
name|i
index|]
argument_list|)
operator|)
condition|)
goto|goto
name|err
goto|;
return|return
operator|(
literal|0
operator|)
return|;
name|err
label|:
name|cxgb_cache_flush
argument_list|()
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
name|void
name|cxgb_cache_flush
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|--
name|inited
operator|>
literal|0
condition|)
return|return;
if|if
condition|(
name|cxgb_caches
operator|==
name|NULL
condition|)
return|return;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|mp_ncpus
condition|;
name|i
operator|++
control|)
name|cxgb_cache_pcpu_deinit
argument_list|(
operator|&
name|cxgb_caches
operator|->
name|ccs_array
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cxgb_caches
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|cxgb_caches
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
name|caddr_t
name|cxgb_cache_get
parameter_list|(
name|uma_zone_t
name|zone
parameter_list|)
block|{
name|caddr_t
name|cl
init|=
name|NULL
decl_stmt|;
name|struct
name|cxgb_cache_pcpu
modifier|*
name|ccp
decl_stmt|;
if|if
condition|(
name|cxgb_pcpu_cache_enable
condition|)
block|{
name|critical_enter
argument_list|()
expr_stmt|;
name|ccp
operator|=
operator|&
name|cxgb_caches
operator|->
name|ccs_array
index|[
name|curcpu
index|]
expr_stmt|;
if|if
condition|(
name|zone
operator|==
name|zone_clust
condition|)
block|{
name|cl
operator|=
name|buf_stack_pop
argument_list|(
operator|&
name|ccp
operator|->
name|ccp_cluster_free
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|zone
operator|==
name|ccp
operator|->
name|ccp_jumbo_zone
condition|)
block|{
name|cl
operator|=
name|buf_stack_pop
argument_list|(
operator|&
name|ccp
operator|->
name|ccp_jumbo_free
argument_list|)
expr_stmt|;
block|}
name|critical_exit
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|cl
operator|==
name|NULL
condition|)
name|cl
operator|=
name|uma_zalloc
argument_list|(
name|zone
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
else|else
name|cxgb_cached_allocations
operator|++
expr_stmt|;
return|return
operator|(
name|cl
operator|)
return|;
block|}
end_function

begin_function
name|void
name|cxgb_cache_put
parameter_list|(
name|uma_zone_t
name|zone
parameter_list|,
name|void
modifier|*
name|cl
parameter_list|)
block|{
name|struct
name|cxgb_cache_pcpu
modifier|*
name|ccp
decl_stmt|;
name|int
name|err
init|=
name|ENOSPC
decl_stmt|;
if|if
condition|(
name|cxgb_pcpu_cache_enable
condition|)
block|{
name|critical_enter
argument_list|()
expr_stmt|;
name|ccp
operator|=
operator|&
name|cxgb_caches
operator|->
name|ccs_array
index|[
name|curcpu
index|]
expr_stmt|;
if|if
condition|(
name|zone
operator|==
name|zone_clust
condition|)
block|{
name|err
operator|=
name|buf_stack_push
argument_list|(
operator|&
name|ccp
operator|->
name|ccp_cluster_free
argument_list|,
name|cl
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|zone
operator|==
name|ccp
operator|->
name|ccp_jumbo_zone
condition|)
block|{
name|err
operator|=
name|buf_stack_push
argument_list|(
operator|&
name|ccp
operator|->
name|ccp_jumbo_free
argument_list|,
name|cl
argument_list|)
expr_stmt|;
block|}
name|critical_exit
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|err
condition|)
name|uma_zfree
argument_list|(
name|zone
argument_list|,
name|cl
argument_list|)
expr_stmt|;
else|else
name|cxgb_cached
operator|++
expr_stmt|;
block|}
end_function

begin_function
name|void
name|cxgb_cache_refill
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|cxgb_cache_pcpu
modifier|*
name|ccp
decl_stmt|;
name|caddr_t
name|vec
index|[
literal|8
index|]
decl_stmt|;
name|uma_zone_t
name|zone
decl_stmt|;
name|int
name|i
decl_stmt|,
name|count
decl_stmt|;
return|return;
name|restart
label|:
name|critical_enter
argument_list|()
expr_stmt|;
name|ccp
operator|=
operator|&
name|cxgb_caches
operator|->
name|ccs_array
index|[
name|curcpu
index|]
expr_stmt|;
name|zone
operator|=
name|ccp
operator|->
name|ccp_jumbo_zone
expr_stmt|;
if|if
condition|(
operator|!
name|buf_stack_avail
argument_list|(
operator|&
name|ccp
operator|->
name|ccp_jumbo_free
argument_list|)
operator|&&
operator|!
name|buf_stack_avail
argument_list|(
operator|&
name|ccp
operator|->
name|ccp_cluster_free
argument_list|)
condition|)
block|{
name|critical_exit
argument_list|()
expr_stmt|;
return|return;
block|}
name|critical_exit
argument_list|()
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
if|if
condition|(
operator|(
name|vec
index|[
name|i
index|]
operator|=
name|uma_zalloc
argument_list|(
name|zone
argument_list|,
name|M_NOWAIT
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|free
goto|;
name|critical_enter
argument_list|()
expr_stmt|;
name|ccp
operator|=
operator|&
name|cxgb_caches
operator|->
name|ccs_array
index|[
name|curcpu
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
operator|&&
name|buf_stack_avail
argument_list|(
operator|&
name|ccp
operator|->
name|ccp_jumbo_free
argument_list|)
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|buf_stack_push
argument_list|(
operator|&
name|ccp
operator|->
name|ccp_jumbo_free
argument_list|,
name|vec
index|[
name|i
index|]
argument_list|)
condition|)
break|break;
name|critical_exit
argument_list|()
expr_stmt|;
for|for
control|(
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
name|uma_zfree
argument_list|(
name|zone
argument_list|,
name|vec
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|zone
operator|=
name|zone_clust
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
if|if
condition|(
operator|(
name|vec
index|[
name|i
index|]
operator|=
name|uma_zalloc
argument_list|(
name|zone
argument_list|,
name|M_NOWAIT
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|free
goto|;
name|critical_enter
argument_list|()
expr_stmt|;
name|ccp
operator|=
operator|&
name|cxgb_caches
operator|->
name|ccs_array
index|[
name|curcpu
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
operator|&&
name|buf_stack_avail
argument_list|(
operator|&
name|ccp
operator|->
name|ccp_cluster_free
argument_list|)
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|buf_stack_push
argument_list|(
operator|&
name|ccp
operator|->
name|ccp_cluster_free
argument_list|,
name|vec
index|[
name|i
index|]
argument_list|)
condition|)
break|break;
name|critical_exit
argument_list|()
expr_stmt|;
for|for
control|(
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
name|uma_zfree
argument_list|(
name|zone
argument_list|,
name|vec
index|[
name|i
index|]
argument_list|)
expr_stmt|;
goto|goto
name|restart
goto|;
name|free
label|:
name|count
operator|=
name|i
expr_stmt|;
for|for
control|(
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
name|uma_zfree
argument_list|(
name|zone
argument_list|,
name|vec
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|struct
name|buf_ring
modifier|*
name|buf_ring_alloc
parameter_list|(
name|int
name|count
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
name|struct
name|buf_ring
modifier|*
name|br
decl_stmt|;
name|KASSERT
argument_list|(
name|powerof2
argument_list|(
name|count
argument_list|)
argument_list|,
operator|(
literal|"buf ring must be size power of 2"
operator|)
argument_list|)
expr_stmt|;
name|br
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|buf_ring
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|flags
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|br
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|br
operator|->
name|br_ring
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|caddr_t
argument_list|)
operator|*
name|count
argument_list|,
name|M_DEVBUF
argument_list|,
name|flags
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|br
operator|->
name|br_ring
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
name|br
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|mtx_init
argument_list|(
operator|&
name|br
operator|->
name|br_lock
argument_list|,
literal|"buf ring"
argument_list|,
name|NULL
argument_list|,
name|MTX_DUPOK
operator||
name|MTX_DEF
argument_list|)
expr_stmt|;
name|br
operator|->
name|br_size
operator|=
name|count
expr_stmt|;
name|br
operator|->
name|br_prod
operator|=
name|br
operator|->
name|br_cons
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|br
operator|)
return|;
block|}
end_function

begin_function
name|void
name|buf_ring_free
parameter_list|(
name|struct
name|buf_ring
modifier|*
name|br
parameter_list|)
block|{
name|free
argument_list|(
name|br
operator|->
name|br_ring
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|br
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


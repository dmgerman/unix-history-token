begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/**************************************************************************  Copyright (c) 2007, Chelsio Inc. All rights reserved.  Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:   1. Redistributions of source code must retain the above copyright notice,     this list of conditions and the following disclaimer.   2. Neither the name of the Chelsio Corporation nor the names of its     contributors may be used to endorse or promote products derived from     this software without specific prior written permission.  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  ***************************************************************************/
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_DEFINED
end_ifdef

begin_include
include|#
directive|include
file|<common/cxgb_common.h>
end_include

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<dev/cxgb/common/cxgb_common.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_enum
enum|enum
block|{
name|ELMR_ADDR
init|=
literal|0
block|,
name|ELMR_STAT
init|=
literal|1
block|,
name|ELMR_DATA_LO
init|=
literal|2
block|,
name|ELMR_DATA_HI
init|=
literal|3
block|,
name|ELMR_MDIO_ADDR
init|=
literal|10
block|}
enum|;
end_enum

begin_define
define|#
directive|define
name|VSC_REG
parameter_list|(
name|block
parameter_list|,
name|subblock
parameter_list|,
name|reg
parameter_list|)
define|\
value|((reg) | ((subblock)<< 8) | ((block)<< 12))
end_define

begin_function
name|int
name|t3_elmr_blk_write
parameter_list|(
name|adapter_t
modifier|*
name|adap
parameter_list|,
name|int
name|start
parameter_list|,
specifier|const
name|u32
modifier|*
name|vals
parameter_list|,
name|int
name|n
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
specifier|const
name|struct
name|mdio_ops
modifier|*
name|mo
init|=
name|adapter_info
argument_list|(
name|adap
argument_list|)
operator|->
name|mdio_ops
decl_stmt|;
name|ELMR_LOCK
argument_list|(
name|adap
argument_list|)
expr_stmt|;
name|ret
operator|=
name|mo
operator|->
name|write
argument_list|(
name|adap
argument_list|,
name|ELMR_MDIO_ADDR
argument_list|,
literal|0
argument_list|,
name|ELMR_ADDR
argument_list|,
name|start
argument_list|)
expr_stmt|;
for|for
control|(
init|;
operator|!
name|ret
operator|&&
name|n
condition|;
name|n
operator|--
operator|,
name|vals
operator|++
control|)
block|{
name|ret
operator|=
name|mo
operator|->
name|write
argument_list|(
name|adap
argument_list|,
name|ELMR_MDIO_ADDR
argument_list|,
literal|0
argument_list|,
name|ELMR_DATA_LO
argument_list|,
operator|*
name|vals
operator|&
literal|0xffff
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
name|ret
operator|=
name|mo
operator|->
name|write
argument_list|(
name|adap
argument_list|,
name|ELMR_MDIO_ADDR
argument_list|,
literal|0
argument_list|,
name|ELMR_DATA_HI
argument_list|,
operator|*
name|vals
operator|>>
literal|16
argument_list|)
expr_stmt|;
block|}
name|ELMR_UNLOCK
argument_list|(
name|adap
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|elmr_write
parameter_list|(
name|adapter_t
modifier|*
name|adap
parameter_list|,
name|int
name|addr
parameter_list|,
name|u32
name|val
parameter_list|)
block|{
return|return
name|t3_elmr_blk_write
argument_list|(
name|adap
argument_list|,
name|addr
argument_list|,
operator|&
name|val
argument_list|,
literal|1
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|t3_elmr_blk_read
parameter_list|(
name|adapter_t
modifier|*
name|adap
parameter_list|,
name|int
name|start
parameter_list|,
name|u32
modifier|*
name|vals
parameter_list|,
name|int
name|n
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|unsigned
name|int
name|v
decl_stmt|;
specifier|const
name|struct
name|mdio_ops
modifier|*
name|mo
init|=
name|adapter_info
argument_list|(
name|adap
argument_list|)
operator|->
name|mdio_ops
decl_stmt|;
name|ELMR_LOCK
argument_list|(
name|adap
argument_list|)
expr_stmt|;
name|ret
operator|=
name|mo
operator|->
name|write
argument_list|(
name|adap
argument_list|,
name|ELMR_MDIO_ADDR
argument_list|,
literal|0
argument_list|,
name|ELMR_ADDR
argument_list|,
name|start
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|ret
operator|=
name|mo
operator|->
name|read
argument_list|(
name|adap
argument_list|,
name|ELMR_MDIO_ADDR
argument_list|,
literal|0
argument_list|,
name|ELMR_STAT
argument_list|,
operator|&
name|v
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
name|v
operator|!=
literal|1
condition|)
block|{
name|ret
operator|=
operator|-
name|ETIMEDOUT
expr_stmt|;
goto|goto
name|out
goto|;
block|}
for|for
control|(
init|;
operator|!
name|ret
operator|&&
name|n
condition|;
name|n
operator|--
operator|,
name|vals
operator|++
control|)
block|{
name|ret
operator|=
name|mo
operator|->
name|read
argument_list|(
name|adap
argument_list|,
name|ELMR_MDIO_ADDR
argument_list|,
literal|0
argument_list|,
name|ELMR_DATA_LO
argument_list|,
name|vals
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
block|{
name|ret
operator|=
name|mo
operator|->
name|read
argument_list|(
name|adap
argument_list|,
name|ELMR_MDIO_ADDR
argument_list|,
literal|0
argument_list|,
name|ELMR_DATA_HI
argument_list|,
operator|&
name|v
argument_list|)
expr_stmt|;
operator|*
name|vals
operator||=
name|v
operator|<<
literal|16
expr_stmt|;
block|}
block|}
name|out
label|:
name|ELMR_UNLOCK
argument_list|(
name|adap
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|t3_vsc7323_init
parameter_list|(
name|adapter_t
modifier|*
name|adap
parameter_list|,
name|int
name|nports
parameter_list|)
block|{
specifier|static
name|struct
name|addr_val_pair
name|sys_avp
index|[]
init|=
block|{
block|{
name|VSC_REG
argument_list|(
literal|7
argument_list|,
literal|15
argument_list|,
literal|0xf
argument_list|)
block|,
literal|2
block|}
block|,
block|{
name|VSC_REG
argument_list|(
literal|7
argument_list|,
literal|15
argument_list|,
literal|0x19
argument_list|)
block|,
literal|0xd6
block|}
block|,
block|{
name|VSC_REG
argument_list|(
literal|7
argument_list|,
literal|15
argument_list|,
literal|7
argument_list|)
block|,
literal|0xc
block|}
block|,
block|{
name|VSC_REG
argument_list|(
literal|7
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
block|,
literal|0x220
block|}
block|, 	}
decl_stmt|;
specifier|static
name|struct
name|addr_val_pair
name|fifo_avp
index|[]
init|=
block|{
block|{
name|VSC_REG
argument_list|(
literal|2
argument_list|,
literal|0
argument_list|,
literal|0x2f
argument_list|)
block|,
literal|0
block|}
block|,
block|{
name|VSC_REG
argument_list|(
literal|2
argument_list|,
literal|0
argument_list|,
literal|0xf
argument_list|)
block|,
literal|0xa0010291
block|}
block|,
block|{
name|VSC_REG
argument_list|(
literal|2
argument_list|,
literal|1
argument_list|,
literal|0x2f
argument_list|)
block|,
literal|1
block|}
block|,
block|{
name|VSC_REG
argument_list|(
literal|2
argument_list|,
literal|1
argument_list|,
literal|0xf
argument_list|)
block|,
literal|0xa026301
block|}
block|}
decl_stmt|;
specifier|static
name|struct
name|addr_val_pair
name|xg_avp
index|[]
init|=
block|{
block|{
name|VSC_REG
argument_list|(
literal|1
argument_list|,
literal|10
argument_list|,
literal|0
argument_list|)
block|,
literal|0x600b
block|}
block|,
block|{
name|VSC_REG
argument_list|(
literal|1
argument_list|,
literal|10
argument_list|,
literal|1
argument_list|)
block|,
literal|0x70600
block|}
block|,
comment|//QUANTA = 96*1024*8/512
block|{
name|VSC_REG
argument_list|(
literal|1
argument_list|,
literal|10
argument_list|,
literal|2
argument_list|)
block|,
literal|0x2710
block|}
block|,
block|{
name|VSC_REG
argument_list|(
literal|1
argument_list|,
literal|10
argument_list|,
literal|5
argument_list|)
block|,
literal|0x65
block|}
block|,
block|{
name|VSC_REG
argument_list|(
literal|1
argument_list|,
literal|10
argument_list|,
literal|7
argument_list|)
block|,
literal|0x23
block|}
block|,
block|{
name|VSC_REG
argument_list|(
literal|1
argument_list|,
literal|10
argument_list|,
literal|0x23
argument_list|)
block|,
literal|0x800007bf
block|}
block|,
block|{
name|VSC_REG
argument_list|(
literal|1
argument_list|,
literal|10
argument_list|,
literal|0x23
argument_list|)
block|,
literal|0x000007bf
block|}
block|,
block|{
name|VSC_REG
argument_list|(
literal|1
argument_list|,
literal|10
argument_list|,
literal|0x23
argument_list|)
block|,
literal|0x800007bf
block|}
block|,
block|{
name|VSC_REG
argument_list|(
literal|1
argument_list|,
literal|10
argument_list|,
literal|0x24
argument_list|)
block|,
literal|4
block|}
block|}
decl_stmt|;
name|int
name|i
decl_stmt|,
name|ret
decl_stmt|,
name|ing_step
decl_stmt|,
name|egr_step
decl_stmt|,
name|ing_bot
decl_stmt|,
name|egr_bot
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ARRAY_SIZE
argument_list|(
name|sys_avp
argument_list|)
condition|;
name|i
operator|++
control|)
if|if
condition|(
operator|(
name|ret
operator|=
name|t3_elmr_blk_write
argument_list|(
name|adap
argument_list|,
name|sys_avp
index|[
name|i
index|]
operator|.
name|reg_addr
argument_list|,
operator|&
name|sys_avp
index|[
name|i
index|]
operator|.
name|val
argument_list|,
literal|1
argument_list|)
operator|)
condition|)
return|return
name|ret
return|;
name|ing_step
operator|=
literal|0xc0
operator|/
name|nports
expr_stmt|;
name|egr_step
operator|=
literal|0x40
operator|/
name|nports
expr_stmt|;
name|ing_bot
operator|=
name|egr_bot
operator|=
literal|0
expr_stmt|;
comment|//	ing_wm = ing_step * 64;
comment|//	egr_wm = egr_step * 64;
comment|/* {ING,EGR}_CONTROL.CLR = 1 here */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nports
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|ret
operator|=
name|elmr_write
argument_list|(
name|adap
argument_list|,
name|VSC_REG
argument_list|(
literal|2
argument_list|,
literal|0
argument_list|,
literal|0x10
operator|+
name|i
argument_list|)
argument_list|,
operator|(
operator|(
name|ing_bot
operator|+
name|ing_step
operator|)
operator|<<
literal|16
operator|)
operator||
name|ing_bot
argument_list|)
operator|)
operator|||
operator|(
name|ret
operator|=
name|elmr_write
argument_list|(
name|adap
argument_list|,
name|VSC_REG
argument_list|(
literal|2
argument_list|,
literal|0
argument_list|,
literal|0x40
operator|+
name|i
argument_list|)
argument_list|,
literal|0x6000a00
argument_list|)
operator|)
operator|||
operator|(
name|ret
operator|=
name|elmr_write
argument_list|(
name|adap
argument_list|,
name|VSC_REG
argument_list|(
literal|2
argument_list|,
literal|0
argument_list|,
literal|0x50
operator|+
name|i
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|)
operator|||
operator|(
name|ret
operator|=
name|elmr_write
argument_list|(
name|adap
argument_list|,
name|VSC_REG
argument_list|(
literal|2
argument_list|,
literal|1
argument_list|,
literal|0x10
operator|+
name|i
argument_list|)
argument_list|,
operator|(
operator|(
name|egr_bot
operator|+
name|egr_step
operator|)
operator|<<
literal|16
operator|)
operator||
name|egr_bot
argument_list|)
operator|)
operator|||
operator|(
name|ret
operator|=
name|elmr_write
argument_list|(
name|adap
argument_list|,
name|VSC_REG
argument_list|(
literal|2
argument_list|,
literal|1
argument_list|,
literal|0x40
operator|+
name|i
argument_list|)
argument_list|,
literal|0x2000280
argument_list|)
operator|)
operator|||
operator|(
name|ret
operator|=
name|elmr_write
argument_list|(
name|adap
argument_list|,
name|VSC_REG
argument_list|(
literal|2
argument_list|,
literal|1
argument_list|,
literal|0x50
operator|+
name|i
argument_list|)
argument_list|,
literal|0
argument_list|)
operator|)
condition|)
return|return
name|ret
return|;
name|ing_bot
operator|+=
name|ing_step
expr_stmt|;
name|egr_bot
operator|+=
name|egr_step
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ARRAY_SIZE
argument_list|(
name|fifo_avp
argument_list|)
condition|;
name|i
operator|++
control|)
if|if
condition|(
operator|(
name|ret
operator|=
name|t3_elmr_blk_write
argument_list|(
name|adap
argument_list|,
name|fifo_avp
index|[
name|i
index|]
operator|.
name|reg_addr
argument_list|,
operator|&
name|fifo_avp
index|[
name|i
index|]
operator|.
name|val
argument_list|,
literal|1
argument_list|)
operator|)
condition|)
return|return
name|ret
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ARRAY_SIZE
argument_list|(
name|xg_avp
argument_list|)
condition|;
name|i
operator|++
control|)
if|if
condition|(
operator|(
name|ret
operator|=
name|t3_elmr_blk_write
argument_list|(
name|adap
argument_list|,
name|xg_avp
index|[
name|i
index|]
operator|.
name|reg_addr
argument_list|,
operator|&
name|xg_avp
index|[
name|i
index|]
operator|.
name|val
argument_list|,
literal|1
argument_list|)
operator|)
condition|)
return|return
name|ret
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nports
condition|;
name|i
operator|++
control|)
if|if
condition|(
operator|(
name|ret
operator|=
name|elmr_write
argument_list|(
name|adap
argument_list|,
name|VSC_REG
argument_list|(
literal|1
argument_list|,
name|i
argument_list|,
literal|0
argument_list|)
argument_list|,
literal|0xa59c
argument_list|)
operator|)
operator|||
operator|(
name|ret
operator|=
name|elmr_write
argument_list|(
name|adap
argument_list|,
name|VSC_REG
argument_list|(
literal|1
argument_list|,
name|i
argument_list|,
literal|5
argument_list|)
argument_list|,
operator|(
name|i
operator|<<
literal|12
operator|)
operator||
literal|0x63
argument_list|)
operator|)
operator|||
operator|(
name|ret
operator|=
name|elmr_write
argument_list|(
name|adap
argument_list|,
name|VSC_REG
argument_list|(
literal|1
argument_list|,
name|i
argument_list|,
literal|0xb
argument_list|)
argument_list|,
literal|0x96
argument_list|)
operator|)
operator|||
operator|(
name|ret
operator|=
name|elmr_write
argument_list|(
name|adap
argument_list|,
name|VSC_REG
argument_list|(
literal|1
argument_list|,
name|i
argument_list|,
literal|0x15
argument_list|)
argument_list|,
literal|0x21
argument_list|)
operator|)
condition|)
return|return
name|ret
return|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|t3_vsc7323_set_speed_fc
parameter_list|(
name|adapter_t
modifier|*
name|adap
parameter_list|,
name|int
name|speed
parameter_list|,
name|int
name|fc
parameter_list|,
name|int
name|port
parameter_list|)
block|{
name|int
name|mode
decl_stmt|,
name|clk
decl_stmt|,
name|r
decl_stmt|;
if|if
condition|(
name|speed
operator|>=
literal|0
condition|)
block|{
if|if
condition|(
name|speed
operator|==
name|SPEED_10
condition|)
name|mode
operator|=
name|clk
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|speed
operator|==
name|SPEED_100
condition|)
name|mode
operator|=
literal|1
operator|,
name|clk
operator|=
literal|2
expr_stmt|;
elseif|else
if|if
condition|(
name|speed
operator|==
name|SPEED_1000
condition|)
name|mode
operator|=
name|clk
operator|=
literal|3
expr_stmt|;
else|else
return|return
operator|-
name|EINVAL
return|;
if|if
condition|(
operator|(
name|r
operator|=
name|elmr_write
argument_list|(
name|adap
argument_list|,
name|VSC_REG
argument_list|(
literal|1
argument_list|,
name|port
argument_list|,
literal|0
argument_list|)
argument_list|,
literal|0xa590
operator||
operator|(
name|mode
operator|<<
literal|2
operator|)
argument_list|)
operator|)
operator|||
operator|(
name|r
operator|=
name|elmr_write
argument_list|(
name|adap
argument_list|,
name|VSC_REG
argument_list|(
literal|1
argument_list|,
name|port
argument_list|,
literal|0xb
argument_list|)
argument_list|,
literal|0x91
operator||
operator|(
name|clk
operator|<<
literal|1
operator|)
argument_list|)
operator|)
operator|||
operator|(
name|r
operator|=
name|elmr_write
argument_list|(
name|adap
argument_list|,
name|VSC_REG
argument_list|(
literal|1
argument_list|,
name|port
argument_list|,
literal|0xb
argument_list|)
argument_list|,
literal|0x90
operator||
operator|(
name|clk
operator|<<
literal|1
operator|)
argument_list|)
operator|)
operator|||
operator|(
name|r
operator|=
name|elmr_write
argument_list|(
name|adap
argument_list|,
name|VSC_REG
argument_list|(
literal|1
argument_list|,
name|port
argument_list|,
literal|0
argument_list|)
argument_list|,
literal|0xa593
operator||
operator|(
name|mode
operator|<<
literal|2
operator|)
argument_list|)
operator|)
condition|)
return|return
name|r
return|;
block|}
name|r
operator|=
operator|(
name|fc
operator|&
name|PAUSE_RX
operator|)
condition|?
literal|0x60200
else|:
literal|0x20200
expr_stmt|;
comment|//QUANTA = 32*1024*8/512
if|if
condition|(
name|fc
operator|&
name|PAUSE_TX
condition|)
name|r
operator||=
operator|(
literal|1
operator|<<
literal|19
operator|)
expr_stmt|;
return|return
name|elmr_write
argument_list|(
name|adap
argument_list|,
name|VSC_REG
argument_list|(
literal|1
argument_list|,
name|port
argument_list|,
literal|1
argument_list|)
argument_list|,
name|r
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|t3_vsc7323_set_mtu
parameter_list|(
name|adapter_t
modifier|*
name|adap
parameter_list|,
name|unsigned
name|int
name|mtu
parameter_list|,
name|int
name|port
parameter_list|)
block|{
return|return
name|elmr_write
argument_list|(
name|adap
argument_list|,
name|VSC_REG
argument_list|(
literal|1
argument_list|,
name|port
argument_list|,
literal|2
argument_list|)
argument_list|,
name|mtu
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|t3_vsc7323_set_addr
parameter_list|(
name|adapter_t
modifier|*
name|adap
parameter_list|,
name|u8
name|addr
index|[
literal|6
index|]
parameter_list|,
name|int
name|port
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|elmr_write
argument_list|(
name|adap
argument_list|,
name|VSC_REG
argument_list|(
literal|1
argument_list|,
name|port
argument_list|,
literal|3
argument_list|)
argument_list|,
operator|(
name|addr
index|[
literal|0
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
name|addr
index|[
literal|1
index|]
operator|<<
literal|8
operator|)
operator||
name|addr
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
name|ret
operator|=
name|elmr_write
argument_list|(
name|adap
argument_list|,
name|VSC_REG
argument_list|(
literal|1
argument_list|,
name|port
argument_list|,
literal|4
argument_list|)
argument_list|,
operator|(
name|addr
index|[
literal|3
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
name|addr
index|[
literal|4
index|]
operator|<<
literal|8
operator|)
operator||
name|addr
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|t3_vsc7323_enable
parameter_list|(
name|adapter_t
modifier|*
name|adap
parameter_list|,
name|int
name|port
parameter_list|,
name|int
name|which
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|unsigned
name|int
name|v
decl_stmt|,
name|orig
decl_stmt|;
name|ret
operator|=
name|t3_elmr_blk_read
argument_list|(
name|adap
argument_list|,
name|VSC_REG
argument_list|(
literal|1
argument_list|,
name|port
argument_list|,
literal|0
argument_list|)
argument_list|,
operator|&
name|v
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
block|{
name|orig
operator|=
name|v
expr_stmt|;
if|if
condition|(
name|which
operator|&
name|MAC_DIRECTION_TX
condition|)
name|v
operator||=
literal|1
expr_stmt|;
if|if
condition|(
name|which
operator|&
name|MAC_DIRECTION_RX
condition|)
name|v
operator||=
literal|2
expr_stmt|;
if|if
condition|(
name|v
operator|!=
name|orig
condition|)
name|ret
operator|=
name|elmr_write
argument_list|(
name|adap
argument_list|,
name|VSC_REG
argument_list|(
literal|1
argument_list|,
name|port
argument_list|,
literal|0
argument_list|)
argument_list|,
name|v
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|t3_vsc7323_disable
parameter_list|(
name|adapter_t
modifier|*
name|adap
parameter_list|,
name|int
name|port
parameter_list|,
name|int
name|which
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|unsigned
name|int
name|v
decl_stmt|,
name|orig
decl_stmt|;
name|ret
operator|=
name|t3_elmr_blk_read
argument_list|(
name|adap
argument_list|,
name|VSC_REG
argument_list|(
literal|1
argument_list|,
name|port
argument_list|,
literal|0
argument_list|)
argument_list|,
operator|&
name|v
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
block|{
name|orig
operator|=
name|v
expr_stmt|;
if|if
condition|(
name|which
operator|&
name|MAC_DIRECTION_TX
condition|)
name|v
operator|&=
operator|~
literal|1
expr_stmt|;
if|if
condition|(
name|which
operator|&
name|MAC_DIRECTION_RX
condition|)
name|v
operator|&=
operator|~
literal|2
expr_stmt|;
if|if
condition|(
name|v
operator|!=
name|orig
condition|)
name|ret
operator|=
name|elmr_write
argument_list|(
name|adap
argument_list|,
name|VSC_REG
argument_list|(
literal|1
argument_list|,
name|port
argument_list|,
literal|0
argument_list|)
argument_list|,
name|v
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_define
define|#
directive|define
name|STATS0_START
value|1
end_define

begin_define
define|#
directive|define
name|STATS1_START
value|0x24
end_define

begin_define
define|#
directive|define
name|NSTATS0
value|(0x1d - STATS0_START + 1)
end_define

begin_define
define|#
directive|define
name|NSTATS1
value|(0x2a - STATS1_START + 1)
end_define

begin_function
specifier|const
name|struct
name|mac_stats
modifier|*
name|t3_vsc7323_update_stats
parameter_list|(
name|struct
name|cmac
modifier|*
name|mac
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|u64
name|rx_ucast
decl_stmt|,
name|tx_ucast
decl_stmt|;
name|u32
name|stats0
index|[
name|NSTATS0
index|]
decl_stmt|,
name|stats1
index|[
name|NSTATS1
index|]
decl_stmt|;
name|ret
operator|=
name|t3_elmr_blk_read
argument_list|(
name|mac
operator|->
name|adapter
argument_list|,
name|VSC_REG
argument_list|(
literal|4
argument_list|,
name|mac
operator|->
name|ext_port
argument_list|,
name|STATS0_START
argument_list|)
argument_list|,
name|stats0
argument_list|,
name|NSTATS0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
name|ret
operator|=
name|t3_elmr_blk_read
argument_list|(
name|mac
operator|->
name|adapter
argument_list|,
name|VSC_REG
argument_list|(
literal|4
argument_list|,
name|mac
operator|->
name|ext_port
argument_list|,
name|STATS1_START
argument_list|)
argument_list|,
name|stats1
argument_list|,
name|NSTATS1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
comment|/* 	 * HW counts Rx/Tx unicast frames but we want all the frames. 	 */
name|rx_ucast
operator|=
name|mac
operator|->
name|stats
operator|.
name|rx_frames
operator|-
name|mac
operator|->
name|stats
operator|.
name|rx_mcast_frames
operator|-
name|mac
operator|->
name|stats
operator|.
name|rx_bcast_frames
expr_stmt|;
name|rx_ucast
operator|+=
call|(
name|u64
call|)
argument_list|(
name|stats0
index|[
literal|6
operator|-
name|STATS0_START
index|]
operator|-
operator|(
name|u32
operator|)
name|rx_ucast
argument_list|)
expr_stmt|;
name|tx_ucast
operator|=
name|mac
operator|->
name|stats
operator|.
name|tx_frames
operator|-
name|mac
operator|->
name|stats
operator|.
name|tx_mcast_frames
operator|-
name|mac
operator|->
name|stats
operator|.
name|tx_bcast_frames
expr_stmt|;
name|tx_ucast
operator|+=
call|(
name|u64
call|)
argument_list|(
name|stats0
index|[
literal|27
operator|-
name|STATS0_START
index|]
operator|-
operator|(
name|u32
operator|)
name|tx_ucast
argument_list|)
expr_stmt|;
define|#
directive|define
name|RMON_UPDATE
parameter_list|(
name|mac
parameter_list|,
name|name
parameter_list|,
name|hw_stat
parameter_list|)
define|\
value|mac->stats.name += (u64)((hw_stat) - (u32)(mac->stats.name))
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|rx_octets
argument_list|,
name|stats0
index|[
literal|4
operator|-
name|STATS0_START
index|]
argument_list|)
expr_stmt|;
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|rx_frames
argument_list|,
name|stats0
index|[
literal|6
operator|-
name|STATS0_START
index|]
argument_list|)
expr_stmt|;
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|rx_frames
argument_list|,
name|stats0
index|[
literal|7
operator|-
name|STATS0_START
index|]
argument_list|)
expr_stmt|;
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|rx_frames
argument_list|,
name|stats0
index|[
literal|8
operator|-
name|STATS0_START
index|]
argument_list|)
expr_stmt|;
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|rx_mcast_frames
argument_list|,
name|stats0
index|[
literal|7
operator|-
name|STATS0_START
index|]
argument_list|)
expr_stmt|;
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|rx_bcast_frames
argument_list|,
name|stats0
index|[
literal|8
operator|-
name|STATS0_START
index|]
argument_list|)
expr_stmt|;
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|rx_fcs_errs
argument_list|,
name|stats0
index|[
literal|9
operator|-
name|STATS0_START
index|]
argument_list|)
expr_stmt|;
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|rx_pause
argument_list|,
name|stats0
index|[
literal|2
operator|-
name|STATS0_START
index|]
argument_list|)
expr_stmt|;
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|rx_jabber
argument_list|,
name|stats0
index|[
literal|16
operator|-
name|STATS0_START
index|]
argument_list|)
expr_stmt|;
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|rx_short
argument_list|,
name|stats0
index|[
literal|11
operator|-
name|STATS0_START
index|]
argument_list|)
expr_stmt|;
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|rx_symbol_errs
argument_list|,
name|stats0
index|[
literal|1
operator|-
name|STATS0_START
index|]
argument_list|)
expr_stmt|;
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|rx_too_long
argument_list|,
name|stats0
index|[
literal|15
operator|-
name|STATS0_START
index|]
argument_list|)
expr_stmt|;
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|rx_frames_64
argument_list|,
name|stats0
index|[
literal|17
operator|-
name|STATS0_START
index|]
argument_list|)
expr_stmt|;
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|rx_frames_65_127
argument_list|,
name|stats0
index|[
literal|18
operator|-
name|STATS0_START
index|]
argument_list|)
expr_stmt|;
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|rx_frames_128_255
argument_list|,
name|stats0
index|[
literal|19
operator|-
name|STATS0_START
index|]
argument_list|)
expr_stmt|;
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|rx_frames_256_511
argument_list|,
name|stats0
index|[
literal|20
operator|-
name|STATS0_START
index|]
argument_list|)
expr_stmt|;
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|rx_frames_512_1023
argument_list|,
name|stats0
index|[
literal|21
operator|-
name|STATS0_START
index|]
argument_list|)
expr_stmt|;
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|rx_frames_1024_1518
argument_list|,
name|stats0
index|[
literal|22
operator|-
name|STATS0_START
index|]
argument_list|)
expr_stmt|;
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|rx_frames_1519_max
argument_list|,
name|stats0
index|[
literal|23
operator|-
name|STATS0_START
index|]
argument_list|)
expr_stmt|;
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|tx_octets
argument_list|,
name|stats0
index|[
literal|26
operator|-
name|STATS0_START
index|]
argument_list|)
expr_stmt|;
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|tx_frames
argument_list|,
name|stats0
index|[
literal|27
operator|-
name|STATS0_START
index|]
argument_list|)
expr_stmt|;
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|tx_frames
argument_list|,
name|stats0
index|[
literal|28
operator|-
name|STATS0_START
index|]
argument_list|)
expr_stmt|;
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|tx_frames
argument_list|,
name|stats0
index|[
literal|29
operator|-
name|STATS0_START
index|]
argument_list|)
expr_stmt|;
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|tx_mcast_frames
argument_list|,
name|stats0
index|[
literal|28
operator|-
name|STATS0_START
index|]
argument_list|)
expr_stmt|;
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|tx_bcast_frames
argument_list|,
name|stats0
index|[
literal|29
operator|-
name|STATS0_START
index|]
argument_list|)
expr_stmt|;
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|tx_pause
argument_list|,
name|stats0
index|[
literal|25
operator|-
name|STATS0_START
index|]
argument_list|)
expr_stmt|;
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|tx_underrun
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|tx_frames_64
argument_list|,
name|stats1
index|[
literal|36
operator|-
name|STATS1_START
index|]
argument_list|)
expr_stmt|;
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|tx_frames_65_127
argument_list|,
name|stats1
index|[
literal|37
operator|-
name|STATS1_START
index|]
argument_list|)
expr_stmt|;
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|tx_frames_128_255
argument_list|,
name|stats1
index|[
literal|38
operator|-
name|STATS1_START
index|]
argument_list|)
expr_stmt|;
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|tx_frames_256_511
argument_list|,
name|stats1
index|[
literal|39
operator|-
name|STATS1_START
index|]
argument_list|)
expr_stmt|;
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|tx_frames_512_1023
argument_list|,
name|stats1
index|[
literal|40
operator|-
name|STATS1_START
index|]
argument_list|)
expr_stmt|;
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|tx_frames_1024_1518
argument_list|,
name|stats1
index|[
literal|41
operator|-
name|STATS1_START
index|]
argument_list|)
expr_stmt|;
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|tx_frames_1519_max
argument_list|,
name|stats1
index|[
literal|42
operator|-
name|STATS1_START
index|]
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|RMON_UPDATE
name|mac
operator|->
name|stats
operator|.
name|rx_frames
operator|=
name|rx_ucast
operator|+
name|mac
operator|->
name|stats
operator|.
name|rx_mcast_frames
operator|+
name|mac
operator|->
name|stats
operator|.
name|rx_bcast_frames
expr_stmt|;
name|mac
operator|->
name|stats
operator|.
name|tx_frames
operator|=
name|tx_ucast
operator|+
name|mac
operator|->
name|stats
operator|.
name|tx_mcast_frames
operator|+
name|mac
operator|->
name|stats
operator|.
name|tx_bcast_frames
expr_stmt|;
name|out
label|:
return|return
operator|&
name|mac
operator|->
name|stats
return|;
block|}
end_function

end_unit


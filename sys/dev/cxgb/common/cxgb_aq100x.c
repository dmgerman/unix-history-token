begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/**************************************************************************  Copyright (c) 2009 Chelsio Inc. All rights reserved.  Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:   1. Redistributions of source code must retain the above copyright notice,     this list of conditions and the following disclaimer.   2. Neither the name of the Chelsio Corporation nor the names of its     contributors may be used to endorse or promote products derived from     this software without specific prior written permission.  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  ***************************************************************************/
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<cxgb_include.h>
end_include

begin_undef
undef|#
directive|undef
name|msleep
end_undef

begin_define
define|#
directive|define
name|msleep
value|t3_os_sleep
end_define

begin_enum
enum|enum
block|{
comment|/* MDIO_DEV_PMA_PMD registers */
name|AQ_LINK_STAT
init|=
literal|0xe800
block|,
comment|/* MDIO_DEV_XGXS registers */
name|AQ_XAUI_RX_CFG
init|=
literal|0xc400
block|,
name|AQ_XAUI_KX_CFG
init|=
literal|0xc440
block|,
name|AQ_XAUI_TX_CFG
init|=
literal|0xe400
block|,
comment|/* MDIO_DEV_ANEG registers */
name|AQ_100M_CTRL
init|=
literal|0x0010
block|,
name|AQ_10G_CTRL
init|=
literal|0x0020
block|,
name|AQ_1G_CTRL
init|=
literal|0xc400
block|,
name|AQ_ANEG_STAT
init|=
literal|0xc800
block|,
comment|/* MDIO_DEV_VEND1 registers */
name|AQ_FW_VERSION
init|=
literal|0x0020
block|,
name|AQ_THERMAL_THR
init|=
literal|0xc421
block|,
name|AQ_THERMAL1
init|=
literal|0xc820
block|,
name|AQ_THERMAL2
init|=
literal|0xc821
block|,
name|AQ_IFLAG_GLOBAL
init|=
literal|0xfc00
block|,
name|AQ_IMASK_GLOBAL
init|=
literal|0xff00
block|, }
enum|;
end_enum

begin_define
define|#
directive|define
name|AQBIT
parameter_list|(
name|x
parameter_list|)
value|(1<< (0x##x))
end_define

begin_define
define|#
directive|define
name|ADV_1G_FULL
value|AQBIT(f)
end_define

begin_define
define|#
directive|define
name|ADV_1G_HALF
value|AQBIT(e)
end_define

begin_define
define|#
directive|define
name|ADV_10G_FULL
value|AQBIT(c)
end_define

begin_define
define|#
directive|define
name|AQ_WRITE_REGS
parameter_list|(
name|phy
parameter_list|,
name|regs
parameter_list|)
value|do { \ 	int i; \ 	for (i = 0; i< ARRAY_SIZE(regs); i++) { \ 		(void) mdio_write(phy, regs[i].mmd, regs[i].reg, regs[i].val); \ 	} \ } while (0)
end_define

begin_define
define|#
directive|define
name|AQ_READ_REGS
parameter_list|(
name|phy
parameter_list|,
name|regs
parameter_list|)
value|do { \ 	unsigned i, v; \ 	for (i = 0; i< ARRAY_SIZE(regs); i++) { \ 		(void) mdio_read(phy, regs[i].mmd, regs[i].reg,&v); \ 	} \ } while (0)
end_define

begin_comment
comment|/*  * Return value is temperature in celcius, 0xffff for error or don't know.  */
end_comment

begin_function
specifier|static
name|int
name|aq100x_temperature
parameter_list|(
name|struct
name|cphy
modifier|*
name|phy
parameter_list|)
block|{
name|unsigned
name|int
name|v
decl_stmt|;
if|if
condition|(
name|mdio_read
argument_list|(
name|phy
argument_list|,
name|MDIO_DEV_VEND1
argument_list|,
name|AQ_THERMAL2
argument_list|,
operator|&
name|v
argument_list|)
operator|||
name|v
operator|==
literal|0xffff
operator|||
operator|(
name|v
operator|&
literal|1
operator|)
operator|!=
literal|1
condition|)
return|return
operator|(
literal|0xffff
operator|)
return|;
if|if
condition|(
name|mdio_read
argument_list|(
name|phy
argument_list|,
name|MDIO_DEV_VEND1
argument_list|,
name|AQ_THERMAL1
argument_list|,
operator|&
name|v
argument_list|)
condition|)
return|return
operator|(
literal|0xffff
operator|)
return|;
return|return
operator|(
call|(
name|int
call|)
argument_list|(
call|(
name|signed
name|char
call|)
argument_list|(
name|v
operator|>>
literal|8
argument_list|)
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|aq100x_set_defaults
parameter_list|(
name|struct
name|cphy
modifier|*
name|phy
parameter_list|)
block|{
return|return
name|mdio_write
argument_list|(
name|phy
argument_list|,
name|MDIO_DEV_VEND1
argument_list|,
name|AQ_THERMAL_THR
argument_list|,
literal|0x6c00
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|aq100x_reset
parameter_list|(
name|struct
name|cphy
modifier|*
name|phy
parameter_list|,
name|int
name|wait
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|err
operator|=
name|t3_phy_reset
argument_list|(
name|phy
argument_list|,
name|MDIO_DEV_PMA_PMD
argument_list|,
name|wait
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|err
condition|)
name|err
operator|=
name|aq100x_set_defaults
argument_list|(
name|phy
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|aq100x_intr_enable
parameter_list|(
name|struct
name|cphy
modifier|*
name|phy
parameter_list|)
block|{
struct|struct
block|{
name|int
name|mmd
decl_stmt|;
name|int
name|reg
decl_stmt|;
name|int
name|val
decl_stmt|;
block|}
name|imasks
index|[]
init|=
block|{
block|{
name|MDIO_DEV_VEND1
block|,
literal|0xd400
block|,
name|AQBIT
argument_list|(
argument|e
argument_list|)
block|}
block|,
block|{
name|MDIO_DEV_VEND1
block|,
literal|0xff01
block|,
name|AQBIT
argument_list|(
literal|2
argument_list|)
block|}
block|,
block|{
name|MDIO_DEV_VEND1
block|,
name|AQ_IMASK_GLOBAL
block|,
name|AQBIT
argument_list|(
literal|0
argument_list|)
block|}
block|}
struct|;
name|AQ_WRITE_REGS
argument_list|(
name|phy
argument_list|,
name|imasks
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|aq100x_intr_disable
parameter_list|(
name|struct
name|cphy
modifier|*
name|phy
parameter_list|)
block|{
struct|struct
block|{
name|int
name|mmd
decl_stmt|;
name|int
name|reg
decl_stmt|;
name|int
name|val
decl_stmt|;
block|}
name|imasks
index|[]
init|=
block|{
block|{
name|MDIO_DEV_VEND1
block|,
literal|0xd400
block|,
literal|0
block|}
block|,
block|{
name|MDIO_DEV_VEND1
block|,
literal|0xff01
block|,
literal|0
block|}
block|,
block|{
name|MDIO_DEV_VEND1
block|,
name|AQ_IMASK_GLOBAL
block|,
literal|0
block|}
block|}
struct|;
name|AQ_WRITE_REGS
argument_list|(
name|phy
argument_list|,
name|imasks
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|aq100x_intr_clear
parameter_list|(
name|struct
name|cphy
modifier|*
name|phy
parameter_list|)
block|{
struct|struct
block|{
name|int
name|mmd
decl_stmt|;
name|int
name|reg
decl_stmt|;
block|}
name|iclr
index|[]
init|=
block|{
block|{
name|MDIO_DEV_VEND1
block|,
literal|0xcc00
block|}
block|,
block|{
name|MDIO_DEV_VEND1
block|,
name|AQ_IMASK_GLOBAL
block|}
comment|/* needed? */
block|}
struct|;
name|AQ_READ_REGS
argument_list|(
name|phy
argument_list|,
name|iclr
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|aq100x_vendor_intr
parameter_list|(
name|struct
name|cphy
modifier|*
name|phy
parameter_list|,
name|int
modifier|*
name|rc
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|unsigned
name|int
name|cause
decl_stmt|,
name|v
decl_stmt|;
name|err
operator|=
name|mdio_read
argument_list|(
name|phy
argument_list|,
name|MDIO_DEV_VEND1
argument_list|,
literal|0xfc01
argument_list|,
operator|&
name|cause
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
operator|(
name|err
operator|)
return|;
if|if
condition|(
name|cause
operator|&
name|AQBIT
argument_list|(
literal|2
argument_list|)
condition|)
block|{
name|err
operator|=
name|mdio_read
argument_list|(
name|phy
argument_list|,
name|MDIO_DEV_VEND1
argument_list|,
literal|0xcc00
argument_list|,
operator|&
name|v
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
operator|(
name|err
operator|)
return|;
if|if
condition|(
name|v
operator|&
name|AQBIT
argument_list|(
name|e
argument_list|)
condition|)
block|{
name|CH_WARN
argument_list|(
name|phy
operator|->
name|adapter
argument_list|,
literal|"PHY%d: temperature is now %dC\n"
argument_list|,
name|phy
operator|->
name|addr
argument_list|,
name|aq100x_temperature
argument_list|(
name|phy
argument_list|)
argument_list|)
expr_stmt|;
name|t3_set_reg_field
argument_list|(
name|phy
operator|->
name|adapter
argument_list|,
name|A_T3DBG_GPIO_EN
argument_list|,
name|phy
operator|->
name|addr
condition|?
name|F_GPIO10_OUT_VAL
else|:
name|F_GPIO6_OUT_VAL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|*
name|rc
operator||=
name|cphy_cause_alarm
expr_stmt|;
block|}
name|cause
operator|&=
operator|~
literal|4
expr_stmt|;
block|}
if|if
condition|(
name|cause
condition|)
name|CH_WARN
argument_list|(
name|phy
operator|->
name|adapter
argument_list|,
literal|"PHY%d: unhandled vendor interrupt"
literal|" (0x%x)\n"
argument_list|,
name|phy
operator|->
name|addr
argument_list|,
name|cause
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|aq100x_intr_handler
parameter_list|(
name|struct
name|cphy
modifier|*
name|phy
parameter_list|)
block|{
name|int
name|err
decl_stmt|,
name|rc
init|=
literal|0
decl_stmt|;
name|unsigned
name|int
name|cause
decl_stmt|;
name|err
operator|=
name|mdio_read
argument_list|(
name|phy
argument_list|,
name|MDIO_DEV_VEND1
argument_list|,
name|AQ_IFLAG_GLOBAL
argument_list|,
operator|&
name|cause
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
operator|(
name|err
operator|)
return|;
if|if
condition|(
name|cause
operator|&
name|AQBIT
argument_list|(
literal|0
argument_list|)
condition|)
block|{
name|err
operator|=
name|aq100x_vendor_intr
argument_list|(
name|phy
argument_list|,
operator|&
name|rc
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
operator|(
name|err
operator|)
return|;
name|cause
operator|&=
operator|~
name|AQBIT
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|cause
condition|)
name|CH_WARN
argument_list|(
name|phy
operator|->
name|adapter
argument_list|,
literal|"PHY%d: unhandled interrupt (0x%x)\n"
argument_list|,
name|phy
operator|->
name|addr
argument_list|,
name|cause
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|aq100x_power_down
parameter_list|(
name|struct
name|cphy
modifier|*
name|phy
parameter_list|,
name|int
name|off
parameter_list|)
block|{
name|int
name|err
decl_stmt|,
name|wait
init|=
literal|500
decl_stmt|;
name|unsigned
name|int
name|v
decl_stmt|;
name|err
operator|=
name|t3_mdio_change_bits
argument_list|(
name|phy
argument_list|,
name|MDIO_DEV_PMA_PMD
argument_list|,
name|MII_BMCR
argument_list|,
name|BMCR_PDOWN
argument_list|,
name|off
condition|?
name|BMCR_PDOWN
else|:
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|||
name|off
condition|)
return|return
operator|(
name|v
operator|)
return|;
name|msleep
argument_list|(
literal|300
argument_list|)
expr_stmt|;
do|do
block|{
name|err
operator|=
name|mdio_read
argument_list|(
name|phy
argument_list|,
name|MDIO_DEV_PMA_PMD
argument_list|,
name|MII_BMCR
argument_list|,
operator|&
name|v
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
operator|(
name|err
operator|)
return|;
name|v
operator|&=
name|BMCR_RESET
expr_stmt|;
if|if
condition|(
name|v
condition|)
name|msleep
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|v
operator|&&
operator|--
name|wait
condition|)
do|;
if|if
condition|(
name|v
condition|)
block|{
name|CH_WARN
argument_list|(
name|phy
operator|->
name|adapter
argument_list|,
literal|"PHY%d: power-up timed out (0x%x).\n"
argument_list|,
name|phy
operator|->
name|addr
argument_list|,
name|v
argument_list|)
expr_stmt|;
return|return
operator|(
name|ETIMEDOUT
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|aq100x_autoneg_enable
parameter_list|(
name|struct
name|cphy
modifier|*
name|phy
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|err
operator|=
name|aq100x_power_down
argument_list|(
name|phy
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|err
condition|)
name|err
operator|=
name|t3_mdio_change_bits
argument_list|(
name|phy
argument_list|,
name|MDIO_DEV_ANEG
argument_list|,
name|MII_BMCR
argument_list|,
name|BMCR_RESET
argument_list|,
name|BMCR_ANENABLE
operator||
name|BMCR_ANRESTART
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|aq100x_autoneg_restart
parameter_list|(
name|struct
name|cphy
modifier|*
name|phy
parameter_list|)
block|{
return|return
name|aq100x_autoneg_enable
argument_list|(
name|phy
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|aq100x_advertise
parameter_list|(
name|struct
name|cphy
modifier|*
name|phy
parameter_list|,
name|unsigned
name|int
name|advertise_map
parameter_list|)
block|{
name|unsigned
name|int
name|adv
decl_stmt|;
name|int
name|err
decl_stmt|;
comment|/* 10G advertisement */
name|adv
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|advertise_map
operator|&
name|ADVERTISED_10000baseT_Full
condition|)
name|adv
operator||=
name|ADV_10G_FULL
expr_stmt|;
name|err
operator|=
name|t3_mdio_change_bits
argument_list|(
name|phy
argument_list|,
name|MDIO_DEV_ANEG
argument_list|,
name|AQ_10G_CTRL
argument_list|,
name|ADV_10G_FULL
argument_list|,
name|adv
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
operator|(
name|err
operator|)
return|;
comment|/* 1G advertisement */
name|adv
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|advertise_map
operator|&
name|ADVERTISED_1000baseT_Full
condition|)
name|adv
operator||=
name|ADV_1G_FULL
expr_stmt|;
if|if
condition|(
name|advertise_map
operator|&
name|ADVERTISED_1000baseT_Half
condition|)
name|adv
operator||=
name|ADV_1G_HALF
expr_stmt|;
name|err
operator|=
name|t3_mdio_change_bits
argument_list|(
name|phy
argument_list|,
name|MDIO_DEV_ANEG
argument_list|,
name|AQ_1G_CTRL
argument_list|,
name|ADV_1G_FULL
operator||
name|ADV_1G_HALF
argument_list|,
name|adv
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
operator|(
name|err
operator|)
return|;
comment|/* 100M, pause advertisement */
name|adv
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|advertise_map
operator|&
name|ADVERTISED_100baseT_Half
condition|)
name|adv
operator||=
name|ADVERTISE_100HALF
expr_stmt|;
if|if
condition|(
name|advertise_map
operator|&
name|ADVERTISED_100baseT_Full
condition|)
name|adv
operator||=
name|ADVERTISE_100FULL
expr_stmt|;
if|if
condition|(
name|advertise_map
operator|&
name|ADVERTISED_Pause
condition|)
name|adv
operator||=
name|ADVERTISE_PAUSE_CAP
expr_stmt|;
if|if
condition|(
name|advertise_map
operator|&
name|ADVERTISED_Asym_Pause
condition|)
name|adv
operator||=
name|ADVERTISE_PAUSE_ASYM
expr_stmt|;
name|err
operator|=
name|t3_mdio_change_bits
argument_list|(
name|phy
argument_list|,
name|MDIO_DEV_ANEG
argument_list|,
name|AQ_100M_CTRL
argument_list|,
literal|0xfe0
argument_list|,
name|adv
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|aq100x_set_loopback
parameter_list|(
name|struct
name|cphy
modifier|*
name|phy
parameter_list|,
name|int
name|mmd
parameter_list|,
name|int
name|dir
parameter_list|,
name|int
name|enable
parameter_list|)
block|{
return|return
name|t3_mdio_change_bits
argument_list|(
name|phy
argument_list|,
name|MDIO_DEV_PMA_PMD
argument_list|,
name|MII_BMCR
argument_list|,
name|BMCR_LOOPBACK
argument_list|,
name|enable
condition|?
name|BMCR_LOOPBACK
else|:
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|aq100x_set_speed_duplex
parameter_list|(
name|struct
name|cphy
modifier|*
name|phy
parameter_list|,
name|int
name|speed
parameter_list|,
name|int
name|duplex
parameter_list|)
block|{
name|int
name|err
decl_stmt|,
name|set
decl_stmt|;
if|if
condition|(
name|speed
operator|==
name|SPEED_100
condition|)
name|set
operator|=
name|BMCR_SPEED100
expr_stmt|;
elseif|else
if|if
condition|(
name|speed
operator|==
name|SPEED_1000
condition|)
name|set
operator|=
name|BMCR_SPEED1000
expr_stmt|;
elseif|else
if|if
condition|(
name|speed
operator|==
name|SPEED_10000
condition|)
name|set
operator|=
name|BMCR_SPEED1000
operator||
name|BMCR_SPEED100
expr_stmt|;
else|else
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
name|duplex
operator|!=
name|DUPLEX_FULL
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|err
operator|=
name|t3_mdio_change_bits
argument_list|(
name|phy
argument_list|,
name|MDIO_DEV_ANEG
argument_list|,
name|MII_BMCR
argument_list|,
name|BMCR_RESET
operator||
name|BMCR_ANENABLE
operator||
name|BMCR_ANRESTART
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
operator|(
name|err
operator|)
return|;
name|err
operator|=
name|t3_mdio_change_bits
argument_list|(
name|phy
argument_list|,
name|MDIO_DEV_PMA_PMD
argument_list|,
name|MII_BMCR
argument_list|,
name|BMCR_SPEED1000
operator||
name|BMCR_SPEED100
argument_list|,
name|set
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
operator|(
name|err
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|aq100x_get_link_status
parameter_list|(
name|struct
name|cphy
modifier|*
name|phy
parameter_list|,
name|int
modifier|*
name|link_ok
parameter_list|,
name|int
modifier|*
name|speed
parameter_list|,
name|int
modifier|*
name|duplex
parameter_list|,
name|int
modifier|*
name|fc
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|unsigned
name|int
name|v
decl_stmt|,
name|link
init|=
literal|0
decl_stmt|;
name|err
operator|=
name|mdio_read
argument_list|(
name|phy
argument_list|,
name|MDIO_DEV_PMA_PMD
argument_list|,
name|AQ_LINK_STAT
argument_list|,
operator|&
name|v
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
operator|(
name|err
operator|)
return|;
if|if
condition|(
name|v
operator|==
literal|0xffff
operator|||
operator|!
operator|(
name|v
operator|&
literal|1
operator|)
condition|)
goto|goto
name|done
goto|;
name|err
operator|=
name|mdio_read
argument_list|(
name|phy
argument_list|,
name|MDIO_DEV_ANEG
argument_list|,
name|MII_BMCR
argument_list|,
operator|&
name|v
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
operator|(
name|err
operator|)
return|;
if|if
condition|(
name|v
operator|&
literal|0x8000
condition|)
goto|goto
name|done
goto|;
if|if
condition|(
name|v
operator|&
name|BMCR_ANENABLE
condition|)
block|{
name|err
operator|=
name|mdio_read
argument_list|(
name|phy
argument_list|,
name|MDIO_DEV_ANEG
argument_list|,
literal|1
argument_list|,
operator|&
name|v
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
operator|(
name|err
operator|)
return|;
if|if
condition|(
operator|(
name|v
operator|&
literal|0x20
operator|)
operator|==
literal|0
condition|)
goto|goto
name|done
goto|;
name|err
operator|=
name|mdio_read
argument_list|(
name|phy
argument_list|,
name|MDIO_DEV_ANEG
argument_list|,
name|AQ_ANEG_STAT
argument_list|,
operator|&
name|v
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
operator|(
name|err
operator|)
return|;
if|if
condition|(
name|speed
condition|)
block|{
switch|switch
condition|(
name|v
operator|&
literal|0x6
condition|)
block|{
case|case
literal|0x6
case|:
operator|*
name|speed
operator|=
name|SPEED_10000
expr_stmt|;
break|break;
case|case
literal|0x4
case|:
operator|*
name|speed
operator|=
name|SPEED_1000
expr_stmt|;
break|break;
case|case
literal|0x2
case|:
operator|*
name|speed
operator|=
name|SPEED_100
expr_stmt|;
break|break;
case|case
literal|0x0
case|:
operator|*
name|speed
operator|=
name|SPEED_10
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|duplex
condition|)
operator|*
name|duplex
operator|=
name|v
operator|&
literal|1
condition|?
name|DUPLEX_FULL
else|:
name|DUPLEX_HALF
expr_stmt|;
if|if
condition|(
name|fc
condition|)
block|{
name|unsigned
name|int
name|lpa
decl_stmt|,
name|adv
decl_stmt|;
name|err
operator|=
name|mdio_read
argument_list|(
name|phy
argument_list|,
name|MDIO_DEV_ANEG
argument_list|,
literal|0x13
argument_list|,
operator|&
name|lpa
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|err
condition|)
name|err
operator|=
name|mdio_read
argument_list|(
name|phy
argument_list|,
name|MDIO_DEV_ANEG
argument_list|,
name|AQ_100M_CTRL
argument_list|,
operator|&
name|adv
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
if|if
condition|(
name|lpa
operator|&
name|adv
operator|&
name|ADVERTISE_PAUSE_CAP
condition|)
operator|*
name|fc
operator|=
name|PAUSE_RX
operator||
name|PAUSE_TX
expr_stmt|;
elseif|else
if|if
condition|(
name|lpa
operator|&
name|ADVERTISE_PAUSE_CAP
operator|&&
name|lpa
operator|&
name|ADVERTISE_PAUSE_ASYM
operator|&&
name|adv
operator|&
name|ADVERTISE_PAUSE_ASYM
condition|)
operator|*
name|fc
operator|=
name|PAUSE_TX
expr_stmt|;
elseif|else
if|if
condition|(
name|lpa
operator|&
name|ADVERTISE_PAUSE_ASYM
operator|&&
name|adv
operator|&
name|ADVERTISE_PAUSE_CAP
condition|)
operator|*
name|fc
operator|=
name|PAUSE_RX
expr_stmt|;
else|else
operator|*
name|fc
operator|=
literal|0
expr_stmt|;
block|}
block|}
else|else
block|{
name|err
operator|=
name|mdio_read
argument_list|(
name|phy
argument_list|,
name|MDIO_DEV_PMA_PMD
argument_list|,
name|MII_BMCR
argument_list|,
operator|&
name|v
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
operator|(
name|err
operator|)
return|;
name|v
operator|&=
name|BMCR_SPEED1000
operator||
name|BMCR_SPEED100
expr_stmt|;
if|if
condition|(
name|speed
condition|)
block|{
if|if
condition|(
name|v
operator|==
operator|(
name|BMCR_SPEED1000
operator||
name|BMCR_SPEED100
operator|)
condition|)
operator|*
name|speed
operator|=
name|SPEED_10000
expr_stmt|;
elseif|else
if|if
condition|(
name|v
operator|==
name|BMCR_SPEED1000
condition|)
operator|*
name|speed
operator|=
name|SPEED_1000
expr_stmt|;
elseif|else
if|if
condition|(
name|v
operator|==
name|BMCR_SPEED100
condition|)
operator|*
name|speed
operator|=
name|SPEED_100
expr_stmt|;
else|else
operator|*
name|speed
operator|=
name|SPEED_10
expr_stmt|;
block|}
if|if
condition|(
name|duplex
condition|)
operator|*
name|duplex
operator|=
name|DUPLEX_FULL
expr_stmt|;
block|}
name|link
operator|=
literal|1
expr_stmt|;
name|done
label|:
if|if
condition|(
name|link_ok
condition|)
operator|*
name|link_ok
operator|=
name|link
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|struct
name|cphy_ops
name|aq100x_ops
init|=
block|{
operator|.
name|reset
operator|=
name|aq100x_reset
block|,
operator|.
name|intr_enable
operator|=
name|aq100x_intr_enable
block|,
operator|.
name|intr_disable
operator|=
name|aq100x_intr_disable
block|,
operator|.
name|intr_clear
operator|=
name|aq100x_intr_clear
block|,
operator|.
name|intr_handler
operator|=
name|aq100x_intr_handler
block|,
operator|.
name|autoneg_enable
operator|=
name|aq100x_autoneg_enable
block|,
operator|.
name|autoneg_restart
operator|=
name|aq100x_autoneg_restart
block|,
operator|.
name|advertise
operator|=
name|aq100x_advertise
block|,
operator|.
name|set_loopback
operator|=
name|aq100x_set_loopback
block|,
operator|.
name|set_speed_duplex
operator|=
name|aq100x_set_speed_duplex
block|,
operator|.
name|get_link_status
operator|=
name|aq100x_get_link_status
block|,
operator|.
name|power_down
operator|=
name|aq100x_power_down
block|, }
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|t3_aq100x_phy_prep
parameter_list|(
name|pinfo_t
modifier|*
name|pinfo
parameter_list|,
name|int
name|phy_addr
parameter_list|,
specifier|const
name|struct
name|mdio_ops
modifier|*
name|mdio_ops
parameter_list|)
block|{
name|struct
name|cphy
modifier|*
name|phy
init|=
operator|&
name|pinfo
operator|->
name|phy
decl_stmt|;
name|unsigned
name|int
name|v
decl_stmt|,
name|v2
decl_stmt|,
name|gpio
decl_stmt|,
name|wait
decl_stmt|;
name|int
name|err
decl_stmt|;
name|adapter_t
modifier|*
name|adapter
init|=
name|pinfo
operator|->
name|adapter
decl_stmt|;
name|cphy_init
argument_list|(
operator|&
name|pinfo
operator|->
name|phy
argument_list|,
name|adapter
argument_list|,
name|pinfo
argument_list|,
name|phy_addr
argument_list|,
operator|&
name|aq100x_ops
argument_list|,
name|mdio_ops
argument_list|,
name|SUPPORTED_1000baseT_Full
operator||
name|SUPPORTED_10000baseT_Full
operator||
name|SUPPORTED_TP
operator||
name|SUPPORTED_Autoneg
operator||
name|SUPPORTED_AUI
operator||
name|SUPPORTED_MISC_IRQ
argument_list|,
literal|"1000/10GBASE-T"
argument_list|)
expr_stmt|;
comment|/* 	 * Hard reset the PHY. 	 */
name|gpio
operator|=
name|phy_addr
condition|?
name|F_GPIO10_OUT_VAL
else|:
name|F_GPIO6_OUT_VAL
expr_stmt|;
name|t3_set_reg_field
argument_list|(
name|adapter
argument_list|,
name|A_T3DBG_GPIO_EN
argument_list|,
name|gpio
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|msleep
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|t3_set_reg_field
argument_list|(
name|adapter
argument_list|,
name|A_T3DBG_GPIO_EN
argument_list|,
name|gpio
argument_list|,
name|gpio
argument_list|)
expr_stmt|;
comment|/* 	 * Give it enough time to load the firmware and get ready for mdio. 	 */
name|msleep
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
name|wait
operator|=
literal|500
expr_stmt|;
comment|/* in 10ms increments */
do|do
block|{
name|err
operator|=
name|mdio_read
argument_list|(
name|phy
argument_list|,
name|MDIO_DEV_PMA_PMD
argument_list|,
name|MII_BMCR
argument_list|,
operator|&
name|v
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|||
name|v
operator|==
literal|0xffff
condition|)
block|{
comment|/* Allow prep_adapter to succeed when ffff is read */
name|CH_WARN
argument_list|(
name|adapter
argument_list|,
literal|"PHY%d: reset failed (0x%x, 0x%x).\n"
argument_list|,
name|phy_addr
argument_list|,
name|err
argument_list|,
name|v
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|v
operator|&=
name|BMCR_RESET
expr_stmt|;
if|if
condition|(
name|v
condition|)
name|msleep
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|v
operator|&&
operator|--
name|wait
condition|)
do|;
if|if
condition|(
name|v
condition|)
block|{
name|CH_WARN
argument_list|(
name|adapter
argument_list|,
literal|"PHY%d: reset timed out (0x%x).\n"
argument_list|,
name|phy_addr
argument_list|,
name|v
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
comment|/* let prep_adapter succeed */
block|}
comment|/* Firmware version check. */
operator|(
name|void
operator|)
name|mdio_read
argument_list|(
name|phy
argument_list|,
name|MDIO_DEV_VEND1
argument_list|,
name|AQ_FW_VERSION
argument_list|,
operator|&
name|v
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|<
literal|0x115
condition|)
name|CH_WARN
argument_list|(
name|adapter
argument_list|,
literal|"PHY%d: unknown firmware %d.%d\n"
argument_list|,
name|phy_addr
argument_list|,
name|v
operator|>>
literal|8
argument_list|,
name|v
operator|&
literal|0xff
argument_list|)
expr_stmt|;
comment|/* The PHY should start in really-low-power mode. */
operator|(
name|void
operator|)
name|mdio_read
argument_list|(
name|phy
argument_list|,
name|MDIO_DEV_PMA_PMD
argument_list|,
name|MII_BMCR
argument_list|,
operator|&
name|v
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|v
operator|&
name|BMCR_PDOWN
operator|)
operator|==
literal|0
condition|)
name|CH_WARN
argument_list|(
name|adapter
argument_list|,
literal|"PHY%d does not start in low power mode.\n"
argument_list|,
name|phy_addr
argument_list|)
expr_stmt|;
comment|/* 	 * Verify XAUI and 1000-X settings, but let prep succeed no matter what. 	 */
name|v
operator|=
name|v2
operator|=
literal|0
expr_stmt|;
operator|(
name|void
operator|)
name|mdio_read
argument_list|(
name|phy
argument_list|,
name|MDIO_DEV_XGXS
argument_list|,
name|AQ_XAUI_RX_CFG
argument_list|,
operator|&
name|v
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|mdio_read
argument_list|(
name|phy
argument_list|,
name|MDIO_DEV_XGXS
argument_list|,
name|AQ_XAUI_TX_CFG
argument_list|,
operator|&
name|v2
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|!=
literal|0x1b
operator|||
name|v2
operator|!=
literal|0x1b
condition|)
name|CH_WARN
argument_list|(
name|adapter
argument_list|,
literal|"PHY%d: incorrect XAUI settings "
literal|"(0x%x, 0x%x).\n"
argument_list|,
name|phy_addr
argument_list|,
name|v
argument_list|,
name|v2
argument_list|)
expr_stmt|;
name|v
operator|=
literal|0
expr_stmt|;
operator|(
name|void
operator|)
name|mdio_read
argument_list|(
name|phy
argument_list|,
name|MDIO_DEV_XGXS
argument_list|,
name|AQ_XAUI_KX_CFG
argument_list|,
operator|&
name|v
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|v
operator|&
literal|0xf
operator|)
operator|!=
literal|0xf
condition|)
name|CH_WARN
argument_list|(
name|adapter
argument_list|,
literal|"PHY%d: incorrect 1000-X settings "
literal|"(0x%x).\n"
argument_list|,
name|phy_addr
argument_list|,
name|v
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|aq100x_set_defaults
argument_list|(
name|phy
argument_list|)
expr_stmt|;
name|done
label|:
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

end_unit


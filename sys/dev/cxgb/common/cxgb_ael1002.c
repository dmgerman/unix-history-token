begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/**************************************************************************  Copyright (c) 2007, Chelsio Inc. All rights reserved.  Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:   1. Redistributions of source code must retain the above copyright notice,     this list of conditions and the following disclaimer.   2. Redistributions in binary form must reproduce the above copyright     notice, this list of conditions and the following disclaimer in the     documentation and/or other materials provided with the distribution.   3. Neither the name of the Chelsio Corporation nor the names of its     contributors may be used to endorse or promote products derived from     this software without specific prior written permission.  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  ***************************************************************************/
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/cxgb/common/cxgb_common.h>
end_include

begin_include
include|#
directive|include
file|<dev/cxgb/common/cxgb_regs.h>
end_include

begin_enum
enum|enum
block|{
name|AEL100X_TX_DISABLE
init|=
literal|9
block|,
name|AEL100X_TX_CONFIG1
init|=
literal|0xc002
block|,
name|AEL1002_PWR_DOWN_HI
init|=
literal|0xc011
block|,
name|AEL1002_PWR_DOWN_LO
init|=
literal|0xc012
block|,
name|AEL1002_XFI_EQL
init|=
literal|0xc015
block|,
name|AEL1002_LB_EN
init|=
literal|0xc017
block|,
name|LASI_CTRL
init|=
literal|0x9002
block|,
name|LASI_STAT
init|=
literal|0x9005
block|}
enum|;
end_enum

begin_function
specifier|static
name|void
name|ael100x_txon
parameter_list|(
name|struct
name|cphy
modifier|*
name|phy
parameter_list|)
block|{
name|int
name|tx_on_gpio
init|=
name|phy
operator|->
name|addr
operator|==
literal|0
condition|?
name|F_GPIO7_OUT_VAL
else|:
name|F_GPIO2_OUT_VAL
decl_stmt|;
name|t3_os_sleep
argument_list|(
literal|100
argument_list|)
expr_stmt|;
name|t3_set_reg_field
argument_list|(
name|phy
operator|->
name|adapter
argument_list|,
name|A_T3DBG_GPIO_EN
argument_list|,
literal|0
argument_list|,
name|tx_on_gpio
argument_list|)
expr_stmt|;
name|t3_os_sleep
argument_list|(
literal|30
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|ael1002_power_down
parameter_list|(
name|struct
name|cphy
modifier|*
name|phy
parameter_list|,
name|int
name|enable
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|err
operator|=
name|mdio_write
argument_list|(
name|phy
argument_list|,
name|MDIO_DEV_PMA_PMD
argument_list|,
name|AEL100X_TX_DISABLE
argument_list|,
operator|!
operator|!
name|enable
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|err
condition|)
name|err
operator|=
name|t3_mdio_change_bits
argument_list|(
name|phy
argument_list|,
name|MDIO_DEV_PMA_PMD
argument_list|,
name|MII_BMCR
argument_list|,
name|BMCR_PDOWN
argument_list|,
name|enable
condition|?
name|BMCR_PDOWN
else|:
literal|0
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ael1002_reset
parameter_list|(
name|struct
name|cphy
modifier|*
name|phy
parameter_list|,
name|int
name|wait
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|ael1002_power_down
argument_list|(
name|phy
argument_list|,
literal|0
argument_list|)
operator|)
operator|||
operator|(
name|err
operator|=
name|mdio_write
argument_list|(
name|phy
argument_list|,
name|MDIO_DEV_PMA_PMD
argument_list|,
name|AEL100X_TX_CONFIG1
argument_list|,
literal|1
argument_list|)
operator|)
operator|||
operator|(
name|err
operator|=
name|mdio_write
argument_list|(
name|phy
argument_list|,
name|MDIO_DEV_PMA_PMD
argument_list|,
name|AEL1002_PWR_DOWN_HI
argument_list|,
literal|0
argument_list|)
operator|)
operator|||
operator|(
name|err
operator|=
name|mdio_write
argument_list|(
name|phy
argument_list|,
name|MDIO_DEV_PMA_PMD
argument_list|,
name|AEL1002_PWR_DOWN_LO
argument_list|,
literal|0
argument_list|)
operator|)
operator|||
operator|(
name|err
operator|=
name|mdio_write
argument_list|(
name|phy
argument_list|,
name|MDIO_DEV_PMA_PMD
argument_list|,
name|AEL1002_XFI_EQL
argument_list|,
literal|0x18
argument_list|)
operator|)
operator|||
operator|(
name|err
operator|=
name|t3_mdio_change_bits
argument_list|(
name|phy
argument_list|,
name|MDIO_DEV_PMA_PMD
argument_list|,
name|AEL1002_LB_EN
argument_list|,
literal|0
argument_list|,
literal|1
operator|<<
literal|5
argument_list|)
operator|)
condition|)
return|return
name|err
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ael1002_intr_noop
parameter_list|(
name|struct
name|cphy
modifier|*
name|phy
parameter_list|)
block|{
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ael100x_get_link_status
parameter_list|(
name|struct
name|cphy
modifier|*
name|phy
parameter_list|,
name|int
modifier|*
name|link_ok
parameter_list|,
name|int
modifier|*
name|speed
parameter_list|,
name|int
modifier|*
name|duplex
parameter_list|,
name|int
modifier|*
name|fc
parameter_list|)
block|{
if|if
condition|(
name|link_ok
condition|)
block|{
name|unsigned
name|int
name|status
decl_stmt|;
name|int
name|err
init|=
name|mdio_read
argument_list|(
name|phy
argument_list|,
name|MDIO_DEV_PMA_PMD
argument_list|,
name|MII_BMSR
argument_list|,
operator|&
name|status
argument_list|)
decl_stmt|;
comment|/* 		 * BMSR_LSTATUS is latch-low, so if it is 0 we need to read it 		 * once more to get the current link state. 		 */
if|if
condition|(
operator|!
name|err
operator|&&
operator|!
operator|(
name|status
operator|&
name|BMSR_LSTATUS
operator|)
condition|)
name|err
operator|=
name|mdio_read
argument_list|(
name|phy
argument_list|,
name|MDIO_DEV_PMA_PMD
argument_list|,
name|MII_BMSR
argument_list|,
operator|&
name|status
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
operator|*
name|link_ok
operator|=
operator|!
operator|!
operator|(
name|status
operator|&
name|BMSR_LSTATUS
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|speed
condition|)
operator|*
name|speed
operator|=
name|SPEED_10000
expr_stmt|;
if|if
condition|(
name|duplex
condition|)
operator|*
name|duplex
operator|=
name|DUPLEX_FULL
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|C99_NOT_SUPPORTED
end_ifdef

begin_decl_stmt
specifier|static
name|struct
name|cphy_ops
name|ael1002_ops
init|=
block|{
name|NULL
block|,
name|ael1002_reset
block|,
name|ael1002_intr_noop
block|,
name|ael1002_intr_noop
block|,
name|ael1002_intr_noop
block|,
name|ael1002_intr_noop
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|ael100x_get_link_status
block|,
name|ael1002_power_down
block|, }
decl_stmt|;
end_decl_stmt

begin_else
else|#
directive|else
end_else

begin_decl_stmt
specifier|static
name|struct
name|cphy_ops
name|ael1002_ops
init|=
block|{
operator|.
name|reset
operator|=
name|ael1002_reset
block|,
operator|.
name|intr_enable
operator|=
name|ael1002_intr_noop
block|,
operator|.
name|intr_disable
operator|=
name|ael1002_intr_noop
block|,
operator|.
name|intr_clear
operator|=
name|ael1002_intr_noop
block|,
operator|.
name|intr_handler
operator|=
name|ael1002_intr_noop
block|,
operator|.
name|get_link_status
operator|=
name|ael100x_get_link_status
block|,
operator|.
name|power_down
operator|=
name|ael1002_power_down
block|, }
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|void
name|t3_ael1002_phy_prep
parameter_list|(
name|struct
name|cphy
modifier|*
name|phy
parameter_list|,
name|adapter_t
modifier|*
name|adapter
parameter_list|,
name|int
name|phy_addr
parameter_list|,
specifier|const
name|struct
name|mdio_ops
modifier|*
name|mdio_ops
parameter_list|)
block|{
name|cphy_init
argument_list|(
name|phy
argument_list|,
name|adapter
argument_list|,
name|phy_addr
argument_list|,
operator|&
name|ael1002_ops
argument_list|,
name|mdio_ops
argument_list|)
expr_stmt|;
name|ael100x_txon
argument_list|(
name|phy
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|ael1006_reset
parameter_list|(
name|struct
name|cphy
modifier|*
name|phy
parameter_list|,
name|int
name|wait
parameter_list|)
block|{
return|return
name|t3_phy_reset
argument_list|(
name|phy
argument_list|,
name|MDIO_DEV_PMA_PMD
argument_list|,
name|wait
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ael1006_intr_enable
parameter_list|(
name|struct
name|cphy
modifier|*
name|phy
parameter_list|)
block|{
return|return
name|mdio_write
argument_list|(
name|phy
argument_list|,
name|MDIO_DEV_PMA_PMD
argument_list|,
name|LASI_CTRL
argument_list|,
literal|1
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ael1006_intr_disable
parameter_list|(
name|struct
name|cphy
modifier|*
name|phy
parameter_list|)
block|{
return|return
name|mdio_write
argument_list|(
name|phy
argument_list|,
name|MDIO_DEV_PMA_PMD
argument_list|,
name|LASI_CTRL
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ael1006_intr_clear
parameter_list|(
name|struct
name|cphy
modifier|*
name|phy
parameter_list|)
block|{
name|u32
name|val
decl_stmt|;
return|return
name|mdio_read
argument_list|(
name|phy
argument_list|,
name|MDIO_DEV_PMA_PMD
argument_list|,
name|LASI_STAT
argument_list|,
operator|&
name|val
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ael1006_intr_handler
parameter_list|(
name|struct
name|cphy
modifier|*
name|phy
parameter_list|)
block|{
name|unsigned
name|int
name|status
decl_stmt|;
name|int
name|err
init|=
name|mdio_read
argument_list|(
name|phy
argument_list|,
name|MDIO_DEV_PMA_PMD
argument_list|,
name|LASI_STAT
argument_list|,
operator|&
name|status
argument_list|)
decl_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
return|return
operator|(
name|status
operator|&
literal|1
operator|)
condition|?
name|cphy_cause_link_change
else|:
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ael1006_power_down
parameter_list|(
name|struct
name|cphy
modifier|*
name|phy
parameter_list|,
name|int
name|enable
parameter_list|)
block|{
return|return
name|t3_mdio_change_bits
argument_list|(
name|phy
argument_list|,
name|MDIO_DEV_PMA_PMD
argument_list|,
name|MII_BMCR
argument_list|,
name|BMCR_PDOWN
argument_list|,
name|enable
condition|?
name|BMCR_PDOWN
else|:
literal|0
argument_list|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|C99_NOT_SUPPORTED
end_ifdef

begin_decl_stmt
specifier|static
name|struct
name|cphy_ops
name|ael1006_ops
init|=
block|{
name|NULL
block|,
name|ael1006_reset
block|,
name|ael1006_intr_enable
block|,
name|ael1006_intr_disable
block|,
name|ael1006_intr_clear
block|,
name|ael1006_intr_handler
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|ael100x_get_link_status
block|,
name|ael1006_power_down
block|, }
decl_stmt|;
end_decl_stmt

begin_else
else|#
directive|else
end_else

begin_decl_stmt
specifier|static
name|struct
name|cphy_ops
name|ael1006_ops
init|=
block|{
operator|.
name|reset
operator|=
name|ael1006_reset
block|,
operator|.
name|intr_enable
operator|=
name|ael1006_intr_enable
block|,
operator|.
name|intr_disable
operator|=
name|ael1006_intr_disable
block|,
operator|.
name|intr_clear
operator|=
name|ael1006_intr_clear
block|,
operator|.
name|intr_handler
operator|=
name|ael1006_intr_handler
block|,
operator|.
name|get_link_status
operator|=
name|ael100x_get_link_status
block|,
operator|.
name|power_down
operator|=
name|ael1006_power_down
block|, }
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|void
name|t3_ael1006_phy_prep
parameter_list|(
name|struct
name|cphy
modifier|*
name|phy
parameter_list|,
name|adapter_t
modifier|*
name|adapter
parameter_list|,
name|int
name|phy_addr
parameter_list|,
specifier|const
name|struct
name|mdio_ops
modifier|*
name|mdio_ops
parameter_list|)
block|{
name|cphy_init
argument_list|(
name|phy
argument_list|,
name|adapter
argument_list|,
name|phy_addr
argument_list|,
operator|&
name|ael1006_ops
argument_list|,
name|mdio_ops
argument_list|)
expr_stmt|;
name|ael100x_txon
argument_list|(
name|phy
argument_list|)
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|C99_NOT_SUPPORTED
end_ifdef

begin_decl_stmt
specifier|static
name|struct
name|cphy_ops
name|qt2045_ops
init|=
block|{
name|NULL
block|,
name|ael1006_reset
block|,
name|ael1006_intr_enable
block|,
name|ael1006_intr_disable
block|,
name|ael1006_intr_clear
block|,
name|ael1006_intr_handler
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|ael100x_get_link_status
block|,
name|ael1006_power_down
block|, }
decl_stmt|;
end_decl_stmt

begin_else
else|#
directive|else
end_else

begin_decl_stmt
specifier|static
name|struct
name|cphy_ops
name|qt2045_ops
init|=
block|{
operator|.
name|reset
operator|=
name|ael1006_reset
block|,
operator|.
name|intr_enable
operator|=
name|ael1006_intr_enable
block|,
operator|.
name|intr_disable
operator|=
name|ael1006_intr_disable
block|,
operator|.
name|intr_clear
operator|=
name|ael1006_intr_clear
block|,
operator|.
name|intr_handler
operator|=
name|ael1006_intr_handler
block|,
operator|.
name|get_link_status
operator|=
name|ael100x_get_link_status
block|,
operator|.
name|power_down
operator|=
name|ael1006_power_down
block|, }
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|void
name|t3_qt2045_phy_prep
parameter_list|(
name|struct
name|cphy
modifier|*
name|phy
parameter_list|,
name|adapter_t
modifier|*
name|adapter
parameter_list|,
name|int
name|phy_addr
parameter_list|,
specifier|const
name|struct
name|mdio_ops
modifier|*
name|mdio_ops
parameter_list|)
block|{
name|unsigned
name|int
name|stat
decl_stmt|;
name|cphy_init
argument_list|(
name|phy
argument_list|,
name|adapter
argument_list|,
name|phy_addr
argument_list|,
operator|&
name|qt2045_ops
argument_list|,
name|mdio_ops
argument_list|)
expr_stmt|;
comment|/* 	 * Some cards where the PHY is supposed to be at address 0 actually 	 * have it at 1. 	 */
if|if
condition|(
operator|!
name|phy_addr
operator|&&
operator|!
name|mdio_read
argument_list|(
name|phy
argument_list|,
name|MDIO_DEV_PMA_PMD
argument_list|,
name|MII_BMSR
argument_list|,
operator|&
name|stat
argument_list|)
operator|&&
name|stat
operator|==
literal|0xffff
condition|)
name|phy
operator|->
name|addr
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|xaui_direct_reset
parameter_list|(
name|struct
name|cphy
modifier|*
name|phy
parameter_list|,
name|int
name|wait
parameter_list|)
block|{
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|xaui_direct_get_link_status
parameter_list|(
name|struct
name|cphy
modifier|*
name|phy
parameter_list|,
name|int
modifier|*
name|link_ok
parameter_list|,
name|int
modifier|*
name|speed
parameter_list|,
name|int
modifier|*
name|duplex
parameter_list|,
name|int
modifier|*
name|fc
parameter_list|)
block|{
if|if
condition|(
name|link_ok
condition|)
block|{
name|unsigned
name|int
name|status
decl_stmt|;
name|status
operator|=
name|t3_read_reg
argument_list|(
name|phy
operator|->
name|adapter
argument_list|,
name|XGM_REG
argument_list|(
name|A_XGM_SERDES_STAT0
argument_list|,
name|phy
operator|->
name|addr
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|link_ok
operator|=
operator|!
operator|(
name|status
operator|&
name|F_LOWSIG0
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|speed
condition|)
operator|*
name|speed
operator|=
name|SPEED_10000
expr_stmt|;
if|if
condition|(
name|duplex
condition|)
operator|*
name|duplex
operator|=
name|DUPLEX_FULL
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|xaui_direct_power_down
parameter_list|(
name|struct
name|cphy
modifier|*
name|phy
parameter_list|,
name|int
name|enable
parameter_list|)
block|{
return|return
literal|0
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|C99_NOT_SUPPORTED
end_ifdef

begin_decl_stmt
specifier|static
name|struct
name|cphy_ops
name|xaui_direct_ops
init|=
block|{
name|NULL
block|,
name|xaui_direct_reset
block|,
name|ael1002_intr_noop
block|,
name|ael1002_intr_noop
block|,
name|ael1002_intr_noop
block|,
name|ael1002_intr_noop
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|xaui_direct_get_link_status
block|,
name|xaui_direct_power_down
block|, }
decl_stmt|;
end_decl_stmt

begin_else
else|#
directive|else
end_else

begin_decl_stmt
specifier|static
name|struct
name|cphy_ops
name|xaui_direct_ops
init|=
block|{
operator|.
name|reset
operator|=
name|xaui_direct_reset
block|,
operator|.
name|intr_enable
operator|=
name|ael1002_intr_noop
block|,
operator|.
name|intr_disable
operator|=
name|ael1002_intr_noop
block|,
operator|.
name|intr_clear
operator|=
name|ael1002_intr_noop
block|,
operator|.
name|intr_handler
operator|=
name|ael1002_intr_noop
block|,
operator|.
name|get_link_status
operator|=
name|xaui_direct_get_link_status
block|,
operator|.
name|power_down
operator|=
name|xaui_direct_power_down
block|, }
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|void
name|t3_xaui_direct_phy_prep
parameter_list|(
name|struct
name|cphy
modifier|*
name|phy
parameter_list|,
name|adapter_t
modifier|*
name|adapter
parameter_list|,
name|int
name|phy_addr
parameter_list|,
specifier|const
name|struct
name|mdio_ops
modifier|*
name|mdio_ops
parameter_list|)
block|{
name|cphy_init
argument_list|(
name|phy
argument_list|,
name|adapter
argument_list|,
literal|1
argument_list|,
operator|&
name|xaui_direct_ops
argument_list|,
name|mdio_ops
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


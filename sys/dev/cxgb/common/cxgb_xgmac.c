begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/**************************************************************************  Copyright (c) 2007, Chelsio Inc. All rights reserved.  Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:   1. Redistributions of source code must retain the above copyright notice,     this list of conditions and the following disclaimer.   2. Neither the name of the Chelsio Corporation nor the names of its     contributors may be used to endorse or promote products derived from     this software without specific prior written permission.  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  ***************************************************************************/
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_DEFINED
end_ifdef

begin_include
include|#
directive|include
file|<cxgb_include.h>
end_include

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<dev/cxgb/cxgb_include.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_undef
undef|#
directive|undef
name|msleep
end_undef

begin_define
define|#
directive|define
name|msleep
value|t3_os_sleep
end_define

begin_function
specifier|static
specifier|inline
name|int
name|macidx
parameter_list|(
specifier|const
name|struct
name|cmac
modifier|*
name|mac
parameter_list|)
block|{
return|return
name|mac
operator|->
name|offset
operator|/
operator|(
name|XGMAC0_1_BASE_ADDR
operator|-
name|XGMAC0_0_BASE_ADDR
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|xaui_serdes_reset
parameter_list|(
name|struct
name|cmac
modifier|*
name|mac
parameter_list|)
block|{
specifier|static
specifier|const
name|unsigned
name|int
name|clear
index|[]
init|=
block|{
name|F_PWRDN0
operator||
name|F_PWRDN1
block|,
name|F_RESETPLL01
block|,
name|F_RESET0
operator||
name|F_RESET1
block|,
name|F_PWRDN2
operator||
name|F_PWRDN3
block|,
name|F_RESETPLL23
block|,
name|F_RESET2
operator||
name|F_RESET3
block|}
decl_stmt|;
name|int
name|i
decl_stmt|;
name|adapter_t
modifier|*
name|adap
init|=
name|mac
operator|->
name|adapter
decl_stmt|;
name|u32
name|ctrl
init|=
name|A_XGM_SERDES_CTRL0
operator|+
name|mac
operator|->
name|offset
decl_stmt|;
name|t3_write_reg
argument_list|(
name|adap
argument_list|,
name|ctrl
argument_list|,
name|adap
operator|->
name|params
operator|.
name|vpd
operator|.
name|xauicfg
index|[
name|macidx
argument_list|(
name|mac
argument_list|)
index|]
operator||
name|F_RESET3
operator||
name|F_RESET2
operator||
name|F_RESET1
operator||
name|F_RESET0
operator||
name|F_PWRDN3
operator||
name|F_PWRDN2
operator||
name|F_PWRDN1
operator||
name|F_PWRDN0
operator||
name|F_RESETPLL23
operator||
name|F_RESETPLL01
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|t3_read_reg
argument_list|(
name|adap
argument_list|,
name|ctrl
argument_list|)
expr_stmt|;
name|udelay
argument_list|(
literal|15
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ARRAY_SIZE
argument_list|(
name|clear
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|t3_set_reg_field
argument_list|(
name|adap
argument_list|,
name|ctrl
argument_list|,
name|clear
index|[
name|i
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|udelay
argument_list|(
literal|15
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  *	t3b_pcs_reset - reset the PCS on T3B+ adapters  *	@mac: the XGMAC handle  *  *	Reset the XGMAC PCS block on T3B+ adapters.  */
end_comment

begin_function
name|void
name|t3b_pcs_reset
parameter_list|(
name|struct
name|cmac
modifier|*
name|mac
parameter_list|)
block|{
name|t3_set_reg_field
argument_list|(
name|mac
operator|->
name|adapter
argument_list|,
name|A_XGM_RESET_CTRL
operator|+
name|mac
operator|->
name|offset
argument_list|,
name|F_PCS_RESET_
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|udelay
argument_list|(
literal|20
argument_list|)
expr_stmt|;
name|t3_set_reg_field
argument_list|(
name|mac
operator|->
name|adapter
argument_list|,
name|A_XGM_RESET_CTRL
operator|+
name|mac
operator|->
name|offset
argument_list|,
literal|0
argument_list|,
name|F_PCS_RESET_
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  *	t3_mac_reset - reset a MAC  *	@mac: the MAC to reset  *  *	Reset the given MAC.  */
end_comment

begin_function
name|int
name|t3_mac_reset
parameter_list|(
name|struct
name|cmac
modifier|*
name|mac
parameter_list|)
block|{
specifier|static
name|struct
name|addr_val_pair
name|mac_reset_avp
index|[]
init|=
block|{
block|{
name|A_XGM_TX_CTRL
block|,
literal|0
block|}
block|,
block|{
name|A_XGM_RX_CTRL
block|,
literal|0
block|}
block|,
block|{
name|A_XGM_RX_CFG
block|,
name|F_DISPAUSEFRAMES
operator||
name|F_EN1536BFRAMES
operator||
name|F_RMFCS
operator||
name|F_ENJUMBO
operator||
name|F_ENHASHMCAST
block|}
block|,
block|{
name|A_XGM_RX_HASH_LOW
block|,
literal|0
block|}
block|,
block|{
name|A_XGM_RX_HASH_HIGH
block|,
literal|0
block|}
block|,
block|{
name|A_XGM_RX_EXACT_MATCH_LOW_1
block|,
literal|0
block|}
block|,
block|{
name|A_XGM_RX_EXACT_MATCH_LOW_2
block|,
literal|0
block|}
block|,
block|{
name|A_XGM_RX_EXACT_MATCH_LOW_3
block|,
literal|0
block|}
block|,
block|{
name|A_XGM_RX_EXACT_MATCH_LOW_4
block|,
literal|0
block|}
block|,
block|{
name|A_XGM_RX_EXACT_MATCH_LOW_5
block|,
literal|0
block|}
block|,
block|{
name|A_XGM_RX_EXACT_MATCH_LOW_6
block|,
literal|0
block|}
block|,
block|{
name|A_XGM_RX_EXACT_MATCH_LOW_7
block|,
literal|0
block|}
block|,
block|{
name|A_XGM_RX_EXACT_MATCH_LOW_8
block|,
literal|0
block|}
block|,
block|{
name|A_XGM_STAT_CTRL
block|,
name|F_CLRSTATS
block|}
block|}
decl_stmt|;
name|u32
name|val
decl_stmt|;
name|adapter_t
modifier|*
name|adap
init|=
name|mac
operator|->
name|adapter
decl_stmt|;
name|unsigned
name|int
name|oft
init|=
name|mac
operator|->
name|offset
decl_stmt|;
name|t3_write_reg
argument_list|(
name|adap
argument_list|,
name|A_XGM_RESET_CTRL
operator|+
name|oft
argument_list|,
name|F_MAC_RESET_
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|t3_read_reg
argument_list|(
name|adap
argument_list|,
name|A_XGM_RESET_CTRL
operator|+
name|oft
argument_list|)
expr_stmt|;
comment|/* flush */
name|t3_write_regs
argument_list|(
name|adap
argument_list|,
name|mac_reset_avp
argument_list|,
name|ARRAY_SIZE
argument_list|(
name|mac_reset_avp
argument_list|)
argument_list|,
name|oft
argument_list|)
expr_stmt|;
name|t3_set_reg_field
argument_list|(
name|adap
argument_list|,
name|A_XGM_RXFIFO_CFG
operator|+
name|oft
argument_list|,
name|F_RXSTRFRWRD
operator||
name|F_DISERRFRAMES
argument_list|,
name|uses_xaui
argument_list|(
name|adap
argument_list|)
condition|?
literal|0
else|:
name|F_RXSTRFRWRD
argument_list|)
expr_stmt|;
name|t3_set_reg_field
argument_list|(
name|adap
argument_list|,
name|A_XGM_TXFIFO_CFG
operator|+
name|oft
argument_list|,
literal|0
argument_list|,
name|F_UNDERUNFIX
argument_list|)
expr_stmt|;
if|if
condition|(
name|uses_xaui
argument_list|(
name|adap
argument_list|)
condition|)
block|{
if|if
condition|(
name|adap
operator|->
name|params
operator|.
name|rev
operator|==
literal|0
condition|)
block|{
name|t3_set_reg_field
argument_list|(
name|adap
argument_list|,
name|A_XGM_SERDES_CTRL
operator|+
name|oft
argument_list|,
literal|0
argument_list|,
name|F_RXENABLE
operator||
name|F_TXENABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|t3_wait_op_done
argument_list|(
name|adap
argument_list|,
name|A_XGM_SERDES_STATUS1
operator|+
name|oft
argument_list|,
name|F_CMULOCK
argument_list|,
literal|1
argument_list|,
literal|5
argument_list|,
literal|2
argument_list|)
condition|)
block|{
name|CH_ERR
argument_list|(
name|adap
argument_list|,
literal|"MAC %d XAUI SERDES CMU lock failed\n"
argument_list|,
name|macidx
argument_list|(
name|mac
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|t3_set_reg_field
argument_list|(
name|adap
argument_list|,
name|A_XGM_SERDES_CTRL
operator|+
name|oft
argument_list|,
literal|0
argument_list|,
name|F_SERDESRESET_
argument_list|)
expr_stmt|;
block|}
else|else
name|xaui_serdes_reset
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mac
operator|->
name|multiport
condition|)
block|{
name|t3_write_reg
argument_list|(
name|adap
argument_list|,
name|A_XGM_RX_MAX_PKT_SIZE
operator|+
name|oft
argument_list|,
name|MAX_FRAME_SIZE
operator|-
literal|4
argument_list|)
expr_stmt|;
name|t3_set_reg_field
argument_list|(
name|adap
argument_list|,
name|A_XGM_TXFIFO_CFG
operator|+
name|oft
argument_list|,
literal|0
argument_list|,
name|F_DISPREAMBLE
argument_list|)
expr_stmt|;
name|t3_set_reg_field
argument_list|(
name|adap
argument_list|,
name|A_XGM_RX_CFG
operator|+
name|oft
argument_list|,
literal|0
argument_list|,
name|F_COPYPREAMBLE
operator||
name|F_ENNON802_3PREAMBLE
argument_list|)
expr_stmt|;
name|t3_set_reg_field
argument_list|(
name|adap
argument_list|,
name|A_XGM_TXFIFO_CFG
operator|+
name|oft
argument_list|,
name|V_TXFIFOTHRESH
argument_list|(
name|M_TXFIFOTHRESH
argument_list|)
argument_list|,
name|V_TXFIFOTHRESH
argument_list|(
literal|64
argument_list|)
argument_list|)
expr_stmt|;
name|t3_write_reg
argument_list|(
name|adap
argument_list|,
name|A_XGM_TX_CTRL
operator|+
name|oft
argument_list|,
name|F_TXEN
argument_list|)
expr_stmt|;
name|t3_write_reg
argument_list|(
name|adap
argument_list|,
name|A_XGM_RX_CTRL
operator|+
name|oft
argument_list|,
name|F_RXEN
argument_list|)
expr_stmt|;
block|}
name|t3_set_reg_field
argument_list|(
name|adap
argument_list|,
name|A_XGM_RX_MAX_PKT_SIZE
operator|+
name|oft
argument_list|,
name|V_RXMAXFRAMERSIZE
argument_list|(
name|M_RXMAXFRAMERSIZE
argument_list|)
argument_list|,
name|V_RXMAXFRAMERSIZE
argument_list|(
name|MAX_FRAME_SIZE
argument_list|)
operator||
name|F_RXENFRAMER
argument_list|)
expr_stmt|;
name|val
operator|=
name|F_MAC_RESET_
operator||
name|F_XGMAC_STOP_EN
expr_stmt|;
if|if
condition|(
operator|!
name|mac
operator|->
name|multiport
condition|)
name|val
operator||=
name|F_XG2G_RESET_
expr_stmt|;
if|if
condition|(
name|uses_xaui
argument_list|(
name|adap
argument_list|)
condition|)
name|val
operator||=
name|F_PCS_RESET_
expr_stmt|;
else|else
name|val
operator||=
name|F_RGMII_RESET_
expr_stmt|;
name|t3_write_reg
argument_list|(
name|adap
argument_list|,
name|A_XGM_RESET_CTRL
operator|+
name|oft
argument_list|,
name|val
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|t3_read_reg
argument_list|(
name|adap
argument_list|,
name|A_XGM_RESET_CTRL
operator|+
name|oft
argument_list|)
expr_stmt|;
comment|/* flush */
if|if
condition|(
operator|(
name|val
operator|&
name|F_PCS_RESET_
operator|)
operator|&&
name|adap
operator|->
name|params
operator|.
name|rev
condition|)
block|{
name|msleep
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|t3b_pcs_reset
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
name|memset
argument_list|(
operator|&
name|mac
operator|->
name|stats
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|mac
operator|->
name|stats
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|t3b2_mac_reset
parameter_list|(
name|struct
name|cmac
modifier|*
name|mac
parameter_list|)
block|{
name|u32
name|val
decl_stmt|;
name|adapter_t
modifier|*
name|adap
init|=
name|mac
operator|->
name|adapter
decl_stmt|;
name|unsigned
name|int
name|oft
init|=
name|mac
operator|->
name|offset
decl_stmt|;
name|int
name|idx
init|=
name|macidx
argument_list|(
name|mac
argument_list|)
decl_stmt|;
name|unsigned
name|int
name|store
decl_stmt|;
comment|/* Stop egress traffic to xgm*/
if|if
condition|(
operator|!
name|macidx
argument_list|(
name|mac
argument_list|)
condition|)
name|t3_set_reg_field
argument_list|(
name|adap
argument_list|,
name|A_MPS_CFG
argument_list|,
name|F_PORT0ACTIVE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
name|t3_set_reg_field
argument_list|(
name|adap
argument_list|,
name|A_MPS_CFG
argument_list|,
name|F_PORT1ACTIVE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* PCS in reset */
name|t3_write_reg
argument_list|(
name|adap
argument_list|,
name|A_XGM_RESET_CTRL
operator|+
name|oft
argument_list|,
name|F_MAC_RESET_
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|t3_read_reg
argument_list|(
name|adap
argument_list|,
name|A_XGM_RESET_CTRL
operator|+
name|oft
argument_list|)
expr_stmt|;
comment|/* flush */
comment|/* Store A_TP_TX_DROP_CFG_CH0 */
name|t3_write_reg
argument_list|(
name|adap
argument_list|,
name|A_TP_PIO_ADDR
argument_list|,
name|A_TP_TX_DROP_CFG_CH0
operator|+
name|idx
argument_list|)
expr_stmt|;
name|store
operator|=
name|t3_read_reg
argument_list|(
name|adap
argument_list|,
name|A_TP_TX_DROP_CFG_CH0
operator|+
name|idx
argument_list|)
expr_stmt|;
name|msleep
argument_list|(
literal|10
argument_list|)
expr_stmt|;
comment|/* Change DROP_CFG to 0xc0000011 */
name|t3_write_reg
argument_list|(
name|adap
argument_list|,
name|A_TP_PIO_ADDR
argument_list|,
name|A_TP_TX_DROP_CFG_CH0
operator|+
name|idx
argument_list|)
expr_stmt|;
name|t3_write_reg
argument_list|(
name|adap
argument_list|,
name|A_TP_PIO_DATA
argument_list|,
literal|0xc0000011
argument_list|)
expr_stmt|;
comment|/* Check for xgm Rx fifo empty */
comment|/* Increased loop count to 1000 from 5 cover 1G and 100Mbps case */
if|if
condition|(
name|t3_wait_op_done
argument_list|(
name|adap
argument_list|,
name|A_XGM_RX_MAX_PKT_SIZE_ERR_CNT
operator|+
name|oft
argument_list|,
literal|0x80000000
argument_list|,
literal|1
argument_list|,
literal|1000
argument_list|,
literal|2
argument_list|)
condition|)
block|{
name|CH_ERR
argument_list|(
name|adap
argument_list|,
literal|"MAC %d Rx fifo drain failed\n"
argument_list|,
name|macidx
argument_list|(
name|mac
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|t3_write_reg
argument_list|(
name|adap
argument_list|,
name|A_XGM_RESET_CTRL
operator|+
name|oft
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/*MAC in reset*/
operator|(
name|void
operator|)
name|t3_read_reg
argument_list|(
name|adap
argument_list|,
name|A_XGM_RESET_CTRL
operator|+
name|oft
argument_list|)
expr_stmt|;
comment|/* flush */
name|val
operator|=
name|F_MAC_RESET_
expr_stmt|;
if|if
condition|(
name|is_10G
argument_list|(
name|adap
argument_list|)
condition|)
name|val
operator||=
name|F_PCS_RESET_
expr_stmt|;
elseif|else
if|if
condition|(
name|uses_xaui
argument_list|(
name|adap
argument_list|)
condition|)
name|val
operator||=
name|F_PCS_RESET_
operator||
name|F_XG2G_RESET_
expr_stmt|;
else|else
name|val
operator||=
name|F_RGMII_RESET_
operator||
name|F_XG2G_RESET_
expr_stmt|;
name|t3_write_reg
argument_list|(
name|adap
argument_list|,
name|A_XGM_RESET_CTRL
operator|+
name|oft
argument_list|,
name|val
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|t3_read_reg
argument_list|(
name|adap
argument_list|,
name|A_XGM_RESET_CTRL
operator|+
name|oft
argument_list|)
expr_stmt|;
comment|/* flush */
if|if
condition|(
operator|(
name|val
operator|&
name|F_PCS_RESET_
operator|)
operator|&&
name|adap
operator|->
name|params
operator|.
name|rev
condition|)
block|{
name|msleep
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|t3b_pcs_reset
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
name|t3_write_reg
argument_list|(
name|adap
argument_list|,
name|A_XGM_RX_CFG
operator|+
name|oft
argument_list|,
name|F_DISPAUSEFRAMES
operator||
name|F_EN1536BFRAMES
operator||
name|F_RMFCS
operator||
name|F_ENJUMBO
operator||
name|F_ENHASHMCAST
argument_list|)
expr_stmt|;
comment|/* Restore the DROP_CFG */
name|t3_write_reg
argument_list|(
name|adap
argument_list|,
name|A_TP_PIO_ADDR
argument_list|,
name|A_TP_TX_DROP_CFG_CH0
operator|+
name|idx
argument_list|)
expr_stmt|;
name|t3_write_reg
argument_list|(
name|adap
argument_list|,
name|A_TP_PIO_DATA
argument_list|,
name|store
argument_list|)
expr_stmt|;
comment|/* Resume egress traffic to xgm */
if|if
condition|(
operator|!
name|macidx
argument_list|(
name|mac
argument_list|)
condition|)
name|t3_set_reg_field
argument_list|(
name|adap
argument_list|,
name|A_MPS_CFG
argument_list|,
literal|0
argument_list|,
name|F_PORT0ACTIVE
argument_list|)
expr_stmt|;
else|else
name|t3_set_reg_field
argument_list|(
name|adap
argument_list|,
name|A_MPS_CFG
argument_list|,
literal|0
argument_list|,
name|F_PORT1ACTIVE
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Set the exact match register 'idx' to recognize the given Ethernet address.  */
end_comment

begin_function
specifier|static
name|void
name|set_addr_filter
parameter_list|(
name|struct
name|cmac
modifier|*
name|mac
parameter_list|,
name|int
name|idx
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
name|u32
name|addr_lo
decl_stmt|,
name|addr_hi
decl_stmt|;
name|unsigned
name|int
name|oft
init|=
name|mac
operator|->
name|offset
operator|+
name|idx
operator|*
literal|8
decl_stmt|;
name|addr_lo
operator|=
operator|(
name|addr
index|[
literal|3
index|]
operator|<<
literal|24
operator|)
operator||
operator|(
name|addr
index|[
literal|2
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
name|addr
index|[
literal|1
index|]
operator|<<
literal|8
operator|)
operator||
name|addr
index|[
literal|0
index|]
expr_stmt|;
name|addr_hi
operator|=
operator|(
name|addr
index|[
literal|5
index|]
operator|<<
literal|8
operator|)
operator||
name|addr
index|[
literal|4
index|]
expr_stmt|;
name|t3_write_reg
argument_list|(
name|mac
operator|->
name|adapter
argument_list|,
name|A_XGM_RX_EXACT_MATCH_LOW_1
operator|+
name|oft
argument_list|,
name|addr_lo
argument_list|)
expr_stmt|;
name|t3_write_reg
argument_list|(
name|mac
operator|->
name|adapter
argument_list|,
name|A_XGM_RX_EXACT_MATCH_HIGH_1
operator|+
name|oft
argument_list|,
name|addr_hi
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  *	t3_mac_set_address - set one of the station's unicast MAC addresses  *	@mac: the MAC handle  *	@idx: index of the exact address match filter to use  *	@addr: the Ethernet address  *  *	Set one of the station's unicast MAC addresses.  */
end_comment

begin_function
name|int
name|t3_mac_set_address
parameter_list|(
name|struct
name|cmac
modifier|*
name|mac
parameter_list|,
name|unsigned
name|int
name|idx
parameter_list|,
name|u8
name|addr
index|[
literal|6
index|]
parameter_list|)
block|{
if|if
condition|(
name|mac
operator|->
name|multiport
condition|)
name|idx
operator|=
name|mac
operator|->
name|ext_port
operator|+
name|idx
operator|*
name|mac
operator|->
name|adapter
operator|->
name|params
operator|.
name|nports
expr_stmt|;
if|if
condition|(
name|idx
operator|>=
name|mac
operator|->
name|nucast
condition|)
return|return
operator|-
name|EINVAL
return|;
name|set_addr_filter
argument_list|(
name|mac
argument_list|,
name|idx
argument_list|,
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|multiport
operator|&&
name|idx
operator|<
name|mac
operator|->
name|adapter
operator|->
name|params
operator|.
name|nports
condition|)
name|t3_vsc7323_set_addr
argument_list|(
name|mac
operator|->
name|adapter
argument_list|,
name|addr
argument_list|,
name|idx
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  *	t3_mac_set_num_ucast - set the number of unicast addresses needed  *	@mac: the MAC handle  *	@n: number of unicast addresses needed  *  *	Specify the number of exact address filters that should be reserved for  *	unicast addresses.  Caller should reload the unicast and multicast  *	addresses after calling this.  *  *	Generally, this is 1 with the first one used for the station address,  *	and the rest are available for multicast addresses.  */
end_comment

begin_function
name|int
name|t3_mac_set_num_ucast
parameter_list|(
name|struct
name|cmac
modifier|*
name|mac
parameter_list|,
name|unsigned
name|char
name|n
parameter_list|)
block|{
if|if
condition|(
name|n
operator|>
name|EXACT_ADDR_FILTERS
condition|)
return|return
operator|-
name|EINVAL
return|;
name|mac
operator|->
name|nucast
operator|=
name|n
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|disable_exact_filters
parameter_list|(
name|struct
name|cmac
modifier|*
name|mac
parameter_list|)
block|{
name|unsigned
name|int
name|i
decl_stmt|,
name|reg
init|=
name|mac
operator|->
name|offset
operator|+
name|A_XGM_RX_EXACT_MATCH_LOW_1
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|EXACT_ADDR_FILTERS
condition|;
name|i
operator|++
operator|,
name|reg
operator|+=
literal|8
control|)
block|{
name|u32
name|v
init|=
name|t3_read_reg
argument_list|(
name|mac
operator|->
name|adapter
argument_list|,
name|reg
argument_list|)
decl_stmt|;
name|t3_write_reg
argument_list|(
name|mac
operator|->
name|adapter
argument_list|,
name|reg
argument_list|,
name|v
argument_list|)
expr_stmt|;
block|}
name|t3_read_reg
argument_list|(
name|mac
operator|->
name|adapter
argument_list|,
name|A_XGM_RX_EXACT_MATCH_LOW_1
argument_list|)
expr_stmt|;
comment|/* flush */
block|}
end_function

begin_function
specifier|static
name|void
name|enable_exact_filters
parameter_list|(
name|struct
name|cmac
modifier|*
name|mac
parameter_list|)
block|{
name|unsigned
name|int
name|i
decl_stmt|,
name|reg
init|=
name|mac
operator|->
name|offset
operator|+
name|A_XGM_RX_EXACT_MATCH_HIGH_1
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|EXACT_ADDR_FILTERS
condition|;
name|i
operator|++
operator|,
name|reg
operator|+=
literal|8
control|)
block|{
name|u32
name|v
init|=
name|t3_read_reg
argument_list|(
name|mac
operator|->
name|adapter
argument_list|,
name|reg
argument_list|)
decl_stmt|;
name|t3_write_reg
argument_list|(
name|mac
operator|->
name|adapter
argument_list|,
name|reg
argument_list|,
name|v
argument_list|)
expr_stmt|;
block|}
name|t3_read_reg
argument_list|(
name|mac
operator|->
name|adapter
argument_list|,
name|A_XGM_RX_EXACT_MATCH_LOW_1
argument_list|)
expr_stmt|;
comment|/* flush */
block|}
end_function

begin_comment
comment|/* Calculate the RX hash filter index of an Ethernet address */
end_comment

begin_function
specifier|static
name|int
name|hash_hw_addr
parameter_list|(
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
name|int
name|hash
init|=
literal|0
decl_stmt|,
name|octet
decl_stmt|,
name|bit
decl_stmt|,
name|i
init|=
literal|0
decl_stmt|,
name|c
decl_stmt|;
for|for
control|(
name|octet
operator|=
literal|0
init|;
name|octet
operator|<
literal|6
condition|;
operator|++
name|octet
control|)
for|for
control|(
name|c
operator|=
name|addr
index|[
name|octet
index|]
operator|,
name|bit
operator|=
literal|0
init|;
name|bit
operator|<
literal|8
condition|;
name|c
operator|>>=
literal|1
operator|,
operator|++
name|bit
control|)
block|{
name|hash
operator|^=
operator|(
name|c
operator|&
literal|1
operator|)
operator|<<
name|i
expr_stmt|;
if|if
condition|(
operator|++
name|i
operator|==
literal|6
condition|)
name|i
operator|=
literal|0
expr_stmt|;
block|}
return|return
name|hash
return|;
block|}
end_function

begin_comment
comment|/**  *	t3_mac_set_rx_mode - set the Rx mode and address filters  *	@mac: the MAC to configure  *	@rm: structure containing the Rx mode and MAC addresses needed  *  *	Configures the MAC Rx mode (promiscuity, etc) and exact and hash  *	address filters.  */
end_comment

begin_function
name|int
name|t3_mac_set_rx_mode
parameter_list|(
name|struct
name|cmac
modifier|*
name|mac
parameter_list|,
name|struct
name|t3_rx_mode
modifier|*
name|rm
parameter_list|)
block|{
name|u32
name|hash_lo
decl_stmt|,
name|hash_hi
decl_stmt|;
name|adapter_t
modifier|*
name|adap
init|=
name|mac
operator|->
name|adapter
decl_stmt|;
name|unsigned
name|int
name|oft
init|=
name|mac
operator|->
name|offset
decl_stmt|;
if|if
condition|(
name|promisc_rx_mode
argument_list|(
name|rm
argument_list|)
condition|)
name|mac
operator|->
name|promisc_map
operator||=
literal|1
operator|<<
name|mac
operator|->
name|ext_port
expr_stmt|;
else|else
name|mac
operator|->
name|promisc_map
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|mac
operator|->
name|ext_port
operator|)
expr_stmt|;
name|t3_set_reg_field
argument_list|(
name|adap
argument_list|,
name|A_XGM_RX_CFG
operator|+
name|oft
argument_list|,
name|F_COPYALLFRAMES
argument_list|,
name|mac
operator|->
name|promisc_map
condition|?
name|F_COPYALLFRAMES
else|:
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|allmulti_rx_mode
argument_list|(
name|rm
argument_list|)
operator|||
name|mac
operator|->
name|multiport
condition|)
name|hash_lo
operator|=
name|hash_hi
operator|=
literal|0xffffffff
expr_stmt|;
else|else
block|{
name|u8
modifier|*
name|addr
decl_stmt|;
name|int
name|exact_addr_idx
init|=
name|mac
operator|->
name|nucast
decl_stmt|;
name|hash_lo
operator|=
name|hash_hi
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
name|addr
operator|=
name|t3_get_next_mcaddr
argument_list|(
name|rm
argument_list|)
operator|)
condition|)
if|if
condition|(
name|exact_addr_idx
operator|<
name|EXACT_ADDR_FILTERS
condition|)
name|set_addr_filter
argument_list|(
name|mac
argument_list|,
name|exact_addr_idx
operator|++
argument_list|,
name|addr
argument_list|)
expr_stmt|;
else|else
block|{
name|int
name|hash
init|=
name|hash_hw_addr
argument_list|(
name|addr
argument_list|)
decl_stmt|;
if|if
condition|(
name|hash
operator|<
literal|32
condition|)
name|hash_lo
operator||=
operator|(
literal|1
operator|<<
name|hash
operator|)
expr_stmt|;
else|else
name|hash_hi
operator||=
operator|(
literal|1
operator|<<
operator|(
name|hash
operator|-
literal|32
operator|)
operator|)
expr_stmt|;
block|}
block|}
name|t3_write_reg
argument_list|(
name|adap
argument_list|,
name|A_XGM_RX_HASH_LOW
operator|+
name|oft
argument_list|,
name|hash_lo
argument_list|)
expr_stmt|;
name|t3_write_reg
argument_list|(
name|adap
argument_list|,
name|A_XGM_RX_HASH_HIGH
operator|+
name|oft
argument_list|,
name|hash_hi
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rx_fifo_hwm
parameter_list|(
name|int
name|mtu
parameter_list|)
block|{
name|int
name|hwm
decl_stmt|;
name|hwm
operator|=
name|max
argument_list|(
name|MAC_RXFIFO_SIZE
operator|-
literal|3
operator|*
name|mtu
argument_list|,
operator|(
name|MAC_RXFIFO_SIZE
operator|*
literal|38
operator|)
operator|/
literal|100
argument_list|)
expr_stmt|;
return|return
name|min
argument_list|(
name|hwm
argument_list|,
name|MAC_RXFIFO_SIZE
operator|-
literal|8192
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  *	t3_mac_set_mtu - set the MAC MTU  *	@mac: the MAC to configure  *	@mtu: the MTU  *  *	Sets the MAC MTU and adjusts the FIFO PAUSE watermarks accordingly.  */
end_comment

begin_function
name|int
name|t3_mac_set_mtu
parameter_list|(
name|struct
name|cmac
modifier|*
name|mac
parameter_list|,
name|unsigned
name|int
name|mtu
parameter_list|)
block|{
name|int
name|hwm
decl_stmt|,
name|lwm
decl_stmt|,
name|divisor
decl_stmt|;
name|int
name|ipg
decl_stmt|;
name|unsigned
name|int
name|thres
decl_stmt|,
name|v
decl_stmt|,
name|reg
decl_stmt|;
name|adapter_t
modifier|*
name|adap
init|=
name|mac
operator|->
name|adapter
decl_stmt|;
comment|/* 	 * MAX_FRAME_SIZE inludes header + FCS, mtu doesn't.  The HW max 	 * packet size register includes header, but not FCS. 	 */
name|mtu
operator|+=
literal|14
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|multiport
condition|)
name|mtu
operator|+=
literal|8
expr_stmt|;
comment|/* for preamble */
if|if
condition|(
name|mtu
operator|>
name|MAX_FRAME_SIZE
operator|-
literal|4
condition|)
return|return
operator|-
name|EINVAL
return|;
if|if
condition|(
name|mac
operator|->
name|multiport
condition|)
return|return
name|t3_vsc7323_set_mtu
argument_list|(
name|adap
argument_list|,
name|mtu
operator|-
literal|4
argument_list|,
name|mac
operator|->
name|ext_port
argument_list|)
return|;
if|if
condition|(
name|adap
operator|->
name|params
operator|.
name|rev
operator|>=
name|T3_REV_B2
operator|&&
operator|(
name|t3_read_reg
argument_list|(
name|adap
argument_list|,
name|A_XGM_RX_CTRL
operator|+
name|mac
operator|->
name|offset
argument_list|)
operator|&
name|F_RXEN
operator|)
condition|)
block|{
name|disable_exact_filters
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|v
operator|=
name|t3_read_reg
argument_list|(
name|adap
argument_list|,
name|A_XGM_RX_CFG
operator|+
name|mac
operator|->
name|offset
argument_list|)
expr_stmt|;
name|t3_set_reg_field
argument_list|(
name|adap
argument_list|,
name|A_XGM_RX_CFG
operator|+
name|mac
operator|->
name|offset
argument_list|,
name|F_ENHASHMCAST
operator||
name|F_COPYALLFRAMES
argument_list|,
name|F_DISBCAST
argument_list|)
expr_stmt|;
name|reg
operator|=
name|adap
operator|->
name|params
operator|.
name|rev
operator|==
name|T3_REV_B2
condition|?
name|A_XGM_RX_MAX_PKT_SIZE_ERR_CNT
else|:
name|A_XGM_RXFIFO_CFG
expr_stmt|;
comment|/* drain RX FIFO */
if|if
condition|(
name|t3_wait_op_done
argument_list|(
name|adap
argument_list|,
name|reg
operator|+
name|mac
operator|->
name|offset
argument_list|,
name|F_RXFIFO_EMPTY
argument_list|,
literal|1
argument_list|,
literal|20
argument_list|,
literal|5
argument_list|)
condition|)
block|{
name|t3_write_reg
argument_list|(
name|adap
argument_list|,
name|A_XGM_RX_CFG
operator|+
name|mac
operator|->
name|offset
argument_list|,
name|v
argument_list|)
expr_stmt|;
name|enable_exact_filters
argument_list|(
name|mac
argument_list|)
expr_stmt|;
return|return
operator|-
name|EIO
return|;
block|}
name|t3_set_reg_field
argument_list|(
name|adap
argument_list|,
name|A_XGM_RX_MAX_PKT_SIZE
operator|+
name|mac
operator|->
name|offset
argument_list|,
name|V_RXMAXPKTSIZE
argument_list|(
name|M_RXMAXPKTSIZE
argument_list|)
argument_list|,
name|V_RXMAXPKTSIZE
argument_list|(
name|mtu
argument_list|)
argument_list|)
expr_stmt|;
name|t3_write_reg
argument_list|(
name|adap
argument_list|,
name|A_XGM_RX_CFG
operator|+
name|mac
operator|->
name|offset
argument_list|,
name|v
argument_list|)
expr_stmt|;
name|enable_exact_filters
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
else|else
name|t3_set_reg_field
argument_list|(
name|adap
argument_list|,
name|A_XGM_RX_MAX_PKT_SIZE
operator|+
name|mac
operator|->
name|offset
argument_list|,
name|V_RXMAXPKTSIZE
argument_list|(
name|M_RXMAXPKTSIZE
argument_list|)
argument_list|,
name|V_RXMAXPKTSIZE
argument_list|(
name|mtu
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Adjust the PAUSE frame watermarks.  We always set the LWM, and the 	 * HWM only if flow-control is enabled. 	 */
name|hwm
operator|=
name|rx_fifo_hwm
argument_list|(
name|mtu
argument_list|)
expr_stmt|;
name|lwm
operator|=
name|min
argument_list|(
literal|3
operator|*
operator|(
name|int
operator|)
name|mtu
argument_list|,
name|MAC_RXFIFO_SIZE
operator|/
literal|4
argument_list|)
expr_stmt|;
name|v
operator|=
name|t3_read_reg
argument_list|(
name|adap
argument_list|,
name|A_XGM_RXFIFO_CFG
operator|+
name|mac
operator|->
name|offset
argument_list|)
expr_stmt|;
name|v
operator|&=
operator|~
name|V_RXFIFOPAUSELWM
argument_list|(
name|M_RXFIFOPAUSELWM
argument_list|)
expr_stmt|;
name|v
operator||=
name|V_RXFIFOPAUSELWM
argument_list|(
name|lwm
operator|/
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|G_RXFIFOPAUSEHWM
argument_list|(
name|v
argument_list|)
condition|)
name|v
operator|=
operator|(
name|v
operator|&
operator|~
name|V_RXFIFOPAUSEHWM
argument_list|(
name|M_RXFIFOPAUSEHWM
argument_list|)
operator|)
operator||
name|V_RXFIFOPAUSEHWM
argument_list|(
name|hwm
operator|/
literal|8
argument_list|)
expr_stmt|;
name|t3_write_reg
argument_list|(
name|adap
argument_list|,
name|A_XGM_RXFIFO_CFG
operator|+
name|mac
operator|->
name|offset
argument_list|,
name|v
argument_list|)
expr_stmt|;
comment|/* Adjust the TX FIFO threshold based on the MTU */
name|thres
operator|=
operator|(
name|adap
operator|->
name|params
operator|.
name|vpd
operator|.
name|cclk
operator|*
literal|1000
operator|)
operator|/
literal|15625
expr_stmt|;
name|thres
operator|=
operator|(
name|thres
operator|*
name|mtu
operator|)
operator|/
literal|1000
expr_stmt|;
if|if
condition|(
name|is_10G
argument_list|(
name|adap
argument_list|)
condition|)
name|thres
operator|/=
literal|10
expr_stmt|;
name|thres
operator|=
name|mtu
operator|>
name|thres
condition|?
operator|(
name|mtu
operator|-
name|thres
operator|+
literal|7
operator|)
operator|/
literal|8
else|:
literal|0
expr_stmt|;
name|thres
operator|=
name|max
argument_list|(
name|thres
argument_list|,
literal|8U
argument_list|)
expr_stmt|;
comment|/* need at least 8 */
name|ipg
operator|=
operator|(
name|adap
operator|->
name|params
operator|.
name|rev
operator|==
name|T3_REV_C
operator|)
condition|?
literal|0
else|:
literal|1
expr_stmt|;
name|t3_set_reg_field
argument_list|(
name|adap
argument_list|,
name|A_XGM_TXFIFO_CFG
operator|+
name|mac
operator|->
name|offset
argument_list|,
name|V_TXFIFOTHRESH
argument_list|(
name|M_TXFIFOTHRESH
argument_list|)
operator||
name|V_TXIPG
argument_list|(
name|M_TXIPG
argument_list|)
argument_list|,
name|V_TXFIFOTHRESH
argument_list|(
name|thres
argument_list|)
operator||
name|V_TXIPG
argument_list|(
name|ipg
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Assuming a minimum drain rate of 2.5Gbps... 	 */
if|if
condition|(
name|adap
operator|->
name|params
operator|.
name|rev
operator|>
literal|0
condition|)
block|{
name|divisor
operator|=
operator|(
name|adap
operator|->
name|params
operator|.
name|rev
operator|==
name|T3_REV_C
operator|)
condition|?
literal|64
else|:
literal|8
expr_stmt|;
name|t3_write_reg
argument_list|(
name|adap
argument_list|,
name|A_XGM_PAUSE_TIMER
operator|+
name|mac
operator|->
name|offset
argument_list|,
operator|(
name|hwm
operator|-
name|lwm
operator|)
operator|*
literal|4
operator|/
name|divisor
argument_list|)
expr_stmt|;
block|}
name|t3_write_reg
argument_list|(
name|adap
argument_list|,
name|A_XGM_TX_PAUSE_QUANTA
operator|+
name|mac
operator|->
name|offset
argument_list|,
name|MAC_RXFIFO_SIZE
operator|*
literal|4
operator|*
literal|8
operator|/
literal|512
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  *	t3_mac_set_speed_duplex_fc - set MAC speed, duplex and flow control  *	@mac: the MAC to configure  *	@speed: the desired speed (10/100/1000/10000)  *	@duplex: the desired duplex  *	@fc: desired Tx/Rx PAUSE configuration  *  *	Set the MAC speed, duplex (actually only full-duplex is supported), and  *	flow control.  If a parameter value is negative the corresponding  *	MAC setting is left at its current value.  */
end_comment

begin_function
name|int
name|t3_mac_set_speed_duplex_fc
parameter_list|(
name|struct
name|cmac
modifier|*
name|mac
parameter_list|,
name|int
name|speed
parameter_list|,
name|int
name|duplex
parameter_list|,
name|int
name|fc
parameter_list|)
block|{
name|u32
name|val
decl_stmt|;
name|adapter_t
modifier|*
name|adap
init|=
name|mac
operator|->
name|adapter
decl_stmt|;
name|unsigned
name|int
name|oft
init|=
name|mac
operator|->
name|offset
decl_stmt|;
if|if
condition|(
name|duplex
operator|>=
literal|0
operator|&&
name|duplex
operator|!=
name|DUPLEX_FULL
condition|)
return|return
operator|-
name|EINVAL
return|;
if|if
condition|(
name|mac
operator|->
name|multiport
condition|)
block|{
name|val
operator|=
name|t3_read_reg
argument_list|(
name|adap
argument_list|,
name|A_XGM_RXFIFO_CFG
operator|+
name|oft
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
name|V_RXFIFOPAUSEHWM
argument_list|(
name|M_RXFIFOPAUSEHWM
argument_list|)
expr_stmt|;
name|val
operator||=
name|V_RXFIFOPAUSEHWM
argument_list|(
name|rx_fifo_hwm
argument_list|(
name|t3_read_reg
argument_list|(
name|adap
argument_list|,
name|A_XGM_RX_MAX_PKT_SIZE
operator|+
name|oft
argument_list|)
argument_list|)
operator|/
literal|8
argument_list|)
expr_stmt|;
name|t3_write_reg
argument_list|(
name|adap
argument_list|,
name|A_XGM_RXFIFO_CFG
operator|+
name|oft
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|t3_set_reg_field
argument_list|(
name|adap
argument_list|,
name|A_XGM_TX_CFG
operator|+
name|oft
argument_list|,
name|F_TXPAUSEEN
argument_list|,
name|F_TXPAUSEEN
argument_list|)
expr_stmt|;
return|return
name|t3_vsc7323_set_speed_fc
argument_list|(
name|adap
argument_list|,
name|speed
argument_list|,
name|fc
argument_list|,
name|mac
operator|->
name|ext_port
argument_list|)
return|;
block|}
if|if
condition|(
name|speed
operator|>=
literal|0
condition|)
block|{
if|if
condition|(
name|speed
operator|==
name|SPEED_10
condition|)
name|val
operator|=
name|V_PORTSPEED
argument_list|(
literal|0
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|speed
operator|==
name|SPEED_100
condition|)
name|val
operator|=
name|V_PORTSPEED
argument_list|(
literal|1
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|speed
operator|==
name|SPEED_1000
condition|)
name|val
operator|=
name|V_PORTSPEED
argument_list|(
literal|2
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|speed
operator|==
name|SPEED_10000
condition|)
name|val
operator|=
name|V_PORTSPEED
argument_list|(
literal|3
argument_list|)
expr_stmt|;
else|else
return|return
operator|-
name|EINVAL
return|;
name|t3_set_reg_field
argument_list|(
name|adap
argument_list|,
name|A_XGM_PORT_CFG
operator|+
name|oft
argument_list|,
name|V_PORTSPEED
argument_list|(
name|M_PORTSPEED
argument_list|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
name|val
operator|=
name|t3_read_reg
argument_list|(
name|adap
argument_list|,
name|A_XGM_RXFIFO_CFG
operator|+
name|oft
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
name|V_RXFIFOPAUSEHWM
argument_list|(
name|M_RXFIFOPAUSEHWM
argument_list|)
expr_stmt|;
if|if
condition|(
name|fc
operator|&
name|PAUSE_TX
condition|)
name|val
operator||=
name|V_RXFIFOPAUSEHWM
argument_list|(
name|rx_fifo_hwm
argument_list|(
name|t3_read_reg
argument_list|(
name|adap
argument_list|,
name|A_XGM_RX_MAX_PKT_SIZE
operator|+
name|oft
argument_list|)
argument_list|)
operator|/
literal|8
argument_list|)
expr_stmt|;
name|t3_write_reg
argument_list|(
name|adap
argument_list|,
name|A_XGM_RXFIFO_CFG
operator|+
name|oft
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|t3_set_reg_field
argument_list|(
name|adap
argument_list|,
name|A_XGM_TX_CFG
operator|+
name|oft
argument_list|,
name|F_TXPAUSEEN
argument_list|,
operator|(
name|fc
operator|&
name|PAUSE_RX
operator|)
condition|?
name|F_TXPAUSEEN
else|:
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  *	t3_mac_enable - enable the MAC in the given directions  *	@mac: the MAC to configure  *	@which: bitmap indicating which directions to enable  *  *	Enables the MAC for operation in the given directions.  *	%MAC_DIRECTION_TX enables the Tx direction, and %MAC_DIRECTION_RX  *	enables the Rx one.  */
end_comment

begin_function
name|int
name|t3_mac_enable
parameter_list|(
name|struct
name|cmac
modifier|*
name|mac
parameter_list|,
name|int
name|which
parameter_list|)
block|{
name|int
name|idx
init|=
name|macidx
argument_list|(
name|mac
argument_list|)
decl_stmt|;
name|adapter_t
modifier|*
name|adap
init|=
name|mac
operator|->
name|adapter
decl_stmt|;
name|unsigned
name|int
name|oft
init|=
name|mac
operator|->
name|offset
decl_stmt|;
name|struct
name|mac_stats
modifier|*
name|s
init|=
operator|&
name|mac
operator|->
name|stats
decl_stmt|;
if|if
condition|(
name|mac
operator|->
name|multiport
condition|)
return|return
name|t3_vsc7323_enable
argument_list|(
name|adap
argument_list|,
name|mac
operator|->
name|ext_port
argument_list|,
name|which
argument_list|)
return|;
if|if
condition|(
name|which
operator|&
name|MAC_DIRECTION_TX
condition|)
block|{
name|t3_write_reg
argument_list|(
name|adap
argument_list|,
name|A_TP_PIO_ADDR
argument_list|,
name|A_TP_TX_DROP_CFG_CH0
operator|+
name|idx
argument_list|)
expr_stmt|;
name|t3_write_reg
argument_list|(
name|adap
argument_list|,
name|A_TP_PIO_DATA
argument_list|,
name|adap
operator|->
name|params
operator|.
name|rev
operator|==
name|T3_REV_C
condition|?
literal|0xc4ffff01
else|:
literal|0xc0ede401
argument_list|)
expr_stmt|;
name|t3_write_reg
argument_list|(
name|adap
argument_list|,
name|A_TP_PIO_ADDR
argument_list|,
name|A_TP_TX_DROP_MODE
argument_list|)
expr_stmt|;
name|t3_set_reg_field
argument_list|(
name|adap
argument_list|,
name|A_TP_PIO_DATA
argument_list|,
literal|1
operator|<<
name|idx
argument_list|,
name|adap
operator|->
name|params
operator|.
name|rev
operator|==
name|T3_REV_C
condition|?
literal|0
else|:
literal|1
operator|<<
name|idx
argument_list|)
expr_stmt|;
name|t3_write_reg
argument_list|(
name|adap
argument_list|,
name|A_XGM_TX_CTRL
operator|+
name|oft
argument_list|,
name|F_TXEN
argument_list|)
expr_stmt|;
name|t3_write_reg
argument_list|(
name|adap
argument_list|,
name|A_TP_PIO_ADDR
argument_list|,
name|A_TP_TX_DROP_CNT_CH0
operator|+
name|idx
argument_list|)
expr_stmt|;
name|mac
operator|->
name|tx_mcnt
operator|=
name|s
operator|->
name|tx_frames
expr_stmt|;
name|mac
operator|->
name|tx_tcnt
operator|=
operator|(
name|G_TXDROPCNTCH0RCVD
argument_list|(
name|t3_read_reg
argument_list|(
name|adap
argument_list|,
name|A_TP_PIO_DATA
argument_list|)
argument_list|)
operator|)
expr_stmt|;
name|mac
operator|->
name|tx_xcnt
operator|=
operator|(
name|G_TXSPI4SOPCNT
argument_list|(
name|t3_read_reg
argument_list|(
name|adap
argument_list|,
name|A_XGM_TX_SPI4_SOP_EOP_CNT
operator|+
name|oft
argument_list|)
argument_list|)
operator|)
expr_stmt|;
name|mac
operator|->
name|rx_mcnt
operator|=
name|s
operator|->
name|rx_frames
expr_stmt|;
name|mac
operator|->
name|rx_pause
operator|=
name|s
operator|->
name|rx_pause
expr_stmt|;
name|mac
operator|->
name|rx_xcnt
operator|=
operator|(
name|G_TXSPI4SOPCNT
argument_list|(
name|t3_read_reg
argument_list|(
name|adap
argument_list|,
name|A_XGM_RX_SPI4_SOP_EOP_CNT
operator|+
name|oft
argument_list|)
argument_list|)
operator|)
expr_stmt|;
name|mac
operator|->
name|rx_ocnt
operator|=
name|s
operator|->
name|rx_fifo_ovfl
expr_stmt|;
name|mac
operator|->
name|txen
operator|=
name|F_TXEN
expr_stmt|;
name|mac
operator|->
name|toggle_cnt
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|which
operator|&
name|MAC_DIRECTION_RX
condition|)
name|t3_write_reg
argument_list|(
name|adap
argument_list|,
name|A_XGM_RX_CTRL
operator|+
name|oft
argument_list|,
name|F_RXEN
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  *	t3_mac_disable - disable the MAC in the given directions  *	@mac: the MAC to configure  *	@which: bitmap indicating which directions to disable  *  *	Disables the MAC in the given directions.  *	%MAC_DIRECTION_TX disables the Tx direction, and %MAC_DIRECTION_RX  *	disables the Rx one.  */
end_comment

begin_function
name|int
name|t3_mac_disable
parameter_list|(
name|struct
name|cmac
modifier|*
name|mac
parameter_list|,
name|int
name|which
parameter_list|)
block|{
name|adapter_t
modifier|*
name|adap
init|=
name|mac
operator|->
name|adapter
decl_stmt|;
if|if
condition|(
name|mac
operator|->
name|multiport
condition|)
return|return
name|t3_vsc7323_disable
argument_list|(
name|adap
argument_list|,
name|mac
operator|->
name|ext_port
argument_list|,
name|which
argument_list|)
return|;
if|if
condition|(
name|which
operator|&
name|MAC_DIRECTION_TX
condition|)
block|{
name|t3_write_reg
argument_list|(
name|adap
argument_list|,
name|A_XGM_TX_CTRL
operator|+
name|mac
operator|->
name|offset
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mac
operator|->
name|txen
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|which
operator|&
name|MAC_DIRECTION_RX
condition|)
block|{
name|int
name|val
init|=
name|F_MAC_RESET_
decl_stmt|;
name|t3_set_reg_field
argument_list|(
name|mac
operator|->
name|adapter
argument_list|,
name|A_XGM_RESET_CTRL
operator|+
name|mac
operator|->
name|offset
argument_list|,
name|F_PCS_RESET_
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|msleep
argument_list|(
literal|100
argument_list|)
expr_stmt|;
name|t3_write_reg
argument_list|(
name|adap
argument_list|,
name|A_XGM_RX_CTRL
operator|+
name|mac
operator|->
name|offset
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_10G
argument_list|(
name|adap
argument_list|)
condition|)
name|val
operator||=
name|F_PCS_RESET_
expr_stmt|;
elseif|else
if|if
condition|(
name|uses_xaui
argument_list|(
name|adap
argument_list|)
condition|)
name|val
operator||=
name|F_PCS_RESET_
operator||
name|F_XG2G_RESET_
expr_stmt|;
else|else
name|val
operator||=
name|F_RGMII_RESET_
operator||
name|F_XG2G_RESET_
expr_stmt|;
name|t3_write_reg
argument_list|(
name|mac
operator|->
name|adapter
argument_list|,
name|A_XGM_RESET_CTRL
operator|+
name|mac
operator|->
name|offset
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|t3b2_mac_watchdog_task
parameter_list|(
name|struct
name|cmac
modifier|*
name|mac
parameter_list|)
block|{
name|int
name|status
decl_stmt|;
name|unsigned
name|int
name|tx_tcnt
decl_stmt|,
name|tx_xcnt
decl_stmt|;
name|adapter_t
modifier|*
name|adap
init|=
name|mac
operator|->
name|adapter
decl_stmt|;
name|struct
name|mac_stats
modifier|*
name|s
init|=
operator|&
name|mac
operator|->
name|stats
decl_stmt|;
name|unsigned
name|int
name|tx_mcnt
init|=
operator|(
name|unsigned
name|int
operator|)
name|s
operator|->
name|tx_frames
decl_stmt|;
if|if
condition|(
name|mac
operator|->
name|multiport
condition|)
block|{
name|tx_mcnt
operator|=
name|t3_read_reg
argument_list|(
name|adap
argument_list|,
name|A_XGM_STAT_TX_FRAME_LOW
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tx_mcnt
operator|=
operator|(
name|unsigned
name|int
operator|)
name|s
operator|->
name|tx_frames
expr_stmt|;
block|}
name|status
operator|=
literal|0
expr_stmt|;
name|tx_xcnt
operator|=
literal|1
expr_stmt|;
comment|/* By default tx_xcnt is making progress*/
name|tx_tcnt
operator|=
name|mac
operator|->
name|tx_tcnt
expr_stmt|;
comment|/* If tx_mcnt is progressing ignore tx_tcnt*/
if|if
condition|(
name|tx_mcnt
operator|==
name|mac
operator|->
name|tx_mcnt
operator|&&
name|mac
operator|->
name|rx_pause
operator|==
name|s
operator|->
name|rx_pause
condition|)
block|{
name|tx_xcnt
operator|=
operator|(
name|G_TXSPI4SOPCNT
argument_list|(
name|t3_read_reg
argument_list|(
name|adap
argument_list|,
name|A_XGM_TX_SPI4_SOP_EOP_CNT
operator|+
name|mac
operator|->
name|offset
argument_list|)
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
name|tx_xcnt
operator|==
literal|0
condition|)
block|{
name|t3_write_reg
argument_list|(
name|adap
argument_list|,
name|A_TP_PIO_ADDR
argument_list|,
name|A_TP_TX_DROP_CNT_CH0
operator|+
name|macidx
argument_list|(
name|mac
argument_list|)
argument_list|)
expr_stmt|;
name|tx_tcnt
operator|=
operator|(
name|G_TXDROPCNTCH0RCVD
argument_list|(
name|t3_read_reg
argument_list|(
name|adap
argument_list|,
name|A_TP_PIO_DATA
argument_list|)
argument_list|)
operator|)
expr_stmt|;
block|}
else|else
block|{
goto|goto
name|out
goto|;
block|}
block|}
else|else
block|{
name|mac
operator|->
name|toggle_cnt
operator|=
literal|0
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
operator|(
name|tx_tcnt
operator|!=
name|mac
operator|->
name|tx_tcnt
operator|)
operator|&&
operator|(
name|mac
operator|->
name|tx_xcnt
operator|==
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|mac
operator|->
name|toggle_cnt
operator|>
literal|4
condition|)
block|{
name|status
operator|=
literal|2
expr_stmt|;
goto|goto
name|out
goto|;
block|}
else|else
block|{
name|status
operator|=
literal|1
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
else|else
block|{
name|mac
operator|->
name|toggle_cnt
operator|=
literal|0
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|out
label|:
name|mac
operator|->
name|tx_tcnt
operator|=
name|tx_tcnt
expr_stmt|;
name|mac
operator|->
name|tx_xcnt
operator|=
name|tx_xcnt
expr_stmt|;
name|mac
operator|->
name|tx_mcnt
operator|=
name|s
operator|->
name|tx_frames
expr_stmt|;
name|mac
operator|->
name|rx_pause
operator|=
name|s
operator|->
name|rx_pause
expr_stmt|;
if|if
condition|(
name|status
operator|==
literal|1
condition|)
block|{
name|t3_write_reg
argument_list|(
name|adap
argument_list|,
name|A_XGM_TX_CTRL
operator|+
name|mac
operator|->
name|offset
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|t3_read_reg
argument_list|(
name|adap
argument_list|,
name|A_XGM_TX_CTRL
operator|+
name|mac
operator|->
name|offset
argument_list|)
expr_stmt|;
comment|/* flush */
name|t3_write_reg
argument_list|(
name|adap
argument_list|,
name|A_XGM_TX_CTRL
operator|+
name|mac
operator|->
name|offset
argument_list|,
name|mac
operator|->
name|txen
argument_list|)
expr_stmt|;
name|t3_read_reg
argument_list|(
name|adap
argument_list|,
name|A_XGM_TX_CTRL
operator|+
name|mac
operator|->
name|offset
argument_list|)
expr_stmt|;
comment|/* flush */
name|mac
operator|->
name|toggle_cnt
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|status
operator|==
literal|2
condition|)
block|{
name|t3b2_mac_reset
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|mac
operator|->
name|toggle_cnt
operator|=
literal|0
expr_stmt|;
block|}
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**  *	t3_mac_update_stats - accumulate MAC statistics  *	@mac: the MAC handle  *  *	This function is called periodically to accumulate the current values  *	of the RMON counters into the port statistics.  Since the packet  *	counters are only 32 bits they can overflow in ~286 secs at 10G, so the  *	function should be called more frequently than that.  The byte counters  *	are 45-bit wide, they would overflow in ~7.8 hours.  */
end_comment

begin_function
specifier|const
name|struct
name|mac_stats
modifier|*
name|t3_mac_update_stats
parameter_list|(
name|struct
name|cmac
modifier|*
name|mac
parameter_list|)
block|{
define|#
directive|define
name|RMON_READ
parameter_list|(
name|mac
parameter_list|,
name|addr
parameter_list|)
value|t3_read_reg(mac->adapter, addr + mac->offset)
define|#
directive|define
name|RMON_UPDATE
parameter_list|(
name|mac
parameter_list|,
name|name
parameter_list|,
name|reg
parameter_list|)
define|\
value|(mac)->stats.name += (u64)RMON_READ(mac, A_XGM_STAT_##reg)
define|#
directive|define
name|RMON_UPDATE64
parameter_list|(
name|mac
parameter_list|,
name|name
parameter_list|,
name|reg_lo
parameter_list|,
name|reg_hi
parameter_list|)
define|\
value|(mac)->stats.name += RMON_READ(mac, A_XGM_STAT_##reg_lo) + \ 			     ((u64)RMON_READ(mac, A_XGM_STAT_##reg_hi)<< 32)
name|u32
name|v
decl_stmt|,
name|lo
decl_stmt|;
if|if
condition|(
name|mac
operator|->
name|multiport
condition|)
return|return
name|t3_vsc7323_update_stats
argument_list|(
name|mac
argument_list|)
return|;
name|RMON_UPDATE64
argument_list|(
name|mac
argument_list|,
name|rx_octets
argument_list|,
name|RX_BYTES_LOW
argument_list|,
name|RX_BYTES_HIGH
argument_list|)
expr_stmt|;
name|RMON_UPDATE64
argument_list|(
name|mac
argument_list|,
name|rx_frames
argument_list|,
name|RX_FRAMES_LOW
argument_list|,
name|RX_FRAMES_HIGH
argument_list|)
expr_stmt|;
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|rx_mcast_frames
argument_list|,
name|RX_MCAST_FRAMES
argument_list|)
expr_stmt|;
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|rx_bcast_frames
argument_list|,
name|RX_BCAST_FRAMES
argument_list|)
expr_stmt|;
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|rx_fcs_errs
argument_list|,
name|RX_CRC_ERR_FRAMES
argument_list|)
expr_stmt|;
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|rx_pause
argument_list|,
name|RX_PAUSE_FRAMES
argument_list|)
expr_stmt|;
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|rx_jabber
argument_list|,
name|RX_JABBER_FRAMES
argument_list|)
expr_stmt|;
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|rx_short
argument_list|,
name|RX_SHORT_FRAMES
argument_list|)
expr_stmt|;
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|rx_symbol_errs
argument_list|,
name|RX_SYM_CODE_ERR_FRAMES
argument_list|)
expr_stmt|;
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|rx_too_long
argument_list|,
name|RX_OVERSIZE_FRAMES
argument_list|)
expr_stmt|;
name|v
operator|=
name|RMON_READ
argument_list|(
name|mac
argument_list|,
name|A_XGM_RX_MAX_PKT_SIZE_ERR_CNT
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|adapter
operator|->
name|params
operator|.
name|rev
operator|==
name|T3_REV_B2
condition|)
name|v
operator|&=
literal|0x7fffffff
expr_stmt|;
name|mac
operator|->
name|stats
operator|.
name|rx_too_long
operator|+=
name|v
expr_stmt|;
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|rx_frames_64
argument_list|,
name|RX_64B_FRAMES
argument_list|)
expr_stmt|;
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|rx_frames_65_127
argument_list|,
name|RX_65_127B_FRAMES
argument_list|)
expr_stmt|;
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|rx_frames_128_255
argument_list|,
name|RX_128_255B_FRAMES
argument_list|)
expr_stmt|;
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|rx_frames_256_511
argument_list|,
name|RX_256_511B_FRAMES
argument_list|)
expr_stmt|;
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|rx_frames_512_1023
argument_list|,
name|RX_512_1023B_FRAMES
argument_list|)
expr_stmt|;
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|rx_frames_1024_1518
argument_list|,
name|RX_1024_1518B_FRAMES
argument_list|)
expr_stmt|;
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|rx_frames_1519_max
argument_list|,
name|RX_1519_MAXB_FRAMES
argument_list|)
expr_stmt|;
name|RMON_UPDATE64
argument_list|(
name|mac
argument_list|,
name|tx_octets
argument_list|,
name|TX_BYTE_LOW
argument_list|,
name|TX_BYTE_HIGH
argument_list|)
expr_stmt|;
name|RMON_UPDATE64
argument_list|(
name|mac
argument_list|,
name|tx_frames
argument_list|,
name|TX_FRAME_LOW
argument_list|,
name|TX_FRAME_HIGH
argument_list|)
expr_stmt|;
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|tx_mcast_frames
argument_list|,
name|TX_MCAST
argument_list|)
expr_stmt|;
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|tx_bcast_frames
argument_list|,
name|TX_BCAST
argument_list|)
expr_stmt|;
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|tx_pause
argument_list|,
name|TX_PAUSE
argument_list|)
expr_stmt|;
comment|/* This counts error frames in general (bad FCS, underrun, etc). */
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|tx_underrun
argument_list|,
name|TX_ERR_FRAMES
argument_list|)
expr_stmt|;
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|tx_frames_64
argument_list|,
name|TX_64B_FRAMES
argument_list|)
expr_stmt|;
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|tx_frames_65_127
argument_list|,
name|TX_65_127B_FRAMES
argument_list|)
expr_stmt|;
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|tx_frames_128_255
argument_list|,
name|TX_128_255B_FRAMES
argument_list|)
expr_stmt|;
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|tx_frames_256_511
argument_list|,
name|TX_256_511B_FRAMES
argument_list|)
expr_stmt|;
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|tx_frames_512_1023
argument_list|,
name|TX_512_1023B_FRAMES
argument_list|)
expr_stmt|;
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|tx_frames_1024_1518
argument_list|,
name|TX_1024_1518B_FRAMES
argument_list|)
expr_stmt|;
name|RMON_UPDATE
argument_list|(
name|mac
argument_list|,
name|tx_frames_1519_max
argument_list|,
name|TX_1519_MAXB_FRAMES
argument_list|)
expr_stmt|;
comment|/* The next stat isn't clear-on-read. */
name|t3_write_reg
argument_list|(
name|mac
operator|->
name|adapter
argument_list|,
name|A_TP_MIB_INDEX
argument_list|,
name|mac
operator|->
name|offset
condition|?
literal|51
else|:
literal|50
argument_list|)
expr_stmt|;
name|v
operator|=
name|t3_read_reg
argument_list|(
name|mac
operator|->
name|adapter
argument_list|,
name|A_TP_MIB_RDATA
argument_list|)
expr_stmt|;
name|lo
operator|=
operator|(
name|u32
operator|)
name|mac
operator|->
name|stats
operator|.
name|rx_cong_drops
expr_stmt|;
name|mac
operator|->
name|stats
operator|.
name|rx_cong_drops
operator|+=
call|(
name|u64
call|)
argument_list|(
name|v
operator|-
name|lo
argument_list|)
expr_stmt|;
return|return
operator|&
name|mac
operator|->
name|stats
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/**************************************************************************  Copyright (c) 2008, Chelsio Inc. All rights reserved.  Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:   1. Redistributions of source code must retain the above copyright notice,     this list of conditions and the following disclaimer.   2. Neither the name of the Chelsio Corporation nor the names of its     contributors may be used to endorse or promote products derived from     this software without specific prior written permission.  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  ***************************************************************************/
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<cxgb_include.h>
end_include

begin_undef
undef|#
directive|undef
name|msleep
end_undef

begin_define
define|#
directive|define
name|msleep
value|t3_os_sleep
end_define

begin_comment
comment|/* TN1010 PHY specific registers. */
end_comment

begin_enum
enum|enum
block|{
name|TN1010_VEND1_STAT
init|=
literal|1
block|, }
enum|;
end_enum

begin_comment
comment|/* IEEE auto-negotiation 10GBASE-T registers */
end_comment

begin_enum
enum|enum
block|{
name|ANEG_ADVER
init|=
literal|16
block|,
name|ANEG_LPA
init|=
literal|19
block|,
name|ANEG_10G_CTRL
init|=
literal|32
block|,
name|ANEG_10G_STAT
init|=
literal|33
block|}
enum|;
end_enum

begin_define
define|#
directive|define
name|ADVERTISE_ENPAGE
value|(1<< 12)
end_define

begin_define
define|#
directive|define
name|ADVERTISE_10000FULL
value|(1<< 12)
end_define

begin_define
define|#
directive|define
name|ADVERTISE_LOOP_TIMING
value|(1<< 0)
end_define

begin_comment
comment|/* vendor specific status register fields */
end_comment

begin_define
define|#
directive|define
name|F_XS_LANE_ALIGN_STAT
value|(1<< 0)
end_define

begin_define
define|#
directive|define
name|F_PCS_BLK_LOCK
value|(1<< 1)
end_define

begin_define
define|#
directive|define
name|F_PMD_SIGNAL_OK
value|(1<< 2)
end_define

begin_define
define|#
directive|define
name|F_LINK_STAT
value|(1<< 3)
end_define

begin_define
define|#
directive|define
name|F_ANEG_SPEED_1G
value|(1<< 4)
end_define

begin_define
define|#
directive|define
name|F_ANEG_MASTER
value|(1<< 5)
end_define

begin_define
define|#
directive|define
name|S_ANEG_STAT
value|6
end_define

begin_define
define|#
directive|define
name|M_ANEG_STAT
value|0x3
end_define

begin_define
define|#
directive|define
name|G_ANEG_STAT
parameter_list|(
name|x
parameter_list|)
value|(((x)>> S_ANEG_STAT)& M_ANEG_STAT)
end_define

begin_enum
enum|enum
block|{
comment|/* autonegotiation status */
name|ANEG_IN_PROGR
init|=
literal|0
block|,
name|ANEG_COMPLETE
init|=
literal|1
block|,
name|ANEG_FAILED
init|=
literal|3
block|}
enum|;
end_enum

begin_comment
comment|/*  * Reset the PHY.  May take up to 500ms to complete.  */
end_comment

begin_function
specifier|static
name|int
name|tn1010_reset
parameter_list|(
name|struct
name|cphy
modifier|*
name|phy
parameter_list|,
name|int
name|wait
parameter_list|)
block|{
name|int
name|err
init|=
name|t3_phy_reset
argument_list|(
name|phy
argument_list|,
name|MDIO_DEV_PMA_PMD
argument_list|,
name|wait
argument_list|)
decl_stmt|;
name|msleep
argument_list|(
literal|500
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tn1010_power_down
parameter_list|(
name|struct
name|cphy
modifier|*
name|phy
parameter_list|,
name|int
name|enable
parameter_list|)
block|{
return|return
name|t3_mdio_change_bits
argument_list|(
name|phy
argument_list|,
name|MDIO_DEV_PMA_PMD
argument_list|,
name|MII_BMCR
argument_list|,
name|BMCR_PDOWN
argument_list|,
name|enable
condition|?
name|BMCR_PDOWN
else|:
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tn1010_autoneg_enable
parameter_list|(
name|struct
name|cphy
modifier|*
name|phy
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|err
operator|=
name|tn1010_power_down
argument_list|(
name|phy
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|err
condition|)
name|err
operator|=
name|t3_mdio_change_bits
argument_list|(
name|phy
argument_list|,
name|MDIO_DEV_ANEG
argument_list|,
name|MII_BMCR
argument_list|,
literal|0
argument_list|,
name|BMCR_ANENABLE
operator||
name|BMCR_ANRESTART
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tn1010_autoneg_restart
parameter_list|(
name|struct
name|cphy
modifier|*
name|phy
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|err
operator|=
name|tn1010_power_down
argument_list|(
name|phy
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|err
condition|)
name|err
operator|=
name|t3_mdio_change_bits
argument_list|(
name|phy
argument_list|,
name|MDIO_DEV_ANEG
argument_list|,
name|MII_BMCR
argument_list|,
literal|0
argument_list|,
name|BMCR_ANRESTART
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tn1010_advertise
parameter_list|(
name|struct
name|cphy
modifier|*
name|phy
parameter_list|,
name|unsigned
name|int
name|advert
parameter_list|)
block|{
name|int
name|err
decl_stmt|,
name|val
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|advert
operator|&
name|ADVERTISED_1000baseT_Full
operator|)
condition|)
return|return
operator|-
name|EINVAL
return|;
comment|/* PHY can't disable 1000BASE-T */
name|val
operator|=
name|ADVERTISE_CSMA
operator||
name|ADVERTISE_ENPAGE
operator||
name|ADVERTISE_NPAGE
expr_stmt|;
if|if
condition|(
name|advert
operator|&
name|ADVERTISED_Pause
condition|)
name|val
operator||=
name|ADVERTISE_PAUSE_CAP
expr_stmt|;
if|if
condition|(
name|advert
operator|&
name|ADVERTISED_Asym_Pause
condition|)
name|val
operator||=
name|ADVERTISE_PAUSE_ASYM
expr_stmt|;
name|err
operator|=
name|mdio_write
argument_list|(
name|phy
argument_list|,
name|MDIO_DEV_ANEG
argument_list|,
name|ANEG_ADVER
argument_list|,
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
name|val
operator|=
operator|(
name|advert
operator|&
name|ADVERTISED_10000baseT_Full
operator|)
condition|?
name|ADVERTISE_10000FULL
else|:
literal|0
expr_stmt|;
return|return
name|mdio_write
argument_list|(
name|phy
argument_list|,
name|MDIO_DEV_ANEG
argument_list|,
name|ANEG_10G_CTRL
argument_list|,
name|val
operator||
name|ADVERTISE_LOOP_TIMING
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tn1010_get_link_status
parameter_list|(
name|struct
name|cphy
modifier|*
name|phy
parameter_list|,
name|int
modifier|*
name|link_ok
parameter_list|,
name|int
modifier|*
name|speed
parameter_list|,
name|int
modifier|*
name|duplex
parameter_list|,
name|int
modifier|*
name|fc
parameter_list|)
block|{
name|unsigned
name|int
name|status
decl_stmt|,
name|lpa
decl_stmt|,
name|adv
decl_stmt|;
name|int
name|err
decl_stmt|,
name|sp
init|=
operator|-
literal|1
decl_stmt|,
name|pause
init|=
literal|0
decl_stmt|;
name|err
operator|=
name|mdio_read
argument_list|(
name|phy
argument_list|,
name|MDIO_DEV_VEND1
argument_list|,
name|TN1010_VEND1_STAT
argument_list|,
operator|&
name|status
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
if|if
condition|(
name|link_ok
condition|)
operator|*
name|link_ok
operator|=
operator|(
name|status
operator|&
name|F_LINK_STAT
operator|)
operator|!=
literal|0
expr_stmt|;
if|if
condition|(
name|G_ANEG_STAT
argument_list|(
name|status
argument_list|)
operator|==
name|ANEG_COMPLETE
condition|)
block|{
name|sp
operator|=
operator|(
name|status
operator|&
name|F_ANEG_SPEED_1G
operator|)
condition|?
name|SPEED_1000
else|:
name|SPEED_10000
expr_stmt|;
if|if
condition|(
name|fc
condition|)
block|{
name|err
operator|=
name|mdio_read
argument_list|(
name|phy
argument_list|,
name|MDIO_DEV_ANEG
argument_list|,
name|ANEG_LPA
argument_list|,
operator|&
name|lpa
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|err
condition|)
name|err
operator|=
name|mdio_read
argument_list|(
name|phy
argument_list|,
name|MDIO_DEV_ANEG
argument_list|,
name|ANEG_ADVER
argument_list|,
operator|&
name|adv
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
if|if
condition|(
name|lpa
operator|&
name|adv
operator|&
name|ADVERTISE_PAUSE_CAP
condition|)
name|pause
operator|=
name|PAUSE_RX
operator||
name|PAUSE_TX
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|lpa
operator|&
name|ADVERTISE_PAUSE_CAP
operator|)
operator|&&
operator|(
name|lpa
operator|&
name|ADVERTISE_PAUSE_ASYM
operator|)
operator|&&
operator|(
name|adv
operator|&
name|ADVERTISE_PAUSE_ASYM
operator|)
condition|)
name|pause
operator|=
name|PAUSE_TX
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|lpa
operator|&
name|ADVERTISE_PAUSE_ASYM
operator|)
operator|&&
operator|(
name|adv
operator|&
name|ADVERTISE_PAUSE_CAP
operator|)
condition|)
name|pause
operator|=
name|PAUSE_RX
expr_stmt|;
block|}
block|}
if|if
condition|(
name|speed
condition|)
operator|*
name|speed
operator|=
name|sp
expr_stmt|;
if|if
condition|(
name|duplex
condition|)
operator|*
name|duplex
operator|=
name|DUPLEX_FULL
expr_stmt|;
if|if
condition|(
name|fc
condition|)
operator|*
name|fc
operator|=
name|pause
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tn1010_set_speed_duplex
parameter_list|(
name|struct
name|cphy
modifier|*
name|phy
parameter_list|,
name|int
name|speed
parameter_list|,
name|int
name|duplex
parameter_list|)
block|{
return|return
operator|-
name|EINVAL
return|;
comment|/* require autoneg */
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|C99_NOT_SUPPORTED
end_ifdef

begin_decl_stmt
specifier|static
name|struct
name|cphy_ops
name|tn1010_ops
init|=
block|{
name|tn1010_reset
block|,
name|t3_phy_lasi_intr_enable
block|,
name|t3_phy_lasi_intr_disable
block|,
name|t3_phy_lasi_intr_clear
block|,
name|t3_phy_lasi_intr_handler
block|,
name|tn1010_autoneg_enable
block|,
name|tn1010_autoneg_restart
block|,
name|tn1010_advertise
block|,
name|NULL
block|,
name|tn1010_set_speed_duplex
block|,
name|tn1010_get_link_status
block|,
name|tn1010_power_down
block|, }
decl_stmt|;
end_decl_stmt

begin_else
else|#
directive|else
end_else

begin_decl_stmt
specifier|static
name|struct
name|cphy_ops
name|tn1010_ops
init|=
block|{
operator|.
name|reset
operator|=
name|tn1010_reset
block|,
operator|.
name|intr_enable
operator|=
name|t3_phy_lasi_intr_enable
block|,
operator|.
name|intr_disable
operator|=
name|t3_phy_lasi_intr_disable
block|,
operator|.
name|intr_clear
operator|=
name|t3_phy_lasi_intr_clear
block|,
operator|.
name|intr_handler
operator|=
name|t3_phy_lasi_intr_handler
block|,
operator|.
name|autoneg_enable
operator|=
name|tn1010_autoneg_enable
block|,
operator|.
name|autoneg_restart
operator|=
name|tn1010_autoneg_restart
block|,
operator|.
name|advertise
operator|=
name|tn1010_advertise
block|,
operator|.
name|set_speed_duplex
operator|=
name|tn1010_set_speed_duplex
block|,
operator|.
name|get_link_status
operator|=
name|tn1010_get_link_status
block|,
operator|.
name|power_down
operator|=
name|tn1010_power_down
block|, }
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|int
name|t3_tn1010_phy_prep
parameter_list|(
name|pinfo_t
modifier|*
name|pinfo
parameter_list|,
name|int
name|phy_addr
parameter_list|,
specifier|const
name|struct
name|mdio_ops
modifier|*
name|mdio_ops
parameter_list|)
block|{
name|cphy_init
argument_list|(
operator|&
name|pinfo
operator|->
name|phy
argument_list|,
name|pinfo
operator|->
name|adapter
argument_list|,
name|pinfo
argument_list|,
name|phy_addr
argument_list|,
operator|&
name|tn1010_ops
argument_list|,
name|mdio_ops
argument_list|,
name|SUPPORTED_1000baseT_Full
operator||
name|SUPPORTED_10000baseT_Full
operator||
name|SUPPORTED_Autoneg
operator||
name|SUPPORTED_AUI
operator||
name|SUPPORTED_TP
argument_list|,
literal|"1000/10GBASE-T"
argument_list|)
expr_stmt|;
name|msleep
argument_list|(
literal|500
argument_list|)
expr_stmt|;
comment|/* PHY needs up to 500ms to start responding to MDIO */
return|return
literal|0
return|;
block|}
end_function

end_unit


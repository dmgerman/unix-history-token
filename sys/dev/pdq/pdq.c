begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 1995,1996 Matt Thomas<matt@3am-software.com>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. The name of the author may not be used to endorse or promote products  *    derived from this software withough specific prior written permission  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  *  * $FreeBSD$  *  */
end_comment

begin_comment
comment|/*  * DEC PDQ FDDI Controller O/S independent code  *  * This module should work any PDQ based board.  Note that changes for  * MIPS and Alpha architectures (or any other architecture which requires  * a flushing of memory or write buffers and/or has incoherent caches)  * have yet to be made.  *  * However, it is expected that the PDQ_CSR_WRITE macro will cause a   * flushing of the write buffers.  */
end_comment

begin_define
define|#
directive|define
name|PDQ_HWSUPPORT
end_define

begin_comment
comment|/* for pdq.h */
end_comment

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__FreeBSD__
argument_list|)
end_if

begin_include
include|#
directive|include
file|<dev/pdq/pdqvar.h>
end_include

begin_include
include|#
directive|include
file|<dev/pdq/pdqreg.h>
end_include

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|"pdqvar.h"
end_include

begin_include
include|#
directive|include
file|"pdqreg.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|PDQ_ROUNDUP
parameter_list|(
name|n
parameter_list|,
name|x
parameter_list|)
value|(((n) + ((x) - 1))& ~((x) - 1))
end_define

begin_define
define|#
directive|define
name|PDQ_CMD_RX_ALIGNMENT
value|16
end_define

begin_if
if|#
directive|if
operator|(
name|defined
argument_list|(
name|PDQTEST
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|PDQ_NOPRINTF
argument_list|)
operator|)
operator|||
name|defined
argument_list|(
name|PDQVERBOSE
argument_list|)
end_if

begin_define
define|#
directive|define
name|PDQ_PRINTF
parameter_list|(
name|x
parameter_list|)
value|printf x
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|PDQ_PRINTF
parameter_list|(
name|x
parameter_list|)
value|do { } while (0)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
specifier|const
name|pdq_halt_codes
index|[]
init|=
block|{
literal|"Selftest Timeout"
block|,
literal|"Host Bus Parity Error"
block|,
literal|"Host Directed Fault"
block|,
literal|"Software Fault"
block|,
literal|"Hardware Fault"
block|,
literal|"PC Trace Path Test"
block|,
literal|"DMA Error"
block|,
literal|"Image CRC Error"
block|,
literal|"Adapter Processer Error"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
specifier|const
name|pdq_adapter_states
index|[]
init|=
block|{
literal|"Reset"
block|,
literal|"Upgrade"
block|,
literal|"DMA Unavailable"
block|,
literal|"DMA Available"
block|,
literal|"Link Available"
block|,
literal|"Link Unavailable"
block|,
literal|"Halted"
block|,
literal|"Ring Member"
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * The following are used in conjunction with   * unsolicited events  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
specifier|const
name|pdq_entities
index|[]
init|=
block|{
literal|"Station"
block|,
literal|"Link"
block|,
literal|"Phy Port"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
specifier|const
name|pdq_station_events
index|[]
init|=
block|{
literal|"Trace Received"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
specifier|const
name|pdq_station_arguments
index|[]
init|=
block|{
literal|"Reason"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
specifier|const
name|pdq_link_events
index|[]
init|=
block|{
literal|"Transmit Underrun"
block|,
literal|"Transmit Failed"
block|,
literal|"Block Check Error (CRC)"
block|,
literal|"Frame Status Error"
block|,
literal|"PDU Length Error"
block|,
name|NULL
block|,
name|NULL
block|,
literal|"Receive Data Overrun"
block|,
name|NULL
block|,
literal|"No User Buffer"
block|,
literal|"Ring Initialization Initiated"
block|,
literal|"Ring Initialization Received"
block|,
literal|"Ring Beacon Initiated"
block|,
literal|"Duplicate Address Failure"
block|,
literal|"Duplicate Token Detected"
block|,
literal|"Ring Purger Error"
block|,
literal|"FCI Strip Error"
block|,
literal|"Trace Initiated"
block|,
literal|"Directed Beacon Received"
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
specifier|const
name|pdq_link_arguments
index|[]
init|=
block|{
literal|"Reason"
block|,
literal|"Data Link Header"
block|,
literal|"Source"
block|,
literal|"Upstream Neighbor"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
specifier|const
name|pdq_phy_events
index|[]
init|=
block|{
literal|"LEM Error Monitor Reject"
block|,
literal|"Elasticy Buffer Error"
block|,
literal|"Link Confidence Test Reject"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
specifier|const
name|pdq_phy_arguments
index|[]
init|=
block|{
literal|"Direction"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
specifier|const
modifier|*
specifier|const
name|pdq_event_arguments
index|[]
init|=
block|{
name|pdq_station_arguments
block|,
name|pdq_link_arguments
block|,
name|pdq_phy_arguments
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
specifier|const
modifier|*
specifier|const
name|pdq_event_codes
index|[]
init|=
block|{
name|pdq_station_events
block|,
name|pdq_link_events
block|,
name|pdq_phy_events
block|}
decl_stmt|;
end_decl_stmt

begin_escape
end_escape

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
specifier|const
name|pdq_station_types
index|[]
init|=
block|{
literal|"SAS"
block|,
literal|"DAC"
block|,
literal|"SAC"
block|,
literal|"NAC"
block|,
literal|"DAS"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
specifier|const
name|pdq_smt_versions
index|[]
init|=
block|{
literal|""
block|,
literal|"V6.2"
block|,
literal|"V7.2"
block|,
literal|"V7.3"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
name|pdq_phy_types
index|[]
init|=
literal|"ABSM"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
specifier|const
name|pdq_pmd_types0
index|[]
init|=
block|{
literal|"ANSI Multi-Mode"
block|,
literal|"ANSI Single-Mode Type 1"
block|,
literal|"ANSI Single-Mode Type 2"
block|,
literal|"ANSI Sonet"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
specifier|const
name|pdq_pmd_types100
index|[]
init|=
block|{
literal|"Low Power"
block|,
literal|"Thin Wire"
block|,
literal|"Shielded Twisted Pair"
block|,
literal|"Unshielded Twisted Pair"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
specifier|const
modifier|*
specifier|const
name|pdq_pmd_types
index|[]
init|=
block|{
name|pdq_pmd_types0
block|,
name|pdq_pmd_types100
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
specifier|const
name|pdq_descriptions
index|[]
init|=
block|{
literal|"DEFPA PCI"
block|,
literal|"DEFEA EISA"
block|,
literal|"DEFTA TC"
block|,
literal|"DEFAA Futurebus"
block|,
literal|"DEFQA Q-bus"
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|pdq_print_fddi_chars
parameter_list|(
name|pdq_t
modifier|*
name|pdq
parameter_list|,
specifier|const
name|pdq_response_status_chars_get_t
modifier|*
name|rsp
parameter_list|)
block|{
specifier|const
name|char
name|hexchars
index|[]
init|=
literal|"0123456789abcdef"
decl_stmt|;
name|printf
argument_list|(
if|#
directive|if
operator|!
name|defined
argument_list|(
name|__bsdi__
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|__NetBSD__
argument_list|)
name|PDQ_OS_PREFIX
else|#
directive|else
literal|": "
endif|#
directive|endif
literal|"DEC %s FDDI %s Controller\n"
argument_list|,
if|#
directive|if
operator|!
name|defined
argument_list|(
name|__bsdi__
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|__NetBSD__
argument_list|)
name|PDQ_OS_PREFIX_ARGS
argument_list|,
endif|#
directive|endif
name|pdq_descriptions
index|[
name|pdq
operator|->
name|pdq_type
index|]
argument_list|,
name|pdq_station_types
index|[
name|rsp
operator|->
name|status_chars_get
operator|.
name|station_type
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
name|PDQ_OS_PREFIX
literal|"FDDI address %c%c:%c%c:%c%c:%c%c:%c%c:%c%c, FW=%c%c%c%c, HW=%c"
argument_list|,
name|PDQ_OS_PREFIX_ARGS
argument_list|,
name|hexchars
index|[
name|pdq
operator|->
name|pdq_hwaddr
operator|.
name|lanaddr_bytes
index|[
literal|0
index|]
operator|>>
literal|4
index|]
argument_list|,
name|hexchars
index|[
name|pdq
operator|->
name|pdq_hwaddr
operator|.
name|lanaddr_bytes
index|[
literal|0
index|]
operator|&
literal|0x0F
index|]
argument_list|,
name|hexchars
index|[
name|pdq
operator|->
name|pdq_hwaddr
operator|.
name|lanaddr_bytes
index|[
literal|1
index|]
operator|>>
literal|4
index|]
argument_list|,
name|hexchars
index|[
name|pdq
operator|->
name|pdq_hwaddr
operator|.
name|lanaddr_bytes
index|[
literal|1
index|]
operator|&
literal|0x0F
index|]
argument_list|,
name|hexchars
index|[
name|pdq
operator|->
name|pdq_hwaddr
operator|.
name|lanaddr_bytes
index|[
literal|2
index|]
operator|>>
literal|4
index|]
argument_list|,
name|hexchars
index|[
name|pdq
operator|->
name|pdq_hwaddr
operator|.
name|lanaddr_bytes
index|[
literal|2
index|]
operator|&
literal|0x0F
index|]
argument_list|,
name|hexchars
index|[
name|pdq
operator|->
name|pdq_hwaddr
operator|.
name|lanaddr_bytes
index|[
literal|3
index|]
operator|>>
literal|4
index|]
argument_list|,
name|hexchars
index|[
name|pdq
operator|->
name|pdq_hwaddr
operator|.
name|lanaddr_bytes
index|[
literal|3
index|]
operator|&
literal|0x0F
index|]
argument_list|,
name|hexchars
index|[
name|pdq
operator|->
name|pdq_hwaddr
operator|.
name|lanaddr_bytes
index|[
literal|4
index|]
operator|>>
literal|4
index|]
argument_list|,
name|hexchars
index|[
name|pdq
operator|->
name|pdq_hwaddr
operator|.
name|lanaddr_bytes
index|[
literal|4
index|]
operator|&
literal|0x0F
index|]
argument_list|,
name|hexchars
index|[
name|pdq
operator|->
name|pdq_hwaddr
operator|.
name|lanaddr_bytes
index|[
literal|5
index|]
operator|>>
literal|4
index|]
argument_list|,
name|hexchars
index|[
name|pdq
operator|->
name|pdq_hwaddr
operator|.
name|lanaddr_bytes
index|[
literal|5
index|]
operator|&
literal|0x0F
index|]
argument_list|,
name|pdq
operator|->
name|pdq_fwrev
operator|.
name|fwrev_bytes
index|[
literal|0
index|]
argument_list|,
name|pdq
operator|->
name|pdq_fwrev
operator|.
name|fwrev_bytes
index|[
literal|1
index|]
argument_list|,
name|pdq
operator|->
name|pdq_fwrev
operator|.
name|fwrev_bytes
index|[
literal|2
index|]
argument_list|,
name|pdq
operator|->
name|pdq_fwrev
operator|.
name|fwrev_bytes
index|[
literal|3
index|]
argument_list|,
name|rsp
operator|->
name|status_chars_get
operator|.
name|module_rev
operator|.
name|fwrev_bytes
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|rsp
operator|->
name|status_chars_get
operator|.
name|smt_version_id
operator|<
name|PDQ_ARRAY_SIZE
argument_list|(
name|pdq_smt_versions
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|", SMT %s\n"
argument_list|,
name|pdq_smt_versions
index|[
name|rsp
operator|->
name|status_chars_get
operator|.
name|smt_version_id
index|]
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
name|PDQ_OS_PREFIX
literal|"FDDI Port%s = %c (PMD = %s)"
argument_list|,
name|PDQ_OS_PREFIX_ARGS
argument_list|,
name|rsp
operator|->
name|status_chars_get
operator|.
name|station_type
operator|==
name|PDQ_STATION_TYPE_DAS
condition|?
literal|"[A]"
else|:
literal|""
argument_list|,
name|pdq_phy_types
index|[
name|rsp
operator|->
name|status_chars_get
operator|.
name|phy_type
index|[
literal|0
index|]
index|]
argument_list|,
name|pdq_pmd_types
index|[
name|rsp
operator|->
name|status_chars_get
operator|.
name|pmd_type
index|[
literal|0
index|]
operator|/
literal|100
index|]
index|[
name|rsp
operator|->
name|status_chars_get
operator|.
name|pmd_type
index|[
literal|0
index|]
operator|%
literal|100
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|rsp
operator|->
name|status_chars_get
operator|.
name|station_type
operator|==
name|PDQ_STATION_TYPE_DAS
condition|)
name|printf
argument_list|(
literal|", FDDI Port[B] = %c (PMD = %s)"
argument_list|,
name|pdq_phy_types
index|[
name|rsp
operator|->
name|status_chars_get
operator|.
name|phy_type
index|[
literal|1
index|]
index|]
argument_list|,
name|pdq_pmd_types
index|[
name|rsp
operator|->
name|status_chars_get
operator|.
name|pmd_type
index|[
literal|1
index|]
operator|/
literal|100
index|]
index|[
name|rsp
operator|->
name|status_chars_get
operator|.
name|pmd_type
index|[
literal|1
index|]
operator|%
literal|100
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_escape
end_escape

begin_function
specifier|static
name|void
name|pdq_init_csrs
parameter_list|(
name|pdq_csrs_t
modifier|*
name|csrs
parameter_list|,
name|pdq_bus_t
name|bus
parameter_list|,
name|pdq_bus_memaddr_t
name|csr_base
parameter_list|,
name|size_t
name|csrsize
parameter_list|)
block|{
name|csrs
operator|->
name|csr_bus
operator|=
name|bus
expr_stmt|;
name|csrs
operator|->
name|csr_base
operator|=
name|csr_base
expr_stmt|;
name|csrs
operator|->
name|csr_port_reset
operator|=
name|PDQ_CSR_OFFSET
argument_list|(
name|csr_base
argument_list|,
literal|0
operator|*
name|csrsize
argument_list|)
expr_stmt|;
name|csrs
operator|->
name|csr_host_data
operator|=
name|PDQ_CSR_OFFSET
argument_list|(
name|csr_base
argument_list|,
literal|1
operator|*
name|csrsize
argument_list|)
expr_stmt|;
name|csrs
operator|->
name|csr_port_control
operator|=
name|PDQ_CSR_OFFSET
argument_list|(
name|csr_base
argument_list|,
literal|2
operator|*
name|csrsize
argument_list|)
expr_stmt|;
name|csrs
operator|->
name|csr_port_data_a
operator|=
name|PDQ_CSR_OFFSET
argument_list|(
name|csr_base
argument_list|,
literal|3
operator|*
name|csrsize
argument_list|)
expr_stmt|;
name|csrs
operator|->
name|csr_port_data_b
operator|=
name|PDQ_CSR_OFFSET
argument_list|(
name|csr_base
argument_list|,
literal|4
operator|*
name|csrsize
argument_list|)
expr_stmt|;
name|csrs
operator|->
name|csr_port_status
operator|=
name|PDQ_CSR_OFFSET
argument_list|(
name|csr_base
argument_list|,
literal|5
operator|*
name|csrsize
argument_list|)
expr_stmt|;
name|csrs
operator|->
name|csr_host_int_type_0
operator|=
name|PDQ_CSR_OFFSET
argument_list|(
name|csr_base
argument_list|,
literal|6
operator|*
name|csrsize
argument_list|)
expr_stmt|;
name|csrs
operator|->
name|csr_host_int_enable
operator|=
name|PDQ_CSR_OFFSET
argument_list|(
name|csr_base
argument_list|,
literal|7
operator|*
name|csrsize
argument_list|)
expr_stmt|;
name|csrs
operator|->
name|csr_type_2_producer
operator|=
name|PDQ_CSR_OFFSET
argument_list|(
name|csr_base
argument_list|,
literal|8
operator|*
name|csrsize
argument_list|)
expr_stmt|;
name|csrs
operator|->
name|csr_cmd_response_producer
operator|=
name|PDQ_CSR_OFFSET
argument_list|(
name|csr_base
argument_list|,
literal|10
operator|*
name|csrsize
argument_list|)
expr_stmt|;
name|csrs
operator|->
name|csr_cmd_request_producer
operator|=
name|PDQ_CSR_OFFSET
argument_list|(
name|csr_base
argument_list|,
literal|11
operator|*
name|csrsize
argument_list|)
expr_stmt|;
name|csrs
operator|->
name|csr_host_smt_producer
operator|=
name|PDQ_CSR_OFFSET
argument_list|(
name|csr_base
argument_list|,
literal|12
operator|*
name|csrsize
argument_list|)
expr_stmt|;
name|csrs
operator|->
name|csr_unsolicited_producer
operator|=
name|PDQ_CSR_OFFSET
argument_list|(
name|csr_base
argument_list|,
literal|13
operator|*
name|csrsize
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|pdq_init_pci_csrs
parameter_list|(
name|pdq_pci_csrs_t
modifier|*
name|csrs
parameter_list|,
name|pdq_bus_t
name|bus
parameter_list|,
name|pdq_bus_memaddr_t
name|csr_base
parameter_list|,
name|size_t
name|csrsize
parameter_list|)
block|{
name|csrs
operator|->
name|csr_bus
operator|=
name|bus
expr_stmt|;
name|csrs
operator|->
name|csr_base
operator|=
name|csr_base
expr_stmt|;
name|csrs
operator|->
name|csr_pfi_mode_control
operator|=
name|PDQ_CSR_OFFSET
argument_list|(
name|csr_base
argument_list|,
literal|16
operator|*
name|csrsize
argument_list|)
expr_stmt|;
name|csrs
operator|->
name|csr_pfi_status
operator|=
name|PDQ_CSR_OFFSET
argument_list|(
name|csr_base
argument_list|,
literal|17
operator|*
name|csrsize
argument_list|)
expr_stmt|;
name|csrs
operator|->
name|csr_fifo_write
operator|=
name|PDQ_CSR_OFFSET
argument_list|(
name|csr_base
argument_list|,
literal|18
operator|*
name|csrsize
argument_list|)
expr_stmt|;
name|csrs
operator|->
name|csr_fifo_read
operator|=
name|PDQ_CSR_OFFSET
argument_list|(
name|csr_base
argument_list|,
literal|19
operator|*
name|csrsize
argument_list|)
expr_stmt|;
block|}
end_function

begin_escape
end_escape

begin_function
specifier|static
name|void
name|pdq_flush_databuf_queue
parameter_list|(
name|pdq_databuf_queue_t
modifier|*
name|q
parameter_list|)
block|{
name|PDQ_OS_DATABUF_T
modifier|*
name|pdu
decl_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|PDQ_OS_DATABUF_DEQUEUE
argument_list|(
name|q
argument_list|,
name|pdu
argument_list|)
expr_stmt|;
if|if
condition|(
name|pdu
operator|==
name|NULL
condition|)
return|return;
name|PDQ_OS_DATABUF_FREE
argument_list|(
name|pdu
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_escape
end_escape

begin_function
specifier|static
name|pdq_boolean_t
name|pdq_do_port_control
parameter_list|(
specifier|const
name|pdq_csrs_t
modifier|*
specifier|const
name|csrs
parameter_list|,
name|pdq_uint32_t
name|cmd
parameter_list|)
block|{
name|int
name|cnt
init|=
literal|0
decl_stmt|;
name|PDQ_CSR_WRITE
argument_list|(
name|csrs
argument_list|,
name|csr_host_int_type_0
argument_list|,
name|PDQ_HOST_INT_CSR_CMD_DONE
argument_list|)
expr_stmt|;
name|PDQ_CSR_WRITE
argument_list|(
name|csrs
argument_list|,
name|csr_port_control
argument_list|,
name|PDQ_PCTL_CMD_ERROR
operator||
name|cmd
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|PDQ_CSR_READ
argument_list|(
name|csrs
argument_list|,
name|csr_host_int_type_0
argument_list|)
operator|&
name|PDQ_HOST_INT_CSR_CMD_DONE
operator|)
operator|==
literal|0
operator|&&
name|cnt
operator|<
literal|33000000
condition|)
name|cnt
operator|++
expr_stmt|;
name|PDQ_PRINTF
argument_list|(
operator|(
literal|"CSR cmd spun %d times\n"
operator|,
name|cnt
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|PDQ_CSR_READ
argument_list|(
name|csrs
argument_list|,
name|csr_host_int_type_0
argument_list|)
operator|&
name|PDQ_HOST_INT_CSR_CMD_DONE
condition|)
block|{
name|PDQ_CSR_WRITE
argument_list|(
name|csrs
argument_list|,
name|csr_host_int_type_0
argument_list|,
name|PDQ_HOST_INT_CSR_CMD_DONE
argument_list|)
expr_stmt|;
return|return
operator|(
name|PDQ_CSR_READ
argument_list|(
name|csrs
argument_list|,
name|csr_port_control
argument_list|)
operator|&
name|PDQ_PCTL_CMD_ERROR
operator|)
condition|?
name|PDQ_FALSE
else|:
name|PDQ_TRUE
return|;
block|}
comment|/* adapter failure */
name|PDQ_ASSERT
argument_list|(
literal|0
argument_list|)
expr_stmt|;
return|return
name|PDQ_FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|pdq_read_mla
parameter_list|(
specifier|const
name|pdq_csrs_t
modifier|*
specifier|const
name|csrs
parameter_list|,
name|pdq_lanaddr_t
modifier|*
name|hwaddr
parameter_list|)
block|{
name|pdq_uint32_t
name|data
decl_stmt|;
name|PDQ_CSR_WRITE
argument_list|(
name|csrs
argument_list|,
name|csr_port_data_a
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|pdq_do_port_control
argument_list|(
name|csrs
argument_list|,
name|PDQ_PCTL_MLA_READ
argument_list|)
expr_stmt|;
name|data
operator|=
name|PDQ_CSR_READ
argument_list|(
name|csrs
argument_list|,
name|csr_host_data
argument_list|)
expr_stmt|;
name|hwaddr
operator|->
name|lanaddr_bytes
index|[
literal|0
index|]
operator|=
operator|(
name|data
operator|>>
literal|0
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|hwaddr
operator|->
name|lanaddr_bytes
index|[
literal|1
index|]
operator|=
operator|(
name|data
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|hwaddr
operator|->
name|lanaddr_bytes
index|[
literal|2
index|]
operator|=
operator|(
name|data
operator|>>
literal|16
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|hwaddr
operator|->
name|lanaddr_bytes
index|[
literal|3
index|]
operator|=
operator|(
name|data
operator|>>
literal|24
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|PDQ_CSR_WRITE
argument_list|(
name|csrs
argument_list|,
name|csr_port_data_a
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pdq_do_port_control
argument_list|(
name|csrs
argument_list|,
name|PDQ_PCTL_MLA_READ
argument_list|)
expr_stmt|;
name|data
operator|=
name|PDQ_CSR_READ
argument_list|(
name|csrs
argument_list|,
name|csr_host_data
argument_list|)
expr_stmt|;
name|hwaddr
operator|->
name|lanaddr_bytes
index|[
literal|4
index|]
operator|=
operator|(
name|data
operator|>>
literal|0
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|hwaddr
operator|->
name|lanaddr_bytes
index|[
literal|5
index|]
operator|=
operator|(
name|data
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|pdq_read_fwrev
parameter_list|(
specifier|const
name|pdq_csrs_t
modifier|*
specifier|const
name|csrs
parameter_list|,
name|pdq_fwrev_t
modifier|*
name|fwrev
parameter_list|)
block|{
name|pdq_uint32_t
name|data
decl_stmt|;
name|pdq_do_port_control
argument_list|(
name|csrs
argument_list|,
name|PDQ_PCTL_FW_REV_READ
argument_list|)
expr_stmt|;
name|data
operator|=
name|PDQ_CSR_READ
argument_list|(
name|csrs
argument_list|,
name|csr_host_data
argument_list|)
expr_stmt|;
name|fwrev
operator|->
name|fwrev_bytes
index|[
literal|3
index|]
operator|=
operator|(
name|data
operator|>>
literal|0
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|fwrev
operator|->
name|fwrev_bytes
index|[
literal|2
index|]
operator|=
operator|(
name|data
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|fwrev
operator|->
name|fwrev_bytes
index|[
literal|1
index|]
operator|=
operator|(
name|data
operator|>>
literal|16
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|fwrev
operator|->
name|fwrev_bytes
index|[
literal|0
index|]
operator|=
operator|(
name|data
operator|>>
literal|24
operator|)
operator|&
literal|0xFF
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|pdq_boolean_t
name|pdq_read_error_log
parameter_list|(
name|pdq_t
modifier|*
name|pdq
parameter_list|,
name|pdq_response_error_log_get_t
modifier|*
name|log_entry
parameter_list|)
block|{
specifier|const
name|pdq_csrs_t
modifier|*
specifier|const
name|csrs
init|=
operator|&
name|pdq
operator|->
name|pdq_csrs
decl_stmt|;
name|pdq_uint32_t
modifier|*
name|ptr
init|=
operator|(
name|pdq_uint32_t
operator|*
operator|)
name|log_entry
decl_stmt|;
name|pdq_do_port_control
argument_list|(
name|csrs
argument_list|,
name|PDQ_PCTL_ERROR_LOG_START
argument_list|)
expr_stmt|;
while|while
condition|(
name|pdq_do_port_control
argument_list|(
name|csrs
argument_list|,
name|PDQ_PCTL_FW_REV_READ
argument_list|)
operator|==
name|PDQ_TRUE
condition|)
block|{
operator|*
name|ptr
operator|++
operator|=
name|PDQ_CSR_READ
argument_list|(
name|csrs
argument_list|,
name|csr_host_data
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pdq_uint8_t
operator|*
operator|)
name|ptr
operator|-
operator|(
name|pdq_uint8_t
operator|*
operator|)
name|log_entry
operator|==
sizeof|sizeof
argument_list|(
operator|*
name|log_entry
argument_list|)
condition|)
break|break;
block|}
return|return
operator|(
name|ptr
operator|==
operator|(
name|pdq_uint32_t
operator|*
operator|)
name|log_entry
operator|)
condition|?
name|PDQ_FALSE
else|:
name|PDQ_TRUE
return|;
block|}
end_function

begin_function
specifier|static
name|pdq_chip_rev_t
name|pdq_read_chiprev
parameter_list|(
specifier|const
name|pdq_csrs_t
modifier|*
specifier|const
name|csrs
parameter_list|)
block|{
name|pdq_uint32_t
name|data
decl_stmt|;
name|PDQ_CSR_WRITE
argument_list|(
name|csrs
argument_list|,
name|csr_port_data_a
argument_list|,
name|PDQ_SUB_CMD_PDQ_REV_GET
argument_list|)
expr_stmt|;
name|pdq_do_port_control
argument_list|(
name|csrs
argument_list|,
name|PDQ_PCTL_SUB_CMD
argument_list|)
expr_stmt|;
name|data
operator|=
name|PDQ_CSR_READ
argument_list|(
name|csrs
argument_list|,
name|csr_host_data
argument_list|)
expr_stmt|;
return|return
operator|(
name|pdq_chip_rev_t
operator|)
name|data
return|;
block|}
end_function

begin_escape
end_escape

begin_struct
specifier|static
specifier|const
struct|struct
block|{
name|size_t
name|cmd_len
decl_stmt|;
name|size_t
name|rsp_len
decl_stmt|;
specifier|const
name|char
modifier|*
name|cmd_name
decl_stmt|;
block|}
name|pdq_cmd_info
index|[]
init|=
block|{
block|{
sizeof|sizeof
argument_list|(
name|pdq_cmd_generic_t
argument_list|)
block|,
comment|/* 0 - PDQC_START */
sizeof|sizeof
argument_list|(
name|pdq_response_generic_t
argument_list|)
block|,
literal|"Start"
block|}
block|,
block|{
sizeof|sizeof
argument_list|(
name|pdq_cmd_filter_set_t
argument_list|)
block|,
comment|/* 1 - PDQC_FILTER_SET */
sizeof|sizeof
argument_list|(
name|pdq_response_generic_t
argument_list|)
block|,
literal|"Filter Set"
block|}
block|,
block|{
sizeof|sizeof
argument_list|(
name|pdq_cmd_generic_t
argument_list|)
block|,
comment|/* 2 - PDQC_FILTER_GET */
sizeof|sizeof
argument_list|(
name|pdq_response_filter_get_t
argument_list|)
block|,
literal|"Filter Get"
block|}
block|,
block|{
sizeof|sizeof
argument_list|(
name|pdq_cmd_chars_set_t
argument_list|)
block|,
comment|/* 3 - PDQC_CHARS_SET */
sizeof|sizeof
argument_list|(
name|pdq_response_generic_t
argument_list|)
block|,
literal|"Chars Set"
block|}
block|,
block|{
sizeof|sizeof
argument_list|(
name|pdq_cmd_generic_t
argument_list|)
block|,
comment|/* 4 - PDQC_STATUS_CHARS_GET */
sizeof|sizeof
argument_list|(
name|pdq_response_status_chars_get_t
argument_list|)
block|,
literal|"Status Chars Get"
block|}
block|,
if|#
directive|if
literal|0
block|{ sizeof(pdq_cmd_generic_t),
comment|/* 5 - PDQC_COUNTERS_GET */
block|sizeof(pdq_response_counters_get_t),       "Counters Get"     },     { sizeof(pdq_cmd_counters_set_t),
comment|/* 6 - PDQC_COUNTERS_SET */
block|sizeof(pdq_response_generic_t),       "Counters Set"     },
else|#
directive|else
block|{
literal|0
block|,
literal|0
block|,
literal|"Counters Get"
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|"Counters Set"
block|}
block|,
endif|#
directive|endif
block|{
sizeof|sizeof
argument_list|(
name|pdq_cmd_addr_filter_set_t
argument_list|)
block|,
comment|/* 7 - PDQC_ADDR_FILTER_SET */
sizeof|sizeof
argument_list|(
name|pdq_response_generic_t
argument_list|)
block|,
literal|"Addr Filter Set"
block|}
block|,
block|{
sizeof|sizeof
argument_list|(
name|pdq_cmd_generic_t
argument_list|)
block|,
comment|/* 8 - PDQC_ADDR_FILTER_GET */
sizeof|sizeof
argument_list|(
name|pdq_response_addr_filter_get_t
argument_list|)
block|,
literal|"Addr Filter Get"
block|}
block|,
if|#
directive|if
literal|0
block|{ sizeof(pdq_cmd_generic_t),
comment|/* 9 - PDQC_ERROR_LOG_CLEAR */
block|sizeof(pdq_response_generic_t),       "Error Log Clear"     },     { sizeof(pdq_cmd_generic_t),
comment|/* 10 - PDQC_ERROR_LOG_SET */
block|sizeof(pdq_response_generic_t),       "Error Log Set"     },     { sizeof(pdq_cmd_generic_t),
comment|/* 11 - PDQC_FDDI_MIB_GET */
block|sizeof(pdq_response_generic_t),       "FDDI MIB Get"     },     { sizeof(pdq_cmd_generic_t),
comment|/* 12 - PDQC_DEC_EXT_MIB_GET */
block|sizeof(pdq_response_generic_t),       "DEC Ext MIB Get"     },     { sizeof(pdq_cmd_generic_t),
comment|/* 13 - PDQC_DEC_SPECIFIC_GET */
block|sizeof(pdq_response_generic_t),       "DEC Specific Get"     },     { sizeof(pdq_cmd_generic_t),
comment|/* 14 - PDQC_SNMP_SET */
block|sizeof(pdq_response_generic_t),       "SNMP Set"     },     { 0, 0, "N/A" },     { sizeof(pdq_cmd_generic_t),
comment|/* 16 - PDQC_SMT_MIB_GET */
block|sizeof(pdq_response_generic_t),       "SMT MIB Get"     },     { sizeof(pdq_cmd_generic_t),
comment|/* 17 - PDQC_SMT_MIB_SET */
block|sizeof(pdq_response_generic_t),       "SMT MIB Set",     },
endif|#
directive|endif
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
name|pdq_queue_commands
parameter_list|(
name|pdq_t
modifier|*
name|pdq
parameter_list|)
block|{
specifier|const
name|pdq_csrs_t
modifier|*
specifier|const
name|csrs
init|=
operator|&
name|pdq
operator|->
name|pdq_csrs
decl_stmt|;
name|pdq_command_info_t
modifier|*
specifier|const
name|ci
init|=
operator|&
name|pdq
operator|->
name|pdq_command_info
decl_stmt|;
name|pdq_descriptor_block_t
modifier|*
specifier|const
name|dbp
init|=
name|pdq
operator|->
name|pdq_dbp
decl_stmt|;
name|pdq_cmd_code_t
name|op
decl_stmt|;
name|pdq_uint32_t
name|cmdlen
decl_stmt|,
name|rsplen
decl_stmt|,
name|mask
decl_stmt|;
comment|/*      * If there are commands or responses active or there aren't      * any pending commands, then don't queue any more.      */
if|if
condition|(
name|ci
operator|->
name|ci_command_active
operator|||
name|ci
operator|->
name|ci_pending_commands
operator|==
literal|0
condition|)
return|return;
comment|/*      * Determine which command needs to be queued.      */
name|op
operator|=
name|PDQC_SMT_MIB_SET
expr_stmt|;
for|for
control|(
name|mask
operator|=
literal|1
operator|<<
operator|(
operator|(
name|int
operator|)
name|op
operator|)
init|;
operator|(
name|mask
operator|&
name|ci
operator|->
name|ci_pending_commands
operator|)
operator|==
literal|0
condition|;
name|mask
operator|>>=
literal|1
control|)
name|op
operator|=
call|(
name|pdq_cmd_code_t
call|)
argument_list|(
operator|(
name|int
operator|)
name|op
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/*      * Obtain the sizes needed for the command and response.      * Round up to PDQ_CMD_RX_ALIGNMENT so the receive buffer is      * always properly aligned.      */
name|cmdlen
operator|=
name|PDQ_ROUNDUP
argument_list|(
name|pdq_cmd_info
index|[
name|op
index|]
operator|.
name|cmd_len
argument_list|,
name|PDQ_CMD_RX_ALIGNMENT
argument_list|)
expr_stmt|;
name|rsplen
operator|=
name|PDQ_ROUNDUP
argument_list|(
name|pdq_cmd_info
index|[
name|op
index|]
operator|.
name|rsp_len
argument_list|,
name|PDQ_CMD_RX_ALIGNMENT
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmdlen
operator|<
name|rsplen
condition|)
name|cmdlen
operator|=
name|rsplen
expr_stmt|;
comment|/*      * Since only one command at a time will be queued, there will always      * be enough space.      */
comment|/*      * Obtain and fill in the descriptor for the command (descriptor is      * pre-initialized)      */
name|dbp
operator|->
name|pdqdb_command_requests
index|[
name|ci
operator|->
name|ci_request_producer
index|]
operator|.
name|txd_seg_len
operator|=
name|cmdlen
expr_stmt|;
name|PDQ_ADVANCE
argument_list|(
name|ci
operator|->
name|ci_request_producer
argument_list|,
literal|1
argument_list|,
name|PDQ_RING_MASK
argument_list|(
name|dbp
operator|->
name|pdqdb_command_requests
argument_list|)
argument_list|)
expr_stmt|;
comment|/*      * Obtain and fill in the descriptor for the response (descriptor is      * pre-initialized)      */
name|dbp
operator|->
name|pdqdb_command_responses
index|[
name|ci
operator|->
name|ci_response_producer
index|]
operator|.
name|rxd_seg_len_hi
operator|=
name|cmdlen
operator|/
literal|16
expr_stmt|;
name|PDQ_ADVANCE
argument_list|(
name|ci
operator|->
name|ci_response_producer
argument_list|,
literal|1
argument_list|,
name|PDQ_RING_MASK
argument_list|(
name|dbp
operator|->
name|pdqdb_command_responses
argument_list|)
argument_list|)
expr_stmt|;
comment|/*      * Clear the command area, set the opcode, and the command from the pending      * mask.      */
name|PDQ_OS_MEMZERO
argument_list|(
name|ci
operator|->
name|ci_bufstart
argument_list|,
name|cmdlen
argument_list|)
expr_stmt|;
operator|*
operator|(
name|pdq_cmd_code_t
operator|*
operator|)
name|ci
operator|->
name|ci_bufstart
operator|=
name|op
expr_stmt|;
name|ci
operator|->
name|ci_pending_commands
operator|&=
operator|~
name|mask
expr_stmt|;
comment|/*      * Fill in the command area, if needed.      */
switch|switch
condition|(
name|op
condition|)
block|{
case|case
name|PDQC_FILTER_SET
case|:
block|{
name|pdq_cmd_filter_set_t
modifier|*
name|filter_set
init|=
operator|(
name|pdq_cmd_filter_set_t
operator|*
operator|)
name|ci
operator|->
name|ci_bufstart
decl_stmt|;
name|unsigned
name|idx
init|=
literal|0
decl_stmt|;
name|filter_set
operator|->
name|filter_set_items
index|[
name|idx
index|]
operator|.
name|item_code
operator|=
name|PDQI_IND_GROUP_PROM
expr_stmt|;
name|filter_set
operator|->
name|filter_set_items
index|[
name|idx
index|]
operator|.
name|filter_state
operator|=
operator|(
name|pdq
operator|->
name|pdq_flags
operator|&
name|PDQ_PROMISC
condition|?
name|PDQ_FILTER_PASS
else|:
name|PDQ_FILTER_BLOCK
operator|)
expr_stmt|;
name|idx
operator|++
expr_stmt|;
name|filter_set
operator|->
name|filter_set_items
index|[
name|idx
index|]
operator|.
name|item_code
operator|=
name|PDQI_GROUP_PROM
expr_stmt|;
name|filter_set
operator|->
name|filter_set_items
index|[
name|idx
index|]
operator|.
name|filter_state
operator|=
operator|(
name|pdq
operator|->
name|pdq_flags
operator|&
name|PDQ_ALLMULTI
condition|?
name|PDQ_FILTER_PASS
else|:
name|PDQ_FILTER_BLOCK
operator|)
expr_stmt|;
name|idx
operator|++
expr_stmt|;
name|filter_set
operator|->
name|filter_set_items
index|[
name|idx
index|]
operator|.
name|item_code
operator|=
name|PDQI_SMT_PROM
expr_stmt|;
name|filter_set
operator|->
name|filter_set_items
index|[
name|idx
index|]
operator|.
name|filter_state
operator|=
operator|(
operator|(
name|pdq
operator|->
name|pdq_flags
operator|&
operator|(
name|PDQ_PROMISC
operator||
name|PDQ_PASS_SMT
operator|)
operator|)
operator|==
operator|(
name|PDQ_PROMISC
operator||
name|PDQ_PASS_SMT
operator|)
condition|?
name|PDQ_FILTER_PASS
else|:
name|PDQ_FILTER_BLOCK
operator|)
expr_stmt|;
name|idx
operator|++
expr_stmt|;
name|filter_set
operator|->
name|filter_set_items
index|[
name|idx
index|]
operator|.
name|item_code
operator|=
name|PDQI_SMT_USER
expr_stmt|;
name|filter_set
operator|->
name|filter_set_items
index|[
name|idx
index|]
operator|.
name|filter_state
operator|=
operator|(
name|pdq
operator|->
name|pdq_flags
operator|&
name|PDQ_PASS_SMT
condition|?
name|PDQ_FILTER_PASS
else|:
name|PDQ_FILTER_BLOCK
operator|)
expr_stmt|;
name|idx
operator|++
expr_stmt|;
name|filter_set
operator|->
name|filter_set_items
index|[
name|idx
index|]
operator|.
name|item_code
operator|=
name|PDQI_EOL
expr_stmt|;
break|break;
block|}
case|case
name|PDQC_ADDR_FILTER_SET
case|:
block|{
name|pdq_cmd_addr_filter_set_t
modifier|*
name|addr_filter_set
init|=
operator|(
name|pdq_cmd_addr_filter_set_t
operator|*
operator|)
name|ci
operator|->
name|ci_bufstart
decl_stmt|;
name|pdq_lanaddr_t
modifier|*
name|addr
init|=
name|addr_filter_set
operator|->
name|addr_filter_set_addresses
decl_stmt|;
name|addr
operator|->
name|lanaddr_bytes
index|[
literal|0
index|]
operator|=
literal|0xFF
expr_stmt|;
name|addr
operator|->
name|lanaddr_bytes
index|[
literal|1
index|]
operator|=
literal|0xFF
expr_stmt|;
name|addr
operator|->
name|lanaddr_bytes
index|[
literal|2
index|]
operator|=
literal|0xFF
expr_stmt|;
name|addr
operator|->
name|lanaddr_bytes
index|[
literal|3
index|]
operator|=
literal|0xFF
expr_stmt|;
name|addr
operator|->
name|lanaddr_bytes
index|[
literal|4
index|]
operator|=
literal|0xFF
expr_stmt|;
name|addr
operator|->
name|lanaddr_bytes
index|[
literal|5
index|]
operator|=
literal|0xFF
expr_stmt|;
name|addr
operator|++
expr_stmt|;
name|pdq_os_addr_fill
argument_list|(
name|pdq
argument_list|,
name|addr
argument_list|,
literal|61
argument_list|)
expr_stmt|;
break|break;
block|}
default|default:
block|{
comment|/* to make gcc happy */
break|break;
block|}
block|}
comment|/*      * At this point the command is done.  All that needs to be done is to      * produce it to the PDQ.      */
name|PDQ_PRINTF
argument_list|(
operator|(
literal|"PDQ Queue Command Request: %s queued\n"
operator|,
name|pdq_cmd_info
index|[
name|op
index|]
operator|.
name|cmd_name
operator|)
argument_list|)
expr_stmt|;
name|ci
operator|->
name|ci_command_active
operator|++
expr_stmt|;
name|PDQ_CSR_WRITE
argument_list|(
name|csrs
argument_list|,
name|csr_cmd_response_producer
argument_list|,
name|ci
operator|->
name|ci_response_producer
operator||
operator|(
name|ci
operator|->
name|ci_response_completion
operator|<<
literal|8
operator|)
argument_list|)
expr_stmt|;
name|PDQ_CSR_WRITE
argument_list|(
name|csrs
argument_list|,
name|csr_cmd_request_producer
argument_list|,
name|ci
operator|->
name|ci_request_producer
operator||
operator|(
name|ci
operator|->
name|ci_request_completion
operator|<<
literal|8
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_escape
end_escape

begin_function
specifier|static
name|void
name|pdq_process_command_responses
parameter_list|(
name|pdq_t
modifier|*
specifier|const
name|pdq
parameter_list|)
block|{
specifier|const
name|pdq_csrs_t
modifier|*
specifier|const
name|csrs
init|=
operator|&
name|pdq
operator|->
name|pdq_csrs
decl_stmt|;
name|pdq_command_info_t
modifier|*
specifier|const
name|ci
init|=
operator|&
name|pdq
operator|->
name|pdq_command_info
decl_stmt|;
specifier|volatile
specifier|const
name|pdq_consumer_block_t
modifier|*
specifier|const
name|cbp
init|=
name|pdq
operator|->
name|pdq_cbp
decl_stmt|;
name|pdq_descriptor_block_t
modifier|*
specifier|const
name|dbp
init|=
name|pdq
operator|->
name|pdq_dbp
decl_stmt|;
specifier|const
name|pdq_response_generic_t
modifier|*
name|rspgen
decl_stmt|;
comment|/*      * We have to process the command and response in tandem so      * just wait for the response to be consumed.  If it has been      * consumed then the command must have been as well.      */
if|if
condition|(
name|cbp
operator|->
name|pdqcb_command_response
operator|==
name|ci
operator|->
name|ci_response_completion
condition|)
return|return;
name|PDQ_ASSERT
argument_list|(
name|cbp
operator|->
name|pdqcb_command_request
operator|!=
name|ci
operator|->
name|ci_request_completion
argument_list|)
expr_stmt|;
name|rspgen
operator|=
operator|(
specifier|const
name|pdq_response_generic_t
operator|*
operator|)
name|ci
operator|->
name|ci_bufstart
expr_stmt|;
name|PDQ_ASSERT
argument_list|(
name|rspgen
operator|->
name|generic_status
operator|==
name|PDQR_SUCCESS
argument_list|)
expr_stmt|;
name|PDQ_PRINTF
argument_list|(
operator|(
literal|"PDQ Process Command Response: %s completed (status=%d)\n"
operator|,
name|pdq_cmd_info
index|[
name|rspgen
operator|->
name|generic_op
index|]
operator|.
name|cmd_name
operator|,
name|rspgen
operator|->
name|generic_status
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rspgen
operator|->
name|generic_op
operator|==
name|PDQC_STATUS_CHARS_GET
operator|&&
operator|(
name|pdq
operator|->
name|pdq_flags
operator|&
name|PDQ_PRINTCHARS
operator|)
condition|)
block|{
name|pdq
operator|->
name|pdq_flags
operator|&=
operator|~
name|PDQ_PRINTCHARS
expr_stmt|;
name|pdq_print_fddi_chars
argument_list|(
name|pdq
argument_list|,
operator|(
specifier|const
name|pdq_response_status_chars_get_t
operator|*
operator|)
name|rspgen
argument_list|)
expr_stmt|;
block|}
name|PDQ_ADVANCE
argument_list|(
name|ci
operator|->
name|ci_request_completion
argument_list|,
literal|1
argument_list|,
name|PDQ_RING_MASK
argument_list|(
name|dbp
operator|->
name|pdqdb_command_requests
argument_list|)
argument_list|)
expr_stmt|;
name|PDQ_ADVANCE
argument_list|(
name|ci
operator|->
name|ci_response_completion
argument_list|,
literal|1
argument_list|,
name|PDQ_RING_MASK
argument_list|(
name|dbp
operator|->
name|pdqdb_command_responses
argument_list|)
argument_list|)
expr_stmt|;
name|ci
operator|->
name|ci_command_active
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ci
operator|->
name|ci_pending_commands
operator|!=
literal|0
condition|)
block|{
name|pdq_queue_commands
argument_list|(
name|pdq
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|PDQ_CSR_WRITE
argument_list|(
name|csrs
argument_list|,
name|csr_cmd_response_producer
argument_list|,
name|ci
operator|->
name|ci_response_producer
operator||
operator|(
name|ci
operator|->
name|ci_response_completion
operator|<<
literal|8
operator|)
argument_list|)
expr_stmt|;
name|PDQ_CSR_WRITE
argument_list|(
name|csrs
argument_list|,
name|csr_cmd_request_producer
argument_list|,
name|ci
operator|->
name|ci_request_producer
operator||
operator|(
name|ci
operator|->
name|ci_request_completion
operator|<<
literal|8
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/*  * This following routine processes unsolicited events.  * In addition, it also fills the unsolicited queue with  * event buffers so it can be used to initialize the queue  * as well.  */
end_comment

begin_function
specifier|static
name|void
name|pdq_process_unsolicited_events
parameter_list|(
name|pdq_t
modifier|*
name|pdq
parameter_list|)
block|{
specifier|const
name|pdq_csrs_t
modifier|*
specifier|const
name|csrs
init|=
operator|&
name|pdq
operator|->
name|pdq_csrs
decl_stmt|;
name|pdq_unsolicited_info_t
modifier|*
name|ui
init|=
operator|&
name|pdq
operator|->
name|pdq_unsolicited_info
decl_stmt|;
specifier|volatile
specifier|const
name|pdq_consumer_block_t
modifier|*
name|cbp
init|=
name|pdq
operator|->
name|pdq_cbp
decl_stmt|;
name|pdq_descriptor_block_t
modifier|*
name|dbp
init|=
name|pdq
operator|->
name|pdq_dbp
decl_stmt|;
specifier|const
name|pdq_unsolicited_event_t
modifier|*
name|event
decl_stmt|;
name|pdq_rxdesc_t
modifier|*
name|rxd
decl_stmt|;
comment|/*      * Process each unsolicited event (if any).      */
while|while
condition|(
name|cbp
operator|->
name|pdqcb_unsolicited_event
operator|!=
name|ui
operator|->
name|ui_completion
condition|)
block|{
name|rxd
operator|=
operator|&
name|dbp
operator|->
name|pdqdb_unsolicited_events
index|[
name|ui
operator|->
name|ui_completion
index|]
expr_stmt|;
name|event
operator|=
operator|&
name|ui
operator|->
name|ui_events
index|[
name|ui
operator|->
name|ui_completion
operator|&
operator|(
name|PDQ_NUM_UNSOLICITED_EVENTS
operator|-
literal|1
operator|)
index|]
expr_stmt|;
switch|switch
condition|(
name|event
operator|->
name|event_type
condition|)
block|{
case|case
name|PDQ_UNSOLICITED_EVENT
case|:
block|{
name|printf
argument_list|(
name|PDQ_OS_PREFIX
literal|"Unsolicited Event: %s: %s"
argument_list|,
name|PDQ_OS_PREFIX_ARGS
argument_list|,
name|pdq_entities
index|[
name|event
operator|->
name|event_entity
index|]
argument_list|,
name|pdq_event_codes
index|[
name|event
operator|->
name|event_entity
index|]
index|[
name|event
operator|->
name|event_code
operator|.
name|value
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|->
name|event_entity
operator|==
name|PDQ_ENTITY_PHY_PORT
condition|)
name|printf
argument_list|(
literal|"[%d]"
argument_list|,
name|event
operator|->
name|event_index
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|PDQ_UNSOLICITED_COUNTERS
case|:
block|{
break|break;
block|}
block|}
name|PDQ_ADVANCE
argument_list|(
name|ui
operator|->
name|ui_completion
argument_list|,
literal|1
argument_list|,
name|PDQ_RING_MASK
argument_list|(
name|dbp
operator|->
name|pdqdb_unsolicited_events
argument_list|)
argument_list|)
expr_stmt|;
name|ui
operator|->
name|ui_free
operator|++
expr_stmt|;
block|}
comment|/*      * Now give back the event buffers back to the PDQ.      */
name|PDQ_ADVANCE
argument_list|(
name|ui
operator|->
name|ui_producer
argument_list|,
name|ui
operator|->
name|ui_free
argument_list|,
name|PDQ_RING_MASK
argument_list|(
name|dbp
operator|->
name|pdqdb_unsolicited_events
argument_list|)
argument_list|)
expr_stmt|;
name|ui
operator|->
name|ui_free
operator|=
literal|0
expr_stmt|;
name|PDQ_CSR_WRITE
argument_list|(
name|csrs
argument_list|,
name|csr_unsolicited_producer
argument_list|,
name|ui
operator|->
name|ui_producer
operator||
operator|(
name|ui
operator|->
name|ui_completion
operator|<<
literal|8
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_escape
end_escape

begin_function
specifier|static
name|void
name|pdq_process_received_data
parameter_list|(
name|pdq_t
modifier|*
name|pdq
parameter_list|,
name|pdq_rx_info_t
modifier|*
name|rx
parameter_list|,
name|pdq_rxdesc_t
modifier|*
name|receives
parameter_list|,
name|pdq_uint32_t
name|completion_goal
parameter_list|,
name|pdq_uint32_t
name|ring_mask
parameter_list|)
block|{
name|pdq_uint32_t
name|completion
init|=
name|rx
operator|->
name|rx_completion
decl_stmt|;
name|pdq_uint32_t
name|producer
init|=
name|rx
operator|->
name|rx_producer
decl_stmt|;
name|PDQ_OS_DATABUF_T
modifier|*
modifier|*
name|buffers
init|=
operator|(
name|PDQ_OS_DATABUF_T
operator|*
operator|*
operator|)
name|rx
operator|->
name|rx_buffers
decl_stmt|;
name|pdq_rxdesc_t
modifier|*
name|rxd
decl_stmt|;
name|pdq_uint32_t
name|idx
decl_stmt|;
while|while
condition|(
name|completion
operator|!=
name|completion_goal
condition|)
block|{
name|PDQ_OS_DATABUF_T
modifier|*
name|fpdu
decl_stmt|,
modifier|*
name|lpdu
decl_stmt|,
modifier|*
name|npdu
decl_stmt|;
name|pdq_uint8_t
modifier|*
name|dataptr
decl_stmt|;
name|pdq_uint32_t
name|fc
decl_stmt|,
name|datalen
decl_stmt|,
name|pdulen
decl_stmt|,
name|segcnt
decl_stmt|;
name|pdq_rxstatus_t
name|status
decl_stmt|;
name|fpdu
operator|=
name|lpdu
operator|=
name|buffers
index|[
name|completion
index|]
expr_stmt|;
name|PDQ_ASSERT
argument_list|(
name|fpdu
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|dataptr
operator|=
name|PDQ_OS_DATABUF_PTR
argument_list|(
name|fpdu
argument_list|)
expr_stmt|;
name|status
operator|=
operator|*
operator|(
name|pdq_rxstatus_t
operator|*
operator|)
name|dataptr
expr_stmt|;
if|if
condition|(
operator|(
name|status
operator|.
name|rxs_status
operator|&
literal|0x200000
operator|)
operator|==
literal|0
condition|)
block|{
name|datalen
operator|=
name|status
operator|.
name|rxs_status
operator|&
literal|0x1FFF
expr_stmt|;
name|fc
operator|=
name|dataptr
index|[
name|PDQ_RX_FC_OFFSET
index|]
expr_stmt|;
switch|switch
condition|(
name|fc
operator|&
operator|(
name|PDQ_FDDIFC_C
operator||
name|PDQ_FDDIFC_L
operator||
name|PDQ_FDDIFC_F
operator|)
condition|)
block|{
case|case
name|PDQ_FDDI_LLC_ASYNC
case|:
case|case
name|PDQ_FDDI_LLC_SYNC
case|:
case|case
name|PDQ_FDDI_IMP_ASYNC
case|:
case|case
name|PDQ_FDDI_IMP_SYNC
case|:
block|{
if|if
condition|(
name|datalen
operator|>
name|PDQ_FDDI_MAX
operator|||
name|datalen
operator|<
name|PDQ_FDDI_LLC_MIN
condition|)
block|{
name|PDQ_PRINTF
argument_list|(
operator|(
literal|"discard: bad length %d\n"
operator|,
name|datalen
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|discard_frame
goto|;
block|}
break|break;
block|}
case|case
name|PDQ_FDDI_SMT
case|:
block|{
if|if
condition|(
name|datalen
operator|>
name|PDQ_FDDI_MAX
operator|||
name|datalen
operator|<
name|PDQ_FDDI_SMT_MIN
condition|)
goto|goto
name|discard_frame
goto|;
break|break;
block|}
default|default:
block|{
name|PDQ_PRINTF
argument_list|(
operator|(
literal|"discard: bad fc 0x%x\n"
operator|,
name|fc
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|discard_frame
goto|;
block|}
block|}
comment|/* 	     * Update the lengths of the data buffers now that we know 	     * the real length. 	     */
name|pdulen
operator|=
name|datalen
operator|-
literal|4
comment|/* CRC */
expr_stmt|;
name|segcnt
operator|=
operator|(
name|pdulen
operator|+
name|PDQ_RX_FC_OFFSET
operator|+
name|PDQ_OS_DATABUF_SIZE
operator|-
literal|1
operator|)
operator|/
name|PDQ_OS_DATABUF_SIZE
expr_stmt|;
name|PDQ_OS_DATABUF_ALLOC
argument_list|(
name|npdu
argument_list|)
expr_stmt|;
if|if
condition|(
name|npdu
operator|==
name|NULL
condition|)
block|{
name|PDQ_PRINTF
argument_list|(
operator|(
literal|"discard: no databuf #0\n"
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|discard_frame
goto|;
block|}
name|buffers
index|[
name|completion
index|]
operator|=
name|npdu
expr_stmt|;
for|for
control|(
name|idx
operator|=
literal|1
init|;
name|idx
operator|<
name|segcnt
condition|;
name|idx
operator|++
control|)
block|{
name|PDQ_OS_DATABUF_ALLOC
argument_list|(
name|npdu
argument_list|)
expr_stmt|;
if|if
condition|(
name|npdu
operator|==
name|NULL
condition|)
block|{
name|PDQ_OS_DATABUF_NEXT_SET
argument_list|(
name|lpdu
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|PDQ_OS_DATABUF_FREE
argument_list|(
name|fpdu
argument_list|)
expr_stmt|;
goto|goto
name|discard_frame
goto|;
block|}
name|PDQ_OS_DATABUF_NEXT_SET
argument_list|(
name|lpdu
argument_list|,
name|buffers
index|[
operator|(
name|completion
operator|+
name|idx
operator|)
operator|&
name|ring_mask
index|]
argument_list|)
expr_stmt|;
name|lpdu
operator|=
name|PDQ_OS_DATABUF_NEXT
argument_list|(
name|lpdu
argument_list|)
expr_stmt|;
name|buffers
index|[
operator|(
name|completion
operator|+
name|idx
operator|)
operator|&
name|ring_mask
index|]
operator|=
name|npdu
expr_stmt|;
block|}
name|PDQ_OS_DATABUF_NEXT_SET
argument_list|(
name|lpdu
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
for|for
control|(
name|idx
operator|=
literal|0
init|;
name|idx
operator|<
name|PDQ_RX_SEGCNT
condition|;
name|idx
operator|++
control|)
block|{
name|buffers
index|[
operator|(
name|producer
operator|+
name|idx
operator|)
operator|&
name|ring_mask
index|]
operator|=
name|buffers
index|[
operator|(
name|completion
operator|+
name|idx
operator|)
operator|&
name|ring_mask
index|]
expr_stmt|;
name|buffers
index|[
operator|(
name|completion
operator|+
name|idx
operator|)
operator|&
name|ring_mask
index|]
operator|=
name|NULL
expr_stmt|;
block|}
name|PDQ_OS_DATABUF_ADJ
argument_list|(
name|fpdu
argument_list|,
name|PDQ_RX_FC_OFFSET
argument_list|)
expr_stmt|;
if|if
condition|(
name|segcnt
operator|==
literal|1
condition|)
block|{
name|PDQ_OS_DATABUF_LEN_SET
argument_list|(
name|fpdu
argument_list|,
name|pdulen
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|PDQ_OS_DATABUF_LEN_SET
argument_list|(
name|lpdu
argument_list|,
name|pdulen
operator|+
name|PDQ_RX_FC_OFFSET
operator|-
operator|(
name|segcnt
operator|-
literal|1
operator|)
operator|*
name|PDQ_OS_DATABUF_SIZE
argument_list|)
expr_stmt|;
block|}
name|pdq_os_receive_pdu
argument_list|(
name|pdq
argument_list|,
name|fpdu
argument_list|,
name|pdulen
argument_list|)
expr_stmt|;
name|rx
operator|->
name|rx_free
operator|+=
name|PDQ_RX_SEGCNT
expr_stmt|;
name|PDQ_ADVANCE
argument_list|(
name|producer
argument_list|,
name|PDQ_RX_SEGCNT
argument_list|,
name|ring_mask
argument_list|)
expr_stmt|;
name|PDQ_ADVANCE
argument_list|(
name|completion
argument_list|,
name|PDQ_RX_SEGCNT
argument_list|,
name|ring_mask
argument_list|)
expr_stmt|;
continue|continue;
block|}
else|else
block|{
name|PDQ_PRINTF
argument_list|(
operator|(
literal|"discard: bad pdu 0x%x(%d.%d.%d.%d.%d)\n"
operator|,
name|status
operator|.
name|rxs_status
operator|,
name|status
operator|.
name|rxs_rcc_badpdu
operator|,
name|status
operator|.
name|rxs_rcc_badcrc
operator|,
name|status
operator|.
name|rxs_rcc_reason
operator|,
name|status
operator|.
name|rxs_fsc
operator|,
name|status
operator|.
name|rxs_fsb_e
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|.
name|rxs_rcc_reason
operator|==
literal|7
condition|)
goto|goto
name|discard_frame
goto|;
if|if
condition|(
name|status
operator|.
name|rxs_rcc_reason
operator|!=
literal|0
condition|)
comment|/* hardware fault */
if|if
condition|(
name|status
operator|.
name|rxs_rcc_badcrc
condition|)
block|{
name|printf
argument_list|(
name|PDQ_OS_PREFIX
literal|" MAC CRC error (source=%x-%x-%x-%x-%x-%x)\n"
argument_list|,
name|PDQ_OS_PREFIX_ARGS
argument_list|,
name|dataptr
index|[
name|PDQ_RX_FC_OFFSET
operator|+
literal|1
index|]
argument_list|,
name|dataptr
index|[
name|PDQ_RX_FC_OFFSET
operator|+
literal|2
index|]
argument_list|,
name|dataptr
index|[
name|PDQ_RX_FC_OFFSET
operator|+
literal|3
index|]
argument_list|,
name|dataptr
index|[
name|PDQ_RX_FC_OFFSET
operator|+
literal|4
index|]
argument_list|,
name|dataptr
index|[
name|PDQ_RX_FC_OFFSET
operator|+
literal|5
index|]
argument_list|,
name|dataptr
index|[
name|PDQ_RX_FC_OFFSET
operator|+
literal|6
index|]
argument_list|)
expr_stmt|;
comment|/* rx->rx_badcrc++; */
block|}
elseif|else
if|if
condition|(
name|status
operator|.
name|rxs_fsc
operator|==
literal|0
operator|||
name|status
operator|.
name|rxs_fsb_e
operator|==
literal|1
condition|)
block|{
comment|/* rx->rx_frame_status_errors++; */
block|}
else|else
block|{
comment|/* hardware fault */
block|}
block|}
name|discard_frame
label|:
comment|/* 	 * Discarded frames go right back on the queue; therefore 	 * ring entries were freed. 	 */
for|for
control|(
name|idx
operator|=
literal|0
init|;
name|idx
operator|<
name|PDQ_RX_SEGCNT
condition|;
name|idx
operator|++
control|)
block|{
name|buffers
index|[
name|producer
index|]
operator|=
name|buffers
index|[
name|completion
index|]
expr_stmt|;
name|buffers
index|[
name|completion
index|]
operator|=
name|NULL
expr_stmt|;
name|rxd
operator|=
operator|&
name|receives
index|[
name|rx
operator|->
name|rx_producer
index|]
expr_stmt|;
if|if
condition|(
name|idx
operator|==
literal|0
condition|)
block|{
name|rxd
operator|->
name|rxd_sop
operator|=
literal|1
expr_stmt|;
name|rxd
operator|->
name|rxd_seg_cnt
operator|=
name|PDQ_RX_SEGCNT
operator|-
literal|1
expr_stmt|;
block|}
else|else
block|{
name|rxd
operator|->
name|rxd_sop
operator|=
literal|0
expr_stmt|;
name|rxd
operator|->
name|rxd_seg_cnt
operator|=
literal|0
expr_stmt|;
block|}
name|rxd
operator|->
name|rxd_pa_hi
operator|=
literal|0
expr_stmt|;
name|rxd
operator|->
name|rxd_seg_len_hi
operator|=
name|PDQ_OS_DATABUF_SIZE
operator|/
literal|16
expr_stmt|;
name|rxd
operator|->
name|rxd_pa_lo
operator|=
name|PDQ_OS_VA_TO_PA
argument_list|(
name|pdq
argument_list|,
name|PDQ_OS_DATABUF_PTR
argument_list|(
name|buffers
index|[
name|rx
operator|->
name|rx_producer
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|PDQ_ADVANCE
argument_list|(
name|rx
operator|->
name|rx_producer
argument_list|,
literal|1
argument_list|,
name|ring_mask
argument_list|)
expr_stmt|;
name|PDQ_ADVANCE
argument_list|(
name|producer
argument_list|,
literal|1
argument_list|,
name|ring_mask
argument_list|)
expr_stmt|;
name|PDQ_ADVANCE
argument_list|(
name|completion
argument_list|,
literal|1
argument_list|,
name|ring_mask
argument_list|)
expr_stmt|;
block|}
block|}
name|rx
operator|->
name|rx_completion
operator|=
name|completion
expr_stmt|;
while|while
condition|(
name|rx
operator|->
name|rx_free
operator|>
name|PDQ_RX_SEGCNT
operator|&&
name|rx
operator|->
name|rx_free
operator|>
name|rx
operator|->
name|rx_target
condition|)
block|{
name|PDQ_OS_DATABUF_T
modifier|*
name|pdu
decl_stmt|;
comment|/* 	 * Allocate the needed number of data buffers. 	 * Try to obtain them from our free queue before 	 * asking the system for more. 	 */
for|for
control|(
name|idx
operator|=
literal|0
init|;
name|idx
operator|<
name|PDQ_RX_SEGCNT
condition|;
name|idx
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|pdu
operator|=
name|buffers
index|[
operator|(
name|rx
operator|->
name|rx_producer
operator|+
name|idx
operator|)
operator|&
name|ring_mask
index|]
operator|)
operator|==
name|NULL
condition|)
block|{
name|PDQ_OS_DATABUF_ALLOC
argument_list|(
name|pdu
argument_list|)
expr_stmt|;
if|if
condition|(
name|pdu
operator|==
name|NULL
condition|)
break|break;
name|buffers
index|[
operator|(
name|rx
operator|->
name|rx_producer
operator|+
name|idx
operator|)
operator|&
name|ring_mask
index|]
operator|=
name|pdu
expr_stmt|;
block|}
name|rxd
operator|=
operator|&
name|receives
index|[
operator|(
name|rx
operator|->
name|rx_producer
operator|+
name|idx
operator|)
operator|&
name|ring_mask
index|]
expr_stmt|;
if|if
condition|(
name|idx
operator|==
literal|0
condition|)
block|{
name|rxd
operator|->
name|rxd_sop
operator|=
literal|1
expr_stmt|;
name|rxd
operator|->
name|rxd_seg_cnt
operator|=
name|PDQ_RX_SEGCNT
operator|-
literal|1
expr_stmt|;
block|}
else|else
block|{
name|rxd
operator|->
name|rxd_sop
operator|=
literal|0
expr_stmt|;
name|rxd
operator|->
name|rxd_seg_cnt
operator|=
literal|0
expr_stmt|;
block|}
name|rxd
operator|->
name|rxd_pa_hi
operator|=
literal|0
expr_stmt|;
name|rxd
operator|->
name|rxd_seg_len_hi
operator|=
name|PDQ_OS_DATABUF_SIZE
operator|/
literal|16
expr_stmt|;
name|rxd
operator|->
name|rxd_pa_lo
operator|=
name|PDQ_OS_VA_TO_PA
argument_list|(
name|pdq
argument_list|,
name|PDQ_OS_DATABUF_PTR
argument_list|(
name|pdu
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|idx
operator|<
name|PDQ_RX_SEGCNT
condition|)
block|{
comment|/* 	     * We didn't get all databufs required to complete a new 	     * receive buffer.  Keep the ones we got and retry a bit 	     * later for the rest. 	     */
break|break;
block|}
name|PDQ_ADVANCE
argument_list|(
name|rx
operator|->
name|rx_producer
argument_list|,
name|PDQ_RX_SEGCNT
argument_list|,
name|ring_mask
argument_list|)
expr_stmt|;
name|rx
operator|->
name|rx_free
operator|-=
name|PDQ_RX_SEGCNT
expr_stmt|;
block|}
block|}
end_function

begin_escape
end_escape

begin_function
name|pdq_boolean_t
name|pdq_queue_transmit_data
parameter_list|(
name|pdq_t
modifier|*
name|pdq
parameter_list|,
name|PDQ_OS_DATABUF_T
modifier|*
name|pdu
parameter_list|)
block|{
name|pdq_tx_info_t
modifier|*
name|tx
init|=
operator|&
name|pdq
operator|->
name|pdq_tx_info
decl_stmt|;
name|pdq_descriptor_block_t
modifier|*
name|dbp
init|=
name|pdq
operator|->
name|pdq_dbp
decl_stmt|;
name|pdq_uint32_t
name|producer
init|=
name|tx
operator|->
name|tx_producer
decl_stmt|;
name|pdq_txdesc_t
modifier|*
name|eop
init|=
name|NULL
decl_stmt|;
name|PDQ_OS_DATABUF_T
modifier|*
name|pdu0
decl_stmt|;
name|pdq_uint32_t
name|freecnt
decl_stmt|;
if|if
condition|(
name|tx
operator|->
name|tx_free
operator|<
literal|1
condition|)
return|return
name|PDQ_FALSE
return|;
name|dbp
operator|->
name|pdqdb_transmits
index|[
name|producer
index|]
operator|=
name|tx
operator|->
name|tx_hdrdesc
expr_stmt|;
name|PDQ_ADVANCE
argument_list|(
name|producer
argument_list|,
literal|1
argument_list|,
name|PDQ_RING_MASK
argument_list|(
name|dbp
operator|->
name|pdqdb_transmits
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|freecnt
operator|=
name|tx
operator|->
name|tx_free
operator|-
literal|1
operator|,
name|pdu0
operator|=
name|pdu
init|;
name|pdu0
operator|!=
name|NULL
operator|&&
name|freecnt
operator|>
literal|0
condition|;
control|)
block|{
name|pdq_uint32_t
name|fraglen
decl_stmt|,
name|datalen
init|=
name|PDQ_OS_DATABUF_LEN
argument_list|(
name|pdu0
argument_list|)
decl_stmt|;
specifier|const
name|pdq_uint8_t
modifier|*
name|dataptr
init|=
name|PDQ_OS_DATABUF_PTR
argument_list|(
name|pdu0
argument_list|)
decl_stmt|;
comment|/* 	 * The first segment is limited to the space remaining in 	 * page.  All segments after that can be up to a full page 	 * in size. 	 */
name|fraglen
operator|=
name|PDQ_OS_PAGESIZE
operator|-
operator|(
operator|(
name|dataptr
operator|-
operator|(
name|pdq_uint8_t
operator|*
operator|)
name|NULL
operator|)
operator|&
operator|(
name|PDQ_OS_PAGESIZE
operator|-
literal|1
operator|)
operator|)
expr_stmt|;
while|while
condition|(
name|datalen
operator|>
literal|0
operator|&&
name|freecnt
operator|>
literal|0
condition|)
block|{
name|pdq_uint32_t
name|seglen
init|=
operator|(
name|fraglen
operator|<
name|datalen
condition|?
name|fraglen
else|:
name|datalen
operator|)
decl_stmt|;
comment|/* 	     * Initialize the transmit descriptor 	     */
name|eop
operator|=
operator|&
name|dbp
operator|->
name|pdqdb_transmits
index|[
name|producer
index|]
expr_stmt|;
name|eop
operator|->
name|txd_seg_len
operator|=
name|seglen
expr_stmt|;
name|eop
operator|->
name|txd_pa_lo
operator|=
name|PDQ_OS_VA_TO_PA
argument_list|(
name|pdq
argument_list|,
name|dataptr
argument_list|)
expr_stmt|;
name|eop
operator|->
name|txd_sop
operator|=
name|eop
operator|->
name|txd_eop
operator|=
name|eop
operator|->
name|txd_pa_hi
operator|=
literal|0
expr_stmt|;
name|datalen
operator|-=
name|seglen
expr_stmt|;
name|dataptr
operator|+=
name|seglen
expr_stmt|;
name|fraglen
operator|=
name|PDQ_OS_PAGESIZE
expr_stmt|;
name|freecnt
operator|--
expr_stmt|;
name|PDQ_ADVANCE
argument_list|(
name|producer
argument_list|,
literal|1
argument_list|,
name|PDQ_RING_MASK
argument_list|(
name|dbp
operator|->
name|pdqdb_transmits
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|pdu0
operator|=
name|PDQ_OS_DATABUF_NEXT
argument_list|(
name|pdu0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pdu0
operator|!=
name|NULL
condition|)
block|{
name|PDQ_ASSERT
argument_list|(
name|freecnt
operator|==
literal|0
argument_list|)
expr_stmt|;
comment|/* 	 * If we still have data to process then the ring was too full 	 * to store the PDU.  Return FALSE so the caller will requeue 	 * the PDU for later. 	 */
return|return
name|PDQ_FALSE
return|;
block|}
comment|/*      * Everything went fine.  Finish it up.      */
name|tx
operator|->
name|tx_descriptor_count
index|[
name|tx
operator|->
name|tx_producer
index|]
operator|=
name|tx
operator|->
name|tx_free
operator|-
name|freecnt
expr_stmt|;
name|eop
operator|->
name|txd_eop
operator|=
literal|1
expr_stmt|;
name|PDQ_OS_DATABUF_ENQUEUE
argument_list|(
operator|&
name|tx
operator|->
name|tx_txq
argument_list|,
name|pdu
argument_list|)
expr_stmt|;
name|tx
operator|->
name|tx_producer
operator|=
name|producer
expr_stmt|;
name|tx
operator|->
name|tx_free
operator|=
name|freecnt
expr_stmt|;
name|PDQ_DO_TYPE2_PRODUCER
argument_list|(
name|pdq
argument_list|)
expr_stmt|;
return|return
name|PDQ_TRUE
return|;
block|}
end_function

begin_escape
end_escape

begin_function
specifier|static
name|void
name|pdq_process_transmitted_data
parameter_list|(
name|pdq_t
modifier|*
name|pdq
parameter_list|)
block|{
name|pdq_tx_info_t
modifier|*
name|tx
init|=
operator|&
name|pdq
operator|->
name|pdq_tx_info
decl_stmt|;
specifier|volatile
specifier|const
name|pdq_consumer_block_t
modifier|*
name|cbp
init|=
name|pdq
operator|->
name|pdq_cbp
decl_stmt|;
name|pdq_descriptor_block_t
modifier|*
name|dbp
init|=
name|pdq
operator|->
name|pdq_dbp
decl_stmt|;
name|pdq_uint32_t
name|completion
init|=
name|tx
operator|->
name|tx_completion
decl_stmt|;
while|while
condition|(
name|completion
operator|!=
name|cbp
operator|->
name|pdqcb_transmits
condition|)
block|{
name|PDQ_OS_DATABUF_T
modifier|*
name|pdu
decl_stmt|;
name|pdq_uint32_t
name|descriptor_count
init|=
name|tx
operator|->
name|tx_descriptor_count
index|[
name|completion
index|]
decl_stmt|;
name|PDQ_ASSERT
argument_list|(
name|dbp
operator|->
name|pdqdb_transmits
index|[
name|completion
index|]
operator|.
name|txd_sop
operator|==
literal|1
argument_list|)
expr_stmt|;
name|PDQ_ASSERT
argument_list|(
name|dbp
operator|->
name|pdqdb_transmits
index|[
operator|(
name|completion
operator|+
name|descriptor_count
operator|-
literal|1
operator|)
operator|&
name|PDQ_RING_MASK
argument_list|(
name|dbp
operator|->
name|pdqdb_transmits
argument_list|)
index|]
operator|.
name|txd_eop
operator|==
literal|1
argument_list|)
expr_stmt|;
name|PDQ_OS_DATABUF_DEQUEUE
argument_list|(
operator|&
name|tx
operator|->
name|tx_txq
argument_list|,
name|pdu
argument_list|)
expr_stmt|;
name|pdq_os_transmit_done
argument_list|(
name|pdq
argument_list|,
name|pdu
argument_list|)
expr_stmt|;
name|tx
operator|->
name|tx_free
operator|+=
name|descriptor_count
expr_stmt|;
name|PDQ_ADVANCE
argument_list|(
name|completion
argument_list|,
name|descriptor_count
argument_list|,
name|PDQ_RING_MASK
argument_list|(
name|dbp
operator|->
name|pdqdb_transmits
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|tx
operator|->
name|tx_completion
operator|!=
name|completion
condition|)
block|{
name|tx
operator|->
name|tx_completion
operator|=
name|completion
expr_stmt|;
name|pdq_os_restart_transmitter
argument_list|(
name|pdq
argument_list|)
expr_stmt|;
block|}
name|PDQ_DO_TYPE2_PRODUCER
argument_list|(
name|pdq
argument_list|)
expr_stmt|;
block|}
end_function

begin_escape
end_escape

begin_function
name|void
name|pdq_flush_transmitter
parameter_list|(
name|pdq_t
modifier|*
name|pdq
parameter_list|)
block|{
specifier|volatile
name|pdq_consumer_block_t
modifier|*
name|cbp
init|=
name|pdq
operator|->
name|pdq_cbp
decl_stmt|;
name|pdq_tx_info_t
modifier|*
name|tx
init|=
operator|&
name|pdq
operator|->
name|pdq_tx_info
decl_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|PDQ_OS_DATABUF_T
modifier|*
name|pdu
decl_stmt|;
name|PDQ_OS_DATABUF_DEQUEUE
argument_list|(
operator|&
name|tx
operator|->
name|tx_txq
argument_list|,
name|pdu
argument_list|)
expr_stmt|;
if|if
condition|(
name|pdu
operator|==
name|NULL
condition|)
break|break;
comment|/* 	 * Don't call transmit done since the packet never made it 	 * out on the wire. 	 */
name|PDQ_OS_DATABUF_FREE
argument_list|(
name|pdu
argument_list|)
expr_stmt|;
block|}
name|tx
operator|->
name|tx_free
operator|=
name|PDQ_RING_MASK
argument_list|(
name|pdq
operator|->
name|pdq_dbp
operator|->
name|pdqdb_transmits
argument_list|)
expr_stmt|;
name|tx
operator|->
name|tx_completion
operator|=
name|cbp
operator|->
name|pdqcb_transmits
operator|=
name|tx
operator|->
name|tx_producer
expr_stmt|;
name|PDQ_DO_TYPE2_PRODUCER
argument_list|(
name|pdq
argument_list|)
expr_stmt|;
block|}
end_function

begin_escape
end_escape

begin_function
name|void
name|pdq_hwreset
parameter_list|(
name|pdq_t
modifier|*
name|pdq
parameter_list|)
block|{
specifier|const
name|pdq_csrs_t
modifier|*
specifier|const
name|csrs
init|=
operator|&
name|pdq
operator|->
name|pdq_csrs
decl_stmt|;
name|pdq_state_t
name|state
decl_stmt|;
name|int
name|cnt
decl_stmt|;
name|state
operator|=
name|PDQ_PSTS_ADAPTER_STATE
argument_list|(
name|PDQ_CSR_READ
argument_list|(
name|csrs
argument_list|,
name|csr_port_status
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|state
operator|==
name|PDQS_DMA_UNAVAILABLE
condition|)
return|return;
name|PDQ_CSR_WRITE
argument_list|(
name|csrs
argument_list|,
name|csr_port_data_a
argument_list|,
operator|(
name|state
operator|==
name|PDQS_HALTED
operator|)
condition|?
literal|0
else|:
name|PDQ_PRESET_SKIP_SELFTEST
argument_list|)
expr_stmt|;
name|PDQ_CSR_WRITE
argument_list|(
name|csrs
argument_list|,
name|csr_port_reset
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|PDQ_OS_USEC_DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
name|PDQ_CSR_WRITE
argument_list|(
name|csrs
argument_list|,
name|csr_port_reset
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|cnt
operator|=
literal|45000
init|;
condition|;
name|cnt
operator|--
control|)
block|{
name|PDQ_OS_USEC_DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
name|state
operator|=
name|PDQ_PSTS_ADAPTER_STATE
argument_list|(
name|PDQ_CSR_READ
argument_list|(
name|csrs
argument_list|,
name|csr_port_status
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|state
operator|==
name|PDQS_DMA_UNAVAILABLE
operator|||
name|cnt
operator|==
literal|0
condition|)
break|break;
block|}
name|PDQ_PRINTF
argument_list|(
operator|(
literal|"PDQ Reset spun %d cycles\n"
operator|,
literal|45000
operator|-
name|cnt
operator|)
argument_list|)
expr_stmt|;
name|PDQ_OS_USEC_DELAY
argument_list|(
literal|10000
argument_list|)
expr_stmt|;
name|state
operator|=
name|PDQ_PSTS_ADAPTER_STATE
argument_list|(
name|PDQ_CSR_READ
argument_list|(
name|csrs
argument_list|,
name|csr_port_status
argument_list|)
argument_list|)
expr_stmt|;
name|PDQ_ASSERT
argument_list|(
name|state
operator|==
name|PDQS_DMA_UNAVAILABLE
argument_list|)
expr_stmt|;
name|PDQ_ASSERT
argument_list|(
name|cnt
operator|>
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/*  * The following routine brings the PDQ from whatever state it is   * in to DMA_UNAVAILABLE (ie. like a RESET but without doing a RESET).  */
end_comment

begin_function
name|pdq_state_t
name|pdq_stop
parameter_list|(
name|pdq_t
modifier|*
name|pdq
parameter_list|)
block|{
name|pdq_state_t
name|state
decl_stmt|;
specifier|const
name|pdq_csrs_t
modifier|*
specifier|const
name|csrs
init|=
operator|&
name|pdq
operator|->
name|pdq_csrs
decl_stmt|;
name|int
name|cnt
decl_stmt|,
name|pass
init|=
literal|0
decl_stmt|,
name|idx
decl_stmt|;
name|PDQ_OS_DATABUF_T
modifier|*
modifier|*
name|buffers
decl_stmt|;
name|restart
label|:
name|state
operator|=
name|PDQ_PSTS_ADAPTER_STATE
argument_list|(
name|PDQ_CSR_READ
argument_list|(
name|csrs
argument_list|,
name|csr_port_status
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|state
operator|!=
name|PDQS_DMA_UNAVAILABLE
condition|)
block|{
name|pdq_hwreset
argument_list|(
name|pdq
argument_list|)
expr_stmt|;
name|state
operator|=
name|PDQ_PSTS_ADAPTER_STATE
argument_list|(
name|PDQ_CSR_READ
argument_list|(
name|csrs
argument_list|,
name|csr_port_status
argument_list|)
argument_list|)
expr_stmt|;
name|PDQ_ASSERT
argument_list|(
name|state
operator|==
name|PDQS_DMA_UNAVAILABLE
argument_list|)
expr_stmt|;
block|}
if|#
directive|if
literal|0
block|switch (state) { 	case PDQS_RING_MEMBER: 	case PDQS_LINK_UNAVAILABLE: 	case PDQS_LINK_AVAILABLE: { 	    PDQ_CSR_WRITE(csrs, csr_port_data_a, PDQ_SUB_CMD_LINK_UNINIT); 	    PDQ_CSR_WRITE(csrs, csr_port_data_b, 0); 	    pdq_do_port_control(csrs, PDQ_PCTL_SUB_CMD); 	    state = PDQ_PSTS_ADAPTER_STATE(PDQ_CSR_READ(csrs, csr_port_status)); 	    PDQ_ASSERT(state == PDQS_DMA_AVAILABLE);
comment|/* FALL THROUGH */
block|} 	case PDQS_DMA_AVAILABLE: { 	    PDQ_CSR_WRITE(csrs, csr_port_data_a, 0); 	    PDQ_CSR_WRITE(csrs, csr_port_data_b, 0); 	    pdq_do_port_control(csrs, PDQ_PCTL_DMA_UNINIT); 	    state = PDQ_PSTS_ADAPTER_STATE(PDQ_CSR_READ(csrs, csr_port_status)); 	    PDQ_ASSERT(state == PDQS_DMA_UNAVAILABLE);
comment|/* FALL THROUGH */
block|} 	case PDQS_DMA_UNAVAILABLE: { 	    break; 	}     }
endif|#
directive|endif
comment|/*      * Now we should be in DMA_UNAVAILABLE.  So bring the PDQ into      * DMA_AVAILABLE.      */
comment|/*      * Obtain the hardware address and firmware revisions      * (MLA = my long address which is FDDI speak for hardware address)      */
name|pdq_read_mla
argument_list|(
operator|&
name|pdq
operator|->
name|pdq_csrs
argument_list|,
operator|&
name|pdq
operator|->
name|pdq_hwaddr
argument_list|)
expr_stmt|;
name|pdq_read_fwrev
argument_list|(
operator|&
name|pdq
operator|->
name|pdq_csrs
argument_list|,
operator|&
name|pdq
operator|->
name|pdq_fwrev
argument_list|)
expr_stmt|;
name|pdq
operator|->
name|pdq_chip_rev
operator|=
name|pdq_read_chiprev
argument_list|(
operator|&
name|pdq
operator|->
name|pdq_csrs
argument_list|)
expr_stmt|;
if|if
condition|(
name|pdq
operator|->
name|pdq_type
operator|==
name|PDQ_DEFPA
condition|)
block|{
comment|/* 	 * Disable interrupts and DMA. 	 */
name|PDQ_CSR_WRITE
argument_list|(
operator|&
name|pdq
operator|->
name|pdq_pci_csrs
argument_list|,
name|csr_pfi_mode_control
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|PDQ_CSR_WRITE
argument_list|(
operator|&
name|pdq
operator|->
name|pdq_pci_csrs
argument_list|,
name|csr_pfi_status
argument_list|,
literal|0x10
argument_list|)
expr_stmt|;
block|}
comment|/*      * Flush all the databuf queues.      */
name|pdq_flush_databuf_queue
argument_list|(
operator|&
name|pdq
operator|->
name|pdq_tx_info
operator|.
name|tx_txq
argument_list|)
expr_stmt|;
name|pdq
operator|->
name|pdq_flags
operator|&=
operator|~
name|PDQ_TXOK
expr_stmt|;
name|buffers
operator|=
operator|(
name|PDQ_OS_DATABUF_T
operator|*
operator|*
operator|)
name|pdq
operator|->
name|pdq_rx_info
operator|.
name|rx_buffers
expr_stmt|;
for|for
control|(
name|idx
operator|=
literal|0
init|;
name|idx
operator|<
name|PDQ_RING_SIZE
argument_list|(
name|pdq
operator|->
name|pdq_dbp
operator|->
name|pdqdb_receives
argument_list|)
condition|;
name|idx
operator|++
control|)
block|{
if|if
condition|(
name|buffers
index|[
name|idx
index|]
operator|!=
name|NULL
condition|)
block|{
name|PDQ_OS_DATABUF_FREE
argument_list|(
name|buffers
index|[
name|idx
index|]
argument_list|)
expr_stmt|;
name|buffers
index|[
name|idx
index|]
operator|=
name|NULL
expr_stmt|;
block|}
block|}
name|pdq
operator|->
name|pdq_rx_info
operator|.
name|rx_free
operator|=
name|PDQ_RING_MASK
argument_list|(
name|pdq
operator|->
name|pdq_dbp
operator|->
name|pdqdb_receives
argument_list|)
expr_stmt|;
name|buffers
operator|=
operator|(
name|PDQ_OS_DATABUF_T
operator|*
operator|*
operator|)
name|pdq
operator|->
name|pdq_host_smt_info
operator|.
name|rx_buffers
expr_stmt|;
for|for
control|(
name|idx
operator|=
literal|0
init|;
name|idx
operator|<
name|PDQ_RING_SIZE
argument_list|(
name|pdq
operator|->
name|pdq_dbp
operator|->
name|pdqdb_host_smt
argument_list|)
condition|;
name|idx
operator|++
control|)
block|{
if|if
condition|(
name|buffers
index|[
name|idx
index|]
operator|!=
name|NULL
condition|)
block|{
name|PDQ_OS_DATABUF_FREE
argument_list|(
name|buffers
index|[
name|idx
index|]
argument_list|)
expr_stmt|;
name|buffers
index|[
name|idx
index|]
operator|=
name|NULL
expr_stmt|;
block|}
block|}
name|pdq
operator|->
name|pdq_host_smt_info
operator|.
name|rx_free
operator|=
name|PDQ_RING_MASK
argument_list|(
name|pdq
operator|->
name|pdq_dbp
operator|->
name|pdqdb_host_smt
argument_list|)
expr_stmt|;
comment|/*      * Reset the consumer indexes to 0.      */
name|pdq
operator|->
name|pdq_cbp
operator|->
name|pdqcb_receives
operator|=
literal|0
expr_stmt|;
name|pdq
operator|->
name|pdq_cbp
operator|->
name|pdqcb_transmits
operator|=
literal|0
expr_stmt|;
name|pdq
operator|->
name|pdq_cbp
operator|->
name|pdqcb_host_smt
operator|=
literal|0
expr_stmt|;
name|pdq
operator|->
name|pdq_cbp
operator|->
name|pdqcb_unsolicited_event
operator|=
literal|0
expr_stmt|;
name|pdq
operator|->
name|pdq_cbp
operator|->
name|pdqcb_command_response
operator|=
literal|0
expr_stmt|;
name|pdq
operator|->
name|pdq_cbp
operator|->
name|pdqcb_command_request
operator|=
literal|0
expr_stmt|;
comment|/*      * Reset the producer and completion indexes to 0.      */
name|pdq
operator|->
name|pdq_command_info
operator|.
name|ci_request_producer
operator|=
literal|0
expr_stmt|;
name|pdq
operator|->
name|pdq_command_info
operator|.
name|ci_response_producer
operator|=
literal|0
expr_stmt|;
name|pdq
operator|->
name|pdq_command_info
operator|.
name|ci_request_completion
operator|=
literal|0
expr_stmt|;
name|pdq
operator|->
name|pdq_command_info
operator|.
name|ci_response_completion
operator|=
literal|0
expr_stmt|;
name|pdq
operator|->
name|pdq_unsolicited_info
operator|.
name|ui_producer
operator|=
literal|0
expr_stmt|;
name|pdq
operator|->
name|pdq_unsolicited_info
operator|.
name|ui_completion
operator|=
literal|0
expr_stmt|;
name|pdq
operator|->
name|pdq_rx_info
operator|.
name|rx_producer
operator|=
literal|0
expr_stmt|;
name|pdq
operator|->
name|pdq_rx_info
operator|.
name|rx_completion
operator|=
literal|0
expr_stmt|;
name|pdq
operator|->
name|pdq_tx_info
operator|.
name|tx_producer
operator|=
literal|0
expr_stmt|;
name|pdq
operator|->
name|pdq_tx_info
operator|.
name|tx_completion
operator|=
literal|0
expr_stmt|;
name|pdq
operator|->
name|pdq_host_smt_info
operator|.
name|rx_producer
operator|=
literal|0
expr_stmt|;
name|pdq
operator|->
name|pdq_host_smt_info
operator|.
name|rx_completion
operator|=
literal|0
expr_stmt|;
name|pdq
operator|->
name|pdq_command_info
operator|.
name|ci_command_active
operator|=
literal|0
expr_stmt|;
name|pdq
operator|->
name|pdq_unsolicited_info
operator|.
name|ui_free
operator|=
name|PDQ_NUM_UNSOLICITED_EVENTS
expr_stmt|;
name|pdq
operator|->
name|pdq_tx_info
operator|.
name|tx_free
operator|=
name|PDQ_RING_MASK
argument_list|(
name|pdq
operator|->
name|pdq_dbp
operator|->
name|pdqdb_transmits
argument_list|)
expr_stmt|;
comment|/*      * Allow the DEFPA to do DMA.  Then program the physical       * addresses of the consumer and descriptor blocks.      */
if|if
condition|(
name|pdq
operator|->
name|pdq_type
operator|==
name|PDQ_DEFPA
condition|)
block|{
ifdef|#
directive|ifdef
name|PDQTEST
name|PDQ_CSR_WRITE
argument_list|(
operator|&
name|pdq
operator|->
name|pdq_pci_csrs
argument_list|,
name|csr_pfi_mode_control
argument_list|,
name|PDQ_PFI_MODE_DMA_ENABLE
argument_list|)
expr_stmt|;
else|#
directive|else
name|PDQ_CSR_WRITE
argument_list|(
operator|&
name|pdq
operator|->
name|pdq_pci_csrs
argument_list|,
name|csr_pfi_mode_control
argument_list|,
name|PDQ_PFI_MODE_DMA_ENABLE
comment|/*|PDQ_PFI_MODE_PFI_PCI_INTR*/
operator||
name|PDQ_PFI_MODE_PDQ_PCI_INTR
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
comment|/*      * Make sure the unsolicited queue has events ...      */
name|pdq_process_unsolicited_events
argument_list|(
name|pdq
argument_list|)
expr_stmt|;
if|if
condition|(
name|pdq
operator|->
name|pdq_type
operator|==
name|PDQ_DEFEA
operator|&&
name|pdq
operator|->
name|pdq_chip_rev
operator|==
name|PDQ_CHIP_REV_E
condition|)
name|PDQ_CSR_WRITE
argument_list|(
name|csrs
argument_list|,
name|csr_port_data_b
argument_list|,
name|PDQ_DMA_BURST_16LW
argument_list|)
expr_stmt|;
else|else
name|PDQ_CSR_WRITE
argument_list|(
name|csrs
argument_list|,
name|csr_port_data_b
argument_list|,
name|PDQ_DMA_BURST_8LW
argument_list|)
expr_stmt|;
name|PDQ_CSR_WRITE
argument_list|(
name|csrs
argument_list|,
name|csr_port_data_a
argument_list|,
name|PDQ_SUB_CMD_DMA_BURST_SIZE_SET
argument_list|)
expr_stmt|;
name|pdq_do_port_control
argument_list|(
name|csrs
argument_list|,
name|PDQ_PCTL_SUB_CMD
argument_list|)
expr_stmt|;
name|PDQ_CSR_WRITE
argument_list|(
name|csrs
argument_list|,
name|csr_port_data_b
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|PDQ_CSR_WRITE
argument_list|(
name|csrs
argument_list|,
name|csr_port_data_a
argument_list|,
name|PDQ_OS_VA_TO_PA
argument_list|(
name|pdq
argument_list|,
name|pdq
operator|->
name|pdq_cbp
argument_list|)
argument_list|)
expr_stmt|;
name|pdq_do_port_control
argument_list|(
name|csrs
argument_list|,
name|PDQ_PCTL_CONSUMER_BLOCK
argument_list|)
expr_stmt|;
name|PDQ_CSR_WRITE
argument_list|(
name|csrs
argument_list|,
name|csr_port_data_b
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|PDQ_CSR_WRITE
argument_list|(
name|csrs
argument_list|,
name|csr_port_data_a
argument_list|,
name|PDQ_OS_VA_TO_PA
argument_list|(
name|pdq
argument_list|,
name|pdq
operator|->
name|pdq_dbp
argument_list|)
operator||
name|PDQ_DMA_INIT_LW_BSWAP_DATA
argument_list|)
expr_stmt|;
name|pdq_do_port_control
argument_list|(
name|csrs
argument_list|,
name|PDQ_PCTL_DMA_INIT
argument_list|)
expr_stmt|;
for|for
control|(
name|cnt
operator|=
literal|0
init|;
name|cnt
operator|<
literal|1000
condition|;
name|cnt
operator|++
control|)
block|{
name|state
operator|=
name|PDQ_PSTS_ADAPTER_STATE
argument_list|(
name|PDQ_CSR_READ
argument_list|(
name|csrs
argument_list|,
name|csr_port_status
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|state
operator|==
name|PDQS_HALTED
condition|)
block|{
if|if
condition|(
name|pass
operator|>
literal|0
condition|)
return|return
name|PDQS_HALTED
return|;
name|pass
operator|=
literal|1
expr_stmt|;
goto|goto
name|restart
goto|;
block|}
if|if
condition|(
name|state
operator|==
name|PDQS_DMA_AVAILABLE
condition|)
block|{
name|PDQ_PRINTF
argument_list|(
operator|(
literal|"Transition to DMA Available took %d spins\n"
operator|,
name|cnt
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|PDQ_OS_USEC_DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
block|}
name|PDQ_ASSERT
argument_list|(
name|state
operator|==
name|PDQS_DMA_AVAILABLE
argument_list|)
expr_stmt|;
name|PDQ_CSR_WRITE
argument_list|(
name|csrs
argument_list|,
name|csr_host_int_type_0
argument_list|,
literal|0xFF
argument_list|)
expr_stmt|;
name|PDQ_CSR_WRITE
argument_list|(
name|csrs
argument_list|,
name|csr_host_int_enable
argument_list|,
literal|0
argument_list|)
comment|/* PDQ_HOST_INT_STATE_CHANGE 	|PDQ_HOST_INT_FATAL_ERROR|PDQ_HOST_INT_CMD_RSP_ENABLE 	|PDQ_HOST_INT_UNSOL_ENABLE */
expr_stmt|;
comment|/*      * Any other command but START should be valid.      */
name|pdq
operator|->
name|pdq_command_info
operator|.
name|ci_pending_commands
operator|&=
operator|~
operator|(
name|PDQ_BITMASK
argument_list|(
name|PDQC_START
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
name|pdq
operator|->
name|pdq_flags
operator|&
name|PDQ_PRINTCHARS
condition|)
name|pdq
operator|->
name|pdq_command_info
operator|.
name|ci_pending_commands
operator||=
name|PDQ_BITMASK
argument_list|(
name|PDQC_STATUS_CHARS_GET
argument_list|)
expr_stmt|;
name|pdq_queue_commands
argument_list|(
name|pdq
argument_list|)
expr_stmt|;
if|if
condition|(
name|pdq
operator|->
name|pdq_flags
operator|&
name|PDQ_PRINTCHARS
condition|)
block|{
comment|/* 	 * Now wait (up to 100ms) for the command(s) to finish. 	 */
for|for
control|(
name|cnt
operator|=
literal|0
init|;
name|cnt
operator|<
literal|1000
condition|;
name|cnt
operator|++
control|)
block|{
name|pdq_process_command_responses
argument_list|(
name|pdq
argument_list|)
expr_stmt|;
if|if
condition|(
name|pdq
operator|->
name|pdq_command_info
operator|.
name|ci_response_producer
operator|==
name|pdq
operator|->
name|pdq_command_info
operator|.
name|ci_response_completion
condition|)
break|break;
name|PDQ_OS_USEC_DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
block|}
name|state
operator|=
name|PDQ_PSTS_ADAPTER_STATE
argument_list|(
name|PDQ_CSR_READ
argument_list|(
name|csrs
argument_list|,
name|csr_port_status
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|state
return|;
block|}
end_function

begin_escape
end_escape

begin_function
name|void
name|pdq_run
parameter_list|(
name|pdq_t
modifier|*
name|pdq
parameter_list|)
block|{
specifier|const
name|pdq_csrs_t
modifier|*
specifier|const
name|csrs
init|=
operator|&
name|pdq
operator|->
name|pdq_csrs
decl_stmt|;
name|pdq_state_t
name|state
decl_stmt|;
name|state
operator|=
name|PDQ_PSTS_ADAPTER_STATE
argument_list|(
name|PDQ_CSR_READ
argument_list|(
name|csrs
argument_list|,
name|csr_port_status
argument_list|)
argument_list|)
expr_stmt|;
name|PDQ_ASSERT
argument_list|(
name|state
operator|!=
name|PDQS_DMA_UNAVAILABLE
argument_list|)
expr_stmt|;
name|PDQ_ASSERT
argument_list|(
name|state
operator|!=
name|PDQS_RESET
argument_list|)
expr_stmt|;
name|PDQ_ASSERT
argument_list|(
name|state
operator|!=
name|PDQS_HALTED
argument_list|)
expr_stmt|;
name|PDQ_ASSERT
argument_list|(
name|state
operator|!=
name|PDQS_UPGRADE
argument_list|)
expr_stmt|;
name|PDQ_ASSERT
argument_list|(
name|state
operator|!=
name|PDQS_RING_MEMBER
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|state
condition|)
block|{
case|case
name|PDQS_DMA_AVAILABLE
case|:
block|{
comment|/* 	     * The PDQ after being reset screws up some of its state. 	     * So we need to clear all the errors/interrupts so the real 	     * ones will get through. 	     */
name|PDQ_CSR_WRITE
argument_list|(
name|csrs
argument_list|,
name|csr_host_int_type_0
argument_list|,
literal|0xFF
argument_list|)
expr_stmt|;
name|PDQ_CSR_WRITE
argument_list|(
name|csrs
argument_list|,
name|csr_host_int_enable
argument_list|,
name|PDQ_HOST_INT_STATE_CHANGE
operator||
name|PDQ_HOST_INT_XMT_DATA_FLUSH
operator||
name|PDQ_HOST_INT_FATAL_ERROR
operator||
name|PDQ_HOST_INT_CMD_RSP_ENABLE
operator||
name|PDQ_HOST_INT_UNSOL_ENABLE
operator||
name|PDQ_HOST_INT_RX_ENABLE
operator||
name|PDQ_HOST_INT_TX_ENABLE
operator||
name|PDQ_HOST_INT_HOST_SMT_ENABLE
argument_list|)
expr_stmt|;
comment|/* 	     * Set the MAC and address filters and start up the PDQ. 	     */
name|pdq_process_unsolicited_events
argument_list|(
name|pdq
argument_list|)
expr_stmt|;
name|pdq_process_received_data
argument_list|(
name|pdq
argument_list|,
operator|&
name|pdq
operator|->
name|pdq_rx_info
argument_list|,
name|pdq
operator|->
name|pdq_dbp
operator|->
name|pdqdb_receives
argument_list|,
name|pdq
operator|->
name|pdq_cbp
operator|->
name|pdqcb_receives
argument_list|,
name|PDQ_RING_MASK
argument_list|(
name|pdq
operator|->
name|pdq_dbp
operator|->
name|pdqdb_receives
argument_list|)
argument_list|)
expr_stmt|;
name|PDQ_DO_TYPE2_PRODUCER
argument_list|(
name|pdq
argument_list|)
expr_stmt|;
if|if
condition|(
name|pdq
operator|->
name|pdq_flags
operator|&
name|PDQ_PASS_SMT
condition|)
block|{
name|pdq_process_received_data
argument_list|(
name|pdq
argument_list|,
operator|&
name|pdq
operator|->
name|pdq_host_smt_info
argument_list|,
name|pdq
operator|->
name|pdq_dbp
operator|->
name|pdqdb_host_smt
argument_list|,
name|pdq
operator|->
name|pdq_cbp
operator|->
name|pdqcb_host_smt
argument_list|,
name|PDQ_RING_MASK
argument_list|(
name|pdq
operator|->
name|pdq_dbp
operator|->
name|pdqdb_host_smt
argument_list|)
argument_list|)
expr_stmt|;
name|PDQ_CSR_WRITE
argument_list|(
name|csrs
argument_list|,
name|csr_host_smt_producer
argument_list|,
name|pdq
operator|->
name|pdq_host_smt_info
operator|.
name|rx_producer
operator||
operator|(
name|pdq
operator|->
name|pdq_host_smt_info
operator|.
name|rx_completion
operator|<<
literal|8
operator|)
argument_list|)
expr_stmt|;
block|}
name|pdq
operator|->
name|pdq_command_info
operator|.
name|ci_pending_commands
operator|=
name|PDQ_BITMASK
argument_list|(
name|PDQC_FILTER_SET
argument_list|)
operator||
name|PDQ_BITMASK
argument_list|(
name|PDQC_ADDR_FILTER_SET
argument_list|)
operator||
name|PDQ_BITMASK
argument_list|(
name|PDQC_START
argument_list|)
expr_stmt|;
if|if
condition|(
name|pdq
operator|->
name|pdq_flags
operator|&
name|PDQ_PRINTCHARS
condition|)
name|pdq
operator|->
name|pdq_command_info
operator|.
name|ci_pending_commands
operator||=
name|PDQ_BITMASK
argument_list|(
name|PDQC_STATUS_CHARS_GET
argument_list|)
expr_stmt|;
name|pdq_queue_commands
argument_list|(
name|pdq
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|PDQS_LINK_UNAVAILABLE
case|:
case|case
name|PDQS_LINK_AVAILABLE
case|:
block|{
name|pdq
operator|->
name|pdq_command_info
operator|.
name|ci_pending_commands
operator|=
name|PDQ_BITMASK
argument_list|(
name|PDQC_FILTER_SET
argument_list|)
operator||
name|PDQ_BITMASK
argument_list|(
name|PDQC_ADDR_FILTER_SET
argument_list|)
expr_stmt|;
if|if
condition|(
name|pdq
operator|->
name|pdq_flags
operator|&
name|PDQ_PRINTCHARS
condition|)
name|pdq
operator|->
name|pdq_command_info
operator|.
name|ci_pending_commands
operator||=
name|PDQ_BITMASK
argument_list|(
name|PDQC_STATUS_CHARS_GET
argument_list|)
expr_stmt|;
if|if
condition|(
name|pdq
operator|->
name|pdq_flags
operator|&
name|PDQ_PASS_SMT
condition|)
block|{
name|pdq_process_received_data
argument_list|(
name|pdq
argument_list|,
operator|&
name|pdq
operator|->
name|pdq_host_smt_info
argument_list|,
name|pdq
operator|->
name|pdq_dbp
operator|->
name|pdqdb_host_smt
argument_list|,
name|pdq
operator|->
name|pdq_cbp
operator|->
name|pdqcb_host_smt
argument_list|,
name|PDQ_RING_MASK
argument_list|(
name|pdq
operator|->
name|pdq_dbp
operator|->
name|pdqdb_host_smt
argument_list|)
argument_list|)
expr_stmt|;
name|PDQ_CSR_WRITE
argument_list|(
name|csrs
argument_list|,
name|csr_host_smt_producer
argument_list|,
name|pdq
operator|->
name|pdq_host_smt_info
operator|.
name|rx_producer
operator||
operator|(
name|pdq
operator|->
name|pdq_host_smt_info
operator|.
name|rx_completion
operator|<<
literal|8
operator|)
argument_list|)
expr_stmt|;
block|}
name|pdq_process_unsolicited_events
argument_list|(
name|pdq
argument_list|)
expr_stmt|;
name|pdq_queue_commands
argument_list|(
name|pdq
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|PDQS_RING_MEMBER
case|:
block|{ 	}
default|default:
block|{
comment|/* to make gcc happy */
break|break;
block|}
block|}
block|}
end_function

begin_escape
end_escape

begin_function
name|int
name|pdq_interrupt
parameter_list|(
name|pdq_t
modifier|*
name|pdq
parameter_list|)
block|{
specifier|const
name|pdq_csrs_t
modifier|*
specifier|const
name|csrs
init|=
operator|&
name|pdq
operator|->
name|pdq_csrs
decl_stmt|;
name|pdq_uint32_t
name|data
decl_stmt|;
name|int
name|progress
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|pdq
operator|->
name|pdq_type
operator|==
name|PDQ_DEFPA
condition|)
name|PDQ_CSR_WRITE
argument_list|(
operator|&
name|pdq
operator|->
name|pdq_pci_csrs
argument_list|,
name|csr_pfi_status
argument_list|,
literal|0x18
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|data
operator|=
name|PDQ_CSR_READ
argument_list|(
name|csrs
argument_list|,
name|csr_port_status
argument_list|)
operator|)
operator|&
name|PDQ_PSTS_INTR_PENDING
condition|)
block|{
name|progress
operator|=
literal|1
expr_stmt|;
name|PDQ_PRINTF
argument_list|(
operator|(
literal|"PDQ Interrupt: Status = 0x%08x\n"
operator|,
name|data
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|&
name|PDQ_PSTS_RCV_DATA_PENDING
condition|)
block|{
name|pdq_process_received_data
argument_list|(
name|pdq
argument_list|,
operator|&
name|pdq
operator|->
name|pdq_rx_info
argument_list|,
name|pdq
operator|->
name|pdq_dbp
operator|->
name|pdqdb_receives
argument_list|,
name|pdq
operator|->
name|pdq_cbp
operator|->
name|pdqcb_receives
argument_list|,
name|PDQ_RING_MASK
argument_list|(
name|pdq
operator|->
name|pdq_dbp
operator|->
name|pdqdb_receives
argument_list|)
argument_list|)
expr_stmt|;
name|PDQ_DO_TYPE2_PRODUCER
argument_list|(
name|pdq
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|data
operator|&
name|PDQ_PSTS_HOST_SMT_PENDING
condition|)
block|{
name|pdq_process_received_data
argument_list|(
name|pdq
argument_list|,
operator|&
name|pdq
operator|->
name|pdq_host_smt_info
argument_list|,
name|pdq
operator|->
name|pdq_dbp
operator|->
name|pdqdb_host_smt
argument_list|,
name|pdq
operator|->
name|pdq_cbp
operator|->
name|pdqcb_host_smt
argument_list|,
name|PDQ_RING_MASK
argument_list|(
name|pdq
operator|->
name|pdq_dbp
operator|->
name|pdqdb_host_smt
argument_list|)
argument_list|)
expr_stmt|;
name|PDQ_DO_HOST_SMT_PRODUCER
argument_list|(
name|pdq
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|data
operator|&
name|PDQ_PSTS_XMT_DATA_PENDING
condition|)
name|pdq_process_transmitted_data
argument_list|(
name|pdq
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|&
name|PDQ_PSTS_UNSOL_PENDING
condition|)
name|pdq_process_unsolicited_events
argument_list|(
name|pdq
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|&
name|PDQ_PSTS_CMD_RSP_PENDING
condition|)
name|pdq_process_command_responses
argument_list|(
name|pdq
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|&
name|PDQ_PSTS_TYPE_0_PENDING
condition|)
block|{
name|data
operator|=
name|PDQ_CSR_READ
argument_list|(
name|csrs
argument_list|,
name|csr_host_int_type_0
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|&
name|PDQ_HOST_INT_STATE_CHANGE
condition|)
block|{
name|pdq_state_t
name|state
init|=
name|PDQ_PSTS_ADAPTER_STATE
argument_list|(
name|PDQ_CSR_READ
argument_list|(
name|csrs
argument_list|,
name|csr_port_status
argument_list|)
argument_list|)
decl_stmt|;
name|printf
argument_list|(
name|PDQ_OS_PREFIX
literal|"%s"
argument_list|,
name|PDQ_OS_PREFIX_ARGS
argument_list|,
name|pdq_adapter_states
index|[
name|state
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|state
operator|==
name|PDQS_LINK_UNAVAILABLE
condition|)
block|{
name|pdq
operator|->
name|pdq_flags
operator|&=
operator|~
name|PDQ_TXOK
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|state
operator|==
name|PDQS_LINK_AVAILABLE
condition|)
block|{
name|pdq
operator|->
name|pdq_flags
operator||=
name|PDQ_TXOK
expr_stmt|;
name|pdq_os_restart_transmitter
argument_list|(
name|pdq
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|state
operator|==
name|PDQS_HALTED
condition|)
block|{
name|pdq_response_error_log_get_t
name|log_entry
decl_stmt|;
name|pdq_halt_code_t
name|halt_code
init|=
name|PDQ_PSTS_HALT_ID
argument_list|(
name|PDQ_CSR_READ
argument_list|(
name|csrs
argument_list|,
name|csr_port_status
argument_list|)
argument_list|)
decl_stmt|;
name|printf
argument_list|(
literal|": halt code = %d (%s)\n"
argument_list|,
name|halt_code
argument_list|,
name|pdq_halt_codes
index|[
name|halt_code
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|halt_code
operator|==
name|PDQH_DMA_ERROR
operator|&&
name|pdq
operator|->
name|pdq_type
operator|==
name|PDQ_DEFPA
condition|)
block|{
name|PDQ_PRINTF
argument_list|(
operator|(
literal|"\tPFI status = 0x%x, Host 0 Fatal Interrupt = 0x%x\n"
operator|,
name|PDQ_CSR_READ
argument_list|(
operator|&
name|pdq
operator|->
name|pdq_pci_csrs
argument_list|,
name|csr_pfi_status
argument_list|)
operator|,
name|data
operator|&
name|PDQ_HOST_INT_FATAL_ERROR
operator|)
argument_list|)
expr_stmt|;
block|}
name|pdq_read_error_log
argument_list|(
name|pdq
argument_list|,
operator|&
name|log_entry
argument_list|)
expr_stmt|;
name|pdq_stop
argument_list|(
name|pdq
argument_list|)
expr_stmt|;
if|if
condition|(
name|pdq
operator|->
name|pdq_flags
operator|&
name|PDQ_RUNNING
condition|)
name|pdq_run
argument_list|(
name|pdq
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|PDQ_CSR_WRITE
argument_list|(
name|csrs
argument_list|,
name|csr_host_int_type_0
argument_list|,
name|PDQ_HOST_INT_STATE_CHANGE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|data
operator|&
name|PDQ_HOST_INT_FATAL_ERROR
condition|)
block|{
name|pdq_stop
argument_list|(
name|pdq
argument_list|)
expr_stmt|;
if|if
condition|(
name|pdq
operator|->
name|pdq_flags
operator|&
name|PDQ_RUNNING
condition|)
name|pdq_run
argument_list|(
name|pdq
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
if|if
condition|(
name|data
operator|&
name|PDQ_HOST_INT_XMT_DATA_FLUSH
condition|)
block|{
name|printf
argument_list|(
name|PDQ_OS_PREFIX
literal|"Flushing transmit queue\n"
argument_list|,
name|PDQ_OS_PREFIX_ARGS
argument_list|)
expr_stmt|;
name|pdq
operator|->
name|pdq_flags
operator|&=
operator|~
name|PDQ_TXOK
expr_stmt|;
name|pdq_flush_transmitter
argument_list|(
name|pdq
argument_list|)
expr_stmt|;
name|pdq_do_port_control
argument_list|(
name|csrs
argument_list|,
name|PDQ_PCTL_XMT_DATA_FLUSH_DONE
argument_list|)
expr_stmt|;
name|PDQ_CSR_WRITE
argument_list|(
name|csrs
argument_list|,
name|csr_host_int_type_0
argument_list|,
name|PDQ_HOST_INT_XMT_DATA_FLUSH
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|pdq
operator|->
name|pdq_type
operator|==
name|PDQ_DEFPA
condition|)
name|PDQ_CSR_WRITE
argument_list|(
operator|&
name|pdq
operator|->
name|pdq_pci_csrs
argument_list|,
name|csr_pfi_status
argument_list|,
literal|0x18
argument_list|)
expr_stmt|;
block|}
return|return
name|progress
return|;
block|}
end_function

begin_escape
end_escape

begin_function
name|pdq_t
modifier|*
name|pdq_initialize
parameter_list|(
name|pdq_bus_t
name|bus
parameter_list|,
name|pdq_bus_memaddr_t
name|csr_base
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|int
name|unit
parameter_list|,
name|void
modifier|*
name|ctx
parameter_list|,
name|pdq_type_t
name|type
parameter_list|)
block|{
name|pdq_t
modifier|*
name|pdq
decl_stmt|;
name|pdq_state_t
name|state
decl_stmt|;
specifier|const
name|pdq_uint32_t
name|contig_bytes
init|=
operator|(
sizeof|sizeof
argument_list|(
name|pdq_descriptor_block_t
argument_list|)
operator|*
literal|2
operator|)
operator|-
name|PDQ_OS_PAGESIZE
decl_stmt|;
name|pdq_uint8_t
modifier|*
name|p
decl_stmt|;
name|int
name|idx
decl_stmt|;
name|PDQ_ASSERT
argument_list|(
sizeof|sizeof
argument_list|(
name|pdq_descriptor_block_t
argument_list|)
operator|==
literal|8192
argument_list|)
expr_stmt|;
name|PDQ_ASSERT
argument_list|(
sizeof|sizeof
argument_list|(
name|pdq_consumer_block_t
argument_list|)
operator|==
literal|64
argument_list|)
expr_stmt|;
name|PDQ_ASSERT
argument_list|(
sizeof|sizeof
argument_list|(
name|pdq_response_filter_get_t
argument_list|)
operator|==
name|PDQ_SIZE_RESPONSE_FILTER_GET
argument_list|)
expr_stmt|;
name|PDQ_ASSERT
argument_list|(
sizeof|sizeof
argument_list|(
name|pdq_cmd_addr_filter_set_t
argument_list|)
operator|==
name|PDQ_SIZE_CMD_ADDR_FILTER_SET
argument_list|)
expr_stmt|;
name|PDQ_ASSERT
argument_list|(
sizeof|sizeof
argument_list|(
name|pdq_response_addr_filter_get_t
argument_list|)
operator|==
name|PDQ_SIZE_RESPONSE_ADDR_FILTER_GET
argument_list|)
expr_stmt|;
name|PDQ_ASSERT
argument_list|(
sizeof|sizeof
argument_list|(
name|pdq_response_status_chars_get_t
argument_list|)
operator|==
name|PDQ_SIZE_RESPONSE_STATUS_CHARS_GET
argument_list|)
expr_stmt|;
name|PDQ_ASSERT
argument_list|(
sizeof|sizeof
argument_list|(
name|pdq_response_fddi_mib_get_t
argument_list|)
operator|==
name|PDQ_SIZE_RESPONSE_FDDI_MIB_GET
argument_list|)
expr_stmt|;
name|PDQ_ASSERT
argument_list|(
sizeof|sizeof
argument_list|(
name|pdq_response_dec_ext_mib_get_t
argument_list|)
operator|==
name|PDQ_SIZE_RESPONSE_DEC_EXT_MIB_GET
argument_list|)
expr_stmt|;
name|PDQ_ASSERT
argument_list|(
sizeof|sizeof
argument_list|(
name|pdq_unsolicited_event_t
argument_list|)
operator|==
literal|512
argument_list|)
expr_stmt|;
name|pdq
operator|=
operator|(
name|pdq_t
operator|*
operator|)
name|PDQ_OS_MEMALLOC
argument_list|(
sizeof|sizeof
argument_list|(
name|pdq_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pdq
operator|==
name|NULL
condition|)
block|{
name|PDQ_PRINTF
argument_list|(
operator|(
literal|"malloc(%d) failed\n"
operator|,
sizeof|sizeof
argument_list|(
operator|*
name|pdq
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|PDQ_OS_MEMZERO
argument_list|(
name|pdq
argument_list|,
sizeof|sizeof
argument_list|(
name|pdq_t
argument_list|)
argument_list|)
expr_stmt|;
name|pdq
operator|->
name|pdq_type
operator|=
name|type
expr_stmt|;
name|pdq
operator|->
name|pdq_unit
operator|=
name|unit
expr_stmt|;
name|pdq
operator|->
name|pdq_os_ctx
operator|=
operator|(
name|void
operator|*
operator|)
name|ctx
expr_stmt|;
name|pdq
operator|->
name|pdq_os_name
operator|=
name|name
expr_stmt|;
name|pdq
operator|->
name|pdq_flags
operator|=
name|PDQ_PRINTCHARS
expr_stmt|;
comment|/*      * Allocate the additional data structures required by      * the PDQ driver.  Allocate a contiguous region of memory      * for the descriptor block.  We need to allocated enough      * to guarantee that we will a get 8KB block of memory aligned      * on a 8KB boundary.  This turns to require that we allocate      * (N*2 - 1 page) pages of memory.  On machine with less than      * a 8KB page size, it mean we will allocate more memory than      * we need.  The extra will be used for the unsolicited event      * buffers (though on machines with 8KB pages we will to allocate      * them separately since there will be nothing left overs.)      */
name|p
operator|=
operator|(
name|pdq_uint8_t
operator|*
operator|)
name|PDQ_OS_MEMALLOC_CONTIG
argument_list|(
name|contig_bytes
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|!=
name|NULL
condition|)
block|{
name|pdq_physaddr_t
name|physaddr
init|=
name|PDQ_OS_VA_TO_PA
argument_list|(
name|pdq
argument_list|,
name|p
argument_list|)
decl_stmt|;
comment|/* 	 * Assert that we really got contiguous memory.  This isn't really 	 * needed on systems that actually have physical contiguous allocation 	 * routines, but on those systems that don't ... 	 */
for|for
control|(
name|idx
operator|=
name|PDQ_OS_PAGESIZE
init|;
name|idx
operator|<
literal|0x2000
condition|;
name|idx
operator|+=
name|PDQ_OS_PAGESIZE
control|)
block|{
if|if
condition|(
name|PDQ_OS_VA_TO_PA
argument_list|(
name|pdq
argument_list|,
name|p
operator|+
name|idx
argument_list|)
operator|-
name|physaddr
operator|!=
name|idx
condition|)
goto|goto
name|cleanup_and_return
goto|;
block|}
name|physaddr
operator|&=
literal|0x1FFF
expr_stmt|;
if|if
condition|(
name|physaddr
condition|)
block|{
name|pdq
operator|->
name|pdq_unsolicited_info
operator|.
name|ui_events
operator|=
operator|(
name|pdq_unsolicited_event_t
operator|*
operator|)
name|p
expr_stmt|;
name|pdq
operator|->
name|pdq_dbp
operator|=
operator|(
name|pdq_descriptor_block_t
operator|*
operator|)
operator|&
name|p
index|[
literal|0x2000
operator|-
name|physaddr
index|]
expr_stmt|;
block|}
else|else
block|{
name|pdq
operator|->
name|pdq_dbp
operator|=
operator|(
name|pdq_descriptor_block_t
operator|*
operator|)
name|p
expr_stmt|;
name|pdq
operator|->
name|pdq_unsolicited_info
operator|.
name|ui_events
operator|=
operator|(
name|pdq_unsolicited_event_t
operator|*
operator|)
operator|&
name|p
index|[
literal|0x2000
index|]
expr_stmt|;
block|}
block|}
if|if
condition|(
name|contig_bytes
operator|==
sizeof|sizeof
argument_list|(
name|pdq_descriptor_block_t
argument_list|)
condition|)
block|{
name|pdq
operator|->
name|pdq_unsolicited_info
operator|.
name|ui_events
operator|=
operator|(
name|pdq_unsolicited_event_t
operator|*
operator|)
name|PDQ_OS_MEMALLOC
argument_list|(
name|PDQ_NUM_UNSOLICITED_EVENTS
operator|*
sizeof|sizeof
argument_list|(
name|pdq_unsolicited_event_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/*      * Make sure everything got allocated.  If not, free what did      * get allocated and return.      */
if|if
condition|(
name|pdq
operator|->
name|pdq_dbp
operator|==
name|NULL
operator|||
name|pdq
operator|->
name|pdq_unsolicited_info
operator|.
name|ui_events
operator|==
name|NULL
condition|)
block|{
name|cleanup_and_return
label|:
if|if
condition|(
name|p
comment|/* pdq->pdq_dbp */
operator|!=
name|NULL
condition|)
name|PDQ_OS_MEMFREE_CONTIG
argument_list|(
name|p
comment|/* pdq->pdq_dbp */
argument_list|,
name|contig_bytes
argument_list|)
expr_stmt|;
if|if
condition|(
name|contig_bytes
operator|==
sizeof|sizeof
argument_list|(
name|pdq_descriptor_block_t
argument_list|)
operator|&&
name|pdq
operator|->
name|pdq_unsolicited_info
operator|.
name|ui_events
operator|!=
name|NULL
condition|)
name|PDQ_OS_MEMFREE
argument_list|(
name|pdq
operator|->
name|pdq_unsolicited_info
operator|.
name|ui_events
argument_list|,
name|PDQ_NUM_UNSOLICITED_EVENTS
operator|*
sizeof|sizeof
argument_list|(
name|pdq_unsolicited_event_t
argument_list|)
argument_list|)
expr_stmt|;
name|PDQ_OS_MEMFREE
argument_list|(
name|pdq
argument_list|,
sizeof|sizeof
argument_list|(
name|pdq_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|pdq
operator|->
name|pdq_cbp
operator|=
operator|(
specifier|volatile
name|pdq_consumer_block_t
operator|*
operator|)
operator|&
name|pdq
operator|->
name|pdq_dbp
operator|->
name|pdqdb_consumer
expr_stmt|;
name|pdq
operator|->
name|pdq_command_info
operator|.
name|ci_bufstart
operator|=
operator|(
name|pdq_uint8_t
operator|*
operator|)
name|pdq
operator|->
name|pdq_dbp
operator|->
name|pdqdb_command_pool
expr_stmt|;
name|pdq
operator|->
name|pdq_rx_info
operator|.
name|rx_buffers
operator|=
operator|(
name|void
operator|*
operator|)
name|pdq
operator|->
name|pdq_dbp
operator|->
name|pdqdb_receive_buffers
expr_stmt|;
name|pdq
operator|->
name|pdq_host_smt_info
operator|.
name|rx_buffers
operator|=
operator|(
name|void
operator|*
operator|)
name|pdq
operator|->
name|pdq_dbp
operator|->
name|pdqdb_host_smt_buffers
expr_stmt|;
name|PDQ_PRINTF
argument_list|(
operator|(
literal|"\nPDQ Descriptor Block = "
name|PDQ_OS_PTR_FMT
literal|"\n"
operator|,
name|pdq
operator|->
name|pdq_dbp
operator|)
argument_list|)
expr_stmt|;
name|PDQ_PRINTF
argument_list|(
operator|(
literal|"    Recieve Queue          = "
name|PDQ_OS_PTR_FMT
literal|"\n"
operator|,
name|pdq
operator|->
name|pdq_dbp
operator|->
name|pdqdb_receives
operator|)
argument_list|)
expr_stmt|;
name|PDQ_PRINTF
argument_list|(
operator|(
literal|"    Transmit Queue         = "
name|PDQ_OS_PTR_FMT
literal|"\n"
operator|,
name|pdq
operator|->
name|pdq_dbp
operator|->
name|pdqdb_transmits
operator|)
argument_list|)
expr_stmt|;
name|PDQ_PRINTF
argument_list|(
operator|(
literal|"    Host SMT Queue         = "
name|PDQ_OS_PTR_FMT
literal|"\n"
operator|,
name|pdq
operator|->
name|pdq_dbp
operator|->
name|pdqdb_host_smt
operator|)
argument_list|)
expr_stmt|;
name|PDQ_PRINTF
argument_list|(
operator|(
literal|"    Command Response Queue = "
name|PDQ_OS_PTR_FMT
literal|"\n"
operator|,
name|pdq
operator|->
name|pdq_dbp
operator|->
name|pdqdb_command_responses
operator|)
argument_list|)
expr_stmt|;
name|PDQ_PRINTF
argument_list|(
operator|(
literal|"    Command Request Queue  = "
name|PDQ_OS_PTR_FMT
literal|"\n"
operator|,
name|pdq
operator|->
name|pdq_dbp
operator|->
name|pdqdb_command_requests
operator|)
argument_list|)
expr_stmt|;
name|PDQ_PRINTF
argument_list|(
operator|(
literal|"PDQ Consumer Block = "
name|PDQ_OS_PTR_FMT
literal|"\n"
operator|,
name|pdq
operator|->
name|pdq_cbp
operator|)
argument_list|)
expr_stmt|;
comment|/*      * Zero out the descriptor block.  Not really required but      * it pays to be neat.  This will also zero out the consumer      * block, command pool, and buffer pointers for the receive      * host_smt rings.      */
name|PDQ_OS_MEMZERO
argument_list|(
name|pdq
operator|->
name|pdq_dbp
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|pdq
operator|->
name|pdq_dbp
argument_list|)
argument_list|)
expr_stmt|;
comment|/*      * Initialize the CSR references.      * the DEFAA (FutureBus+) skips a longword between registers      */
name|pdq_init_csrs
argument_list|(
operator|&
name|pdq
operator|->
name|pdq_csrs
argument_list|,
name|bus
argument_list|,
name|csr_base
argument_list|,
name|pdq
operator|->
name|pdq_type
operator|==
name|PDQ_DEFAA
condition|?
literal|2
else|:
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|pdq
operator|->
name|pdq_type
operator|==
name|PDQ_DEFPA
condition|)
name|pdq_init_pci_csrs
argument_list|(
operator|&
name|pdq
operator|->
name|pdq_pci_csrs
argument_list|,
name|bus
argument_list|,
name|csr_base
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|PDQ_PRINTF
argument_list|(
operator|(
literal|"PDQ CSRs: BASE = "
name|PDQ_OS_PTR_FMT
literal|"\n"
operator|,
name|pdq
operator|->
name|pdq_csrs
operator|.
name|csr_base
operator|)
argument_list|)
expr_stmt|;
name|PDQ_PRINTF
argument_list|(
operator|(
literal|"    Port Reset                = "
name|PDQ_OS_PTR_FMT
literal|" [0x%08x]\n"
operator|,
name|pdq
operator|->
name|pdq_csrs
operator|.
name|csr_port_reset
operator|,
name|PDQ_CSR_READ
argument_list|(
operator|&
name|pdq
operator|->
name|pdq_csrs
argument_list|,
name|csr_port_reset
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|PDQ_PRINTF
argument_list|(
operator|(
literal|"    Host Data                 = "
name|PDQ_OS_PTR_FMT
literal|" [0x%08x]\n"
operator|,
name|pdq
operator|->
name|pdq_csrs
operator|.
name|csr_host_data
operator|,
name|PDQ_CSR_READ
argument_list|(
operator|&
name|pdq
operator|->
name|pdq_csrs
argument_list|,
name|csr_host_data
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|PDQ_PRINTF
argument_list|(
operator|(
literal|"    Port Control              = "
name|PDQ_OS_PTR_FMT
literal|" [0x%08x]\n"
operator|,
name|pdq
operator|->
name|pdq_csrs
operator|.
name|csr_port_control
operator|,
name|PDQ_CSR_READ
argument_list|(
operator|&
name|pdq
operator|->
name|pdq_csrs
argument_list|,
name|csr_port_control
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|PDQ_PRINTF
argument_list|(
operator|(
literal|"    Port Data A               = "
name|PDQ_OS_PTR_FMT
literal|" [0x%08x]\n"
operator|,
name|pdq
operator|->
name|pdq_csrs
operator|.
name|csr_port_data_a
operator|,
name|PDQ_CSR_READ
argument_list|(
operator|&
name|pdq
operator|->
name|pdq_csrs
argument_list|,
name|csr_port_data_a
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|PDQ_PRINTF
argument_list|(
operator|(
literal|"    Port Data B               = "
name|PDQ_OS_PTR_FMT
literal|" [0x%08x]\n"
operator|,
name|pdq
operator|->
name|pdq_csrs
operator|.
name|csr_port_data_b
operator|,
name|PDQ_CSR_READ
argument_list|(
operator|&
name|pdq
operator|->
name|pdq_csrs
argument_list|,
name|csr_port_data_b
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|PDQ_PRINTF
argument_list|(
operator|(
literal|"    Port Status               = "
name|PDQ_OS_PTR_FMT
literal|" [0x%08x]\n"
operator|,
name|pdq
operator|->
name|pdq_csrs
operator|.
name|csr_port_status
operator|,
name|PDQ_CSR_READ
argument_list|(
operator|&
name|pdq
operator|->
name|pdq_csrs
argument_list|,
name|csr_port_status
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|PDQ_PRINTF
argument_list|(
operator|(
literal|"    Host Int Type 0           = "
name|PDQ_OS_PTR_FMT
literal|" [0x%08x]\n"
operator|,
name|pdq
operator|->
name|pdq_csrs
operator|.
name|csr_host_int_type_0
operator|,
name|PDQ_CSR_READ
argument_list|(
operator|&
name|pdq
operator|->
name|pdq_csrs
argument_list|,
name|csr_host_int_type_0
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|PDQ_PRINTF
argument_list|(
operator|(
literal|"    Host Int Enable           = "
name|PDQ_OS_PTR_FMT
literal|" [0x%08x]\n"
operator|,
name|pdq
operator|->
name|pdq_csrs
operator|.
name|csr_host_int_enable
operator|,
name|PDQ_CSR_READ
argument_list|(
operator|&
name|pdq
operator|->
name|pdq_csrs
argument_list|,
name|csr_host_int_enable
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|PDQ_PRINTF
argument_list|(
operator|(
literal|"    Type 2 Producer           = "
name|PDQ_OS_PTR_FMT
literal|" [0x%08x]\n"
operator|,
name|pdq
operator|->
name|pdq_csrs
operator|.
name|csr_type_2_producer
operator|,
name|PDQ_CSR_READ
argument_list|(
operator|&
name|pdq
operator|->
name|pdq_csrs
argument_list|,
name|csr_type_2_producer
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|PDQ_PRINTF
argument_list|(
operator|(
literal|"    Command Response Producer = "
name|PDQ_OS_PTR_FMT
literal|" [0x%08x]\n"
operator|,
name|pdq
operator|->
name|pdq_csrs
operator|.
name|csr_cmd_response_producer
operator|,
name|PDQ_CSR_READ
argument_list|(
operator|&
name|pdq
operator|->
name|pdq_csrs
argument_list|,
name|csr_cmd_response_producer
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|PDQ_PRINTF
argument_list|(
operator|(
literal|"    Command Request Producer  = "
name|PDQ_OS_PTR_FMT
literal|" [0x%08x]\n"
operator|,
name|pdq
operator|->
name|pdq_csrs
operator|.
name|csr_cmd_request_producer
operator|,
name|PDQ_CSR_READ
argument_list|(
operator|&
name|pdq
operator|->
name|pdq_csrs
argument_list|,
name|csr_cmd_request_producer
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|PDQ_PRINTF
argument_list|(
operator|(
literal|"    Host SMT Producer         = "
name|PDQ_OS_PTR_FMT
literal|" [0x%08x]\n"
operator|,
name|pdq
operator|->
name|pdq_csrs
operator|.
name|csr_host_smt_producer
operator|,
name|PDQ_CSR_READ
argument_list|(
operator|&
name|pdq
operator|->
name|pdq_csrs
argument_list|,
name|csr_host_smt_producer
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|PDQ_PRINTF
argument_list|(
operator|(
literal|"    Unsolicited Producer      = "
name|PDQ_OS_PTR_FMT
literal|" [0x%08x]\n"
operator|,
name|pdq
operator|->
name|pdq_csrs
operator|.
name|csr_unsolicited_producer
operator|,
name|PDQ_CSR_READ
argument_list|(
operator|&
name|pdq
operator|->
name|pdq_csrs
argument_list|,
name|csr_unsolicited_producer
argument_list|)
operator|)
argument_list|)
expr_stmt|;
comment|/*      * Initialize the command information block      */
name|pdq
operator|->
name|pdq_command_info
operator|.
name|ci_pa_bufstart
operator|=
name|PDQ_OS_VA_TO_PA
argument_list|(
name|pdq
argument_list|,
name|pdq
operator|->
name|pdq_command_info
operator|.
name|ci_bufstart
argument_list|)
expr_stmt|;
for|for
control|(
name|idx
operator|=
literal|0
init|;
name|idx
operator|<
sizeof|sizeof
argument_list|(
name|pdq
operator|->
name|pdq_dbp
operator|->
name|pdqdb_command_requests
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|pdq
operator|->
name|pdq_dbp
operator|->
name|pdqdb_command_requests
index|[
literal|0
index|]
argument_list|)
condition|;
name|idx
operator|++
control|)
block|{
name|pdq_txdesc_t
modifier|*
name|txd
init|=
operator|&
name|pdq
operator|->
name|pdq_dbp
operator|->
name|pdqdb_command_requests
index|[
name|idx
index|]
decl_stmt|;
name|txd
operator|->
name|txd_pa_lo
operator|=
name|pdq
operator|->
name|pdq_command_info
operator|.
name|ci_pa_bufstart
expr_stmt|;
name|txd
operator|->
name|txd_eop
operator|=
name|txd
operator|->
name|txd_sop
operator|=
literal|1
expr_stmt|;
name|txd
operator|->
name|txd_pa_hi
operator|=
literal|0
expr_stmt|;
block|}
for|for
control|(
name|idx
operator|=
literal|0
init|;
name|idx
operator|<
sizeof|sizeof
argument_list|(
name|pdq
operator|->
name|pdq_dbp
operator|->
name|pdqdb_command_responses
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|pdq
operator|->
name|pdq_dbp
operator|->
name|pdqdb_command_responses
index|[
literal|0
index|]
argument_list|)
condition|;
name|idx
operator|++
control|)
block|{
name|pdq_rxdesc_t
modifier|*
name|rxd
init|=
operator|&
name|pdq
operator|->
name|pdq_dbp
operator|->
name|pdqdb_command_responses
index|[
name|idx
index|]
decl_stmt|;
name|rxd
operator|->
name|rxd_pa_lo
operator|=
name|pdq
operator|->
name|pdq_command_info
operator|.
name|ci_pa_bufstart
expr_stmt|;
name|rxd
operator|->
name|rxd_sop
operator|=
literal|1
expr_stmt|;
name|rxd
operator|->
name|rxd_seg_cnt
operator|=
literal|0
expr_stmt|;
name|rxd
operator|->
name|rxd_seg_len_lo
operator|=
literal|0
expr_stmt|;
block|}
comment|/*      * Initialize the unsolicited event information block      */
name|pdq
operator|->
name|pdq_unsolicited_info
operator|.
name|ui_free
operator|=
name|PDQ_NUM_UNSOLICITED_EVENTS
expr_stmt|;
name|pdq
operator|->
name|pdq_unsolicited_info
operator|.
name|ui_pa_bufstart
operator|=
name|PDQ_OS_VA_TO_PA
argument_list|(
name|pdq
argument_list|,
name|pdq
operator|->
name|pdq_unsolicited_info
operator|.
name|ui_events
argument_list|)
expr_stmt|;
for|for
control|(
name|idx
operator|=
literal|0
init|;
name|idx
operator|<
sizeof|sizeof
argument_list|(
name|pdq
operator|->
name|pdq_dbp
operator|->
name|pdqdb_unsolicited_events
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|pdq
operator|->
name|pdq_dbp
operator|->
name|pdqdb_unsolicited_events
index|[
literal|0
index|]
argument_list|)
condition|;
name|idx
operator|++
control|)
block|{
name|pdq_rxdesc_t
modifier|*
name|rxd
init|=
operator|&
name|pdq
operator|->
name|pdq_dbp
operator|->
name|pdqdb_unsolicited_events
index|[
name|idx
index|]
decl_stmt|;
name|pdq_unsolicited_event_t
modifier|*
name|event
init|=
operator|&
name|pdq
operator|->
name|pdq_unsolicited_info
operator|.
name|ui_events
index|[
name|idx
operator|&
operator|(
name|PDQ_NUM_UNSOLICITED_EVENTS
operator|-
literal|1
operator|)
index|]
decl_stmt|;
name|rxd
operator|->
name|rxd_sop
operator|=
literal|1
expr_stmt|;
name|rxd
operator|->
name|rxd_seg_cnt
operator|=
literal|0
expr_stmt|;
name|rxd
operator|->
name|rxd_seg_len_hi
operator|=
sizeof|sizeof
argument_list|(
name|pdq_unsolicited_event_t
argument_list|)
operator|/
literal|16
expr_stmt|;
name|rxd
operator|->
name|rxd_pa_lo
operator|=
name|pdq
operator|->
name|pdq_unsolicited_info
operator|.
name|ui_pa_bufstart
operator|+
operator|(
specifier|const
name|pdq_uint8_t
operator|*
operator|)
name|event
operator|-
operator|(
specifier|const
name|pdq_uint8_t
operator|*
operator|)
name|pdq
operator|->
name|pdq_unsolicited_info
operator|.
name|ui_events
expr_stmt|;
name|rxd
operator|->
name|rxd_pa_hi
operator|=
literal|0
expr_stmt|;
block|}
comment|/*      * Initialize the receive information blocks (normal and SMT).      */
name|pdq
operator|->
name|pdq_rx_info
operator|.
name|rx_free
operator|=
name|PDQ_RING_MASK
argument_list|(
name|pdq
operator|->
name|pdq_dbp
operator|->
name|pdqdb_receives
argument_list|)
expr_stmt|;
name|pdq
operator|->
name|pdq_rx_info
operator|.
name|rx_target
operator|=
name|pdq
operator|->
name|pdq_rx_info
operator|.
name|rx_free
operator|-
name|PDQ_RX_SEGCNT
operator|*
literal|8
expr_stmt|;
name|pdq
operator|->
name|pdq_host_smt_info
operator|.
name|rx_free
operator|=
name|PDQ_RING_MASK
argument_list|(
name|pdq
operator|->
name|pdq_dbp
operator|->
name|pdqdb_host_smt
argument_list|)
expr_stmt|;
name|pdq
operator|->
name|pdq_host_smt_info
operator|.
name|rx_target
operator|=
name|pdq
operator|->
name|pdq_host_smt_info
operator|.
name|rx_free
operator|-
name|PDQ_RX_SEGCNT
operator|*
literal|3
expr_stmt|;
comment|/*      * Initialize the transmit information block.      */
name|pdq
operator|->
name|pdq_tx_hdr
index|[
literal|0
index|]
operator|=
name|PDQ_FDDI_PH0
expr_stmt|;
name|pdq
operator|->
name|pdq_tx_hdr
index|[
literal|1
index|]
operator|=
name|PDQ_FDDI_PH1
expr_stmt|;
name|pdq
operator|->
name|pdq_tx_hdr
index|[
literal|2
index|]
operator|=
name|PDQ_FDDI_PH2
expr_stmt|;
name|pdq
operator|->
name|pdq_tx_info
operator|.
name|tx_free
operator|=
name|PDQ_RING_MASK
argument_list|(
name|pdq
operator|->
name|pdq_dbp
operator|->
name|pdqdb_transmits
argument_list|)
expr_stmt|;
name|pdq
operator|->
name|pdq_tx_info
operator|.
name|tx_hdrdesc
operator|.
name|txd_seg_len
operator|=
sizeof|sizeof
argument_list|(
name|pdq
operator|->
name|pdq_tx_hdr
argument_list|)
expr_stmt|;
name|pdq
operator|->
name|pdq_tx_info
operator|.
name|tx_hdrdesc
operator|.
name|txd_sop
operator|=
literal|1
expr_stmt|;
name|pdq
operator|->
name|pdq_tx_info
operator|.
name|tx_hdrdesc
operator|.
name|txd_pa_lo
operator|=
name|PDQ_OS_VA_TO_PA
argument_list|(
name|pdq
argument_list|,
name|pdq
operator|->
name|pdq_tx_hdr
argument_list|)
expr_stmt|;
name|state
operator|=
name|PDQ_PSTS_ADAPTER_STATE
argument_list|(
name|PDQ_CSR_READ
argument_list|(
operator|&
name|pdq
operator|->
name|pdq_csrs
argument_list|,
name|csr_port_status
argument_list|)
argument_list|)
expr_stmt|;
name|PDQ_PRINTF
argument_list|(
operator|(
literal|"PDQ Adapter State = %s\n"
operator|,
name|pdq_adapter_states
index|[
name|state
index|]
operator|)
argument_list|)
expr_stmt|;
comment|/*      * Stop the PDQ if it is running and put it into a known state.      */
name|state
operator|=
name|pdq_stop
argument_list|(
name|pdq
argument_list|)
expr_stmt|;
name|PDQ_PRINTF
argument_list|(
operator|(
literal|"PDQ Adapter State = %s\n"
operator|,
name|pdq_adapter_states
index|[
name|state
index|]
operator|)
argument_list|)
expr_stmt|;
name|PDQ_ASSERT
argument_list|(
name|state
operator|==
name|PDQS_DMA_AVAILABLE
argument_list|)
expr_stmt|;
comment|/*      * If the adapter is not the state we expect, then the initialization      * failed.  Cleanup and exit.      */
if|#
directive|if
name|defined
argument_list|(
name|PDQVERBOSE
argument_list|)
if|if
condition|(
name|state
operator|==
name|PDQS_HALTED
condition|)
block|{
name|pdq_halt_code_t
name|halt_code
init|=
name|PDQ_PSTS_HALT_ID
argument_list|(
name|PDQ_CSR_READ
argument_list|(
operator|&
name|pdq
operator|->
name|pdq_csrs
argument_list|,
name|csr_port_status
argument_list|)
argument_list|)
decl_stmt|;
name|printf
argument_list|(
literal|"Halt code = %d (%s)\n"
argument_list|,
name|halt_code
argument_list|,
name|pdq_halt_codes
index|[
name|halt_code
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|halt_code
operator|==
name|PDQH_DMA_ERROR
operator|&&
name|pdq
operator|->
name|pdq_type
operator|==
name|PDQ_DEFPA
condition|)
name|PDQ_PRINTF
argument_list|(
operator|(
literal|"PFI status = 0x%x, Host 0 Fatal Interrupt = 0x%x\n"
operator|,
name|PDQ_CSR_READ
argument_list|(
operator|&
name|pdq
operator|->
name|pdq_pci_csrs
argument_list|,
name|csr_pfi_status
argument_list|)
operator|,
name|PDQ_CSR_READ
argument_list|(
operator|&
name|pdq
operator|->
name|pdq_csrs
argument_list|,
name|csr_host_int_type_0
argument_list|)
operator|&
name|PDQ_HOST_INT_FATAL_ERROR
operator|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|state
operator|==
name|PDQS_RESET
operator|||
name|state
operator|==
name|PDQS_HALTED
operator|||
name|state
operator|==
name|PDQS_UPGRADE
condition|)
goto|goto
name|cleanup_and_return
goto|;
name|PDQ_PRINTF
argument_list|(
operator|(
literal|"PDQ Hardware Address = %02x-%02x-%02x-%02x-%02x-%02x\n"
operator|,
name|pdq
operator|->
name|pdq_hwaddr
operator|.
name|lanaddr_bytes
index|[
literal|0
index|]
operator|,
name|pdq
operator|->
name|pdq_hwaddr
operator|.
name|lanaddr_bytes
index|[
literal|1
index|]
operator|,
name|pdq
operator|->
name|pdq_hwaddr
operator|.
name|lanaddr_bytes
index|[
literal|2
index|]
operator|,
name|pdq
operator|->
name|pdq_hwaddr
operator|.
name|lanaddr_bytes
index|[
literal|3
index|]
operator|,
name|pdq
operator|->
name|pdq_hwaddr
operator|.
name|lanaddr_bytes
index|[
literal|4
index|]
operator|,
name|pdq
operator|->
name|pdq_hwaddr
operator|.
name|lanaddr_bytes
index|[
literal|5
index|]
operator|)
argument_list|)
expr_stmt|;
name|PDQ_PRINTF
argument_list|(
operator|(
literal|"PDQ Firmware Revision = %c%c%c%c\n"
operator|,
name|pdq
operator|->
name|pdq_fwrev
operator|.
name|fwrev_bytes
index|[
literal|0
index|]
operator|,
name|pdq
operator|->
name|pdq_fwrev
operator|.
name|fwrev_bytes
index|[
literal|1
index|]
operator|,
name|pdq
operator|->
name|pdq_fwrev
operator|.
name|fwrev_bytes
index|[
literal|2
index|]
operator|,
name|pdq
operator|->
name|pdq_fwrev
operator|.
name|fwrev_bytes
index|[
literal|3
index|]
operator|)
argument_list|)
expr_stmt|;
name|PDQ_PRINTF
argument_list|(
operator|(
literal|"PDQ Chip Revision = "
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|pdq
operator|->
name|pdq_chip_rev
condition|)
block|{
case|case
name|PDQ_CHIP_REV_A_B_OR_C
case|:
name|PDQ_PRINTF
argument_list|(
operator|(
literal|"Rev C or below"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|PDQ_CHIP_REV_D
case|:
name|PDQ_PRINTF
argument_list|(
operator|(
literal|"Rev D"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|PDQ_CHIP_REV_E
case|:
name|PDQ_PRINTF
argument_list|(
operator|(
literal|"Rev E"
operator|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|PDQ_PRINTF
argument_list|(
operator|(
literal|"Unknown Rev %d"
operator|,
operator|(
name|int
operator|)
name|pdq
operator|->
name|pdq_chip_rev
operator|)
argument_list|)
expr_stmt|;
block|}
name|PDQ_PRINTF
argument_list|(
operator|(
literal|"\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|pdq
return|;
block|}
end_function

end_unit


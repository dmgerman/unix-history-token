begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	$NetBSD: pdq_ifsubr.c,v 1.38 2001/12/21 23:21:47 matt Exp $	*/
end_comment

begin_comment
comment|/*-  * Copyright (c) 1995, 1996 Matt Thomas<matt@3am-software.com>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. The name of the author may not be used to endorse or promote products  *    derived from this software without specific prior written permission  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  *  * $NetBSD: pdq_ifsubr.c,v 1.12 1997/06/05 01:56:35 thomas Exp$  * $FreeBSD$  */
end_comment

begin_comment
comment|/*  * DEC PDQ FDDI Controller; code for BSD derived operating systems  *  *	This module provide bus independent BSD specific O/S functions.  *	(ie. it provides an ifnet interface to the rest of the system)  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|__NetBSD__
end_ifdef

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__KERNEL_RCSID
argument_list|(
literal|0
argument_list|,
literal|"$NetBSD: pdq_ifsubr.c,v 1.38 2001/12/21 23:21:47 matt Exp $"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|PDQ_OSSUPPORT
end_define

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus_memio.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus_pio.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_arp.h>
end_include

begin_include
include|#
directive|include
file|<net/if_dl.h>
end_include

begin_include
include|#
directive|include
file|<net/if_media.h>
end_include

begin_include
include|#
directive|include
file|<net/fddi.h>
end_include

begin_include
include|#
directive|include
file|<net/bpf.h>
end_include

begin_include
include|#
directive|include
file|<dev/pdq/pdq_freebsd.h>
end_include

begin_include
include|#
directive|include
file|<dev/pdq/pdqreg.h>
end_include

begin_decl_stmt
name|devclass_t
name|pdq_devclass
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|pdq_ifinit
parameter_list|(
name|pdq_softc_t
modifier|*
name|sc
parameter_list|)
block|{
if|if
condition|(
name|sc
operator|->
name|sc_if
operator|.
name|if_flags
operator|&
name|IFF_UP
condition|)
block|{
name|sc
operator|->
name|sc_if
operator|.
name|if_flags
operator||=
name|IFF_RUNNING
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_if
operator|.
name|if_flags
operator|&
name|IFF_PROMISC
condition|)
block|{
name|sc
operator|->
name|sc_pdq
operator|->
name|pdq_flags
operator||=
name|PDQ_PROMISC
expr_stmt|;
block|}
else|else
block|{
name|sc
operator|->
name|sc_pdq
operator|->
name|pdq_flags
operator|&=
operator|~
name|PDQ_PROMISC
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|sc_if
operator|.
name|if_flags
operator|&
name|IFF_LINK1
condition|)
block|{
name|sc
operator|->
name|sc_pdq
operator|->
name|pdq_flags
operator||=
name|PDQ_PASS_SMT
expr_stmt|;
block|}
else|else
block|{
name|sc
operator|->
name|sc_pdq
operator|->
name|pdq_flags
operator|&=
operator|~
name|PDQ_PASS_SMT
expr_stmt|;
block|}
name|sc
operator|->
name|sc_pdq
operator|->
name|pdq_flags
operator||=
name|PDQ_RUNNING
expr_stmt|;
name|pdq_run
argument_list|(
name|sc
operator|->
name|sc_pdq
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|sc
operator|->
name|sc_if
operator|.
name|if_flags
operator|&=
operator|~
name|IFF_RUNNING
expr_stmt|;
name|sc
operator|->
name|sc_pdq
operator|->
name|pdq_flags
operator|&=
operator|~
name|PDQ_RUNNING
expr_stmt|;
name|pdq_stop
argument_list|(
name|sc
operator|->
name|sc_pdq
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_escape
end_escape

begin_function
specifier|static
name|void
name|pdq_ifwatchdog
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
comment|/*      * No progress was made on the transmit queue for PDQ_OS_TX_TRANSMIT      * seconds.  Remove all queued packets.      */
name|ifp
operator|->
name|if_flags
operator|&=
operator|~
name|IFF_OACTIVE
expr_stmt|;
name|ifp
operator|->
name|if_timer
operator|=
literal|0
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|IFQ_DEQUEUE
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
return|return;
name|PDQ_OS_DATABUF_FREE
argument_list|(
name|PDQ_OS_IFP_TO_SOFTC
argument_list|(
name|ifp
argument_list|)
operator|->
name|sc_pdq
argument_list|,
name|m
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|pdq_ifstart
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|pdq_softc_t
modifier|*
specifier|const
name|sc
init|=
name|PDQ_OS_IFP_TO_SOFTC
argument_list|(
name|ifp
argument_list|)
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|int
name|tx
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_RUNNING
operator|)
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
name|sc
operator|->
name|sc_if
operator|.
name|if_timer
operator|==
literal|0
condition|)
name|sc
operator|->
name|sc_if
operator|.
name|if_timer
operator|=
name|PDQ_OS_TX_TIMEOUT
expr_stmt|;
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_pdq
operator|->
name|pdq_flags
operator|&
name|PDQ_TXOK
operator|)
operator|==
literal|0
condition|)
block|{
name|sc
operator|->
name|sc_if
operator|.
name|if_flags
operator||=
name|IFF_OACTIVE
expr_stmt|;
return|return;
block|}
name|sc
operator|->
name|sc_flags
operator||=
name|PDQIF_DOWNCALL
expr_stmt|;
for|for
control|(
init|;
condition|;
name|tx
operator|=
literal|1
control|)
block|{
name|IF_DEQUEUE
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
break|break;
if|#
directive|if
name|defined
argument_list|(
name|PDQ_BUS_DMA
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|PDQ_BUS_DMA_NOTX
argument_list|)
if|if
condition|(
operator|(
name|m
operator|->
name|m_flags
operator|&
name|M_HASTXDMAMAP
operator|)
operator|==
literal|0
condition|)
block|{
name|bus_dmamap_t
name|map
decl_stmt|;
if|if
condition|(
name|PDQ_OS_HDR_OFFSET
operator|!=
name|PDQ_RX_FC_OFFSET
condition|)
block|{
name|m
operator|->
name|m_data
index|[
literal|0
index|]
operator|=
name|PDQ_FDDI_PH0
expr_stmt|;
name|m
operator|->
name|m_data
index|[
literal|1
index|]
operator|=
name|PDQ_FDDI_PH1
expr_stmt|;
name|m
operator|->
name|m_data
index|[
literal|2
index|]
operator|=
name|PDQ_FDDI_PH2
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|bus_dmamap_create
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|,
literal|255
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|,
literal|0
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|,
operator|&
name|map
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|bus_dmamap_load_mbuf
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
name|map
argument_list|,
name|m
argument_list|,
name|BUS_DMA_WRITE
operator||
name|BUS_DMA_NOWAIT
argument_list|)
condition|)
block|{
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
name|map
argument_list|,
literal|0
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
name|M_SETCTX
argument_list|(
name|m
argument_list|,
name|map
argument_list|)
expr_stmt|;
name|m
operator|->
name|m_flags
operator||=
name|M_HASTXDMAMAP
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|m
operator|->
name|m_flags
operator|&
name|M_HASTXDMAMAP
operator|)
operator|==
literal|0
condition|)
break|break;
block|}
else|#
directive|else
if|if
condition|(
name|PDQ_OS_HDR_OFFSET
operator|!=
name|PDQ_RX_FC_OFFSET
condition|)
block|{
name|m
operator|->
name|m_data
index|[
literal|0
index|]
operator|=
name|PDQ_FDDI_PH0
expr_stmt|;
name|m
operator|->
name|m_data
index|[
literal|1
index|]
operator|=
name|PDQ_FDDI_PH1
expr_stmt|;
name|m
operator|->
name|m_data
index|[
literal|2
index|]
operator|=
name|PDQ_FDDI_PH2
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|pdq_queue_transmit_data
argument_list|(
name|sc
operator|->
name|sc_pdq
argument_list|,
name|m
argument_list|)
operator|==
name|PDQ_FALSE
condition|)
break|break;
block|}
if|if
condition|(
name|m
operator|!=
name|NULL
condition|)
block|{
name|ifp
operator|->
name|if_flags
operator||=
name|IFF_OACTIVE
expr_stmt|;
name|IF_PREPEND
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|,
name|m
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|tx
condition|)
name|PDQ_DO_TYPE2_PRODUCER
argument_list|(
name|sc
operator|->
name|sc_pdq
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_flags
operator|&=
operator|~
name|PDQIF_DOWNCALL
expr_stmt|;
block|}
end_function

begin_escape
end_escape

begin_function
name|void
name|pdq_os_receive_pdu
parameter_list|(
name|pdq_t
modifier|*
name|pdq
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|size_t
name|pktlen
parameter_list|,
name|int
name|drop
parameter_list|)
block|{
name|pdq_softc_t
modifier|*
name|sc
init|=
name|pdq
operator|->
name|pdq_os_ctx
decl_stmt|;
name|struct
name|fddi_header
modifier|*
name|fh
decl_stmt|;
name|sc
operator|->
name|sc_if
operator|.
name|if_ipackets
operator|++
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|PDQ_BUS_DMA
argument_list|)
block|{
comment|/* 	 * Even though the first mbuf start at the first fddi header octet, 	 * the dmamap starts PDQ_OS_HDR_OFFSET octets earlier.  Any additional 	 * mbufs will start normally. 	 */
name|int
name|offset
init|=
name|PDQ_OS_HDR_OFFSET
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m0
decl_stmt|;
for|for
control|(
name|m0
operator|=
name|m
init|;
name|m0
operator|!=
name|NULL
condition|;
name|m0
operator|=
name|m0
operator|->
name|m_next
operator|,
name|offset
operator|=
literal|0
control|)
block|{
name|pdq_os_databuf_sync
argument_list|(
name|sc
argument_list|,
name|m0
argument_list|,
name|offset
argument_list|,
name|m0
operator|->
name|m_len
argument_list|,
name|BUS_DMASYNC_POSTREAD
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
name|M_GETCTX
argument_list|(
name|m0
argument_list|,
name|bus_dmamap_t
argument_list|)
argument_list|)
expr_stmt|;
name|bus_dmamap_destroy
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
name|M_GETCTX
argument_list|(
name|m0
argument_list|,
name|bus_dmamap_t
argument_list|)
argument_list|)
expr_stmt|;
name|m0
operator|->
name|m_flags
operator|&=
operator|~
name|M_HASRXDMAMAP
expr_stmt|;
name|M_SETCTX
argument_list|(
name|m0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|pktlen
expr_stmt|;
if|#
directive|if
name|NBPFILTER
operator|>
literal|0
if|if
condition|(
name|sc
operator|->
name|sc_bpf
operator|!=
name|NULL
condition|)
name|PDQ_BPF_MTAP
argument_list|(
name|sc
argument_list|,
name|m
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|fh
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|fddi_header
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
name|drop
operator|||
operator|(
name|fh
operator|->
name|fddi_fc
operator|&
operator|(
name|FDDIFC_L
operator||
name|FDDIFC_F
operator|)
operator|)
operator|!=
name|FDDIFC_LLC_ASYNC
condition|)
block|{
name|sc
operator|->
name|sc_if
operator|.
name|if_iqdrops
operator|++
expr_stmt|;
name|sc
operator|->
name|sc_if
operator|.
name|if_ierrors
operator|++
expr_stmt|;
name|PDQ_OS_DATABUF_FREE
argument_list|(
name|pdq
argument_list|,
name|m
argument_list|)
expr_stmt|;
return|return;
block|}
name|m_adj
argument_list|(
name|m
argument_list|,
name|FDDI_HDR_LEN
argument_list|)
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|rcvif
operator|=
operator|&
name|sc
operator|->
name|sc_if
expr_stmt|;
name|fddi_input
argument_list|(
operator|&
name|sc
operator|->
name|sc_if
argument_list|,
name|fh
argument_list|,
name|m
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|pdq_os_restart_transmitter
parameter_list|(
name|pdq_t
modifier|*
name|pdq
parameter_list|)
block|{
name|pdq_softc_t
modifier|*
name|sc
init|=
name|pdq
operator|->
name|pdq_os_ctx
decl_stmt|;
name|sc
operator|->
name|sc_if
operator|.
name|if_flags
operator|&=
operator|~
name|IFF_OACTIVE
expr_stmt|;
if|if
condition|(
name|IFQ_IS_EMPTY
argument_list|(
operator|&
name|sc
operator|->
name|sc_if
operator|.
name|if_snd
argument_list|)
operator|==
literal|0
condition|)
block|{
name|sc
operator|->
name|sc_if
operator|.
name|if_timer
operator|=
name|PDQ_OS_TX_TIMEOUT
expr_stmt|;
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|PDQIF_DOWNCALL
operator|)
operator|==
literal|0
condition|)
name|pdq_ifstart
argument_list|(
operator|&
name|sc
operator|->
name|sc_if
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|sc
operator|->
name|sc_if
operator|.
name|if_timer
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|pdq_os_transmit_done
parameter_list|(
name|pdq_t
modifier|*
name|pdq
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|)
block|{
name|pdq_softc_t
modifier|*
name|sc
init|=
name|pdq
operator|->
name|pdq_os_ctx
decl_stmt|;
if|#
directive|if
name|NBPFILTER
operator|>
literal|0
if|if
condition|(
name|sc
operator|->
name|sc_bpf
operator|!=
name|NULL
condition|)
name|PDQ_BPF_MTAP
argument_list|(
name|sc
argument_list|,
name|m
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|PDQ_OS_DATABUF_FREE
argument_list|(
name|pdq
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_if
operator|.
name|if_opackets
operator|++
expr_stmt|;
block|}
end_function

begin_escape
end_escape

begin_function
name|void
name|pdq_os_addr_fill
parameter_list|(
name|pdq_t
modifier|*
name|pdq
parameter_list|,
name|pdq_lanaddr_t
modifier|*
name|addr
parameter_list|,
name|size_t
name|num_addrs
parameter_list|)
block|{
name|pdq_softc_t
modifier|*
name|sc
init|=
name|pdq
operator|->
name|pdq_os_ctx
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|struct
name|ifmultiaddr
modifier|*
name|ifma
decl_stmt|;
name|ifp
operator|=
operator|&
name|sc
operator|->
name|arpcom
operator|.
name|ac_if
expr_stmt|;
comment|/*      * ADDR_FILTER_SET is always issued before FILTER_SET so      * we can play with PDQ_ALLMULTI and not worry about       * queueing a FILTER_SET ourselves.      */
name|pdq
operator|->
name|pdq_flags
operator|&=
operator|~
name|PDQ_ALLMULTI
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|IFF_ALLMULTI
argument_list|)
name|sc
operator|->
name|sc_if
operator|.
name|if_flags
operator|&=
operator|~
name|IFF_ALLMULTI
expr_stmt|;
endif|#
directive|endif
for|for
control|(
name|ifma
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|sc
operator|->
name|sc_if
operator|.
name|if_multiaddrs
argument_list|)
init|;
name|ifma
operator|&&
name|num_addrs
operator|>
literal|0
condition|;
name|ifma
operator|=
name|TAILQ_NEXT
argument_list|(
name|ifma
argument_list|,
name|ifma_link
argument_list|)
control|)
block|{
name|char
modifier|*
name|mcaddr
decl_stmt|;
if|if
condition|(
name|ifma
operator|->
name|ifma_addr
operator|->
name|sa_family
operator|!=
name|AF_LINK
condition|)
continue|continue;
name|mcaddr
operator|=
name|LLADDR
argument_list|(
operator|(
expr|struct
name|sockaddr_dl
operator|*
operator|)
name|ifma
operator|->
name|ifma_addr
argument_list|)
expr_stmt|;
operator|(
operator|(
name|u_short
operator|*
operator|)
name|addr
operator|->
name|lanaddr_bytes
operator|)
index|[
literal|0
index|]
operator|=
operator|(
operator|(
name|u_short
operator|*
operator|)
name|mcaddr
operator|)
index|[
literal|0
index|]
expr_stmt|;
operator|(
operator|(
name|u_short
operator|*
operator|)
name|addr
operator|->
name|lanaddr_bytes
operator|)
index|[
literal|1
index|]
operator|=
operator|(
operator|(
name|u_short
operator|*
operator|)
name|mcaddr
operator|)
index|[
literal|1
index|]
expr_stmt|;
operator|(
operator|(
name|u_short
operator|*
operator|)
name|addr
operator|->
name|lanaddr_bytes
operator|)
index|[
literal|2
index|]
operator|=
operator|(
operator|(
name|u_short
operator|*
operator|)
name|mcaddr
operator|)
index|[
literal|2
index|]
expr_stmt|;
name|addr
operator|++
expr_stmt|;
name|num_addrs
operator|--
expr_stmt|;
block|}
comment|/*      * If not all the address fit into the CAM, turn on all-multicast mode.      */
if|if
condition|(
name|ifma
operator|!=
name|NULL
condition|)
block|{
name|pdq
operator|->
name|pdq_flags
operator||=
name|PDQ_ALLMULTI
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|IFF_ALLMULTI
argument_list|)
name|sc
operator|->
name|sc_if
operator|.
name|if_flags
operator||=
name|IFF_ALLMULTI
expr_stmt|;
endif|#
directive|endif
block|}
block|}
end_function

begin_escape
end_escape

begin_if
if|#
directive|if
name|defined
argument_list|(
name|IFM_FDDI
argument_list|)
end_if

begin_function
specifier|static
name|int
name|pdq_ifmedia_change
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|pdq_softc_t
modifier|*
specifier|const
name|sc
init|=
name|PDQ_OS_IFP_TO_SOFTC
argument_list|(
name|ifp
argument_list|)
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_ifmedia
operator|.
name|ifm_media
operator|&
name|IFM_FDX
condition|)
block|{
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_pdq
operator|->
name|pdq_flags
operator|&
name|PDQ_WANT_FDX
operator|)
operator|==
literal|0
condition|)
block|{
name|sc
operator|->
name|sc_pdq
operator|->
name|pdq_flags
operator||=
name|PDQ_WANT_FDX
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_pdq
operator|->
name|pdq_flags
operator|&
name|PDQ_RUNNING
condition|)
name|pdq_run
argument_list|(
name|sc
operator|->
name|sc_pdq
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|sc
operator|->
name|sc_pdq
operator|->
name|pdq_flags
operator|&
name|PDQ_WANT_FDX
condition|)
block|{
name|sc
operator|->
name|sc_pdq
operator|->
name|pdq_flags
operator|&=
operator|~
name|PDQ_WANT_FDX
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_pdq
operator|->
name|pdq_flags
operator|&
name|PDQ_RUNNING
condition|)
name|pdq_run
argument_list|(
name|sc
operator|->
name|sc_pdq
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|pdq_ifmedia_status
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|ifmediareq
modifier|*
name|ifmr
parameter_list|)
block|{
name|pdq_softc_t
modifier|*
specifier|const
name|sc
init|=
name|PDQ_OS_IFP_TO_SOFTC
argument_list|(
name|ifp
argument_list|)
decl_stmt|;
name|ifmr
operator|->
name|ifm_status
operator|=
name|IFM_AVALID
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_pdq
operator|->
name|pdq_flags
operator|&
name|PDQ_IS_ONRING
condition|)
name|ifmr
operator|->
name|ifm_status
operator||=
name|IFM_ACTIVE
expr_stmt|;
name|ifmr
operator|->
name|ifm_active
operator|=
operator|(
name|ifmr
operator|->
name|ifm_current
operator|&
operator|~
name|IFM_FDX
operator|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_pdq
operator|->
name|pdq_flags
operator|&
name|PDQ_IS_FDX
condition|)
name|ifmr
operator|->
name|ifm_active
operator||=
name|IFM_FDX
expr_stmt|;
block|}
end_function

begin_function
name|void
name|pdq_os_update_status
parameter_list|(
name|pdq_t
modifier|*
name|pdq
parameter_list|,
specifier|const
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|pdq_softc_t
modifier|*
specifier|const
name|sc
init|=
name|pdq
operator|->
name|pdq_os_ctx
decl_stmt|;
specifier|const
name|pdq_response_status_chars_get_t
modifier|*
name|rsp
init|=
name|arg
decl_stmt|;
name|int
name|media
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|rsp
operator|->
name|status_chars_get
operator|.
name|pmd_type
index|[
literal|0
index|]
condition|)
block|{
case|case
name|PDQ_PMD_TYPE_ANSI_MUTLI_MODE
case|:
name|media
operator|=
name|IFM_FDDI_MMF
expr_stmt|;
break|break;
case|case
name|PDQ_PMD_TYPE_ANSI_SINGLE_MODE_TYPE_1
case|:
name|media
operator|=
name|IFM_FDDI_SMF
expr_stmt|;
break|break;
case|case
name|PDQ_PMD_TYPE_ANSI_SIGNLE_MODE_TYPE_2
case|:
name|media
operator|=
name|IFM_FDDI_SMF
expr_stmt|;
break|break;
case|case
name|PDQ_PMD_TYPE_UNSHIELDED_TWISTED_PAIR
case|:
name|media
operator|=
name|IFM_FDDI_UTP
expr_stmt|;
break|break;
default|default:
name|media
operator||=
name|IFM_MANUAL
expr_stmt|;
block|}
if|if
condition|(
name|rsp
operator|->
name|status_chars_get
operator|.
name|station_type
operator|==
name|PDQ_STATION_TYPE_DAS
condition|)
name|media
operator||=
name|IFM_FDDI_DA
expr_stmt|;
name|sc
operator|->
name|sc_ifmedia
operator|.
name|ifm_media
operator|=
name|media
operator||
name|IFM_FDDI
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* defined(IFM_FDDI) */
end_comment

begin_escape
end_escape

begin_function
specifier|static
name|int
name|pdq_ifioctl
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|u_long
name|cmd
parameter_list|,
name|caddr_t
name|data
parameter_list|)
block|{
name|pdq_softc_t
modifier|*
name|sc
init|=
name|PDQ_OS_IFP_TO_SOFTC
argument_list|(
name|ifp
argument_list|)
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|PDQ_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|SIOCSIFMTU
case|:
case|case
name|SIOCGIFADDR
case|:
case|case
name|SIOCSIFADDR
case|:
block|{
name|error
operator|=
name|fddi_ioctl
argument_list|(
name|ifp
argument_list|,
name|cmd
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|SIOCSIFFLAGS
case|:
block|{
name|pdq_ifinit
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|SIOCADDMULTI
case|:
case|case
name|SIOCDELMULTI
case|:
block|{
if|if
condition|(
name|sc
operator|->
name|sc_if
operator|.
name|if_flags
operator|&
name|IFF_RUNNING
condition|)
block|{
name|pdq_run
argument_list|(
name|sc
operator|->
name|sc_pdq
argument_list|)
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
block|}
break|break;
block|}
if|#
directive|if
name|defined
argument_list|(
name|IFM_FDDI
argument_list|)
operator|&&
name|defined
argument_list|(
name|SIOCSIFMEDIA
argument_list|)
case|case
name|SIOCSIFMEDIA
case|:
case|case
name|SIOCGIFMEDIA
case|:
block|{
name|struct
name|ifreq
modifier|*
name|ifr
init|=
operator|(
expr|struct
name|ifreq
operator|*
operator|)
name|data
decl_stmt|;
name|error
operator|=
name|ifmedia_ioctl
argument_list|(
name|ifp
argument_list|,
name|ifr
argument_list|,
operator|&
name|sc
operator|->
name|sc_ifmedia
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
default|default:
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
block|}
name|PDQ_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_escape
end_escape

begin_ifndef
ifndef|#
directive|ifndef
name|IFF_NOTRAILERS
end_ifndef

begin_define
define|#
directive|define
name|IFF_NOTRAILERS
value|0
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|void
name|pdq_ifattach
parameter_list|(
name|pdq_softc_t
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
operator|&
name|sc
operator|->
name|sc_if
decl_stmt|;
name|mtx_init
argument_list|(
operator|&
name|sc
operator|->
name|mtx
argument_list|,
name|device_get_nameunit
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
argument_list|,
name|MTX_DEF
operator||
name|MTX_RECURSE
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_softc
operator|=
name|sc
expr_stmt|;
name|ifp
operator|->
name|if_init
operator|=
operator|(
name|if_init_f_t
operator|*
operator|)
name|pdq_ifinit
expr_stmt|;
name|ifp
operator|->
name|if_snd
operator|.
name|ifq_maxlen
operator|=
name|IFQ_MAXLEN
expr_stmt|;
name|ifp
operator|->
name|if_flags
operator|=
name|IFF_BROADCAST
operator||
name|IFF_SIMPLEX
operator||
name|IFF_NOTRAILERS
operator||
name|IFF_MULTICAST
expr_stmt|;
if|#
directive|if
operator|(
name|defined
argument_list|(
name|__FreeBSD__
argument_list|)
operator|&&
name|BSD
operator|>=
literal|199506
operator|)
operator|||
name|defined
argument_list|(
name|__NetBSD__
argument_list|)
name|ifp
operator|->
name|if_watchdog
operator|=
name|pdq_ifwatchdog
expr_stmt|;
else|#
directive|else
name|ifp
operator|->
name|if_watchdog
operator|=
name|ifwatchdog
expr_stmt|;
endif|#
directive|endif
name|ifp
operator|->
name|if_ioctl
operator|=
name|pdq_ifioctl
expr_stmt|;
if|#
directive|if
operator|!
name|defined
argument_list|(
name|__NetBSD__
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|__FreeBSD__
argument_list|)
name|ifp
operator|->
name|if_output
operator|=
name|fddi_output
expr_stmt|;
endif|#
directive|endif
name|ifp
operator|->
name|if_start
operator|=
name|pdq_ifstart
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|IFM_FDDI
argument_list|)
block|{
specifier|const
name|int
name|media
init|=
name|sc
operator|->
name|sc_ifmedia
operator|.
name|ifm_media
decl_stmt|;
name|ifmedia_init
argument_list|(
operator|&
name|sc
operator|->
name|sc_ifmedia
argument_list|,
name|IFM_FDX
argument_list|,
name|pdq_ifmedia_change
argument_list|,
name|pdq_ifmedia_status
argument_list|)
expr_stmt|;
name|ifmedia_add
argument_list|(
operator|&
name|sc
operator|->
name|sc_ifmedia
argument_list|,
name|media
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ifmedia_set
argument_list|(
operator|&
name|sc
operator|->
name|sc_ifmedia
argument_list|,
name|media
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|if_attach
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|__NetBSD__
argument_list|)
name|fddi_ifattach
argument_list|(
name|ifp
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|sc
operator|->
name|sc_pdq
operator|->
name|pdq_hwaddr
argument_list|)
expr_stmt|;
else|#
directive|else
name|fddi_ifattach
argument_list|(
name|ifp
argument_list|,
name|FDDI_BPF_SUPPORTED
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_function
name|void
name|pdq_ifdetach
parameter_list|(
name|pdq_softc_t
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|ifp
operator|=
operator|&
name|sc
operator|->
name|arpcom
operator|.
name|ac_if
expr_stmt|;
name|fddi_ifdetach
argument_list|(
name|ifp
argument_list|,
name|FDDI_BPF_SUPPORTED
argument_list|)
expr_stmt|;
name|pdq_stop
argument_list|(
name|sc
operator|->
name|sc_pdq
argument_list|)
expr_stmt|;
name|pdq_free
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|void
name|pdq_free
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|pdq_softc_t
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|io
condition|)
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|io_type
argument_list|,
name|sc
operator|->
name|io_rid
argument_list|,
name|sc
operator|->
name|io
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|mem
condition|)
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|mem_type
argument_list|,
name|sc
operator|->
name|mem_rid
argument_list|,
name|sc
operator|->
name|mem
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|irq_ih
condition|)
name|bus_teardown_intr
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|irq
argument_list|,
name|sc
operator|->
name|irq_ih
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|irq
condition|)
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
name|sc
operator|->
name|irq_rid
argument_list|,
name|sc
operator|->
name|irq
argument_list|)
expr_stmt|;
comment|/* 	 * Destroy the mutex. 	 */
if|if
condition|(
name|mtx_initialized
argument_list|(
operator|&
name|sc
operator|->
name|mtx
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|mtx_destroy
argument_list|(
operator|&
name|sc
operator|->
name|mtx
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_if
if|#
directive|if
name|defined
argument_list|(
name|PDQ_BUS_DMA
argument_list|)
end_if

begin_function
name|int
name|pdq_os_memalloc_contig
parameter_list|(
name|pdq_t
modifier|*
name|pdq
parameter_list|)
block|{
name|pdq_softc_t
modifier|*
specifier|const
name|sc
init|=
name|pdq
operator|->
name|pdq_os_ctx
decl_stmt|;
name|bus_dma_segment_t
name|db_segs
index|[
literal|1
index|]
decl_stmt|,
name|ui_segs
index|[
literal|1
index|]
decl_stmt|,
name|cb_segs
index|[
literal|1
index|]
decl_stmt|;
name|int
name|db_nsegs
init|=
literal|0
decl_stmt|,
name|ui_nsegs
init|=
literal|0
decl_stmt|;
name|int
name|steps
init|=
literal|0
decl_stmt|;
name|int
name|not_ok
decl_stmt|;
name|not_ok
operator|=
name|bus_dmamem_alloc
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|pdq
operator|->
name|pdq_dbp
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|pdq
operator|->
name|pdq_dbp
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|pdq
operator|->
name|pdq_dbp
argument_list|)
argument_list|,
name|db_segs
argument_list|,
literal|1
argument_list|,
operator|&
name|db_nsegs
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|not_ok
condition|)
block|{
name|steps
operator|=
literal|1
expr_stmt|;
name|not_ok
operator|=
name|bus_dmamem_map
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
name|db_segs
argument_list|,
name|db_nsegs
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|pdq
operator|->
name|pdq_dbp
argument_list|)
argument_list|,
operator|(
name|caddr_t
operator|*
operator|)
operator|&
name|pdq
operator|->
name|pdq_dbp
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|not_ok
condition|)
block|{
name|steps
operator|=
literal|2
expr_stmt|;
name|not_ok
operator|=
name|bus_dmamap_create
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
name|db_segs
index|[
literal|0
index|]
operator|.
name|ds_len
argument_list|,
literal|1
argument_list|,
literal|0x2000
argument_list|,
literal|0
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|,
operator|&
name|sc
operator|->
name|sc_dbmap
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|not_ok
condition|)
block|{
name|steps
operator|=
literal|3
expr_stmt|;
name|not_ok
operator|=
name|bus_dmamap_load
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
name|sc
operator|->
name|sc_dbmap
argument_list|,
name|pdq
operator|->
name|pdq_dbp
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|pdq
operator|->
name|pdq_dbp
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|not_ok
condition|)
block|{
name|steps
operator|=
literal|4
expr_stmt|;
name|pdq
operator|->
name|pdq_pa_descriptor_block
operator|=
name|sc
operator|->
name|sc_dbmap
operator|->
name|dm_segs
index|[
literal|0
index|]
operator|.
name|ds_addr
expr_stmt|;
name|not_ok
operator|=
name|bus_dmamem_alloc
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
name|PDQ_OS_PAGESIZE
argument_list|,
name|PDQ_OS_PAGESIZE
argument_list|,
name|PDQ_OS_PAGESIZE
argument_list|,
name|ui_segs
argument_list|,
literal|1
argument_list|,
operator|&
name|ui_nsegs
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|not_ok
condition|)
block|{
name|steps
operator|=
literal|5
expr_stmt|;
name|not_ok
operator|=
name|bus_dmamem_map
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
name|ui_segs
argument_list|,
name|ui_nsegs
argument_list|,
name|PDQ_OS_PAGESIZE
argument_list|,
operator|(
name|caddr_t
operator|*
operator|)
operator|&
name|pdq
operator|->
name|pdq_unsolicited_info
operator|.
name|ui_events
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|not_ok
condition|)
block|{
name|steps
operator|=
literal|6
expr_stmt|;
name|not_ok
operator|=
name|bus_dmamap_create
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
name|ui_segs
index|[
literal|0
index|]
operator|.
name|ds_len
argument_list|,
literal|1
argument_list|,
name|PDQ_OS_PAGESIZE
argument_list|,
literal|0
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|,
operator|&
name|sc
operator|->
name|sc_uimap
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|not_ok
condition|)
block|{
name|steps
operator|=
literal|7
expr_stmt|;
name|not_ok
operator|=
name|bus_dmamap_load
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
name|sc
operator|->
name|sc_uimap
argument_list|,
name|pdq
operator|->
name|pdq_unsolicited_info
operator|.
name|ui_events
argument_list|,
name|PDQ_OS_PAGESIZE
argument_list|,
name|NULL
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|not_ok
condition|)
block|{
name|steps
operator|=
literal|8
expr_stmt|;
name|pdq
operator|->
name|pdq_unsolicited_info
operator|.
name|ui_pa_bufstart
operator|=
name|sc
operator|->
name|sc_uimap
operator|->
name|dm_segs
index|[
literal|0
index|]
operator|.
name|ds_addr
expr_stmt|;
name|cb_segs
index|[
literal|0
index|]
operator|=
name|db_segs
index|[
literal|0
index|]
expr_stmt|;
name|cb_segs
index|[
literal|0
index|]
operator|.
name|ds_addr
operator|+=
name|offsetof
argument_list|(
name|pdq_descriptor_block_t
argument_list|,
name|pdqdb_consumer
argument_list|)
expr_stmt|;
name|cb_segs
index|[
literal|0
index|]
operator|.
name|ds_len
operator|=
sizeof|sizeof
argument_list|(
name|pdq_consumer_block_t
argument_list|)
expr_stmt|;
name|not_ok
operator|=
name|bus_dmamem_map
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
name|cb_segs
argument_list|,
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|pdq
operator|->
name|pdq_cbp
argument_list|)
argument_list|,
operator|(
name|caddr_t
operator|*
operator|)
operator|&
name|pdq
operator|->
name|pdq_cbp
argument_list|,
name|BUS_DMA_NOWAIT
operator||
name|BUS_DMA_COHERENT
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|not_ok
condition|)
block|{
name|steps
operator|=
literal|9
expr_stmt|;
name|not_ok
operator|=
name|bus_dmamap_create
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
name|cb_segs
index|[
literal|0
index|]
operator|.
name|ds_len
argument_list|,
literal|1
argument_list|,
literal|0x2000
argument_list|,
literal|0
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|,
operator|&
name|sc
operator|->
name|sc_cbmap
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|not_ok
condition|)
block|{
name|steps
operator|=
literal|10
expr_stmt|;
name|not_ok
operator|=
name|bus_dmamap_load
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
name|sc
operator|->
name|sc_cbmap
argument_list|,
operator|(
name|caddr_t
operator|)
name|pdq
operator|->
name|pdq_cbp
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|pdq
operator|->
name|pdq_cbp
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|not_ok
condition|)
block|{
name|pdq
operator|->
name|pdq_pa_consumer_block
operator|=
name|sc
operator|->
name|sc_cbmap
operator|->
name|dm_segs
index|[
literal|0
index|]
operator|.
name|ds_addr
expr_stmt|;
return|return
name|not_ok
return|;
block|}
switch|switch
condition|(
name|steps
condition|)
block|{
case|case
literal|11
case|:
block|{
name|bus_dmamap_unload
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
name|sc
operator|->
name|sc_cbmap
argument_list|)
expr_stmt|;
comment|/* FALL THROUGH */
block|}
case|case
literal|10
case|:
block|{
name|bus_dmamap_destroy
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
name|sc
operator|->
name|sc_cbmap
argument_list|)
expr_stmt|;
comment|/* FALL THROUGH */
block|}
case|case
literal|9
case|:
block|{
name|bus_dmamem_unmap
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
operator|(
name|caddr_t
operator|)
name|pdq
operator|->
name|pdq_cbp
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|pdq
operator|->
name|pdq_cbp
argument_list|)
argument_list|)
expr_stmt|;
comment|/* FALL THROUGH */
block|}
case|case
literal|8
case|:
block|{
name|bus_dmamap_unload
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
name|sc
operator|->
name|sc_uimap
argument_list|)
expr_stmt|;
comment|/* FALL THROUGH */
block|}
case|case
literal|7
case|:
block|{
name|bus_dmamap_destroy
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
name|sc
operator|->
name|sc_uimap
argument_list|)
expr_stmt|;
comment|/* FALL THROUGH */
block|}
case|case
literal|6
case|:
block|{
name|bus_dmamem_unmap
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
operator|(
name|caddr_t
operator|)
name|pdq
operator|->
name|pdq_unsolicited_info
operator|.
name|ui_events
argument_list|,
name|PDQ_OS_PAGESIZE
argument_list|)
expr_stmt|;
comment|/* FALL THROUGH */
block|}
case|case
literal|5
case|:
block|{
name|bus_dmamem_free
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
name|ui_segs
argument_list|,
name|ui_nsegs
argument_list|)
expr_stmt|;
comment|/* FALL THROUGH */
block|}
case|case
literal|4
case|:
block|{
name|bus_dmamap_unload
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
name|sc
operator|->
name|sc_dbmap
argument_list|)
expr_stmt|;
comment|/* FALL THROUGH */
block|}
case|case
literal|3
case|:
block|{
name|bus_dmamap_destroy
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
name|sc
operator|->
name|sc_dbmap
argument_list|)
expr_stmt|;
comment|/* FALL THROUGH */
block|}
case|case
literal|2
case|:
block|{
name|bus_dmamem_unmap
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
operator|(
name|caddr_t
operator|)
name|pdq
operator|->
name|pdq_dbp
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|pdq
operator|->
name|pdq_dbp
argument_list|)
argument_list|)
expr_stmt|;
comment|/* FALL THROUGH */
block|}
case|case
literal|1
case|:
block|{
name|bus_dmamem_free
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
name|db_segs
argument_list|,
name|db_nsegs
argument_list|)
expr_stmt|;
comment|/* FALL THROUGH */
block|}
block|}
return|return
name|not_ok
return|;
block|}
end_function

begin_function
specifier|extern
name|void
name|pdq_os_descriptor_block_sync
parameter_list|(
name|pdq_os_ctx_t
modifier|*
name|sc
parameter_list|,
name|size_t
name|offset
parameter_list|,
name|size_t
name|length
parameter_list|,
name|int
name|ops
parameter_list|)
block|{
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
name|sc
operator|->
name|sc_dbmap
argument_list|,
name|offset
argument_list|,
name|length
argument_list|,
name|ops
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|extern
name|void
name|pdq_os_consumer_block_sync
parameter_list|(
name|pdq_os_ctx_t
modifier|*
name|sc
parameter_list|,
name|int
name|ops
parameter_list|)
block|{
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
name|sc
operator|->
name|sc_cbmap
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|pdq_consumer_block_t
argument_list|)
argument_list|,
name|ops
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|extern
name|void
name|pdq_os_unsolicited_event_sync
parameter_list|(
name|pdq_os_ctx_t
modifier|*
name|sc
parameter_list|,
name|size_t
name|offset
parameter_list|,
name|size_t
name|length
parameter_list|,
name|int
name|ops
parameter_list|)
block|{
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
name|sc
operator|->
name|sc_uimap
argument_list|,
name|offset
argument_list|,
name|length
argument_list|,
name|ops
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|extern
name|void
name|pdq_os_databuf_sync
parameter_list|(
name|pdq_os_ctx_t
modifier|*
name|sc
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|size_t
name|offset
parameter_list|,
name|size_t
name|length
parameter_list|,
name|int
name|ops
parameter_list|)
block|{
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
name|M_GETCTX
argument_list|(
name|m
argument_list|,
name|bus_dmamap_t
argument_list|)
argument_list|,
name|offset
argument_list|,
name|length
argument_list|,
name|ops
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|extern
name|void
name|pdq_os_databuf_free
parameter_list|(
name|pdq_os_ctx_t
modifier|*
name|sc
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|)
block|{
if|if
condition|(
name|m
operator|->
name|m_flags
operator|&
operator|(
name|M_HASRXDMAMAP
operator||
name|M_HASTXDMAMAP
operator|)
condition|)
block|{
name|bus_dmamap_t
name|map
init|=
name|M_GETCTX
argument_list|(
name|m
argument_list|,
name|bus_dmamap_t
argument_list|)
decl_stmt|;
name|bus_dmamap_unload
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
name|map
argument_list|)
expr_stmt|;
name|bus_dmamap_destroy
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
name|map
argument_list|)
expr_stmt|;
name|m
operator|->
name|m_flags
operator|&=
operator|~
operator|(
name|M_HASRXDMAMAP
operator||
name|M_HASTXDMAMAP
operator|)
expr_stmt|;
block|}
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|extern
name|struct
name|mbuf
modifier|*
name|pdq_os_databuf_alloc
parameter_list|(
name|pdq_os_ctx_t
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|bus_dmamap_t
name|map
decl_stmt|;
name|MGETHDR
argument_list|(
name|m
argument_list|,
name|M_DONTWAIT
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"%s: can't alloc small buf\n"
argument_list|,
name|sc
operator|->
name|sc_dev
operator|.
name|dv_xname
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|MCLGET
argument_list|(
name|m
argument_list|,
name|M_DONTWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|m
operator|->
name|m_flags
operator|&
name|M_EXT
operator|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s: can't alloc cluster\n"
argument_list|,
name|sc
operator|->
name|sc_dev
operator|.
name|dv_xname
argument_list|)
expr_stmt|;
name|m_free
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|m
operator|->
name|m_len
operator|=
name|PDQ_OS_DATABUF_SIZE
expr_stmt|;
if|if
condition|(
name|bus_dmamap_create
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
name|PDQ_OS_DATABUF_SIZE
argument_list|,
literal|1
argument_list|,
name|PDQ_OS_DATABUF_SIZE
argument_list|,
literal|0
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|,
operator|&
name|map
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"%s: can't create dmamap\n"
argument_list|,
name|sc
operator|->
name|sc_dev
operator|.
name|dv_xname
argument_list|)
expr_stmt|;
name|m_free
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|bus_dmamap_load_mbuf
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
name|map
argument_list|,
name|m
argument_list|,
name|BUS_DMA_READ
operator||
name|BUS_DMA_NOWAIT
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"%s: can't load dmamap\n"
argument_list|,
name|sc
operator|->
name|sc_dev
operator|.
name|dv_xname
argument_list|)
expr_stmt|;
name|bus_dmamap_destroy
argument_list|(
name|sc
operator|->
name|sc_dmatag
argument_list|,
name|map
argument_list|)
expr_stmt|;
name|m_free
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|m
operator|->
name|m_flags
operator||=
name|M_HASRXDMAMAP
expr_stmt|;
name|M_SETCTX
argument_list|(
name|m
argument_list|,
name|map
argument_list|)
expr_stmt|;
return|return
name|m
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

end_unit


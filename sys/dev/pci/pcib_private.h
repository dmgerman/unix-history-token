begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 1994,1995 Stefan Esser, Wolfgang StanglMeier  * Copyright (c) 2000 Michael Smith<msmith@freebsd.org>  * Copyright (c) 2000 BSDi  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. The name of the author may not be used to endorse or promote products  *    derived from this software without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|__PCIB_PRIVATE_H__
end_ifndef

begin_define
define|#
directive|define
name|__PCIB_PRIVATE_H__
end_define

begin_include
include|#
directive|include
file|<sys/_callout.h>
end_include

begin_include
include|#
directive|include
file|<sys/_task.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|NEW_PCIB
end_ifdef

begin_comment
comment|/*  * Data structure and routines that Host to PCI bridge drivers can use  * to restrict allocations for child devices to ranges decoded by the  * bridge.  */
end_comment

begin_struct
struct|struct
name|pcib_host_resources
block|{
name|device_t
name|hr_pcib
decl_stmt|;
name|struct
name|resource_list
name|hr_rl
decl_stmt|;
block|}
struct|;
end_struct

begin_function_decl
name|int
name|pcib_host_res_init
parameter_list|(
name|device_t
name|pcib
parameter_list|,
name|struct
name|pcib_host_resources
modifier|*
name|hr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|pcib_host_res_free
parameter_list|(
name|device_t
name|pcib
parameter_list|,
name|struct
name|pcib_host_resources
modifier|*
name|hr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|pcib_host_res_decodes
parameter_list|(
name|struct
name|pcib_host_resources
modifier|*
name|hr
parameter_list|,
name|int
name|type
parameter_list|,
name|rman_res_t
name|start
parameter_list|,
name|rman_res_t
name|end
parameter_list|,
name|u_int
name|flags
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|struct
name|resource
modifier|*
name|pcib_host_res_alloc
parameter_list|(
name|struct
name|pcib_host_resources
modifier|*
name|hr
parameter_list|,
name|device_t
name|dev
parameter_list|,
name|int
name|type
parameter_list|,
name|int
modifier|*
name|rid
parameter_list|,
name|rman_res_t
name|start
parameter_list|,
name|rman_res_t
name|end
parameter_list|,
name|rman_res_t
name|count
parameter_list|,
name|u_int
name|flags
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|pcib_host_res_adjust
parameter_list|(
name|struct
name|pcib_host_resources
modifier|*
name|hr
parameter_list|,
name|device_t
name|dev
parameter_list|,
name|int
name|type
parameter_list|,
name|struct
name|resource
modifier|*
name|r
parameter_list|,
name|rman_res_t
name|start
parameter_list|,
name|rman_res_t
name|end
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * Export portions of generic PCI:PCI bridge support so that it can be  * used by subclasses.  */
end_comment

begin_expr_stmt
name|DECLARE_CLASS
argument_list|(
name|pcib_driver
argument_list|)
expr_stmt|;
end_expr_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|NEW_PCIB
end_ifdef

begin_define
define|#
directive|define
name|WIN_IO
value|0x1
end_define

begin_define
define|#
directive|define
name|WIN_MEM
value|0x2
end_define

begin_define
define|#
directive|define
name|WIN_PMEM
value|0x4
end_define

begin_struct
struct|struct
name|pcib_window
block|{
name|pci_addr_t
name|base
decl_stmt|;
comment|/* base address */
name|pci_addr_t
name|limit
decl_stmt|;
comment|/* topmost address */
name|struct
name|rman
name|rman
decl_stmt|;
name|struct
name|resource
modifier|*
modifier|*
name|res
decl_stmt|;
name|int
name|count
decl_stmt|;
comment|/* size of 'res' array */
name|int
name|reg
decl_stmt|;
comment|/* resource id from parent */
name|int
name|valid
decl_stmt|;
name|int
name|mask
decl_stmt|;
comment|/* WIN_* bitmask of this window */
name|int
name|step
decl_stmt|;
comment|/* log_2 of window granularity */
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
block|}
struct|;
end_struct

begin_endif
endif|#
directive|endif
end_endif

begin_struct
struct|struct
name|pcib_secbus
block|{
name|u_int
name|sec
decl_stmt|;
name|u_int
name|sub
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|NEW_PCIB
argument_list|)
operator|&&
name|defined
argument_list|(
name|PCI_RES_BUS
argument_list|)
name|device_t
name|dev
decl_stmt|;
name|struct
name|rman
name|rman
decl_stmt|;
name|struct
name|resource
modifier|*
name|res
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|int
name|sub_reg
decl_stmt|;
endif|#
directive|endif
block|}
struct|;
end_struct

begin_comment
comment|/*  * Bridge-specific data.  */
end_comment

begin_struct
struct|struct
name|pcib_softc
block|{
name|device_t
name|dev
decl_stmt|;
name|device_t
name|child
decl_stmt|;
name|uint32_t
name|flags
decl_stmt|;
comment|/* flags */
define|#
directive|define
name|PCIB_SUBTRACTIVE
value|0x1
define|#
directive|define
name|PCIB_DISABLE_MSI
value|0x2
define|#
directive|define
name|PCIB_DISABLE_MSIX
value|0x4
define|#
directive|define
name|PCIB_ENABLE_ARI
value|0x8
define|#
directive|define
name|PCIB_HOTPLUG
value|0x10
define|#
directive|define
name|PCIB_HOTPLUG_CMD_PENDING
value|0x20
define|#
directive|define
name|PCIB_DETACH_PENDING
value|0x40
define|#
directive|define
name|PCIB_DETACHING
value|0x80
name|u_int
name|domain
decl_stmt|;
comment|/* domain number */
name|u_int
name|pribus
decl_stmt|;
comment|/* primary bus number */
name|struct
name|pcib_secbus
name|bus
decl_stmt|;
comment|/* secondary bus numbers */
ifdef|#
directive|ifdef
name|NEW_PCIB
name|struct
name|pcib_window
name|io
decl_stmt|;
comment|/* I/O port window */
name|struct
name|pcib_window
name|mem
decl_stmt|;
comment|/* memory window */
name|struct
name|pcib_window
name|pmem
decl_stmt|;
comment|/* prefetchable memory window */
else|#
directive|else
name|pci_addr_t
name|pmembase
decl_stmt|;
comment|/* base address of prefetchable memory */
name|pci_addr_t
name|pmemlimit
decl_stmt|;
comment|/* topmost address of prefetchable memory */
name|pci_addr_t
name|membase
decl_stmt|;
comment|/* base address of memory window */
name|pci_addr_t
name|memlimit
decl_stmt|;
comment|/* topmost address of memory window */
name|uint32_t
name|iobase
decl_stmt|;
comment|/* base address of port window */
name|uint32_t
name|iolimit
decl_stmt|;
comment|/* topmost address of port window */
endif|#
directive|endif
name|uint16_t
name|bridgectl
decl_stmt|;
comment|/* bridge control register */
name|uint16_t
name|pcie_link_sta
decl_stmt|;
name|uint16_t
name|pcie_slot_sta
decl_stmt|;
name|uint32_t
name|pcie_slot_cap
decl_stmt|;
name|struct
name|resource
modifier|*
name|pcie_irq
decl_stmt|;
name|void
modifier|*
name|pcie_ihand
decl_stmt|;
name|struct
name|task
name|pcie_hp_task
decl_stmt|;
name|struct
name|callout
name|pcie_ab_timer
decl_stmt|;
name|struct
name|callout
name|pcie_cc_timer
decl_stmt|;
name|struct
name|callout
name|pcie_dll_timer
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|PCIB_SUPPORTED_ARI_VER
value|1
end_define

begin_typedef
typedef|typedef
name|uint32_t
name|pci_read_config_fn
parameter_list|(
name|int
name|b
parameter_list|,
name|int
name|s
parameter_list|,
name|int
name|f
parameter_list|,
name|int
name|reg
parameter_list|,
name|int
name|width
parameter_list|)
function_decl|;
end_typedef

begin_function_decl
name|int
name|host_pcib_get_busno
parameter_list|(
name|pci_read_config_fn
name|read_config
parameter_list|,
name|int
name|bus
parameter_list|,
name|int
name|slot
parameter_list|,
name|int
name|func
parameter_list|,
name|uint8_t
modifier|*
name|busnum
parameter_list|)
function_decl|;
end_function_decl

begin_if
if|#
directive|if
name|defined
argument_list|(
name|NEW_PCIB
argument_list|)
operator|&&
name|defined
argument_list|(
name|PCI_RES_BUS
argument_list|)
end_if

begin_function_decl
name|struct
name|resource
modifier|*
name|pci_domain_alloc_bus
parameter_list|(
name|int
name|domain
parameter_list|,
name|device_t
name|dev
parameter_list|,
name|int
modifier|*
name|rid
parameter_list|,
name|rman_res_t
name|start
parameter_list|,
name|rman_res_t
name|end
parameter_list|,
name|rman_res_t
name|count
parameter_list|,
name|u_int
name|flags
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|pci_domain_adjust_bus
parameter_list|(
name|int
name|domain
parameter_list|,
name|device_t
name|dev
parameter_list|,
name|struct
name|resource
modifier|*
name|r
parameter_list|,
name|rman_res_t
name|start
parameter_list|,
name|rman_res_t
name|end
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|pci_domain_release_bus
parameter_list|(
name|int
name|domain
parameter_list|,
name|device_t
name|dev
parameter_list|,
name|int
name|rid
parameter_list|,
name|struct
name|resource
modifier|*
name|r
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|struct
name|resource
modifier|*
name|pcib_alloc_subbus
parameter_list|(
name|struct
name|pcib_secbus
modifier|*
name|bus
parameter_list|,
name|device_t
name|child
parameter_list|,
name|int
modifier|*
name|rid
parameter_list|,
name|rman_res_t
name|start
parameter_list|,
name|rman_res_t
name|end
parameter_list|,
name|rman_res_t
name|count
parameter_list|,
name|u_int
name|flags
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|pcib_free_secbus
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|struct
name|pcib_secbus
modifier|*
name|bus
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|pcib_setup_secbus
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|struct
name|pcib_secbus
modifier|*
name|bus
parameter_list|,
name|int
name|min_count
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
name|int
name|pcib_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|pcib_attach_child
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|pcib_attach_common
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|pcib_bridge_init
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|NEW_PCIB
end_ifdef

begin_function_decl
specifier|const
name|char
modifier|*
name|pcib_child_name
parameter_list|(
name|device_t
name|child
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
name|int
name|pcib_child_present
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|device_t
name|child
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|pcib_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|pcib_read_ivar
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|device_t
name|child
parameter_list|,
name|int
name|which
parameter_list|,
name|uintptr_t
modifier|*
name|result
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|pcib_write_ivar
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|device_t
name|child
parameter_list|,
name|int
name|which
parameter_list|,
name|uintptr_t
name|value
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|struct
name|resource
modifier|*
name|pcib_alloc_resource
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|device_t
name|child
parameter_list|,
name|int
name|type
parameter_list|,
name|int
modifier|*
name|rid
parameter_list|,
name|rman_res_t
name|start
parameter_list|,
name|rman_res_t
name|end
parameter_list|,
name|rman_res_t
name|count
parameter_list|,
name|u_int
name|flags
parameter_list|)
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|NEW_PCIB
end_ifdef

begin_function_decl
name|int
name|pcib_adjust_resource
parameter_list|(
name|device_t
name|bus
parameter_list|,
name|device_t
name|child
parameter_list|,
name|int
name|type
parameter_list|,
name|struct
name|resource
modifier|*
name|r
parameter_list|,
name|rman_res_t
name|start
parameter_list|,
name|rman_res_t
name|end
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|pcib_release_resource
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|device_t
name|child
parameter_list|,
name|int
name|type
parameter_list|,
name|int
name|rid
parameter_list|,
name|struct
name|resource
modifier|*
name|r
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
name|int
name|pcib_maxslots
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|pcib_maxfuncs
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|pcib_route_interrupt
parameter_list|(
name|device_t
name|pcib
parameter_list|,
name|device_t
name|dev
parameter_list|,
name|int
name|pin
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|pcib_alloc_msi
parameter_list|(
name|device_t
name|pcib
parameter_list|,
name|device_t
name|dev
parameter_list|,
name|int
name|count
parameter_list|,
name|int
name|maxcount
parameter_list|,
name|int
modifier|*
name|irqs
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|pcib_release_msi
parameter_list|(
name|device_t
name|pcib
parameter_list|,
name|device_t
name|dev
parameter_list|,
name|int
name|count
parameter_list|,
name|int
modifier|*
name|irqs
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|pcib_alloc_msix
parameter_list|(
name|device_t
name|pcib
parameter_list|,
name|device_t
name|dev
parameter_list|,
name|int
modifier|*
name|irq
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|pcib_release_msix
parameter_list|(
name|device_t
name|pcib
parameter_list|,
name|device_t
name|dev
parameter_list|,
name|int
name|irq
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|pcib_map_msi
parameter_list|(
name|device_t
name|pcib
parameter_list|,
name|device_t
name|dev
parameter_list|,
name|int
name|irq
parameter_list|,
name|uint64_t
modifier|*
name|addr
parameter_list|,
name|uint32_t
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|pcib_get_id
parameter_list|(
name|device_t
name|pcib
parameter_list|,
name|device_t
name|dev
parameter_list|,
name|enum
name|pci_id_type
name|type
parameter_list|,
name|uintptr_t
modifier|*
name|id
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|pcib_decode_rid
parameter_list|(
name|device_t
name|pcib
parameter_list|,
name|uint16_t
name|rid
parameter_list|,
name|int
modifier|*
name|bus
parameter_list|,
name|int
modifier|*
name|slot
parameter_list|,
name|int
modifier|*
name|func
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|pcib_request_feature
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|enum
name|pci_feature
name|feature
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|pcib_request_feature_allow
parameter_list|(
name|device_t
name|pcib
parameter_list|,
name|device_t
name|dev
parameter_list|,
name|enum
name|pci_feature
name|feature
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

end_unit


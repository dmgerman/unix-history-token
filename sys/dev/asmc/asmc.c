begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2007, 2008 Rui Paulo<rpaulo@FreeBSD.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED  * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE  * DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT,  * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES  * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR  * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,  * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN  * ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE  * POSSIBILITY OF SUCH DAMAGE.  *  */
end_comment

begin_comment
comment|/*  * Driver for Apple's System Management Console (SMC).  * SMC can be found on the MacBook, MacBook Pro and Mac Mini.  *  * Inspired by the Linux applesmc driver.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/taskqueue.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<contrib/dev/acpica/include/acpi.h>
end_include

begin_include
include|#
directive|include
file|<dev/acpica/acpivar.h>
end_include

begin_include
include|#
directive|include
file|<dev/asmc/asmcvar.h>
end_include

begin_include
include|#
directive|include
file|"opt_intr_filter.h"
end_include

begin_comment
comment|/*  * Device interface.  */
end_comment

begin_function_decl
specifier|static
name|int
name|asmc_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|asmc_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|asmc_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * SMC functions.  */
end_comment

begin_function_decl
specifier|static
name|int
name|asmc_init
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|asmc_command
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|uint8_t
name|command
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|asmc_wait
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|uint8_t
name|val
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|asmc_wait_ack
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|uint8_t
name|val
parameter_list|,
name|int
name|amount
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|asmc_key_write
parameter_list|(
name|device_t
name|dev
parameter_list|,
specifier|const
name|char
modifier|*
name|key
parameter_list|,
name|uint8_t
modifier|*
name|buf
parameter_list|,
name|uint8_t
name|len
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|asmc_key_read
parameter_list|(
name|device_t
name|dev
parameter_list|,
specifier|const
name|char
modifier|*
name|key
parameter_list|,
name|uint8_t
modifier|*
name|buf
parameter_list|,
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|asmc_fan_count
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|asmc_fan_getvalue
parameter_list|(
name|device_t
name|dev
parameter_list|,
specifier|const
name|char
modifier|*
name|key
parameter_list|,
name|int
name|fan
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|asmc_temp_getvalue
parameter_list|(
name|device_t
name|dev
parameter_list|,
specifier|const
name|char
modifier|*
name|key
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|asmc_sms_read
parameter_list|(
name|device_t
parameter_list|,
specifier|const
name|char
modifier|*
name|key
parameter_list|,
name|int16_t
modifier|*
name|val
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|asmc_sms_calibrate
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|asmc_sms_intrfast
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|INTR_FILTER
end_ifdef

begin_function_decl
specifier|static
name|void
name|asmc_sms_handler
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|void
name|asmc_sms_printintr
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|asmc_sms_task
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|int
name|pending
parameter_list|)
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|DEBUG
end_ifdef

begin_function_decl
name|void
name|asmc_dumpall
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|asmc_key_dump
parameter_list|(
name|device_t
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * Model functions.  */
end_comment

begin_function_decl
specifier|static
name|int
name|asmc_mb_sysctl_fanspeed
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|asmc_mb_sysctl_fansafespeed
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|asmc_mb_sysctl_fanminspeed
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|asmc_mb_sysctl_fanmaxspeed
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|asmc_mb_sysctl_fantargetspeed
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|asmc_temp_sysctl
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|asmc_mb_sysctl_sms_x
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|asmc_mb_sysctl_sms_y
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|asmc_mb_sysctl_sms_z
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|asmc_mbp_sysctl_light_left
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|asmc_mbp_sysctl_light_right
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|asmc_mbp_sysctl_light_control
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
function_decl|;
end_function_decl

begin_struct
struct|struct
name|asmc_model
block|{
specifier|const
name|char
modifier|*
name|smc_model
decl_stmt|;
comment|/* smbios.system.product env var. */
specifier|const
name|char
modifier|*
name|smc_desc
decl_stmt|;
comment|/* driver description */
comment|/* Helper functions */
name|int
function_decl|(
modifier|*
name|smc_sms_x
function_decl|)
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
function_decl|;
name|int
function_decl|(
modifier|*
name|smc_sms_y
function_decl|)
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
function_decl|;
name|int
function_decl|(
modifier|*
name|smc_sms_z
function_decl|)
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
function_decl|;
name|int
function_decl|(
modifier|*
name|smc_fan_speed
function_decl|)
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
function_decl|;
name|int
function_decl|(
modifier|*
name|smc_fan_safespeed
function_decl|)
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
function_decl|;
name|int
function_decl|(
modifier|*
name|smc_fan_minspeed
function_decl|)
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
function_decl|;
name|int
function_decl|(
modifier|*
name|smc_fan_maxspeed
function_decl|)
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
function_decl|;
name|int
function_decl|(
modifier|*
name|smc_fan_targetspeed
function_decl|)
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
function_decl|;
name|int
function_decl|(
modifier|*
name|smc_light_left
function_decl|)
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
function_decl|;
name|int
function_decl|(
modifier|*
name|smc_light_right
function_decl|)
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
function_decl|;
name|int
function_decl|(
modifier|*
name|smc_light_control
function_decl|)
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
function_decl|;
specifier|const
name|char
modifier|*
name|smc_temps
index|[
name|ASMC_TEMP_MAX
index|]
decl_stmt|;
specifier|const
name|char
modifier|*
name|smc_tempnames
index|[
name|ASMC_TEMP_MAX
index|]
decl_stmt|;
specifier|const
name|char
modifier|*
name|smc_tempdescs
index|[
name|ASMC_TEMP_MAX
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_function_decl
specifier|static
name|struct
name|asmc_model
modifier|*
name|asmc_match
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_define
define|#
directive|define
name|ASMC_SMS_FUNCS
value|asmc_mb_sysctl_sms_x, asmc_mb_sysctl_sms_y, \ 			asmc_mb_sysctl_sms_z
end_define

begin_define
define|#
directive|define
name|ASMC_FAN_FUNCS
value|asmc_mb_sysctl_fanspeed, asmc_mb_sysctl_fansafespeed, \ 			asmc_mb_sysctl_fanminspeed, \ 			asmc_mb_sysctl_fanmaxspeed, \ 			asmc_mb_sysctl_fantargetspeed
end_define

begin_define
define|#
directive|define
name|ASMC_LIGHT_FUNCS
value|asmc_mbp_sysctl_light_left, \ 			 asmc_mbp_sysctl_light_right, \ 			 asmc_mbp_sysctl_light_control
end_define

begin_decl_stmt
name|struct
name|asmc_model
name|asmc_models
index|[]
init|=
block|{
block|{
literal|"MacBook1,1"
block|,
literal|"Apple SMC MacBook Core Duo"
block|,
name|ASMC_SMS_FUNCS
block|,
name|ASMC_FAN_FUNCS
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|ASMC_MB_TEMPS
block|,
name|ASMC_MB_TEMPNAMES
block|,
name|ASMC_MB_TEMPDESCS
block|}
block|,
block|{
literal|"MacBook2,1"
block|,
literal|"Apple SMC MacBook Core 2 Duo"
block|,
name|ASMC_SMS_FUNCS
block|,
name|ASMC_FAN_FUNCS
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|ASMC_MB_TEMPS
block|,
name|ASMC_MB_TEMPNAMES
block|,
name|ASMC_MB_TEMPDESCS
block|}
block|,
block|{
literal|"MacBookPro1,1"
block|,
literal|"Apple SMC MacBook Pro Core Duo (15-inch)"
block|,
name|ASMC_SMS_FUNCS
block|,
name|ASMC_FAN_FUNCS
block|,
name|ASMC_LIGHT_FUNCS
block|,
name|ASMC_MBP_TEMPS
block|,
name|ASMC_MBP_TEMPNAMES
block|,
name|ASMC_MBP_TEMPDESCS
block|}
block|,
block|{
literal|"MacBookPro1,2"
block|,
literal|"Apple SMC MacBook Pro Core Duo (17-inch)"
block|,
name|ASMC_SMS_FUNCS
block|,
name|ASMC_FAN_FUNCS
block|,
name|ASMC_LIGHT_FUNCS
block|,
name|ASMC_MBP_TEMPS
block|,
name|ASMC_MBP_TEMPNAMES
block|,
name|ASMC_MBP_TEMPDESCS
block|}
block|,
block|{
literal|"MacBookPro2,1"
block|,
literal|"Apple SMC MacBook Pro Core 2 Duo (17-inch)"
block|,
name|ASMC_SMS_FUNCS
block|,
name|ASMC_FAN_FUNCS
block|,
name|ASMC_LIGHT_FUNCS
block|,
name|ASMC_MBP_TEMPS
block|,
name|ASMC_MBP_TEMPNAMES
block|,
name|ASMC_MBP_TEMPDESCS
block|}
block|,
block|{
literal|"MacBookPro2,2"
block|,
literal|"Apple SMC MacBook Pro Core 2 Duo (15-inch)"
block|,
name|ASMC_SMS_FUNCS
block|,
name|ASMC_FAN_FUNCS
block|,
name|ASMC_LIGHT_FUNCS
block|,
name|ASMC_MBP_TEMPS
block|,
name|ASMC_MBP_TEMPNAMES
block|,
name|ASMC_MBP_TEMPDESCS
block|}
block|,
block|{
literal|"MacBookPro3,1"
block|,
literal|"Apple SMC MacBook Pro Core 2 Duo (15-inch LED)"
block|,
name|ASMC_SMS_FUNCS
block|,
name|ASMC_FAN_FUNCS
block|,
name|ASMC_LIGHT_FUNCS
block|,
name|ASMC_MBP_TEMPS
block|,
name|ASMC_MBP_TEMPNAMES
block|,
name|ASMC_MBP_TEMPDESCS
block|}
block|,
block|{
literal|"MacBookPro3,2"
block|,
literal|"Apple SMC MacBook Pro Core 2 Duo (17-inch HD)"
block|,
name|ASMC_SMS_FUNCS
block|,
name|ASMC_FAN_FUNCS
block|,
name|ASMC_LIGHT_FUNCS
block|,
name|ASMC_MBP_TEMPS
block|,
name|ASMC_MBP_TEMPNAMES
block|,
name|ASMC_MBP_TEMPDESCS
block|}
block|,
block|{
literal|"MacBookPro4,1"
block|,
literal|"Apple SMC MacBook Pro Core 2 Duo (Penryn)"
block|,
name|ASMC_SMS_FUNCS
block|,
name|ASMC_FAN_FUNCS
block|,
name|ASMC_LIGHT_FUNCS
block|,
name|ASMC_MBP4_TEMPS
block|,
name|ASMC_MBP4_TEMPNAMES
block|,
name|ASMC_MBP4_TEMPDESCS
block|}
block|,
comment|/* The Mac Mini has no SMS */
block|{
literal|"Macmini1,1"
block|,
literal|"Apple SMC Mac Mini"
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|ASMC_FAN_FUNCS
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|ASMC_MM_TEMPS
block|,
name|ASMC_MM_TEMPNAMES
block|,
name|ASMC_MM_TEMPDESCS
block|}
block|,
comment|/* Idem for the MacPro */
block|{
literal|"MacPro2"
block|,
literal|"Apple SMC Mac Pro (8-core)"
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|ASMC_FAN_FUNCS
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|ASMC_MP_TEMPS
block|,
name|ASMC_MP_TEMPNAMES
block|,
name|ASMC_MP_TEMPDESCS
block|}
block|,
block|{
literal|"MacBookAir1,1"
block|,
literal|"Apple SMC MacBook Air"
block|,
name|ASMC_SMS_FUNCS
block|,
name|ASMC_FAN_FUNCS
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|ASMC_MBA_TEMPS
block|,
name|ASMC_MBA_TEMPNAMES
block|,
name|ASMC_MBA_TEMPDESCS
block|}
block|,
block|{
name|NULL
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_undef
undef|#
directive|undef
name|ASMC_SMS_FUNCS
end_undef

begin_undef
undef|#
directive|undef
name|ASMC_FAN_FUNCS
end_undef

begin_undef
undef|#
directive|undef
name|ASMC_LIGHT_FUNCS
end_undef

begin_comment
comment|/*  * Driver methods.  */
end_comment

begin_decl_stmt
specifier|static
name|device_method_t
name|asmc_methods
index|[]
init|=
block|{
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|asmc_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|asmc_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|asmc_detach
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|asmc_driver
init|=
block|{
literal|"asmc"
block|,
name|asmc_methods
block|,
expr|sizeof
operator|(
expr|struct
name|asmc_softc
operator|)
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Debugging  */
end_comment

begin_define
define|#
directive|define
name|_COMPONENT
value|ACPI_OEM
end_define

begin_macro
name|ACPI_MODULE_NAME
argument_list|(
literal|"ASMC"
argument_list|)
end_macro

begin_ifdef
ifdef|#
directive|ifdef
name|DEBUG
end_ifdef

begin_define
define|#
directive|define
name|ASMC_DPRINTF
parameter_list|(
name|str
parameter_list|)
value|device_printf(dev, str)
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|ASMC_DPRINTF
parameter_list|(
name|str
parameter_list|)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* NB: can't be const */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|asmc_ids
index|[]
init|=
block|{
literal|"APP0001"
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|asmc_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|asmc
argument_list|,
name|acpi
argument_list|,
name|asmc_driver
argument_list|,
name|asmc_devclass
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|asmc
argument_list|,
name|acpi
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|struct
name|asmc_model
modifier|*
name|asmc_match
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|char
modifier|*
name|model
decl_stmt|;
name|model
operator|=
name|getenv
argument_list|(
literal|"smbios.system.product"
argument_list|)
expr_stmt|;
if|if
condition|(
name|model
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|asmc_models
index|[
name|i
index|]
operator|.
name|smc_model
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|model
argument_list|,
name|asmc_models
index|[
name|i
index|]
operator|.
name|smc_model
argument_list|,
name|strlen
argument_list|(
name|model
argument_list|)
argument_list|)
condition|)
block|{
name|freeenv
argument_list|(
name|model
argument_list|)
expr_stmt|;
return|return
operator|(
operator|&
name|asmc_models
index|[
name|i
index|]
operator|)
return|;
block|}
block|}
name|freeenv
argument_list|(
name|model
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|asmc_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|asmc_model
modifier|*
name|model
decl_stmt|;
if|if
condition|(
name|resource_disabled
argument_list|(
literal|"asmc"
argument_list|,
literal|0
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
name|ACPI_ID_PROBE
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|,
name|dev
argument_list|,
name|asmc_ids
argument_list|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|model
operator|=
name|asmc_match
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|model
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"model not recognized\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|device_set_desc
argument_list|(
name|dev
argument_list|,
name|model
operator|->
name|smc_desc
argument_list|)
expr_stmt|;
return|return
operator|(
name|BUS_PROBE_DEFAULT
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|asmc_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|char
name|name
index|[
literal|2
index|]
decl_stmt|;
name|struct
name|asmc_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|sysctl_ctx_list
modifier|*
name|sysctlctx
decl_stmt|;
name|struct
name|sysctl_oid
modifier|*
name|sysctlnode
decl_stmt|;
name|struct
name|asmc_model
modifier|*
name|model
decl_stmt|;
name|sc
operator|->
name|sc_ioport
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IOPORT
argument_list|,
operator|&
name|sc
operator|->
name|sc_rid_port
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_ioport
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to allocate IO port\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
name|sysctlctx
operator|=
name|device_get_sysctl_ctx
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sysctlnode
operator|=
name|device_get_sysctl_tree
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|model
operator|=
name|asmc_match
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|mtx_init
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|,
literal|"asmc"
argument_list|,
name|NULL
argument_list|,
name|MTX_SPIN
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_model
operator|=
name|model
expr_stmt|;
name|asmc_init
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* 	 * dev.asmc.n.fan.* tree. 	 */
name|sc
operator|->
name|sc_fan_tree
index|[
literal|0
index|]
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
name|sysctlctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|sysctlnode
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"fan"
argument_list|,
name|CTLFLAG_RD
argument_list|,
literal|0
argument_list|,
literal|"Fan Root Tree"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
name|sc
operator|->
name|sc_nfan
condition|;
name|i
operator|++
control|)
block|{
name|j
operator|=
name|i
operator|-
literal|1
expr_stmt|;
name|name
index|[
literal|0
index|]
operator|=
literal|'0'
operator|+
name|j
expr_stmt|;
name|name
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_fan_tree
index|[
name|i
index|]
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
name|sysctlctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|sc
operator|->
name|sc_fan_tree
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
name|name
argument_list|,
name|CTLFLAG_RD
argument_list|,
literal|0
argument_list|,
literal|"Fan Subtree"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
name|sysctlctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|sc
operator|->
name|sc_fan_tree
index|[
name|i
index|]
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"speed"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RD
argument_list|,
name|dev
argument_list|,
name|j
argument_list|,
name|model
operator|->
name|smc_fan_speed
argument_list|,
literal|"I"
argument_list|,
literal|"Fan speed in RPM"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
name|sysctlctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|sc
operator|->
name|sc_fan_tree
index|[
name|i
index|]
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"safespeed"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RD
argument_list|,
name|dev
argument_list|,
name|j
argument_list|,
name|model
operator|->
name|smc_fan_safespeed
argument_list|,
literal|"I"
argument_list|,
literal|"Fan safe speed in RPM"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
name|sysctlctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|sc
operator|->
name|sc_fan_tree
index|[
name|i
index|]
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"minspeed"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RD
argument_list|,
name|dev
argument_list|,
name|j
argument_list|,
name|model
operator|->
name|smc_fan_minspeed
argument_list|,
literal|"I"
argument_list|,
literal|"Fan minimum speed in RPM"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
name|sysctlctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|sc
operator|->
name|sc_fan_tree
index|[
name|i
index|]
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"maxspeed"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RD
argument_list|,
name|dev
argument_list|,
name|j
argument_list|,
name|model
operator|->
name|smc_fan_maxspeed
argument_list|,
literal|"I"
argument_list|,
literal|"Fan maximum speed in RPM"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
name|sysctlctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|sc
operator|->
name|sc_fan_tree
index|[
name|i
index|]
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"targetspeed"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RD
argument_list|,
name|dev
argument_list|,
name|j
argument_list|,
name|model
operator|->
name|smc_fan_targetspeed
argument_list|,
literal|"I"
argument_list|,
literal|"Fan target speed in RPM"
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * dev.asmc.n.temp tree. 	 */
name|sc
operator|->
name|sc_temp_tree
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
name|sysctlctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|sysctlnode
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"temp"
argument_list|,
name|CTLFLAG_RD
argument_list|,
literal|0
argument_list|,
literal|"Temperature sensors"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|model
operator|->
name|smc_temps
index|[
name|i
index|]
condition|;
name|i
operator|++
control|)
block|{
name|SYSCTL_ADD_PROC
argument_list|(
name|sysctlctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|sc
operator|->
name|sc_temp_tree
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
name|model
operator|->
name|smc_tempnames
index|[
name|i
index|]
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RD
argument_list|,
name|dev
argument_list|,
name|i
argument_list|,
name|asmc_temp_sysctl
argument_list|,
literal|"I"
argument_list|,
name|model
operator|->
name|smc_tempdescs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * dev.asmc.n.light 	 */
if|if
condition|(
name|model
operator|->
name|smc_light_left
condition|)
block|{
name|sc
operator|->
name|sc_light_tree
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
name|sysctlctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|sysctlnode
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"light"
argument_list|,
name|CTLFLAG_RD
argument_list|,
literal|0
argument_list|,
literal|"Keyboard backlight sensors"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
name|sysctlctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|sc
operator|->
name|sc_light_tree
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"left"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RD
argument_list|,
name|dev
argument_list|,
literal|0
argument_list|,
name|model
operator|->
name|smc_light_left
argument_list|,
literal|"I"
argument_list|,
literal|"Keyboard backlight left sensor"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
name|sysctlctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|sc
operator|->
name|sc_light_tree
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"right"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RD
argument_list|,
name|dev
argument_list|,
literal|0
argument_list|,
name|model
operator|->
name|smc_light_right
argument_list|,
literal|"I"
argument_list|,
literal|"Keyboard backlight right sensor"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
name|sysctlctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|sc
operator|->
name|sc_light_tree
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"control"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RW
operator||
name|CTLFLAG_ANYBODY
argument_list|,
name|dev
argument_list|,
literal|0
argument_list|,
name|model
operator|->
name|smc_light_control
argument_list|,
literal|"I"
argument_list|,
literal|"Keyboard backlight brightness control"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|model
operator|->
name|smc_sms_x
operator|==
name|NULL
condition|)
goto|goto
name|nosms
goto|;
comment|/* 	 * dev.asmc.n.sms tree. 	 */
name|sc
operator|->
name|sc_sms_tree
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
name|sysctlctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|sysctlnode
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"sms"
argument_list|,
name|CTLFLAG_RD
argument_list|,
literal|0
argument_list|,
literal|"Sudden Motion Sensor"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
name|sysctlctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|sc
operator|->
name|sc_sms_tree
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"x"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RD
argument_list|,
name|dev
argument_list|,
literal|0
argument_list|,
name|model
operator|->
name|smc_sms_x
argument_list|,
literal|"I"
argument_list|,
literal|"Sudden Motion Sensor X value"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
name|sysctlctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|sc
operator|->
name|sc_sms_tree
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"y"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RD
argument_list|,
name|dev
argument_list|,
literal|0
argument_list|,
name|model
operator|->
name|smc_sms_y
argument_list|,
literal|"I"
argument_list|,
literal|"Sudden Motion Sensor Y value"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
name|sysctlctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|sc
operator|->
name|sc_sms_tree
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"z"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RD
argument_list|,
name|dev
argument_list|,
literal|0
argument_list|,
name|model
operator|->
name|smc_sms_z
argument_list|,
literal|"I"
argument_list|,
literal|"Sudden Motion Sensor Z value"
argument_list|)
expr_stmt|;
comment|/* 	 * Need a taskqueue to send devctl_notify() events 	 * when the SMS interrupt us. 	 * 	 * PI_REALTIME is used due to the sensitivity of the 	 * interrupt. An interrupt from the SMS means that the 	 * disk heads should be turned off as quickly as possible. 	 * 	 * We only need to do this for the non INTR_FILTER case. 	 */
name|sc
operator|->
name|sc_sms_tq
operator|=
name|NULL
expr_stmt|;
ifndef|#
directive|ifndef
name|INTR_FILTER
name|TASK_INIT
argument_list|(
operator|&
name|sc
operator|->
name|sc_sms_task
argument_list|,
literal|0
argument_list|,
name|asmc_sms_task
argument_list|,
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_sms_tq
operator|=
name|taskqueue_create_fast
argument_list|(
literal|"asmc_taskq"
argument_list|,
name|M_WAITOK
argument_list|,
name|taskqueue_thread_enqueue
argument_list|,
operator|&
name|sc
operator|->
name|sc_sms_tq
argument_list|)
expr_stmt|;
name|taskqueue_start_threads
argument_list|(
operator|&
name|sc
operator|->
name|sc_sms_tq
argument_list|,
literal|1
argument_list|,
name|PI_REALTIME
argument_list|,
literal|"%s sms taskq"
argument_list|,
name|device_get_nameunit
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* 	 * Allocate an IRQ for the SMS. 	 */
name|sc
operator|->
name|sc_rid_irq
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_irq
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
operator|&
name|sc
operator|->
name|sc_rid_irq
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_irq
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to allocate IRQ resource\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ENXIO
expr_stmt|;
goto|goto
name|err2
goto|;
block|}
name|ret
operator|=
name|bus_setup_intr
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|sc_irq
argument_list|,
name|INTR_TYPE_MISC
operator||
name|INTR_MPSAFE
argument_list|,
ifdef|#
directive|ifdef
name|INTR_FILTER
name|asmc_sms_intrfast
argument_list|,
name|asmc_sms_handler
argument_list|,
else|#
directive|else
name|asmc_sms_intrfast
argument_list|,
name|NULL
argument_list|,
endif|#
directive|endif
name|dev
argument_list|,
operator|&
name|sc
operator|->
name|sc_cookie
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to setup SMS IRQ\n"
argument_list|)
expr_stmt|;
goto|goto
name|err1
goto|;
block|}
name|nosms
label|:
return|return
operator|(
literal|0
operator|)
return|;
name|err1
label|:
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
name|sc
operator|->
name|sc_rid_irq
argument_list|,
name|sc
operator|->
name|sc_irq
argument_list|)
expr_stmt|;
name|err2
label|:
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IOPORT
argument_list|,
name|sc
operator|->
name|sc_rid_port
argument_list|,
name|sc
operator|->
name|sc_ioport
argument_list|)
expr_stmt|;
name|mtx_destroy
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_sms_tq
condition|)
name|taskqueue_free
argument_list|(
name|sc
operator|->
name|sc_sms_tq
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|asmc_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|asmc_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_sms_tq
condition|)
block|{
name|taskqueue_drain
argument_list|(
name|sc
operator|->
name|sc_sms_tq
argument_list|,
operator|&
name|sc
operator|->
name|sc_sms_task
argument_list|)
expr_stmt|;
name|taskqueue_free
argument_list|(
name|sc
operator|->
name|sc_sms_tq
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|sc_cookie
condition|)
name|bus_teardown_intr
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|sc_irq
argument_list|,
name|sc
operator|->
name|sc_cookie
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_irq
condition|)
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
name|sc
operator|->
name|sc_rid_irq
argument_list|,
name|sc
operator|->
name|sc_irq
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_ioport
condition|)
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IOPORT
argument_list|,
name|sc
operator|->
name|sc_rid_port
argument_list|,
name|sc
operator|->
name|sc_ioport
argument_list|)
expr_stmt|;
name|mtx_destroy
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|DEBUG
end_ifdef

begin_function
name|void
name|asmc_dumpall
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
comment|/* XXX magic number */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|0x100
condition|;
name|i
operator|++
control|)
name|asmc_key_dump
argument_list|(
name|dev
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|int
name|asmc_init
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|asmc_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|i
decl_stmt|,
name|error
init|=
literal|1
decl_stmt|;
name|uint8_t
name|buf
index|[
literal|4
index|]
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_model
operator|->
name|smc_sms_x
operator|==
name|NULL
condition|)
goto|goto
name|nosms
goto|;
comment|/* 	 * We are ready to recieve interrupts from the SMS. 	 */
name|buf
index|[
literal|0
index|]
operator|=
literal|0x01
expr_stmt|;
name|ASMC_DPRINTF
argument_list|(
operator|(
literal|"intok key\n"
operator|)
argument_list|)
expr_stmt|;
name|asmc_key_write
argument_list|(
name|dev
argument_list|,
name|ASMC_KEY_INTOK
argument_list|,
name|buf
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|50
argument_list|)
expr_stmt|;
comment|/*  	 * Initiate the polling intervals. 	 */
name|buf
index|[
literal|0
index|]
operator|=
literal|20
expr_stmt|;
comment|/* msecs */
name|ASMC_DPRINTF
argument_list|(
operator|(
literal|"low int key\n"
operator|)
argument_list|)
expr_stmt|;
name|asmc_key_write
argument_list|(
name|dev
argument_list|,
name|ASMC_KEY_SMS_LOW_INT
argument_list|,
name|buf
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|200
argument_list|)
expr_stmt|;
name|buf
index|[
literal|0
index|]
operator|=
literal|20
expr_stmt|;
comment|/* msecs */
name|ASMC_DPRINTF
argument_list|(
operator|(
literal|"high int key\n"
operator|)
argument_list|)
expr_stmt|;
name|asmc_key_write
argument_list|(
name|dev
argument_list|,
name|ASMC_KEY_SMS_HIGH_INT
argument_list|,
name|buf
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|200
argument_list|)
expr_stmt|;
name|buf
index|[
literal|0
index|]
operator|=
literal|0x00
expr_stmt|;
name|buf
index|[
literal|1
index|]
operator|=
literal|0x60
expr_stmt|;
name|ASMC_DPRINTF
argument_list|(
operator|(
literal|"sms low key\n"
operator|)
argument_list|)
expr_stmt|;
name|asmc_key_write
argument_list|(
name|dev
argument_list|,
name|ASMC_KEY_SMS_LOW
argument_list|,
name|buf
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|200
argument_list|)
expr_stmt|;
name|buf
index|[
literal|0
index|]
operator|=
literal|0x01
expr_stmt|;
name|buf
index|[
literal|1
index|]
operator|=
literal|0xc0
expr_stmt|;
name|ASMC_DPRINTF
argument_list|(
operator|(
literal|"sms high key\n"
operator|)
argument_list|)
expr_stmt|;
name|asmc_key_write
argument_list|(
name|dev
argument_list|,
name|ASMC_KEY_SMS_HIGH
argument_list|,
name|buf
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|200
argument_list|)
expr_stmt|;
comment|/* 	 * I'm not sure what this key does, but it seems to be 	 * required. 	 */
name|buf
index|[
literal|0
index|]
operator|=
literal|0x01
expr_stmt|;
name|ASMC_DPRINTF
argument_list|(
operator|(
literal|"sms flag key\n"
operator|)
argument_list|)
expr_stmt|;
name|asmc_key_write
argument_list|(
name|dev
argument_list|,
name|ASMC_KEY_SMS_FLAG
argument_list|,
name|buf
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_sms_intr_works
operator|=
literal|0
expr_stmt|;
comment|/* 	 * Retry SMS initialization 1000 times 	 * (takes approx. 2 seconds in worst case) 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|1000
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|asmc_key_read
argument_list|(
name|dev
argument_list|,
name|ASMC_KEY_SMS
argument_list|,
name|buf
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
operator|&&
operator|(
name|buf
index|[
literal|0
index|]
operator|==
name|ASMC_SMS_INIT1
operator|&&
name|buf
index|[
literal|1
index|]
operator|==
name|ASMC_SMS_INIT2
operator|)
condition|)
block|{
name|error
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_sms_intr_works
operator|=
literal|1
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|buf
index|[
literal|0
index|]
operator|=
name|ASMC_SMS_INIT1
expr_stmt|;
name|buf
index|[
literal|1
index|]
operator|=
name|ASMC_SMS_INIT2
expr_stmt|;
name|ASMC_DPRINTF
argument_list|(
operator|(
literal|"sms key\n"
operator|)
argument_list|)
expr_stmt|;
name|asmc_key_write
argument_list|(
name|dev
argument_list|,
name|ASMC_KEY_SMS
argument_list|,
name|buf
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|50
argument_list|)
expr_stmt|;
block|}
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"WARNING: Sudden Motion Sensor not initialized!\n"
argument_list|)
expr_stmt|;
name|out
label|:
name|asmc_sms_calibrate
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|nosms
label|:
name|sc
operator|->
name|sc_nfan
operator|=
name|asmc_fan_count
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_nfan
operator|>
name|ASMC_MAXFANS
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"more than %d fans were detected. Please "
literal|"report this.\n"
argument_list|,
name|ASMC_MAXFANS
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_nfan
operator|=
name|ASMC_MAXFANS
expr_stmt|;
block|}
if|if
condition|(
name|bootverbose
condition|)
block|{
comment|/* 		 * XXX: The number of keys is a 32 bit buffer, but 		 * right now Apple only uses the last 8 bit. 		 */
name|asmc_key_read
argument_list|(
name|dev
argument_list|,
name|ASMC_NKEYS
argument_list|,
name|buf
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"number of keys: %d\n"
argument_list|,
name|buf
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|DEBUG
name|asmc_dumpall
argument_list|(
name|dev
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * We need to make sure that the SMC acks the byte sent.  * Just wait up to (amount * 10)  ms.  */
end_comment

begin_function
specifier|static
name|int
name|asmc_wait_ack
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|uint8_t
name|val
parameter_list|,
name|int
name|amount
parameter_list|)
block|{
name|struct
name|asmc_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|u_int
name|i
decl_stmt|;
name|val
operator|=
name|val
operator|&
name|ASMC_STATUS_MASK
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|amount
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|ASMC_CMDPORT_READ
argument_list|(
name|sc
argument_list|)
operator|&
name|ASMC_STATUS_MASK
operator|)
operator|==
name|val
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * We need to make sure that the SMC acks the byte sent.  * Just wait up to 100 ms.  */
end_comment

begin_function
specifier|static
name|int
name|asmc_wait
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|uint8_t
name|val
parameter_list|)
block|{
name|struct
name|asmc_softc
modifier|*
name|sc
decl_stmt|;
if|if
condition|(
name|asmc_wait_ack
argument_list|(
name|dev
argument_list|,
name|val
argument_list|,
literal|1000
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|val
operator|=
name|val
operator|&
name|ASMC_STATUS_MASK
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s failed: 0x%x, 0x%x\n"
argument_list|,
name|__func__
argument_list|,
name|val
argument_list|,
name|ASMC_CMDPORT_READ
argument_list|(
name|sc
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Send the given command, retrying up to 10 times if  * the acknowledgement fails.  */
end_comment

begin_function
specifier|static
name|int
name|asmc_command
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|uint8_t
name|command
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|struct
name|asmc_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|10
condition|;
name|i
operator|++
control|)
block|{
name|ASMC_CMDPORT_WRITE
argument_list|(
name|sc
argument_list|,
name|command
argument_list|)
expr_stmt|;
if|if
condition|(
name|asmc_wait_ack
argument_list|(
name|dev
argument_list|,
literal|0x0c
argument_list|,
literal|100
argument_list|)
operator|==
literal|0
condition|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
ifdef|#
directive|ifdef
name|DEBUG
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s failed: 0x%x, 0x%x\n"
argument_list|,
name|__func__
argument_list|,
name|command
argument_list|,
name|ASMC_CMDPORT_READ
argument_list|(
name|sc
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|asmc_key_read
parameter_list|(
name|device_t
name|dev
parameter_list|,
specifier|const
name|char
modifier|*
name|key
parameter_list|,
name|uint8_t
modifier|*
name|buf
parameter_list|,
name|uint8_t
name|len
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|error
init|=
literal|1
decl_stmt|,
name|try
init|=
literal|0
decl_stmt|;
name|struct
name|asmc_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|mtx_lock_spin
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
name|begin
label|:
if|if
condition|(
name|asmc_command
argument_list|(
name|dev
argument_list|,
name|ASMC_CMDREAD
argument_list|)
condition|)
goto|goto
name|out
goto|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
name|ASMC_DATAPORT_WRITE
argument_list|(
name|sc
argument_list|,
name|key
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|asmc_wait
argument_list|(
name|dev
argument_list|,
literal|0x04
argument_list|)
condition|)
goto|goto
name|out
goto|;
block|}
name|ASMC_DATAPORT_WRITE
argument_list|(
name|sc
argument_list|,
name|len
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|asmc_wait
argument_list|(
name|dev
argument_list|,
literal|0x05
argument_list|)
condition|)
goto|goto
name|out
goto|;
name|buf
index|[
name|i
index|]
operator|=
name|ASMC_DATAPORT_READ
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
name|error
operator|=
literal|0
expr_stmt|;
name|out
label|:
if|if
condition|(
name|error
condition|)
block|{
if|if
condition|(
operator|++
name|try
operator|<
literal|10
condition|)
goto|goto
name|begin
goto|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s for key %s failed %d times, giving up\n"
argument_list|,
name|__func__
argument_list|,
name|key
argument_list|,
name|try
argument_list|)
expr_stmt|;
block|}
name|mtx_unlock_spin
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|DEBUG
end_ifdef

begin_function
specifier|static
name|int
name|asmc_key_dump
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|number
parameter_list|)
block|{
name|struct
name|asmc_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|char
name|key
index|[
literal|5
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
name|char
name|type
index|[
literal|7
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
name|uint8_t
name|index
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|v
index|[
literal|32
index|]
decl_stmt|;
name|uint8_t
name|maxlen
decl_stmt|;
name|int
name|i
decl_stmt|,
name|error
init|=
literal|1
decl_stmt|,
name|try
init|=
literal|0
decl_stmt|;
name|mtx_lock_spin
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
name|index
index|[
literal|0
index|]
operator|=
operator|(
name|number
operator|>>
literal|24
operator|)
operator|&
literal|0xff
expr_stmt|;
name|index
index|[
literal|1
index|]
operator|=
operator|(
name|number
operator|>>
literal|16
operator|)
operator|&
literal|0xff
expr_stmt|;
name|index
index|[
literal|2
index|]
operator|=
operator|(
name|number
operator|>>
literal|8
operator|)
operator|&
literal|0xff
expr_stmt|;
name|index
index|[
literal|3
index|]
operator|=
operator|(
name|number
operator|)
operator|&
literal|0xff
expr_stmt|;
name|begin
label|:
if|if
condition|(
name|asmc_command
argument_list|(
name|dev
argument_list|,
literal|0x12
argument_list|)
condition|)
goto|goto
name|out
goto|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
name|ASMC_DATAPORT_WRITE
argument_list|(
name|sc
argument_list|,
name|index
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|asmc_wait
argument_list|(
name|dev
argument_list|,
literal|0x04
argument_list|)
condition|)
goto|goto
name|out
goto|;
block|}
name|ASMC_DATAPORT_WRITE
argument_list|(
name|sc
argument_list|,
literal|4
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|asmc_wait
argument_list|(
name|dev
argument_list|,
literal|0x05
argument_list|)
condition|)
goto|goto
name|out
goto|;
name|key
index|[
name|i
index|]
operator|=
name|ASMC_DATAPORT_READ
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
comment|/* get type */
if|if
condition|(
name|asmc_command
argument_list|(
name|dev
argument_list|,
literal|0x13
argument_list|)
condition|)
goto|goto
name|out
goto|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
name|ASMC_DATAPORT_WRITE
argument_list|(
name|sc
argument_list|,
name|key
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|asmc_wait
argument_list|(
name|dev
argument_list|,
literal|0x04
argument_list|)
condition|)
goto|goto
name|out
goto|;
block|}
name|ASMC_DATAPORT_WRITE
argument_list|(
name|sc
argument_list|,
literal|6
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|6
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|asmc_wait
argument_list|(
name|dev
argument_list|,
literal|0x05
argument_list|)
condition|)
goto|goto
name|out
goto|;
name|type
index|[
name|i
index|]
operator|=
name|ASMC_DATAPORT_READ
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
name|error
operator|=
literal|0
expr_stmt|;
name|out
label|:
if|if
condition|(
name|error
condition|)
block|{
if|if
condition|(
operator|++
name|try
operator|<
literal|10
condition|)
goto|goto
name|begin
goto|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s for key %s failed %d times, giving up\n"
argument_list|,
name|__func__
argument_list|,
name|key
argument_list|,
name|try
argument_list|)
expr_stmt|;
name|mtx_unlock_spin
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|char
name|buf
index|[
literal|1024
index|]
decl_stmt|;
name|char
name|buf2
index|[
literal|8
index|]
decl_stmt|;
name|mtx_unlock_spin
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
name|maxlen
operator|=
name|type
index|[
literal|0
index|]
expr_stmt|;
name|type
index|[
literal|0
index|]
operator|=
literal|' '
expr_stmt|;
name|type
index|[
literal|5
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|maxlen
operator|>
sizeof|sizeof
argument_list|(
name|v
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"WARNING: cropping maxlen from %d to %zu\n"
argument_list|,
name|maxlen
argument_list|,
sizeof|sizeof
argument_list|(
name|v
argument_list|)
argument_list|)
expr_stmt|;
name|maxlen
operator|=
sizeof|sizeof
argument_list|(
name|v
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|v
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|v
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
block|}
name|asmc_key_read
argument_list|(
name|dev
argument_list|,
name|key
argument_list|,
name|v
argument_list|,
name|maxlen
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"key %d is: %s, type %s "
literal|"(len %d), data"
argument_list|,
name|number
argument_list|,
name|key
argument_list|,
name|type
argument_list|,
name|maxlen
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|maxlen
condition|;
name|i
operator|++
control|)
block|{
name|snprintf
argument_list|(
name|buf2
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|" %02x"
argument_list|,
name|v
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|strlcat
argument_list|(
name|buf
argument_list|,
name|buf2
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|strlcat
argument_list|(
name|buf
argument_list|,
literal|" \n"
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|int
name|asmc_key_write
parameter_list|(
name|device_t
name|dev
parameter_list|,
specifier|const
name|char
modifier|*
name|key
parameter_list|,
name|uint8_t
modifier|*
name|buf
parameter_list|,
name|uint8_t
name|len
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|error
init|=
operator|-
literal|1
decl_stmt|,
name|try
init|=
literal|0
decl_stmt|;
name|struct
name|asmc_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|mtx_lock_spin
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
name|begin
label|:
name|ASMC_DPRINTF
argument_list|(
operator|(
literal|"cmd port: cmd write\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|asmc_command
argument_list|(
name|dev
argument_list|,
name|ASMC_CMDWRITE
argument_list|)
condition|)
goto|goto
name|out
goto|;
name|ASMC_DPRINTF
argument_list|(
operator|(
literal|"data port: key\n"
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
name|ASMC_DATAPORT_WRITE
argument_list|(
name|sc
argument_list|,
name|key
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|asmc_wait
argument_list|(
name|dev
argument_list|,
literal|0x04
argument_list|)
condition|)
goto|goto
name|out
goto|;
block|}
name|ASMC_DPRINTF
argument_list|(
operator|(
literal|"data port: length\n"
operator|)
argument_list|)
expr_stmt|;
name|ASMC_DATAPORT_WRITE
argument_list|(
name|sc
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|ASMC_DPRINTF
argument_list|(
operator|(
literal|"data port: buffer\n"
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|asmc_wait
argument_list|(
name|dev
argument_list|,
literal|0x04
argument_list|)
condition|)
goto|goto
name|out
goto|;
name|ASMC_DATAPORT_WRITE
argument_list|(
name|sc
argument_list|,
name|buf
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|error
operator|=
literal|0
expr_stmt|;
name|out
label|:
if|if
condition|(
name|error
condition|)
block|{
if|if
condition|(
operator|++
name|try
operator|<
literal|10
condition|)
goto|goto
name|begin
goto|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s for key %s failed %d times, giving up\n"
argument_list|,
name|__func__
argument_list|,
name|key
argument_list|,
name|try
argument_list|)
expr_stmt|;
block|}
name|mtx_unlock_spin
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Fan control functions.  */
end_comment

begin_function
specifier|static
name|int
name|asmc_fan_count
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|uint8_t
name|buf
index|[
literal|1
index|]
decl_stmt|;
if|if
condition|(
name|asmc_key_read
argument_list|(
name|dev
argument_list|,
name|ASMC_KEY_FANCOUNT
argument_list|,
name|buf
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
return|return
operator|(
name|buf
index|[
literal|0
index|]
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|asmc_fan_getvalue
parameter_list|(
name|device_t
name|dev
parameter_list|,
specifier|const
name|char
modifier|*
name|key
parameter_list|,
name|int
name|fan
parameter_list|)
block|{
name|int
name|speed
decl_stmt|;
name|uint8_t
name|buf
index|[
literal|2
index|]
decl_stmt|;
name|char
name|fankey
index|[
literal|5
index|]
decl_stmt|;
name|snprintf
argument_list|(
name|fankey
argument_list|,
sizeof|sizeof
argument_list|(
name|fankey
argument_list|)
argument_list|,
name|key
argument_list|,
name|fan
argument_list|)
expr_stmt|;
if|if
condition|(
name|asmc_key_read
argument_list|(
name|dev
argument_list|,
name|fankey
argument_list|,
name|buf
argument_list|,
literal|2
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|speed
operator|=
operator|(
name|buf
index|[
literal|0
index|]
operator|<<
literal|6
operator|)
operator||
operator|(
name|buf
index|[
literal|1
index|]
operator|>>
literal|2
operator|)
expr_stmt|;
return|return
operator|(
name|speed
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|asmc_mb_sysctl_fanspeed
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|device_t
name|dev
init|=
operator|(
name|device_t
operator|)
name|arg1
decl_stmt|;
name|int
name|fan
init|=
name|arg2
decl_stmt|;
name|int
name|error
decl_stmt|;
name|int32_t
name|v
decl_stmt|;
name|v
operator|=
name|asmc_fan_getvalue
argument_list|(
name|dev
argument_list|,
name|ASMC_KEY_FANSPEED
argument_list|,
name|fan
argument_list|)
expr_stmt|;
name|error
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|v
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|asmc_mb_sysctl_fansafespeed
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|device_t
name|dev
init|=
operator|(
name|device_t
operator|)
name|arg1
decl_stmt|;
name|int
name|fan
init|=
name|arg2
decl_stmt|;
name|int
name|error
decl_stmt|;
name|int32_t
name|v
decl_stmt|;
name|v
operator|=
name|asmc_fan_getvalue
argument_list|(
name|dev
argument_list|,
name|ASMC_KEY_FANSAFESPEED
argument_list|,
name|fan
argument_list|)
expr_stmt|;
name|error
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|v
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|asmc_mb_sysctl_fanminspeed
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|device_t
name|dev
init|=
operator|(
name|device_t
operator|)
name|arg1
decl_stmt|;
name|int
name|fan
init|=
name|arg2
decl_stmt|;
name|int
name|error
decl_stmt|;
name|int32_t
name|v
decl_stmt|;
name|v
operator|=
name|asmc_fan_getvalue
argument_list|(
name|dev
argument_list|,
name|ASMC_KEY_FANMINSPEED
argument_list|,
name|fan
argument_list|)
expr_stmt|;
name|error
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|v
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|asmc_mb_sysctl_fanmaxspeed
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|device_t
name|dev
init|=
operator|(
name|device_t
operator|)
name|arg1
decl_stmt|;
name|int
name|fan
init|=
name|arg2
decl_stmt|;
name|int
name|error
decl_stmt|;
name|int32_t
name|v
decl_stmt|;
name|v
operator|=
name|asmc_fan_getvalue
argument_list|(
name|dev
argument_list|,
name|ASMC_KEY_FANMAXSPEED
argument_list|,
name|fan
argument_list|)
expr_stmt|;
name|error
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|v
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|asmc_mb_sysctl_fantargetspeed
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|device_t
name|dev
init|=
operator|(
name|device_t
operator|)
name|arg1
decl_stmt|;
name|int
name|fan
init|=
name|arg2
decl_stmt|;
name|int
name|error
decl_stmt|;
name|int32_t
name|v
decl_stmt|;
name|v
operator|=
name|asmc_fan_getvalue
argument_list|(
name|dev
argument_list|,
name|ASMC_KEY_FANTARGETSPEED
argument_list|,
name|fan
argument_list|)
expr_stmt|;
name|error
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|v
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Temperature functions.  */
end_comment

begin_function
specifier|static
name|int
name|asmc_temp_getvalue
parameter_list|(
name|device_t
name|dev
parameter_list|,
specifier|const
name|char
modifier|*
name|key
parameter_list|)
block|{
name|uint8_t
name|buf
index|[
literal|2
index|]
decl_stmt|;
comment|/* 	 * Check for invalid temperatures. 	 */
if|if
condition|(
name|asmc_key_read
argument_list|(
name|dev
argument_list|,
name|key
argument_list|,
name|buf
argument_list|,
literal|2
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
return|return
operator|(
name|buf
index|[
literal|0
index|]
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|asmc_temp_sysctl
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|device_t
name|dev
init|=
operator|(
name|device_t
operator|)
name|arg1
decl_stmt|;
name|struct
name|asmc_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|error
decl_stmt|,
name|val
decl_stmt|;
name|val
operator|=
name|asmc_temp_getvalue
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|sc_model
operator|->
name|smc_temps
index|[
name|arg2
index|]
argument_list|)
expr_stmt|;
name|error
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|val
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Sudden Motion Sensor functions.  */
end_comment

begin_function
specifier|static
name|int
name|asmc_sms_read
parameter_list|(
name|device_t
name|dev
parameter_list|,
specifier|const
name|char
modifier|*
name|key
parameter_list|,
name|int16_t
modifier|*
name|val
parameter_list|)
block|{
name|uint8_t
name|buf
index|[
literal|2
index|]
decl_stmt|;
name|int
name|error
decl_stmt|;
comment|/* no need to do locking here as asmc_key_read() already does it */
switch|switch
condition|(
name|key
index|[
literal|3
index|]
condition|)
block|{
case|case
literal|'X'
case|:
case|case
literal|'Y'
case|:
case|case
literal|'Z'
case|:
name|error
operator|=
name|asmc_key_read
argument_list|(
name|dev
argument_list|,
name|key
argument_list|,
name|buf
argument_list|,
literal|2
argument_list|)
expr_stmt|;
break|break;
default|default:
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s called with invalid argument %s\n"
argument_list|,
name|__func__
argument_list|,
name|key
argument_list|)
expr_stmt|;
name|error
operator|=
literal|1
expr_stmt|;
goto|goto
name|out
goto|;
block|}
operator|*
name|val
operator|=
operator|(
operator|(
name|int16_t
operator|)
name|buf
index|[
literal|0
index|]
operator|<<
literal|8
operator|)
operator||
name|buf
index|[
literal|1
index|]
expr_stmt|;
name|out
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|asmc_sms_calibrate
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|asmc_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|asmc_sms_read
argument_list|(
name|dev
argument_list|,
name|ASMC_KEY_SMS_X
argument_list|,
operator|&
name|sc
operator|->
name|sms_rest_x
argument_list|)
expr_stmt|;
name|asmc_sms_read
argument_list|(
name|dev
argument_list|,
name|ASMC_KEY_SMS_Y
argument_list|,
operator|&
name|sc
operator|->
name|sms_rest_y
argument_list|)
expr_stmt|;
name|asmc_sms_read
argument_list|(
name|dev
argument_list|,
name|ASMC_KEY_SMS_Z
argument_list|,
operator|&
name|sc
operator|->
name|sms_rest_z
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|asmc_sms_intrfast
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|uint8_t
name|type
decl_stmt|;
name|device_t
name|dev
init|=
operator|(
name|device_t
operator|)
name|arg
decl_stmt|;
name|struct
name|asmc_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|sc
operator|->
name|sc_sms_intr_works
condition|)
return|return
operator|(
name|FILTER_HANDLED
operator|)
return|;
name|mtx_lock_spin
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
name|type
operator|=
name|ASMC_INTPORT_READ
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|mtx_unlock_spin
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_sms_intrtype
operator|=
name|type
expr_stmt|;
name|asmc_sms_printintr
argument_list|(
name|dev
argument_list|,
name|type
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|INTR_FILTER
return|return
operator|(
name|FILTER_SCHEDULE_THREAD
operator||
name|FILTER_HANDLED
operator|)
return|;
else|#
directive|else
name|taskqueue_enqueue
argument_list|(
name|sc
operator|->
name|sc_sms_tq
argument_list|,
operator|&
name|sc
operator|->
name|sc_sms_task
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
name|FILTER_HANDLED
operator|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|INTR_FILTER
end_ifdef

begin_function
specifier|static
name|void
name|asmc_sms_handler
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|asmc_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|arg
argument_list|)
decl_stmt|;
name|asmc_sms_task
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|void
name|asmc_sms_printintr
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|uint8_t
name|type
parameter_list|)
block|{
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|ASMC_SMS_INTFF
case|:
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"WARNING: possible free fall!\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|ASMC_SMS_INTHA
case|:
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"WARNING: high acceleration detected!\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|ASMC_SMS_INTSH
case|:
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"WARNING: possible shock!\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s unknown interrupt\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|asmc_sms_task
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|int
name|pending
parameter_list|)
block|{
name|struct
name|asmc_softc
modifier|*
name|sc
init|=
operator|(
expr|struct
name|asmc_softc
operator|*
operator|)
name|arg
decl_stmt|;
name|char
name|notify
index|[
literal|16
index|]
decl_stmt|;
name|int
name|type
decl_stmt|;
switch|switch
condition|(
name|sc
operator|->
name|sc_sms_intrtype
condition|)
block|{
case|case
name|ASMC_SMS_INTFF
case|:
name|type
operator|=
literal|2
expr_stmt|;
break|break;
case|case
name|ASMC_SMS_INTHA
case|:
name|type
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|ASMC_SMS_INTSH
case|:
name|type
operator|=
literal|0
expr_stmt|;
break|break;
default|default:
name|type
operator|=
literal|255
expr_stmt|;
block|}
name|snprintf
argument_list|(
name|notify
argument_list|,
sizeof|sizeof
argument_list|(
name|notify
argument_list|)
argument_list|,
literal|" notify=0x%x"
argument_list|,
name|type
argument_list|)
expr_stmt|;
name|devctl_notify
argument_list|(
literal|"ACPI"
argument_list|,
literal|"asmc"
argument_list|,
literal|"SMS"
argument_list|,
name|notify
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|asmc_mb_sysctl_sms_x
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|device_t
name|dev
init|=
operator|(
name|device_t
operator|)
name|arg1
decl_stmt|;
name|int
name|error
decl_stmt|;
name|int16_t
name|val
decl_stmt|;
name|int32_t
name|v
decl_stmt|;
name|asmc_sms_read
argument_list|(
name|dev
argument_list|,
name|ASMC_KEY_SMS_X
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|v
operator|=
operator|(
name|int32_t
operator|)
name|val
expr_stmt|;
name|error
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|v
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|asmc_mb_sysctl_sms_y
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|device_t
name|dev
init|=
operator|(
name|device_t
operator|)
name|arg1
decl_stmt|;
name|int
name|error
decl_stmt|;
name|int16_t
name|val
decl_stmt|;
name|int32_t
name|v
decl_stmt|;
name|asmc_sms_read
argument_list|(
name|dev
argument_list|,
name|ASMC_KEY_SMS_Y
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|v
operator|=
operator|(
name|int32_t
operator|)
name|val
expr_stmt|;
name|error
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|v
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|asmc_mb_sysctl_sms_z
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|device_t
name|dev
init|=
operator|(
name|device_t
operator|)
name|arg1
decl_stmt|;
name|int
name|error
decl_stmt|;
name|int16_t
name|val
decl_stmt|;
name|int32_t
name|v
decl_stmt|;
name|asmc_sms_read
argument_list|(
name|dev
argument_list|,
name|ASMC_KEY_SMS_Z
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|v
operator|=
operator|(
name|int32_t
operator|)
name|val
expr_stmt|;
name|error
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|v
argument_list|,
sizeof|sizeof
argument_list|(
name|v
argument_list|)
argument_list|,
name|req
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|asmc_mbp_sysctl_light_left
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|device_t
name|dev
init|=
operator|(
name|device_t
operator|)
name|arg1
decl_stmt|;
name|uint8_t
name|buf
index|[
literal|6
index|]
decl_stmt|;
name|int
name|error
decl_stmt|;
name|int32_t
name|v
decl_stmt|;
name|asmc_key_read
argument_list|(
name|dev
argument_list|,
name|ASMC_KEY_LIGHTLEFT
argument_list|,
name|buf
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|v
operator|=
name|buf
index|[
literal|2
index|]
expr_stmt|;
name|error
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|v
argument_list|,
sizeof|sizeof
argument_list|(
name|v
argument_list|)
argument_list|,
name|req
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|asmc_mbp_sysctl_light_right
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|device_t
name|dev
init|=
operator|(
name|device_t
operator|)
name|arg1
decl_stmt|;
name|uint8_t
name|buf
index|[
literal|6
index|]
decl_stmt|;
name|int
name|error
decl_stmt|;
name|int32_t
name|v
decl_stmt|;
name|asmc_key_read
argument_list|(
name|dev
argument_list|,
name|ASMC_KEY_LIGHTRIGHT
argument_list|,
name|buf
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|v
operator|=
name|buf
index|[
literal|2
index|]
expr_stmt|;
name|error
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|v
argument_list|,
sizeof|sizeof
argument_list|(
name|v
argument_list|)
argument_list|,
name|req
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|asmc_mbp_sysctl_light_control
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|device_t
name|dev
init|=
operator|(
name|device_t
operator|)
name|arg1
decl_stmt|;
name|uint8_t
name|buf
index|[
literal|2
index|]
decl_stmt|;
name|int
name|error
decl_stmt|;
name|unsigned
name|int
name|level
decl_stmt|;
specifier|static
name|int32_t
name|v
decl_stmt|;
name|error
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|v
argument_list|,
sizeof|sizeof
argument_list|(
name|v
argument_list|)
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
operator|&&
name|req
operator|->
name|newptr
operator|!=
name|NULL
condition|)
block|{
name|level
operator|=
operator|*
operator|(
name|unsigned
name|int
operator|*
operator|)
name|req
operator|->
name|newptr
expr_stmt|;
if|if
condition|(
name|level
operator|>
literal|255
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|v
operator|=
name|level
expr_stmt|;
name|buf
index|[
literal|0
index|]
operator|=
name|level
expr_stmt|;
name|buf
index|[
literal|1
index|]
operator|=
literal|0x00
expr_stmt|;
name|asmc_key_write
argument_list|(
name|dev
argument_list|,
name|ASMC_KEY_LIGHTVALUE
argument_list|,
name|buf
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

end_unit


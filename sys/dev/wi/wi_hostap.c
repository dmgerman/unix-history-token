begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2002  *	Thomas Skibo<skibo@pacbell.net>.  All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. All advertising materials mentioning features or use of this software  *    must display the following acknowledgement:  *	This product includes software developed by Thomas Skibo.  * 4. Neither the name of the author nor the names of any co-contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY Thomas Skibo AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL Thomas Skibo OR HIS DRINKING PALS  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF  * THE POSSIBILITY OF SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_comment
comment|/* This is experimental Host AP software for Prism 2 802.11b interfaces.  *  * Much of this is based upon the "Linux Host AP driver Host AP driver  * for Intersil Prism2" by Jouni Malinen<jkm@ssh.com> or<jkmaline@cc.hut.fi>.  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_if
if|#
directive|if
name|__FreeBSD_version
operator|>=
literal|500033
end_if

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/ucred.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/syslog.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<machine/clock.h>
end_include

begin_include
include|#
directive|include
file|<machine/md_var.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus_pio.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_arp.h>
end_include

begin_include
include|#
directive|include
file|<net/ethernet.h>
end_include

begin_include
include|#
directive|include
file|<net/if_dl.h>
end_include

begin_include
include|#
directive|include
file|<net/if_media.h>
end_include

begin_include
include|#
directive|include
file|<net/if_types.h>
end_include

begin_include
include|#
directive|include
file|<net/if_ieee80211.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_systm.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_var.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip.h>
end_include

begin_include
include|#
directive|include
file|<netinet/if_ether.h>
end_include

begin_include
include|#
directive|include
file|<dev/wi/if_wavelan_ieee.h>
end_include

begin_include
include|#
directive|include
file|<dev/wi/wi_hostap.h>
end_include

begin_include
include|#
directive|include
file|<dev/wi/if_wivar.h>
end_include

begin_include
include|#
directive|include
file|<dev/wi/if_wireg.h>
end_include

begin_expr_stmt
name|MALLOC_DEFINE
argument_list|(
name|M_HAP_STA
argument_list|,
literal|"hostap_sta"
argument_list|,
literal|"if_wi host AP mode station entry"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function_decl
specifier|static
name|void
name|wihap_sta_timeout
parameter_list|(
name|void
modifier|*
name|v
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|wihap_sta_info
modifier|*
name|wihap_sta_alloc
parameter_list|(
name|struct
name|wi_softc
modifier|*
name|sc
parameter_list|,
name|u_int8_t
modifier|*
name|addr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|wihap_sta_delete
parameter_list|(
name|struct
name|wihap_sta_info
modifier|*
name|sta
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|wihap_sta_info
modifier|*
name|wihap_sta_find
parameter_list|(
name|struct
name|wihap_info
modifier|*
name|whi
parameter_list|,
name|u_int8_t
modifier|*
name|addr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|wihap_sta_is_assoc
parameter_list|(
name|struct
name|wihap_info
modifier|*
name|whi
parameter_list|,
name|u_int8_t
name|addr
index|[]
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|wihap_auth_req
parameter_list|(
name|struct
name|wi_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|wi_frame
modifier|*
name|rxfrm
parameter_list|,
name|caddr_t
name|pkt
parameter_list|,
name|int
name|len
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|wihap_sta_deauth
parameter_list|(
name|struct
name|wi_softc
modifier|*
name|sc
parameter_list|,
name|u_int8_t
name|sta_addr
index|[]
parameter_list|,
name|u_int16_t
name|reason
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|wihap_deauth_req
parameter_list|(
name|struct
name|wi_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|wi_frame
modifier|*
name|rxfrm
parameter_list|,
name|caddr_t
name|pkt
parameter_list|,
name|int
name|len
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|wihap_assoc_req
parameter_list|(
name|struct
name|wi_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|wi_frame
modifier|*
name|rxfrm
parameter_list|,
name|caddr_t
name|pkt
parameter_list|,
name|int
name|len
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|wihap_sta_disassoc
parameter_list|(
name|struct
name|wi_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|wihap_sta_info
modifier|*
name|sta
parameter_list|,
name|u_int16_t
name|reason
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|wihap_disassoc_req
parameter_list|(
name|struct
name|wi_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|wi_frame
modifier|*
name|rxfrm
parameter_list|,
name|caddr_t
name|pkt
parameter_list|,
name|int
name|len
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * take_hword()  *  *	Used for parsing management frames.  The pkt pointer and length  *	variables are updated after the value is removed.  */
end_comment

begin_function
specifier|static
name|__inline
name|u_int16_t
name|take_hword
parameter_list|(
name|caddr_t
modifier|*
name|ppkt
parameter_list|,
name|int
modifier|*
name|plen
parameter_list|)
block|{
name|u_int16_t
name|s
init|=
name|le16toh
argument_list|(
operator|*
operator|(
name|u_int16_t
operator|*
operator|)
operator|*
name|ppkt
argument_list|)
decl_stmt|;
operator|*
name|ppkt
operator|+=
sizeof|sizeof
argument_list|(
name|u_int16_t
argument_list|)
expr_stmt|;
operator|*
name|plen
operator|-=
sizeof|sizeof
argument_list|(
name|u_int16_t
argument_list|)
expr_stmt|;
return|return
name|s
return|;
block|}
end_function

begin_comment
comment|/* take_tlv()  *  *	Parse out TLV element from a packet, check for underflow of packet  *	or overflow of buffer, update pkt/len.  */
end_comment

begin_function
specifier|static
name|int
name|take_tlv
parameter_list|(
name|caddr_t
modifier|*
name|ppkt
parameter_list|,
name|int
modifier|*
name|plen
parameter_list|,
name|int
name|id_expect
parameter_list|,
name|void
modifier|*
name|dst
parameter_list|,
name|int
name|maxlen
parameter_list|)
block|{
name|u_int8_t
name|id
decl_stmt|,
name|len
decl_stmt|;
if|if
condition|(
operator|*
name|plen
operator|<
literal|2
condition|)
return|return
operator|-
literal|1
return|;
name|id
operator|=
operator|(
operator|(
name|u_int8_t
operator|*
operator|)
operator|*
name|ppkt
operator|)
index|[
literal|0
index|]
expr_stmt|;
name|len
operator|=
operator|(
operator|(
name|u_int8_t
operator|*
operator|)
operator|*
name|ppkt
operator|)
index|[
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|id
operator|!=
name|id_expect
operator|||
operator|*
name|plen
operator|<
name|len
operator|+
literal|2
operator|||
name|maxlen
operator|<
name|len
condition|)
return|return
operator|-
literal|1
return|;
name|bcopy
argument_list|(
operator|*
name|ppkt
operator|+
literal|2
argument_list|,
name|dst
argument_list|,
name|len
argument_list|)
expr_stmt|;
operator|*
name|plen
operator|-=
literal|2
operator|+
name|len
expr_stmt|;
operator|*
name|ppkt
operator|+=
literal|2
operator|+
name|len
expr_stmt|;
return|return
operator|(
name|len
operator|)
return|;
block|}
end_function

begin_comment
comment|/* put_hword()  *	Put half-word element into management frames.  */
end_comment

begin_function
specifier|static
name|__inline
name|void
name|put_hword
parameter_list|(
name|caddr_t
modifier|*
name|ppkt
parameter_list|,
name|u_int16_t
name|s
parameter_list|)
block|{
operator|*
operator|(
name|u_int16_t
operator|*
operator|)
operator|*
name|ppkt
operator|=
name|htole16
argument_list|(
name|s
argument_list|)
expr_stmt|;
operator|*
name|ppkt
operator|+=
sizeof|sizeof
argument_list|(
name|u_int16_t
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* put_tlv()  *	Put TLV elements into management frames.  */
end_comment

begin_function
specifier|static
name|void
name|put_tlv
parameter_list|(
name|caddr_t
modifier|*
name|ppkt
parameter_list|,
name|u_int8_t
name|id
parameter_list|,
name|void
modifier|*
name|src
parameter_list|,
name|u_int8_t
name|len
parameter_list|)
block|{
operator|(
operator|*
name|ppkt
operator|)
index|[
literal|0
index|]
operator|=
name|id
expr_stmt|;
operator|(
operator|*
name|ppkt
operator|)
index|[
literal|1
index|]
operator|=
name|len
expr_stmt|;
name|bcopy
argument_list|(
name|src
argument_list|,
operator|(
operator|*
name|ppkt
operator|)
operator|+
literal|2
argument_list|,
name|len
argument_list|)
expr_stmt|;
operator|*
name|ppkt
operator|+=
literal|2
operator|+
name|len
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|put_rates
parameter_list|(
name|caddr_t
modifier|*
name|ppkt
parameter_list|,
name|u_int16_t
name|rates
parameter_list|)
block|{
name|u_int8_t
name|ratebuf
index|[
literal|8
index|]
decl_stmt|;
name|int
name|len
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|rates
operator|&
name|WI_SUPPRATES_1M
condition|)
name|ratebuf
index|[
name|len
operator|++
index|]
operator|=
literal|0x82
expr_stmt|;
if|if
condition|(
name|rates
operator|&
name|WI_SUPPRATES_2M
condition|)
name|ratebuf
index|[
name|len
operator|++
index|]
operator|=
literal|0x84
expr_stmt|;
if|if
condition|(
name|rates
operator|&
name|WI_SUPPRATES_5M
condition|)
name|ratebuf
index|[
name|len
operator|++
index|]
operator|=
literal|0x8b
expr_stmt|;
if|if
condition|(
name|rates
operator|&
name|WI_SUPPRATES_11M
condition|)
name|ratebuf
index|[
name|len
operator|++
index|]
operator|=
literal|0x96
expr_stmt|;
name|put_tlv
argument_list|(
name|ppkt
argument_list|,
name|IEEE80211_ELEMID_RATES
argument_list|,
name|ratebuf
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
name|len
return|;
block|}
end_function

begin_comment
comment|/* wihap_init()  *  *	Initialize host AP data structures.  Called even if port type is  *	not AP.  */
end_comment

begin_function
name|void
name|wihap_init
parameter_list|(
name|struct
name|wi_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|struct
name|wihap_info
modifier|*
name|whi
init|=
operator|&
name|sc
operator|->
name|wi_hostap_info
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|arpcom
operator|.
name|ac_if
operator|.
name|if_flags
operator|&
name|IFF_DEBUG
condition|)
name|printf
argument_list|(
literal|"wihap_init: sc=0x%x whi=0x%x\n"
argument_list|,
operator|(
name|int
operator|)
name|sc
argument_list|,
operator|(
name|int
operator|)
name|whi
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|whi
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|wihap_info
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|wi_ptype
operator|!=
name|WI_PORTTYPE_AP
condition|)
return|return;
name|whi
operator|->
name|apflags
operator|=
name|WIHAPFL_ACTIVE
expr_stmt|;
name|LIST_INIT
argument_list|(
operator|&
name|whi
operator|->
name|sta_list
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|WI_STA_HASH_SIZE
condition|;
name|i
operator|++
control|)
name|LIST_INIT
argument_list|(
operator|&
name|whi
operator|->
name|sta_hash
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|whi
operator|->
name|inactivity_time
operator|=
name|WIHAP_DFLT_INACTIVITY_TIME
expr_stmt|;
block|}
end_function

begin_comment
comment|/* wihap_sta_disassoc()  *  *	Send a disassociation frame to a specified station.  */
end_comment

begin_function
specifier|static
name|void
name|wihap_sta_disassoc
parameter_list|(
name|struct
name|wi_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|wihap_sta_info
modifier|*
name|sta
parameter_list|,
name|u_int16_t
name|reason
parameter_list|)
block|{
name|struct
name|wi_80211_hdr
modifier|*
name|resp_hdr
decl_stmt|;
name|caddr_t
name|pkt
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|arpcom
operator|.
name|ac_if
operator|.
name|if_flags
operator|&
name|IFF_DEBUG
condition|)
name|printf
argument_list|(
literal|"Sending disassoc to sta %6D\n"
argument_list|,
name|sta
operator|->
name|addr
argument_list|,
literal|":"
argument_list|)
expr_stmt|;
comment|/* Send disassoc packet. */
name|resp_hdr
operator|=
operator|(
expr|struct
name|wi_80211_hdr
operator|*
operator|)
name|sc
operator|->
name|wi_txbuf
expr_stmt|;
name|bzero
argument_list|(
name|resp_hdr
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|wi_80211_hdr
argument_list|)
argument_list|)
expr_stmt|;
name|resp_hdr
operator|->
name|frame_ctl
operator|=
name|WI_FTYPE_MGMT
operator||
name|WI_STYPE_MGMT_DISAS
expr_stmt|;
name|pkt
operator|=
name|sc
operator|->
name|wi_txbuf
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|wi_80211_hdr
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|sta
operator|->
name|addr
argument_list|,
name|resp_hdr
operator|->
name|addr1
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|sc
operator|->
name|arpcom
operator|.
name|ac_enaddr
argument_list|,
name|resp_hdr
operator|->
name|addr2
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|sc
operator|->
name|arpcom
operator|.
name|ac_enaddr
argument_list|,
name|resp_hdr
operator|->
name|addr3
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|put_hword
argument_list|(
operator|&
name|pkt
argument_list|,
name|reason
argument_list|)
expr_stmt|;
name|wi_mgmt_xmit
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|wi_txbuf
argument_list|,
literal|2
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|wi_80211_hdr
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* wihap_sta_deauth()  *  *	Send a deauthentication message to a specified station.  */
end_comment

begin_function
specifier|static
name|void
name|wihap_sta_deauth
parameter_list|(
name|struct
name|wi_softc
modifier|*
name|sc
parameter_list|,
name|u_int8_t
name|sta_addr
index|[]
parameter_list|,
name|u_int16_t
name|reason
parameter_list|)
block|{
name|struct
name|wi_80211_hdr
modifier|*
name|resp_hdr
decl_stmt|;
name|caddr_t
name|pkt
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|arpcom
operator|.
name|ac_if
operator|.
name|if_flags
operator|&
name|IFF_DEBUG
condition|)
name|printf
argument_list|(
literal|"Sending deauth to sta %6D\n"
argument_list|,
name|sta_addr
argument_list|,
literal|":"
argument_list|)
expr_stmt|;
comment|/* Send deauth packet. */
name|resp_hdr
operator|=
operator|(
expr|struct
name|wi_80211_hdr
operator|*
operator|)
name|sc
operator|->
name|wi_txbuf
expr_stmt|;
name|bzero
argument_list|(
name|resp_hdr
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|wi_80211_hdr
argument_list|)
argument_list|)
expr_stmt|;
name|resp_hdr
operator|->
name|frame_ctl
operator|=
name|htole16
argument_list|(
name|WI_FTYPE_MGMT
operator||
name|WI_STYPE_MGMT_DEAUTH
argument_list|)
expr_stmt|;
name|pkt
operator|=
name|sc
operator|->
name|wi_txbuf
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|wi_80211_hdr
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|sta_addr
argument_list|,
name|resp_hdr
operator|->
name|addr1
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|sc
operator|->
name|arpcom
operator|.
name|ac_enaddr
argument_list|,
name|resp_hdr
operator|->
name|addr2
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|sc
operator|->
name|arpcom
operator|.
name|ac_enaddr
argument_list|,
name|resp_hdr
operator|->
name|addr3
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|put_hword
argument_list|(
operator|&
name|pkt
argument_list|,
name|reason
argument_list|)
expr_stmt|;
name|wi_mgmt_xmit
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|wi_txbuf
argument_list|,
literal|2
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|wi_80211_hdr
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* wihap_shutdown()  *  *	Disassociate all stations and free up data structures.  */
end_comment

begin_function
name|void
name|wihap_shutdown
parameter_list|(
name|struct
name|wi_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|wihap_info
modifier|*
name|whi
init|=
operator|&
name|sc
operator|->
name|wi_hostap_info
decl_stmt|;
name|struct
name|wihap_sta_info
modifier|*
name|sta
decl_stmt|,
modifier|*
name|next
decl_stmt|;
name|int
name|s
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|arpcom
operator|.
name|ac_if
operator|.
name|if_flags
operator|&
name|IFF_DEBUG
condition|)
name|printf
argument_list|(
literal|"wihap_shutdown: sc=0x%x whi=0x%x\n"
argument_list|,
operator|(
name|int
operator|)
name|sc
argument_list|,
operator|(
name|int
operator|)
name|whi
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|whi
operator|->
name|apflags
operator|&
name|WIHAPFL_ACTIVE
operator|)
condition|)
return|return;
comment|/* XXX: I read somewhere you can deauth all the stations with 	 * a single broadcast.  Maybe try that someday. 	 */
name|s
operator|=
name|splimp
argument_list|()
expr_stmt|;
name|sta
operator|=
name|LIST_FIRST
argument_list|(
operator|&
name|whi
operator|->
name|sta_list
argument_list|)
expr_stmt|;
while|while
condition|(
name|sta
condition|)
block|{
name|untimeout
argument_list|(
name|wihap_sta_timeout
argument_list|,
name|sta
argument_list|,
name|sta
operator|->
name|tmo
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sc
operator|->
name|wi_gone
condition|)
block|{
comment|/* Disassociate station. */
if|if
condition|(
name|sta
operator|->
name|flags
operator|&
name|WI_SIFLAGS_ASSOC
condition|)
name|wihap_sta_disassoc
argument_list|(
name|sc
argument_list|,
name|sta
argument_list|,
name|IEEE80211_REASON_ASSOC_LEAVE
argument_list|)
expr_stmt|;
comment|/* Deauth station. */
if|if
condition|(
name|sta
operator|->
name|flags
operator|&
name|WI_SIFLAGS_AUTHEN
condition|)
name|wihap_sta_deauth
argument_list|(
name|sc
argument_list|,
name|sta
operator|->
name|addr
argument_list|,
name|IEEE80211_REASON_AUTH_LEAVE
argument_list|)
expr_stmt|;
block|}
comment|/* Delete the structure. */
if|if
condition|(
name|sc
operator|->
name|arpcom
operator|.
name|ac_if
operator|.
name|if_flags
operator|&
name|IFF_DEBUG
condition|)
name|printf
argument_list|(
literal|"wihap_shutdown: FREE(sta=0x%x)\n"
argument_list|,
operator|(
name|int
operator|)
name|sta
argument_list|)
expr_stmt|;
name|next
operator|=
name|LIST_NEXT
argument_list|(
name|sta
argument_list|,
name|list
argument_list|)
expr_stmt|;
name|FREE
argument_list|(
name|sta
argument_list|,
name|M_HAP_STA
argument_list|)
expr_stmt|;
name|sta
operator|=
name|next
expr_stmt|;
block|}
name|whi
operator|->
name|apflags
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_comment
comment|/* sta_hash_func()  * Hash function for finding stations from ethernet address.  */
end_comment

begin_function
specifier|static
name|__inline
name|int
name|sta_hash_func
parameter_list|(
name|u_int8_t
name|addr
index|[]
parameter_list|)
block|{
return|return
operator|(
operator|(
name|addr
index|[
literal|3
index|]
operator|+
name|addr
index|[
literal|4
index|]
operator|+
name|addr
index|[
literal|5
index|]
operator|)
operator|%
name|WI_STA_HASH_SIZE
operator|)
return|;
block|}
end_function

begin_comment
comment|/* addr_cmp():  Maybe this is a faster way to compare addresses? */
end_comment

begin_function
specifier|static
name|__inline
name|int
name|addr_cmp
parameter_list|(
name|u_int8_t
name|a
index|[]
parameter_list|,
name|u_int8_t
name|b
index|[]
parameter_list|)
block|{
return|return
operator|(
operator|*
operator|(
name|u_int16_t
operator|*
operator|)
operator|(
name|a
operator|+
literal|4
operator|)
operator|==
operator|*
operator|(
name|u_int16_t
operator|*
operator|)
operator|(
name|b
operator|+
literal|4
operator|)
operator|&&
operator|*
operator|(
name|u_int32_t
operator|*
operator|)
operator|(
name|a
operator|)
operator|==
operator|*
operator|(
name|u_int32_t
operator|*
operator|)
operator|(
name|b
operator|)
operator|)
return|;
block|}
end_function

begin_function
name|void
name|wihap_sta_timeout
parameter_list|(
name|void
modifier|*
name|v
parameter_list|)
block|{
name|struct
name|wihap_sta_info
modifier|*
name|sta
init|=
name|v
decl_stmt|;
name|struct
name|wi_softc
modifier|*
name|sc
init|=
name|sta
operator|->
name|sc
decl_stmt|;
name|struct
name|wihap_info
modifier|*
name|whi
init|=
operator|&
name|sc
operator|->
name|wi_hostap_info
decl_stmt|;
name|int
name|s
decl_stmt|;
name|s
operator|=
name|splimp
argument_list|()
expr_stmt|;
if|if
condition|(
name|sta
operator|->
name|flags
operator|&
name|WI_SIFLAGS_ASSOC
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|arpcom
operator|.
name|ac_if
operator|.
name|if_flags
operator|&
name|IFF_DEBUG
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"inactivity disassoc: %6D\n"
argument_list|,
name|sta
operator|->
name|addr
argument_list|,
literal|":"
argument_list|)
expr_stmt|;
comment|/* Disassoc station. */
name|wihap_sta_disassoc
argument_list|(
name|sc
argument_list|,
name|sta
argument_list|,
name|IEEE80211_REASON_ASSOC_EXPIRE
argument_list|)
expr_stmt|;
name|sta
operator|->
name|flags
operator|&=
operator|~
name|WI_SIFLAGS_ASSOC
expr_stmt|;
name|sta
operator|->
name|tmo
operator|=
name|timeout
argument_list|(
name|wihap_sta_timeout
argument_list|,
name|sta
argument_list|,
name|hz
operator|*
name|whi
operator|->
name|inactivity_time
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sta
operator|->
name|flags
operator|&
name|WI_SIFLAGS_AUTHEN
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|arpcom
operator|.
name|ac_if
operator|.
name|if_flags
operator|&
name|IFF_DEBUG
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"inactivity disassoc: %6D\n"
argument_list|,
name|sta
operator|->
name|addr
argument_list|,
literal|":"
argument_list|)
expr_stmt|;
comment|/* Deauthenticate station. */
name|wihap_sta_deauth
argument_list|(
name|sc
argument_list|,
name|sta
operator|->
name|addr
argument_list|,
name|IEEE80211_REASON_AUTH_EXPIRE
argument_list|)
expr_stmt|;
name|sta
operator|->
name|flags
operator|&=
operator|~
name|WI_SIFLAGS_AUTHEN
expr_stmt|;
comment|/* Delete the station if it's not permanent. */
if|if
condition|(
operator|!
operator|(
name|sta
operator|->
name|flags
operator|&
name|WI_SIFLAGS_PERM
operator|)
condition|)
name|wihap_sta_delete
argument_list|(
name|sta
argument_list|)
expr_stmt|;
block|}
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* wihap_sta_delete()  * Delete a single station and free up its data structure.  */
end_comment

begin_function
specifier|static
name|void
name|wihap_sta_delete
parameter_list|(
name|struct
name|wihap_sta_info
modifier|*
name|sta
parameter_list|)
block|{
name|struct
name|wi_softc
modifier|*
name|sc
init|=
name|sta
operator|->
name|sc
decl_stmt|;
name|struct
name|wihap_info
modifier|*
name|whi
init|=
operator|&
name|sc
operator|->
name|wi_hostap_info
decl_stmt|;
name|int
name|i
init|=
name|sta
operator|->
name|asid
operator|-
literal|0xc001
decl_stmt|;
name|untimeout
argument_list|(
name|wihap_sta_timeout
argument_list|,
name|sta
argument_list|,
name|sta
operator|->
name|tmo
argument_list|)
expr_stmt|;
name|whi
operator|->
name|asid_inuse_mask
index|[
name|i
operator|>>
literal|4
index|]
operator|&=
operator|~
operator|(
literal|1UL
operator|<<
operator|(
name|i
operator|&
literal|0xf
operator|)
operator|)
expr_stmt|;
name|LIST_REMOVE
argument_list|(
name|sta
argument_list|,
name|list
argument_list|)
expr_stmt|;
name|LIST_REMOVE
argument_list|(
name|sta
argument_list|,
name|hash
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|->
name|challenge
condition|)
name|FREE
argument_list|(
name|sta
operator|->
name|challenge
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
name|FREE
argument_list|(
name|sta
argument_list|,
name|M_HAP_STA
argument_list|)
expr_stmt|;
name|whi
operator|->
name|n_stations
operator|--
expr_stmt|;
block|}
end_function

begin_comment
comment|/* wihap_sta_alloc()  *  *	Create a new station data structure and put it in the list  *	and hash table.  */
end_comment

begin_function
specifier|static
name|struct
name|wihap_sta_info
modifier|*
name|wihap_sta_alloc
parameter_list|(
name|struct
name|wi_softc
modifier|*
name|sc
parameter_list|,
name|u_int8_t
modifier|*
name|addr
parameter_list|)
block|{
name|struct
name|wihap_info
modifier|*
name|whi
init|=
operator|&
name|sc
operator|->
name|wi_hostap_info
decl_stmt|;
name|struct
name|wihap_sta_info
modifier|*
name|sta
decl_stmt|;
name|int
name|i
decl_stmt|,
name|hash
init|=
name|sta_hash_func
argument_list|(
name|addr
argument_list|)
decl_stmt|;
comment|/* Allocate structure. */
name|MALLOC
argument_list|(
name|sta
argument_list|,
expr|struct
name|wihap_sta_info
operator|*
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|wihap_sta_info
argument_list|)
argument_list|,
name|M_HAP_STA
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|bzero
argument_list|(
name|sta
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|wihap_sta_info
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Allocate an ASID. */
name|i
operator|=
name|hash
operator|<<
literal|4
expr_stmt|;
while|while
condition|(
name|whi
operator|->
name|asid_inuse_mask
index|[
name|i
operator|>>
literal|4
index|]
operator|&
operator|(
literal|1UL
operator|<<
operator|(
name|i
operator|&
literal|0xf
operator|)
operator|)
condition|)
name|i
operator|=
operator|(
name|i
operator|==
operator|(
name|WI_STA_HASH_SIZE
operator|<<
literal|4
operator|)
operator|-
literal|1
operator|)
condition|?
literal|0
else|:
operator|(
name|i
operator|+
literal|1
operator|)
expr_stmt|;
name|whi
operator|->
name|asid_inuse_mask
index|[
name|i
operator|>>
literal|4
index|]
operator||=
operator|(
literal|1UL
operator|<<
operator|(
name|i
operator|&
literal|0xf
operator|)
operator|)
expr_stmt|;
name|sta
operator|->
name|asid
operator|=
literal|0xc001
operator|+
name|i
expr_stmt|;
comment|/* Insert in list and hash list. */
name|LIST_INSERT_HEAD
argument_list|(
operator|&
name|whi
operator|->
name|sta_list
argument_list|,
name|sta
argument_list|,
name|list
argument_list|)
expr_stmt|;
name|LIST_INSERT_HEAD
argument_list|(
operator|&
name|whi
operator|->
name|sta_hash
index|[
name|hash
index|]
argument_list|,
name|sta
argument_list|,
name|hash
argument_list|)
expr_stmt|;
name|sta
operator|->
name|sc
operator|=
name|sc
expr_stmt|;
name|whi
operator|->
name|n_stations
operator|++
expr_stmt|;
name|bcopy
argument_list|(
name|addr
argument_list|,
operator|&
name|sta
operator|->
name|addr
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
return|return
operator|(
name|sta
operator|)
return|;
block|}
end_function

begin_comment
comment|/* wihap_sta_find()  *  *	Find station structure given address.  */
end_comment

begin_function
specifier|static
name|struct
name|wihap_sta_info
modifier|*
name|wihap_sta_find
parameter_list|(
name|struct
name|wihap_info
modifier|*
name|whi
parameter_list|,
name|u_int8_t
modifier|*
name|addr
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|struct
name|wihap_sta_info
modifier|*
name|sta
decl_stmt|;
name|i
operator|=
name|sta_hash_func
argument_list|(
name|addr
argument_list|)
expr_stmt|;
name|LIST_FOREACH
argument_list|(
argument|sta
argument_list|,
argument|&whi->sta_hash[i]
argument_list|,
argument|hash
argument_list|)
if|if
condition|(
name|addr_cmp
argument_list|(
name|addr
argument_list|,
name|sta
operator|->
name|addr
argument_list|)
condition|)
return|return
name|sta
return|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wihap_check_rates
parameter_list|(
name|struct
name|wihap_sta_info
modifier|*
name|sta
parameter_list|,
name|u_int8_t
name|rates
index|[]
parameter_list|,
name|int
name|rates_len
parameter_list|)
block|{
name|struct
name|wi_softc
modifier|*
name|sc
init|=
name|sta
operator|->
name|sc
decl_stmt|;
name|int
name|i
decl_stmt|;
name|sta
operator|->
name|rates
operator|=
literal|0
expr_stmt|;
name|sta
operator|->
name|tx_max_rate
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rates_len
condition|;
name|i
operator|++
control|)
switch|switch
condition|(
name|rates
index|[
name|i
index|]
operator|&
literal|0x7f
condition|)
block|{
case|case
literal|0x02
case|:
name|sta
operator|->
name|rates
operator||=
name|WI_SUPPRATES_1M
expr_stmt|;
break|break;
case|case
literal|0x04
case|:
name|sta
operator|->
name|rates
operator||=
name|WI_SUPPRATES_2M
expr_stmt|;
if|if
condition|(
name|sta
operator|->
name|tx_max_rate
operator|<
literal|1
condition|)
name|sta
operator|->
name|tx_max_rate
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|0x0b
case|:
name|sta
operator|->
name|rates
operator||=
name|WI_SUPPRATES_5M
expr_stmt|;
if|if
condition|(
name|sta
operator|->
name|tx_max_rate
operator|<
literal|2
condition|)
name|sta
operator|->
name|tx_max_rate
operator|=
literal|2
expr_stmt|;
break|break;
case|case
literal|0x16
case|:
name|sta
operator|->
name|rates
operator||=
name|WI_SUPPRATES_11M
expr_stmt|;
name|sta
operator|->
name|tx_max_rate
operator|=
literal|3
expr_stmt|;
break|break;
block|}
name|sta
operator|->
name|rates
operator|&=
name|sc
operator|->
name|wi_supprates
expr_stmt|;
name|sta
operator|->
name|tx_curr_rate
operator|=
name|sta
operator|->
name|tx_max_rate
expr_stmt|;
return|return
operator|(
name|sta
operator|->
name|rates
operator|==
literal|0
condition|?
operator|-
literal|1
else|:
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* wihap_auth_req()  *  *	Handle incoming authentication request.  Only handle OPEN  *	requests.  */
end_comment

begin_function
specifier|static
name|void
name|wihap_auth_req
parameter_list|(
name|struct
name|wi_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|wi_frame
modifier|*
name|rxfrm
parameter_list|,
name|caddr_t
name|pkt
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|struct
name|wihap_info
modifier|*
name|whi
init|=
operator|&
name|sc
operator|->
name|wi_hostap_info
decl_stmt|;
name|struct
name|wihap_sta_info
modifier|*
name|sta
decl_stmt|;
name|u_int16_t
name|algo
decl_stmt|;
name|u_int16_t
name|seq
decl_stmt|;
name|u_int16_t
name|status
decl_stmt|;
name|int
name|i
decl_stmt|,
name|challenge_len
decl_stmt|;
name|u_int8_t
name|challenge
index|[
literal|32
index|]
decl_stmt|;
name|struct
name|wi_80211_hdr
modifier|*
name|resp_hdr
decl_stmt|;
if|if
condition|(
name|len
operator|<
literal|6
condition|)
return|return;
comment|/* Break open packet. */
name|algo
operator|=
name|take_hword
argument_list|(
operator|&
name|pkt
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
name|seq
operator|=
name|take_hword
argument_list|(
operator|&
name|pkt
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
name|status
operator|=
name|take_hword
argument_list|(
operator|&
name|pkt
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
name|challenge_len
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|len
operator|>
literal|0
operator|&&
operator|(
name|challenge_len
operator|=
name|take_tlv
argument_list|(
operator|&
name|pkt
argument_list|,
operator|&
name|len
argument_list|,
name|IEEE80211_ELEMID_CHALLENGE
argument_list|,
name|challenge
argument_list|,
sizeof|sizeof
argument_list|(
name|challenge
argument_list|)
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return;
if|if
condition|(
name|sc
operator|->
name|arpcom
operator|.
name|ac_if
operator|.
name|if_flags
operator|&
name|IFF_DEBUG
condition|)
name|printf
argument_list|(
literal|"wihap_auth_req: station %6D algo=0x%x seq=0x%x\n"
argument_list|,
name|rxfrm
operator|->
name|wi_addr2
argument_list|,
literal|":"
argument_list|,
name|algo
argument_list|,
name|seq
argument_list|)
expr_stmt|;
comment|/* Find or create station info. */
name|sta
operator|=
name|wihap_sta_find
argument_list|(
name|whi
argument_list|,
name|rxfrm
operator|->
name|wi_addr2
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|==
name|NULL
condition|)
block|{
comment|/* Are we allowing new stations? 		 */
if|if
condition|(
name|whi
operator|->
name|apflags
operator|&
name|WIHAPFL_MAC_FILT
condition|)
block|{
name|status
operator|=
name|IEEE80211_STATUS_OTHER
expr_stmt|;
comment|/* XXX */
goto|goto
name|fail
goto|;
block|}
comment|/* Check for too many stations. 		 */
if|if
condition|(
name|whi
operator|->
name|n_stations
operator|>=
name|WIHAP_MAX_STATIONS
condition|)
block|{
name|status
operator|=
name|IEEE80211_STATUS_TOO_MANY_STATIONS
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|sc
operator|->
name|arpcom
operator|.
name|ac_if
operator|.
name|if_flags
operator|&
name|IFF_DEBUG
condition|)
name|printf
argument_list|(
literal|"wihap_auth_req: new station\n"
argument_list|)
expr_stmt|;
comment|/* Create new station. */
name|sta
operator|=
name|wihap_sta_alloc
argument_list|(
name|sc
argument_list|,
name|rxfrm
operator|->
name|wi_addr2
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|==
name|NULL
condition|)
block|{
comment|/* Out of memory! */
name|status
operator|=
name|IEEE80211_STATUS_TOO_MANY_STATIONS
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
block|}
comment|/* Note: it's okay to leave the station info structure around 	 * if the authen fails.  It'll be timed out eventually. 	 */
switch|switch
condition|(
name|algo
condition|)
block|{
case|case
name|IEEE80211_AUTH_ALG_OPEN
case|:
if|if
condition|(
name|sc
operator|->
name|wi_authmode
operator|!=
name|IEEE80211_AUTH_OPEN
condition|)
block|{
name|seq
operator|=
literal|2
expr_stmt|;
name|status
operator|=
name|IEEE80211_STATUS_ALG
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|seq
operator|!=
literal|1
condition|)
block|{
name|seq
operator|=
literal|2
expr_stmt|;
name|status
operator|=
name|IEEE80211_STATUS_SEQUENCE
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|challenge_len
operator|=
literal|0
expr_stmt|;
name|seq
operator|=
literal|2
expr_stmt|;
name|sta
operator|->
name|flags
operator||=
name|WI_SIFLAGS_AUTHEN
expr_stmt|;
break|break;
case|case
name|IEEE80211_AUTH_ALG_SHARED
case|:
if|if
condition|(
name|sc
operator|->
name|wi_authmode
operator|!=
name|IEEE80211_AUTH_SHARED
condition|)
block|{
name|seq
operator|=
literal|2
expr_stmt|;
name|status
operator|=
name|IEEE80211_STATUS_ALG
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
switch|switch
condition|(
name|seq
condition|)
block|{
case|case
literal|1
case|:
comment|/* Create a challenge frame. */
if|if
condition|(
operator|!
name|sta
operator|->
name|challenge
condition|)
block|{
name|MALLOC
argument_list|(
name|sta
operator|->
name|challenge
argument_list|,
name|u_int32_t
operator|*
argument_list|,
literal|128
argument_list|,
name|M_TEMP
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sta
operator|->
name|challenge
condition|)
return|return;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
name|challenge
index|[
name|i
index|]
operator|=
name|sta
operator|->
name|challenge
index|[
name|i
index|]
operator|=
name|arc4random
argument_list|()
expr_stmt|;
name|challenge_len
operator|=
literal|128
expr_stmt|;
name|seq
operator|=
literal|2
expr_stmt|;
break|break;
case|case
literal|3
case|:
if|if
condition|(
name|challenge_len
operator|!=
literal|128
operator|||
operator|!
name|sta
operator|->
name|challenge
operator|||
operator|!
operator|(
name|le16toh
argument_list|(
name|rxfrm
operator|->
name|wi_frame_ctl
argument_list|)
operator|&
name|WI_FCTL_WEP
operator|)
condition|)
block|{
name|status
operator|=
name|IEEE80211_STATUS_CHALLENGE
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|challenge_len
operator|=
literal|0
expr_stmt|;
name|seq
operator|=
literal|4
expr_stmt|;
comment|/* Check the challenge text.  (Was decrypted by 			 * the adapter.) 			 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|sta
operator|->
name|challenge
index|[
name|i
index|]
operator|!=
name|challenge
index|[
name|i
index|]
condition|)
block|{
name|status
operator|=
name|IEEE80211_STATUS_CHALLENGE
expr_stmt|;
name|FREE
argument_list|(
name|sta
operator|->
name|challenge
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
name|sta
operator|->
name|challenge
operator|=
name|NULL
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|sta
operator|->
name|flags
operator||=
name|WI_SIFLAGS_AUTHEN
expr_stmt|;
name|FREE
argument_list|(
name|sta
operator|->
name|challenge
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
name|sta
operator|->
name|challenge
operator|=
name|NULL
expr_stmt|;
break|break;
default|default:
name|seq
operator|=
literal|2
expr_stmt|;
name|status
operator|=
name|IEEE80211_STATUS_SEQUENCE
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
comment|/* switch (seq) */
break|break;
default|default:
if|if
condition|(
name|sc
operator|->
name|arpcom
operator|.
name|ac_if
operator|.
name|if_flags
operator|&
name|IFF_DEBUG
condition|)
name|printf
argument_list|(
literal|"wihap_auth_req: algorithm unsupported: 0x%x\n"
argument_list|,
name|algo
argument_list|)
expr_stmt|;
name|status
operator|=
name|IEEE80211_STATUS_ALG
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
comment|/* switch (algo) */
name|status
operator|=
name|IEEE80211_STATUS_SUCCESS
expr_stmt|;
name|fail
label|:
if|if
condition|(
name|sc
operator|->
name|arpcom
operator|.
name|ac_if
operator|.
name|if_flags
operator|&
name|IFF_DEBUG
condition|)
name|printf
argument_list|(
literal|"wihap_auth_req: returns status=0x%x\n"
argument_list|,
name|status
argument_list|)
expr_stmt|;
comment|/* Send response. */
name|resp_hdr
operator|=
operator|(
expr|struct
name|wi_80211_hdr
operator|*
operator|)
name|sc
operator|->
name|wi_txbuf
expr_stmt|;
name|bzero
argument_list|(
name|resp_hdr
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|wi_80211_hdr
argument_list|)
argument_list|)
expr_stmt|;
name|resp_hdr
operator|->
name|frame_ctl
operator|=
name|htole16
argument_list|(
name|WI_FTYPE_MGMT
operator||
name|WI_STYPE_MGMT_AUTH
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|rxfrm
operator|->
name|wi_addr2
argument_list|,
name|resp_hdr
operator|->
name|addr1
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|sc
operator|->
name|arpcom
operator|.
name|ac_enaddr
argument_list|,
name|resp_hdr
operator|->
name|addr2
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|sc
operator|->
name|arpcom
operator|.
name|ac_enaddr
argument_list|,
name|resp_hdr
operator|->
name|addr3
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|pkt
operator|=
operator|&
name|sc
operator|->
name|wi_txbuf
index|[
sizeof|sizeof
argument_list|(
expr|struct
name|wi_80211_hdr
argument_list|)
index|]
expr_stmt|;
name|put_hword
argument_list|(
operator|&
name|pkt
argument_list|,
name|algo
argument_list|)
expr_stmt|;
name|put_hword
argument_list|(
operator|&
name|pkt
argument_list|,
name|seq
argument_list|)
expr_stmt|;
name|put_hword
argument_list|(
operator|&
name|pkt
argument_list|,
name|status
argument_list|)
expr_stmt|;
if|if
condition|(
name|challenge_len
operator|>
literal|0
condition|)
name|put_tlv
argument_list|(
operator|&
name|pkt
argument_list|,
name|IEEE80211_ELEMID_CHALLENGE
argument_list|,
name|challenge
argument_list|,
name|challenge_len
argument_list|)
expr_stmt|;
name|wi_mgmt_xmit
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|wi_txbuf
argument_list|,
literal|6
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|wi_80211_hdr
argument_list|)
operator|+
operator|(
name|challenge_len
operator|>
literal|0
condition|?
name|challenge_len
operator|+
literal|2
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* wihap_assoc_req()  *  *	Handle incoming association and reassociation requests.  */
end_comment

begin_function
specifier|static
name|void
name|wihap_assoc_req
parameter_list|(
name|struct
name|wi_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|wi_frame
modifier|*
name|rxfrm
parameter_list|,
name|caddr_t
name|pkt
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|struct
name|wihap_info
modifier|*
name|whi
init|=
operator|&
name|sc
operator|->
name|wi_hostap_info
decl_stmt|;
name|struct
name|wihap_sta_info
modifier|*
name|sta
decl_stmt|;
name|struct
name|wi_80211_hdr
modifier|*
name|resp_hdr
decl_stmt|;
name|u_int16_t
name|capinfo
decl_stmt|;
name|u_int16_t
name|lstintvl
decl_stmt|;
name|u_int8_t
name|rates
index|[
literal|8
index|]
decl_stmt|;
name|int
name|ssid_len
decl_stmt|,
name|rates_len
decl_stmt|;
name|char
name|ssid
index|[
literal|33
index|]
decl_stmt|;
name|u_int16_t
name|status
decl_stmt|;
name|u_int16_t
name|asid
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|len
operator|<
literal|8
condition|)
return|return;
comment|/* Pull out request parameters. */
name|capinfo
operator|=
name|take_hword
argument_list|(
operator|&
name|pkt
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
name|lstintvl
operator|=
name|take_hword
argument_list|(
operator|&
name|pkt
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ssid_len
operator|=
name|take_tlv
argument_list|(
operator|&
name|pkt
argument_list|,
operator|&
name|len
argument_list|,
name|IEEE80211_ELEMID_SSID
argument_list|,
name|ssid
argument_list|,
sizeof|sizeof
argument_list|(
name|ssid
argument_list|)
operator|-
literal|1
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return;
name|ssid
index|[
name|ssid_len
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|(
name|rates_len
operator|=
name|take_tlv
argument_list|(
operator|&
name|pkt
argument_list|,
operator|&
name|len
argument_list|,
name|IEEE80211_ELEMID_RATES
argument_list|,
name|rates
argument_list|,
sizeof|sizeof
argument_list|(
name|rates
argument_list|)
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return;
if|if
condition|(
operator|(
name|rxfrm
operator|->
name|wi_frame_ctl
operator|&
name|htole16
argument_list|(
name|WI_FCTL_STYPE
argument_list|)
operator|)
operator|==
name|htole16
argument_list|(
name|WI_STYPE_MGMT_REASREQ
argument_list|)
condition|)
block|{
comment|/* Reassociation Request-- * Current AP.  (Ignore?) */
if|if
condition|(
name|len
operator|<
literal|6
condition|)
return|return;
block|}
if|if
condition|(
name|sc
operator|->
name|arpcom
operator|.
name|ac_if
operator|.
name|if_flags
operator|&
name|IFF_DEBUG
condition|)
name|printf
argument_list|(
literal|"wihap_assoc_req: from station %6D\n"
argument_list|,
name|rxfrm
operator|->
name|wi_addr2
argument_list|,
literal|":"
argument_list|)
expr_stmt|;
comment|/* If SSID doesn't match, simply drop. */
if|if
condition|(
name|strcmp
argument_list|(
name|sc
operator|->
name|wi_net_name
argument_list|,
name|ssid
argument_list|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|arpcom
operator|.
name|ac_if
operator|.
name|if_flags
operator|&
name|IFF_DEBUG
condition|)
name|printf
argument_list|(
literal|"wihap_assoc_req: bad ssid: '%s' != '%s'\n"
argument_list|,
name|ssid
argument_list|,
name|sc
operator|->
name|wi_net_name
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Is this station authenticated yet? */
name|sta
operator|=
name|wihap_sta_find
argument_list|(
name|whi
argument_list|,
name|rxfrm
operator|->
name|wi_addr2
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|==
name|NULL
operator|||
operator|!
operator|(
name|sta
operator|->
name|flags
operator|&
name|WI_SIFLAGS_AUTHEN
operator|)
condition|)
block|{
name|wihap_sta_deauth
argument_list|(
name|sc
argument_list|,
name|rxfrm
operator|->
name|wi_addr2
argument_list|,
name|IEEE80211_REASON_NOT_AUTHED
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Check supported rates against ours. */
if|if
condition|(
name|wihap_check_rates
argument_list|(
name|sta
argument_list|,
name|rates
argument_list|,
name|rates_len
argument_list|)
operator|<
literal|0
condition|)
block|{
name|status
operator|=
name|IEEE80211_STATUS_RATES
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
comment|/* Check capinfo. 	 * Check for ESS, not IBSS. 	 * Check WEP/PRIVACY flags match. 	 * Refuse stations requesting to be put on CF-polling list. 	 */
name|sta
operator|->
name|capinfo
operator|=
name|capinfo
expr_stmt|;
name|status
operator|=
name|IEEE80211_STATUS_CAPINFO
expr_stmt|;
if|if
condition|(
operator|(
name|capinfo
operator|&
operator|(
name|IEEE80211_CAPINFO_ESS
operator||
name|IEEE80211_CAPINFO_IBSS
operator|)
operator|)
operator|!=
name|IEEE80211_CAPINFO_ESS
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|arpcom
operator|.
name|ac_if
operator|.
name|if_flags
operator|&
name|IFF_DEBUG
condition|)
name|printf
argument_list|(
literal|"wihap_assoc_req: capinfo mismatch: "
literal|"client using IBSS mode\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
operator|(
name|sc
operator|->
name|wi_use_wep
operator|&&
operator|!
operator|(
name|capinfo
operator|&
name|IEEE80211_CAPINFO_PRIVACY
operator|)
operator|)
operator|||
operator|(
operator|!
name|sc
operator|->
name|wi_use_wep
operator|&&
operator|(
name|capinfo
operator|&
name|IEEE80211_CAPINFO_PRIVACY
operator|)
operator|)
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|arpcom
operator|.
name|ac_if
operator|.
name|if_flags
operator|&
name|IFF_DEBUG
condition|)
name|printf
argument_list|(
literal|"wihap_assoc_req: capinfo mismatch: client "
literal|"%susing WEP\n"
argument_list|,
name|sc
operator|->
name|wi_use_wep
condition|?
literal|"not "
else|:
literal|""
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
operator|(
name|capinfo
operator|&
operator|(
name|IEEE80211_CAPINFO_CF_POLLABLE
operator||
name|IEEE80211_CAPINFO_CF_POLLREQ
operator|)
operator|)
operator|==
name|IEEE80211_CAPINFO_CF_POLLABLE
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|arpcom
operator|.
name|ac_if
operator|.
name|if_flags
operator|&
name|IFF_DEBUG
condition|)
name|printf
argument_list|(
literal|"wihap_assoc_req: capinfo mismatch: "
literal|"client requested CF polling\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
comment|/* Use ASID is allocated by whi_sta_alloc(). */
name|asid
operator|=
name|sta
operator|->
name|asid
expr_stmt|;
if|if
condition|(
name|sta
operator|->
name|flags
operator|&
name|WI_SIFLAGS_ASSOC
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|arpcom
operator|.
name|ac_if
operator|.
name|if_flags
operator|&
name|IFF_DEBUG
condition|)
name|printf
argument_list|(
literal|"wihap_assoc_req: already assoc'ed?\n"
argument_list|)
expr_stmt|;
block|}
name|sta
operator|->
name|flags
operator||=
name|WI_SIFLAGS_ASSOC
expr_stmt|;
name|sta
operator|->
name|inactivity_timer
operator|=
name|whi
operator|->
name|inactivity_time
expr_stmt|;
name|status
operator|=
name|IEEE80211_STATUS_SUCCESS
expr_stmt|;
name|fail
label|:
if|if
condition|(
name|sc
operator|->
name|arpcom
operator|.
name|ac_if
operator|.
name|if_flags
operator|&
name|IFF_DEBUG
condition|)
name|printf
argument_list|(
literal|"wihap_assoc_req: returns status=0x%x\n"
argument_list|,
name|status
argument_list|)
expr_stmt|;
comment|/* Send response. */
name|resp_hdr
operator|=
operator|(
expr|struct
name|wi_80211_hdr
operator|*
operator|)
name|sc
operator|->
name|wi_txbuf
expr_stmt|;
name|bzero
argument_list|(
name|resp_hdr
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|wi_80211_hdr
argument_list|)
argument_list|)
expr_stmt|;
name|resp_hdr
operator|->
name|frame_ctl
operator|=
name|htole16
argument_list|(
name|WI_FTYPE_MGMT
operator||
name|WI_STYPE_MGMT_ASRESP
argument_list|)
expr_stmt|;
name|pkt
operator|=
name|sc
operator|->
name|wi_txbuf
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|wi_80211_hdr
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|rxfrm
operator|->
name|wi_addr2
argument_list|,
name|resp_hdr
operator|->
name|addr1
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|sc
operator|->
name|arpcom
operator|.
name|ac_enaddr
argument_list|,
name|resp_hdr
operator|->
name|addr2
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|sc
operator|->
name|arpcom
operator|.
name|ac_enaddr
argument_list|,
name|resp_hdr
operator|->
name|addr3
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|put_hword
argument_list|(
operator|&
name|pkt
argument_list|,
name|capinfo
argument_list|)
expr_stmt|;
name|put_hword
argument_list|(
operator|&
name|pkt
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|put_hword
argument_list|(
operator|&
name|pkt
argument_list|,
name|asid
argument_list|)
expr_stmt|;
name|rates_len
operator|=
name|put_rates
argument_list|(
operator|&
name|pkt
argument_list|,
name|sc
operator|->
name|wi_supprates
argument_list|)
expr_stmt|;
name|wi_mgmt_xmit
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|wi_txbuf
argument_list|,
literal|8
operator|+
name|rates_len
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|wi_80211_hdr
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* wihap_deauth_req()  *  *	Handle deauthentication requests.  Delete the station.  */
end_comment

begin_function
specifier|static
name|void
name|wihap_deauth_req
parameter_list|(
name|struct
name|wi_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|wi_frame
modifier|*
name|rxfrm
parameter_list|,
name|caddr_t
name|pkt
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|struct
name|wihap_info
modifier|*
name|whi
init|=
operator|&
name|sc
operator|->
name|wi_hostap_info
decl_stmt|;
name|struct
name|wihap_sta_info
modifier|*
name|sta
decl_stmt|;
name|u_int16_t
name|reason
decl_stmt|;
if|if
condition|(
name|len
operator|<
literal|2
condition|)
return|return;
name|reason
operator|=
name|take_hword
argument_list|(
operator|&
name|pkt
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
name|sta
operator|=
name|wihap_sta_find
argument_list|(
name|whi
argument_list|,
name|rxfrm
operator|->
name|wi_addr2
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|arpcom
operator|.
name|ac_if
operator|.
name|if_flags
operator|&
name|IFF_DEBUG
condition|)
name|printf
argument_list|(
literal|"wihap_deauth_req: unknown station: 6D\n"
argument_list|,
name|rxfrm
operator|->
name|wi_addr2
argument_list|,
literal|":"
argument_list|)
expr_stmt|;
block|}
else|else
name|wihap_sta_delete
argument_list|(
name|sta
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* wihap_disassoc_req()  *  *	Handle disassociation requests.  Just reset the assoc flag.  *	We'll free up the station resources when we get a deauth  *	request or when it times out.  */
end_comment

begin_function
specifier|static
name|void
name|wihap_disassoc_req
parameter_list|(
name|struct
name|wi_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|wi_frame
modifier|*
name|rxfrm
parameter_list|,
name|caddr_t
name|pkt
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|struct
name|wihap_info
modifier|*
name|whi
init|=
operator|&
name|sc
operator|->
name|wi_hostap_info
decl_stmt|;
name|struct
name|wihap_sta_info
modifier|*
name|sta
decl_stmt|;
name|u_int16_t
name|reason
decl_stmt|;
if|if
condition|(
name|len
operator|<
literal|2
condition|)
return|return;
name|reason
operator|=
name|take_hword
argument_list|(
operator|&
name|pkt
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
name|sta
operator|=
name|wihap_sta_find
argument_list|(
name|whi
argument_list|,
name|rxfrm
operator|->
name|wi_addr2
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|arpcom
operator|.
name|ac_if
operator|.
name|if_flags
operator|&
name|IFF_DEBUG
condition|)
name|printf
argument_list|(
literal|"wihap_disassoc_req: unknown station: 6D\n"
argument_list|,
name|rxfrm
operator|->
name|wi_addr2
argument_list|,
literal|":"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
operator|(
name|sta
operator|->
name|flags
operator|&
name|WI_SIFLAGS_AUTHEN
operator|)
condition|)
block|{
comment|/* 		 * If station is not authenticated, send deauthentication 		 * frame. 		 */
name|wihap_sta_deauth
argument_list|(
name|sc
argument_list|,
name|rxfrm
operator|->
name|wi_addr2
argument_list|,
name|IEEE80211_REASON_NOT_AUTHED
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
name|sta
operator|->
name|flags
operator|&=
operator|~
name|WI_SIFLAGS_ASSOC
expr_stmt|;
block|}
end_function

begin_comment
comment|/* wihap_debug_frame_type()  *  * Print out frame type.  Used in early debugging.  */
end_comment

begin_function
specifier|static
name|__inline
name|void
name|wihap_debug_frame_type
parameter_list|(
name|struct
name|wi_frame
modifier|*
name|rxfrm
parameter_list|)
block|{
name|printf
argument_list|(
literal|"wihap_mgmt_input: len=%d "
argument_list|,
name|le16toh
argument_list|(
name|rxfrm
operator|->
name|wi_dat_len
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rxfrm
operator|->
name|wi_frame_ctl
operator|&
name|htole16
argument_list|(
name|WI_FCTL_FTYPE
argument_list|)
operator|)
operator|==
name|htole16
argument_list|(
name|WI_FTYPE_MGMT
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"MGMT: "
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|le16toh
argument_list|(
name|rxfrm
operator|->
name|wi_frame_ctl
argument_list|)
operator|&
name|WI_FCTL_STYPE
condition|)
block|{
case|case
name|WI_STYPE_MGMT_ASREQ
case|:
name|printf
argument_list|(
literal|"assoc req: \n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|WI_STYPE_MGMT_ASRESP
case|:
name|printf
argument_list|(
literal|"assoc resp: \n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|WI_STYPE_MGMT_REASREQ
case|:
name|printf
argument_list|(
literal|"reassoc req: \n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|WI_STYPE_MGMT_REASRESP
case|:
name|printf
argument_list|(
literal|"reassoc resp: \n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|WI_STYPE_MGMT_PROBEREQ
case|:
name|printf
argument_list|(
literal|"probe req: \n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|WI_STYPE_MGMT_PROBERESP
case|:
name|printf
argument_list|(
literal|"probe resp: \n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|WI_STYPE_MGMT_BEACON
case|:
name|printf
argument_list|(
literal|"beacon: \n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|WI_STYPE_MGMT_ATIM
case|:
name|printf
argument_list|(
literal|"ann traf ind \n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|WI_STYPE_MGMT_DISAS
case|:
name|printf
argument_list|(
literal|"disassociation: \n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|WI_STYPE_MGMT_AUTH
case|:
name|printf
argument_list|(
literal|"auth: \n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|WI_STYPE_MGMT_DEAUTH
case|:
name|printf
argument_list|(
literal|"deauth: \n"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"unknown (stype=0x%x)\n"
argument_list|,
name|le16toh
argument_list|(
name|rxfrm
operator|->
name|wi_frame_ctl
argument_list|)
operator|&
name|WI_FCTL_STYPE
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|printf
argument_list|(
literal|"ftype=0x%x (ctl=0x%x)\n"
argument_list|,
name|le16toh
argument_list|(
name|rxfrm
operator|->
name|wi_frame_ctl
argument_list|)
operator|&
name|WI_FCTL_FTYPE
argument_list|,
name|le16toh
argument_list|(
name|rxfrm
operator|->
name|wi_frame_ctl
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* wihap_mgmt_input:  *  *	Called for each management frame received in host ap mode.  *	wihap_mgmt_input() is expected to free the mbuf.  */
end_comment

begin_function
name|void
name|wihap_mgmt_input
parameter_list|(
name|struct
name|wi_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|wi_frame
modifier|*
name|rxfrm
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|)
block|{
name|caddr_t
name|pkt
decl_stmt|;
name|int
name|s
decl_stmt|,
name|len
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|arpcom
operator|.
name|ac_if
operator|.
name|if_flags
operator|&
name|IFF_DEBUG
condition|)
name|wihap_debug_frame_type
argument_list|(
name|rxfrm
argument_list|)
expr_stmt|;
name|pkt
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
name|caddr_t
argument_list|)
operator|+
name|WI_802_11_OFFSET_RAW
expr_stmt|;
name|len
operator|=
name|m
operator|->
name|m_len
operator|-
name|WI_802_11_OFFSET_RAW
expr_stmt|;
if|if
condition|(
operator|(
name|rxfrm
operator|->
name|wi_frame_ctl
operator|&
name|htole16
argument_list|(
name|WI_FCTL_FTYPE
argument_list|)
operator|)
operator|==
name|htole16
argument_list|(
name|WI_FTYPE_MGMT
argument_list|)
condition|)
block|{
comment|/* any of the following will mess w/ the station list */
name|s
operator|=
name|splsoftclock
argument_list|()
expr_stmt|;
switch|switch
condition|(
name|le16toh
argument_list|(
name|rxfrm
operator|->
name|wi_frame_ctl
argument_list|)
operator|&
name|WI_FCTL_STYPE
condition|)
block|{
case|case
name|WI_STYPE_MGMT_ASREQ
case|:
name|wihap_assoc_req
argument_list|(
name|sc
argument_list|,
name|rxfrm
argument_list|,
name|pkt
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|WI_STYPE_MGMT_ASRESP
case|:
break|break;
case|case
name|WI_STYPE_MGMT_REASREQ
case|:
name|wihap_assoc_req
argument_list|(
name|sc
argument_list|,
name|rxfrm
argument_list|,
name|pkt
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|WI_STYPE_MGMT_REASRESP
case|:
break|break;
case|case
name|WI_STYPE_MGMT_PROBEREQ
case|:
break|break;
case|case
name|WI_STYPE_MGMT_PROBERESP
case|:
break|break;
case|case
name|WI_STYPE_MGMT_BEACON
case|:
break|break;
case|case
name|WI_STYPE_MGMT_ATIM
case|:
break|break;
case|case
name|WI_STYPE_MGMT_DISAS
case|:
name|wihap_disassoc_req
argument_list|(
name|sc
argument_list|,
name|rxfrm
argument_list|,
name|pkt
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|WI_STYPE_MGMT_AUTH
case|:
name|wihap_auth_req
argument_list|(
name|sc
argument_list|,
name|rxfrm
argument_list|,
name|pkt
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|WI_STYPE_MGMT_DEAUTH
case|:
name|wihap_deauth_req
argument_list|(
name|sc
argument_list|,
name|rxfrm
argument_list|,
name|pkt
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
block|}
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* wihap_sta_is_assoc()  *  *	Determine if a station is assoc'ed.  Update its activity  *	counter as a side-effect.  */
end_comment

begin_function
specifier|static
name|int
name|wihap_sta_is_assoc
parameter_list|(
name|struct
name|wihap_info
modifier|*
name|whi
parameter_list|,
name|u_int8_t
name|addr
index|[]
parameter_list|)
block|{
name|struct
name|wihap_sta_info
modifier|*
name|sta
decl_stmt|;
name|sta
operator|=
name|wihap_sta_find
argument_list|(
name|whi
argument_list|,
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|!=
name|NULL
operator|&&
operator|(
name|sta
operator|->
name|flags
operator|&
name|WI_SIFLAGS_ASSOC
operator|)
condition|)
block|{
comment|/* Keep it active. */
name|untimeout
argument_list|(
name|wihap_sta_timeout
argument_list|,
name|sta
argument_list|,
name|sta
operator|->
name|tmo
argument_list|)
expr_stmt|;
name|sta
operator|->
name|tmo
operator|=
name|timeout
argument_list|(
name|wihap_sta_timeout
argument_list|,
name|sta
argument_list|,
name|hz
operator|*
name|whi
operator|->
name|inactivity_time
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
else|else
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* wihap_check_tx()  *  *	Determine if a station is assoc'ed, get its tx rate, and update  *	its activity.  */
end_comment

begin_function
name|int
name|wihap_check_tx
parameter_list|(
name|struct
name|wihap_info
modifier|*
name|whi
parameter_list|,
name|u_int8_t
name|addr
index|[]
parameter_list|,
name|u_int8_t
modifier|*
name|txrate
parameter_list|)
block|{
name|struct
name|wihap_sta_info
modifier|*
name|sta
decl_stmt|;
specifier|static
name|u_int8_t
name|txratetable
index|[]
init|=
block|{
literal|10
block|,
literal|20
block|,
literal|55
block|,
literal|110
block|}
decl_stmt|;
name|int
name|s
decl_stmt|;
name|s
operator|=
name|splclock
argument_list|()
expr_stmt|;
if|if
condition|(
name|addr
index|[
literal|0
index|]
operator|&
literal|0x01
condition|)
block|{
operator|*
name|txrate
operator|=
literal|0
expr_stmt|;
comment|/* XXX: multicast rate? */
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|sta
operator|=
name|wihap_sta_find
argument_list|(
name|whi
argument_list|,
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|!=
name|NULL
operator|&&
operator|(
name|sta
operator|->
name|flags
operator|&
name|WI_SIFLAGS_ASSOC
operator|)
condition|)
block|{
comment|/* Keep it active. */
name|untimeout
argument_list|(
name|wihap_sta_timeout
argument_list|,
name|sta
argument_list|,
name|sta
operator|->
name|tmo
argument_list|)
expr_stmt|;
name|sta
operator|->
name|tmo
operator|=
name|timeout
argument_list|(
name|wihap_sta_timeout
argument_list|,
name|sta
argument_list|,
name|hz
operator|*
name|whi
operator|->
name|inactivity_time
argument_list|)
expr_stmt|;
operator|*
name|txrate
operator|=
name|txratetable
index|[
name|sta
operator|->
name|tx_curr_rate
index|]
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * wihap_data_input()  *  *	Handle all data input on interface when in Host AP mode.  *	Some packets are destined for this machine, others are  *	repeated to other stations.  *  *	If wihap_data_input() returns a non-zero, it has processed  *	the packet and will free the mbuf.  */
end_comment

begin_function
name|int
name|wihap_data_input
parameter_list|(
name|struct
name|wi_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|wi_frame
modifier|*
name|rxfrm
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
operator|&
name|sc
operator|->
name|arpcom
operator|.
name|ac_if
decl_stmt|;
name|struct
name|wihap_info
modifier|*
name|whi
init|=
operator|&
name|sc
operator|->
name|wi_hostap_info
decl_stmt|;
name|struct
name|wihap_sta_info
modifier|*
name|sta
decl_stmt|;
name|int
name|mcast
decl_stmt|,
name|s
decl_stmt|;
comment|/* TODS flag must be set. */
if|if
condition|(
operator|!
operator|(
name|rxfrm
operator|->
name|wi_frame_ctl
operator|&
name|htole16
argument_list|(
name|WI_FCTL_TODS
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_DEBUG
condition|)
name|printf
argument_list|(
literal|"wihap_data_input: no TODS src=%6D\n"
argument_list|,
name|rxfrm
operator|->
name|wi_addr2
argument_list|,
literal|":"
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
comment|/* Check BSSID. (Is this necessary?) */
if|if
condition|(
operator|!
name|addr_cmp
argument_list|(
name|rxfrm
operator|->
name|wi_addr1
argument_list|,
name|sc
operator|->
name|arpcom
operator|.
name|ac_enaddr
argument_list|)
condition|)
block|{
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_DEBUG
condition|)
name|printf
argument_list|(
literal|"wihap_data_input: incorrect bss: %6D\n"
argument_list|,
name|rxfrm
operator|->
name|wi_addr1
argument_list|,
literal|":"
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|s
operator|=
name|splsoftclock
argument_list|()
expr_stmt|;
comment|/* Find source station. */
name|sta
operator|=
name|wihap_sta_find
argument_list|(
name|whi
argument_list|,
name|rxfrm
operator|->
name|wi_addr2
argument_list|)
expr_stmt|;
comment|/* Source station must be associated. */
if|if
condition|(
name|sta
operator|==
name|NULL
operator|||
operator|!
operator|(
name|sta
operator|->
name|flags
operator|&
name|WI_SIFLAGS_ASSOC
operator|)
condition|)
block|{
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_DEBUG
condition|)
name|printf
argument_list|(
literal|"wihap_data_input: dropping unassoc src %6D\n"
argument_list|,
name|rxfrm
operator|->
name|wi_addr2
argument_list|,
literal|":"
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|untimeout
argument_list|(
name|wihap_sta_timeout
argument_list|,
name|sta
argument_list|,
name|sta
operator|->
name|tmo
argument_list|)
expr_stmt|;
name|sta
operator|->
name|tmo
operator|=
name|timeout
argument_list|(
name|wihap_sta_timeout
argument_list|,
name|sta
argument_list|,
name|hz
operator|*
name|whi
operator|->
name|inactivity_time
argument_list|)
expr_stmt|;
name|sta
operator|->
name|sig_info
operator|=
name|le16toh
argument_list|(
name|rxfrm
operator|->
name|wi_q_info
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
comment|/* Repeat this packet to BSS? */
name|mcast
operator|=
operator|(
name|rxfrm
operator|->
name|wi_addr3
index|[
literal|0
index|]
operator|&
literal|0x01
operator|)
operator|!=
literal|0
expr_stmt|;
if|if
condition|(
name|mcast
operator|||
name|wihap_sta_is_assoc
argument_list|(
name|whi
argument_list|,
name|rxfrm
operator|->
name|wi_addr3
argument_list|)
condition|)
block|{
comment|/* If it's multicast, make a copy. 		 */
if|if
condition|(
name|mcast
condition|)
block|{
name|m
operator|=
name|m_copym
argument_list|(
name|m
argument_list|,
literal|0
argument_list|,
name|M_COPYALL
argument_list|,
name|M_DONTWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|m
operator|->
name|m_flags
operator||=
name|M_MCAST
expr_stmt|;
comment|/* XXX */
block|}
comment|/* Queue up for repeating. 		 */
name|IF_HANDOFF
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|,
name|m
argument_list|,
name|ifp
argument_list|)
expr_stmt|;
return|return
operator|(
operator|!
name|mcast
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* wihap_ioctl()  *  *	Handle Host AP specific ioctls.  Called from wi_ioctl().  */
end_comment

begin_function
name|int
name|wihap_ioctl
parameter_list|(
name|struct
name|wi_softc
modifier|*
name|sc
parameter_list|,
name|u_long
name|command
parameter_list|,
name|caddr_t
name|data
parameter_list|)
block|{
name|struct
name|ifreq
modifier|*
name|ifr
init|=
operator|(
expr|struct
name|ifreq
operator|*
operator|)
name|data
decl_stmt|;
name|struct
name|wihap_info
modifier|*
name|whi
init|=
operator|&
name|sc
operator|->
name|wi_hostap_info
decl_stmt|;
name|struct
name|wihap_sta_info
modifier|*
name|sta
decl_stmt|;
name|struct
name|hostap_getall
name|reqall
decl_stmt|;
name|struct
name|hostap_sta
name|reqsta
decl_stmt|;
name|struct
name|hostap_sta
name|stabuf
decl_stmt|;
name|int
name|s
decl_stmt|,
name|error
init|=
literal|0
decl_stmt|,
name|n
decl_stmt|,
name|flag
decl_stmt|;
if|#
directive|if
name|__FreeBSD_version
operator|>=
literal|500000
name|struct
name|thread
modifier|*
name|td
init|=
name|curthread
decl_stmt|;
else|#
directive|else
name|struct
name|proc
modifier|*
name|td
init|=
name|curproc
decl_stmt|;
comment|/* Little white lie */
endif|#
directive|endif
if|if
condition|(
operator|!
operator|(
name|sc
operator|->
name|arpcom
operator|.
name|ac_if
operator|.
name|if_flags
operator|&
name|IFF_RUNNING
operator|)
condition|)
return|return
name|ENODEV
return|;
switch|switch
condition|(
name|command
condition|)
block|{
case|case
name|SIOCHOSTAP_DEL
case|:
if|if
condition|(
operator|(
name|error
operator|=
name|suser
argument_list|(
name|td
argument_list|)
operator|)
condition|)
break|break;
if|if
condition|(
operator|(
name|error
operator|=
name|copyin
argument_list|(
name|ifr
operator|->
name|ifr_data
argument_list|,
operator|&
name|reqsta
argument_list|,
sizeof|sizeof
argument_list|(
name|reqsta
argument_list|)
argument_list|)
operator|)
condition|)
break|break;
name|s
operator|=
name|splimp
argument_list|()
expr_stmt|;
name|sta
operator|=
name|wihap_sta_find
argument_list|(
name|whi
argument_list|,
name|reqsta
operator|.
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|==
name|NULL
condition|)
name|error
operator|=
name|ENOENT
expr_stmt|;
else|else
block|{
comment|/* Disassociate station. */
if|if
condition|(
name|sta
operator|->
name|flags
operator|&
name|WI_SIFLAGS_ASSOC
condition|)
name|wihap_sta_disassoc
argument_list|(
name|sc
argument_list|,
name|sta
argument_list|,
name|IEEE80211_REASON_ASSOC_LEAVE
argument_list|)
expr_stmt|;
comment|/* Deauth station. */
if|if
condition|(
name|sta
operator|->
name|flags
operator|&
name|WI_SIFLAGS_AUTHEN
condition|)
name|wihap_sta_deauth
argument_list|(
name|sc
argument_list|,
name|sta
operator|->
name|addr
argument_list|,
name|IEEE80211_REASON_AUTH_LEAVE
argument_list|)
expr_stmt|;
name|wihap_sta_delete
argument_list|(
name|sta
argument_list|)
expr_stmt|;
block|}
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCHOSTAP_GET
case|:
if|if
condition|(
operator|(
name|error
operator|=
name|copyin
argument_list|(
name|ifr
operator|->
name|ifr_data
argument_list|,
operator|&
name|reqsta
argument_list|,
sizeof|sizeof
argument_list|(
name|reqsta
argument_list|)
argument_list|)
operator|)
condition|)
break|break;
name|s
operator|=
name|splimp
argument_list|()
expr_stmt|;
name|sta
operator|=
name|wihap_sta_find
argument_list|(
name|whi
argument_list|,
name|reqsta
operator|.
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|==
name|NULL
condition|)
name|error
operator|=
name|ENOENT
expr_stmt|;
else|else
block|{
name|reqsta
operator|.
name|flags
operator|=
name|sta
operator|->
name|flags
expr_stmt|;
name|reqsta
operator|.
name|asid
operator|=
name|sta
operator|->
name|asid
expr_stmt|;
name|reqsta
operator|.
name|capinfo
operator|=
name|sta
operator|->
name|capinfo
expr_stmt|;
name|reqsta
operator|.
name|sig_info
operator|=
name|sta
operator|->
name|sig_info
expr_stmt|;
name|reqsta
operator|.
name|rates
operator|=
name|sta
operator|->
name|rates
expr_stmt|;
name|error
operator|=
name|copyout
argument_list|(
operator|&
name|reqsta
argument_list|,
name|ifr
operator|->
name|ifr_data
argument_list|,
sizeof|sizeof
argument_list|(
name|reqsta
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCHOSTAP_ADD
case|:
if|if
condition|(
operator|(
name|error
operator|=
name|suser
argument_list|(
name|td
argument_list|)
operator|)
condition|)
break|break;
if|if
condition|(
operator|(
name|error
operator|=
name|copyin
argument_list|(
name|ifr
operator|->
name|ifr_data
argument_list|,
operator|&
name|reqsta
argument_list|,
sizeof|sizeof
argument_list|(
name|reqsta
argument_list|)
argument_list|)
operator|)
condition|)
break|break;
name|s
operator|=
name|splimp
argument_list|()
expr_stmt|;
name|sta
operator|=
name|wihap_sta_find
argument_list|(
name|whi
argument_list|,
name|reqsta
operator|.
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|!=
name|NULL
condition|)
block|{
name|error
operator|=
name|EEXIST
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|whi
operator|->
name|n_stations
operator|>=
name|WIHAP_MAX_STATIONS
condition|)
block|{
name|error
operator|=
name|ENOSPC
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
break|break;
block|}
name|sta
operator|=
name|wihap_sta_alloc
argument_list|(
name|sc
argument_list|,
name|reqsta
operator|.
name|addr
argument_list|)
expr_stmt|;
name|sta
operator|->
name|flags
operator|=
name|reqsta
operator|.
name|flags
expr_stmt|;
name|sta
operator|->
name|tmo
operator|=
name|timeout
argument_list|(
name|wihap_sta_timeout
argument_list|,
name|sta
argument_list|,
name|hz
operator|*
name|whi
operator|->
name|inactivity_time
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCHOSTAP_SFLAGS
case|:
if|if
condition|(
operator|(
name|error
operator|=
name|suser
argument_list|(
name|td
argument_list|)
operator|)
condition|)
break|break;
if|if
condition|(
operator|(
name|error
operator|=
name|copyin
argument_list|(
name|ifr
operator|->
name|ifr_data
argument_list|,
operator|&
name|flag
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
operator|)
condition|)
break|break;
name|whi
operator|->
name|apflags
operator|=
operator|(
name|whi
operator|->
name|apflags
operator|&
name|WIHAPFL_CANTCHANGE
operator|)
operator||
operator|(
name|flag
operator|&
operator|~
name|WIHAPFL_CANTCHANGE
operator|)
expr_stmt|;
break|break;
case|case
name|SIOCHOSTAP_GFLAGS
case|:
name|flag
operator|=
operator|(
name|int
operator|)
name|whi
operator|->
name|apflags
expr_stmt|;
name|error
operator|=
name|copyout
argument_list|(
operator|&
name|flag
argument_list|,
name|ifr
operator|->
name|ifr_data
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCHOSTAP_GETALL
case|:
if|if
condition|(
operator|(
name|error
operator|=
name|copyin
argument_list|(
name|ifr
operator|->
name|ifr_data
argument_list|,
operator|&
name|reqall
argument_list|,
sizeof|sizeof
argument_list|(
name|reqall
argument_list|)
argument_list|)
operator|)
condition|)
break|break;
name|reqall
operator|.
name|nstations
operator|=
name|whi
operator|->
name|n_stations
expr_stmt|;
name|n
operator|=
literal|0
expr_stmt|;
name|s
operator|=
name|splimp
argument_list|()
expr_stmt|;
name|sta
operator|=
name|LIST_FIRST
argument_list|(
operator|&
name|whi
operator|->
name|sta_list
argument_list|)
expr_stmt|;
while|while
condition|(
name|sta
operator|&&
name|reqall
operator|.
name|size
operator|>=
name|n
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|hostap_sta
argument_list|)
condition|)
block|{
name|bcopy
argument_list|(
name|sta
operator|->
name|addr
argument_list|,
name|stabuf
operator|.
name|addr
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|stabuf
operator|.
name|asid
operator|=
name|sta
operator|->
name|asid
expr_stmt|;
name|stabuf
operator|.
name|flags
operator|=
name|sta
operator|->
name|flags
expr_stmt|;
name|stabuf
operator|.
name|capinfo
operator|=
name|sta
operator|->
name|capinfo
expr_stmt|;
name|stabuf
operator|.
name|sig_info
operator|=
name|sta
operator|->
name|sig_info
expr_stmt|;
name|stabuf
operator|.
name|rates
operator|=
name|sta
operator|->
name|rates
expr_stmt|;
name|error
operator|=
name|copyout
argument_list|(
operator|&
name|stabuf
argument_list|,
operator|(
name|caddr_t
operator|)
name|reqall
operator|.
name|addr
operator|+
name|n
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|hostap_sta
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
break|break;
name|sta
operator|=
name|LIST_NEXT
argument_list|(
name|sta
argument_list|,
name|list
argument_list|)
expr_stmt|;
name|n
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|hostap_sta
argument_list|)
expr_stmt|;
block|}
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
name|error
operator|=
name|copyout
argument_list|(
operator|&
name|reqall
argument_list|,
name|ifr
operator|->
name|ifr_data
argument_list|,
sizeof|sizeof
argument_list|(
name|reqall
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"wihap_ioctl: i shouldn't get other ioctls!\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

end_unit


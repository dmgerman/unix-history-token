begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2009-2012 Alexander Motin<mav@FreeBSD.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer,  *    without modification, immediately at the beginning of the file.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<machine/stdarg.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<dev/pci/pcivar.h>
end_include

begin_include
include|#
directive|include
file|<dev/pci/pcireg.h>
end_include

begin_include
include|#
directive|include
file|"ahci.h"
end_include

begin_decl_stmt
specifier|static
name|int
name|force_ahci
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"hw.ahci.force"
argument_list|,
operator|&
name|force_ahci
argument_list|)
expr_stmt|;
end_expr_stmt

begin_struct
specifier|static
specifier|const
struct|struct
block|{
name|uint32_t
name|id
decl_stmt|;
name|uint8_t
name|rev
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|int
name|quirks
decl_stmt|;
block|}
name|ahci_ids
index|[]
init|=
block|{
block|{
literal|0x43801002
block|,
literal|0x00
block|,
literal|"AMD SB600"
block|,
name|AHCI_Q_NOMSI
operator||
name|AHCI_Q_ATI_PMP_BUG
operator||
name|AHCI_Q_MAXIO_64K
block|}
block|,
block|{
literal|0x43901002
block|,
literal|0x00
block|,
literal|"AMD SB7x0/SB8x0/SB9x0"
block|,
name|AHCI_Q_ATI_PMP_BUG
operator||
name|AHCI_Q_1MSI
block|}
block|,
block|{
literal|0x43911002
block|,
literal|0x00
block|,
literal|"AMD SB7x0/SB8x0/SB9x0"
block|,
name|AHCI_Q_ATI_PMP_BUG
operator||
name|AHCI_Q_1MSI
block|}
block|,
block|{
literal|0x43921002
block|,
literal|0x00
block|,
literal|"AMD SB7x0/SB8x0/SB9x0"
block|,
name|AHCI_Q_ATI_PMP_BUG
operator||
name|AHCI_Q_1MSI
block|}
block|,
block|{
literal|0x43931002
block|,
literal|0x00
block|,
literal|"AMD SB7x0/SB8x0/SB9x0"
block|,
name|AHCI_Q_ATI_PMP_BUG
operator||
name|AHCI_Q_1MSI
block|}
block|,
block|{
literal|0x43941002
block|,
literal|0x00
block|,
literal|"AMD SB7x0/SB8x0/SB9x0"
block|,
name|AHCI_Q_ATI_PMP_BUG
operator||
name|AHCI_Q_1MSI
block|}
block|,
comment|/* Not sure SB8x0/SB9x0 needs this quirk. Be conservative though */
block|{
literal|0x43951002
block|,
literal|0x00
block|,
literal|"AMD SB8x0/SB9x0"
block|,
name|AHCI_Q_ATI_PMP_BUG
block|}
block|,
block|{
literal|0x78001022
block|,
literal|0x00
block|,
literal|"AMD Hudson-2"
block|,
literal|0
block|}
block|,
block|{
literal|0x78011022
block|,
literal|0x00
block|,
literal|"AMD Hudson-2"
block|,
literal|0
block|}
block|,
block|{
literal|0x78021022
block|,
literal|0x00
block|,
literal|"AMD Hudson-2"
block|,
literal|0
block|}
block|,
block|{
literal|0x78031022
block|,
literal|0x00
block|,
literal|"AMD Hudson-2"
block|,
literal|0
block|}
block|,
block|{
literal|0x78041022
block|,
literal|0x00
block|,
literal|"AMD Hudson-2"
block|,
literal|0
block|}
block|,
block|{
literal|0x06011b21
block|,
literal|0x00
block|,
literal|"ASMedia ASM1060"
block|,
literal|0
block|}
block|,
block|{
literal|0x06021b21
block|,
literal|0x00
block|,
literal|"ASMedia ASM1060"
block|,
literal|0
block|}
block|,
block|{
literal|0x06111b21
block|,
literal|0x00
block|,
literal|"ASMedia ASM1061"
block|,
literal|0
block|}
block|,
block|{
literal|0x06121b21
block|,
literal|0x00
block|,
literal|"ASMedia ASM1062"
block|,
literal|0
block|}
block|,
block|{
literal|0x06201b21
block|,
literal|0x00
block|,
literal|"ASMedia ASM106x"
block|,
literal|0
block|}
block|,
block|{
literal|0x06211b21
block|,
literal|0x00
block|,
literal|"ASMedia ASM106x"
block|,
literal|0
block|}
block|,
block|{
literal|0x06221b21
block|,
literal|0x00
block|,
literal|"ASMedia ASM106x"
block|,
literal|0
block|}
block|,
block|{
literal|0x06241b21
block|,
literal|0x00
block|,
literal|"ASMedia ASM106x"
block|,
literal|0
block|}
block|,
block|{
literal|0x06251b21
block|,
literal|0x00
block|,
literal|"ASMedia ASM106x"
block|,
literal|0
block|}
block|,
block|{
literal|0x26528086
block|,
literal|0x00
block|,
literal|"Intel ICH6"
block|,
name|AHCI_Q_NOFORCE
block|}
block|,
block|{
literal|0x26538086
block|,
literal|0x00
block|,
literal|"Intel ICH6M"
block|,
name|AHCI_Q_NOFORCE
block|}
block|,
block|{
literal|0x26818086
block|,
literal|0x00
block|,
literal|"Intel ESB2"
block|,
literal|0
block|}
block|,
block|{
literal|0x26828086
block|,
literal|0x00
block|,
literal|"Intel ESB2"
block|,
literal|0
block|}
block|,
block|{
literal|0x26838086
block|,
literal|0x00
block|,
literal|"Intel ESB2"
block|,
literal|0
block|}
block|,
block|{
literal|0x27c18086
block|,
literal|0x00
block|,
literal|"Intel ICH7"
block|,
literal|0
block|}
block|,
block|{
literal|0x27c38086
block|,
literal|0x00
block|,
literal|"Intel ICH7"
block|,
literal|0
block|}
block|,
block|{
literal|0x27c58086
block|,
literal|0x00
block|,
literal|"Intel ICH7M"
block|,
literal|0
block|}
block|,
block|{
literal|0x27c68086
block|,
literal|0x00
block|,
literal|"Intel ICH7M"
block|,
literal|0
block|}
block|,
block|{
literal|0x28218086
block|,
literal|0x00
block|,
literal|"Intel ICH8"
block|,
literal|0
block|}
block|,
block|{
literal|0x28228086
block|,
literal|0x00
block|,
literal|"Intel ICH8"
block|,
literal|0
block|}
block|,
block|{
literal|0x28248086
block|,
literal|0x00
block|,
literal|"Intel ICH8"
block|,
literal|0
block|}
block|,
block|{
literal|0x28298086
block|,
literal|0x00
block|,
literal|"Intel ICH8M"
block|,
literal|0
block|}
block|,
block|{
literal|0x282a8086
block|,
literal|0x00
block|,
literal|"Intel ICH8M"
block|,
literal|0
block|}
block|,
block|{
literal|0x29228086
block|,
literal|0x00
block|,
literal|"Intel ICH9"
block|,
literal|0
block|}
block|,
block|{
literal|0x29238086
block|,
literal|0x00
block|,
literal|"Intel ICH9"
block|,
literal|0
block|}
block|,
block|{
literal|0x29248086
block|,
literal|0x00
block|,
literal|"Intel ICH9"
block|,
literal|0
block|}
block|,
block|{
literal|0x29258086
block|,
literal|0x00
block|,
literal|"Intel ICH9"
block|,
literal|0
block|}
block|,
block|{
literal|0x29278086
block|,
literal|0x00
block|,
literal|"Intel ICH9"
block|,
literal|0
block|}
block|,
block|{
literal|0x29298086
block|,
literal|0x00
block|,
literal|"Intel ICH9M"
block|,
literal|0
block|}
block|,
block|{
literal|0x292a8086
block|,
literal|0x00
block|,
literal|"Intel ICH9M"
block|,
literal|0
block|}
block|,
block|{
literal|0x292b8086
block|,
literal|0x00
block|,
literal|"Intel ICH9M"
block|,
literal|0
block|}
block|,
block|{
literal|0x292c8086
block|,
literal|0x00
block|,
literal|"Intel ICH9M"
block|,
literal|0
block|}
block|,
block|{
literal|0x292f8086
block|,
literal|0x00
block|,
literal|"Intel ICH9M"
block|,
literal|0
block|}
block|,
block|{
literal|0x294d8086
block|,
literal|0x00
block|,
literal|"Intel ICH9"
block|,
literal|0
block|}
block|,
block|{
literal|0x294e8086
block|,
literal|0x00
block|,
literal|"Intel ICH9M"
block|,
literal|0
block|}
block|,
block|{
literal|0x3a058086
block|,
literal|0x00
block|,
literal|"Intel ICH10"
block|,
literal|0
block|}
block|,
block|{
literal|0x3a228086
block|,
literal|0x00
block|,
literal|"Intel ICH10"
block|,
literal|0
block|}
block|,
block|{
literal|0x3a258086
block|,
literal|0x00
block|,
literal|"Intel ICH10"
block|,
literal|0
block|}
block|,
block|{
literal|0x3b228086
block|,
literal|0x00
block|,
literal|"Intel 5 Series/3400 Series"
block|,
literal|0
block|}
block|,
block|{
literal|0x3b238086
block|,
literal|0x00
block|,
literal|"Intel 5 Series/3400 Series"
block|,
literal|0
block|}
block|,
block|{
literal|0x3b258086
block|,
literal|0x00
block|,
literal|"Intel 5 Series/3400 Series"
block|,
literal|0
block|}
block|,
block|{
literal|0x3b298086
block|,
literal|0x00
block|,
literal|"Intel 5 Series/3400 Series"
block|,
literal|0
block|}
block|,
block|{
literal|0x3b2c8086
block|,
literal|0x00
block|,
literal|"Intel 5 Series/3400 Series"
block|,
literal|0
block|}
block|,
block|{
literal|0x3b2f8086
block|,
literal|0x00
block|,
literal|"Intel 5 Series/3400 Series"
block|,
literal|0
block|}
block|,
block|{
literal|0x1c028086
block|,
literal|0x00
block|,
literal|"Intel Cougar Point"
block|,
literal|0
block|}
block|,
block|{
literal|0x1c038086
block|,
literal|0x00
block|,
literal|"Intel Cougar Point"
block|,
literal|0
block|}
block|,
block|{
literal|0x1c048086
block|,
literal|0x00
block|,
literal|"Intel Cougar Point"
block|,
literal|0
block|}
block|,
block|{
literal|0x1c058086
block|,
literal|0x00
block|,
literal|"Intel Cougar Point"
block|,
literal|0
block|}
block|,
block|{
literal|0x1d028086
block|,
literal|0x00
block|,
literal|"Intel Patsburg"
block|,
literal|0
block|}
block|,
block|{
literal|0x1d048086
block|,
literal|0x00
block|,
literal|"Intel Patsburg"
block|,
literal|0
block|}
block|,
block|{
literal|0x1d068086
block|,
literal|0x00
block|,
literal|"Intel Patsburg"
block|,
literal|0
block|}
block|,
block|{
literal|0x28268086
block|,
literal|0x00
block|,
literal|"Intel Patsburg (RAID)"
block|,
literal|0
block|}
block|,
block|{
literal|0x1e028086
block|,
literal|0x00
block|,
literal|"Intel Panther Point"
block|,
literal|0
block|}
block|,
block|{
literal|0x1e038086
block|,
literal|0x00
block|,
literal|"Intel Panther Point"
block|,
literal|0
block|}
block|,
block|{
literal|0x1e048086
block|,
literal|0x00
block|,
literal|"Intel Panther Point (RAID)"
block|,
literal|0
block|}
block|,
block|{
literal|0x1e058086
block|,
literal|0x00
block|,
literal|"Intel Panther Point (RAID)"
block|,
literal|0
block|}
block|,
block|{
literal|0x1e068086
block|,
literal|0x00
block|,
literal|"Intel Panther Point (RAID)"
block|,
literal|0
block|}
block|,
block|{
literal|0x1e078086
block|,
literal|0x00
block|,
literal|"Intel Panther Point (RAID)"
block|,
literal|0
block|}
block|,
block|{
literal|0x1e0e8086
block|,
literal|0x00
block|,
literal|"Intel Panther Point (RAID)"
block|,
literal|0
block|}
block|,
block|{
literal|0x1e0f8086
block|,
literal|0x00
block|,
literal|"Intel Panther Point (RAID)"
block|,
literal|0
block|}
block|,
block|{
literal|0x1f228086
block|,
literal|0x00
block|,
literal|"Intel Avoton"
block|,
literal|0
block|}
block|,
block|{
literal|0x1f238086
block|,
literal|0x00
block|,
literal|"Intel Avoton"
block|,
literal|0
block|}
block|,
block|{
literal|0x1f248086
block|,
literal|0x00
block|,
literal|"Intel Avoton (RAID)"
block|,
literal|0
block|}
block|,
block|{
literal|0x1f258086
block|,
literal|0x00
block|,
literal|"Intel Avoton (RAID)"
block|,
literal|0
block|}
block|,
block|{
literal|0x1f268086
block|,
literal|0x00
block|,
literal|"Intel Avoton (RAID)"
block|,
literal|0
block|}
block|,
block|{
literal|0x1f278086
block|,
literal|0x00
block|,
literal|"Intel Avoton (RAID)"
block|,
literal|0
block|}
block|,
block|{
literal|0x1f2e8086
block|,
literal|0x00
block|,
literal|"Intel Avoton (RAID)"
block|,
literal|0
block|}
block|,
block|{
literal|0x1f2f8086
block|,
literal|0x00
block|,
literal|"Intel Avoton (RAID)"
block|,
literal|0
block|}
block|,
block|{
literal|0x1f328086
block|,
literal|0x00
block|,
literal|"Intel Avoton"
block|,
literal|0
block|}
block|,
block|{
literal|0x1f338086
block|,
literal|0x00
block|,
literal|"Intel Avoton"
block|,
literal|0
block|}
block|,
block|{
literal|0x1f348086
block|,
literal|0x00
block|,
literal|"Intel Avoton (RAID)"
block|,
literal|0
block|}
block|,
block|{
literal|0x1f358086
block|,
literal|0x00
block|,
literal|"Intel Avoton (RAID)"
block|,
literal|0
block|}
block|,
block|{
literal|0x1f368086
block|,
literal|0x00
block|,
literal|"Intel Avoton (RAID)"
block|,
literal|0
block|}
block|,
block|{
literal|0x1f378086
block|,
literal|0x00
block|,
literal|"Intel Avoton (RAID)"
block|,
literal|0
block|}
block|,
block|{
literal|0x1f3e8086
block|,
literal|0x00
block|,
literal|"Intel Avoton (RAID)"
block|,
literal|0
block|}
block|,
block|{
literal|0x1f3f8086
block|,
literal|0x00
block|,
literal|"Intel Avoton (RAID)"
block|,
literal|0
block|}
block|,
block|{
literal|0x23a38086
block|,
literal|0x00
block|,
literal|"Intel Coleto Creek"
block|,
literal|0
block|}
block|,
block|{
literal|0x28238086
block|,
literal|0x00
block|,
literal|"Intel Wellsburg (RAID)"
block|,
literal|0
block|}
block|,
block|{
literal|0x28278086
block|,
literal|0x00
block|,
literal|"Intel Wellsburg (RAID)"
block|,
literal|0
block|}
block|,
block|{
literal|0x8c028086
block|,
literal|0x00
block|,
literal|"Intel Lynx Point"
block|,
literal|0
block|}
block|,
block|{
literal|0x8c038086
block|,
literal|0x00
block|,
literal|"Intel Lynx Point"
block|,
literal|0
block|}
block|,
block|{
literal|0x8c048086
block|,
literal|0x00
block|,
literal|"Intel Lynx Point (RAID)"
block|,
literal|0
block|}
block|,
block|{
literal|0x8c058086
block|,
literal|0x00
block|,
literal|"Intel Lynx Point (RAID)"
block|,
literal|0
block|}
block|,
block|{
literal|0x8c068086
block|,
literal|0x00
block|,
literal|"Intel Lynx Point (RAID)"
block|,
literal|0
block|}
block|,
block|{
literal|0x8c078086
block|,
literal|0x00
block|,
literal|"Intel Lynx Point (RAID)"
block|,
literal|0
block|}
block|,
block|{
literal|0x8c0e8086
block|,
literal|0x00
block|,
literal|"Intel Lynx Point (RAID)"
block|,
literal|0
block|}
block|,
block|{
literal|0x8c0f8086
block|,
literal|0x00
block|,
literal|"Intel Lynx Point (RAID)"
block|,
literal|0
block|}
block|,
block|{
literal|0x8c828086
block|,
literal|0x00
block|,
literal|"Intel Wildcat Point"
block|,
literal|0
block|}
block|,
block|{
literal|0x8c838086
block|,
literal|0x00
block|,
literal|"Intel Wildcat Point"
block|,
literal|0
block|}
block|,
block|{
literal|0x8c848086
block|,
literal|0x00
block|,
literal|"Intel Wildcat Point (RAID)"
block|,
literal|0
block|}
block|,
block|{
literal|0x8c858086
block|,
literal|0x00
block|,
literal|"Intel Wildcat Point (RAID)"
block|,
literal|0
block|}
block|,
block|{
literal|0x8c868086
block|,
literal|0x00
block|,
literal|"Intel Wildcat Point (RAID)"
block|,
literal|0
block|}
block|,
block|{
literal|0x8c878086
block|,
literal|0x00
block|,
literal|"Intel Wildcat Point (RAID)"
block|,
literal|0
block|}
block|,
block|{
literal|0x8c8e8086
block|,
literal|0x00
block|,
literal|"Intel Wildcat Point (RAID)"
block|,
literal|0
block|}
block|,
block|{
literal|0x8c8f8086
block|,
literal|0x00
block|,
literal|"Intel Wildcat Point (RAID)"
block|,
literal|0
block|}
block|,
block|{
literal|0x8d028086
block|,
literal|0x00
block|,
literal|"Intel Wellsburg"
block|,
literal|0
block|}
block|,
block|{
literal|0x8d048086
block|,
literal|0x00
block|,
literal|"Intel Wellsburg (RAID)"
block|,
literal|0
block|}
block|,
block|{
literal|0x8d068086
block|,
literal|0x00
block|,
literal|"Intel Wellsburg (RAID)"
block|,
literal|0
block|}
block|,
block|{
literal|0x8d628086
block|,
literal|0x00
block|,
literal|"Intel Wellsburg"
block|,
literal|0
block|}
block|,
block|{
literal|0x8d648086
block|,
literal|0x00
block|,
literal|"Intel Wellsburg (RAID)"
block|,
literal|0
block|}
block|,
block|{
literal|0x8d668086
block|,
literal|0x00
block|,
literal|"Intel Wellsburg (RAID)"
block|,
literal|0
block|}
block|,
block|{
literal|0x8d6e8086
block|,
literal|0x00
block|,
literal|"Intel Wellsburg (RAID)"
block|,
literal|0
block|}
block|,
block|{
literal|0x9c028086
block|,
literal|0x00
block|,
literal|"Intel Lynx Point-LP"
block|,
literal|0
block|}
block|,
block|{
literal|0x9c038086
block|,
literal|0x00
block|,
literal|"Intel Lynx Point-LP"
block|,
literal|0
block|}
block|,
block|{
literal|0x9c048086
block|,
literal|0x00
block|,
literal|"Intel Lynx Point-LP (RAID)"
block|,
literal|0
block|}
block|,
block|{
literal|0x9c058086
block|,
literal|0x00
block|,
literal|"Intel Lynx Point-LP (RAID)"
block|,
literal|0
block|}
block|,
block|{
literal|0x9c068086
block|,
literal|0x00
block|,
literal|"Intel Lynx Point-LP (RAID)"
block|,
literal|0
block|}
block|,
block|{
literal|0x9c078086
block|,
literal|0x00
block|,
literal|"Intel Lynx Point-LP (RAID)"
block|,
literal|0
block|}
block|,
block|{
literal|0x9c0e8086
block|,
literal|0x00
block|,
literal|"Intel Lynx Point-LP (RAID)"
block|,
literal|0
block|}
block|,
block|{
literal|0x9c0f8086
block|,
literal|0x00
block|,
literal|"Intel Lynx Point-LP (RAID)"
block|,
literal|0
block|}
block|,
block|{
literal|0x9d038086
block|,
literal|0x00
block|,
literal|"Intel Sunrise Point-LP"
block|,
literal|0
block|}
block|,
block|{
literal|0x9d058086
block|,
literal|0x00
block|,
literal|"Intel Sunrise Point-LP (RAID)"
block|,
literal|0
block|}
block|,
block|{
literal|0x9d078086
block|,
literal|0x00
block|,
literal|"Intel Sunrise Point-LP (RAID)"
block|,
literal|0
block|}
block|,
block|{
literal|0xa1028086
block|,
literal|0x00
block|,
literal|"Intel Sunrise Point"
block|,
literal|0
block|}
block|,
block|{
literal|0xa1038086
block|,
literal|0x00
block|,
literal|"Intel Sunrise Point"
block|,
literal|0
block|}
block|,
block|{
literal|0xa1058086
block|,
literal|0x00
block|,
literal|"Intel Sunrise Point (RAID)"
block|,
literal|0
block|}
block|,
block|{
literal|0xa1068086
block|,
literal|0x00
block|,
literal|"Intel Sunrise Point (RAID)"
block|,
literal|0
block|}
block|,
block|{
literal|0xa1078086
block|,
literal|0x00
block|,
literal|"Intel Sunrise Point (RAID)"
block|,
literal|0
block|}
block|,
block|{
literal|0xa10f8086
block|,
literal|0x00
block|,
literal|"Intel Sunrise Point (RAID)"
block|,
literal|0
block|}
block|,
block|{
literal|0x23238086
block|,
literal|0x00
block|,
literal|"Intel DH89xxCC"
block|,
literal|0
block|}
block|,
block|{
literal|0x2360197b
block|,
literal|0x00
block|,
literal|"JMicron JMB360"
block|,
literal|0
block|}
block|,
block|{
literal|0x2361197b
block|,
literal|0x00
block|,
literal|"JMicron JMB361"
block|,
name|AHCI_Q_NOFORCE
operator||
name|AHCI_Q_1CH
block|}
block|,
block|{
literal|0x2362197b
block|,
literal|0x00
block|,
literal|"JMicron JMB362"
block|,
literal|0
block|}
block|,
block|{
literal|0x2363197b
block|,
literal|0x00
block|,
literal|"JMicron JMB363"
block|,
name|AHCI_Q_NOFORCE
block|}
block|,
block|{
literal|0x2365197b
block|,
literal|0x00
block|,
literal|"JMicron JMB365"
block|,
name|AHCI_Q_NOFORCE
block|}
block|,
block|{
literal|0x2366197b
block|,
literal|0x00
block|,
literal|"JMicron JMB366"
block|,
name|AHCI_Q_NOFORCE
block|}
block|,
block|{
literal|0x2368197b
block|,
literal|0x00
block|,
literal|"JMicron JMB368"
block|,
name|AHCI_Q_NOFORCE
block|}
block|,
block|{
literal|0x611111ab
block|,
literal|0x00
block|,
literal|"Marvell 88SE6111"
block|,
name|AHCI_Q_NOFORCE
operator||
name|AHCI_Q_NOPMP
operator||
name|AHCI_Q_1CH
operator||
name|AHCI_Q_EDGEIS
block|}
block|,
block|{
literal|0x612111ab
block|,
literal|0x00
block|,
literal|"Marvell 88SE6121"
block|,
name|AHCI_Q_NOFORCE
operator||
name|AHCI_Q_NOPMP
operator||
name|AHCI_Q_2CH
operator||
name|AHCI_Q_EDGEIS
operator||
name|AHCI_Q_NONCQ
operator||
name|AHCI_Q_NOCOUNT
block|}
block|,
block|{
literal|0x614111ab
block|,
literal|0x00
block|,
literal|"Marvell 88SE6141"
block|,
name|AHCI_Q_NOFORCE
operator||
name|AHCI_Q_NOPMP
operator||
name|AHCI_Q_4CH
operator||
name|AHCI_Q_EDGEIS
operator||
name|AHCI_Q_NONCQ
operator||
name|AHCI_Q_NOCOUNT
block|}
block|,
block|{
literal|0x614511ab
block|,
literal|0x00
block|,
literal|"Marvell 88SE6145"
block|,
name|AHCI_Q_NOFORCE
operator||
name|AHCI_Q_NOPMP
operator||
name|AHCI_Q_4CH
operator||
name|AHCI_Q_EDGEIS
operator||
name|AHCI_Q_NONCQ
operator||
name|AHCI_Q_NOCOUNT
block|}
block|,
block|{
literal|0x91201b4b
block|,
literal|0x00
block|,
literal|"Marvell 88SE912x"
block|,
name|AHCI_Q_EDGEIS
block|}
block|,
block|{
literal|0x91231b4b
block|,
literal|0x11
block|,
literal|"Marvell 88SE912x"
block|,
name|AHCI_Q_ALTSIG
block|}
block|,
block|{
literal|0x91231b4b
block|,
literal|0x00
block|,
literal|"Marvell 88SE912x"
block|,
name|AHCI_Q_EDGEIS
operator||
name|AHCI_Q_SATA2
block|}
block|,
block|{
literal|0x91251b4b
block|,
literal|0x00
block|,
literal|"Marvell 88SE9125"
block|,
literal|0
block|}
block|,
block|{
literal|0x91281b4b
block|,
literal|0x00
block|,
literal|"Marvell 88SE9128"
block|,
name|AHCI_Q_ALTSIG
block|}
block|,
block|{
literal|0x91301b4b
block|,
literal|0x00
block|,
literal|"Marvell 88SE9130"
block|,
name|AHCI_Q_ALTSIG
block|}
block|,
block|{
literal|0x91721b4b
block|,
literal|0x00
block|,
literal|"Marvell 88SE9172"
block|,
literal|0
block|}
block|,
block|{
literal|0x91821b4b
block|,
literal|0x00
block|,
literal|"Marvell 88SE9182"
block|,
literal|0
block|}
block|,
block|{
literal|0x91831b4b
block|,
literal|0x00
block|,
literal|"Marvell 88SS9183"
block|,
literal|0
block|}
block|,
block|{
literal|0x91a01b4b
block|,
literal|0x00
block|,
literal|"Marvell 88SE91Ax"
block|,
literal|0
block|}
block|,
block|{
literal|0x92151b4b
block|,
literal|0x00
block|,
literal|"Marvell 88SE9215"
block|,
literal|0
block|}
block|,
block|{
literal|0x92201b4b
block|,
literal|0x00
block|,
literal|"Marvell 88SE9220"
block|,
name|AHCI_Q_ALTSIG
block|}
block|,
block|{
literal|0x92301b4b
block|,
literal|0x00
block|,
literal|"Marvell 88SE9230"
block|,
name|AHCI_Q_ALTSIG
block|}
block|,
block|{
literal|0x92351b4b
block|,
literal|0x00
block|,
literal|"Marvell 88SE9235"
block|,
literal|0
block|}
block|,
block|{
literal|0x06201103
block|,
literal|0x00
block|,
literal|"HighPoint RocketRAID 620"
block|,
literal|0
block|}
block|,
block|{
literal|0x06201b4b
block|,
literal|0x00
block|,
literal|"HighPoint RocketRAID 620"
block|,
literal|0
block|}
block|,
block|{
literal|0x06221103
block|,
literal|0x00
block|,
literal|"HighPoint RocketRAID 622"
block|,
literal|0
block|}
block|,
block|{
literal|0x06221b4b
block|,
literal|0x00
block|,
literal|"HighPoint RocketRAID 622"
block|,
literal|0
block|}
block|,
block|{
literal|0x06401103
block|,
literal|0x00
block|,
literal|"HighPoint RocketRAID 640"
block|,
literal|0
block|}
block|,
block|{
literal|0x06401b4b
block|,
literal|0x00
block|,
literal|"HighPoint RocketRAID 640"
block|,
literal|0
block|}
block|,
block|{
literal|0x06441103
block|,
literal|0x00
block|,
literal|"HighPoint RocketRAID 644"
block|,
literal|0
block|}
block|,
block|{
literal|0x06441b4b
block|,
literal|0x00
block|,
literal|"HighPoint RocketRAID 644"
block|,
literal|0
block|}
block|,
block|{
literal|0x06411103
block|,
literal|0x00
block|,
literal|"HighPoint RocketRAID 640L"
block|,
literal|0
block|}
block|,
block|{
literal|0x06421103
block|,
literal|0x00
block|,
literal|"HighPoint RocketRAID 642L"
block|,
literal|0
block|}
block|,
block|{
literal|0x06451103
block|,
literal|0x00
block|,
literal|"HighPoint RocketRAID 644L"
block|,
literal|0
block|}
block|,
block|{
literal|0x044c10de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP65"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x044d10de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP65"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x044e10de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP65"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x044f10de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP65"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x045c10de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP65"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x045d10de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP65"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x045e10de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP65"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x045f10de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP65"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x055010de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP67"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x055110de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP67"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x055210de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP67"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x055310de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP67"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x055410de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP67"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x055510de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP67"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x055610de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP67"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x055710de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP67"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x055810de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP67"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x055910de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP67"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x055A10de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP67"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x055B10de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP67"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x058410de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP67"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x07f010de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP73"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x07f110de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP73"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x07f210de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP73"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x07f310de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP73"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x07f410de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP73"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x07f510de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP73"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x07f610de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP73"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x07f710de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP73"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x07f810de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP73"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x07f910de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP73"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x07fa10de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP73"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x07fb10de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP73"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x0ad010de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP77"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x0ad110de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP77"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x0ad210de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP77"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x0ad310de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP77"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x0ad410de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP77"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x0ad510de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP77"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x0ad610de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP77"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x0ad710de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP77"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x0ad810de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP77"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x0ad910de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP77"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x0ada10de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP77"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x0adb10de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP77"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x0ab410de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP79"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x0ab510de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP79"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x0ab610de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP79"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x0ab710de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP79"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x0ab810de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP79"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x0ab910de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP79"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x0aba10de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP79"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x0abb10de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP79"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x0abc10de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP79"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x0abd10de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP79"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x0abe10de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP79"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x0abf10de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP79"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x0d8410de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP89"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x0d8510de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP89"
block|,
name|AHCI_Q_NOFORCE
operator||
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x0d8610de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP89"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x0d8710de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP89"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x0d8810de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP89"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x0d8910de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP89"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x0d8a10de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP89"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x0d8b10de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP89"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x0d8c10de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP89"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x0d8d10de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP89"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x0d8e10de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP89"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x0d8f10de
block|,
literal|0x00
block|,
literal|"NVIDIA MCP89"
block|,
name|AHCI_Q_NOAA
block|}
block|,
block|{
literal|0x3781105a
block|,
literal|0x00
block|,
literal|"Promise TX8660"
block|,
literal|0
block|}
block|,
block|{
literal|0x33491106
block|,
literal|0x00
block|,
literal|"VIA VT8251"
block|,
name|AHCI_Q_NOPMP
operator||
name|AHCI_Q_NONCQ
block|}
block|,
block|{
literal|0x62871106
block|,
literal|0x00
block|,
literal|"VIA VT8251"
block|,
name|AHCI_Q_NOPMP
operator||
name|AHCI_Q_NONCQ
block|}
block|,
block|{
literal|0x11841039
block|,
literal|0x00
block|,
literal|"SiS 966"
block|,
literal|0
block|}
block|,
block|{
literal|0x11851039
block|,
literal|0x00
block|,
literal|"SiS 968"
block|,
literal|0
block|}
block|,
block|{
literal|0x01861039
block|,
literal|0x00
block|,
literal|"SiS 968"
block|,
literal|0
block|}
block|,
block|{
literal|0xa01c177d
block|,
literal|0x00
block|,
literal|"ThunderX"
block|,
name|AHCI_Q_ABAR0
operator||
name|AHCI_Q_1MSI
block|}
block|,
block|{
literal|0x00000000
block|,
literal|0x00
block|,
name|NULL
block|,
literal|0
block|}
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|ahci_pci_ctlr_reset
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
if|if
condition|(
name|pci_read_config
argument_list|(
name|dev
argument_list|,
name|PCIR_DEVVENDOR
argument_list|,
literal|4
argument_list|)
operator|==
literal|0x28298086
operator|&&
operator|(
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x92
argument_list|,
literal|1
argument_list|)
operator|&
literal|0xfe
operator|)
operator|==
literal|0x04
condition|)
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x92
argument_list|,
literal|0x01
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|ahci_ctlr_reset
argument_list|(
name|dev
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ahci_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|char
name|buf
index|[
literal|64
index|]
decl_stmt|;
name|int
name|i
decl_stmt|,
name|valid
init|=
literal|0
decl_stmt|;
name|uint32_t
name|devid
init|=
name|pci_get_devid
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|uint8_t
name|revid
init|=
name|pci_get_revid
argument_list|(
name|dev
argument_list|)
decl_stmt|;
comment|/* 	 * Ensure it is not a PCI bridge (some vendors use 	 * the same PID and VID in PCI bridge and AHCI cards). 	 */
if|if
condition|(
name|pci_get_class
argument_list|(
name|dev
argument_list|)
operator|==
name|PCIC_BRIDGE
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
comment|/* Is this a possible AHCI candidate? */
if|if
condition|(
name|pci_get_class
argument_list|(
name|dev
argument_list|)
operator|==
name|PCIC_STORAGE
operator|&&
name|pci_get_subclass
argument_list|(
name|dev
argument_list|)
operator|==
name|PCIS_STORAGE_SATA
operator|&&
name|pci_get_progif
argument_list|(
name|dev
argument_list|)
operator|==
name|PCIP_STORAGE_SATA_AHCI_1_0
condition|)
name|valid
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|pci_get_class
argument_list|(
name|dev
argument_list|)
operator|==
name|PCIC_STORAGE
operator|&&
name|pci_get_subclass
argument_list|(
name|dev
argument_list|)
operator|==
name|PCIS_STORAGE_RAID
condition|)
name|valid
operator|=
literal|2
expr_stmt|;
comment|/* Is this a known AHCI chip? */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|ahci_ids
index|[
name|i
index|]
operator|.
name|id
operator|!=
literal|0
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ahci_ids
index|[
name|i
index|]
operator|.
name|id
operator|==
name|devid
operator|&&
name|ahci_ids
index|[
name|i
index|]
operator|.
name|rev
operator|<=
name|revid
operator|&&
operator|(
name|valid
operator|||
operator|(
name|force_ahci
operator|==
literal|1
operator|&&
operator|!
operator|(
name|ahci_ids
index|[
name|i
index|]
operator|.
name|quirks
operator|&
name|AHCI_Q_NOFORCE
operator|)
operator|)
operator|)
condition|)
block|{
comment|/* Do not attach JMicrons with single PCI function. */
if|if
condition|(
name|pci_get_vendor
argument_list|(
name|dev
argument_list|)
operator|==
literal|0x197b
operator|&&
operator|(
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0xdf
argument_list|,
literal|1
argument_list|)
operator|&
literal|0x40
operator|)
operator|==
literal|0
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s AHCI SATA controller"
argument_list|,
name|ahci_ids
index|[
name|i
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
name|device_set_desc_copy
argument_list|(
name|dev
argument_list|,
name|buf
argument_list|)
expr_stmt|;
return|return
operator|(
name|BUS_PROBE_DEFAULT
operator|)
return|;
block|}
block|}
if|if
condition|(
name|valid
operator|!=
literal|1
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|device_set_desc_copy
argument_list|(
name|dev
argument_list|,
literal|"AHCI SATA controller"
argument_list|)
expr_stmt|;
return|return
operator|(
name|BUS_PROBE_DEFAULT
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ahci_ata_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|char
name|buf
index|[
literal|64
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
name|uint32_t
name|devid
init|=
name|pci_get_devid
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|uint8_t
name|revid
init|=
name|pci_get_revid
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|intptr_t
operator|)
name|device_get_ivars
argument_list|(
name|dev
argument_list|)
operator|>=
literal|0
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
comment|/* Is this a known AHCI chip? */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|ahci_ids
index|[
name|i
index|]
operator|.
name|id
operator|!=
literal|0
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ahci_ids
index|[
name|i
index|]
operator|.
name|id
operator|==
name|devid
operator|&&
name|ahci_ids
index|[
name|i
index|]
operator|.
name|rev
operator|<=
name|revid
condition|)
block|{
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s AHCI SATA controller"
argument_list|,
name|ahci_ids
index|[
name|i
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
name|device_set_desc_copy
argument_list|(
name|dev
argument_list|,
name|buf
argument_list|)
expr_stmt|;
return|return
operator|(
name|BUS_PROBE_DEFAULT
operator|)
return|;
block|}
block|}
name|device_set_desc_copy
argument_list|(
name|dev
argument_list|,
literal|"AHCI SATA controller"
argument_list|)
expr_stmt|;
return|return
operator|(
name|BUS_PROBE_DEFAULT
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ahci_pci_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ahci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|error
decl_stmt|,
name|i
decl_stmt|;
name|uint32_t
name|devid
init|=
name|pci_get_devid
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|uint8_t
name|revid
init|=
name|pci_get_revid
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|ahci_ids
index|[
name|i
index|]
operator|.
name|id
operator|!=
literal|0
operator|&&
operator|(
name|ahci_ids
index|[
name|i
index|]
operator|.
name|id
operator|!=
name|devid
operator|||
name|ahci_ids
index|[
name|i
index|]
operator|.
name|rev
operator|>
name|revid
operator|)
condition|)
name|i
operator|++
expr_stmt|;
name|ctlr
operator|->
name|quirks
operator|=
name|ahci_ids
index|[
name|i
index|]
operator|.
name|quirks
expr_stmt|;
comment|/* Limit speed for my onboard JMicron external port. 	 * It is not eSATA really, limit to SATA 1 */
if|if
condition|(
name|pci_get_devid
argument_list|(
name|dev
argument_list|)
operator|==
literal|0x2363197b
operator|&&
name|pci_get_subvendor
argument_list|(
name|dev
argument_list|)
operator|==
literal|0x1043
operator|&&
name|pci_get_subdevice
argument_list|(
name|dev
argument_list|)
operator|==
literal|0x81e4
condition|)
name|ctlr
operator|->
name|quirks
operator||=
name|AHCI_Q_SATA1_UNIT0
expr_stmt|;
name|resource_int_value
argument_list|(
name|device_get_name
argument_list|(
name|dev
argument_list|)
argument_list|,
name|device_get_unit
argument_list|(
name|dev
argument_list|)
argument_list|,
literal|"quirks"
argument_list|,
operator|&
name|ctlr
operator|->
name|quirks
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|vendorid
operator|=
name|pci_get_vendor
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|deviceid
operator|=
name|pci_get_device
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|subvendorid
operator|=
name|pci_get_subvendor
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|subdeviceid
operator|=
name|pci_get_subdevice
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* Default AHCI Base Address is BAR(5), Cavium uses BAR(0) */
if|if
condition|(
name|ctlr
operator|->
name|quirks
operator|&
name|AHCI_Q_ABAR0
condition|)
name|ctlr
operator|->
name|r_rid
operator|=
name|PCIR_BAR
argument_list|(
literal|0
argument_list|)
expr_stmt|;
else|else
name|ctlr
operator|->
name|r_rid
operator|=
name|PCIR_BAR
argument_list|(
literal|5
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ctlr
operator|->
name|r_mem
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
operator|&
name|ctlr
operator|->
name|r_rid
argument_list|,
name|RF_ACTIVE
argument_list|)
operator|)
condition|)
return|return
name|ENXIO
return|;
name|pci_enable_busmaster
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* Reset controller */
if|if
condition|(
operator|(
name|error
operator|=
name|ahci_pci_ctlr_reset
argument_list|(
name|dev
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|ctlr
operator|->
name|r_rid
argument_list|,
name|ctlr
operator|->
name|r_mem
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
empty_stmt|;
comment|/* Setup interrupts. */
comment|/* Setup MSI register parameters */
comment|/* Process hints. */
if|if
condition|(
name|ctlr
operator|->
name|quirks
operator|&
name|AHCI_Q_NOMSI
condition|)
name|ctlr
operator|->
name|msi
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|ctlr
operator|->
name|quirks
operator|&
name|AHCI_Q_1MSI
condition|)
name|ctlr
operator|->
name|msi
operator|=
literal|1
expr_stmt|;
else|else
name|ctlr
operator|->
name|msi
operator|=
literal|2
expr_stmt|;
name|resource_int_value
argument_list|(
name|device_get_name
argument_list|(
name|dev
argument_list|)
argument_list|,
name|device_get_unit
argument_list|(
name|dev
argument_list|)
argument_list|,
literal|"msi"
argument_list|,
operator|&
name|ctlr
operator|->
name|msi
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|numirqs
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|ctlr
operator|->
name|msi
operator|<
literal|0
condition|)
name|ctlr
operator|->
name|msi
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|ctlr
operator|->
name|msi
operator|==
literal|1
condition|)
name|ctlr
operator|->
name|msi
operator|=
name|min
argument_list|(
literal|1
argument_list|,
name|pci_msi_count
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|ctlr
operator|->
name|msi
operator|>
literal|1
condition|)
block|{
name|ctlr
operator|->
name|msi
operator|=
literal|2
expr_stmt|;
name|ctlr
operator|->
name|numirqs
operator|=
name|pci_msi_count
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
comment|/* Allocate MSI if needed/present. */
if|if
condition|(
name|ctlr
operator|->
name|msi
operator|&&
name|pci_alloc_msi
argument_list|(
name|dev
argument_list|,
operator|&
name|ctlr
operator|->
name|numirqs
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|ctlr
operator|->
name|msi
operator|=
literal|0
expr_stmt|;
name|ctlr
operator|->
name|numirqs
operator|=
literal|1
expr_stmt|;
block|}
name|error
operator|=
name|ahci_attach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
if|if
condition|(
name|ctlr
operator|->
name|msi
condition|)
name|pci_release_msi
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ahci_pci_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|ahci_detach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|pci_release_msi
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ahci_pci_suspend
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ahci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|bus_generic_suspend
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* Disable interupts, so the state change(s) doesn't trigger */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_mem
argument_list|,
name|AHCI_GHC
argument_list|,
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_mem
argument_list|,
name|AHCI_GHC
argument_list|)
operator|&
operator|(
operator|~
name|AHCI_GHC_IE
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ahci_pci_resume
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|int
name|res
decl_stmt|;
if|if
condition|(
operator|(
name|res
operator|=
name|ahci_pci_ctlr_reset
argument_list|(
name|dev
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|res
operator|)
return|;
name|ahci_ctlr_setup
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
name|bus_generic_resume
argument_list|(
name|dev
argument_list|)
operator|)
return|;
block|}
end_function

begin_decl_stmt
name|devclass_t
name|ahci_devclass
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|device_method_t
name|ahci_methods
index|[]
init|=
block|{
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|ahci_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|ahci_pci_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|ahci_pci_detach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_suspend
argument_list|,
name|ahci_pci_suspend
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_resume
argument_list|,
name|ahci_pci_resume
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|bus_print_child
argument_list|,
name|ahci_print_child
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|bus_alloc_resource
argument_list|,
name|ahci_alloc_resource
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|bus_release_resource
argument_list|,
name|ahci_release_resource
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|bus_setup_intr
argument_list|,
name|ahci_setup_intr
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|bus_teardown_intr
argument_list|,
name|ahci_teardown_intr
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|bus_child_location_str
argument_list|,
name|ahci_child_location_str
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|bus_get_dma_tag
argument_list|,
name|ahci_get_dma_tag
argument_list|)
block|,
name|DEVMETHOD_END
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|ahci_driver
init|=
block|{
literal|"ahci"
block|,
name|ahci_methods
block|,
expr|sizeof
operator|(
expr|struct
name|ahci_controller
operator|)
block|}
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|ahci
argument_list|,
name|pci
argument_list|,
name|ahci_driver
argument_list|,
name|ahci_devclass
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|device_method_t
name|ahci_ata_methods
index|[]
init|=
block|{
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|ahci_ata_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|ahci_pci_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|ahci_pci_detach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_suspend
argument_list|,
name|ahci_pci_suspend
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_resume
argument_list|,
name|ahci_pci_resume
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|bus_print_child
argument_list|,
name|ahci_print_child
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|bus_alloc_resource
argument_list|,
name|ahci_alloc_resource
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|bus_release_resource
argument_list|,
name|ahci_release_resource
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|bus_setup_intr
argument_list|,
name|ahci_setup_intr
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|bus_teardown_intr
argument_list|,
name|ahci_teardown_intr
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|bus_child_location_str
argument_list|,
name|ahci_child_location_str
argument_list|)
block|,
name|DEVMETHOD_END
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|ahci_ata_driver
init|=
block|{
literal|"ahci"
block|,
name|ahci_ata_methods
block|,
expr|sizeof
operator|(
expr|struct
name|ahci_controller
operator|)
block|}
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|ahci
argument_list|,
name|atapci
argument_list|,
name|ahci_ata_driver
argument_list|,
name|ahci_devclass
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


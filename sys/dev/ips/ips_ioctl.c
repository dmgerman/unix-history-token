begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2002 Adaptec Inc.  * All rights reserved.  *  * Written by: David Jeffery  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<dev/ips/ips.h>
end_include

begin_include
include|#
directive|include
file|<dev/ips/ips_ioctl.h>
end_include

begin_function
specifier|static
name|void
name|ips_ioctl_finish
parameter_list|(
name|ips_command_t
modifier|*
name|command
parameter_list|)
block|{
name|ips_ioctl_t
modifier|*
name|ioctl_cmd
init|=
name|command
operator|->
name|arg
decl_stmt|;
if|if
condition|(
name|ioctl_cmd
operator|->
name|readwrite
operator|&
name|IPS_IOCTL_READ
condition|)
block|{
name|bus_dmamap_sync
argument_list|(
name|ioctl_cmd
operator|->
name|dmatag
argument_list|,
name|ioctl_cmd
operator|->
name|dmamap
argument_list|,
name|BUS_DMASYNC_POSTREAD
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ioctl_cmd
operator|->
name|readwrite
operator|&
name|IPS_IOCTL_WRITE
condition|)
block|{
name|bus_dmamap_sync
argument_list|(
name|ioctl_cmd
operator|->
name|dmatag
argument_list|,
name|ioctl_cmd
operator|->
name|dmamap
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
block|}
name|bus_dmamap_sync
argument_list|(
name|command
operator|->
name|sc
operator|->
name|command_dmatag
argument_list|,
name|command
operator|->
name|command_dmamap
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|ioctl_cmd
operator|->
name|dmatag
argument_list|,
name|ioctl_cmd
operator|->
name|dmamap
argument_list|)
expr_stmt|;
name|ioctl_cmd
operator|->
name|status
operator|.
name|value
operator|=
name|command
operator|->
name|status
operator|.
name|value
expr_stmt|;
name|ips_insert_free_cmd
argument_list|(
name|command
operator|->
name|sc
argument_list|,
name|command
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ips_ioctl_callback
parameter_list|(
name|void
modifier|*
name|cmdptr
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|segments
parameter_list|,
name|int
name|segnum
parameter_list|,
name|int
name|error
parameter_list|)
block|{
name|ips_command_t
modifier|*
name|command
init|=
name|cmdptr
decl_stmt|;
name|ips_ioctl_t
modifier|*
name|ioctl_cmd
init|=
name|command
operator|->
name|arg
decl_stmt|;
name|ips_generic_cmd
modifier|*
name|command_buffer
init|=
name|command
operator|->
name|command_buffer
decl_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|ioctl_cmd
operator|->
name|status
operator|.
name|value
operator|=
name|IPS_ERROR_STATUS
expr_stmt|;
name|ips_insert_free_cmd
argument_list|(
name|command
operator|->
name|sc
argument_list|,
name|command
argument_list|)
expr_stmt|;
return|return;
block|}
name|command_buffer
operator|->
name|id
operator|=
name|command
operator|->
name|id
expr_stmt|;
name|command_buffer
operator|->
name|buffaddr
operator|=
name|segments
index|[
literal|0
index|]
operator|.
name|ds_addr
expr_stmt|;
if|if
condition|(
name|ioctl_cmd
operator|->
name|readwrite
operator|&
name|IPS_IOCTL_WRITE
condition|)
block|{
name|bus_dmamap_sync
argument_list|(
name|ioctl_cmd
operator|->
name|dmatag
argument_list|,
name|ioctl_cmd
operator|->
name|dmamap
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ioctl_cmd
operator|->
name|readwrite
operator|&
name|IPS_IOCTL_READ
condition|)
block|{
name|bus_dmamap_sync
argument_list|(
name|ioctl_cmd
operator|->
name|dmatag
argument_list|,
name|ioctl_cmd
operator|->
name|dmamap
argument_list|,
name|BUS_DMASYNC_PREREAD
argument_list|)
expr_stmt|;
block|}
name|bus_dmamap_sync
argument_list|(
name|command
operator|->
name|sc
operator|->
name|command_dmatag
argument_list|,
name|command
operator|->
name|command_dmamap
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
name|command
operator|->
name|sc
operator|->
name|ips_issue_cmd
argument_list|(
name|command
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|ips_ioctl_start
parameter_list|(
name|ips_command_t
modifier|*
name|command
parameter_list|)
block|{
name|ips_ioctl_t
modifier|*
name|ioctl_cmd
init|=
name|command
operator|->
name|arg
decl_stmt|;
name|memcpy
argument_list|(
name|command
operator|->
name|command_buffer
argument_list|,
name|ioctl_cmd
operator|->
name|command_buffer
argument_list|,
sizeof|sizeof
argument_list|(
name|ips_generic_cmd
argument_list|)
argument_list|)
expr_stmt|;
name|command
operator|->
name|callback
operator|=
name|ips_ioctl_finish
expr_stmt|;
name|bus_dmamap_load
argument_list|(
name|ioctl_cmd
operator|->
name|dmatag
argument_list|,
name|ioctl_cmd
operator|->
name|dmamap
argument_list|,
name|ioctl_cmd
operator|->
name|data_buffer
argument_list|,
name|ioctl_cmd
operator|->
name|datasize
argument_list|,
name|ips_ioctl_callback
argument_list|,
name|command
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ips_ioctl_cmd
parameter_list|(
name|ips_softc_t
modifier|*
name|sc
parameter_list|,
name|ips_ioctl_t
modifier|*
name|ioctl_cmd
parameter_list|,
name|ips_user_request
modifier|*
name|user_request
parameter_list|)
block|{
name|int
name|error
init|=
name|EINVAL
decl_stmt|;
if|if
condition|(
name|bus_dma_tag_create
argument_list|(
comment|/* parent    */
name|sc
operator|->
name|adapter_dmatag
argument_list|,
comment|/* alignment */
literal|1
argument_list|,
comment|/* boundary  */
literal|0
argument_list|,
comment|/* lowaddr   */
name|BUS_SPACE_MAXADDR_32BIT
argument_list|,
comment|/* highaddr  */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* filter    */
name|NULL
argument_list|,
comment|/* filterarg */
name|NULL
argument_list|,
comment|/* maxsize   */
name|ioctl_cmd
operator|->
name|datasize
argument_list|,
comment|/* numsegs   */
literal|1
argument_list|,
comment|/* maxsegsize*/
name|ioctl_cmd
operator|->
name|datasize
argument_list|,
comment|/* flags     */
literal|0
argument_list|,
operator|&
name|ioctl_cmd
operator|->
name|dmatag
argument_list|)
operator|!=
literal|0
condition|)
block|{
return|return
name|ENOMEM
return|;
block|}
if|if
condition|(
name|bus_dmamem_alloc
argument_list|(
name|ioctl_cmd
operator|->
name|dmatag
argument_list|,
operator|&
name|ioctl_cmd
operator|->
name|data_buffer
argument_list|,
literal|0
argument_list|,
operator|&
name|ioctl_cmd
operator|->
name|dmamap
argument_list|)
condition|)
block|{
name|error
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|exit
goto|;
block|}
if|if
condition|(
name|copyin
argument_list|(
name|user_request
operator|->
name|data_buffer
argument_list|,
name|ioctl_cmd
operator|->
name|data_buffer
argument_list|,
name|ioctl_cmd
operator|->
name|datasize
argument_list|)
condition|)
goto|goto
name|exit
goto|;
name|ioctl_cmd
operator|->
name|status
operator|.
name|value
operator|=
literal|0xffffffff
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|ips_get_free_cmd
argument_list|(
name|sc
argument_list|,
name|ips_ioctl_start
argument_list|,
name|ioctl_cmd
argument_list|,
literal|0
argument_list|)
operator|)
operator|>
literal|0
condition|)
block|{
name|error
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|exit
goto|;
block|}
while|while
condition|(
name|ioctl_cmd
operator|->
name|status
operator|.
name|value
operator|==
literal|0xffffffff
condition|)
name|tsleep
argument_list|(
name|ioctl_cmd
argument_list|,
literal|0
argument_list|,
literal|"ips"
argument_list|,
name|hz
operator|/
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|COMMAND_ERROR
argument_list|(
operator|&
name|ioctl_cmd
operator|->
name|status
argument_list|)
condition|)
name|error
operator|=
name|EIO
expr_stmt|;
else|else
name|error
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|copyout
argument_list|(
name|ioctl_cmd
operator|->
name|data_buffer
argument_list|,
name|user_request
operator|->
name|data_buffer
argument_list|,
name|ioctl_cmd
operator|->
name|datasize
argument_list|)
condition|)
name|error
operator|=
name|EINVAL
expr_stmt|;
name|exit
label|:
name|bus_dmamem_free
argument_list|(
name|ioctl_cmd
operator|->
name|dmatag
argument_list|,
name|ioctl_cmd
operator|->
name|data_buffer
argument_list|,
name|ioctl_cmd
operator|->
name|dmamap
argument_list|)
expr_stmt|;
name|bus_dma_tag_destroy
argument_list|(
name|ioctl_cmd
operator|->
name|dmatag
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_function
name|int
name|ips_ioctl_request
parameter_list|(
name|ips_softc_t
modifier|*
name|sc
parameter_list|,
name|u_long
name|ioctl_request
parameter_list|,
name|caddr_t
name|addr
parameter_list|,
name|int32_t
name|flags
parameter_list|)
block|{
name|int
name|error
init|=
name|EINVAL
decl_stmt|;
name|ips_ioctl_t
modifier|*
name|ioctl_cmd
decl_stmt|;
name|ips_user_request
modifier|*
name|user_request
decl_stmt|;
switch|switch
condition|(
name|ioctl_request
condition|)
block|{
case|case
name|IPS_USER_CMD
case|:
name|user_request
operator|=
operator|(
name|ips_user_request
operator|*
operator|)
name|addr
expr_stmt|;
name|ioctl_cmd
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|ips_ioctl_t
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|ioctl_cmd
operator|->
name|command_buffer
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|ips_generic_cmd
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
if|if
condition|(
name|copyin
argument_list|(
name|user_request
operator|->
name|command_buffer
argument_list|,
name|ioctl_cmd
operator|->
name|command_buffer
argument_list|,
sizeof|sizeof
argument_list|(
name|ips_generic_cmd
argument_list|)
argument_list|)
condition|)
block|{
name|free
argument_list|(
name|ioctl_cmd
operator|->
name|command_buffer
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|ioctl_cmd
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
break|break;
block|}
name|ioctl_cmd
operator|->
name|readwrite
operator|=
name|IPS_IOCTL_READ
operator||
name|IPS_IOCTL_WRITE
expr_stmt|;
name|ioctl_cmd
operator|->
name|datasize
operator|=
name|IPS_IOCTL_BUFFER_SIZE
expr_stmt|;
name|error
operator|=
name|ips_ioctl_cmd
argument_list|(
name|sc
argument_list|,
name|ioctl_cmd
argument_list|,
name|user_request
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|ioctl_cmd
operator|->
name|command_buffer
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|ioctl_cmd
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
name|error
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/******************************************************************************    Copyright (c) 2001-2010, Intel Corporation    All rights reserved.      Redistribution and use in source and binary forms, with or without    modification, are permitted provided that the following conditions are met:       1. Redistributions of source code must retain the above copyright notice,        this list of conditions and the following disclaimer.       2. Redistributions in binary form must reproduce the above copyright        notice, this list of conditions and the following disclaimer in the        documentation and/or other materials provided with the distribution.       3. Neither the name of the Intel Corporation nor the names of its        contributors may be used to endorse or promote products derived from        this software without specific prior written permission.      THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"   AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE    IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE    ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE    LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR    CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF    SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS    INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN    CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)    ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE   POSSIBILITY OF SUCH DAMAGE.  ******************************************************************************/
end_comment

begin_comment
comment|/*$FreeBSD$*/
end_comment

begin_comment
comment|/*  * 82542 Gigabit Ethernet Controller  */
end_comment

begin_include
include|#
directive|include
file|"e1000_api.h"
end_include

begin_function_decl
specifier|static
name|s32
name|e1000_init_phy_params_82542
parameter_list|(
name|struct
name|e1000_hw
modifier|*
name|hw
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|s32
name|e1000_init_nvm_params_82542
parameter_list|(
name|struct
name|e1000_hw
modifier|*
name|hw
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|s32
name|e1000_init_mac_params_82542
parameter_list|(
name|struct
name|e1000_hw
modifier|*
name|hw
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|s32
name|e1000_get_bus_info_82542
parameter_list|(
name|struct
name|e1000_hw
modifier|*
name|hw
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|s32
name|e1000_reset_hw_82542
parameter_list|(
name|struct
name|e1000_hw
modifier|*
name|hw
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|s32
name|e1000_init_hw_82542
parameter_list|(
name|struct
name|e1000_hw
modifier|*
name|hw
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|s32
name|e1000_setup_link_82542
parameter_list|(
name|struct
name|e1000_hw
modifier|*
name|hw
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|s32
name|e1000_led_on_82542
parameter_list|(
name|struct
name|e1000_hw
modifier|*
name|hw
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|s32
name|e1000_led_off_82542
parameter_list|(
name|struct
name|e1000_hw
modifier|*
name|hw
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|e1000_rar_set_82542
parameter_list|(
name|struct
name|e1000_hw
modifier|*
name|hw
parameter_list|,
name|u8
modifier|*
name|addr
parameter_list|,
name|u32
name|index
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|e1000_clear_hw_cntrs_82542
parameter_list|(
name|struct
name|e1000_hw
modifier|*
name|hw
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|s32
name|e1000_read_mac_addr_82542
parameter_list|(
name|struct
name|e1000_hw
modifier|*
name|hw
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/**  *  e1000_init_phy_params_82542 - Init PHY func ptrs.  *  @hw: pointer to the HW structure  **/
end_comment

begin_function
specifier|static
name|s32
name|e1000_init_phy_params_82542
parameter_list|(
name|struct
name|e1000_hw
modifier|*
name|hw
parameter_list|)
block|{
name|struct
name|e1000_phy_info
modifier|*
name|phy
init|=
operator|&
name|hw
operator|->
name|phy
decl_stmt|;
name|s32
name|ret_val
init|=
name|E1000_SUCCESS
decl_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"e1000_init_phy_params_82542"
argument_list|)
expr_stmt|;
name|phy
operator|->
name|type
operator|=
name|e1000_phy_none
expr_stmt|;
return|return
name|ret_val
return|;
block|}
end_function

begin_comment
comment|/**  *  e1000_init_nvm_params_82542 - Init NVM func ptrs.  *  @hw: pointer to the HW structure  **/
end_comment

begin_function
specifier|static
name|s32
name|e1000_init_nvm_params_82542
parameter_list|(
name|struct
name|e1000_hw
modifier|*
name|hw
parameter_list|)
block|{
name|struct
name|e1000_nvm_info
modifier|*
name|nvm
init|=
operator|&
name|hw
operator|->
name|nvm
decl_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"e1000_init_nvm_params_82542"
argument_list|)
expr_stmt|;
name|nvm
operator|->
name|address_bits
operator|=
literal|6
expr_stmt|;
name|nvm
operator|->
name|delay_usec
operator|=
literal|50
expr_stmt|;
name|nvm
operator|->
name|opcode_bits
operator|=
literal|3
expr_stmt|;
name|nvm
operator|->
name|type
operator|=
name|e1000_nvm_eeprom_microwire
expr_stmt|;
name|nvm
operator|->
name|word_size
operator|=
literal|64
expr_stmt|;
comment|/* Function Pointers */
name|nvm
operator|->
name|ops
operator|.
name|read
operator|=
name|e1000_read_nvm_microwire
expr_stmt|;
name|nvm
operator|->
name|ops
operator|.
name|release
operator|=
name|e1000_stop_nvm
expr_stmt|;
name|nvm
operator|->
name|ops
operator|.
name|write
operator|=
name|e1000_write_nvm_microwire
expr_stmt|;
name|nvm
operator|->
name|ops
operator|.
name|update
operator|=
name|e1000_update_nvm_checksum_generic
expr_stmt|;
name|nvm
operator|->
name|ops
operator|.
name|validate
operator|=
name|e1000_validate_nvm_checksum_generic
expr_stmt|;
return|return
name|E1000_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**  *  e1000_init_mac_params_82542 - Init MAC func ptrs.  *  @hw: pointer to the HW structure  **/
end_comment

begin_function
specifier|static
name|s32
name|e1000_init_mac_params_82542
parameter_list|(
name|struct
name|e1000_hw
modifier|*
name|hw
parameter_list|)
block|{
name|struct
name|e1000_mac_info
modifier|*
name|mac
init|=
operator|&
name|hw
operator|->
name|mac
decl_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"e1000_init_mac_params_82542"
argument_list|)
expr_stmt|;
comment|/* Set media type */
name|hw
operator|->
name|phy
operator|.
name|media_type
operator|=
name|e1000_media_type_fiber
expr_stmt|;
comment|/* Set mta register count */
name|mac
operator|->
name|mta_reg_count
operator|=
literal|128
expr_stmt|;
comment|/* Set rar entry count */
name|mac
operator|->
name|rar_entry_count
operator|=
name|E1000_RAR_ENTRIES
expr_stmt|;
comment|/* Function pointers */
comment|/* bus type/speed/width */
name|mac
operator|->
name|ops
operator|.
name|get_bus_info
operator|=
name|e1000_get_bus_info_82542
expr_stmt|;
comment|/* function id */
name|mac
operator|->
name|ops
operator|.
name|set_lan_id
operator|=
name|e1000_set_lan_id_multi_port_pci
expr_stmt|;
comment|/* reset */
name|mac
operator|->
name|ops
operator|.
name|reset_hw
operator|=
name|e1000_reset_hw_82542
expr_stmt|;
comment|/* hw initialization */
name|mac
operator|->
name|ops
operator|.
name|init_hw
operator|=
name|e1000_init_hw_82542
expr_stmt|;
comment|/* link setup */
name|mac
operator|->
name|ops
operator|.
name|setup_link
operator|=
name|e1000_setup_link_82542
expr_stmt|;
comment|/* phy/fiber/serdes setup */
name|mac
operator|->
name|ops
operator|.
name|setup_physical_interface
operator|=
name|e1000_setup_fiber_serdes_link_generic
expr_stmt|;
comment|/* check for link */
name|mac
operator|->
name|ops
operator|.
name|check_for_link
operator|=
name|e1000_check_for_fiber_link_generic
expr_stmt|;
comment|/* multicast address update */
name|mac
operator|->
name|ops
operator|.
name|update_mc_addr_list
operator|=
name|e1000_update_mc_addr_list_generic
expr_stmt|;
comment|/* writing VFTA */
name|mac
operator|->
name|ops
operator|.
name|write_vfta
operator|=
name|e1000_write_vfta_generic
expr_stmt|;
comment|/* clearing VFTA */
name|mac
operator|->
name|ops
operator|.
name|clear_vfta
operator|=
name|e1000_clear_vfta_generic
expr_stmt|;
comment|/* read mac address */
name|mac
operator|->
name|ops
operator|.
name|read_mac_addr
operator|=
name|e1000_read_mac_addr_82542
expr_stmt|;
comment|/* set RAR */
name|mac
operator|->
name|ops
operator|.
name|rar_set
operator|=
name|e1000_rar_set_82542
expr_stmt|;
comment|/* turn on/off LED */
name|mac
operator|->
name|ops
operator|.
name|led_on
operator|=
name|e1000_led_on_82542
expr_stmt|;
name|mac
operator|->
name|ops
operator|.
name|led_off
operator|=
name|e1000_led_off_82542
expr_stmt|;
comment|/* clear hardware counters */
name|mac
operator|->
name|ops
operator|.
name|clear_hw_cntrs
operator|=
name|e1000_clear_hw_cntrs_82542
expr_stmt|;
comment|/* link info */
name|mac
operator|->
name|ops
operator|.
name|get_link_up_info
operator|=
name|e1000_get_speed_and_duplex_fiber_serdes_generic
expr_stmt|;
return|return
name|E1000_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**  *  e1000_init_function_pointers_82542 - Init func ptrs.  *  @hw: pointer to the HW structure  *  *  Called to initialize all function pointers and parameters.  **/
end_comment

begin_function
name|void
name|e1000_init_function_pointers_82542
parameter_list|(
name|struct
name|e1000_hw
modifier|*
name|hw
parameter_list|)
block|{
name|DEBUGFUNC
argument_list|(
literal|"e1000_init_function_pointers_82542"
argument_list|)
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|init_params
operator|=
name|e1000_init_mac_params_82542
expr_stmt|;
name|hw
operator|->
name|nvm
operator|.
name|ops
operator|.
name|init_params
operator|=
name|e1000_init_nvm_params_82542
expr_stmt|;
name|hw
operator|->
name|phy
operator|.
name|ops
operator|.
name|init_params
operator|=
name|e1000_init_phy_params_82542
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  *  e1000_get_bus_info_82542 - Obtain bus information for adapter  *  @hw: pointer to the HW structure  *  *  This will obtain information about the HW bus for which the  *  adapter is attached and stores it in the hw structure.  **/
end_comment

begin_function
specifier|static
name|s32
name|e1000_get_bus_info_82542
parameter_list|(
name|struct
name|e1000_hw
modifier|*
name|hw
parameter_list|)
block|{
name|DEBUGFUNC
argument_list|(
literal|"e1000_get_bus_info_82542"
argument_list|)
expr_stmt|;
name|hw
operator|->
name|bus
operator|.
name|type
operator|=
name|e1000_bus_type_pci
expr_stmt|;
name|hw
operator|->
name|bus
operator|.
name|speed
operator|=
name|e1000_bus_speed_unknown
expr_stmt|;
name|hw
operator|->
name|bus
operator|.
name|width
operator|=
name|e1000_bus_width_unknown
expr_stmt|;
return|return
name|E1000_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**  *  e1000_reset_hw_82542 - Reset hardware  *  @hw: pointer to the HW structure  *  *  This resets the hardware into a known state.  **/
end_comment

begin_function
specifier|static
name|s32
name|e1000_reset_hw_82542
parameter_list|(
name|struct
name|e1000_hw
modifier|*
name|hw
parameter_list|)
block|{
name|struct
name|e1000_bus_info
modifier|*
name|bus
init|=
operator|&
name|hw
operator|->
name|bus
decl_stmt|;
name|s32
name|ret_val
init|=
name|E1000_SUCCESS
decl_stmt|;
name|u32
name|ctrl
decl_stmt|,
name|icr
decl_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"e1000_reset_hw_82542"
argument_list|)
expr_stmt|;
if|if
condition|(
name|hw
operator|->
name|revision_id
operator|==
name|E1000_REVISION_2
condition|)
block|{
name|DEBUGOUT
argument_list|(
literal|"Disabling MWI on 82542 rev 2\n"
argument_list|)
expr_stmt|;
name|e1000_pci_clear_mwi
argument_list|(
name|hw
argument_list|)
expr_stmt|;
block|}
name|DEBUGOUT
argument_list|(
literal|"Masking off all interrupts\n"
argument_list|)
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|E1000_IMC
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|E1000_RCTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|E1000_TCTL
argument_list|,
name|E1000_TCTL_PSP
argument_list|)
expr_stmt|;
name|E1000_WRITE_FLUSH
argument_list|(
name|hw
argument_list|)
expr_stmt|;
comment|/* 	 * Delay to allow any outstanding PCI transactions to complete before 	 * resetting the device 	 */
name|msec_delay
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|ctrl
operator|=
name|E1000_READ_REG
argument_list|(
name|hw
argument_list|,
name|E1000_CTRL
argument_list|)
expr_stmt|;
name|DEBUGOUT
argument_list|(
literal|"Issuing a global reset to 82542/82543 MAC\n"
argument_list|)
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|E1000_CTRL
argument_list|,
name|ctrl
operator||
name|E1000_CTRL_RST
argument_list|)
expr_stmt|;
name|hw
operator|->
name|nvm
operator|.
name|ops
operator|.
name|reload
argument_list|(
name|hw
argument_list|)
expr_stmt|;
name|msec_delay
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|E1000_IMC
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|icr
operator|=
name|E1000_READ_REG
argument_list|(
name|hw
argument_list|,
name|E1000_ICR
argument_list|)
expr_stmt|;
if|if
condition|(
name|hw
operator|->
name|revision_id
operator|==
name|E1000_REVISION_2
condition|)
block|{
if|if
condition|(
name|bus
operator|->
name|pci_cmd_word
operator|&
name|CMD_MEM_WRT_INVALIDATE
condition|)
name|e1000_pci_set_mwi
argument_list|(
name|hw
argument_list|)
expr_stmt|;
block|}
return|return
name|ret_val
return|;
block|}
end_function

begin_comment
comment|/**  *  e1000_init_hw_82542 - Initialize hardware  *  @hw: pointer to the HW structure  *  *  This inits the hardware readying it for operation.  **/
end_comment

begin_function
specifier|static
name|s32
name|e1000_init_hw_82542
parameter_list|(
name|struct
name|e1000_hw
modifier|*
name|hw
parameter_list|)
block|{
name|struct
name|e1000_mac_info
modifier|*
name|mac
init|=
operator|&
name|hw
operator|->
name|mac
decl_stmt|;
name|struct
name|e1000_dev_spec_82542
modifier|*
name|dev_spec
init|=
operator|&
name|hw
operator|->
name|dev_spec
operator|.
name|_82542
decl_stmt|;
name|s32
name|ret_val
init|=
name|E1000_SUCCESS
decl_stmt|;
name|u32
name|ctrl
decl_stmt|;
name|u16
name|i
decl_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"e1000_init_hw_82542"
argument_list|)
expr_stmt|;
comment|/* Disabling VLAN filtering */
name|E1000_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|E1000_VET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mac
operator|->
name|ops
operator|.
name|clear_vfta
argument_list|(
name|hw
argument_list|)
expr_stmt|;
comment|/* For 82542 (rev 2.0), disable MWI and put the receiver into reset */
if|if
condition|(
name|hw
operator|->
name|revision_id
operator|==
name|E1000_REVISION_2
condition|)
block|{
name|DEBUGOUT
argument_list|(
literal|"Disabling MWI on 82542 rev 2.0\n"
argument_list|)
expr_stmt|;
name|e1000_pci_clear_mwi
argument_list|(
name|hw
argument_list|)
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|E1000_RCTL
argument_list|,
name|E1000_RCTL_RST
argument_list|)
expr_stmt|;
name|E1000_WRITE_FLUSH
argument_list|(
name|hw
argument_list|)
expr_stmt|;
name|msec_delay
argument_list|(
literal|5
argument_list|)
expr_stmt|;
block|}
comment|/* Setup the receive address. */
name|e1000_init_rx_addrs_generic
argument_list|(
name|hw
argument_list|,
name|mac
operator|->
name|rar_entry_count
argument_list|)
expr_stmt|;
comment|/* For 82542 (rev 2.0), take the receiver out of reset and enable MWI */
if|if
condition|(
name|hw
operator|->
name|revision_id
operator|==
name|E1000_REVISION_2
condition|)
block|{
name|E1000_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|E1000_RCTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|E1000_WRITE_FLUSH
argument_list|(
name|hw
argument_list|)
expr_stmt|;
name|msec_delay
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|hw
operator|->
name|bus
operator|.
name|pci_cmd_word
operator|&
name|CMD_MEM_WRT_INVALIDATE
condition|)
name|e1000_pci_set_mwi
argument_list|(
name|hw
argument_list|)
expr_stmt|;
block|}
comment|/* Zero out the Multicast HASH table */
name|DEBUGOUT
argument_list|(
literal|"Zeroing the MTA\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|mac
operator|->
name|mta_reg_count
condition|;
name|i
operator|++
control|)
name|E1000_WRITE_REG_ARRAY
argument_list|(
name|hw
argument_list|,
name|E1000_MTA
argument_list|,
name|i
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* 	 * Set the PCI priority bit correctly in the CTRL register.  This 	 * determines if the adapter gives priority to receives, or if it 	 * gives equal priority to transmits and receives. 	 */
if|if
condition|(
name|dev_spec
operator|->
name|dma_fairness
condition|)
block|{
name|ctrl
operator|=
name|E1000_READ_REG
argument_list|(
name|hw
argument_list|,
name|E1000_CTRL
argument_list|)
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|E1000_CTRL
argument_list|,
name|ctrl
operator||
name|E1000_CTRL_PRIOR
argument_list|)
expr_stmt|;
block|}
comment|/* Setup link and flow control */
name|ret_val
operator|=
name|e1000_setup_link_82542
argument_list|(
name|hw
argument_list|)
expr_stmt|;
comment|/* 	 * Clear all of the statistics registers (clear on read).  It is 	 * important that we do this after we have tried to establish link 	 * because the symbol error count will increment wildly if there 	 * is no link. 	 */
name|e1000_clear_hw_cntrs_82542
argument_list|(
name|hw
argument_list|)
expr_stmt|;
return|return
name|ret_val
return|;
block|}
end_function

begin_comment
comment|/**  *  e1000_setup_link_82542 - Setup flow control and link settings  *  @hw: pointer to the HW structure  *  *  Determines which flow control settings to use, then configures flow  *  control.  Calls the appropriate media-specific link configuration  *  function.  Assuming the adapter has a valid link partner, a valid link  *  should be established.  Assumes the hardware has previously been reset  *  and the transmitter and receiver are not enabled.  **/
end_comment

begin_function
specifier|static
name|s32
name|e1000_setup_link_82542
parameter_list|(
name|struct
name|e1000_hw
modifier|*
name|hw
parameter_list|)
block|{
name|struct
name|e1000_mac_info
modifier|*
name|mac
init|=
operator|&
name|hw
operator|->
name|mac
decl_stmt|;
name|s32
name|ret_val
init|=
name|E1000_SUCCESS
decl_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"e1000_setup_link_82542"
argument_list|)
expr_stmt|;
name|ret_val
operator|=
name|e1000_set_default_fc_generic
argument_list|(
name|hw
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret_val
condition|)
goto|goto
name|out
goto|;
name|hw
operator|->
name|fc
operator|.
name|requested_mode
operator|&=
operator|~
name|e1000_fc_tx_pause
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|report_tx_early
operator|==
literal|1
condition|)
name|hw
operator|->
name|fc
operator|.
name|requested_mode
operator|&=
operator|~
name|e1000_fc_rx_pause
expr_stmt|;
comment|/* 	 * Save off the requested flow control mode for use later.  Depending 	 * on the link partner's capabilities, we may or may not use this mode. 	 */
name|hw
operator|->
name|fc
operator|.
name|current_mode
operator|=
name|hw
operator|->
name|fc
operator|.
name|requested_mode
expr_stmt|;
name|DEBUGOUT1
argument_list|(
literal|"After fix-ups FlowControl is now = %x\n"
argument_list|,
name|hw
operator|->
name|fc
operator|.
name|current_mode
argument_list|)
expr_stmt|;
comment|/* Call the necessary subroutine to configure the link. */
name|ret_val
operator|=
name|mac
operator|->
name|ops
operator|.
name|setup_physical_interface
argument_list|(
name|hw
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret_val
condition|)
goto|goto
name|out
goto|;
comment|/* 	 * Initialize the flow control address, type, and PAUSE timer 	 * registers to their default values.  This is done even if flow 	 * control is disabled, because it does not hurt anything to 	 * initialize these registers. 	 */
name|DEBUGOUT
argument_list|(
literal|"Initializing Flow Control address, type and timer regs\n"
argument_list|)
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|E1000_FCAL
argument_list|,
name|FLOW_CONTROL_ADDRESS_LOW
argument_list|)
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|E1000_FCAH
argument_list|,
name|FLOW_CONTROL_ADDRESS_HIGH
argument_list|)
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|E1000_FCT
argument_list|,
name|FLOW_CONTROL_TYPE
argument_list|)
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|E1000_FCTTV
argument_list|,
name|hw
operator|->
name|fc
operator|.
name|pause_time
argument_list|)
expr_stmt|;
name|ret_val
operator|=
name|e1000_set_fc_watermarks_generic
argument_list|(
name|hw
argument_list|)
expr_stmt|;
name|out
label|:
return|return
name|ret_val
return|;
block|}
end_function

begin_comment
comment|/**  *  e1000_led_on_82542 - Turn on SW controllable LED  *  @hw: pointer to the HW structure  *  *  Turns the SW defined LED on.  **/
end_comment

begin_function
specifier|static
name|s32
name|e1000_led_on_82542
parameter_list|(
name|struct
name|e1000_hw
modifier|*
name|hw
parameter_list|)
block|{
name|u32
name|ctrl
init|=
name|E1000_READ_REG
argument_list|(
name|hw
argument_list|,
name|E1000_CTRL
argument_list|)
decl_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"e1000_led_on_82542"
argument_list|)
expr_stmt|;
name|ctrl
operator||=
name|E1000_CTRL_SWDPIN0
expr_stmt|;
name|ctrl
operator||=
name|E1000_CTRL_SWDPIO0
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|E1000_CTRL
argument_list|,
name|ctrl
argument_list|)
expr_stmt|;
return|return
name|E1000_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**  *  e1000_led_off_82542 - Turn off SW controllable LED  *  @hw: pointer to the HW structure  *  *  Turns the SW defined LED off.  **/
end_comment

begin_function
specifier|static
name|s32
name|e1000_led_off_82542
parameter_list|(
name|struct
name|e1000_hw
modifier|*
name|hw
parameter_list|)
block|{
name|u32
name|ctrl
init|=
name|E1000_READ_REG
argument_list|(
name|hw
argument_list|,
name|E1000_CTRL
argument_list|)
decl_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"e1000_led_off_82542"
argument_list|)
expr_stmt|;
name|ctrl
operator|&=
operator|~
name|E1000_CTRL_SWDPIN0
expr_stmt|;
name|ctrl
operator||=
name|E1000_CTRL_SWDPIO0
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|E1000_CTRL
argument_list|,
name|ctrl
argument_list|)
expr_stmt|;
return|return
name|E1000_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**  *  e1000_rar_set_82542 - Set receive address register  *  @hw: pointer to the HW structure  *  @addr: pointer to the receive address  *  @index: receive address array register  *  *  Sets the receive address array register at index to the address passed  *  in by addr.  **/
end_comment

begin_function
specifier|static
name|void
name|e1000_rar_set_82542
parameter_list|(
name|struct
name|e1000_hw
modifier|*
name|hw
parameter_list|,
name|u8
modifier|*
name|addr
parameter_list|,
name|u32
name|index
parameter_list|)
block|{
name|u32
name|rar_low
decl_stmt|,
name|rar_high
decl_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"e1000_rar_set_82542"
argument_list|)
expr_stmt|;
comment|/* 	 * HW expects these in little endian so we reverse the byte order 	 * from network order (big endian) to little endian 	 */
name|rar_low
operator|=
operator|(
operator|(
name|u32
operator|)
name|addr
index|[
literal|0
index|]
operator||
operator|(
operator|(
name|u32
operator|)
name|addr
index|[
literal|1
index|]
operator|<<
literal|8
operator|)
operator||
operator|(
operator|(
name|u32
operator|)
name|addr
index|[
literal|2
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
operator|(
name|u32
operator|)
name|addr
index|[
literal|3
index|]
operator|<<
literal|24
operator|)
operator|)
expr_stmt|;
name|rar_high
operator|=
operator|(
operator|(
name|u32
operator|)
name|addr
index|[
literal|4
index|]
operator||
operator|(
operator|(
name|u32
operator|)
name|addr
index|[
literal|5
index|]
operator|<<
literal|8
operator|)
operator|)
expr_stmt|;
comment|/* If MAC address zero, no need to set the AV bit */
if|if
condition|(
name|rar_low
operator|||
name|rar_high
condition|)
name|rar_high
operator||=
name|E1000_RAH_AV
expr_stmt|;
name|E1000_WRITE_REG_ARRAY
argument_list|(
name|hw
argument_list|,
name|E1000_RA
argument_list|,
operator|(
name|index
operator|<<
literal|1
operator|)
argument_list|,
name|rar_low
argument_list|)
expr_stmt|;
name|E1000_WRITE_REG_ARRAY
argument_list|(
name|hw
argument_list|,
name|E1000_RA
argument_list|,
operator|(
operator|(
name|index
operator|<<
literal|1
operator|)
operator|+
literal|1
operator|)
argument_list|,
name|rar_high
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  *  e1000_translate_register_82542 - Translate the proper register offset  *  @reg: e1000 register to be read  *  *  Registers in 82542 are located in different offsets than other adapters  *  even though they function in the same manner.  This function takes in  *  the name of the register to read and returns the correct offset for  *  82542 silicon.  **/
end_comment

begin_function
name|u32
name|e1000_translate_register_82542
parameter_list|(
name|u32
name|reg
parameter_list|)
block|{
comment|/* 	 * Some of the 82542 registers are located at different 	 * offsets than they are in newer adapters. 	 * Despite the difference in location, the registers 	 * function in the same manner. 	 */
switch|switch
condition|(
name|reg
condition|)
block|{
case|case
name|E1000_RA
case|:
name|reg
operator|=
literal|0x00040
expr_stmt|;
break|break;
case|case
name|E1000_RDTR
case|:
name|reg
operator|=
literal|0x00108
expr_stmt|;
break|break;
case|case
name|E1000_RDBAL
argument_list|(
literal|0
argument_list|)
case|:
name|reg
operator|=
literal|0x00110
expr_stmt|;
break|break;
case|case
name|E1000_RDBAH
argument_list|(
literal|0
argument_list|)
case|:
name|reg
operator|=
literal|0x00114
expr_stmt|;
break|break;
case|case
name|E1000_RDLEN
argument_list|(
literal|0
argument_list|)
case|:
name|reg
operator|=
literal|0x00118
expr_stmt|;
break|break;
case|case
name|E1000_RDH
argument_list|(
literal|0
argument_list|)
case|:
name|reg
operator|=
literal|0x00120
expr_stmt|;
break|break;
case|case
name|E1000_RDT
argument_list|(
literal|0
argument_list|)
case|:
name|reg
operator|=
literal|0x00128
expr_stmt|;
break|break;
case|case
name|E1000_RDBAL
argument_list|(
literal|1
argument_list|)
case|:
name|reg
operator|=
literal|0x00138
expr_stmt|;
break|break;
case|case
name|E1000_RDBAH
argument_list|(
literal|1
argument_list|)
case|:
name|reg
operator|=
literal|0x0013C
expr_stmt|;
break|break;
case|case
name|E1000_RDLEN
argument_list|(
literal|1
argument_list|)
case|:
name|reg
operator|=
literal|0x00140
expr_stmt|;
break|break;
case|case
name|E1000_RDH
argument_list|(
literal|1
argument_list|)
case|:
name|reg
operator|=
literal|0x00148
expr_stmt|;
break|break;
case|case
name|E1000_RDT
argument_list|(
literal|1
argument_list|)
case|:
name|reg
operator|=
literal|0x00150
expr_stmt|;
break|break;
case|case
name|E1000_FCRTH
case|:
name|reg
operator|=
literal|0x00160
expr_stmt|;
break|break;
case|case
name|E1000_FCRTL
case|:
name|reg
operator|=
literal|0x00168
expr_stmt|;
break|break;
case|case
name|E1000_MTA
case|:
name|reg
operator|=
literal|0x00200
expr_stmt|;
break|break;
case|case
name|E1000_TDBAL
argument_list|(
literal|0
argument_list|)
case|:
name|reg
operator|=
literal|0x00420
expr_stmt|;
break|break;
case|case
name|E1000_TDBAH
argument_list|(
literal|0
argument_list|)
case|:
name|reg
operator|=
literal|0x00424
expr_stmt|;
break|break;
case|case
name|E1000_TDLEN
argument_list|(
literal|0
argument_list|)
case|:
name|reg
operator|=
literal|0x00428
expr_stmt|;
break|break;
case|case
name|E1000_TDH
argument_list|(
literal|0
argument_list|)
case|:
name|reg
operator|=
literal|0x00430
expr_stmt|;
break|break;
case|case
name|E1000_TDT
argument_list|(
literal|0
argument_list|)
case|:
name|reg
operator|=
literal|0x00438
expr_stmt|;
break|break;
case|case
name|E1000_TIDV
case|:
name|reg
operator|=
literal|0x00440
expr_stmt|;
break|break;
case|case
name|E1000_VFTA
case|:
name|reg
operator|=
literal|0x00600
expr_stmt|;
break|break;
case|case
name|E1000_TDFH
case|:
name|reg
operator|=
literal|0x08010
expr_stmt|;
break|break;
case|case
name|E1000_TDFT
case|:
name|reg
operator|=
literal|0x08018
expr_stmt|;
break|break;
default|default:
break|break;
block|}
return|return
name|reg
return|;
block|}
end_function

begin_comment
comment|/**  *  e1000_clear_hw_cntrs_82542 - Clear device specific hardware counters  *  @hw: pointer to the HW structure  *  *  Clears the hardware counters by reading the counter registers.  **/
end_comment

begin_function
specifier|static
name|void
name|e1000_clear_hw_cntrs_82542
parameter_list|(
name|struct
name|e1000_hw
modifier|*
name|hw
parameter_list|)
block|{
name|DEBUGFUNC
argument_list|(
literal|"e1000_clear_hw_cntrs_82542"
argument_list|)
expr_stmt|;
name|e1000_clear_hw_cntrs_base_generic
argument_list|(
name|hw
argument_list|)
expr_stmt|;
name|E1000_READ_REG
argument_list|(
name|hw
argument_list|,
name|E1000_PRC64
argument_list|)
expr_stmt|;
name|E1000_READ_REG
argument_list|(
name|hw
argument_list|,
name|E1000_PRC127
argument_list|)
expr_stmt|;
name|E1000_READ_REG
argument_list|(
name|hw
argument_list|,
name|E1000_PRC255
argument_list|)
expr_stmt|;
name|E1000_READ_REG
argument_list|(
name|hw
argument_list|,
name|E1000_PRC511
argument_list|)
expr_stmt|;
name|E1000_READ_REG
argument_list|(
name|hw
argument_list|,
name|E1000_PRC1023
argument_list|)
expr_stmt|;
name|E1000_READ_REG
argument_list|(
name|hw
argument_list|,
name|E1000_PRC1522
argument_list|)
expr_stmt|;
name|E1000_READ_REG
argument_list|(
name|hw
argument_list|,
name|E1000_PTC64
argument_list|)
expr_stmt|;
name|E1000_READ_REG
argument_list|(
name|hw
argument_list|,
name|E1000_PTC127
argument_list|)
expr_stmt|;
name|E1000_READ_REG
argument_list|(
name|hw
argument_list|,
name|E1000_PTC255
argument_list|)
expr_stmt|;
name|E1000_READ_REG
argument_list|(
name|hw
argument_list|,
name|E1000_PTC511
argument_list|)
expr_stmt|;
name|E1000_READ_REG
argument_list|(
name|hw
argument_list|,
name|E1000_PTC1023
argument_list|)
expr_stmt|;
name|E1000_READ_REG
argument_list|(
name|hw
argument_list|,
name|E1000_PTC1522
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  *  e1000_read_mac_addr_82542 - Read device MAC address  *  @hw: pointer to the HW structure  *  *  Reads the device MAC address from the EEPROM and stores the value.  **/
end_comment

begin_function
specifier|static
name|s32
name|e1000_read_mac_addr_82542
parameter_list|(
name|struct
name|e1000_hw
modifier|*
name|hw
parameter_list|)
block|{
name|s32
name|ret_val
init|=
name|E1000_SUCCESS
decl_stmt|;
name|u16
name|offset
decl_stmt|,
name|nvm_data
decl_stmt|,
name|i
decl_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"e1000_read_mac_addr"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ETH_ADDR_LEN
condition|;
name|i
operator|+=
literal|2
control|)
block|{
name|offset
operator|=
name|i
operator|>>
literal|1
expr_stmt|;
name|ret_val
operator|=
name|hw
operator|->
name|nvm
operator|.
name|ops
operator|.
name|read
argument_list|(
name|hw
argument_list|,
name|offset
argument_list|,
literal|1
argument_list|,
operator|&
name|nvm_data
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret_val
condition|)
block|{
name|DEBUGOUT
argument_list|(
literal|"NVM Read Error\n"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|hw
operator|->
name|mac
operator|.
name|perm_addr
index|[
name|i
index|]
operator|=
call|(
name|u8
call|)
argument_list|(
name|nvm_data
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|perm_addr
index|[
name|i
operator|+
literal|1
index|]
operator|=
call|(
name|u8
call|)
argument_list|(
name|nvm_data
operator|>>
literal|8
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ETH_ADDR_LEN
condition|;
name|i
operator|++
control|)
name|hw
operator|->
name|mac
operator|.
name|addr
index|[
name|i
index|]
operator|=
name|hw
operator|->
name|mac
operator|.
name|perm_addr
index|[
name|i
index|]
expr_stmt|;
name|out
label|:
return|return
name|ret_val
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2013-2014 Qlogic Corporation  * All rights reserved.  *  *  Redistribution and use in source and binary forms, with or without  *  modification, are permitted provided that the following conditions  *  are met:  *  *  1. Redistributions of source code must retain the above copyright  *     notice, this list of conditions and the following disclaimer.  *  2. Redistributions in binary form must reproduce the above copyright  *     notice, this list of conditions and the following disclaimer in the  *     documentation and/or other materials provided with the distribution.  *  *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"  *  AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  *  IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  *  ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE  *  LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR  *  CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  *  SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS  *  INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN  *  CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  *  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE  *  POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_comment
comment|/*  * File: ql_hw.c  * Author : David C Somayajulu, Qlogic Corporation, Aliso Viejo, CA 92656.  * Content: Contains Hardware dependant functions  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"ql_os.h"
end_include

begin_include
include|#
directive|include
file|"ql_hw.h"
end_include

begin_include
include|#
directive|include
file|"ql_def.h"
end_include

begin_include
include|#
directive|include
file|"ql_inline.h"
end_include

begin_include
include|#
directive|include
file|"ql_ver.h"
end_include

begin_include
include|#
directive|include
file|"ql_glbl.h"
end_include

begin_include
include|#
directive|include
file|"ql_dbg.h"
end_include

begin_comment
comment|/*  * Static Functions  */
end_comment

begin_function_decl
specifier|static
name|void
name|qla_del_rcv_cntxt
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qla_init_rcv_cntxt
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|qla_del_xmt_cntxt
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qla_init_xmt_cntxt
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|qla_hw_tx_done_locked
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint32_t
name|txr_idx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qla_mbx_cmd
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint32_t
modifier|*
name|h_mbox
parameter_list|,
name|uint32_t
name|n_hmbox
parameter_list|,
name|uint32_t
modifier|*
name|fw_mbox
parameter_list|,
name|uint32_t
name|n_fwmbox
parameter_list|,
name|uint32_t
name|no_pause
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qla_config_intr_cntxt
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint32_t
name|num_intrs
parameter_list|,
name|uint32_t
name|create
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qla_get_nic_partition
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qla_config_rss
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint16_t
name|cntxt_id
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qla_config_intr_coalesce
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint16_t
name|cntxt_id
parameter_list|,
name|int
name|tenable
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qla_set_mac_rcv_mode
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint32_t
name|mode
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qla_link_event_req
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint16_t
name|cntxt_id
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qla_tx_tso
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|struct
name|mbuf
modifier|*
name|mp
parameter_list|,
name|q80_tx_cmd_t
modifier|*
name|tx_cmd
parameter_list|,
name|uint8_t
modifier|*
name|hdr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qla_hw_add_all_mcast
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qla_hw_del_all_mcast
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qla_add_rcv_rings
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint32_t
name|sds_idx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qla_minidump_init
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|qla_minidump_free
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|int
name|qla_sysctl_get_drvr_stats
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|int
name|err
init|=
literal|0
decl_stmt|,
name|ret
decl_stmt|;
name|qla_host_t
modifier|*
name|ha
decl_stmt|;
name|uint32_t
name|i
decl_stmt|;
name|err
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|ret
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|||
operator|!
name|req
operator|->
name|newptr
condition|)
return|return
operator|(
name|err
operator|)
return|;
if|if
condition|(
name|ret
operator|==
literal|1
condition|)
block|{
name|ha
operator|=
operator|(
name|qla_host_t
operator|*
operator|)
name|arg1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|hw
operator|.
name|num_sds_rings
condition|;
name|i
operator|++
control|)
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"%s: sds_ring[%d] = %p\n"
argument_list|,
name|__func__
argument_list|,
name|i
argument_list|,
operator|(
name|void
operator|*
operator|)
name|ha
operator|->
name|hw
operator|.
name|sds
index|[
name|i
index|]
operator|.
name|intr_count
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|hw
operator|.
name|num_tx_rings
condition|;
name|i
operator|++
control|)
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"%s: tx[%d] = %p\n"
argument_list|,
name|__func__
argument_list|,
name|i
argument_list|,
operator|(
name|void
operator|*
operator|)
name|ha
operator|->
name|tx_ring
index|[
name|i
index|]
operator|.
name|count
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|hw
operator|.
name|num_rds_rings
condition|;
name|i
operator|++
control|)
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"%s: rds_ring[%d] = %p\n"
argument_list|,
name|__func__
argument_list|,
name|i
argument_list|,
operator|(
name|void
operator|*
operator|)
name|ha
operator|->
name|hw
operator|.
name|rds
index|[
name|i
index|]
operator|.
name|count
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"%s: lro_pkt_count = %p\n"
argument_list|,
name|__func__
argument_list|,
operator|(
name|void
operator|*
operator|)
name|ha
operator|->
name|lro_pkt_count
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"%s: lro_bytes = %p\n"
argument_list|,
name|__func__
argument_list|,
operator|(
name|void
operator|*
operator|)
name|ha
operator|->
name|lro_bytes
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|QL_DBG
end_ifdef

begin_function
specifier|static
name|void
name|qla_stop_pegs
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|uint32_t
name|val
init|=
literal|1
decl_stmt|;
name|ql_rdwr_indreg32
argument_list|(
name|ha
argument_list|,
name|Q8_CRB_PEG_0
argument_list|,
operator|&
name|val
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ql_rdwr_indreg32
argument_list|(
name|ha
argument_list|,
name|Q8_CRB_PEG_1
argument_list|,
operator|&
name|val
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ql_rdwr_indreg32
argument_list|(
name|ha
argument_list|,
name|Q8_CRB_PEG_2
argument_list|,
operator|&
name|val
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ql_rdwr_indreg32
argument_list|(
name|ha
argument_list|,
name|Q8_CRB_PEG_3
argument_list|,
operator|&
name|val
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ql_rdwr_indreg32
argument_list|(
name|ha
argument_list|,
name|Q8_CRB_PEG_4
argument_list|,
operator|&
name|val
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"%s PEGS HALTED!!!!!\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|qla_sysctl_stop_pegs
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|int
name|err
decl_stmt|,
name|ret
init|=
literal|0
decl_stmt|;
name|qla_host_t
modifier|*
name|ha
decl_stmt|;
name|err
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|ret
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|||
operator|!
name|req
operator|->
name|newptr
condition|)
return|return
operator|(
name|err
operator|)
return|;
if|if
condition|(
name|ret
operator|==
literal|1
condition|)
block|{
name|ha
operator|=
operator|(
name|qla_host_t
operator|*
operator|)
name|arg1
expr_stmt|;
operator|(
name|void
operator|)
name|QLA_LOCK
argument_list|(
name|ha
argument_list|,
name|__func__
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|qla_stop_pegs
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|QLA_UNLOCK
argument_list|(
name|ha
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
block|}
return|return
name|err
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* #ifdef QL_DBG */
end_comment

begin_comment
comment|/*  * Name: ql_hw_add_sysctls  * Function: Add P3Plus specific sysctls  */
end_comment

begin_function
name|void
name|ql_hw_add_sysctls
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|device_t
name|dev
decl_stmt|;
name|dev
operator|=
name|ha
operator|->
name|pci_dev
expr_stmt|;
name|ha
operator|->
name|hw
operator|.
name|num_sds_rings
operator|=
name|MAX_SDS_RINGS
expr_stmt|;
name|ha
operator|->
name|hw
operator|.
name|num_rds_rings
operator|=
name|MAX_RDS_RINGS
expr_stmt|;
name|ha
operator|->
name|hw
operator|.
name|num_tx_rings
operator|=
name|NUM_TX_RINGS
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|device_get_sysctl_ctx
argument_list|(
name|dev
argument_list|)
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|device_get_sysctl_tree
argument_list|(
name|dev
argument_list|)
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"num_rds_rings"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw
operator|.
name|num_rds_rings
argument_list|,
name|ha
operator|->
name|hw
operator|.
name|num_rds_rings
argument_list|,
literal|"Number of Rcv Descriptor Rings"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|device_get_sysctl_ctx
argument_list|(
name|dev
argument_list|)
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|device_get_sysctl_tree
argument_list|(
name|dev
argument_list|)
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"num_sds_rings"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw
operator|.
name|num_sds_rings
argument_list|,
name|ha
operator|->
name|hw
operator|.
name|num_sds_rings
argument_list|,
literal|"Number of Status Descriptor Rings"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|device_get_sysctl_ctx
argument_list|(
name|dev
argument_list|)
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|device_get_sysctl_tree
argument_list|(
name|dev
argument_list|)
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"num_tx_rings"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw
operator|.
name|num_tx_rings
argument_list|,
name|ha
operator|->
name|hw
operator|.
name|num_tx_rings
argument_list|,
literal|"Number of Transmit Rings"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|device_get_sysctl_ctx
argument_list|(
name|dev
argument_list|)
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|device_get_sysctl_tree
argument_list|(
name|dev
argument_list|)
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_ring_index"
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|ha
operator|->
name|txr_idx
argument_list|,
name|ha
operator|->
name|txr_idx
argument_list|,
literal|"Tx Ring Used"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
name|device_get_sysctl_ctx
argument_list|(
name|dev
argument_list|)
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|device_get_sysctl_tree
argument_list|(
name|dev
argument_list|)
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"drvr_stats"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RW
argument_list|,
operator|(
name|void
operator|*
operator|)
name|ha
argument_list|,
literal|0
argument_list|,
name|qla_sysctl_get_drvr_stats
argument_list|,
literal|"I"
argument_list|,
literal|"Driver Maintained Statistics"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|device_get_sysctl_ctx
argument_list|(
name|dev
argument_list|)
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|device_get_sysctl_tree
argument_list|(
name|dev
argument_list|)
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"max_tx_segs"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw
operator|.
name|max_tx_segs
argument_list|,
name|ha
operator|->
name|hw
operator|.
name|max_tx_segs
argument_list|,
literal|"Max # of Segments in a non-TSO pkt"
argument_list|)
expr_stmt|;
name|ha
operator|->
name|hw
operator|.
name|sds_cidx_thres
operator|=
literal|32
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|device_get_sysctl_ctx
argument_list|(
name|dev
argument_list|)
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|device_get_sysctl_tree
argument_list|(
name|dev
argument_list|)
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"sds_cidx_thres"
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|ha
operator|->
name|hw
operator|.
name|sds_cidx_thres
argument_list|,
name|ha
operator|->
name|hw
operator|.
name|sds_cidx_thres
argument_list|,
literal|"Number of SDS entries to process before updating"
literal|" SDS Ring Consumer Index"
argument_list|)
expr_stmt|;
name|ha
operator|->
name|hw
operator|.
name|rds_pidx_thres
operator|=
literal|32
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|device_get_sysctl_ctx
argument_list|(
name|dev
argument_list|)
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|device_get_sysctl_tree
argument_list|(
name|dev
argument_list|)
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rds_pidx_thres"
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|ha
operator|->
name|hw
operator|.
name|rds_pidx_thres
argument_list|,
name|ha
operator|->
name|hw
operator|.
name|rds_pidx_thres
argument_list|,
literal|"Number of Rcv Rings Entries to post before updating"
literal|" RDS Ring Producer Index"
argument_list|)
expr_stmt|;
name|ha
operator|->
name|hw
operator|.
name|min_lro_pkt_size
operator|=
literal|512
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|device_get_sysctl_ctx
argument_list|(
name|dev
argument_list|)
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|device_get_sysctl_tree
argument_list|(
name|dev
argument_list|)
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"min_lro_pkt_size"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw
operator|.
name|min_lro_pkt_size
argument_list|,
name|ha
operator|->
name|hw
operator|.
name|min_lro_pkt_size
argument_list|,
literal|"minimum packet size to trigger lro"
argument_list|)
expr_stmt|;
name|ha
operator|->
name|hw
operator|.
name|mdump_active
operator|=
literal|0
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|device_get_sysctl_ctx
argument_list|(
name|dev
argument_list|)
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|device_get_sysctl_tree
argument_list|(
name|dev
argument_list|)
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"minidump_active"
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|ha
operator|->
name|hw
operator|.
name|mdump_active
argument_list|,
name|ha
operator|->
name|hw
operator|.
name|mdump_active
argument_list|,
literal|"Minidump Utility is Active \n"
literal|"\t 0 = Minidump Utility is not active\n"
literal|"\t 1 = Minidump Utility is retrieved on this port\n"
literal|"\t 2 = Minidump Utility is retrieved on the other port\n"
argument_list|)
expr_stmt|;
name|ha
operator|->
name|hw
operator|.
name|mdump_start
operator|=
literal|0
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|device_get_sysctl_ctx
argument_list|(
name|dev
argument_list|)
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|device_get_sysctl_tree
argument_list|(
name|dev
argument_list|)
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"minidump_start"
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|ha
operator|->
name|hw
operator|.
name|mdump_start
argument_list|,
name|ha
operator|->
name|hw
operator|.
name|mdump_start
argument_list|,
literal|"Minidump Utility can start minidump process"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|QL_DBG
name|SYSCTL_ADD_UINT
argument_list|(
name|device_get_sysctl_ctx
argument_list|(
name|dev
argument_list|)
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|device_get_sysctl_tree
argument_list|(
name|dev
argument_list|)
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"err_inject"
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|ha
operator|->
name|err_inject
argument_list|,
name|ha
operator|->
name|err_inject
argument_list|,
literal|"Error to be injected\n"
literal|"\t\t\t 0: No Errors\n"
literal|"\t\t\t 1: rcv: rxb struct invalid\n"
literal|"\t\t\t 2: rcv: mp == NULL\n"
literal|"\t\t\t 3: lro: rxb struct invalid\n"
literal|"\t\t\t 4: lro: mp == NULL\n"
literal|"\t\t\t 5: rcv: num handles invalid\n"
literal|"\t\t\t 6: reg: indirect reg rd_wr failure\n"
literal|"\t\t\t 7: ocm: offchip memory rd_wr failure\n"
literal|"\t\t\t 8: mbx: mailbox command failure\n"
literal|"\t\t\t 9: heartbeat failure\n"
literal|"\t\t\t A: temperature failure\n"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
name|device_get_sysctl_ctx
argument_list|(
name|dev
argument_list|)
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|device_get_sysctl_tree
argument_list|(
name|dev
argument_list|)
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"peg_stop"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RW
argument_list|,
operator|(
name|void
operator|*
operator|)
name|ha
argument_list|,
literal|0
argument_list|,
name|qla_sysctl_stop_pegs
argument_list|,
literal|"I"
argument_list|,
literal|"Peg Stop"
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* #ifdef QL_DBG */
block|}
end_function

begin_function
name|void
name|ql_hw_link_status
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"cable_oui\t\t 0x%08x\n"
argument_list|,
name|ha
operator|->
name|hw
operator|.
name|cable_oui
argument_list|)
expr_stmt|;
if|if
condition|(
name|ha
operator|->
name|hw
operator|.
name|link_up
condition|)
block|{
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"link Up\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"link Down\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ha
operator|->
name|hw
operator|.
name|flags
operator|.
name|fduplex
condition|)
block|{
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"Full Duplex\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"Half Duplex\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ha
operator|->
name|hw
operator|.
name|flags
operator|.
name|autoneg
condition|)
block|{
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"Auto Negotiation Enabled\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"Auto Negotiation Disabled\n"
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|ha
operator|->
name|hw
operator|.
name|link_speed
condition|)
block|{
case|case
literal|0x710
case|:
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"link speed\t\t 10Gps\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x3E8
case|:
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"link speed\t\t 1Gps\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x64
case|:
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"link speed\t\t 100Mbps\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"link speed\t\t Unknown\n"
argument_list|)
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
name|ha
operator|->
name|hw
operator|.
name|module_type
condition|)
block|{
case|case
literal|0x01
case|:
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"Module Type 10GBase-LRM\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x02
case|:
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"Module Type 10GBase-LR\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x03
case|:
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"Module Type 10GBase-SR\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x04
case|:
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"Module Type 10GE Passive Copper(Compliant)[%d m]\n"
argument_list|,
name|ha
operator|->
name|hw
operator|.
name|cable_length
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x05
case|:
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"Module Type 10GE Active"
literal|" Limiting Copper(Compliant)[%d m]\n"
argument_list|,
name|ha
operator|->
name|hw
operator|.
name|cable_length
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x06
case|:
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"Module Type 10GE Passive Copper"
literal|" (Legacy, Best Effort)[%d m]\n"
argument_list|,
name|ha
operator|->
name|hw
operator|.
name|cable_length
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x07
case|:
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"Module Type 1000Base-SX\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x08
case|:
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"Module Type 1000Base-LX\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x09
case|:
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"Module Type 1000Base-CX\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x0A
case|:
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"Module Type 1000Base-T\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x0B
case|:
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"Module Type 1GE Passive Copper"
literal|"(Legacy, Best Effort)\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"Unknown Module Type 0x%x\n"
argument_list|,
name|ha
operator|->
name|hw
operator|.
name|module_type
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ha
operator|->
name|hw
operator|.
name|link_faults
operator|==
literal|1
condition|)
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"SFP Power Fault\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Name: ql_free_dma  * Function: Frees the DMA'able memory allocated in ql_alloc_dma()  */
end_comment

begin_function
name|void
name|ql_free_dma
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|uint32_t
name|i
decl_stmt|;
if|if
condition|(
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|flags
operator|.
name|sds_ring
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|hw
operator|.
name|num_sds_rings
condition|;
name|i
operator|++
control|)
block|{
name|ql_free_dmabuf
argument_list|(
name|ha
argument_list|,
operator|&
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|sds_ring
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|flags
operator|.
name|sds_ring
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|flags
operator|.
name|rds_ring
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|hw
operator|.
name|num_rds_rings
condition|;
name|i
operator|++
control|)
block|{
name|ql_free_dmabuf
argument_list|(
name|ha
argument_list|,
operator|&
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|rds_ring
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|flags
operator|.
name|rds_ring
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|flags
operator|.
name|tx_ring
condition|)
block|{
name|ql_free_dmabuf
argument_list|(
name|ha
argument_list|,
operator|&
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|tx_ring
argument_list|)
expr_stmt|;
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|flags
operator|.
name|tx_ring
operator|=
literal|0
expr_stmt|;
block|}
name|qla_minidump_free
argument_list|(
name|ha
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Name: ql_alloc_dma  * Function: Allocates DMA'able memory for Tx/Rx Rings, Tx/Rx Contexts.  */
end_comment

begin_function
name|int
name|ql_alloc_dma
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|device_t
name|dev
decl_stmt|;
name|uint32_t
name|i
decl_stmt|,
name|j
decl_stmt|,
name|size
decl_stmt|,
name|tx_ring_size
decl_stmt|;
name|qla_hw_t
modifier|*
name|hw
decl_stmt|;
name|qla_hw_tx_cntxt_t
modifier|*
name|tx_cntxt
decl_stmt|;
name|uint8_t
modifier|*
name|vaddr
decl_stmt|;
name|bus_addr_t
name|paddr
decl_stmt|;
name|dev
operator|=
name|ha
operator|->
name|pci_dev
expr_stmt|;
name|QL_DPRINT2
argument_list|(
name|ha
argument_list|,
operator|(
name|dev
operator|,
literal|"%s: enter\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
name|hw
operator|=
operator|&
name|ha
operator|->
name|hw
expr_stmt|;
comment|/* 	 * Allocate Transmit Ring 	 */
name|tx_ring_size
operator|=
operator|(
sizeof|sizeof
argument_list|(
name|q80_tx_cmd_t
argument_list|)
operator|*
name|NUM_TX_DESCRIPTORS
operator|)
expr_stmt|;
name|size
operator|=
operator|(
name|tx_ring_size
operator|*
name|ha
operator|->
name|hw
operator|.
name|num_tx_rings
operator|)
expr_stmt|;
name|hw
operator|->
name|dma_buf
operator|.
name|tx_ring
operator|.
name|alignment
operator|=
literal|8
expr_stmt|;
name|hw
operator|->
name|dma_buf
operator|.
name|tx_ring
operator|.
name|size
operator|=
name|size
operator|+
name|PAGE_SIZE
expr_stmt|;
if|if
condition|(
name|ql_alloc_dmabuf
argument_list|(
name|ha
argument_list|,
operator|&
name|hw
operator|->
name|dma_buf
operator|.
name|tx_ring
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: tx ring alloc failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
goto|goto
name|ql_alloc_dma_exit
goto|;
block|}
name|vaddr
operator|=
operator|(
name|uint8_t
operator|*
operator|)
name|hw
operator|->
name|dma_buf
operator|.
name|tx_ring
operator|.
name|dma_b
expr_stmt|;
name|paddr
operator|=
name|hw
operator|->
name|dma_buf
operator|.
name|tx_ring
operator|.
name|dma_addr
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|hw
operator|.
name|num_tx_rings
condition|;
name|i
operator|++
control|)
block|{
name|tx_cntxt
operator|=
operator|(
name|qla_hw_tx_cntxt_t
operator|*
operator|)
operator|&
name|hw
operator|->
name|tx_cntxt
index|[
name|i
index|]
expr_stmt|;
name|tx_cntxt
operator|->
name|tx_ring_base
operator|=
operator|(
name|q80_tx_cmd_t
operator|*
operator|)
name|vaddr
expr_stmt|;
name|tx_cntxt
operator|->
name|tx_ring_paddr
operator|=
name|paddr
expr_stmt|;
name|vaddr
operator|+=
name|tx_ring_size
expr_stmt|;
name|paddr
operator|+=
name|tx_ring_size
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|hw
operator|.
name|num_tx_rings
condition|;
name|i
operator|++
control|)
block|{
name|tx_cntxt
operator|=
operator|(
name|qla_hw_tx_cntxt_t
operator|*
operator|)
operator|&
name|hw
operator|->
name|tx_cntxt
index|[
name|i
index|]
expr_stmt|;
name|tx_cntxt
operator|->
name|tx_cons
operator|=
operator|(
name|uint32_t
operator|*
operator|)
name|vaddr
expr_stmt|;
name|tx_cntxt
operator|->
name|tx_cons_paddr
operator|=
name|paddr
expr_stmt|;
name|vaddr
operator|+=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
name|paddr
operator|+=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
block|}
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|flags
operator|.
name|tx_ring
operator|=
literal|1
expr_stmt|;
name|QL_DPRINT2
argument_list|(
name|ha
argument_list|,
operator|(
name|dev
operator|,
literal|"%s: tx_ring phys %p virt %p\n"
operator|,
name|__func__
operator|,
operator|(
name|void
operator|*
operator|)
operator|(
name|hw
operator|->
name|dma_buf
operator|.
name|tx_ring
operator|.
name|dma_addr
operator|)
operator|,
name|hw
operator|->
name|dma_buf
operator|.
name|tx_ring
operator|.
name|dma_b
operator|)
argument_list|)
expr_stmt|;
comment|/* 	 * Allocate Receive Descriptor Rings 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|hw
operator|->
name|num_rds_rings
condition|;
name|i
operator|++
control|)
block|{
name|hw
operator|->
name|dma_buf
operator|.
name|rds_ring
index|[
name|i
index|]
operator|.
name|alignment
operator|=
literal|8
expr_stmt|;
name|hw
operator|->
name|dma_buf
operator|.
name|rds_ring
index|[
name|i
index|]
operator|.
name|size
operator|=
operator|(
sizeof|sizeof
argument_list|(
name|q80_recv_desc_t
argument_list|)
operator|)
operator|*
name|NUM_RX_DESCRIPTORS
expr_stmt|;
if|if
condition|(
name|ql_alloc_dmabuf
argument_list|(
name|ha
argument_list|,
operator|&
name|hw
operator|->
name|dma_buf
operator|.
name|rds_ring
index|[
name|i
index|]
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: rds ring[%d] alloc failed\n"
argument_list|,
name|__func__
argument_list|,
name|i
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|i
condition|;
name|j
operator|++
control|)
name|ql_free_dmabuf
argument_list|(
name|ha
argument_list|,
operator|&
name|hw
operator|->
name|dma_buf
operator|.
name|rds_ring
index|[
name|j
index|]
argument_list|)
expr_stmt|;
goto|goto
name|ql_alloc_dma_exit
goto|;
block|}
name|QL_DPRINT4
argument_list|(
name|ha
argument_list|,
operator|(
name|dev
operator|,
literal|"%s: rx_ring[%d] phys %p virt %p\n"
operator|,
name|__func__
operator|,
name|i
operator|,
operator|(
name|void
operator|*
operator|)
operator|(
name|hw
operator|->
name|dma_buf
operator|.
name|rds_ring
index|[
name|i
index|]
operator|.
name|dma_addr
operator|)
operator|,
name|hw
operator|->
name|dma_buf
operator|.
name|rds_ring
index|[
name|i
index|]
operator|.
name|dma_b
operator|)
argument_list|)
expr_stmt|;
block|}
name|hw
operator|->
name|dma_buf
operator|.
name|flags
operator|.
name|rds_ring
operator|=
literal|1
expr_stmt|;
comment|/* 	 * Allocate Status Descriptor Rings 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|hw
operator|->
name|num_sds_rings
condition|;
name|i
operator|++
control|)
block|{
name|hw
operator|->
name|dma_buf
operator|.
name|sds_ring
index|[
name|i
index|]
operator|.
name|alignment
operator|=
literal|8
expr_stmt|;
name|hw
operator|->
name|dma_buf
operator|.
name|sds_ring
index|[
name|i
index|]
operator|.
name|size
operator|=
operator|(
sizeof|sizeof
argument_list|(
name|q80_stat_desc_t
argument_list|)
operator|)
operator|*
name|NUM_STATUS_DESCRIPTORS
expr_stmt|;
if|if
condition|(
name|ql_alloc_dmabuf
argument_list|(
name|ha
argument_list|,
operator|&
name|hw
operator|->
name|dma_buf
operator|.
name|sds_ring
index|[
name|i
index|]
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: sds ring alloc failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|i
condition|;
name|j
operator|++
control|)
name|ql_free_dmabuf
argument_list|(
name|ha
argument_list|,
operator|&
name|hw
operator|->
name|dma_buf
operator|.
name|sds_ring
index|[
name|j
index|]
argument_list|)
expr_stmt|;
goto|goto
name|ql_alloc_dma_exit
goto|;
block|}
name|QL_DPRINT4
argument_list|(
name|ha
argument_list|,
operator|(
name|dev
operator|,
literal|"%s: sds_ring[%d] phys %p virt %p\n"
operator|,
name|__func__
operator|,
name|i
operator|,
operator|(
name|void
operator|*
operator|)
operator|(
name|hw
operator|->
name|dma_buf
operator|.
name|sds_ring
index|[
name|i
index|]
operator|.
name|dma_addr
operator|)
operator|,
name|hw
operator|->
name|dma_buf
operator|.
name|sds_ring
index|[
name|i
index|]
operator|.
name|dma_b
operator|)
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|hw
operator|->
name|num_sds_rings
condition|;
name|i
operator|++
control|)
block|{
name|hw
operator|->
name|sds
index|[
name|i
index|]
operator|.
name|sds_ring_base
operator|=
operator|(
name|q80_stat_desc_t
operator|*
operator|)
name|hw
operator|->
name|dma_buf
operator|.
name|sds_ring
index|[
name|i
index|]
operator|.
name|dma_b
expr_stmt|;
block|}
name|hw
operator|->
name|dma_buf
operator|.
name|flags
operator|.
name|sds_ring
operator|=
literal|1
expr_stmt|;
return|return
literal|0
return|;
name|ql_alloc_dma_exit
label|:
name|ql_free_dma
argument_list|(
name|ha
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_define
define|#
directive|define
name|Q8_MBX_MSEC_DELAY
value|5000
end_define

begin_function
specifier|static
name|int
name|qla_mbx_cmd
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint32_t
modifier|*
name|h_mbox
parameter_list|,
name|uint32_t
name|n_hmbox
parameter_list|,
name|uint32_t
modifier|*
name|fw_mbox
parameter_list|,
name|uint32_t
name|n_fwmbox
parameter_list|,
name|uint32_t
name|no_pause
parameter_list|)
block|{
name|uint32_t
name|i
decl_stmt|;
name|uint32_t
name|data
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|QL_ERR_INJECT
argument_list|(
name|ha
argument_list|,
name|INJCT_MBX_CMD_FAILURE
argument_list|)
condition|)
block|{
name|ret
operator|=
operator|-
literal|3
expr_stmt|;
name|ha
operator|->
name|qla_initiate_recovery
operator|=
literal|1
expr_stmt|;
goto|goto
name|exit_qla_mbx_cmd
goto|;
block|}
if|if
condition|(
name|no_pause
condition|)
name|i
operator|=
literal|1000
expr_stmt|;
else|else
name|i
operator|=
name|Q8_MBX_MSEC_DELAY
expr_stmt|;
while|while
condition|(
name|i
condition|)
block|{
name|data
operator|=
name|READ_REG32
argument_list|(
name|ha
argument_list|,
name|Q8_HOST_MBOX_CNTRL
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
name|no_pause
condition|)
block|{
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|qla_mdelay
argument_list|(
name|__func__
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|i
operator|--
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|==
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"%s: host_mbx_cntrl 0x%08x\n"
argument_list|,
name|__func__
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
name|ha
operator|->
name|qla_initiate_recovery
operator|=
literal|1
expr_stmt|;
goto|goto
name|exit_qla_mbx_cmd
goto|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n_hmbox
condition|;
name|i
operator|++
control|)
block|{
name|WRITE_REG32
argument_list|(
name|ha
argument_list|,
operator|(
name|Q8_HOST_MBOX0
operator|+
operator|(
name|i
operator|<<
literal|2
operator|)
operator|)
argument_list|,
operator|*
name|h_mbox
argument_list|)
expr_stmt|;
name|h_mbox
operator|++
expr_stmt|;
block|}
name|WRITE_REG32
argument_list|(
name|ha
argument_list|,
name|Q8_HOST_MBOX_CNTRL
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
name|i
operator|=
name|Q8_MBX_MSEC_DELAY
expr_stmt|;
while|while
condition|(
name|i
condition|)
block|{
name|data
operator|=
name|READ_REG32
argument_list|(
name|ha
argument_list|,
name|Q8_FW_MBOX_CNTRL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|data
operator|&
literal|0x3
operator|)
operator|==
literal|1
condition|)
block|{
name|data
operator|=
name|READ_REG32
argument_list|(
name|ha
argument_list|,
name|Q8_FW_MBOX0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|data
operator|&
literal|0xF000
operator|)
operator|!=
literal|0x8000
condition|)
break|break;
block|}
if|if
condition|(
name|no_pause
condition|)
block|{
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|qla_mdelay
argument_list|(
name|__func__
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|i
operator|--
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|==
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"%s: fw_mbx_cntrl 0x%08x\n"
argument_list|,
name|__func__
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|2
expr_stmt|;
name|ha
operator|->
name|qla_initiate_recovery
operator|=
literal|1
expr_stmt|;
goto|goto
name|exit_qla_mbx_cmd
goto|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n_fwmbox
condition|;
name|i
operator|++
control|)
block|{
operator|*
name|fw_mbox
operator|++
operator|=
name|READ_REG32
argument_list|(
name|ha
argument_list|,
operator|(
name|Q8_FW_MBOX0
operator|+
operator|(
name|i
operator|<<
literal|2
operator|)
operator|)
argument_list|)
expr_stmt|;
block|}
name|WRITE_REG32
argument_list|(
name|ha
argument_list|,
name|Q8_FW_MBOX_CNTRL
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
name|WRITE_REG32
argument_list|(
name|ha
argument_list|,
name|ha
operator|->
name|hw
operator|.
name|mbx_intr_mask_offset
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
name|exit_qla_mbx_cmd
label|:
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qla_get_nic_partition
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|uint32_t
modifier|*
name|mbox
decl_stmt|,
name|err
decl_stmt|;
name|device_t
name|dev
init|=
name|ha
operator|->
name|pci_dev
decl_stmt|;
name|bzero
argument_list|(
name|ha
operator|->
name|hw
operator|.
name|mbox
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|*
name|Q8_NUM_MBOX
operator|)
argument_list|)
expr_stmt|;
name|mbox
operator|=
name|ha
operator|->
name|hw
operator|.
name|mbox
expr_stmt|;
name|mbox
index|[
literal|0
index|]
operator|=
name|Q8_MBX_GET_NIC_PARTITION
operator||
operator|(
literal|0x2
operator|<<
literal|16
operator|)
operator||
operator|(
literal|0x2
operator|<<
literal|29
operator|)
expr_stmt|;
if|if
condition|(
name|qla_mbx_cmd
argument_list|(
name|ha
argument_list|,
name|mbox
argument_list|,
literal|2
argument_list|,
name|mbox
argument_list|,
literal|19
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: failed0\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|err
operator|=
name|mbox
index|[
literal|0
index|]
operator|>>
literal|25
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|!=
literal|1
operator|)
operator|&&
operator|(
name|err
operator|!=
literal|0
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: failed1 [0x%08x]\n"
argument_list|,
name|__func__
argument_list|,
name|err
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qla_config_intr_cntxt
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint32_t
name|num_intrs
parameter_list|,
name|uint32_t
name|create
parameter_list|)
block|{
name|uint32_t
name|i
decl_stmt|,
name|err
decl_stmt|;
name|device_t
name|dev
init|=
name|ha
operator|->
name|pci_dev
decl_stmt|;
name|q80_config_intr_t
modifier|*
name|c_intr
decl_stmt|;
name|q80_config_intr_rsp_t
modifier|*
name|c_intr_rsp
decl_stmt|;
name|c_intr
operator|=
operator|(
name|q80_config_intr_t
operator|*
operator|)
name|ha
operator|->
name|hw
operator|.
name|mbox
expr_stmt|;
name|bzero
argument_list|(
name|c_intr
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|q80_config_intr_t
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|c_intr
operator|->
name|opcode
operator|=
name|Q8_MBX_CONFIG_INTR
expr_stmt|;
name|c_intr
operator|->
name|count_version
operator|=
operator|(
sizeof|sizeof
argument_list|(
name|q80_config_intr_t
argument_list|)
operator|>>
literal|2
operator|)
expr_stmt|;
name|c_intr
operator|->
name|count_version
operator||=
name|Q8_MBX_CMD_VERSION
expr_stmt|;
name|c_intr
operator|->
name|nentries
operator|=
name|num_intrs
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_intrs
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|create
condition|)
block|{
name|c_intr
operator|->
name|intr
index|[
name|i
index|]
operator|.
name|cmd_type
operator|=
name|Q8_MBX_CONFIG_INTR_CREATE
expr_stmt|;
name|c_intr
operator|->
name|intr
index|[
name|i
index|]
operator|.
name|msix_index
operator|=
name|i
operator|+
literal|1
expr_stmt|;
block|}
else|else
block|{
name|c_intr
operator|->
name|intr
index|[
name|i
index|]
operator|.
name|cmd_type
operator|=
name|Q8_MBX_CONFIG_INTR_DELETE
expr_stmt|;
name|c_intr
operator|->
name|intr
index|[
name|i
index|]
operator|.
name|msix_index
operator|=
name|ha
operator|->
name|hw
operator|.
name|intr_id
index|[
name|i
index|]
expr_stmt|;
block|}
name|c_intr
operator|->
name|intr
index|[
name|i
index|]
operator|.
name|cmd_type
operator||=
name|Q8_MBX_CONFIG_INTR_TYPE_MSI_X
expr_stmt|;
block|}
if|if
condition|(
name|qla_mbx_cmd
argument_list|(
name|ha
argument_list|,
operator|(
name|uint32_t
operator|*
operator|)
name|c_intr
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|q80_config_intr_t
argument_list|)
operator|>>
literal|2
operator|)
argument_list|,
name|ha
operator|->
name|hw
operator|.
name|mbox
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|q80_config_intr_rsp_t
argument_list|)
operator|>>
literal|2
operator|)
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: failed0\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|c_intr_rsp
operator|=
operator|(
name|q80_config_intr_rsp_t
operator|*
operator|)
name|ha
operator|->
name|hw
operator|.
name|mbox
expr_stmt|;
name|err
operator|=
name|Q8_MBX_RSP_STATUS
argument_list|(
name|c_intr_rsp
operator|->
name|regcnt_status
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: failed1 [0x%08x, %d]\n"
argument_list|,
name|__func__
argument_list|,
name|err
argument_list|,
name|c_intr_rsp
operator|->
name|nentries
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|c_intr_rsp
operator|->
name|nentries
condition|;
name|i
operator|++
control|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: [%d]:[0x%x 0x%x 0x%x]\n"
argument_list|,
name|__func__
argument_list|,
name|i
argument_list|,
name|c_intr_rsp
operator|->
name|intr
index|[
name|i
index|]
operator|.
name|status
argument_list|,
name|c_intr_rsp
operator|->
name|intr
index|[
name|i
index|]
operator|.
name|intr_id
argument_list|,
name|c_intr_rsp
operator|->
name|intr
index|[
name|i
index|]
operator|.
name|intr_src
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|(
operator|(
name|i
operator|<
name|num_intrs
operator|)
operator|&&
name|create
operator|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|c_intr_rsp
operator|->
name|intr
index|[
name|i
index|]
operator|.
name|status
condition|)
block|{
name|ha
operator|->
name|hw
operator|.
name|intr_id
index|[
name|i
index|]
operator|=
name|c_intr_rsp
operator|->
name|intr
index|[
name|i
index|]
operator|.
name|intr_id
expr_stmt|;
name|ha
operator|->
name|hw
operator|.
name|intr_src
index|[
name|i
index|]
operator|=
name|c_intr_rsp
operator|->
name|intr
index|[
name|i
index|]
operator|.
name|intr_src
expr_stmt|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Name: qla_config_rss  * Function: Configure RSS for the context/interface.  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|uint64_t
name|rss_key
index|[]
init|=
block|{
literal|0xbeac01fa6a42b73bULL
block|,
literal|0x8030f20c77cb2da3ULL
block|,
literal|0xae7b30b4d0ca2bcbULL
block|,
literal|0x43a38fb04167253dULL
block|,
literal|0x255b0ec26d5a56daULL
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|qla_config_rss
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint16_t
name|cntxt_id
parameter_list|)
block|{
name|q80_config_rss_t
modifier|*
name|c_rss
decl_stmt|;
name|q80_config_rss_rsp_t
modifier|*
name|c_rss_rsp
decl_stmt|;
name|uint32_t
name|err
decl_stmt|,
name|i
decl_stmt|;
name|device_t
name|dev
init|=
name|ha
operator|->
name|pci_dev
decl_stmt|;
name|c_rss
operator|=
operator|(
name|q80_config_rss_t
operator|*
operator|)
name|ha
operator|->
name|hw
operator|.
name|mbox
expr_stmt|;
name|bzero
argument_list|(
name|c_rss
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|q80_config_rss_t
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|c_rss
operator|->
name|opcode
operator|=
name|Q8_MBX_CONFIG_RSS
expr_stmt|;
name|c_rss
operator|->
name|count_version
operator|=
operator|(
sizeof|sizeof
argument_list|(
name|q80_config_rss_t
argument_list|)
operator|>>
literal|2
operator|)
expr_stmt|;
name|c_rss
operator|->
name|count_version
operator||=
name|Q8_MBX_CMD_VERSION
expr_stmt|;
name|c_rss
operator|->
name|hash_type
operator|=
operator|(
name|Q8_MBX_RSS_HASH_TYPE_IPV4_TCP_IP
operator||
name|Q8_MBX_RSS_HASH_TYPE_IPV6_TCP_IP
operator|)
expr_stmt|;
name|c_rss
operator|->
name|flags
operator|=
name|Q8_MBX_RSS_FLAGS_ENABLE_RSS
expr_stmt|;
name|c_rss
operator|->
name|flags
operator||=
name|Q8_MBX_RSS_FLAGS_USE_IND_TABLE
expr_stmt|;
name|c_rss
operator|->
name|indtbl_mask
operator|=
name|Q8_MBX_RSS_INDTBL_MASK
expr_stmt|;
name|c_rss
operator|->
name|indtbl_mask
operator||=
name|Q8_MBX_RSS_FLAGS_MULTI_RSS_VALID
expr_stmt|;
name|c_rss
operator|->
name|flags
operator||=
name|Q8_MBX_RSS_FLAGS_TYPE_CRSS
expr_stmt|;
name|c_rss
operator|->
name|cntxt_id
operator|=
name|cntxt_id
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|5
condition|;
name|i
operator|++
control|)
block|{
name|c_rss
operator|->
name|rss_key
index|[
name|i
index|]
operator|=
name|rss_key
index|[
name|i
index|]
expr_stmt|;
block|}
if|if
condition|(
name|qla_mbx_cmd
argument_list|(
name|ha
argument_list|,
operator|(
name|uint32_t
operator|*
operator|)
name|c_rss
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|q80_config_rss_t
argument_list|)
operator|>>
literal|2
operator|)
argument_list|,
name|ha
operator|->
name|hw
operator|.
name|mbox
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|q80_config_rss_rsp_t
argument_list|)
operator|>>
literal|2
operator|)
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: failed0\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|c_rss_rsp
operator|=
operator|(
name|q80_config_rss_rsp_t
operator|*
operator|)
name|ha
operator|->
name|hw
operator|.
name|mbox
expr_stmt|;
name|err
operator|=
name|Q8_MBX_RSP_STATUS
argument_list|(
name|c_rss_rsp
operator|->
name|regcnt_status
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: failed1 [0x%08x]\n"
argument_list|,
name|__func__
argument_list|,
name|err
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|uint8_t
name|rss_ind_default_table
index|[
name|Q8_RSS_IND_TBL_SIZE
index|]
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|qla_set_rss_ind_table
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint32_t
name|start_idx
parameter_list|,
name|uint32_t
name|count
parameter_list|,
name|uint16_t
name|cntxt_id
parameter_list|,
name|uint8_t
modifier|*
name|ind_table
parameter_list|)
block|{
name|q80_config_rss_ind_table_t
modifier|*
name|c_rss_ind
decl_stmt|;
name|q80_config_rss_ind_table_rsp_t
modifier|*
name|c_rss_ind_rsp
decl_stmt|;
name|uint32_t
name|err
decl_stmt|;
name|device_t
name|dev
init|=
name|ha
operator|->
name|pci_dev
decl_stmt|;
if|if
condition|(
operator|(
name|count
operator|>
name|Q8_RSS_IND_TBL_SIZE
operator|)
operator|||
operator|(
operator|(
name|start_idx
operator|+
name|count
operator|-
literal|1
operator|)
operator|>
name|Q8_RSS_IND_TBL_MAX_IDX
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: illegal count [%d, %d]\n"
argument_list|,
name|__func__
argument_list|,
name|start_idx
argument_list|,
name|count
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|c_rss_ind
operator|=
operator|(
name|q80_config_rss_ind_table_t
operator|*
operator|)
name|ha
operator|->
name|hw
operator|.
name|mbox
expr_stmt|;
name|bzero
argument_list|(
name|c_rss_ind
argument_list|,
sizeof|sizeof
argument_list|(
name|q80_config_rss_ind_table_t
argument_list|)
argument_list|)
expr_stmt|;
name|c_rss_ind
operator|->
name|opcode
operator|=
name|Q8_MBX_CONFIG_RSS_TABLE
expr_stmt|;
name|c_rss_ind
operator|->
name|count_version
operator|=
operator|(
sizeof|sizeof
argument_list|(
name|q80_config_rss_ind_table_t
argument_list|)
operator|>>
literal|2
operator|)
expr_stmt|;
name|c_rss_ind
operator|->
name|count_version
operator||=
name|Q8_MBX_CMD_VERSION
expr_stmt|;
name|c_rss_ind
operator|->
name|start_idx
operator|=
name|start_idx
expr_stmt|;
name|c_rss_ind
operator|->
name|end_idx
operator|=
name|start_idx
operator|+
name|count
operator|-
literal|1
expr_stmt|;
name|c_rss_ind
operator|->
name|cntxt_id
operator|=
name|cntxt_id
expr_stmt|;
name|bcopy
argument_list|(
name|ind_table
argument_list|,
name|c_rss_ind
operator|->
name|ind_table
argument_list|,
name|count
argument_list|)
expr_stmt|;
if|if
condition|(
name|qla_mbx_cmd
argument_list|(
name|ha
argument_list|,
operator|(
name|uint32_t
operator|*
operator|)
name|c_rss_ind
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|q80_config_rss_ind_table_t
argument_list|)
operator|>>
literal|2
operator|)
argument_list|,
name|ha
operator|->
name|hw
operator|.
name|mbox
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|q80_config_rss_ind_table_rsp_t
argument_list|)
operator|>>
literal|2
operator|)
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: failed0\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|c_rss_ind_rsp
operator|=
operator|(
name|q80_config_rss_ind_table_rsp_t
operator|*
operator|)
name|ha
operator|->
name|hw
operator|.
name|mbox
expr_stmt|;
name|err
operator|=
name|Q8_MBX_RSP_STATUS
argument_list|(
name|c_rss_ind_rsp
operator|->
name|regcnt_status
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: failed1 [0x%08x]\n"
argument_list|,
name|__func__
argument_list|,
name|err
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Name: qla_config_intr_coalesce  * Function: Configure Interrupt Coalescing.  */
end_comment

begin_function
specifier|static
name|int
name|qla_config_intr_coalesce
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint16_t
name|cntxt_id
parameter_list|,
name|int
name|tenable
parameter_list|)
block|{
name|q80_config_intr_coalesc_t
modifier|*
name|intrc
decl_stmt|;
name|q80_config_intr_coalesc_rsp_t
modifier|*
name|intrc_rsp
decl_stmt|;
name|uint32_t
name|err
decl_stmt|,
name|i
decl_stmt|;
name|device_t
name|dev
init|=
name|ha
operator|->
name|pci_dev
decl_stmt|;
name|intrc
operator|=
operator|(
name|q80_config_intr_coalesc_t
operator|*
operator|)
name|ha
operator|->
name|hw
operator|.
name|mbox
expr_stmt|;
name|bzero
argument_list|(
name|intrc
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|q80_config_intr_coalesc_t
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|intrc
operator|->
name|opcode
operator|=
name|Q8_MBX_CONFIG_INTR_COALESCE
expr_stmt|;
name|intrc
operator|->
name|count_version
operator|=
operator|(
sizeof|sizeof
argument_list|(
name|q80_config_intr_coalesc_t
argument_list|)
operator|>>
literal|2
operator|)
expr_stmt|;
name|intrc
operator|->
name|count_version
operator||=
name|Q8_MBX_CMD_VERSION
expr_stmt|;
name|intrc
operator|->
name|flags
operator|=
name|Q8_MBX_INTRC_FLAGS_RCV
expr_stmt|;
name|intrc
operator|->
name|cntxt_id
operator|=
name|cntxt_id
expr_stmt|;
name|intrc
operator|->
name|max_pkts
operator|=
literal|256
expr_stmt|;
name|intrc
operator|->
name|max_mswait
operator|=
literal|3
expr_stmt|;
if|if
condition|(
name|tenable
condition|)
block|{
name|intrc
operator|->
name|flags
operator||=
name|Q8_MBX_INTRC_FLAGS_PERIODIC
expr_stmt|;
name|intrc
operator|->
name|timer_type
operator|=
name|Q8_MBX_INTRC_TIMER_PERIODIC
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|hw
operator|.
name|num_sds_rings
condition|;
name|i
operator|++
control|)
block|{
name|intrc
operator|->
name|sds_ring_mask
operator||=
operator|(
literal|1
operator|<<
name|i
operator|)
expr_stmt|;
block|}
name|intrc
operator|->
name|ms_timeout
operator|=
literal|1000
expr_stmt|;
block|}
if|if
condition|(
name|qla_mbx_cmd
argument_list|(
name|ha
argument_list|,
operator|(
name|uint32_t
operator|*
operator|)
name|intrc
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|q80_config_intr_coalesc_t
argument_list|)
operator|>>
literal|2
operator|)
argument_list|,
name|ha
operator|->
name|hw
operator|.
name|mbox
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|q80_config_intr_coalesc_rsp_t
argument_list|)
operator|>>
literal|2
operator|)
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: failed0\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|intrc_rsp
operator|=
operator|(
name|q80_config_intr_coalesc_rsp_t
operator|*
operator|)
name|ha
operator|->
name|hw
operator|.
name|mbox
expr_stmt|;
name|err
operator|=
name|Q8_MBX_RSP_STATUS
argument_list|(
name|intrc_rsp
operator|->
name|regcnt_status
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: failed1 [0x%08x]\n"
argument_list|,
name|__func__
argument_list|,
name|err
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Name: qla_config_mac_addr  * Function: binds a MAC address to the context/interface.  *	Can be unicast, multicast or broadcast.  */
end_comment

begin_function
specifier|static
name|int
name|qla_config_mac_addr
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint8_t
modifier|*
name|mac_addr
parameter_list|,
name|uint32_t
name|add_mac
parameter_list|)
block|{
name|q80_config_mac_addr_t
modifier|*
name|cmac
decl_stmt|;
name|q80_config_mac_addr_rsp_t
modifier|*
name|cmac_rsp
decl_stmt|;
name|uint32_t
name|err
decl_stmt|;
name|device_t
name|dev
init|=
name|ha
operator|->
name|pci_dev
decl_stmt|;
name|cmac
operator|=
operator|(
name|q80_config_mac_addr_t
operator|*
operator|)
name|ha
operator|->
name|hw
operator|.
name|mbox
expr_stmt|;
name|bzero
argument_list|(
name|cmac
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|q80_config_mac_addr_t
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|cmac
operator|->
name|opcode
operator|=
name|Q8_MBX_CONFIG_MAC_ADDR
expr_stmt|;
name|cmac
operator|->
name|count_version
operator|=
sizeof|sizeof
argument_list|(
name|q80_config_mac_addr_t
argument_list|)
operator|>>
literal|2
expr_stmt|;
name|cmac
operator|->
name|count_version
operator||=
name|Q8_MBX_CMD_VERSION
expr_stmt|;
if|if
condition|(
name|add_mac
condition|)
name|cmac
operator|->
name|cmd
operator|=
name|Q8_MBX_CMAC_CMD_ADD_MAC_ADDR
expr_stmt|;
else|else
name|cmac
operator|->
name|cmd
operator|=
name|Q8_MBX_CMAC_CMD_DEL_MAC_ADDR
expr_stmt|;
name|cmac
operator|->
name|cmd
operator||=
name|Q8_MBX_CMAC_CMD_CAM_INGRESS
expr_stmt|;
name|cmac
operator|->
name|nmac_entries
operator|=
literal|1
expr_stmt|;
name|cmac
operator|->
name|cntxt_id
operator|=
name|ha
operator|->
name|hw
operator|.
name|rcv_cntxt_id
expr_stmt|;
name|bcopy
argument_list|(
name|mac_addr
argument_list|,
name|cmac
operator|->
name|mac_addr
index|[
literal|0
index|]
operator|.
name|addr
argument_list|,
literal|6
argument_list|)
expr_stmt|;
if|if
condition|(
name|qla_mbx_cmd
argument_list|(
name|ha
argument_list|,
operator|(
name|uint32_t
operator|*
operator|)
name|cmac
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|q80_config_mac_addr_t
argument_list|)
operator|>>
literal|2
operator|)
argument_list|,
name|ha
operator|->
name|hw
operator|.
name|mbox
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|q80_config_mac_addr_rsp_t
argument_list|)
operator|>>
literal|2
operator|)
argument_list|,
literal|1
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: %s failed0\n"
argument_list|,
name|__func__
argument_list|,
operator|(
name|add_mac
condition|?
literal|"Add"
else|:
literal|"Del"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|cmac_rsp
operator|=
operator|(
name|q80_config_mac_addr_rsp_t
operator|*
operator|)
name|ha
operator|->
name|hw
operator|.
name|mbox
expr_stmt|;
name|err
operator|=
name|Q8_MBX_RSP_STATUS
argument_list|(
name|cmac_rsp
operator|->
name|regcnt_status
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: %s "
literal|"%02x:%02x:%02x:%02x:%02x:%02x failed1 [0x%08x]\n"
argument_list|,
name|__func__
argument_list|,
operator|(
name|add_mac
condition|?
literal|"Add"
else|:
literal|"Del"
operator|)
argument_list|,
name|mac_addr
index|[
literal|0
index|]
argument_list|,
name|mac_addr
index|[
literal|1
index|]
argument_list|,
name|mac_addr
index|[
literal|2
index|]
argument_list|,
name|mac_addr
index|[
literal|3
index|]
argument_list|,
name|mac_addr
index|[
literal|4
index|]
argument_list|,
name|mac_addr
index|[
literal|5
index|]
argument_list|,
name|err
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Name: qla_set_mac_rcv_mode  * Function: Enable/Disable AllMulticast and Promiscous Modes.  */
end_comment

begin_function
specifier|static
name|int
name|qla_set_mac_rcv_mode
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint32_t
name|mode
parameter_list|)
block|{
name|q80_config_mac_rcv_mode_t
modifier|*
name|rcv_mode
decl_stmt|;
name|uint32_t
name|err
decl_stmt|;
name|q80_config_mac_rcv_mode_rsp_t
modifier|*
name|rcv_mode_rsp
decl_stmt|;
name|device_t
name|dev
init|=
name|ha
operator|->
name|pci_dev
decl_stmt|;
name|rcv_mode
operator|=
operator|(
name|q80_config_mac_rcv_mode_t
operator|*
operator|)
name|ha
operator|->
name|hw
operator|.
name|mbox
expr_stmt|;
name|bzero
argument_list|(
name|rcv_mode
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|q80_config_mac_rcv_mode_t
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|rcv_mode
operator|->
name|opcode
operator|=
name|Q8_MBX_CONFIG_MAC_RX_MODE
expr_stmt|;
name|rcv_mode
operator|->
name|count_version
operator|=
sizeof|sizeof
argument_list|(
name|q80_config_mac_rcv_mode_t
argument_list|)
operator|>>
literal|2
expr_stmt|;
name|rcv_mode
operator|->
name|count_version
operator||=
name|Q8_MBX_CMD_VERSION
expr_stmt|;
name|rcv_mode
operator|->
name|mode
operator|=
name|mode
expr_stmt|;
name|rcv_mode
operator|->
name|cntxt_id
operator|=
name|ha
operator|->
name|hw
operator|.
name|rcv_cntxt_id
expr_stmt|;
if|if
condition|(
name|qla_mbx_cmd
argument_list|(
name|ha
argument_list|,
operator|(
name|uint32_t
operator|*
operator|)
name|rcv_mode
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|q80_config_mac_rcv_mode_t
argument_list|)
operator|>>
literal|2
operator|)
argument_list|,
name|ha
operator|->
name|hw
operator|.
name|mbox
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|q80_config_mac_rcv_mode_rsp_t
argument_list|)
operator|>>
literal|2
operator|)
argument_list|,
literal|1
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: failed0\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|rcv_mode_rsp
operator|=
operator|(
name|q80_config_mac_rcv_mode_rsp_t
operator|*
operator|)
name|ha
operator|->
name|hw
operator|.
name|mbox
expr_stmt|;
name|err
operator|=
name|Q8_MBX_RSP_STATUS
argument_list|(
name|rcv_mode_rsp
operator|->
name|regcnt_status
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: failed1 [0x%08x]\n"
argument_list|,
name|__func__
argument_list|,
name|err
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|ql_set_promisc
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|ha
operator|->
name|hw
operator|.
name|mac_rcv_mode
operator||=
name|Q8_MBX_MAC_RCV_PROMISC_ENABLE
expr_stmt|;
name|ret
operator|=
name|qla_set_mac_rcv_mode
argument_list|(
name|ha
argument_list|,
name|ha
operator|->
name|hw
operator|.
name|mac_rcv_mode
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ql_set_allmulti
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|ha
operator|->
name|hw
operator|.
name|mac_rcv_mode
operator||=
name|Q8_MBX_MAC_ALL_MULTI_ENABLE
expr_stmt|;
name|ret
operator|=
name|qla_set_mac_rcv_mode
argument_list|(
name|ha
argument_list|,
name|ha
operator|->
name|hw
operator|.
name|mac_rcv_mode
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Name: ql_set_max_mtu  * Function:  *	Sets the maximum transfer unit size for the specified rcv context.  */
end_comment

begin_function
name|int
name|ql_set_max_mtu
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint32_t
name|mtu
parameter_list|,
name|uint16_t
name|cntxt_id
parameter_list|)
block|{
name|device_t
name|dev
decl_stmt|;
name|q80_set_max_mtu_t
modifier|*
name|max_mtu
decl_stmt|;
name|q80_set_max_mtu_rsp_t
modifier|*
name|max_mtu_rsp
decl_stmt|;
name|uint32_t
name|err
decl_stmt|;
name|dev
operator|=
name|ha
operator|->
name|pci_dev
expr_stmt|;
name|max_mtu
operator|=
operator|(
name|q80_set_max_mtu_t
operator|*
operator|)
name|ha
operator|->
name|hw
operator|.
name|mbox
expr_stmt|;
name|bzero
argument_list|(
name|max_mtu
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|q80_set_max_mtu_t
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|max_mtu
operator|->
name|opcode
operator|=
name|Q8_MBX_SET_MAX_MTU
expr_stmt|;
name|max_mtu
operator|->
name|count_version
operator|=
operator|(
sizeof|sizeof
argument_list|(
name|q80_set_max_mtu_t
argument_list|)
operator|>>
literal|2
operator|)
expr_stmt|;
name|max_mtu
operator|->
name|count_version
operator||=
name|Q8_MBX_CMD_VERSION
expr_stmt|;
name|max_mtu
operator|->
name|cntxt_id
operator|=
name|cntxt_id
expr_stmt|;
name|max_mtu
operator|->
name|mtu
operator|=
name|mtu
expr_stmt|;
if|if
condition|(
name|qla_mbx_cmd
argument_list|(
name|ha
argument_list|,
operator|(
name|uint32_t
operator|*
operator|)
name|max_mtu
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|q80_set_max_mtu_t
argument_list|)
operator|>>
literal|2
operator|)
argument_list|,
name|ha
operator|->
name|hw
operator|.
name|mbox
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|q80_set_max_mtu_rsp_t
argument_list|)
operator|>>
literal|2
operator|)
argument_list|,
literal|1
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|max_mtu_rsp
operator|=
operator|(
name|q80_set_max_mtu_rsp_t
operator|*
operator|)
name|ha
operator|->
name|hw
operator|.
name|mbox
expr_stmt|;
name|err
operator|=
name|Q8_MBX_RSP_STATUS
argument_list|(
name|max_mtu_rsp
operator|->
name|regcnt_status
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: failed [0x%08x]\n"
argument_list|,
name|__func__
argument_list|,
name|err
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qla_link_event_req
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint16_t
name|cntxt_id
parameter_list|)
block|{
name|device_t
name|dev
decl_stmt|;
name|q80_link_event_t
modifier|*
name|lnk
decl_stmt|;
name|q80_link_event_rsp_t
modifier|*
name|lnk_rsp
decl_stmt|;
name|uint32_t
name|err
decl_stmt|;
name|dev
operator|=
name|ha
operator|->
name|pci_dev
expr_stmt|;
name|lnk
operator|=
operator|(
name|q80_link_event_t
operator|*
operator|)
name|ha
operator|->
name|hw
operator|.
name|mbox
expr_stmt|;
name|bzero
argument_list|(
name|lnk
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|q80_link_event_t
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|lnk
operator|->
name|opcode
operator|=
name|Q8_MBX_LINK_EVENT_REQ
expr_stmt|;
name|lnk
operator|->
name|count_version
operator|=
operator|(
sizeof|sizeof
argument_list|(
name|q80_link_event_t
argument_list|)
operator|>>
literal|2
operator|)
expr_stmt|;
name|lnk
operator|->
name|count_version
operator||=
name|Q8_MBX_CMD_VERSION
expr_stmt|;
name|lnk
operator|->
name|cntxt_id
operator|=
name|cntxt_id
expr_stmt|;
name|lnk
operator|->
name|cmd
operator|=
name|Q8_LINK_EVENT_CMD_ENABLE_ASYNC
expr_stmt|;
if|if
condition|(
name|qla_mbx_cmd
argument_list|(
name|ha
argument_list|,
operator|(
name|uint32_t
operator|*
operator|)
name|lnk
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|q80_link_event_t
argument_list|)
operator|>>
literal|2
operator|)
argument_list|,
name|ha
operator|->
name|hw
operator|.
name|mbox
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|q80_link_event_rsp_t
argument_list|)
operator|>>
literal|2
operator|)
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|lnk_rsp
operator|=
operator|(
name|q80_link_event_rsp_t
operator|*
operator|)
name|ha
operator|->
name|hw
operator|.
name|mbox
expr_stmt|;
name|err
operator|=
name|Q8_MBX_RSP_STATUS
argument_list|(
name|lnk_rsp
operator|->
name|regcnt_status
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: failed [0x%08x]\n"
argument_list|,
name|__func__
argument_list|,
name|err
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qla_config_fw_lro
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint16_t
name|cntxt_id
parameter_list|)
block|{
name|device_t
name|dev
decl_stmt|;
name|q80_config_fw_lro_t
modifier|*
name|fw_lro
decl_stmt|;
name|q80_config_fw_lro_rsp_t
modifier|*
name|fw_lro_rsp
decl_stmt|;
name|uint32_t
name|err
decl_stmt|;
name|dev
operator|=
name|ha
operator|->
name|pci_dev
expr_stmt|;
name|fw_lro
operator|=
operator|(
name|q80_config_fw_lro_t
operator|*
operator|)
name|ha
operator|->
name|hw
operator|.
name|mbox
expr_stmt|;
name|bzero
argument_list|(
name|fw_lro
argument_list|,
sizeof|sizeof
argument_list|(
name|q80_config_fw_lro_t
argument_list|)
argument_list|)
expr_stmt|;
name|fw_lro
operator|->
name|opcode
operator|=
name|Q8_MBX_CONFIG_FW_LRO
expr_stmt|;
name|fw_lro
operator|->
name|count_version
operator|=
operator|(
sizeof|sizeof
argument_list|(
name|q80_config_fw_lro_t
argument_list|)
operator|>>
literal|2
operator|)
expr_stmt|;
name|fw_lro
operator|->
name|count_version
operator||=
name|Q8_MBX_CMD_VERSION
expr_stmt|;
name|fw_lro
operator|->
name|flags
operator||=
name|Q8_MBX_FW_LRO_IPV4
operator||
name|Q8_MBX_FW_LRO_IPV4_WO_DST_IP_CHK
expr_stmt|;
name|fw_lro
operator|->
name|cntxt_id
operator|=
name|cntxt_id
expr_stmt|;
if|if
condition|(
name|ha
operator|->
name|hw
operator|.
name|min_lro_pkt_size
condition|)
block|{
name|fw_lro
operator|->
name|flags
operator||=
name|Q8_MBX_FW_LRO_LOW_THRESHOLD
expr_stmt|;
name|fw_lro
operator|->
name|low_threshold
operator|=
name|ha
operator|->
name|hw
operator|.
name|min_lro_pkt_size
expr_stmt|;
block|}
if|if
condition|(
name|qla_mbx_cmd
argument_list|(
name|ha
argument_list|,
operator|(
name|uint32_t
operator|*
operator|)
name|fw_lro
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|q80_config_fw_lro_t
argument_list|)
operator|>>
literal|2
operator|)
argument_list|,
name|ha
operator|->
name|hw
operator|.
name|mbox
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|q80_config_fw_lro_rsp_t
argument_list|)
operator|>>
literal|2
operator|)
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|fw_lro_rsp
operator|=
operator|(
name|q80_config_fw_lro_rsp_t
operator|*
operator|)
name|ha
operator|->
name|hw
operator|.
name|mbox
expr_stmt|;
name|err
operator|=
name|Q8_MBX_RSP_STATUS
argument_list|(
name|fw_lro_rsp
operator|->
name|regcnt_status
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: failed [0x%08x]\n"
argument_list|,
name|__func__
argument_list|,
name|err
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|qla_xmt_stats
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|q80_xmt_stats_t
modifier|*
name|xstat
parameter_list|)
block|{
name|device_t
name|dev
init|=
name|ha
operator|->
name|pci_dev
decl_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: total_bytes\t\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|__func__
argument_list|,
name|xstat
operator|->
name|total_bytes
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: total_pkts\t\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|__func__
argument_list|,
name|xstat
operator|->
name|total_pkts
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: errors\t\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|__func__
argument_list|,
name|xstat
operator|->
name|errors
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: pkts_dropped\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|__func__
argument_list|,
name|xstat
operator|->
name|pkts_dropped
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: switch_pkts\t\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|__func__
argument_list|,
name|xstat
operator|->
name|switch_pkts
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: num_buffers\t\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|__func__
argument_list|,
name|xstat
operator|->
name|num_buffers
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|qla_rcv_stats
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|q80_rcv_stats_t
modifier|*
name|rstat
parameter_list|)
block|{
name|device_t
name|dev
init|=
name|ha
operator|->
name|pci_dev
decl_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: total_bytes\t\t\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|__func__
argument_list|,
name|rstat
operator|->
name|total_bytes
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: total_pkts\t\t\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|__func__
argument_list|,
name|rstat
operator|->
name|total_pkts
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: lro_pkt_count\t\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|__func__
argument_list|,
name|rstat
operator|->
name|lro_pkt_count
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: sw_pkt_count\t\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|__func__
argument_list|,
name|rstat
operator|->
name|sw_pkt_count
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: ip_chksum_err\t\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|__func__
argument_list|,
name|rstat
operator|->
name|ip_chksum_err
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: pkts_wo_acntxts\t\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|__func__
argument_list|,
name|rstat
operator|->
name|pkts_wo_acntxts
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: pkts_dropped_no_sds_card\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|__func__
argument_list|,
name|rstat
operator|->
name|pkts_dropped_no_sds_card
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: pkts_dropped_no_sds_host\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|__func__
argument_list|,
name|rstat
operator|->
name|pkts_dropped_no_sds_host
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: oversized_pkts\t\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|__func__
argument_list|,
name|rstat
operator|->
name|oversized_pkts
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: pkts_dropped_no_rds\t\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|__func__
argument_list|,
name|rstat
operator|->
name|pkts_dropped_no_rds
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: unxpctd_mcast_pkts\t\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|__func__
argument_list|,
name|rstat
operator|->
name|unxpctd_mcast_pkts
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: re1_fbq_error\t\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|__func__
argument_list|,
name|rstat
operator|->
name|re1_fbq_error
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: invalid_mac_addr\t\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|__func__
argument_list|,
name|rstat
operator|->
name|invalid_mac_addr
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: rds_prime_trys\t\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|__func__
argument_list|,
name|rstat
operator|->
name|rds_prime_trys
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: rds_prime_success\t\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|__func__
argument_list|,
name|rstat
operator|->
name|rds_prime_success
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: lro_flows_added\t\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|__func__
argument_list|,
name|rstat
operator|->
name|lro_flows_added
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: lro_flows_deleted\t\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|__func__
argument_list|,
name|rstat
operator|->
name|lro_flows_deleted
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: lro_flows_active\t\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|__func__
argument_list|,
name|rstat
operator|->
name|lro_flows_active
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: pkts_droped_unknown\t\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|__func__
argument_list|,
name|rstat
operator|->
name|pkts_droped_unknown
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|qla_mac_stats
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|q80_mac_stats_t
modifier|*
name|mstat
parameter_list|)
block|{
name|device_t
name|dev
init|=
name|ha
operator|->
name|pci_dev
decl_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: xmt_frames\t\t\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|__func__
argument_list|,
name|mstat
operator|->
name|xmt_frames
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: xmt_bytes\t\t\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|__func__
argument_list|,
name|mstat
operator|->
name|xmt_bytes
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: xmt_mcast_pkts\t\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|__func__
argument_list|,
name|mstat
operator|->
name|xmt_mcast_pkts
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: xmt_bcast_pkts\t\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|__func__
argument_list|,
name|mstat
operator|->
name|xmt_bcast_pkts
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: xmt_pause_frames\t\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|__func__
argument_list|,
name|mstat
operator|->
name|xmt_pause_frames
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: xmt_cntrl_pkts\t\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|__func__
argument_list|,
name|mstat
operator|->
name|xmt_cntrl_pkts
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: xmt_pkt_lt_64bytes\t\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|__func__
argument_list|,
name|mstat
operator|->
name|xmt_pkt_lt_64bytes
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: xmt_pkt_lt_127bytes\t\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|__func__
argument_list|,
name|mstat
operator|->
name|xmt_pkt_lt_127bytes
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: xmt_pkt_lt_255bytes\t\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|__func__
argument_list|,
name|mstat
operator|->
name|xmt_pkt_lt_255bytes
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: xmt_pkt_lt_511bytes\t\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|__func__
argument_list|,
name|mstat
operator|->
name|xmt_pkt_lt_511bytes
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: xmt_pkt_lt_1023bytes\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|__func__
argument_list|,
name|mstat
operator|->
name|xmt_pkt_lt_1023bytes
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: xmt_pkt_lt_1518bytes\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|__func__
argument_list|,
name|mstat
operator|->
name|xmt_pkt_lt_1518bytes
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: xmt_pkt_gt_1518bytes\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|__func__
argument_list|,
name|mstat
operator|->
name|xmt_pkt_gt_1518bytes
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: rcv_frames\t\t\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|__func__
argument_list|,
name|mstat
operator|->
name|rcv_frames
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: rcv_bytes\t\t\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|__func__
argument_list|,
name|mstat
operator|->
name|rcv_bytes
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: rcv_mcast_pkts\t\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|__func__
argument_list|,
name|mstat
operator|->
name|rcv_mcast_pkts
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: rcv_bcast_pkts\t\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|__func__
argument_list|,
name|mstat
operator|->
name|rcv_bcast_pkts
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: rcv_pause_frames\t\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|__func__
argument_list|,
name|mstat
operator|->
name|rcv_pause_frames
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: rcv_cntrl_pkts\t\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|__func__
argument_list|,
name|mstat
operator|->
name|rcv_cntrl_pkts
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: rcv_pkt_lt_64bytes\t\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|__func__
argument_list|,
name|mstat
operator|->
name|rcv_pkt_lt_64bytes
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: rcv_pkt_lt_127bytes\t\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|__func__
argument_list|,
name|mstat
operator|->
name|rcv_pkt_lt_127bytes
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: rcv_pkt_lt_255bytes\t\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|__func__
argument_list|,
name|mstat
operator|->
name|rcv_pkt_lt_255bytes
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: rcv_pkt_lt_511bytes\t\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|__func__
argument_list|,
name|mstat
operator|->
name|rcv_pkt_lt_511bytes
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: rcv_pkt_lt_1023bytes\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|__func__
argument_list|,
name|mstat
operator|->
name|rcv_pkt_lt_1023bytes
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: rcv_pkt_lt_1518bytes\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|__func__
argument_list|,
name|mstat
operator|->
name|rcv_pkt_lt_1518bytes
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: rcv_pkt_gt_1518bytes\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|__func__
argument_list|,
name|mstat
operator|->
name|rcv_pkt_gt_1518bytes
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: rcv_len_error\t\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|__func__
argument_list|,
name|mstat
operator|->
name|rcv_len_error
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: rcv_len_small\t\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|__func__
argument_list|,
name|mstat
operator|->
name|rcv_len_small
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: rcv_len_large\t\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|__func__
argument_list|,
name|mstat
operator|->
name|rcv_len_large
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: rcv_jabber\t\t\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|__func__
argument_list|,
name|mstat
operator|->
name|rcv_jabber
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: rcv_dropped\t\t\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|__func__
argument_list|,
name|mstat
operator|->
name|rcv_dropped
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: fcs_error\t\t\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|__func__
argument_list|,
name|mstat
operator|->
name|fcs_error
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: align_error\t\t\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|__func__
argument_list|,
name|mstat
operator|->
name|align_error
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|qla_get_hw_stats
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint32_t
name|cmd
parameter_list|)
block|{
name|device_t
name|dev
decl_stmt|;
name|q80_get_stats_t
modifier|*
name|stat
decl_stmt|;
name|q80_get_stats_rsp_t
modifier|*
name|stat_rsp
decl_stmt|;
name|uint32_t
name|err
decl_stmt|;
name|dev
operator|=
name|ha
operator|->
name|pci_dev
expr_stmt|;
name|stat
operator|=
operator|(
name|q80_get_stats_t
operator|*
operator|)
name|ha
operator|->
name|hw
operator|.
name|mbox
expr_stmt|;
name|bzero
argument_list|(
name|stat
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|q80_get_stats_t
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|stat
operator|->
name|opcode
operator|=
name|Q8_MBX_GET_STATS
expr_stmt|;
name|stat
operator|->
name|count_version
operator|=
literal|2
expr_stmt|;
name|stat
operator|->
name|count_version
operator||=
name|Q8_MBX_CMD_VERSION
expr_stmt|;
name|stat
operator|->
name|cmd
operator|=
name|cmd
expr_stmt|;
if|if
condition|(
name|qla_mbx_cmd
argument_list|(
name|ha
argument_list|,
operator|(
name|uint32_t
operator|*
operator|)
name|stat
argument_list|,
literal|2
argument_list|,
name|ha
operator|->
name|hw
operator|.
name|mbox
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|q80_get_stats_rsp_t
argument_list|)
operator|>>
literal|2
operator|)
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|stat_rsp
operator|=
operator|(
name|q80_get_stats_rsp_t
operator|*
operator|)
name|ha
operator|->
name|hw
operator|.
name|mbox
expr_stmt|;
name|err
operator|=
name|Q8_MBX_RSP_STATUS
argument_list|(
name|stat_rsp
operator|->
name|regcnt_status
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|ql_get_stats
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|q80_get_stats_rsp_t
modifier|*
name|stat_rsp
decl_stmt|;
name|q80_mac_stats_t
modifier|*
name|mstat
decl_stmt|;
name|q80_xmt_stats_t
modifier|*
name|xstat
decl_stmt|;
name|q80_rcv_stats_t
modifier|*
name|rstat
decl_stmt|;
name|uint32_t
name|cmd
decl_stmt|;
name|stat_rsp
operator|=
operator|(
name|q80_get_stats_rsp_t
operator|*
operator|)
name|ha
operator|->
name|hw
operator|.
name|mbox
expr_stmt|;
comment|/* 	 * Get MAC Statistics 	 */
name|cmd
operator|=
name|Q8_GET_STATS_CMD_TYPE_MAC
expr_stmt|;
name|cmd
operator||=
operator|(
operator|(
name|ha
operator|->
name|pci_func
operator|&
literal|0x1
operator|)
operator|<<
literal|16
operator|)
expr_stmt|;
if|if
condition|(
name|qla_get_hw_stats
argument_list|(
name|ha
argument_list|,
name|cmd
argument_list|)
operator|==
literal|0
condition|)
block|{
name|mstat
operator|=
operator|(
name|q80_mac_stats_t
operator|*
operator|)
operator|&
name|stat_rsp
operator|->
name|u
operator|.
name|mac
expr_stmt|;
name|qla_mac_stats
argument_list|(
name|ha
argument_list|,
name|mstat
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"%s: mac failed [0x%08x]\n"
argument_list|,
name|__func__
argument_list|,
name|ha
operator|->
name|hw
operator|.
name|mbox
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Get RCV Statistics 	 */
name|cmd
operator|=
name|Q8_GET_STATS_CMD_RCV
operator||
name|Q8_GET_STATS_CMD_TYPE_CNTXT
expr_stmt|;
name|cmd
operator||=
operator|(
name|ha
operator|->
name|hw
operator|.
name|rcv_cntxt_id
operator|<<
literal|16
operator|)
expr_stmt|;
if|if
condition|(
name|qla_get_hw_stats
argument_list|(
name|ha
argument_list|,
name|cmd
argument_list|)
operator|==
literal|0
condition|)
block|{
name|rstat
operator|=
operator|(
name|q80_rcv_stats_t
operator|*
operator|)
operator|&
name|stat_rsp
operator|->
name|u
operator|.
name|rcv
expr_stmt|;
name|qla_rcv_stats
argument_list|(
name|ha
argument_list|,
name|rstat
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"%s: rcv failed [0x%08x]\n"
argument_list|,
name|__func__
argument_list|,
name|ha
operator|->
name|hw
operator|.
name|mbox
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Get XMT Statistics 	 */
name|cmd
operator|=
name|Q8_GET_STATS_CMD_XMT
operator||
name|Q8_GET_STATS_CMD_TYPE_CNTXT
expr_stmt|;
name|cmd
operator||=
operator|(
name|ha
operator|->
name|hw
operator|.
name|tx_cntxt
index|[
name|ha
operator|->
name|txr_idx
index|]
operator|.
name|tx_cntxt_id
operator|<<
literal|16
operator|)
expr_stmt|;
if|if
condition|(
name|qla_get_hw_stats
argument_list|(
name|ha
argument_list|,
name|cmd
argument_list|)
operator|==
literal|0
condition|)
block|{
name|xstat
operator|=
operator|(
name|q80_xmt_stats_t
operator|*
operator|)
operator|&
name|stat_rsp
operator|->
name|u
operator|.
name|xmt
expr_stmt|;
name|qla_xmt_stats
argument_list|(
name|ha
argument_list|,
name|xstat
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"%s: xmt failed [0x%08x]\n"
argument_list|,
name|__func__
argument_list|,
name|ha
operator|->
name|hw
operator|.
name|mbox
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Name: qla_tx_tso  * Function: Checks if the packet to be transmitted is a candidate for  *	Large TCP Segment Offload. If yes, the appropriate fields in the Tx  *	Ring Structure are plugged in.  */
end_comment

begin_function
specifier|static
name|int
name|qla_tx_tso
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|struct
name|mbuf
modifier|*
name|mp
parameter_list|,
name|q80_tx_cmd_t
modifier|*
name|tx_cmd
parameter_list|,
name|uint8_t
modifier|*
name|hdr
parameter_list|)
block|{
name|struct
name|ether_vlan_header
modifier|*
name|eh
decl_stmt|;
name|struct
name|ip
modifier|*
name|ip
init|=
name|NULL
decl_stmt|;
name|struct
name|ip6_hdr
modifier|*
name|ip6
init|=
name|NULL
decl_stmt|;
name|struct
name|tcphdr
modifier|*
name|th
init|=
name|NULL
decl_stmt|;
name|uint32_t
name|ehdrlen
decl_stmt|,
name|hdrlen
decl_stmt|,
name|ip_hlen
decl_stmt|,
name|tcp_hlen
decl_stmt|,
name|tcp_opt_off
decl_stmt|;
name|uint16_t
name|etype
decl_stmt|,
name|opcode
decl_stmt|,
name|offload
init|=
literal|1
decl_stmt|;
name|device_t
name|dev
decl_stmt|;
name|dev
operator|=
name|ha
operator|->
name|pci_dev
expr_stmt|;
name|eh
operator|=
name|mtod
argument_list|(
name|mp
argument_list|,
expr|struct
name|ether_vlan_header
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
name|eh
operator|->
name|evl_encap_proto
operator|==
name|htons
argument_list|(
name|ETHERTYPE_VLAN
argument_list|)
condition|)
block|{
name|ehdrlen
operator|=
name|ETHER_HDR_LEN
operator|+
name|ETHER_VLAN_ENCAP_LEN
expr_stmt|;
name|etype
operator|=
name|ntohs
argument_list|(
name|eh
operator|->
name|evl_proto
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ehdrlen
operator|=
name|ETHER_HDR_LEN
expr_stmt|;
name|etype
operator|=
name|ntohs
argument_list|(
name|eh
operator|->
name|evl_encap_proto
argument_list|)
expr_stmt|;
block|}
name|hdrlen
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|etype
condition|)
block|{
case|case
name|ETHERTYPE_IP
case|:
name|tcp_opt_off
operator|=
name|ehdrlen
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|ip
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|tcphdr
argument_list|)
expr_stmt|;
if|if
condition|(
name|mp
operator|->
name|m_len
operator|<
name|tcp_opt_off
condition|)
block|{
name|m_copydata
argument_list|(
name|mp
argument_list|,
literal|0
argument_list|,
name|tcp_opt_off
argument_list|,
name|hdr
argument_list|)
expr_stmt|;
name|ip
operator|=
operator|(
expr|struct
name|ip
operator|*
operator|)
operator|(
name|hdr
operator|+
name|ehdrlen
operator|)
expr_stmt|;
block|}
else|else
block|{
name|ip
operator|=
operator|(
expr|struct
name|ip
operator|*
operator|)
operator|(
name|mp
operator|->
name|m_data
operator|+
name|ehdrlen
operator|)
expr_stmt|;
block|}
name|ip_hlen
operator|=
name|ip
operator|->
name|ip_hl
operator|<<
literal|2
expr_stmt|;
name|opcode
operator|=
name|Q8_TX_CMD_OP_XMT_TCP_LSO
expr_stmt|;
if|if
condition|(
operator|(
name|ip
operator|->
name|ip_p
operator|!=
name|IPPROTO_TCP
operator|)
operator|||
operator|(
name|ip_hlen
operator|!=
sizeof|sizeof
argument_list|(
expr|struct
name|ip
argument_list|)
operator|)
condition|)
block|{
comment|/* IP Options are not supported */
name|offload
operator|=
literal|0
expr_stmt|;
block|}
else|else
name|th
operator|=
operator|(
expr|struct
name|tcphdr
operator|*
operator|)
operator|(
operator|(
name|caddr_t
operator|)
name|ip
operator|+
name|ip_hlen
operator|)
expr_stmt|;
break|break;
case|case
name|ETHERTYPE_IPV6
case|:
name|tcp_opt_off
operator|=
name|ehdrlen
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|ip6_hdr
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|tcphdr
argument_list|)
expr_stmt|;
if|if
condition|(
name|mp
operator|->
name|m_len
operator|<
name|tcp_opt_off
condition|)
block|{
name|m_copydata
argument_list|(
name|mp
argument_list|,
literal|0
argument_list|,
name|tcp_opt_off
argument_list|,
name|hdr
argument_list|)
expr_stmt|;
name|ip6
operator|=
operator|(
expr|struct
name|ip6_hdr
operator|*
operator|)
operator|(
name|hdr
operator|+
name|ehdrlen
operator|)
expr_stmt|;
block|}
else|else
block|{
name|ip6
operator|=
operator|(
expr|struct
name|ip6_hdr
operator|*
operator|)
operator|(
name|mp
operator|->
name|m_data
operator|+
name|ehdrlen
operator|)
expr_stmt|;
block|}
name|ip_hlen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ip6_hdr
argument_list|)
expr_stmt|;
name|opcode
operator|=
name|Q8_TX_CMD_OP_XMT_TCP_LSO_IPV6
expr_stmt|;
if|if
condition|(
name|ip6
operator|->
name|ip6_nxt
operator|!=
name|IPPROTO_TCP
condition|)
block|{
comment|//device_printf(dev, "%s: ipv6\n", __func__);
name|offload
operator|=
literal|0
expr_stmt|;
block|}
else|else
name|th
operator|=
operator|(
expr|struct
name|tcphdr
operator|*
operator|)
operator|(
operator|(
name|caddr_t
operator|)
name|ip6
operator|+
name|ip_hlen
operator|)
expr_stmt|;
break|break;
default|default:
name|QL_DPRINT8
argument_list|(
name|ha
argument_list|,
operator|(
name|dev
operator|,
literal|"%s: type!=ip\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
name|offload
operator|=
literal|0
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
name|offload
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|tcp_hlen
operator|=
name|th
operator|->
name|th_off
operator|<<
literal|2
expr_stmt|;
name|hdrlen
operator|=
name|ehdrlen
operator|+
name|ip_hlen
operator|+
name|tcp_hlen
expr_stmt|;
if|if
condition|(
name|mp
operator|->
name|m_len
operator|<
name|hdrlen
condition|)
block|{
if|if
condition|(
name|mp
operator|->
name|m_len
operator|<
name|tcp_opt_off
condition|)
block|{
if|if
condition|(
name|tcp_hlen
operator|>
sizeof|sizeof
argument_list|(
expr|struct
name|tcphdr
argument_list|)
condition|)
block|{
name|m_copydata
argument_list|(
name|mp
argument_list|,
name|tcp_opt_off
argument_list|,
operator|(
name|tcp_hlen
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|tcphdr
argument_list|)
operator|)
argument_list|,
operator|&
name|hdr
index|[
name|tcp_opt_off
index|]
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|m_copydata
argument_list|(
name|mp
argument_list|,
literal|0
argument_list|,
name|hdrlen
argument_list|,
name|hdr
argument_list|)
expr_stmt|;
block|}
block|}
name|tx_cmd
operator|->
name|mss
operator|=
name|mp
operator|->
name|m_pkthdr
operator|.
name|tso_segsz
expr_stmt|;
name|tx_cmd
operator|->
name|flags_opcode
operator|=
name|opcode
expr_stmt|;
name|tx_cmd
operator|->
name|tcp_hdr_off
operator|=
name|ip_hlen
operator|+
name|ehdrlen
expr_stmt|;
name|tx_cmd
operator|->
name|total_hdr_len
operator|=
name|hdrlen
expr_stmt|;
comment|/* Check for Multicast least significant bit of MSB == 1 */
if|if
condition|(
name|eh
operator|->
name|evl_dhost
index|[
literal|0
index|]
operator|&
literal|0x01
condition|)
block|{
name|tx_cmd
operator|->
name|flags_opcode
operator||=
name|Q8_TX_CMD_FLAGS_MULTICAST
expr_stmt|;
block|}
if|if
condition|(
name|mp
operator|->
name|m_len
operator|<
name|hdrlen
condition|)
block|{
name|printf
argument_list|(
literal|"%d\n"
argument_list|,
name|hdrlen
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Name: qla_tx_chksum  * Function: Checks if the packet to be transmitted is a candidate for  *	TCP/UDP Checksum offload. If yes, the appropriate fields in the Tx  *	Ring Structure are plugged in.  */
end_comment

begin_function
specifier|static
name|int
name|qla_tx_chksum
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|struct
name|mbuf
modifier|*
name|mp
parameter_list|,
name|uint32_t
modifier|*
name|op_code
parameter_list|,
name|uint32_t
modifier|*
name|tcp_hdr_off
parameter_list|)
block|{
name|struct
name|ether_vlan_header
modifier|*
name|eh
decl_stmt|;
name|struct
name|ip
modifier|*
name|ip
decl_stmt|;
name|struct
name|ip6_hdr
modifier|*
name|ip6
decl_stmt|;
name|uint32_t
name|ehdrlen
decl_stmt|,
name|ip_hlen
decl_stmt|;
name|uint16_t
name|etype
decl_stmt|,
name|opcode
decl_stmt|,
name|offload
init|=
literal|1
decl_stmt|;
name|device_t
name|dev
decl_stmt|;
name|uint8_t
name|buf
index|[
sizeof|sizeof
argument_list|(
expr|struct
name|ip6_hdr
argument_list|)
index|]
decl_stmt|;
name|dev
operator|=
name|ha
operator|->
name|pci_dev
expr_stmt|;
operator|*
name|op_code
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|mp
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|&
operator|(
name|CSUM_TCP
operator||
name|CSUM_UDP
operator|)
operator|)
operator|==
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|eh
operator|=
name|mtod
argument_list|(
name|mp
argument_list|,
expr|struct
name|ether_vlan_header
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
name|eh
operator|->
name|evl_encap_proto
operator|==
name|htons
argument_list|(
name|ETHERTYPE_VLAN
argument_list|)
condition|)
block|{
name|ehdrlen
operator|=
name|ETHER_HDR_LEN
operator|+
name|ETHER_VLAN_ENCAP_LEN
expr_stmt|;
name|etype
operator|=
name|ntohs
argument_list|(
name|eh
operator|->
name|evl_proto
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ehdrlen
operator|=
name|ETHER_HDR_LEN
expr_stmt|;
name|etype
operator|=
name|ntohs
argument_list|(
name|eh
operator|->
name|evl_encap_proto
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|etype
condition|)
block|{
case|case
name|ETHERTYPE_IP
case|:
name|ip
operator|=
operator|(
expr|struct
name|ip
operator|*
operator|)
operator|(
name|mp
operator|->
name|m_data
operator|+
name|ehdrlen
operator|)
expr_stmt|;
name|ip_hlen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ip
argument_list|)
expr_stmt|;
if|if
condition|(
name|mp
operator|->
name|m_len
operator|<
operator|(
name|ehdrlen
operator|+
name|ip_hlen
operator|)
condition|)
block|{
name|m_copydata
argument_list|(
name|mp
argument_list|,
name|ehdrlen
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ip
argument_list|)
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|ip
operator|=
operator|(
expr|struct
name|ip
operator|*
operator|)
name|buf
expr_stmt|;
block|}
if|if
condition|(
name|ip
operator|->
name|ip_p
operator|==
name|IPPROTO_TCP
condition|)
name|opcode
operator|=
name|Q8_TX_CMD_OP_XMT_TCP_CHKSUM
expr_stmt|;
elseif|else
if|if
condition|(
name|ip
operator|->
name|ip_p
operator|==
name|IPPROTO_UDP
condition|)
name|opcode
operator|=
name|Q8_TX_CMD_OP_XMT_UDP_CHKSUM
expr_stmt|;
else|else
block|{
comment|//device_printf(dev, "%s: ipv4\n", __func__);
name|offload
operator|=
literal|0
expr_stmt|;
block|}
break|break;
case|case
name|ETHERTYPE_IPV6
case|:
name|ip6
operator|=
operator|(
expr|struct
name|ip6_hdr
operator|*
operator|)
operator|(
name|mp
operator|->
name|m_data
operator|+
name|ehdrlen
operator|)
expr_stmt|;
name|ip_hlen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ip6_hdr
argument_list|)
expr_stmt|;
if|if
condition|(
name|mp
operator|->
name|m_len
operator|<
operator|(
name|ehdrlen
operator|+
name|ip_hlen
operator|)
condition|)
block|{
name|m_copydata
argument_list|(
name|mp
argument_list|,
name|ehdrlen
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ip6_hdr
argument_list|)
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|ip6
operator|=
operator|(
expr|struct
name|ip6_hdr
operator|*
operator|)
name|buf
expr_stmt|;
block|}
if|if
condition|(
name|ip6
operator|->
name|ip6_nxt
operator|==
name|IPPROTO_TCP
condition|)
name|opcode
operator|=
name|Q8_TX_CMD_OP_XMT_TCP_CHKSUM_IPV6
expr_stmt|;
elseif|else
if|if
condition|(
name|ip6
operator|->
name|ip6_nxt
operator|==
name|IPPROTO_UDP
condition|)
name|opcode
operator|=
name|Q8_TX_CMD_OP_XMT_UDP_CHKSUM_IPV6
expr_stmt|;
else|else
block|{
comment|//device_printf(dev, "%s: ipv6\n", __func__);
name|offload
operator|=
literal|0
expr_stmt|;
block|}
break|break;
default|default:
name|offload
operator|=
literal|0
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
name|offload
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
operator|*
name|op_code
operator|=
name|opcode
expr_stmt|;
operator|*
name|tcp_hdr_off
operator|=
operator|(
name|ip_hlen
operator|+
name|ehdrlen
operator|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_define
define|#
directive|define
name|QLA_TX_MIN_FREE
value|2
end_define

begin_comment
comment|/*  * Name: ql_hw_send  * Function: Transmits a packet. It first checks if the packet is a  *	candidate for Large TCP Segment Offload and then for UDP/TCP checksum  *	offload. If either of these creteria are not met, it is transmitted  *	as a regular ethernet frame.  */
end_comment

begin_function
name|int
name|ql_hw_send
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|segs
parameter_list|,
name|int
name|nsegs
parameter_list|,
name|uint32_t
name|tx_idx
parameter_list|,
name|struct
name|mbuf
modifier|*
name|mp
parameter_list|,
name|uint32_t
name|txr_idx
parameter_list|)
block|{
name|struct
name|ether_vlan_header
modifier|*
name|eh
decl_stmt|;
name|qla_hw_t
modifier|*
name|hw
init|=
operator|&
name|ha
operator|->
name|hw
decl_stmt|;
name|q80_tx_cmd_t
modifier|*
name|tx_cmd
decl_stmt|,
name|tso_cmd
decl_stmt|;
name|bus_dma_segment_t
modifier|*
name|c_seg
decl_stmt|;
name|uint32_t
name|num_tx_cmds
decl_stmt|,
name|hdr_len
init|=
literal|0
decl_stmt|;
name|uint32_t
name|total_length
init|=
literal|0
decl_stmt|,
name|bytes
decl_stmt|,
name|tx_cmd_count
init|=
literal|0
decl_stmt|,
name|txr_next
decl_stmt|;
name|device_t
name|dev
decl_stmt|;
name|int
name|i
decl_stmt|,
name|ret
decl_stmt|;
name|uint8_t
modifier|*
name|src
init|=
name|NULL
decl_stmt|,
modifier|*
name|dst
init|=
name|NULL
decl_stmt|;
name|uint8_t
name|frame_hdr
index|[
name|QL_FRAME_HDR_SIZE
index|]
decl_stmt|;
name|uint32_t
name|op_code
init|=
literal|0
decl_stmt|;
name|uint32_t
name|tcp_hdr_off
init|=
literal|0
decl_stmt|;
name|dev
operator|=
name|ha
operator|->
name|pci_dev
expr_stmt|;
comment|/* 	 * Always make sure there is atleast one empty slot in the tx_ring 	 * tx_ring is considered full when there only one entry available 	 */
name|num_tx_cmds
operator|=
operator|(
name|nsegs
operator|+
operator|(
name|Q8_TX_CMD_MAX_SEGMENTS
operator|-
literal|1
operator|)
operator|)
operator|>>
literal|2
expr_stmt|;
name|total_length
operator|=
name|mp
operator|->
name|m_pkthdr
operator|.
name|len
expr_stmt|;
if|if
condition|(
name|total_length
operator|>
name|QLA_MAX_TSO_FRAME_SIZE
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: total length exceeds maxlen(%d)\n"
argument_list|,
name|__func__
argument_list|,
name|total_length
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|eh
operator|=
name|mtod
argument_list|(
name|mp
argument_list|,
expr|struct
name|ether_vlan_header
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
name|mp
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|&
name|CSUM_TSO
condition|)
block|{
name|bzero
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|&
name|tso_cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|q80_tx_cmd_t
argument_list|)
argument_list|)
expr_stmt|;
name|src
operator|=
name|frame_hdr
expr_stmt|;
name|ret
operator|=
name|qla_tx_tso
argument_list|(
name|ha
argument_list|,
name|mp
argument_list|,
operator|&
name|tso_cmd
argument_list|,
name|src
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ret
operator|&
operator|~
literal|1
operator|)
condition|)
block|{
comment|/* find the additional tx_cmd descriptors required */
if|if
condition|(
name|mp
operator|->
name|m_flags
operator|&
name|M_VLANTAG
condition|)
name|tso_cmd
operator|.
name|total_hdr_len
operator|+=
name|ETHER_VLAN_ENCAP_LEN
expr_stmt|;
name|hdr_len
operator|=
name|tso_cmd
operator|.
name|total_hdr_len
expr_stmt|;
name|bytes
operator|=
sizeof|sizeof
argument_list|(
name|q80_tx_cmd_t
argument_list|)
operator|-
name|Q8_TX_CMD_TSO_ALIGN
expr_stmt|;
name|bytes
operator|=
name|QL_MIN
argument_list|(
name|bytes
argument_list|,
name|hdr_len
argument_list|)
expr_stmt|;
name|num_tx_cmds
operator|++
expr_stmt|;
name|hdr_len
operator|-=
name|bytes
expr_stmt|;
while|while
condition|(
name|hdr_len
condition|)
block|{
name|bytes
operator|=
name|QL_MIN
argument_list|(
operator|(
sizeof|sizeof
argument_list|(
name|q80_tx_cmd_t
argument_list|)
operator|)
argument_list|,
name|hdr_len
argument_list|)
expr_stmt|;
name|hdr_len
operator|-=
name|bytes
expr_stmt|;
name|num_tx_cmds
operator|++
expr_stmt|;
block|}
name|hdr_len
operator|=
name|tso_cmd
operator|.
name|total_hdr_len
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
name|src
operator|=
operator|(
name|uint8_t
operator|*
operator|)
name|eh
expr_stmt|;
block|}
else|else
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
else|else
block|{
operator|(
name|void
operator|)
name|qla_tx_chksum
argument_list|(
name|ha
argument_list|,
name|mp
argument_list|,
operator|&
name|op_code
argument_list|,
operator|&
name|tcp_hdr_off
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|hw
operator|->
name|tx_cntxt
index|[
name|txr_idx
index|]
operator|.
name|txr_free
operator|<=
operator|(
name|num_tx_cmds
operator|+
name|QLA_TX_MIN_FREE
operator|)
condition|)
block|{
name|qla_hw_tx_done_locked
argument_list|(
name|ha
argument_list|,
name|txr_idx
argument_list|)
expr_stmt|;
if|if
condition|(
name|hw
operator|->
name|tx_cntxt
index|[
name|txr_idx
index|]
operator|.
name|txr_free
operator|<=
operator|(
name|num_tx_cmds
operator|+
name|QLA_TX_MIN_FREE
operator|)
condition|)
block|{
name|QL_DPRINT8
argument_list|(
name|ha
argument_list|,
operator|(
name|dev
operator|,
literal|"%s: (hw->txr_free<= "
literal|"(num_tx_cmds + QLA_TX_MIN_FREE))\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
name|tx_cmd
operator|=
operator|&
name|hw
operator|->
name|tx_cntxt
index|[
name|txr_idx
index|]
operator|.
name|tx_ring_base
index|[
name|tx_idx
index|]
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|mp
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|&
name|CSUM_TSO
operator|)
condition|)
block|{
if|if
condition|(
name|nsegs
operator|>
name|ha
operator|->
name|hw
operator|.
name|max_tx_segs
condition|)
name|ha
operator|->
name|hw
operator|.
name|max_tx_segs
operator|=
name|nsegs
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|void
operator|*
operator|)
name|tx_cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|q80_tx_cmd_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|op_code
condition|)
block|{
name|tx_cmd
operator|->
name|flags_opcode
operator|=
name|op_code
expr_stmt|;
name|tx_cmd
operator|->
name|tcp_hdr_off
operator|=
name|tcp_hdr_off
expr_stmt|;
block|}
else|else
block|{
name|tx_cmd
operator|->
name|flags_opcode
operator|=
name|Q8_TX_CMD_OP_XMT_ETHER
expr_stmt|;
block|}
block|}
else|else
block|{
name|bcopy
argument_list|(
operator|&
name|tso_cmd
argument_list|,
name|tx_cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|q80_tx_cmd_t
argument_list|)
argument_list|)
expr_stmt|;
name|ha
operator|->
name|tx_tso_frames
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|eh
operator|->
name|evl_encap_proto
operator|==
name|htons
argument_list|(
name|ETHERTYPE_VLAN
argument_list|)
condition|)
block|{
name|tx_cmd
operator|->
name|flags_opcode
operator||=
name|Q8_TX_CMD_FLAGS_VLAN_TAGGED
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|mp
operator|->
name|m_flags
operator|&
name|M_VLANTAG
condition|)
block|{
if|if
condition|(
name|hdr_len
condition|)
block|{
comment|/* TSO */
name|tx_cmd
operator|->
name|flags_opcode
operator||=
operator|(
name|Q8_TX_CMD_FLAGS_VLAN_TAGGED
operator||
name|Q8_TX_CMD_FLAGS_HW_VLAN_ID
operator|)
expr_stmt|;
name|tx_cmd
operator|->
name|tcp_hdr_off
operator|+=
name|ETHER_VLAN_ENCAP_LEN
expr_stmt|;
block|}
else|else
name|tx_cmd
operator|->
name|flags_opcode
operator||=
name|Q8_TX_CMD_FLAGS_HW_VLAN_ID
expr_stmt|;
name|ha
operator|->
name|hw_vlan_tx_frames
operator|++
expr_stmt|;
name|tx_cmd
operator|->
name|vlan_tci
operator|=
name|mp
operator|->
name|m_pkthdr
operator|.
name|ether_vtag
expr_stmt|;
block|}
name|tx_cmd
operator|->
name|n_bufs
operator|=
operator|(
name|uint8_t
operator|)
name|nsegs
expr_stmt|;
name|tx_cmd
operator|->
name|data_len_lo
operator|=
call|(
name|uint8_t
call|)
argument_list|(
name|total_length
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
name|tx_cmd
operator|->
name|data_len_hi
operator|=
name|qla_host_to_le16
argument_list|(
operator|(
call|(
name|uint16_t
call|)
argument_list|(
name|total_length
operator|>>
literal|8
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|tx_cmd
operator|->
name|cntxtid
operator|=
name|Q8_TX_CMD_PORT_CNXTID
argument_list|(
name|ha
operator|->
name|pci_func
argument_list|)
expr_stmt|;
name|c_seg
operator|=
name|segs
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|(
operator|(
name|i
operator|<
name|Q8_TX_CMD_MAX_SEGMENTS
operator|)
operator|&&
name|nsegs
operator|)
condition|;
name|i
operator|++
control|)
block|{
switch|switch
condition|(
name|i
condition|)
block|{
case|case
literal|0
case|:
name|tx_cmd
operator|->
name|buf1_addr
operator|=
name|c_seg
operator|->
name|ds_addr
expr_stmt|;
name|tx_cmd
operator|->
name|buf1_len
operator|=
name|c_seg
operator|->
name|ds_len
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|tx_cmd
operator|->
name|buf2_addr
operator|=
name|c_seg
operator|->
name|ds_addr
expr_stmt|;
name|tx_cmd
operator|->
name|buf2_len
operator|=
name|c_seg
operator|->
name|ds_len
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|tx_cmd
operator|->
name|buf3_addr
operator|=
name|c_seg
operator|->
name|ds_addr
expr_stmt|;
name|tx_cmd
operator|->
name|buf3_len
operator|=
name|c_seg
operator|->
name|ds_len
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|tx_cmd
operator|->
name|buf4_addr
operator|=
name|c_seg
operator|->
name|ds_addr
expr_stmt|;
name|tx_cmd
operator|->
name|buf4_len
operator|=
name|c_seg
operator|->
name|ds_len
expr_stmt|;
break|break;
block|}
name|c_seg
operator|++
expr_stmt|;
name|nsegs
operator|--
expr_stmt|;
block|}
name|txr_next
operator|=
name|hw
operator|->
name|tx_cntxt
index|[
name|txr_idx
index|]
operator|.
name|txr_next
operator|=
operator|(
name|hw
operator|->
name|tx_cntxt
index|[
name|txr_idx
index|]
operator|.
name|txr_next
operator|+
literal|1
operator|)
operator|&
operator|(
name|NUM_TX_DESCRIPTORS
operator|-
literal|1
operator|)
expr_stmt|;
name|tx_cmd_count
operator|++
expr_stmt|;
if|if
condition|(
operator|!
name|nsegs
condition|)
break|break;
name|tx_cmd
operator|=
operator|&
name|hw
operator|->
name|tx_cntxt
index|[
name|txr_idx
index|]
operator|.
name|tx_ring_base
index|[
name|txr_next
index|]
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|void
operator|*
operator|)
name|tx_cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|q80_tx_cmd_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mp
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|&
name|CSUM_TSO
condition|)
block|{
comment|/* TSO : Copy the header in the following tx cmd descriptors */
name|txr_next
operator|=
name|hw
operator|->
name|tx_cntxt
index|[
name|txr_idx
index|]
operator|.
name|txr_next
expr_stmt|;
name|tx_cmd
operator|=
operator|&
name|hw
operator|->
name|tx_cntxt
index|[
name|txr_idx
index|]
operator|.
name|tx_ring_base
index|[
name|txr_next
index|]
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|void
operator|*
operator|)
name|tx_cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|q80_tx_cmd_t
argument_list|)
argument_list|)
expr_stmt|;
name|bytes
operator|=
sizeof|sizeof
argument_list|(
name|q80_tx_cmd_t
argument_list|)
operator|-
name|Q8_TX_CMD_TSO_ALIGN
expr_stmt|;
name|bytes
operator|=
name|QL_MIN
argument_list|(
name|bytes
argument_list|,
name|hdr_len
argument_list|)
expr_stmt|;
name|dst
operator|=
operator|(
name|uint8_t
operator|*
operator|)
name|tx_cmd
operator|+
name|Q8_TX_CMD_TSO_ALIGN
expr_stmt|;
if|if
condition|(
name|mp
operator|->
name|m_flags
operator|&
name|M_VLANTAG
condition|)
block|{
comment|/* first copy the src/dst MAC addresses */
name|bcopy
argument_list|(
name|src
argument_list|,
name|dst
argument_list|,
operator|(
name|ETHER_ADDR_LEN
operator|*
literal|2
operator|)
argument_list|)
expr_stmt|;
name|dst
operator|+=
operator|(
name|ETHER_ADDR_LEN
operator|*
literal|2
operator|)
expr_stmt|;
name|src
operator|+=
operator|(
name|ETHER_ADDR_LEN
operator|*
literal|2
operator|)
expr_stmt|;
operator|*
operator|(
operator|(
name|uint16_t
operator|*
operator|)
name|dst
operator|)
operator|=
name|htons
argument_list|(
name|ETHERTYPE_VLAN
argument_list|)
expr_stmt|;
name|dst
operator|+=
literal|2
expr_stmt|;
operator|*
operator|(
operator|(
name|uint16_t
operator|*
operator|)
name|dst
operator|)
operator|=
name|htons
argument_list|(
name|mp
operator|->
name|m_pkthdr
operator|.
name|ether_vtag
argument_list|)
expr_stmt|;
name|dst
operator|+=
literal|2
expr_stmt|;
comment|/* bytes left in src header */
name|hdr_len
operator|-=
operator|(
operator|(
name|ETHER_ADDR_LEN
operator|*
literal|2
operator|)
operator|+
name|ETHER_VLAN_ENCAP_LEN
operator|)
expr_stmt|;
comment|/* bytes left in TxCmd Entry */
name|bytes
operator|-=
operator|(
operator|(
name|ETHER_ADDR_LEN
operator|*
literal|2
operator|)
operator|+
name|ETHER_VLAN_ENCAP_LEN
operator|)
expr_stmt|;
name|bcopy
argument_list|(
name|src
argument_list|,
name|dst
argument_list|,
name|bytes
argument_list|)
expr_stmt|;
name|src
operator|+=
name|bytes
expr_stmt|;
name|hdr_len
operator|-=
name|bytes
expr_stmt|;
block|}
else|else
block|{
name|bcopy
argument_list|(
name|src
argument_list|,
name|dst
argument_list|,
name|bytes
argument_list|)
expr_stmt|;
name|src
operator|+=
name|bytes
expr_stmt|;
name|hdr_len
operator|-=
name|bytes
expr_stmt|;
block|}
name|txr_next
operator|=
name|hw
operator|->
name|tx_cntxt
index|[
name|txr_idx
index|]
operator|.
name|txr_next
operator|=
operator|(
name|hw
operator|->
name|tx_cntxt
index|[
name|txr_idx
index|]
operator|.
name|txr_next
operator|+
literal|1
operator|)
operator|&
operator|(
name|NUM_TX_DESCRIPTORS
operator|-
literal|1
operator|)
expr_stmt|;
name|tx_cmd_count
operator|++
expr_stmt|;
while|while
condition|(
name|hdr_len
condition|)
block|{
name|tx_cmd
operator|=
operator|&
name|hw
operator|->
name|tx_cntxt
index|[
name|txr_idx
index|]
operator|.
name|tx_ring_base
index|[
name|txr_next
index|]
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|void
operator|*
operator|)
name|tx_cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|q80_tx_cmd_t
argument_list|)
argument_list|)
expr_stmt|;
name|bytes
operator|=
name|QL_MIN
argument_list|(
operator|(
sizeof|sizeof
argument_list|(
name|q80_tx_cmd_t
argument_list|)
operator|)
argument_list|,
name|hdr_len
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|src
argument_list|,
name|tx_cmd
argument_list|,
name|bytes
argument_list|)
expr_stmt|;
name|src
operator|+=
name|bytes
expr_stmt|;
name|hdr_len
operator|-=
name|bytes
expr_stmt|;
name|txr_next
operator|=
name|hw
operator|->
name|tx_cntxt
index|[
name|txr_idx
index|]
operator|.
name|txr_next
operator|=
operator|(
name|hw
operator|->
name|tx_cntxt
index|[
name|txr_idx
index|]
operator|.
name|txr_next
operator|+
literal|1
operator|)
operator|&
operator|(
name|NUM_TX_DESCRIPTORS
operator|-
literal|1
operator|)
expr_stmt|;
name|tx_cmd_count
operator|++
expr_stmt|;
block|}
block|}
name|hw
operator|->
name|tx_cntxt
index|[
name|txr_idx
index|]
operator|.
name|txr_free
operator|=
name|hw
operator|->
name|tx_cntxt
index|[
name|txr_idx
index|]
operator|.
name|txr_free
operator|-
name|tx_cmd_count
expr_stmt|;
name|QL_UPDATE_TX_PRODUCER_INDEX
argument_list|(
name|ha
argument_list|,
name|hw
operator|->
name|tx_cntxt
index|[
name|txr_idx
index|]
operator|.
name|txr_next
argument_list|,\
name|txr_idx
argument_list|)
expr_stmt|;
name|QL_DPRINT8
argument_list|(
name|ha
argument_list|,
operator|(
name|dev
operator|,
literal|"%s: return\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qla_config_rss_ind_table
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|uint32_t
name|i
decl_stmt|,
name|count
decl_stmt|;
name|uint8_t
name|rss_ind_tbl
index|[
literal|16
index|]
decl_stmt|;
name|bzero
argument_list|(
name|rss_ind_default_table
argument_list|,
sizeof|sizeof
argument_list|(
name|rss_ind_default_table
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
block|{
name|rss_ind_tbl
index|[
name|i
index|]
operator|=
name|i
operator|%
name|ha
operator|->
name|hw
operator|.
name|num_sds_rings
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
name|Q8_RSS_IND_TBL_MAX_IDX
condition|;
name|i
operator|=
name|i
operator|+
literal|16
control|)
block|{
if|if
condition|(
operator|(
name|i
operator|+
literal|16
operator|)
operator|>
name|Q8_RSS_IND_TBL_MAX_IDX
condition|)
block|{
name|count
operator|=
name|Q8_RSS_IND_TBL_MAX_IDX
operator|-
name|i
operator|+
literal|1
expr_stmt|;
block|}
else|else
block|{
name|count
operator|=
literal|16
expr_stmt|;
block|}
if|if
condition|(
name|qla_set_rss_ind_table
argument_list|(
name|ha
argument_list|,
name|i
argument_list|,
name|count
argument_list|,
name|ha
operator|->
name|hw
operator|.
name|rcv_cntxt_id
argument_list|,
name|rss_ind_tbl
argument_list|)
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Name: ql_del_hw_if  * Function: Destroys the hardware specific entities corresponding to an  *	Ethernet Interface  */
end_comment

begin_function
name|void
name|ql_del_hw_if
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|qla_del_rcv_cntxt
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|qla_del_xmt_cntxt
argument_list|(
name|ha
argument_list|)
expr_stmt|;
if|if
condition|(
name|ha
operator|->
name|hw
operator|.
name|flags
operator|.
name|init_intr_cnxt
condition|)
block|{
name|qla_config_intr_cntxt
argument_list|(
name|ha
argument_list|,
name|ha
operator|->
name|hw
operator|.
name|num_sds_rings
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ha
operator|->
name|hw
operator|.
name|flags
operator|.
name|init_intr_cnxt
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Name: ql_init_hw_if  * Function: Creates the hardware specific entities corresponding to an  *	Ethernet Interface - Transmit and Receive Contexts. Sets the MAC Address  *	corresponding to the interface. Enables LRO if allowed.  */
end_comment

begin_function
name|int
name|ql_init_hw_if
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|device_t
name|dev
decl_stmt|;
name|uint32_t
name|i
decl_stmt|;
name|uint8_t
name|bcast_mac
index|[
literal|6
index|]
decl_stmt|;
name|qla_rdesc_t
modifier|*
name|rdesc
decl_stmt|;
name|dev
operator|=
name|ha
operator|->
name|pci_dev
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|hw
operator|.
name|num_sds_rings
condition|;
name|i
operator|++
control|)
block|{
name|bzero
argument_list|(
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|sds_ring
index|[
name|i
index|]
operator|.
name|dma_b
argument_list|,
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|sds_ring
index|[
name|i
index|]
operator|.
name|size
argument_list|)
expr_stmt|;
block|}
name|ha
operator|->
name|hw
operator|.
name|mbx_intr_mask_offset
operator|=
name|READ_REG32
argument_list|(
name|ha
argument_list|,
name|Q8_MBOX_INT_MASK_MSIX
argument_list|)
expr_stmt|;
comment|/* Use MSI-X vector 0; Enable Firmware Mailbox Interrupt */
name|WRITE_REG32
argument_list|(
name|ha
argument_list|,
name|Q8_MBOX_INT_ENABLE
argument_list|,
name|BIT_2
argument_list|)
expr_stmt|;
name|WRITE_REG32
argument_list|(
name|ha
argument_list|,
name|ha
operator|->
name|hw
operator|.
name|mbx_intr_mask_offset
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
name|qla_get_nic_partition
argument_list|(
name|ha
argument_list|)
expr_stmt|;
if|if
condition|(
name|qla_config_intr_cntxt
argument_list|(
name|ha
argument_list|,
name|ha
operator|->
name|hw
operator|.
name|num_sds_rings
argument_list|,
literal|1
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ha
operator|->
name|hw
operator|.
name|flags
operator|.
name|init_intr_cnxt
operator|=
literal|1
expr_stmt|;
block|}
else|else
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|ha
operator|->
name|hw
operator|.
name|mdump_init
operator|==
literal|0
condition|)
block|{
name|qla_minidump_init
argument_list|(
name|ha
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Create Receive Context 	 */
if|if
condition|(
name|qla_init_rcv_cntxt
argument_list|(
name|ha
argument_list|)
condition|)
block|{
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|hw
operator|.
name|num_rds_rings
condition|;
name|i
operator|++
control|)
block|{
name|rdesc
operator|=
operator|&
name|ha
operator|->
name|hw
operator|.
name|rds
index|[
name|i
index|]
expr_stmt|;
name|rdesc
operator|->
name|rx_next
operator|=
name|NUM_RX_DESCRIPTORS
operator|-
literal|2
expr_stmt|;
name|rdesc
operator|->
name|rx_in
operator|=
literal|0
expr_stmt|;
comment|/* Update the RDS Producer Indices */
name|QL_UPDATE_RDS_PRODUCER_INDEX
argument_list|(
name|ha
argument_list|,
name|rdesc
operator|->
name|prod_std
argument_list|,\
name|rdesc
operator|->
name|rx_next
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Create Transmit Context 	 */
if|if
condition|(
name|qla_init_xmt_cntxt
argument_list|(
name|ha
argument_list|)
condition|)
block|{
name|qla_del_rcv_cntxt
argument_list|(
name|ha
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|ha
operator|->
name|hw
operator|.
name|max_tx_segs
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|qla_config_mac_addr
argument_list|(
name|ha
argument_list|,
name|ha
operator|->
name|hw
operator|.
name|mac_addr
argument_list|,
literal|1
argument_list|)
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|ha
operator|->
name|hw
operator|.
name|flags
operator|.
name|unicast_mac
operator|=
literal|1
expr_stmt|;
name|bcast_mac
index|[
literal|0
index|]
operator|=
literal|0xFF
expr_stmt|;
name|bcast_mac
index|[
literal|1
index|]
operator|=
literal|0xFF
expr_stmt|;
name|bcast_mac
index|[
literal|2
index|]
operator|=
literal|0xFF
expr_stmt|;
name|bcast_mac
index|[
literal|3
index|]
operator|=
literal|0xFF
expr_stmt|;
name|bcast_mac
index|[
literal|4
index|]
operator|=
literal|0xFF
expr_stmt|;
name|bcast_mac
index|[
literal|5
index|]
operator|=
literal|0xFF
expr_stmt|;
if|if
condition|(
name|qla_config_mac_addr
argument_list|(
name|ha
argument_list|,
name|bcast_mac
argument_list|,
literal|1
argument_list|)
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|ha
operator|->
name|hw
operator|.
name|flags
operator|.
name|bcast_mac
operator|=
literal|1
expr_stmt|;
comment|/* 	 * program any cached multicast addresses 	 */
if|if
condition|(
name|qla_hw_add_all_mcast
argument_list|(
name|ha
argument_list|)
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|qla_config_rss
argument_list|(
name|ha
argument_list|,
name|ha
operator|->
name|hw
operator|.
name|rcv_cntxt_id
argument_list|)
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|qla_config_rss_ind_table
argument_list|(
name|ha
argument_list|)
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|qla_config_intr_coalesce
argument_list|(
name|ha
argument_list|,
name|ha
operator|->
name|hw
operator|.
name|rcv_cntxt_id
argument_list|,
literal|0
argument_list|)
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|qla_link_event_req
argument_list|(
name|ha
argument_list|,
name|ha
operator|->
name|hw
operator|.
name|rcv_cntxt_id
argument_list|)
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|qla_config_fw_lro
argument_list|(
name|ha
argument_list|,
name|ha
operator|->
name|hw
operator|.
name|rcv_cntxt_id
argument_list|)
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|hw
operator|.
name|num_sds_rings
condition|;
name|i
operator|++
control|)
name|QL_ENABLE_INTERRUPTS
argument_list|(
name|ha
argument_list|,
name|i
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qla_map_sds_to_rds
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|device_t
name|dev
init|=
name|ha
operator|->
name|pci_dev
decl_stmt|;
name|q80_rq_map_sds_to_rds_t
modifier|*
name|map_rings
decl_stmt|;
name|q80_rsp_add_rcv_rings_t
modifier|*
name|map_rings_rsp
decl_stmt|;
name|uint32_t
name|i
decl_stmt|,
name|err
decl_stmt|;
name|qla_hw_t
modifier|*
name|hw
init|=
operator|&
name|ha
operator|->
name|hw
decl_stmt|;
name|map_rings
operator|=
operator|(
name|q80_rq_map_sds_to_rds_t
operator|*
operator|)
name|ha
operator|->
name|hw
operator|.
name|mbox
expr_stmt|;
name|bzero
argument_list|(
name|map_rings
argument_list|,
sizeof|sizeof
argument_list|(
name|q80_rq_map_sds_to_rds_t
argument_list|)
argument_list|)
expr_stmt|;
name|map_rings
operator|->
name|opcode
operator|=
name|Q8_MBX_MAP_SDS_TO_RDS
expr_stmt|;
name|map_rings
operator|->
name|count_version
operator|=
operator|(
sizeof|sizeof
argument_list|(
name|q80_rq_map_sds_to_rds_t
argument_list|)
operator|>>
literal|2
operator|)
expr_stmt|;
name|map_rings
operator|->
name|count_version
operator||=
name|Q8_MBX_CMD_VERSION
expr_stmt|;
name|map_rings
operator|->
name|cntxt_id
operator|=
name|hw
operator|->
name|rcv_cntxt_id
expr_stmt|;
name|map_rings
operator|->
name|num_rings
operator|=
name|hw
operator|->
name|num_sds_rings
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|hw
operator|->
name|num_sds_rings
condition|;
name|i
operator|++
control|)
block|{
name|map_rings
operator|->
name|sds_rds
index|[
name|i
index|]
operator|.
name|sds_ring
operator|=
name|i
expr_stmt|;
name|map_rings
operator|->
name|sds_rds
index|[
name|i
index|]
operator|.
name|rds_ring
operator|=
name|i
expr_stmt|;
block|}
if|if
condition|(
name|qla_mbx_cmd
argument_list|(
name|ha
argument_list|,
operator|(
name|uint32_t
operator|*
operator|)
name|map_rings
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|q80_rq_map_sds_to_rds_t
argument_list|)
operator|>>
literal|2
operator|)
argument_list|,
name|ha
operator|->
name|hw
operator|.
name|mbox
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|q80_rsp_add_rcv_rings_t
argument_list|)
operator|>>
literal|2
operator|)
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: failed0\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|map_rings_rsp
operator|=
operator|(
name|q80_rsp_add_rcv_rings_t
operator|*
operator|)
name|ha
operator|->
name|hw
operator|.
name|mbox
expr_stmt|;
name|err
operator|=
name|Q8_MBX_RSP_STATUS
argument_list|(
name|map_rings_rsp
operator|->
name|regcnt_status
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: failed1 [0x%08x]\n"
argument_list|,
name|__func__
argument_list|,
name|err
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Name: qla_init_rcv_cntxt  * Function: Creates the Receive Context.  */
end_comment

begin_function
specifier|static
name|int
name|qla_init_rcv_cntxt
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|q80_rq_rcv_cntxt_t
modifier|*
name|rcntxt
decl_stmt|;
name|q80_rsp_rcv_cntxt_t
modifier|*
name|rcntxt_rsp
decl_stmt|;
name|q80_stat_desc_t
modifier|*
name|sdesc
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|qla_hw_t
modifier|*
name|hw
init|=
operator|&
name|ha
operator|->
name|hw
decl_stmt|;
name|device_t
name|dev
decl_stmt|;
name|uint32_t
name|err
decl_stmt|;
name|uint32_t
name|rcntxt_sds_rings
decl_stmt|;
name|uint32_t
name|rcntxt_rds_rings
decl_stmt|;
name|dev
operator|=
name|ha
operator|->
name|pci_dev
expr_stmt|;
comment|/* 	 * Create Receive Context 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|hw
operator|->
name|num_sds_rings
condition|;
name|i
operator|++
control|)
block|{
name|sdesc
operator|=
operator|(
name|q80_stat_desc_t
operator|*
operator|)
operator|&
name|hw
operator|->
name|sds
index|[
name|i
index|]
operator|.
name|sds_ring_base
index|[
literal|0
index|]
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|NUM_STATUS_DESCRIPTORS
condition|;
name|j
operator|++
control|)
block|{
name|sdesc
operator|->
name|data
index|[
literal|0
index|]
operator|=
literal|1ULL
expr_stmt|;
name|sdesc
operator|->
name|data
index|[
literal|1
index|]
operator|=
literal|1ULL
expr_stmt|;
block|}
block|}
name|rcntxt_sds_rings
operator|=
name|hw
operator|->
name|num_sds_rings
expr_stmt|;
if|if
condition|(
name|hw
operator|->
name|num_sds_rings
operator|>
name|MAX_RCNTXT_SDS_RINGS
condition|)
name|rcntxt_sds_rings
operator|=
name|MAX_RCNTXT_SDS_RINGS
expr_stmt|;
name|rcntxt_rds_rings
operator|=
name|hw
operator|->
name|num_rds_rings
expr_stmt|;
if|if
condition|(
name|hw
operator|->
name|num_rds_rings
operator|>
name|MAX_RDS_RING_SETS
condition|)
name|rcntxt_rds_rings
operator|=
name|MAX_RDS_RING_SETS
expr_stmt|;
name|rcntxt
operator|=
operator|(
name|q80_rq_rcv_cntxt_t
operator|*
operator|)
name|ha
operator|->
name|hw
operator|.
name|mbox
expr_stmt|;
name|bzero
argument_list|(
name|rcntxt
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|q80_rq_rcv_cntxt_t
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|rcntxt
operator|->
name|opcode
operator|=
name|Q8_MBX_CREATE_RX_CNTXT
expr_stmt|;
name|rcntxt
operator|->
name|count_version
operator|=
operator|(
sizeof|sizeof
argument_list|(
name|q80_rq_rcv_cntxt_t
argument_list|)
operator|>>
literal|2
operator|)
expr_stmt|;
name|rcntxt
operator|->
name|count_version
operator||=
name|Q8_MBX_CMD_VERSION
expr_stmt|;
name|rcntxt
operator|->
name|cap0
operator|=
name|Q8_RCV_CNTXT_CAP0_BASEFW
operator||
name|Q8_RCV_CNTXT_CAP0_LRO
operator||
name|Q8_RCV_CNTXT_CAP0_HW_LRO
operator||
name|Q8_RCV_CNTXT_CAP0_RSS
operator||
name|Q8_RCV_CNTXT_CAP0_SGL_JUMBO
operator||
name|Q8_RCV_CNTXT_CAP0_SGL_LRO
expr_stmt|;
if|if
condition|(
name|ha
operator|->
name|hw
operator|.
name|num_rds_rings
operator|>
literal|1
condition|)
block|{
name|rcntxt
operator|->
name|nrds_sets_rings
operator|=
name|rcntxt_rds_rings
operator||
operator|(
literal|1
operator|<<
literal|5
operator|)
expr_stmt|;
name|rcntxt
operator|->
name|cap0
operator||=
name|Q8_RCV_CNTXT_CAP0_MULTI_RDS
expr_stmt|;
block|}
else|else
name|rcntxt
operator|->
name|nrds_sets_rings
operator|=
literal|0x1
operator||
operator|(
literal|1
operator|<<
literal|5
operator|)
expr_stmt|;
name|rcntxt
operator|->
name|nsds_rings
operator|=
name|rcntxt_sds_rings
expr_stmt|;
name|rcntxt
operator|->
name|rds_producer_mode
operator|=
name|Q8_RCV_CNTXT_RDS_PROD_MODE_UNIQUE
expr_stmt|;
name|rcntxt
operator|->
name|rcv_vpid
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rcntxt_sds_rings
condition|;
name|i
operator|++
control|)
block|{
name|rcntxt
operator|->
name|sds
index|[
name|i
index|]
operator|.
name|paddr
operator|=
name|qla_host_to_le64
argument_list|(
name|hw
operator|->
name|dma_buf
operator|.
name|sds_ring
index|[
name|i
index|]
operator|.
name|dma_addr
argument_list|)
expr_stmt|;
name|rcntxt
operator|->
name|sds
index|[
name|i
index|]
operator|.
name|size
operator|=
name|qla_host_to_le32
argument_list|(
name|NUM_STATUS_DESCRIPTORS
argument_list|)
expr_stmt|;
if|if
condition|(
name|ha
operator|->
name|msix_count
operator|==
literal|2
condition|)
block|{
name|rcntxt
operator|->
name|sds
index|[
name|i
index|]
operator|.
name|intr_id
operator|=
name|qla_host_to_le16
argument_list|(
name|hw
operator|->
name|intr_id
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|rcntxt
operator|->
name|sds
index|[
name|i
index|]
operator|.
name|intr_src_bit
operator|=
name|qla_host_to_le16
argument_list|(
operator|(
name|i
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|rcntxt
operator|->
name|sds
index|[
name|i
index|]
operator|.
name|intr_id
operator|=
name|qla_host_to_le16
argument_list|(
name|hw
operator|->
name|intr_id
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|rcntxt
operator|->
name|sds
index|[
name|i
index|]
operator|.
name|intr_src_bit
operator|=
name|qla_host_to_le16
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rcntxt_rds_rings
condition|;
name|i
operator|++
control|)
block|{
name|rcntxt
operator|->
name|rds
index|[
name|i
index|]
operator|.
name|paddr_std
operator|=
name|qla_host_to_le64
argument_list|(
name|hw
operator|->
name|dma_buf
operator|.
name|rds_ring
index|[
name|i
index|]
operator|.
name|dma_addr
argument_list|)
expr_stmt|;
name|rcntxt
operator|->
name|rds
index|[
name|i
index|]
operator|.
name|std_bsize
operator|=
name|qla_host_to_le64
argument_list|(
name|MCLBYTES
argument_list|)
expr_stmt|;
name|rcntxt
operator|->
name|rds
index|[
name|i
index|]
operator|.
name|std_nentries
operator|=
name|qla_host_to_le32
argument_list|(
name|NUM_RX_DESCRIPTORS
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|qla_mbx_cmd
argument_list|(
name|ha
argument_list|,
operator|(
name|uint32_t
operator|*
operator|)
name|rcntxt
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|q80_rq_rcv_cntxt_t
argument_list|)
operator|>>
literal|2
operator|)
argument_list|,
name|ha
operator|->
name|hw
operator|.
name|mbox
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|q80_rsp_rcv_cntxt_t
argument_list|)
operator|>>
literal|2
operator|)
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: failed0\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|rcntxt_rsp
operator|=
operator|(
name|q80_rsp_rcv_cntxt_t
operator|*
operator|)
name|ha
operator|->
name|hw
operator|.
name|mbox
expr_stmt|;
name|err
operator|=
name|Q8_MBX_RSP_STATUS
argument_list|(
name|rcntxt_rsp
operator|->
name|regcnt_status
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: failed1 [0x%08x]\n"
argument_list|,
name|__func__
argument_list|,
name|err
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rcntxt_sds_rings
condition|;
name|i
operator|++
control|)
block|{
name|hw
operator|->
name|sds
index|[
name|i
index|]
operator|.
name|sds_consumer
operator|=
name|rcntxt_rsp
operator|->
name|sds_cons
index|[
name|i
index|]
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rcntxt_rds_rings
condition|;
name|i
operator|++
control|)
block|{
name|hw
operator|->
name|rds
index|[
name|i
index|]
operator|.
name|prod_std
operator|=
name|rcntxt_rsp
operator|->
name|rds
index|[
name|i
index|]
operator|.
name|prod_std
expr_stmt|;
block|}
name|hw
operator|->
name|rcv_cntxt_id
operator|=
name|rcntxt_rsp
operator|->
name|cntxt_id
expr_stmt|;
name|ha
operator|->
name|hw
operator|.
name|flags
operator|.
name|init_rx_cnxt
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|hw
operator|->
name|num_sds_rings
operator|>
name|MAX_RCNTXT_SDS_RINGS
condition|)
block|{
name|err
operator|=
name|qla_add_rcv_rings
argument_list|(
name|ha
argument_list|,
name|MAX_RCNTXT_SDS_RINGS
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|hw
operator|->
name|num_rds_rings
operator|>
literal|1
condition|)
block|{
name|err
operator|=
name|qla_map_sds_to_rds
argument_list|(
name|ha
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
operator|-
literal|1
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qla_add_rcv_rings
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint32_t
name|sds_idx
parameter_list|)
block|{
name|device_t
name|dev
init|=
name|ha
operator|->
name|pci_dev
decl_stmt|;
name|q80_rq_add_rcv_rings_t
modifier|*
name|add_rcv
decl_stmt|;
name|q80_rsp_add_rcv_rings_t
modifier|*
name|add_rcv_rsp
decl_stmt|;
name|uint32_t
name|i
decl_stmt|,
name|j
decl_stmt|,
name|err
decl_stmt|;
name|uint8_t
name|nsds
decl_stmt|;
name|qla_hw_t
modifier|*
name|hw
init|=
operator|&
name|ha
operator|->
name|hw
decl_stmt|;
name|nsds
operator|=
name|hw
operator|->
name|num_sds_rings
operator|-
name|MAX_RCNTXT_SDS_RINGS
expr_stmt|;
name|add_rcv
operator|=
operator|(
name|q80_rq_add_rcv_rings_t
operator|*
operator|)
name|ha
operator|->
name|hw
operator|.
name|mbox
expr_stmt|;
name|bzero
argument_list|(
name|add_rcv
argument_list|,
sizeof|sizeof
argument_list|(
name|q80_rq_add_rcv_rings_t
argument_list|)
argument_list|)
expr_stmt|;
name|add_rcv
operator|->
name|opcode
operator|=
name|Q8_MBX_ADD_RX_RINGS
expr_stmt|;
name|add_rcv
operator|->
name|count_version
operator|=
operator|(
sizeof|sizeof
argument_list|(
name|q80_rq_add_rcv_rings_t
argument_list|)
operator|>>
literal|2
operator|)
expr_stmt|;
name|add_rcv
operator|->
name|count_version
operator||=
name|Q8_MBX_CMD_VERSION
expr_stmt|;
if|if
condition|(
name|hw
operator|->
name|num_rds_rings
operator|>
literal|1
condition|)
name|add_rcv
operator|->
name|nrds_sets_rings
operator|=
name|nsds
operator||
operator|(
literal|1
operator|<<
literal|5
operator|)
expr_stmt|;
else|else
name|add_rcv
operator|->
name|nrds_sets_rings
operator|=
literal|0
expr_stmt|;
name|add_rcv
operator|->
name|nsds_rings
operator|=
name|nsds
expr_stmt|;
name|add_rcv
operator|->
name|cntxt_id
operator|=
name|hw
operator|->
name|rcv_cntxt_id
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nsds
condition|;
name|i
operator|++
control|)
block|{
name|j
operator|=
name|i
operator|+
name|sds_idx
expr_stmt|;
name|add_rcv
operator|->
name|sds
index|[
name|i
index|]
operator|.
name|paddr
operator|=
name|qla_host_to_le64
argument_list|(
name|hw
operator|->
name|dma_buf
operator|.
name|sds_ring
index|[
name|j
index|]
operator|.
name|dma_addr
argument_list|)
expr_stmt|;
name|add_rcv
operator|->
name|sds
index|[
name|i
index|]
operator|.
name|size
operator|=
name|qla_host_to_le32
argument_list|(
name|NUM_STATUS_DESCRIPTORS
argument_list|)
expr_stmt|;
if|if
condition|(
name|ha
operator|->
name|msix_count
operator|==
literal|2
condition|)
block|{
name|add_rcv
operator|->
name|sds
index|[
name|i
index|]
operator|.
name|intr_id
operator|=
name|qla_host_to_le16
argument_list|(
name|hw
operator|->
name|intr_id
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|add_rcv
operator|->
name|sds
index|[
name|i
index|]
operator|.
name|intr_src_bit
operator|=
name|qla_host_to_le16
argument_list|(
name|j
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|add_rcv
operator|->
name|sds
index|[
name|i
index|]
operator|.
name|intr_id
operator|=
name|qla_host_to_le16
argument_list|(
name|hw
operator|->
name|intr_id
index|[
name|j
index|]
argument_list|)
expr_stmt|;
name|add_rcv
operator|->
name|sds
index|[
name|i
index|]
operator|.
name|intr_src_bit
operator|=
name|qla_host_to_le16
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|(
operator|(
name|i
operator|<
name|nsds
operator|)
operator|&&
operator|(
name|hw
operator|->
name|num_rds_rings
operator|>
literal|1
operator|)
operator|)
condition|;
name|i
operator|++
control|)
block|{
name|j
operator|=
name|i
operator|+
name|sds_idx
expr_stmt|;
name|add_rcv
operator|->
name|rds
index|[
name|i
index|]
operator|.
name|paddr_std
operator|=
name|qla_host_to_le64
argument_list|(
name|hw
operator|->
name|dma_buf
operator|.
name|rds_ring
index|[
name|j
index|]
operator|.
name|dma_addr
argument_list|)
expr_stmt|;
name|add_rcv
operator|->
name|rds
index|[
name|i
index|]
operator|.
name|std_bsize
operator|=
name|qla_host_to_le64
argument_list|(
name|MCLBYTES
argument_list|)
expr_stmt|;
name|add_rcv
operator|->
name|rds
index|[
name|i
index|]
operator|.
name|std_nentries
operator|=
name|qla_host_to_le32
argument_list|(
name|NUM_RX_DESCRIPTORS
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|qla_mbx_cmd
argument_list|(
name|ha
argument_list|,
operator|(
name|uint32_t
operator|*
operator|)
name|add_rcv
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|q80_rq_add_rcv_rings_t
argument_list|)
operator|>>
literal|2
operator|)
argument_list|,
name|ha
operator|->
name|hw
operator|.
name|mbox
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|q80_rsp_add_rcv_rings_t
argument_list|)
operator|>>
literal|2
operator|)
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: failed0\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|add_rcv_rsp
operator|=
operator|(
name|q80_rsp_add_rcv_rings_t
operator|*
operator|)
name|ha
operator|->
name|hw
operator|.
name|mbox
expr_stmt|;
name|err
operator|=
name|Q8_MBX_RSP_STATUS
argument_list|(
name|add_rcv_rsp
operator|->
name|regcnt_status
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: failed1 [0x%08x]\n"
argument_list|,
name|__func__
argument_list|,
name|err
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
for|for
control|(
name|i
operator|=
name|sds_idx
init|;
name|i
operator|<
name|hw
operator|->
name|num_sds_rings
condition|;
name|i
operator|++
control|)
block|{
name|hw
operator|->
name|sds
index|[
name|i
index|]
operator|.
name|sds_consumer
operator|=
name|add_rcv_rsp
operator|->
name|sds_cons
index|[
operator|(
name|i
operator|-
name|sds_idx
operator|)
index|]
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
name|sds_idx
init|;
name|i
operator|<
name|hw
operator|->
name|num_rds_rings
condition|;
name|i
operator|++
control|)
block|{
name|hw
operator|->
name|rds
index|[
name|i
index|]
operator|.
name|prod_std
operator|=
name|add_rcv_rsp
operator|->
name|rds
index|[
operator|(
name|i
operator|-
name|sds_idx
operator|)
index|]
operator|.
name|prod_std
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Name: qla_del_rcv_cntxt  * Function: Destroys the Receive Context.  */
end_comment

begin_function
specifier|static
name|void
name|qla_del_rcv_cntxt
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|device_t
name|dev
init|=
name|ha
operator|->
name|pci_dev
decl_stmt|;
name|q80_rcv_cntxt_destroy_t
modifier|*
name|rcntxt
decl_stmt|;
name|q80_rcv_cntxt_destroy_rsp_t
modifier|*
name|rcntxt_rsp
decl_stmt|;
name|uint32_t
name|err
decl_stmt|;
name|uint8_t
name|bcast_mac
index|[
literal|6
index|]
decl_stmt|;
if|if
condition|(
operator|!
name|ha
operator|->
name|hw
operator|.
name|flags
operator|.
name|init_rx_cnxt
condition|)
return|return;
if|if
condition|(
name|qla_hw_del_all_mcast
argument_list|(
name|ha
argument_list|)
condition|)
return|return;
if|if
condition|(
name|ha
operator|->
name|hw
operator|.
name|flags
operator|.
name|bcast_mac
condition|)
block|{
name|bcast_mac
index|[
literal|0
index|]
operator|=
literal|0xFF
expr_stmt|;
name|bcast_mac
index|[
literal|1
index|]
operator|=
literal|0xFF
expr_stmt|;
name|bcast_mac
index|[
literal|2
index|]
operator|=
literal|0xFF
expr_stmt|;
name|bcast_mac
index|[
literal|3
index|]
operator|=
literal|0xFF
expr_stmt|;
name|bcast_mac
index|[
literal|4
index|]
operator|=
literal|0xFF
expr_stmt|;
name|bcast_mac
index|[
literal|5
index|]
operator|=
literal|0xFF
expr_stmt|;
if|if
condition|(
name|qla_config_mac_addr
argument_list|(
name|ha
argument_list|,
name|bcast_mac
argument_list|,
literal|0
argument_list|)
condition|)
return|return;
name|ha
operator|->
name|hw
operator|.
name|flags
operator|.
name|bcast_mac
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|ha
operator|->
name|hw
operator|.
name|flags
operator|.
name|unicast_mac
condition|)
block|{
if|if
condition|(
name|qla_config_mac_addr
argument_list|(
name|ha
argument_list|,
name|ha
operator|->
name|hw
operator|.
name|mac_addr
argument_list|,
literal|0
argument_list|)
condition|)
return|return;
name|ha
operator|->
name|hw
operator|.
name|flags
operator|.
name|unicast_mac
operator|=
literal|0
expr_stmt|;
block|}
name|rcntxt
operator|=
operator|(
name|q80_rcv_cntxt_destroy_t
operator|*
operator|)
name|ha
operator|->
name|hw
operator|.
name|mbox
expr_stmt|;
name|bzero
argument_list|(
name|rcntxt
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|q80_rcv_cntxt_destroy_t
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|rcntxt
operator|->
name|opcode
operator|=
name|Q8_MBX_DESTROY_RX_CNTXT
expr_stmt|;
name|rcntxt
operator|->
name|count_version
operator|=
operator|(
sizeof|sizeof
argument_list|(
name|q80_rcv_cntxt_destroy_t
argument_list|)
operator|>>
literal|2
operator|)
expr_stmt|;
name|rcntxt
operator|->
name|count_version
operator||=
name|Q8_MBX_CMD_VERSION
expr_stmt|;
name|rcntxt
operator|->
name|cntxt_id
operator|=
name|ha
operator|->
name|hw
operator|.
name|rcv_cntxt_id
expr_stmt|;
if|if
condition|(
name|qla_mbx_cmd
argument_list|(
name|ha
argument_list|,
operator|(
name|uint32_t
operator|*
operator|)
name|rcntxt
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|q80_rcv_cntxt_destroy_t
argument_list|)
operator|>>
literal|2
operator|)
argument_list|,
name|ha
operator|->
name|hw
operator|.
name|mbox
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|q80_rcv_cntxt_destroy_rsp_t
argument_list|)
operator|>>
literal|2
operator|)
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: failed0\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return;
block|}
name|rcntxt_rsp
operator|=
operator|(
name|q80_rcv_cntxt_destroy_rsp_t
operator|*
operator|)
name|ha
operator|->
name|hw
operator|.
name|mbox
expr_stmt|;
name|err
operator|=
name|Q8_MBX_RSP_STATUS
argument_list|(
name|rcntxt_rsp
operator|->
name|regcnt_status
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: failed1 [0x%08x]\n"
argument_list|,
name|__func__
argument_list|,
name|err
argument_list|)
expr_stmt|;
block|}
name|ha
operator|->
name|hw
operator|.
name|flags
operator|.
name|init_rx_cnxt
operator|=
literal|0
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*  * Name: qla_init_xmt_cntxt  * Function: Creates the Transmit Context.  */
end_comment

begin_function
specifier|static
name|int
name|qla_init_xmt_cntxt_i
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint32_t
name|txr_idx
parameter_list|)
block|{
name|device_t
name|dev
decl_stmt|;
name|qla_hw_t
modifier|*
name|hw
init|=
operator|&
name|ha
operator|->
name|hw
decl_stmt|;
name|q80_rq_tx_cntxt_t
modifier|*
name|tcntxt
decl_stmt|;
name|q80_rsp_tx_cntxt_t
modifier|*
name|tcntxt_rsp
decl_stmt|;
name|uint32_t
name|err
decl_stmt|;
name|qla_hw_tx_cntxt_t
modifier|*
name|hw_tx_cntxt
decl_stmt|;
name|hw_tx_cntxt
operator|=
operator|&
name|hw
operator|->
name|tx_cntxt
index|[
name|txr_idx
index|]
expr_stmt|;
name|dev
operator|=
name|ha
operator|->
name|pci_dev
expr_stmt|;
comment|/* 	 * Create Transmit Context 	 */
name|tcntxt
operator|=
operator|(
name|q80_rq_tx_cntxt_t
operator|*
operator|)
name|ha
operator|->
name|hw
operator|.
name|mbox
expr_stmt|;
name|bzero
argument_list|(
name|tcntxt
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|q80_rq_tx_cntxt_t
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|tcntxt
operator|->
name|opcode
operator|=
name|Q8_MBX_CREATE_TX_CNTXT
expr_stmt|;
name|tcntxt
operator|->
name|count_version
operator|=
operator|(
sizeof|sizeof
argument_list|(
name|q80_rq_tx_cntxt_t
argument_list|)
operator|>>
literal|2
operator|)
expr_stmt|;
name|tcntxt
operator|->
name|count_version
operator||=
name|Q8_MBX_CMD_VERSION
expr_stmt|;
name|tcntxt
operator|->
name|cap0
operator|=
name|Q8_TX_CNTXT_CAP0_BASEFW
operator||
name|Q8_TX_CNTXT_CAP0_LSO
expr_stmt|;
name|tcntxt
operator|->
name|ntx_rings
operator|=
literal|1
expr_stmt|;
name|tcntxt
operator|->
name|tx_ring
index|[
literal|0
index|]
operator|.
name|paddr
operator|=
name|qla_host_to_le64
argument_list|(
name|hw_tx_cntxt
operator|->
name|tx_ring_paddr
argument_list|)
expr_stmt|;
name|tcntxt
operator|->
name|tx_ring
index|[
literal|0
index|]
operator|.
name|tx_consumer
operator|=
name|qla_host_to_le64
argument_list|(
name|hw_tx_cntxt
operator|->
name|tx_cons_paddr
argument_list|)
expr_stmt|;
name|tcntxt
operator|->
name|tx_ring
index|[
literal|0
index|]
operator|.
name|nentries
operator|=
name|qla_host_to_le16
argument_list|(
name|NUM_TX_DESCRIPTORS
argument_list|)
expr_stmt|;
name|tcntxt
operator|->
name|tx_ring
index|[
literal|0
index|]
operator|.
name|intr_id
operator|=
name|qla_host_to_le16
argument_list|(
name|hw
operator|->
name|intr_id
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|tcntxt
operator|->
name|tx_ring
index|[
literal|0
index|]
operator|.
name|intr_src_bit
operator|=
name|qla_host_to_le16
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|hw_tx_cntxt
operator|->
name|txr_free
operator|=
name|NUM_TX_DESCRIPTORS
expr_stmt|;
name|hw_tx_cntxt
operator|->
name|txr_next
operator|=
name|hw_tx_cntxt
operator|->
name|txr_comp
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|qla_mbx_cmd
argument_list|(
name|ha
argument_list|,
operator|(
name|uint32_t
operator|*
operator|)
name|tcntxt
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|q80_rq_tx_cntxt_t
argument_list|)
operator|>>
literal|2
operator|)
argument_list|,
name|ha
operator|->
name|hw
operator|.
name|mbox
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|q80_rsp_tx_cntxt_t
argument_list|)
operator|>>
literal|2
operator|)
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: failed0\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|tcntxt_rsp
operator|=
operator|(
name|q80_rsp_tx_cntxt_t
operator|*
operator|)
name|ha
operator|->
name|hw
operator|.
name|mbox
expr_stmt|;
name|err
operator|=
name|Q8_MBX_RSP_STATUS
argument_list|(
name|tcntxt_rsp
operator|->
name|regcnt_status
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: failed1 [0x%08x]\n"
argument_list|,
name|__func__
argument_list|,
name|err
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|hw_tx_cntxt
operator|->
name|tx_prod_reg
operator|=
name|tcntxt_rsp
operator|->
name|tx_ring
index|[
literal|0
index|]
operator|.
name|prod_index
expr_stmt|;
name|hw_tx_cntxt
operator|->
name|tx_cntxt_id
operator|=
name|tcntxt_rsp
operator|->
name|tx_ring
index|[
literal|0
index|]
operator|.
name|cntxt_id
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Name: qla_del_xmt_cntxt  * Function: Destroys the Transmit Context.  */
end_comment

begin_function
specifier|static
name|int
name|qla_del_xmt_cntxt_i
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint32_t
name|txr_idx
parameter_list|)
block|{
name|device_t
name|dev
init|=
name|ha
operator|->
name|pci_dev
decl_stmt|;
name|q80_tx_cntxt_destroy_t
modifier|*
name|tcntxt
decl_stmt|;
name|q80_tx_cntxt_destroy_rsp_t
modifier|*
name|tcntxt_rsp
decl_stmt|;
name|uint32_t
name|err
decl_stmt|;
name|tcntxt
operator|=
operator|(
name|q80_tx_cntxt_destroy_t
operator|*
operator|)
name|ha
operator|->
name|hw
operator|.
name|mbox
expr_stmt|;
name|bzero
argument_list|(
name|tcntxt
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|q80_tx_cntxt_destroy_t
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|tcntxt
operator|->
name|opcode
operator|=
name|Q8_MBX_DESTROY_TX_CNTXT
expr_stmt|;
name|tcntxt
operator|->
name|count_version
operator|=
operator|(
sizeof|sizeof
argument_list|(
name|q80_tx_cntxt_destroy_t
argument_list|)
operator|>>
literal|2
operator|)
expr_stmt|;
name|tcntxt
operator|->
name|count_version
operator||=
name|Q8_MBX_CMD_VERSION
expr_stmt|;
name|tcntxt
operator|->
name|cntxt_id
operator|=
name|ha
operator|->
name|hw
operator|.
name|tx_cntxt
index|[
name|txr_idx
index|]
operator|.
name|tx_cntxt_id
expr_stmt|;
if|if
condition|(
name|qla_mbx_cmd
argument_list|(
name|ha
argument_list|,
operator|(
name|uint32_t
operator|*
operator|)
name|tcntxt
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|q80_tx_cntxt_destroy_t
argument_list|)
operator|>>
literal|2
operator|)
argument_list|,
name|ha
operator|->
name|hw
operator|.
name|mbox
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|q80_tx_cntxt_destroy_rsp_t
argument_list|)
operator|>>
literal|2
operator|)
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: failed0\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|tcntxt_rsp
operator|=
operator|(
name|q80_tx_cntxt_destroy_rsp_t
operator|*
operator|)
name|ha
operator|->
name|hw
operator|.
name|mbox
expr_stmt|;
name|err
operator|=
name|Q8_MBX_RSP_STATUS
argument_list|(
name|tcntxt_rsp
operator|->
name|regcnt_status
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: failed1 [0x%08x]\n"
argument_list|,
name|__func__
argument_list|,
name|err
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|qla_del_xmt_cntxt
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|uint32_t
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|ha
operator|->
name|hw
operator|.
name|flags
operator|.
name|init_tx_cnxt
condition|)
return|return;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|hw
operator|.
name|num_tx_rings
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|qla_del_xmt_cntxt_i
argument_list|(
name|ha
argument_list|,
name|i
argument_list|)
condition|)
break|break;
block|}
name|ha
operator|->
name|hw
operator|.
name|flags
operator|.
name|init_tx_cnxt
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|qla_init_xmt_cntxt
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|uint32_t
name|i
decl_stmt|,
name|j
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|hw
operator|.
name|num_tx_rings
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|qla_init_xmt_cntxt_i
argument_list|(
name|ha
argument_list|,
name|i
argument_list|)
operator|!=
literal|0
condition|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|i
condition|;
name|j
operator|++
control|)
name|qla_del_xmt_cntxt_i
argument_list|(
name|ha
argument_list|,
name|j
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
name|ha
operator|->
name|hw
operator|.
name|flags
operator|.
name|init_tx_cnxt
operator|=
literal|1
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qla_hw_add_all_mcast
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|nmcast
decl_stmt|;
name|nmcast
operator|=
name|ha
operator|->
name|hw
operator|.
name|nmcast
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|(
operator|(
name|i
operator|<
name|Q8_MAX_NUM_MULTICAST_ADDRS
operator|)
operator|&&
name|nmcast
operator|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|ha
operator|->
name|hw
operator|.
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|0
index|]
operator|!=
literal|0
operator|)
operator|||
operator|(
name|ha
operator|->
name|hw
operator|.
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|1
index|]
operator|!=
literal|0
operator|)
operator|||
operator|(
name|ha
operator|->
name|hw
operator|.
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|2
index|]
operator|!=
literal|0
operator|)
operator|||
operator|(
name|ha
operator|->
name|hw
operator|.
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|3
index|]
operator|!=
literal|0
operator|)
operator|||
operator|(
name|ha
operator|->
name|hw
operator|.
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|4
index|]
operator|!=
literal|0
operator|)
operator|||
operator|(
name|ha
operator|->
name|hw
operator|.
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|5
index|]
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|qla_config_mac_addr
argument_list|(
name|ha
argument_list|,
name|ha
operator|->
name|hw
operator|.
name|mcast
index|[
name|i
index|]
operator|.
name|addr
argument_list|,
literal|1
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"%s: failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|nmcast
operator|--
expr_stmt|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qla_hw_del_all_mcast
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|nmcast
decl_stmt|;
name|nmcast
operator|=
name|ha
operator|->
name|hw
operator|.
name|nmcast
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|(
operator|(
name|i
operator|<
name|Q8_MAX_NUM_MULTICAST_ADDRS
operator|)
operator|&&
name|nmcast
operator|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|ha
operator|->
name|hw
operator|.
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|0
index|]
operator|!=
literal|0
operator|)
operator|||
operator|(
name|ha
operator|->
name|hw
operator|.
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|1
index|]
operator|!=
literal|0
operator|)
operator|||
operator|(
name|ha
operator|->
name|hw
operator|.
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|2
index|]
operator|!=
literal|0
operator|)
operator|||
operator|(
name|ha
operator|->
name|hw
operator|.
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|3
index|]
operator|!=
literal|0
operator|)
operator|||
operator|(
name|ha
operator|->
name|hw
operator|.
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|4
index|]
operator|!=
literal|0
operator|)
operator|||
operator|(
name|ha
operator|->
name|hw
operator|.
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|5
index|]
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|qla_config_mac_addr
argument_list|(
name|ha
argument_list|,
name|ha
operator|->
name|hw
operator|.
name|mcast
index|[
name|i
index|]
operator|.
name|addr
argument_list|,
literal|0
argument_list|)
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|nmcast
operator|--
expr_stmt|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qla_hw_add_mcast
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint8_t
modifier|*
name|mta
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|Q8_MAX_NUM_MULTICAST_ADDRS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|QL_MAC_CMP
argument_list|(
name|ha
operator|->
name|hw
operator|.
name|mcast
index|[
name|i
index|]
operator|.
name|addr
argument_list|,
name|mta
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|0
return|;
comment|/* its been already added */
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|Q8_MAX_NUM_MULTICAST_ADDRS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|ha
operator|->
name|hw
operator|.
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|0
index|]
operator|==
literal|0
operator|)
operator|&&
operator|(
name|ha
operator|->
name|hw
operator|.
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|1
index|]
operator|==
literal|0
operator|)
operator|&&
operator|(
name|ha
operator|->
name|hw
operator|.
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|2
index|]
operator|==
literal|0
operator|)
operator|&&
operator|(
name|ha
operator|->
name|hw
operator|.
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|3
index|]
operator|==
literal|0
operator|)
operator|&&
operator|(
name|ha
operator|->
name|hw
operator|.
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|4
index|]
operator|==
literal|0
operator|)
operator|&&
operator|(
name|ha
operator|->
name|hw
operator|.
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|5
index|]
operator|==
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|qla_config_mac_addr
argument_list|(
name|ha
argument_list|,
name|mta
argument_list|,
literal|1
argument_list|)
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|bcopy
argument_list|(
name|mta
argument_list|,
name|ha
operator|->
name|hw
operator|.
name|mcast
index|[
name|i
index|]
operator|.
name|addr
argument_list|,
name|Q8_MAC_ADDR_LEN
argument_list|)
expr_stmt|;
name|ha
operator|->
name|hw
operator|.
name|nmcast
operator|++
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qla_hw_del_mcast
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint8_t
modifier|*
name|mta
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|Q8_MAX_NUM_MULTICAST_ADDRS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|QL_MAC_CMP
argument_list|(
name|ha
operator|->
name|hw
operator|.
name|mcast
index|[
name|i
index|]
operator|.
name|addr
argument_list|,
name|mta
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|qla_config_mac_addr
argument_list|(
name|ha
argument_list|,
name|mta
argument_list|,
literal|0
argument_list|)
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|ha
operator|->
name|hw
operator|.
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|ha
operator|->
name|hw
operator|.
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|ha
operator|->
name|hw
operator|.
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|ha
operator|->
name|hw
operator|.
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|ha
operator|->
name|hw
operator|.
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|4
index|]
operator|=
literal|0
expr_stmt|;
name|ha
operator|->
name|hw
operator|.
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|5
index|]
operator|=
literal|0
expr_stmt|;
name|ha
operator|->
name|hw
operator|.
name|nmcast
operator|--
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Name: ql_hw_set_multi  * Function: Sets the Multicast Addresses provided the host O.S into the  *	hardware (for the given interface)  */
end_comment

begin_function
name|int
name|ql_hw_set_multi
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint8_t
modifier|*
name|mcast
parameter_list|,
name|uint32_t
name|mcnt
parameter_list|,
name|uint32_t
name|add_mac
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|uint8_t
modifier|*
name|mta
init|=
name|mcast
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|mcnt
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|add_mac
condition|)
block|{
name|ret
operator|=
name|qla_hw_add_mcast
argument_list|(
name|ha
argument_list|,
name|mta
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
break|break;
block|}
else|else
block|{
name|ret
operator|=
name|qla_hw_del_mcast
argument_list|(
name|ha
argument_list|,
name|mta
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
break|break;
block|}
name|mta
operator|+=
name|Q8_MAC_ADDR_LEN
expr_stmt|;
block|}
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Name: qla_hw_tx_done_locked  * Function: Handle Transmit Completions  */
end_comment

begin_function
specifier|static
name|void
name|qla_hw_tx_done_locked
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint32_t
name|txr_idx
parameter_list|)
block|{
name|qla_tx_buf_t
modifier|*
name|txb
decl_stmt|;
name|qla_hw_t
modifier|*
name|hw
init|=
operator|&
name|ha
operator|->
name|hw
decl_stmt|;
name|uint32_t
name|comp_idx
decl_stmt|,
name|comp_count
init|=
literal|0
decl_stmt|;
name|qla_hw_tx_cntxt_t
modifier|*
name|hw_tx_cntxt
decl_stmt|;
name|hw_tx_cntxt
operator|=
operator|&
name|hw
operator|->
name|tx_cntxt
index|[
name|txr_idx
index|]
expr_stmt|;
comment|/* retrieve index of last entry in tx ring completed */
name|comp_idx
operator|=
name|qla_le32_to_host
argument_list|(
operator|*
operator|(
name|hw_tx_cntxt
operator|->
name|tx_cons
operator|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|comp_idx
operator|!=
name|hw_tx_cntxt
operator|->
name|txr_comp
condition|)
block|{
name|txb
operator|=
operator|&
name|ha
operator|->
name|tx_ring
index|[
name|txr_idx
index|]
operator|.
name|tx_buf
index|[
name|hw_tx_cntxt
operator|->
name|txr_comp
index|]
expr_stmt|;
name|hw_tx_cntxt
operator|->
name|txr_comp
operator|++
expr_stmt|;
if|if
condition|(
name|hw_tx_cntxt
operator|->
name|txr_comp
operator|==
name|NUM_TX_DESCRIPTORS
condition|)
name|hw_tx_cntxt
operator|->
name|txr_comp
operator|=
literal|0
expr_stmt|;
name|comp_count
operator|++
expr_stmt|;
if|if
condition|(
name|txb
operator|->
name|m_head
condition|)
block|{
name|if_inc_counter
argument_list|(
name|ha
operator|->
name|ifp
argument_list|,
name|IFCOUNTER_OPACKETS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|ha
operator|->
name|tx_tag
argument_list|,
name|txb
operator|->
name|map
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|ha
operator|->
name|tx_tag
argument_list|,
name|txb
operator|->
name|map
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|txb
operator|->
name|m_head
argument_list|)
expr_stmt|;
name|txb
operator|->
name|m_head
operator|=
name|NULL
expr_stmt|;
block|}
block|}
name|hw_tx_cntxt
operator|->
name|txr_free
operator|+=
name|comp_count
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*  * Name: ql_hw_tx_done  * Function: Handle Transmit Completions  */
end_comment

begin_function
name|void
name|ql_hw_tx_done
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|uint32_t
name|flag
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|mtx_trylock
argument_list|(
operator|&
name|ha
operator|->
name|tx_lock
argument_list|)
condition|)
block|{
name|QL_DPRINT8
argument_list|(
name|ha
argument_list|,
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s: !mtx_trylock(&ha->tx_lock)\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|hw
operator|.
name|num_tx_rings
condition|;
name|i
operator|++
control|)
block|{
name|qla_hw_tx_done_locked
argument_list|(
name|ha
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|ha
operator|->
name|hw
operator|.
name|tx_cntxt
index|[
name|i
index|]
operator|.
name|txr_free
operator|<=
operator|(
name|NUM_TX_DESCRIPTORS
operator|>>
literal|1
operator|)
condition|)
name|flag
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|flag
condition|)
name|ha
operator|->
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_OACTIVE
expr_stmt|;
name|QLA_TX_UNLOCK
argument_list|(
name|ha
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|void
name|ql_update_link_state
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|uint32_t
name|link_state
decl_stmt|;
name|uint32_t
name|prev_link_state
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|ha
operator|->
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
condition|)
block|{
name|ha
operator|->
name|hw
operator|.
name|link_up
operator|=
literal|0
expr_stmt|;
return|return;
block|}
name|link_state
operator|=
name|READ_REG32
argument_list|(
name|ha
argument_list|,
name|Q8_LINK_STATE
argument_list|)
expr_stmt|;
name|prev_link_state
operator|=
name|ha
operator|->
name|hw
operator|.
name|link_up
expr_stmt|;
if|if
condition|(
name|ha
operator|->
name|pci_func
operator|==
literal|0
condition|)
name|ha
operator|->
name|hw
operator|.
name|link_up
operator|=
operator|(
operator|(
operator|(
name|link_state
operator|&
literal|0xF
operator|)
operator|==
literal|1
operator|)
condition|?
literal|1
else|:
literal|0
operator|)
expr_stmt|;
else|else
name|ha
operator|->
name|hw
operator|.
name|link_up
operator|=
operator|(
operator|(
operator|(
operator|(
name|link_state
operator|>>
literal|4
operator|)
operator|&
literal|0xF
operator|)
operator|==
literal|1
operator|)
condition|?
literal|1
else|:
literal|0
operator|)
expr_stmt|;
if|if
condition|(
name|prev_link_state
operator|!=
name|ha
operator|->
name|hw
operator|.
name|link_up
condition|)
block|{
if|if
condition|(
name|ha
operator|->
name|hw
operator|.
name|link_up
condition|)
block|{
name|if_link_state_change
argument_list|(
name|ha
operator|->
name|ifp
argument_list|,
name|LINK_STATE_UP
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|if_link_state_change
argument_list|(
name|ha
operator|->
name|ifp
argument_list|,
name|LINK_STATE_DOWN
argument_list|)
expr_stmt|;
block|}
block|}
return|return;
block|}
end_function

begin_function
name|void
name|ql_hw_stop_rcv
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|done
decl_stmt|,
name|count
init|=
literal|100
decl_stmt|;
while|while
condition|(
name|count
operator|--
condition|)
block|{
name|done
operator|=
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|hw
operator|.
name|num_sds_rings
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ha
operator|->
name|hw
operator|.
name|sds
index|[
name|i
index|]
operator|.
name|rcv_active
condition|)
name|done
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|done
condition|)
break|break;
else|else
name|qla_mdelay
argument_list|(
name|__func__
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|count
condition|)
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"%s: Counter expired.\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|int
name|ql_hw_check_health
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|;
name|ha
operator|->
name|hw
operator|.
name|health_count
operator|++
expr_stmt|;
if|if
condition|(
name|ha
operator|->
name|hw
operator|.
name|health_count
operator|<
literal|1000
condition|)
return|return
literal|0
return|;
name|ha
operator|->
name|hw
operator|.
name|health_count
operator|=
literal|0
expr_stmt|;
name|val
operator|=
name|READ_REG32
argument_list|(
name|ha
argument_list|,
name|Q8_ASIC_TEMPERATURE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|val
operator|&
literal|0xFFFF
operator|)
operator|==
literal|2
operator|)
operator|||
operator|(
operator|(
name|val
operator|&
literal|0xFFFF
operator|)
operator|==
literal|3
operator|)
operator|||
operator|(
name|QL_ERR_INJECT
argument_list|(
name|ha
argument_list|,
name|INJCT_TEMPERATURE_FAILURE
argument_list|)
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"%s: Temperature Alert [0x%08x]\n"
argument_list|,
name|__func__
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|val
operator|=
name|READ_REG32
argument_list|(
name|ha
argument_list|,
name|Q8_FIRMWARE_HEARTBEAT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|val
operator|!=
name|ha
operator|->
name|hw
operator|.
name|hbeat_value
operator|)
operator|&&
operator|(
operator|!
operator|(
name|QL_ERR_INJECT
argument_list|(
name|ha
argument_list|,
name|INJCT_TEMPERATURE_FAILURE
argument_list|)
operator|)
operator|)
condition|)
block|{
name|ha
operator|->
name|hw
operator|.
name|hbeat_value
operator|=
name|val
expr_stmt|;
return|return
literal|0
return|;
block|}
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"%s: Heartbeat Failue [0x%08x]\n"
argument_list|,
name|__func__
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qla_get_minidump_tmplt_size
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint32_t
modifier|*
name|size
parameter_list|)
block|{
name|uint32_t
name|err
decl_stmt|;
name|device_t
name|dev
init|=
name|ha
operator|->
name|pci_dev
decl_stmt|;
name|q80_config_md_templ_size_t
modifier|*
name|md_size
decl_stmt|;
name|q80_config_md_templ_size_rsp_t
modifier|*
name|md_size_rsp
decl_stmt|;
name|md_size
operator|=
operator|(
name|q80_config_md_templ_size_t
operator|*
operator|)
name|ha
operator|->
name|hw
operator|.
name|mbox
expr_stmt|;
name|bzero
argument_list|(
name|md_size
argument_list|,
sizeof|sizeof
argument_list|(
name|q80_config_md_templ_size_t
argument_list|)
argument_list|)
expr_stmt|;
name|md_size
operator|->
name|opcode
operator|=
name|Q8_MBX_GET_MINIDUMP_TMPLT_SIZE
expr_stmt|;
name|md_size
operator|->
name|count_version
operator|=
operator|(
sizeof|sizeof
argument_list|(
name|q80_config_md_templ_size_t
argument_list|)
operator|>>
literal|2
operator|)
expr_stmt|;
name|md_size
operator|->
name|count_version
operator||=
name|Q8_MBX_CMD_VERSION
expr_stmt|;
if|if
condition|(
name|qla_mbx_cmd
argument_list|(
name|ha
argument_list|,
operator|(
name|uint32_t
operator|*
operator|)
name|md_size
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|q80_config_md_templ_size_t
argument_list|)
operator|>>
literal|2
operator|)
argument_list|,
name|ha
operator|->
name|hw
operator|.
name|mbox
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|q80_config_md_templ_size_rsp_t
argument_list|)
operator|>>
literal|2
operator|)
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|md_size_rsp
operator|=
operator|(
name|q80_config_md_templ_size_rsp_t
operator|*
operator|)
name|ha
operator|->
name|hw
operator|.
name|mbox
expr_stmt|;
name|err
operator|=
name|Q8_MBX_RSP_STATUS
argument_list|(
name|md_size_rsp
operator|->
name|regcnt_status
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: failed [0x%08x]\n"
argument_list|,
name|__func__
argument_list|,
name|err
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
operator|*
name|size
operator|=
name|md_size_rsp
operator|->
name|templ_size
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qla_get_minidump_template
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|uint32_t
name|err
decl_stmt|;
name|device_t
name|dev
init|=
name|ha
operator|->
name|pci_dev
decl_stmt|;
name|q80_config_md_templ_cmd_t
modifier|*
name|md_templ
decl_stmt|;
name|q80_config_md_templ_cmd_rsp_t
modifier|*
name|md_templ_rsp
decl_stmt|;
name|md_templ
operator|=
operator|(
name|q80_config_md_templ_cmd_t
operator|*
operator|)
name|ha
operator|->
name|hw
operator|.
name|mbox
expr_stmt|;
name|bzero
argument_list|(
name|md_templ
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|q80_config_md_templ_cmd_t
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|md_templ
operator|->
name|opcode
operator|=
name|Q8_MBX_GET_MINIDUMP_TMPLT
expr_stmt|;
name|md_templ
operator|->
name|count_version
operator|=
operator|(
sizeof|sizeof
argument_list|(
name|q80_config_md_templ_cmd_t
argument_list|)
operator|>>
literal|2
operator|)
expr_stmt|;
name|md_templ
operator|->
name|count_version
operator||=
name|Q8_MBX_CMD_VERSION
expr_stmt|;
name|md_templ
operator|->
name|buf_addr
operator|=
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|minidump
operator|.
name|dma_addr
expr_stmt|;
name|md_templ
operator|->
name|buff_size
operator|=
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|minidump
operator|.
name|size
expr_stmt|;
if|if
condition|(
name|qla_mbx_cmd
argument_list|(
name|ha
argument_list|,
operator|(
name|uint32_t
operator|*
operator|)
name|md_templ
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|q80_config_md_templ_cmd_t
argument_list|)
operator|>>
literal|2
operator|)
argument_list|,
name|ha
operator|->
name|hw
operator|.
name|mbox
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|q80_config_md_templ_cmd_rsp_t
argument_list|)
operator|>>
literal|2
operator|)
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|md_templ_rsp
operator|=
operator|(
name|q80_config_md_templ_cmd_rsp_t
operator|*
operator|)
name|ha
operator|->
name|hw
operator|.
name|mbox
expr_stmt|;
name|err
operator|=
name|Q8_MBX_RSP_STATUS
argument_list|(
name|md_templ_rsp
operator|->
name|regcnt_status
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: failed [0x%08x]\n"
argument_list|,
name|__func__
argument_list|,
name|err
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qla_minidump_init
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|uint32_t
name|template_size
init|=
literal|0
decl_stmt|;
name|device_t
name|dev
init|=
name|ha
operator|->
name|pci_dev
decl_stmt|;
comment|/* 	 * Get Minidump Template Size  	 */
name|ret
operator|=
name|qla_get_minidump_tmplt_size
argument_list|(
name|ha
argument_list|,
operator|&
name|template_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|||
operator|(
name|template_size
operator|==
literal|0
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: failed [%d, %d]\n"
argument_list|,
name|__func__
argument_list|,
name|ret
argument_list|,
name|template_size
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* 	 * Allocate Memory for Minidump Template 	 */
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|minidump
operator|.
name|alignment
operator|=
literal|8
expr_stmt|;
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|minidump
operator|.
name|size
operator|=
name|template_size
expr_stmt|;
if|if
condition|(
name|ql_alloc_dmabuf
argument_list|(
name|ha
argument_list|,
operator|&
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|minidump
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: minidump dma alloc failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|flags
operator|.
name|minidump
operator|=
literal|1
expr_stmt|;
comment|/* 	 * Retrieve Minidump Template 	 */
name|ret
operator|=
name|qla_get_minidump_template
argument_list|(
name|ha
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|qla_minidump_free
argument_list|(
name|ha
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ha
operator|->
name|hw
operator|.
name|mdump_init
operator|=
literal|1
expr_stmt|;
block|}
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|qla_minidump_free
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|ha
operator|->
name|hw
operator|.
name|mdump_init
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|flags
operator|.
name|minidump
condition|)
block|{
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|flags
operator|.
name|minidump
operator|=
literal|0
expr_stmt|;
name|ql_free_dmabuf
argument_list|(
name|ha
argument_list|,
operator|&
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|minidump
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
name|void
name|ql_minidump
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|uint32_t
name|delay
init|=
literal|6000
decl_stmt|;
if|if
condition|(
operator|!
name|ha
operator|->
name|hw
operator|.
name|mdump_init
condition|)
return|return;
if|if
condition|(
operator|!
name|ha
operator|->
name|hw
operator|.
name|mdump_active
condition|)
return|return;
if|if
condition|(
name|ha
operator|->
name|hw
operator|.
name|mdump_active
operator|==
literal|1
condition|)
block|{
name|ha
operator|->
name|hw
operator|.
name|mdump_start_seq_index
operator|=
name|ql_stop_sequence
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|ha
operator|->
name|hw
operator|.
name|mdump_start
operator|=
literal|1
expr_stmt|;
block|}
while|while
condition|(
name|delay
operator|--
operator|&&
name|ha
operator|->
name|hw
operator|.
name|mdump_active
condition|)
block|{
name|qla_mdelay
argument_list|(
name|__func__
argument_list|,
literal|100
argument_list|)
expr_stmt|;
block|}
name|ha
operator|->
name|hw
operator|.
name|mdump_start
operator|=
literal|0
expr_stmt|;
name|ql_start_sequence
argument_list|(
name|ha
argument_list|,
name|ha
operator|->
name|hw
operator|.
name|mdump_start_seq_index
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

end_unit


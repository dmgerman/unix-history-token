begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * DDK library for Cronyx-Tau adapters.  *  * Copyright (C) 1998-1999 Cronyx Engineering.  * Author: Alexander Kvitchenko,<aak@cronyx.ru>  *  * Copyright (C) 1999-2003 Cronyx Engineering.  * Author: Roman Kurakin,<rik@cronyx.ru>  *  * This source is derived from  * Diagnose utility for Cronyx-Tau adapter:  * by Serge Vakulenko,<vak@cronyx.ru>  *  * This software is distributed with NO WARRANTIES, not even the implied  * warranties for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  *  * Authors grant any other persons or organisations permission to use  * or modify this software as long as this message is kept with the software,  * all derivative works or modified versions.  *  * Cronyx Id: ctddk.c,v 1.1.2.3 2003/11/14 16:55:36 rik Exp $  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/cx/machdep.h>
end_include

begin_include
include|#
directive|include
file|<dev/ctau/ctddk.h>
end_include

begin_include
include|#
directive|include
file|<dev/ctau/ctaureg.h>
end_include

begin_include
include|#
directive|include
file|<dev/ctau/hdc64570.h>
end_include

begin_include
include|#
directive|include
file|<dev/ctau/ds2153.h>
end_include

begin_include
include|#
directive|include
file|<dev/ctau/am8530.h>
end_include

begin_include
include|#
directive|include
file|<dev/ctau/lxt318.h>
end_include

begin_include
include|#
directive|include
file|<dev/cx/cronyxfw.h>
end_include

begin_include
include|#
directive|include
file|<dev/ctau/ctaufw.h>
end_include

begin_include
include|#
directive|include
file|<dev/ctau/ctau2fw.h>
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|CT_DDK_NO_G703
end_ifndef

begin_include
include|#
directive|include
file|<dev/ctau/ctaug7fw.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|CT_DDK_NO_E1
end_ifndef

begin_include
include|#
directive|include
file|<dev/ctau/ctaue1fw.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|void
name|ct_hdlc_interrupt
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|,
name|int
name|imvr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ct_e1_interrupt
parameter_list|(
name|ct_board_t
modifier|*
name|b
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ct_scc_interrupt
parameter_list|(
name|ct_board_t
modifier|*
name|b
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ct_e1timer_interrupt
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|short
name|porttab
index|[]
init|=
block|{
comment|/* standard base port set */
literal|0x200
block|,
literal|0x220
block|,
literal|0x240
block|,
literal|0x260
block|,
literal|0x280
block|,
literal|0x2a0
block|,
literal|0x2c0
block|,
literal|0x2e0
block|,
literal|0x300
block|,
literal|0x320
block|,
literal|0x340
block|,
literal|0x360
block|,
literal|0x380
block|,
literal|0x3a0
block|,
literal|0x3c0
block|,
literal|0x3e0
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|ct_find
parameter_list|(
name|port_t
modifier|*
name|board_ports
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|n
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|n
operator|=
literal|0
init|;
name|porttab
index|[
name|i
index|]
operator|&&
name|n
operator|<
name|NBRD
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|ct_probe_board
argument_list|(
name|porttab
index|[
name|i
index|]
argument_list|,
operator|-
literal|1
argument_list|,
operator|-
literal|1
argument_list|)
condition|)
name|board_ports
index|[
name|n
operator|++
index|]
operator|=
name|porttab
index|[
name|i
index|]
expr_stmt|;
return|return
name|n
return|;
block|}
end_function

begin_function
name|int
name|ct_open_board
parameter_list|(
name|ct_board_t
modifier|*
name|b
parameter_list|,
name|int
name|num
parameter_list|,
name|port_t
name|port
parameter_list|,
name|int
name|irq
parameter_list|,
name|int
name|dma
parameter_list|)
block|{
name|ct_chan_t
modifier|*
name|c
decl_stmt|;
specifier|const
name|unsigned
name|char
modifier|*
name|fw
decl_stmt|;
specifier|const
name|cr_dat_tst_t
modifier|*
name|ft
decl_stmt|;
name|long
name|flen
decl_stmt|;
if|if
condition|(
name|num
operator|>=
name|NBRD
operator|||
operator|!
name|ct_probe_board
argument_list|(
name|port
argument_list|,
name|irq
argument_list|,
name|dma
argument_list|)
condition|)
return|return
literal|0
return|;
comment|/* init callback pointers */
for|for
control|(
name|c
operator|=
name|b
operator|->
name|chan
init|;
name|c
operator|<
name|b
operator|->
name|chan
operator|+
name|NCHAN
condition|;
operator|++
name|c
control|)
block|{
name|c
operator|->
name|call_on_tx
operator|=
literal|0
expr_stmt|;
name|c
operator|->
name|call_on_rx
operator|=
literal|0
expr_stmt|;
name|c
operator|->
name|call_on_msig
operator|=
literal|0
expr_stmt|;
name|c
operator|->
name|call_on_scc
operator|=
literal|0
expr_stmt|;
name|c
operator|->
name|call_on_err
operator|=
literal|0
expr_stmt|;
block|}
comment|/* init DDK channel variables */
for|for
control|(
name|c
operator|=
name|b
operator|->
name|chan
init|;
name|c
operator|<
name|b
operator|->
name|chan
operator|+
name|NCHAN
condition|;
operator|++
name|c
control|)
block|{
name|c
operator|->
name|sccrx_empty
operator|=
name|c
operator|->
name|scctx_empty
operator|=
literal|1
expr_stmt|;
name|c
operator|->
name|sccrx_b
operator|=
name|c
operator|->
name|sccrx_e
operator|=
literal|0
expr_stmt|;
name|c
operator|->
name|scctx_b
operator|=
name|c
operator|->
name|scctx_e
operator|=
literal|0
expr_stmt|;
name|c
operator|->
name|e1_first_int
operator|=
literal|1
expr_stmt|;
block|}
comment|/* init board structure */
name|ct_init
argument_list|(
name|b
argument_list|,
name|num
argument_list|,
name|port
argument_list|,
name|irq
argument_list|,
name|dma
argument_list|,
name|ctau_fw_data
argument_list|,
name|ctau_fw_len
argument_list|,
name|ctau_fw_tvec
argument_list|,
name|ctau2_fw_data
argument_list|)
expr_stmt|;
comment|/* determine which firmware should be loaded */
name|fw
operator|=
name|ctau_fw_data
expr_stmt|;
name|flen
operator|=
name|ctau_fw_len
expr_stmt|;
name|ft
operator|=
name|ctau_fw_tvec
expr_stmt|;
switch|switch
condition|(
name|b
operator|->
name|type
condition|)
block|{
case|case
name|B_TAU2
case|:
case|case
name|B_TAU2_G703
case|:
case|case
name|B_TAU2_E1
case|:
case|case
name|B_TAU2_E1D
case|:
name|fw
operator|=
name|ctau2_fw_data
expr_stmt|;
name|flen
operator|=
literal|0
expr_stmt|;
name|ft
operator|=
literal|0
expr_stmt|;
break|break;
ifndef|#
directive|ifndef
name|CT_DDK_NO_G703
case|case
name|B_TAU_G703
case|:
name|fw
operator|=
name|ctaug703_fw_data
expr_stmt|;
name|flen
operator|=
name|ctaug703_fw_len
expr_stmt|;
name|ft
operator|=
name|ctaug703_fw_tvec
expr_stmt|;
break|break;
endif|#
directive|endif
ifndef|#
directive|ifndef
name|CT_DDK_NO_E1
case|case
name|B_TAU_E1
case|:
name|fw
operator|=
name|ctaue1_fw_data
expr_stmt|;
name|flen
operator|=
name|ctaue1_fw_len
expr_stmt|;
name|ft
operator|=
name|ctaue1_fw_tvec
expr_stmt|;
break|break;
endif|#
directive|endif
block|}
comment|/* Load firmware and set up board */
return|return
name|ct_setup_board
argument_list|(
name|b
argument_list|,
name|fw
argument_list|,
name|flen
argument_list|,
name|ft
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  * must be called on the exit  */
end_comment

begin_function
name|void
name|ct_close_board
parameter_list|(
name|ct_board_t
modifier|*
name|b
parameter_list|)
block|{
name|ct_setup_board
argument_list|(
name|b
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Reset the controller. */
name|outb
argument_list|(
name|BCR0
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Disable DMA channel. */
name|ct_disable_dma
argument_list|(
name|b
argument_list|)
expr_stmt|;
name|ct_led
argument_list|(
name|b
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ct_g703_rate
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|,
name|unsigned
name|long
name|rate
parameter_list|)
block|{
name|c
operator|->
name|gopt
operator|.
name|rate
operator|=
name|rate
expr_stmt|;
name|ct_setup_g703
argument_list|(
name|c
operator|->
name|board
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Set up baud rate.  */
end_comment

begin_function
specifier|static
name|void
name|ct_chan_baud
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|,
name|unsigned
name|long
name|baud
parameter_list|)
block|{
name|c
operator|->
name|baud
operator|=
name|baud
expr_stmt|;
if|if
condition|(
name|baud
condition|)
block|{
name|c
operator|->
name|hopt
operator|.
name|txs
operator|=
name|CLK_INT
expr_stmt|;
block|}
else|else
block|{
name|ct_set_dpll
argument_list|(
name|c
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|c
operator|->
name|hopt
operator|.
name|txs
operator|=
name|CLK_LINE
expr_stmt|;
block|}
name|ct_update_chan
argument_list|(
name|c
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ct_set_baud
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|,
name|unsigned
name|long
name|baud
parameter_list|)
block|{
name|unsigned
name|long
name|r
decl_stmt|;
if|if
condition|(
name|c
operator|->
name|mode
operator|==
name|M_E1
condition|)
return|return;
if|if
condition|(
name|c
operator|->
name|mode
operator|==
name|M_G703
condition|)
block|{
if|if
condition|(
name|baud
operator|>=
literal|2048000
condition|)
name|r
operator|=
literal|2048
expr_stmt|;
elseif|else
if|if
condition|(
name|baud
operator|>=
literal|1024000
condition|)
name|r
operator|=
literal|1024
expr_stmt|;
elseif|else
if|if
condition|(
name|baud
operator|>=
literal|512000
condition|)
name|r
operator|=
literal|512
expr_stmt|;
elseif|else
if|if
condition|(
name|baud
operator|>=
literal|256000
condition|)
name|r
operator|=
literal|256
expr_stmt|;
elseif|else
if|if
condition|(
name|baud
operator|>=
literal|128000
condition|)
name|r
operator|=
literal|128
expr_stmt|;
else|else
name|r
operator|=
literal|64
expr_stmt|;
name|ct_g703_rate
argument_list|(
name|c
argument_list|,
name|r
argument_list|)
expr_stmt|;
block|}
else|else
name|ct_chan_baud
argument_list|(
name|c
argument_list|,
name|baud
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Configure Tau/E1 board.  */
end_comment

begin_function
specifier|static
name|void
name|ct_e1_config
parameter_list|(
name|ct_board_t
modifier|*
name|b
parameter_list|,
name|unsigned
name|char
name|cfg
parameter_list|)
block|{
if|if
condition|(
name|cfg
operator|==
name|b
operator|->
name|opt
operator|.
name|cfg
condition|)
return|return;
if|if
condition|(
name|cfg
operator|==
name|CFG_B
condition|)
name|b
operator|->
name|chan
index|[
literal|1
index|]
operator|.
name|mode
operator|=
name|M_HDLC
expr_stmt|;
else|else
name|b
operator|->
name|chan
index|[
literal|1
index|]
operator|.
name|mode
operator|=
name|M_E1
expr_stmt|;
comment|/* Recovering synchronization */
if|if
condition|(
name|b
operator|->
name|opt
operator|.
name|cfg
operator|==
name|CFG_B
condition|)
block|{
name|ct_chan_baud
argument_list|(
name|b
operator|->
name|chan
operator|+
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ct_set_invtxc
argument_list|(
name|b
operator|->
name|chan
operator|+
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ct_set_invrxc
argument_list|(
name|b
operator|->
name|chan
operator|+
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ct_set_nrzi
argument_list|(
name|b
operator|->
name|chan
operator|+
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|b
operator|->
name|opt
operator|.
name|cfg
operator|=
name|cfg
expr_stmt|;
name|ct_setup_e1
argument_list|(
name|b
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Config Tau/G.703 board  */
end_comment

begin_function
specifier|static
name|void
name|ct_g703_config
parameter_list|(
name|ct_board_t
modifier|*
name|b
parameter_list|,
name|unsigned
name|char
name|cfg
parameter_list|)
block|{
if|if
condition|(
name|cfg
operator|==
name|b
operator|->
name|opt
operator|.
name|cfg
condition|)
return|return;
if|if
condition|(
name|cfg
operator|==
name|CFG_B
condition|)
name|b
operator|->
name|chan
index|[
literal|1
index|]
operator|.
name|mode
operator|=
name|M_HDLC
expr_stmt|;
else|else
name|b
operator|->
name|chan
index|[
literal|1
index|]
operator|.
name|mode
operator|=
name|M_G703
expr_stmt|;
comment|/* Recovering synchronization */
if|if
condition|(
name|b
operator|->
name|opt
operator|.
name|cfg
operator|==
name|CFG_B
condition|)
block|{
name|ct_chan_baud
argument_list|(
name|b
operator|->
name|chan
operator|+
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ct_set_invtxc
argument_list|(
name|b
operator|->
name|chan
operator|+
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ct_set_invrxc
argument_list|(
name|b
operator|->
name|chan
operator|+
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ct_set_nrzi
argument_list|(
name|b
operator|->
name|chan
operator|+
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|b
operator|->
name|opt
operator|.
name|cfg
operator|=
name|cfg
expr_stmt|;
name|ct_setup_g703
argument_list|(
name|b
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|ct_set_clk
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|,
name|int
name|clk
parameter_list|)
block|{
if|if
condition|(
name|c
operator|->
name|num
condition|)
name|c
operator|->
name|board
operator|->
name|opt
operator|.
name|clk1
operator|=
name|clk
expr_stmt|;
else|else
name|c
operator|->
name|board
operator|->
name|opt
operator|.
name|clk0
operator|=
name|clk
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|mode
operator|==
name|M_E1
condition|)
block|{
name|ct_setup_e1
argument_list|(
name|c
operator|->
name|board
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|c
operator|->
name|mode
operator|==
name|M_G703
condition|)
block|{
name|ct_setup_g703
argument_list|(
name|c
operator|->
name|board
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
else|else
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|int
name|ct_get_clk
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|)
block|{
return|return
name|c
operator|->
name|num
condition|?
name|c
operator|->
name|board
operator|->
name|opt
operator|.
name|clk1
else|:
name|c
operator|->
name|board
operator|->
name|opt
operator|.
name|clk0
return|;
block|}
end_function

begin_function
name|int
name|ct_set_ts
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|,
name|unsigned
name|long
name|ts
parameter_list|)
block|{
if|if
condition|(
operator|!
operator|(
name|c
operator|->
name|mode
operator|==
name|M_E1
operator|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|c
operator|->
name|num
condition|)
name|c
operator|->
name|board
operator|->
name|opt
operator|.
name|s1
operator|=
name|ts
expr_stmt|;
else|else
name|c
operator|->
name|board
operator|->
name|opt
operator|.
name|s0
operator|=
name|ts
expr_stmt|;
name|ct_setup_e1
argument_list|(
name|c
operator|->
name|board
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|ct_set_subchan
parameter_list|(
name|ct_board_t
modifier|*
name|b
parameter_list|,
name|unsigned
name|long
name|ts
parameter_list|)
block|{
if|if
condition|(
name|b
operator|->
name|chan
index|[
literal|0
index|]
operator|.
name|mode
operator|!=
name|M_E1
condition|)
return|return
operator|-
literal|1
return|;
name|b
operator|->
name|opt
operator|.
name|s2
operator|=
name|ts
expr_stmt|;
name|ct_setup_e1
argument_list|(
name|b
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|ct_set_higain
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|,
name|int
name|on
parameter_list|)
block|{
if|if
condition|(
operator|!
operator|(
name|c
operator|->
name|mode
operator|==
name|M_E1
operator|)
condition|)
return|return
operator|-
literal|1
return|;
name|c
operator|->
name|gopt
operator|.
name|higain
operator|=
name|on
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|ct_setup_e1
argument_list|(
name|c
operator|->
name|board
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Start service channel.  */
end_comment

begin_function
name|void
name|ct_start_scc
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|,
name|char
modifier|*
name|rxbuf
parameter_list|,
name|char
modifier|*
name|txbuf
parameter_list|)
block|{
name|c
operator|->
name|sccrx
operator|=
name|rxbuf
expr_stmt|;
name|c
operator|->
name|scctx
operator|=
name|txbuf
expr_stmt|;
comment|/* Enable interrupts from service channel. */
if|if
condition|(
name|c
operator|->
name|board
operator|->
name|type
operator|!=
name|B_TAU_E1
operator|&&
name|c
operator|->
name|board
operator|->
name|type
operator|!=
name|B_TAU_E1C
operator|&&
name|c
operator|->
name|board
operator|->
name|type
operator|!=
name|B_TAU2_E1
condition|)
return|return;
name|cte_out2
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|,
name|c
operator|->
name|num
condition|?
name|AM_IMR
else|:
name|AM_IMR
operator||
name|AM_A
argument_list|,
name|IMR_TX
operator||
name|IMR_RX_ALL
argument_list|)
expr_stmt|;
name|cte_out2
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|,
name|AM_MICR
argument_list|,
name|MICR_MIE
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Start HDLC channel.  */
end_comment

begin_function
name|void
name|ct_start_chan
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|,
name|ct_buf_t
modifier|*
name|cb
parameter_list|,
name|unsigned
name|long
name|phys
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|ier0
decl_stmt|;
name|unsigned
name|long
name|bound
decl_stmt|;
if|if
condition|(
name|cb
condition|)
block|{
comment|/* Set up descriptors, align to 64k boundary. 		 * If 64k boundary is inside buffers 		 * buffers will begin on this boundary 		 * (there were allocated additional space for this) */
name|c
operator|->
name|tdesc
operator|=
name|cb
operator|->
name|descbuf
expr_stmt|;
name|c
operator|->
name|tdphys
index|[
literal|0
index|]
operator|=
name|phys
operator|+
operator|(
operator|(
name|char
operator|*
operator|)
name|c
operator|->
name|tdesc
operator|-
operator|(
name|char
operator|*
operator|)
name|cb
operator|)
expr_stmt|;
name|bound
operator|=
operator|(
operator|(
name|c
operator|->
name|tdphys
index|[
literal|0
index|]
operator|+
literal|0xffff
operator|)
operator|&
operator|~
operator|(
literal|0xffffUL
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|bound
operator|<
name|c
operator|->
name|tdphys
index|[
literal|0
index|]
operator|+
literal|2
operator|*
name|NBUF
operator|*
sizeof|sizeof
argument_list|(
name|ct_desc_t
argument_list|)
condition|)
block|{
name|c
operator|->
name|tdesc
operator|=
operator|(
name|ct_desc_t
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|c
operator|->
name|tdesc
operator|+
operator|(
name|bound
operator|-
name|c
operator|->
name|tdphys
index|[
literal|0
index|]
operator|)
operator|)
expr_stmt|;
name|c
operator|->
name|tdphys
index|[
literal|0
index|]
operator|=
name|bound
expr_stmt|;
block|}
name|c
operator|->
name|rdesc
operator|=
name|c
operator|->
name|tdesc
operator|+
name|NBUF
expr_stmt|;
comment|/* Set buffers. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NBUF
condition|;
operator|++
name|i
control|)
block|{
name|c
operator|->
name|rbuf
index|[
name|i
index|]
operator|=
name|cb
operator|->
name|rbuffer
index|[
name|i
index|]
expr_stmt|;
name|c
operator|->
name|tbuf
index|[
name|i
index|]
operator|=
name|cb
operator|->
name|tbuffer
index|[
name|i
index|]
expr_stmt|;
block|}
comment|/* Set buffer physical addresses */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NBUF
condition|;
operator|++
name|i
control|)
block|{
name|c
operator|->
name|rphys
index|[
name|i
index|]
operator|=
name|phys
operator|+
operator|(
operator|(
name|char
operator|*
operator|)
name|c
operator|->
name|rbuf
index|[
name|i
index|]
operator|-
operator|(
name|char
operator|*
operator|)
name|cb
operator|)
expr_stmt|;
name|c
operator|->
name|tphys
index|[
name|i
index|]
operator|=
name|phys
operator|+
operator|(
operator|(
name|char
operator|*
operator|)
name|c
operator|->
name|tbuf
index|[
name|i
index|]
operator|-
operator|(
name|char
operator|*
operator|)
name|cb
operator|)
expr_stmt|;
name|c
operator|->
name|rdphys
index|[
name|i
index|]
operator|=
name|phys
operator|+
operator|(
operator|(
name|char
operator|*
operator|)
operator|(
name|c
operator|->
name|rdesc
operator|+
name|i
operator|)
operator|-
operator|(
name|char
operator|*
operator|)
name|cb
operator|)
expr_stmt|;
name|c
operator|->
name|tdphys
index|[
name|i
index|]
operator|=
name|phys
operator|+
operator|(
operator|(
name|char
operator|*
operator|)
operator|(
name|c
operator|->
name|tdesc
operator|+
name|i
operator|)
operator|-
operator|(
name|char
operator|*
operator|)
name|cb
operator|)
expr_stmt|;
block|}
block|}
comment|/* Set up block chains. */
comment|/* receive buffers */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NBUF
condition|;
operator|++
name|i
control|)
block|{
name|B_NEXT
argument_list|(
name|c
operator|->
name|rdesc
index|[
name|i
index|]
argument_list|)
operator|=
name|c
operator|->
name|rdphys
index|[
operator|(
name|i
operator|+
literal|1
operator|)
operator|%
name|NBUF
index|]
operator|&
literal|0xffff
expr_stmt|;
name|B_PTR
argument_list|(
name|c
operator|->
name|rdesc
index|[
name|i
index|]
argument_list|)
operator|=
name|c
operator|->
name|rphys
index|[
name|i
index|]
expr_stmt|;
name|B_LEN
argument_list|(
name|c
operator|->
name|rdesc
index|[
name|i
index|]
argument_list|)
operator|=
name|DMABUFSZ
expr_stmt|;
name|B_STATUS
argument_list|(
name|c
operator|->
name|rdesc
index|[
name|i
index|]
argument_list|)
operator|=
literal|0
expr_stmt|;
block|}
comment|/* transmit buffers */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NBUF
condition|;
operator|++
name|i
control|)
block|{
name|B_NEXT
argument_list|(
name|c
operator|->
name|tdesc
index|[
name|i
index|]
argument_list|)
operator|=
name|c
operator|->
name|tdphys
index|[
operator|(
name|i
operator|+
literal|1
operator|)
operator|%
name|NBUF
index|]
operator|&
literal|0xffff
expr_stmt|;
name|B_PTR
argument_list|(
name|c
operator|->
name|tdesc
index|[
name|i
index|]
argument_list|)
operator|=
name|c
operator|->
name|tphys
index|[
name|i
index|]
expr_stmt|;
name|B_LEN
argument_list|(
name|c
operator|->
name|tdesc
index|[
name|i
index|]
argument_list|)
operator|=
name|DMABUFSZ
expr_stmt|;
name|B_STATUS
argument_list|(
name|c
operator|->
name|tdesc
index|[
name|i
index|]
argument_list|)
operator|=
name|FST_EOM
expr_stmt|;
name|c
operator|->
name|attach
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|c
operator|->
name|type
operator|&
name|T_E1
condition|)
block|{
name|c
operator|->
name|mode
operator|=
name|M_E1
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|num
operator|&&
name|c
operator|->
name|board
operator|->
name|opt
operator|.
name|cfg
operator|==
name|CFG_B
condition|)
name|c
operator|->
name|mode
operator|=
name|M_HDLC
expr_stmt|;
block|}
if|if
condition|(
name|c
operator|->
name|type
operator|&
name|T_G703
condition|)
block|{
name|c
operator|->
name|mode
operator|=
name|M_G703
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|num
operator|&&
name|c
operator|->
name|board
operator|->
name|opt
operator|.
name|cfg
operator|==
name|CFG_B
condition|)
name|c
operator|->
name|mode
operator|=
name|M_HDLC
expr_stmt|;
block|}
name|ct_update_chan
argument_list|(
name|c
argument_list|)
expr_stmt|;
comment|/* enable receiver */
name|c
operator|->
name|rn
operator|=
literal|0
expr_stmt|;
name|ct_start_receiver
argument_list|(
name|c
argument_list|,
literal|1
argument_list|,
name|c
operator|->
name|rphys
index|[
literal|0
index|]
argument_list|,
name|DMABUFSZ
argument_list|,
name|c
operator|->
name|rdphys
index|[
literal|0
index|]
argument_list|,
name|c
operator|->
name|rdphys
index|[
name|NBUF
operator|-
literal|1
index|]
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|c
operator|->
name|IE1
argument_list|,
name|inb
argument_list|(
name|c
operator|->
name|IE1
argument_list|)
operator||
name|IE1_CDCDE
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|c
operator|->
name|IE0
argument_list|,
name|inb
argument_list|(
name|c
operator|->
name|IE0
argument_list|)
operator||
name|IE0_RX_INTE
argument_list|)
expr_stmt|;
name|ier0
operator|=
name|inb
argument_list|(
name|IER0
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|)
expr_stmt|;
name|ier0
operator||=
name|c
operator|->
name|num
condition|?
name|IER0_RX_INTE_1
else|:
name|IER0_RX_INTE_0
expr_stmt|;
name|outb
argument_list|(
name|IER0
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|,
name|ier0
argument_list|)
expr_stmt|;
comment|/* Enable transmitter */
name|c
operator|->
name|tn
operator|=
literal|0
expr_stmt|;
name|c
operator|->
name|te
operator|=
literal|0
expr_stmt|;
name|ct_start_transmitter
argument_list|(
name|c
argument_list|,
literal|1
argument_list|,
name|c
operator|->
name|tphys
index|[
literal|0
index|]
argument_list|,
name|DMABUFSZ
argument_list|,
name|c
operator|->
name|tdphys
index|[
literal|0
index|]
argument_list|,
name|c
operator|->
name|tdphys
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|c
operator|->
name|TX
operator|.
name|DIR
argument_list|,
name|DIR_CHAIN_EOME
operator||
name|DIR_CHAIN_BOFE
operator||
name|DIR_CHAIN_COFE
argument_list|)
expr_stmt|;
comment|/* Clear DTR and RTS */
name|ct_set_dtr
argument_list|(
name|c
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ct_set_rts
argument_list|(
name|c
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Turn receiver on/off  */
end_comment

begin_function
name|void
name|ct_enable_receive
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|,
name|int
name|on
parameter_list|)
block|{
name|unsigned
name|char
name|st3
decl_stmt|,
name|ier0
decl_stmt|,
name|ier1
decl_stmt|;
name|st3
operator|=
name|inb
argument_list|(
name|c
operator|->
name|ST3
argument_list|)
expr_stmt|;
comment|/* enable or disable receiver */
if|if
condition|(
name|on
operator|&&
operator|!
operator|(
name|st3
operator|&
name|ST3_RX_ENABLED
operator|)
condition|)
block|{
name|c
operator|->
name|rn
operator|=
literal|0
expr_stmt|;
name|ct_start_receiver
argument_list|(
name|c
argument_list|,
literal|1
argument_list|,
name|c
operator|->
name|rphys
index|[
literal|0
index|]
argument_list|,
name|DMABUFSZ
argument_list|,
name|c
operator|->
name|rdphys
index|[
literal|0
index|]
argument_list|,
name|c
operator|->
name|rdphys
index|[
name|NBUF
operator|-
literal|1
index|]
argument_list|)
expr_stmt|;
comment|/* enable status interrupt */
name|outb
argument_list|(
name|c
operator|->
name|IE1
argument_list|,
name|inb
argument_list|(
name|c
operator|->
name|IE1
argument_list|)
operator||
name|IE1_CDCDE
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|c
operator|->
name|IE0
argument_list|,
name|inb
argument_list|(
name|c
operator|->
name|IE0
argument_list|)
operator||
name|IE0_RX_INTE
argument_list|)
expr_stmt|;
name|ier0
operator|=
name|inb
argument_list|(
name|IER0
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|)
expr_stmt|;
name|ier0
operator||=
name|c
operator|->
name|num
condition|?
name|IER0_RX_INTE_1
else|:
name|IER0_RX_INTE_0
expr_stmt|;
name|outb
argument_list|(
name|IER0
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|,
name|ier0
argument_list|)
expr_stmt|;
name|ct_set_rts
argument_list|(
name|c
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|on
operator|&&
operator|(
name|st3
operator|&
name|ST3_RX_ENABLED
operator|)
condition|)
block|{
name|ct_set_rts
argument_list|(
name|c
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|c
operator|->
name|CMD
argument_list|,
name|CMD_RX_DISABLE
argument_list|)
expr_stmt|;
name|ier0
operator|=
name|inb
argument_list|(
name|IER0
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|)
expr_stmt|;
name|ier0
operator|&=
name|c
operator|->
name|num
condition|?
operator|~
operator|(
name|IER0_RX_INTE_1
operator||
name|IER0_RX_RDYE_1
operator|)
else|:
operator|~
operator|(
name|IER0_RX_INTE_0
operator||
name|IER0_RX_RDYE_0
operator|)
expr_stmt|;
name|outb
argument_list|(
name|IER0
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|,
name|ier0
argument_list|)
expr_stmt|;
name|ier1
operator|=
name|inb
argument_list|(
name|IER1
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|)
expr_stmt|;
name|ier1
operator|&=
name|c
operator|->
name|num
condition|?
operator|~
operator|(
name|IER1_RX_DMERE_1
operator||
name|IER1_RX_DME_1
operator|)
else|:
operator|~
operator|(
name|IER1_RX_DMERE_0
operator||
name|IER1_RX_DME_0
operator|)
expr_stmt|;
name|outb
argument_list|(
name|IER1
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|,
name|ier1
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Turn transmitter on/off  */
end_comment

begin_function
name|void
name|ct_enable_transmit
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|,
name|int
name|on
parameter_list|)
block|{
name|unsigned
name|char
name|st3
decl_stmt|,
name|ier0
decl_stmt|,
name|ier1
decl_stmt|;
name|st3
operator|=
name|inb
argument_list|(
name|c
operator|->
name|ST3
argument_list|)
expr_stmt|;
comment|/* enable or disable receiver */
if|if
condition|(
name|on
operator|&&
operator|!
operator|(
name|st3
operator|&
name|ST3_TX_ENABLED
operator|)
condition|)
block|{
name|c
operator|->
name|tn
operator|=
literal|0
expr_stmt|;
name|c
operator|->
name|te
operator|=
literal|0
expr_stmt|;
name|ct_start_transmitter
argument_list|(
name|c
argument_list|,
literal|1
argument_list|,
name|c
operator|->
name|tphys
index|[
literal|0
index|]
argument_list|,
name|DMABUFSZ
argument_list|,
name|c
operator|->
name|tdphys
index|[
literal|0
index|]
argument_list|,
name|c
operator|->
name|tdphys
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|c
operator|->
name|TX
operator|.
name|DIR
argument_list|,
name|DIR_CHAIN_EOME
operator||
name|DIR_CHAIN_BOFE
operator||
name|DIR_CHAIN_COFE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|on
operator|&&
operator|(
name|st3
operator|&
name|ST3_TX_ENABLED
operator|)
condition|)
block|{
name|outb
argument_list|(
name|c
operator|->
name|CMD
argument_list|,
name|CMD_TX_DISABLE
argument_list|)
expr_stmt|;
name|ier0
operator|=
name|inb
argument_list|(
name|IER0
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|)
expr_stmt|;
name|ier0
operator|&=
name|c
operator|->
name|num
condition|?
operator|~
operator|(
name|IER0_TX_INTE_1
operator||
name|IER0_TX_RDYE_1
operator|)
else|:
operator|~
operator|(
name|IER0_TX_INTE_0
operator||
name|IER0_TX_RDYE_0
operator|)
expr_stmt|;
name|outb
argument_list|(
name|IER0
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|,
name|ier0
argument_list|)
expr_stmt|;
name|ier1
operator|=
name|inb
argument_list|(
name|IER1
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|)
expr_stmt|;
name|ier1
operator|&=
name|c
operator|->
name|num
condition|?
operator|~
operator|(
name|IER1_TX_DMERE_1
operator||
name|IER1_TX_DME_1
operator|)
else|:
operator|~
operator|(
name|IER1_TX_DMERE_0
operator||
name|IER1_TX_DME_0
operator|)
expr_stmt|;
name|outb
argument_list|(
name|IER1
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|,
name|ier1
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|ct_set_config
parameter_list|(
name|ct_board_t
modifier|*
name|b
parameter_list|,
name|int
name|cfg
parameter_list|)
block|{
if|if
condition|(
name|b
operator|->
name|opt
operator|.
name|cfg
operator|==
name|cfg
condition|)
return|return
literal|0
return|;
switch|switch
condition|(
name|b
operator|->
name|type
condition|)
block|{
case|case
name|B_TAU_G703
case|:
case|case
name|B_TAU_G703C
case|:
case|case
name|B_TAU2_G703
case|:
if|if
condition|(
name|cfg
operator|==
name|CFG_C
condition|)
return|return
operator|-
literal|1
return|;
name|ct_g703_config
argument_list|(
name|b
argument_list|,
name|cfg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|B_TAU_E1
case|:
case|case
name|B_TAU_E1C
case|:
case|case
name|B_TAU_E1D
case|:
case|case
name|B_TAU2_E1
case|:
case|case
name|B_TAU2_E1D
case|:
name|ct_e1_config
argument_list|(
name|b
argument_list|,
name|cfg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
default|default:
return|return
name|cfg
operator|==
name|CFG_A
condition|?
literal|0
else|:
operator|-
literal|1
return|;
block|}
block|}
end_function

begin_function
name|int
name|ct_get_dpll
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|)
block|{
return|return
operator|(
name|c
operator|->
name|hopt
operator|.
name|rxs
operator|==
name|CLK_RXS_DPLL_INT
operator|)
return|;
block|}
end_function

begin_function
name|void
name|ct_set_dpll
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|,
name|int
name|on
parameter_list|)
block|{
if|if
condition|(
name|on
operator|&&
name|ct_get_baud
argument_list|(
name|c
argument_list|)
condition|)
name|c
operator|->
name|hopt
operator|.
name|rxs
operator|=
name|CLK_RXS_DPLL_INT
expr_stmt|;
else|else
name|c
operator|->
name|hopt
operator|.
name|rxs
operator|=
name|CLK_LINE
expr_stmt|;
name|ct_update_chan
argument_list|(
name|c
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|ct_get_nrzi
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|)
block|{
return|return
operator|(
name|c
operator|->
name|opt
operator|.
name|md2
operator|.
name|encod
operator|==
name|MD2_ENCOD_NRZI
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Change line encoding to NRZI, default is NRZ  */
end_comment

begin_function
name|void
name|ct_set_nrzi
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|,
name|int
name|on
parameter_list|)
block|{
name|c
operator|->
name|opt
operator|.
name|md2
operator|.
name|encod
operator|=
name|on
condition|?
name|MD2_ENCOD_NRZI
else|:
name|MD2_ENCOD_NRZ
expr_stmt|;
name|outb
argument_list|(
name|c
operator|->
name|MD2
argument_list|,
operator|*
operator|(
name|unsigned
name|char
operator|*
operator|)
operator|&
name|c
operator|->
name|opt
operator|.
name|md2
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Transmit clock inversion  */
end_comment

begin_function
name|void
name|ct_set_invtxc
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|,
name|int
name|on
parameter_list|)
block|{
if|if
condition|(
name|on
condition|)
name|c
operator|->
name|board
operator|->
name|bcr2
operator||=
operator|(
name|c
operator|->
name|num
condition|?
name|BCR2_INVTXC1
else|:
name|BCR2_INVTXC0
operator|)
expr_stmt|;
else|else
name|c
operator|->
name|board
operator|->
name|bcr2
operator|&=
operator|~
operator|(
name|c
operator|->
name|num
condition|?
name|BCR2_INVTXC1
else|:
name|BCR2_INVTXC0
operator|)
expr_stmt|;
name|outb
argument_list|(
name|BCR2
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|board
operator|->
name|bcr2
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|ct_get_invtxc
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|)
block|{
return|return
operator|(
name|c
operator|->
name|board
operator|->
name|bcr2
operator|&
operator|(
name|c
operator|->
name|num
condition|?
name|BCR2_INVTXC1
else|:
name|BCR2_INVTXC0
operator|)
operator|)
operator|!=
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Receive clock inversion  */
end_comment

begin_function
name|void
name|ct_set_invrxc
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|,
name|int
name|on
parameter_list|)
block|{
if|if
condition|(
name|on
condition|)
name|c
operator|->
name|board
operator|->
name|bcr2
operator||=
operator|(
name|c
operator|->
name|num
condition|?
name|BCR2_INVRXC1
else|:
name|BCR2_INVRXC0
operator|)
expr_stmt|;
else|else
name|c
operator|->
name|board
operator|->
name|bcr2
operator|&=
operator|~
operator|(
name|c
operator|->
name|num
condition|?
name|BCR2_INVRXC1
else|:
name|BCR2_INVRXC0
operator|)
expr_stmt|;
name|outb
argument_list|(
name|BCR2
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|board
operator|->
name|bcr2
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|ct_get_invrxc
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|)
block|{
return|return
operator|(
name|c
operator|->
name|board
operator|->
name|bcr2
operator|&
operator|(
name|c
operator|->
name|num
condition|?
name|BCR2_INVRXC1
else|:
name|BCR2_INVRXC0
operator|)
operator|)
operator|!=
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Main interrupt handler  */
end_comment

begin_function
name|void
name|ct_int_handler
parameter_list|(
name|ct_board_t
modifier|*
name|b
parameter_list|)
block|{
name|unsigned
name|char
name|bsr0
decl_stmt|,
name|imvr
decl_stmt|;
name|ct_chan_t
modifier|*
name|c
decl_stmt|;
while|while
condition|(
operator|(
name|bsr0
operator|=
name|inb
argument_list|(
name|BSR0
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|)
operator|)
operator|&
name|BSR0_INTR
condition|)
block|{
if|if
condition|(
name|bsr0
operator|&
name|BSR0_RDYERR
condition|)
block|{
name|outb
argument_list|(
name|BCR1
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|,
name|b
operator|->
name|bcr1
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|bsr0
operator|&
name|BSR0_GINT
condition|)
block|{
if|if
condition|(
name|b
operator|->
name|type
operator|==
name|B_TAU_E1
operator|||
name|b
operator|->
name|type
operator|==
name|B_TAU_E1C
operator|||
name|b
operator|->
name|type
operator|==
name|B_TAU_E1D
operator|||
name|b
operator|->
name|type
operator|==
name|B_TAU2_E1
operator|||
name|b
operator|->
name|type
operator|==
name|B_TAU2_E1D
condition|)
name|ct_e1_interrupt
argument_list|(
name|b
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|bsr0
operator|&
name|BSR0_HDINT
condition|)
block|{
comment|/* Read the interrupt modified vector register. */
name|imvr
operator|=
name|inb
argument_list|(
name|IACK
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|)
expr_stmt|;
name|c
operator|=
name|b
operator|->
name|chan
operator|+
operator|(
name|imvr
operator|&
name|IMVR_CHAN1
condition|?
literal|1
else|:
literal|0
operator|)
expr_stmt|;
name|ct_hdlc_interrupt
argument_list|(
name|c
argument_list|,
name|imvr
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ct_e1_interrupt
parameter_list|(
name|ct_board_t
modifier|*
name|b
parameter_list|)
block|{
name|unsigned
name|char
name|sr
decl_stmt|;
name|sr
operator|=
name|inb
argument_list|(
name|E1SR
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sr
operator|&
name|E1SR_SCC_IRQ
condition|)
name|ct_scc_interrupt
argument_list|(
name|b
argument_list|)
expr_stmt|;
if|if
condition|(
name|sr
operator|&
name|E1SR_E0_IRQ1
condition|)
name|ct_e1timer_interrupt
argument_list|(
name|b
operator|->
name|chan
operator|+
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|sr
operator|&
name|E1SR_E1_IRQ1
condition|)
name|ct_e1timer_interrupt
argument_list|(
name|b
operator|->
name|chan
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ct_scc_interrupt
parameter_list|(
name|ct_board_t
modifier|*
name|b
parameter_list|)
block|{
name|unsigned
name|char
name|rsr
decl_stmt|;
name|unsigned
name|char
name|ivr
decl_stmt|,
name|a
init|=
name|AM_A
decl_stmt|;
comment|/* assume channel A */
name|ct_chan_t
modifier|*
name|c
init|=
name|b
operator|->
name|chan
decl_stmt|;
name|ivr
operator|=
name|cte_in2
argument_list|(
name|b
operator|->
name|port
argument_list|,
name|AM_IVR
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ivr
operator|&
name|IVR_A
operator|)
condition|)
operator|++
name|c
operator|,
name|a
operator|=
literal|0
expr_stmt|;
comment|/* really channel B */
switch|switch
condition|(
name|ivr
operator|&
name|IVR_REASON
condition|)
block|{
case|case
name|IVR_TXRDY
case|:
comment|/* transmitter empty */
name|c
operator|->
name|scctx_b
operator|=
operator|(
name|c
operator|->
name|scctx_b
operator|+
literal|1
operator|)
operator|%
name|SCCBUFSZ
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|scctx_b
operator|==
name|c
operator|->
name|scctx_e
condition|)
block|{
name|c
operator|->
name|scctx_empty
operator|=
literal|1
expr_stmt|;
name|cte_out2c
argument_list|(
name|c
argument_list|,
name|AM_CR
operator||
name|CR_RST_TXINT
argument_list|)
expr_stmt|;
block|}
else|else
name|cte_out2d
argument_list|(
name|c
argument_list|,
name|c
operator|->
name|scctx
index|[
name|c
operator|->
name|scctx_b
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|IVR_RXERR
case|:
comment|/* receive error */
case|case
name|IVR_RX
case|:
comment|/* receive character available */
name|rsr
operator|=
name|cte_in2
argument_list|(
name|b
operator|->
name|port
argument_list|,
name|a
operator||
name|AM_RSR
argument_list|)
expr_stmt|;
if|if
condition|(
name|rsr
operator|&
name|RSR_RXOVRN
condition|)
block|{
comment|/* rx overrun */
if|if
condition|(
name|c
operator|->
name|call_on_err
condition|)
name|c
operator|->
name|call_on_err
argument_list|(
name|c
argument_list|,
name|CT_SCC_OVERRUN
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rsr
operator|&
name|RSR_FRME
condition|)
block|{
comment|/* frame error */
if|if
condition|(
name|c
operator|->
name|call_on_err
condition|)
name|c
operator|->
name|call_on_err
argument_list|(
name|c
argument_list|,
name|CT_SCC_FRAME
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|c
operator|->
name|sccrx
index|[
name|c
operator|->
name|sccrx_e
index|]
operator|=
name|cte_in2d
argument_list|(
name|c
argument_list|)
expr_stmt|;
name|c
operator|->
name|sccrx_e
operator|=
operator|(
name|c
operator|->
name|sccrx_e
operator|+
literal|1
operator|)
operator|%
name|SCCBUFSZ
expr_stmt|;
name|c
operator|->
name|sccrx_empty
operator|&=
literal|0
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|call_on_scc
condition|)
name|c
operator|->
name|call_on_scc
argument_list|(
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|sccrx_e
operator|==
name|c
operator|->
name|sccrx_b
operator|&&
operator|!
name|c
operator|->
name|sccrx_empty
condition|)
if|if
condition|(
name|c
operator|->
name|call_on_err
condition|)
name|c
operator|->
name|call_on_err
argument_list|(
name|c
argument_list|,
name|CT_SCC_OVERFLOW
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rsr
condition|)
name|cte_out2c
argument_list|(
name|c
argument_list|,
name|CR_RST_ERROR
argument_list|)
expr_stmt|;
break|break;
case|case
name|IVR_STATUS
case|:
comment|/* external status interrupt */
comment|/* Unexpected SCC status interrupt. */
name|cte_out2c
argument_list|(
name|c
argument_list|,
name|CR_RST_EXTINT
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/*  * G.703 mode channel: process 1-second timer interrupts.  * Read error and request registers, and fill the status field.  */
end_comment

begin_function
name|void
name|ct_g703_timer
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|)
block|{
name|int
name|bpv
decl_stmt|,
name|cd
decl_stmt|,
name|tsterr
decl_stmt|,
name|tstreq
decl_stmt|;
comment|/* Count seconds. 	 * During the first second after the channel startup 	 * the status registers are not stable yet, 	 * we will so skip the first second. */
operator|++
name|c
operator|->
name|cursec
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|mode
operator|!=
name|M_G703
condition|)
return|return;
if|if
condition|(
name|c
operator|->
name|totsec
operator|+
name|c
operator|->
name|cursec
operator|<=
literal|1
condition|)
return|return;
name|c
operator|->
name|status
operator|=
literal|0
expr_stmt|;
name|cd
operator|=
name|ct_get_cd
argument_list|(
name|c
argument_list|)
expr_stmt|;
name|bpv
operator|=
name|inb
argument_list|(
name|GERR
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|)
operator|&
operator|(
name|c
operator|->
name|num
condition|?
name|GERR_BPV1
else|:
name|GERR_BPV0
operator|)
expr_stmt|;
name|outb
argument_list|(
name|GERR
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|,
name|bpv
argument_list|)
expr_stmt|;
name|tsterr
operator|=
name|inb
argument_list|(
name|GERR
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|)
operator|&
operator|(
name|c
operator|->
name|num
condition|?
name|GERR_ERR1
else|:
name|GERR_ERR0
operator|)
expr_stmt|;
name|outb
argument_list|(
name|GERR
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|,
name|tsterr
argument_list|)
expr_stmt|;
name|tstreq
operator|=
name|inb
argument_list|(
name|GLDR
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|)
operator|&
operator|(
name|c
operator|->
name|num
condition|?
name|GLDR_LREQ1
else|:
name|GLDR_LREQ0
operator|)
expr_stmt|;
name|outb
argument_list|(
name|GLDR
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|,
name|tstreq
argument_list|)
expr_stmt|;
comment|/* Compute the SNMP-compatible channel status. */
if|if
condition|(
name|bpv
condition|)
operator|++
name|c
operator|->
name|currnt
operator|.
name|bpv
expr_stmt|;
comment|/* bipolar violation */
if|if
condition|(
operator|!
name|cd
condition|)
name|c
operator|->
name|status
operator||=
name|ESTS_LOS
expr_stmt|;
comment|/* loss of signal */
if|if
condition|(
name|tsterr
condition|)
name|c
operator|->
name|status
operator||=
name|ESTS_TSTERR
expr_stmt|;
comment|/* test error */
if|if
condition|(
name|tstreq
condition|)
name|c
operator|->
name|status
operator||=
name|ESTS_TSTREQ
expr_stmt|;
comment|/* test code detected */
if|if
condition|(
operator|!
name|c
operator|->
name|status
condition|)
name|c
operator|->
name|status
operator|=
name|ESTS_NOALARM
expr_stmt|;
comment|/* Unavaiable second -- loss of carrier, or receiving test code. */
if|if
condition|(
operator|(
operator|!
name|cd
operator|)
operator|||
name|tstreq
condition|)
comment|/* Unavailable second -- no other counters. */
operator|++
name|c
operator|->
name|currnt
operator|.
name|uas
expr_stmt|;
else|else
block|{
comment|/* Line errored second -- any BPV. */
if|if
condition|(
name|bpv
condition|)
operator|++
name|c
operator|->
name|currnt
operator|.
name|les
expr_stmt|;
comment|/* Collect data for computing 		 * degraded minutes. */
operator|++
name|c
operator|->
name|degsec
expr_stmt|;
if|if
condition|(
name|cd
operator|&&
name|bpv
condition|)
operator|++
name|c
operator|->
name|degerr
expr_stmt|;
block|}
comment|/* Degraded minutes -- having more than 50% error intervals. */
if|if
condition|(
name|c
operator|->
name|cursec
operator|/
literal|60
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|c
operator|->
name|degerr
operator|*
literal|2
operator|>
name|c
operator|->
name|degsec
condition|)
operator|++
name|c
operator|->
name|currnt
operator|.
name|dm
expr_stmt|;
name|c
operator|->
name|degsec
operator|=
literal|0
expr_stmt|;
name|c
operator|->
name|degerr
operator|=
literal|0
expr_stmt|;
block|}
comment|/* Rotate statistics every 15 minutes. */
if|if
condition|(
name|c
operator|->
name|cursec
operator|>
literal|15
operator|*
literal|60
condition|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|47
init|;
name|i
operator|>
literal|0
condition|;
operator|--
name|i
control|)
name|c
operator|->
name|interval
index|[
name|i
index|]
operator|=
name|c
operator|->
name|interval
index|[
name|i
operator|-
literal|1
index|]
expr_stmt|;
name|c
operator|->
name|interval
index|[
literal|0
index|]
operator|=
name|c
operator|->
name|currnt
expr_stmt|;
comment|/* Accumulate total statistics. */
name|c
operator|->
name|total
operator|.
name|bpv
operator|+=
name|c
operator|->
name|currnt
operator|.
name|bpv
expr_stmt|;
name|c
operator|->
name|total
operator|.
name|fse
operator|+=
name|c
operator|->
name|currnt
operator|.
name|fse
expr_stmt|;
name|c
operator|->
name|total
operator|.
name|crce
operator|+=
name|c
operator|->
name|currnt
operator|.
name|crce
expr_stmt|;
name|c
operator|->
name|total
operator|.
name|rcrce
operator|+=
name|c
operator|->
name|currnt
operator|.
name|rcrce
expr_stmt|;
name|c
operator|->
name|total
operator|.
name|uas
operator|+=
name|c
operator|->
name|currnt
operator|.
name|uas
expr_stmt|;
name|c
operator|->
name|total
operator|.
name|les
operator|+=
name|c
operator|->
name|currnt
operator|.
name|les
expr_stmt|;
name|c
operator|->
name|total
operator|.
name|es
operator|+=
name|c
operator|->
name|currnt
operator|.
name|es
expr_stmt|;
name|c
operator|->
name|total
operator|.
name|bes
operator|+=
name|c
operator|->
name|currnt
operator|.
name|bes
expr_stmt|;
name|c
operator|->
name|total
operator|.
name|ses
operator|+=
name|c
operator|->
name|currnt
operator|.
name|ses
expr_stmt|;
name|c
operator|->
name|total
operator|.
name|oofs
operator|+=
name|c
operator|->
name|currnt
operator|.
name|oofs
expr_stmt|;
name|c
operator|->
name|total
operator|.
name|css
operator|+=
name|c
operator|->
name|currnt
operator|.
name|css
expr_stmt|;
name|c
operator|->
name|total
operator|.
name|dm
operator|+=
name|c
operator|->
name|currnt
operator|.
name|dm
expr_stmt|;
name|memset
argument_list|(
operator|&
name|c
operator|->
name|currnt
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|c
operator|->
name|currnt
argument_list|)
argument_list|)
expr_stmt|;
name|c
operator|->
name|totsec
operator|+=
name|c
operator|->
name|cursec
expr_stmt|;
name|c
operator|->
name|cursec
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ct_e1timer_interrupt
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|)
block|{
name|unsigned
name|short
name|port
decl_stmt|;
name|unsigned
name|char
name|sr1
decl_stmt|,
name|sr2
decl_stmt|,
name|ssr
decl_stmt|;
name|unsigned
name|long
name|bpv
decl_stmt|,
name|fas
decl_stmt|,
name|crc4
decl_stmt|,
name|ebit
decl_stmt|,
name|pcv
decl_stmt|,
name|oof
decl_stmt|;
name|port
operator|=
name|c
operator|->
name|num
condition|?
name|E1CS1
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
else|:
name|E1CS0
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
expr_stmt|;
name|sr2
operator|=
name|cte_ins
argument_list|(
name|port
argument_list|,
name|DS_SR2
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
comment|/* is it timer interrupt ? */
if|if
condition|(
operator|!
operator|(
name|sr2
operator|&
name|SR2_SEC
operator|)
condition|)
return|return;
comment|/* first interrupts should be ignored */
if|if
condition|(
name|c
operator|->
name|e1_first_int
operator|>
literal|0
condition|)
block|{
name|c
operator|->
name|e1_first_int
operator|--
expr_stmt|;
return|return;
block|}
operator|++
name|c
operator|->
name|cursec
expr_stmt|;
name|c
operator|->
name|status
operator|=
literal|0
expr_stmt|;
comment|/* Compute the SNMP-compatible channel status. */
name|sr1
operator|=
name|cte_ins
argument_list|(
name|port
argument_list|,
name|DS_SR1
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
name|ssr
operator|=
name|cte_in
argument_list|(
name|port
argument_list|,
name|DS_SSR
argument_list|)
expr_stmt|;
name|oof
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|sr1
operator|&
operator|(
name|SR1_RCL
operator||
name|SR1_RLOS
operator|)
condition|)
name|c
operator|->
name|status
operator||=
name|ESTS_LOS
expr_stmt|;
comment|/* loss of signal */
if|if
condition|(
name|sr1
operator|&
name|SR1_RUA1
condition|)
name|c
operator|->
name|status
operator||=
name|ESTS_AIS
expr_stmt|;
comment|/* receiving all ones */
if|if
condition|(
name|c
operator|->
name|gopt
operator|.
name|cas
operator|&&
operator|(
name|sr1
operator|&
name|SR1_RSA1
operator|)
condition|)
name|c
operator|->
name|status
operator||=
name|ESTS_AIS16
expr_stmt|;
comment|/* signaling all ones */
if|if
condition|(
name|c
operator|->
name|gopt
operator|.
name|cas
operator|&&
operator|(
name|sr1
operator|&
name|SR1_RDMA
operator|)
condition|)
name|c
operator|->
name|status
operator||=
name|ESTS_FARLOMF
expr_stmt|;
comment|/* alarm in timeslot 16 */
if|if
condition|(
name|sr1
operator|&
name|SR1_RRA
condition|)
name|c
operator|->
name|status
operator||=
name|ESTS_FARLOF
expr_stmt|;
comment|/* far loss of framing */
comment|/* Controlled slip second -- any slip event. */
if|if
condition|(
name|sr1
operator|&
name|SR1_RSLIP
condition|)
block|{
operator|++
name|c
operator|->
name|currnt
operator|.
name|css
expr_stmt|;
block|}
if|if
condition|(
name|ssr
operator|&
name|SSR_SYNC
condition|)
block|{
name|c
operator|->
name|status
operator||=
name|ESTS_LOF
expr_stmt|;
comment|/* loss of framing */
operator|++
name|oof
expr_stmt|;
comment|/* out of framing */
block|}
if|if
condition|(
operator|(
name|c
operator|->
name|gopt
operator|.
name|cas
operator|&&
operator|(
name|ssr
operator|&
name|SSR_SYNC_CAS
operator|)
operator|)
operator|||
operator|(
name|c
operator|->
name|gopt
operator|.
name|crc4
operator|&&
operator|(
name|ssr
operator|&
name|SSR_SYNC_CRC4
operator|)
operator|)
condition|)
block|{
name|c
operator|->
name|status
operator||=
name|ESTS_LOMF
expr_stmt|;
comment|/* loss of multiframing */
operator|++
name|oof
expr_stmt|;
comment|/* out of framing */
block|}
if|if
condition|(
operator|!
name|c
operator|->
name|status
condition|)
name|c
operator|->
name|status
operator|=
name|ESTS_NOALARM
expr_stmt|;
comment|/* Get error counters. */
name|bpv
operator|=
name|VCR
argument_list|(
name|cte_in
argument_list|(
name|port
argument_list|,
name|DS_VCR1
argument_list|)
argument_list|,
name|cte_in
argument_list|(
name|port
argument_list|,
name|DS_VCR2
argument_list|)
argument_list|)
expr_stmt|;
name|fas
operator|=
name|FASCR
argument_list|(
name|cte_in
argument_list|(
name|port
argument_list|,
name|DS_FASCR1
argument_list|)
argument_list|,
name|cte_in
argument_list|(
name|port
argument_list|,
name|DS_FASCR2
argument_list|)
argument_list|)
expr_stmt|;
name|crc4
operator|=
name|CRCCR
argument_list|(
name|cte_in
argument_list|(
name|port
argument_list|,
name|DS_CRCCR1
argument_list|)
argument_list|,
name|cte_in
argument_list|(
name|port
argument_list|,
name|DS_CRCCR2
argument_list|)
argument_list|)
expr_stmt|;
name|ebit
operator|=
name|EBCR
argument_list|(
name|cte_in
argument_list|(
name|port
argument_list|,
name|DS_EBCR1
argument_list|)
argument_list|,
name|cte_in
argument_list|(
name|port
argument_list|,
name|DS_EBCR2
argument_list|)
argument_list|)
expr_stmt|;
name|c
operator|->
name|currnt
operator|.
name|bpv
operator|+=
name|bpv
expr_stmt|;
name|c
operator|->
name|currnt
operator|.
name|fse
operator|+=
name|fas
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|gopt
operator|.
name|crc4
condition|)
block|{
name|c
operator|->
name|currnt
operator|.
name|crce
operator|+=
name|crc4
expr_stmt|;
name|c
operator|->
name|currnt
operator|.
name|rcrce
operator|+=
name|ebit
expr_stmt|;
block|}
comment|/* Path code violation is frame sync error if CRC4 disabled, 	 * or CRC error if CRC4 enabled. */
name|pcv
operator|=
name|fas
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|gopt
operator|.
name|crc4
condition|)
name|pcv
operator|+=
name|crc4
expr_stmt|;
comment|/* Unavaiable second -- receiving all ones, or 	 * loss of carrier, or loss of signal. */
if|if
condition|(
name|sr1
operator|&
operator|(
name|SR1_RUA1
operator||
name|SR1_RCL
operator||
name|SR1_RLOS
operator|)
condition|)
comment|/* Unavailable second -- no other counters. */
operator|++
name|c
operator|->
name|currnt
operator|.
name|uas
expr_stmt|;
else|else
block|{
comment|/* Line errored second -- any BPV. */
if|if
condition|(
name|bpv
condition|)
operator|++
name|c
operator|->
name|currnt
operator|.
name|les
expr_stmt|;
comment|/* Errored second -- any PCV, or out of frame sync, 		 * or any slip events. */
if|if
condition|(
name|pcv
operator|||
name|oof
operator|||
operator|(
name|sr1
operator|&
name|SR1_RSLIP
operator|)
condition|)
operator|++
name|c
operator|->
name|currnt
operator|.
name|es
expr_stmt|;
comment|/* Severely errored framing second -- out of frame sync. */
if|if
condition|(
name|oof
condition|)
operator|++
name|c
operator|->
name|currnt
operator|.
name|oofs
expr_stmt|;
comment|/* Severely errored seconds -- 		 * 832 or more PCVs, or 2048 or more BPVs. */
if|if
condition|(
name|bpv
operator|>=
literal|2048
operator|||
name|pcv
operator|>=
literal|832
condition|)
operator|++
name|c
operator|->
name|currnt
operator|.
name|ses
expr_stmt|;
else|else
block|{
comment|/* Bursty errored seconds -- 			 * no SES and more than 1 PCV. */
if|if
condition|(
name|pcv
operator|>
literal|1
condition|)
operator|++
name|c
operator|->
name|currnt
operator|.
name|bes
expr_stmt|;
comment|/* Collect data for computing 			 * degraded minutes. */
operator|++
name|c
operator|->
name|degsec
expr_stmt|;
name|c
operator|->
name|degerr
operator|+=
name|bpv
operator|+
name|pcv
expr_stmt|;
block|}
block|}
comment|/* Degraded minutes -- having error rate more than 10e-6, 	 * not counting unavailable and severely errored seconds. */
if|if
condition|(
name|c
operator|->
name|cursec
operator|/
literal|60
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|c
operator|->
name|degerr
operator|>
name|c
operator|->
name|degsec
operator|*
literal|2048
operator|/
literal|1000
condition|)
operator|++
name|c
operator|->
name|currnt
operator|.
name|dm
expr_stmt|;
name|c
operator|->
name|degsec
operator|=
literal|0
expr_stmt|;
name|c
operator|->
name|degerr
operator|=
literal|0
expr_stmt|;
block|}
comment|/* Rotate statistics every 15 minutes. */
if|if
condition|(
name|c
operator|->
name|cursec
operator|>
literal|15
operator|*
literal|60
condition|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|47
init|;
name|i
operator|>
literal|0
condition|;
operator|--
name|i
control|)
name|c
operator|->
name|interval
index|[
name|i
index|]
operator|=
name|c
operator|->
name|interval
index|[
name|i
operator|-
literal|1
index|]
expr_stmt|;
name|c
operator|->
name|interval
index|[
literal|0
index|]
operator|=
name|c
operator|->
name|currnt
expr_stmt|;
comment|/* Accumulate total statistics. */
name|c
operator|->
name|total
operator|.
name|bpv
operator|+=
name|c
operator|->
name|currnt
operator|.
name|bpv
expr_stmt|;
name|c
operator|->
name|total
operator|.
name|fse
operator|+=
name|c
operator|->
name|currnt
operator|.
name|fse
expr_stmt|;
name|c
operator|->
name|total
operator|.
name|crce
operator|+=
name|c
operator|->
name|currnt
operator|.
name|crce
expr_stmt|;
name|c
operator|->
name|total
operator|.
name|rcrce
operator|+=
name|c
operator|->
name|currnt
operator|.
name|rcrce
expr_stmt|;
name|c
operator|->
name|total
operator|.
name|uas
operator|+=
name|c
operator|->
name|currnt
operator|.
name|uas
expr_stmt|;
name|c
operator|->
name|total
operator|.
name|les
operator|+=
name|c
operator|->
name|currnt
operator|.
name|les
expr_stmt|;
name|c
operator|->
name|total
operator|.
name|es
operator|+=
name|c
operator|->
name|currnt
operator|.
name|es
expr_stmt|;
name|c
operator|->
name|total
operator|.
name|bes
operator|+=
name|c
operator|->
name|currnt
operator|.
name|bes
expr_stmt|;
name|c
operator|->
name|total
operator|.
name|ses
operator|+=
name|c
operator|->
name|currnt
operator|.
name|ses
expr_stmt|;
name|c
operator|->
name|total
operator|.
name|oofs
operator|+=
name|c
operator|->
name|currnt
operator|.
name|oofs
expr_stmt|;
name|c
operator|->
name|total
operator|.
name|css
operator|+=
name|c
operator|->
name|currnt
operator|.
name|css
expr_stmt|;
name|c
operator|->
name|total
operator|.
name|dm
operator|+=
name|c
operator|->
name|currnt
operator|.
name|dm
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|c
operator|->
name|currnt
argument_list|)
condition|;
operator|++
name|i
control|)
operator|*
operator|(
operator|(
operator|(
name|char
operator|*
operator|)
operator|(
operator|&
name|c
operator|->
name|currnt
operator|)
operator|)
operator|+
name|i
operator|)
operator|=
literal|0
expr_stmt|;
name|c
operator|->
name|totsec
operator|+=
name|c
operator|->
name|cursec
expr_stmt|;
name|c
operator|->
name|cursec
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ct_hdlc_interrupt
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|,
name|int
name|imvr
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|dsr
decl_stmt|,
name|st1
decl_stmt|,
name|st2
decl_stmt|,
name|cda
decl_stmt|;
switch|switch
condition|(
name|imvr
operator|&
name|IMVR_VECT_MASK
condition|)
block|{
case|case
name|IMVR_RX_DMOK
case|:
comment|/* receive DMA normal end */
name|dsr
operator|=
name|inb
argument_list|(
name|c
operator|->
name|RX
operator|.
name|DSR
argument_list|)
expr_stmt|;
name|cda
operator|=
name|inw
argument_list|(
name|c
operator|->
name|RX
operator|.
name|CDA
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NBUF
condition|;
operator|++
name|i
control|)
if|if
condition|(
name|cda
operator|==
operator|(
name|unsigned
name|short
operator|)
name|c
operator|->
name|rdphys
index|[
name|i
index|]
condition|)
break|break;
if|if
condition|(
name|i
operator|>=
name|NBUF
condition|)
name|i
operator|=
name|c
operator|->
name|rn
expr_stmt|;
comment|/* cannot happen */
while|while
condition|(
name|c
operator|->
name|rn
operator|!=
name|i
condition|)
block|{
name|int
name|cst
init|=
name|B_STATUS
argument_list|(
name|c
operator|->
name|rdesc
index|[
name|c
operator|->
name|rn
index|]
argument_list|)
decl_stmt|;
if|if
condition|(
name|cst
operator|==
name|FST_EOM
condition|)
block|{
comment|/* process data */
if|if
condition|(
name|c
operator|->
name|call_on_rx
condition|)
name|c
operator|->
name|call_on_rx
argument_list|(
name|c
argument_list|,
name|c
operator|->
name|rbuf
index|[
name|c
operator|->
name|rn
index|]
argument_list|,
name|B_LEN
argument_list|(
name|c
operator|->
name|rdesc
index|[
name|c
operator|->
name|rn
index|]
argument_list|)
argument_list|)
expr_stmt|;
operator|++
name|c
operator|->
name|ipkts
expr_stmt|;
name|c
operator|->
name|ibytes
operator|+=
name|B_LEN
argument_list|(
name|c
operator|->
name|rdesc
index|[
name|c
operator|->
name|rn
index|]
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cst
operator|&
name|ST2_OVRN
condition|)
block|{
comment|/* Receive overrun error */
if|if
condition|(
name|c
operator|->
name|call_on_err
condition|)
name|c
operator|->
name|call_on_err
argument_list|(
name|c
argument_list|,
name|CT_OVERRUN
argument_list|)
expr_stmt|;
operator|++
name|c
operator|->
name|ierrs
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cst
operator|&
operator|(
name|ST2_HDLC_RBIT
operator||
name|ST2_HDLC_ABT
operator||
name|ST2_HDLC_SHRT
operator|)
condition|)
block|{
comment|/* Receive frame error */
if|if
condition|(
name|c
operator|->
name|call_on_err
condition|)
name|c
operator|->
name|call_on_err
argument_list|(
name|c
argument_list|,
name|CT_FRAME
argument_list|)
expr_stmt|;
operator|++
name|c
operator|->
name|ierrs
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|cst
operator|&
name|ST2_HDLC_EOM
operator|)
operator|&&
operator|(
name|cst
operator|&
name|ST2_HDLC_CRCE
operator|)
condition|)
block|{
comment|/* Receive CRC error */
if|if
condition|(
name|c
operator|->
name|call_on_err
condition|)
name|c
operator|->
name|call_on_err
argument_list|(
name|c
argument_list|,
name|CT_CRC
argument_list|)
expr_stmt|;
operator|++
name|c
operator|->
name|ierrs
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
operator|(
name|cst
operator|&
name|ST2_HDLC_EOM
operator|)
condition|)
block|{
comment|/* Frame dose not fit in the buffer.*/
if|if
condition|(
name|c
operator|->
name|call_on_err
condition|)
name|c
operator|->
name|call_on_err
argument_list|(
name|c
argument_list|,
name|CT_OVERFLOW
argument_list|)
expr_stmt|;
operator|++
name|c
operator|->
name|ierrs
expr_stmt|;
block|}
name|B_NEXT
argument_list|(
name|c
operator|->
name|rdesc
index|[
name|c
operator|->
name|rn
index|]
argument_list|)
operator|=
name|c
operator|->
name|rdphys
index|[
operator|(
name|c
operator|->
name|rn
operator|+
literal|1
operator|)
operator|%
name|NBUF
index|]
operator|&
literal|0xffff
expr_stmt|;
name|B_PTR
argument_list|(
name|c
operator|->
name|rdesc
index|[
name|c
operator|->
name|rn
index|]
argument_list|)
operator|=
name|c
operator|->
name|rphys
index|[
name|c
operator|->
name|rn
index|]
expr_stmt|;
name|B_LEN
argument_list|(
name|c
operator|->
name|rdesc
index|[
name|c
operator|->
name|rn
index|]
argument_list|)
operator|=
name|DMABUFSZ
expr_stmt|;
name|B_STATUS
argument_list|(
name|c
operator|->
name|rdesc
index|[
name|c
operator|->
name|rn
index|]
argument_list|)
operator|=
literal|0
expr_stmt|;
name|c
operator|->
name|rn
operator|=
operator|(
name|c
operator|->
name|rn
operator|+
literal|1
operator|)
operator|%
name|NBUF
expr_stmt|;
block|}
name|outw
argument_list|(
name|c
operator|->
name|RX
operator|.
name|EDA
argument_list|,
operator|(
name|unsigned
name|short
operator|)
name|c
operator|->
name|rdphys
index|[
operator|(
name|i
operator|+
name|NBUF
operator|-
literal|1
operator|)
operator|%
name|NBUF
index|]
argument_list|)
expr_stmt|;
comment|/* Clear DMA interrupt. */
if|if
condition|(
name|inb
argument_list|(
name|c
operator|->
name|RX
operator|.
name|DSR
argument_list|)
operator|&
name|DSR_DMA_ENABLE
condition|)
block|{
name|outb
argument_list|(
name|c
operator|->
name|RX
operator|.
name|DSR
argument_list|,
name|dsr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|outb
argument_list|(
name|c
operator|->
name|RX
operator|.
name|DSR
argument_list|,
operator|(
name|dsr
operator|&
literal|0xfc
operator|)
operator||
name|DSR_DMA_ENABLE
argument_list|)
expr_stmt|;
block|}
operator|++
name|c
operator|->
name|rintr
expr_stmt|;
break|break;
case|case
name|IMVR_RX_INT
case|:
comment|/* receive status */
name|st1
operator|=
name|inb
argument_list|(
name|c
operator|->
name|ST1
argument_list|)
expr_stmt|;
name|st2
operator|=
name|inb
argument_list|(
name|c
operator|->
name|ST2
argument_list|)
expr_stmt|;
if|if
condition|(
name|st1
operator|&
name|ST1_CDCD
condition|)
block|{
if|if
condition|(
name|c
operator|->
name|call_on_msig
condition|)
name|c
operator|->
name|call_on_msig
argument_list|(
name|c
argument_list|)
expr_stmt|;
operator|++
name|c
operator|->
name|mintr
expr_stmt|;
block|}
comment|/* Clear interrupt. */
name|outb
argument_list|(
name|c
operator|->
name|ST1
argument_list|,
name|st1
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|c
operator|->
name|ST2
argument_list|,
name|st2
argument_list|)
expr_stmt|;
operator|++
name|c
operator|->
name|rintr
expr_stmt|;
break|break;
case|case
name|IMVR_RX_DMERR
case|:
comment|/* receive DMA error */
name|dsr
operator|=
name|inb
argument_list|(
name|c
operator|->
name|RX
operator|.
name|DSR
argument_list|)
expr_stmt|;
if|if
condition|(
name|dsr
operator|&
operator|(
name|DSR_CHAIN_BOF
operator||
name|DSR_CHAIN_COF
operator|)
condition|)
block|{
if|if
condition|(
name|c
operator|->
name|call_on_err
condition|)
name|c
operator|->
name|call_on_err
argument_list|(
name|c
argument_list|,
name|CT_OVERFLOW
argument_list|)
expr_stmt|;
operator|++
name|c
operator|->
name|ierrs
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NBUF
condition|;
operator|++
name|i
control|)
block|{
name|B_LEN
argument_list|(
name|c
operator|->
name|rdesc
index|[
name|i
index|]
argument_list|)
operator|=
name|DMABUFSZ
expr_stmt|;
name|B_STATUS
argument_list|(
name|c
operator|->
name|rdesc
index|[
name|i
index|]
argument_list|)
operator|=
literal|0
expr_stmt|;
block|}
name|ct_start_receiver
argument_list|(
name|c
argument_list|,
literal|1
argument_list|,
name|c
operator|->
name|rphys
index|[
literal|0
index|]
argument_list|,
name|DMABUFSZ
argument_list|,
name|c
operator|->
name|rdphys
index|[
literal|0
index|]
argument_list|,
name|c
operator|->
name|rdphys
index|[
name|NBUF
operator|-
literal|1
index|]
argument_list|)
expr_stmt|;
name|c
operator|->
name|rn
operator|=
literal|0
expr_stmt|;
block|}
comment|/* Clear DMA interrupt. */
name|outb
argument_list|(
name|c
operator|->
name|RX
operator|.
name|DSR
argument_list|,
name|dsr
argument_list|)
expr_stmt|;
operator|++
name|c
operator|->
name|rintr
expr_stmt|;
break|break;
case|case
name|IMVR_TX_DMOK
case|:
comment|/* transmit DMA normal end */
case|case
name|IMVR_TX_DMERR
case|:
comment|/* transmit DMA error	   */
name|dsr
operator|=
name|inb
argument_list|(
name|c
operator|->
name|TX
operator|.
name|DSR
argument_list|)
expr_stmt|;
name|cda
operator|=
name|inw
argument_list|(
name|c
operator|->
name|TX
operator|.
name|CDA
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NBUF
operator|&&
name|cda
operator|!=
operator|(
name|unsigned
name|short
operator|)
name|c
operator|->
name|tdphys
index|[
name|i
index|]
condition|;
operator|++
name|i
control|)
continue|continue;
if|if
condition|(
name|i
operator|>=
name|NBUF
condition|)
name|i
operator|=
literal|1
expr_stmt|;
comment|/* cannot happen */
if|if
condition|(
name|dsr
operator|&
name|DSR_CHAIN_COF
condition|)
block|{
if|if
condition|(
name|c
operator|->
name|call_on_err
condition|)
name|c
operator|->
name|call_on_err
argument_list|(
name|c
argument_list|,
name|CT_UNDERRUN
argument_list|)
expr_stmt|;
operator|++
name|c
operator|->
name|oerrs
expr_stmt|;
block|}
while|while
condition|(
name|c
operator|->
name|tn
operator|!=
name|i
condition|)
block|{
if|if
condition|(
name|c
operator|->
name|call_on_tx
condition|)
name|c
operator|->
name|call_on_tx
argument_list|(
name|c
argument_list|,
name|c
operator|->
name|attach
index|[
name|c
operator|->
name|tn
index|]
argument_list|,
name|B_LEN
argument_list|(
name|c
operator|->
name|tdesc
index|[
name|c
operator|->
name|tn
index|]
argument_list|)
argument_list|)
expr_stmt|;
operator|++
name|c
operator|->
name|opkts
expr_stmt|;
name|c
operator|->
name|obytes
operator|+=
name|B_LEN
argument_list|(
name|c
operator|->
name|tdesc
index|[
name|c
operator|->
name|tn
index|]
argument_list|)
expr_stmt|;
name|c
operator|->
name|tn
operator|=
operator|(
name|c
operator|->
name|tn
operator|+
literal|1
operator|)
operator|%
name|NBUF
expr_stmt|;
comment|/* Clear DMA interrupt. */
name|outb
argument_list|(
name|c
operator|->
name|TX
operator|.
name|DSR
argument_list|,
name|DSR_CHAIN_EOM
operator||
name|DSR_DMA_CONTINUE
argument_list|)
expr_stmt|;
block|}
name|outb
argument_list|(
name|c
operator|->
name|TX
operator|.
name|DSR
argument_list|,
name|dsr
operator|&
operator|~
name|DSR_CHAIN_EOM
argument_list|)
expr_stmt|;
operator|++
name|c
operator|->
name|tintr
expr_stmt|;
break|break;
case|case
name|IMVR_TX_INT
case|:
comment|/* transmit error, HDLC only */
name|st1
operator|=
name|inb
argument_list|(
name|c
operator|->
name|ST1
argument_list|)
expr_stmt|;
if|if
condition|(
name|st1
operator|&
name|ST1_HDLC_UDRN
condition|)
block|{
if|if
condition|(
name|c
operator|->
name|call_on_err
condition|)
name|c
operator|->
name|call_on_err
argument_list|(
name|c
argument_list|,
name|CT_UNDERRUN
argument_list|)
expr_stmt|;
operator|++
name|c
operator|->
name|oerrs
expr_stmt|;
block|}
name|outb
argument_list|(
name|c
operator|->
name|ST1
argument_list|,
name|st1
argument_list|)
expr_stmt|;
operator|++
name|c
operator|->
name|tintr
expr_stmt|;
break|break;
default|default:
comment|/* Unknown interrupt - cannot happen. */
break|break;
block|}
block|}
end_function

begin_function
name|int
name|ct_receive_enabled
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|)
block|{
name|int
name|st3
decl_stmt|;
name|st3
operator|=
name|inb
argument_list|(
name|c
operator|->
name|ST3
argument_list|)
expr_stmt|;
return|return
operator|(
name|st3
operator|&
name|ST3_RX_ENABLED
operator|)
condition|?
literal|1
else|:
literal|0
return|;
block|}
end_function

begin_function
name|int
name|ct_transmit_enabled
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|)
block|{
name|int
name|st3
decl_stmt|;
name|st3
operator|=
name|inb
argument_list|(
name|c
operator|->
name|ST3
argument_list|)
expr_stmt|;
return|return
operator|(
name|st3
operator|&
name|ST3_TX_ENABLED
operator|)
condition|?
literal|1
else|:
literal|0
return|;
block|}
end_function

begin_function
name|int
name|ct_buf_free
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|)
block|{
return|return
operator|(
name|NBUF
operator|+
name|c
operator|->
name|tn
operator|-
name|c
operator|->
name|te
operator|-
literal|1
operator|)
operator|%
name|NBUF
return|;
block|}
end_function

begin_function
name|int
name|ct_send_packet
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|,
name|unsigned
name|char
modifier|*
name|data
parameter_list|,
name|int
name|len
parameter_list|,
name|void
modifier|*
name|attachment
parameter_list|)
block|{
name|int
name|dsr
decl_stmt|,
name|ne
decl_stmt|;
if|if
condition|(
name|len
operator|>
name|DMABUFSZ
condition|)
return|return
operator|-
literal|2
return|;
comment|/* Is it really free? */
name|ne
operator|=
operator|(
name|c
operator|->
name|te
operator|+
literal|1
operator|)
operator|%
name|NBUF
expr_stmt|;
if|if
condition|(
name|ne
operator|==
name|c
operator|->
name|tn
condition|)
return|return
operator|-
literal|1
return|;
comment|/* Set up the tx descriptor. */
name|B_LEN
argument_list|(
name|c
operator|->
name|tdesc
index|[
name|c
operator|->
name|te
index|]
argument_list|)
operator|=
name|len
expr_stmt|;
name|B_STATUS
argument_list|(
name|c
operator|->
name|tdesc
index|[
name|c
operator|->
name|te
index|]
argument_list|)
operator|=
name|FST_EOM
expr_stmt|;
name|c
operator|->
name|attach
index|[
name|c
operator|->
name|te
index|]
operator|=
name|attachment
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|tbuf
index|[
name|c
operator|->
name|te
index|]
operator|!=
name|data
condition|)
name|memcpy
argument_list|(
name|c
operator|->
name|tbuf
index|[
name|c
operator|->
name|te
index|]
argument_list|,
name|data
argument_list|,
name|len
argument_list|)
expr_stmt|;
comment|/* Start the transmitter. */
name|c
operator|->
name|te
operator|=
name|ne
expr_stmt|;
name|outw
argument_list|(
name|c
operator|->
name|TX
operator|.
name|EDA
argument_list|,
operator|(
name|unsigned
name|short
operator|)
name|c
operator|->
name|tdphys
index|[
name|ne
index|]
argument_list|)
expr_stmt|;
name|dsr
operator|=
name|inb
argument_list|(
name|c
operator|->
name|TX
operator|.
name|DSR
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|dsr
operator|&
name|DSR_DMA_ENABLE
operator|)
condition|)
name|outb
argument_list|(
name|c
operator|->
name|TX
operator|.
name|DSR
argument_list|,
name|DSR_DMA_ENABLE
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|scc_write
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|,
name|unsigned
name|char
modifier|*
name|d
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|free
decl_stmt|;
comment|/* determining free place in buffer */
if|if
condition|(
name|c
operator|->
name|scctx_empty
condition|)
name|free
operator|=
name|SCCBUFSZ
expr_stmt|;
else|else
name|free
operator|=
operator|(
name|SCCBUFSZ
operator|+
name|c
operator|->
name|scctx_b
operator|-
name|c
operator|->
name|scctx_e
operator|)
operator|%
name|SCCBUFSZ
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|free
condition|)
return|return
operator|-
literal|1
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
block|{
name|c
operator|->
name|scctx
index|[
name|c
operator|->
name|scctx_e
index|]
operator|=
name|d
index|[
name|i
index|]
expr_stmt|;
name|c
operator|->
name|scctx_e
operator|=
operator|(
name|c
operator|->
name|scctx_e
operator|+
literal|1
operator|)
operator|%
name|SCCBUFSZ
expr_stmt|;
block|}
if|if
condition|(
name|c
operator|->
name|scctx_empty
operator|&&
name|len
condition|)
block|{
name|cte_out2d
argument_list|(
name|c
argument_list|,
name|c
operator|->
name|scctx
index|[
name|c
operator|->
name|scctx_b
index|]
argument_list|)
expr_stmt|;
name|c
operator|->
name|scctx_empty
operator|=
literal|0
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|scc_read
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|,
name|unsigned
name|char
modifier|*
name|d
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|bytes
decl_stmt|;
if|if
condition|(
name|c
operator|->
name|sccrx_empty
condition|)
name|bytes
operator|=
literal|0
expr_stmt|;
else|else
name|bytes
operator|=
operator|(
name|SCCBUFSZ
operator|+
name|c
operator|->
name|sccrx_e
operator|-
literal|1
operator|-
name|c
operator|->
name|sccrx_b
operator|)
operator|%
name|SCCBUFSZ
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|bytes
condition|)
return|return
operator|-
literal|1
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
block|{
name|d
index|[
name|i
index|]
operator|=
name|c
operator|->
name|sccrx
index|[
name|c
operator|->
name|sccrx_b
index|]
expr_stmt|;
name|c
operator|->
name|sccrx_b
operator|=
operator|(
name|c
operator|->
name|sccrx_b
operator|+
literal|1
operator|)
operator|%
name|SCCBUFSZ
expr_stmt|;
block|}
if|if
condition|(
name|c
operator|->
name|sccrx_b
operator|==
name|c
operator|->
name|sccrx_e
condition|)
name|c
operator|->
name|sccrx_empty
operator|=
literal|1
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|sccrx_check
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|)
block|{
name|int
name|bytes
decl_stmt|;
if|if
condition|(
name|c
operator|->
name|sccrx_empty
condition|)
name|bytes
operator|=
literal|0
expr_stmt|;
else|else
name|bytes
operator|=
operator|(
name|SCCBUFSZ
operator|+
name|c
operator|->
name|sccrx_e
operator|-
literal|1
operator|-
name|c
operator|->
name|sccrx_b
operator|)
operator|%
name|SCCBUFSZ
operator|+
literal|1
expr_stmt|;
return|return
name|bytes
return|;
block|}
end_function

begin_function
name|int
name|scc_read_byte
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|)
block|{
name|unsigned
name|char
name|a
decl_stmt|;
if|if
condition|(
name|scc_read
argument_list|(
name|c
argument_list|,
operator|&
name|a
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|a
return|;
block|}
end_function

begin_function
name|int
name|scc_write_byte
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|,
name|unsigned
name|char
name|b
parameter_list|)
block|{
if|if
condition|(
name|scc_write
argument_list|(
name|c
argument_list|,
operator|&
name|b
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|b
return|;
block|}
end_function

begin_comment
comment|/*  * Register event processing functions  */
end_comment

begin_function
name|void
name|ct_register_transmit
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|,
name|void
function_decl|(
modifier|*
name|func
function_decl|)
parameter_list|(
name|ct_chan_t
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|,
name|int
parameter_list|)
parameter_list|)
block|{
name|c
operator|->
name|call_on_tx
operator|=
name|func
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ct_register_receive
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|,
name|void
function_decl|(
modifier|*
name|func
function_decl|)
parameter_list|(
name|ct_chan_t
modifier|*
parameter_list|,
name|char
modifier|*
parameter_list|,
name|int
parameter_list|)
parameter_list|)
block|{
name|c
operator|->
name|call_on_rx
operator|=
name|func
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ct_register_error
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|,
name|void
function_decl|(
modifier|*
name|func
function_decl|)
parameter_list|(
name|ct_chan_t
modifier|*
parameter_list|,
name|int
parameter_list|)
parameter_list|)
block|{
name|c
operator|->
name|call_on_err
operator|=
name|func
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ct_register_scc
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|,
name|void
function_decl|(
modifier|*
name|func
function_decl|)
parameter_list|(
name|ct_chan_t
modifier|*
parameter_list|)
parameter_list|)
block|{
name|c
operator|->
name|call_on_scc
operator|=
name|func
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ct_register_modem
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|,
name|void
function_decl|(
modifier|*
name|func
function_decl|)
parameter_list|(
name|ct_chan_t
modifier|*
parameter_list|)
parameter_list|)
block|{
name|c
operator|->
name|call_on_msig
operator|=
name|func
expr_stmt|;
block|}
end_function

end_unit


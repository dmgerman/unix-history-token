begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Low-level subroutines for Cronyx-Tau adapter.  *  * Copyright (C) 1994-2001 Cronyx Engineering.  * Author: Serge Vakulenko,<vak@cronyx.ru>  *  * Copyright (C) 2003 Cronyx Engineering.  * Author: Roman Kurakin,<rik@cronyx.ru>  *  * This software is distributed with NO WARRANTIES, not even the implied  * warranties for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  *  * Authors grant any other persons or organisations permission to use  * or modify this software as long as this message is kept with the software,  * all derivative works or modified versions.  *  * Cronyx Id: ctau.c,v 1.1.2.4 2003/12/11 17:33:43 rik Exp $  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/cx/machdep.h>
end_include

begin_include
include|#
directive|include
file|<dev/ctau/ctddk.h>
end_include

begin_include
include|#
directive|include
file|<dev/ctau/ctaureg.h>
end_include

begin_include
include|#
directive|include
file|<dev/ctau/hdc64570.h>
end_include

begin_include
include|#
directive|include
file|<dev/ctau/ds2153.h>
end_include

begin_include
include|#
directive|include
file|<dev/ctau/am8530.h>
end_include

begin_include
include|#
directive|include
file|<dev/ctau/lxt318.h>
end_include

begin_include
include|#
directive|include
file|<dev/cx/cronyxfw.h>
end_include

begin_define
define|#
directive|define
name|DMA_MASK
value|0xd4
end_define

begin_comment
comment|/* DMA mask register */
end_comment

begin_define
define|#
directive|define
name|DMA_MASK_CLEAR
value|0x04
end_define

begin_comment
comment|/* DMA clear mask */
end_comment

begin_define
define|#
directive|define
name|DMA_MODE
value|0xd6
end_define

begin_comment
comment|/* DMA mode register */
end_comment

begin_define
define|#
directive|define
name|DMA_MODE_MASTER
value|0xc0
end_define

begin_comment
comment|/* DMA master mode */
end_comment

begin_define
define|#
directive|define
name|BYTE
value|*(unsigned char*)&
end_define

begin_decl_stmt
specifier|static
name|unsigned
name|char
name|irqmask
index|[]
init|=
block|{
name|BCR0_IRQ_DIS
block|,
name|BCR0_IRQ_DIS
block|,
name|BCR0_IRQ_DIS
block|,
name|BCR0_IRQ_3
block|,
name|BCR0_IRQ_DIS
block|,
name|BCR0_IRQ_5
block|,
name|BCR0_IRQ_DIS
block|,
name|BCR0_IRQ_7
block|,
name|BCR0_IRQ_DIS
block|,
name|BCR0_IRQ_DIS
block|,
name|BCR0_IRQ_10
block|,
name|BCR0_IRQ_11
block|,
name|BCR0_IRQ_12
block|,
name|BCR0_IRQ_DIS
block|,
name|BCR0_IRQ_DIS
block|,
name|BCR0_IRQ_15
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|char
name|dmamask
index|[]
init|=
block|{
name|BCR0_DMA_DIS
block|,
name|BCR0_DMA_DIS
block|,
name|BCR0_DMA_DIS
block|,
name|BCR0_DMA_DIS
block|,
name|BCR0_DMA_DIS
block|,
name|BCR0_DMA_5
block|,
name|BCR0_DMA_6
block|,
name|BCR0_DMA_7
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|short
name|porttab
index|[]
init|=
block|{
comment|/* standard base port set */
literal|0x200
block|,
literal|0x220
block|,
literal|0x240
block|,
literal|0x260
block|,
literal|0x280
block|,
literal|0x2a0
block|,
literal|0x2c0
block|,
literal|0x2e0
block|,
literal|0x300
block|,
literal|0x320
block|,
literal|0x340
block|,
literal|0x360
block|,
literal|0x380
block|,
literal|0x3a0
block|,
literal|0x3c0
block|,
literal|0x3e0
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|short
name|irqtab
index|[]
init|=
block|{
literal|3
block|,
literal|5
block|,
literal|7
block|,
literal|10
block|,
literal|11
block|,
literal|12
block|,
literal|15
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|short
name|dmatab
index|[]
init|=
block|{
literal|5
block|,
literal|6
block|,
literal|7
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|valid
parameter_list|(
name|short
name|value
parameter_list|,
name|short
modifier|*
name|list
parameter_list|)
block|{
while|while
condition|(
operator|*
name|list
condition|)
if|if
condition|(
name|value
operator|==
operator|*
name|list
operator|++
condition|)
return|return
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_decl_stmt
name|long
name|ct_baud
init|=
literal|256000
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* default baud rate */
end_comment

begin_decl_stmt
name|unsigned
name|char
name|ct_chan_mode
init|=
name|M_HDLC
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* default mode */
end_comment

begin_function_decl
specifier|static
name|void
name|ct_init_chan
parameter_list|(
name|ct_board_t
modifier|*
name|b
parameter_list|,
name|int
name|num
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ct_enable_loop
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ct_disable_loop
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|int
name|ct_download
parameter_list|(
name|port_t
name|port
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|firmware
parameter_list|,
name|long
name|bits
parameter_list|,
specifier|const
name|cr_dat_tst_t
modifier|*
name|tst
parameter_list|)
block|{
name|unsigned
name|char
name|cr1
decl_stmt|,
name|sr2
decl_stmt|;
name|long
name|i
decl_stmt|,
name|n
decl_stmt|,
name|maxn
init|=
operator|(
name|bits
operator|+
literal|7
operator|)
operator|>>
literal|3
decl_stmt|;
name|int
name|v
decl_stmt|,
name|b
decl_stmt|;
name|inb
argument_list|(
name|BSR3
argument_list|(
name|port
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|maxn
condition|;
operator|++
name|n
control|)
block|{
name|v
operator|=
operator|(
operator|(
name|firmware
index|[
name|n
index|]
operator|^
literal|' '
operator|)
operator|<<
literal|1
operator|)
operator||
operator|(
operator|(
name|firmware
index|[
name|n
index|]
operator|>>
literal|7
operator|)
operator|&
literal|1
operator|)
expr_stmt|;
for|for
control|(
name|b
operator|=
literal|0
init|;
name|b
operator|<
literal|7
condition|;
name|b
operator|+=
literal|2
operator|,
name|i
operator|+=
literal|2
control|)
block|{
if|if
condition|(
name|i
operator|>=
name|bits
condition|)
break|break;
name|cr1
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|v
operator|>>
name|b
operator|&
literal|1
condition|)
name|cr1
operator||=
name|BCR1_TMS
expr_stmt|;
if|if
condition|(
name|v
operator|>>
name|b
operator|&
literal|2
condition|)
name|cr1
operator||=
name|BCR1_TDI
expr_stmt|;
name|outb
argument_list|(
name|BCR1
argument_list|(
name|port
argument_list|)
argument_list|,
name|cr1
argument_list|)
expr_stmt|;
name|sr2
operator|=
name|inb
argument_list|(
name|BSR2
argument_list|(
name|port
argument_list|)
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|BCR0
argument_list|(
name|port
argument_list|)
argument_list|,
name|BCR0_TCK
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|BCR0
argument_list|(
name|port
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|>=
name|tst
operator|->
name|end
condition|)
operator|++
name|tst
expr_stmt|;
if|if
condition|(
name|i
operator|>=
name|tst
operator|->
name|start
operator|&&
operator|(
name|sr2
operator|&
name|BSR2_LERR
operator|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Firmware unpack algorithm.  */
end_comment

begin_typedef
typedef|typedef
struct|struct
block|{
specifier|const
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|;
name|unsigned
name|char
name|byte
decl_stmt|;
name|unsigned
name|char
name|count
decl_stmt|;
block|}
name|unpack_t
typedef|;
end_typedef

begin_function
specifier|static
name|unsigned
name|short
name|unpack_init
parameter_list|(
name|unpack_t
modifier|*
name|t
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|ptr
parameter_list|)
block|{
name|unsigned
name|short
name|len
decl_stmt|;
name|len
operator|=
operator|*
name|ptr
operator|++
expr_stmt|;
name|len
operator||=
operator|*
name|ptr
operator|++
operator|<<
literal|8
expr_stmt|;
name|t
operator|->
name|ptr
operator|=
name|ptr
expr_stmt|;
name|t
operator|->
name|byte
operator|=
literal|0
expr_stmt|;
name|t
operator|->
name|count
operator|=
literal|0
expr_stmt|;
return|return
name|len
return|;
block|}
end_function

begin_function
specifier|static
name|unsigned
name|char
name|unpack_getchar
parameter_list|(
name|unpack_t
modifier|*
name|t
parameter_list|)
block|{
if|if
condition|(
name|t
operator|->
name|count
operator|>
literal|0
condition|)
block|{
operator|--
name|t
operator|->
name|count
expr_stmt|;
return|return
name|t
operator|->
name|byte
return|;
block|}
name|t
operator|->
name|byte
operator|=
operator|*
name|t
operator|->
name|ptr
operator|++
expr_stmt|;
if|if
condition|(
name|t
operator|->
name|byte
operator|==
literal|0
condition|)
name|t
operator|->
name|count
operator|=
operator|*
name|t
operator|->
name|ptr
operator|++
expr_stmt|;
return|return
name|t
operator|->
name|byte
return|;
block|}
end_function

begin_comment
comment|/*  * Firmware download signals.  */
end_comment

begin_define
define|#
directive|define
name|nstatus
parameter_list|(
name|b
parameter_list|)
value|(inb(BSR3(b))& BSR3_NSTATUS)
end_define

begin_define
define|#
directive|define
name|confdone
parameter_list|(
name|b
parameter_list|)
value|(inb(BSR3(b))& BSR3_CONF_DN)
end_define

begin_define
define|#
directive|define
name|nconfig_set
parameter_list|(
name|b
parameter_list|)
value|outb (bcr1_port, (bcr1&= ~BCR1_NCONFIGI))
end_define

begin_define
define|#
directive|define
name|nconfig_clr
parameter_list|(
name|b
parameter_list|)
value|outb (bcr1_port, (bcr1 |= BCR1_NCONFIGI))
end_define

begin_define
define|#
directive|define
name|dclk_tick
parameter_list|(
name|b
parameter_list|)
value|outb (BCR3(b), 0)
end_define

begin_define
define|#
directive|define
name|putbit
parameter_list|(
name|b
parameter_list|,
name|bit
parameter_list|)
value|{ if (bit) bcr1 |= BCR1_1KDAT; \ 			else bcr1&= ~BCR1_1KDAT; \ 			outb (bcr1_port, bcr1); \ 			dclk_tick (b); }
end_define

begin_define
define|#
directive|define
name|DEBUG
parameter_list|(
name|x
parameter_list|)
end_define

begin_comment
comment|/*trace_str x*/
end_comment

begin_function
name|int
name|ct_download2
parameter_list|(
name|port_t
name|port
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|fwaddr
parameter_list|)
block|{
name|unsigned
name|short
name|bytes
decl_stmt|;
name|unsigned
name|char
name|bcr1
decl_stmt|,
name|val
decl_stmt|;
name|port_t
name|bcr1_port
decl_stmt|;
name|unpack_t
name|t
decl_stmt|;
comment|/* 	 * Set NCONFIG and wait until NSTATUS is set. 	 */
name|bcr1_port
operator|=
name|BCR1
argument_list|(
name|port
argument_list|)
expr_stmt|;
name|bcr1
operator|=
literal|0
expr_stmt|;
name|nconfig_set
argument_list|(
name|port
argument_list|)
expr_stmt|;
for|for
control|(
name|val
operator|=
literal|0
init|;
name|val
operator|<
literal|255
condition|;
operator|++
name|val
control|)
if|if
condition|(
name|nstatus
argument_list|(
name|port
argument_list|)
condition|)
break|break;
comment|/* 	 * Clear NCONFIG, wait 2 usec and check that NSTATUS is cleared. 	 */
name|nconfig_clr
argument_list|(
name|port
argument_list|)
expr_stmt|;
for|for
control|(
name|val
operator|=
literal|0
init|;
name|val
operator|<
literal|2
operator|*
literal|3
condition|;
operator|++
name|val
control|)
name|nconfig_clr
argument_list|(
name|port
argument_list|)
expr_stmt|;
if|if
condition|(
name|nstatus
argument_list|(
name|port
argument_list|)
condition|)
block|{
name|DEBUG
argument_list|(
operator|(
literal|"Bad nstatus, downloading aborted (bsr3=0x%x).\n"
operator|,
name|inb
argument_list|(
name|BSR3
argument_list|(
name|port
argument_list|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|nconfig_set
argument_list|(
name|port
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* 	 * Set NCONFIG and wait 5 usec. 	 */
name|nconfig_set
argument_list|(
name|port
argument_list|)
expr_stmt|;
for|for
control|(
name|val
operator|=
literal|0
init|;
name|val
operator|<
literal|5
operator|*
literal|3
condition|;
operator|++
name|val
control|)
comment|/* Delay 5 msec. */
name|nconfig_set
argument_list|(
name|port
argument_list|)
expr_stmt|;
comment|/* 	 * ó ÁÄÒÅÓÁ `fwaddr' × ÐÁÍÑÔÉ ÄÏÌÖÎÙ ÌÅÖÁÔØ ÕÐÁËÏ×ÁÎÎÙÅ ÄÁÎÎÙÅ 	 * ÄÌÑ ÚÁÇÒÕÚËÉ firmware. úÎÁÞÅÎÉÅ ÄÏÌÖÎÏ ÂÙÔØ ÓÏÇÌÁÓÏ×ÁÎÏ Ó ÐÁÒÁÍÅÔÒÏÍ 	 * ×ÙÚÏ×Á ÕÔÉÌÉÔÙ `megaprog' × ÓËÒÉÐÔÅ ÚÁÇÒÕÚËÉ (É Makefile). 	 */
name|bytes
operator|=
name|unpack_init
argument_list|(
operator|&
name|t
argument_list|,
name|fwaddr
argument_list|)
expr_stmt|;
for|for
control|(
init|;
name|bytes
operator|>
literal|0
condition|;
operator|--
name|bytes
control|)
block|{
name|val
operator|=
name|unpack_getchar
argument_list|(
operator|&
name|t
argument_list|)
expr_stmt|;
if|if
condition|(
name|nstatus
argument_list|(
name|port
argument_list|)
operator|==
literal|0
condition|)
block|{
name|DEBUG
argument_list|(
operator|(
literal|"Bad nstatus, %d bytes remaining.\n"
operator|,
name|bytes
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|failed
goto|;
block|}
if|if
condition|(
name|confdone
argument_list|(
name|port
argument_list|)
condition|)
block|{
comment|/* Ten extra clocks. Hope 50 is enough. */
for|for
control|(
name|val
operator|=
literal|0
init|;
name|val
operator|<
literal|50
condition|;
operator|++
name|val
control|)
name|dclk_tick
argument_list|(
name|port
argument_list|)
expr_stmt|;
if|if
condition|(
name|nstatus
argument_list|(
name|port
argument_list|)
operator|==
literal|0
condition|)
block|{
name|DEBUG
argument_list|(
operator|(
literal|"Bad nstatus after confdone, %d bytes remaining (%d).\n"
operator|,
name|bytes
operator|,
name|t
operator|.
name|ptr
operator|-
name|fwaddr
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|failed
goto|;
block|}
comment|/* Succeeded. */
comment|/*DEBUG (("Download succeeded.\n"));*/
return|return
literal|1
return|;
block|}
name|putbit
argument_list|(
name|port
argument_list|,
name|val
operator|&
literal|0x01
argument_list|)
expr_stmt|;
name|putbit
argument_list|(
name|port
argument_list|,
name|val
operator|&
literal|0x02
argument_list|)
expr_stmt|;
name|putbit
argument_list|(
name|port
argument_list|,
name|val
operator|&
literal|0x04
argument_list|)
expr_stmt|;
name|putbit
argument_list|(
name|port
argument_list|,
name|val
operator|&
literal|0x08
argument_list|)
expr_stmt|;
name|putbit
argument_list|(
name|port
argument_list|,
name|val
operator|&
literal|0x10
argument_list|)
expr_stmt|;
name|putbit
argument_list|(
name|port
argument_list|,
name|val
operator|&
literal|0x20
argument_list|)
expr_stmt|;
name|putbit
argument_list|(
name|port
argument_list|,
name|val
operator|&
literal|0x40
argument_list|)
expr_stmt|;
name|putbit
argument_list|(
name|port
argument_list|,
name|val
operator|&
literal|0x80
argument_list|)
expr_stmt|;
comment|/* if ((bytes& 1023) == 0) putch ('.'); */
block|}
name|DEBUG
argument_list|(
operator|(
literal|"Bad confdone.\n"
operator|)
argument_list|)
expr_stmt|;
name|failed
label|:
name|DEBUG
argument_list|(
operator|(
literal|"Downloading aborted.\n"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Detect Tau2 adapter.  */
end_comment

begin_function
specifier|static
name|int
name|ct_probe2_board
parameter_list|(
name|port_t
name|port
parameter_list|)
block|{
name|unsigned
name|char
name|sr3
decl_stmt|,
name|osr3
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|valid
argument_list|(
name|port
argument_list|,
name|porttab
argument_list|)
condition|)
return|return
literal|0
return|;
name|osr3
operator|=
name|inb
argument_list|(
name|BSR3
argument_list|(
name|port
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|osr3
operator|&
operator|(
name|BSR3_IB
operator||
name|BSR3_IB_NEG
operator|)
operator|)
operator|!=
name|BSR3_IB
operator|&&
operator|(
name|osr3
operator|&
operator|(
name|BSR3_IB
operator||
name|BSR3_IB_NEG
operator|)
operator|)
operator|!=
name|BSR3_IB_NEG
condition|)
return|return
operator|(
literal|0
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|100
condition|;
operator|++
name|i
control|)
block|{
comment|/* Do it twice */
name|sr3
operator|=
name|inb
argument_list|(
name|BSR3
argument_list|(
name|port
argument_list|)
argument_list|)
expr_stmt|;
name|sr3
operator|=
name|inb
argument_list|(
name|BSR3
argument_list|(
name|port
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|sr3
operator|^
name|osr3
operator|)
operator|&
operator|(
name|BSR3_IB
operator||
name|BSR3_IB_NEG
operator||
name|BSR3_ZERO
operator|)
operator|)
operator|!=
operator|(
name|BSR3_IB
operator||
name|BSR3_IB_NEG
operator|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|osr3
operator|=
name|sr3
expr_stmt|;
block|}
comment|/* Reset the controller. */
name|outb
argument_list|(
name|BCR0
argument_list|(
name|port
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/*  * Check if the Tau board is present at the given base port.  * Read board status register 1 and check identification bits  * which should invert every next read.  * The "zero" bit should remain stable.  */
end_comment

begin_function
name|int
name|ct_probe_board
parameter_list|(
name|port_t
name|port
parameter_list|,
name|int
name|irq
parameter_list|,
name|int
name|dma
parameter_list|)
block|{
name|unsigned
name|char
name|sr3
decl_stmt|,
name|osr3
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|valid
argument_list|(
name|port
argument_list|,
name|porttab
argument_list|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|(
name|irq
operator|>
literal|0
operator|)
operator|&&
operator|(
operator|!
name|valid
argument_list|(
name|irq
argument_list|,
name|irqtab
argument_list|)
operator|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|(
name|dma
operator|>
literal|0
operator|)
operator|&&
operator|(
operator|!
name|valid
argument_list|(
name|dma
argument_list|,
name|dmatab
argument_list|)
operator|)
condition|)
return|return
literal|0
return|;
name|osr3
operator|=
name|inb
argument_list|(
name|BSR3
argument_list|(
name|port
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|osr3
operator|&
operator|(
name|BSR3_IB
operator||
name|BSR3_IB_NEG
operator|)
operator|)
operator|!=
name|BSR3_IB
operator|&&
operator|(
name|osr3
operator|&
operator|(
name|BSR3_IB
operator||
name|BSR3_IB_NEG
operator|)
operator|)
operator|!=
name|BSR3_IB_NEG
condition|)
return|return
operator|(
literal|0
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|100
condition|;
operator|++
name|i
control|)
block|{
name|sr3
operator|=
name|inb
argument_list|(
name|BSR3
argument_list|(
name|port
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|sr3
operator|^
name|osr3
operator|)
operator|&
operator|(
name|BSR3_IB
operator||
name|BSR3_IB_NEG
operator||
name|BSR3_ZERO
operator|)
operator|)
operator|!=
operator|(
name|BSR3_IB
operator||
name|BSR3_IB_NEG
operator|)
condition|)
return|return
name|ct_probe2_board
argument_list|(
name|port
argument_list|)
return|;
name|osr3
operator|=
name|sr3
expr_stmt|;
block|}
comment|/* Reset the controller. */
name|outb
argument_list|(
name|BCR0
argument_list|(
name|port
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Check that the irq is functional.  * irq>0  - activate the interrupt from the adapter (irq=on)  * irq<0  - deactivate the interrupt (irq=off)  * irq==0 - free the interrupt line (irq=tri-state)  * Return the interrupt mask _before_ activating irq.  */
end_comment

begin_function
name|int
name|ct_probe_irq
parameter_list|(
name|ct_board_t
modifier|*
name|b
parameter_list|,
name|int
name|irq
parameter_list|)
block|{
name|int
name|mask
decl_stmt|;
name|outb
argument_list|(
literal|0x20
argument_list|,
literal|0x0a
argument_list|)
expr_stmt|;
name|mask
operator|=
name|inb
argument_list|(
literal|0x20
argument_list|)
expr_stmt|;
name|outb
argument_list|(
literal|0xa0
argument_list|,
literal|0x0a
argument_list|)
expr_stmt|;
name|mask
operator||=
name|inb
argument_list|(
literal|0xa0
argument_list|)
operator|<<
literal|8
expr_stmt|;
if|if
condition|(
name|irq
operator|>
literal|0
condition|)
block|{
name|outb
argument_list|(
name|BCR0
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|,
name|BCR0_HDRUN
operator||
name|irqmask
index|[
name|irq
index|]
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|R
argument_list|(
name|b
operator|->
name|port
argument_list|,
name|HD_TEPR_0R
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|outw
argument_list|(
name|R
argument_list|(
name|b
operator|->
name|port
argument_list|,
name|HD_TCONR_0R
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|outw
argument_list|(
name|R
argument_list|(
name|b
operator|->
name|port
argument_list|,
name|HD_TCNT_0R
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|R
argument_list|(
name|b
operator|->
name|port
argument_list|,
name|HD_TCSR_0R
argument_list|)
argument_list|,
name|TCSR_ENABLE
operator||
name|TCSR_INTR
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|IER2
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|,
name|IER2_RX_TME_0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|irq
operator|<
literal|0
condition|)
block|{
name|outb
argument_list|(
name|BCR0
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|,
name|BCR0_HDRUN
operator||
name|irqmask
index|[
operator|-
name|irq
index|]
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|IER0
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|IER1
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|IER2
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|R
argument_list|(
name|b
operator|->
name|port
argument_list|,
name|HD_TCSR_0R
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|cte_out
argument_list|(
name|E1CS0
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|,
name|DS_IMR2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|cte_out
argument_list|(
name|E1CS1
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|,
name|DS_IMR2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|-
name|irq
operator|>
literal|7
condition|)
block|{
name|outb
argument_list|(
literal|0xa0
argument_list|,
literal|0x60
operator||
operator|(
operator|(
operator|-
name|irq
operator|)
operator|&
literal|7
operator|)
argument_list|)
expr_stmt|;
name|outb
argument_list|(
literal|0x20
argument_list|,
literal|0x62
argument_list|)
expr_stmt|;
block|}
else|else
name|outb
argument_list|(
literal|0x20
argument_list|,
literal|0x60
operator||
operator|(
operator|-
name|irq
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|outb
argument_list|(
name|BCR0
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|,
name|b
operator|->
name|bcr0
argument_list|)
expr_stmt|;
name|cte_out
argument_list|(
name|E1CS0
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|,
name|DS_IMR2
argument_list|,
name|SR2_SEC
argument_list|)
expr_stmt|;
name|cte_out
argument_list|(
name|E1CS1
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|,
name|DS_IMR2
argument_list|,
name|SR2_SEC
argument_list|)
expr_stmt|;
block|}
return|return
name|mask
return|;
block|}
end_function

begin_function
name|void
name|ct_init_board
parameter_list|(
name|ct_board_t
modifier|*
name|b
parameter_list|,
name|int
name|num
parameter_list|,
name|port_t
name|port
parameter_list|,
name|int
name|irq
parameter_list|,
name|int
name|dma
parameter_list|,
name|int
name|type
parameter_list|,
name|long
name|osc
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
comment|/* Initialize board structure. */
name|b
operator|->
name|type
operator|=
name|type
expr_stmt|;
name|b
operator|->
name|port
operator|=
name|port
expr_stmt|;
name|b
operator|->
name|num
operator|=
name|num
expr_stmt|;
name|b
operator|->
name|irq
operator|=
name|irq
expr_stmt|;
name|b
operator|->
name|dma
operator|=
name|dma
expr_stmt|;
name|b
operator|->
name|osc
operator|=
name|osc
expr_stmt|;
comment|/* Get the board type. */
if|if
condition|(
name|b
operator|->
name|type
operator|==
name|B_TAU
condition|)
name|strcpy
argument_list|(
name|b
operator|->
name|name
argument_list|,
literal|"Tau"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|b
operator|->
name|type
operator|==
name|B_TAU_E1
condition|)
name|strcpy
argument_list|(
name|b
operator|->
name|name
argument_list|,
literal|"Tau/E1"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|b
operator|->
name|type
operator|==
name|B_TAU_E1C
condition|)
name|strcpy
argument_list|(
name|b
operator|->
name|name
argument_list|,
literal|"Tau/E1c"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|b
operator|->
name|type
operator|==
name|B_TAU_E1D
condition|)
name|strcpy
argument_list|(
name|b
operator|->
name|name
argument_list|,
literal|"Tau/E1d"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|b
operator|->
name|type
operator|==
name|B_TAU_G703
condition|)
name|strcpy
argument_list|(
name|b
operator|->
name|name
argument_list|,
literal|"Tau/G.703"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|b
operator|->
name|type
operator|==
name|B_TAU_G703C
condition|)
name|strcpy
argument_list|(
name|b
operator|->
name|name
argument_list|,
literal|"Tau/G.703c"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|b
operator|->
name|type
operator|==
name|B_TAU2
condition|)
name|strcpy
argument_list|(
name|b
operator|->
name|name
argument_list|,
literal|"Tau2"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|b
operator|->
name|type
operator|==
name|B_TAU2_E1
condition|)
name|strcpy
argument_list|(
name|b
operator|->
name|name
argument_list|,
literal|"Tau2/E1"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|b
operator|->
name|type
operator|==
name|B_TAU2_E1D
condition|)
name|strcpy
argument_list|(
name|b
operator|->
name|name
argument_list|,
literal|"Tau2/E1d"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|b
operator|->
name|type
operator|==
name|B_TAU2_G703
condition|)
name|strcpy
argument_list|(
name|b
operator|->
name|name
argument_list|,
literal|"Tau2/G.703"
argument_list|)
expr_stmt|;
else|else
name|strcpy
argument_list|(
name|b
operator|->
name|name
argument_list|,
literal|"Tau/???"
argument_list|)
expr_stmt|;
comment|/* Set DMA and IRQ. */
name|b
operator|->
name|bcr0
operator|=
name|BCR0_HDRUN
operator||
name|dmamask
index|[
name|b
operator|->
name|dma
index|]
operator||
name|irqmask
index|[
name|b
operator|->
name|irq
index|]
expr_stmt|;
comment|/* Clear DTR[0..1]. */
name|b
operator|->
name|bcr1
operator|=
literal|0
expr_stmt|;
name|b
operator|->
name|e1cfg
operator|=
literal|0
expr_stmt|;
comment|/* Initialize channel structures. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NCHAN
condition|;
operator|++
name|i
control|)
name|ct_init_chan
argument_list|(
name|b
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|ct_reinit_board
argument_list|(
name|b
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Initialize the board structure.  */
end_comment

begin_function
name|void
name|ct_init
parameter_list|(
name|ct_board_t
modifier|*
name|b
parameter_list|,
name|int
name|num
parameter_list|,
name|port_t
name|port
parameter_list|,
name|int
name|irq
parameter_list|,
name|int
name|dma
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|firmware
parameter_list|,
name|long
name|bits
parameter_list|,
specifier|const
name|cr_dat_tst_t
modifier|*
name|tst
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|firmware2
parameter_list|)
block|{
specifier|static
name|long
name|tlen
init|=
literal|182
decl_stmt|;
specifier|static
name|cr_dat_tst_t
name|tvec
index|[]
init|=
block|{
block|{
literal|114
block|,
literal|178
block|}
block|,
block|{
literal|182
block|,
literal|182
block|}
block|}
decl_stmt|;
specifier|static
name|cr_dat_tst_t
name|tvec2
index|[]
init|=
block|{
block|{
literal|50
block|,
literal|178
block|}
block|,
block|{
literal|182
block|,
literal|182
block|}
block|}
decl_stmt|;
specifier|static
name|unsigned
name|char
name|tau
index|[]
init|=
block|{
literal|155
block|,
literal|153
block|,
literal|113
block|,
literal|48
block|,
literal|64
block|,
literal|236
block|,
literal|48
block|,
literal|49
block|,
literal|49
block|,
literal|49
block|,
literal|49
block|,
literal|49
block|,
literal|49
block|,
literal|49
block|,
literal|49
block|,
literal|49
block|,
literal|49
block|,
literal|49
block|,
literal|49
block|,
literal|49
block|,
literal|49
block|,
literal|49
block|,
literal|183
block|,}
decl_stmt|;
specifier|static
name|unsigned
name|char
name|e1
index|[]
init|=
block|{
literal|155
block|,
literal|153
block|,
literal|113
block|,
literal|48
block|,
literal|64
block|,
literal|236
block|,
literal|112
block|,
literal|37
block|,
literal|49
block|,
literal|37
block|,
literal|33
block|,
literal|116
block|,
literal|101
block|,
literal|100
block|,
literal|112
block|,
literal|37
block|,
literal|49
block|,
literal|37
block|,
literal|33
block|,
literal|116
block|,
literal|101
block|,
literal|100
block|,
literal|230
block|,}
decl_stmt|;
specifier|static
name|unsigned
name|char
name|e1_2
index|[]
init|=
block|{
literal|155
block|,
literal|153
block|,
literal|113
block|,
literal|48
block|,
literal|64
block|,
literal|236
block|,
literal|112
block|,
literal|37
block|,
literal|49
block|,
literal|37
block|,
literal|33
block|,
literal|116
block|,
literal|101
block|,
literal|100
block|,
literal|96
block|,
literal|97
block|,
literal|53
block|,
literal|49
block|,
literal|49
block|,
literal|96
block|,
literal|97
block|,
literal|100
block|,
literal|230
block|,}
decl_stmt|;
specifier|static
name|unsigned
name|char
name|e1_3
index|[]
init|=
block|{
literal|155
block|,
literal|153
block|,
literal|113
block|,
literal|48
block|,
literal|64
block|,
literal|236
block|,
literal|96
block|,
literal|97
block|,
literal|53
block|,
literal|49
block|,
literal|49
block|,
literal|96
block|,
literal|97
block|,
literal|100
block|,
literal|96
block|,
literal|97
block|,
literal|53
block|,
literal|49
block|,
literal|49
block|,
literal|96
block|,
literal|97
block|,
literal|100
block|,
literal|230
block|,}
decl_stmt|;
specifier|static
name|unsigned
name|char
name|e1_4
index|[]
init|=
block|{
literal|155
block|,
literal|153
block|,
literal|113
block|,
literal|48
block|,
literal|64
block|,
literal|236
block|,
literal|96
block|,
literal|97
block|,
literal|53
block|,
literal|49
block|,
literal|49
block|,
literal|96
block|,
literal|97
block|,
literal|100
block|,
literal|112
block|,
literal|37
block|,
literal|49
block|,
literal|37
block|,
literal|33
block|,
literal|116
block|,
literal|101
block|,
literal|100
block|,
literal|230
block|,}
decl_stmt|;
specifier|static
name|unsigned
name|char
name|g703
index|[]
init|=
block|{
literal|155
block|,
literal|153
block|,
literal|113
block|,
literal|48
block|,
literal|64
block|,
literal|236
block|,
literal|112
block|,
literal|37
block|,
literal|49
block|,
literal|37
block|,
literal|33
block|,
literal|116
block|,
literal|101
block|,
literal|32
block|,
literal|117
block|,
literal|37
block|,
literal|49
block|,
literal|37
block|,
literal|33
block|,
literal|116
block|,
literal|101
block|,
literal|100
block|,
literal|230
block|,}
decl_stmt|;
specifier|static
name|unsigned
name|char
name|g703_2
index|[]
init|=
block|{
literal|155
block|,
literal|153
block|,
literal|113
block|,
literal|48
block|,
literal|64
block|,
literal|236
block|,
literal|112
block|,
literal|37
block|,
literal|49
block|,
literal|37
block|,
literal|33
block|,
literal|116
block|,
literal|101
block|,
literal|32
block|,
literal|101
block|,
literal|97
block|,
literal|53
block|,
literal|49
block|,
literal|49
block|,
literal|96
block|,
literal|97
block|,
literal|100
block|,
literal|230
block|,}
decl_stmt|;
specifier|static
name|unsigned
name|char
name|g703_3
index|[]
init|=
block|{
literal|155
block|,
literal|153
block|,
literal|113
block|,
literal|48
block|,
literal|64
block|,
literal|236
block|,
literal|96
block|,
literal|97
block|,
literal|53
block|,
literal|49
block|,
literal|49
block|,
literal|96
block|,
literal|97
block|,
literal|32
block|,
literal|101
block|,
literal|97
block|,
literal|53
block|,
literal|49
block|,
literal|49
block|,
literal|96
block|,
literal|97
block|,
literal|100
block|,
literal|230
block|,}
decl_stmt|;
specifier|static
name|unsigned
name|char
name|g703_4
index|[]
init|=
block|{
literal|155
block|,
literal|153
block|,
literal|113
block|,
literal|48
block|,
literal|64
block|,
literal|236
block|,
literal|96
block|,
literal|97
block|,
literal|53
block|,
literal|49
block|,
literal|49
block|,
literal|96
block|,
literal|97
block|,
literal|32
block|,
literal|117
block|,
literal|37
block|,
literal|49
block|,
literal|37
block|,
literal|33
block|,
literal|116
block|,
literal|101
block|,
literal|100
block|,
literal|230
block|,}
decl_stmt|;
name|int
name|type
init|=
name|B_TAU
decl_stmt|;
name|long
name|osc
init|=
operator|(
name|inb
argument_list|(
name|BSR3
argument_list|(
name|port
argument_list|)
argument_list|)
operator|&
name|BSR3_ZERO
operator|)
condition|?
literal|8192000
else|:
literal|10000000
decl_stmt|;
comment|/* Get the board type. */
if|if
condition|(
name|ct_probe2_board
argument_list|(
name|port
argument_list|)
operator|&&
name|ct_download2
argument_list|(
name|port
argument_list|,
name|firmware2
argument_list|)
condition|)
block|{
comment|/* Tau2, 1k30-based model */
name|unsigned
name|char
name|sr0
init|=
name|inb
argument_list|(
name|BSR0
argument_list|(
name|port
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|sr0
operator|&
name|BSR0_T703
operator|)
condition|)
name|type
operator|=
name|B_TAU2_G703
expr_stmt|;
elseif|else
if|if
condition|(
name|sr0
operator|&
name|BSR0_TE1
condition|)
name|type
operator|=
name|B_TAU2
expr_stmt|;
elseif|else
if|if
condition|(
name|inb
argument_list|(
name|E1SR
argument_list|(
name|port
argument_list|)
argument_list|)
operator|&
name|E1SR_REV
condition|)
name|type
operator|=
name|B_TAU2_E1D
expr_stmt|;
else|else
name|type
operator|=
name|B_TAU2_E1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ct_download
argument_list|(
name|port
argument_list|,
name|tau
argument_list|,
name|tlen
argument_list|,
name|tvec
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|ct_download
argument_list|(
name|port
argument_list|,
name|firmware
argument_list|,
name|bits
argument_list|,
name|tst
argument_list|)
condition|)
name|type
operator|=
name|B_TAU
expr_stmt|;
else|else
block|{
name|unsigned
name|char
name|sr0
init|=
name|inb
argument_list|(
name|BSR0
argument_list|(
name|port
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|sr0
operator|&
name|BSR0_T703
operator|)
condition|)
name|type
operator|=
name|B_TAU_G703C
expr_stmt|;
elseif|else
if|if
condition|(
name|sr0
operator|&
name|BSR0_TE1
condition|)
name|type
operator|=
name|B_TAU
expr_stmt|;
elseif|else
if|if
condition|(
name|inb
argument_list|(
name|E1SR
argument_list|(
name|port
argument_list|)
argument_list|)
operator|&
name|E1SR_REV
condition|)
name|type
operator|=
name|B_TAU_E1D
expr_stmt|;
else|else
name|type
operator|=
name|B_TAU_E1C
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|ct_download
argument_list|(
name|port
argument_list|,
name|e1
argument_list|,
name|tlen
argument_list|,
name|tvec2
argument_list|)
operator|||
name|ct_download
argument_list|(
name|port
argument_list|,
name|e1_2
argument_list|,
name|tlen
argument_list|,
name|tvec2
argument_list|)
operator|||
name|ct_download
argument_list|(
name|port
argument_list|,
name|e1_3
argument_list|,
name|tlen
argument_list|,
name|tvec2
argument_list|)
operator|||
name|ct_download
argument_list|(
name|port
argument_list|,
name|e1_4
argument_list|,
name|tlen
argument_list|,
name|tvec2
argument_list|)
condition|)
name|type
operator|=
name|B_TAU_E1
expr_stmt|;
elseif|else
if|if
condition|(
name|ct_download
argument_list|(
name|port
argument_list|,
name|g703
argument_list|,
name|tlen
argument_list|,
name|tvec2
argument_list|)
operator|||
name|ct_download
argument_list|(
name|port
argument_list|,
name|g703_2
argument_list|,
name|tlen
argument_list|,
name|tvec2
argument_list|)
operator|||
name|ct_download
argument_list|(
name|port
argument_list|,
name|g703_3
argument_list|,
name|tlen
argument_list|,
name|tvec2
argument_list|)
operator|||
name|ct_download
argument_list|(
name|port
argument_list|,
name|g703_4
argument_list|,
name|tlen
argument_list|,
name|tvec2
argument_list|)
condition|)
name|type
operator|=
name|B_TAU_G703
expr_stmt|;
name|ct_init_board
argument_list|(
name|b
argument_list|,
name|num
argument_list|,
name|port
argument_list|,
name|irq
argument_list|,
name|dma
argument_list|,
name|type
argument_list|,
name|osc
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Initialize the channel structure.  */
end_comment

begin_function
specifier|static
name|void
name|ct_init_chan
parameter_list|(
name|ct_board_t
modifier|*
name|b
parameter_list|,
name|int
name|i
parameter_list|)
block|{
name|ct_chan_t
modifier|*
name|c
init|=
name|b
operator|->
name|chan
operator|+
name|i
decl_stmt|;
name|port_t
name|port
init|=
name|b
operator|->
name|port
decl_stmt|;
name|c
operator|->
name|num
operator|=
name|i
expr_stmt|;
name|c
operator|->
name|board
operator|=
name|b
expr_stmt|;
switch|switch
condition|(
name|b
operator|->
name|type
condition|)
block|{
case|case
name|B_TAU
case|:
case|case
name|B_TAU2
case|:
name|c
operator|->
name|type
operator|=
name|T_SERIAL
expr_stmt|;
break|break;
case|case
name|B_TAU_E1
case|:
case|case
name|B_TAU_E1C
case|:
case|case
name|B_TAU_E1D
case|:
case|case
name|B_TAU2_E1
case|:
case|case
name|B_TAU2_E1D
case|:
name|c
operator|->
name|type
operator|=
name|T_E1
expr_stmt|;
break|break;
case|case
name|B_TAU_G703
case|:
case|case
name|B_TAU_G703C
case|:
case|case
name|B_TAU2_G703
case|:
name|c
operator|->
name|type
operator|=
name|T_G703
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|c
operator|->
name|num
condition|)
name|c
operator|->
name|type
operator||=
name|T_SERIAL
expr_stmt|;
define|#
directive|define
name|reg
parameter_list|(
name|X
parameter_list|,
name|N
parameter_list|)
value|HD_##X##_##N
define|#
directive|define
name|set
parameter_list|(
name|X
parameter_list|,
name|N
parameter_list|)
value|c->X = R(port,reg(X,N))
define|#
directive|define
name|srx
parameter_list|(
name|X
parameter_list|,
name|N
parameter_list|)
value|c->RX.X = R(port,reg(X,N##R))
define|#
directive|define
name|stx
parameter_list|(
name|X
parameter_list|,
name|N
parameter_list|)
value|c->TX.X = R(port,reg(X,N##T))
if|if
condition|(
name|i
operator|==
literal|0
condition|)
block|{
name|set
argument_list|(
name|MD0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|set
argument_list|(
name|MD1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|set
argument_list|(
name|MD2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|set
argument_list|(
name|CTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|set
argument_list|(
name|RXS
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|set
argument_list|(
name|TXS
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|set
argument_list|(
name|TMC
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|set
argument_list|(
name|CMD
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|set
argument_list|(
name|ST0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|set
argument_list|(
name|ST1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|set
argument_list|(
name|ST2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|set
argument_list|(
name|ST3
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|set
argument_list|(
name|FST
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|set
argument_list|(
name|IE0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|set
argument_list|(
name|IE1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|set
argument_list|(
name|IE2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|set
argument_list|(
name|FST
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|set
argument_list|(
name|IE0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|set
argument_list|(
name|IE1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|set
argument_list|(
name|IE2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|set
argument_list|(
name|FIE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|set
argument_list|(
name|SA0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|set
argument_list|(
name|SA1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|set
argument_list|(
name|IDL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|set
argument_list|(
name|TRB
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|set
argument_list|(
name|RRC
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|set
argument_list|(
name|TRC0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|set
argument_list|(
name|TRC1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|set
argument_list|(
name|CST
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|srx
argument_list|(
name|DAR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|srx
argument_list|(
name|DARB
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|srx
argument_list|(
name|SAR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|srx
argument_list|(
name|SARB
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|srx
argument_list|(
name|CDA
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|srx
argument_list|(
name|EDA
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|srx
argument_list|(
name|BFL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|srx
argument_list|(
name|BCR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|srx
argument_list|(
name|DSR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|srx
argument_list|(
name|DMR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|srx
argument_list|(
name|FCT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|srx
argument_list|(
name|DIR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|srx
argument_list|(
name|DCR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|srx
argument_list|(
name|TCNT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|srx
argument_list|(
name|TCONR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|srx
argument_list|(
name|TCSR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|srx
argument_list|(
name|TEPR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|stx
argument_list|(
name|DAR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|stx
argument_list|(
name|DARB
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|stx
argument_list|(
name|SAR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|stx
argument_list|(
name|SARB
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|stx
argument_list|(
name|CDA
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|stx
argument_list|(
name|EDA
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|stx
argument_list|(
name|BCR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|stx
argument_list|(
name|DSR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|stx
argument_list|(
name|DMR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|stx
argument_list|(
name|FCT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|stx
argument_list|(
name|DIR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|stx
argument_list|(
name|DCR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|stx
argument_list|(
name|TCNT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|stx
argument_list|(
name|TCONR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|stx
argument_list|(
name|TCSR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|stx
argument_list|(
name|TEPR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|set
argument_list|(
name|MD0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|set
argument_list|(
name|MD1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|set
argument_list|(
name|MD2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|set
argument_list|(
name|CTL
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|set
argument_list|(
name|RXS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|set
argument_list|(
name|TXS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|set
argument_list|(
name|TMC
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|set
argument_list|(
name|CMD
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|set
argument_list|(
name|ST0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|set
argument_list|(
name|ST1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|set
argument_list|(
name|ST2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|set
argument_list|(
name|ST3
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|set
argument_list|(
name|FST
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|set
argument_list|(
name|IE0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|set
argument_list|(
name|IE1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|set
argument_list|(
name|IE2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|set
argument_list|(
name|FST
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|set
argument_list|(
name|IE0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|set
argument_list|(
name|IE1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|set
argument_list|(
name|IE2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|set
argument_list|(
name|FIE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|set
argument_list|(
name|SA0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|set
argument_list|(
name|SA1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|set
argument_list|(
name|IDL
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|set
argument_list|(
name|TRB
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|set
argument_list|(
name|RRC
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|set
argument_list|(
name|TRC0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|set
argument_list|(
name|TRC1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|set
argument_list|(
name|CST
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|srx
argument_list|(
name|DAR
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|srx
argument_list|(
name|DARB
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|srx
argument_list|(
name|SAR
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|srx
argument_list|(
name|SARB
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|srx
argument_list|(
name|CDA
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|srx
argument_list|(
name|EDA
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|srx
argument_list|(
name|BFL
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|srx
argument_list|(
name|BCR
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|srx
argument_list|(
name|DSR
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|srx
argument_list|(
name|DMR
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|srx
argument_list|(
name|FCT
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|srx
argument_list|(
name|DIR
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|srx
argument_list|(
name|DCR
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|srx
argument_list|(
name|TCNT
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|srx
argument_list|(
name|TCONR
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|srx
argument_list|(
name|TCSR
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|srx
argument_list|(
name|TEPR
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|stx
argument_list|(
name|DAR
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|stx
argument_list|(
name|DARB
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|stx
argument_list|(
name|SAR
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|stx
argument_list|(
name|SARB
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|stx
argument_list|(
name|CDA
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|stx
argument_list|(
name|EDA
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|stx
argument_list|(
name|BCR
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|stx
argument_list|(
name|DSR
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|stx
argument_list|(
name|DMR
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|stx
argument_list|(
name|FCT
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|stx
argument_list|(
name|DIR
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|stx
argument_list|(
name|DCR
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|stx
argument_list|(
name|TCNT
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|stx
argument_list|(
name|TCONR
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|stx
argument_list|(
name|TCSR
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|stx
argument_list|(
name|TEPR
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
undef|#
directive|undef
name|set
undef|#
directive|undef
name|srx
undef|#
directive|undef
name|stx
undef|#
directive|undef
name|reg
block|}
end_function

begin_comment
comment|/*  * Reinitialize the channels, using new options.  */
end_comment

begin_function
name|void
name|ct_reinit_chan
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|)
block|{
name|ct_board_t
modifier|*
name|b
init|=
name|c
operator|->
name|board
decl_stmt|;
name|long
name|s
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|c
operator|->
name|hopt
operator|.
name|txs
operator|==
name|CLK_LINE
condition|)
block|{
comment|/* External clock mode -- set zero baud rate. */
if|if
condition|(
name|c
operator|->
name|mode
operator|!=
name|M_ASYNC
condition|)
name|c
operator|->
name|baud
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|c
operator|->
name|baud
operator|==
literal|0
condition|)
block|{
comment|/* No baud rate in internal clock mode -- set default values. */
if|if
condition|(
name|c
operator|->
name|mode
operator|==
name|M_ASYNC
condition|)
name|c
operator|->
name|baud
operator|=
literal|9600
expr_stmt|;
elseif|else
if|if
condition|(
name|c
operator|->
name|mode
operator|==
name|M_HDLC
condition|)
name|c
operator|->
name|baud
operator|=
literal|64000
expr_stmt|;
block|}
switch|switch
condition|(
name|c
operator|->
name|type
condition|)
block|{
case|case
name|T_E1_SERIAL
case|:
if|if
condition|(
name|b
operator|->
name|opt
operator|.
name|cfg
operator|==
name|CFG_B
condition|)
break|break;
comment|/* Fall through... */
case|case
name|T_E1
case|:
name|c
operator|->
name|mode
operator|=
name|M_E1
expr_stmt|;
name|c
operator|->
name|hopt
operator|.
name|txs
operator|=
name|CLK_LINE
expr_stmt|;
comment|/* Compute the baud value. */
if|if
condition|(
name|c
operator|->
name|num
condition|)
block|{
name|s
operator|=
name|b
operator|->
name|opt
operator|.
name|s1
expr_stmt|;
if|if
condition|(
name|b
operator|->
name|opt
operator|.
name|cfg
operator|==
name|CFG_C
condition|)
name|s
operator|&=
operator|~
name|b
operator|->
name|opt
operator|.
name|s0
expr_stmt|;
block|}
else|else
name|s
operator|=
name|b
operator|->
name|opt
operator|.
name|s0
expr_stmt|;
comment|/* Skip timeslot 16 in CAS mode. */
if|if
condition|(
name|c
operator|->
name|gopt
operator|.
name|cas
condition|)
name|s
operator|&=
operator|~
operator|(
literal|1L
operator|<<
literal|16
operator|)
expr_stmt|;
name|c
operator|->
name|baud
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
operator|++
name|i
control|)
if|if
condition|(
operator|(
name|s
operator|>>
name|i
operator|)
operator|&
literal|1
condition|)
name|c
operator|->
name|baud
operator|+=
literal|64000
expr_stmt|;
name|c
operator|->
name|gopt
operator|.
name|rate
operator|=
name|c
operator|->
name|baud
operator|/
literal|1000
expr_stmt|;
comment|/* Set NRZ and clear INVCLK. */
name|c
operator|->
name|opt
operator|.
name|md2
operator|.
name|encod
operator|=
name|MD2_ENCOD_NRZ
expr_stmt|;
name|c
operator|->
name|board
operator|->
name|opt
operator|.
name|bcr2
operator|&=
name|c
operator|->
name|num
condition|?
operator|~
operator|(
name|BCR2_INVTXC1
operator||
name|BCR2_INVRXC1
operator|)
else|:
operator|~
operator|(
name|BCR2_INVTXC0
operator||
name|BCR2_INVRXC0
operator|)
expr_stmt|;
break|break;
case|case
name|T_G703_SERIAL
case|:
if|if
condition|(
name|b
operator|->
name|opt
operator|.
name|cfg
operator|==
name|CFG_B
condition|)
break|break;
comment|/* Fall through... */
case|case
name|T_G703
case|:
name|c
operator|->
name|mode
operator|=
name|M_G703
expr_stmt|;
name|c
operator|->
name|hopt
operator|.
name|txs
operator|=
name|CLK_LINE
expr_stmt|;
name|c
operator|->
name|baud
operator|=
name|c
operator|->
name|gopt
operator|.
name|rate
operator|*
literal|1000L
expr_stmt|;
comment|/* Set NRZ/NRZI and clear INVCLK. */
if|if
condition|(
name|c
operator|->
name|opt
operator|.
name|md2
operator|.
name|encod
operator|!=
name|MD2_ENCOD_NRZ
operator|&&
name|c
operator|->
name|opt
operator|.
name|md2
operator|.
name|encod
operator|!=
name|MD2_ENCOD_NRZI
condition|)
name|c
operator|->
name|opt
operator|.
name|md2
operator|.
name|encod
operator|=
name|MD2_ENCOD_NRZ
expr_stmt|;
name|c
operator|->
name|board
operator|->
name|opt
operator|.
name|bcr2
operator|&=
name|c
operator|->
name|num
condition|?
operator|~
operator|(
name|BCR2_INVTXC1
operator||
name|BCR2_INVRXC1
operator|)
else|:
operator|~
operator|(
name|BCR2_INVTXC0
operator||
name|BCR2_INVRXC0
operator|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/*  * Reinitialize all channels, using new options and baud rate.  */
end_comment

begin_function
name|void
name|ct_reinit_board
parameter_list|(
name|ct_board_t
modifier|*
name|b
parameter_list|)
block|{
name|ct_chan_t
modifier|*
name|c
decl_stmt|;
name|b
operator|->
name|opt
operator|=
name|ct_board_opt_dflt
expr_stmt|;
for|for
control|(
name|c
operator|=
name|b
operator|->
name|chan
init|;
name|c
operator|<
name|b
operator|->
name|chan
operator|+
name|NCHAN
condition|;
operator|++
name|c
control|)
block|{
name|c
operator|->
name|opt
operator|=
name|ct_chan_opt_dflt
expr_stmt|;
name|c
operator|->
name|hopt
operator|=
name|ct_opt_hdlc_dflt
expr_stmt|;
name|c
operator|->
name|gopt
operator|=
name|ct_opt_g703_dflt
expr_stmt|;
name|c
operator|->
name|mode
operator|=
name|ct_chan_mode
expr_stmt|;
name|c
operator|->
name|baud
operator|=
name|ct_baud
expr_stmt|;
name|ct_reinit_chan
argument_list|(
name|c
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Set up the E1 controller of the Tau/E1 board.  * Frame sync signals:  * Configuration	Rsync0	Tsync0	Rsync1	Tsync1  * ---------------------------------------------------  * A (II)		out	out	out	out  * B,C,D (HI,K,D)	in	out	in	out  * ---------------------------------------------------  * BI			out	out	in	in	-- not implemented  * old B,C,D (HI,K,D)	out	in	out	in	-- old  */
end_comment

begin_function
specifier|static
name|void
name|ct_setup_ctlr
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|)
block|{
name|ct_board_t
modifier|*
name|b
init|=
name|c
operator|->
name|board
decl_stmt|;
name|port_t
name|p
init|=
name|c
operator|->
name|num
condition|?
name|E1CS1
argument_list|(
name|b
operator|->
name|port
argument_list|)
else|:
name|E1CS0
argument_list|(
name|b
operator|->
name|port
argument_list|)
decl_stmt|;
name|unsigned
name|char
name|rcr1
decl_stmt|,
name|rcr2
decl_stmt|,
name|tcr1
decl_stmt|,
name|tcr2
decl_stmt|,
name|ccr1
decl_stmt|,
name|licr
decl_stmt|;
name|unsigned
name|long
name|xcbr
decl_stmt|,
name|tir
decl_stmt|;
name|int
name|i
decl_stmt|;
name|rcr2
operator|=
name|RCR2_RSCLKM
expr_stmt|;
name|tcr1
operator|=
name|TCR1_TSIS
operator||
name|TCR1_TSO
expr_stmt|;
name|tcr2
operator|=
literal|0
expr_stmt|;
name|ccr1
operator|=
literal|0
expr_stmt|;
name|licr
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|b
operator|->
name|opt
operator|.
name|cfg
operator|!=
name|CFG_D
condition|)
block|{
comment|/* Enable monitoring channel, when not in telephony mode. */
name|rcr2
operator||=
name|RCR2_SA_4
expr_stmt|;
name|tcr2
operator||=
name|TCR2_SA_4
expr_stmt|;
block|}
if|if
condition|(
name|b
operator|->
name|opt
operator|.
name|cfg
operator|==
name|CFG_A
condition|)
block|{
name|rcr1
operator|=
name|RCR1_RSO
expr_stmt|;
block|}
else|else
block|{
name|rcr1
operator|=
name|RCR1_RSI
expr_stmt|;
name|rcr2
operator||=
name|RCR2_RESE
expr_stmt|;
block|}
if|if
condition|(
name|c
operator|->
name|gopt
operator|.
name|cas
condition|)
name|tcr1
operator||=
name|TCR1_T16S
expr_stmt|;
else|else
name|ccr1
operator||=
name|CCR1_CCS
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|gopt
operator|.
name|hdb3
condition|)
name|ccr1
operator||=
name|CCR1_THDB3
operator||
name|CCR1_RHDB3
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|gopt
operator|.
name|crc4
condition|)
block|{
name|ccr1
operator||=
name|CCR1_TCRC4
operator||
name|CCR1_RCRC4
expr_stmt|;
name|tcr2
operator||=
name|TCR2_AEBE
expr_stmt|;
block|}
if|if
condition|(
name|c
operator|->
name|gopt
operator|.
name|higain
condition|)
name|licr
operator||=
name|LICR_HIGAIN
expr_stmt|;
if|if
condition|(
name|inb
argument_list|(
name|E1SR
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|)
operator|&
operator|(
name|c
operator|->
name|num
condition|?
name|E1SR_TP1
else|:
name|E1SR_TP0
operator|)
condition|)
name|licr
operator||=
name|LICR_LB120P
expr_stmt|;
else|else
name|licr
operator||=
name|LICR_LB75P
expr_stmt|;
name|cte_out
argument_list|(
name|p
argument_list|,
name|DS_RCR1
argument_list|,
name|rcr1
argument_list|)
expr_stmt|;
comment|/* receive control 1 */
name|cte_out
argument_list|(
name|p
argument_list|,
name|DS_RCR2
argument_list|,
name|rcr2
argument_list|)
expr_stmt|;
comment|/* receive control 2 */
name|cte_out
argument_list|(
name|p
argument_list|,
name|DS_TCR1
argument_list|,
name|tcr1
argument_list|)
expr_stmt|;
comment|/* transmit control 1 */
name|cte_out
argument_list|(
name|p
argument_list|,
name|DS_TCR2
argument_list|,
name|tcr2
argument_list|)
expr_stmt|;
comment|/* transmit control 2 */
name|cte_out
argument_list|(
name|p
argument_list|,
name|DS_CCR1
argument_list|,
name|ccr1
argument_list|)
expr_stmt|;
comment|/* common control 1 */
name|cte_out
argument_list|(
name|p
argument_list|,
name|DS_CCR2
argument_list|,
name|CCR2_CNTCV
operator||
name|CCR2_AUTORA
operator||
name|CCR2_LOFA1
argument_list|)
expr_stmt|;
comment|/* common control 2 */
name|cte_out
argument_list|(
name|p
argument_list|,
name|DS_CCR3
argument_list|,
name|CCR3_TSCLKM
argument_list|)
expr_stmt|;
comment|/* common control 3 */
name|cte_out
argument_list|(
name|p
argument_list|,
name|DS_LICR
argument_list|,
name|licr
argument_list|)
expr_stmt|;
comment|/* line interface control */
name|cte_out
argument_list|(
name|p
argument_list|,
name|DS_IMR1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* interrupt mask 1 */
name|cte_out
argument_list|(
name|p
argument_list|,
name|DS_IMR2
argument_list|,
name|SR2_SEC
argument_list|)
expr_stmt|;
comment|/* interrupt mask 2 */
name|cte_out
argument_list|(
name|p
argument_list|,
name|DS_TEST1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|cte_out
argument_list|(
name|p
argument_list|,
name|DS_TEST2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|cte_out
argument_list|(
name|p
argument_list|,
name|DS_TAF
argument_list|,
literal|0x9b
argument_list|)
expr_stmt|;
comment|/* transmit align frame */
name|cte_out
argument_list|(
name|p
argument_list|,
name|DS_TNAF
argument_list|,
literal|0xdf
argument_list|)
expr_stmt|;
comment|/* transmit non-align frame */
name|cte_out
argument_list|(
name|p
argument_list|,
name|DS_TIDR
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
comment|/* transmit idle definition */
name|cte_out
argument_list|(
name|p
argument_list|,
name|DS_TS
argument_list|,
literal|0x0b
argument_list|)
expr_stmt|;
comment|/* transmit signaling 1 */
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
literal|16
condition|;
operator|++
name|i
control|)
comment|/* transmit signaling 2..16 */
name|cte_out
argument_list|(
name|p
argument_list|,
call|(
name|unsigned
name|char
call|)
argument_list|(
name|DS_TS
operator|+
name|i
argument_list|)
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
comment|/* 	 * S0 == list of timeslots for channel 0 	 * S1 == list of timeslots for channel 1 	 * S2 == list of timeslots for E1 subchannel (pass through) 	 * 	 * Each channel uses the same timeslots for receive and transmit, 	 * i.e. RCBRi == TCBRi. 	 */
if|if
condition|(
name|b
operator|->
name|opt
operator|.
name|cfg
operator|==
name|CFG_B
condition|)
name|b
operator|->
name|opt
operator|.
name|s1
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|b
operator|->
name|opt
operator|.
name|cfg
operator|==
name|CFG_C
condition|)
name|b
operator|->
name|opt
operator|.
name|s1
operator|&=
operator|~
name|b
operator|->
name|opt
operator|.
name|s0
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|gopt
operator|.
name|cas
condition|)
block|{
comment|/* Skip timeslot 16 in CAS mode. */
name|b
operator|->
name|opt
operator|.
name|s0
operator|&=
operator|~
operator|(
literal|1L
operator|<<
literal|16
operator|)
expr_stmt|;
name|b
operator|->
name|opt
operator|.
name|s1
operator|&=
operator|~
operator|(
literal|1L
operator|<<
literal|16
operator|)
expr_stmt|;
block|}
name|b
operator|->
name|opt
operator|.
name|s2
operator|&=
operator|~
name|b
operator|->
name|opt
operator|.
name|s0
expr_stmt|;
name|b
operator|->
name|opt
operator|.
name|s2
operator|&=
operator|~
name|b
operator|->
name|opt
operator|.
name|s1
expr_stmt|;
comment|/* 	 * Configuration A: 	 *	xCBRi := Si 	 *	TIRi  := ~Si 	 * 	 * Configuration B: 	 *	xCBRi := Si 	 *	TIRi  := 0 	 * 	 * Configuration C:		(S0& S2 == 0) 	 *	xCBR0 := S0 	 *	xCBR1 := 0 	 *	TIR0  := ~S0& ~S2 	 *	TIR1  := ~S2 	 * 	 * Configuration D:		(Si& Sj == 0) 	 *	xCBR0 := S0 	 *	xCBR1 := S1 	 *	TIR0  := ~S0& ~S1& ~S2 	 *	TIR1  := ~S2 	 */
name|xcbr
operator|=
name|c
operator|->
name|num
condition|?
name|b
operator|->
name|opt
operator|.
name|s1
else|:
name|b
operator|->
name|opt
operator|.
name|s0
expr_stmt|;
if|if
condition|(
name|b
operator|->
name|opt
operator|.
name|cfg
operator|==
name|CFG_A
condition|)
name|tir
operator|=
operator|~
name|xcbr
expr_stmt|;
elseif|else
if|if
condition|(
name|b
operator|->
name|opt
operator|.
name|cfg
operator|==
name|CFG_D
condition|)
name|tir
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|c
operator|->
name|num
operator|==
literal|0
condition|)
name|tir
operator|=
operator|~
operator|(
name|b
operator|->
name|opt
operator|.
name|s0
operator||
name|b
operator|->
name|opt
operator|.
name|s1
operator||
name|b
operator|->
name|opt
operator|.
name|s2
operator|)
expr_stmt|;
else|else
name|tir
operator|=
operator|~
name|b
operator|->
name|opt
operator|.
name|s2
expr_stmt|;
comment|/* Mark idle channels. */
name|cte_out
argument_list|(
name|p
argument_list|,
name|DS_TIR
argument_list|,
call|(
name|unsigned
name|char
call|)
argument_list|(
name|tir
operator|&
literal|0xfe
argument_list|)
argument_list|)
expr_stmt|;
name|cte_out
argument_list|(
name|p
argument_list|,
name|DS_TIR
operator|+
literal|1
argument_list|,
call|(
name|unsigned
name|char
call|)
argument_list|(
name|tir
operator|>>
literal|8
argument_list|)
argument_list|)
expr_stmt|;
name|cte_out
argument_list|(
name|p
argument_list|,
name|DS_TIR
operator|+
literal|2
argument_list|,
call|(
name|unsigned
name|char
call|)
argument_list|(
name|tir
operator|>>
literal|16
argument_list|)
argument_list|)
expr_stmt|;
name|cte_out
argument_list|(
name|p
argument_list|,
name|DS_TIR
operator|+
literal|3
argument_list|,
call|(
name|unsigned
name|char
call|)
argument_list|(
name|tir
operator|>>
literal|24
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Set up rx/tx timeslots. */
name|cte_out
argument_list|(
name|p
argument_list|,
name|DS_RCBR
argument_list|,
call|(
name|unsigned
name|char
call|)
argument_list|(
name|xcbr
operator|&
literal|0xfe
argument_list|)
argument_list|)
expr_stmt|;
name|cte_out
argument_list|(
name|p
argument_list|,
name|DS_RCBR
operator|+
literal|1
argument_list|,
call|(
name|unsigned
name|char
call|)
argument_list|(
name|xcbr
operator|>>
literal|8
argument_list|)
argument_list|)
expr_stmt|;
name|cte_out
argument_list|(
name|p
argument_list|,
name|DS_RCBR
operator|+
literal|2
argument_list|,
call|(
name|unsigned
name|char
call|)
argument_list|(
name|xcbr
operator|>>
literal|16
argument_list|)
argument_list|)
expr_stmt|;
name|cte_out
argument_list|(
name|p
argument_list|,
name|DS_RCBR
operator|+
literal|3
argument_list|,
call|(
name|unsigned
name|char
call|)
argument_list|(
name|xcbr
operator|>>
literal|24
argument_list|)
argument_list|)
expr_stmt|;
name|cte_out
argument_list|(
name|p
argument_list|,
name|DS_TCBR
argument_list|,
call|(
name|unsigned
name|char
call|)
argument_list|(
name|xcbr
operator|&
literal|0xfe
argument_list|)
argument_list|)
expr_stmt|;
name|cte_out
argument_list|(
name|p
argument_list|,
name|DS_TCBR
operator|+
literal|1
argument_list|,
call|(
name|unsigned
name|char
call|)
argument_list|(
name|xcbr
operator|>>
literal|8
argument_list|)
argument_list|)
expr_stmt|;
name|cte_out
argument_list|(
name|p
argument_list|,
name|DS_TCBR
operator|+
literal|2
argument_list|,
call|(
name|unsigned
name|char
call|)
argument_list|(
name|xcbr
operator|>>
literal|16
argument_list|)
argument_list|)
expr_stmt|;
name|cte_out
argument_list|(
name|p
argument_list|,
name|DS_TCBR
operator|+
literal|3
argument_list|,
call|(
name|unsigned
name|char
call|)
argument_list|(
name|xcbr
operator|>>
literal|24
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Reset the line interface. */
name|cte_out
argument_list|(
name|p
argument_list|,
name|DS_CCR3
argument_list|,
name|CCR3_TSCLKM
operator||
name|CCR3_LIRESET
argument_list|)
expr_stmt|;
name|cte_out
argument_list|(
name|p
argument_list|,
name|DS_CCR3
argument_list|,
name|CCR3_TSCLKM
argument_list|)
expr_stmt|;
comment|/* Reset the elastic store. */
name|cte_out
argument_list|(
name|p
argument_list|,
name|DS_CCR3
argument_list|,
name|CCR3_TSCLKM
operator||
name|CCR3_ESRESET
argument_list|)
expr_stmt|;
name|cte_out
argument_list|(
name|p
argument_list|,
name|DS_CCR3
argument_list|,
name|CCR3_TSCLKM
argument_list|)
expr_stmt|;
comment|/* Clear status registers. */
name|cte_ins
argument_list|(
name|p
argument_list|,
name|DS_SR1
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
name|cte_ins
argument_list|(
name|p
argument_list|,
name|DS_SR2
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
name|cte_ins
argument_list|(
name|p
argument_list|,
name|DS_RIR
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Set up the serial controller of the Tau/E1 board.  */
end_comment

begin_function
specifier|static
name|void
name|ct_setup_scc
parameter_list|(
name|port_t
name|port
parameter_list|)
block|{
define|#
directive|define
name|SET
parameter_list|(
name|r
parameter_list|,
name|v
parameter_list|)
value|{ cte_out2 (port, r, v); cte_out2 (port, AM_A | r, v); }
comment|/* hardware reset */
name|cte_out2
argument_list|(
name|port
argument_list|,
name|AM_MICR
argument_list|,
name|MICR_RESET_HW
argument_list|)
expr_stmt|;
name|SET
argument_list|(
name|AM_PMR
argument_list|,
literal|0x0c
argument_list|)
expr_stmt|;
comment|/* 2 stop bits */
name|SET
argument_list|(
name|AM_IMR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* no W/REQ signal */
name|cte_out2
argument_list|(
name|port
argument_list|,
name|AM_IVR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* interrupt vector */
name|SET
argument_list|(
name|AM_RCR
argument_list|,
literal|0xc0
argument_list|)
expr_stmt|;
comment|/* rx 8 bits/char */
name|SET
argument_list|(
name|AM_TCR
argument_list|,
literal|0x60
argument_list|)
expr_stmt|;
comment|/* tx 8 bits/char */
name|SET
argument_list|(
name|AM_SAF
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* sync address field */
name|SET
argument_list|(
name|AM_SFR
argument_list|,
literal|0x7e
argument_list|)
expr_stmt|;
comment|/* sync flag register */
name|cte_out2
argument_list|(
name|port
argument_list|,
name|AM_MICR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* master interrupt control */
name|SET
argument_list|(
name|AM_MCR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* NRZ mode */
name|SET
argument_list|(
name|AM_CMR
argument_list|,
literal|0x08
argument_list|)
expr_stmt|;
comment|/* rxclk=RTxC, txclk=TRxC */
name|SET
argument_list|(
name|AM_TCL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* time constant low */
name|SET
argument_list|(
name|AM_TCH
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* time constant high */
name|SET
argument_list|(
name|AM_BCR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* disable baud rate generator */
name|SET
argument_list|(
name|AM_RCR
argument_list|,
literal|0xc1
argument_list|)
expr_stmt|;
comment|/* enable rx */
name|SET
argument_list|(
name|AM_TCR
argument_list|,
literal|0x68
argument_list|)
expr_stmt|;
comment|/* enable tx */
name|SET
argument_list|(
name|AM_SICR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* no status interrupt */
name|SET
argument_list|(
name|AM_CR
argument_list|,
name|CR_RST_EXTINT
argument_list|)
expr_stmt|;
comment|/* reset external status */
name|SET
argument_list|(
name|AM_CR
argument_list|,
name|CR_RST_EXTINT
argument_list|)
expr_stmt|;
comment|/* reset ext/status twice */
undef|#
directive|undef
name|SET
block|}
end_function

begin_comment
comment|/*  * Set up the Tau/E1 board.  */
end_comment

begin_function
name|void
name|ct_setup_e1
parameter_list|(
name|ct_board_t
modifier|*
name|b
parameter_list|)
block|{
comment|/* 	 * Control register 0: 	 * 1) board configuration 	 * 2) clock modes 	 */
name|b
operator|->
name|e1cfg
operator|&=
name|E1CFG_LED
expr_stmt|;
switch|switch
condition|(
name|b
operator|->
name|opt
operator|.
name|cfg
condition|)
block|{
case|case
name|CFG_C
case|:
name|b
operator|->
name|e1cfg
operator||=
name|E1CFG_K
expr_stmt|;
break|break;
case|case
name|CFG_B
case|:
name|b
operator|->
name|e1cfg
operator||=
name|E1CFG_HI
expr_stmt|;
break|break;
case|case
name|CFG_D
case|:
name|b
operator|->
name|e1cfg
operator||=
name|E1CFG_D
expr_stmt|;
break|break;
default|default:
name|b
operator|->
name|e1cfg
operator||=
name|E1CFG_II
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|b
operator|->
name|opt
operator|.
name|clk0
operator|==
name|GCLK_RCV
condition|)
name|b
operator|->
name|e1cfg
operator||=
name|E1CFG_CLK0_RCV
expr_stmt|;
if|if
condition|(
name|b
operator|->
name|opt
operator|.
name|clk0
operator|==
name|GCLK_RCLKO
condition|)
name|b
operator|->
name|e1cfg
operator||=
name|E1CFG_CLK0_RCLK1
expr_stmt|;
else|else
name|b
operator|->
name|e1cfg
operator||=
name|E1CFG_CLK0_INT
expr_stmt|;
if|if
condition|(
name|b
operator|->
name|opt
operator|.
name|clk1
operator|==
name|GCLK_RCV
condition|)
name|b
operator|->
name|e1cfg
operator||=
name|E1CFG_CLK1_RCV
expr_stmt|;
if|if
condition|(
name|b
operator|->
name|opt
operator|.
name|clk1
operator|==
name|GCLK_RCLKO
condition|)
name|b
operator|->
name|e1cfg
operator||=
name|E1CFG_CLK1_RCLK0
expr_stmt|;
else|else
name|b
operator|->
name|e1cfg
operator||=
name|E1CFG_CLK1_INT
expr_stmt|;
name|outb
argument_list|(
name|E1CFG
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|,
name|b
operator|->
name|e1cfg
argument_list|)
expr_stmt|;
comment|/* 	 * Set up serial controller. 	 */
name|ct_setup_scc
argument_list|(
name|b
operator|->
name|port
argument_list|)
expr_stmt|;
comment|/* 	 * Set up E1 controllers. 	 */
name|ct_setup_ctlr
argument_list|(
name|b
operator|->
name|chan
operator|+
literal|0
argument_list|)
expr_stmt|;
comment|/* channel 0 */
name|ct_setup_ctlr
argument_list|(
name|b
operator|->
name|chan
operator|+
literal|1
argument_list|)
expr_stmt|;
comment|/* channel 1 */
comment|/* Start the board (GRUN). */
name|b
operator|->
name|e1cfg
operator||=
name|E1CFG_GRUN
expr_stmt|;
name|outb
argument_list|(
name|E1CFG
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|,
name|b
operator|->
name|e1cfg
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Set up the G.703 controller of the Tau/G.703 board.  */
end_comment

begin_function
specifier|static
name|void
name|ct_setup_lxt
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|)
block|{
name|ctg_outx
argument_list|(
name|c
argument_list|,
name|LX_CCR1
argument_list|,
name|LX_RESET
argument_list|)
expr_stmt|;
comment|/* reset the chip */
comment|/* Delay */
name|ctg_inx
argument_list|(
name|c
argument_list|,
name|LX_CCR1
argument_list|)
expr_stmt|;
name|c
operator|->
name|lx
operator|=
name|LX_LOS
expr_stmt|;
comment|/* disable loss of sync interrupt */
if|if
condition|(
name|c
operator|->
name|num
operator|&&
name|c
operator|->
name|board
operator|->
name|opt
operator|.
name|cfg
operator|==
name|CFG_B
condition|)
name|c
operator|->
name|lx
operator||=
name|LX_TAOS
expr_stmt|;
comment|/* idle channel--transmit all ones */
if|if
condition|(
name|c
operator|->
name|gopt
operator|.
name|hdb3
condition|)
name|c
operator|->
name|lx
operator||=
name|LX_HDB3
expr_stmt|;
comment|/* enable HDB3 encoding */
name|ctg_outx
argument_list|(
name|c
argument_list|,
name|LX_CCR1
argument_list|,
name|c
operator|->
name|lx
argument_list|)
expr_stmt|;
comment|/* setup the new mode */
name|ctg_outx
argument_list|(
name|c
argument_list|,
name|LX_CCR2
argument_list|,
name|LX_CCR2_LH
argument_list|)
expr_stmt|;
comment|/* setup Long Haul mode */
name|ctg_outx
argument_list|(
name|c
argument_list|,
name|LX_CCR3
argument_list|,
name|LX_CCR3_E1_LH
argument_list|)
expr_stmt|;
comment|/* setup Long Haul mode */
block|}
end_function

begin_comment
comment|/*  * Set up the Tau/G.703 board.  */
end_comment

begin_function
name|void
name|ct_setup_g703
parameter_list|(
name|ct_board_t
modifier|*
name|b
parameter_list|)
block|{
name|b
operator|->
name|gmd0
operator|=
name|GMD_2048
expr_stmt|;
if|if
condition|(
name|b
operator|->
name|chan
index|[
literal|0
index|]
operator|.
name|gopt
operator|.
name|pce
condition|)
block|{
if|if
condition|(
name|b
operator|->
name|chan
index|[
literal|0
index|]
operator|.
name|gopt
operator|.
name|pce2
condition|)
name|b
operator|->
name|gmd0
operator||=
name|GMD_PCE_PCM2
expr_stmt|;
else|else
name|b
operator|->
name|gmd0
operator||=
name|GMD_PCE_PCM2D
expr_stmt|;
block|}
if|if
condition|(
name|b
operator|->
name|opt
operator|.
name|clk0
condition|)
name|b
operator|->
name|gmd0
operator||=
name|GMD_RSYNC
expr_stmt|;
name|b
operator|->
name|gmd1
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|b
operator|->
name|chan
index|[
literal|1
index|]
operator|.
name|gopt
operator|.
name|pce
condition|)
block|{
if|if
condition|(
name|b
operator|->
name|chan
index|[
literal|1
index|]
operator|.
name|gopt
operator|.
name|pce2
condition|)
name|b
operator|->
name|gmd1
operator||=
name|GMD_PCE_PCM2
expr_stmt|;
else|else
name|b
operator|->
name|gmd1
operator||=
name|GMD_PCE_PCM2D
expr_stmt|;
block|}
if|if
condition|(
name|b
operator|->
name|opt
operator|.
name|clk1
condition|)
name|b
operator|->
name|gmd1
operator||=
name|GMD_RSYNC
expr_stmt|;
switch|switch
condition|(
name|b
operator|->
name|chan
index|[
literal|0
index|]
operator|.
name|gopt
operator|.
name|rate
condition|)
block|{
case|case
literal|2048
case|:
name|b
operator|->
name|gmd0
operator||=
name|GMD_2048
expr_stmt|;
break|break;
case|case
literal|1024
case|:
name|b
operator|->
name|gmd0
operator||=
name|GMD_1024
expr_stmt|;
break|break;
case|case
literal|512
case|:
name|b
operator|->
name|gmd0
operator||=
name|GMD_512
expr_stmt|;
break|break;
case|case
literal|256
case|:
name|b
operator|->
name|gmd0
operator||=
name|GMD_256
expr_stmt|;
break|break;
case|case
literal|128
case|:
name|b
operator|->
name|gmd0
operator||=
name|GMD_128
expr_stmt|;
break|break;
case|case
literal|64
case|:
name|b
operator|->
name|gmd0
operator||=
name|GMD_64
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
name|b
operator|->
name|chan
index|[
literal|1
index|]
operator|.
name|gopt
operator|.
name|rate
condition|)
block|{
case|case
literal|2048
case|:
name|b
operator|->
name|gmd1
operator||=
name|GMD_2048
expr_stmt|;
break|break;
case|case
literal|1024
case|:
name|b
operator|->
name|gmd1
operator||=
name|GMD_1024
expr_stmt|;
break|break;
case|case
literal|512
case|:
name|b
operator|->
name|gmd1
operator||=
name|GMD_512
expr_stmt|;
break|break;
case|case
literal|256
case|:
name|b
operator|->
name|gmd1
operator||=
name|GMD_256
expr_stmt|;
break|break;
case|case
literal|128
case|:
name|b
operator|->
name|gmd1
operator||=
name|GMD_128
expr_stmt|;
break|break;
case|case
literal|64
case|:
name|b
operator|->
name|gmd1
operator||=
name|GMD_64
expr_stmt|;
break|break;
block|}
name|outb
argument_list|(
name|GMD0
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|,
name|b
operator|->
name|gmd0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|GMD1
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|,
name|b
operator|->
name|gmd1
operator||
name|GMD1_NCS0
operator||
name|GMD1_NCS1
argument_list|)
expr_stmt|;
name|b
operator|->
name|gmd2
operator|&=
name|GMD2_LED
expr_stmt|;
if|if
condition|(
name|b
operator|->
name|opt
operator|.
name|cfg
operator|==
name|CFG_B
condition|)
name|b
operator|->
name|gmd2
operator||=
name|GMD2_SERIAL
expr_stmt|;
name|outb
argument_list|(
name|GMD2
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|,
name|b
operator|->
name|gmd2
argument_list|)
expr_stmt|;
comment|/* Set up G.703 controllers. */
if|if
condition|(
operator|(
name|b
operator|->
name|chan
operator|+
literal|0
operator|)
operator|->
name|lx
operator|&
name|LX_LLOOP
condition|)
block|{
name|ct_setup_lxt
argument_list|(
name|b
operator|->
name|chan
operator|+
literal|0
argument_list|)
expr_stmt|;
comment|/* channel 0 */
name|ct_enable_loop
argument_list|(
name|b
operator|->
name|chan
operator|+
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ct_setup_lxt
argument_list|(
name|b
operator|->
name|chan
operator|+
literal|0
argument_list|)
expr_stmt|;
comment|/* channel 0 */
block|}
if|if
condition|(
operator|(
name|b
operator|->
name|chan
operator|+
literal|1
operator|)
operator|->
name|lx
operator|&
name|LX_LLOOP
condition|)
block|{
name|ct_setup_lxt
argument_list|(
name|b
operator|->
name|chan
operator|+
literal|1
argument_list|)
expr_stmt|;
comment|/* channel 1 */
name|ct_enable_loop
argument_list|(
name|b
operator|->
name|chan
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ct_setup_lxt
argument_list|(
name|b
operator|->
name|chan
operator|+
literal|1
argument_list|)
expr_stmt|;
comment|/* channel 1 */
block|}
comment|/* Clear errors. */
name|outb
argument_list|(
name|GERR
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|GLDR
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Set up the board.  */
end_comment

begin_function
name|int
name|ct_setup_board
parameter_list|(
name|ct_board_t
modifier|*
name|b
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|firmware
parameter_list|,
name|long
name|bits
parameter_list|,
specifier|const
name|cr_dat_tst_t
modifier|*
name|tst
parameter_list|)
block|{
name|ct_chan_t
modifier|*
name|c
decl_stmt|;
comment|/* Disable DMA channel. */
name|outb
argument_list|(
name|DMA_MASK
argument_list|,
operator|(
name|b
operator|->
name|dma
operator|&
literal|3
operator|)
operator||
name|DMA_MASK_CLEAR
argument_list|)
expr_stmt|;
comment|/* Reset the controller. */
name|outb
argument_list|(
name|BCR0
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Load the firmware. */
if|if
condition|(
name|firmware
operator|&&
operator|(
name|b
operator|->
name|type
operator|==
name|B_TAU
operator|||
name|b
operator|->
name|type
operator|==
name|B_TAU_E1
operator|||
name|b
operator|->
name|type
operator|==
name|B_TAU_G703
operator|)
operator|&&
operator|!
name|ct_download
argument_list|(
name|b
operator|->
name|port
argument_list|,
name|firmware
argument_list|,
name|bits
argument_list|,
name|tst
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|firmware
operator|&&
operator|(
name|b
operator|->
name|type
operator|==
name|B_TAU2
operator|||
name|b
operator|->
name|type
operator|==
name|B_TAU2_E1
operator|||
name|b
operator|->
name|type
operator|==
name|B_TAU2_E1D
operator|||
name|b
operator|->
name|type
operator|==
name|B_TAU2_G703
operator|)
operator|&&
operator|!
name|ct_download2
argument_list|(
name|b
operator|->
name|port
argument_list|,
name|firmware
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* Enable DMA and IRQ. */
name|outb
argument_list|(
name|BCR0
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|,
name|BCR0_HDRUN
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|BCR0
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|,
name|b
operator|->
name|bcr0
argument_list|)
expr_stmt|;
comment|/* Clear DTR[0..1]. */
name|outb
argument_list|(
name|BCR1
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|,
name|b
operator|->
name|bcr1
argument_list|)
expr_stmt|;
comment|/* Set bus timing. */
name|b
operator|->
name|bcr2
operator|=
name|b
operator|->
name|opt
operator|.
name|bcr2
expr_stmt|;
name|outb
argument_list|(
name|BCR2
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|,
name|b
operator|->
name|bcr2
argument_list|)
expr_stmt|;
comment|/* 	 * Initialize the controller. 	 */
comment|/* Zero wait state mode. */
name|outb
argument_list|(
name|WCRL
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|WCRM
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|WCRH
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Clear interrupt modified vector register. */
name|outb
argument_list|(
name|IMVR
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|ITCR
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|,
name|ITCR_CYCLE_SINGLE
operator||
name|ITCR_VECT_MOD
argument_list|)
expr_stmt|;
comment|/* Disable all interrupts. */
name|outb
argument_list|(
name|IER0
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|IER1
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|IER2
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Set DMA parameters, enable master DMA mode. */
name|outb
argument_list|(
argument|PCR(b->port)
argument_list|,
argument|BYTE b->opt.pcr
argument_list|)
empty_stmt|;
name|outb
argument_list|(
name|DMER
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|,
name|DME_ENABLE
argument_list|)
expr_stmt|;
comment|/* Set up DMA channel to master mode. */
name|outb
argument_list|(
name|DMA_MODE
argument_list|,
operator|(
name|b
operator|->
name|dma
operator|&
literal|3
operator|)
operator||
name|DMA_MODE_MASTER
argument_list|)
expr_stmt|;
comment|/* Enable DMA channel. */
name|outb
argument_list|(
name|DMA_MASK
argument_list|,
name|b
operator|->
name|dma
operator|&
literal|3
argument_list|)
expr_stmt|;
comment|/* Disable byte-sync mode for Tau/G.703. */
if|if
condition|(
name|b
operator|->
name|type
operator|==
name|B_TAU_G703
condition|)
name|outb
argument_list|(
name|GMD2
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Initialize all channels. */
for|for
control|(
name|c
operator|=
name|b
operator|->
name|chan
init|;
name|c
operator|<
name|b
operator|->
name|chan
operator|+
name|NCHAN
condition|;
operator|++
name|c
control|)
name|ct_setup_chan
argument_list|(
name|c
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|b
operator|->
name|type
condition|)
block|{
case|case
name|B_TAU_G703
case|:
case|case
name|B_TAU_G703C
case|:
case|case
name|B_TAU2_G703
case|:
name|ct_setup_g703
argument_list|(
name|b
argument_list|)
expr_stmt|;
break|break;
case|case
name|B_TAU_E1
case|:
case|case
name|B_TAU_E1C
case|:
case|case
name|B_TAU_E1D
case|:
case|case
name|B_TAU2_E1
case|:
case|case
name|B_TAU2_E1D
case|:
name|ct_setup_e1
argument_list|(
name|b
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Update the channel mode options.  */
end_comment

begin_function
name|void
name|ct_update_chan
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|)
block|{
name|int
name|txbr
decl_stmt|,
name|rxbr
decl_stmt|,
name|tmc
decl_stmt|,
name|txcout
decl_stmt|;
name|unsigned
name|char
name|rxs
decl_stmt|,
name|txs
decl_stmt|,
name|dmr
init|=
literal|0
decl_stmt|;
name|ct_md0_async_t
name|amd0
decl_stmt|;
name|ct_md0_hdlc_t
name|hmd0
decl_stmt|;
name|ct_md1_async_t
name|amd1
decl_stmt|;
switch|switch
condition|(
name|c
operator|->
name|mode
condition|)
block|{
comment|/* initialize the channel mode */
case|case
name|M_ASYNC
case|:
default|default:
name|rxs
operator|=
name|CLK_INT
expr_stmt|;
name|txs
operator|=
name|CLK_INT
expr_stmt|;
name|amd0
operator|.
name|mode
operator|=
name|MD0_MODE_ASYNC
expr_stmt|;
name|amd0
operator|.
name|stopb
operator|=
name|MD0_STOPB_1
expr_stmt|;
name|amd0
operator|.
name|cts_rts_dcd
operator|=
literal|0
expr_stmt|;
name|amd1
operator|.
name|clk
operator|=
name|MD1_CLK_16
expr_stmt|;
name|amd1
operator|.
name|txclen
operator|=
name|amd1
operator|.
name|rxclen
operator|=
name|MD1_CLEN_8
expr_stmt|;
name|amd1
operator|.
name|parmode
operator|=
name|MD1_PAR_NO
expr_stmt|;
name|outb
argument_list|(
argument|c->MD0
argument_list|,
argument|BYTE amd0
argument_list|)
empty_stmt|;
name|outb
argument_list|(
argument|c->MD1
argument_list|,
argument|BYTE amd1
argument_list|)
empty_stmt|;
name|outb
argument_list|(
name|c
operator|->
name|CTL
argument_list|,
name|c
operator|->
name|rts
condition|?
literal|0
else|:
name|CTL_RTS_INV
argument_list|)
expr_stmt|;
break|break;
case|case
name|M_E1
case|:
case|case
name|M_G703
case|:
case|case
name|M_HDLC
case|:
name|rxs
operator|=
name|c
operator|->
name|hopt
operator|.
name|rxs
expr_stmt|;
name|txs
operator|=
name|c
operator|->
name|hopt
operator|.
name|txs
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|mode
operator|==
name|M_E1
operator|&&
name|c
operator|->
name|board
operator|->
name|opt
operator|.
name|cfg
operator|==
name|CFG_D
condition|)
block|{
name|hmd0
operator|=
name|c
operator|->
name|hopt
operator|.
name|md0
expr_stmt|;
name|hmd0
operator|.
name|crc
operator|=
literal|0
expr_stmt|;
name|outb
argument_list|(
argument|c->MD0
argument_list|,
argument|BYTE hmd0
argument_list|)
empty_stmt|;
name|outb
argument_list|(
argument|c->MD1
argument_list|,
argument|BYTE c->hopt.md1
argument_list|)
empty_stmt|;
name|outb
argument_list|(
name|c
operator|->
name|CTL
argument_list|,
name|c
operator|->
name|hopt
operator|.
name|ctl
operator|&
operator|~
name|CTL_IDLE_PTRN
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|c
operator|->
name|SA0
argument_list|,
name|c
operator|->
name|hopt
operator|.
name|sa0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|c
operator|->
name|SA1
argument_list|,
name|c
operator|->
name|hopt
operator|.
name|sa1
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|c
operator|->
name|IDL
argument_list|,
literal|0x7e
argument_list|)
expr_stmt|;
comment|/* HDLC flag 01111110 */
block|}
else|else
block|{
name|outb
argument_list|(
argument|c->MD0
argument_list|,
argument|BYTE c->hopt.md0
argument_list|)
empty_stmt|;
name|outb
argument_list|(
argument|c->MD1
argument_list|,
argument|BYTE c->hopt.md1
argument_list|)
empty_stmt|;
name|outb
argument_list|(
name|c
operator|->
name|SA0
argument_list|,
name|c
operator|->
name|hopt
operator|.
name|sa0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|c
operator|->
name|SA1
argument_list|,
name|c
operator|->
name|hopt
operator|.
name|sa1
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|c
operator|->
name|IDL
argument_list|,
literal|0x7e
argument_list|)
expr_stmt|;
comment|/* HDLC flag 01111110 */
if|if
condition|(
name|c
operator|->
name|rts
condition|)
name|outb
argument_list|(
name|c
operator|->
name|CTL
argument_list|,
name|c
operator|->
name|hopt
operator|.
name|ctl
operator|&
operator|~
name|CTL_RTS_INV
argument_list|)
expr_stmt|;
else|else
name|outb
argument_list|(
name|c
operator|->
name|CTL
argument_list|,
name|c
operator|->
name|hopt
operator|.
name|ctl
operator||
name|CTL_RTS_INV
argument_list|)
expr_stmt|;
block|}
comment|/* Chained-block DMA mode with frame counter. */
name|dmr
operator||=
name|DMR_CHAIN_CNTE
operator||
name|DMR_CHAIN_NF
operator||
name|DMR_TMOD
expr_stmt|;
break|break;
block|}
name|outb
argument_list|(
name|c
operator|->
name|RX
operator|.
name|DMR
argument_list|,
name|dmr
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|c
operator|->
name|TX
operator|.
name|DMR
argument_list|,
name|dmr
argument_list|)
expr_stmt|;
comment|/* set mode-independent options */
name|c
operator|->
name|opt
operator|.
name|md2
operator|.
name|dpll_clk
operator|=
name|MD2_DPLL_CLK_8
expr_stmt|;
name|outb
argument_list|(
argument|c->MD2
argument_list|,
argument|BYTE c->opt.md2
argument_list|)
empty_stmt|;
comment|/* set up receiver and transmitter clocks */
if|if
condition|(
name|c
operator|->
name|baud
operator|>
literal|1024000
condition|)
block|{
comment|/* turn off DPLL if the baud rate is too high */
if|if
condition|(
name|rxs
operator|==
name|CLK_RXS_LINE_NS
condition|)
name|rxs
operator|=
name|CLK_LINE
expr_stmt|;
elseif|else
if|if
condition|(
name|rxs
operator|==
name|CLK_RXS_DPLL_INT
condition|)
name|rxs
operator|=
name|CLK_INT
expr_stmt|;
block|}
if|if
condition|(
name|rxs
operator|==
name|CLK_RXS_LINE_NS
operator|||
name|rxs
operator|==
name|CLK_RXS_DPLL_INT
condition|)
block|{
comment|/* Using 1:8 sampling rate. */
name|ct_compute_clock
argument_list|(
name|c
operator|->
name|board
operator|->
name|osc
argument_list|,
name|c
operator|->
name|baud
operator|*
literal|8
argument_list|,
operator|&
name|rxbr
argument_list|,
operator|&
name|tmc
argument_list|)
expr_stmt|;
name|txbr
operator|=
name|rxbr
operator|+
literal|3
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|c
operator|->
name|mode
operator|==
name|M_ASYNC
condition|)
block|{
comment|/* Using 1:16 sampling rate. */
name|ct_compute_clock
argument_list|(
name|c
operator|->
name|board
operator|->
name|osc
argument_list|,
name|c
operator|->
name|baud
operator|*
literal|8
argument_list|,
operator|&
name|rxbr
argument_list|,
operator|&
name|tmc
argument_list|)
expr_stmt|;
operator|--
name|rxbr
expr_stmt|;
name|txbr
operator|=
name|rxbr
expr_stmt|;
block|}
else|else
block|{
name|ct_compute_clock
argument_list|(
name|c
operator|->
name|board
operator|->
name|osc
argument_list|,
name|c
operator|->
name|baud
argument_list|,
operator|&
name|rxbr
argument_list|,
operator|&
name|tmc
argument_list|)
expr_stmt|;
name|txbr
operator|=
name|rxbr
expr_stmt|;
block|}
name|txs
operator||=
name|txbr
expr_stmt|;
name|rxs
operator||=
name|rxbr
expr_stmt|;
name|outb
argument_list|(
name|c
operator|->
name|TMC
argument_list|,
name|tmc
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|c
operator|->
name|RXS
argument_list|,
name|rxs
argument_list|)
expr_stmt|;
comment|/* Disable TXCOUT before changing TXS 	 * to avoid two transmitters on the same line. 	 * Enable it after TXS is set, if needed. */
name|txcout
operator|=
name|c
operator|->
name|num
condition|?
name|BCR1_TXCOUT1
else|:
name|BCR1_TXCOUT0
expr_stmt|;
name|c
operator|->
name|board
operator|->
name|bcr1
operator|&=
operator|~
name|txcout
expr_stmt|;
name|outb
argument_list|(
name|BCR1
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|board
operator|->
name|bcr1
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|c
operator|->
name|TXS
argument_list|,
name|txs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|txs
operator|&
name|CLK_MASK
operator|)
operator|!=
name|CLK_LINE
condition|)
block|{
name|c
operator|->
name|board
operator|->
name|bcr1
operator||=
name|txcout
expr_stmt|;
name|outb
argument_list|(
name|BCR1
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|board
operator|->
name|bcr1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|c
operator|->
name|board
operator|->
name|type
operator|==
name|B_TAU_E1D
operator|||
name|c
operator|->
name|board
operator|->
name|type
operator|==
name|B_TAU2_E1D
condition|)
name|ct_set_phony
argument_list|(
name|c
argument_list|,
name|c
operator|->
name|gopt
operator|.
name|phony
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Initialize the channel.  */
end_comment

begin_function
name|void
name|ct_setup_chan
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|)
block|{
comment|/* reset the channel */
name|outb
argument_list|(
name|c
operator|->
name|RX
operator|.
name|DSR
argument_list|,
name|DSR_DMA_DISABLE
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|c
operator|->
name|TX
operator|.
name|DSR
argument_list|,
name|DSR_DMA_DISABLE
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|c
operator|->
name|CMD
argument_list|,
name|CMD_TX_RESET
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|c
operator|->
name|CMD
argument_list|,
name|CMD_TX_ABORT
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|c
operator|->
name|CMD
argument_list|,
name|CMD_CHAN_RESET
argument_list|)
expr_stmt|;
comment|/* disable interrupts */
name|outb
argument_list|(
name|c
operator|->
name|IE0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|c
operator|->
name|IE1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|c
operator|->
name|IE2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|c
operator|->
name|FIE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* clear DTR, RTS */
name|ct_set_dtr
argument_list|(
name|c
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ct_set_rts
argument_list|(
name|c
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|c
operator|->
name|lx
operator|=
name|LX_LOS
expr_stmt|;
name|ct_update_chan
argument_list|(
name|c
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|unsigned
name|long
name|ct_get_ts
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|)
block|{
return|return
name|c
operator|->
name|num
condition|?
name|c
operator|->
name|board
operator|->
name|opt
operator|.
name|s1
else|:
name|c
operator|->
name|board
operator|->
name|opt
operator|.
name|s0
return|;
block|}
end_function

begin_comment
comment|/*  * Data transfer speed  */
end_comment

begin_function
name|unsigned
name|long
name|ct_get_baud
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|)
block|{
name|unsigned
name|long
name|speed
decl_stmt|;
name|unsigned
name|long
name|ts
decl_stmt|;
if|if
condition|(
name|c
operator|->
name|mode
operator|==
name|M_G703
condition|)
block|{
name|speed
operator|=
literal|1000
operator|*
name|c
operator|->
name|gopt
operator|.
name|rate
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|c
operator|->
name|mode
operator|==
name|M_E1
condition|)
block|{
name|ts
operator|=
name|ct_get_ts
argument_list|(
name|c
argument_list|)
expr_stmt|;
for|for
control|(
name|speed
operator|=
literal|0
init|;
name|ts
condition|;
name|ts
operator|>>=
literal|1
control|)
comment|/* Each timeslot is 64 Kbps */
if|if
condition|(
name|ts
operator|&
literal|1
condition|)
name|speed
operator|+=
literal|64000
expr_stmt|;
block|}
else|else
name|speed
operator|=
operator|(
name|c
operator|->
name|hopt
operator|.
name|txs
operator|==
name|CLK_INT
operator|)
condition|?
name|c
operator|->
name|baud
else|:
literal|0
expr_stmt|;
return|return
name|speed
return|;
block|}
end_function

begin_comment
comment|/*  * Turn local loopback on  */
end_comment

begin_function
specifier|static
name|void
name|ct_enable_loop
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|)
block|{
if|if
condition|(
name|c
operator|->
name|mode
operator|==
name|M_E1
condition|)
block|{
name|unsigned
name|short
name|p
init|=
name|c
operator|->
name|num
condition|?
name|E1CS1
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
else|:
name|E1CS0
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
decl_stmt|;
comment|/* Local loopback. */
name|cte_out
argument_list|(
name|p
argument_list|,
name|DS_CCR2
argument_list|,
name|cte_in
argument_list|(
name|p
argument_list|,
name|DS_CCR2
argument_list|)
operator||
name|CCR2_LLOOP
argument_list|)
expr_stmt|;
comment|/* Enable jitter attenuator at the transmit side. */
name|cte_out
argument_list|(
name|p
argument_list|,
name|DS_LICR
argument_list|,
name|cte_in
argument_list|(
name|p
argument_list|,
name|DS_LICR
argument_list|)
operator||
name|LICR_JA_TX
argument_list|)
expr_stmt|;
return|return;
block|}
elseif|else
if|if
condition|(
name|c
operator|->
name|mode
operator|==
name|M_G703
condition|)
block|{
name|c
operator|->
name|lx
operator|=
name|LX_LOS
operator||
name|LX_HDB3
expr_stmt|;
name|ctg_outx
argument_list|(
name|c
argument_list|,
name|LX_CCR1
argument_list|,
name|c
operator|->
name|lx
operator||=
name|LX_LLOOP
argument_list|)
expr_stmt|;
return|return;
block|}
elseif|else
if|if
condition|(
name|c
operator|->
name|mode
operator|==
name|M_HDLC
operator|&&
name|ct_get_baud
argument_list|(
name|c
argument_list|)
condition|)
block|{
name|unsigned
name|char
name|rxs
init|=
name|inb
argument_list|(
name|c
operator|->
name|RXS
argument_list|)
operator|&
operator|~
name|CLK_MASK
decl_stmt|;
name|unsigned
name|char
name|txs
init|=
name|inb
argument_list|(
name|c
operator|->
name|TXS
argument_list|)
operator|&
operator|~
name|CLK_MASK
decl_stmt|;
name|int
name|txcout
init|=
name|c
operator|->
name|num
condition|?
name|BCR1_TXCOUT1
else|:
name|BCR1_TXCOUT0
decl_stmt|;
name|c
operator|->
name|opt
operator|.
name|md2
operator|.
name|loop
operator|=
name|MD2_LLOOP
expr_stmt|;
comment|/* Disable TXCOUT before changing TXS */
comment|/* to avoid two transmitters on the same line. */
comment|/* Enable it after TXS is set. */
name|outb
argument_list|(
name|BCR1
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|board
operator|->
name|bcr1
operator|&
operator|~
name|txcout
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|c
operator|->
name|RXS
argument_list|,
name|rxs
operator||
name|CLK_INT
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|c
operator|->
name|TXS
argument_list|,
name|txs
operator||
name|CLK_INT
argument_list|)
expr_stmt|;
name|c
operator|->
name|board
operator|->
name|bcr1
operator||=
name|txcout
expr_stmt|;
name|outb
argument_list|(
name|BCR1
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|board
operator|->
name|bcr1
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|c
operator|->
name|MD2
argument_list|,
operator|*
operator|(
name|unsigned
name|char
operator|*
operator|)
operator|&
name|c
operator|->
name|opt
operator|.
name|md2
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
end_function

begin_comment
comment|/*  * Turn local loopback off  */
end_comment

begin_function
specifier|static
name|void
name|ct_disable_loop
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|)
block|{
if|if
condition|(
name|c
operator|->
name|mode
operator|==
name|M_E1
condition|)
block|{
name|unsigned
name|short
name|p
init|=
name|c
operator|->
name|num
condition|?
name|E1CS1
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
else|:
name|E1CS0
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
decl_stmt|;
comment|/* Local loopback. */
name|cte_out
argument_list|(
name|p
argument_list|,
name|DS_CCR2
argument_list|,
name|cte_in
argument_list|(
name|p
argument_list|,
name|DS_CCR2
argument_list|)
operator|&
operator|~
name|CCR2_LLOOP
argument_list|)
expr_stmt|;
comment|/* Disable jitter attenuator at the transmit side. */
name|cte_out
argument_list|(
name|p
argument_list|,
name|DS_LICR
argument_list|,
name|cte_in
argument_list|(
name|p
argument_list|,
name|DS_LICR
argument_list|)
operator|&
operator|~
name|LICR_JA_TX
argument_list|)
expr_stmt|;
return|return;
block|}
elseif|else
if|if
condition|(
name|c
operator|->
name|mode
operator|==
name|M_G703
condition|)
block|{
name|c
operator|->
name|lx
operator|=
name|LX_LOS
operator||
name|LX_HDB3
expr_stmt|;
name|ctg_outx
argument_list|(
name|c
argument_list|,
name|LX_CCR1
argument_list|,
name|c
operator|->
name|lx
argument_list|)
expr_stmt|;
return|return;
block|}
elseif|else
if|if
condition|(
name|c
operator|->
name|mode
operator|==
name|M_HDLC
operator|&&
name|ct_get_baud
argument_list|(
name|c
argument_list|)
condition|)
block|{
name|unsigned
name|char
name|rxs
init|=
name|inb
argument_list|(
name|c
operator|->
name|RXS
argument_list|)
operator|&
operator|~
name|CLK_MASK
decl_stmt|;
name|unsigned
name|char
name|txs
init|=
name|inb
argument_list|(
name|c
operator|->
name|TXS
argument_list|)
operator|&
operator|~
name|CLK_MASK
decl_stmt|;
name|int
name|txcout
init|=
name|c
operator|->
name|num
condition|?
name|BCR1_TXCOUT1
else|:
name|BCR1_TXCOUT0
decl_stmt|;
name|c
operator|->
name|opt
operator|.
name|md2
operator|.
name|loop
operator|=
name|MD2_FDX
expr_stmt|;
name|outb
argument_list|(
name|BCR1
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|board
operator|->
name|bcr1
operator|&
operator|~
name|txcout
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|c
operator|->
name|RXS
argument_list|,
name|rxs
operator||
name|CLK_LINE
argument_list|)
expr_stmt|;
if|if
condition|(
name|ct_get_baud
argument_list|(
name|c
argument_list|)
condition|)
name|outb
argument_list|(
name|c
operator|->
name|TXS
argument_list|,
name|txs
operator||
name|CLK_INT
argument_list|)
expr_stmt|;
else|else
name|outb
argument_list|(
name|c
operator|->
name|TXS
argument_list|,
name|txs
operator||
name|CLK_LINE
argument_list|)
expr_stmt|;
name|c
operator|->
name|board
operator|->
name|bcr1
operator||=
name|txcout
expr_stmt|;
name|outb
argument_list|(
name|BCR1
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|board
operator|->
name|bcr1
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|c
operator|->
name|MD2
argument_list|,
operator|*
operator|(
name|unsigned
name|char
operator|*
operator|)
operator|&
name|c
operator|->
name|opt
operator|.
name|md2
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
end_function

begin_comment
comment|/*  * Turn local loopback on/off  */
end_comment

begin_function
name|void
name|ct_set_loop
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|,
name|int
name|on
parameter_list|)
block|{
if|if
condition|(
name|on
condition|)
name|ct_enable_loop
argument_list|(
name|c
argument_list|)
expr_stmt|;
else|else
name|ct_disable_loop
argument_list|(
name|c
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|ct_get_loop
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|)
block|{
if|if
condition|(
name|c
operator|->
name|mode
operator|==
name|M_E1
condition|)
block|{
name|unsigned
name|short
name|p
init|=
name|c
operator|->
name|num
condition|?
name|E1CS1
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
else|:
name|E1CS0
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
decl_stmt|;
return|return
name|cte_in
argument_list|(
name|p
argument_list|,
name|DS_CCR2
argument_list|)
operator|&
name|CCR2_LLOOP
return|;
block|}
if|if
condition|(
name|c
operator|->
name|mode
operator|==
name|M_G703
condition|)
return|return
name|c
operator|->
name|lx
operator|&
name|LX_LLOOP
return|;
comment|/* M_HDLC */
return|return
operator|(
name|c
operator|->
name|opt
operator|.
name|md2
operator|.
name|loop
operator|&
name|MD2_LLOOP
operator|)
operator|!=
literal|0
return|;
block|}
end_function

begin_function
name|void
name|ct_set_phony
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|,
name|int
name|on
parameter_list|)
block|{
comment|/* Valid only for TauPCI-E1. */
if|if
condition|(
name|c
operator|->
name|board
operator|->
name|type
operator|!=
name|B_TAU_E1D
operator|&&
name|c
operator|->
name|board
operator|->
name|type
operator|!=
name|B_TAU2_E1D
condition|)
return|return;
name|c
operator|->
name|gopt
operator|.
name|phony
operator|=
operator|(
name|on
operator|!=
literal|0
operator|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|gopt
operator|.
name|phony
condition|)
block|{
name|c
operator|->
name|board
operator|->
name|e1syn
operator||=
name|c
operator|->
name|num
condition|?
name|E1SYN_ENS1
else|:
name|E1SYN_ENS0
expr_stmt|;
comment|/* No receive/transmit crc. */
name|c
operator|->
name|hopt
operator|.
name|md0
operator|.
name|crc
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|c
operator|->
name|board
operator|->
name|e1syn
operator|&=
operator|~
operator|(
name|c
operator|->
name|num
condition|?
name|E1SYN_ENS1
else|:
name|E1SYN_ENS0
operator|)
expr_stmt|;
comment|/* Enable crc. */
name|c
operator|->
name|hopt
operator|.
name|md0
operator|.
name|crc
operator|=
literal|1
expr_stmt|;
block|}
name|outb
argument_list|(
argument|c->MD0
argument_list|,
argument|BYTE c->hopt.md0
argument_list|)
empty_stmt|;
name|outb
argument_list|(
name|E1SYN
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|board
operator|->
name|e1syn
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ct_start_receiver
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|,
name|int
name|dma
parameter_list|,
name|unsigned
name|long
name|buf
parameter_list|,
name|unsigned
name|len
parameter_list|,
name|unsigned
name|long
name|desc
parameter_list|,
name|unsigned
name|long
name|lim
parameter_list|)
block|{
name|int
name|ier0
init|=
name|inb
argument_list|(
name|IER0
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|)
decl_stmt|;
name|int
name|ier1
init|=
name|inb
argument_list|(
name|IER1
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|)
decl_stmt|;
name|int
name|ier2
init|=
name|inb
argument_list|(
name|IER2
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|)
decl_stmt|;
name|int
name|ie0
init|=
name|inb
argument_list|(
name|c
operator|->
name|IE0
argument_list|)
decl_stmt|;
name|int
name|ie2
init|=
name|inb
argument_list|(
name|c
operator|->
name|IE2
argument_list|)
decl_stmt|;
if|if
condition|(
name|dma
condition|)
block|{
name|ier1
operator||=
name|c
operator|->
name|num
condition|?
operator|(
name|IER1_RX_DMERE_1
operator||
name|IER1_RX_DME_1
operator|)
else|:
operator|(
name|IER1_RX_DMERE_0
operator||
name|IER1_RX_DME_0
operator|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|mode
operator|==
name|M_ASYNC
condition|)
block|{
name|ier0
operator||=
name|c
operator|->
name|num
condition|?
name|IER0_RX_INTE_1
else|:
name|IER0_RX_INTE_0
expr_stmt|;
name|ie0
operator||=
name|IE0_RX_INTE
expr_stmt|;
name|ie2
operator||=
name|IE2_OVRNE
operator||
name|IE2_ASYNC_FRMEE
operator||
name|IE2_ASYNC_PEE
expr_stmt|;
block|}
block|}
else|else
block|{
name|ier0
operator||=
name|c
operator|->
name|num
condition|?
operator|(
name|IER0_RX_INTE_1
operator||
name|IER0_RX_RDYE_1
operator|)
else|:
operator|(
name|IER0_RX_INTE_0
operator||
name|IER0_RX_RDYE_0
operator|)
expr_stmt|;
name|ie0
operator||=
name|IE0_RX_INTE
operator||
name|IE0_RX_RDYE
expr_stmt|;
block|}
comment|/* Start timer. */
if|if
condition|(
operator|!
name|dma
condition|)
block|{
name|outb
argument_list|(
name|c
operator|->
name|RX
operator|.
name|TEPR
argument_list|,
name|TEPR_64
argument_list|)
expr_stmt|;
comment|/* prescale to 16 kHz */
name|outw
argument_list|(
name|c
operator|->
name|RX
operator|.
name|TCONR
argument_list|,
literal|160
argument_list|)
expr_stmt|;
comment|/* period is 10 msec */
name|outw
argument_list|(
name|c
operator|->
name|RX
operator|.
name|TCNT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|c
operator|->
name|RX
operator|.
name|TCSR
argument_list|,
name|TCSR_ENABLE
operator||
name|TCSR_INTR
argument_list|)
expr_stmt|;
name|ier2
operator||=
name|c
operator|->
name|num
condition|?
name|IER2_RX_TME_1
else|:
name|IER2_RX_TME_0
expr_stmt|;
block|}
comment|/* Enable interrupts. */
name|outb
argument_list|(
name|IER0
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|,
name|ier0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|IER1
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|,
name|ier1
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|IER2
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|,
name|ier2
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|c
operator|->
name|IE0
argument_list|,
name|ie0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|c
operator|->
name|IE2
argument_list|,
name|ie2
argument_list|)
expr_stmt|;
comment|/* RXRDY:=1 when the receive buffer has more than RRC chars */
name|outb
argument_list|(
name|c
operator|->
name|RRC
argument_list|,
name|dma
condition|?
name|c
operator|->
name|opt
operator|.
name|dma_rrc
else|:
name|c
operator|->
name|opt
operator|.
name|pio_rrc
argument_list|)
expr_stmt|;
comment|/* Start receiver. */
if|if
condition|(
name|dma
condition|)
block|{
name|outb
argument_list|(
name|c
operator|->
name|RX
operator|.
name|DCR
argument_list|,
name|DCR_ABORT
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|mode
operator|==
name|M_ASYNC
condition|)
block|{
comment|/* Single-buffer DMA mode. */
name|outb
argument_list|(
name|c
operator|->
name|RX
operator|.
name|DARB
argument_list|,
call|(
name|unsigned
name|char
call|)
argument_list|(
name|buf
operator|>>
literal|16
argument_list|)
argument_list|)
expr_stmt|;
name|outw
argument_list|(
name|c
operator|->
name|RX
operator|.
name|DAR
argument_list|,
operator|(
name|unsigned
name|short
operator|)
name|buf
argument_list|)
expr_stmt|;
name|outw
argument_list|(
name|c
operator|->
name|RX
operator|.
name|BCR
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|c
operator|->
name|RX
operator|.
name|DIR
argument_list|,
name|DIR_EOTE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Chained-buffer DMA mode. */
name|outb
argument_list|(
name|c
operator|->
name|RX
operator|.
name|SARB
argument_list|,
call|(
name|unsigned
name|char
call|)
argument_list|(
name|desc
operator|>>
literal|16
argument_list|)
argument_list|)
expr_stmt|;
name|outw
argument_list|(
name|c
operator|->
name|RX
operator|.
name|EDA
argument_list|,
operator|(
name|unsigned
name|short
operator|)
name|lim
argument_list|)
expr_stmt|;
name|outw
argument_list|(
name|c
operator|->
name|RX
operator|.
name|CDA
argument_list|,
operator|(
name|unsigned
name|short
operator|)
name|desc
argument_list|)
expr_stmt|;
name|outw
argument_list|(
name|c
operator|->
name|RX
operator|.
name|BFL
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|c
operator|->
name|RX
operator|.
name|DIR
argument_list|,
name|DIR_CHAIN_EOME
operator||
name|DIR_CHAIN_BOFE
operator||
name|DIR_CHAIN_COFE
argument_list|)
expr_stmt|;
block|}
name|outb
argument_list|(
name|c
operator|->
name|RX
operator|.
name|DSR
argument_list|,
name|DSR_DMA_ENABLE
argument_list|)
expr_stmt|;
block|}
name|outb
argument_list|(
name|c
operator|->
name|CMD
argument_list|,
name|CMD_RX_ENABLE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ct_start_transmitter
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|,
name|int
name|dma
parameter_list|,
name|unsigned
name|long
name|buf
parameter_list|,
name|unsigned
name|len
parameter_list|,
name|unsigned
name|long
name|desc
parameter_list|,
name|unsigned
name|long
name|lim
parameter_list|)
block|{
name|int
name|ier0
init|=
name|inb
argument_list|(
name|IER0
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|)
decl_stmt|;
name|int
name|ier1
init|=
name|inb
argument_list|(
name|IER1
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|)
decl_stmt|;
name|int
name|ie0
init|=
name|inb
argument_list|(
name|c
operator|->
name|IE0
argument_list|)
decl_stmt|;
name|int
name|ie1
init|=
name|inb
argument_list|(
name|c
operator|->
name|IE1
argument_list|)
decl_stmt|;
comment|/* Enable underrun interrupt in HDLC and raw modes. */
if|if
condition|(
name|c
operator|->
name|mode
operator|!=
name|M_ASYNC
condition|)
block|{
name|ier0
operator||=
name|c
operator|->
name|num
condition|?
name|IER0_TX_INTE_1
else|:
name|IER0_TX_INTE_0
expr_stmt|;
name|ie0
operator||=
name|IE0_TX_INTE
expr_stmt|;
name|ie1
operator||=
name|IE1_HDLC_UDRNE
expr_stmt|;
block|}
if|if
condition|(
name|dma
condition|)
name|ier1
operator||=
name|c
operator|->
name|num
condition|?
operator|(
name|IER1_TX_DMERE_1
operator||
name|IER1_TX_DME_1
operator|)
else|:
operator|(
name|IER1_TX_DMERE_0
operator||
name|IER1_TX_DME_0
operator|)
expr_stmt|;
else|else
block|{
name|ier0
operator||=
name|c
operator|->
name|num
condition|?
name|IER0_TX_RDYE_1
else|:
name|IER0_TX_RDYE_0
expr_stmt|;
name|ie0
operator||=
name|IE0_TX_RDYE
expr_stmt|;
block|}
comment|/* Enable interrupts. */
name|outb
argument_list|(
name|IER0
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|,
name|ier0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|IER1
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|,
name|ier1
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|c
operator|->
name|IE0
argument_list|,
name|ie0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|c
operator|->
name|IE1
argument_list|,
name|ie1
argument_list|)
expr_stmt|;
comment|/* TXRDY:=1 when the transmit buffer has TRC0 or less chars, 	 * TXRDY:=0 when the transmit buffer has more than TRC1 chars */
name|outb
argument_list|(
name|c
operator|->
name|TRC0
argument_list|,
name|dma
condition|?
name|c
operator|->
name|opt
operator|.
name|dma_trc0
else|:
name|c
operator|->
name|opt
operator|.
name|pio_trc0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|c
operator|->
name|TRC1
argument_list|,
name|dma
condition|?
name|c
operator|->
name|opt
operator|.
name|dma_trc1
else|:
name|c
operator|->
name|opt
operator|.
name|pio_trc1
argument_list|)
expr_stmt|;
comment|/* Start transmitter. */
if|if
condition|(
name|dma
condition|)
block|{
name|outb
argument_list|(
name|c
operator|->
name|TX
operator|.
name|DCR
argument_list|,
name|DCR_ABORT
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|mode
operator|==
name|M_ASYNC
condition|)
block|{
comment|/* Single-buffer DMA mode. */
name|outb
argument_list|(
name|c
operator|->
name|TX
operator|.
name|SARB
argument_list|,
call|(
name|unsigned
name|char
call|)
argument_list|(
name|buf
operator|>>
literal|16
argument_list|)
argument_list|)
expr_stmt|;
name|outw
argument_list|(
name|c
operator|->
name|TX
operator|.
name|SAR
argument_list|,
operator|(
name|unsigned
name|short
operator|)
name|buf
argument_list|)
expr_stmt|;
name|outw
argument_list|(
name|c
operator|->
name|TX
operator|.
name|BCR
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|c
operator|->
name|TX
operator|.
name|DIR
argument_list|,
name|DIR_EOTE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Chained-buffer DMA mode. */
name|outb
argument_list|(
name|c
operator|->
name|TX
operator|.
name|SARB
argument_list|,
call|(
name|unsigned
name|char
call|)
argument_list|(
name|desc
operator|>>
literal|16
argument_list|)
argument_list|)
expr_stmt|;
name|outw
argument_list|(
name|c
operator|->
name|TX
operator|.
name|EDA
argument_list|,
operator|(
name|unsigned
name|short
operator|)
name|lim
argument_list|)
expr_stmt|;
name|outw
argument_list|(
name|c
operator|->
name|TX
operator|.
name|CDA
argument_list|,
operator|(
name|unsigned
name|short
operator|)
name|desc
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|c
operator|->
name|TX
operator|.
name|DIR
argument_list|,
comment|/* DIR_CHAIN_EOME | */
name|DIR_CHAIN_BOFE
operator||
name|DIR_CHAIN_COFE
argument_list|)
expr_stmt|;
block|}
comment|/* Set DSR_DMA_ENABLE to begin! */
block|}
name|outb
argument_list|(
name|c
operator|->
name|CMD
argument_list|,
name|CMD_TX_ENABLE
argument_list|)
expr_stmt|;
comment|/* Clear errors. */
if|if
condition|(
name|c
operator|->
name|board
operator|->
name|type
operator|==
name|B_TAU_G703
condition|)
block|{
name|outb
argument_list|(
name|GERR
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|GLDR
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Control DTR signal for the channel.  * Turn it on/off.  */
end_comment

begin_function
name|void
name|ct_set_dtr
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|,
name|int
name|on
parameter_list|)
block|{
if|if
condition|(
name|on
condition|)
block|{
name|c
operator|->
name|dtr
operator|=
literal|1
expr_stmt|;
name|c
operator|->
name|board
operator|->
name|bcr1
operator||=
name|c
operator|->
name|num
condition|?
name|BCR1_DTR1
else|:
name|BCR1_DTR0
expr_stmt|;
block|}
else|else
block|{
name|c
operator|->
name|dtr
operator|=
literal|0
expr_stmt|;
name|c
operator|->
name|board
operator|->
name|bcr1
operator|&=
operator|~
operator|(
name|c
operator|->
name|num
condition|?
name|BCR1_DTR1
else|:
name|BCR1_DTR0
operator|)
expr_stmt|;
block|}
name|outb
argument_list|(
name|BCR1
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|board
operator|->
name|bcr1
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Control RTS signal for the channel.  * Turn it on/off.  */
end_comment

begin_function
name|void
name|ct_set_rts
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|,
name|int
name|on
parameter_list|)
block|{
name|c
operator|->
name|rts
operator|=
operator|(
name|on
operator|!=
literal|0
operator|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|rts
condition|)
name|outb
argument_list|(
name|c
operator|->
name|CTL
argument_list|,
name|inb
argument_list|(
name|c
operator|->
name|CTL
argument_list|)
operator|&
operator|~
name|CTL_RTS_INV
argument_list|)
expr_stmt|;
else|else
name|outb
argument_list|(
name|c
operator|->
name|CTL
argument_list|,
name|inb
argument_list|(
name|c
operator|->
name|CTL
argument_list|)
operator||
name|CTL_RTS_INV
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Control BREAK state in asynchronous mode.  * Turn it on/off.  */
end_comment

begin_function
name|void
name|ct_set_brk
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|,
name|int
name|on
parameter_list|)
block|{
if|if
condition|(
name|c
operator|->
name|mode
operator|!=
name|M_ASYNC
condition|)
return|return;
if|if
condition|(
name|on
condition|)
name|outb
argument_list|(
name|c
operator|->
name|CTL
argument_list|,
name|inb
argument_list|(
name|c
operator|->
name|CTL
argument_list|)
operator||
name|CTL_BRK
argument_list|)
expr_stmt|;
else|else
name|outb
argument_list|(
name|c
operator|->
name|CTL
argument_list|,
name|inb
argument_list|(
name|c
operator|->
name|CTL
argument_list|)
operator|&
operator|~
name|CTL_BRK
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Get the state of DSR signal of the channel.  */
end_comment

begin_function
name|int
name|ct_get_dsr
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|)
block|{
return|return
operator|(
name|inb
argument_list|(
name|BSR1
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|)
operator|&
operator|(
name|c
operator|->
name|num
condition|?
name|BSR1_DSR1
else|:
name|BSR1_DSR0
operator|)
operator|)
operator|!=
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Get the G.703 line signal level.  */
end_comment

begin_function
name|int
name|ct_get_lq
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|)
block|{
name|unsigned
name|char
name|q1
decl_stmt|,
name|q2
decl_stmt|,
name|q3
decl_stmt|;
specifier|static
name|int
name|lq_to_santibells
index|[]
init|=
block|{
literal|0
block|,
literal|95
block|,
literal|195
block|,
literal|285
block|}
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|c
operator|->
name|type
operator|&
name|T_G703
operator|)
condition|)
return|return
literal|0
return|;
name|q1
operator|=
name|inb
argument_list|(
name|GLQ
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Repeat reading the register to produce a 10-usec delay. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|20
condition|;
operator|++
name|i
control|)
name|q2
operator|=
name|inb
argument_list|(
name|GLQ
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|20
condition|;
operator|++
name|i
control|)
name|q3
operator|=
name|inb
argument_list|(
name|GLQ
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|num
condition|)
block|{
name|q1
operator|>>=
name|GLQ_SHIFT
expr_stmt|;
name|q2
operator|>>=
name|GLQ_SHIFT
expr_stmt|;
name|q3
operator|>>=
name|GLQ_SHIFT
expr_stmt|;
block|}
name|q1
operator|&=
name|GLQ_MASK
expr_stmt|;
name|q2
operator|&=
name|GLQ_MASK
expr_stmt|;
name|q3
operator|&=
name|GLQ_MASK
expr_stmt|;
if|if
condition|(
name|q1
operator|<=
name|q2
operator|&&
name|q2
operator|<=
name|q3
condition|)
return|return
name|lq_to_santibells
index|[
name|q2
index|]
return|;
if|if
condition|(
name|q2
operator|<=
name|q3
operator|&&
name|q3
operator|<=
name|q1
condition|)
return|return
name|lq_to_santibells
index|[
name|q3
index|]
return|;
if|if
condition|(
name|q3
operator|<=
name|q1
operator|&&
name|q1
operator|<=
name|q2
condition|)
return|return
name|lq_to_santibells
index|[
name|q1
index|]
return|;
if|if
condition|(
name|q1
operator|<=
name|q3
operator|&&
name|q3
operator|<=
name|q2
condition|)
return|return
name|lq_to_santibells
index|[
name|q3
index|]
return|;
if|if
condition|(
name|q3
operator|<=
name|q2
operator|&&
name|q2
operator|<=
name|q1
condition|)
return|return
name|lq_to_santibells
index|[
name|q2
index|]
return|;
comment|/* if (q2<= q1&& q1<= q3) */
return|return
name|lq_to_santibells
index|[
name|q1
index|]
return|;
block|}
end_function

begin_comment
comment|/*  * Get the state of CARRIER signal of the channel.  */
end_comment

begin_function
name|int
name|ct_get_cd
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|)
block|{
return|return
operator|(
name|inb
argument_list|(
name|c
operator|->
name|ST3
argument_list|)
operator|&
name|ST3_DCD_INV
operator|)
operator|==
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Get the state of CTS signal of the channel.  */
end_comment

begin_function
name|int
name|ct_get_cts
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|)
block|{
return|return
operator|(
name|inb
argument_list|(
name|c
operator|->
name|ST3
argument_list|)
operator|&
name|ST3_CTS_INV
operator|)
operator|==
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Turn LED on/off.  */
end_comment

begin_function
name|void
name|ct_led
parameter_list|(
name|ct_board_t
modifier|*
name|b
parameter_list|,
name|int
name|on
parameter_list|)
block|{
switch|switch
condition|(
name|b
operator|->
name|type
condition|)
block|{
case|case
name|B_TAU_G703
case|:
case|case
name|B_TAU_G703C
case|:
case|case
name|B_TAU2_G703
case|:
if|if
condition|(
name|on
condition|)
name|b
operator|->
name|gmd2
operator||=
name|GMD2_LED
expr_stmt|;
else|else
name|b
operator|->
name|gmd2
operator|&=
operator|~
name|GMD2_LED
expr_stmt|;
name|outb
argument_list|(
name|GMD2
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|,
name|b
operator|->
name|gmd2
argument_list|)
expr_stmt|;
break|break;
default|default:
if|if
condition|(
name|on
condition|)
name|b
operator|->
name|e1cfg
operator||=
name|E1CFG_LED
expr_stmt|;
else|else
name|b
operator|->
name|e1cfg
operator|&=
operator|~
name|E1CFG_LED
expr_stmt|;
name|outb
argument_list|(
name|E1CFG
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|,
name|b
operator|->
name|e1cfg
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
name|void
name|ct_disable_dma
parameter_list|(
name|ct_board_t
modifier|*
name|b
parameter_list|)
block|{
comment|/* Disable DMA channel. */
name|outb
argument_list|(
name|DMA_MASK
argument_list|,
operator|(
name|b
operator|->
name|dma
operator|&
literal|3
operator|)
operator||
name|DMA_MASK_CLEAR
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ct_compute_clock
parameter_list|(
name|long
name|hz
parameter_list|,
name|long
name|baud
parameter_list|,
name|int
modifier|*
name|txbr
parameter_list|,
name|int
modifier|*
name|tmc
parameter_list|)
block|{
if|if
condition|(
name|baud
operator|<
literal|100
condition|)
name|baud
operator|=
literal|100
expr_stmt|;
operator|*
name|txbr
operator|=
literal|0
expr_stmt|;
if|if
condition|(
literal|4
operator|*
name|baud
operator|>
literal|3
operator|*
name|hz
condition|)
operator|*
name|tmc
operator|=
literal|1
expr_stmt|;
else|else
block|{
while|while
condition|(
operator|(
operator|(
name|hz
operator|/
name|baud
operator|)
operator|>>
operator|++
operator|*
name|txbr
operator|)
operator|>
literal|256
condition|)
continue|continue;
operator|*
name|tmc
operator|=
operator|(
operator|(
operator|(
literal|2
operator|*
name|hz
operator|/
name|baud
operator|)
operator|>>
operator|*
name|txbr
operator|)
operator|+
literal|1
operator|)
operator|/
literal|2
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Access to DS2153 chips on the Tau/E1 board.  * Examples:  *	val = cte_in (E1CSi (base), DS_RCR1)  *	cte_out (E1CSi (base), DS_CCR1, val)  *	val = cte_ins (E1CSi (base), DS_SSR)  */
end_comment

begin_function
name|unsigned
name|char
name|cte_in
parameter_list|(
name|port_t
name|base
parameter_list|,
name|unsigned
name|char
name|reg
parameter_list|)
block|{
name|outb
argument_list|(
name|base
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
name|inb
argument_list|(
name|E1DAT
argument_list|(
name|base
operator|&
literal|0x3e0
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|cte_out
parameter_list|(
name|port_t
name|base
parameter_list|,
name|unsigned
name|char
name|reg
parameter_list|,
name|unsigned
name|char
name|val
parameter_list|)
block|{
name|outb
argument_list|(
name|base
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|E1DAT
argument_list|(
name|base
operator|&
literal|0x3e0
argument_list|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Get the DS2153 status register, using write-read-write scheme.  */
end_comment

begin_function
name|unsigned
name|char
name|cte_ins
parameter_list|(
name|port_t
name|base
parameter_list|,
name|unsigned
name|char
name|reg
parameter_list|,
name|unsigned
name|char
name|mask
parameter_list|)
block|{
name|unsigned
name|char
name|val
decl_stmt|;
name|port_t
name|rw
init|=
name|E1DAT
argument_list|(
name|base
operator|&
literal|0x3e0
argument_list|)
decl_stmt|;
name|outb
argument_list|(
name|base
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|rw
argument_list|,
name|mask
argument_list|)
expr_stmt|;
comment|/* lock bits */
name|outb
argument_list|(
name|base
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|val
operator|=
name|inb
argument_list|(
name|rw
argument_list|)
operator|&
name|mask
expr_stmt|;
comment|/* get values */
name|outb
argument_list|(
name|base
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|rw
argument_list|,
name|val
argument_list|)
expr_stmt|;
comment|/* unlock bits */
return|return
name|val
return|;
block|}
end_function

begin_comment
comment|/*  * Access to 8530 chip on the Tau/E1 board.  * Examples:  *	val = cte_in2 (base, AM_RSR | AM_A)  *	cte_out2 (base, AM_IMR, val)  */
end_comment

begin_function
name|unsigned
name|char
name|cte_in2
parameter_list|(
name|port_t
name|base
parameter_list|,
name|unsigned
name|char
name|reg
parameter_list|)
block|{
name|outb
argument_list|(
name|E1CS2
argument_list|(
name|base
argument_list|)
argument_list|,
name|E1CS2_SCC
operator||
name|reg
operator|>>
literal|4
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|E1DAT
argument_list|(
name|base
argument_list|)
argument_list|,
name|reg
operator|&
literal|15
argument_list|)
expr_stmt|;
return|return
name|inb
argument_list|(
name|E1DAT
argument_list|(
name|base
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|cte_out2
parameter_list|(
name|port_t
name|base
parameter_list|,
name|unsigned
name|char
name|reg
parameter_list|,
name|unsigned
name|char
name|val
parameter_list|)
block|{
name|outb
argument_list|(
name|E1CS2
argument_list|(
name|base
argument_list|)
argument_list|,
name|E1CS2_SCC
operator||
name|reg
operator|>>
literal|4
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|E1DAT
argument_list|(
name|base
argument_list|)
argument_list|,
name|reg
operator|&
literal|15
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|E1DAT
argument_list|(
name|base
argument_list|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Read the data from the 8530 receive fifo.  */
end_comment

begin_function
name|unsigned
name|char
name|cte_in2d
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|)
block|{
name|outb
argument_list|(
name|E1CS2
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|,
name|E1CS2_SCC
operator||
name|E1CS2_DC
operator||
operator|(
name|c
operator|->
name|num
condition|?
literal|0
else|:
name|E1CS2_AB
operator|)
argument_list|)
expr_stmt|;
return|return
name|inb
argument_list|(
name|E1DAT
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  * Send the 8530 command.  */
end_comment

begin_function
name|void
name|cte_out2c
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|,
name|unsigned
name|char
name|val
parameter_list|)
block|{
name|outb
argument_list|(
name|E1CS2
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|,
name|E1CS2_SCC
operator||
operator|(
name|c
operator|->
name|num
condition|?
literal|0
else|:
name|E1CS2_AB
operator|)
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|E1DAT
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Write the data to the 8530 transmit fifo.  */
end_comment

begin_function
name|void
name|cte_out2d
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|,
name|unsigned
name|char
name|val
parameter_list|)
block|{
name|outb
argument_list|(
name|E1CS2
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|,
name|E1CS2_SCC
operator||
name|E1CS2_DC
operator||
operator|(
name|c
operator|->
name|num
condition|?
literal|0
else|:
name|E1CS2_AB
operator|)
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|E1DAT
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Access to LXT318 chip on the Tau/G.703 board.  * Examples:  *	val = ctg_inx (c)  *	ctg_outx (c, val)  */
end_comment

begin_function
specifier|static
name|void
name|ctg_output
parameter_list|(
name|port_t
name|port
parameter_list|,
name|unsigned
name|char
name|val
parameter_list|,
name|unsigned
name|char
name|v0
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
operator|++
name|i
control|)
block|{
name|unsigned
name|char
name|v
init|=
name|v0
decl_stmt|;
if|if
condition|(
operator|(
name|val
operator|>>
name|i
operator|)
operator|&
literal|1
condition|)
name|v
operator||=
name|GMD0_SDI
expr_stmt|;
name|outb
argument_list|(
name|port
argument_list|,
name|v
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|port
argument_list|,
name|v
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|port
argument_list|,
name|v
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|port
argument_list|,
name|v
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|port
argument_list|,
name|v
operator||
name|GMD0_SCLK
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|port
argument_list|,
name|v
operator||
name|GMD0_SCLK
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|port
argument_list|,
name|v
operator||
name|GMD0_SCLK
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|port
argument_list|,
name|v
operator||
name|GMD0_SCLK
argument_list|)
expr_stmt|;
block|}
name|outb
argument_list|(
name|port
argument_list|,
name|v0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ctg_outx
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|,
name|unsigned
name|char
name|reg
parameter_list|,
name|unsigned
name|char
name|val
parameter_list|)
block|{
name|port_t
name|port
init|=
name|GMD0
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
decl_stmt|;
name|outb
argument_list|(
name|GMD1
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|board
operator|->
name|gmd1
operator||
name|GMD1_NCS0
operator||
name|GMD1_NCS1
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|GMD1
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|board
operator|->
name|gmd1
operator||
operator|(
name|c
operator|->
name|num
condition|?
name|GMD1_NCS0
else|:
name|GMD1_NCS1
operator|)
argument_list|)
expr_stmt|;
name|ctg_output
argument_list|(
name|port
argument_list|,
operator|(
name|reg
operator|<<
literal|1
operator|)
operator||
name|LX_WRITE
argument_list|,
name|c
operator|->
name|board
operator|->
name|gmd0
argument_list|)
expr_stmt|;
name|ctg_output
argument_list|(
name|port
argument_list|,
name|val
argument_list|,
name|c
operator|->
name|board
operator|->
name|gmd0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|GMD1
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|board
operator|->
name|gmd1
operator||
name|GMD1_NCS0
operator||
name|GMD1_NCS1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|unsigned
name|char
name|ctg_inx
parameter_list|(
name|ct_chan_t
modifier|*
name|c
parameter_list|,
name|unsigned
name|char
name|reg
parameter_list|)
block|{
name|port_t
name|port
init|=
name|GMD0
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
decl_stmt|;
name|port_t
name|data
init|=
name|GLDR
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
decl_stmt|;
name|unsigned
name|char
name|val
init|=
literal|0
decl_stmt|,
name|mask
init|=
name|c
operator|->
name|num
condition|?
name|GLDR_C1
else|:
name|GLDR_C0
decl_stmt|;
name|int
name|i
decl_stmt|;
name|outb
argument_list|(
name|GMD1
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|board
operator|->
name|gmd1
operator||
name|GMD1_NCS0
operator||
name|GMD1_NCS1
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|GMD1
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|board
operator|->
name|gmd1
operator||
operator|(
name|c
operator|->
name|num
condition|?
name|GMD1_NCS0
else|:
name|GMD1_NCS1
operator|)
argument_list|)
expr_stmt|;
name|ctg_output
argument_list|(
name|port
argument_list|,
operator|(
name|reg
operator|<<
literal|1
operator|)
operator||
name|LX_READ
argument_list|,
name|c
operator|->
name|board
operator|->
name|gmd0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
operator|++
name|i
control|)
block|{
name|outb
argument_list|(
name|port
argument_list|,
name|c
operator|->
name|board
operator|->
name|gmd0
operator||
name|GMD0_SCLK
argument_list|)
expr_stmt|;
if|if
condition|(
name|inb
argument_list|(
name|data
argument_list|)
operator|&
name|mask
condition|)
name|val
operator||=
literal|1
operator|<<
name|i
expr_stmt|;
name|outb
argument_list|(
name|port
argument_list|,
name|c
operator|->
name|board
operator|->
name|gmd0
argument_list|)
expr_stmt|;
block|}
name|outb
argument_list|(
name|GMD1
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|board
operator|->
name|gmd1
operator||
name|GMD1_NCS0
operator||
name|GMD1_NCS1
argument_list|)
expr_stmt|;
return|return
name|val
return|;
block|}
end_function

begin_comment
comment|/*  * Adapter options  */
end_comment

begin_decl_stmt
name|ct_board_opt_t
name|ct_board_opt_dflt
init|=
block|{
literal|0
block|,
comment|/* board control register 2 */
block|{
comment|/* DMA priority control register */
name|PCR_PRIO_ROTATE
block|,
literal|0
block|,
comment|/* all channels share the the bus hold */
literal|0
block|,
comment|/* hold the bus until all transfers done */
block|}
block|,
name|CFG_A
block|,
comment|/* E1/G.703 config: two independent channels */
name|GCLK_INT
block|,
comment|/* E1/G.703 chan 0 internal tx clock source */
name|GCLK_INT
block|,
comment|/* E1/G.703 chan 1 internal tx clock source */
operator|~
literal|0UL
operator|<<
literal|1
block|,
comment|/* E1 channel 0 timeslots 1..31 */
operator|~
literal|0UL
operator|<<
literal|1
block|,
comment|/* E1 channel 1 timeslots 1..31 */
literal|0
block|,
comment|/* no E1 subchannel timeslots */
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Mode-independent channel options  */
end_comment

begin_decl_stmt
name|ct_chan_opt_t
name|ct_chan_opt_dflt
init|=
block|{
block|{
comment|/* mode register 2 */
name|MD2_FDX
block|,
comment|/* full duplex communication */
literal|0
block|,
comment|/* empty ADPLL clock rate */
name|MD2_ENCOD_NRZ
block|,
comment|/* NRZ encoding */
block|}
block|,
comment|/* DMA mode FIFO marks */
literal|15
block|,
literal|24
block|,
literal|30
block|,
comment|/* rx ready, tx empty, tx full */
comment|/* port i/o mode FIFO marks */
literal|15
block|,
literal|16
block|,
literal|30
block|,
comment|/* rx ready, tx empty, tx full */
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Default HDLC options  */
end_comment

begin_decl_stmt
name|ct_opt_hdlc_t
name|ct_opt_hdlc_dflt
init|=
block|{
block|{
comment|/* mode register 0 */
literal|1
block|,
comment|/* CRC preset to all ones (V.41) */
literal|1
block|,
comment|/* CRC-CCITT */
literal|1
block|,
comment|/* enable CRC */
literal|0
block|,
comment|/* disable automatic CTS/DCD */
name|MD0_MODE_HDLC
block|,
comment|/* HDLC mode */
block|}
block|,
block|{
comment|/* mode register 1 */
name|MD1_ADDR_NOCHK
block|,
comment|/* do not check address field */
block|}
block|,
name|CTL_IDLE_PTRN
operator||
name|CTL_UDRN_ABORT
operator||
name|CTL_RTS_INV
block|,
comment|/* control register */
literal|0
block|,
literal|0
block|,
comment|/* empty sync/address registers 0,1 */
name|CLK_LINE
block|,
comment|/* receive clock source: RXC line input */
name|CLK_LINE
block|,
comment|/* transmit clock source: TXC line input */
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Default E1/G.703 options  */
end_comment

begin_decl_stmt
name|ct_opt_g703_t
name|ct_opt_g703_dflt
init|=
block|{
literal|1
block|,
comment|/* HDB3 enable */
literal|0
block|,
comment|/* precoder disable */
name|GTEST_DIS
block|,
comment|/* test disabled, normal operation */
literal|0
block|,
comment|/* CRC4 disable */
literal|0
block|,
comment|/* CCS signaling */
literal|0
block|,
comment|/* low gain */
literal|0
block|,
comment|/* no raw mode */
literal|0
block|,
comment|/* no PCM2 precoder compatibility */
literal|2048
block|,
comment|/* data rate 2048 kbit/sec */
block|}
decl_stmt|;
end_decl_stmt

end_unit


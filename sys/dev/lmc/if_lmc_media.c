begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	$FreeBSD$ */
end_comment

begin_comment
comment|/* $Id: if_lmc_media.c,v 1.23 1999/03/01 15:12:24 explorer Exp $ */
end_comment

begin_comment
comment|/*-  * Copyright (c) 1994-1997 Matt Thomas (matt@3am-software.com)  * Copyright (c) LAN Media Corporation 1998, 1999.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. The name of the author may not be used to endorse or promote products  *    derived from this software withough specific prior written permission  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_comment
comment|/*  * For lack of a better place, put the SSI cable stuff here.  */
end_comment

begin_decl_stmt
name|char
modifier|*
name|lmc_ssi_cables
index|[]
init|=
block|{
literal|"V.10/RS423"
block|,
literal|"EIA530A"
block|,
literal|"reserved"
block|,
literal|"X.21"
block|,
literal|"V.35"
block|,
literal|"EIA449/EIA530/V.36"
block|,
literal|"V.28/EIA232"
block|,
literal|"none"
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * protocol independent method.  */
end_comment

begin_function_decl
specifier|static
name|void
name|lmc_set_protocol
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
parameter_list|,
name|lmc_ctl_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * media independent methods to check on media status, link, light LEDs,  * etc.  */
end_comment

begin_function_decl
specifier|static
name|void
name|lmc_ds3_init
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|lmc_ds3_default
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|lmc_ds3_set_status
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
parameter_list|,
name|lmc_ctl_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|lmc_ds3_set_100ft
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|lmc_ds3_get_link_status
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|lmc_ds3_set_crc_length
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|lmc_ds3_set_scram
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|lmc_hssi_init
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|lmc_hssi_default
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|lmc_hssi_set_status
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
parameter_list|,
name|lmc_ctl_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|lmc_hssi_set_clock
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|lmc_hssi_get_link_status
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|lmc_hssi_set_link_status
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|lmc_hssi_set_crc_length
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|lmc_ssi_init
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|lmc_ssi_default
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|lmc_ssi_set_status
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
parameter_list|,
name|lmc_ctl_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|lmc_ssi_set_clock
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|lmc_ssi_set_speed
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
parameter_list|,
name|lmc_ctl_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|lmc_ssi_get_link_status
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|lmc_ssi_set_link_status
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|lmc_ssi_set_crc_length
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|lmc_t1_init
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|lmc_t1_default
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|lmc_t1_set_status
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
parameter_list|,
name|lmc_ctl_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|lmc_t1_get_link_status
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|lmc_t1_set_circuit_type
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|lmc_t1_set_crc_length
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|lmc_dummy_set_1
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|lmc_dummy_set2_1
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
parameter_list|,
name|lmc_ctl_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|write_av9110_bit
parameter_list|(
name|lmc_softc_t
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|write_av9110
parameter_list|(
name|lmc_softc_t
modifier|*
parameter_list|,
name|u_int32_t
parameter_list|,
name|u_int32_t
parameter_list|,
name|u_int32_t
parameter_list|,
name|u_int32_t
parameter_list|,
name|u_int32_t
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
name|lmc_media_t
name|lmc_ds3_media
init|=
block|{
name|lmc_ds3_init
block|,
comment|/* special media init stuff */
name|lmc_ds3_default
block|,
comment|/* reset to default state */
name|lmc_ds3_set_status
block|,
comment|/* reset status to state provided */
name|lmc_dummy_set_1
block|,
comment|/* set clock source */
name|lmc_dummy_set2_1
block|,
comment|/* set line speed */
name|lmc_ds3_set_100ft
block|,
comment|/* set cable length */
name|lmc_ds3_set_scram
block|,
comment|/* set scrambler */
name|lmc_ds3_get_link_status
block|,
comment|/* get link status */
name|lmc_dummy_set_1
block|,
comment|/* set link status */
name|lmc_ds3_set_crc_length
block|,
comment|/* set CRC length */
name|lmc_dummy_set_1
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|lmc_media_t
name|lmc_hssi_media
init|=
block|{
name|lmc_hssi_init
block|,
comment|/* special media init stuff */
name|lmc_hssi_default
block|,
comment|/* reset to default state */
name|lmc_hssi_set_status
block|,
comment|/* reset status to state provided */
name|lmc_hssi_set_clock
block|,
comment|/* set clock source */
name|lmc_dummy_set2_1
block|,
comment|/* set line speed */
name|lmc_dummy_set_1
block|,
comment|/* set cable length */
name|lmc_dummy_set_1
block|,
comment|/* set scrambler */
name|lmc_hssi_get_link_status
block|,
comment|/* get link status */
name|lmc_hssi_set_link_status
block|,
comment|/* set link status */
name|lmc_hssi_set_crc_length
block|,
comment|/* set CRC length */
name|lmc_dummy_set_1
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|lmc_media_t
name|lmc_ssi_media
init|=
block|{
name|lmc_ssi_init
block|,
comment|/* special media init stuff */
name|lmc_ssi_default
block|,
comment|/* reset to default state */
name|lmc_ssi_set_status
block|,
comment|/* reset status to state provided */
name|lmc_ssi_set_clock
block|,
comment|/* set clock source */
name|lmc_ssi_set_speed
block|,
comment|/* set line speed */
name|lmc_dummy_set_1
block|,
comment|/* set cable length */
name|lmc_dummy_set_1
block|,
comment|/* set scrambler */
name|lmc_ssi_get_link_status
block|,
comment|/* get link status */
name|lmc_ssi_set_link_status
block|,
comment|/* set link status */
name|lmc_ssi_set_crc_length
block|,
comment|/* set CRC length */
name|lmc_dummy_set_1
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|lmc_media_t
name|lmc_t1_media
init|=
block|{
name|lmc_t1_init
block|,
comment|/* special media init stuff */
name|lmc_t1_default
block|,
comment|/* reset to default state */
name|lmc_t1_set_status
block|,
comment|/* reset status to state provided */
name|lmc_dummy_set_1
block|,
comment|/* set clock source */
name|lmc_dummy_set2_1
block|,
comment|/* set line speed */
name|lmc_dummy_set_1
block|,
comment|/* set cable length */
name|lmc_dummy_set_1
block|,
comment|/* set scrambler */
name|lmc_t1_get_link_status
block|,
comment|/* get link status */
name|lmc_dummy_set_1
block|,
comment|/* set link status */
name|lmc_t1_set_crc_length
block|,
comment|/* set CRC length */
name|lmc_t1_set_circuit_type
comment|/* set T1 or E1 circuit type */
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|lmc_dummy_set_1
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
name|sc
parameter_list|,
name|int
name|a
parameter_list|)
block|{ }
end_function

begin_function
specifier|static
name|void
name|lmc_dummy_set2_1
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
name|sc
parameter_list|,
name|lmc_ctl_t
modifier|*
name|a
parameter_list|)
block|{ }
end_function

begin_comment
comment|/*  *  HSSI methods  */
end_comment

begin_function
specifier|static
name|void
name|lmc_hssi_init
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
name|sc
parameter_list|)
block|{
name|sc
operator|->
name|ictl
operator|.
name|cardtype
operator|=
name|LMC_CTL_CARDTYPE_LMC5200
expr_stmt|;
name|lmc_gpio_mkoutput
argument_list|(
name|sc
argument_list|,
name|LMC_GEP_HSSI_CLOCK
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|lmc_hssi_default
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
name|sc
parameter_list|)
block|{
name|sc
operator|->
name|lmc_miireg16
operator|=
name|LMC_MII16_LED_ALL
expr_stmt|;
name|sc
operator|->
name|lmc_media
operator|->
name|set_link_status
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sc
operator|->
name|lmc_media
operator|->
name|set_clock_source
argument_list|(
name|sc
argument_list|,
name|LMC_CTL_CLOCK_SOURCE_EXT
argument_list|)
expr_stmt|;
name|sc
operator|->
name|lmc_media
operator|->
name|set_crc_length
argument_list|(
name|sc
argument_list|,
name|LMC_CTL_CRC_LENGTH_16
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Given a user provided state, set ourselves up to match it.  This will  * always reset the card if needed.  */
end_comment

begin_function
specifier|static
name|void
name|lmc_hssi_set_status
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
name|sc
parameter_list|,
name|lmc_ctl_t
modifier|*
name|ctl
parameter_list|)
block|{
if|if
condition|(
name|ctl
operator|==
name|NULL
condition|)
block|{
name|sc
operator|->
name|lmc_media
operator|->
name|set_clock_source
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|ictl
operator|.
name|clock_source
argument_list|)
expr_stmt|;
name|lmc_set_protocol
argument_list|(
name|sc
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 	 * check for change in clock source 	 */
if|if
condition|(
name|ctl
operator|->
name|clock_source
operator|&&
operator|!
name|sc
operator|->
name|ictl
operator|.
name|clock_source
condition|)
name|sc
operator|->
name|lmc_media
operator|->
name|set_clock_source
argument_list|(
name|sc
argument_list|,
name|LMC_CTL_CLOCK_SOURCE_INT
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|ctl
operator|->
name|clock_source
operator|&&
name|sc
operator|->
name|ictl
operator|.
name|clock_source
condition|)
name|sc
operator|->
name|lmc_media
operator|->
name|set_clock_source
argument_list|(
name|sc
argument_list|,
name|LMC_CTL_CLOCK_SOURCE_EXT
argument_list|)
expr_stmt|;
name|lmc_set_protocol
argument_list|(
name|sc
argument_list|,
name|ctl
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * 1 == internal, 0 == external  */
end_comment

begin_function
specifier|static
name|void
name|lmc_hssi_set_clock
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
name|sc
parameter_list|,
name|int
name|ie
parameter_list|)
block|{
if|if
condition|(
name|ie
operator|==
name|LMC_CTL_CLOCK_SOURCE_EXT
condition|)
block|{
name|sc
operator|->
name|lmc_gpio
operator||=
name|LMC_GEP_HSSI_CLOCK
expr_stmt|;
name|LMC_CSR_WRITE
argument_list|(
name|sc
argument_list|,
name|csr_gp
argument_list|,
name|sc
operator|->
name|lmc_gpio
argument_list|)
expr_stmt|;
name|sc
operator|->
name|ictl
operator|.
name|clock_source
operator|=
name|LMC_CTL_CLOCK_SOURCE_EXT
expr_stmt|;
name|printf
argument_list|(
name|LMC_PRINTF_FMT
literal|": clock external\n"
argument_list|,
name|LMC_PRINTF_ARGS
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|sc
operator|->
name|lmc_gpio
operator|&=
operator|~
operator|(
name|LMC_GEP_HSSI_CLOCK
operator|)
expr_stmt|;
name|LMC_CSR_WRITE
argument_list|(
name|sc
argument_list|,
name|csr_gp
argument_list|,
name|sc
operator|->
name|lmc_gpio
argument_list|)
expr_stmt|;
name|sc
operator|->
name|ictl
operator|.
name|clock_source
operator|=
name|LMC_CTL_CLOCK_SOURCE_INT
expr_stmt|;
name|printf
argument_list|(
name|LMC_PRINTF_FMT
literal|": clock internal\n"
argument_list|,
name|LMC_PRINTF_ARGS
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * return hardware link status.  * 0 == link is down, 1 == link is up.  */
end_comment

begin_function
specifier|static
name|int
name|lmc_hssi_get_link_status
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
name|sc
parameter_list|)
block|{
name|u_int16_t
name|link_status
decl_stmt|;
name|link_status
operator|=
name|lmc_mii_readreg
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|link_status
operator|&
name|LMC_MII16_HSSI_CA
operator|)
operator|==
name|LMC_MII16_HSSI_CA
condition|)
return|return
literal|1
return|;
else|else
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|lmc_hssi_set_link_status
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
name|sc
parameter_list|,
name|int
name|state
parameter_list|)
block|{
if|if
condition|(
name|state
condition|)
name|sc
operator|->
name|lmc_miireg16
operator||=
name|LMC_MII16_HSSI_TA
expr_stmt|;
else|else
name|sc
operator|->
name|lmc_miireg16
operator|&=
operator|~
name|LMC_MII16_HSSI_TA
expr_stmt|;
name|lmc_mii_writereg
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
literal|16
argument_list|,
name|sc
operator|->
name|lmc_miireg16
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * 0 == 16bit, 1 == 32bit  */
end_comment

begin_function
specifier|static
name|void
name|lmc_hssi_set_crc_length
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
name|sc
parameter_list|,
name|int
name|state
parameter_list|)
block|{
if|if
condition|(
name|state
operator|==
name|LMC_CTL_CRC_LENGTH_32
condition|)
block|{
comment|/* 32 bit */
name|sc
operator|->
name|lmc_miireg16
operator||=
name|LMC_MII16_HSSI_CRC
expr_stmt|;
name|sc
operator|->
name|ictl
operator|.
name|crc_length
operator|=
name|LMC_CTL_CRC_LENGTH_32
expr_stmt|;
block|}
else|else
block|{
comment|/* 16 bit */
name|sc
operator|->
name|lmc_miireg16
operator|&=
operator|~
name|LMC_MII16_HSSI_CRC
expr_stmt|;
name|sc
operator|->
name|ictl
operator|.
name|crc_length
operator|=
name|LMC_CTL_CRC_LENGTH_16
expr_stmt|;
block|}
name|lmc_mii_writereg
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
literal|16
argument_list|,
name|sc
operator|->
name|lmc_miireg16
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  *  DS3 methods  */
end_comment

begin_comment
comment|/*  * Set cable length  */
end_comment

begin_function
specifier|static
name|void
name|lmc_ds3_set_100ft
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
name|sc
parameter_list|,
name|int
name|ie
parameter_list|)
block|{
if|if
condition|(
name|ie
operator|==
name|LMC_CTL_CABLE_LENGTH_GT_100FT
condition|)
block|{
name|sc
operator|->
name|lmc_miireg16
operator|&=
operator|~
name|LMC_MII16_DS3_ZERO
expr_stmt|;
name|sc
operator|->
name|ictl
operator|.
name|cable_length
operator|=
name|LMC_CTL_CABLE_LENGTH_GT_100FT
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ie
operator|==
name|LMC_CTL_CABLE_LENGTH_LT_100FT
condition|)
block|{
name|sc
operator|->
name|lmc_miireg16
operator||=
name|LMC_MII16_DS3_ZERO
expr_stmt|;
name|sc
operator|->
name|ictl
operator|.
name|cable_length
operator|=
name|LMC_CTL_CABLE_LENGTH_LT_100FT
expr_stmt|;
block|}
name|lmc_mii_writereg
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
literal|16
argument_list|,
name|sc
operator|->
name|lmc_miireg16
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|lmc_ds3_default
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
name|sc
parameter_list|)
block|{
name|sc
operator|->
name|lmc_miireg16
operator|=
name|LMC_MII16_LED_ALL
expr_stmt|;
name|sc
operator|->
name|lmc_media
operator|->
name|set_link_status
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sc
operator|->
name|lmc_media
operator|->
name|set_cable_length
argument_list|(
name|sc
argument_list|,
name|LMC_CTL_CABLE_LENGTH_LT_100FT
argument_list|)
expr_stmt|;
name|sc
operator|->
name|lmc_media
operator|->
name|set_scrambler
argument_list|(
name|sc
argument_list|,
name|LMC_CTL_OFF
argument_list|)
expr_stmt|;
name|sc
operator|->
name|lmc_media
operator|->
name|set_crc_length
argument_list|(
name|sc
argument_list|,
name|LMC_CTL_CRC_LENGTH_16
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Given a user provided state, set ourselves up to match it.  This will  * always reset the card if needed.  */
end_comment

begin_function
specifier|static
name|void
name|lmc_ds3_set_status
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
name|sc
parameter_list|,
name|lmc_ctl_t
modifier|*
name|ctl
parameter_list|)
block|{
if|if
condition|(
name|ctl
operator|==
name|NULL
condition|)
block|{
name|sc
operator|->
name|lmc_media
operator|->
name|set_cable_length
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|ictl
operator|.
name|cable_length
argument_list|)
expr_stmt|;
name|sc
operator|->
name|lmc_media
operator|->
name|set_scrambler
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|ictl
operator|.
name|scrambler_onoff
argument_list|)
expr_stmt|;
name|lmc_set_protocol
argument_list|(
name|sc
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 	 * check for change in cable length setting 	 */
if|if
condition|(
name|ctl
operator|->
name|cable_length
operator|&&
operator|!
name|sc
operator|->
name|ictl
operator|.
name|cable_length
condition|)
name|lmc_ds3_set_100ft
argument_list|(
name|sc
argument_list|,
name|LMC_CTL_CABLE_LENGTH_GT_100FT
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|ctl
operator|->
name|cable_length
operator|&&
name|sc
operator|->
name|ictl
operator|.
name|cable_length
condition|)
name|lmc_ds3_set_100ft
argument_list|(
name|sc
argument_list|,
name|LMC_CTL_CABLE_LENGTH_LT_100FT
argument_list|)
expr_stmt|;
comment|/* 	 * Check for change in scrambler setting (requires reset) 	 */
if|if
condition|(
name|ctl
operator|->
name|scrambler_onoff
operator|&&
operator|!
name|sc
operator|->
name|ictl
operator|.
name|scrambler_onoff
condition|)
name|lmc_ds3_set_scram
argument_list|(
name|sc
argument_list|,
name|LMC_CTL_ON
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|ctl
operator|->
name|scrambler_onoff
operator|&&
name|sc
operator|->
name|ictl
operator|.
name|scrambler_onoff
condition|)
name|lmc_ds3_set_scram
argument_list|(
name|sc
argument_list|,
name|LMC_CTL_OFF
argument_list|)
expr_stmt|;
name|lmc_set_protocol
argument_list|(
name|sc
argument_list|,
name|ctl
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|lmc_ds3_init
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
name|sc
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|sc
operator|->
name|ictl
operator|.
name|cardtype
operator|=
name|LMC_CTL_CARDTYPE_LMC5245
expr_stmt|;
comment|/* writes zeros everywhere */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|21
condition|;
name|i
operator|++
control|)
block|{
name|lmc_mii_writereg
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
literal|17
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|lmc_mii_writereg
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
literal|18
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
comment|/* set some essential bits */
name|lmc_mii_writereg
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
literal|17
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|lmc_mii_writereg
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
literal|18
argument_list|,
literal|0x05
argument_list|)
expr_stmt|;
comment|/* ser, xtx */
name|lmc_mii_writereg
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
literal|17
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|lmc_mii_writereg
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
literal|18
argument_list|,
literal|0x80
argument_list|)
expr_stmt|;
comment|/* emode */
name|lmc_mii_writereg
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
literal|17
argument_list|,
literal|14
argument_list|)
expr_stmt|;
name|lmc_mii_writereg
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
literal|18
argument_list|,
literal|0x30
argument_list|)
expr_stmt|;
comment|/* rcgen, tcgen */
comment|/* clear counters and latched bits */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|21
condition|;
name|i
operator|++
control|)
block|{
name|lmc_mii_writereg
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
literal|17
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|lmc_mii_readreg
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
literal|18
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * 1 == DS3 payload scrambled, 0 == not scrambled  */
end_comment

begin_function
specifier|static
name|void
name|lmc_ds3_set_scram
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
name|sc
parameter_list|,
name|int
name|ie
parameter_list|)
block|{
if|if
condition|(
name|ie
operator|==
name|LMC_CTL_ON
condition|)
block|{
name|sc
operator|->
name|lmc_miireg16
operator||=
name|LMC_MII16_DS3_SCRAM
expr_stmt|;
name|sc
operator|->
name|ictl
operator|.
name|scrambler_onoff
operator|=
name|LMC_CTL_ON
expr_stmt|;
block|}
else|else
block|{
name|sc
operator|->
name|lmc_miireg16
operator|&=
operator|~
name|LMC_MII16_DS3_SCRAM
expr_stmt|;
name|sc
operator|->
name|ictl
operator|.
name|scrambler_onoff
operator|=
name|LMC_CTL_OFF
expr_stmt|;
block|}
name|lmc_mii_writereg
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
literal|16
argument_list|,
name|sc
operator|->
name|lmc_miireg16
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * return hardware link status.  * 0 == link is down, 1 == link is up.  */
end_comment

begin_function
specifier|static
name|int
name|lmc_ds3_get_link_status
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
name|sc
parameter_list|)
block|{
name|u_int16_t
name|link_status
decl_stmt|;
name|lmc_mii_writereg
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
literal|17
argument_list|,
literal|7
argument_list|)
expr_stmt|;
name|link_status
operator|=
name|lmc_mii_readreg
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
literal|18
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|link_status
operator|&
name|LMC_FRAMER_REG0_DLOS
operator|)
operator|==
literal|0
condition|)
return|return
literal|1
return|;
else|else
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * 0 == 16bit, 1 == 32bit  */
end_comment

begin_function
specifier|static
name|void
name|lmc_ds3_set_crc_length
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
name|sc
parameter_list|,
name|int
name|state
parameter_list|)
block|{
if|if
condition|(
name|state
operator|==
name|LMC_CTL_CRC_LENGTH_32
condition|)
block|{
comment|/* 32 bit */
name|sc
operator|->
name|lmc_miireg16
operator||=
name|LMC_MII16_DS3_CRC
expr_stmt|;
name|sc
operator|->
name|ictl
operator|.
name|crc_length
operator|=
name|LMC_CTL_CRC_LENGTH_32
expr_stmt|;
block|}
else|else
block|{
comment|/* 16 bit */
name|sc
operator|->
name|lmc_miireg16
operator|&=
operator|~
name|LMC_MII16_DS3_CRC
expr_stmt|;
name|sc
operator|->
name|ictl
operator|.
name|crc_length
operator|=
name|LMC_CTL_CRC_LENGTH_16
expr_stmt|;
block|}
name|lmc_mii_writereg
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
literal|16
argument_list|,
name|sc
operator|->
name|lmc_miireg16
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  *  SSI methods  */
end_comment

begin_function
specifier|static
name|void
name|lmc_ssi_init
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
name|sc
parameter_list|)
block|{
name|u_int16_t
name|mii17
decl_stmt|;
name|int
name|cable
decl_stmt|;
name|sc
operator|->
name|ictl
operator|.
name|cardtype
operator|=
name|LMC_CTL_CARDTYPE_LMC1000
expr_stmt|;
name|mii17
operator|=
name|lmc_mii_readreg
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
literal|17
argument_list|)
expr_stmt|;
name|cable
operator|=
operator|(
name|mii17
operator|&
name|LMC_MII17_SSI_CABLE_MASK
operator|)
operator|>>
name|LMC_MII17_SSI_CABLE_SHIFT
expr_stmt|;
name|sc
operator|->
name|ictl
operator|.
name|cable_type
operator|=
name|cable
expr_stmt|;
name|lmc_gpio_mkoutput
argument_list|(
name|sc
argument_list|,
name|LMC_GEP_SSI_TXCLOCK
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|lmc_ssi_default
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
name|sc
parameter_list|)
block|{
name|sc
operator|->
name|lmc_miireg16
operator|=
name|LMC_MII16_LED_ALL
expr_stmt|;
comment|/* 	 * make TXCLOCK always be an output 	 */
name|lmc_gpio_mkoutput
argument_list|(
name|sc
argument_list|,
name|LMC_GEP_SSI_TXCLOCK
argument_list|)
expr_stmt|;
name|sc
operator|->
name|lmc_media
operator|->
name|set_link_status
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sc
operator|->
name|lmc_media
operator|->
name|set_clock_source
argument_list|(
name|sc
argument_list|,
name|LMC_CTL_CLOCK_SOURCE_EXT
argument_list|)
expr_stmt|;
name|sc
operator|->
name|lmc_media
operator|->
name|set_speed
argument_list|(
name|sc
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|sc
operator|->
name|lmc_media
operator|->
name|set_crc_length
argument_list|(
name|sc
argument_list|,
name|LMC_CTL_CRC_LENGTH_16
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Given a user provided state, set ourselves up to match it.  This will  * always reset the card if needed.  */
end_comment

begin_function
specifier|static
name|void
name|lmc_ssi_set_status
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
name|sc
parameter_list|,
name|lmc_ctl_t
modifier|*
name|ctl
parameter_list|)
block|{
if|if
condition|(
name|ctl
operator|==
name|NULL
condition|)
block|{
name|sc
operator|->
name|lmc_media
operator|->
name|set_clock_source
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|ictl
operator|.
name|clock_source
argument_list|)
expr_stmt|;
name|sc
operator|->
name|lmc_media
operator|->
name|set_speed
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|ictl
argument_list|)
expr_stmt|;
name|lmc_set_protocol
argument_list|(
name|sc
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 	 * check for change in clock source 	 */
if|if
condition|(
name|ctl
operator|->
name|clock_source
operator|==
name|LMC_CTL_CLOCK_SOURCE_INT
operator|&&
name|sc
operator|->
name|ictl
operator|.
name|clock_source
operator|==
name|LMC_CTL_CLOCK_SOURCE_EXT
condition|)
name|sc
operator|->
name|lmc_media
operator|->
name|set_clock_source
argument_list|(
name|sc
argument_list|,
name|LMC_CTL_CLOCK_SOURCE_INT
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|ctl
operator|->
name|clock_source
operator|==
name|LMC_CTL_CLOCK_SOURCE_EXT
operator|&&
name|sc
operator|->
name|ictl
operator|.
name|clock_source
operator|==
name|LMC_CTL_CLOCK_SOURCE_INT
condition|)
name|sc
operator|->
name|lmc_media
operator|->
name|set_clock_source
argument_list|(
name|sc
argument_list|,
name|LMC_CTL_CLOCK_SOURCE_EXT
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctl
operator|->
name|clock_rate
operator|!=
name|sc
operator|->
name|ictl
operator|.
name|clock_rate
condition|)
name|sc
operator|->
name|lmc_media
operator|->
name|set_speed
argument_list|(
name|sc
argument_list|,
name|ctl
argument_list|)
expr_stmt|;
name|lmc_set_protocol
argument_list|(
name|sc
argument_list|,
name|ctl
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * 1 == internal, 0 == external  */
end_comment

begin_function
specifier|static
name|void
name|lmc_ssi_set_clock
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
name|sc
parameter_list|,
name|int
name|ie
parameter_list|)
block|{
if|if
condition|(
name|ie
operator|==
name|LMC_CTL_CLOCK_SOURCE_EXT
condition|)
block|{
name|sc
operator|->
name|lmc_gpio
operator|&=
operator|~
operator|(
name|LMC_GEP_SSI_TXCLOCK
operator|)
expr_stmt|;
name|LMC_CSR_WRITE
argument_list|(
name|sc
argument_list|,
name|csr_gp
argument_list|,
name|sc
operator|->
name|lmc_gpio
argument_list|)
expr_stmt|;
name|sc
operator|->
name|ictl
operator|.
name|clock_source
operator|=
name|LMC_CTL_CLOCK_SOURCE_EXT
expr_stmt|;
name|printf
argument_list|(
name|LMC_PRINTF_FMT
literal|": clock external\n"
argument_list|,
name|LMC_PRINTF_ARGS
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|sc
operator|->
name|lmc_gpio
operator||=
name|LMC_GEP_SSI_TXCLOCK
expr_stmt|;
name|LMC_CSR_WRITE
argument_list|(
name|sc
argument_list|,
name|csr_gp
argument_list|,
name|sc
operator|->
name|lmc_gpio
argument_list|)
expr_stmt|;
name|sc
operator|->
name|ictl
operator|.
name|clock_source
operator|=
name|LMC_CTL_CLOCK_SOURCE_INT
expr_stmt|;
name|printf
argument_list|(
name|LMC_PRINTF_FMT
literal|": clock internal\n"
argument_list|,
name|LMC_PRINTF_ARGS
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|lmc_ssi_set_speed
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
name|sc
parameter_list|,
name|lmc_ctl_t
modifier|*
name|ctl
parameter_list|)
block|{
name|lmc_ctl_t
modifier|*
name|ictl
init|=
operator|&
name|sc
operator|->
name|ictl
decl_stmt|;
name|lmc_av9110_t
modifier|*
name|av
decl_stmt|;
if|if
condition|(
name|ctl
operator|==
name|NULL
condition|)
block|{
name|av
operator|=
operator|&
name|ictl
operator|->
name|cardspec
operator|.
name|ssi
expr_stmt|;
name|ictl
operator|->
name|clock_rate
operator|=
literal|100000
expr_stmt|;
name|av
operator|->
name|f
operator|=
name|ictl
operator|->
name|clock_rate
expr_stmt|;
name|av
operator|->
name|n
operator|=
literal|8
expr_stmt|;
name|av
operator|->
name|m
operator|=
literal|25
expr_stmt|;
name|av
operator|->
name|v
operator|=
literal|0
expr_stmt|;
name|av
operator|->
name|x
operator|=
literal|0
expr_stmt|;
name|av
operator|->
name|r
operator|=
literal|2
expr_stmt|;
name|write_av9110
argument_list|(
name|sc
argument_list|,
name|av
operator|->
name|n
argument_list|,
name|av
operator|->
name|m
argument_list|,
name|av
operator|->
name|v
argument_list|,
name|av
operator|->
name|x
argument_list|,
name|av
operator|->
name|r
argument_list|)
expr_stmt|;
return|return;
block|}
name|av
operator|=
operator|&
name|ctl
operator|->
name|cardspec
operator|.
name|ssi
expr_stmt|;
if|if
condition|(
name|av
operator|->
name|f
operator|==
literal|0
condition|)
return|return;
name|ictl
operator|->
name|clock_rate
operator|=
name|av
operator|->
name|f
expr_stmt|;
comment|/* really, this is the rate we are */
name|ictl
operator|->
name|cardspec
operator|.
name|ssi
operator|=
operator|*
name|av
expr_stmt|;
name|write_av9110
argument_list|(
name|sc
argument_list|,
name|av
operator|->
name|n
argument_list|,
name|av
operator|->
name|m
argument_list|,
name|av
operator|->
name|v
argument_list|,
name|av
operator|->
name|x
argument_list|,
name|av
operator|->
name|r
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * return hardware link status.  * 0 == link is down, 1 == link is up.  */
end_comment

begin_function
specifier|static
name|int
name|lmc_ssi_get_link_status
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
name|sc
parameter_list|)
block|{
name|u_int16_t
name|link_status
decl_stmt|;
comment|/* 	 * missing CTS?  Hmm.  If we require CTS on, we may never get the 	 * link to come up, so omit it in this test. 	 * 	 * Also, it seems that with a loopback cable, DCD isn't asserted, 	 * so just check for things like this: 	 *	DSR _must_ be asserted. 	 *	One of DCD or CTS must be asserted. 	 */
name|link_status
operator|=
name|lmc_mii_readreg
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|link_status
operator|&
name|LMC_MII16_SSI_DSR
operator|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
operator|(
name|link_status
operator|&
operator|(
name|LMC_MII16_SSI_CTS
operator||
name|LMC_MII16_SSI_DCD
operator|)
operator|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|lmc_ssi_set_link_status
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
name|sc
parameter_list|,
name|int
name|state
parameter_list|)
block|{
if|if
condition|(
name|state
condition|)
block|{
name|sc
operator|->
name|lmc_miireg16
operator||=
operator|(
name|LMC_MII16_SSI_DTR
operator||
name|LMC_MII16_SSI_RTS
operator|)
expr_stmt|;
name|printf
argument_list|(
name|LMC_PRINTF_FMT
literal|": asserting DTR and RTS\n"
argument_list|,
name|LMC_PRINTF_ARGS
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|sc
operator|->
name|lmc_miireg16
operator|&=
operator|~
operator|(
name|LMC_MII16_SSI_DTR
operator||
name|LMC_MII16_SSI_RTS
operator|)
expr_stmt|;
name|printf
argument_list|(
name|LMC_PRINTF_FMT
literal|": deasserting DTR and RTS\n"
argument_list|,
name|LMC_PRINTF_ARGS
argument_list|)
expr_stmt|;
block|}
name|lmc_mii_writereg
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
literal|16
argument_list|,
name|sc
operator|->
name|lmc_miireg16
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * 0 == 16bit, 1 == 32bit  */
end_comment

begin_function
specifier|static
name|void
name|lmc_ssi_set_crc_length
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
name|sc
parameter_list|,
name|int
name|state
parameter_list|)
block|{
if|if
condition|(
name|state
operator|==
name|LMC_CTL_CRC_LENGTH_32
condition|)
block|{
comment|/* 32 bit */
name|sc
operator|->
name|lmc_miireg16
operator||=
name|LMC_MII16_SSI_CRC
expr_stmt|;
name|sc
operator|->
name|ictl
operator|.
name|crc_length
operator|=
name|LMC_CTL_CRC_LENGTH_32
expr_stmt|;
block|}
else|else
block|{
comment|/* 16 bit */
name|sc
operator|->
name|lmc_miireg16
operator|&=
operator|~
name|LMC_MII16_SSI_CRC
expr_stmt|;
name|sc
operator|->
name|ictl
operator|.
name|crc_length
operator|=
name|LMC_CTL_CRC_LENGTH_16
expr_stmt|;
block|}
name|lmc_mii_writereg
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
literal|16
argument_list|,
name|sc
operator|->
name|lmc_miireg16
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * These are bits to program the SSI frequency generator  */
end_comment

begin_function
specifier|static
name|void
name|write_av9110_bit
parameter_list|(
name|lmc_softc_t
modifier|*
name|sc
parameter_list|,
name|int
name|c
parameter_list|)
block|{
comment|/* 	 * set the data bit as we need it. 	 */
name|sc
operator|->
name|lmc_gpio
operator|&=
operator|~
operator|(
name|LMC_GEP_SERIALCLK
operator|)
expr_stmt|;
if|if
condition|(
name|c
operator|&
literal|0x01
condition|)
name|sc
operator|->
name|lmc_gpio
operator||=
name|LMC_GEP_SERIAL
expr_stmt|;
else|else
name|sc
operator|->
name|lmc_gpio
operator|&=
operator|~
operator|(
name|LMC_GEP_SERIAL
operator|)
expr_stmt|;
name|LMC_CSR_WRITE
argument_list|(
name|sc
argument_list|,
name|csr_gp
argument_list|,
name|sc
operator|->
name|lmc_gpio
argument_list|)
expr_stmt|;
comment|/* 	 * set the clock to high 	 */
name|sc
operator|->
name|lmc_gpio
operator||=
name|LMC_GEP_SERIALCLK
expr_stmt|;
name|LMC_CSR_WRITE
argument_list|(
name|sc
argument_list|,
name|csr_gp
argument_list|,
name|sc
operator|->
name|lmc_gpio
argument_list|)
expr_stmt|;
comment|/* 	 * set the clock to low again. 	 */
name|sc
operator|->
name|lmc_gpio
operator|&=
operator|~
operator|(
name|LMC_GEP_SERIALCLK
operator|)
expr_stmt|;
name|LMC_CSR_WRITE
argument_list|(
name|sc
argument_list|,
name|csr_gp
argument_list|,
name|sc
operator|->
name|lmc_gpio
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|write_av9110
parameter_list|(
name|lmc_softc_t
modifier|*
name|sc
parameter_list|,
name|u_int32_t
name|n
parameter_list|,
name|u_int32_t
name|m
parameter_list|,
name|u_int32_t
name|v
parameter_list|,
name|u_int32_t
name|x
parameter_list|,
name|u_int32_t
name|r
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|#
directive|if
literal|0
block|printf(LMC_PRINTF_FMT ": speed %u, %d %d %d %d %d\n", 	       LMC_PRINTF_ARGS, sc->ictl.clock_rate, 	       n, m, v, x, r);
endif|#
directive|endif
name|sc
operator|->
name|lmc_gpio
operator||=
name|LMC_GEP_SSI_GENERATOR
expr_stmt|;
name|sc
operator|->
name|lmc_gpio
operator|&=
operator|~
operator|(
name|LMC_GEP_SERIAL
operator||
name|LMC_GEP_SERIALCLK
operator|)
expr_stmt|;
name|LMC_CSR_WRITE
argument_list|(
name|sc
argument_list|,
name|csr_gp
argument_list|,
name|sc
operator|->
name|lmc_gpio
argument_list|)
expr_stmt|;
comment|/* 	 * Set the TXCLOCK, GENERATOR, SERIAL, and SERIALCLK 	 * as outputs. 	 */
name|lmc_gpio_mkoutput
argument_list|(
name|sc
argument_list|,
operator|(
name|LMC_GEP_SERIAL
operator||
name|LMC_GEP_SERIALCLK
operator||
name|LMC_GEP_SSI_GENERATOR
operator|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|lmc_gpio
operator|&=
operator|~
operator|(
name|LMC_GEP_SSI_GENERATOR
operator|)
expr_stmt|;
name|LMC_CSR_WRITE
argument_list|(
name|sc
argument_list|,
name|csr_gp
argument_list|,
name|sc
operator|->
name|lmc_gpio
argument_list|)
expr_stmt|;
comment|/* 	 * a shifting we will go... 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|7
condition|;
name|i
operator|++
control|)
name|write_av9110_bit
argument_list|(
name|sc
argument_list|,
name|n
operator|>>
name|i
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|7
condition|;
name|i
operator|++
control|)
name|write_av9110_bit
argument_list|(
name|sc
argument_list|,
name|m
operator|>>
name|i
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|1
condition|;
name|i
operator|++
control|)
name|write_av9110_bit
argument_list|(
name|sc
argument_list|,
name|v
operator|>>
name|i
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
name|write_av9110_bit
argument_list|(
name|sc
argument_list|,
name|x
operator|>>
name|i
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
name|write_av9110_bit
argument_list|(
name|sc
argument_list|,
name|r
operator|>>
name|i
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|5
condition|;
name|i
operator|++
control|)
name|write_av9110_bit
argument_list|(
name|sc
argument_list|,
literal|0x17
operator|>>
name|i
argument_list|)
expr_stmt|;
comment|/* 	 * stop driving serial-related signals 	 */
name|lmc_gpio_mkinput
argument_list|(
name|sc
argument_list|,
operator|(
name|LMC_GEP_SERIAL
operator||
name|LMC_GEP_SERIALCLK
operator||
name|LMC_GEP_SSI_GENERATOR
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|lmc_set_protocol
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
name|sc
parameter_list|,
name|lmc_ctl_t
modifier|*
name|ctl
parameter_list|)
block|{
if|if
condition|(
name|ctl
operator|==
literal|0
condition|)
block|{
name|sc
operator|->
name|ictl
operator|.
name|keepalive_onoff
operator|=
name|LMC_CTL_ON
expr_stmt|;
return|return;
block|}
if|#
directive|if
name|defined
argument_list|(
name|__NetBSD__
argument_list|)
operator|||
name|defined
argument_list|(
name|__FreeBSD__
argument_list|)
if|if
condition|(
name|ctl
operator|->
name|keepalive_onoff
operator|!=
name|sc
operator|->
name|ictl
operator|.
name|keepalive_onoff
condition|)
block|{
switch|switch
condition|(
name|ctl
operator|->
name|keepalive_onoff
condition|)
block|{
case|case
name|LMC_CTL_ON
case|:
name|printf
argument_list|(
name|LMC_PRINTF_FMT
literal|": enabling keepalive\n"
argument_list|,
name|LMC_PRINTF_ARGS
argument_list|)
expr_stmt|;
name|sc
operator|->
name|ictl
operator|.
name|keepalive_onoff
operator|=
name|LMC_CTL_ON
expr_stmt|;
name|sc
operator|->
name|lmc_sppp
operator|.
name|pp_flags
operator|=
name|PP_CISCO
operator||
name|PP_KEEPALIVE
expr_stmt|;
break|break;
case|case
name|LMC_CTL_OFF
case|:
name|printf
argument_list|(
name|LMC_PRINTF_FMT
literal|": disabling keepalive\n"
argument_list|,
name|LMC_PRINTF_ARGS
argument_list|)
expr_stmt|;
name|sc
operator|->
name|ictl
operator|.
name|keepalive_onoff
operator|=
name|LMC_CTL_OFF
expr_stmt|;
name|sc
operator|->
name|lmc_sppp
operator|.
name|pp_flags
operator|=
name|PP_CISCO
expr_stmt|;
block|}
block|}
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/*  *  T1 methods  */
end_comment

begin_comment
comment|/*  * The framer regs are multiplexed through MII regs 17& 18  *  write the register address to MII reg 17 and the *  data to MII reg 18. */
end_comment

begin_function
specifier|static
name|void
name|lmc_t1_write
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
name|sc
parameter_list|,
name|int
name|a
parameter_list|,
name|int
name|d
parameter_list|)
block|{
name|lmc_mii_writereg
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
literal|17
argument_list|,
name|a
argument_list|)
expr_stmt|;
name|lmc_mii_writereg
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
literal|18
argument_list|,
name|d
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* XXX future to be integtrated with if_lmc.c for alarms */
end_comment

begin_function
specifier|static
name|int
name|lmc_t1_read
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
name|sc
parameter_list|,
name|int
name|a
parameter_list|)
block|{
name|lmc_mii_writereg
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
literal|17
argument_list|,
name|a
argument_list|)
expr_stmt|;
return|return
name|lmc_mii_readreg
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
literal|18
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|lmc_t1_init
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
name|sc
parameter_list|)
block|{
name|u_int16_t
name|mii16
decl_stmt|;
name|int
name|i
decl_stmt|;
name|sc
operator|->
name|ictl
operator|.
name|cardtype
operator|=
name|LMC_CTL_CARDTYPE_LMC1200
expr_stmt|;
name|mii16
operator|=
name|lmc_mii_readreg
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
literal|16
argument_list|)
expr_stmt|;
comment|/* reset 8370 */
name|mii16
operator|&=
operator|~
name|LMC_MII16_T1_RST
expr_stmt|;
name|lmc_mii_writereg
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
literal|16
argument_list|,
name|mii16
operator||
name|LMC_MII16_T1_RST
argument_list|)
expr_stmt|;
name|lmc_mii_writereg
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
literal|16
argument_list|,
name|mii16
argument_list|)
expr_stmt|;
comment|/* set T1 or E1 line impedance */
comment|/* mii16&= ~LMC_MII16_T1_Z; */
name|mii16
operator||=
name|LMC_MII16_T1_Z
expr_stmt|;
name|lmc_mii_writereg
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
literal|16
argument_list|,
name|mii16
argument_list|)
expr_stmt|;
name|lmc_t1_write
argument_list|(
name|sc
argument_list|,
literal|0x01
argument_list|,
literal|0x1B
argument_list|)
expr_stmt|;
comment|/* CR0     - primary control          */
name|lmc_t1_write
argument_list|(
name|sc
argument_list|,
literal|0x02
argument_list|,
literal|0x42
argument_list|)
expr_stmt|;
comment|/* JAT_CR  - jitter atten config      */
name|lmc_t1_write
argument_list|(
name|sc
argument_list|,
literal|0x14
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
comment|/* LOOP    - loopback config          */
name|lmc_t1_write
argument_list|(
name|sc
argument_list|,
literal|0x15
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
comment|/* DL3_TS  - xtrnl datalink timeslot  */
name|lmc_t1_write
argument_list|(
name|sc
argument_list|,
literal|0x18
argument_list|,
literal|0xFF
argument_list|)
expr_stmt|;
comment|/* PIO     - programmable I/O         */
name|lmc_t1_write
argument_list|(
name|sc
argument_list|,
literal|0x19
argument_list|,
literal|0x30
argument_list|)
expr_stmt|;
comment|/* POE     - programmable OE          */
name|lmc_t1_write
argument_list|(
name|sc
argument_list|,
literal|0x1A
argument_list|,
literal|0x0F
argument_list|)
expr_stmt|;
comment|/* CMUX    - clock input mux          */
name|lmc_t1_write
argument_list|(
name|sc
argument_list|,
literal|0x20
argument_list|,
literal|0x41
argument_list|)
expr_stmt|;
comment|/* LIU_CR  - RX LIU config            */
name|lmc_t1_write
argument_list|(
name|sc
argument_list|,
literal|0x22
argument_list|,
literal|0x76
argument_list|)
expr_stmt|;
comment|/* RLIU_CR - RX LIU config            */
name|lmc_t1_write
argument_list|(
name|sc
argument_list|,
literal|0x40
argument_list|,
literal|0x03
argument_list|)
expr_stmt|;
comment|/* RCR0    - RX config                */
name|lmc_t1_write
argument_list|(
name|sc
argument_list|,
literal|0x45
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
comment|/* RALM    - RX alarm config          */
name|lmc_t1_write
argument_list|(
name|sc
argument_list|,
literal|0x46
argument_list|,
literal|0x05
argument_list|)
expr_stmt|;
comment|/* LATCH   - RX alarm/err/cntr latch  */
name|lmc_t1_write
argument_list|(
name|sc
argument_list|,
literal|0x68
argument_list|,
literal|0x40
argument_list|)
expr_stmt|;
comment|/* TLIU_CR - TX LIU config            */
name|lmc_t1_write
argument_list|(
name|sc
argument_list|,
literal|0x70
argument_list|,
literal|0x0D
argument_list|)
expr_stmt|;
comment|/* TCR0    - TX framer config         */
name|lmc_t1_write
argument_list|(
name|sc
argument_list|,
literal|0x71
argument_list|,
literal|0x05
argument_list|)
expr_stmt|;
comment|/* TCR1    - TX config                */
name|lmc_t1_write
argument_list|(
name|sc
argument_list|,
literal|0x72
argument_list|,
literal|0x0B
argument_list|)
expr_stmt|;
comment|/* TFRM    - TX frame format          */
name|lmc_t1_write
argument_list|(
name|sc
argument_list|,
literal|0x73
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
comment|/* TERROR  - TX error insert          */
name|lmc_t1_write
argument_list|(
name|sc
argument_list|,
literal|0x74
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
comment|/* TMAN    - TX manual Sa/FEBE config */
name|lmc_t1_write
argument_list|(
name|sc
argument_list|,
literal|0x75
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
comment|/* TALM    - TX alarm signal config   */
name|lmc_t1_write
argument_list|(
name|sc
argument_list|,
literal|0x76
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
comment|/* TPATT   - TX test pattern config   */
name|lmc_t1_write
argument_list|(
name|sc
argument_list|,
literal|0x77
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
comment|/* TLB     - TX inband loopback confg */
name|lmc_t1_write
argument_list|(
name|sc
argument_list|,
literal|0x90
argument_list|,
literal|0x05
argument_list|)
expr_stmt|;
comment|/* CLAD_CR - clock rate adapter confg */
name|lmc_t1_write
argument_list|(
name|sc
argument_list|,
literal|0x91
argument_list|,
literal|0x05
argument_list|)
expr_stmt|;
comment|/* CSEL    - clad freq sel            */
name|lmc_t1_write
argument_list|(
name|sc
argument_list|,
literal|0xA6
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
comment|/* DL1_CTL - DL1 control              */
name|lmc_t1_write
argument_list|(
name|sc
argument_list|,
literal|0xB1
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
comment|/* DL2_CTL - DL2 control              */
name|lmc_t1_write
argument_list|(
name|sc
argument_list|,
literal|0xD0
argument_list|,
literal|0x47
argument_list|)
expr_stmt|;
comment|/* SBI_CR  - sys bus iface config     */
name|lmc_t1_write
argument_list|(
name|sc
argument_list|,
literal|0xD1
argument_list|,
literal|0x70
argument_list|)
expr_stmt|;
comment|/* RSB_CR  - RX sys bus config        */
name|lmc_t1_write
argument_list|(
name|sc
argument_list|,
literal|0xD4
argument_list|,
literal|0x30
argument_list|)
expr_stmt|;
comment|/* TSB_CR  - TX sys bus config        */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
block|{
name|lmc_t1_write
argument_list|(
name|sc
argument_list|,
literal|0x0E0
operator|+
name|i
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
comment|/*SBCn sysbus perchannel ctl */
name|lmc_t1_write
argument_list|(
name|sc
argument_list|,
literal|0x100
operator|+
name|i
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
comment|/* TPCn - TX per-channel ctl */
name|lmc_t1_write
argument_list|(
name|sc
argument_list|,
literal|0x180
operator|+
name|i
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
comment|/* RPCn - RX per-channel ctl */
block|}
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
literal|25
condition|;
name|i
operator|++
control|)
block|{
name|lmc_t1_write
argument_list|(
name|sc
argument_list|,
literal|0x0E0
operator|+
name|i
argument_list|,
literal|0x0D
argument_list|)
expr_stmt|;
comment|/* SBCn - sys bus per-channel ctl    */
block|}
comment|/* Turn on the transmiter */
name|mii16
operator||=
name|LMC_MII16_T1_XOE
expr_stmt|;
name|lmc_mii_writereg
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
literal|16
argument_list|,
name|mii16
argument_list|)
expr_stmt|;
name|sc
operator|->
name|lmc_miireg16
operator|=
name|mii16
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|lmc_t1_default
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
name|sc
parameter_list|)
block|{
name|sc
operator|->
name|lmc_miireg16
operator|=
name|LMC_MII16_LED_ALL
expr_stmt|;
name|sc
operator|->
name|lmc_media
operator|->
name|set_link_status
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sc
operator|->
name|lmc_media
operator|->
name|set_circuit_type
argument_list|(
name|sc
argument_list|,
name|LMC_CTL_CIRCUIT_TYPE_T1
argument_list|)
expr_stmt|;
name|sc
operator|->
name|lmc_media
operator|->
name|set_crc_length
argument_list|(
name|sc
argument_list|,
name|LMC_CTL_CRC_LENGTH_16
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Given a user provided state, set ourselves up to match it.  This will  * always reset the card if needed.  */
end_comment

begin_function
specifier|static
name|void
name|lmc_t1_set_status
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
name|sc
parameter_list|,
name|lmc_ctl_t
modifier|*
name|ctl
parameter_list|)
block|{
if|if
condition|(
name|ctl
operator|==
name|NULL
condition|)
block|{
name|sc
operator|->
name|lmc_media
operator|->
name|set_circuit_type
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|ictl
operator|.
name|circuit_type
argument_list|)
expr_stmt|;
name|lmc_set_protocol
argument_list|(
name|sc
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/*          * check for change in circuit type 	 */
if|if
condition|(
name|ctl
operator|->
name|circuit_type
operator|==
name|LMC_CTL_CIRCUIT_TYPE_T1
operator|&&
name|sc
operator|->
name|ictl
operator|.
name|circuit_type
operator|==
name|LMC_CTL_CIRCUIT_TYPE_E1
condition|)
name|sc
operator|->
name|lmc_media
operator|->
name|set_circuit_type
argument_list|(
name|sc
argument_list|,
name|LMC_CTL_CIRCUIT_TYPE_E1
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|ctl
operator|->
name|circuit_type
operator|==
name|LMC_CTL_CIRCUIT_TYPE_E1
operator|&&
name|sc
operator|->
name|ictl
operator|.
name|circuit_type
operator|==
name|LMC_CTL_CIRCUIT_TYPE_T1
condition|)
name|sc
operator|->
name|lmc_media
operator|->
name|set_circuit_type
argument_list|(
name|sc
argument_list|,
name|LMC_CTL_CIRCUIT_TYPE_T1
argument_list|)
expr_stmt|;
name|lmc_set_protocol
argument_list|(
name|sc
argument_list|,
name|ctl
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * return hardware link status.  * 0 == link is down, 1 == link is up.  */
end_comment

begin_function
specifier|static
name|int
name|lmc_t1_get_link_status
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
name|sc
parameter_list|)
block|{
name|u_int16_t
name|link_status
decl_stmt|;
name|lmc_mii_writereg
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
literal|17
argument_list|,
name|T1FRAMER_ALARM1_STATUS
argument_list|)
expr_stmt|;
name|link_status
operator|=
name|lmc_mii_readreg
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
literal|18
argument_list|)
operator|&
literal|0x00FF
expr_stmt|;
comment|/* Make sure it's 8 bits only */
comment|/* 	 * LMC 1200 LED definitions          * led0 yellow = far-end adapter is in Red alarm condition   	 * led1 blue = received an Alarm Indication signal (upstream failure)          * led2 Green = power to adapter, Gate Array loaded& driver attached          * led3 red = Loss of Signal (LOS) or out of frame (OOF) conditions 	 * detected on T3 receive signal          */
comment|/* detect a change in Blue alarm indication signal */
if|if
condition|(
name|link_status
operator|&
name|T1F_RAIS
condition|)
block|{
comment|/* turn on blue LED */
name|lmc_led_on
argument_list|(
name|sc
argument_list|,
name|LMC_DS3_LED1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* turn off blue LED */
name|lmc_led_off
argument_list|(
name|sc
argument_list|,
name|LMC_DS3_LED1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|sc
operator|->
name|t1_alarm1_status
operator|&
name|T1F_RAIS
operator|)
operator|!=
operator|(
name|link_status
operator|&
name|T1F_RAIS
operator|)
condition|)
block|{
if|if
condition|(
name|link_status
operator|&
name|T1F_RAIS
condition|)
block|{
comment|/* turn on blue LED */
name|printf
argument_list|(
literal|" link status: RAIS turn ON Blue %x\n"
argument_list|,
name|link_status
argument_list|)
expr_stmt|;
comment|/* DEBUG */
name|lmc_led_on
argument_list|(
name|sc
argument_list|,
name|LMC_DS3_LED1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* turn off blue LED */
name|printf
argument_list|(
literal|" link status: RAIS turn OFF Blue %x\n"
argument_list|,
name|link_status
argument_list|)
expr_stmt|;
comment|/* DEBUG */
name|lmc_led_off
argument_list|(
name|sc
argument_list|,
name|LMC_DS3_LED1
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* 	 * T1F_RYEL wiggles quite a bit, 	 *  taking it out until I understand why -baz 6/22/99          */
if|if
condition|(
name|link_status
operator|&
name|T1F_RMYEL
condition|)
block|{
comment|/* turn on yellow LED */
name|lmc_led_on
argument_list|(
name|sc
argument_list|,
name|LMC_DS3_LED0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|lmc_led_off
argument_list|(
name|sc
argument_list|,
name|LMC_DS3_LED0
argument_list|)
expr_stmt|;
block|}
comment|/* Yellow alarm indication */
if|if
condition|(
operator|(
name|sc
operator|->
name|t1_alarm1_status
operator|&
name|T1F_RMYEL
operator|)
operator|!=
operator|(
name|link_status
operator|&
name|T1F_RMYEL
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|link_status
operator|&
name|T1F_RMYEL
operator|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|" link status: RYEL turn OFF Yellow %x\n"
argument_list|,
name|link_status
argument_list|)
expr_stmt|;
comment|/* DEBUG */
block|}
else|else
block|{
name|printf
argument_list|(
literal|" link status: RYEL turn ON Yellow %x\n"
argument_list|,
name|link_status
argument_list|)
expr_stmt|;
comment|/* DEBUG */
block|}
block|}
if|if
condition|(
name|link_status
operator|&
operator|(
name|T1F_RLOF
operator||
name|T1F_RLOS
operator|)
condition|)
block|{
name|lmc_led_on
argument_list|(
name|sc
argument_list|,
name|LMC_DS3_LED3
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|lmc_led_off
argument_list|(
name|sc
argument_list|,
name|LMC_DS3_LED3
argument_list|)
expr_stmt|;
block|}
name|sc
operator|->
name|t1_alarm1_status
operator|=
name|link_status
expr_stmt|;
name|lmc_mii_writereg
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
literal|17
argument_list|,
name|T1FRAMER_ALARM2_STATUS
argument_list|)
expr_stmt|;
name|sc
operator|->
name|t1_alarm2_status
operator|=
name|lmc_mii_readreg
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
literal|18
argument_list|)
expr_stmt|;
comment|/* link status based upon T1 receive loss of frame or          * loss of signal - RED alarm indication */
if|if
condition|(
operator|(
name|link_status
operator|&
operator|(
name|T1F_RLOF
operator||
name|T1F_RLOS
operator|)
operator|)
operator|==
literal|0
condition|)
return|return
literal|1
return|;
else|else
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * 1 == T1 Circuit Type , 0 == E1 Circuit Type  */
end_comment

begin_function
specifier|static
name|void
name|lmc_t1_set_circuit_type
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
name|sc
parameter_list|,
name|int
name|ie
parameter_list|)
block|{
if|if
condition|(
name|ie
operator|==
name|LMC_CTL_CIRCUIT_TYPE_T1
condition|)
block|{
name|sc
operator|->
name|lmc_miireg16
operator||=
name|LMC_MII16_T1_Z
expr_stmt|;
name|sc
operator|->
name|ictl
operator|.
name|circuit_type
operator|=
name|LMC_CTL_CIRCUIT_TYPE_T1
expr_stmt|;
block|}
else|else
block|{
name|sc
operator|->
name|lmc_miireg16
operator|&=
operator|~
name|LMC_MII16_T1_Z
expr_stmt|;
name|sc
operator|->
name|ictl
operator|.
name|scrambler_onoff
operator|=
name|LMC_CTL_CIRCUIT_TYPE_E1
expr_stmt|;
block|}
name|lmc_mii_writereg
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
literal|16
argument_list|,
name|sc
operator|->
name|lmc_miireg16
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * 0 == 16bit, 1 == 32bit */
end_comment

begin_function
specifier|static
name|void
name|lmc_t1_set_crc_length
parameter_list|(
name|lmc_softc_t
modifier|*
specifier|const
name|sc
parameter_list|,
name|int
name|state
parameter_list|)
block|{
if|if
condition|(
name|state
operator|==
name|LMC_CTL_CRC_LENGTH_32
condition|)
block|{
comment|/* 32 bit */
name|sc
operator|->
name|lmc_miireg16
operator||=
name|LMC_MII16_T1_CRC
expr_stmt|;
name|sc
operator|->
name|ictl
operator|.
name|crc_length
operator|=
name|LMC_CTL_CRC_LENGTH_32
expr_stmt|;
name|sc
operator|->
name|lmc_crcSize
operator|=
name|LMC_CTL_CRC_BYTESIZE_4
expr_stmt|;
block|}
else|else
block|{
comment|/* 16 bit */
name|sc
operator|->
name|lmc_miireg16
operator|&=
operator|~
name|LMC_MII16_T1_CRC
expr_stmt|;
name|sc
operator|->
name|ictl
operator|.
name|crc_length
operator|=
name|LMC_CTL_CRC_LENGTH_16
expr_stmt|;
name|sc
operator|->
name|lmc_crcSize
operator|=
name|LMC_CTL_CRC_BYTESIZE_2
expr_stmt|;
block|}
name|lmc_mii_writereg
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
literal|16
argument_list|,
name|sc
operator|->
name|lmc_miireg16
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


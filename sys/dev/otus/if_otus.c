begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	$OpenBSD: if_otus.c,v 1.46 2015/03/14 03:38:49 jsg Exp $	*/
end_comment

begin_comment
comment|/*-  * Copyright (c) 2009 Damien Bergamini<damien.bergamini@free.fr>  * Copyright (c) 2015 Adrian Chadd<adrian@FreeBSD.org>  *  * Permission to use, copy, modify, and distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES  * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF  * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR  * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES  * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN  * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF  * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_comment
comment|/*  * Driver for Atheros AR9001U chipset.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"opt_wlan.h"
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<sys/firmware.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/taskqueue.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<net/bpf.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_var.h>
end_include

begin_include
include|#
directive|include
file|<net/if_arp.h>
end_include

begin_include
include|#
directive|include
file|<net/if_dl.h>
end_include

begin_include
include|#
directive|include
file|<net/if_media.h>
end_include

begin_include
include|#
directive|include
file|<net/if_types.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_systm.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_var.h>
end_include

begin_include
include|#
directive|include
file|<netinet/if_ether.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_var.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_regdomain.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_radiotap.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_ratectl.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_input.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|IEEE80211_SUPPORT_SUPERG
end_ifdef

begin_include
include|#
directive|include
file|<net80211/ieee80211_superg.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<dev/usb/usb.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usbdi.h>
end_include

begin_include
include|#
directive|include
file|"usbdevs.h"
end_include

begin_define
define|#
directive|define
name|USB_DEBUG_VAR
value|otus_debug
end_define

begin_include
include|#
directive|include
file|<dev/usb/usb_debug.h>
end_include

begin_include
include|#
directive|include
file|"if_otusreg.h"
end_include

begin_decl_stmt
specifier|static
name|int
name|otus_debug
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_expr_stmt
specifier|static
name|SYSCTL_NODE
argument_list|(
name|_hw_usb
argument_list|,
name|OID_AUTO
argument_list|,
name|otus
argument_list|,
name|CTLFLAG_RW
argument_list|,
literal|0
argument_list|,
literal|"USB otus"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_hw_usb_otus
argument_list|,
name|OID_AUTO
argument_list|,
name|debug
argument_list|,
name|CTLFLAG_RWTUN
argument_list|,
operator|&
name|otus_debug
argument_list|,
literal|0
argument_list|,
literal|"Debug level"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_define
define|#
directive|define
name|OTUS_DEBUG_XMIT
value|0x00000001
end_define

begin_define
define|#
directive|define
name|OTUS_DEBUG_RECV
value|0x00000002
end_define

begin_define
define|#
directive|define
name|OTUS_DEBUG_TXDONE
value|0x00000004
end_define

begin_define
define|#
directive|define
name|OTUS_DEBUG_RXDONE
value|0x00000008
end_define

begin_define
define|#
directive|define
name|OTUS_DEBUG_CMD
value|0x00000010
end_define

begin_define
define|#
directive|define
name|OTUS_DEBUG_CMDDONE
value|0x00000020
end_define

begin_define
define|#
directive|define
name|OTUS_DEBUG_RESET
value|0x00000040
end_define

begin_define
define|#
directive|define
name|OTUS_DEBUG_STATE
value|0x00000080
end_define

begin_define
define|#
directive|define
name|OTUS_DEBUG_CMDNOTIFY
value|0x00000100
end_define

begin_define
define|#
directive|define
name|OTUS_DEBUG_REGIO
value|0x00000200
end_define

begin_define
define|#
directive|define
name|OTUS_DEBUG_IRQ
value|0x00000400
end_define

begin_define
define|#
directive|define
name|OTUS_DEBUG_TXCOMP
value|0x00000800
end_define

begin_define
define|#
directive|define
name|OTUS_DEBUG_ANY
value|0xffffffff
end_define

begin_define
define|#
directive|define
name|OTUS_DPRINTF
parameter_list|(
name|sc
parameter_list|,
name|dm
parameter_list|,
modifier|...
parameter_list|)
define|\
value|do { \ 		if ((dm == OTUS_DEBUG_ANY) || (dm& otus_debug)) \ 			device_printf(sc->sc_dev, __VA_ARGS__); \ 	} while (0)
end_define

begin_define
define|#
directive|define
name|OTUS_DEV
parameter_list|(
name|v
parameter_list|,
name|p
parameter_list|)
value|{ USB_VPI(v, p, 0) }
end_define

begin_decl_stmt
specifier|static
specifier|const
name|STRUCT_USB_HOST_ID
name|otus_devs
index|[]
init|=
block|{
name|OTUS_DEV
argument_list|(
name|USB_VENDOR_ACCTON
argument_list|,
name|USB_PRODUCT_ACCTON_WN7512
argument_list|)
block|,
name|OTUS_DEV
argument_list|(
name|USB_VENDOR_ATHEROS2
argument_list|,
name|USB_PRODUCT_ATHEROS2_3CRUSBN275
argument_list|)
block|,
name|OTUS_DEV
argument_list|(
name|USB_VENDOR_ATHEROS2
argument_list|,
name|USB_PRODUCT_ATHEROS2_TG121N
argument_list|)
block|,
name|OTUS_DEV
argument_list|(
name|USB_VENDOR_ATHEROS2
argument_list|,
name|USB_PRODUCT_ATHEROS2_AR9170
argument_list|)
block|,
name|OTUS_DEV
argument_list|(
name|USB_VENDOR_ATHEROS2
argument_list|,
name|USB_PRODUCT_ATHEROS2_WN612
argument_list|)
block|,
name|OTUS_DEV
argument_list|(
name|USB_VENDOR_ATHEROS2
argument_list|,
name|USB_PRODUCT_ATHEROS2_WN821NV2
argument_list|)
block|,
name|OTUS_DEV
argument_list|(
name|USB_VENDOR_AVM
argument_list|,
name|USB_PRODUCT_AVM_FRITZWLAN
argument_list|)
block|,
name|OTUS_DEV
argument_list|(
name|USB_VENDOR_CACE
argument_list|,
name|USB_PRODUCT_CACE_AIRPCAPNX
argument_list|)
block|,
name|OTUS_DEV
argument_list|(
name|USB_VENDOR_DLINK2
argument_list|,
name|USB_PRODUCT_DLINK2_DWA130D1
argument_list|)
block|,
name|OTUS_DEV
argument_list|(
name|USB_VENDOR_DLINK2
argument_list|,
name|USB_PRODUCT_DLINK2_DWA160A1
argument_list|)
block|,
name|OTUS_DEV
argument_list|(
name|USB_VENDOR_DLINK2
argument_list|,
name|USB_PRODUCT_DLINK2_DWA160A2
argument_list|)
block|,
name|OTUS_DEV
argument_list|(
name|USB_VENDOR_IODATA
argument_list|,
name|USB_PRODUCT_IODATA_WNGDNUS2
argument_list|)
block|,
name|OTUS_DEV
argument_list|(
name|USB_VENDOR_NEC
argument_list|,
name|USB_PRODUCT_NEC_WL300NUG
argument_list|)
block|,
name|OTUS_DEV
argument_list|(
name|USB_VENDOR_NETGEAR
argument_list|,
name|USB_PRODUCT_NETGEAR_WN111V2
argument_list|)
block|,
name|OTUS_DEV
argument_list|(
name|USB_VENDOR_NETGEAR
argument_list|,
name|USB_PRODUCT_NETGEAR_WNA1000
argument_list|)
block|,
name|OTUS_DEV
argument_list|(
name|USB_VENDOR_NETGEAR
argument_list|,
name|USB_PRODUCT_NETGEAR_WNDA3100
argument_list|)
block|,
name|OTUS_DEV
argument_list|(
name|USB_VENDOR_PLANEX2
argument_list|,
name|USB_PRODUCT_PLANEX2_GW_US300
argument_list|)
block|,
name|OTUS_DEV
argument_list|(
name|USB_VENDOR_WISTRONNEWEB
argument_list|,
name|USB_PRODUCT_WISTRONNEWEB_O8494
argument_list|)
block|,
name|OTUS_DEV
argument_list|(
name|USB_VENDOR_WISTRONNEWEB
argument_list|,
name|USB_PRODUCT_WISTRONNEWEB_WNC0600
argument_list|)
block|,
name|OTUS_DEV
argument_list|(
name|USB_VENDOR_ZCOM
argument_list|,
name|USB_PRODUCT_ZCOM_UB81
argument_list|)
block|,
name|OTUS_DEV
argument_list|(
name|USB_VENDOR_ZCOM
argument_list|,
name|USB_PRODUCT_ZCOM_UB82
argument_list|)
block|,
name|OTUS_DEV
argument_list|(
name|USB_VENDOR_ZYDAS
argument_list|,
name|USB_PRODUCT_ZYDAS_ZD1221
argument_list|)
block|,
name|OTUS_DEV
argument_list|(
name|USB_VENDOR_ZYXEL
argument_list|,
name|USB_PRODUCT_ZYXEL_NWD271N
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|device_probe_t
name|otus_match
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|device_attach_t
name|otus_attach
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|device_detach_t
name|otus_detach
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|int
name|otus_attachhook
parameter_list|(
name|struct
name|otus_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|otus_get_chanlist
parameter_list|(
name|struct
name|otus_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|otus_load_firmware
parameter_list|(
name|struct
name|otus_softc
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|otus_open_pipes
parameter_list|(
name|struct
name|otus_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|otus_close_pipes
parameter_list|(
name|struct
name|otus_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|otus_alloc_tx_cmd_list
parameter_list|(
name|struct
name|otus_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|otus_free_tx_cmd_list
parameter_list|(
name|struct
name|otus_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|otus_alloc_rx_list
parameter_list|(
name|struct
name|otus_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|otus_free_rx_list
parameter_list|(
name|struct
name|otus_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|otus_alloc_tx_list
parameter_list|(
name|struct
name|otus_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|otus_free_tx_list
parameter_list|(
name|struct
name|otus_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|otus_free_list
parameter_list|(
name|struct
name|otus_softc
modifier|*
parameter_list|,
name|struct
name|otus_data
type|[]
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|otus_data
modifier|*
name|_otus_getbuf
parameter_list|(
name|struct
name|otus_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|otus_data
modifier|*
name|otus_getbuf
parameter_list|(
name|struct
name|otus_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|otus_freebuf
parameter_list|(
name|struct
name|otus_softc
modifier|*
parameter_list|,
name|struct
name|otus_data
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|otus_tx_cmd
modifier|*
name|_otus_get_txcmd
parameter_list|(
name|struct
name|otus_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|otus_tx_cmd
modifier|*
name|otus_get_txcmd
parameter_list|(
name|struct
name|otus_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|otus_free_txcmd
parameter_list|(
name|struct
name|otus_softc
modifier|*
parameter_list|,
name|struct
name|otus_tx_cmd
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|otus_next_scan
parameter_list|(
name|void
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|otus_tx_task
parameter_list|(
name|void
modifier|*
parameter_list|,
name|int
name|pending
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|otus_do_async
parameter_list|(
name|struct
name|otus_softc
modifier|*
parameter_list|,
name|void
function_decl|(
modifier|*
function_decl|)
parameter_list|(
name|struct
name|otus_softc
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
parameter_list|,
name|void
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|otus_newstate
parameter_list|(
name|struct
name|ieee80211vap
modifier|*
parameter_list|,
name|enum
name|ieee80211_state
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|otus_cmd
parameter_list|(
name|struct
name|otus_softc
modifier|*
parameter_list|,
name|uint8_t
parameter_list|,
specifier|const
name|void
modifier|*
parameter_list|,
name|int
parameter_list|,
name|void
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|otus_write
parameter_list|(
name|struct
name|otus_softc
modifier|*
parameter_list|,
name|uint32_t
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|otus_write_barrier
parameter_list|(
name|struct
name|otus_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|ieee80211_node
modifier|*
name|otus_node_alloc
parameter_list|(
name|struct
name|ieee80211vap
modifier|*
name|vap
parameter_list|,
specifier|const
name|uint8_t
name|mac
index|[
name|IEEE80211_ADDR_LEN
index|]
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|otus_media_change
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|otus_read_eeprom
parameter_list|(
name|struct
name|otus_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|otus_newassoc
parameter_list|(
name|struct
name|ieee80211_node
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|otus_cmd_rxeof
parameter_list|(
name|struct
name|otus_softc
modifier|*
parameter_list|,
name|uint8_t
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|otus_sub_rxeof
parameter_list|(
name|struct
name|otus_softc
modifier|*
parameter_list|,
name|uint8_t
modifier|*
parameter_list|,
name|int
parameter_list|,
name|struct
name|mbufq
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|otus_tx
parameter_list|(
name|struct
name|otus_softc
modifier|*
parameter_list|,
name|struct
name|ieee80211_node
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|,
name|struct
name|otus_data
modifier|*
parameter_list|,
specifier|const
name|struct
name|ieee80211_bpf_params
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|otus_ioctl
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|,
name|u_long
parameter_list|,
name|caddr_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|otus_set_multi
parameter_list|(
name|struct
name|otus_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|otus_updateedca
parameter_list|(
name|struct
name|ieee80211com
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|otus_updateedca_locked
parameter_list|(
name|struct
name|otus_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|otus_updateslot
parameter_list|(
name|struct
name|otus_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|otus_init_mac
parameter_list|(
name|struct
name|otus_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|uint32_t
name|otus_phy_get_def
parameter_list|(
name|struct
name|otus_softc
modifier|*
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|otus_set_board_values
parameter_list|(
name|struct
name|otus_softc
modifier|*
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|otus_program_phy
parameter_list|(
name|struct
name|otus_softc
modifier|*
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|otus_set_rf_bank4
parameter_list|(
name|struct
name|otus_softc
modifier|*
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|otus_get_delta_slope
parameter_list|(
name|uint32_t
parameter_list|,
name|uint32_t
modifier|*
parameter_list|,
name|uint32_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|otus_set_chan
parameter_list|(
name|struct
name|otus_softc
modifier|*
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|otus_set_key
parameter_list|(
name|struct
name|ieee80211com
modifier|*
parameter_list|,
name|struct
name|ieee80211_node
modifier|*
parameter_list|,
name|struct
name|ieee80211_key
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|otus_set_key_cb
parameter_list|(
name|struct
name|otus_softc
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|otus_delete_key
parameter_list|(
name|struct
name|ieee80211com
modifier|*
parameter_list|,
name|struct
name|ieee80211_node
modifier|*
parameter_list|,
name|struct
name|ieee80211_key
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|otus_delete_key_cb
parameter_list|(
name|struct
name|otus_softc
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|otus_calibrate_to
parameter_list|(
name|void
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|otus_set_bssid
parameter_list|(
name|struct
name|otus_softc
modifier|*
parameter_list|,
specifier|const
name|uint8_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|otus_set_macaddr
parameter_list|(
name|struct
name|otus_softc
modifier|*
parameter_list|,
specifier|const
name|uint8_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|otus_led_newstate_type1
parameter_list|(
name|struct
name|otus_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|otus_led_newstate_type2
parameter_list|(
name|struct
name|otus_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|otus_led_newstate_type3
parameter_list|(
name|struct
name|otus_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|otus_init
parameter_list|(
name|struct
name|otus_softc
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|otus_stop
parameter_list|(
name|struct
name|otus_softc
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|device_method_t
name|otus_methods
index|[]
init|=
block|{
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|otus_match
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|otus_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|otus_detach
argument_list|)
block|,
name|DEVMETHOD_END
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|otus_driver
init|=
block|{
operator|.
name|name
operator|=
literal|"otus"
block|,
operator|.
name|methods
operator|=
name|otus_methods
block|,
operator|.
name|size
operator|=
expr|sizeof
operator|(
expr|struct
name|otus_softc
operator|)
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|otus_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|otus
argument_list|,
name|uhub
argument_list|,
name|otus_driver
argument_list|,
name|otus_devclass
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|otus
argument_list|,
name|wlan
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|otus
argument_list|,
name|usb
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|otus
argument_list|,
name|firmware
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_VERSION
argument_list|(
name|otus
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|usb_callback_t
name|otus_bulk_tx_callback
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|usb_callback_t
name|otus_bulk_rx_callback
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|usb_callback_t
name|otus_bulk_irq_callback
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|usb_callback_t
name|otus_bulk_cmd_callback
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|usb_config
name|otus_config
index|[
name|OTUS_N_XFER
index|]
init|=
block|{
index|[
name|OTUS_BULK_TX
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|UE_BULK
block|,
operator|.
name|endpoint
operator|=
name|UE_ADDR_ANY
block|,
operator|.
name|direction
operator|=
name|UE_DIR_OUT
block|,
operator|.
name|bufsize
operator|=
literal|0x200
block|,
operator|.
name|flags
operator|=
block|{
operator|.
name|pipe_bof
operator|=
literal|1
block|,
operator|.
name|force_short_xfer
operator|=
literal|1
block|,}
block|,
operator|.
name|callback
operator|=
name|otus_bulk_tx_callback
block|,
operator|.
name|timeout
operator|=
literal|5000
block|,
comment|/* ms */
block|}
block|,
index|[
name|OTUS_BULK_RX
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|UE_BULK
block|,
operator|.
name|endpoint
operator|=
name|UE_ADDR_ANY
block|,
operator|.
name|direction
operator|=
name|UE_DIR_IN
block|,
operator|.
name|bufsize
operator|=
name|OTUS_RXBUFSZ
block|,
operator|.
name|flags
operator|=
block|{
operator|.
name|ext_buffer
operator|=
literal|1
block|,
operator|.
name|pipe_bof
operator|=
literal|1
block|,
operator|.
name|short_xfer_ok
operator|=
literal|1
block|,}
block|,
operator|.
name|callback
operator|=
name|otus_bulk_rx_callback
block|, 	}
block|,
index|[
name|OTUS_BULK_IRQ
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|UE_INTERRUPT
block|,
operator|.
name|endpoint
operator|=
name|UE_ADDR_ANY
block|,
operator|.
name|direction
operator|=
name|UE_DIR_IN
block|,
operator|.
name|bufsize
operator|=
name|OTUS_MAX_CTRLSZ
block|,
operator|.
name|flags
operator|=
block|{
operator|.
name|pipe_bof
operator|=
literal|1
block|,
operator|.
name|short_xfer_ok
operator|=
literal|1
block|,}
block|,
operator|.
name|callback
operator|=
name|otus_bulk_irq_callback
block|, 	}
block|,
index|[
name|OTUS_BULK_CMD
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|UE_INTERRUPT
block|,
operator|.
name|endpoint
operator|=
name|UE_ADDR_ANY
block|,
operator|.
name|direction
operator|=
name|UE_DIR_OUT
block|,
operator|.
name|bufsize
operator|=
name|OTUS_MAX_CTRLSZ
block|,
operator|.
name|flags
operator|=
block|{
operator|.
name|pipe_bof
operator|=
literal|1
block|,
operator|.
name|force_short_xfer
operator|=
literal|1
block|,}
block|,
operator|.
name|callback
operator|=
name|otus_bulk_cmd_callback
block|,
operator|.
name|timeout
operator|=
literal|5000
block|,
comment|/* ms */
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|otus_match
parameter_list|(
name|device_t
name|self
parameter_list|)
block|{
name|struct
name|usb_attach_arg
modifier|*
name|uaa
init|=
name|device_get_ivars
argument_list|(
name|self
argument_list|)
decl_stmt|;
if|if
condition|(
name|uaa
operator|->
name|usb_mode
operator|!=
name|USB_MODE_HOST
operator|||
name|uaa
operator|->
name|info
operator|.
name|bIfaceIndex
operator|!=
literal|0
operator|||
name|uaa
operator|->
name|info
operator|.
name|bConfigIndex
operator|!=
literal|0
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
return|return
operator|(
name|usbd_lookup_id_by_uaa
argument_list|(
name|otus_devs
argument_list|,
sizeof|sizeof
argument_list|(
name|otus_devs
argument_list|)
argument_list|,
name|uaa
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|otus_attach
parameter_list|(
name|device_t
name|self
parameter_list|)
block|{
name|struct
name|usb_attach_arg
modifier|*
name|uaa
init|=
name|device_get_ivars
argument_list|(
name|self
argument_list|)
decl_stmt|;
name|struct
name|otus_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|self
argument_list|)
decl_stmt|;
name|int
name|error
decl_stmt|;
name|uint8_t
name|iface_index
decl_stmt|;
name|device_set_usb_desc
argument_list|(
name|self
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_udev
operator|=
name|uaa
operator|->
name|device
expr_stmt|;
name|sc
operator|->
name|sc_dev
operator|=
name|self
expr_stmt|;
name|mtx_init
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|,
name|device_get_nameunit
argument_list|(
name|self
argument_list|)
argument_list|,
name|MTX_NETWORK_LOCK
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
name|TIMEOUT_TASK_INIT
argument_list|(
name|taskqueue_thread
argument_list|,
operator|&
name|sc
operator|->
name|scan_to
argument_list|,
literal|0
argument_list|,
name|otus_next_scan
argument_list|,
name|sc
argument_list|)
expr_stmt|;
name|TIMEOUT_TASK_INIT
argument_list|(
name|taskqueue_thread
argument_list|,
operator|&
name|sc
operator|->
name|calib_to
argument_list|,
literal|0
argument_list|,
name|otus_calibrate_to
argument_list|,
name|sc
argument_list|)
expr_stmt|;
name|TASK_INIT
argument_list|(
operator|&
name|sc
operator|->
name|tx_task
argument_list|,
literal|0
argument_list|,
name|otus_tx_task
argument_list|,
name|sc
argument_list|)
expr_stmt|;
name|mbufq_init
argument_list|(
operator|&
name|sc
operator|->
name|sc_snd
argument_list|,
name|ifqmaxlen
argument_list|)
expr_stmt|;
name|iface_index
operator|=
literal|0
expr_stmt|;
name|error
operator|=
name|usbd_transfer_setup
argument_list|(
name|uaa
operator|->
name|device
argument_list|,
operator|&
name|iface_index
argument_list|,
name|sc
operator|->
name|sc_xfer
argument_list|,
name|otus_config
argument_list|,
name|OTUS_N_XFER
argument_list|,
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not allocate USB transfers, err=%s\n"
argument_list|,
name|usbd_errstr
argument_list|(
name|error
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|fail_usb
goto|;
block|}
if|if
condition|(
operator|(
name|error
operator|=
name|otus_open_pipes
argument_list|(
name|sc
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: could not open pipes\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
comment|/* XXX check return status; fail out if appropriate */
if|if
condition|(
name|otus_attachhook
argument_list|(
name|sc
argument_list|)
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail
label|:
name|otus_close_pipes
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|fail_usb
label|:
name|mtx_destroy
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|otus_detach
parameter_list|(
name|device_t
name|self
parameter_list|)
block|{
name|struct
name|otus_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|self
argument_list|)
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
name|otus_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|usbd_transfer_unsetup
argument_list|(
name|sc
operator|->
name|sc_xfer
argument_list|,
name|OTUS_N_XFER
argument_list|)
expr_stmt|;
name|taskqueue_drain_timeout
argument_list|(
name|taskqueue_thread
argument_list|,
operator|&
name|sc
operator|->
name|scan_to
argument_list|)
expr_stmt|;
name|taskqueue_drain_timeout
argument_list|(
name|taskqueue_thread
argument_list|,
operator|&
name|sc
operator|->
name|calib_to
argument_list|)
expr_stmt|;
name|taskqueue_drain
argument_list|(
name|taskqueue_thread
argument_list|,
operator|&
name|sc
operator|->
name|tx_task
argument_list|)
expr_stmt|;
name|otus_close_pipes
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
comment|/* Wait for all queued asynchronous commands to complete. */
block|usb_rem_wait_task(sc->sc_udev,&sc->sc_task);  	usbd_ref_wait(sc->sc_udev);
endif|#
directive|endif
name|ieee80211_ifdetach
argument_list|(
name|ic
argument_list|)
expr_stmt|;
name|mtx_destroy
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|otus_delay_ms
parameter_list|(
name|struct
name|otus_softc
modifier|*
name|sc
parameter_list|,
name|int
name|ms
parameter_list|)
block|{
name|DELAY
argument_list|(
literal|1000
operator|*
name|ms
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|ieee80211vap
modifier|*
name|otus_vap_create
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|,
specifier|const
name|char
name|name
index|[
name|IFNAMSIZ
index|]
parameter_list|,
name|int
name|unit
parameter_list|,
name|enum
name|ieee80211_opmode
name|opmode
parameter_list|,
name|int
name|flags
parameter_list|,
specifier|const
name|uint8_t
name|bssid
index|[
name|IEEE80211_ADDR_LEN
index|]
parameter_list|,
specifier|const
name|uint8_t
name|mac
index|[
name|IEEE80211_ADDR_LEN
index|]
parameter_list|)
block|{
name|struct
name|otus_vap
modifier|*
name|uvp
decl_stmt|;
name|struct
name|ieee80211vap
modifier|*
name|vap
decl_stmt|;
if|if
condition|(
operator|!
name|TAILQ_EMPTY
argument_list|(
operator|&
name|ic
operator|->
name|ic_vaps
argument_list|)
condition|)
comment|/* only one at a time */
return|return
operator|(
name|NULL
operator|)
return|;
name|uvp
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|otus_vap
argument_list|)
argument_list|,
name|M_80211_VAP
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|vap
operator|=
operator|&
name|uvp
operator|->
name|vap
expr_stmt|;
if|if
condition|(
name|ieee80211_vap_setup
argument_list|(
name|ic
argument_list|,
name|vap
argument_list|,
name|name
argument_list|,
name|unit
argument_list|,
name|opmode
argument_list|,
name|flags
argument_list|,
name|bssid
argument_list|)
operator|!=
literal|0
condition|)
block|{
comment|/* out of memory */
name|free
argument_list|(
name|uvp
argument_list|,
name|M_80211_VAP
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
comment|/* override state transition machine */
name|uvp
operator|->
name|newstate
operator|=
name|vap
operator|->
name|iv_newstate
expr_stmt|;
name|vap
operator|->
name|iv_newstate
operator|=
name|otus_newstate
expr_stmt|;
comment|/* XXX TODO: double-check */
name|vap
operator|->
name|iv_ampdu_density
operator|=
name|IEEE80211_HTCAP_MPDUDENSITY_16
expr_stmt|;
name|vap
operator|->
name|iv_ampdu_rxmax
operator|=
name|IEEE80211_HTCAP_MAXRXAMPDU_32K
expr_stmt|;
name|ieee80211_ratectl_init
argument_list|(
name|vap
argument_list|)
expr_stmt|;
comment|/* complete setup */
name|ieee80211_vap_attach
argument_list|(
name|vap
argument_list|,
name|ieee80211_media_change
argument_list|,
name|ieee80211_media_status
argument_list|,
name|mac
argument_list|)
expr_stmt|;
name|ic
operator|->
name|ic_opmode
operator|=
name|opmode
expr_stmt|;
return|return
operator|(
name|vap
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|otus_vap_delete
parameter_list|(
name|struct
name|ieee80211vap
modifier|*
name|vap
parameter_list|)
block|{
name|struct
name|otus_vap
modifier|*
name|uvp
init|=
name|OTUS_VAP
argument_list|(
name|vap
argument_list|)
decl_stmt|;
name|ieee80211_ratectl_deinit
argument_list|(
name|vap
argument_list|)
expr_stmt|;
name|ieee80211_vap_detach
argument_list|(
name|vap
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|uvp
argument_list|,
name|M_80211_VAP
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|otus_parent
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|)
block|{
name|struct
name|otus_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_softc
decl_stmt|;
name|int
name|startall
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|ic
operator|->
name|ic_nrunning
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|sc
operator|->
name|sc_running
condition|)
block|{
name|otus_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|startall
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
operator|(
name|void
operator|)
name|otus_set_multi
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|sc
operator|->
name|sc_running
condition|)
name|otus_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|startall
condition|)
name|ieee80211_start_all
argument_list|(
name|ic
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|otus_drain_mbufq
parameter_list|(
name|struct
name|otus_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|struct
name|ieee80211_node
modifier|*
name|ni
decl_stmt|;
name|OTUS_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|m
operator|=
name|mbufq_dequeue
argument_list|(
operator|&
name|sc
operator|->
name|sc_snd
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|ni
operator|=
operator|(
expr|struct
name|ieee80211_node
operator|*
operator|)
name|m
operator|->
name|m_pkthdr
operator|.
name|rcvif
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|rcvif
operator|=
name|NULL
expr_stmt|;
name|ieee80211_free_node
argument_list|(
name|ni
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|otus_tx_start
parameter_list|(
name|struct
name|otus_softc
modifier|*
name|sc
parameter_list|)
block|{
name|taskqueue_enqueue
argument_list|(
name|taskqueue_thread
argument_list|,
operator|&
name|sc
operator|->
name|tx_task
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|otus_transmit
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|)
block|{
name|struct
name|otus_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_softc
decl_stmt|;
name|int
name|error
decl_stmt|;
name|OTUS_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sc
operator|->
name|sc_running
condition|)
block|{
name|OTUS_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
comment|/* XXX TODO: handle fragments */
name|error
operator|=
name|mbufq_enqueue
argument_list|(
operator|&
name|sc
operator|->
name|sc_snd
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|OTUS_DPRINTF
argument_list|(
name|sc
argument_list|,
name|OTUS_DEBUG_XMIT
argument_list|,
literal|"%s: mbufq_enqueue failed: %d\n"
argument_list|,
name|__func__
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|OTUS_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|OTUS_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Kick TX */
name|otus_tx_start
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|_otus_start
parameter_list|(
name|struct
name|otus_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ieee80211_node
modifier|*
name|ni
decl_stmt|;
name|struct
name|otus_data
modifier|*
name|bf
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|OTUS_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|m
operator|=
name|mbufq_dequeue
argument_list|(
operator|&
name|sc
operator|->
name|sc_snd
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|bf
operator|=
name|otus_getbuf
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|bf
operator|==
name|NULL
condition|)
block|{
name|OTUS_DPRINTF
argument_list|(
name|sc
argument_list|,
name|OTUS_DEBUG_XMIT
argument_list|,
literal|"%s: failed to get buffer\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|mbufq_prepend
argument_list|(
operator|&
name|sc
operator|->
name|sc_snd
argument_list|,
name|m
argument_list|)
expr_stmt|;
break|break;
block|}
name|ni
operator|=
operator|(
expr|struct
name|ieee80211_node
operator|*
operator|)
name|m
operator|->
name|m_pkthdr
operator|.
name|rcvif
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|rcvif
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|otus_tx
argument_list|(
name|sc
argument_list|,
name|ni
argument_list|,
name|m
argument_list|,
name|bf
argument_list|,
name|NULL
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|OTUS_DPRINTF
argument_list|(
name|sc
argument_list|,
name|OTUS_DEBUG_XMIT
argument_list|,
literal|"%s: failed to transmit\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|if_inc_counter
argument_list|(
name|ni
operator|->
name|ni_vap
operator|->
name|iv_ifp
argument_list|,
name|IFCOUNTER_OERRORS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|otus_freebuf
argument_list|(
name|sc
argument_list|,
name|bf
argument_list|)
expr_stmt|;
name|ieee80211_free_node
argument_list|(
name|ni
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|otus_tx_task
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|int
name|pending
parameter_list|)
block|{
name|struct
name|otus_softc
modifier|*
name|sc
init|=
name|arg
decl_stmt|;
name|OTUS_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|_otus_start
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|OTUS_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|otus_raw_xmit
parameter_list|(
name|struct
name|ieee80211_node
modifier|*
name|ni
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
specifier|const
name|struct
name|ieee80211_bpf_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|ni
operator|->
name|ni_ic
decl_stmt|;
name|struct
name|otus_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_softc
decl_stmt|;
name|struct
name|otus_data
modifier|*
name|bf
init|=
name|NULL
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
comment|/* Don't transmit if we're not running */
name|OTUS_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sc
operator|->
name|sc_running
condition|)
block|{
name|error
operator|=
name|ENETDOWN
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|bf
operator|=
name|otus_getbuf
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|bf
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|ENOBUFS
expr_stmt|;
goto|goto
name|error
goto|;
block|}
if|if
condition|(
name|otus_tx
argument_list|(
name|sc
argument_list|,
name|ni
argument_list|,
name|m
argument_list|,
name|bf
argument_list|,
name|params
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|error
operator|=
name|EIO
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|OTUS_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|error
label|:
if|if
condition|(
name|bf
condition|)
name|otus_freebuf
argument_list|(
name|sc
argument_list|,
name|bf
argument_list|)
expr_stmt|;
name|OTUS_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|otus_update_chw
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|)
block|{
name|printf
argument_list|(
literal|"%s: TODO\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|otus_set_channel
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|)
block|{
name|struct
name|otus_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_softc
decl_stmt|;
name|OTUS_DPRINTF
argument_list|(
name|sc
argument_list|,
name|OTUS_DEBUG_RESET
argument_list|,
literal|"%s: set channel: %d\n"
argument_list|,
name|__func__
argument_list|,
name|ic
operator|->
name|ic_curchan
operator|->
name|ic_freq
argument_list|)
expr_stmt|;
name|OTUS_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|otus_set_chan
argument_list|(
name|sc
argument_list|,
name|ic
operator|->
name|ic_curchan
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OTUS_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|otus_ampdu_enable
parameter_list|(
name|struct
name|ieee80211_node
modifier|*
name|ni
parameter_list|,
name|struct
name|ieee80211_tx_ampdu
modifier|*
name|tap
parameter_list|)
block|{
comment|/* For now, no A-MPDU TX support in the driver */
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|otus_scan_start
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|)
block|{
comment|//	printf("%s: TODO\n", __func__);
block|}
end_function

begin_function
specifier|static
name|void
name|otus_scan_end
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|)
block|{
comment|//	printf("%s: TODO\n", __func__);
block|}
end_function

begin_function
specifier|static
name|void
name|otus_update_mcast
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|)
block|{
name|struct
name|otus_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_softc
decl_stmt|;
operator|(
name|void
operator|)
name|otus_set_multi
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|otus_attachhook
parameter_list|(
name|struct
name|otus_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
name|usb_device_request_t
name|req
decl_stmt|;
name|uint32_t
name|in
decl_stmt|,
name|out
decl_stmt|;
name|uint8_t
name|bands
index|[
name|howmany
argument_list|(
name|IEEE80211_MODE_MAX
argument_list|,
literal|8
argument_list|)
index|]
decl_stmt|;
name|int
name|error
decl_stmt|;
comment|/* Not locked */
name|error
operator|=
name|otus_load_firmware
argument_list|(
name|sc
argument_list|,
literal|"otusfw_init"
argument_list|,
name|AR_FW_INIT_ADDR
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: could not load %s firmware\n"
argument_list|,
name|__func__
argument_list|,
literal|"init"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
comment|/* XXX not locked? */
name|otus_delay_ms
argument_list|(
name|sc
argument_list|,
literal|1000
argument_list|)
expr_stmt|;
comment|/* Not locked */
name|error
operator|=
name|otus_load_firmware
argument_list|(
name|sc
argument_list|,
literal|"otusfw_main"
argument_list|,
name|AR_FW_MAIN_ADDR
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: could not load %s firmware\n"
argument_list|,
name|__func__
argument_list|,
literal|"main"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|OTUS_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Tell device that firmware transfer is complete. */
name|req
operator|.
name|bmRequestType
operator|=
name|UT_WRITE_VENDOR_DEVICE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|AR_FW_DOWNLOAD_COMPLETE
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|usbd_do_request_flags
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|,
operator|&
name|req
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|250
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|OTUS_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: firmware initialization failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
comment|/* Send an ECHO command to check that everything is settled. */
name|in
operator|=
literal|0xbadc0ffe
expr_stmt|;
if|if
condition|(
name|otus_cmd
argument_list|(
name|sc
argument_list|,
name|AR_CMD_ECHO
argument_list|,
operator|&
name|in
argument_list|,
sizeof|sizeof
name|in
argument_list|,
operator|&
name|out
argument_list|,
sizeof|sizeof
argument_list|(
name|out
argument_list|)
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|OTUS_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: echo command failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
if|if
condition|(
name|in
operator|!=
name|out
condition|)
block|{
name|OTUS_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: echo reply mismatch: 0x%08x!=0x%08x\n"
argument_list|,
name|__func__
argument_list|,
name|in
argument_list|,
name|out
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
comment|/* Read entire EEPROM. */
if|if
condition|(
name|otus_read_eeprom
argument_list|(
name|sc
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|OTUS_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: could not read EEPROM\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|OTUS_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|txmask
operator|=
name|sc
operator|->
name|eeprom
operator|.
name|baseEepHeader
operator|.
name|txMask
expr_stmt|;
name|sc
operator|->
name|rxmask
operator|=
name|sc
operator|->
name|eeprom
operator|.
name|baseEepHeader
operator|.
name|rxMask
expr_stmt|;
name|sc
operator|->
name|capflags
operator|=
name|sc
operator|->
name|eeprom
operator|.
name|baseEepHeader
operator|.
name|opCapFlags
expr_stmt|;
name|IEEE80211_ADDR_COPY
argument_list|(
name|ic
operator|->
name|ic_macaddr
argument_list|,
name|sc
operator|->
name|eeprom
operator|.
name|baseEepHeader
operator|.
name|macAddr
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_led_newstate
operator|=
name|otus_led_newstate_type3
expr_stmt|;
comment|/* XXX */
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"MAC/BBP AR9170, RF AR%X, MIMO %dT%dR, address %s\n"
argument_list|,
operator|(
name|sc
operator|->
name|capflags
operator|&
name|AR5416_OPFLAGS_11A
operator|)
condition|?
literal|0x9104
else|:
operator|(
operator|(
name|sc
operator|->
name|txmask
operator|==
literal|0x5
operator|)
condition|?
literal|0x9102
else|:
literal|0x9101
operator|)
argument_list|,
operator|(
name|sc
operator|->
name|txmask
operator|==
literal|0x5
operator|)
condition|?
literal|2
else|:
literal|1
argument_list|,
operator|(
name|sc
operator|->
name|rxmask
operator|==
literal|0x5
operator|)
condition|?
literal|2
else|:
literal|1
argument_list|,
name|ether_sprintf
argument_list|(
name|ic
operator|->
name|ic_macaddr
argument_list|)
argument_list|)
expr_stmt|;
name|ic
operator|->
name|ic_softc
operator|=
name|sc
expr_stmt|;
name|ic
operator|->
name|ic_name
operator|=
name|device_get_nameunit
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
expr_stmt|;
name|ic
operator|->
name|ic_phytype
operator|=
name|IEEE80211_T_OFDM
expr_stmt|;
comment|/* not only, but not used */
name|ic
operator|->
name|ic_opmode
operator|=
name|IEEE80211_M_STA
expr_stmt|;
comment|/* default to BSS mode */
comment|/* Set device capabilities. */
name|ic
operator|->
name|ic_caps
operator|=
name|IEEE80211_C_STA
operator||
comment|/* station mode */
if|#
directive|if
literal|0
expr|IEEE80211_C_BGSCAN |
comment|/* Background scan. */
endif|#
directive|endif
name|IEEE80211_C_SHPREAMBLE
operator||
comment|/* Short preamble supported. */
name|IEEE80211_C_WME
operator||
comment|/* WME/QoS */
name|IEEE80211_C_SHSLOT
operator||
comment|/* Short slot time supported. */
name|IEEE80211_C_FF
operator||
comment|/* Atheros fast-frames supported. */
name|IEEE80211_C_MONITOR
operator||
name|IEEE80211_C_WPA
expr_stmt|;
comment|/* WPA/RSN. */
comment|/* XXX TODO: 11n */
if|#
directive|if
literal|0
block|if (sc->eeprom.baseEepHeader.opCapFlags& AR5416_OPFLAGS_11G) {
comment|/* Set supported .11b and .11g rates. */
block|ic->ic_sup_rates[IEEE80211_MODE_11B] = 		    ieee80211_std_rateset_11b; 		ic->ic_sup_rates[IEEE80211_MODE_11G] = 		    ieee80211_std_rateset_11g; 	} 	if (sc->eeprom.baseEepHeader.opCapFlags& AR5416_OPFLAGS_11A) {
comment|/* Set supported .11a rates. */
block|ic->ic_sup_rates[IEEE80211_MODE_11A] = 		    ieee80211_std_rateset_11a; 	}
endif|#
directive|endif
if|#
directive|if
literal|0
comment|/* Build the list of supported channels. */
block|otus_get_chanlist(sc);
else|#
directive|else
comment|/* Set supported .11b and .11g rates. */
name|memset
argument_list|(
name|bands
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|bands
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|eeprom
operator|.
name|baseEepHeader
operator|.
name|opCapFlags
operator|&
name|AR5416_OPFLAGS_11G
condition|)
block|{
name|setbit
argument_list|(
name|bands
argument_list|,
name|IEEE80211_MODE_11B
argument_list|)
expr_stmt|;
name|setbit
argument_list|(
name|bands
argument_list|,
name|IEEE80211_MODE_11G
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|eeprom
operator|.
name|baseEepHeader
operator|.
name|opCapFlags
operator|&
name|AR5416_OPFLAGS_11A
condition|)
block|{
name|setbit
argument_list|(
name|bands
argument_list|,
name|IEEE80211_MODE_11A
argument_list|)
expr_stmt|;
block|}
if|#
directive|if
literal|0
block|if (sc->sc_ht) 		setbit(bands, IEEE80211_MODE_11NG);
endif|#
directive|endif
name|ieee80211_init_channels
argument_list|(
name|ic
argument_list|,
name|NULL
argument_list|,
name|bands
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|ieee80211_ifattach
argument_list|(
name|ic
argument_list|)
expr_stmt|;
name|ic
operator|->
name|ic_raw_xmit
operator|=
name|otus_raw_xmit
expr_stmt|;
name|ic
operator|->
name|ic_scan_start
operator|=
name|otus_scan_start
expr_stmt|;
name|ic
operator|->
name|ic_scan_end
operator|=
name|otus_scan_end
expr_stmt|;
name|ic
operator|->
name|ic_set_channel
operator|=
name|otus_set_channel
expr_stmt|;
name|ic
operator|->
name|ic_vap_create
operator|=
name|otus_vap_create
expr_stmt|;
name|ic
operator|->
name|ic_vap_delete
operator|=
name|otus_vap_delete
expr_stmt|;
name|ic
operator|->
name|ic_update_mcast
operator|=
name|otus_update_mcast
expr_stmt|;
name|ic
operator|->
name|ic_update_promisc
operator|=
name|otus_update_mcast
expr_stmt|;
name|ic
operator|->
name|ic_parent
operator|=
name|otus_parent
expr_stmt|;
name|ic
operator|->
name|ic_transmit
operator|=
name|otus_transmit
expr_stmt|;
name|ic
operator|->
name|ic_update_chw
operator|=
name|otus_update_chw
expr_stmt|;
name|ic
operator|->
name|ic_ampdu_enable
operator|=
name|otus_ampdu_enable
expr_stmt|;
name|ic
operator|->
name|ic_wme
operator|.
name|wme_update
operator|=
name|otus_updateedca
expr_stmt|;
name|ic
operator|->
name|ic_newassoc
operator|=
name|otus_newassoc
expr_stmt|;
name|ic
operator|->
name|ic_node_alloc
operator|=
name|otus_node_alloc
expr_stmt|;
ifdef|#
directive|ifdef
name|notyet
name|ic
operator|->
name|ic_set_key
operator|=
name|otus_set_key
expr_stmt|;
name|ic
operator|->
name|ic_delete_key
operator|=
name|otus_delete_key
expr_stmt|;
endif|#
directive|endif
name|ieee80211_radiotap_attach
argument_list|(
name|ic
argument_list|,
operator|&
name|sc
operator|->
name|sc_txtap
operator|.
name|wt_ihdr
argument_list|,
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|sc_txtap
argument_list|)
argument_list|,
name|OTUS_TX_RADIOTAP_PRESENT
argument_list|,
operator|&
name|sc
operator|->
name|sc_rxtap
operator|.
name|wr_ihdr
argument_list|,
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|sc_rxtap
argument_list|)
argument_list|,
name|OTUS_RX_RADIOTAP_PRESENT
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|void
name|otus_get_chanlist
parameter_list|(
name|struct
name|otus_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
name|uint16_t
name|domain
decl_stmt|;
name|uint8_t
name|chan
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* XXX regulatory domain. */
name|domain
operator|=
name|le16toh
argument_list|(
name|sc
operator|->
name|eeprom
operator|.
name|baseEepHeader
operator|.
name|regDmn
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|OTUS_DPRINTF
argument_list|(
name|sc
argument_list|,
name|OTUS_DEBUG_RESET
argument_list|,
literal|"regdomain=0x%04x\n"
argument_list|,
name|domain
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|eeprom
operator|.
name|baseEepHeader
operator|.
name|opCapFlags
operator|&
name|AR5416_OPFLAGS_11G
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|14
condition|;
name|i
operator|++
control|)
block|{
name|chan
operator|=
name|ar_chans
index|[
name|i
index|]
expr_stmt|;
name|ic
operator|->
name|ic_channels
index|[
name|chan
index|]
operator|.
name|ic_freq
operator|=
name|ieee80211_ieee2mhz
argument_list|(
name|chan
argument_list|,
name|IEEE80211_CHAN_2GHZ
argument_list|)
expr_stmt|;
name|ic
operator|->
name|ic_channels
index|[
name|chan
index|]
operator|.
name|ic_flags
operator|=
name|IEEE80211_CHAN_CCK
operator||
name|IEEE80211_CHAN_OFDM
operator||
name|IEEE80211_CHAN_DYN
operator||
name|IEEE80211_CHAN_2GHZ
expr_stmt|;
block|}
block|}
if|if
condition|(
name|sc
operator|->
name|eeprom
operator|.
name|baseEepHeader
operator|.
name|opCapFlags
operator|&
name|AR5416_OPFLAGS_11A
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|14
init|;
name|i
operator|<
name|nitems
argument_list|(
name|ar_chans
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|chan
operator|=
name|ar_chans
index|[
name|i
index|]
expr_stmt|;
name|ic
operator|->
name|ic_channels
index|[
name|chan
index|]
operator|.
name|ic_freq
operator|=
name|ieee80211_ieee2mhz
argument_list|(
name|chan
argument_list|,
name|IEEE80211_CHAN_5GHZ
argument_list|)
expr_stmt|;
name|ic
operator|->
name|ic_channels
index|[
name|chan
index|]
operator|.
name|ic_flags
operator|=
name|IEEE80211_CHAN_A
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|int
name|otus_load_firmware
parameter_list|(
name|struct
name|otus_softc
modifier|*
name|sc
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|uint32_t
name|addr
parameter_list|)
block|{
name|usb_device_request_t
name|req
decl_stmt|;
name|char
modifier|*
name|ptr
decl_stmt|;
specifier|const
name|struct
name|firmware
modifier|*
name|fw
decl_stmt|;
name|int
name|mlen
decl_stmt|,
name|error
decl_stmt|,
name|size
decl_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
comment|/* Read firmware image from the filesystem. */
if|if
condition|(
operator|(
name|fw
operator|=
name|firmware_get
argument_list|(
name|name
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: failed loadfirmware of file %s\n"
argument_list|,
name|__func__
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|req
operator|.
name|bmRequestType
operator|=
name|UT_WRITE_VENDOR_DEVICE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|AR_FW_DOWNLOAD
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OTUS_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* XXX const */
name|ptr
operator|=
name|__DECONST
argument_list|(
name|char
operator|*
argument_list|,
name|fw
operator|->
name|data
argument_list|)
expr_stmt|;
name|size
operator|=
name|fw
operator|->
name|datasize
expr_stmt|;
name|addr
operator|>>=
literal|8
expr_stmt|;
while|while
condition|(
name|size
operator|>
literal|0
condition|)
block|{
name|mlen
operator|=
name|MIN
argument_list|(
name|size
argument_list|,
literal|4096
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
name|mlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|usbd_do_request_flags
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|,
operator|&
name|req
argument_list|,
name|ptr
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|250
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|error
operator|=
name|EIO
expr_stmt|;
break|break;
block|}
name|addr
operator|+=
name|mlen
operator|>>
literal|8
expr_stmt|;
name|ptr
operator|+=
name|mlen
expr_stmt|;
name|size
operator|-=
name|mlen
expr_stmt|;
block|}
name|OTUS_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|firmware_put
argument_list|(
name|fw
argument_list|,
name|FIRMWARE_UNLOAD
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: %s: error=%d\n"
argument_list|,
name|__func__
argument_list|,
name|name
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_function
name|int
name|otus_open_pipes
parameter_list|(
name|struct
name|otus_softc
modifier|*
name|sc
parameter_list|)
block|{
if|#
directive|if
literal|0
block|int isize, error; 	int i;
endif|#
directive|endif
name|int
name|error
decl_stmt|;
name|OTUS_UNLOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|otus_alloc_tx_cmd_list
argument_list|(
name|sc
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: could not allocate command xfer\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
operator|(
name|error
operator|=
name|otus_alloc_tx_list
argument_list|(
name|sc
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: could not allocate Tx xfers\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
operator|(
name|error
operator|=
name|otus_alloc_rx_list
argument_list|(
name|sc
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: could not allocate Rx xfers\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
comment|/* Enable RX transfers; needed for initial firmware messages */
name|OTUS_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|usbd_transfer_start
argument_list|(
name|sc
operator|->
name|sc_xfer
index|[
name|OTUS_BULK_RX
index|]
argument_list|)
expr_stmt|;
name|usbd_transfer_start
argument_list|(
name|sc
operator|->
name|sc_xfer
index|[
name|OTUS_BULK_IRQ
index|]
argument_list|)
expr_stmt|;
name|OTUS_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|fail
label|:
name|otus_close_pipes
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_function
name|void
name|otus_close_pipes
parameter_list|(
name|struct
name|otus_softc
modifier|*
name|sc
parameter_list|)
block|{
name|OTUS_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|otus_free_tx_cmd_list
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|otus_free_tx_list
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|otus_free_rx_list
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|OTUS_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|usbd_transfer_unsetup
argument_list|(
name|sc
operator|->
name|sc_xfer
argument_list|,
name|OTUS_N_XFER
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|otus_free_cmd_list
parameter_list|(
name|struct
name|otus_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|otus_tx_cmd
name|cmd
index|[]
parameter_list|,
name|int
name|ndata
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
comment|/* XXX TODO: someone has to have waken up waiters! */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ndata
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|otus_tx_cmd
modifier|*
name|dp
init|=
operator|&
name|cmd
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
name|dp
operator|->
name|buf
operator|!=
name|NULL
condition|)
block|{
name|free
argument_list|(
name|dp
operator|->
name|buf
argument_list|,
name|M_USBDEV
argument_list|)
expr_stmt|;
name|dp
operator|->
name|buf
operator|=
name|NULL
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|otus_alloc_cmd_list
parameter_list|(
name|struct
name|otus_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|otus_tx_cmd
name|cmd
index|[]
parameter_list|,
name|int
name|ndata
parameter_list|,
name|int
name|maxsz
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|error
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ndata
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|otus_tx_cmd
modifier|*
name|dp
init|=
operator|&
name|cmd
index|[
name|i
index|]
decl_stmt|;
name|dp
operator|->
name|buf
operator|=
name|malloc
argument_list|(
name|maxsz
argument_list|,
name|M_USBDEV
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
name|dp
operator|->
name|odata
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|dp
operator|->
name|buf
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not allocate buffer\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|fail
label|:
name|otus_free_cmd_list
argument_list|(
name|sc
argument_list|,
name|cmd
argument_list|,
name|ndata
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|otus_alloc_tx_cmd_list
parameter_list|(
name|struct
name|otus_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|error
decl_stmt|,
name|i
decl_stmt|;
name|error
operator|=
name|otus_alloc_cmd_list
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|sc_cmd
argument_list|,
name|OTUS_CMD_LIST_COUNT
argument_list|,
name|OTUS_MAX_TXCMDSZ
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|STAILQ_INIT
argument_list|(
operator|&
name|sc
operator|->
name|sc_cmd_active
argument_list|)
expr_stmt|;
name|STAILQ_INIT
argument_list|(
operator|&
name|sc
operator|->
name|sc_cmd_inactive
argument_list|)
expr_stmt|;
name|STAILQ_INIT
argument_list|(
operator|&
name|sc
operator|->
name|sc_cmd_pending
argument_list|)
expr_stmt|;
name|STAILQ_INIT
argument_list|(
operator|&
name|sc
operator|->
name|sc_cmd_waiting
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|OTUS_CMD_LIST_COUNT
condition|;
name|i
operator|++
control|)
name|STAILQ_INSERT_HEAD
argument_list|(
operator|&
name|sc
operator|->
name|sc_cmd_inactive
argument_list|,
operator|&
name|sc
operator|->
name|sc_cmd
index|[
name|i
index|]
argument_list|,
name|next_cmd
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|otus_free_tx_cmd_list
parameter_list|(
name|struct
name|otus_softc
modifier|*
name|sc
parameter_list|)
block|{
comment|/* 	 * XXX TODO: something needs to wake up any pending/sleeping 	 * waiters! 	 */
name|STAILQ_INIT
argument_list|(
operator|&
name|sc
operator|->
name|sc_cmd_active
argument_list|)
expr_stmt|;
name|STAILQ_INIT
argument_list|(
operator|&
name|sc
operator|->
name|sc_cmd_inactive
argument_list|)
expr_stmt|;
name|STAILQ_INIT
argument_list|(
operator|&
name|sc
operator|->
name|sc_cmd_pending
argument_list|)
expr_stmt|;
name|STAILQ_INIT
argument_list|(
operator|&
name|sc
operator|->
name|sc_cmd_waiting
argument_list|)
expr_stmt|;
name|otus_free_cmd_list
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|sc_cmd
argument_list|,
name|OTUS_CMD_LIST_COUNT
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|otus_alloc_list
parameter_list|(
name|struct
name|otus_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|otus_data
name|data
index|[]
parameter_list|,
name|int
name|ndata
parameter_list|,
name|int
name|maxsz
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|error
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ndata
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|otus_data
modifier|*
name|dp
init|=
operator|&
name|data
index|[
name|i
index|]
decl_stmt|;
name|dp
operator|->
name|sc
operator|=
name|sc
expr_stmt|;
name|dp
operator|->
name|m
operator|=
name|NULL
expr_stmt|;
name|dp
operator|->
name|buf
operator|=
name|malloc
argument_list|(
name|maxsz
argument_list|,
name|M_USBDEV
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|dp
operator|->
name|buf
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not allocate buffer\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|dp
operator|->
name|ni
operator|=
name|NULL
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|fail
label|:
name|otus_free_list
argument_list|(
name|sc
argument_list|,
name|data
argument_list|,
name|ndata
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|otus_alloc_rx_list
parameter_list|(
name|struct
name|otus_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|error
decl_stmt|,
name|i
decl_stmt|;
name|error
operator|=
name|otus_alloc_list
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|sc_rx
argument_list|,
name|OTUS_RX_LIST_COUNT
argument_list|,
name|OTUS_RXBUFSZ
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|STAILQ_INIT
argument_list|(
operator|&
name|sc
operator|->
name|sc_rx_active
argument_list|)
expr_stmt|;
name|STAILQ_INIT
argument_list|(
operator|&
name|sc
operator|->
name|sc_rx_inactive
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|OTUS_RX_LIST_COUNT
condition|;
name|i
operator|++
control|)
name|STAILQ_INSERT_HEAD
argument_list|(
operator|&
name|sc
operator|->
name|sc_rx_inactive
argument_list|,
operator|&
name|sc
operator|->
name|sc_rx
index|[
name|i
index|]
argument_list|,
name|next
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|otus_alloc_tx_list
parameter_list|(
name|struct
name|otus_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|error
decl_stmt|,
name|i
decl_stmt|;
name|error
operator|=
name|otus_alloc_list
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|sc_tx
argument_list|,
name|OTUS_TX_LIST_COUNT
argument_list|,
name|OTUS_TXBUFSZ
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|STAILQ_INIT
argument_list|(
operator|&
name|sc
operator|->
name|sc_tx_inactive
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|!=
name|OTUS_N_XFER
condition|;
name|i
operator|++
control|)
block|{
name|STAILQ_INIT
argument_list|(
operator|&
name|sc
operator|->
name|sc_tx_active
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|STAILQ_INIT
argument_list|(
operator|&
name|sc
operator|->
name|sc_tx_pending
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|OTUS_TX_LIST_COUNT
condition|;
name|i
operator|++
control|)
block|{
name|STAILQ_INSERT_HEAD
argument_list|(
operator|&
name|sc
operator|->
name|sc_tx_inactive
argument_list|,
operator|&
name|sc
operator|->
name|sc_tx
index|[
name|i
index|]
argument_list|,
name|next
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|otus_free_tx_list
parameter_list|(
name|struct
name|otus_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
comment|/* prevent further allocations from TX list(s) */
name|STAILQ_INIT
argument_list|(
operator|&
name|sc
operator|->
name|sc_tx_inactive
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|!=
name|OTUS_N_XFER
condition|;
name|i
operator|++
control|)
block|{
name|STAILQ_INIT
argument_list|(
operator|&
name|sc
operator|->
name|sc_tx_active
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|STAILQ_INIT
argument_list|(
operator|&
name|sc
operator|->
name|sc_tx_pending
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|otus_free_list
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|sc_tx
argument_list|,
name|OTUS_TX_LIST_COUNT
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|otus_free_rx_list
parameter_list|(
name|struct
name|otus_softc
modifier|*
name|sc
parameter_list|)
block|{
comment|/* prevent further allocations from RX list(s) */
name|STAILQ_INIT
argument_list|(
operator|&
name|sc
operator|->
name|sc_rx_inactive
argument_list|)
expr_stmt|;
name|STAILQ_INIT
argument_list|(
operator|&
name|sc
operator|->
name|sc_rx_active
argument_list|)
expr_stmt|;
name|otus_free_list
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|sc_rx
argument_list|,
name|OTUS_RX_LIST_COUNT
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|otus_free_list
parameter_list|(
name|struct
name|otus_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|otus_data
name|data
index|[]
parameter_list|,
name|int
name|ndata
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ndata
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|otus_data
modifier|*
name|dp
init|=
operator|&
name|data
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
name|dp
operator|->
name|buf
operator|!=
name|NULL
condition|)
block|{
name|free
argument_list|(
name|dp
operator|->
name|buf
argument_list|,
name|M_USBDEV
argument_list|)
expr_stmt|;
name|dp
operator|->
name|buf
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|dp
operator|->
name|ni
operator|!=
name|NULL
condition|)
block|{
name|ieee80211_free_node
argument_list|(
name|dp
operator|->
name|ni
argument_list|)
expr_stmt|;
name|dp
operator|->
name|ni
operator|=
name|NULL
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|struct
name|otus_data
modifier|*
name|_otus_getbuf
parameter_list|(
name|struct
name|otus_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|otus_data
modifier|*
name|bf
decl_stmt|;
name|bf
operator|=
name|STAILQ_FIRST
argument_list|(
operator|&
name|sc
operator|->
name|sc_tx_inactive
argument_list|)
expr_stmt|;
if|if
condition|(
name|bf
operator|!=
name|NULL
condition|)
name|STAILQ_REMOVE_HEAD
argument_list|(
operator|&
name|sc
operator|->
name|sc_tx_inactive
argument_list|,
name|next
argument_list|)
expr_stmt|;
else|else
name|bf
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
name|bf
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|otus_data
modifier|*
name|otus_getbuf
parameter_list|(
name|struct
name|otus_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|otus_data
modifier|*
name|bf
decl_stmt|;
name|OTUS_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|bf
operator|=
name|_otus_getbuf
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|bf
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|otus_freebuf
parameter_list|(
name|struct
name|otus_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|otus_data
modifier|*
name|bf
parameter_list|)
block|{
name|OTUS_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|sc
operator|->
name|sc_tx_inactive
argument_list|,
name|bf
argument_list|,
name|next
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|otus_tx_cmd
modifier|*
name|_otus_get_txcmd
parameter_list|(
name|struct
name|otus_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|otus_tx_cmd
modifier|*
name|bf
decl_stmt|;
name|bf
operator|=
name|STAILQ_FIRST
argument_list|(
operator|&
name|sc
operator|->
name|sc_cmd_inactive
argument_list|)
expr_stmt|;
if|if
condition|(
name|bf
operator|!=
name|NULL
condition|)
name|STAILQ_REMOVE_HEAD
argument_list|(
operator|&
name|sc
operator|->
name|sc_cmd_inactive
argument_list|,
name|next_cmd
argument_list|)
expr_stmt|;
else|else
name|bf
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
name|bf
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|otus_tx_cmd
modifier|*
name|otus_get_txcmd
parameter_list|(
name|struct
name|otus_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|otus_tx_cmd
modifier|*
name|bf
decl_stmt|;
name|OTUS_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|bf
operator|=
name|_otus_get_txcmd
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|bf
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: no tx cmd buffers\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|bf
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|otus_free_txcmd
parameter_list|(
name|struct
name|otus_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|otus_tx_cmd
modifier|*
name|bf
parameter_list|)
block|{
name|OTUS_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|sc
operator|->
name|sc_cmd_inactive
argument_list|,
name|bf
argument_list|,
name|next_cmd
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|otus_next_scan
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|int
name|pending
parameter_list|)
block|{
if|#
directive|if
literal|0
block|struct otus_softc *sc = arg;  	if (usbd_is_dying(sc->sc_udev)) 		return;  	usbd_ref_incr(sc->sc_udev);  	if (sc->sc_ic.ic_state == IEEE80211_S_SCAN) 		ieee80211_next_scan(&sc->sc_ic.ic_if);  	usbd_ref_decr(sc->sc_udev);
endif|#
directive|endif
block|}
end_function

begin_function
name|int
name|otus_newstate
parameter_list|(
name|struct
name|ieee80211vap
modifier|*
name|vap
parameter_list|,
name|enum
name|ieee80211_state
name|nstate
parameter_list|,
name|int
name|arg
parameter_list|)
block|{
name|struct
name|otus_vap
modifier|*
name|uvp
init|=
name|OTUS_VAP
argument_list|(
name|vap
argument_list|)
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|vap
operator|->
name|iv_ic
decl_stmt|;
name|struct
name|otus_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_softc
decl_stmt|;
name|struct
name|ieee80211_node
modifier|*
name|ni
decl_stmt|;
name|enum
name|ieee80211_state
name|ostate
decl_stmt|;
name|ostate
operator|=
name|vap
operator|->
name|iv_state
expr_stmt|;
name|OTUS_DPRINTF
argument_list|(
name|sc
argument_list|,
name|OTUS_DEBUG_STATE
argument_list|,
literal|"%s: %s -> %s\n"
argument_list|,
name|__func__
argument_list|,
name|ieee80211_state_name
index|[
name|ostate
index|]
argument_list|,
name|ieee80211_state_name
index|[
name|nstate
index|]
argument_list|)
expr_stmt|;
name|IEEE80211_UNLOCK
argument_list|(
name|ic
argument_list|)
expr_stmt|;
name|OTUS_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* XXX TODO: more fleshing out! */
switch|switch
condition|(
name|nstate
condition|)
block|{
case|case
name|IEEE80211_S_RUN
case|:
name|ni
operator|=
name|ieee80211_ref_node
argument_list|(
name|vap
operator|->
name|iv_bss
argument_list|)
expr_stmt|;
if|if
condition|(
name|ic
operator|->
name|ic_opmode
operator|==
name|IEEE80211_M_STA
condition|)
block|{
name|otus_updateslot
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|otus_set_bssid
argument_list|(
name|sc
argument_list|,
name|ni
operator|->
name|ni_bssid
argument_list|)
expr_stmt|;
comment|/* Start calibration timer. */
name|taskqueue_enqueue_timeout
argument_list|(
name|taskqueue_thread
argument_list|,
operator|&
name|sc
operator|->
name|calib_to
argument_list|,
name|hz
argument_list|)
expr_stmt|;
block|}
name|ieee80211_free_node
argument_list|(
name|ni
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
comment|/* XXX TODO: calibration? */
name|sc
operator|->
name|sc_led_newstate
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|OTUS_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|IEEE80211_LOCK
argument_list|(
name|ic
argument_list|)
expr_stmt|;
return|return
operator|(
name|uvp
operator|->
name|newstate
argument_list|(
name|vap
argument_list|,
name|nstate
argument_list|,
name|arg
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|otus_cmd
parameter_list|(
name|struct
name|otus_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|code
parameter_list|,
specifier|const
name|void
modifier|*
name|idata
parameter_list|,
name|int
name|ilen
parameter_list|,
name|void
modifier|*
name|odata
parameter_list|,
name|int
name|odatalen
parameter_list|)
block|{
name|struct
name|otus_tx_cmd
modifier|*
name|cmd
decl_stmt|;
name|struct
name|ar_cmd_hdr
modifier|*
name|hdr
decl_stmt|;
name|int
name|xferlen
decl_stmt|,
name|error
decl_stmt|;
name|OTUS_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Always bulk-out a multiple of 4 bytes. */
name|xferlen
operator|=
operator|(
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
operator|+
name|ilen
operator|+
literal|3
operator|)
operator|&
operator|~
literal|3
expr_stmt|;
if|if
condition|(
name|xferlen
operator|>
name|OTUS_MAX_TXCMDSZ
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: command (0x%02x) size (%d)> %d\n"
argument_list|,
name|__func__
argument_list|,
name|code
argument_list|,
name|xferlen
argument_list|,
name|OTUS_MAX_TXCMDSZ
argument_list|)
expr_stmt|;
return|return
operator|(
name|EIO
operator|)
return|;
block|}
name|cmd
operator|=
name|otus_get_txcmd
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: failed to get buf\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
name|EIO
operator|)
return|;
block|}
name|hdr
operator|=
operator|(
expr|struct
name|ar_cmd_hdr
operator|*
operator|)
name|cmd
operator|->
name|buf
expr_stmt|;
name|hdr
operator|->
name|code
operator|=
name|code
expr_stmt|;
name|hdr
operator|->
name|len
operator|=
name|ilen
expr_stmt|;
name|hdr
operator|->
name|token
operator|=
operator|++
name|sc
operator|->
name|token
expr_stmt|;
comment|/* Don't care about endianness. */
name|cmd
operator|->
name|token
operator|=
name|hdr
operator|->
name|token
expr_stmt|;
comment|/* XXX TODO: check max cmd length? */
name|memcpy
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|hdr
index|[
literal|1
index|]
argument_list|,
name|idata
argument_list|,
name|ilen
argument_list|)
expr_stmt|;
name|OTUS_DPRINTF
argument_list|(
name|sc
argument_list|,
name|OTUS_DEBUG_CMD
argument_list|,
literal|"%s: sending command code=0x%02x len=%d token=%d\n"
argument_list|,
name|__func__
argument_list|,
name|code
argument_list|,
name|ilen
argument_list|,
name|hdr
operator|->
name|token
argument_list|)
expr_stmt|;
name|cmd
operator|->
name|odata
operator|=
name|odata
expr_stmt|;
name|cmd
operator|->
name|odatalen
operator|=
name|odatalen
expr_stmt|;
name|cmd
operator|->
name|buflen
operator|=
name|xferlen
expr_stmt|;
comment|/* Queue the command to the endpoint */
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|sc
operator|->
name|sc_cmd_pending
argument_list|,
name|cmd
argument_list|,
name|next_cmd
argument_list|)
expr_stmt|;
name|usbd_transfer_start
argument_list|(
name|sc
operator|->
name|sc_xfer
index|[
name|OTUS_BULK_CMD
index|]
argument_list|)
expr_stmt|;
comment|/* Sleep on the command; wait for it to complete */
name|error
operator|=
name|msleep
argument_list|(
name|cmd
argument_list|,
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|,
name|PCATCH
argument_list|,
literal|"otuscmd"
argument_list|,
name|hz
argument_list|)
expr_stmt|;
comment|/* 	 * At this point we don't own cmd any longer; it'll be 	 * freed by the cmd bulk path or the RX notification 	 * path.  If the data is made available then it'll be copied 	 * to the caller.  All that is left to do is communicate 	 * status back to the caller. 	 */
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: timeout waiting for command 0x%02x reply\n"
argument_list|,
name|__func__
argument_list|,
name|code
argument_list|)
expr_stmt|;
block|}
return|return
name|error
return|;
block|}
end_function

begin_function
name|void
name|otus_write
parameter_list|(
name|struct
name|otus_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|reg
parameter_list|,
name|uint32_t
name|val
parameter_list|)
block|{
name|OTUS_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|write_buf
index|[
name|sc
operator|->
name|write_idx
index|]
operator|.
name|reg
operator|=
name|htole32
argument_list|(
name|reg
argument_list|)
expr_stmt|;
name|sc
operator|->
name|write_buf
index|[
name|sc
operator|->
name|write_idx
index|]
operator|.
name|val
operator|=
name|htole32
argument_list|(
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
operator|++
name|sc
operator|->
name|write_idx
operator|>
operator|(
name|AR_MAX_WRITE_IDX
operator|-
literal|1
operator|)
condition|)
operator|(
name|void
operator|)
name|otus_write_barrier
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|otus_write_barrier
parameter_list|(
name|struct
name|otus_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
name|OTUS_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|write_idx
operator|==
literal|0
condition|)
return|return
literal|0
return|;
comment|/* Nothing to flush. */
name|OTUS_DPRINTF
argument_list|(
name|sc
argument_list|,
name|OTUS_DEBUG_REGIO
argument_list|,
literal|"%s: called; %d updates\n"
argument_list|,
name|__func__
argument_list|,
name|sc
operator|->
name|write_idx
argument_list|)
expr_stmt|;
name|error
operator|=
name|otus_cmd
argument_list|(
name|sc
argument_list|,
name|AR_CMD_WREG
argument_list|,
name|sc
operator|->
name|write_buf
argument_list|,
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|write_buf
index|[
literal|0
index|]
argument_list|)
operator|*
name|sc
operator|->
name|write_idx
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sc
operator|->
name|write_idx
operator|=
literal|0
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|ieee80211_node
modifier|*
name|otus_node_alloc
parameter_list|(
name|struct
name|ieee80211vap
modifier|*
name|vap
parameter_list|,
specifier|const
name|uint8_t
name|mac
index|[
name|IEEE80211_ADDR_LEN
index|]
parameter_list|)
block|{
return|return
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|otus_node
argument_list|)
argument_list|,
name|M_80211_NODE
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
return|;
block|}
end_function

begin_if
if|#
directive|if
literal|0
end_if

begin_endif
unit|int otus_media_change(struct ifnet *ifp) { 	struct otus_softc *sc = ifp->if_softc; 	struct ieee80211com *ic =&sc->sc_ic; 	uint8_t rate, ridx; 	int error;  	error = ieee80211_media_change(ifp); 	if (error != ENETRESET) 		return error;  	if (ic->ic_fixed_rate != -1) { 		rate = ic->ic_sup_rates[ic->ic_curmode]. 		    rs_rates[ic->ic_fixed_rate]& IEEE80211_RATE_VAL; 		for (ridx = 0; ridx<= OTUS_RIDX_MAX; ridx++) 			if (otus_rates[ridx].rate == rate) 				break; 		sc->fixed_ridx = ridx; 	}  	if ((ifp->if_flags& (IFF_UP | IFF_RUNNING)) == (IFF_UP | IFF_RUNNING)) 		error = otus_init(sc);  	return error; }
endif|#
directive|endif
end_endif

begin_function
name|int
name|otus_read_eeprom
parameter_list|(
name|struct
name|otus_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|regs
index|[
literal|8
index|]
decl_stmt|,
name|reg
decl_stmt|;
name|uint8_t
modifier|*
name|eep
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|error
decl_stmt|;
name|OTUS_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Read EEPROM by blocks of 32 bytes. */
name|eep
operator|=
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|sc
operator|->
name|eeprom
expr_stmt|;
name|reg
operator|=
name|AR_EEPROM_OFFSET
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|eeprom
argument_list|)
operator|/
literal|32
condition|;
name|i
operator|++
control|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|8
condition|;
name|j
operator|++
operator|,
name|reg
operator|+=
literal|4
control|)
name|regs
index|[
name|j
index|]
operator|=
name|htole32
argument_list|(
name|reg
argument_list|)
expr_stmt|;
name|error
operator|=
name|otus_cmd
argument_list|(
name|sc
argument_list|,
name|AR_CMD_RREG
argument_list|,
name|regs
argument_list|,
sizeof|sizeof
name|regs
argument_list|,
name|eep
argument_list|,
literal|32
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
break|break;
name|eep
operator|+=
literal|32
expr_stmt|;
block|}
return|return
name|error
return|;
block|}
end_function

begin_function
name|void
name|otus_newassoc
parameter_list|(
name|struct
name|ieee80211_node
modifier|*
name|ni
parameter_list|,
name|int
name|isnew
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|ni
operator|->
name|ni_ic
decl_stmt|;
name|struct
name|otus_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_softc
decl_stmt|;
name|struct
name|otus_node
modifier|*
name|on
init|=
name|OTUS_NODE
argument_list|(
name|ni
argument_list|)
decl_stmt|;
name|OTUS_DPRINTF
argument_list|(
name|sc
argument_list|,
name|OTUS_DEBUG_STATE
argument_list|,
literal|"new assoc isnew=%d addr=%s\n"
argument_list|,
name|isnew
argument_list|,
name|ether_sprintf
argument_list|(
name|ni
operator|->
name|ni_macaddr
argument_list|)
argument_list|)
expr_stmt|;
name|on
operator|->
name|tx_done
operator|=
literal|0
expr_stmt|;
name|on
operator|->
name|tx_err
operator|=
literal|0
expr_stmt|;
name|on
operator|->
name|tx_retries
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|otus_cmd_handle_response
parameter_list|(
name|struct
name|otus_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|ar_cmd_hdr
modifier|*
name|hdr
parameter_list|)
block|{
name|struct
name|otus_tx_cmd
modifier|*
name|cmd
decl_stmt|;
name|OTUS_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|OTUS_DPRINTF
argument_list|(
name|sc
argument_list|,
name|OTUS_DEBUG_CMDDONE
argument_list|,
literal|"%s: received reply code=0x%02x len=%d token=%d\n"
argument_list|,
name|__func__
argument_list|,
name|hdr
operator|->
name|code
argument_list|,
name|hdr
operator|->
name|len
argument_list|,
name|hdr
operator|->
name|token
argument_list|)
expr_stmt|;
comment|/* 	 * Walk the list, freeing items that aren't ours, 	 * stopping when we hit our token. 	 */
while|while
condition|(
operator|(
name|cmd
operator|=
name|STAILQ_FIRST
argument_list|(
operator|&
name|sc
operator|->
name|sc_cmd_waiting
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|STAILQ_REMOVE_HEAD
argument_list|(
operator|&
name|sc
operator|->
name|sc_cmd_waiting
argument_list|,
name|next_cmd
argument_list|)
expr_stmt|;
name|OTUS_DPRINTF
argument_list|(
name|sc
argument_list|,
name|OTUS_DEBUG_CMDDONE
argument_list|,
literal|"%s: cmd=%p; hdr.token=%d, cmd.token=%d\n"
argument_list|,
name|__func__
argument_list|,
name|cmd
argument_list|,
operator|(
name|int
operator|)
name|hdr
operator|->
name|token
argument_list|,
operator|(
name|int
operator|)
name|cmd
operator|->
name|token
argument_list|)
expr_stmt|;
if|if
condition|(
name|hdr
operator|->
name|token
operator|==
name|cmd
operator|->
name|token
condition|)
block|{
comment|/* Copy answer into caller's supplied buffer. */
if|if
condition|(
name|cmd
operator|->
name|odata
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|hdr
operator|->
name|len
operator|!=
name|cmd
operator|->
name|odatalen
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: code 0x%02x, len=%d, olen=%d\n"
argument_list|,
name|__func__
argument_list|,
operator|(
name|int
operator|)
name|hdr
operator|->
name|code
argument_list|,
operator|(
name|int
operator|)
name|hdr
operator|->
name|len
argument_list|,
operator|(
name|int
operator|)
name|cmd
operator|->
name|odatalen
argument_list|)
expr_stmt|;
block|}
name|memcpy
argument_list|(
name|cmd
operator|->
name|odata
argument_list|,
operator|&
name|hdr
index|[
literal|1
index|]
argument_list|,
name|MIN
argument_list|(
name|cmd
operator|->
name|odatalen
argument_list|,
name|hdr
operator|->
name|len
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|wakeup
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
block|}
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|sc
operator|->
name|sc_cmd_inactive
argument_list|,
name|cmd
argument_list|,
name|next_cmd
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|otus_cmd_rxeof
parameter_list|(
name|struct
name|otus_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
modifier|*
name|buf
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
name|struct
name|ar_cmd_hdr
modifier|*
name|hdr
decl_stmt|;
name|OTUS_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|__predict_false
argument_list|(
name|len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
argument_list|)
condition|)
block|{
name|OTUS_DPRINTF
argument_list|(
name|sc
argument_list|,
name|OTUS_DEBUG_CMDDONE
argument_list|,
literal|"cmd too small %d\n"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return;
block|}
name|hdr
operator|=
operator|(
expr|struct
name|ar_cmd_hdr
operator|*
operator|)
name|buf
expr_stmt|;
if|if
condition|(
name|__predict_false
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
operator|+
name|hdr
operator|->
name|len
operator|>
name|len
operator|||
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
operator|+
name|hdr
operator|->
name|len
operator|>
literal|64
argument_list|)
condition|)
block|{
name|OTUS_DPRINTF
argument_list|(
name|sc
argument_list|,
name|OTUS_DEBUG_CMDDONE
argument_list|,
literal|"cmd too large %d\n"
argument_list|,
name|hdr
operator|->
name|len
argument_list|)
expr_stmt|;
return|return;
block|}
name|OTUS_DPRINTF
argument_list|(
name|sc
argument_list|,
name|OTUS_DEBUG_RXDONE
argument_list|,
literal|"%s: code=%.02x\n"
argument_list|,
name|__func__
argument_list|,
name|hdr
operator|->
name|code
argument_list|)
expr_stmt|;
comment|/* 	 * This has to reach into the cmd queue "waiting for 	 * an RX response" list, grab the head entry and check 	 * if we need to wake anyone up. 	 */
if|if
condition|(
operator|(
name|hdr
operator|->
name|code
operator|&
literal|0xc0
operator|)
operator|!=
literal|0xc0
condition|)
block|{
name|otus_cmd_handle_response
argument_list|(
name|sc
argument_list|,
name|hdr
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Received unsolicited notification. */
switch|switch
condition|(
name|hdr
operator|->
name|code
operator|&
literal|0x3f
condition|)
block|{
case|case
name|AR_EVT_BEACON
case|:
break|break;
case|case
name|AR_EVT_TX_COMP
case|:
block|{
name|struct
name|ar_evt_tx_comp
modifier|*
name|tx
init|=
operator|(
expr|struct
name|ar_evt_tx_comp
operator|*
operator|)
operator|&
name|hdr
index|[
literal|1
index|]
decl_stmt|;
name|struct
name|ieee80211_node
modifier|*
name|ni
decl_stmt|;
name|ni
operator|=
name|ieee80211_find_node
argument_list|(
operator|&
name|ic
operator|->
name|ic_sta
argument_list|,
name|tx
operator|->
name|macaddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ni
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: txcomp on unknown node (%s)\n"
argument_list|,
name|__func__
argument_list|,
name|ether_sprintf
argument_list|(
name|tx
operator|->
name|macaddr
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|OTUS_DPRINTF
argument_list|(
name|sc
argument_list|,
name|OTUS_DEBUG_TXCOMP
argument_list|,
literal|"tx completed %s status=%d phy=0x%x\n"
argument_list|,
name|ether_sprintf
argument_list|(
name|tx
operator|->
name|macaddr
argument_list|)
argument_list|,
name|le16toh
argument_list|(
name|tx
operator|->
name|status
argument_list|)
argument_list|,
name|le32toh
argument_list|(
name|tx
operator|->
name|phy
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|le16toh
argument_list|(
name|tx
operator|->
name|status
argument_list|)
condition|)
block|{
case|case
name|AR_TX_STATUS_COMP
case|:
if|#
directive|if
literal|0
block|ackfailcnt = 0; 			ieee80211_ratectl_tx_complete(ni->ni_vap, ni, 			    IEEE80211_RATECTL_TX_SUCCESS,&ackfailcnt, NULL);
endif|#
directive|endif
comment|/* 			 * We don't get the above; only error notifications. 			 * Sigh.  So, don't worry about this. 			 */
break|break;
case|case
name|AR_TX_STATUS_RETRY_COMP
case|:
name|OTUS_NODE
argument_list|(
name|ni
argument_list|)
operator|->
name|tx_retries
operator|++
expr_stmt|;
break|break;
case|case
name|AR_TX_STATUS_FAILED
case|:
name|OTUS_NODE
argument_list|(
name|ni
argument_list|)
operator|->
name|tx_err
operator|++
expr_stmt|;
break|break;
block|}
name|ieee80211_free_node
argument_list|(
name|ni
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|AR_EVT_TBTT
case|:
break|break;
case|case
name|AR_EVT_DO_BB_RESET
case|:
comment|/* 		 * This is "tell driver to reset baseband" from ar9170-fw. 		 * 		 * I'm not sure what we should do here, so I'm going to 		 * fall through; it gets generated when RTSRetryCnt internally 		 * reaches '5' - I guess the firmware authors thought that 		 * meant that the BB may have gone deaf or something. 		 */
default|default:
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: received notification code=0x%02x len=%d\n"
argument_list|,
name|__func__
argument_list|,
name|hdr
operator|->
name|code
argument_list|,
name|hdr
operator|->
name|len
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|otus_sub_rxeof
parameter_list|(
name|struct
name|otus_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
modifier|*
name|buf
parameter_list|,
name|int
name|len
parameter_list|,
name|struct
name|mbufq
modifier|*
name|rxq
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
name|struct
name|ieee80211_rx_stats
name|rxs
decl_stmt|;
if|#
directive|if
literal|0
block|struct ieee80211_node *ni;
endif|#
directive|endif
name|struct
name|ar_rx_tail
modifier|*
name|tail
decl_stmt|;
name|struct
name|ieee80211_frame
modifier|*
name|wh
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|uint8_t
modifier|*
name|plcp
decl_stmt|;
comment|//	int s;
name|int
name|mlen
decl_stmt|;
if|if
condition|(
name|__predict_false
argument_list|(
name|len
operator|<
name|AR_PLCP_HDR_LEN
argument_list|)
condition|)
block|{
name|OTUS_DPRINTF
argument_list|(
name|sc
argument_list|,
name|OTUS_DEBUG_RXDONE
argument_list|,
literal|"sub-xfer too short %d\n"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return;
block|}
name|plcp
operator|=
name|buf
expr_stmt|;
comment|/* All bits in the PLCP header are set to 1 for non-MPDU. */
if|if
condition|(
name|memcmp
argument_list|(
name|plcp
argument_list|,
name|AR_PLCP_HDR_INTR
argument_list|,
name|AR_PLCP_HDR_LEN
argument_list|)
operator|==
literal|0
condition|)
block|{
name|otus_cmd_rxeof
argument_list|(
name|sc
argument_list|,
name|plcp
operator|+
name|AR_PLCP_HDR_LEN
argument_list|,
name|len
operator|-
name|AR_PLCP_HDR_LEN
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Received MPDU. */
if|if
condition|(
name|__predict_false
argument_list|(
name|len
operator|<
name|AR_PLCP_HDR_LEN
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|tail
argument_list|)
argument_list|)
condition|)
block|{
name|OTUS_DPRINTF
argument_list|(
name|sc
argument_list|,
name|OTUS_DEBUG_RXDONE
argument_list|,
literal|"MPDU too short %d\n"
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|counter_u64_add
argument_list|(
name|ic
operator|->
name|ic_ierrors
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return;
block|}
name|tail
operator|=
operator|(
expr|struct
name|ar_rx_tail
operator|*
operator|)
operator|(
name|plcp
operator|+
name|len
operator|-
sizeof|sizeof
argument_list|(
operator|*
name|tail
argument_list|)
operator|)
expr_stmt|;
comment|/* Discard error frames; don't discard BAD_RA (eg monitor mode); let net80211 do that */
if|if
condition|(
name|__predict_false
argument_list|(
operator|(
name|tail
operator|->
name|error
operator|&
operator|~
name|AR_RX_ERROR_BAD_RA
operator|)
operator|!=
literal|0
argument_list|)
condition|)
block|{
name|OTUS_DPRINTF
argument_list|(
name|sc
argument_list|,
name|OTUS_DEBUG_RXDONE
argument_list|,
literal|"error frame 0x%02x\n"
argument_list|,
name|tail
operator|->
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
name|tail
operator|->
name|error
operator|&
name|AR_RX_ERROR_FCS
condition|)
block|{
name|OTUS_DPRINTF
argument_list|(
name|sc
argument_list|,
name|OTUS_DEBUG_RXDONE
argument_list|,
literal|"bad FCS\n"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|tail
operator|->
name|error
operator|&
name|AR_RX_ERROR_MMIC
condition|)
block|{
comment|/* Report Michael MIC failures to net80211. */
if|#
directive|if
literal|0
block|ieee80211_notify_michael_failure(ni->ni_vap, wh, keyidx);
endif|#
directive|endif
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: MIC failure\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
block|}
name|counter_u64_add
argument_list|(
name|ic
operator|->
name|ic_ierrors
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Compute MPDU's length. */
name|mlen
operator|=
name|len
operator|-
name|AR_PLCP_HDR_LEN
operator|-
sizeof|sizeof
argument_list|(
operator|*
name|tail
argument_list|)
expr_stmt|;
comment|/* Make sure there's room for an 802.11 header + FCS. */
if|if
condition|(
name|__predict_false
argument_list|(
name|mlen
operator|<
name|IEEE80211_MIN_LEN
argument_list|)
condition|)
block|{
name|counter_u64_add
argument_list|(
name|ic
operator|->
name|ic_ierrors
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return;
block|}
name|mlen
operator|-=
name|IEEE80211_CRC_LEN
expr_stmt|;
comment|/* strip 802.11 FCS */
name|wh
operator|=
operator|(
expr|struct
name|ieee80211_frame
operator|*
operator|)
operator|(
name|plcp
operator|+
name|AR_PLCP_HDR_LEN
operator|)
expr_stmt|;
comment|/* 	 * TODO: I see> 2KiB buffers in this path; is it A-MSDU or something? 	 */
name|m
operator|=
name|m_get2
argument_list|(
name|mlen
argument_list|,
name|M_NOWAIT
argument_list|,
name|MT_DATA
argument_list|,
name|M_PKTHDR
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: failed m_get2() (mlen=%d)\n"
argument_list|,
name|__func__
argument_list|,
name|mlen
argument_list|)
expr_stmt|;
name|counter_u64_add
argument_list|(
name|ic
operator|->
name|ic_ierrors
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Finalize mbuf. */
name|memcpy
argument_list|(
name|mtod
argument_list|(
name|m
argument_list|,
name|uint8_t
operator|*
argument_list|)
argument_list|,
name|wh
argument_list|,
name|mlen
argument_list|)
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|m
operator|->
name|m_len
operator|=
name|mlen
expr_stmt|;
if|#
directive|if
literal|0
block|if (__predict_false(sc->sc_drvbpf != NULL)) { 		struct otus_rx_radiotap_header *tap =&sc->sc_rxtap; 		struct mbuf mb;  		tap->wr_flags = 0; 		tap->wr_chan_freq = htole16(ic->ic_ibss_chan->ic_freq); 		tap->wr_chan_flags = htole16(ic->ic_ibss_chan->ic_flags); 		tap->wr_antsignal = tail->rssi; 		tap->wr_rate = 2;
comment|/* In case it can't be found below. */
block|switch (tail->status& AR_RX_STATUS_MT_MASK) { 		case AR_RX_STATUS_MT_CCK: 			switch (plcp[0]) { 			case  10: tap->wr_rate =   2; break; 			case  20: tap->wr_rate =   4; break; 			case  55: tap->wr_rate =  11; break; 			case 110: tap->wr_rate =  22; break; 			} 			if (tail->status& AR_RX_STATUS_SHPREAMBLE) 				tap->wr_flags |= IEEE80211_RADIOTAP_F_SHORTPRE; 			break; 		case AR_RX_STATUS_MT_OFDM: 			switch (plcp[0]& 0xf) { 			case 0xb: tap->wr_rate =  12; break; 			case 0xf: tap->wr_rate =  18; break; 			case 0xa: tap->wr_rate =  24; break; 			case 0xe: tap->wr_rate =  36; break; 			case 0x9: tap->wr_rate =  48; break; 			case 0xd: tap->wr_rate =  72; break; 			case 0x8: tap->wr_rate =  96; break; 			case 0xc: tap->wr_rate = 108; break; 			} 			break; 		} 		mb.m_data = (caddr_t)tap; 		mb.m_next = m; 		mb.m_nextpkt = NULL; 		mb.m_type = 0; 		mb.m_flags = 0; 		bpf_mtap(sc->sc_drvbpf,&mb, BPF_DIRECTION_IN); 	}
endif|#
directive|endif
comment|/* Add RSSI/NF to this mbuf */
name|bzero
argument_list|(
operator|&
name|rxs
argument_list|,
sizeof|sizeof
argument_list|(
name|rxs
argument_list|)
argument_list|)
expr_stmt|;
name|rxs
operator|.
name|r_flags
operator|=
name|IEEE80211_R_NF
operator||
name|IEEE80211_R_RSSI
expr_stmt|;
name|rxs
operator|.
name|nf
operator|=
name|sc
operator|->
name|sc_nf
index|[
literal|0
index|]
expr_stmt|;
comment|/* XXX chain 0 != combined rssi/nf */
name|rxs
operator|.
name|rssi
operator|=
name|tail
operator|->
name|rssi
expr_stmt|;
comment|/* XXX TODO: add MIMO RSSI/NF as well */
name|ieee80211_add_rx_params
argument_list|(
name|m
argument_list|,
operator|&
name|rxs
argument_list|)
expr_stmt|;
comment|/* XXX make a method */
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|rxq
operator|->
name|mq_head
argument_list|,
name|m
argument_list|,
name|m_stailqpkt
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|OTUS_UNLOCK(sc); 	ni = ieee80211_find_rxnode(ic, wh); 	rxi.rxi_flags = 0; 	rxi.rxi_rssi = tail->rssi; 	rxi.rxi_tstamp = 0;
comment|/* unused */
block|ieee80211_input(ifp, m, ni,&rxi);
comment|/* Node is no longer needed. */
block|ieee80211_release_node(ic, ni); 	OTUS_LOCK(sc);
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|void
name|otus_rxeof
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|,
name|struct
name|otus_data
modifier|*
name|data
parameter_list|,
name|struct
name|mbufq
modifier|*
name|rxq
parameter_list|)
block|{
name|struct
name|otus_softc
modifier|*
name|sc
init|=
name|usbd_xfer_softc
argument_list|(
name|xfer
argument_list|)
decl_stmt|;
name|caddr_t
name|buf
init|=
name|data
operator|->
name|buf
decl_stmt|;
name|struct
name|ar_rx_head
modifier|*
name|head
decl_stmt|;
name|uint16_t
name|hlen
decl_stmt|;
name|int
name|len
decl_stmt|;
name|usbd_xfer_status
argument_list|(
name|xfer
argument_list|,
operator|&
name|len
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
while|while
condition|(
name|len
operator|>=
sizeof|sizeof
argument_list|(
operator|*
name|head
argument_list|)
condition|)
block|{
name|head
operator|=
operator|(
expr|struct
name|ar_rx_head
operator|*
operator|)
name|buf
expr_stmt|;
if|if
condition|(
name|__predict_false
argument_list|(
name|head
operator|->
name|tag
operator|!=
name|htole16
argument_list|(
name|AR_RX_HEAD_TAG
argument_list|)
argument_list|)
condition|)
block|{
name|OTUS_DPRINTF
argument_list|(
name|sc
argument_list|,
name|OTUS_DEBUG_RXDONE
argument_list|,
literal|"tag not valid 0x%x\n"
argument_list|,
name|le16toh
argument_list|(
name|head
operator|->
name|tag
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|hlen
operator|=
name|le16toh
argument_list|(
name|head
operator|->
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|__predict_false
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|head
argument_list|)
operator|+
name|hlen
operator|>
name|len
argument_list|)
condition|)
block|{
name|OTUS_DPRINTF
argument_list|(
name|sc
argument_list|,
name|OTUS_DEBUG_RXDONE
argument_list|,
literal|"xfer too short %d/%d\n"
argument_list|,
name|len
argument_list|,
name|hlen
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* Process sub-xfer. */
name|otus_sub_rxeof
argument_list|(
name|sc
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|head
index|[
literal|1
index|]
argument_list|,
name|hlen
argument_list|,
name|rxq
argument_list|)
expr_stmt|;
comment|/* Next sub-xfer is aligned on a 32-bit boundary. */
name|hlen
operator|=
operator|(
sizeof|sizeof
argument_list|(
operator|*
name|head
argument_list|)
operator|+
name|hlen
operator|+
literal|3
operator|)
operator|&
operator|~
literal|3
expr_stmt|;
name|buf
operator|+=
name|hlen
expr_stmt|;
name|len
operator|-=
name|hlen
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|otus_bulk_rx_callback
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|,
name|usb_error_t
name|error
parameter_list|)
block|{
name|struct
name|otus_softc
modifier|*
name|sc
init|=
name|usbd_xfer_softc
argument_list|(
name|xfer
argument_list|)
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
name|struct
name|ieee80211_frame
modifier|*
name|wh
decl_stmt|;
name|struct
name|ieee80211_node
modifier|*
name|ni
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|struct
name|mbufq
name|scrx
decl_stmt|;
name|struct
name|otus_data
modifier|*
name|data
decl_stmt|;
name|OTUS_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|mbufq_init
argument_list|(
operator|&
name|scrx
argument_list|,
literal|1024
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|device_printf(sc->sc_dev, "%s: called; state=%d; error=%d\n", 	    __func__, 	    USB_GET_STATE(xfer), 	    error);
endif|#
directive|endif
switch|switch
condition|(
name|USB_GET_STATE
argument_list|(
name|xfer
argument_list|)
condition|)
block|{
case|case
name|USB_ST_TRANSFERRED
case|:
name|data
operator|=
name|STAILQ_FIRST
argument_list|(
operator|&
name|sc
operator|->
name|sc_rx_active
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
goto|goto
name|tr_setup
goto|;
name|STAILQ_REMOVE_HEAD
argument_list|(
operator|&
name|sc
operator|->
name|sc_rx_active
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|otus_rxeof
argument_list|(
name|xfer
argument_list|,
name|data
argument_list|,
operator|&
name|scrx
argument_list|)
expr_stmt|;
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|sc
operator|->
name|sc_rx_inactive
argument_list|,
name|data
argument_list|,
name|next
argument_list|)
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|USB_ST_SETUP
case|:
name|tr_setup
label|:
comment|/* 		 * XXX TODO: what if sc_rx isn't empty, but data 		 * is empty?  Then we leak mbufs. 		 */
name|data
operator|=
name|STAILQ_FIRST
argument_list|(
operator|&
name|sc
operator|->
name|sc_rx_inactive
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
block|{
comment|//KASSERT(m == NULL, ("mbuf isn't NULL"));
return|return;
block|}
name|STAILQ_REMOVE_HEAD
argument_list|(
operator|&
name|sc
operator|->
name|sc_rx_inactive
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|sc
operator|->
name|sc_rx_active
argument_list|,
name|data
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|usbd_xfer_set_frame_data
argument_list|(
name|xfer
argument_list|,
literal|0
argument_list|,
name|data
operator|->
name|buf
argument_list|,
name|usbd_xfer_max_len
argument_list|(
name|xfer
argument_list|)
argument_list|)
expr_stmt|;
name|usbd_transfer_submit
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
comment|/* 		 * To avoid LOR we should unlock our private mutex here to call 		 * ieee80211_input() because here is at the end of a USB 		 * callback and safe to unlock. 		 */
name|OTUS_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|m
operator|=
name|mbufq_dequeue
argument_list|(
operator|&
name|scrx
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|wh
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ieee80211_frame
operator|*
argument_list|)
expr_stmt|;
name|ni
operator|=
name|ieee80211_find_rxnode
argument_list|(
name|ic
argument_list|,
operator|(
expr|struct
name|ieee80211_frame_min
operator|*
operator|)
name|wh
argument_list|)
expr_stmt|;
if|if
condition|(
name|ni
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|ni
operator|->
name|ni_flags
operator|&
name|IEEE80211_NODE_HT
condition|)
name|m
operator|->
name|m_flags
operator||=
name|M_AMPDU
expr_stmt|;
operator|(
name|void
operator|)
name|ieee80211_input_mimo
argument_list|(
name|ni
argument_list|,
name|m
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ieee80211_free_node
argument_list|(
name|ni
argument_list|)
expr_stmt|;
block|}
else|else
operator|(
name|void
operator|)
name|ieee80211_input_mimo_all
argument_list|(
name|ic
argument_list|,
name|m
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|IEEE80211_SUPPORT_SUPERG
name|ieee80211_ff_age_all
argument_list|(
name|ic
argument_list|,
literal|100
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|OTUS_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|/* needs it to the inactive queue due to a error. */
name|data
operator|=
name|STAILQ_FIRST
argument_list|(
operator|&
name|sc
operator|->
name|sc_rx_active
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|!=
name|NULL
condition|)
block|{
name|STAILQ_REMOVE_HEAD
argument_list|(
operator|&
name|sc
operator|->
name|sc_rx_active
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|sc
operator|->
name|sc_rx_inactive
argument_list|,
name|data
argument_list|,
name|next
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|error
operator|!=
name|USB_ERR_CANCELLED
condition|)
block|{
name|usbd_xfer_set_stall
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
name|counter_u64_add
argument_list|(
name|ic
operator|->
name|ic_ierrors
argument_list|,
literal|1
argument_list|)
expr_stmt|;
goto|goto
name|tr_setup
goto|;
block|}
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|otus_txeof
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|,
name|struct
name|otus_data
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|otus_softc
modifier|*
name|sc
init|=
name|usbd_xfer_softc
argument_list|(
name|xfer
argument_list|)
decl_stmt|;
name|OTUS_DPRINTF
argument_list|(
name|sc
argument_list|,
name|OTUS_DEBUG_TXDONE
argument_list|,
literal|"%s: called; data=%p\n"
argument_list|,
name|__func__
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|OTUS_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_tx_n_active
operator|==
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: completed but tx_active=0\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|sc
operator|->
name|sc_tx_n_active
operator|--
expr_stmt|;
block|}
if|if
condition|(
name|data
operator|->
name|m
condition|)
block|{
comment|/* XXX status? */
comment|/* XXX we get TX status via the RX path.. */
name|ieee80211_tx_complete
argument_list|(
name|data
operator|->
name|ni
argument_list|,
name|data
operator|->
name|m
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|data
operator|->
name|m
operator|=
name|NULL
expr_stmt|;
name|data
operator|->
name|ni
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|otus_txcmdeof
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|,
name|struct
name|otus_tx_cmd
modifier|*
name|cmd
parameter_list|)
block|{
name|struct
name|otus_softc
modifier|*
name|sc
init|=
name|usbd_xfer_softc
argument_list|(
name|xfer
argument_list|)
decl_stmt|;
name|OTUS_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|OTUS_DPRINTF
argument_list|(
name|sc
argument_list|,
name|OTUS_DEBUG_CMDDONE
argument_list|,
literal|"%s: called; data=%p; odata=%p\n"
argument_list|,
name|__func__
argument_list|,
name|cmd
argument_list|,
name|cmd
operator|->
name|odata
argument_list|)
expr_stmt|;
comment|/* 	 * Non-response commands still need wakeup so the caller 	 * knows it was submitted and completed OK; response commands should 	 * wait until they're ACKed by the firmware with a response. 	 */
if|if
condition|(
name|cmd
operator|->
name|odata
condition|)
block|{
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|sc
operator|->
name|sc_cmd_waiting
argument_list|,
name|cmd
argument_list|,
name|next_cmd
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wakeup
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
name|otus_free_txcmd
argument_list|(
name|sc
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|otus_bulk_tx_callback
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|,
name|usb_error_t
name|error
parameter_list|)
block|{
name|uint8_t
name|which
init|=
name|OTUS_BULK_TX
decl_stmt|;
name|struct
name|otus_softc
modifier|*
name|sc
init|=
name|usbd_xfer_softc
argument_list|(
name|xfer
argument_list|)
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
name|struct
name|otus_data
modifier|*
name|data
decl_stmt|;
name|OTUS_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|USB_GET_STATE
argument_list|(
name|xfer
argument_list|)
condition|)
block|{
case|case
name|USB_ST_TRANSFERRED
case|:
name|data
operator|=
name|STAILQ_FIRST
argument_list|(
operator|&
name|sc
operator|->
name|sc_tx_active
index|[
name|which
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
goto|goto
name|tr_setup
goto|;
name|OTUS_DPRINTF
argument_list|(
name|sc
argument_list|,
name|OTUS_DEBUG_TXDONE
argument_list|,
literal|"%s: transfer done %p\n"
argument_list|,
name|__func__
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|STAILQ_REMOVE_HEAD
argument_list|(
operator|&
name|sc
operator|->
name|sc_tx_active
index|[
name|which
index|]
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|otus_txeof
argument_list|(
name|xfer
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|otus_freebuf
argument_list|(
name|sc
argument_list|,
name|data
argument_list|)
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|USB_ST_SETUP
case|:
name|tr_setup
label|:
name|data
operator|=
name|STAILQ_FIRST
argument_list|(
operator|&
name|sc
operator|->
name|sc_tx_pending
index|[
name|which
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
block|{
name|OTUS_DPRINTF
argument_list|(
name|sc
argument_list|,
name|OTUS_DEBUG_XMIT
argument_list|,
literal|"%s: empty pending queue sc %p\n"
argument_list|,
name|__func__
argument_list|,
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_tx_n_active
operator|=
literal|0
expr_stmt|;
goto|goto
name|finish
goto|;
block|}
name|STAILQ_REMOVE_HEAD
argument_list|(
operator|&
name|sc
operator|->
name|sc_tx_pending
index|[
name|which
index|]
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|sc
operator|->
name|sc_tx_active
index|[
name|which
index|]
argument_list|,
name|data
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|usbd_xfer_set_frame_data
argument_list|(
name|xfer
argument_list|,
literal|0
argument_list|,
name|data
operator|->
name|buf
argument_list|,
name|data
operator|->
name|buflen
argument_list|)
expr_stmt|;
name|OTUS_DPRINTF
argument_list|(
name|sc
argument_list|,
name|OTUS_DEBUG_XMIT
argument_list|,
literal|"%s: submitting transfer %p\n"
argument_list|,
name|__func__
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|usbd_transfer_submit
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_tx_n_active
operator|++
expr_stmt|;
break|break;
default|default:
name|data
operator|=
name|STAILQ_FIRST
argument_list|(
operator|&
name|sc
operator|->
name|sc_tx_active
index|[
name|which
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|!=
name|NULL
condition|)
block|{
name|STAILQ_REMOVE_HEAD
argument_list|(
operator|&
name|sc
operator|->
name|sc_tx_active
index|[
name|which
index|]
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|otus_txeof
argument_list|(
name|xfer
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|otus_freebuf
argument_list|(
name|sc
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
name|counter_u64_add
argument_list|(
name|ic
operator|->
name|ic_oerrors
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|USB_ERR_CANCELLED
condition|)
block|{
name|usbd_xfer_set_stall
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
goto|goto
name|tr_setup
goto|;
block|}
break|break;
block|}
name|finish
label|:
ifdef|#
directive|ifdef
name|IEEE80211_SUPPORT_SUPERG
comment|/* 	 * If the TX active queue drops below a certain 	 * threshold, ensure we age fast-frames out so they're 	 * transmitted. 	 */
if|if
condition|(
name|sc
operator|->
name|sc_tx_n_active
operator|<
literal|2
condition|)
block|{
comment|/* XXX ew - net80211 should defer this for us! */
name|OTUS_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ieee80211_ff_flush
argument_list|(
name|ic
argument_list|,
name|WME_AC_VO
argument_list|)
expr_stmt|;
name|ieee80211_ff_flush
argument_list|(
name|ic
argument_list|,
name|WME_AC_VI
argument_list|)
expr_stmt|;
name|ieee80211_ff_flush
argument_list|(
name|ic
argument_list|,
name|WME_AC_BE
argument_list|)
expr_stmt|;
name|ieee80211_ff_flush
argument_list|(
name|ic
argument_list|,
name|WME_AC_BK
argument_list|)
expr_stmt|;
name|OTUS_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* Kick TX */
name|otus_tx_start
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|otus_bulk_cmd_callback
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|,
name|usb_error_t
name|error
parameter_list|)
block|{
name|struct
name|otus_softc
modifier|*
name|sc
init|=
name|usbd_xfer_softc
argument_list|(
name|xfer
argument_list|)
decl_stmt|;
if|#
directive|if
literal|0
block|struct ieee80211com *ic =&sc->sc_ic;
endif|#
directive|endif
name|struct
name|otus_tx_cmd
modifier|*
name|cmd
decl_stmt|;
name|OTUS_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|USB_GET_STATE
argument_list|(
name|xfer
argument_list|)
condition|)
block|{
case|case
name|USB_ST_TRANSFERRED
case|:
name|cmd
operator|=
name|STAILQ_FIRST
argument_list|(
operator|&
name|sc
operator|->
name|sc_cmd_active
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd
operator|==
name|NULL
condition|)
goto|goto
name|tr_setup
goto|;
name|OTUS_DPRINTF
argument_list|(
name|sc
argument_list|,
name|OTUS_DEBUG_CMDDONE
argument_list|,
literal|"%s: transfer done %p\n"
argument_list|,
name|__func__
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
name|STAILQ_REMOVE_HEAD
argument_list|(
operator|&
name|sc
operator|->
name|sc_cmd_active
argument_list|,
name|next_cmd
argument_list|)
expr_stmt|;
name|otus_txcmdeof
argument_list|(
name|xfer
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|USB_ST_SETUP
case|:
name|tr_setup
label|:
name|cmd
operator|=
name|STAILQ_FIRST
argument_list|(
operator|&
name|sc
operator|->
name|sc_cmd_pending
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd
operator|==
name|NULL
condition|)
block|{
name|OTUS_DPRINTF
argument_list|(
name|sc
argument_list|,
name|OTUS_DEBUG_CMD
argument_list|,
literal|"%s: empty pending queue sc %p\n"
argument_list|,
name|__func__
argument_list|,
name|sc
argument_list|)
expr_stmt|;
return|return;
block|}
name|STAILQ_REMOVE_HEAD
argument_list|(
operator|&
name|sc
operator|->
name|sc_cmd_pending
argument_list|,
name|next_cmd
argument_list|)
expr_stmt|;
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|sc
operator|->
name|sc_cmd_active
argument_list|,
name|cmd
argument_list|,
name|next_cmd
argument_list|)
expr_stmt|;
name|usbd_xfer_set_frame_data
argument_list|(
name|xfer
argument_list|,
literal|0
argument_list|,
name|cmd
operator|->
name|buf
argument_list|,
name|cmd
operator|->
name|buflen
argument_list|)
expr_stmt|;
name|OTUS_DPRINTF
argument_list|(
name|sc
argument_list|,
name|OTUS_DEBUG_CMD
argument_list|,
literal|"%s: submitting transfer %p; buf=%p, buflen=%d\n"
argument_list|,
name|__func__
argument_list|,
name|cmd
argument_list|,
name|cmd
operator|->
name|buf
argument_list|,
name|cmd
operator|->
name|buflen
argument_list|)
expr_stmt|;
name|usbd_transfer_submit
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
break|break;
default|default:
name|cmd
operator|=
name|STAILQ_FIRST
argument_list|(
operator|&
name|sc
operator|->
name|sc_cmd_active
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd
operator|!=
name|NULL
condition|)
block|{
name|STAILQ_REMOVE_HEAD
argument_list|(
operator|&
name|sc
operator|->
name|sc_cmd_active
argument_list|,
name|next_cmd
argument_list|)
expr_stmt|;
name|otus_txcmdeof
argument_list|(
name|xfer
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|error
operator|!=
name|USB_ERR_CANCELLED
condition|)
block|{
name|usbd_xfer_set_stall
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
goto|goto
name|tr_setup
goto|;
block|}
break|break;
block|}
block|}
end_function

begin_comment
comment|/*  * This isn't used by carl9170; it however may be used by the  * initial bootloader.  */
end_comment

begin_function
specifier|static
name|void
name|otus_bulk_irq_callback
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|,
name|usb_error_t
name|error
parameter_list|)
block|{
name|struct
name|otus_softc
modifier|*
name|sc
init|=
name|usbd_xfer_softc
argument_list|(
name|xfer
argument_list|)
decl_stmt|;
name|int
name|actlen
decl_stmt|;
name|int
name|sumlen
decl_stmt|;
name|usbd_xfer_status
argument_list|(
name|xfer
argument_list|,
operator|&
name|actlen
argument_list|,
operator|&
name|sumlen
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|OTUS_DPRINTF
argument_list|(
name|sc
argument_list|,
name|OTUS_DEBUG_IRQ
argument_list|,
literal|"%s: called; state=%d\n"
argument_list|,
name|__func__
argument_list|,
name|USB_GET_STATE
argument_list|(
name|xfer
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|USB_GET_STATE
argument_list|(
name|xfer
argument_list|)
condition|)
block|{
case|case
name|USB_ST_TRANSFERRED
case|:
comment|/* 		 * Read usb frame data, if any. 		 * "actlen" has the total length for all frames 		 * transferred. 		 */
name|OTUS_DPRINTF
argument_list|(
name|sc
argument_list|,
name|OTUS_DEBUG_IRQ
argument_list|,
literal|"%s: comp; %d bytes\n"
argument_list|,
name|__func__
argument_list|,
name|actlen
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|pc = usbd_xfer_get_frame(xfer, 0); 		otus_dump_usb_rx_page(sc, pc, actlen);
endif|#
directive|endif
comment|/* XXX fallthrough */
case|case
name|USB_ST_SETUP
case|:
comment|/* 		 * Setup xfer frame lengths/count and data 		 */
name|OTUS_DPRINTF
argument_list|(
name|sc
argument_list|,
name|OTUS_DEBUG_IRQ
argument_list|,
literal|"%s: setup\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|usbd_xfer_set_frame_len
argument_list|(
name|xfer
argument_list|,
literal|0
argument_list|,
name|usbd_xfer_max_len
argument_list|(
name|xfer
argument_list|)
argument_list|)
expr_stmt|;
name|usbd_transfer_submit
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|/* Error */
comment|/* 		 * Print error message and clear stall 		 * for example. 		 */
name|OTUS_DPRINTF
argument_list|(
name|sc
argument_list|,
name|OTUS_DEBUG_IRQ
argument_list|,
literal|"%s: ERROR?\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/*  * Map net80211 rate to hw rate for otus MAC/PHY.  */
end_comment

begin_function
specifier|static
name|uint8_t
name|otus_rate_to_hw_rate
parameter_list|(
name|struct
name|otus_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|rate
parameter_list|)
block|{
name|int
name|is_2ghz
decl_stmt|;
name|is_2ghz
operator|=
operator|!
operator|!
operator|(
name|IEEE80211_IS_CHAN_2GHZ
argument_list|(
name|sc
operator|->
name|sc_ic
operator|.
name|ic_curchan
argument_list|)
operator|)
expr_stmt|;
switch|switch
condition|(
name|rate
condition|)
block|{
comment|/* CCK */
case|case
literal|2
case|:
return|return
operator|(
literal|0x0
operator|)
return|;
case|case
literal|4
case|:
return|return
operator|(
literal|0x1
operator|)
return|;
case|case
literal|11
case|:
return|return
operator|(
literal|0x2
operator|)
return|;
case|case
literal|22
case|:
return|return
operator|(
literal|0x3
operator|)
return|;
comment|/* OFDM */
case|case
literal|12
case|:
return|return
operator|(
literal|0xb
operator|)
return|;
case|case
literal|18
case|:
return|return
operator|(
literal|0xf
operator|)
return|;
case|case
literal|24
case|:
return|return
operator|(
literal|0xa
operator|)
return|;
case|case
literal|36
case|:
return|return
operator|(
literal|0xe
operator|)
return|;
case|case
literal|48
case|:
return|return
operator|(
literal|0x9
operator|)
return|;
case|case
literal|72
case|:
return|return
operator|(
literal|0xd
operator|)
return|;
case|case
literal|96
case|:
return|return
operator|(
literal|0x8
operator|)
return|;
case|case
literal|108
case|:
return|return
operator|(
literal|0xc
operator|)
return|;
default|default:
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: unknown rate '%d'\n"
argument_list|,
name|__func__
argument_list|,
operator|(
name|int
operator|)
name|rate
argument_list|)
expr_stmt|;
case|case
literal|0
case|:
if|if
condition|(
name|is_2ghz
condition|)
return|return
operator|(
literal|0x0
operator|)
return|;
comment|/* 1MB CCK */
else|else
return|return
operator|(
literal|0xb
operator|)
return|;
comment|/* 6MB OFDM */
comment|/* XXX TODO: HT */
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|otus_hw_rate_is_ofdm
parameter_list|(
name|struct
name|otus_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|hw_rate
parameter_list|)
block|{
switch|switch
condition|(
name|hw_rate
condition|)
block|{
case|case
literal|0x0
case|:
case|case
literal|0x1
case|:
case|case
literal|0x2
case|:
case|case
literal|0x3
case|:
return|return
operator|(
literal|0
operator|)
return|;
default|default:
return|return
operator|(
literal|1
operator|)
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|otus_tx_update_ratectl
parameter_list|(
name|struct
name|otus_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|ieee80211_node
modifier|*
name|ni
parameter_list|)
block|{
name|int
name|tx
decl_stmt|,
name|tx_success
decl_stmt|,
name|tx_retry
decl_stmt|;
name|tx
operator|=
name|OTUS_NODE
argument_list|(
name|ni
argument_list|)
operator|->
name|tx_done
expr_stmt|;
name|tx_success
operator|=
name|OTUS_NODE
argument_list|(
name|ni
argument_list|)
operator|->
name|tx_done
operator|-
name|OTUS_NODE
argument_list|(
name|ni
argument_list|)
operator|->
name|tx_err
expr_stmt|;
name|tx_retry
operator|=
name|OTUS_NODE
argument_list|(
name|ni
argument_list|)
operator|->
name|tx_retries
expr_stmt|;
name|ieee80211_ratectl_tx_update
argument_list|(
name|ni
operator|->
name|ni_vap
argument_list|,
name|ni
argument_list|,
operator|&
name|tx
argument_list|,
operator|&
name|tx_success
argument_list|,
operator|&
name|tx_retry
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * XXX TODO: support tx bpf parameters for configuration!  *  * Relevant pieces:  *  * ac = params->ibp_pri& 3;  * rate = params->ibp_rate0;  * params->ibp_flags& IEEE80211_BPF_NOACK  * params->ibp_flags& IEEE80211_BPF_RTS  * params->ibp_flags& IEEE80211_BPF_CTS  * tx->rts_ntries = params->ibp_try1;  * tx->data_ntries = params->ibp_try0;  */
end_comment

begin_function
specifier|static
name|int
name|otus_tx
parameter_list|(
name|struct
name|otus_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|ieee80211_node
modifier|*
name|ni
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|struct
name|otus_data
modifier|*
name|data
parameter_list|,
specifier|const
name|struct
name|ieee80211_bpf_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
name|struct
name|ieee80211vap
modifier|*
name|vap
init|=
name|ni
operator|->
name|ni_vap
decl_stmt|;
name|struct
name|ieee80211_frame
modifier|*
name|wh
decl_stmt|;
name|struct
name|ieee80211_key
modifier|*
name|k
decl_stmt|;
name|struct
name|ar_tx_head
modifier|*
name|head
decl_stmt|;
name|uint32_t
name|phyctl
decl_stmt|;
name|uint16_t
name|macctl
decl_stmt|,
name|qos
decl_stmt|;
name|uint8_t
name|qid
decl_stmt|,
name|rate
decl_stmt|;
name|int
name|hasqos
decl_stmt|,
name|xferlen
decl_stmt|;
name|wh
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ieee80211_frame
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator|&
name|IEEE80211_FC1_PROTECTED
condition|)
block|{
name|k
operator|=
name|ieee80211_crypto_encap
argument_list|(
name|ni
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|k
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: m=%p: ieee80211_crypto_encap returns NULL\n"
argument_list|,
name|__func__
argument_list|,
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOBUFS
operator|)
return|;
block|}
name|wh
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ieee80211_frame
operator|*
argument_list|)
expr_stmt|;
block|}
comment|/* Calculate transfer length; ensure data buffer is large enough */
name|xferlen
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|head
argument_list|)
operator|+
name|m
operator|->
name|m_pkthdr
operator|.
name|len
expr_stmt|;
if|if
condition|(
name|xferlen
operator|>
name|OTUS_TXBUFSZ
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: 802.11 TX frame is %d bytes, max %d bytes\n"
argument_list|,
name|__func__
argument_list|,
name|xferlen
argument_list|,
name|OTUS_TXBUFSZ
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOBUFS
operator|)
return|;
block|}
name|hasqos
operator|=
operator|!
operator|!
name|IEEE80211_QOS_HAS_SEQ
argument_list|(
name|wh
argument_list|)
expr_stmt|;
if|if
condition|(
name|hasqos
condition|)
block|{
name|uint8_t
name|tid
decl_stmt|;
name|qos
operator|=
operator|(
operator|(
specifier|const
expr|struct
name|ieee80211_qosframe
operator|*
operator|)
name|wh
operator|)
operator|->
name|i_qos
index|[
literal|0
index|]
expr_stmt|;
name|tid
operator|=
name|qos
operator|&
name|IEEE80211_QOS_TID
expr_stmt|;
name|qid
operator|=
name|TID_TO_WME_AC
argument_list|(
name|tid
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|qos
operator|=
literal|0
expr_stmt|;
name|qid
operator|=
name|WME_AC_BE
expr_stmt|;
block|}
comment|/* Pickup a rate index. */
if|if
condition|(
name|params
operator|!=
name|NULL
condition|)
block|{
name|rate
operator|=
name|otus_rate_to_hw_rate
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|ibp_rate0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|IEEE80211_IS_MULTICAST
argument_list|(
name|wh
operator|->
name|i_addr1
argument_list|)
operator|||
operator|(
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator|&
name|IEEE80211_FC0_TYPE_MASK
operator|)
operator|!=
name|IEEE80211_FC0_TYPE_DATA
condition|)
block|{
comment|/* Get lowest rate */
name|rate
operator|=
name|otus_rate_to_hw_rate
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|m
operator|->
name|m_flags
operator|&
name|M_EAPOL
condition|)
block|{
comment|/* Get lowest rate */
name|rate
operator|=
name|otus_rate_to_hw_rate
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|(
name|void
operator|)
name|ieee80211_ratectl_rate
argument_list|(
name|ni
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rate
operator|=
name|otus_rate_to_hw_rate
argument_list|(
name|sc
argument_list|,
name|ni
operator|->
name|ni_txrate
argument_list|)
expr_stmt|;
block|}
name|phyctl
operator|=
literal|0
expr_stmt|;
name|macctl
operator|=
name|AR_TX_MAC_BACKOFF
operator||
name|AR_TX_MAC_HW_DUR
operator||
name|AR_TX_MAC_QID
argument_list|(
name|qid
argument_list|)
expr_stmt|;
comment|/* 	 * XXX TODO: params for NOACK, ACK, RTS, CTS, etc 	 */
if|if
condition|(
name|IEEE80211_IS_MULTICAST
argument_list|(
name|wh
operator|->
name|i_addr1
argument_list|)
operator|||
operator|(
name|hasqos
operator|&&
operator|(
operator|(
name|qos
operator|&
name|IEEE80211_QOS_ACKPOLICY
operator|)
operator|==
name|IEEE80211_QOS_ACKPOLICY_NOACK
operator|)
operator|)
condition|)
name|macctl
operator||=
name|AR_TX_MAC_NOACK
expr_stmt|;
if|if
condition|(
operator|!
name|IEEE80211_IS_MULTICAST
argument_list|(
name|wh
operator|->
name|i_addr1
argument_list|)
condition|)
block|{
if|if
condition|(
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|+
name|IEEE80211_CRC_LEN
operator|>=
name|vap
operator|->
name|iv_rtsthreshold
condition|)
name|macctl
operator||=
name|AR_TX_MAC_RTS
expr_stmt|;
elseif|else
if|if
condition|(
name|ic
operator|->
name|ic_flags
operator|&
name|IEEE80211_F_USEPROT
condition|)
block|{
if|if
condition|(
name|ic
operator|->
name|ic_protmode
operator|==
name|IEEE80211_PROT_CTSONLY
condition|)
name|macctl
operator||=
name|AR_TX_MAC_CTS
expr_stmt|;
elseif|else
if|if
condition|(
name|ic
operator|->
name|ic_protmode
operator|==
name|IEEE80211_PROT_RTSCTS
condition|)
name|macctl
operator||=
name|AR_TX_MAC_RTS
expr_stmt|;
block|}
block|}
name|phyctl
operator||=
name|AR_TX_PHY_MCS
argument_list|(
name|rate
argument_list|)
expr_stmt|;
if|if
condition|(
name|otus_hw_rate_is_ofdm
argument_list|(
name|sc
argument_list|,
name|rate
argument_list|)
condition|)
block|{
name|phyctl
operator||=
name|AR_TX_PHY_MT_OFDM
expr_stmt|;
comment|/* Always use all tx antennas for now, just to be safe */
name|phyctl
operator||=
name|AR_TX_PHY_ANTMSK
argument_list|(
name|sc
operator|->
name|txmask
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* CCK */
name|phyctl
operator||=
name|AR_TX_PHY_MT_CCK
expr_stmt|;
name|phyctl
operator||=
name|AR_TX_PHY_ANTMSK
argument_list|(
name|sc
operator|->
name|txmask
argument_list|)
expr_stmt|;
block|}
comment|/* Update net80211 with the current counters */
name|otus_tx_update_ratectl
argument_list|(
name|sc
argument_list|,
name|ni
argument_list|)
expr_stmt|;
comment|/* Update rate control stats for frames that are ACK'ed. */
if|if
condition|(
operator|!
operator|(
name|macctl
operator|&
name|AR_TX_MAC_NOACK
operator|)
condition|)
name|OTUS_NODE
argument_list|(
name|ni
argument_list|)
operator|->
name|tx_done
operator|++
expr_stmt|;
comment|/* Fill Tx descriptor. */
name|head
operator|=
operator|(
expr|struct
name|ar_tx_head
operator|*
operator|)
name|data
operator|->
name|buf
expr_stmt|;
name|head
operator|->
name|len
operator|=
name|htole16
argument_list|(
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|+
name|IEEE80211_CRC_LEN
argument_list|)
expr_stmt|;
name|head
operator|->
name|macctl
operator|=
name|htole16
argument_list|(
name|macctl
argument_list|)
expr_stmt|;
name|head
operator|->
name|phyctl
operator|=
name|htole32
argument_list|(
name|phyctl
argument_list|)
expr_stmt|;
name|m_copydata
argument_list|(
name|m
argument_list|,
literal|0
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|head
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|data
operator|->
name|buflen
operator|=
name|xferlen
expr_stmt|;
name|data
operator|->
name|ni
operator|=
name|ni
expr_stmt|;
name|data
operator|->
name|m
operator|=
name|m
expr_stmt|;
name|OTUS_DPRINTF
argument_list|(
name|sc
argument_list|,
name|OTUS_DEBUG_XMIT
argument_list|,
literal|"%s: tx: m=%p; data=%p; len=%d mac=0x%04x phy=0x%08x rate=0x%02x, ni_txrate=%d\n"
argument_list|,
name|__func__
argument_list|,
name|m
argument_list|,
name|data
argument_list|,
name|le16toh
argument_list|(
name|head
operator|->
name|len
argument_list|)
argument_list|,
name|macctl
argument_list|,
name|phyctl
argument_list|,
operator|(
name|int
operator|)
name|rate
argument_list|,
operator|(
name|int
operator|)
name|ni
operator|->
name|ni_txrate
argument_list|)
expr_stmt|;
comment|/* Submit transfer */
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|sc
operator|->
name|sc_tx_pending
index|[
name|OTUS_BULK_TX
index|]
argument_list|,
name|data
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|usbd_transfer_start
argument_list|(
name|sc
operator|->
name|sc_xfer
index|[
name|OTUS_BULK_TX
index|]
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|otus_set_multi
parameter_list|(
name|struct
name|otus_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|lo
decl_stmt|,
name|hi
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
name|int
name|r
decl_stmt|;
if|if
condition|(
name|ic
operator|->
name|ic_allmulti
operator|>
literal|0
operator|||
name|ic
operator|->
name|ic_promisc
operator|>
literal|0
operator|||
name|ic
operator|->
name|ic_opmode
operator|==
name|IEEE80211_M_MONITOR
condition|)
block|{
name|lo
operator|=
literal|0xffffffff
expr_stmt|;
name|hi
operator|=
literal|0xffffffff
expr_stmt|;
block|}
else|else
block|{
name|struct
name|ieee80211vap
modifier|*
name|vap
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|struct
name|ifmultiaddr
modifier|*
name|ifma
decl_stmt|;
name|lo
operator|=
name|hi
operator|=
literal|0
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|vap
argument_list|,
argument|&ic->ic_vaps
argument_list|,
argument|iv_next
argument_list|)
block|{
name|ifp
operator|=
name|vap
operator|->
name|iv_ifp
expr_stmt|;
name|if_maddr_rlock
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|ifma
argument_list|,
argument|&ifp->if_multiaddrs
argument_list|,
argument|ifma_link
argument_list|)
block|{
name|caddr_t
name|dl
decl_stmt|;
name|uint32_t
name|val
decl_stmt|;
name|dl
operator|=
name|LLADDR
argument_list|(
operator|(
expr|struct
name|sockaddr_dl
operator|*
operator|)
name|ifma
operator|->
name|ifma_addr
argument_list|)
expr_stmt|;
name|val
operator|=
name|LE_READ_4
argument_list|(
name|dl
operator|+
literal|4
argument_list|)
expr_stmt|;
comment|/* Get address byte 5 */
name|val
operator|=
name|val
operator|&
literal|0x0000ff00
expr_stmt|;
name|val
operator|=
name|val
operator|>>
literal|8
expr_stmt|;
comment|/* As per below, shift it>> 2 to get only 6 bits */
name|val
operator|=
name|val
operator|>>
literal|2
expr_stmt|;
if|if
condition|(
name|val
operator|<
literal|32
condition|)
name|lo
operator||=
literal|1
operator|<<
name|val
expr_stmt|;
else|else
name|hi
operator||=
literal|1
operator|<<
operator|(
name|val
operator|-
literal|32
operator|)
expr_stmt|;
block|}
name|if_maddr_runlock
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
block|}
block|}
if|#
directive|if
literal|0
comment|/* XXX openbsd code */
block|while (enm != NULL) { 		bit = enm->enm_addrlo[5]>> 2; 		if (bit< 32) 			lo |= 1<< bit; 		else 			hi |= 1<< (bit - 32); 		ETHER_NEXT_MULTI(step, enm); 	}
endif|#
directive|endif
name|hi
operator||=
literal|1U
operator|<<
literal|31
expr_stmt|;
comment|/* Make sure the broadcast bit is set. */
name|OTUS_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_MAC_REG_GROUP_HASH_TBL_L
argument_list|,
name|lo
argument_list|)
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_MAC_REG_GROUP_HASH_TBL_H
argument_list|,
name|hi
argument_list|)
expr_stmt|;
name|r
operator|=
name|otus_write_barrier
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|OTUS_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|r
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|otus_updateedca
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|)
block|{
name|struct
name|otus_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_softc
decl_stmt|;
name|OTUS_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* 	 * XXX TODO: take temporary copy of EDCA information 	 * when scheduling this so we have a more time-correct view 	 * of things. 	 * XXX TODO: this can be done on the net80211 level 	 */
name|otus_updateedca_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|OTUS_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|otus_updateedca_locked
parameter_list|(
name|struct
name|otus_softc
modifier|*
name|sc
parameter_list|)
block|{
define|#
directive|define
name|EXP2
parameter_list|(
name|val
parameter_list|)
value|((1<< (val)) - 1)
define|#
directive|define
name|AIFS
parameter_list|(
name|val
parameter_list|)
value|((val) * 9 + 10)
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
specifier|const
name|struct
name|wmeParams
modifier|*
name|edca
decl_stmt|;
name|OTUS_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|edca
operator|=
name|ic
operator|->
name|ic_wme
operator|.
name|wme_chanParams
operator|.
name|cap_wmeParams
expr_stmt|;
comment|/* Set CWmin/CWmax values. */
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_MAC_REG_AC0_CW
argument_list|,
name|EXP2
argument_list|(
name|edca
index|[
name|WME_AC_BE
index|]
operator|.
name|wmep_logcwmax
argument_list|)
operator|<<
literal|16
operator||
name|EXP2
argument_list|(
name|edca
index|[
name|WME_AC_BE
index|]
operator|.
name|wmep_logcwmin
argument_list|)
argument_list|)
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_MAC_REG_AC1_CW
argument_list|,
name|EXP2
argument_list|(
name|edca
index|[
name|WME_AC_BK
index|]
operator|.
name|wmep_logcwmax
argument_list|)
operator|<<
literal|16
operator||
name|EXP2
argument_list|(
name|edca
index|[
name|WME_AC_BK
index|]
operator|.
name|wmep_logcwmin
argument_list|)
argument_list|)
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_MAC_REG_AC2_CW
argument_list|,
name|EXP2
argument_list|(
name|edca
index|[
name|WME_AC_VI
index|]
operator|.
name|wmep_logcwmax
argument_list|)
operator|<<
literal|16
operator||
name|EXP2
argument_list|(
name|edca
index|[
name|WME_AC_VI
index|]
operator|.
name|wmep_logcwmin
argument_list|)
argument_list|)
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_MAC_REG_AC3_CW
argument_list|,
name|EXP2
argument_list|(
name|edca
index|[
name|WME_AC_VO
index|]
operator|.
name|wmep_logcwmax
argument_list|)
operator|<<
literal|16
operator||
name|EXP2
argument_list|(
name|edca
index|[
name|WME_AC_VO
index|]
operator|.
name|wmep_logcwmin
argument_list|)
argument_list|)
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_MAC_REG_AC4_CW
argument_list|,
comment|/* Special TXQ. */
name|EXP2
argument_list|(
name|edca
index|[
name|WME_AC_VO
index|]
operator|.
name|wmep_logcwmax
argument_list|)
operator|<<
literal|16
operator||
name|EXP2
argument_list|(
name|edca
index|[
name|WME_AC_VO
index|]
operator|.
name|wmep_logcwmin
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Set AIFSN values. */
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_MAC_REG_AC1_AC0_AIFS
argument_list|,
name|AIFS
argument_list|(
name|edca
index|[
name|WME_AC_VI
index|]
operator|.
name|wmep_aifsn
argument_list|)
operator|<<
literal|24
operator||
name|AIFS
argument_list|(
name|edca
index|[
name|WME_AC_BK
index|]
operator|.
name|wmep_aifsn
argument_list|)
operator|<<
literal|12
operator||
name|AIFS
argument_list|(
name|edca
index|[
name|WME_AC_BE
index|]
operator|.
name|wmep_aifsn
argument_list|)
argument_list|)
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_MAC_REG_AC3_AC2_AIFS
argument_list|,
name|AIFS
argument_list|(
name|edca
index|[
name|WME_AC_VO
index|]
operator|.
name|wmep_aifsn
argument_list|)
operator|<<
literal|16
operator||
comment|/* Special TXQ. */
name|AIFS
argument_list|(
name|edca
index|[
name|WME_AC_VO
index|]
operator|.
name|wmep_aifsn
argument_list|)
operator|<<
literal|4
operator||
name|AIFS
argument_list|(
name|edca
index|[
name|WME_AC_VI
index|]
operator|.
name|wmep_aifsn
argument_list|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
comment|/* Set TXOP limit. */
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_MAC_REG_AC1_AC0_TXOP
argument_list|,
name|edca
index|[
name|WME_AC_BK
index|]
operator|.
name|wmep_txopLimit
operator|<<
literal|16
operator||
name|edca
index|[
name|WME_AC_BE
index|]
operator|.
name|wmep_txopLimit
argument_list|)
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_MAC_REG_AC3_AC2_TXOP
argument_list|,
name|edca
index|[
name|WME_AC_VO
index|]
operator|.
name|wmep_txopLimit
operator|<<
literal|16
operator||
name|edca
index|[
name|WME_AC_VI
index|]
operator|.
name|wmep_txopLimit
argument_list|)
expr_stmt|;
comment|/* XXX ACK policy? */
operator|(
name|void
operator|)
name|otus_write_barrier
argument_list|(
name|sc
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|AIFS
undef|#
directive|undef
name|EXP2
block|}
end_function

begin_function
specifier|static
name|void
name|otus_updateslot
parameter_list|(
name|struct
name|otus_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
name|uint32_t
name|slottime
decl_stmt|;
name|OTUS_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|slottime
operator|=
name|IEEE80211_GET_SLOTTIME
argument_list|(
name|ic
argument_list|)
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_MAC_REG_SLOT_TIME
argument_list|,
name|slottime
operator|<<
literal|10
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|otus_write_barrier
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|otus_init_mac
parameter_list|(
name|struct
name|otus_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
name|OTUS_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_MAC_REG_ACK_EXTENSION
argument_list|,
literal|0x40
argument_list|)
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_MAC_REG_RETRY_MAX
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_MAC_REG_SNIFFER
argument_list|,
literal|0x2000000
argument_list|)
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_MAC_REG_RX_THRESHOLD
argument_list|,
literal|0xc1f80
argument_list|)
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_MAC_REG_RX_PE_DELAY
argument_list|,
literal|0x70
argument_list|)
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_MAC_REG_EIFS_AND_SIFS
argument_list|,
literal|0xa144000
argument_list|)
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_MAC_REG_SLOT_TIME
argument_list|,
literal|9
operator|<<
literal|10
argument_list|)
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_MAC_REG_TID_CFACK_CFEND_RATE
argument_list|,
literal|0x19000000
argument_list|)
expr_stmt|;
comment|/* NAV protects ACK only (in TXOP). */
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_MAC_REG_TXOP_DURATION
argument_list|,
literal|0x201
argument_list|)
expr_stmt|;
comment|/* Set beacon Tx power to 0x7. */
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_MAC_REG_BCN_HT1
argument_list|,
literal|0x8000170
argument_list|)
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_MAC_REG_BACKOFF_PROTECT
argument_list|,
literal|0x105
argument_list|)
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_MAC_REG_AMPDU_FACTOR
argument_list|,
literal|0x10000a
argument_list|)
expr_stmt|;
comment|/* Filter any control frames, BAR is bit 24. */
comment|//	otus_write(sc, AR_MAC_REG_FRAMETYPE_FILTER, 0x0500ffff);
comment|//	otus_write(sc, AR_MAC_REG_RX_CONTROL, 0x1);
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_MAC_REG_BASIC_RATE
argument_list|,
literal|0x150f
argument_list|)
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_MAC_REG_MANDATORY_RATE
argument_list|,
literal|0x150f
argument_list|)
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_MAC_REG_RTS_CTS_RATE
argument_list|,
literal|0x10b01bb
argument_list|)
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_MAC_REG_ACK_TPC
argument_list|,
literal|0x4003c1e
argument_list|)
expr_stmt|;
comment|/* Enable LED0 and LED1. */
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_GPIO_REG_PORT_TYPE
argument_list|,
literal|0x3
argument_list|)
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_GPIO_REG_PORT_DATA
argument_list|,
literal|0x3
argument_list|)
expr_stmt|;
comment|/* Switch MAC to OTUS interface. */
name|otus_write
argument_list|(
name|sc
argument_list|,
literal|0x1c3600
argument_list|,
literal|0x3
argument_list|)
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_MAC_REG_AMPDU_RX_THRESH
argument_list|,
literal|0xffff
argument_list|)
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_MAC_REG_MISC_680
argument_list|,
literal|0xf00008
argument_list|)
expr_stmt|;
comment|/* Disable Rx timeout (workaround). */
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_MAC_REG_RX_TIMEOUT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Set USB Rx stream mode maximum frame number to 2. */
name|otus_write
argument_list|(
name|sc
argument_list|,
literal|0x1e1110
argument_list|,
literal|0x4
argument_list|)
expr_stmt|;
comment|/* Set USB Rx stream mode timeout to 10us. */
name|otus_write
argument_list|(
name|sc
argument_list|,
literal|0x1e1114
argument_list|,
literal|0x80
argument_list|)
expr_stmt|;
comment|/* Set clock frequency to 88/80MHz. */
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_PWR_REG_CLOCK_SEL
argument_list|,
literal|0x73
argument_list|)
expr_stmt|;
comment|/* Set WLAN DMA interrupt mode: generate intr per packet. */
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_MAC_REG_TXRX_MPI
argument_list|,
literal|0x110011
argument_list|)
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_MAC_REG_FCS_SELECT
argument_list|,
literal|0x4
argument_list|)
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_MAC_REG_TXOP_NOT_ENOUGH_INDICATION
argument_list|,
literal|0x141e0f48
argument_list|)
expr_stmt|;
comment|/* Disable HW decryption for now. */
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_MAC_REG_ENCRYPTION
argument_list|,
literal|0x78
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|otus_write_barrier
argument_list|(
name|sc
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|error
return|;
comment|/* Set default EDCA parameters. */
name|otus_updateedca_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Return default value for PHY register based on current operating mode.  */
end_comment

begin_function
name|uint32_t
name|otus_phy_get_def
parameter_list|(
name|struct
name|otus_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|reg
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nitems
argument_list|(
name|ar5416_phy_regs
argument_list|)
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|AR_PHY
argument_list|(
name|ar5416_phy_regs
index|[
name|i
index|]
argument_list|)
operator|==
name|reg
condition|)
return|return
name|sc
operator|->
name|phy_vals
index|[
name|i
index|]
return|;
return|return
literal|0
return|;
comment|/* Register not found. */
block|}
end_function

begin_comment
comment|/*  * Update PHY's programming based on vendor-specific data stored in EEPROM.  * This is for FEM-type devices only.  */
end_comment

begin_function
name|int
name|otus_set_board_values
parameter_list|(
name|struct
name|otus_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
name|c
parameter_list|)
block|{
specifier|const
name|struct
name|ModalEepHeader
modifier|*
name|eep
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|,
name|offset
decl_stmt|;
if|if
condition|(
name|IEEE80211_IS_CHAN_5GHZ
argument_list|(
name|c
argument_list|)
condition|)
name|eep
operator|=
operator|&
name|sc
operator|->
name|eeprom
operator|.
name|modalHeader
index|[
literal|0
index|]
expr_stmt|;
else|else
name|eep
operator|=
operator|&
name|sc
operator|->
name|eeprom
operator|.
name|modalHeader
index|[
literal|1
index|]
expr_stmt|;
comment|/* Offset of chain 2. */
name|offset
operator|=
literal|2
operator|*
literal|0x1000
expr_stmt|;
name|tmp
operator|=
name|le32toh
argument_list|(
name|eep
operator|->
name|antCtrlCommon
argument_list|)
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_PHY_SWITCH_COM
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|le32toh
argument_list|(
name|eep
operator|->
name|antCtrlChain
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_PHY_SWITCH_CHAIN_0
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|le32toh
argument_list|(
name|eep
operator|->
name|antCtrlChain
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_PHY_SWITCH_CHAIN_0
operator|+
name|offset
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
literal|1
comment|/* sc->sc_sco == AR_SCO_SCN */
condition|)
block|{
name|tmp
operator|=
name|otus_phy_get_def
argument_list|(
name|sc
argument_list|,
name|AR_PHY_SETTLING
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
operator|(
literal|0x7f
operator|<<
literal|7
operator|)
expr_stmt|;
name|tmp
operator||=
operator|(
name|eep
operator|->
name|switchSettling
operator|&
literal|0x7f
operator|)
operator|<<
literal|7
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_PHY_SETTLING
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
name|tmp
operator|=
name|otus_phy_get_def
argument_list|(
name|sc
argument_list|,
name|AR_PHY_DESIRED_SZ
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
literal|0xffff
expr_stmt|;
name|tmp
operator||=
name|eep
operator|->
name|pgaDesiredSize
operator|<<
literal|8
operator||
name|eep
operator|->
name|adcDesiredSize
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_PHY_DESIRED_SZ
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|eep
operator|->
name|txEndToXpaOff
operator|<<
literal|24
operator||
name|eep
operator|->
name|txEndToXpaOff
operator|<<
literal|16
operator||
name|eep
operator|->
name|txFrameToXpaOn
operator|<<
literal|8
operator||
name|eep
operator|->
name|txFrameToXpaOn
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_PHY_RF_CTL4
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|otus_phy_get_def
argument_list|(
name|sc
argument_list|,
name|AR_PHY_RF_CTL3
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
operator|(
literal|0xff
operator|<<
literal|16
operator|)
expr_stmt|;
name|tmp
operator||=
name|eep
operator|->
name|txEndToRxOn
operator|<<
literal|16
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_PHY_RF_CTL3
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|otus_phy_get_def
argument_list|(
name|sc
argument_list|,
name|AR_PHY_CCA
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
operator|(
literal|0x7f
operator|<<
literal|12
operator|)
expr_stmt|;
name|tmp
operator||=
operator|(
name|eep
operator|->
name|thresh62
operator|&
literal|0x7f
operator|)
operator|<<
literal|12
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_PHY_CCA
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|otus_phy_get_def
argument_list|(
name|sc
argument_list|,
name|AR_PHY_RXGAIN
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
operator|(
literal|0x3f
operator|<<
literal|12
operator|)
expr_stmt|;
name|tmp
operator||=
operator|(
name|eep
operator|->
name|txRxAttenCh
index|[
literal|0
index|]
operator|&
literal|0x3f
operator|)
operator|<<
literal|12
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_PHY_RXGAIN
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|otus_phy_get_def
argument_list|(
name|sc
argument_list|,
name|AR_PHY_RXGAIN
operator|+
name|offset
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
operator|(
literal|0x3f
operator|<<
literal|12
operator|)
expr_stmt|;
name|tmp
operator||=
operator|(
name|eep
operator|->
name|txRxAttenCh
index|[
literal|1
index|]
operator|&
literal|0x3f
operator|)
operator|<<
literal|12
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_PHY_RXGAIN
operator|+
name|offset
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|otus_phy_get_def
argument_list|(
name|sc
argument_list|,
name|AR_PHY_GAIN_2GHZ
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
operator|(
literal|0x3f
operator|<<
literal|18
operator|)
expr_stmt|;
name|tmp
operator||=
operator|(
name|eep
operator|->
name|rxTxMarginCh
index|[
literal|0
index|]
operator|&
literal|0x3f
operator|)
operator|<<
literal|18
expr_stmt|;
if|if
condition|(
name|IEEE80211_IS_CHAN_5GHZ
argument_list|(
name|c
argument_list|)
condition|)
block|{
name|tmp
operator|&=
operator|~
operator|(
literal|0xf
operator|<<
literal|10
operator|)
expr_stmt|;
name|tmp
operator||=
operator|(
name|eep
operator|->
name|bswMargin
index|[
literal|0
index|]
operator|&
literal|0xf
operator|)
operator|<<
literal|10
expr_stmt|;
block|}
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_PHY_GAIN_2GHZ
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|otus_phy_get_def
argument_list|(
name|sc
argument_list|,
name|AR_PHY_GAIN_2GHZ
operator|+
name|offset
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
operator|(
literal|0x3f
operator|<<
literal|18
operator|)
expr_stmt|;
name|tmp
operator||=
operator|(
name|eep
operator|->
name|rxTxMarginCh
index|[
literal|1
index|]
operator|&
literal|0x3f
operator|)
operator|<<
literal|18
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_PHY_GAIN_2GHZ
operator|+
name|offset
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|otus_phy_get_def
argument_list|(
name|sc
argument_list|,
name|AR_PHY_TIMING_CTRL4
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
operator|(
literal|0x3f
operator|<<
literal|5
operator||
literal|0x1f
operator|)
expr_stmt|;
name|tmp
operator||=
operator|(
name|eep
operator|->
name|iqCalICh
index|[
literal|0
index|]
operator|&
literal|0x3f
operator|)
operator|<<
literal|5
operator||
operator|(
name|eep
operator|->
name|iqCalQCh
index|[
literal|0
index|]
operator|&
literal|0x1f
operator|)
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_PHY_TIMING_CTRL4
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|otus_phy_get_def
argument_list|(
name|sc
argument_list|,
name|AR_PHY_TIMING_CTRL4
operator|+
name|offset
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
operator|(
literal|0x3f
operator|<<
literal|5
operator||
literal|0x1f
operator|)
expr_stmt|;
name|tmp
operator||=
operator|(
name|eep
operator|->
name|iqCalICh
index|[
literal|1
index|]
operator|&
literal|0x3f
operator|)
operator|<<
literal|5
operator||
operator|(
name|eep
operator|->
name|iqCalQCh
index|[
literal|1
index|]
operator|&
literal|0x1f
operator|)
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_PHY_TIMING_CTRL4
operator|+
name|offset
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|otus_phy_get_def
argument_list|(
name|sc
argument_list|,
name|AR_PHY_TPCRG1
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
operator|(
literal|0xf
operator|<<
literal|16
operator|)
expr_stmt|;
name|tmp
operator||=
operator|(
name|eep
operator|->
name|xpd
operator|&
literal|0xf
operator|)
operator|<<
literal|16
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_PHY_TPCRG1
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
return|return
name|otus_write_barrier
argument_list|(
name|sc
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|otus_program_phy
parameter_list|(
name|struct
name|otus_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
name|c
parameter_list|)
block|{
specifier|const
name|uint32_t
modifier|*
name|vals
decl_stmt|;
name|int
name|error
decl_stmt|,
name|i
decl_stmt|;
comment|/* Select PHY programming based on band and bandwidth. */
if|if
condition|(
name|IEEE80211_IS_CHAN_2GHZ
argument_list|(
name|c
argument_list|)
condition|)
name|vals
operator|=
name|ar5416_phy_vals_2ghz_20mhz
expr_stmt|;
else|else
name|vals
operator|=
name|ar5416_phy_vals_5ghz_20mhz
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nitems
argument_list|(
name|ar5416_phy_regs
argument_list|)
condition|;
name|i
operator|++
control|)
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_PHY
argument_list|(
name|ar5416_phy_regs
index|[
name|i
index|]
argument_list|)
argument_list|,
name|vals
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|sc
operator|->
name|phy_vals
operator|=
name|vals
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|eeprom
operator|.
name|baseEepHeader
operator|.
name|deviceType
operator|==
literal|0x80
condition|)
comment|/* FEM */
if|if
condition|(
operator|(
name|error
operator|=
name|otus_set_board_values
argument_list|(
name|sc
argument_list|,
name|c
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|error
return|;
comment|/* Initial Tx power settings. */
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_PHY_POWER_TX_RATE_MAX
argument_list|,
literal|0x7f
argument_list|)
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_PHY_POWER_TX_RATE1
argument_list|,
literal|0x3f3f3f3f
argument_list|)
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_PHY_POWER_TX_RATE2
argument_list|,
literal|0x3f3f3f3f
argument_list|)
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_PHY_POWER_TX_RATE3
argument_list|,
literal|0x3f3f3f3f
argument_list|)
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_PHY_POWER_TX_RATE4
argument_list|,
literal|0x3f3f3f3f
argument_list|)
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_PHY_POWER_TX_RATE5
argument_list|,
literal|0x3f3f3f3f
argument_list|)
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_PHY_POWER_TX_RATE6
argument_list|,
literal|0x3f3f3f3f
argument_list|)
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_PHY_POWER_TX_RATE7
argument_list|,
literal|0x3f3f3f3f
argument_list|)
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_PHY_POWER_TX_RATE8
argument_list|,
literal|0x3f3f3f3f
argument_list|)
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_PHY_POWER_TX_RATE9
argument_list|,
literal|0x3f3f3f3f
argument_list|)
expr_stmt|;
if|if
condition|(
name|IEEE80211_IS_CHAN_2GHZ
argument_list|(
name|c
argument_list|)
condition|)
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_PWR_REG_PLL_ADDAC
argument_list|,
literal|0x5163
argument_list|)
expr_stmt|;
else|else
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_PWR_REG_PLL_ADDAC
argument_list|,
literal|0x5143
argument_list|)
expr_stmt|;
return|return
name|otus_write_barrier
argument_list|(
name|sc
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|__inline
name|uint8_t
name|otus_reverse_bits
parameter_list|(
name|uint8_t
name|v
parameter_list|)
block|{
name|v
operator|=
operator|(
operator|(
name|v
operator|>>
literal|1
operator|)
operator|&
literal|0x55
operator|)
operator||
operator|(
operator|(
name|v
operator|&
literal|0x55
operator|)
operator|<<
literal|1
operator|)
expr_stmt|;
name|v
operator|=
operator|(
operator|(
name|v
operator|>>
literal|2
operator|)
operator|&
literal|0x33
operator|)
operator||
operator|(
operator|(
name|v
operator|&
literal|0x33
operator|)
operator|<<
literal|2
operator|)
expr_stmt|;
name|v
operator|=
operator|(
operator|(
name|v
operator|>>
literal|4
operator|)
operator|&
literal|0x0f
operator|)
operator||
operator|(
operator|(
name|v
operator|&
literal|0x0f
operator|)
operator|<<
literal|4
operator|)
expr_stmt|;
return|return
name|v
return|;
block|}
end_function

begin_function
name|int
name|otus_set_rf_bank4
parameter_list|(
name|struct
name|otus_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
name|c
parameter_list|)
block|{
name|uint8_t
name|chansel
decl_stmt|,
name|d0
decl_stmt|,
name|d1
decl_stmt|;
name|uint16_t
name|data
decl_stmt|;
name|int
name|error
decl_stmt|;
name|OTUS_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|d0
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|IEEE80211_IS_CHAN_5GHZ
argument_list|(
name|c
argument_list|)
condition|)
block|{
name|chansel
operator|=
operator|(
name|c
operator|->
name|ic_freq
operator|-
literal|4800
operator|)
operator|/
literal|5
expr_stmt|;
if|if
condition|(
name|chansel
operator|&
literal|1
condition|)
name|d0
operator||=
name|AR_BANK4_AMODE_REFSEL
argument_list|(
literal|2
argument_list|)
expr_stmt|;
else|else
name|d0
operator||=
name|AR_BANK4_AMODE_REFSEL
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|d0
operator||=
name|AR_BANK4_AMODE_REFSEL
argument_list|(
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|ic_freq
operator|==
literal|2484
condition|)
block|{
comment|/* CH 14 */
name|d0
operator||=
name|AR_BANK4_BMODE_LF_SYNTH_FREQ
expr_stmt|;
name|chansel
operator|=
literal|10
operator|+
operator|(
name|c
operator|->
name|ic_freq
operator|-
literal|2274
operator|)
operator|/
literal|5
expr_stmt|;
block|}
else|else
name|chansel
operator|=
literal|16
operator|+
operator|(
name|c
operator|->
name|ic_freq
operator|-
literal|2272
operator|)
operator|/
literal|5
expr_stmt|;
name|chansel
operator|<<=
literal|2
expr_stmt|;
block|}
name|d0
operator||=
name|AR_BANK4_ADDR
argument_list|(
literal|1
argument_list|)
operator||
name|AR_BANK4_CHUP
expr_stmt|;
name|d1
operator|=
name|otus_reverse_bits
argument_list|(
name|chansel
argument_list|)
expr_stmt|;
comment|/* Write bits 0-4 of d0 and d1. */
name|data
operator|=
operator|(
name|d1
operator|&
literal|0x1f
operator|)
operator|<<
literal|5
operator||
operator|(
name|d0
operator|&
literal|0x1f
operator|)
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_PHY
argument_list|(
literal|44
argument_list|)
argument_list|,
name|data
argument_list|)
expr_stmt|;
comment|/* Write bits 5-7 of d0 and d1. */
name|data
operator|=
operator|(
name|d1
operator|>>
literal|5
operator|)
operator|<<
literal|5
operator||
operator|(
name|d0
operator|>>
literal|5
operator|)
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_PHY
argument_list|(
literal|58
argument_list|)
argument_list|,
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|otus_write_barrier
argument_list|(
name|sc
argument_list|)
operator|)
operator|==
literal|0
condition|)
name|otus_delay_ms
argument_list|(
name|sc
argument_list|,
literal|10
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_function
name|void
name|otus_get_delta_slope
parameter_list|(
name|uint32_t
name|coeff
parameter_list|,
name|uint32_t
modifier|*
name|exponent
parameter_list|,
name|uint32_t
modifier|*
name|mantissa
parameter_list|)
block|{
define|#
directive|define
name|COEFF_SCALE_SHIFT
value|24
name|uint32_t
name|exp
decl_stmt|,
name|man
decl_stmt|;
comment|/* exponent = 14 - floor(log2(coeff)) */
for|for
control|(
name|exp
operator|=
literal|31
init|;
name|exp
operator|>
literal|0
condition|;
name|exp
operator|--
control|)
if|if
condition|(
name|coeff
operator|&
operator|(
literal|1
operator|<<
name|exp
operator|)
condition|)
break|break;
name|KASSERT
argument_list|(
name|exp
operator|!=
literal|0
argument_list|,
operator|(
literal|"exp"
operator|)
argument_list|)
expr_stmt|;
name|exp
operator|=
literal|14
operator|-
operator|(
name|exp
operator|-
name|COEFF_SCALE_SHIFT
operator|)
expr_stmt|;
comment|/* mantissa = floor(coeff * 2^exponent + 0.5) */
name|man
operator|=
name|coeff
operator|+
operator|(
literal|1
operator|<<
operator|(
name|COEFF_SCALE_SHIFT
operator|-
name|exp
operator|-
literal|1
operator|)
operator|)
expr_stmt|;
operator|*
name|mantissa
operator|=
name|man
operator|>>
operator|(
name|COEFF_SCALE_SHIFT
operator|-
name|exp
operator|)
expr_stmt|;
operator|*
name|exponent
operator|=
name|exp
operator|-
literal|16
expr_stmt|;
undef|#
directive|undef
name|COEFF_SCALE_SHIFT
block|}
end_function

begin_function
specifier|static
name|int
name|otus_set_chan
parameter_list|(
name|struct
name|otus_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
name|c
parameter_list|,
name|int
name|assoc
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
name|struct
name|ar_cmd_frequency
name|cmd
decl_stmt|;
name|struct
name|ar_rsp_frequency
name|rsp
decl_stmt|;
specifier|const
name|uint32_t
modifier|*
name|vals
decl_stmt|;
name|uint32_t
name|coeff
decl_stmt|,
name|exp
decl_stmt|,
name|man
decl_stmt|,
name|tmp
decl_stmt|;
name|uint8_t
name|code
decl_stmt|;
name|int
name|error
decl_stmt|,
name|chan
decl_stmt|,
name|i
decl_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
name|chan
operator|=
name|ieee80211_chan2ieee
argument_list|(
name|ic
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|OTUS_DPRINTF
argument_list|(
name|sc
argument_list|,
name|OTUS_DEBUG_RESET
argument_list|,
literal|"setting channel %d (%dMHz)\n"
argument_list|,
name|chan
argument_list|,
name|c
operator|->
name|ic_freq
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|IEEE80211_IS_CHAN_2GHZ
argument_list|(
name|c
argument_list|)
condition|?
literal|0x105
else|:
literal|0x104
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_MAC_REG_DYNAMIC_SIFS_ACK
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|otus_write_barrier
argument_list|(
name|sc
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|finish
goto|;
comment|/* Disable BB Heavy Clip. */
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_PHY_HEAVY_CLIP_ENABLE
argument_list|,
literal|0x200
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|otus_write_barrier
argument_list|(
name|sc
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|finish
goto|;
comment|/* XXX Is that FREQ_START ? */
name|error
operator|=
name|otus_cmd
argument_list|(
name|sc
argument_list|,
name|AR_CMD_FREQ_STRAT
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|finish
goto|;
comment|/* Reprogram PHY and RF on channel band or bandwidth changes. */
if|if
condition|(
name|sc
operator|->
name|bb_reset
operator|||
name|c
operator|->
name|ic_flags
operator|!=
name|sc
operator|->
name|sc_curchan
operator|->
name|ic_flags
condition|)
block|{
name|OTUS_DPRINTF
argument_list|(
name|sc
argument_list|,
name|OTUS_DEBUG_RESET
argument_list|,
literal|"band switch\n"
argument_list|)
expr_stmt|;
comment|/* Cold/Warm reset BB/ADDA. */
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_PWR_REG_RESET
argument_list|,
name|sc
operator|->
name|bb_reset
condition|?
literal|0x800
else|:
literal|0x400
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|otus_write_barrier
argument_list|(
name|sc
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|finish
goto|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_PWR_REG_RESET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|otus_write_barrier
argument_list|(
name|sc
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|finish
goto|;
name|sc
operator|->
name|bb_reset
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|otus_program_phy
argument_list|(
name|sc
argument_list|,
name|c
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: could not program PHY\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
goto|goto
name|finish
goto|;
block|}
comment|/* Select RF programming based on band. */
if|if
condition|(
name|IEEE80211_IS_CHAN_5GHZ
argument_list|(
name|c
argument_list|)
condition|)
name|vals
operator|=
name|ar5416_banks_vals_5ghz
expr_stmt|;
else|else
name|vals
operator|=
name|ar5416_banks_vals_2ghz
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nitems
argument_list|(
name|ar5416_banks_regs
argument_list|)
condition|;
name|i
operator|++
control|)
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_PHY
argument_list|(
name|ar5416_banks_regs
index|[
name|i
index|]
argument_list|)
argument_list|,
name|vals
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|otus_write_barrier
argument_list|(
name|sc
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: could not program RF\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
goto|goto
name|finish
goto|;
block|}
name|code
operator|=
name|AR_CMD_RF_INIT
expr_stmt|;
block|}
else|else
block|{
name|code
operator|=
name|AR_CMD_FREQUENCY
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|error
operator|=
name|otus_set_rf_bank4
argument_list|(
name|sc
argument_list|,
name|c
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|finish
goto|;
name|tmp
operator|=
operator|(
name|sc
operator|->
name|txmask
operator|==
literal|0x5
operator|)
condition|?
literal|0x340
else|:
literal|0x240
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_PHY_TURBO
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|otus_write_barrier
argument_list|(
name|sc
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|finish
goto|;
comment|/* Send firmware command to set channel. */
name|cmd
operator|.
name|freq
operator|=
name|htole32
argument_list|(
operator|(
name|uint32_t
operator|)
name|c
operator|->
name|ic_freq
operator|*
literal|1000
argument_list|)
expr_stmt|;
name|cmd
operator|.
name|dynht2040
operator|=
name|htole32
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|cmd
operator|.
name|htena
operator|=
name|htole32
argument_list|(
literal|1
argument_list|)
expr_stmt|;
comment|/* Set Delta Slope (exponent and mantissa). */
name|coeff
operator|=
operator|(
literal|100
operator|<<
literal|24
operator|)
operator|/
name|c
operator|->
name|ic_freq
expr_stmt|;
name|otus_get_delta_slope
argument_list|(
name|coeff
argument_list|,
operator|&
name|exp
argument_list|,
operator|&
name|man
argument_list|)
expr_stmt|;
name|cmd
operator|.
name|dsc_exp
operator|=
name|htole32
argument_list|(
name|exp
argument_list|)
expr_stmt|;
name|cmd
operator|.
name|dsc_man
operator|=
name|htole32
argument_list|(
name|man
argument_list|)
expr_stmt|;
name|OTUS_DPRINTF
argument_list|(
name|sc
argument_list|,
name|OTUS_DEBUG_RESET
argument_list|,
literal|"ds coeff=%u exp=%u man=%u\n"
argument_list|,
name|coeff
argument_list|,
name|exp
argument_list|,
name|man
argument_list|)
expr_stmt|;
comment|/* For Short GI, coeff is 9/10 that of normal coeff. */
name|coeff
operator|=
operator|(
literal|9
operator|*
name|coeff
operator|)
operator|/
literal|10
expr_stmt|;
name|otus_get_delta_slope
argument_list|(
name|coeff
argument_list|,
operator|&
name|exp
argument_list|,
operator|&
name|man
argument_list|)
expr_stmt|;
name|cmd
operator|.
name|dsc_shgi_exp
operator|=
name|htole32
argument_list|(
name|exp
argument_list|)
expr_stmt|;
name|cmd
operator|.
name|dsc_shgi_man
operator|=
name|htole32
argument_list|(
name|man
argument_list|)
expr_stmt|;
name|OTUS_DPRINTF
argument_list|(
name|sc
argument_list|,
name|OTUS_DEBUG_RESET
argument_list|,
literal|"ds shgi coeff=%u exp=%u man=%u\n"
argument_list|,
name|coeff
argument_list|,
name|exp
argument_list|,
name|man
argument_list|)
expr_stmt|;
comment|/* Set wait time for AGC and noise calibration (100 or 200ms). */
name|cmd
operator|.
name|check_loop_count
operator|=
name|assoc
condition|?
name|htole32
argument_list|(
literal|2000
argument_list|)
else|:
name|htole32
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
name|OTUS_DPRINTF
argument_list|(
name|sc
argument_list|,
name|OTUS_DEBUG_RESET
argument_list|,
literal|"%s\n"
argument_list|,
operator|(
name|code
operator|==
name|AR_CMD_RF_INIT
operator|)
condition|?
literal|"RF_INIT"
else|:
literal|"FREQUENCY"
argument_list|)
expr_stmt|;
name|error
operator|=
name|otus_cmd
argument_list|(
name|sc
argument_list|,
name|code
argument_list|,
operator|&
name|cmd
argument_list|,
sizeof|sizeof
name|cmd
argument_list|,
operator|&
name|rsp
argument_list|,
sizeof|sizeof
argument_list|(
name|rsp
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|finish
goto|;
if|if
condition|(
operator|(
name|rsp
operator|.
name|status
operator|&
name|htole32
argument_list|(
name|AR_CAL_ERR_AGC
operator||
name|AR_CAL_ERR_NF_VAL
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|OTUS_DPRINTF
argument_list|(
name|sc
argument_list|,
name|OTUS_DEBUG_RESET
argument_list|,
literal|"status=0x%x\n"
argument_list|,
name|le32toh
argument_list|(
name|rsp
operator|.
name|status
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Force cold reset on next channel. */
name|sc
operator|->
name|bb_reset
operator|=
literal|1
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|USB_DEBUG
if|if
condition|(
name|otus_debug
operator|&
name|OTUS_DEBUG_RESET
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"calibration status=0x%x\n"
argument_list|,
name|le32toh
argument_list|(
name|rsp
operator|.
name|status
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
block|{
comment|/* 2 Rx chains */
comment|/* Sign-extend 9-bit NF values. */
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"noisefloor chain %d=%d\n"
argument_list|,
name|i
argument_list|,
operator|(
operator|(
operator|(
name|int32_t
operator|)
name|le32toh
argument_list|(
name|rsp
operator|.
name|nf
index|[
name|i
index|]
argument_list|)
operator|)
operator|<<
literal|4
operator|)
operator|>>
literal|23
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"noisefloor ext chain %d=%d\n"
argument_list|,
name|i
argument_list|,
operator|(
operator|(
name|int32_t
operator|)
name|le32toh
argument_list|(
name|rsp
operator|.
name|nf_ext
index|[
name|i
index|]
argument_list|)
operator|)
operator|>>
literal|23
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|OTUS_NUM_CHAINS
condition|;
name|i
operator|++
control|)
block|{
name|sc
operator|->
name|sc_nf
index|[
name|i
index|]
operator|=
operator|(
operator|(
operator|(
operator|(
name|int32_t
operator|)
name|le32toh
argument_list|(
name|rsp
operator|.
name|nf
index|[
name|i
index|]
argument_list|)
operator|)
operator|<<
literal|4
operator|)
operator|>>
literal|23
operator|)
expr_stmt|;
block|}
name|sc
operator|->
name|sc_curchan
operator|=
name|c
expr_stmt|;
name|finish
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|notyet
end_ifdef

begin_function
name|int
name|otus_set_key
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|,
name|struct
name|ieee80211_node
modifier|*
name|ni
parameter_list|,
name|struct
name|ieee80211_key
modifier|*
name|k
parameter_list|)
block|{
name|struct
name|otus_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_softc
decl_stmt|;
name|struct
name|otus_cmd_key
name|cmd
decl_stmt|;
comment|/* Defer setting of WEP keys until interface is brought up. */
if|if
condition|(
operator|(
name|ic
operator|->
name|ic_if
operator|.
name|if_flags
operator|&
operator|(
name|IFF_UP
operator||
name|IFF_RUNNING
operator|)
operator|)
operator|!=
operator|(
name|IFF_UP
operator||
name|IFF_RUNNING
operator|)
condition|)
return|return
literal|0
return|;
comment|/* Do it in a process context. */
name|cmd
operator|.
name|key
operator|=
operator|*
name|k
expr_stmt|;
name|cmd
operator|.
name|associd
operator|=
operator|(
name|ni
operator|!=
name|NULL
operator|)
condition|?
name|ni
operator|->
name|ni_associd
else|:
literal|0
expr_stmt|;
name|otus_do_async
argument_list|(
name|sc
argument_list|,
name|otus_set_key_cb
argument_list|,
operator|&
name|cmd
argument_list|,
sizeof|sizeof
name|cmd
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|otus_set_key_cb
parameter_list|(
name|struct
name|otus_softc
modifier|*
name|sc
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|otus_cmd_key
modifier|*
name|cmd
init|=
name|arg
decl_stmt|;
name|struct
name|ieee80211_key
modifier|*
name|k
init|=
operator|&
name|cmd
operator|->
name|key
decl_stmt|;
name|struct
name|ar_cmd_ekey
name|key
decl_stmt|;
name|uint16_t
name|cipher
decl_stmt|;
name|int
name|error
decl_stmt|;
name|memset
argument_list|(
operator|&
name|key
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|k
operator|->
name|k_flags
operator|&
name|IEEE80211_KEY_GROUP
condition|)
block|{
name|key
operator|.
name|uid
operator|=
name|htole16
argument_list|(
name|k
operator|->
name|k_id
argument_list|)
expr_stmt|;
name|IEEE80211_ADDR_COPY
argument_list|(
name|key
operator|.
name|macaddr
argument_list|,
name|sc
operator|->
name|sc_ic
operator|.
name|ic_myaddr
argument_list|)
expr_stmt|;
name|key
operator|.
name|macaddr
index|[
literal|0
index|]
operator||=
literal|0x80
expr_stmt|;
block|}
else|else
block|{
name|key
operator|.
name|uid
operator|=
name|htole16
argument_list|(
name|OTUS_UID
argument_list|(
name|cmd
operator|->
name|associd
argument_list|)
argument_list|)
expr_stmt|;
name|IEEE80211_ADDR_COPY
argument_list|(
name|key
operator|.
name|macaddr
argument_list|,
name|ni
operator|->
name|ni_macaddr
argument_list|)
expr_stmt|;
block|}
name|key
operator|.
name|kix
operator|=
name|htole16
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|/* Map net80211 cipher to hardware. */
switch|switch
condition|(
name|k
operator|->
name|k_cipher
condition|)
block|{
case|case
name|IEEE80211_CIPHER_WEP40
case|:
name|cipher
operator|=
name|AR_CIPHER_WEP64
expr_stmt|;
break|break;
case|case
name|IEEE80211_CIPHER_WEP104
case|:
name|cipher
operator|=
name|AR_CIPHER_WEP128
expr_stmt|;
break|break;
case|case
name|IEEE80211_CIPHER_TKIP
case|:
name|cipher
operator|=
name|AR_CIPHER_TKIP
expr_stmt|;
break|break;
case|case
name|IEEE80211_CIPHER_CCMP
case|:
name|cipher
operator|=
name|AR_CIPHER_AES
expr_stmt|;
break|break;
default|default:
return|return;
block|}
name|key
operator|.
name|cipher
operator|=
name|htole16
argument_list|(
name|cipher
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|key
operator|.
name|key
argument_list|,
name|k
operator|->
name|k_key
argument_list|,
name|MIN
argument_list|(
name|k
operator|->
name|k_len
argument_list|,
literal|16
argument_list|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|otus_cmd
argument_list|(
name|sc
argument_list|,
name|AR_CMD_EKEY
argument_list|,
operator|&
name|key
argument_list|,
sizeof|sizeof
name|key
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
operator|||
name|k
operator|->
name|k_cipher
operator|!=
name|IEEE80211_CIPHER_TKIP
condition|)
return|return;
comment|/* TKIP: set Tx/Rx MIC Key. */
name|key
operator|.
name|kix
operator|=
name|htole16
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|key
operator|.
name|key
argument_list|,
name|k
operator|->
name|k_key
operator|+
literal|16
argument_list|,
literal|16
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|otus_cmd
argument_list|(
name|sc
argument_list|,
name|AR_CMD_EKEY
argument_list|,
operator|&
name|key
argument_list|,
sizeof|sizeof
name|key
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|otus_delete_key
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|,
name|struct
name|ieee80211_node
modifier|*
name|ni
parameter_list|,
name|struct
name|ieee80211_key
modifier|*
name|k
parameter_list|)
block|{
name|struct
name|otus_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_softc
decl_stmt|;
name|struct
name|otus_cmd_key
name|cmd
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|ic
operator|->
name|ic_if
operator|.
name|if_flags
operator|&
name|IFF_RUNNING
operator|)
operator|||
name|ic
operator|->
name|ic_state
operator|!=
name|IEEE80211_S_RUN
condition|)
return|return;
comment|/* Nothing to do. */
comment|/* Do it in a process context. */
name|cmd
operator|.
name|key
operator|=
operator|*
name|k
expr_stmt|;
name|cmd
operator|.
name|associd
operator|=
operator|(
name|ni
operator|!=
name|NULL
operator|)
condition|?
name|ni
operator|->
name|ni_associd
else|:
literal|0
expr_stmt|;
name|otus_do_async
argument_list|(
name|sc
argument_list|,
name|otus_delete_key_cb
argument_list|,
operator|&
name|cmd
argument_list|,
sizeof|sizeof
name|cmd
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|otus_delete_key_cb
parameter_list|(
name|struct
name|otus_softc
modifier|*
name|sc
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|otus_cmd_key
modifier|*
name|cmd
init|=
name|arg
decl_stmt|;
name|struct
name|ieee80211_key
modifier|*
name|k
init|=
operator|&
name|cmd
operator|->
name|key
decl_stmt|;
name|uint32_t
name|uid
decl_stmt|;
if|if
condition|(
name|k
operator|->
name|k_flags
operator|&
name|IEEE80211_KEY_GROUP
condition|)
name|uid
operator|=
name|htole32
argument_list|(
name|k
operator|->
name|k_id
argument_list|)
expr_stmt|;
else|else
name|uid
operator|=
name|htole32
argument_list|(
name|OTUS_UID
argument_list|(
name|cmd
operator|->
name|associd
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|otus_cmd
argument_list|(
name|sc
argument_list|,
name|AR_CMD_DKEY
argument_list|,
operator|&
name|uid
argument_list|,
sizeof|sizeof
name|uid
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * XXX TODO: check if we have to be doing any calibration in the host  * or whether it's purely a firmware thing.  */
end_comment

begin_function
name|void
name|otus_calibrate_to
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|int
name|pending
parameter_list|)
block|{
if|#
directive|if
literal|0
block|struct otus_softc *sc = arg;  	device_printf(sc->sc_dev, "%s: called\n", __func__); 	struct ieee80211com *ic =&sc->sc_ic; 	struct ieee80211_node *ni; 	int s;  	if (usbd_is_dying(sc->sc_udev)) 		return;  	usbd_ref_incr(sc->sc_udev);  	s = splnet(); 	ni = ic->ic_bss; 	ieee80211_amrr_choose(&sc->amrr, ni,&((struct otus_node *)ni)->amn); 	splx(s);  	if (!usbd_is_dying(sc->sc_udev)) 		timeout_add_sec(&sc->calib_to, 1);  	usbd_ref_decr(sc->sc_udev);
endif|#
directive|endif
block|}
end_function

begin_function
name|int
name|otus_set_bssid
parameter_list|(
name|struct
name|otus_softc
modifier|*
name|sc
parameter_list|,
specifier|const
name|uint8_t
modifier|*
name|bssid
parameter_list|)
block|{
name|OTUS_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_MAC_REG_BSSID_L
argument_list|,
name|bssid
index|[
literal|0
index|]
operator||
name|bssid
index|[
literal|1
index|]
operator|<<
literal|8
operator||
name|bssid
index|[
literal|2
index|]
operator|<<
literal|16
operator||
name|bssid
index|[
literal|3
index|]
operator|<<
literal|24
argument_list|)
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_MAC_REG_BSSID_H
argument_list|,
name|bssid
index|[
literal|4
index|]
operator||
name|bssid
index|[
literal|5
index|]
operator|<<
literal|8
argument_list|)
expr_stmt|;
return|return
name|otus_write_barrier
argument_list|(
name|sc
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|otus_set_macaddr
parameter_list|(
name|struct
name|otus_softc
modifier|*
name|sc
parameter_list|,
specifier|const
name|uint8_t
modifier|*
name|addr
parameter_list|)
block|{
name|OTUS_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_MAC_REG_MAC_ADDR_L
argument_list|,
name|addr
index|[
literal|0
index|]
operator||
name|addr
index|[
literal|1
index|]
operator|<<
literal|8
operator||
name|addr
index|[
literal|2
index|]
operator|<<
literal|16
operator||
name|addr
index|[
literal|3
index|]
operator|<<
literal|24
argument_list|)
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_MAC_REG_MAC_ADDR_H
argument_list|,
name|addr
index|[
literal|4
index|]
operator||
name|addr
index|[
literal|5
index|]
operator|<<
literal|8
argument_list|)
expr_stmt|;
return|return
name|otus_write_barrier
argument_list|(
name|sc
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Default single-LED. */
end_comment

begin_function
name|void
name|otus_led_newstate_type1
parameter_list|(
name|struct
name|otus_softc
modifier|*
name|sc
parameter_list|)
block|{
comment|/* TBD */
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: TODO\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* NETGEAR, dual-LED. */
end_comment

begin_function
name|void
name|otus_led_newstate_type2
parameter_list|(
name|struct
name|otus_softc
modifier|*
name|sc
parameter_list|)
block|{
comment|/* TBD */
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: TODO\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* NETGEAR, single-LED/3 colors (blue, red, purple.) */
end_comment

begin_function
name|void
name|otus_led_newstate_type3
parameter_list|(
name|struct
name|otus_softc
modifier|*
name|sc
parameter_list|)
block|{
if|#
directive|if
literal|0
block|struct ieee80211com *ic =&sc->sc_ic; 	struct ieee80211vap *vap = TAILQ_FIRST(&ic->ic_vaps);  	uint32_t state = sc->led_state;  	OTUS_LOCK_ASSERT(sc);  	if (!vap) { 		state = 0;
comment|/* led off */
block|} else if (vap->iv_state == IEEE80211_S_INIT) { 		state = 0;
comment|/* LED off. */
block|} else if (vap->iv_state == IEEE80211_S_RUN) {
comment|/* Associated, LED always on. */
block|if (IEEE80211_IS_CHAN_2GHZ(sc->sc_curchan)) 			state = AR_LED0_ON;
comment|/* 2GHz=>Red. */
block|else 			state = AR_LED1_ON;
comment|/* 5GHz=>Blue. */
block|} else {
comment|/* Scanning, blink LED. */
block|state ^= AR_LED0_ON | AR_LED1_ON; 		if (IEEE80211_IS_CHAN_2GHZ(sc->sc_curchan)) 			state&= ~AR_LED1_ON; 		else 			state&= ~AR_LED0_ON; 	} 	if (state != sc->led_state) { 		otus_write(sc, AR_GPIO_REG_PORT_DATA, state); 		if (otus_write_barrier(sc) == 0) 			sc->led_state = state; 	}
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/*  * TODO:  *  * + If in monitor mode, set BSSID to all zeros, else the node BSSID.  * + Handle STA + monitor (eg tcpdump/promisc/radiotap) as well as  *   pure monitor mode.  */
end_comment

begin_function
specifier|static
name|int
name|otus_set_operating_mode
parameter_list|(
name|struct
name|otus_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
name|uint32_t
name|rx_ctrl
decl_stmt|;
name|uint32_t
name|frm_filt
decl_stmt|;
name|uint32_t
name|cam_mode
decl_stmt|;
name|uint32_t
name|rx_sniffer
decl_stmt|;
name|OTUS_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* XXX TODO: too many magic constants */
name|rx_ctrl
operator|=
literal|0x1
expr_stmt|;
comment|/* Filter any control frames, BAR is bit 24. */
name|frm_filt
operator|=
literal|0x0500ffff
expr_stmt|;
name|cam_mode
operator|=
literal|0x0f000002
expr_stmt|;
comment|/* XXX STA */
name|rx_sniffer
operator|=
literal|0x20000000
expr_stmt|;
switch|switch
condition|(
name|ic
operator|->
name|ic_opmode
condition|)
block|{
case|case
name|IEEE80211_M_STA
case|:
name|cam_mode
operator|=
literal|0x0f000002
expr_stmt|;
comment|/* XXX STA */
name|rx_ctrl
operator|=
literal|0x1
expr_stmt|;
name|frm_filt
operator|=
literal|0x0500ffff
expr_stmt|;
name|rx_sniffer
operator|=
literal|0x20000000
expr_stmt|;
break|break;
case|case
name|IEEE80211_M_MONITOR
case|:
name|cam_mode
operator|=
literal|0x0f000002
expr_stmt|;
comment|/* XXX STA */
name|rx_ctrl
operator|=
literal|0x1
expr_stmt|;
name|frm_filt
operator|=
literal|0xffffffff
expr_stmt|;
name|rx_sniffer
operator|=
literal|0x20000001
expr_stmt|;
break|break;
default|default:
break|break;
block|}
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_MAC_REG_SNIFFER
argument_list|,
name|rx_sniffer
argument_list|)
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_MAC_REG_CAM_MODE
argument_list|,
name|cam_mode
argument_list|)
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_MAC_REG_FRAMETYPE_FILTER
argument_list|,
name|frm_filt
argument_list|)
expr_stmt|;
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_MAC_REG_RX_CONTROL
argument_list|,
name|cam_mode
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|otus_write_barrier
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|otus_init
parameter_list|(
name|struct
name|otus_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
name|int
name|error
decl_stmt|;
name|OTUS_UNLOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|OTUS_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Drain any pending TX frames */
name|otus_drain_mbufq
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Init MAC */
if|if
condition|(
operator|(
name|error
operator|=
name|otus_init_mac
argument_list|(
name|sc
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|OTUS_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: could not initialize MAC\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
operator|(
name|void
operator|)
name|otus_set_macaddr
argument_list|(
name|sc
argument_list|,
name|ic
operator|->
name|ic_macaddr
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|otus_set_operating_mode
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|bb_reset
operator|=
literal|1
expr_stmt|;
comment|/* Force cold reset. */
if|if
condition|(
operator|(
name|error
operator|=
name|otus_set_chan
argument_list|(
name|sc
argument_list|,
name|ic
operator|->
name|ic_curchan
argument_list|,
literal|0
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|OTUS_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: could not set channel\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
comment|/* Start Rx. */
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_MAC_REG_DMA_TRIGGER
argument_list|,
literal|0x100
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|otus_write_barrier
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_running
operator|=
literal|1
expr_stmt|;
name|OTUS_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|otus_stop
parameter_list|(
name|struct
name|otus_softc
modifier|*
name|sc
parameter_list|)
block|{
if|#
directive|if
literal|0
block|int s;
endif|#
directive|endif
name|OTUS_UNLOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|OTUS_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_running
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_tx_timer
operator|=
literal|0
expr_stmt|;
name|OTUS_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|taskqueue_drain_timeout
argument_list|(
name|taskqueue_thread
argument_list|,
operator|&
name|sc
operator|->
name|scan_to
argument_list|)
expr_stmt|;
name|taskqueue_drain_timeout
argument_list|(
name|taskqueue_thread
argument_list|,
operator|&
name|sc
operator|->
name|calib_to
argument_list|)
expr_stmt|;
name|taskqueue_drain
argument_list|(
name|taskqueue_thread
argument_list|,
operator|&
name|sc
operator|->
name|tx_task
argument_list|)
expr_stmt|;
name|OTUS_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_running
operator|=
literal|0
expr_stmt|;
comment|/* Stop Rx. */
name|otus_write
argument_list|(
name|sc
argument_list|,
name|AR_MAC_REG_DMA_TRIGGER
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|otus_write_barrier
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Drain any pending TX frames */
name|otus_drain_mbufq
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|OTUS_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


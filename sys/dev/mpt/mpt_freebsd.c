begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * FreeBSD/CAM specific routines for LSI '909 FC  adapters.  * FreeBSD Version.  *  * Copyright (c)  2000, 2001 by Greg Ansley  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice immediately at the beginning of the file, without modification,  *    this list of conditions, and the following disclaimer.  * 2. The name of the author may not be used to endorse or promote products  *    derived from this software without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE FOR  * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_comment
comment|/*  * Additional Copyright (c) 2002 by Matthew Jacob under same license.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/mpt/mpt_freebsd.h>
end_include

begin_function_decl
specifier|static
name|void
name|mpt_poll
parameter_list|(
name|struct
name|cam_sim
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|timeout_t
name|mpttimeout
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|timeout_t
name|mpttimeout2
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|mpt_action
parameter_list|(
name|struct
name|cam_sim
modifier|*
parameter_list|,
name|union
name|ccb
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|mpt_setwidth
parameter_list|(
name|mpt_softc_t
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|mpt_setsync
parameter_list|(
name|mpt_softc_t
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|void
name|mpt_cam_attach
parameter_list|(
name|mpt_softc_t
modifier|*
name|mpt
parameter_list|)
block|{
name|struct
name|cam_devq
modifier|*
name|devq
decl_stmt|;
name|struct
name|cam_sim
modifier|*
name|sim
decl_stmt|;
name|int
name|maxq
decl_stmt|;
name|mpt
operator|->
name|bus
operator|=
literal|0
expr_stmt|;
name|maxq
operator|=
operator|(
name|mpt
operator|->
name|mpt_global_credits
operator|<
name|MPT_MAX_REQUESTS
argument_list|(
name|mpt
argument_list|)
operator|)
condition|?
name|mpt
operator|->
name|mpt_global_credits
else|:
name|MPT_MAX_REQUESTS
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
comment|/* 	 * Create the device queue for our SIM(s). 	 */
name|devq
operator|=
name|cam_simq_alloc
argument_list|(
name|maxq
argument_list|)
expr_stmt|;
if|if
condition|(
name|devq
operator|==
name|NULL
condition|)
block|{
return|return;
block|}
comment|/* 	 * Construct our SIM entry. 	 */
name|sim
operator|=
name|cam_sim_alloc
argument_list|(
name|mpt_action
argument_list|,
name|mpt_poll
argument_list|,
literal|"mpt"
argument_list|,
name|mpt
argument_list|,
name|mpt
operator|->
name|unit
argument_list|,
literal|1
argument_list|,
name|maxq
argument_list|,
name|devq
argument_list|)
expr_stmt|;
if|if
condition|(
name|sim
operator|==
name|NULL
condition|)
block|{
name|cam_simq_free
argument_list|(
name|devq
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 	 * Register exactly the bus. 	 */
if|if
condition|(
name|xpt_bus_register
argument_list|(
name|sim
argument_list|,
literal|0
argument_list|)
operator|!=
name|CAM_SUCCESS
condition|)
block|{
name|cam_sim_free
argument_list|(
name|sim
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|xpt_create_path
argument_list|(
operator|&
name|mpt
operator|->
name|path
argument_list|,
name|NULL
argument_list|,
name|cam_sim_path
argument_list|(
name|sim
argument_list|)
argument_list|,
name|CAM_TARGET_WILDCARD
argument_list|,
name|CAM_LUN_WILDCARD
argument_list|)
operator|!=
name|CAM_REQ_CMP
condition|)
block|{
name|xpt_bus_deregister
argument_list|(
name|cam_sim_path
argument_list|(
name|sim
argument_list|)
argument_list|)
expr_stmt|;
name|cam_sim_free
argument_list|(
name|sim
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
return|return;
block|}
name|mpt
operator|->
name|sim
operator|=
name|sim
expr_stmt|;
block|}
end_function

begin_function
name|void
name|mpt_cam_detach
parameter_list|(
name|mpt_softc_t
modifier|*
name|mpt
parameter_list|)
block|{
if|if
condition|(
name|mpt
operator|->
name|sim
operator|!=
name|NULL
condition|)
block|{
name|xpt_free_path
argument_list|(
name|mpt
operator|->
name|path
argument_list|)
expr_stmt|;
name|xpt_bus_deregister
argument_list|(
name|cam_sim_path
argument_list|(
name|mpt
operator|->
name|sim
argument_list|)
argument_list|)
expr_stmt|;
name|cam_sim_free
argument_list|(
name|mpt
operator|->
name|sim
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|mpt
operator|->
name|sim
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* This routine is used after a system crash to dump core onto the  * swap device.  */
end_comment

begin_function
specifier|static
name|void
name|mpt_poll
parameter_list|(
name|struct
name|cam_sim
modifier|*
name|sim
parameter_list|)
block|{
name|mpt_softc_t
modifier|*
name|mpt
init|=
operator|(
name|mpt_softc_t
operator|*
operator|)
name|cam_sim_softc
argument_list|(
name|sim
argument_list|)
decl_stmt|;
name|MPT_LOCK
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
name|mpt_intr
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
name|MPT_UNLOCK
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * This routine is called if the 9x9 does not return completion status  * for a command after a CAM specified time.  */
end_comment

begin_function
specifier|static
name|void
name|mpttimeout
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|request_t
modifier|*
name|req
decl_stmt|;
name|union
name|ccb
modifier|*
name|ccb
init|=
name|arg
decl_stmt|;
name|u_int32_t
name|oseq
decl_stmt|;
name|mpt_softc_t
modifier|*
name|mpt
decl_stmt|;
name|mpt
operator|=
name|ccb
operator|->
name|ccb_h
operator|.
name|ccb_mpt_ptr
expr_stmt|;
name|MPT_LOCK
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
name|req
operator|=
name|ccb
operator|->
name|ccb_h
operator|.
name|ccb_req_ptr
expr_stmt|;
name|oseq
operator|=
name|req
operator|->
name|sequence
expr_stmt|;
name|mpt
operator|->
name|timeouts
operator|++
expr_stmt|;
if|if
condition|(
name|mpt_intr
argument_list|(
name|mpt
argument_list|)
condition|)
block|{
if|if
condition|(
name|req
operator|->
name|sequence
operator|!=
name|oseq
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"bullet missed in timeout"
argument_list|)
expr_stmt|;
name|MPT_UNLOCK
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
return|return;
block|}
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"bullet U-turned in timeout: got us"
argument_list|)
expr_stmt|;
block|}
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"time out on request index = 0x%02x sequence = 0x%08x"
argument_list|,
name|req
operator|->
name|index
argument_list|,
name|req
operator|->
name|sequence
argument_list|)
expr_stmt|;
name|mpt_check_doorbell
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"Status %08x; Mask %08x; Doorbell %08x"
argument_list|,
name|mpt_read
argument_list|(
name|mpt
argument_list|,
name|MPT_OFFSET_INTR_STATUS
argument_list|)
argument_list|,
name|mpt_read
argument_list|(
name|mpt
argument_list|,
name|MPT_OFFSET_INTR_MASK
argument_list|)
argument_list|,
name|mpt_read
argument_list|(
name|mpt
argument_list|,
name|MPT_OFFSET_DOORBELL
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"request state %s\n"
argument_list|,
name|mpt_req_state
argument_list|(
name|req
operator|->
name|debug
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ccb
operator|!=
name|req
operator|->
name|ccb
condition|)
block|{
name|printf
argument_list|(
literal|"time out: ccb %p != req->ccb %p\n"
argument_list|,
name|ccb
argument_list|,
name|req
operator|->
name|ccb
argument_list|)
expr_stmt|;
block|}
name|mpt_print_scsi_io_request
argument_list|(
operator|(
name|MSG_SCSI_IO_REQUEST
operator|*
operator|)
name|req
operator|->
name|req_vbuf
argument_list|)
expr_stmt|;
name|req
operator|->
name|debug
operator|=
name|REQ_TIMEOUT
expr_stmt|;
name|req
operator|->
name|ccb
operator|=
name|NULL
expr_stmt|;
name|req
operator|->
name|link
operator|.
name|sle_next
operator|=
operator|(
name|void
operator|*
operator|)
name|mpt
expr_stmt|;
operator|(
name|void
operator|)
name|timeout
argument_list|(
name|mpttimeout2
argument_list|,
operator|(
name|caddr_t
operator|)
name|req
argument_list|,
name|hz
operator|/
literal|10
argument_list|)
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_CMD_TIMEOUT
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator||=
name|CAM_RELEASE_SIMQ
expr_stmt|;
name|mpt
operator|->
name|outofbeer
operator|=
literal|0
expr_stmt|;
name|MPTLOCK_2_CAMLOCK
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
name|CAMLOCK_2_MPTLOCK
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
name|MPT_UNLOCK
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mpttimeout2
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|request_t
modifier|*
name|req
init|=
name|arg
decl_stmt|;
if|if
condition|(
name|req
operator|->
name|debug
operator|==
name|REQ_TIMEOUT
condition|)
block|{
name|mpt_softc_t
modifier|*
name|mpt
init|=
operator|(
name|mpt_softc_t
operator|*
operator|)
name|req
operator|->
name|link
operator|.
name|sle_next
decl_stmt|;
name|MPT_LOCK
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
name|mpt_free_request
argument_list|(
name|mpt
argument_list|,
name|req
argument_list|)
expr_stmt|;
name|MPT_UNLOCK
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Callback routine from "bus_dmamap_load" or in simple case called directly.  *  * Takes a list of physical segments and builds the SGL for SCSI IO command  * and forwards the commard to the IOC after one last check that CAM has not  * aborted the transaction.  */
end_comment

begin_function
specifier|static
name|void
name|mpt_execute_req
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|dm_segs
parameter_list|,
name|int
name|nseg
parameter_list|,
name|int
name|error
parameter_list|)
block|{
name|request_t
modifier|*
name|req
decl_stmt|;
name|union
name|ccb
modifier|*
name|ccb
decl_stmt|;
name|mpt_softc_t
modifier|*
name|mpt
decl_stmt|;
name|MSG_SCSI_IO_REQUEST
modifier|*
name|mpt_req
decl_stmt|;
name|SGE_SIMPLE32
modifier|*
name|se
decl_stmt|;
name|req
operator|=
operator|(
name|request_t
operator|*
operator|)
name|arg
expr_stmt|;
name|ccb
operator|=
name|req
operator|->
name|ccb
expr_stmt|;
name|mpt
operator|=
name|ccb
operator|->
name|ccb_h
operator|.
name|ccb_mpt_ptr
expr_stmt|;
name|req
operator|=
name|ccb
operator|->
name|ccb_h
operator|.
name|ccb_req_ptr
expr_stmt|;
name|mpt_req
operator|=
name|req
operator|->
name|req_vbuf
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
operator|&&
name|nseg
operator|>
name|MPT_SGL_MAX
condition|)
block|{
name|error
operator|=
name|EFBIG
expr_stmt|;
block|}
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|error
operator|!=
name|EFBIG
condition|)
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"bus_dmamap_load returned %d"
argument_list|,
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|==
name|CAM_REQ_INPROG
condition|)
block|{
name|xpt_freeze_devq
argument_list|(
name|ccb
operator|->
name|ccb_h
operator|.
name|path
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_DEV_QFRZN
expr_stmt|;
if|if
condition|(
name|error
operator|==
name|EFBIG
condition|)
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator||=
name|CAM_REQ_TOO_BIG
expr_stmt|;
else|else
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator||=
name|CAM_REQ_CMP_ERR
expr_stmt|;
block|}
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|&=
operator|~
name|CAM_SIM_QUEUED
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
name|CAMLOCK_2_MPTLOCK
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
name|mpt_free_request
argument_list|(
name|mpt
argument_list|,
name|req
argument_list|)
expr_stmt|;
name|MPTLOCK_2_CAMLOCK
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|nseg
operator|>
name|MPT_NSGL_FIRST
argument_list|(
name|mpt
argument_list|)
condition|)
block|{
name|int
name|i
decl_stmt|,
name|nleft
init|=
name|nseg
decl_stmt|;
name|u_int32_t
name|flags
decl_stmt|;
name|bus_dmasync_op_t
name|op
decl_stmt|;
name|SGE_CHAIN32
modifier|*
name|ce
decl_stmt|;
name|mpt_req
operator|->
name|DataLength
operator|=
name|ccb
operator|->
name|csio
operator|.
name|dxfer_len
expr_stmt|;
name|flags
operator|=
name|MPI_SGE_FLAGS_SIMPLE_ELEMENT
expr_stmt|;
if|if
condition|(
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_DIR_MASK
operator|)
operator|==
name|CAM_DIR_OUT
condition|)
name|flags
operator||=
name|MPI_SGE_FLAGS_HOST_TO_IOC
expr_stmt|;
name|se
operator|=
operator|(
name|SGE_SIMPLE32
operator|*
operator|)
operator|&
name|mpt_req
operator|->
name|SGL
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MPT_NSGL_FIRST
argument_list|(
name|mpt
argument_list|)
operator|-
literal|1
condition|;
name|i
operator|++
operator|,
name|se
operator|++
operator|,
name|dm_segs
operator|++
control|)
block|{
name|u_int32_t
name|tf
decl_stmt|;
name|bzero
argument_list|(
name|se
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|se
argument_list|)
argument_list|)
expr_stmt|;
name|se
operator|->
name|Address
operator|=
name|dm_segs
operator|->
name|ds_addr
expr_stmt|;
name|MPI_pSGE_SET_LENGTH
argument_list|(
name|se
argument_list|,
name|dm_segs
operator|->
name|ds_len
argument_list|)
expr_stmt|;
name|tf
operator|=
name|flags
expr_stmt|;
if|if
condition|(
name|i
operator|==
name|MPT_NSGL_FIRST
argument_list|(
name|mpt
argument_list|)
operator|-
literal|2
condition|)
block|{
name|tf
operator||=
name|MPI_SGE_FLAGS_LAST_ELEMENT
expr_stmt|;
block|}
name|MPI_pSGE_SET_FLAGS
argument_list|(
name|se
argument_list|,
name|tf
argument_list|)
expr_stmt|;
name|nleft
operator|-=
literal|1
expr_stmt|;
block|}
comment|/* 		 * Tell the IOC where to find the first chain element 		 */
name|mpt_req
operator|->
name|ChainOffset
operator|=
operator|(
operator|(
name|char
operator|*
operator|)
name|se
operator|-
operator|(
name|char
operator|*
operator|)
name|mpt_req
operator|)
operator|>>
literal|2
expr_stmt|;
comment|/* 		 * Until we're finished with all segments... 		 */
while|while
condition|(
name|nleft
condition|)
block|{
name|int
name|ntodo
decl_stmt|;
comment|/* 			 * Construct the chain element that point to the 			 * next segment. 			 */
name|ce
operator|=
operator|(
name|SGE_CHAIN32
operator|*
operator|)
name|se
operator|++
expr_stmt|;
if|if
condition|(
name|nleft
operator|>
name|MPT_NSGL
argument_list|(
name|mpt
argument_list|)
condition|)
block|{
name|ntodo
operator|=
name|MPT_NSGL
argument_list|(
name|mpt
argument_list|)
operator|-
literal|1
expr_stmt|;
name|ce
operator|->
name|NextChainOffset
operator|=
operator|(
name|MPT_RQSL
argument_list|(
name|mpt
argument_list|)
operator|-
sizeof|sizeof
argument_list|(
name|SGE_SIMPLE32
argument_list|)
operator|)
operator|>>
literal|2
expr_stmt|;
block|}
else|else
block|{
name|ntodo
operator|=
name|nleft
expr_stmt|;
name|ce
operator|->
name|NextChainOffset
operator|=
literal|0
expr_stmt|;
block|}
name|ce
operator|->
name|Length
operator|=
name|ntodo
operator|*
sizeof|sizeof
argument_list|(
name|SGE_SIMPLE32
argument_list|)
expr_stmt|;
name|ce
operator|->
name|Address
operator|=
name|req
operator|->
name|req_pbuf
operator|+
operator|(
operator|(
name|char
operator|*
operator|)
name|se
operator|-
operator|(
name|char
operator|*
operator|)
name|mpt_req
operator|)
expr_stmt|;
name|ce
operator|->
name|Flags
operator|=
name|MPI_SGE_FLAGS_CHAIN_ELEMENT
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ntodo
condition|;
name|i
operator|++
operator|,
name|se
operator|++
operator|,
name|dm_segs
operator|++
control|)
block|{
name|u_int32_t
name|tf
decl_stmt|;
name|bzero
argument_list|(
name|se
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|se
argument_list|)
argument_list|)
expr_stmt|;
name|se
operator|->
name|Address
operator|=
name|dm_segs
operator|->
name|ds_addr
expr_stmt|;
name|MPI_pSGE_SET_LENGTH
argument_list|(
name|se
argument_list|,
name|dm_segs
operator|->
name|ds_len
argument_list|)
expr_stmt|;
name|tf
operator|=
name|flags
expr_stmt|;
if|if
condition|(
name|i
operator|==
name|ntodo
operator|-
literal|1
condition|)
block|{
name|tf
operator||=
name|MPI_SGE_FLAGS_LAST_ELEMENT
expr_stmt|;
if|if
condition|(
name|ce
operator|->
name|NextChainOffset
operator|==
literal|0
condition|)
block|{
name|tf
operator||=
name|MPI_SGE_FLAGS_END_OF_LIST
operator||
name|MPI_SGE_FLAGS_END_OF_BUFFER
expr_stmt|;
block|}
block|}
name|MPI_pSGE_SET_FLAGS
argument_list|(
name|se
argument_list|,
name|tf
argument_list|)
expr_stmt|;
name|nleft
operator|-=
literal|1
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_DIR_MASK
operator|)
operator|==
name|CAM_DIR_IN
condition|)
name|op
operator|=
name|BUS_DMASYNC_PREREAD
expr_stmt|;
else|else
name|op
operator|=
name|BUS_DMASYNC_PREWRITE
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
operator|(
name|CAM_SG_LIST_PHYS
operator||
name|CAM_DATA_PHYS
operator|)
operator|)
condition|)
block|{
name|bus_dmamap_sync
argument_list|(
name|mpt
operator|->
name|buffer_dmat
argument_list|,
name|req
operator|->
name|dmap
argument_list|,
name|op
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|nseg
operator|>
literal|0
condition|)
block|{
name|int
name|i
decl_stmt|;
name|u_int32_t
name|flags
decl_stmt|;
name|bus_dmasync_op_t
name|op
decl_stmt|;
name|mpt_req
operator|->
name|DataLength
operator|=
name|ccb
operator|->
name|csio
operator|.
name|dxfer_len
expr_stmt|;
name|flags
operator|=
name|MPI_SGE_FLAGS_SIMPLE_ELEMENT
expr_stmt|;
if|if
condition|(
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_DIR_MASK
operator|)
operator|==
name|CAM_DIR_OUT
condition|)
name|flags
operator||=
name|MPI_SGE_FLAGS_HOST_TO_IOC
expr_stmt|;
comment|/* Copy the segments into our SG list */
name|se
operator|=
operator|(
name|SGE_SIMPLE32
operator|*
operator|)
operator|&
name|mpt_req
operator|->
name|SGL
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nseg
condition|;
name|i
operator|++
operator|,
name|se
operator|++
operator|,
name|dm_segs
operator|++
control|)
block|{
name|u_int32_t
name|tf
decl_stmt|;
name|bzero
argument_list|(
name|se
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|se
argument_list|)
argument_list|)
expr_stmt|;
name|se
operator|->
name|Address
operator|=
name|dm_segs
operator|->
name|ds_addr
expr_stmt|;
name|MPI_pSGE_SET_LENGTH
argument_list|(
name|se
argument_list|,
name|dm_segs
operator|->
name|ds_len
argument_list|)
expr_stmt|;
name|tf
operator|=
name|flags
expr_stmt|;
if|if
condition|(
name|i
operator|==
name|nseg
operator|-
literal|1
condition|)
block|{
name|tf
operator||=
name|MPI_SGE_FLAGS_LAST_ELEMENT
operator||
name|MPI_SGE_FLAGS_END_OF_BUFFER
operator||
name|MPI_SGE_FLAGS_END_OF_LIST
expr_stmt|;
block|}
name|MPI_pSGE_SET_FLAGS
argument_list|(
name|se
argument_list|,
name|tf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_DIR_MASK
operator|)
operator|==
name|CAM_DIR_IN
condition|)
name|op
operator|=
name|BUS_DMASYNC_PREREAD
expr_stmt|;
else|else
name|op
operator|=
name|BUS_DMASYNC_PREWRITE
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
operator|(
name|CAM_SG_LIST_PHYS
operator||
name|CAM_DATA_PHYS
operator|)
operator|)
condition|)
block|{
name|bus_dmamap_sync
argument_list|(
name|mpt
operator|->
name|buffer_dmat
argument_list|,
name|req
operator|->
name|dmap
argument_list|,
name|op
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|se
operator|=
operator|(
name|SGE_SIMPLE32
operator|*
operator|)
operator|&
name|mpt_req
operator|->
name|SGL
expr_stmt|;
comment|/* 		 * No data to transfer so we just make a single simple SGL 		 * with zero length. 		 */
name|MPI_pSGE_SET_FLAGS
argument_list|(
name|se
argument_list|,
operator|(
name|MPI_SGE_FLAGS_LAST_ELEMENT
operator||
name|MPI_SGE_FLAGS_END_OF_BUFFER
operator||
name|MPI_SGE_FLAGS_SIMPLE_ELEMENT
operator||
name|MPI_SGE_FLAGS_END_OF_LIST
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Last time we need to check if this CCB needs to be aborted. 	 */
if|if
condition|(
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|!=
name|CAM_REQ_INPROG
condition|)
block|{
if|if
condition|(
name|nseg
operator|&&
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_SG_LIST_PHYS
operator|)
operator|==
literal|0
condition|)
name|bus_dmamap_unload
argument_list|(
name|mpt
operator|->
name|buffer_dmat
argument_list|,
name|req
operator|->
name|dmap
argument_list|)
expr_stmt|;
name|CAMLOCK_2_MPTLOCK
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
name|mpt_free_request
argument_list|(
name|mpt
argument_list|,
name|req
argument_list|)
expr_stmt|;
name|MPTLOCK_2_CAMLOCK
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
return|return;
block|}
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator||=
name|CAM_SIM_QUEUED
expr_stmt|;
name|MPTLOCK_2_CAMLOCK
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
if|if
condition|(
name|ccb
operator|->
name|ccb_h
operator|.
name|timeout
operator|!=
name|CAM_TIME_INFINITY
condition|)
block|{
name|ccb
operator|->
name|ccb_h
operator|.
name|timeout_ch
operator|=
name|timeout
argument_list|(
name|mpttimeout
argument_list|,
operator|(
name|caddr_t
operator|)
name|ccb
argument_list|,
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|timeout
operator|*
name|hz
operator|)
operator|/
literal|1000
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|callout_handle_init
argument_list|(
operator|&
name|ccb
operator|->
name|ccb_h
operator|.
name|timeout_ch
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mpt
operator|->
name|verbose
operator|>
literal|1
condition|)
name|mpt_print_scsi_io_request
argument_list|(
name|mpt_req
argument_list|)
expr_stmt|;
name|mpt_send_cmd
argument_list|(
name|mpt
argument_list|,
name|req
argument_list|)
expr_stmt|;
name|MPTLOCK_2_CAMLOCK
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mpt_start
parameter_list|(
name|union
name|ccb
modifier|*
name|ccb
parameter_list|)
block|{
name|request_t
modifier|*
name|req
decl_stmt|;
name|struct
name|mpt_softc
modifier|*
name|mpt
decl_stmt|;
name|MSG_SCSI_IO_REQUEST
modifier|*
name|mpt_req
decl_stmt|;
name|struct
name|ccb_scsiio
modifier|*
name|csio
init|=
operator|&
name|ccb
operator|->
name|csio
decl_stmt|;
name|struct
name|ccb_hdr
modifier|*
name|ccbh
init|=
operator|&
name|ccb
operator|->
name|ccb_h
decl_stmt|;
comment|/* Get the pointer for the physical addapter */
name|mpt
operator|=
name|ccb
operator|->
name|ccb_h
operator|.
name|ccb_mpt_ptr
expr_stmt|;
name|CAMLOCK_2_MPTLOCK
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
comment|/* Get a request structure off the free list */
if|if
condition|(
operator|(
name|req
operator|=
name|mpt_get_request
argument_list|(
name|mpt
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|mpt
operator|->
name|outofbeer
operator|==
literal|0
condition|)
block|{
name|mpt
operator|->
name|outofbeer
operator|=
literal|1
expr_stmt|;
name|xpt_freeze_simq
argument_list|(
name|mpt
operator|->
name|sim
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|mpt
operator|->
name|verbose
operator|>
literal|1
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"FREEZEQ"
argument_list|)
expr_stmt|;
block|}
block|}
name|MPTLOCK_2_CAMLOCK
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQUEUE_REQ
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
return|return;
block|}
name|MPTLOCK_2_CAMLOCK
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
comment|/* Link the ccb and the request structure so we can find */
comment|/* the other knowing either the request or the ccb		 */
name|req
operator|->
name|ccb
operator|=
name|ccb
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|ccb_req_ptr
operator|=
name|req
expr_stmt|;
comment|/* Now we build the command for the IOC */
name|mpt_req
operator|=
name|req
operator|->
name|req_vbuf
expr_stmt|;
name|bzero
argument_list|(
name|mpt_req
argument_list|,
sizeof|sizeof
expr|*
name|mpt_req
argument_list|)
expr_stmt|;
name|mpt_req
operator|->
name|Function
operator|=
name|MPI_FUNCTION_SCSI_IO_REQUEST
expr_stmt|;
name|mpt_req
operator|->
name|Bus
operator|=
name|mpt
operator|->
name|bus
expr_stmt|;
name|mpt_req
operator|->
name|SenseBufferLength
operator|=
operator|(
name|csio
operator|->
name|sense_len
operator|<
name|MPT_SENSE_SIZE
operator|)
condition|?
name|csio
operator|->
name|sense_len
else|:
name|MPT_SENSE_SIZE
expr_stmt|;
comment|/* We use the message context to find the request structure when we */
comment|/* Get the command competion interrupt from the FC IOC.				*/
name|mpt_req
operator|->
name|MsgContext
operator|=
name|req
operator|->
name|index
expr_stmt|;
comment|/* Which physical device to do the I/O on */
name|mpt_req
operator|->
name|TargetID
operator|=
name|ccb
operator|->
name|ccb_h
operator|.
name|target_id
expr_stmt|;
name|mpt_req
operator|->
name|LUN
index|[
literal|1
index|]
operator|=
name|ccb
operator|->
name|ccb_h
operator|.
name|target_lun
expr_stmt|;
comment|/* Set the direction of the transfer */
if|if
condition|(
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_DIR_MASK
operator|)
operator|==
name|CAM_DIR_IN
condition|)
name|mpt_req
operator|->
name|Control
operator|=
name|MPI_SCSIIO_CONTROL_READ
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_DIR_MASK
operator|)
operator|==
name|CAM_DIR_OUT
condition|)
name|mpt_req
operator|->
name|Control
operator|=
name|MPI_SCSIIO_CONTROL_WRITE
expr_stmt|;
else|else
name|mpt_req
operator|->
name|Control
operator|=
name|MPI_SCSIIO_CONTROL_NODATATRANSFER
expr_stmt|;
if|if
condition|(
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_TAG_ACTION_VALID
operator|)
operator|!=
literal|0
condition|)
block|{
switch|switch
condition|(
name|ccb
operator|->
name|csio
operator|.
name|tag_action
condition|)
block|{
case|case
name|MSG_HEAD_OF_Q_TAG
case|:
name|mpt_req
operator|->
name|Control
operator||=
name|MPI_SCSIIO_CONTROL_HEADOFQ
expr_stmt|;
break|break;
case|case
name|MSG_ACA_TASK
case|:
name|mpt_req
operator|->
name|Control
operator||=
name|MPI_SCSIIO_CONTROL_ACAQ
expr_stmt|;
break|break;
case|case
name|MSG_ORDERED_Q_TAG
case|:
name|mpt_req
operator|->
name|Control
operator||=
name|MPI_SCSIIO_CONTROL_ORDEREDQ
expr_stmt|;
break|break;
case|case
name|MSG_SIMPLE_Q_TAG
case|:
default|default:
name|mpt_req
operator|->
name|Control
operator||=
name|MPI_SCSIIO_CONTROL_SIMPLEQ
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
if|if
condition|(
name|mpt
operator|->
name|is_fc
condition|)
name|mpt_req
operator|->
name|Control
operator||=
name|MPI_SCSIIO_CONTROL_SIMPLEQ
expr_stmt|;
else|else
name|mpt_req
operator|->
name|Control
operator||=
name|MPI_SCSIIO_CONTROL_UNTAGGED
expr_stmt|;
block|}
if|if
condition|(
name|mpt
operator|->
name|is_fc
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_DIS_DISCONNECT
condition|)
block|{
name|mpt_req
operator|->
name|Control
operator||=
name|MPI_SCSIIO_CONTROL_NO_DISCONNECT
expr_stmt|;
block|}
block|}
comment|/* Copy the scsi command block into place */
if|if
condition|(
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_CDB_POINTER
operator|)
operator|!=
literal|0
condition|)
name|bcopy
argument_list|(
name|csio
operator|->
name|cdb_io
operator|.
name|cdb_ptr
argument_list|,
name|mpt_req
operator|->
name|CDB
argument_list|,
name|csio
operator|->
name|cdb_len
argument_list|)
expr_stmt|;
else|else
name|bcopy
argument_list|(
name|csio
operator|->
name|cdb_io
operator|.
name|cdb_bytes
argument_list|,
name|mpt_req
operator|->
name|CDB
argument_list|,
name|csio
operator|->
name|cdb_len
argument_list|)
expr_stmt|;
name|mpt_req
operator|->
name|CDBLength
operator|=
name|csio
operator|->
name|cdb_len
expr_stmt|;
name|mpt_req
operator|->
name|DataLength
operator|=
name|csio
operator|->
name|dxfer_len
expr_stmt|;
name|mpt_req
operator|->
name|SenseBufferLowAddr
operator|=
name|req
operator|->
name|sense_pbuf
expr_stmt|;
comment|/* 	 * If we have any data to send with this command, 	 * map it into bus space. 	 */
if|if
condition|(
operator|(
name|ccbh
operator|->
name|flags
operator|&
name|CAM_DIR_MASK
operator|)
operator|!=
name|CAM_DIR_NONE
condition|)
block|{
if|if
condition|(
operator|(
name|ccbh
operator|->
name|flags
operator|&
name|CAM_SCATTER_VALID
operator|)
operator|==
literal|0
condition|)
block|{
comment|/* 			 * We've been given a pointer to a single buffer. 			 */
if|if
condition|(
operator|(
name|ccbh
operator|->
name|flags
operator|&
name|CAM_DATA_PHYS
operator|)
operator|==
literal|0
condition|)
block|{
comment|/* 				 * Virtual address that needs to translated into 				 * one or more physical pages. 				 */
name|int
name|error
decl_stmt|;
name|error
operator|=
name|bus_dmamap_load
argument_list|(
name|mpt
operator|->
name|buffer_dmat
argument_list|,
name|req
operator|->
name|dmap
argument_list|,
name|csio
operator|->
name|data_ptr
argument_list|,
name|csio
operator|->
name|dxfer_len
argument_list|,
name|mpt_execute_req
argument_list|,
name|req
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
name|EINPROGRESS
condition|)
block|{
comment|/* 					 * So as to maintain ordering, 					 * freeze the controller queue 					 * until our mapping is 					 * returned. 					 */
name|xpt_freeze_simq
argument_list|(
name|mpt
operator|->
name|sim
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ccbh
operator|->
name|status
operator||=
name|CAM_RELEASE_SIMQ
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* 				 * We have been given a pointer to single 				 * physical buffer. 				 */
name|struct
name|bus_dma_segment
name|seg
decl_stmt|;
name|seg
operator|.
name|ds_addr
operator|=
operator|(
name|bus_addr_t
operator|)
operator|(
name|vm_offset_t
operator|)
name|csio
operator|->
name|data_ptr
expr_stmt|;
name|seg
operator|.
name|ds_len
operator|=
name|csio
operator|->
name|dxfer_len
expr_stmt|;
name|mpt_execute_req
argument_list|(
name|req
argument_list|,
operator|&
name|seg
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* 			 * We have been given a list of addresses. 			 * These case could be easily done but they are not 			 * currently generated by the CAM subsystem so there 			 * is no point in wasting the time right now. 			 */
name|struct
name|bus_dma_segment
modifier|*
name|segs
decl_stmt|;
if|if
condition|(
operator|(
name|ccbh
operator|->
name|flags
operator|&
name|CAM_SG_LIST_PHYS
operator|)
operator|==
literal|0
condition|)
block|{
name|mpt_execute_req
argument_list|(
name|req
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|EFAULT
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Just use the segments provided */
name|segs
operator|=
operator|(
expr|struct
name|bus_dma_segment
operator|*
operator|)
name|csio
operator|->
name|data_ptr
expr_stmt|;
name|mpt_execute_req
argument_list|(
name|req
argument_list|,
name|segs
argument_list|,
name|csio
operator|->
name|sglist_cnt
argument_list|,
operator|(
name|csio
operator|->
name|sglist_cnt
operator|<
name|MPT_SGL_MAX
operator|)
condition|?
literal|0
else|:
name|EFBIG
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|mpt_execute_req
argument_list|(
name|req
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|mpt_bus_reset
parameter_list|(
name|union
name|ccb
modifier|*
name|ccb
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
name|request_t
modifier|*
name|req
decl_stmt|;
name|mpt_softc_t
modifier|*
name|mpt
decl_stmt|;
name|MSG_SCSI_TASK_MGMT
modifier|*
name|reset_req
decl_stmt|;
comment|/* Get the pointer for the physical adapter */
name|mpt
operator|=
name|ccb
operator|->
name|ccb_h
operator|.
name|ccb_mpt_ptr
expr_stmt|;
comment|/* Get a request structure off the free list */
if|if
condition|(
operator|(
name|req
operator|=
name|mpt_get_request
argument_list|(
name|mpt
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
return|return
operator|(
name|CAM_REQUEUE_REQ
operator|)
return|;
block|}
comment|/* Link the ccb and the request structure so we can find */
comment|/* the other knowing either the request or the ccb		 */
name|req
operator|->
name|ccb
operator|=
name|ccb
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|ccb_req_ptr
operator|=
name|req
expr_stmt|;
name|reset_req
operator|=
name|req
operator|->
name|req_vbuf
expr_stmt|;
name|bzero
argument_list|(
name|reset_req
argument_list|,
sizeof|sizeof
expr|*
name|reset_req
argument_list|)
expr_stmt|;
name|reset_req
operator|->
name|Function
operator|=
name|MPI_FUNCTION_SCSI_TASK_MGMT
expr_stmt|;
name|reset_req
operator|->
name|MsgContext
operator|=
name|req
operator|->
name|index
expr_stmt|;
name|reset_req
operator|->
name|TaskType
operator|=
name|MPI_SCSITASKMGMT_TASKTYPE_RESET_BUS
expr_stmt|;
if|if
condition|(
name|mpt
operator|->
name|is_fc
condition|)
block|{
comment|/* 		 * Should really be TARGET_RESET_OPTION 		 */
name|reset_req
operator|->
name|MsgFlags
operator|=
name|MPI_SCSITASKMGMT_MSGFLAGS_LIP_RESET_OPTION
expr_stmt|;
block|}
comment|/* Which physical device Reset */
name|reset_req
operator|->
name|TargetID
operator|=
name|ccb
operator|->
name|ccb_h
operator|.
name|target_id
expr_stmt|;
name|reset_req
operator|->
name|LUN
index|[
literal|1
index|]
operator|=
name|ccb
operator|->
name|ccb_h
operator|.
name|target_lun
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator||=
name|CAM_SIM_QUEUED
expr_stmt|;
name|error
operator|=
name|mpt_send_handshake_cmd
argument_list|(
name|mpt
argument_list|,
sizeof|sizeof
argument_list|(
name|MSG_SCSI_TASK_MGMT
argument_list|)
argument_list|,
name|reset_req
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"mpt_bus_reset: mpt_send_handshake return %d"
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|(
name|CAM_REQ_CMP_ERR
operator|)
return|;
block|}
else|else
block|{
return|return
operator|(
name|CAM_REQ_CMP
operator|)
return|;
block|}
block|}
end_function

begin_comment
comment|/*  * Process an asynchronous event from the IOC.  */
end_comment

begin_function_decl
specifier|static
name|void
name|mpt_ctlop
parameter_list|(
name|mpt_softc_t
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|,
name|u_int32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|mpt_event_notify_reply
parameter_list|(
name|mpt_softc_t
modifier|*
name|mpt
parameter_list|,
name|MSG_EVENT_NOTIFY_REPLY
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|void
name|mpt_ctlop
parameter_list|(
name|mpt_softc_t
modifier|*
name|mpt
parameter_list|,
name|void
modifier|*
name|vmsg
parameter_list|,
name|u_int32_t
name|reply
parameter_list|)
block|{
name|MSG_DEFAULT_REPLY
modifier|*
name|dmsg
init|=
name|vmsg
decl_stmt|;
if|if
condition|(
name|dmsg
operator|->
name|Function
operator|==
name|MPI_FUNCTION_EVENT_NOTIFICATION
condition|)
block|{
name|mpt_event_notify_reply
argument_list|(
name|mpt
argument_list|,
name|vmsg
argument_list|)
expr_stmt|;
name|mpt_free_reply
argument_list|(
name|mpt
argument_list|,
operator|(
name|reply
operator|<<
literal|1
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|dmsg
operator|->
name|Function
operator|==
name|MPI_FUNCTION_EVENT_ACK
condition|)
block|{
name|mpt_free_reply
argument_list|(
name|mpt
argument_list|,
operator|(
name|reply
operator|<<
literal|1
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|dmsg
operator|->
name|Function
operator|==
name|MPI_FUNCTION_PORT_ENABLE
condition|)
block|{
name|MSG_PORT_ENABLE_REPLY
modifier|*
name|msg
init|=
name|vmsg
decl_stmt|;
name|int
name|index
init|=
name|msg
operator|->
name|MsgContext
operator|&
operator|~
literal|0x80000000
decl_stmt|;
if|if
condition|(
name|mpt
operator|->
name|verbose
operator|>
literal|1
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"enable port reply idx %d"
argument_list|,
name|index
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|index
operator|>=
literal|0
operator|&&
name|index
operator|<
name|MPT_MAX_REQUESTS
argument_list|(
name|mpt
argument_list|)
condition|)
block|{
name|request_t
modifier|*
name|req
init|=
operator|&
name|mpt
operator|->
name|request_pool
index|[
name|index
index|]
decl_stmt|;
name|req
operator|->
name|debug
operator|=
name|REQ_DONE
expr_stmt|;
block|}
name|mpt_free_reply
argument_list|(
name|mpt
argument_list|,
operator|(
name|reply
operator|<<
literal|1
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|dmsg
operator|->
name|Function
operator|==
name|MPI_FUNCTION_CONFIG
condition|)
block|{
name|MSG_CONFIG_REPLY
modifier|*
name|msg
init|=
name|vmsg
decl_stmt|;
name|int
name|index
init|=
name|msg
operator|->
name|MsgContext
operator|&
operator|~
literal|0x80000000
decl_stmt|;
if|if
condition|(
name|index
operator|>=
literal|0
operator|&&
name|index
operator|<
name|MPT_MAX_REQUESTS
argument_list|(
name|mpt
argument_list|)
condition|)
block|{
name|request_t
modifier|*
name|req
init|=
operator|&
name|mpt
operator|->
name|request_pool
index|[
name|index
index|]
decl_stmt|;
name|req
operator|->
name|debug
operator|=
name|REQ_DONE
expr_stmt|;
name|req
operator|->
name|sequence
operator|=
name|reply
expr_stmt|;
block|}
else|else
block|{
name|mpt_free_reply
argument_list|(
name|mpt
argument_list|,
operator|(
name|reply
operator|<<
literal|1
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"unknown mpt_ctlop: %x"
argument_list|,
name|dmsg
operator|->
name|Function
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|mpt_event_notify_reply
parameter_list|(
name|mpt_softc_t
modifier|*
name|mpt
parameter_list|,
name|MSG_EVENT_NOTIFY_REPLY
modifier|*
name|msg
parameter_list|)
block|{
switch|switch
condition|(
name|msg
operator|->
name|Event
condition|)
block|{
case|case
name|MPI_EVENT_LOG_DATA
case|:
comment|/* Some error occured that LSI wants logged */
name|printf
argument_list|(
literal|"\tEvtLogData: IOCLogInfo: 0x%08x\n"
argument_list|,
name|msg
operator|->
name|IOCLogInfo
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tEvtLogData: Event Data:"
argument_list|)
expr_stmt|;
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|msg
operator|->
name|EventDataLength
condition|;
name|i
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"  %08x"
argument_list|,
name|msg
operator|->
name|Data
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|MPI_EVENT_UNIT_ATTENTION
case|:
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"Bus: 0x%02x TargetID: 0x%02x"
argument_list|,
operator|(
name|msg
operator|->
name|Data
index|[
literal|0
index|]
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|,
name|msg
operator|->
name|Data
index|[
literal|0
index|]
operator|&
literal|0xff
argument_list|)
expr_stmt|;
break|break;
case|case
name|MPI_EVENT_IOC_BUS_RESET
case|:
comment|/* We generated a bus reset */
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"IOC Bus Reset Port: %d"
argument_list|,
operator|(
name|msg
operator|->
name|Data
index|[
literal|0
index|]
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
break|break;
case|case
name|MPI_EVENT_EXT_BUS_RESET
case|:
comment|/* Someone else generated a bus reset */
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"Ext Bus Reset"
argument_list|)
expr_stmt|;
comment|/* 		 * These replies don't return EventData like the MPI 		 * spec says they do 		 */
comment|/*		xpt_async(AC_BUS_RESET, path, NULL);  */
break|break;
case|case
name|MPI_EVENT_RESCAN
case|:
comment|/* 		 * In general this means a device has been added 		 * to the loop. 		 */
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"Rescan Port: %d"
argument_list|,
operator|(
name|msg
operator|->
name|Data
index|[
literal|0
index|]
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
comment|/*		xpt_async(AC_FOUND_DEVICE, path, NULL);  */
break|break;
case|case
name|MPI_EVENT_LINK_STATUS_CHANGE
case|:
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"Port %d: LinkState: %s"
argument_list|,
operator|(
name|msg
operator|->
name|Data
index|[
literal|1
index|]
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|,
operator|(
operator|(
name|msg
operator|->
name|Data
index|[
literal|0
index|]
operator|&
literal|0xff
operator|)
operator|==
literal|0
operator|)
condition|?
literal|"Failed"
else|:
literal|"Active"
argument_list|)
expr_stmt|;
break|break;
case|case
name|MPI_EVENT_LOOP_STATE_CHANGE
case|:
switch|switch
condition|(
operator|(
name|msg
operator|->
name|Data
index|[
literal|0
index|]
operator|>>
literal|16
operator|)
operator|&
literal|0xff
condition|)
block|{
case|case
literal|0x01
case|:
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"Port 0x%x: FC LinkEvent: LIP(%02x,%02x) (Loop Initialization)\n"
argument_list|,
operator|(
name|msg
operator|->
name|Data
index|[
literal|1
index|]
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|,
operator|(
name|msg
operator|->
name|Data
index|[
literal|0
index|]
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|,
operator|(
name|msg
operator|->
name|Data
index|[
literal|0
index|]
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
switch|switch
condition|(
operator|(
name|msg
operator|->
name|Data
index|[
literal|0
index|]
operator|>>
literal|8
operator|)
operator|&
literal|0xff
condition|)
block|{
case|case
literal|0xF7
case|:
if|if
condition|(
operator|(
name|msg
operator|->
name|Data
index|[
literal|0
index|]
operator|&
literal|0xff
operator|)
operator|==
literal|0xF7
condition|)
block|{
name|printf
argument_list|(
literal|"Device needs AL_PA\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"Device %02x doesn't like FC performance\n"
argument_list|,
name|msg
operator|->
name|Data
index|[
literal|0
index|]
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|0xF8
case|:
if|if
condition|(
operator|(
name|msg
operator|->
name|Data
index|[
literal|0
index|]
operator|&
literal|0xff
operator|)
operator|==
literal|0xF7
condition|)
block|{
name|printf
argument_list|(
literal|"Device had loop failure at its receiver prior to acquiring AL_PA\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"Device %02x detected loop failure at its receiver\n"
argument_list|,
name|msg
operator|->
name|Data
index|[
literal|0
index|]
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|printf
argument_list|(
literal|"Device %02x requests that device %02x reset itself\n"
argument_list|,
name|msg
operator|->
name|Data
index|[
literal|0
index|]
operator|&
literal|0xFF
argument_list|,
operator|(
name|msg
operator|->
name|Data
index|[
literal|0
index|]
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|0x02
case|:
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"Port 0x%x: FC LinkEvent: LPE(%02x,%02x) (Loop Port Enable)"
argument_list|,
operator|(
name|msg
operator|->
name|Data
index|[
literal|1
index|]
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|,
comment|/* Port */
operator|(
name|msg
operator|->
name|Data
index|[
literal|0
index|]
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|,
comment|/* Character 3 */
operator|(
name|msg
operator|->
name|Data
index|[
literal|0
index|]
operator|)
operator|&
literal|0xff
comment|/* Character 4 */
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x03
case|:
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"Port 0x%x: FC LinkEvent: LPB(%02x,%02x) (Loop Port Bypass)"
argument_list|,
operator|(
name|msg
operator|->
name|Data
index|[
literal|1
index|]
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|,
comment|/* Port */
operator|(
name|msg
operator|->
name|Data
index|[
literal|0
index|]
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|,
comment|/* Character 3 */
operator|(
name|msg
operator|->
name|Data
index|[
literal|0
index|]
operator|)
operator|&
literal|0xff
comment|/* Character 4 */
argument_list|)
expr_stmt|;
break|break;
default|default:
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"Port 0x%x: FC LinkEvent: Unknown FC event (%02x %02x %02x)"
argument_list|,
operator|(
name|msg
operator|->
name|Data
index|[
literal|1
index|]
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|,
comment|/* Port */
operator|(
name|msg
operator|->
name|Data
index|[
literal|0
index|]
operator|>>
literal|16
operator|)
operator|&
literal|0xff
argument_list|,
comment|/* Event */
operator|(
name|msg
operator|->
name|Data
index|[
literal|0
index|]
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|,
comment|/* Character 3 */
operator|(
name|msg
operator|->
name|Data
index|[
literal|0
index|]
operator|)
operator|&
literal|0xff
comment|/* Character 4 */
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|MPI_EVENT_LOGOUT
case|:
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"FC Logout Port: %d N_PortID: %02x"
argument_list|,
operator|(
name|msg
operator|->
name|Data
index|[
literal|1
index|]
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|,
name|msg
operator|->
name|Data
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|MPI_EVENT_EVENT_CHANGE
case|:
comment|/* This is just an acknowledgement of our  		   mpt_send_event_request */
break|break;
default|default:
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"Unknown event 0x%x\n"
argument_list|,
name|msg
operator|->
name|Event
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|msg
operator|->
name|AckRequired
condition|)
block|{
name|MSG_EVENT_ACK
modifier|*
name|ackp
decl_stmt|;
name|request_t
modifier|*
name|req
decl_stmt|;
if|if
condition|(
operator|(
name|req
operator|=
name|mpt_get_request
argument_list|(
name|mpt
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|panic
argument_list|(
literal|"unable to get request to acknowledge notify"
argument_list|)
expr_stmt|;
block|}
name|ackp
operator|=
operator|(
name|MSG_EVENT_ACK
operator|*
operator|)
name|req
operator|->
name|req_vbuf
expr_stmt|;
name|bzero
argument_list|(
name|ackp
argument_list|,
sizeof|sizeof
expr|*
name|ackp
argument_list|)
expr_stmt|;
name|ackp
operator|->
name|Function
operator|=
name|MPI_FUNCTION_EVENT_ACK
expr_stmt|;
name|ackp
operator|->
name|Event
operator|=
name|msg
operator|->
name|Event
expr_stmt|;
name|ackp
operator|->
name|EventContext
operator|=
name|msg
operator|->
name|EventContext
expr_stmt|;
name|ackp
operator|->
name|MsgContext
operator|=
name|req
operator|->
name|index
operator||
literal|0x80000000
expr_stmt|;
name|mpt_check_doorbell
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
name|mpt_send_cmd
argument_list|(
name|mpt
argument_list|,
name|req
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|mpt_done
parameter_list|(
name|mpt_softc_t
modifier|*
name|mpt
parameter_list|,
name|u_int32_t
name|reply
parameter_list|)
block|{
name|int
name|index
decl_stmt|;
name|request_t
modifier|*
name|req
decl_stmt|;
name|union
name|ccb
modifier|*
name|ccb
decl_stmt|;
name|MSG_REQUEST_HEADER
modifier|*
name|mpt_req
decl_stmt|;
name|MSG_SCSI_IO_REPLY
modifier|*
name|mpt_reply
decl_stmt|;
name|index
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* Shutup the complier */
if|if
condition|(
operator|(
name|reply
operator|&
name|MPT_CONTEXT_REPLY
operator|)
operator|==
literal|0
condition|)
block|{
comment|/* context reply */
name|mpt_reply
operator|=
name|NULL
expr_stmt|;
name|index
operator|=
name|reply
operator|&
name|MPT_CONTEXT_MASK
expr_stmt|;
block|}
else|else
block|{
name|unsigned
modifier|*
name|pReply
decl_stmt|;
name|bus_dmamap_sync
argument_list|(
name|mpt
operator|->
name|reply_dmat
argument_list|,
name|mpt
operator|->
name|reply_dmap
argument_list|,
name|BUS_DMASYNC_POSTREAD
argument_list|)
expr_stmt|;
comment|/* address reply (Error) */
name|mpt_reply
operator|=
name|MPT_REPLY_PTOV
argument_list|(
name|mpt
argument_list|,
name|reply
argument_list|)
expr_stmt|;
if|if
condition|(
name|mpt
operator|->
name|verbose
operator|>
literal|1
condition|)
block|{
name|pReply
operator|=
operator|(
name|unsigned
operator|*
operator|)
name|mpt_reply
expr_stmt|;
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"Address Reply (index %u)"
argument_list|,
name|mpt_reply
operator|->
name|MsgContext
operator|&
literal|0xffff
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%08x %08x %08x %08x\n"
argument_list|,
name|pReply
index|[
literal|0
index|]
argument_list|,
name|pReply
index|[
literal|1
index|]
argument_list|,
name|pReply
index|[
literal|2
index|]
argument_list|,
name|pReply
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%08x %08x %08x %08x\n"
argument_list|,
name|pReply
index|[
literal|4
index|]
argument_list|,
name|pReply
index|[
literal|5
index|]
argument_list|,
name|pReply
index|[
literal|6
index|]
argument_list|,
name|pReply
index|[
literal|7
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%08x %08x %08x %08x\n\n"
argument_list|,
name|pReply
index|[
literal|8
index|]
argument_list|,
name|pReply
index|[
literal|9
index|]
argument_list|,
name|pReply
index|[
literal|10
index|]
argument_list|,
name|pReply
index|[
literal|11
index|]
argument_list|)
expr_stmt|;
block|}
name|index
operator|=
name|mpt_reply
operator|->
name|MsgContext
expr_stmt|;
block|}
comment|/* 	 * Address reply with MessageContext high bit set 	 * This is most likely a notify message so we try 	 * to process it then free it 	 */
if|if
condition|(
operator|(
name|index
operator|&
literal|0x80000000
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|mpt_reply
operator|!=
name|NULL
condition|)
block|{
name|mpt_ctlop
argument_list|(
name|mpt
argument_list|,
name|mpt_reply
argument_list|,
name|reply
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"mpt_done: index 0x%x, NULL reply"
argument_list|,
name|index
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
comment|/* Did we end up with a valid index into the table? */
if|if
condition|(
name|index
operator|<
literal|0
operator|||
name|index
operator|>=
name|MPT_MAX_REQUESTS
argument_list|(
name|mpt
argument_list|)
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"mpt_done: invalid index (%x) in reply"
argument_list|,
name|index
argument_list|)
expr_stmt|;
return|return;
block|}
name|req
operator|=
operator|&
name|mpt
operator|->
name|request_pool
index|[
name|index
index|]
expr_stmt|;
comment|/* Make sure memory hasn't been trashed */
if|if
condition|(
name|req
operator|->
name|index
operator|!=
name|index
condition|)
block|{
name|printf
argument_list|(
literal|"mpt_done: corrupted request struct"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Short cut for task management replys; nothing more for us to do */
name|mpt_req
operator|=
name|req
operator|->
name|req_vbuf
expr_stmt|;
if|if
condition|(
name|mpt_req
operator|->
name|Function
operator|==
name|MPI_FUNCTION_SCSI_TASK_MGMT
condition|)
block|{
if|if
condition|(
name|mpt
operator|->
name|verbose
operator|>
literal|1
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"mpt_done: TASK MGMT"
argument_list|)
expr_stmt|;
block|}
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|mpt_req
operator|->
name|Function
operator|==
name|MPI_FUNCTION_PORT_ENABLE
condition|)
block|{
goto|goto
name|done
goto|;
block|}
comment|/* 	 * At this point it better be a SCSI IO command, but don't 	 * crash if it isn't 	 */
if|if
condition|(
name|mpt_req
operator|->
name|Function
operator|!=
name|MPI_FUNCTION_SCSI_IO_REQUEST
condition|)
block|{
goto|goto
name|done
goto|;
block|}
comment|/* Recover the CAM control block from the request structure */
name|ccb
operator|=
name|req
operator|->
name|ccb
expr_stmt|;
comment|/* Can't have had a SCSI command with out a CAM control block */
if|if
condition|(
name|ccb
operator|==
name|NULL
operator|||
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|&
name|CAM_SIM_QUEUED
operator|)
operator|==
literal|0
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"mpt_done: corrupted ccb, index = 0x%02x seq = 0x%08x"
argument_list|,
name|req
operator|->
name|index
argument_list|,
name|req
operator|->
name|sequence
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" request state %s\nmpt_request:\n"
argument_list|,
name|mpt_req_state
argument_list|(
name|req
operator|->
name|debug
argument_list|)
argument_list|)
expr_stmt|;
name|mpt_print_scsi_io_request
argument_list|(
operator|(
name|MSG_SCSI_IO_REQUEST
operator|*
operator|)
name|req
operator|->
name|req_vbuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|mpt_reply
operator|!=
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"\nmpt_done: reply:\n"
argument_list|)
expr_stmt|;
name|mpt_print_reply
argument_list|(
name|MPT_REPLY_PTOV
argument_list|(
name|mpt
argument_list|,
name|reply
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"\nmpt_done: context reply: 0x%08x\n"
argument_list|,
name|reply
argument_list|)
expr_stmt|;
block|}
goto|goto
name|done
goto|;
block|}
name|untimeout
argument_list|(
name|mpttimeout
argument_list|,
name|ccb
argument_list|,
name|ccb
operator|->
name|ccb_h
operator|.
name|timeout_ch
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_DIR_MASK
operator|)
operator|!=
name|CAM_DIR_NONE
condition|)
block|{
name|bus_dmasync_op_t
name|op
decl_stmt|;
if|if
condition|(
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_DIR_MASK
operator|)
operator|==
name|CAM_DIR_IN
condition|)
block|{
name|op
operator|=
name|BUS_DMASYNC_POSTREAD
expr_stmt|;
block|}
else|else
block|{
name|op
operator|=
name|BUS_DMASYNC_POSTWRITE
expr_stmt|;
block|}
name|bus_dmamap_sync
argument_list|(
name|mpt
operator|->
name|buffer_dmat
argument_list|,
name|req
operator|->
name|dmap
argument_list|,
name|op
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|mpt
operator|->
name|buffer_dmat
argument_list|,
name|req
operator|->
name|dmap
argument_list|)
expr_stmt|;
block|}
name|ccb
operator|->
name|csio
operator|.
name|resid
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|mpt_reply
operator|==
name|NULL
condition|)
block|{
comment|/* Context reply; report that the command was successfull */
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_CMP
expr_stmt|;
name|ccb
operator|->
name|csio
operator|.
name|scsi_status
operator|=
name|SCSI_STATUS_OK
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|&=
operator|~
name|CAM_SIM_QUEUED
expr_stmt|;
if|if
condition|(
name|mpt
operator|->
name|outofbeer
condition|)
block|{
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator||=
name|CAM_RELEASE_SIMQ
expr_stmt|;
name|mpt
operator|->
name|outofbeer
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|mpt
operator|->
name|verbose
operator|>
literal|1
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"THAWQ"
argument_list|)
expr_stmt|;
block|}
block|}
name|MPTLOCK_2_CAMLOCK
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
name|CAMLOCK_2_MPTLOCK
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|ccb
operator|->
name|csio
operator|.
name|scsi_status
operator|=
name|mpt_reply
operator|->
name|SCSIStatus
expr_stmt|;
switch|switch
condition|(
name|mpt_reply
operator|->
name|IOCStatus
condition|)
block|{
case|case
name|MPI_IOCSTATUS_SCSI_DATA_OVERRUN
case|:
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_DATA_RUN_ERR
expr_stmt|;
break|break;
case|case
name|MPI_IOCSTATUS_SCSI_DATA_UNDERRUN
case|:
comment|/* 		 * Yikes, Tagged queue full comes through this path! 		 * 		 * So we'll change it to a status error and anything 		 * that returns status should probably be a status  		 * error as well. 		 */
name|ccb
operator|->
name|csio
operator|.
name|resid
operator|=
name|ccb
operator|->
name|csio
operator|.
name|dxfer_len
operator|-
name|mpt_reply
operator|->
name|TransferCount
expr_stmt|;
if|if
condition|(
name|mpt_reply
operator|->
name|SCSIState
operator|&
name|MPI_SCSI_STATE_NO_SCSI_STATUS
condition|)
block|{
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_DATA_RUN_ERR
expr_stmt|;
break|break;
block|}
comment|/* Fall through */
case|case
name|MPI_IOCSTATUS_SUCCESS
case|:
case|case
name|MPI_IOCSTATUS_SCSI_RECOVERED_ERROR
case|:
switch|switch
condition|(
name|ccb
operator|->
name|csio
operator|.
name|scsi_status
condition|)
block|{
case|case
name|SCSI_STATUS_OK
case|:
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_CMP
expr_stmt|;
break|break;
default|default:
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_SCSI_STATUS_ERROR
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|MPI_IOCSTATUS_BUSY
case|:
case|case
name|MPI_IOCSTATUS_INSUFFICIENT_RESOURCES
case|:
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_BUSY
expr_stmt|;
break|break;
case|case
name|MPI_IOCSTATUS_SCSI_INVALID_BUS
case|:
case|case
name|MPI_IOCSTATUS_SCSI_INVALID_TARGETID
case|:
case|case
name|MPI_IOCSTATUS_SCSI_DEVICE_NOT_THERE
case|:
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_DEV_NOT_THERE
expr_stmt|;
break|break;
case|case
name|MPI_IOCSTATUS_SCSI_RESIDUAL_MISMATCH
case|:
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_DATA_RUN_ERR
expr_stmt|;
break|break;
case|case
name|MPI_IOCSTATUS_SCSI_PROTOCOL_ERROR
case|:
case|case
name|MPI_IOCSTATUS_SCSI_IO_DATA_ERROR
case|:
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_UNCOR_PARITY
expr_stmt|;
break|break;
case|case
name|MPI_IOCSTATUS_SCSI_TASK_TERMINATED
case|:
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_CMP
expr_stmt|;
break|break;
case|case
name|MPI_IOCSTATUS_SCSI_TASK_MGMT_FAILED
case|:
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_UA_TERMIO
expr_stmt|;
break|break;
case|case
name|MPI_IOCSTATUS_SCSI_IOC_TERMINATED
case|:
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_TERMIO
expr_stmt|;
break|break;
case|case
name|MPI_IOCSTATUS_SCSI_EXT_TERMINATED
case|:
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_SCSI_BUS_RESET
expr_stmt|;
break|break;
default|default:
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_UNREC_HBA_ERROR
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|(
name|mpt_reply
operator|->
name|SCSIState
operator|&
name|MPI_SCSI_STATE_AUTOSENSE_VALID
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
operator|(
name|CAM_SENSE_PHYS
operator||
name|CAM_SENSE_PTR
operator|)
condition|)
block|{
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator||=
name|CAM_AUTOSENSE_FAIL
expr_stmt|;
block|}
else|else
block|{
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator||=
name|CAM_AUTOSNS_VALID
expr_stmt|;
name|ccb
operator|->
name|csio
operator|.
name|sense_resid
operator|=
name|mpt_reply
operator|->
name|SenseCount
expr_stmt|;
name|bcopy
argument_list|(
name|req
operator|->
name|sense_vbuf
argument_list|,
operator|&
name|ccb
operator|->
name|csio
operator|.
name|sense_data
argument_list|,
name|ccb
operator|->
name|csio
operator|.
name|sense_len
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|mpt_reply
operator|->
name|SCSIState
operator|&
name|MPI_SCSI_STATE_AUTOSENSE_FAILED
condition|)
block|{
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|&=
operator|~
name|CAM_STATUS_MASK
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator||=
name|CAM_AUTOSENSE_FAIL
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|&
name|CAM_STATUS_MASK
operator|)
operator|!=
name|CAM_REQ_CMP
condition|)
block|{
if|if
condition|(
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|&
name|CAM_DEV_QFRZN
operator|)
operator|==
literal|0
condition|)
block|{
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator||=
name|CAM_DEV_QFRZN
expr_stmt|;
name|xpt_freeze_devq
argument_list|(
name|ccb
operator|->
name|ccb_h
operator|.
name|path
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|&=
operator|~
name|CAM_SIM_QUEUED
expr_stmt|;
if|if
condition|(
name|mpt
operator|->
name|outofbeer
condition|)
block|{
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator||=
name|CAM_RELEASE_SIMQ
expr_stmt|;
name|mpt
operator|->
name|outofbeer
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|mpt
operator|->
name|verbose
operator|>
literal|1
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"THAWQ"
argument_list|)
expr_stmt|;
block|}
block|}
name|MPTLOCK_2_CAMLOCK
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
name|CAMLOCK_2_MPTLOCK
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
name|done
label|:
comment|/* If IOC done with this request free it up */
if|if
condition|(
name|mpt_reply
operator|==
name|NULL
operator|||
operator|(
name|mpt_reply
operator|->
name|MsgFlags
operator|&
literal|0x80
operator|)
operator|==
literal|0
condition|)
name|mpt_free_request
argument_list|(
name|mpt
argument_list|,
name|req
argument_list|)
expr_stmt|;
comment|/* If address reply; give the buffer back to the IOC */
if|if
condition|(
name|mpt_reply
operator|!=
name|NULL
condition|)
name|mpt_free_reply
argument_list|(
name|mpt
argument_list|,
operator|(
name|reply
operator|<<
literal|1
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mpt_action
parameter_list|(
name|struct
name|cam_sim
modifier|*
name|sim
parameter_list|,
name|union
name|ccb
modifier|*
name|ccb
parameter_list|)
block|{
name|int
name|tgt
decl_stmt|,
name|error
decl_stmt|;
name|mpt_softc_t
modifier|*
name|mpt
decl_stmt|;
name|struct
name|ccb_trans_settings
modifier|*
name|cts
decl_stmt|;
name|CAM_DEBUG
argument_list|(
name|ccb
operator|->
name|ccb_h
operator|.
name|path
argument_list|,
name|CAM_DEBUG_TRACE
argument_list|,
operator|(
literal|"mpt_action\n"
operator|)
argument_list|)
expr_stmt|;
name|mpt
operator|=
operator|(
name|mpt_softc_t
operator|*
operator|)
name|cam_sim_softc
argument_list|(
name|sim
argument_list|)
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|ccb_mpt_ptr
operator|=
name|mpt
expr_stmt|;
switch|switch
condition|(
name|ccb
operator|->
name|ccb_h
operator|.
name|func_code
condition|)
block|{
case|case
name|XPT_RESET_BUS
case|:
if|if
condition|(
name|mpt
operator|->
name|verbose
operator|>
literal|1
condition|)
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"XPT_RESET_BUS"
argument_list|)
expr_stmt|;
name|CAMLOCK_2_MPTLOCK
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
name|error
operator|=
name|mpt_bus_reset
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|error
condition|)
block|{
case|case
name|CAM_REQ_INPROG
case|:
name|MPTLOCK_2_CAMLOCK
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
break|break;
case|case
name|CAM_REQUEUE_REQ
case|:
if|if
condition|(
name|mpt
operator|->
name|outofbeer
operator|==
literal|0
condition|)
block|{
name|mpt
operator|->
name|outofbeer
operator|=
literal|1
expr_stmt|;
name|xpt_freeze_simq
argument_list|(
name|sim
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|mpt
operator|->
name|verbose
operator|>
literal|1
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"FREEZEQ"
argument_list|)
expr_stmt|;
block|}
block|}
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQUEUE_REQ
expr_stmt|;
name|MPTLOCK_2_CAMLOCK
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
break|break;
case|case
name|CAM_REQ_CMP
case|:
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|&=
operator|~
name|CAM_SIM_QUEUED
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator||=
name|CAM_REQ_CMP
expr_stmt|;
if|if
condition|(
name|mpt
operator|->
name|outofbeer
condition|)
block|{
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator||=
name|CAM_RELEASE_SIMQ
expr_stmt|;
name|mpt
operator|->
name|outofbeer
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|mpt
operator|->
name|verbose
operator|>
literal|1
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"THAWQ"
argument_list|)
expr_stmt|;
block|}
block|}
name|MPTLOCK_2_CAMLOCK
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
break|break;
default|default:
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_CMP_ERR
expr_stmt|;
name|MPTLOCK_2_CAMLOCK
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|XPT_SCSI_IO
case|:
comment|/* Execute the requested I/O operation */
comment|/* 		 * Do a couple of preliminary checks... 		 */
if|if
condition|(
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_CDB_POINTER
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_CDB_PHYS
operator|)
operator|!=
literal|0
condition|)
block|{
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_INVALID
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
comment|/* Max supported CDB length is 16 bytes */
if|if
condition|(
name|ccb
operator|->
name|csio
operator|.
name|cdb_len
operator|>
sizeof|sizeof
argument_list|(
operator|(
operator|(
name|PTR_MSG_SCSI_IO_REQUEST
operator|)
literal|0
operator|)
operator|->
name|CDB
argument_list|)
condition|)
block|{
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_INVALID
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
return|return;
block|}
name|ccb
operator|->
name|csio
operator|.
name|scsi_status
operator|=
name|SCSI_STATUS_OK
expr_stmt|;
name|mpt_start
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
break|break;
case|case
name|XPT_ABORT
case|:
comment|/* 		 * XXX: Need to implement 		 */
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_UA_ABORT
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|CAM_NEW_TRAN_CODE
define|#
directive|define
name|IS_CURRENT_SETTINGS
parameter_list|(
name|c
parameter_list|)
value|(c->type == CTS_TYPE_CURRENT_SETTINGS)
else|#
directive|else
define|#
directive|define
name|IS_CURRENT_SETTINGS
parameter_list|(
name|c
parameter_list|)
value|(c->flags& CCB_TRANS_CURRENT_SETTINGS)
endif|#
directive|endif
define|#
directive|define
name|DP_DISC_ENABLE
value|0x1
define|#
directive|define
name|DP_DISC_DISABL
value|0x2
define|#
directive|define
name|DP_DISC
value|(DP_DISC_ENABLE|DP_DISC_DISABL)
define|#
directive|define
name|DP_TQING_ENABLE
value|0x4
define|#
directive|define
name|DP_TQING_DISABL
value|0x8
define|#
directive|define
name|DP_TQING
value|(DP_TQING_ENABLE|DP_TQING_DISABL)
define|#
directive|define
name|DP_WIDE
value|0x10
define|#
directive|define
name|DP_NARROW
value|0x20
define|#
directive|define
name|DP_WIDTH
value|(DP_WIDE|DP_NARROW)
define|#
directive|define
name|DP_SYNC
value|0x40
case|case
name|XPT_SET_TRAN_SETTINGS
case|:
comment|/* Nexus Settings */
name|cts
operator|=
operator|&
name|ccb
operator|->
name|cts
expr_stmt|;
if|if
condition|(
operator|!
name|IS_CURRENT_SETTINGS
argument_list|(
name|cts
argument_list|)
condition|)
block|{
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_INVALID
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
break|break;
block|}
name|tgt
operator|=
name|cts
operator|->
name|ccb_h
operator|.
name|target_id
expr_stmt|;
if|if
condition|(
name|mpt
operator|->
name|is_fc
operator|==
literal|0
condition|)
block|{
name|u_int8_t
name|dval
init|=
literal|0
decl_stmt|;
name|u_int
name|period
init|=
literal|0
decl_stmt|,
name|offset
init|=
literal|0
decl_stmt|;
ifndef|#
directive|ifndef
name|CAM_NEW_TRAN_CODE
if|if
condition|(
name|cts
operator|->
name|valid
operator|&
name|CCB_TRANS_DISC_VALID
condition|)
block|{
name|dval
operator||=
name|DP_DISC_ENABLE
expr_stmt|;
block|}
if|if
condition|(
name|cts
operator|->
name|valid
operator|&
name|CCB_TRANS_TQ_VALID
condition|)
block|{
name|dval
operator||=
name|DP_TQING_ENABLE
expr_stmt|;
block|}
if|if
condition|(
name|cts
operator|->
name|valid
operator|&
name|CCB_TRANS_BUS_WIDTH_VALID
condition|)
block|{
if|if
condition|(
name|cts
operator|->
name|bus_width
condition|)
name|dval
operator||=
name|DP_WIDE
expr_stmt|;
else|else
name|dval
operator||=
name|DP_NARROW
expr_stmt|;
block|}
comment|/* 			 * Any SYNC RATE of nonzero and SYNC_OFFSET 			 * of nonzero will cause us to go to the 			 * selected (from NVRAM) maximum value for 			 * this device. At a later point, we'll 			 * allow finer control. 			 */
if|if
condition|(
operator|(
name|cts
operator|->
name|valid
operator|&
name|CCB_TRANS_SYNC_RATE_VALID
operator|)
operator|&&
operator|(
name|cts
operator|->
name|valid
operator|&
name|CCB_TRANS_SYNC_OFFSET_VALID
operator|)
condition|)
block|{
name|dval
operator||=
name|DP_SYNC
expr_stmt|;
name|period
operator|=
name|cts
operator|->
name|sync_period
expr_stmt|;
name|offset
operator|=
name|cts
operator|->
name|sync_offset
expr_stmt|;
block|}
else|#
directive|else
name|struct
name|ccb_trans_settings_scsi
modifier|*
name|scsi
init|=
operator|&
name|cts
operator|->
name|proto_specific
operator|.
name|scsi
decl_stmt|;
name|struct
name|ccb_trans_settings_spi
modifier|*
name|spi
init|=
operator|&
name|cts
operator|->
name|xport_specific
operator|.
name|spi
decl_stmt|;
if|if
condition|(
operator|(
name|spi
operator|->
name|valid
operator|&
name|CTS_SPI_VALID_DISC
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|spi
operator|->
name|flags
operator|&
name|CTS_SPI_FLAGS_DISC_ENB
operator|)
operator|!=
literal|0
condition|)
name|dval
operator||=
name|DP_DISC_ENABLE
expr_stmt|;
else|else
name|dval
operator||=
name|DP_DISC_DISABL
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|scsi
operator|->
name|valid
operator|&
name|CTS_SCSI_VALID_TQ
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|scsi
operator|->
name|flags
operator|&
name|CTS_SCSI_FLAGS_TAG_ENB
operator|)
operator|!=
literal|0
condition|)
name|dval
operator||=
name|DP_TQING_ENABLE
expr_stmt|;
else|else
name|dval
operator||=
name|DP_TQING_DISABL
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|spi
operator|->
name|valid
operator|&
name|CTS_SPI_VALID_BUS_WIDTH
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|spi
operator|->
name|bus_width
operator|==
name|MSG_EXT_WDTR_BUS_16_BIT
condition|)
name|dval
operator||=
name|DP_WIDE
expr_stmt|;
else|else
name|dval
operator||=
name|DP_NARROW
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|spi
operator|->
name|valid
operator|&
name|CTS_SPI_VALID_SYNC_OFFSET
operator|)
operator|&&
operator|(
name|spi
operator|->
name|valid
operator|&
name|CTS_SPI_VALID_SYNC_RATE
operator|)
operator|&&
operator|(
name|spi
operator|->
name|sync_period
operator|&&
name|spi
operator|->
name|sync_offset
operator|)
condition|)
block|{
name|dval
operator||=
name|DP_SYNC
expr_stmt|;
name|period
operator|=
name|spi
operator|->
name|sync_period
expr_stmt|;
name|offset
operator|=
name|spi
operator|->
name|sync_offset
expr_stmt|;
block|}
endif|#
directive|endif
name|CAMLOCK_2_MPTLOCK
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
if|if
condition|(
name|dval
operator|&
name|DP_DISC_ENABLE
condition|)
block|{
name|mpt
operator|->
name|mpt_disc_enable
operator||=
operator|(
literal|1
operator|<<
name|tgt
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|dval
operator|&
name|DP_DISC_DISABL
condition|)
block|{
name|mpt
operator|->
name|mpt_disc_enable
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|tgt
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|dval
operator|&
name|DP_TQING_ENABLE
condition|)
block|{
name|mpt
operator|->
name|mpt_tag_enable
operator||=
operator|(
literal|1
operator|<<
name|tgt
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|dval
operator|&
name|DP_TQING_DISABL
condition|)
block|{
name|mpt
operator|->
name|mpt_tag_enable
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|tgt
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|dval
operator|&
name|DP_WIDTH
condition|)
block|{
if|if
condition|(
name|mpt_setwidth
argument_list|(
name|mpt
argument_list|,
name|tgt
argument_list|,
name|dval
operator|&
name|DP_WIDE
argument_list|)
condition|)
block|{
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_CMP_ERR
expr_stmt|;
name|MPTLOCK_2_CAMLOCK
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|dval
operator|&
name|DP_SYNC
condition|)
block|{
if|if
condition|(
name|mpt_setsync
argument_list|(
name|mpt
argument_list|,
name|tgt
argument_list|,
name|period
argument_list|,
name|offset
argument_list|)
condition|)
block|{
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_CMP_ERR
expr_stmt|;
name|MPTLOCK_2_CAMLOCK
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|MPTLOCK_2_CAMLOCK
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
if|if
condition|(
name|mpt
operator|->
name|verbose
operator|>
literal|1
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"SET tgt %d flags %x period %x off %x"
argument_list|,
name|tgt
argument_list|,
name|dval
argument_list|,
name|period
argument_list|,
name|offset
argument_list|)
expr_stmt|;
block|}
block|}
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_CMP
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
break|break;
case|case
name|XPT_GET_TRAN_SETTINGS
case|:
name|cts
operator|=
operator|&
name|ccb
operator|->
name|cts
expr_stmt|;
name|tgt
operator|=
name|cts
operator|->
name|ccb_h
operator|.
name|target_id
expr_stmt|;
if|if
condition|(
name|mpt
operator|->
name|is_fc
condition|)
block|{
ifndef|#
directive|ifndef
name|CAM_NEW_TRAN_CODE
comment|/* 			 * a lot of normal SCSI things don't make sense. 			 */
name|cts
operator|->
name|flags
operator|=
name|CCB_TRANS_TAG_ENB
operator||
name|CCB_TRANS_DISC_ENB
expr_stmt|;
name|cts
operator|->
name|valid
operator|=
name|CCB_TRANS_DISC_VALID
operator||
name|CCB_TRANS_TQ_VALID
expr_stmt|;
comment|/* 			 * How do you measure the width of a high 			 * speed serial bus? Well, in bytes. 			 * 			 * Offset and period make no sense, though, so we set 			 * (above) a 'base' transfer speed to be gigabit. 			 */
name|cts
operator|->
name|bus_width
operator|=
name|MSG_EXT_WDTR_BUS_8_BIT
expr_stmt|;
else|#
directive|else
name|struct
name|ccb_trans_settings_fc
modifier|*
name|fc
init|=
operator|&
name|cts
operator|->
name|xport_specific
operator|.
name|fc
decl_stmt|;
name|cts
operator|->
name|protocol
operator|=
name|PROTO_SCSI
expr_stmt|;
name|cts
operator|->
name|protocol_version
operator|=
name|SCSI_REV_2
expr_stmt|;
name|cts
operator|->
name|transport
operator|=
name|XPORT_FC
expr_stmt|;
name|cts
operator|->
name|transport_version
operator|=
literal|0
expr_stmt|;
name|fc
operator|->
name|valid
operator|=
name|CTS_FC_VALID_SPEED
expr_stmt|;
name|fc
operator|->
name|bitrate
operator|=
literal|100000
expr_stmt|;
comment|/* XXX: Need for 2Gb/s */
comment|/* XXX: need a port database for each target */
endif|#
directive|endif
block|}
else|else
block|{
ifdef|#
directive|ifdef
name|CAM_NEW_TRAN_CODE
name|struct
name|ccb_trans_settings_scsi
modifier|*
name|scsi
init|=
operator|&
name|cts
operator|->
name|proto_specific
operator|.
name|scsi
decl_stmt|;
name|struct
name|ccb_trans_settings_spi
modifier|*
name|spi
init|=
operator|&
name|cts
operator|->
name|xport_specific
operator|.
name|spi
decl_stmt|;
endif|#
directive|endif
name|u_int8_t
name|dval
decl_stmt|,
name|pval
decl_stmt|,
name|oval
decl_stmt|;
comment|/* 			 * We aren't going off of Port PAGE2 params for 			 * tagged queuing or disconnect capabilities 			 * for current settings. For goal settings, 			 * we assert all capabilities- we've had some 			 * problems with reading NVRAM data. 			 */
if|if
condition|(
name|IS_CURRENT_SETTINGS
argument_list|(
name|cts
argument_list|)
condition|)
block|{
name|CONFIG_PAGE_SCSI_DEVICE_0
name|tmp
decl_stmt|;
name|dval
operator|=
literal|0
expr_stmt|;
name|tmp
operator|=
name|mpt
operator|->
name|mpt_dev_page0
index|[
name|tgt
index|]
expr_stmt|;
name|CAMLOCK_2_MPTLOCK
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
if|if
condition|(
name|mpt_read_cfg_page
argument_list|(
name|mpt
argument_list|,
name|tgt
argument_list|,
operator|&
name|tmp
operator|.
name|Header
argument_list|)
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"cannot get target %d DP0"
argument_list|,
name|tgt
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|mpt
operator|->
name|verbose
operator|>
literal|1
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"SPI Tgt %d Page 0: NParms %x Information %x"
argument_list|,
name|tgt
argument_list|,
name|tmp
operator|.
name|NegotiatedParameters
argument_list|,
name|tmp
operator|.
name|Information
argument_list|)
expr_stmt|;
block|}
block|}
name|MPTLOCK_2_CAMLOCK
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|.
name|NegotiatedParameters
operator|&
name|MPI_SCSIDEVPAGE0_NP_WIDE
condition|)
name|dval
operator||=
name|DP_WIDE
expr_stmt|;
if|if
condition|(
name|mpt
operator|->
name|mpt_disc_enable
operator|&
operator|(
literal|1
operator|<<
name|tgt
operator|)
condition|)
block|{
name|dval
operator||=
name|DP_DISC_ENABLE
expr_stmt|;
block|}
if|if
condition|(
name|mpt
operator|->
name|mpt_tag_enable
operator|&
operator|(
literal|1
operator|<<
name|tgt
operator|)
condition|)
block|{
name|dval
operator||=
name|DP_TQING_ENABLE
expr_stmt|;
block|}
name|oval
operator|=
operator|(
name|tmp
operator|.
name|NegotiatedParameters
operator|>>
literal|16
operator|)
operator|&
literal|0xff
expr_stmt|;
name|pval
operator|=
operator|(
name|tmp
operator|.
name|NegotiatedParameters
operator|>>
literal|8
operator|)
operator|&
literal|0xff
expr_stmt|;
block|}
else|else
block|{
comment|/* 				 * XXX: Fix wrt NVRAM someday. Attempts 				 * XXX: to read port page2 device data 				 * XXX: just returns zero in these areas. 				 */
name|dval
operator|=
name|DP_WIDE
operator||
name|DP_DISC
operator||
name|DP_TQING
expr_stmt|;
name|oval
operator|=
operator|(
name|mpt
operator|->
name|mpt_port_page0
operator|.
name|Capabilities
operator|>>
literal|16
operator|)
expr_stmt|;
name|pval
operator|=
operator|(
name|mpt
operator|->
name|mpt_port_page0
operator|.
name|Capabilities
operator|>>
literal|8
operator|)
expr_stmt|;
block|}
ifndef|#
directive|ifndef
name|CAM_NEW_TRAN_CODE
name|cts
operator|->
name|flags
operator|&=
operator|~
operator|(
name|CCB_TRANS_DISC_ENB
operator||
name|CCB_TRANS_TAG_ENB
operator|)
expr_stmt|;
if|if
condition|(
name|dval
operator|&
name|DP_DISC_ENABLE
condition|)
block|{
name|cts
operator|->
name|flags
operator||=
name|CCB_TRANS_DISC_ENB
expr_stmt|;
block|}
if|if
condition|(
name|dval
operator|&
name|DP_TQING_ENABLE
condition|)
block|{
name|cts
operator|->
name|flags
operator||=
name|CCB_TRANS_TAG_ENB
expr_stmt|;
block|}
if|if
condition|(
name|dval
operator|&
name|DP_WIDE
condition|)
block|{
name|cts
operator|->
name|bus_width
operator|=
name|MSG_EXT_WDTR_BUS_16_BIT
expr_stmt|;
block|}
else|else
block|{
name|cts
operator|->
name|bus_width
operator|=
name|MSG_EXT_WDTR_BUS_8_BIT
expr_stmt|;
block|}
name|cts
operator|->
name|valid
operator|=
name|CCB_TRANS_BUS_WIDTH_VALID
operator||
name|CCB_TRANS_DISC_VALID
operator||
name|CCB_TRANS_TQ_VALID
expr_stmt|;
if|if
condition|(
name|oval
condition|)
block|{
name|cts
operator|->
name|sync_period
operator|=
name|pval
expr_stmt|;
name|cts
operator|->
name|sync_offset
operator|=
name|oval
expr_stmt|;
name|cts
operator|->
name|valid
operator||=
name|CCB_TRANS_SYNC_RATE_VALID
operator||
name|CCB_TRANS_SYNC_OFFSET_VALID
expr_stmt|;
block|}
else|#
directive|else
name|cts
operator|->
name|protocol
operator|=
name|PROTO_SCSI
expr_stmt|;
name|cts
operator|->
name|protocol_version
operator|=
name|SCSI_REV_2
expr_stmt|;
name|cts
operator|->
name|transport
operator|=
name|XPORT_SPI
expr_stmt|;
name|cts
operator|->
name|transport_version
operator|=
literal|2
expr_stmt|;
name|scsi
operator|->
name|flags
operator|&=
operator|~
name|CTS_SCSI_FLAGS_TAG_ENB
expr_stmt|;
name|spi
operator|->
name|flags
operator|&=
operator|~
name|CTS_SPI_FLAGS_DISC_ENB
expr_stmt|;
if|if
condition|(
name|dval
operator|&
name|DP_DISC_ENABLE
condition|)
block|{
name|spi
operator|->
name|flags
operator||=
name|CTS_SPI_FLAGS_DISC_ENB
expr_stmt|;
block|}
if|if
condition|(
name|dval
operator|&
name|DP_TQING_ENABLE
condition|)
block|{
name|scsi
operator|->
name|flags
operator||=
name|CTS_SCSI_FLAGS_TAG_ENB
expr_stmt|;
block|}
if|if
condition|(
name|oval
operator|&&
name|pval
condition|)
block|{
name|spi
operator|->
name|sync_offset
operator|=
name|oval
expr_stmt|;
name|spi
operator|->
name|sync_period
operator|=
name|pval
expr_stmt|;
name|spi
operator|->
name|valid
operator||=
name|CTS_SPI_VALID_SYNC_OFFSET
expr_stmt|;
name|spi
operator|->
name|valid
operator||=
name|CTS_SPI_VALID_SYNC_RATE
expr_stmt|;
block|}
name|spi
operator|->
name|valid
operator||=
name|CTS_SPI_VALID_BUS_WIDTH
expr_stmt|;
if|if
condition|(
name|dval
operator|&
name|DP_WIDE
condition|)
block|{
name|spi
operator|->
name|bus_width
operator|=
name|MSG_EXT_WDTR_BUS_16_BIT
expr_stmt|;
block|}
else|else
block|{
name|spi
operator|->
name|bus_width
operator|=
name|MSG_EXT_WDTR_BUS_8_BIT
expr_stmt|;
block|}
if|if
condition|(
name|cts
operator|->
name|ccb_h
operator|.
name|target_lun
operator|!=
name|CAM_LUN_WILDCARD
condition|)
block|{
name|scsi
operator|->
name|valid
operator|=
name|CTS_SCSI_VALID_TQ
expr_stmt|;
name|spi
operator|->
name|valid
operator||=
name|CTS_SPI_VALID_DISC
expr_stmt|;
block|}
else|else
block|{
name|scsi
operator|->
name|valid
operator|=
literal|0
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|mpt
operator|->
name|verbose
operator|>
literal|1
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"GET %s tgt %d flags %x period %x off %x"
argument_list|,
name|IS_CURRENT_SETTINGS
argument_list|(
name|cts
argument_list|)
condition|?
literal|"ACTIVE"
else|:
literal|"NVRAM"
argument_list|,
name|tgt
argument_list|,
name|dval
argument_list|,
name|pval
argument_list|,
name|oval
argument_list|)
expr_stmt|;
block|}
block|}
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_CMP
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
break|break;
case|case
name|XPT_CALC_GEOMETRY
case|:
block|{
name|struct
name|ccb_calc_geometry
modifier|*
name|ccg
decl_stmt|;
name|ccg
operator|=
operator|&
name|ccb
operator|->
name|ccg
expr_stmt|;
if|if
condition|(
name|ccg
operator|->
name|block_size
operator|==
literal|0
condition|)
block|{
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_INVALID
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
break|break;
block|}
name|cam_calc_geometry
argument_list|(
name|ccg
argument_list|,
comment|/*extended*/
literal|1
argument_list|)
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|XPT_PATH_INQ
case|:
comment|/* Path routing inquiry */
block|{
name|struct
name|ccb_pathinq
modifier|*
name|cpi
init|=
operator|&
name|ccb
operator|->
name|cpi
decl_stmt|;
name|cpi
operator|->
name|version_num
operator|=
literal|1
expr_stmt|;
name|cpi
operator|->
name|target_sprt
operator|=
literal|0
expr_stmt|;
name|cpi
operator|->
name|hba_eng_cnt
operator|=
literal|0
expr_stmt|;
name|cpi
operator|->
name|max_lun
operator|=
literal|7
expr_stmt|;
name|cpi
operator|->
name|bus_id
operator|=
name|cam_sim_bus
argument_list|(
name|sim
argument_list|)
expr_stmt|;
if|if
condition|(
name|mpt
operator|->
name|is_fc
condition|)
block|{
name|cpi
operator|->
name|max_target
operator|=
literal|255
expr_stmt|;
name|cpi
operator|->
name|hba_misc
operator|=
name|PIM_NOBUSRESET
expr_stmt|;
name|cpi
operator|->
name|initiator_id
operator|=
name|cpi
operator|->
name|max_target
operator|+
literal|1
expr_stmt|;
name|cpi
operator|->
name|base_transfer_speed
operator|=
literal|100000
expr_stmt|;
name|cpi
operator|->
name|hba_inquiry
operator|=
name|PI_TAG_ABLE
expr_stmt|;
block|}
else|else
block|{
name|cpi
operator|->
name|initiator_id
operator|=
name|mpt
operator|->
name|mpt_ini_id
expr_stmt|;
name|cpi
operator|->
name|base_transfer_speed
operator|=
literal|3300
expr_stmt|;
name|cpi
operator|->
name|hba_inquiry
operator|=
name|PI_SDTR_ABLE
operator||
name|PI_TAG_ABLE
operator||
name|PI_WIDE_16
expr_stmt|;
name|cpi
operator|->
name|hba_misc
operator|=
literal|0
expr_stmt|;
name|cpi
operator|->
name|max_target
operator|=
literal|15
expr_stmt|;
block|}
name|strncpy
argument_list|(
name|cpi
operator|->
name|sim_vid
argument_list|,
literal|"FreeBSD"
argument_list|,
name|SIM_IDLEN
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|cpi
operator|->
name|hba_vid
argument_list|,
literal|"LSI"
argument_list|,
name|HBA_IDLEN
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|cpi
operator|->
name|dev_name
argument_list|,
name|cam_sim_name
argument_list|(
name|sim
argument_list|)
argument_list|,
name|DEV_IDLEN
argument_list|)
expr_stmt|;
name|cpi
operator|->
name|unit_number
operator|=
name|cam_sim_unit
argument_list|(
name|sim
argument_list|)
expr_stmt|;
name|cpi
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_CMP
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
break|break;
block|}
default|default:
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_INVALID
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|mpt_setwidth
parameter_list|(
name|mpt_softc_t
modifier|*
name|mpt
parameter_list|,
name|int
name|tgt
parameter_list|,
name|int
name|onoff
parameter_list|)
block|{
name|CONFIG_PAGE_SCSI_DEVICE_1
name|tmp
decl_stmt|;
name|tmp
operator|=
name|mpt
operator|->
name|mpt_dev_page1
index|[
name|tgt
index|]
expr_stmt|;
if|if
condition|(
name|onoff
condition|)
block|{
name|tmp
operator|.
name|RequestedParameters
operator||=
name|MPI_SCSIDEVPAGE1_RP_WIDE
expr_stmt|;
block|}
else|else
block|{
name|tmp
operator|.
name|RequestedParameters
operator|&=
operator|~
name|MPI_SCSIDEVPAGE1_RP_WIDE
expr_stmt|;
block|}
if|if
condition|(
name|mpt_write_cfg_page
argument_list|(
name|mpt
argument_list|,
name|tgt
argument_list|,
operator|&
name|tmp
operator|.
name|Header
argument_list|)
condition|)
block|{
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|mpt_read_cfg_page
argument_list|(
name|mpt
argument_list|,
name|tgt
argument_list|,
operator|&
name|tmp
operator|.
name|Header
argument_list|)
condition|)
block|{
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|mpt
operator|->
name|mpt_dev_page1
index|[
name|tgt
index|]
operator|=
name|tmp
expr_stmt|;
if|if
condition|(
name|mpt
operator|->
name|verbose
operator|>
literal|1
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"SPI Target %d Page 1: RequestedParameters %x Config %x"
argument_list|,
name|tgt
argument_list|,
name|mpt
operator|->
name|mpt_dev_page1
index|[
name|tgt
index|]
operator|.
name|RequestedParameters
argument_list|,
name|mpt
operator|->
name|mpt_dev_page1
index|[
name|tgt
index|]
operator|.
name|Configuration
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mpt_setsync
parameter_list|(
name|mpt_softc_t
modifier|*
name|mpt
parameter_list|,
name|int
name|tgt
parameter_list|,
name|int
name|period
parameter_list|,
name|int
name|offset
parameter_list|)
block|{
name|CONFIG_PAGE_SCSI_DEVICE_1
name|tmp
decl_stmt|;
name|tmp
operator|=
name|mpt
operator|->
name|mpt_dev_page1
index|[
name|tgt
index|]
expr_stmt|;
name|tmp
operator|.
name|RequestedParameters
operator|&=
operator|~
name|MPI_SCSIDEVPAGE1_RP_MIN_SYNC_PERIOD_MASK
expr_stmt|;
name|tmp
operator|.
name|RequestedParameters
operator|&=
operator|~
name|MPI_SCSIDEVPAGE1_RP_MAX_SYNC_OFFSET_MASK
expr_stmt|;
name|tmp
operator|.
name|RequestedParameters
operator|&=
operator|~
name|MPI_SCSIDEVPAGE1_RP_DT
expr_stmt|;
name|tmp
operator|.
name|RequestedParameters
operator|&=
operator|~
name|MPI_SCSIDEVPAGE1_RP_QAS
expr_stmt|;
name|tmp
operator|.
name|RequestedParameters
operator|&=
operator|~
name|MPI_SCSIDEVPAGE1_RP_IU
expr_stmt|;
comment|/* 	 * XXX: For now, we're ignoring specific settings 	 */
if|if
condition|(
name|period
operator|&&
name|offset
condition|)
block|{
name|int
name|factor
decl_stmt|,
name|offset
decl_stmt|,
name|np
decl_stmt|;
name|factor
operator|=
operator|(
name|mpt
operator|->
name|mpt_port_page0
operator|.
name|Capabilities
operator|>>
literal|8
operator|)
operator|&
literal|0xff
expr_stmt|;
name|offset
operator|=
operator|(
name|mpt
operator|->
name|mpt_port_page0
operator|.
name|Capabilities
operator|>>
literal|16
operator|)
operator|&
literal|0xff
expr_stmt|;
name|np
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|factor
operator|<
literal|0x9
condition|)
block|{
name|np
operator||=
name|MPI_SCSIDEVPAGE1_RP_QAS
expr_stmt|;
name|np
operator||=
name|MPI_SCSIDEVPAGE1_RP_IU
expr_stmt|;
block|}
if|if
condition|(
name|factor
operator|<
literal|0xa
condition|)
block|{
name|np
operator||=
name|MPI_SCSIDEVPAGE1_RP_DT
expr_stmt|;
block|}
name|np
operator||=
operator|(
name|factor
operator|<<
literal|8
operator|)
operator||
operator|(
name|offset
operator|<<
literal|16
operator|)
expr_stmt|;
name|tmp
operator|.
name|RequestedParameters
operator||=
name|np
expr_stmt|;
block|}
if|if
condition|(
name|mpt_write_cfg_page
argument_list|(
name|mpt
argument_list|,
name|tgt
argument_list|,
operator|&
name|tmp
operator|.
name|Header
argument_list|)
condition|)
block|{
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|mpt_read_cfg_page
argument_list|(
name|mpt
argument_list|,
name|tgt
argument_list|,
operator|&
name|tmp
operator|.
name|Header
argument_list|)
condition|)
block|{
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|mpt
operator|->
name|mpt_dev_page1
index|[
name|tgt
index|]
operator|=
name|tmp
expr_stmt|;
if|if
condition|(
name|mpt
operator|->
name|verbose
operator|>
literal|1
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"SPI Target %d Page 1: RParams %x Config %x"
argument_list|,
name|tgt
argument_list|,
name|mpt
operator|->
name|mpt_dev_page1
index|[
name|tgt
index|]
operator|.
name|RequestedParameters
argument_list|,
name|mpt
operator|->
name|mpt_dev_page1
index|[
name|tgt
index|]
operator|.
name|Configuration
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


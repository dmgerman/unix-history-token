begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Routines for handling the integrated RAID features LSI MPT Fusion adapters.  *  * Copyright (c) 2005, WHEEL Sp. z o.o.  * Copyright (c) 2005 Justin T. Gibbs.  * All rights reserved.  *   * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions are  * met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce at minimum a disclaimer  *    substantially similar to the "NO WARRANTY" disclaimer below  *    ("Disclaimer") and any redistribution must be conditioned upon including  *    a substantially similar Disclaimer requirement for further binary  *    redistribution.  * 3. Neither the names of the above listed copyright holders nor the names  *    of any contributors may be used to endorse or promote products derived  *    from this software without specific prior written permission.  *   * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE  * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF THE COPYRIGHT  * OWNER OR CONTRIBUTOR IS ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_comment
comment|/*-  * Some Breakage and Bug Fixing added later.  * Copyright (c) 2006, by Matthew Jacob  * All Rights Reserved  *  * Support from LSI-Logic has also gone a great deal toward making this a  * workable subsystem and is gratefully acknowledged.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/mpt/mpt.h>
end_include

begin_include
include|#
directive|include
file|<dev/mpt/mpt_raid.h>
end_include

begin_include
include|#
directive|include
file|"dev/mpt/mpilib/mpi_ioc.h"
end_include

begin_comment
comment|/* XXX Fix Event Handling!!! */
end_comment

begin_include
include|#
directive|include
file|"dev/mpt/mpilib/mpi_raid.h"
end_include

begin_include
include|#
directive|include
file|<cam/cam.h>
end_include

begin_include
include|#
directive|include
file|<cam/cam_ccb.h>
end_include

begin_include
include|#
directive|include
file|<cam/cam_sim.h>
end_include

begin_include
include|#
directive|include
file|<cam/cam_xpt_sim.h>
end_include

begin_if
if|#
directive|if
name|__FreeBSD_version
operator|<
literal|500000
end_if

begin_include
include|#
directive|include
file|<sys/devicestat.h>
end_include

begin_define
define|#
directive|define
name|GIANT_REQUIRED
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<cam/cam_periph.h>
end_include

begin_include
include|#
directive|include
file|<sys/callout.h>
end_include

begin_include
include|#
directive|include
file|<sys/kthread.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<machine/stdarg.h>
end_include

begin_struct
struct|struct
name|mpt_raid_action_result
block|{
union|union
block|{
name|MPI_RAID_VOL_INDICATOR
name|indicator_struct
decl_stmt|;
name|uint32_t
name|new_settings
decl_stmt|;
name|uint8_t
name|phys_disk_num
decl_stmt|;
block|}
name|action_data
union|;
name|uint16_t
name|action_status
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|REQ_TO_RAID_ACTION_RESULT
parameter_list|(
name|req
parameter_list|)
value|((struct mpt_raid_action_result *) \ 	(((MSG_RAID_ACTION_REQUEST *)(req->req_vbuf)) + 1))
end_define

begin_define
define|#
directive|define
name|REQ_IOCSTATUS
parameter_list|(
name|req
parameter_list|)
value|((req)->IOCStatus& MPI_IOCSTATUS_MASK)
end_define

begin_decl_stmt
specifier|static
name|mpt_probe_handler_t
name|mpt_raid_probe
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|mpt_attach_handler_t
name|mpt_raid_attach
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|mpt_enable_handler_t
name|mpt_raid_enable
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|mpt_event_handler_t
name|mpt_raid_event
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|mpt_shutdown_handler_t
name|mpt_raid_shutdown
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|mpt_reset_handler_t
name|mpt_raid_ioc_reset
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|mpt_detach_handler_t
name|mpt_raid_detach
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|mpt_personality
name|mpt_raid_personality
init|=
block|{
operator|.
name|name
operator|=
literal|"mpt_raid"
block|,
operator|.
name|probe
operator|=
name|mpt_raid_probe
block|,
operator|.
name|attach
operator|=
name|mpt_raid_attach
block|,
operator|.
name|enable
operator|=
name|mpt_raid_enable
block|,
operator|.
name|event
operator|=
name|mpt_raid_event
block|,
operator|.
name|reset
operator|=
name|mpt_raid_ioc_reset
block|,
operator|.
name|shutdown
operator|=
name|mpt_raid_shutdown
block|,
operator|.
name|detach
operator|=
name|mpt_raid_detach
block|, }
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DECLARE_MPT_PERSONALITY
argument_list|(
name|mpt_raid
argument_list|,
name|SI_ORDER_THIRD
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MPT_PERSONALITY_DEPEND
argument_list|(
name|mpt_raid
argument_list|,
name|mpt_cam
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|mpt_reply_handler_t
name|mpt_raid_reply_handler
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|int
name|mpt_raid_reply_frame_handler
parameter_list|(
name|struct
name|mpt_softc
modifier|*
name|mpt
parameter_list|,
name|request_t
modifier|*
name|req
parameter_list|,
name|MSG_DEFAULT_REPLY
modifier|*
name|reply_frame
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|mpt_spawn_raid_thread
parameter_list|(
name|struct
name|mpt_softc
modifier|*
name|mpt
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|mpt_terminate_raid_thread
parameter_list|(
name|struct
name|mpt_softc
modifier|*
name|mpt
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|mpt_raid_thread
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|timeout_t
name|mpt_raid_timer
decl_stmt|;
end_decl_stmt

begin_if
if|#
directive|if
literal|0
end_if

begin_endif
unit|static void mpt_enable_vol(struct mpt_softc *mpt, 			   struct mpt_raid_volume *mpt_vol, int enable);
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|void
name|mpt_verify_mwce
parameter_list|(
name|struct
name|mpt_softc
modifier|*
name|mpt
parameter_list|,
name|struct
name|mpt_raid_volume
modifier|*
name|mpt_vol
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|mpt_adjust_queue_depth
parameter_list|(
name|struct
name|mpt_softc
modifier|*
name|mpt
parameter_list|,
name|struct
name|mpt_raid_volume
modifier|*
name|mpt_vol
parameter_list|,
name|struct
name|cam_path
modifier|*
name|path
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|mpt_raid_sysctl_attach
parameter_list|(
name|struct
name|mpt_softc
modifier|*
name|mpt
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|uint32_t
name|raid_handler_id
init|=
name|MPT_HANDLER_ID_NONE
decl_stmt|;
end_decl_stmt

begin_function
specifier|const
name|char
modifier|*
name|mpt_vol_type
parameter_list|(
name|struct
name|mpt_raid_volume
modifier|*
name|vol
parameter_list|)
block|{
switch|switch
condition|(
name|vol
operator|->
name|config_page
operator|->
name|VolumeType
condition|)
block|{
case|case
name|MPI_RAID_VOL_TYPE_IS
case|:
return|return
operator|(
literal|"RAID-0"
operator|)
return|;
case|case
name|MPI_RAID_VOL_TYPE_IME
case|:
return|return
operator|(
literal|"RAID-1E"
operator|)
return|;
case|case
name|MPI_RAID_VOL_TYPE_IM
case|:
return|return
operator|(
literal|"RAID-1"
operator|)
return|;
default|default:
return|return
operator|(
literal|"Unknown"
operator|)
return|;
block|}
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|mpt_vol_state
parameter_list|(
name|struct
name|mpt_raid_volume
modifier|*
name|vol
parameter_list|)
block|{
switch|switch
condition|(
name|vol
operator|->
name|config_page
operator|->
name|VolumeStatus
operator|.
name|State
condition|)
block|{
case|case
name|MPI_RAIDVOL0_STATUS_STATE_OPTIMAL
case|:
return|return
operator|(
literal|"Optimal"
operator|)
return|;
case|case
name|MPI_RAIDVOL0_STATUS_STATE_DEGRADED
case|:
return|return
operator|(
literal|"Degraded"
operator|)
return|;
case|case
name|MPI_RAIDVOL0_STATUS_STATE_FAILED
case|:
return|return
operator|(
literal|"Failed"
operator|)
return|;
default|default:
return|return
operator|(
literal|"Unknown"
operator|)
return|;
block|}
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|mpt_disk_state
parameter_list|(
name|struct
name|mpt_raid_disk
modifier|*
name|disk
parameter_list|)
block|{
switch|switch
condition|(
name|disk
operator|->
name|config_page
operator|.
name|PhysDiskStatus
operator|.
name|State
condition|)
block|{
case|case
name|MPI_PHYSDISK0_STATUS_ONLINE
case|:
return|return
operator|(
literal|"Online"
operator|)
return|;
case|case
name|MPI_PHYSDISK0_STATUS_MISSING
case|:
return|return
operator|(
literal|"Missing"
operator|)
return|;
case|case
name|MPI_PHYSDISK0_STATUS_NOT_COMPATIBLE
case|:
return|return
operator|(
literal|"Incompatible"
operator|)
return|;
case|case
name|MPI_PHYSDISK0_STATUS_FAILED
case|:
return|return
operator|(
literal|"Failed"
operator|)
return|;
case|case
name|MPI_PHYSDISK0_STATUS_INITIALIZING
case|:
return|return
operator|(
literal|"Initializing"
operator|)
return|;
case|case
name|MPI_PHYSDISK0_STATUS_OFFLINE_REQUESTED
case|:
return|return
operator|(
literal|"Offline Requested"
operator|)
return|;
case|case
name|MPI_PHYSDISK0_STATUS_FAILED_REQUESTED
case|:
return|return
operator|(
literal|"Failed per Host Request"
operator|)
return|;
case|case
name|MPI_PHYSDISK0_STATUS_OTHER_OFFLINE
case|:
return|return
operator|(
literal|"Offline"
operator|)
return|;
default|default:
return|return
operator|(
literal|"Unknown"
operator|)
return|;
block|}
block|}
end_function

begin_function
name|void
name|mpt_vol_prt
parameter_list|(
name|struct
name|mpt_softc
modifier|*
name|mpt
parameter_list|,
name|struct
name|mpt_raid_volume
modifier|*
name|vol
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|ap
decl_stmt|;
name|printf
argument_list|(
literal|"%s:vol%d(%s:%d:%d): "
argument_list|,
name|device_get_nameunit
argument_list|(
name|mpt
operator|->
name|dev
argument_list|)
argument_list|,
call|(
name|u_int
call|)
argument_list|(
name|vol
operator|-
name|mpt
operator|->
name|raid_volumes
argument_list|)
argument_list|,
name|device_get_nameunit
argument_list|(
name|mpt
operator|->
name|dev
argument_list|)
argument_list|,
name|vol
operator|->
name|config_page
operator|->
name|VolumeBus
argument_list|,
name|vol
operator|->
name|config_page
operator|->
name|VolumeID
argument_list|)
expr_stmt|;
name|va_start
argument_list|(
name|ap
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|vprintf
argument_list|(
name|fmt
argument_list|,
name|ap
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|mpt_disk_prt
parameter_list|(
name|struct
name|mpt_softc
modifier|*
name|mpt
parameter_list|,
name|struct
name|mpt_raid_disk
modifier|*
name|disk
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|ap
decl_stmt|;
if|if
condition|(
name|disk
operator|->
name|volume
operator|!=
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"(%s:vol%d:%d): "
argument_list|,
name|device_get_nameunit
argument_list|(
name|mpt
operator|->
name|dev
argument_list|)
argument_list|,
name|disk
operator|->
name|volume
operator|->
name|config_page
operator|->
name|VolumeID
argument_list|,
name|disk
operator|->
name|member_number
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"(%s:%d:%d): "
argument_list|,
name|device_get_nameunit
argument_list|(
name|mpt
operator|->
name|dev
argument_list|)
argument_list|,
name|disk
operator|->
name|config_page
operator|.
name|PhysDiskBus
argument_list|,
name|disk
operator|->
name|config_page
operator|.
name|PhysDiskID
argument_list|)
expr_stmt|;
block|}
name|va_start
argument_list|(
name|ap
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|vprintf
argument_list|(
name|fmt
argument_list|,
name|ap
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mpt_raid_async
parameter_list|(
name|void
modifier|*
name|callback_arg
parameter_list|,
name|u_int32_t
name|code
parameter_list|,
name|struct
name|cam_path
modifier|*
name|path
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|mpt_softc
modifier|*
name|mpt
decl_stmt|;
name|mpt
operator|=
operator|(
expr|struct
name|mpt_softc
operator|*
operator|)
name|callback_arg
expr_stmt|;
switch|switch
condition|(
name|code
condition|)
block|{
case|case
name|AC_FOUND_DEVICE
case|:
block|{
name|struct
name|ccb_getdev
modifier|*
name|cgd
decl_stmt|;
name|struct
name|mpt_raid_volume
modifier|*
name|mpt_vol
decl_stmt|;
name|cgd
operator|=
operator|(
expr|struct
name|ccb_getdev
operator|*
operator|)
name|arg
expr_stmt|;
if|if
condition|(
name|cgd
operator|==
name|NULL
condition|)
block|{
break|break;
block|}
name|mpt_lprt
argument_list|(
name|mpt
argument_list|,
name|MPT_PRT_DEBUG
argument_list|,
literal|"Callback for %d\n"
argument_list|,
name|cgd
operator|->
name|ccb_h
operator|.
name|target_id
argument_list|)
expr_stmt|;
name|RAID_VOL_FOREACH
argument_list|(
argument|mpt
argument_list|,
argument|mpt_vol
argument_list|)
block|{
if|if
condition|(
operator|(
name|mpt_vol
operator|->
name|flags
operator|&
name|MPT_RVF_ACTIVE
operator|)
operator|==
literal|0
condition|)
continue|continue;
if|if
condition|(
name|mpt_vol
operator|->
name|config_page
operator|->
name|VolumeID
operator|==
name|cgd
operator|->
name|ccb_h
operator|.
name|target_id
condition|)
block|{
name|mpt_adjust_queue_depth
argument_list|(
name|mpt
argument_list|,
name|mpt_vol
argument_list|,
name|path
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
default|default:
break|break;
block|}
block|}
end_function

begin_function
name|int
name|mpt_raid_probe
parameter_list|(
name|struct
name|mpt_softc
modifier|*
name|mpt
parameter_list|)
block|{
if|if
condition|(
name|mpt
operator|->
name|ioc_page2
operator|==
name|NULL
operator|||
name|mpt
operator|->
name|ioc_page2
operator|->
name|MaxPhysDisks
operator|==
literal|0
condition|)
block|{
return|return
operator|(
name|ENODEV
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|mpt_raid_attach
parameter_list|(
name|struct
name|mpt_softc
modifier|*
name|mpt
parameter_list|)
block|{
name|struct
name|ccb_setasync
name|csa
decl_stmt|;
name|mpt_handler_t
name|handler
decl_stmt|;
name|int
name|error
decl_stmt|;
name|mpt_callout_init
argument_list|(
operator|&
name|mpt
operator|->
name|raid_timer
argument_list|)
expr_stmt|;
name|handler
operator|.
name|reply_handler
operator|=
name|mpt_raid_reply_handler
expr_stmt|;
name|error
operator|=
name|mpt_register_handler
argument_list|(
name|mpt
argument_list|,
name|MPT_HANDLER_REPLY
argument_list|,
name|handler
argument_list|,
operator|&
name|raid_handler_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"Unable to register RAID haandler!\n"
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|error
operator|=
name|mpt_spawn_raid_thread
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"Unable to spawn RAID thread!\n"
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|xpt_setup_ccb
argument_list|(
operator|&
name|csa
operator|.
name|ccb_h
argument_list|,
name|mpt
operator|->
name|path
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|csa
operator|.
name|ccb_h
operator|.
name|func_code
operator|=
name|XPT_SASYNC_CB
expr_stmt|;
name|csa
operator|.
name|event_enable
operator|=
name|AC_FOUND_DEVICE
expr_stmt|;
name|csa
operator|.
name|callback
operator|=
name|mpt_raid_async
expr_stmt|;
name|csa
operator|.
name|callback_arg
operator|=
name|mpt
expr_stmt|;
name|MPTLOCK_2_CAMLOCK
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
name|xpt_action
argument_list|(
operator|(
expr|union
name|ccb
operator|*
operator|)
operator|&
name|csa
argument_list|)
expr_stmt|;
name|CAMLOCK_2_MPTLOCK
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
if|if
condition|(
name|csa
operator|.
name|ccb_h
operator|.
name|status
operator|!=
name|CAM_REQ_CMP
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"mpt_raid_attach: Unable to register "
literal|"CAM async handler.\n"
argument_list|)
expr_stmt|;
block|}
name|mpt_raid_sysctl_attach
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|cleanup
label|:
name|mpt_raid_detach
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
name|int
name|mpt_raid_enable
parameter_list|(
name|struct
name|mpt_softc
modifier|*
name|mpt
parameter_list|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|void
name|mpt_raid_detach
parameter_list|(
name|struct
name|mpt_softc
modifier|*
name|mpt
parameter_list|)
block|{
name|struct
name|ccb_setasync
name|csa
decl_stmt|;
name|mpt_handler_t
name|handler
decl_stmt|;
name|callout_stop
argument_list|(
operator|&
name|mpt
operator|->
name|raid_timer
argument_list|)
expr_stmt|;
name|mpt_terminate_raid_thread
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
name|handler
operator|.
name|reply_handler
operator|=
name|mpt_raid_reply_handler
expr_stmt|;
name|mpt_deregister_handler
argument_list|(
name|mpt
argument_list|,
name|MPT_HANDLER_REPLY
argument_list|,
name|handler
argument_list|,
name|raid_handler_id
argument_list|)
expr_stmt|;
name|xpt_setup_ccb
argument_list|(
operator|&
name|csa
operator|.
name|ccb_h
argument_list|,
name|mpt
operator|->
name|path
argument_list|,
comment|/*priority*/
literal|5
argument_list|)
expr_stmt|;
name|csa
operator|.
name|ccb_h
operator|.
name|func_code
operator|=
name|XPT_SASYNC_CB
expr_stmt|;
name|csa
operator|.
name|event_enable
operator|=
literal|0
expr_stmt|;
name|csa
operator|.
name|callback
operator|=
name|mpt_raid_async
expr_stmt|;
name|csa
operator|.
name|callback_arg
operator|=
name|mpt
expr_stmt|;
name|MPTLOCK_2_CAMLOCK
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
name|xpt_action
argument_list|(
operator|(
expr|union
name|ccb
operator|*
operator|)
operator|&
name|csa
argument_list|)
expr_stmt|;
name|CAMLOCK_2_MPTLOCK
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mpt_raid_ioc_reset
parameter_list|(
name|struct
name|mpt_softc
modifier|*
name|mpt
parameter_list|,
name|int
name|type
parameter_list|)
block|{
comment|/* Nothing to do yet. */
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|raid_event_txt
index|[]
init|=
block|{
literal|"Volume Created"
block|,
literal|"Volume Deleted"
block|,
literal|"Volume Settings Changed"
block|,
literal|"Volume Status Changed"
block|,
literal|"Volume Physical Disk Membership Changed"
block|,
literal|"Physical Disk Created"
block|,
literal|"Physical Disk Deleted"
block|,
literal|"Physical Disk Settings Changed"
block|,
literal|"Physical Disk Status Changed"
block|,
literal|"Domain Validation Required"
block|,
literal|"SMART Data Received"
block|,
literal|"Replace Action Started"
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|mpt_raid_event
parameter_list|(
name|struct
name|mpt_softc
modifier|*
name|mpt
parameter_list|,
name|request_t
modifier|*
name|req
parameter_list|,
name|MSG_EVENT_NOTIFY_REPLY
modifier|*
name|msg
parameter_list|)
block|{
name|EVENT_DATA_RAID
modifier|*
name|raid_event
decl_stmt|;
name|struct
name|mpt_raid_volume
modifier|*
name|mpt_vol
decl_stmt|;
name|struct
name|mpt_raid_disk
modifier|*
name|mpt_disk
decl_stmt|;
name|CONFIG_PAGE_RAID_VOL_0
modifier|*
name|vol_pg
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|print_event
decl_stmt|;
if|if
condition|(
name|msg
operator|->
name|Event
operator|!=
name|MPI_EVENT_INTEGRATED_RAID
condition|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|raid_event
operator|=
operator|(
name|EVENT_DATA_RAID
operator|*
operator|)
operator|&
name|msg
operator|->
name|Data
expr_stmt|;
name|mpt_vol
operator|=
name|NULL
expr_stmt|;
name|vol_pg
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|mpt
operator|->
name|raid_volumes
operator|!=
name|NULL
operator|&&
name|mpt
operator|->
name|ioc_page2
operator|!=
name|NULL
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|mpt
operator|->
name|ioc_page2
operator|->
name|MaxVolumes
condition|;
name|i
operator|++
control|)
block|{
name|mpt_vol
operator|=
operator|&
name|mpt
operator|->
name|raid_volumes
index|[
name|i
index|]
expr_stmt|;
name|vol_pg
operator|=
name|mpt_vol
operator|->
name|config_page
expr_stmt|;
if|if
condition|(
operator|(
name|mpt_vol
operator|->
name|flags
operator|&
name|MPT_RVF_ACTIVE
operator|)
operator|==
literal|0
condition|)
continue|continue;
if|if
condition|(
name|vol_pg
operator|->
name|VolumeID
operator|==
name|raid_event
operator|->
name|VolumeID
operator|&&
name|vol_pg
operator|->
name|VolumeBus
operator|==
name|raid_event
operator|->
name|VolumeBus
condition|)
break|break;
block|}
if|if
condition|(
name|i
operator|>=
name|mpt
operator|->
name|ioc_page2
operator|->
name|MaxVolumes
condition|)
block|{
name|mpt_vol
operator|=
name|NULL
expr_stmt|;
name|vol_pg
operator|=
name|NULL
expr_stmt|;
block|}
block|}
name|mpt_disk
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|raid_event
operator|->
name|PhysDiskNum
operator|!=
literal|0xFF
operator|&&
name|mpt
operator|->
name|raid_disks
operator|!=
name|NULL
condition|)
block|{
name|mpt_disk
operator|=
name|mpt
operator|->
name|raid_disks
operator|+
name|raid_event
operator|->
name|PhysDiskNum
expr_stmt|;
if|if
condition|(
operator|(
name|mpt_disk
operator|->
name|flags
operator|&
name|MPT_RDF_ACTIVE
operator|)
operator|==
literal|0
condition|)
block|{
name|mpt_disk
operator|=
name|NULL
expr_stmt|;
block|}
block|}
name|print_event
operator|=
literal|1
expr_stmt|;
switch|switch
condition|(
name|raid_event
operator|->
name|ReasonCode
condition|)
block|{
case|case
name|MPI_EVENT_RAID_RC_VOLUME_CREATED
case|:
case|case
name|MPI_EVENT_RAID_RC_VOLUME_DELETED
case|:
break|break;
case|case
name|MPI_EVENT_RAID_RC_VOLUME_STATUS_CHANGED
case|:
if|if
condition|(
name|mpt_vol
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
name|mpt_vol
operator|->
name|flags
operator|&
name|MPT_RVF_UP2DATE
operator|)
operator|!=
literal|0
condition|)
block|{
name|mpt_vol
operator|->
name|flags
operator|&=
operator|~
name|MPT_RVF_UP2DATE
expr_stmt|;
block|}
else|else
block|{
comment|/* 				 * Coalesce status messages into one 				 * per background run of our RAID thread. 				 * This removes "spurious" status messages 				 * from our output. 				 */
name|print_event
operator|=
literal|0
expr_stmt|;
block|}
block|}
break|break;
case|case
name|MPI_EVENT_RAID_RC_VOLUME_SETTINGS_CHANGED
case|:
case|case
name|MPI_EVENT_RAID_RC_VOLUME_PHYSDISK_CHANGED
case|:
name|mpt
operator|->
name|raid_rescan
operator|++
expr_stmt|;
if|if
condition|(
name|mpt_vol
operator|!=
name|NULL
condition|)
block|{
name|mpt_vol
operator|->
name|flags
operator|&=
operator|~
operator|(
name|MPT_RVF_UP2DATE
operator||
name|MPT_RVF_ANNOUNCED
operator|)
expr_stmt|;
block|}
break|break;
case|case
name|MPI_EVENT_RAID_RC_PHYSDISK_CREATED
case|:
case|case
name|MPI_EVENT_RAID_RC_PHYSDISK_DELETED
case|:
name|mpt
operator|->
name|raid_rescan
operator|++
expr_stmt|;
break|break;
case|case
name|MPI_EVENT_RAID_RC_PHYSDISK_SETTINGS_CHANGED
case|:
case|case
name|MPI_EVENT_RAID_RC_PHYSDISK_STATUS_CHANGED
case|:
name|mpt
operator|->
name|raid_rescan
operator|++
expr_stmt|;
if|if
condition|(
name|mpt_disk
operator|!=
name|NULL
condition|)
block|{
name|mpt_disk
operator|->
name|flags
operator|&=
operator|~
name|MPT_RDF_UP2DATE
expr_stmt|;
block|}
break|break;
case|case
name|MPI_EVENT_RAID_RC_DOMAIN_VAL_NEEDED
case|:
name|mpt
operator|->
name|raid_rescan
operator|++
expr_stmt|;
break|break;
case|case
name|MPI_EVENT_RAID_RC_SMART_DATA
case|:
case|case
name|MPI_EVENT_RAID_RC_REPLACE_ACTION_STARTED
case|:
break|break;
block|}
if|if
condition|(
name|print_event
condition|)
block|{
if|if
condition|(
name|mpt_disk
operator|!=
name|NULL
condition|)
block|{
name|mpt_disk_prt
argument_list|(
name|mpt
argument_list|,
name|mpt_disk
argument_list|,
literal|""
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|mpt_vol
operator|!=
name|NULL
condition|)
block|{
name|mpt_vol_prt
argument_list|(
name|mpt
argument_list|,
name|mpt_vol
argument_list|,
literal|""
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"Volume(%d:%d"
argument_list|,
name|raid_event
operator|->
name|VolumeBus
argument_list|,
name|raid_event
operator|->
name|VolumeID
argument_list|)
expr_stmt|;
if|if
condition|(
name|raid_event
operator|->
name|PhysDiskNum
operator|!=
literal|0xFF
condition|)
name|mpt_prtc
argument_list|(
name|mpt
argument_list|,
literal|":%d): "
argument_list|,
name|raid_event
operator|->
name|PhysDiskNum
argument_list|)
expr_stmt|;
else|else
name|mpt_prtc
argument_list|(
name|mpt
argument_list|,
literal|"): "
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|raid_event
operator|->
name|ReasonCode
operator|>=
name|NUM_ELEMENTS
argument_list|(
name|raid_event_txt
argument_list|)
condition|)
name|mpt_prtc
argument_list|(
name|mpt
argument_list|,
literal|"Unhandled RaidEvent %#x\n"
argument_list|,
name|raid_event
operator|->
name|ReasonCode
argument_list|)
expr_stmt|;
else|else
name|mpt_prtc
argument_list|(
name|mpt
argument_list|,
literal|"%s\n"
argument_list|,
name|raid_event_txt
index|[
name|raid_event
operator|->
name|ReasonCode
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|raid_event
operator|->
name|ReasonCode
operator|==
name|MPI_EVENT_RAID_RC_SMART_DATA
condition|)
block|{
comment|/* XXX Use CAM's print sense for this... */
if|if
condition|(
name|mpt_disk
operator|!=
name|NULL
condition|)
name|mpt_disk_prt
argument_list|(
name|mpt
argument_list|,
name|mpt_disk
argument_list|,
literal|""
argument_list|)
expr_stmt|;
else|else
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"Volume(%d:%d:%d: "
argument_list|,
name|raid_event
operator|->
name|VolumeBus
argument_list|,
name|raid_event
operator|->
name|VolumeID
argument_list|,
name|raid_event
operator|->
name|PhysDiskNum
argument_list|)
expr_stmt|;
name|mpt_prtc
argument_list|(
name|mpt
argument_list|,
literal|"ASC 0x%x, ASCQ 0x%x)\n"
argument_list|,
name|raid_event
operator|->
name|ASC
argument_list|,
name|raid_event
operator|->
name|ASCQ
argument_list|)
expr_stmt|;
block|}
name|mpt_raid_wakeup
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mpt_raid_shutdown
parameter_list|(
name|struct
name|mpt_softc
modifier|*
name|mpt
parameter_list|)
block|{
name|struct
name|mpt_raid_volume
modifier|*
name|mpt_vol
decl_stmt|;
if|if
condition|(
name|mpt
operator|->
name|raid_mwce_setting
operator|!=
name|MPT_RAID_MWCE_REBUILD_ONLY
condition|)
block|{
return|return;
block|}
name|mpt
operator|->
name|raid_mwce_setting
operator|=
name|MPT_RAID_MWCE_OFF
expr_stmt|;
name|RAID_VOL_FOREACH
argument_list|(
argument|mpt
argument_list|,
argument|mpt_vol
argument_list|)
block|{
name|mpt_verify_mwce
argument_list|(
name|mpt
argument_list|,
name|mpt_vol
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|mpt_raid_reply_handler
parameter_list|(
name|struct
name|mpt_softc
modifier|*
name|mpt
parameter_list|,
name|request_t
modifier|*
name|req
parameter_list|,
name|uint32_t
name|reply_desc
parameter_list|,
name|MSG_DEFAULT_REPLY
modifier|*
name|reply_frame
parameter_list|)
block|{
name|int
name|free_req
decl_stmt|;
if|if
condition|(
name|req
operator|==
name|NULL
condition|)
return|return
operator|(
name|TRUE
operator|)
return|;
name|free_req
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|reply_frame
operator|!=
name|NULL
condition|)
name|free_req
operator|=
name|mpt_raid_reply_frame_handler
argument_list|(
name|mpt
argument_list|,
name|req
argument_list|,
name|reply_frame
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|NOTYET
elseif|else
if|if
condition|(
name|req
operator|->
name|ccb
operator|!=
name|NULL
condition|)
block|{
comment|/* Complete Quiesce CCB with error... */
block|}
endif|#
directive|endif
name|req
operator|->
name|state
operator|&=
operator|~
name|REQ_STATE_QUEUED
expr_stmt|;
name|req
operator|->
name|state
operator||=
name|REQ_STATE_DONE
expr_stmt|;
name|TAILQ_REMOVE
argument_list|(
operator|&
name|mpt
operator|->
name|request_pending_list
argument_list|,
name|req
argument_list|,
name|links
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|req
operator|->
name|state
operator|&
name|REQ_STATE_NEED_WAKEUP
operator|)
operator|!=
literal|0
condition|)
block|{
name|wakeup
argument_list|(
name|req
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|free_req
condition|)
block|{
name|mpt_free_request
argument_list|(
name|mpt
argument_list|,
name|req
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|TRUE
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Parse additional completion information in the reply  * frame for RAID I/O requests.  */
end_comment

begin_function
specifier|static
name|int
name|mpt_raid_reply_frame_handler
parameter_list|(
name|struct
name|mpt_softc
modifier|*
name|mpt
parameter_list|,
name|request_t
modifier|*
name|req
parameter_list|,
name|MSG_DEFAULT_REPLY
modifier|*
name|reply_frame
parameter_list|)
block|{
name|MSG_RAID_ACTION_REPLY
modifier|*
name|reply
decl_stmt|;
name|struct
name|mpt_raid_action_result
modifier|*
name|action_result
decl_stmt|;
name|MSG_RAID_ACTION_REQUEST
modifier|*
name|rap
decl_stmt|;
name|reply
operator|=
operator|(
name|MSG_RAID_ACTION_REPLY
operator|*
operator|)
name|reply_frame
expr_stmt|;
name|req
operator|->
name|IOCStatus
operator|=
name|le16toh
argument_list|(
name|reply
operator|->
name|IOCStatus
argument_list|)
expr_stmt|;
name|rap
operator|=
operator|(
name|MSG_RAID_ACTION_REQUEST
operator|*
operator|)
name|req
operator|->
name|req_vbuf
expr_stmt|;
switch|switch
condition|(
name|rap
operator|->
name|Action
condition|)
block|{
case|case
name|MPI_RAID_ACTION_QUIESCE_PHYS_IO
case|:
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"QUIESCE PHYSIO DONE\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|MPI_RAID_ACTION_ENABLE_PHYS_IO
case|:
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"ENABLY PHYSIO DONE\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
name|action_result
operator|=
name|REQ_TO_RAID_ACTION_RESULT
argument_list|(
name|req
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|action_result
operator|->
name|action_data
argument_list|,
operator|&
name|reply
operator|->
name|ActionData
argument_list|,
sizeof|sizeof
argument_list|(
name|action_result
operator|->
name|action_data
argument_list|)
argument_list|)
expr_stmt|;
name|action_result
operator|->
name|action_status
operator|=
name|reply
operator|->
name|ActionStatus
expr_stmt|;
return|return
operator|(
name|TRUE
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Utiltity routine to perform a RAID action command;  */
end_comment

begin_function
name|int
name|mpt_issue_raid_req
parameter_list|(
name|struct
name|mpt_softc
modifier|*
name|mpt
parameter_list|,
name|struct
name|mpt_raid_volume
modifier|*
name|vol
parameter_list|,
name|struct
name|mpt_raid_disk
modifier|*
name|disk
parameter_list|,
name|request_t
modifier|*
name|req
parameter_list|,
name|u_int
name|Action
parameter_list|,
name|uint32_t
name|ActionDataWord
parameter_list|,
name|bus_addr_t
name|addr
parameter_list|,
name|bus_size_t
name|len
parameter_list|,
name|int
name|write
parameter_list|,
name|int
name|wait
parameter_list|)
block|{
name|MSG_RAID_ACTION_REQUEST
modifier|*
name|rap
decl_stmt|;
name|SGE_SIMPLE32
modifier|*
name|se
decl_stmt|;
name|rap
operator|=
name|req
operator|->
name|req_vbuf
expr_stmt|;
name|memset
argument_list|(
name|rap
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
expr|*
name|rap
argument_list|)
expr_stmt|;
name|rap
operator|->
name|Action
operator|=
name|Action
expr_stmt|;
name|rap
operator|->
name|ActionDataWord
operator|=
name|ActionDataWord
expr_stmt|;
name|rap
operator|->
name|Function
operator|=
name|MPI_FUNCTION_RAID_ACTION
expr_stmt|;
name|rap
operator|->
name|VolumeID
operator|=
name|vol
operator|->
name|config_page
operator|->
name|VolumeID
expr_stmt|;
name|rap
operator|->
name|VolumeBus
operator|=
name|vol
operator|->
name|config_page
operator|->
name|VolumeBus
expr_stmt|;
if|if
condition|(
name|disk
operator|!=
literal|0
condition|)
name|rap
operator|->
name|PhysDiskNum
operator|=
name|disk
operator|->
name|config_page
operator|.
name|PhysDiskNum
expr_stmt|;
else|else
name|rap
operator|->
name|PhysDiskNum
operator|=
literal|0xFF
expr_stmt|;
name|se
operator|=
operator|(
name|SGE_SIMPLE32
operator|*
operator|)
operator|&
name|rap
operator|->
name|ActionDataSGE
expr_stmt|;
name|se
operator|->
name|Address
operator|=
name|addr
expr_stmt|;
name|MPI_pSGE_SET_LENGTH
argument_list|(
name|se
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|MPI_pSGE_SET_FLAGS
argument_list|(
name|se
argument_list|,
operator|(
name|MPI_SGE_FLAGS_SIMPLE_ELEMENT
operator||
name|MPI_SGE_FLAGS_LAST_ELEMENT
operator||
name|MPI_SGE_FLAGS_END_OF_BUFFER
operator||
name|MPI_SGE_FLAGS_END_OF_LIST
operator||
name|write
condition|?
name|MPI_SGE_FLAGS_HOST_TO_IOC
else|:
name|MPI_SGE_FLAGS_IOC_TO_HOST
operator|)
argument_list|)
expr_stmt|;
name|rap
operator|->
name|MsgContext
operator|=
name|htole32
argument_list|(
name|req
operator|->
name|index
operator||
name|raid_handler_id
argument_list|)
expr_stmt|;
name|mpt_check_doorbell
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
name|mpt_send_cmd
argument_list|(
name|mpt
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|wait
condition|)
block|{
return|return
operator|(
name|mpt_wait_req
argument_list|(
name|mpt
argument_list|,
name|req
argument_list|,
name|REQ_STATE_DONE
argument_list|,
name|REQ_STATE_DONE
argument_list|,
comment|/*sleep_ok*/
name|FALSE
argument_list|,
comment|/*time_ms*/
literal|2000
argument_list|)
operator|)
return|;
block|}
else|else
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
end_function

begin_comment
comment|/*************************** RAID Status Monitoring ***************************/
end_comment

begin_function
specifier|static
name|int
name|mpt_spawn_raid_thread
parameter_list|(
name|struct
name|mpt_softc
modifier|*
name|mpt
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
comment|/* 	 * Freeze out any CAM transactions until our thread 	 * is able to run at least once.  We need to update 	 * our RAID pages before acception I/O or we may 	 * reject I/O to an ID we later determine is for a 	 * hidden physdisk. 	 */
name|xpt_freeze_simq
argument_list|(
name|mpt
operator|->
name|phydisk_sim
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|error
operator|=
name|mpt_kthread_create
argument_list|(
name|mpt_raid_thread
argument_list|,
name|mpt
argument_list|,
operator|&
name|mpt
operator|->
name|raid_thread
argument_list|,
comment|/*flags*/
literal|0
argument_list|,
comment|/*altstack*/
literal|0
argument_list|,
literal|"mpt_raid%d"
argument_list|,
name|mpt
operator|->
name|unit
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
name|xpt_release_simq
argument_list|(
name|mpt
operator|->
name|phydisk_sim
argument_list|,
comment|/*run_queue*/
name|FALSE
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mpt_terminate_raid_thread
parameter_list|(
name|struct
name|mpt_softc
modifier|*
name|mpt
parameter_list|)
block|{
if|if
condition|(
name|mpt
operator|->
name|raid_thread
operator|==
name|NULL
condition|)
block|{
return|return;
block|}
name|mpt
operator|->
name|shutdwn_raid
operator|=
literal|1
expr_stmt|;
name|wakeup
argument_list|(
name|mpt
operator|->
name|raid_volumes
argument_list|)
expr_stmt|;
comment|/* 	 * Sleep on a slightly different location 	 * for this interlock just for added safety. 	 */
name|mpt_sleep
argument_list|(
name|mpt
argument_list|,
operator|&
name|mpt
operator|->
name|raid_thread
argument_list|,
name|PUSER
argument_list|,
literal|"thtrm"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mpt_cam_rescan_callback
parameter_list|(
name|struct
name|cam_periph
modifier|*
name|periph
parameter_list|,
name|union
name|ccb
modifier|*
name|ccb
parameter_list|)
block|{
name|xpt_free_path
argument_list|(
name|ccb
operator|->
name|ccb_h
operator|.
name|path
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|ccb
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mpt_raid_thread
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|mpt_softc
modifier|*
name|mpt
decl_stmt|;
name|int
name|firstrun
decl_stmt|;
if|#
directive|if
name|__FreeBSD_version
operator|>=
literal|500000
name|mtx_lock
argument_list|(
operator|&
name|Giant
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|mpt
operator|=
operator|(
expr|struct
name|mpt_softc
operator|*
operator|)
name|arg
expr_stmt|;
name|firstrun
operator|=
literal|1
expr_stmt|;
name|MPT_LOCK
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
while|while
condition|(
name|mpt
operator|->
name|shutdwn_raid
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|mpt
operator|->
name|raid_wakeup
operator|==
literal|0
condition|)
block|{
name|mpt_sleep
argument_list|(
name|mpt
argument_list|,
operator|&
name|mpt
operator|->
name|raid_volumes
argument_list|,
name|PUSER
argument_list|,
literal|"idle"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|mpt
operator|->
name|raid_wakeup
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|mpt_refresh_raid_data
argument_list|(
name|mpt
argument_list|)
condition|)
block|{
name|mpt_schedule_raid_refresh
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
comment|/* XX NOT QUITE RIGHT */
continue|continue;
block|}
comment|/* 		 * Now that we have our first snapshot of RAID data, 		 * allow CAM to access our physical disk bus. 		 */
if|if
condition|(
name|firstrun
condition|)
block|{
name|firstrun
operator|=
literal|0
expr_stmt|;
name|MPTLOCK_2_CAMLOCK
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
name|xpt_release_simq
argument_list|(
name|mpt
operator|->
name|phydisk_sim
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|CAMLOCK_2_MPTLOCK
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mpt
operator|->
name|raid_rescan
operator|!=
literal|0
condition|)
block|{
name|union
name|ccb
modifier|*
name|ccb
decl_stmt|;
name|struct
name|cam_path
modifier|*
name|path
decl_stmt|;
name|int
name|error
decl_stmt|;
name|mpt
operator|->
name|raid_rescan
operator|=
literal|0
expr_stmt|;
name|ccb
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|ccb
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|error
operator|=
name|xpt_create_path
argument_list|(
operator|&
name|path
argument_list|,
name|xpt_periph
argument_list|,
name|cam_sim_path
argument_list|(
name|mpt
operator|->
name|phydisk_sim
argument_list|)
argument_list|,
name|CAM_TARGET_WILDCARD
argument_list|,
name|CAM_LUN_WILDCARD
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|CAM_REQ_CMP
condition|)
block|{
name|free
argument_list|(
name|ccb
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"Unable to rescan RAID Bus!\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|xpt_setup_ccb
argument_list|(
operator|&
name|ccb
operator|->
name|ccb_h
argument_list|,
name|path
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|func_code
operator|=
name|XPT_SCAN_BUS
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|cbfcnp
operator|=
name|mpt_cam_rescan_callback
expr_stmt|;
name|ccb
operator|->
name|crcn
operator|.
name|flags
operator|=
name|CAM_FLAG_NONE
expr_stmt|;
name|MPTLOCK_2_CAMLOCK
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
name|xpt_action
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
name|CAMLOCK_2_MPTLOCK
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|mpt
operator|->
name|raid_thread
operator|=
name|NULL
expr_stmt|;
name|wakeup
argument_list|(
operator|&
name|mpt
operator|->
name|raid_thread
argument_list|)
expr_stmt|;
name|MPT_UNLOCK
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
if|#
directive|if
name|__FreeBSD_version
operator|>=
literal|500000
name|mtx_unlock
argument_list|(
operator|&
name|Giant
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|kthread_exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_if
if|#
directive|if
literal|0
end_if

begin_comment
unit|static void mpt_raid_quiesce_timeout(void *arg) {
comment|/* Complete the CCB with error */
end_comment

begin_comment
comment|/* COWWWW */
end_comment

begin_comment
unit|}  static timeout_t mpt_raid_quiesce_timeout; cam_status mpt_raid_quiesce_disk(struct mpt_softc *mpt, struct mpt_raid_disk *mpt_disk, 		      request_t *req) { 	union ccb *ccb;  	ccb = req->ccb; 	if ((mpt_disk->flags& MPT_RDF_QUIESCED) != 0) 		return (CAM_REQ_CMP);  	if ((mpt_disk->flags& MPT_RDF_QUIESCING) == 0) { 		int rv;  		mpt_disk->flags |= MPT_RDF_QUIESCING; 		xpt_freeze_devq(ccb->ccb_h.path, 1); 		 		rv = mpt_issue_raid_req(mpt, mpt_disk->volume, mpt_disk, req, 					MPI_RAID_ACTION_QUIESCE_PHYS_IO,
comment|/*ActionData*/
end_comment

begin_comment
unit|0,
comment|/*addr*/
end_comment

begin_comment
unit|0,
comment|/*len*/
end_comment

begin_comment
unit|0,
comment|/*write*/
end_comment

begin_comment
unit|FALSE,
comment|/*wait*/
end_comment

begin_if
unit|FALSE); 		if (rv != 0) 			return (CAM_REQ_CMP_ERR);  		ccb->ccb_h.timeout_ch = 			timeout(mpt_raid_quiesce_timeout, (caddr_t)ccb, 5 * hz);
if|#
directive|if
literal|0
end_if

begin_comment
unit|if (rv == ETIMEDOUT) { 			mpt_disk_prt(mpt, mpt_disk, "mpt_raid_quiesce_disk: " 				     "Quiece Timed-out\n"); 			xpt_release_devq(ccb->ccb_h.path, 1,
comment|/*run*/
end_comment

begin_comment
unit|0); 			return (CAM_REQ_CMP_ERR); 		}  		ar = REQ_TO_RAID_ACTION_RESULT(req); 		if (rv != 0 		 || REQ_IOCSTATUS(req) != MPI_IOCSTATUS_SUCCESS 		 || (ar->action_status != MPI_RAID_ACTION_ASTATUS_SUCCESS)) { 			mpt_disk_prt(mpt, mpt_disk, "Quiece Failed" 				    "%d:%x:%x\n", rv, req->IOCStatus, 				    ar->action_status); 			xpt_release_devq(ccb->ccb_h.path, 1,
comment|/*run*/
end_comment

begin_endif
unit|0); 			return (CAM_REQ_CMP_ERR); 		}
endif|#
directive|endif
end_endif

begin_endif
unit|return (CAM_REQ_INPROG); 	} 	return (CAM_REQUEUE_REQ); }
endif|#
directive|endif
end_endif

begin_comment
comment|/* XXX Ignores that there may be multiple busses/IOCs involved. */
end_comment

begin_function
name|cam_status
name|mpt_map_physdisk
parameter_list|(
name|struct
name|mpt_softc
modifier|*
name|mpt
parameter_list|,
name|union
name|ccb
modifier|*
name|ccb
parameter_list|,
name|u_int
modifier|*
name|tgt
parameter_list|)
block|{
name|struct
name|mpt_raid_disk
modifier|*
name|mpt_disk
decl_stmt|;
name|mpt_disk
operator|=
name|mpt
operator|->
name|raid_disks
operator|+
name|ccb
operator|->
name|ccb_h
operator|.
name|target_id
expr_stmt|;
if|if
condition|(
name|ccb
operator|->
name|ccb_h
operator|.
name|target_id
operator|<
name|mpt
operator|->
name|raid_max_disks
operator|&&
operator|(
name|mpt_disk
operator|->
name|flags
operator|&
name|MPT_RDF_ACTIVE
operator|)
operator|!=
literal|0
condition|)
block|{
operator|*
name|tgt
operator|=
name|mpt_disk
operator|->
name|config_page
operator|.
name|PhysDiskID
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|mpt_lprt
argument_list|(
name|mpt
argument_list|,
name|MPT_PRT_DEBUG1
argument_list|,
literal|"mpt_map_physdisk(%d) - Not Active\n"
argument_list|,
name|ccb
operator|->
name|ccb_h
operator|.
name|target_id
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/* XXX Ignores that there may be multiple busses/IOCs involved. */
end_comment

begin_function
name|int
name|mpt_is_raid_volume
parameter_list|(
name|struct
name|mpt_softc
modifier|*
name|mpt
parameter_list|,
name|int
name|tgt
parameter_list|)
block|{
name|CONFIG_PAGE_IOC_2_RAID_VOL
modifier|*
name|ioc_vol
decl_stmt|;
name|CONFIG_PAGE_IOC_2_RAID_VOL
modifier|*
name|ioc_last_vol
decl_stmt|;
if|if
condition|(
name|mpt
operator|->
name|ioc_page2
operator|==
name|NULL
operator|||
name|mpt
operator|->
name|ioc_page2
operator|->
name|MaxPhysDisks
operator|==
literal|0
condition|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|ioc_vol
operator|=
name|mpt
operator|->
name|ioc_page2
operator|->
name|RaidVolume
expr_stmt|;
name|ioc_last_vol
operator|=
name|ioc_vol
operator|+
name|mpt
operator|->
name|ioc_page2
operator|->
name|NumActiveVolumes
expr_stmt|;
for|for
control|(
init|;
name|ioc_vol
operator|!=
name|ioc_last_vol
condition|;
name|ioc_vol
operator|++
control|)
block|{
if|if
condition|(
name|ioc_vol
operator|->
name|VolumeID
operator|==
name|tgt
condition|)
block|{
return|return
operator|(
literal|1
operator|)
return|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_if
if|#
directive|if
literal|0
end_if

begin_comment
unit|static void mpt_enable_vol(struct mpt_softc *mpt, struct mpt_raid_volume *mpt_vol, 	       int enable) { 	request_t *req; 	struct mpt_raid_action_result *ar; 	CONFIG_PAGE_RAID_VOL_0 *vol_pg; 	int enabled; 	int rv;  	vol_pg = mpt_vol->config_page; 	enabled = vol_pg->VolumeStatus.Flags& MPI_RAIDVOL0_STATUS_FLAG_ENABLED;
comment|/* 	 * If the setting matches the configuration, 	 * there is nothing to do. 	 */
end_comment

begin_comment
unit|if ((enabled&& enable) 	 || (!enabled&& !enable)) 		return;  	req = mpt_get_request(mpt,
comment|/*sleep_ok*/
end_comment

begin_comment
unit|TRUE); 	if (req == NULL) { 		mpt_vol_prt(mpt, mpt_vol, 			    "mpt_enable_vol: Get request failed!\n"); 		return; 	}  	rv = mpt_issue_raid_req(mpt, mpt_vol,
comment|/*disk*/
end_comment

begin_comment
unit|NULL, req, 				enable ? MPI_RAID_ACTION_ENABLE_VOLUME 				       : MPI_RAID_ACTION_DISABLE_VOLUME,
comment|/*data*/
end_comment

begin_comment
unit|0,
comment|/*addr*/
end_comment

begin_comment
unit|0,
comment|/*len*/
end_comment

begin_comment
unit|0,
comment|/*write*/
end_comment

begin_comment
unit|FALSE,
comment|/*wait*/
end_comment

begin_endif
unit|TRUE); 	if (rv == ETIMEDOUT) { 		mpt_vol_prt(mpt, mpt_vol, "mpt_enable_vol: " 			    "%s Volume Timed-out\n", 			    enable ? "Enable" : "Disable"); 		return; 	} 	ar = REQ_TO_RAID_ACTION_RESULT(req); 	if (rv != 0 	 || REQ_IOCSTATUS(req) != MPI_IOCSTATUS_SUCCESS 	 || (ar->action_status != MPI_RAID_ACTION_ASTATUS_SUCCESS)) { 		mpt_vol_prt(mpt, mpt_vol, "%s Volume Failed: %d:%x:%x\n", 			    enable ? "Enable" : "Disable", 			    rv, req->IOCStatus, ar->action_status); 	}  	mpt_free_request(mpt, req); }
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|void
name|mpt_verify_mwce
parameter_list|(
name|struct
name|mpt_softc
modifier|*
name|mpt
parameter_list|,
name|struct
name|mpt_raid_volume
modifier|*
name|mpt_vol
parameter_list|)
block|{
name|request_t
modifier|*
name|req
decl_stmt|;
name|struct
name|mpt_raid_action_result
modifier|*
name|ar
decl_stmt|;
name|CONFIG_PAGE_RAID_VOL_0
modifier|*
name|vol_pg
decl_stmt|;
name|uint32_t
name|data
decl_stmt|;
name|int
name|rv
decl_stmt|;
name|int
name|resyncing
decl_stmt|;
name|int
name|mwce
decl_stmt|;
name|vol_pg
operator|=
name|mpt_vol
operator|->
name|config_page
expr_stmt|;
name|resyncing
operator|=
name|vol_pg
operator|->
name|VolumeStatus
operator|.
name|Flags
operator|&
name|MPI_RAIDVOL0_STATUS_FLAG_RESYNC_IN_PROGRESS
expr_stmt|;
name|mwce
operator|=
name|vol_pg
operator|->
name|VolumeSettings
operator|.
name|Settings
operator|&
name|MPI_RAIDVOL0_SETTING_WRITE_CACHING_ENABLE
expr_stmt|;
comment|/* 	 * If the setting matches the configuration, 	 * there is nothing to do. 	 */
switch|switch
condition|(
name|mpt
operator|->
name|raid_mwce_setting
condition|)
block|{
case|case
name|MPT_RAID_MWCE_REBUILD_ONLY
case|:
if|if
condition|(
operator|(
name|resyncing
operator|&&
name|mwce
operator|)
operator|||
operator|(
operator|!
name|resyncing
operator|&&
operator|!
name|mwce
operator|)
condition|)
block|{
return|return;
block|}
name|mpt_vol
operator|->
name|flags
operator|^=
name|MPT_RVF_WCE_CHANGED
expr_stmt|;
if|if
condition|(
operator|(
name|mpt_vol
operator|->
name|flags
operator|&
name|MPT_RVF_WCE_CHANGED
operator|)
operator|==
literal|0
condition|)
block|{
comment|/* 			 * Wait one more status update to see if 			 * resyncing gets enabled.  It gets disabled 			 * temporarilly when WCE is changed. 			 */
return|return;
block|}
break|break;
case|case
name|MPT_RAID_MWCE_ON
case|:
if|if
condition|(
name|mwce
condition|)
return|return;
break|break;
case|case
name|MPT_RAID_MWCE_OFF
case|:
if|if
condition|(
operator|!
name|mwce
condition|)
return|return;
break|break;
case|case
name|MPT_RAID_MWCE_NC
case|:
return|return;
block|}
name|req
operator|=
name|mpt_get_request
argument_list|(
name|mpt
argument_list|,
comment|/*sleep_ok*/
name|TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|==
name|NULL
condition|)
block|{
name|mpt_vol_prt
argument_list|(
name|mpt
argument_list|,
name|mpt_vol
argument_list|,
literal|"mpt_verify_mwce: Get request failed!\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|vol_pg
operator|->
name|VolumeSettings
operator|.
name|Settings
operator|^=
name|MPI_RAIDVOL0_SETTING_WRITE_CACHING_ENABLE
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|data
argument_list|,
operator|&
name|vol_pg
operator|->
name|VolumeSettings
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|vol_pg
operator|->
name|VolumeSettings
operator|.
name|Settings
operator|^=
name|MPI_RAIDVOL0_SETTING_WRITE_CACHING_ENABLE
expr_stmt|;
name|rv
operator|=
name|mpt_issue_raid_req
argument_list|(
name|mpt
argument_list|,
name|mpt_vol
argument_list|,
comment|/*disk*/
name|NULL
argument_list|,
name|req
argument_list|,
name|MPI_RAID_ACTION_CHANGE_VOLUME_SETTINGS
argument_list|,
name|data
argument_list|,
comment|/*addr*/
literal|0
argument_list|,
comment|/*len*/
literal|0
argument_list|,
comment|/*write*/
name|FALSE
argument_list|,
comment|/*wait*/
name|TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|==
name|ETIMEDOUT
condition|)
block|{
name|mpt_vol_prt
argument_list|(
name|mpt
argument_list|,
name|mpt_vol
argument_list|,
literal|"mpt_verify_mwce: "
literal|"Write Cache Enable Timed-out\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|ar
operator|=
name|REQ_TO_RAID_ACTION_RESULT
argument_list|(
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
operator|||
name|REQ_IOCSTATUS
argument_list|(
name|req
argument_list|)
operator|!=
name|MPI_IOCSTATUS_SUCCESS
operator|||
operator|(
name|ar
operator|->
name|action_status
operator|!=
name|MPI_RAID_ACTION_ASTATUS_SUCCESS
operator|)
condition|)
block|{
name|mpt_vol_prt
argument_list|(
name|mpt
argument_list|,
name|mpt_vol
argument_list|,
literal|"Write Cache Enable Failed: "
literal|"%d:%x:%x\n"
argument_list|,
name|rv
argument_list|,
name|req
operator|->
name|IOCStatus
argument_list|,
name|ar
operator|->
name|action_status
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|vol_pg
operator|->
name|VolumeSettings
operator|.
name|Settings
operator|^=
name|MPI_RAIDVOL0_SETTING_WRITE_CACHING_ENABLE
expr_stmt|;
block|}
name|mpt_free_request
argument_list|(
name|mpt
argument_list|,
name|req
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mpt_verify_resync_rate
parameter_list|(
name|struct
name|mpt_softc
modifier|*
name|mpt
parameter_list|,
name|struct
name|mpt_raid_volume
modifier|*
name|mpt_vol
parameter_list|)
block|{
name|request_t
modifier|*
name|req
decl_stmt|;
name|struct
name|mpt_raid_action_result
modifier|*
name|ar
decl_stmt|;
name|CONFIG_PAGE_RAID_VOL_0
modifier|*
name|vol_pg
decl_stmt|;
name|u_int
name|prio
decl_stmt|;
name|int
name|rv
decl_stmt|;
name|vol_pg
operator|=
name|mpt_vol
operator|->
name|config_page
expr_stmt|;
if|if
condition|(
name|mpt
operator|->
name|raid_resync_rate
operator|==
name|MPT_RAID_RESYNC_RATE_NC
condition|)
return|return;
comment|/* 	 * If the current RAID resync rate does not 	 * match our configured rate, update it. 	 */
name|prio
operator|=
name|vol_pg
operator|->
name|VolumeSettings
operator|.
name|Settings
operator|&
name|MPI_RAIDVOL0_SETTING_PRIORITY_RESYNC
expr_stmt|;
if|if
condition|(
name|vol_pg
operator|->
name|ResyncRate
operator|!=
literal|0
operator|&&
name|vol_pg
operator|->
name|ResyncRate
operator|!=
name|mpt
operator|->
name|raid_resync_rate
condition|)
block|{
name|req
operator|=
name|mpt_get_request
argument_list|(
name|mpt
argument_list|,
comment|/*sleep_ok*/
name|TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|==
name|NULL
condition|)
block|{
name|mpt_vol_prt
argument_list|(
name|mpt
argument_list|,
name|mpt_vol
argument_list|,
literal|"mpt_verify_resync_rate: "
literal|"Get request failed!\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|rv
operator|=
name|mpt_issue_raid_req
argument_list|(
name|mpt
argument_list|,
name|mpt_vol
argument_list|,
comment|/*disk*/
name|NULL
argument_list|,
name|req
argument_list|,
name|MPI_RAID_ACTION_SET_RESYNC_RATE
argument_list|,
name|mpt
operator|->
name|raid_resync_rate
argument_list|,
comment|/*addr*/
literal|0
argument_list|,
comment|/*len*/
literal|0
argument_list|,
comment|/*write*/
name|FALSE
argument_list|,
comment|/*wait*/
name|TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|==
name|ETIMEDOUT
condition|)
block|{
name|mpt_vol_prt
argument_list|(
name|mpt
argument_list|,
name|mpt_vol
argument_list|,
literal|"mpt_refresh_raid_data: "
literal|"Resync Rate Setting Timed-out\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|ar
operator|=
name|REQ_TO_RAID_ACTION_RESULT
argument_list|(
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
operator|||
name|REQ_IOCSTATUS
argument_list|(
name|req
argument_list|)
operator|!=
name|MPI_IOCSTATUS_SUCCESS
operator|||
operator|(
name|ar
operator|->
name|action_status
operator|!=
name|MPI_RAID_ACTION_ASTATUS_SUCCESS
operator|)
condition|)
block|{
name|mpt_vol_prt
argument_list|(
name|mpt
argument_list|,
name|mpt_vol
argument_list|,
literal|"Resync Rate Setting Failed: "
literal|"%d:%x:%x\n"
argument_list|,
name|rv
argument_list|,
name|req
operator|->
name|IOCStatus
argument_list|,
name|ar
operator|->
name|action_status
argument_list|)
expr_stmt|;
block|}
else|else
name|vol_pg
operator|->
name|ResyncRate
operator|=
name|mpt
operator|->
name|raid_resync_rate
expr_stmt|;
name|mpt_free_request
argument_list|(
name|mpt
argument_list|,
name|req
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|prio
operator|&&
name|mpt
operator|->
name|raid_resync_rate
operator|<
literal|128
operator|)
operator|||
operator|(
operator|!
name|prio
operator|&&
name|mpt
operator|->
name|raid_resync_rate
operator|>=
literal|128
operator|)
condition|)
block|{
name|uint32_t
name|data
decl_stmt|;
name|req
operator|=
name|mpt_get_request
argument_list|(
name|mpt
argument_list|,
comment|/*sleep_ok*/
name|TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|==
name|NULL
condition|)
block|{
name|mpt_vol_prt
argument_list|(
name|mpt
argument_list|,
name|mpt_vol
argument_list|,
literal|"mpt_verify_resync_rate: "
literal|"Get request failed!\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|vol_pg
operator|->
name|VolumeSettings
operator|.
name|Settings
operator|^=
name|MPI_RAIDVOL0_SETTING_PRIORITY_RESYNC
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|data
argument_list|,
operator|&
name|vol_pg
operator|->
name|VolumeSettings
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|vol_pg
operator|->
name|VolumeSettings
operator|.
name|Settings
operator|^=
name|MPI_RAIDVOL0_SETTING_PRIORITY_RESYNC
expr_stmt|;
name|rv
operator|=
name|mpt_issue_raid_req
argument_list|(
name|mpt
argument_list|,
name|mpt_vol
argument_list|,
comment|/*disk*/
name|NULL
argument_list|,
name|req
argument_list|,
name|MPI_RAID_ACTION_CHANGE_VOLUME_SETTINGS
argument_list|,
name|data
argument_list|,
comment|/*addr*/
literal|0
argument_list|,
comment|/*len*/
literal|0
argument_list|,
comment|/*write*/
name|FALSE
argument_list|,
comment|/*wait*/
name|TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|==
name|ETIMEDOUT
condition|)
block|{
name|mpt_vol_prt
argument_list|(
name|mpt
argument_list|,
name|mpt_vol
argument_list|,
literal|"mpt_refresh_raid_data: "
literal|"Resync Rate Setting Timed-out\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|ar
operator|=
name|REQ_TO_RAID_ACTION_RESULT
argument_list|(
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
operator|||
name|REQ_IOCSTATUS
argument_list|(
name|req
argument_list|)
operator|!=
name|MPI_IOCSTATUS_SUCCESS
operator|||
operator|(
name|ar
operator|->
name|action_status
operator|!=
name|MPI_RAID_ACTION_ASTATUS_SUCCESS
operator|)
condition|)
block|{
name|mpt_vol_prt
argument_list|(
name|mpt
argument_list|,
name|mpt_vol
argument_list|,
literal|"Resync Rate Setting Failed: "
literal|"%d:%x:%x\n"
argument_list|,
name|rv
argument_list|,
name|req
operator|->
name|IOCStatus
argument_list|,
name|ar
operator|->
name|action_status
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|vol_pg
operator|->
name|VolumeSettings
operator|.
name|Settings
operator|^=
name|MPI_RAIDVOL0_SETTING_PRIORITY_RESYNC
expr_stmt|;
block|}
name|mpt_free_request
argument_list|(
name|mpt
argument_list|,
name|req
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|mpt_adjust_queue_depth
parameter_list|(
name|struct
name|mpt_softc
modifier|*
name|mpt
parameter_list|,
name|struct
name|mpt_raid_volume
modifier|*
name|mpt_vol
parameter_list|,
name|struct
name|cam_path
modifier|*
name|path
parameter_list|)
block|{
name|struct
name|ccb_relsim
name|crs
decl_stmt|;
name|xpt_setup_ccb
argument_list|(
operator|&
name|crs
operator|.
name|ccb_h
argument_list|,
name|path
argument_list|,
comment|/*priority*/
literal|5
argument_list|)
expr_stmt|;
name|crs
operator|.
name|ccb_h
operator|.
name|func_code
operator|=
name|XPT_REL_SIMQ
expr_stmt|;
name|crs
operator|.
name|release_flags
operator|=
name|RELSIM_ADJUST_OPENINGS
expr_stmt|;
name|crs
operator|.
name|openings
operator|=
name|mpt
operator|->
name|raid_queue_depth
expr_stmt|;
name|xpt_action
argument_list|(
operator|(
expr|union
name|ccb
operator|*
operator|)
operator|&
name|crs
argument_list|)
expr_stmt|;
if|if
condition|(
name|crs
operator|.
name|ccb_h
operator|.
name|status
operator|!=
name|CAM_REQ_CMP
condition|)
name|mpt_vol_prt
argument_list|(
name|mpt
argument_list|,
name|mpt_vol
argument_list|,
literal|"mpt_adjust_queue_depth failed "
literal|"with CAM status %#x\n"
argument_list|,
name|crs
operator|.
name|ccb_h
operator|.
name|status
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mpt_announce_vol
parameter_list|(
name|struct
name|mpt_softc
modifier|*
name|mpt
parameter_list|,
name|struct
name|mpt_raid_volume
modifier|*
name|mpt_vol
parameter_list|)
block|{
name|CONFIG_PAGE_RAID_VOL_0
modifier|*
name|vol_pg
decl_stmt|;
name|u_int
name|i
decl_stmt|;
name|vol_pg
operator|=
name|mpt_vol
operator|->
name|config_page
expr_stmt|;
name|mpt_vol_prt
argument_list|(
name|mpt
argument_list|,
name|mpt_vol
argument_list|,
literal|"Settings ("
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
literal|0x8000
condition|;
name|i
operator|<<=
literal|1
control|)
block|{
switch|switch
condition|(
name|vol_pg
operator|->
name|VolumeSettings
operator|.
name|Settings
operator|&
name|i
condition|)
block|{
case|case
name|MPI_RAIDVOL0_SETTING_WRITE_CACHING_ENABLE
case|:
name|mpt_prtc
argument_list|(
name|mpt
argument_list|,
literal|" Member-WCE"
argument_list|)
expr_stmt|;
break|break;
case|case
name|MPI_RAIDVOL0_SETTING_OFFLINE_ON_SMART
case|:
name|mpt_prtc
argument_list|(
name|mpt
argument_list|,
literal|" Offline-On-SMART-Err"
argument_list|)
expr_stmt|;
break|break;
case|case
name|MPI_RAIDVOL0_SETTING_AUTO_CONFIGURE
case|:
name|mpt_prtc
argument_list|(
name|mpt
argument_list|,
literal|" Hot-Plug-Spares"
argument_list|)
expr_stmt|;
break|break;
case|case
name|MPI_RAIDVOL0_SETTING_PRIORITY_RESYNC
case|:
name|mpt_prtc
argument_list|(
name|mpt
argument_list|,
literal|" High-Priority-ReSync"
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
name|mpt_prtc
argument_list|(
name|mpt
argument_list|,
literal|" )\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|vol_pg
operator|->
name|VolumeSettings
operator|.
name|HotSparePool
operator|!=
literal|0
condition|)
block|{
name|mpt_vol_prt
argument_list|(
name|mpt
argument_list|,
name|mpt_vol
argument_list|,
literal|"Using Spare Pool%s"
argument_list|,
name|powerof2
argument_list|(
name|vol_pg
operator|->
name|VolumeSettings
operator|.
name|HotSparePool
argument_list|)
condition|?
literal|":"
else|:
literal|"s:"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
block|{
name|u_int
name|mask
decl_stmt|;
name|mask
operator|=
literal|0x1
operator|<<
name|i
expr_stmt|;
if|if
condition|(
operator|(
name|vol_pg
operator|->
name|VolumeSettings
operator|.
name|HotSparePool
operator|&
name|mask
operator|)
operator|==
literal|0
condition|)
continue|continue;
name|mpt_prtc
argument_list|(
name|mpt
argument_list|,
literal|" %d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
name|mpt_prtc
argument_list|(
name|mpt
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|mpt_vol_prt
argument_list|(
name|mpt
argument_list|,
name|mpt_vol
argument_list|,
literal|"%d Members:\n"
argument_list|,
name|vol_pg
operator|->
name|NumPhysDisks
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|vol_pg
operator|->
name|NumPhysDisks
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|mpt_raid_disk
modifier|*
name|mpt_disk
decl_stmt|;
name|CONFIG_PAGE_RAID_PHYS_DISK_0
modifier|*
name|disk_pg
decl_stmt|;
name|int
name|pt_bus
init|=
name|cam_sim_bus
argument_list|(
name|mpt
operator|->
name|phydisk_sim
argument_list|)
decl_stmt|;
name|U8
name|f
decl_stmt|,
name|s
decl_stmt|;
name|mpt_disk
operator|=
name|mpt
operator|->
name|raid_disks
operator|+
name|vol_pg
operator|->
name|PhysDisk
index|[
name|i
index|]
operator|.
name|PhysDiskNum
expr_stmt|;
name|disk_pg
operator|=
operator|&
name|mpt_disk
operator|->
name|config_page
expr_stmt|;
name|mpt_prtc
argument_list|(
name|mpt
argument_list|,
literal|"      "
argument_list|)
expr_stmt|;
name|mpt_prtc
argument_list|(
name|mpt
argument_list|,
literal|"(%s:%d:%d:0): "
argument_list|,
name|device_get_nameunit
argument_list|(
name|mpt
operator|->
name|dev
argument_list|)
argument_list|,
name|pt_bus
argument_list|,
name|disk_pg
operator|->
name|PhysDiskID
argument_list|)
expr_stmt|;
if|if
condition|(
name|vol_pg
operator|->
name|VolumeType
operator|==
name|MPI_RAID_VOL_TYPE_IM
condition|)
block|{
name|mpt_prtc
argument_list|(
name|mpt
argument_list|,
literal|"%s"
argument_list|,
name|mpt_disk
operator|->
name|member_number
operator|==
literal|0
condition|?
literal|"Primary"
else|:
literal|"Secondary"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|mpt_prtc
argument_list|(
name|mpt
argument_list|,
literal|"Stripe Position %d"
argument_list|,
name|mpt_disk
operator|->
name|member_number
argument_list|)
expr_stmt|;
block|}
name|f
operator|=
name|disk_pg
operator|->
name|PhysDiskStatus
operator|.
name|Flags
expr_stmt|;
name|s
operator|=
name|disk_pg
operator|->
name|PhysDiskStatus
operator|.
name|State
expr_stmt|;
if|if
condition|(
name|f
operator|&
name|MPI_PHYSDISK0_STATUS_FLAG_OUT_OF_SYNC
condition|)
block|{
name|mpt_prtc
argument_list|(
name|mpt
argument_list|,
literal|" Out of Sync"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|f
operator|&
name|MPI_PHYSDISK0_STATUS_FLAG_QUIESCED
condition|)
block|{
name|mpt_prtc
argument_list|(
name|mpt
argument_list|,
literal|" Quiesced"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|f
operator|&
name|MPI_PHYSDISK0_STATUS_FLAG_INACTIVE_VOLUME
condition|)
block|{
name|mpt_prtc
argument_list|(
name|mpt
argument_list|,
literal|" Inactive"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|f
operator|&
name|MPI_PHYSDISK0_STATUS_FLAG_OPTIMAL_PREVIOUS
condition|)
block|{
name|mpt_prtc
argument_list|(
name|mpt
argument_list|,
literal|" Was Optimal"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|f
operator|&
name|MPI_PHYSDISK0_STATUS_FLAG_NOT_OPTIMAL_PREVIOUS
condition|)
block|{
name|mpt_prtc
argument_list|(
name|mpt
argument_list|,
literal|" Was Non-Optimal"
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|s
condition|)
block|{
case|case
name|MPI_PHYSDISK0_STATUS_ONLINE
case|:
name|mpt_prtc
argument_list|(
name|mpt
argument_list|,
literal|" Online"
argument_list|)
expr_stmt|;
break|break;
case|case
name|MPI_PHYSDISK0_STATUS_MISSING
case|:
name|mpt_prtc
argument_list|(
name|mpt
argument_list|,
literal|" Missing"
argument_list|)
expr_stmt|;
break|break;
case|case
name|MPI_PHYSDISK0_STATUS_NOT_COMPATIBLE
case|:
name|mpt_prtc
argument_list|(
name|mpt
argument_list|,
literal|" Incompatible"
argument_list|)
expr_stmt|;
break|break;
case|case
name|MPI_PHYSDISK0_STATUS_FAILED
case|:
name|mpt_prtc
argument_list|(
name|mpt
argument_list|,
literal|" Failed"
argument_list|)
expr_stmt|;
break|break;
case|case
name|MPI_PHYSDISK0_STATUS_INITIALIZING
case|:
name|mpt_prtc
argument_list|(
name|mpt
argument_list|,
literal|" Initializing"
argument_list|)
expr_stmt|;
break|break;
case|case
name|MPI_PHYSDISK0_STATUS_OFFLINE_REQUESTED
case|:
name|mpt_prtc
argument_list|(
name|mpt
argument_list|,
literal|" Requested Offline"
argument_list|)
expr_stmt|;
break|break;
case|case
name|MPI_PHYSDISK0_STATUS_FAILED_REQUESTED
case|:
name|mpt_prtc
argument_list|(
name|mpt
argument_list|,
literal|" Requested Failed"
argument_list|)
expr_stmt|;
break|break;
case|case
name|MPI_PHYSDISK0_STATUS_OTHER_OFFLINE
case|:
default|default:
name|mpt_prtc
argument_list|(
name|mpt
argument_list|,
literal|" Offline Other (%x)"
argument_list|,
name|s
argument_list|)
expr_stmt|;
break|break;
block|}
name|mpt_prtc
argument_list|(
name|mpt
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|mpt_announce_disk
parameter_list|(
name|struct
name|mpt_softc
modifier|*
name|mpt
parameter_list|,
name|struct
name|mpt_raid_disk
modifier|*
name|mpt_disk
parameter_list|)
block|{
name|CONFIG_PAGE_RAID_PHYS_DISK_0
modifier|*
name|disk_pg
decl_stmt|;
name|int
name|rd_bus
init|=
name|cam_sim_bus
argument_list|(
name|mpt
operator|->
name|sim
argument_list|)
decl_stmt|;
name|int
name|pt_bus
init|=
name|cam_sim_bus
argument_list|(
name|mpt
operator|->
name|phydisk_sim
argument_list|)
decl_stmt|;
name|u_int
name|i
decl_stmt|;
name|disk_pg
operator|=
operator|&
name|mpt_disk
operator|->
name|config_page
expr_stmt|;
name|mpt_disk_prt
argument_list|(
name|mpt
argument_list|,
name|mpt_disk
argument_list|,
literal|"Physical (%s:%d:%d:0), Pass-thru (%s:%d:%d:0)\n"
argument_list|,
name|device_get_nameunit
argument_list|(
name|mpt
operator|->
name|dev
argument_list|)
argument_list|,
name|rd_bus
argument_list|,
name|disk_pg
operator|->
name|PhysDiskID
argument_list|,
name|device_get_nameunit
argument_list|(
name|mpt
operator|->
name|dev
argument_list|)
argument_list|,
name|pt_bus
argument_list|,
name|mpt_disk
operator|-
name|mpt
operator|->
name|raid_disks
argument_list|)
expr_stmt|;
if|if
condition|(
name|disk_pg
operator|->
name|PhysDiskSettings
operator|.
name|HotSparePool
operator|==
literal|0
condition|)
return|return;
name|mpt_disk_prt
argument_list|(
name|mpt
argument_list|,
name|mpt_disk
argument_list|,
literal|"Member of Hot Spare Pool%s"
argument_list|,
name|powerof2
argument_list|(
name|disk_pg
operator|->
name|PhysDiskSettings
operator|.
name|HotSparePool
argument_list|)
condition|?
literal|":"
else|:
literal|"s:"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
block|{
name|u_int
name|mask
decl_stmt|;
name|mask
operator|=
literal|0x1
operator|<<
name|i
expr_stmt|;
if|if
condition|(
operator|(
name|disk_pg
operator|->
name|PhysDiskSettings
operator|.
name|HotSparePool
operator|&
name|mask
operator|)
operator|==
literal|0
condition|)
continue|continue;
name|mpt_prtc
argument_list|(
name|mpt
argument_list|,
literal|" %d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
name|mpt_prtc
argument_list|(
name|mpt
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mpt_refresh_raid_disk
parameter_list|(
name|struct
name|mpt_softc
modifier|*
name|mpt
parameter_list|,
name|struct
name|mpt_raid_disk
modifier|*
name|mpt_disk
parameter_list|,
name|IOC_3_PHYS_DISK
modifier|*
name|ioc_disk
parameter_list|)
block|{
name|int
name|rv
decl_stmt|;
name|rv
operator|=
name|mpt_read_cfg_header
argument_list|(
name|mpt
argument_list|,
name|MPI_CONFIG_PAGETYPE_RAID_PHYSDISK
argument_list|,
comment|/*PageNumber*/
literal|0
argument_list|,
name|ioc_disk
operator|->
name|PhysDiskNum
argument_list|,
operator|&
name|mpt_disk
operator|->
name|config_page
operator|.
name|Header
argument_list|,
comment|/*sleep_ok*/
name|TRUE
argument_list|,
comment|/*timeout_ms*/
literal|5000
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"mpt_refresh_raid_disk: "
literal|"Failed to read RAID Disk Hdr(%d)\n"
argument_list|,
name|ioc_disk
operator|->
name|PhysDiskNum
argument_list|)
expr_stmt|;
return|return;
block|}
name|rv
operator|=
name|mpt_read_cur_cfg_page
argument_list|(
name|mpt
argument_list|,
name|ioc_disk
operator|->
name|PhysDiskNum
argument_list|,
operator|&
name|mpt_disk
operator|->
name|config_page
operator|.
name|Header
argument_list|,
sizeof|sizeof
argument_list|(
name|mpt_disk
operator|->
name|config_page
argument_list|)
argument_list|,
comment|/*sleep_ok*/
name|TRUE
argument_list|,
comment|/*timeout_ms*/
literal|5000
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"mpt_refresh_raid_disk: "
literal|"Failed to read RAID Disk Page(%d)\n"
argument_list|,
name|ioc_disk
operator|->
name|PhysDiskNum
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mpt_refresh_raid_vol
parameter_list|(
name|struct
name|mpt_softc
modifier|*
name|mpt
parameter_list|,
name|struct
name|mpt_raid_volume
modifier|*
name|mpt_vol
parameter_list|,
name|CONFIG_PAGE_IOC_2_RAID_VOL
modifier|*
name|ioc_vol
parameter_list|)
block|{
name|CONFIG_PAGE_RAID_VOL_0
modifier|*
name|vol_pg
decl_stmt|;
name|struct
name|mpt_raid_action_result
modifier|*
name|ar
decl_stmt|;
name|request_t
modifier|*
name|req
decl_stmt|;
name|int
name|rv
decl_stmt|;
name|int
name|i
decl_stmt|;
name|vol_pg
operator|=
name|mpt_vol
operator|->
name|config_page
expr_stmt|;
name|mpt_vol
operator|->
name|flags
operator|&=
operator|~
name|MPT_RVF_UP2DATE
expr_stmt|;
name|rv
operator|=
name|mpt_read_cfg_header
argument_list|(
name|mpt
argument_list|,
name|MPI_CONFIG_PAGETYPE_RAID_VOLUME
argument_list|,
comment|/*PageNumber*/
literal|0
argument_list|,
name|ioc_vol
operator|->
name|VolumePageNumber
argument_list|,
operator|&
name|vol_pg
operator|->
name|Header
argument_list|,
comment|/*sleep_ok*/
name|TRUE
argument_list|,
comment|/*timeout_ms*/
literal|5000
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|mpt_vol_prt
argument_list|(
name|mpt
argument_list|,
name|mpt_vol
argument_list|,
literal|"mpt_refresh_raid_vol: "
literal|"Failed to read RAID Vol Hdr(%d)\n"
argument_list|,
name|ioc_vol
operator|->
name|VolumePageNumber
argument_list|)
expr_stmt|;
return|return;
block|}
name|rv
operator|=
name|mpt_read_cur_cfg_page
argument_list|(
name|mpt
argument_list|,
name|ioc_vol
operator|->
name|VolumePageNumber
argument_list|,
operator|&
name|vol_pg
operator|->
name|Header
argument_list|,
name|mpt
operator|->
name|raid_page0_len
argument_list|,
comment|/*sleep_ok*/
name|TRUE
argument_list|,
comment|/*timeout_ms*/
literal|5000
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|mpt_vol_prt
argument_list|(
name|mpt
argument_list|,
name|mpt_vol
argument_list|,
literal|"mpt_refresh_raid_vol: "
literal|"Failed to read RAID Vol Page(%d)\n"
argument_list|,
name|ioc_vol
operator|->
name|VolumePageNumber
argument_list|)
expr_stmt|;
return|return;
block|}
name|mpt_vol
operator|->
name|flags
operator||=
name|MPT_RVF_ACTIVE
expr_stmt|;
comment|/* Update disk entry array data. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|vol_pg
operator|->
name|NumPhysDisks
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|mpt_raid_disk
modifier|*
name|mpt_disk
decl_stmt|;
name|mpt_disk
operator|=
name|mpt
operator|->
name|raid_disks
operator|+
name|vol_pg
operator|->
name|PhysDisk
index|[
name|i
index|]
operator|.
name|PhysDiskNum
expr_stmt|;
name|mpt_disk
operator|->
name|volume
operator|=
name|mpt_vol
expr_stmt|;
name|mpt_disk
operator|->
name|member_number
operator|=
name|vol_pg
operator|->
name|PhysDisk
index|[
name|i
index|]
operator|.
name|PhysDiskMap
expr_stmt|;
if|if
condition|(
name|vol_pg
operator|->
name|VolumeType
operator|==
name|MPI_RAID_VOL_TYPE_IM
condition|)
block|{
name|mpt_disk
operator|->
name|member_number
operator|--
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|vol_pg
operator|->
name|VolumeStatus
operator|.
name|Flags
operator|&
name|MPI_RAIDVOL0_STATUS_FLAG_RESYNC_IN_PROGRESS
operator|)
operator|==
literal|0
condition|)
return|return;
name|req
operator|=
name|mpt_get_request
argument_list|(
name|mpt
argument_list|,
comment|/*sleep_ok*/
name|TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|==
name|NULL
condition|)
block|{
name|mpt_vol_prt
argument_list|(
name|mpt
argument_list|,
name|mpt_vol
argument_list|,
literal|"mpt_refresh_raid_vol: Get request failed!\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|rv
operator|=
name|mpt_issue_raid_req
argument_list|(
name|mpt
argument_list|,
name|mpt_vol
argument_list|,
comment|/*disk*/
name|NULL
argument_list|,
name|req
argument_list|,
name|MPI_RAID_ACTION_INDICATOR_STRUCT
argument_list|,
comment|/*ActionWord*/
literal|0
argument_list|,
comment|/*addr*/
literal|0
argument_list|,
comment|/*len*/
literal|0
argument_list|,
comment|/*write*/
name|FALSE
argument_list|,
comment|/*wait*/
name|TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|==
name|ETIMEDOUT
condition|)
block|{
name|mpt_vol_prt
argument_list|(
name|mpt
argument_list|,
name|mpt_vol
argument_list|,
literal|"mpt_refresh_raid_vol: "
literal|"Progress indicator fetch timedout!\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|ar
operator|=
name|REQ_TO_RAID_ACTION_RESULT
argument_list|(
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|==
literal|0
operator|&&
name|ar
operator|->
name|action_status
operator|==
name|MPI_RAID_ACTION_ASTATUS_SUCCESS
operator|&&
name|REQ_IOCSTATUS
argument_list|(
name|req
argument_list|)
operator|==
name|MPI_IOCSTATUS_SUCCESS
condition|)
block|{
name|memcpy
argument_list|(
operator|&
name|mpt_vol
operator|->
name|sync_progress
argument_list|,
operator|&
name|ar
operator|->
name|action_data
operator|.
name|indicator_struct
argument_list|,
sizeof|sizeof
argument_list|(
name|mpt_vol
operator|->
name|sync_progress
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|mpt_vol_prt
argument_list|(
name|mpt
argument_list|,
name|mpt_vol
argument_list|,
literal|"mpt_refresh_raid_vol: "
literal|"Progress indicator fetch failed!\n"
argument_list|)
expr_stmt|;
block|}
name|mpt_free_request
argument_list|(
name|mpt
argument_list|,
name|req
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Update in-core information about RAID support.  We update any entries  * that didn't previously exists or have been marked as needing to  * be updated by our event handler.  Interesting changes are displayed  * to the console.  */
end_comment

begin_function
name|int
name|mpt_refresh_raid_data
parameter_list|(
name|struct
name|mpt_softc
modifier|*
name|mpt
parameter_list|)
block|{
name|CONFIG_PAGE_IOC_2_RAID_VOL
modifier|*
name|ioc_vol
decl_stmt|;
name|CONFIG_PAGE_IOC_2_RAID_VOL
modifier|*
name|ioc_last_vol
decl_stmt|;
name|IOC_3_PHYS_DISK
modifier|*
name|ioc_disk
decl_stmt|;
name|IOC_3_PHYS_DISK
modifier|*
name|ioc_last_disk
decl_stmt|;
name|CONFIG_PAGE_RAID_VOL_0
modifier|*
name|vol_pg
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|int
name|rv
decl_stmt|;
name|int
name|i
decl_stmt|;
name|u_int
name|nonopt_volumes
decl_stmt|;
if|if
condition|(
name|mpt
operator|->
name|ioc_page2
operator|==
name|NULL
operator|||
name|mpt
operator|->
name|ioc_page3
operator|==
name|NULL
condition|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
comment|/* 	 * Mark all items as unreferenced by the configuration. 	 * This allows us to find, report, and discard stale 	 * entries. 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|mpt
operator|->
name|ioc_page2
operator|->
name|MaxPhysDisks
condition|;
name|i
operator|++
control|)
block|{
name|mpt
operator|->
name|raid_disks
index|[
name|i
index|]
operator|.
name|flags
operator|&=
operator|~
name|MPT_RDF_REFERENCED
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|mpt
operator|->
name|ioc_page2
operator|->
name|MaxVolumes
condition|;
name|i
operator|++
control|)
block|{
name|mpt
operator|->
name|raid_volumes
index|[
name|i
index|]
operator|.
name|flags
operator|&=
operator|~
name|MPT_RVF_REFERENCED
expr_stmt|;
block|}
comment|/* 	 * Get Physical Disk information. 	 */
name|len
operator|=
name|mpt
operator|->
name|ioc_page3
operator|->
name|Header
operator|.
name|PageLength
operator|*
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
name|rv
operator|=
name|mpt_read_cur_cfg_page
argument_list|(
name|mpt
argument_list|,
comment|/*PageAddress*/
literal|0
argument_list|,
operator|&
name|mpt
operator|->
name|ioc_page3
operator|->
name|Header
argument_list|,
name|len
argument_list|,
comment|/*sleep_ok*/
name|TRUE
argument_list|,
comment|/*timeout_ms*/
literal|5000
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"mpt_refresh_raid_data: Failed to read IOC Page 3\n"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|ioc_disk
operator|=
name|mpt
operator|->
name|ioc_page3
operator|->
name|PhysDisk
expr_stmt|;
name|ioc_last_disk
operator|=
name|ioc_disk
operator|+
name|mpt
operator|->
name|ioc_page3
operator|->
name|NumPhysDisks
expr_stmt|;
for|for
control|(
init|;
name|ioc_disk
operator|!=
name|ioc_last_disk
condition|;
name|ioc_disk
operator|++
control|)
block|{
name|struct
name|mpt_raid_disk
modifier|*
name|mpt_disk
decl_stmt|;
name|mpt_disk
operator|=
name|mpt
operator|->
name|raid_disks
operator|+
name|ioc_disk
operator|->
name|PhysDiskNum
expr_stmt|;
name|mpt_disk
operator|->
name|flags
operator||=
name|MPT_RDF_REFERENCED
expr_stmt|;
if|if
condition|(
operator|(
name|mpt_disk
operator|->
name|flags
operator|&
operator|(
name|MPT_RDF_ACTIVE
operator||
name|MPT_RDF_UP2DATE
operator|)
operator|)
operator|!=
operator|(
name|MPT_RDF_ACTIVE
operator||
name|MPT_RDF_UP2DATE
operator|)
condition|)
block|{
name|mpt_refresh_raid_disk
argument_list|(
name|mpt
argument_list|,
name|mpt_disk
argument_list|,
name|ioc_disk
argument_list|)
expr_stmt|;
block|}
name|mpt_disk
operator|->
name|flags
operator||=
name|MPT_RDF_ACTIVE
expr_stmt|;
name|mpt
operator|->
name|raid_rescan
operator|++
expr_stmt|;
block|}
comment|/* 	 * Refresh volume data. 	 */
name|len
operator|=
name|mpt
operator|->
name|ioc_page2
operator|->
name|Header
operator|.
name|PageLength
operator|*
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
name|rv
operator|=
name|mpt_read_cur_cfg_page
argument_list|(
name|mpt
argument_list|,
comment|/*PageAddress*/
literal|0
argument_list|,
operator|&
name|mpt
operator|->
name|ioc_page2
operator|->
name|Header
argument_list|,
name|len
argument_list|,
comment|/*sleep_ok*/
name|TRUE
argument_list|,
comment|/*timeout_ms*/
literal|5000
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"mpt_refresh_raid_data: "
literal|"Failed to read IOC Page 2\n"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|ioc_vol
operator|=
name|mpt
operator|->
name|ioc_page2
operator|->
name|RaidVolume
expr_stmt|;
name|ioc_last_vol
operator|=
name|ioc_vol
operator|+
name|mpt
operator|->
name|ioc_page2
operator|->
name|NumActiveVolumes
expr_stmt|;
for|for
control|(
init|;
name|ioc_vol
operator|!=
name|ioc_last_vol
condition|;
name|ioc_vol
operator|++
control|)
block|{
name|struct
name|mpt_raid_volume
modifier|*
name|mpt_vol
decl_stmt|;
name|mpt_vol
operator|=
name|mpt
operator|->
name|raid_volumes
operator|+
name|ioc_vol
operator|->
name|VolumePageNumber
expr_stmt|;
name|mpt_vol
operator|->
name|flags
operator||=
name|MPT_RVF_REFERENCED
expr_stmt|;
name|vol_pg
operator|=
name|mpt_vol
operator|->
name|config_page
expr_stmt|;
if|if
condition|(
name|vol_pg
operator|==
name|NULL
condition|)
continue|continue;
if|if
condition|(
operator|(
operator|(
name|mpt_vol
operator|->
name|flags
operator|&
operator|(
name|MPT_RVF_ACTIVE
operator||
name|MPT_RVF_UP2DATE
operator|)
operator|)
operator|!=
operator|(
name|MPT_RVF_ACTIVE
operator||
name|MPT_RVF_UP2DATE
operator|)
operator|)
operator|||
operator|(
name|vol_pg
operator|->
name|VolumeStatus
operator|.
name|Flags
operator|&
name|MPI_RAIDVOL0_STATUS_FLAG_RESYNC_IN_PROGRESS
operator|)
operator|!=
literal|0
condition|)
block|{
name|mpt_refresh_raid_vol
argument_list|(
name|mpt
argument_list|,
name|mpt_vol
argument_list|,
name|ioc_vol
argument_list|)
expr_stmt|;
block|}
name|mpt_vol
operator|->
name|flags
operator||=
name|MPT_RVF_ACTIVE
expr_stmt|;
block|}
name|nonopt_volumes
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|mpt
operator|->
name|ioc_page2
operator|->
name|MaxVolumes
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|mpt_raid_volume
modifier|*
name|mpt_vol
decl_stmt|;
name|uint64_t
name|total
decl_stmt|;
name|uint64_t
name|left
decl_stmt|;
name|int
name|m
decl_stmt|;
name|u_int
name|prio
decl_stmt|;
name|mpt_vol
operator|=
operator|&
name|mpt
operator|->
name|raid_volumes
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|mpt_vol
operator|->
name|flags
operator|&
name|MPT_RVF_ACTIVE
operator|)
operator|==
literal|0
condition|)
continue|continue;
name|vol_pg
operator|=
name|mpt_vol
operator|->
name|config_page
expr_stmt|;
if|if
condition|(
operator|(
name|mpt_vol
operator|->
name|flags
operator|&
operator|(
name|MPT_RVF_REFERENCED
operator||
name|MPT_RVF_ANNOUNCED
operator|)
operator|)
operator|==
name|MPT_RVF_ANNOUNCED
condition|)
block|{
name|mpt_vol_prt
argument_list|(
name|mpt
argument_list|,
name|mpt_vol
argument_list|,
literal|"No longer configured\n"
argument_list|)
expr_stmt|;
name|mpt_vol
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|(
name|mpt_vol
operator|->
name|flags
operator|&
name|MPT_RVF_ANNOUNCED
operator|)
operator|==
literal|0
condition|)
block|{
name|mpt_announce_vol
argument_list|(
name|mpt
argument_list|,
name|mpt_vol
argument_list|)
expr_stmt|;
name|mpt_vol
operator|->
name|flags
operator||=
name|MPT_RVF_ANNOUNCED
expr_stmt|;
block|}
if|if
condition|(
name|vol_pg
operator|->
name|VolumeStatus
operator|.
name|State
operator|!=
name|MPI_RAIDVOL0_STATUS_STATE_OPTIMAL
condition|)
name|nonopt_volumes
operator|++
expr_stmt|;
if|if
condition|(
operator|(
name|mpt_vol
operator|->
name|flags
operator|&
name|MPT_RVF_UP2DATE
operator|)
operator|!=
literal|0
condition|)
continue|continue;
name|mpt_vol
operator|->
name|flags
operator||=
name|MPT_RVF_UP2DATE
expr_stmt|;
name|mpt_vol_prt
argument_list|(
name|mpt
argument_list|,
name|mpt_vol
argument_list|,
literal|"%s - %s\n"
argument_list|,
name|mpt_vol_type
argument_list|(
name|mpt_vol
argument_list|)
argument_list|,
name|mpt_vol_state
argument_list|(
name|mpt_vol
argument_list|)
argument_list|)
expr_stmt|;
name|mpt_verify_mwce
argument_list|(
name|mpt
argument_list|,
name|mpt_vol
argument_list|)
expr_stmt|;
if|if
condition|(
name|vol_pg
operator|->
name|VolumeStatus
operator|.
name|Flags
operator|==
literal|0
condition|)
continue|continue;
name|mpt_vol_prt
argument_list|(
name|mpt
argument_list|,
name|mpt_vol
argument_list|,
literal|"Status ("
argument_list|)
expr_stmt|;
for|for
control|(
name|m
operator|=
literal|1
init|;
name|m
operator|<=
literal|0x80
condition|;
name|m
operator|<<=
literal|1
control|)
block|{
switch|switch
condition|(
name|vol_pg
operator|->
name|VolumeStatus
operator|.
name|Flags
operator|&
name|m
condition|)
block|{
case|case
name|MPI_RAIDVOL0_STATUS_FLAG_ENABLED
case|:
name|mpt_prtc
argument_list|(
name|mpt
argument_list|,
literal|" Enabled"
argument_list|)
expr_stmt|;
break|break;
case|case
name|MPI_RAIDVOL0_STATUS_FLAG_QUIESCED
case|:
name|mpt_prtc
argument_list|(
name|mpt
argument_list|,
literal|" Quiesced"
argument_list|)
expr_stmt|;
break|break;
case|case
name|MPI_RAIDVOL0_STATUS_FLAG_RESYNC_IN_PROGRESS
case|:
name|mpt_prtc
argument_list|(
name|mpt
argument_list|,
literal|" Re-Syncing"
argument_list|)
expr_stmt|;
break|break;
case|case
name|MPI_RAIDVOL0_STATUS_FLAG_VOLUME_INACTIVE
case|:
name|mpt_prtc
argument_list|(
name|mpt
argument_list|,
literal|" Inactive"
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
name|mpt_prtc
argument_list|(
name|mpt
argument_list|,
literal|" )\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|vol_pg
operator|->
name|VolumeStatus
operator|.
name|Flags
operator|&
name|MPI_RAIDVOL0_STATUS_FLAG_RESYNC_IN_PROGRESS
operator|)
operator|==
literal|0
condition|)
continue|continue;
name|mpt_verify_resync_rate
argument_list|(
name|mpt
argument_list|,
name|mpt_vol
argument_list|)
expr_stmt|;
name|left
operator|=
name|u64toh
argument_list|(
name|mpt_vol
operator|->
name|sync_progress
operator|.
name|BlocksRemaining
argument_list|)
expr_stmt|;
name|total
operator|=
name|u64toh
argument_list|(
name|mpt_vol
operator|->
name|sync_progress
operator|.
name|TotalBlocks
argument_list|)
expr_stmt|;
if|if
condition|(
name|vol_pg
operator|->
name|ResyncRate
operator|!=
literal|0
condition|)
block|{
name|prio
operator|=
operator|(
operator|(
name|u_int
operator|)
name|vol_pg
operator|->
name|ResyncRate
operator|*
literal|100000
operator|)
operator|/
literal|0xFF
expr_stmt|;
name|mpt_vol_prt
argument_list|(
name|mpt
argument_list|,
name|mpt_vol
argument_list|,
literal|"Rate %d.%d%%\n"
argument_list|,
name|prio
operator|/
literal|1000
argument_list|,
name|prio
operator|%
literal|1000
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|prio
operator|=
name|vol_pg
operator|->
name|VolumeSettings
operator|.
name|Settings
operator|&
name|MPI_RAIDVOL0_SETTING_PRIORITY_RESYNC
expr_stmt|;
name|mpt_vol_prt
argument_list|(
name|mpt
argument_list|,
name|mpt_vol
argument_list|,
literal|"%s Priority Re-Sync\n"
argument_list|,
name|prio
condition|?
literal|"High"
else|:
literal|"Low"
argument_list|)
expr_stmt|;
block|}
if|#
directive|if
name|__FreeBSD_version
operator|>=
literal|500000
name|mpt_vol_prt
argument_list|(
name|mpt
argument_list|,
name|mpt_vol
argument_list|,
literal|"%ju of %ju "
literal|"blocks remaining\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|left
argument_list|,
operator|(
name|uintmax_t
operator|)
name|total
argument_list|)
expr_stmt|;
else|#
directive|else
name|mpt_vol_prt
argument_list|(
name|mpt
argument_list|,
name|mpt_vol
argument_list|,
literal|"%llu of %llu "
literal|"blocks remaining\n"
argument_list|,
operator|(
name|uint64_t
operator|)
name|left
argument_list|,
operator|(
name|uint64_t
operator|)
name|total
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* Periodically report on sync progress. */
name|mpt_schedule_raid_refresh
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|mpt
operator|->
name|ioc_page2
operator|->
name|MaxPhysDisks
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|mpt_raid_disk
modifier|*
name|mpt_disk
decl_stmt|;
name|CONFIG_PAGE_RAID_PHYS_DISK_0
modifier|*
name|disk_pg
decl_stmt|;
name|int
name|m
decl_stmt|;
name|mpt_disk
operator|=
operator|&
name|mpt
operator|->
name|raid_disks
index|[
name|i
index|]
expr_stmt|;
name|disk_pg
operator|=
operator|&
name|mpt_disk
operator|->
name|config_page
expr_stmt|;
if|if
condition|(
operator|(
name|mpt_disk
operator|->
name|flags
operator|&
name|MPT_RDF_ACTIVE
operator|)
operator|==
literal|0
condition|)
continue|continue;
if|if
condition|(
operator|(
name|mpt_disk
operator|->
name|flags
operator|&
operator|(
name|MPT_RDF_REFERENCED
operator||
name|MPT_RDF_ANNOUNCED
operator|)
operator|)
operator|==
name|MPT_RDF_ANNOUNCED
condition|)
block|{
name|mpt_disk_prt
argument_list|(
name|mpt
argument_list|,
name|mpt_disk
argument_list|,
literal|"No longer configured\n"
argument_list|)
expr_stmt|;
name|mpt_disk
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
name|mpt
operator|->
name|raid_rescan
operator|++
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|(
name|mpt_disk
operator|->
name|flags
operator|&
name|MPT_RDF_ANNOUNCED
operator|)
operator|==
literal|0
condition|)
block|{
name|mpt_announce_disk
argument_list|(
name|mpt
argument_list|,
name|mpt_disk
argument_list|)
expr_stmt|;
name|mpt_disk
operator|->
name|flags
operator||=
name|MPT_RVF_ANNOUNCED
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|mpt_disk
operator|->
name|flags
operator|&
name|MPT_RDF_UP2DATE
operator|)
operator|!=
literal|0
condition|)
continue|continue;
name|mpt_disk
operator|->
name|flags
operator||=
name|MPT_RDF_UP2DATE
expr_stmt|;
name|mpt_disk_prt
argument_list|(
name|mpt
argument_list|,
name|mpt_disk
argument_list|,
literal|"%s\n"
argument_list|,
name|mpt_disk_state
argument_list|(
name|mpt_disk
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|disk_pg
operator|->
name|PhysDiskStatus
operator|.
name|Flags
operator|==
literal|0
condition|)
continue|continue;
name|mpt_disk_prt
argument_list|(
name|mpt
argument_list|,
name|mpt_disk
argument_list|,
literal|"Status ("
argument_list|)
expr_stmt|;
for|for
control|(
name|m
operator|=
literal|1
init|;
name|m
operator|<=
literal|0x80
condition|;
name|m
operator|<<=
literal|1
control|)
block|{
switch|switch
condition|(
name|disk_pg
operator|->
name|PhysDiskStatus
operator|.
name|Flags
operator|&
name|m
condition|)
block|{
case|case
name|MPI_PHYSDISK0_STATUS_FLAG_OUT_OF_SYNC
case|:
name|mpt_prtc
argument_list|(
name|mpt
argument_list|,
literal|" Out-Of-Sync"
argument_list|)
expr_stmt|;
break|break;
case|case
name|MPI_PHYSDISK0_STATUS_FLAG_QUIESCED
case|:
name|mpt_prtc
argument_list|(
name|mpt
argument_list|,
literal|" Quiesced"
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
name|mpt_prtc
argument_list|(
name|mpt
argument_list|,
literal|" )\n"
argument_list|)
expr_stmt|;
block|}
name|mpt
operator|->
name|raid_nonopt_volumes
operator|=
name|nonopt_volumes
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mpt_raid_timer
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|mpt_softc
modifier|*
name|mpt
decl_stmt|;
name|mpt
operator|=
operator|(
expr|struct
name|mpt_softc
operator|*
operator|)
name|arg
expr_stmt|;
name|MPT_LOCK
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
name|mpt_raid_wakeup
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
name|MPT_UNLOCK
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|mpt_schedule_raid_refresh
parameter_list|(
name|struct
name|mpt_softc
modifier|*
name|mpt
parameter_list|)
block|{
name|callout_reset
argument_list|(
operator|&
name|mpt
operator|->
name|raid_timer
argument_list|,
name|MPT_RAID_SYNC_REPORT_INTERVAL
argument_list|,
name|mpt_raid_timer
argument_list|,
name|mpt
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|mpt_raid_free_mem
parameter_list|(
name|struct
name|mpt_softc
modifier|*
name|mpt
parameter_list|)
block|{
if|if
condition|(
name|mpt
operator|->
name|raid_volumes
condition|)
block|{
name|struct
name|mpt_raid_volume
modifier|*
name|mpt_raid
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|mpt
operator|->
name|raid_max_volumes
condition|;
name|i
operator|++
control|)
block|{
name|mpt_raid
operator|=
operator|&
name|mpt
operator|->
name|raid_volumes
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|mpt_raid
operator|->
name|config_page
condition|)
block|{
name|free
argument_list|(
name|mpt_raid
operator|->
name|config_page
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|mpt_raid
operator|->
name|config_page
operator|=
name|NULL
expr_stmt|;
block|}
block|}
name|free
argument_list|(
name|mpt
operator|->
name|raid_volumes
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|mpt
operator|->
name|raid_volumes
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|mpt
operator|->
name|raid_disks
condition|)
block|{
name|free
argument_list|(
name|mpt
operator|->
name|raid_disks
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|mpt
operator|->
name|raid_disks
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|mpt
operator|->
name|ioc_page2
condition|)
block|{
name|free
argument_list|(
name|mpt
operator|->
name|ioc_page2
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|mpt
operator|->
name|ioc_page2
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|mpt
operator|->
name|ioc_page3
condition|)
block|{
name|free
argument_list|(
name|mpt
operator|->
name|ioc_page3
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|mpt
operator|->
name|ioc_page3
operator|=
name|NULL
expr_stmt|;
block|}
name|mpt
operator|->
name|raid_max_volumes
operator|=
literal|0
expr_stmt|;
name|mpt
operator|->
name|raid_max_disks
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|mpt_raid_set_vol_resync_rate
parameter_list|(
name|struct
name|mpt_softc
modifier|*
name|mpt
parameter_list|,
name|u_int
name|rate
parameter_list|)
block|{
name|struct
name|mpt_raid_volume
modifier|*
name|mpt_vol
decl_stmt|;
if|if
condition|(
operator|(
name|rate
operator|>
name|MPT_RAID_RESYNC_RATE_MAX
operator|||
name|rate
operator|<
name|MPT_RAID_RESYNC_RATE_MIN
operator|)
operator|&&
name|rate
operator|!=
name|MPT_RAID_RESYNC_RATE_NC
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|MPT_LOCK
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
name|mpt
operator|->
name|raid_resync_rate
operator|=
name|rate
expr_stmt|;
name|RAID_VOL_FOREACH
argument_list|(
argument|mpt
argument_list|,
argument|mpt_vol
argument_list|)
block|{
if|if
condition|(
operator|(
name|mpt_vol
operator|->
name|flags
operator|&
name|MPT_RVF_ACTIVE
operator|)
operator|==
literal|0
condition|)
block|{
continue|continue;
block|}
name|mpt_verify_resync_rate
argument_list|(
name|mpt
argument_list|,
name|mpt_vol
argument_list|)
expr_stmt|;
block|}
name|MPT_UNLOCK
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mpt_raid_set_vol_queue_depth
parameter_list|(
name|struct
name|mpt_softc
modifier|*
name|mpt
parameter_list|,
name|u_int
name|vol_queue_depth
parameter_list|)
block|{
name|struct
name|mpt_raid_volume
modifier|*
name|mpt_vol
decl_stmt|;
if|if
condition|(
name|vol_queue_depth
operator|>
literal|255
operator|||
name|vol_queue_depth
operator|<
literal|1
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|MPT_LOCK
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
name|mpt
operator|->
name|raid_queue_depth
operator|=
name|vol_queue_depth
expr_stmt|;
name|RAID_VOL_FOREACH
argument_list|(
argument|mpt
argument_list|,
argument|mpt_vol
argument_list|)
block|{
name|struct
name|cam_path
modifier|*
name|path
decl_stmt|;
name|int
name|error
decl_stmt|;
if|if
condition|(
operator|(
name|mpt_vol
operator|->
name|flags
operator|&
name|MPT_RVF_ACTIVE
operator|)
operator|==
literal|0
condition|)
continue|continue;
name|mpt
operator|->
name|raid_rescan
operator|=
literal|0
expr_stmt|;
name|MPTLOCK_2_CAMLOCK
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
name|error
operator|=
name|xpt_create_path
argument_list|(
operator|&
name|path
argument_list|,
name|xpt_periph
argument_list|,
name|cam_sim_path
argument_list|(
name|mpt
operator|->
name|sim
argument_list|)
argument_list|,
name|mpt_vol
operator|->
name|config_page
operator|->
name|VolumeID
argument_list|,
comment|/*lun*/
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|CAM_REQ_CMP
condition|)
block|{
name|CAMLOCK_2_MPTLOCK
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
name|mpt_vol_prt
argument_list|(
name|mpt
argument_list|,
name|mpt_vol
argument_list|,
literal|"Unable to allocate path!\n"
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|mpt_adjust_queue_depth
argument_list|(
name|mpt
argument_list|,
name|mpt_vol
argument_list|,
name|path
argument_list|)
expr_stmt|;
name|xpt_free_path
argument_list|(
name|path
argument_list|)
expr_stmt|;
name|CAMLOCK_2_MPTLOCK
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
block|}
name|MPT_UNLOCK
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mpt_raid_set_vol_mwce
parameter_list|(
name|struct
name|mpt_softc
modifier|*
name|mpt
parameter_list|,
name|mpt_raid_mwce_t
name|mwce
parameter_list|)
block|{
name|struct
name|mpt_raid_volume
modifier|*
name|mpt_vol
decl_stmt|;
name|int
name|force_full_resync
decl_stmt|;
name|MPT_LOCK
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
if|if
condition|(
name|mwce
operator|==
name|mpt
operator|->
name|raid_mwce_setting
condition|)
block|{
name|MPT_UNLOCK
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
comment|/* 	 * Catch MWCE being left on due to a failed shutdown.  Since 	 * sysctls cannot be set by the loader, we treat the first 	 * setting of this varible specially and force a full volume 	 * resync if MWCE is enabled and a resync is in progress. 	 */
name|force_full_resync
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|mpt
operator|->
name|raid_mwce_set
operator|==
literal|0
operator|&&
name|mpt
operator|->
name|raid_mwce_setting
operator|==
name|MPT_RAID_MWCE_NC
operator|&&
name|mwce
operator|==
name|MPT_RAID_MWCE_REBUILD_ONLY
condition|)
name|force_full_resync
operator|=
literal|1
expr_stmt|;
name|mpt
operator|->
name|raid_mwce_setting
operator|=
name|mwce
expr_stmt|;
name|RAID_VOL_FOREACH
argument_list|(
argument|mpt
argument_list|,
argument|mpt_vol
argument_list|)
block|{
name|CONFIG_PAGE_RAID_VOL_0
modifier|*
name|vol_pg
decl_stmt|;
name|int
name|resyncing
decl_stmt|;
name|int
name|mwce
decl_stmt|;
if|if
condition|(
operator|(
name|mpt_vol
operator|->
name|flags
operator|&
name|MPT_RVF_ACTIVE
operator|)
operator|==
literal|0
condition|)
continue|continue;
name|vol_pg
operator|=
name|mpt_vol
operator|->
name|config_page
expr_stmt|;
name|resyncing
operator|=
name|vol_pg
operator|->
name|VolumeStatus
operator|.
name|Flags
operator|&
name|MPI_RAIDVOL0_STATUS_FLAG_RESYNC_IN_PROGRESS
expr_stmt|;
name|mwce
operator|=
name|vol_pg
operator|->
name|VolumeSettings
operator|.
name|Settings
operator|&
name|MPI_RAIDVOL0_SETTING_WRITE_CACHING_ENABLE
expr_stmt|;
if|if
condition|(
name|force_full_resync
operator|&&
name|resyncing
operator|&&
name|mwce
condition|)
block|{
comment|/* 			 * XXX disable/enable volume should force a resync, 			 *     but we'll need to queice, drain, and restart 			 *     I/O to do that. 			 */
name|mpt_vol_prt
argument_list|(
name|mpt
argument_list|,
name|mpt_vol
argument_list|,
literal|"WARNING - Unsafe shutdown "
literal|"detected.  Suggest full resync.\n"
argument_list|)
expr_stmt|;
block|}
name|mpt_verify_mwce
argument_list|(
name|mpt
argument_list|,
name|mpt_vol
argument_list|)
expr_stmt|;
block|}
name|mpt
operator|->
name|raid_mwce_set
operator|=
literal|1
expr_stmt|;
name|MPT_UNLOCK
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|const
name|char
modifier|*
name|mpt_vol_mwce_strs
index|[]
init|=
block|{
literal|"On"
block|,
literal|"Off"
block|,
literal|"On-During-Rebuild"
block|,
literal|"NC"
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|mpt_raid_sysctl_vol_member_wce
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|char
name|inbuf
index|[
literal|20
index|]
decl_stmt|;
name|struct
name|mpt_softc
modifier|*
name|mpt
decl_stmt|;
specifier|const
name|char
modifier|*
name|str
decl_stmt|;
name|int
name|error
decl_stmt|;
name|u_int
name|size
decl_stmt|;
name|u_int
name|i
decl_stmt|;
name|GIANT_REQUIRED
expr_stmt|;
name|mpt
operator|=
operator|(
expr|struct
name|mpt_softc
operator|*
operator|)
name|arg1
expr_stmt|;
name|str
operator|=
name|mpt_vol_mwce_strs
index|[
name|mpt
operator|->
name|raid_mwce_setting
index|]
expr_stmt|;
name|error
operator|=
name|SYSCTL_OUT
argument_list|(
name|req
argument_list|,
name|str
argument_list|,
name|strlen
argument_list|(
name|str
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|||
operator|!
name|req
operator|->
name|newptr
condition|)
block|{
return|return
operator|(
name|error
operator|)
return|;
block|}
name|size
operator|=
name|req
operator|->
name|newlen
operator|-
name|req
operator|->
name|newidx
expr_stmt|;
if|if
condition|(
name|size
operator|>=
sizeof|sizeof
argument_list|(
name|inbuf
argument_list|)
condition|)
block|{
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
name|error
operator|=
name|SYSCTL_IN
argument_list|(
name|req
argument_list|,
name|inbuf
argument_list|,
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
return|return
operator|(
name|error
operator|)
return|;
block|}
name|inbuf
index|[
name|size
index|]
operator|=
literal|'\0'
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_ELEMENTS
argument_list|(
name|mpt_vol_mwce_strs
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|mpt_vol_mwce_strs
index|[
name|i
index|]
argument_list|,
name|inbuf
argument_list|)
operator|==
literal|0
condition|)
block|{
return|return
operator|(
name|mpt_raid_set_vol_mwce
argument_list|(
name|mpt
argument_list|,
name|i
argument_list|)
operator|)
return|;
block|}
block|}
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mpt_raid_sysctl_vol_resync_rate
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|struct
name|mpt_softc
modifier|*
name|mpt
decl_stmt|;
name|u_int
name|raid_resync_rate
decl_stmt|;
name|int
name|error
decl_stmt|;
name|GIANT_REQUIRED
expr_stmt|;
name|mpt
operator|=
operator|(
expr|struct
name|mpt_softc
operator|*
operator|)
name|arg1
expr_stmt|;
name|raid_resync_rate
operator|=
name|mpt
operator|->
name|raid_resync_rate
expr_stmt|;
name|error
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|raid_resync_rate
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|||
operator|!
name|req
operator|->
name|newptr
condition|)
block|{
return|return
name|error
return|;
block|}
return|return
operator|(
name|mpt_raid_set_vol_resync_rate
argument_list|(
name|mpt
argument_list|,
name|raid_resync_rate
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mpt_raid_sysctl_vol_queue_depth
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|struct
name|mpt_softc
modifier|*
name|mpt
decl_stmt|;
name|u_int
name|raid_queue_depth
decl_stmt|;
name|int
name|error
decl_stmt|;
name|GIANT_REQUIRED
expr_stmt|;
name|mpt
operator|=
operator|(
expr|struct
name|mpt_softc
operator|*
operator|)
name|arg1
expr_stmt|;
name|raid_queue_depth
operator|=
name|mpt
operator|->
name|raid_queue_depth
expr_stmt|;
name|error
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|raid_queue_depth
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|||
operator|!
name|req
operator|->
name|newptr
condition|)
block|{
return|return
name|error
return|;
block|}
return|return
operator|(
name|mpt_raid_set_vol_queue_depth
argument_list|(
name|mpt
argument_list|,
name|raid_queue_depth
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mpt_raid_sysctl_attach
parameter_list|(
name|struct
name|mpt_softc
modifier|*
name|mpt
parameter_list|)
block|{
if|#
directive|if
name|__FreeBSD_version
operator|>=
literal|500000
name|struct
name|sysctl_ctx_list
modifier|*
name|ctx
init|=
name|device_get_sysctl_ctx
argument_list|(
name|mpt
operator|->
name|dev
argument_list|)
decl_stmt|;
name|struct
name|sysctl_oid
modifier|*
name|tree
init|=
name|device_get_sysctl_tree
argument_list|(
name|mpt
operator|->
name|dev
argument_list|)
decl_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|tree
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"vol_member_wce"
argument_list|,
name|CTLTYPE_STRING
operator||
name|CTLFLAG_RW
argument_list|,
name|mpt
argument_list|,
literal|0
argument_list|,
name|mpt_raid_sysctl_vol_member_wce
argument_list|,
literal|"A"
argument_list|,
literal|"volume member WCE(On,Off,On-During-Rebuild,NC)"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|tree
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"vol_queue_depth"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RW
argument_list|,
name|mpt
argument_list|,
literal|0
argument_list|,
name|mpt_raid_sysctl_vol_queue_depth
argument_list|,
literal|"I"
argument_list|,
literal|"default volume queue depth"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|tree
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"vol_resync_rate"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RW
argument_list|,
name|mpt
argument_list|,
literal|0
argument_list|,
name|mpt_raid_sysctl_vol_resync_rate
argument_list|,
literal|"I"
argument_list|,
literal|"volume resync priority (0 == NC, 1 - 255)"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_INT
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|tree
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"nonoptimal_volumes"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|mpt
operator|->
name|raid_nonopt_volumes
argument_list|,
literal|0
argument_list|,
literal|"number of nonoptimal volumes"
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

end_unit


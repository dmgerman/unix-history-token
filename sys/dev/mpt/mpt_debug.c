begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Debug routines for LSI '909 FC  adapters.  * FreeBSD Version.  *  * Copyright (c)  2000, 2001 by Greg Ansley  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice immediately at the beginning of the file, without modification,  *    this list of conditions, and the following disclaimer.  * 2. The name of the author may not be used to endorse or promote products  *    derived from this software without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE FOR  * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  */
end_comment

begin_comment
comment|/*-  * Copyright (c) 2002, 2006 by Matthew Jacob  * All rights reserved.  *   * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions are  * met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce at minimum a disclaimer  *    substantially similar to the "NO WARRANTY" disclaimer below  *    ("Disclaimer") and any redistribution must be conditioned upon including  *    a substantially similar Disclaimer requirement for further binary  *    redistribution.  * 3. Neither the names of the above listed copyright holders nor the names  *    of any contributors may be used to endorse or promote products derived  *    from this software without specific prior written permission.  *   * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE  * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF THE COPYRIGHT  * OWNER OR CONTRIBUTOR IS ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  *  * Support from Chris Ellsworth in order to make SAS adapters work  * is gratefully acknowledged.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/mpt/mpt.h>
end_include

begin_include
include|#
directive|include
file|<dev/mpt/mpilib/mpi_ioc.h>
end_include

begin_include
include|#
directive|include
file|<dev/mpt/mpilib/mpi_init.h>
end_include

begin_include
include|#
directive|include
file|<dev/mpt/mpilib/mpi_fc.h>
end_include

begin_include
include|#
directive|include
file|<cam/scsi/scsi_all.h>
end_include

begin_include
include|#
directive|include
file|<machine/stdarg.h>
end_include

begin_comment
comment|/* for use by mpt_prt below */
end_comment

begin_struct
struct|struct
name|Error_Map
block|{
name|int
name|Error_Code
decl_stmt|;
name|char
modifier|*
name|Error_String
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|Error_Map
name|IOC_Status
index|[]
init|=
block|{
block|{
name|MPI_IOCSTATUS_SUCCESS
block|,
literal|"Success"
block|}
block|,
block|{
name|MPI_IOCSTATUS_INVALID_FUNCTION
block|,
literal|"IOC: Invalid Function"
block|}
block|,
block|{
name|MPI_IOCSTATUS_BUSY
block|,
literal|"IOC: Busy"
block|}
block|,
block|{
name|MPI_IOCSTATUS_INVALID_SGL
block|,
literal|"IOC: Invalid SGL"
block|}
block|,
block|{
name|MPI_IOCSTATUS_INTERNAL_ERROR
block|,
literal|"IOC: Internal Error"
block|}
block|,
block|{
name|MPI_IOCSTATUS_RESERVED
block|,
literal|"IOC: Reserved"
block|}
block|,
block|{
name|MPI_IOCSTATUS_INSUFFICIENT_RESOURCES
block|,
literal|"IOC: Insufficient Resources"
block|}
block|,
block|{
name|MPI_IOCSTATUS_INVALID_FIELD
block|,
literal|"IOC: Invalid Field"
block|}
block|,
block|{
name|MPI_IOCSTATUS_INVALID_STATE
block|,
literal|"IOC: Invalid State"
block|}
block|,
block|{
name|MPI_IOCSTATUS_CONFIG_INVALID_ACTION
block|,
literal|"Invalid Action"
block|}
block|,
block|{
name|MPI_IOCSTATUS_CONFIG_INVALID_TYPE
block|,
literal|"Invalid Type"
block|}
block|,
block|{
name|MPI_IOCSTATUS_CONFIG_INVALID_PAGE
block|,
literal|"Invalid Page"
block|}
block|,
block|{
name|MPI_IOCSTATUS_CONFIG_INVALID_DATA
block|,
literal|"Invalid Data"
block|}
block|,
block|{
name|MPI_IOCSTATUS_CONFIG_NO_DEFAULTS
block|,
literal|"No Defaults"
block|}
block|,
block|{
name|MPI_IOCSTATUS_CONFIG_CANT_COMMIT
block|,
literal|"Can't Commit"
block|}
block|,
block|{
name|MPI_IOCSTATUS_SCSI_RECOVERED_ERROR
block|,
literal|"SCSI: Recoverd Error"
block|}
block|,
block|{
name|MPI_IOCSTATUS_SCSI_INVALID_BUS
block|,
literal|"SCSI: Invalid Bus"
block|}
block|,
block|{
name|MPI_IOCSTATUS_SCSI_INVALID_TARGETID
block|,
literal|"SCSI: Invalid Target ID"
block|}
block|,
block|{
name|MPI_IOCSTATUS_SCSI_DEVICE_NOT_THERE
block|,
literal|"SCSI: Device Not There"
block|}
block|,
block|{
name|MPI_IOCSTATUS_SCSI_DATA_OVERRUN
block|,
literal|"SCSI: Data Overrun"
block|}
block|,
block|{
name|MPI_IOCSTATUS_SCSI_DATA_UNDERRUN
block|,
literal|"SCSI: Data Underrun"
block|}
block|,
block|{
name|MPI_IOCSTATUS_SCSI_IO_DATA_ERROR
block|,
literal|"SCSI: Data Error"
block|}
block|,
block|{
name|MPI_IOCSTATUS_SCSI_PROTOCOL_ERROR
block|,
literal|"SCSI: Protocol Error"
block|}
block|,
block|{
name|MPI_IOCSTATUS_SCSI_TASK_TERMINATED
block|,
literal|"SCSI: Task Terminated"
block|}
block|,
block|{
name|MPI_IOCSTATUS_SCSI_RESIDUAL_MISMATCH
block|,
literal|"SCSI: Residual Mismatch"
block|}
block|,
block|{
name|MPI_IOCSTATUS_SCSI_TASK_MGMT_FAILED
block|,
literal|"SCSI: Task Management Failed"
block|}
block|,
block|{
name|MPI_IOCSTATUS_SCSI_IOC_TERMINATED
block|,
literal|"SCSI: IOC Bus Reset"
block|}
block|,
block|{
name|MPI_IOCSTATUS_SCSI_EXT_TERMINATED
block|,
literal|"SCSI: External Bus Reset"
block|}
block|,
block|{
name|MPI_IOCSTATUS_TARGET_PRIORITY_IO
block|,
literal|"SCSI Target: Priority I/O"
block|}
block|,
block|{
name|MPI_IOCSTATUS_TARGET_INVALID_PORT
block|,
literal|"SCSI Target: Invalid Port"
block|}
block|,
block|{
name|MPI_IOCSTATUS_TARGET_INVALID_IOCINDEX
block|,
literal|"SCSI Target: Invalid IOC Index"
block|}
block|,
block|{
name|MPI_IOCSTATUS_TARGET_ABORTED
block|,
literal|"SCSI Target: Aborted"
block|}
block|,
block|{
name|MPI_IOCSTATUS_TARGET_NO_CONN_RETRYABLE
block|,
literal|"SCSI Target: No Connection (Retryable)"
block|}
block|,
block|{
name|MPI_IOCSTATUS_TARGET_NO_CONNECTION
block|,
literal|"SCSI Target: No Connection"
block|}
block|,
block|{
name|MPI_IOCSTATUS_TARGET_XFER_COUNT_MISMATCH
block|,
literal|"SCSI Target: Transfer Count Mismatch"
block|}
block|,
block|{
name|MPI_IOCSTATUS_TARGET_FC_ABORTED
block|,
literal|"FC: Aborted"
block|}
block|,
block|{
name|MPI_IOCSTATUS_TARGET_FC_RX_ID_INVALID
block|,
literal|"FC: Recieve ID Invalid"
block|}
block|,
block|{
name|MPI_IOCSTATUS_TARGET_FC_DID_INVALID
block|,
literal|"FC: Recieve DID Invalid"
block|}
block|,
block|{
name|MPI_IOCSTATUS_TARGET_FC_NODE_LOGGED_OUT
block|,
literal|"FC: Node Logged Out"
block|}
block|,
block|{
name|MPI_IOCSTATUS_LAN_DEVICE_NOT_FOUND
block|,
literal|"LAN: Device Not Found"
block|}
block|,
block|{
name|MPI_IOCSTATUS_LAN_DEVICE_FAILURE
block|,
literal|"LAN: Device Not Failure"
block|}
block|,
block|{
name|MPI_IOCSTATUS_LAN_TRANSMIT_ERROR
block|,
literal|"LAN: Transmit Error"
block|}
block|,
block|{
name|MPI_IOCSTATUS_LAN_TRANSMIT_ABORTED
block|,
literal|"LAN: Transmit Aborted"
block|}
block|,
block|{
name|MPI_IOCSTATUS_LAN_RECEIVE_ERROR
block|,
literal|"LAN: Recieve Error"
block|}
block|,
block|{
name|MPI_IOCSTATUS_LAN_RECEIVE_ABORTED
block|,
literal|"LAN: Recieve Aborted"
block|}
block|,
block|{
name|MPI_IOCSTATUS_LAN_PARTIAL_PACKET
block|,
literal|"LAN: Partial Packet"
block|}
block|,
block|{
name|MPI_IOCSTATUS_LAN_CANCELED
block|,
literal|"LAN: Canceled"
block|}
block|,
block|{
operator|-
literal|1
block|,
literal|0
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|Error_Map
name|IOC_Func
index|[]
init|=
block|{
block|{
name|MPI_FUNCTION_SCSI_IO_REQUEST
block|,
literal|"SCSI IO Request"
block|}
block|,
block|{
name|MPI_FUNCTION_SCSI_TASK_MGMT
block|,
literal|"SCSI Task Management"
block|}
block|,
block|{
name|MPI_FUNCTION_IOC_INIT
block|,
literal|"IOC Init"
block|}
block|,
block|{
name|MPI_FUNCTION_IOC_FACTS
block|,
literal|"IOC Facts"
block|}
block|,
block|{
name|MPI_FUNCTION_CONFIG
block|,
literal|"Config"
block|}
block|,
block|{
name|MPI_FUNCTION_PORT_FACTS
block|,
literal|"Port Facts"
block|}
block|,
block|{
name|MPI_FUNCTION_PORT_ENABLE
block|,
literal|"Port Enable"
block|}
block|,
block|{
name|MPI_FUNCTION_EVENT_NOTIFICATION
block|,
literal|"Event Notification"
block|}
block|,
block|{
name|MPI_FUNCTION_EVENT_ACK
block|,
literal|"Event Ack"
block|}
block|,
block|{
name|MPI_FUNCTION_FW_DOWNLOAD
block|,
literal|"FW Download"
block|}
block|,
block|{
name|MPI_FUNCTION_TARGET_CMD_BUFFER_POST
block|,
literal|"SCSI Target Command Buffer"
block|}
block|,
block|{
name|MPI_FUNCTION_TARGET_ASSIST
block|,
literal|"Target Assist"
block|}
block|,
block|{
name|MPI_FUNCTION_TARGET_STATUS_SEND
block|,
literal|"Target Status Send"
block|}
block|,
block|{
name|MPI_FUNCTION_TARGET_MODE_ABORT
block|,
literal|"Target Mode Abort"
block|}
block|,
block|{
operator|-
literal|1
block|,
literal|0
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|Error_Map
name|IOC_Event
index|[]
init|=
block|{
block|{
name|MPI_EVENT_NONE
block|,
literal|"None"
block|}
block|,
block|{
name|MPI_EVENT_LOG_DATA
block|,
literal|"LogData"
block|}
block|,
block|{
name|MPI_EVENT_STATE_CHANGE
block|,
literal|"State Change"
block|}
block|,
block|{
name|MPI_EVENT_UNIT_ATTENTION
block|,
literal|"Unit Attention"
block|}
block|,
block|{
name|MPI_EVENT_IOC_BUS_RESET
block|,
literal|"IOC Bus Reset"
block|}
block|,
block|{
name|MPI_EVENT_EXT_BUS_RESET
block|,
literal|"External Bus Reset"
block|}
block|,
block|{
name|MPI_EVENT_RESCAN
block|,
literal|"Rescan"
block|}
block|,
block|{
name|MPI_EVENT_LINK_STATUS_CHANGE
block|,
literal|"Link Status Change"
block|}
block|,
block|{
name|MPI_EVENT_LOOP_STATE_CHANGE
block|,
literal|"Loop State Change"
block|}
block|,
block|{
name|MPI_EVENT_LOGOUT
block|,
literal|"Logout"
block|}
block|,
block|{
name|MPI_EVENT_EVENT_CHANGE
block|,
literal|"EventChange"
block|}
block|,
block|{
operator|-
literal|1
block|,
literal|0
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|Error_Map
name|IOC_SCSIState
index|[]
init|=
block|{
block|{
name|MPI_SCSI_STATE_AUTOSENSE_VALID
block|,
literal|"AutoSense_Valid"
block|}
block|,
block|{
name|MPI_SCSI_STATE_AUTOSENSE_FAILED
block|,
literal|"AutoSense_Failed"
block|}
block|,
block|{
name|MPI_SCSI_STATE_NO_SCSI_STATUS
block|,
literal|"No_SCSI_Status"
block|}
block|,
block|{
name|MPI_SCSI_STATE_TERMINATED
block|,
literal|"State_Terminated"
block|}
block|,
block|{
name|MPI_SCSI_STATE_RESPONSE_INFO_VALID
block|,
literal|"Repsonse_Info_Valid"
block|}
block|,
block|{
name|MPI_SCSI_STATE_QUEUE_TAG_REJECTED
block|,
literal|"Queue Tag Rejected"
block|}
block|,
block|{
operator|-
literal|1
block|,
literal|0
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|Error_Map
name|IOC_SCSIStatus
index|[]
init|=
block|{
block|{
name|SCSI_STATUS_OK
block|,
literal|"OK"
block|}
block|,
block|{
name|SCSI_STATUS_CHECK_COND
block|,
literal|"Check Condition"
block|}
block|,
block|{
name|SCSI_STATUS_COND_MET
block|,
literal|"Check Condition Met"
block|}
block|,
block|{
name|SCSI_STATUS_BUSY
block|,
literal|"Busy"
block|}
block|,
block|{
name|SCSI_STATUS_INTERMED
block|,
literal|"Intermidiate Condition"
block|}
block|,
block|{
name|SCSI_STATUS_INTERMED_COND_MET
block|,
literal|"Intermidiate Condition Met"
block|}
block|,
block|{
name|SCSI_STATUS_RESERV_CONFLICT
block|,
literal|"Reservation Conflict"
block|}
block|,
block|{
name|SCSI_STATUS_CMD_TERMINATED
block|,
literal|"Command Terminated"
block|}
block|,
block|{
name|SCSI_STATUS_QUEUE_FULL
block|,
literal|"Queue Full"
block|}
block|,
block|{
operator|-
literal|1
block|,
literal|0
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|Error_Map
name|IOC_Diag
index|[]
init|=
block|{
block|{
name|MPI_DIAG_DRWE
block|,
literal|"DWE"
block|}
block|,
block|{
name|MPI_DIAG_FLASH_BAD_SIG
block|,
literal|"FLASH_Bad"
block|}
block|,
block|{
name|MPI_DIAGNOSTIC_OFFSET
block|,
literal|"Offset"
block|}
block|,
block|{
name|MPI_DIAG_RESET_ADAPTER
block|,
literal|"Reset"
block|}
block|,
block|{
name|MPI_DIAG_DISABLE_ARM
block|,
literal|"DisARM"
block|}
block|,
block|{
name|MPI_DIAG_MEM_ENABLE
block|,
literal|"DME"
block|}
block|,
block|{
operator|-
literal|1
block|,
literal|0
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|Error_Map
name|IOC_SCSITMType
index|[]
init|=
block|{
block|{
name|MPI_SCSITASKMGMT_TASKTYPE_ABORT_TASK
block|,
literal|"Abort Task"
block|}
block|,
block|{
name|MPI_SCSITASKMGMT_TASKTYPE_ABRT_TASK_SET
block|,
literal|"Abort Task Set"
block|}
block|,
block|{
name|MPI_SCSITASKMGMT_TASKTYPE_TARGET_RESET
block|,
literal|"Target Reset"
block|}
block|,
block|{
name|MPI_SCSITASKMGMT_TASKTYPE_RESET_BUS
block|,
literal|"Reset Bus"
block|}
block|,
block|{
name|MPI_SCSITASKMGMT_TASKTYPE_LOGICAL_UNIT_RESET
block|,
literal|"Logical Unit Reset"
block|}
block|,
block|{
operator|-
literal|1
block|,
literal|0
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|char
modifier|*
name|mpt_ioc_status
parameter_list|(
name|int
name|code
parameter_list|)
block|{
specifier|const
name|struct
name|Error_Map
modifier|*
name|status
init|=
name|IOC_Status
decl_stmt|;
specifier|static
name|char
name|buf
index|[
literal|64
index|]
decl_stmt|;
while|while
condition|(
name|status
operator|->
name|Error_Code
operator|>=
literal|0
condition|)
block|{
if|if
condition|(
name|status
operator|->
name|Error_Code
operator|==
operator|(
name|code
operator|&
name|MPI_IOCSTATUS_MASK
operator|)
condition|)
return|return
name|status
operator|->
name|Error_String
return|;
name|status
operator|++
expr_stmt|;
block|}
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
name|buf
argument_list|,
literal|"Unknown (0x%08x)"
argument_list|,
name|code
argument_list|)
expr_stmt|;
return|return
name|buf
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|mpt_ioc_diag
parameter_list|(
name|u_int32_t
name|code
parameter_list|)
block|{
specifier|const
name|struct
name|Error_Map
modifier|*
name|status
init|=
name|IOC_Diag
decl_stmt|;
specifier|static
name|char
name|buf
index|[
literal|128
index|]
decl_stmt|;
name|char
modifier|*
name|ptr
init|=
name|buf
decl_stmt|;
name|char
modifier|*
name|end
init|=
operator|&
name|buf
index|[
literal|128
index|]
decl_stmt|;
name|buf
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|ptr
operator|+=
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
name|buf
argument_list|,
literal|"(0x%08x)"
argument_list|,
name|code
argument_list|)
expr_stmt|;
while|while
condition|(
name|status
operator|->
name|Error_Code
operator|>=
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|status
operator|->
name|Error_Code
operator|&
name|code
operator|)
operator|!=
literal|0
condition|)
name|ptr
operator|+=
name|snprintf
argument_list|(
name|ptr
argument_list|,
call|(
name|size_t
call|)
argument_list|(
name|end
operator|-
name|ptr
argument_list|)
argument_list|,
literal|"%s "
argument_list|,
name|status
operator|->
name|Error_String
argument_list|)
expr_stmt|;
name|status
operator|++
expr_stmt|;
block|}
return|return
name|buf
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|mpt_ioc_function
parameter_list|(
name|int
name|code
parameter_list|)
block|{
specifier|const
name|struct
name|Error_Map
modifier|*
name|status
init|=
name|IOC_Func
decl_stmt|;
specifier|static
name|char
name|buf
index|[
literal|64
index|]
decl_stmt|;
while|while
condition|(
name|status
operator|->
name|Error_Code
operator|>=
literal|0
condition|)
block|{
if|if
condition|(
name|status
operator|->
name|Error_Code
operator|==
name|code
condition|)
return|return
name|status
operator|->
name|Error_String
return|;
name|status
operator|++
expr_stmt|;
block|}
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
name|buf
argument_list|,
literal|"Unknown (0x%08x)"
argument_list|,
name|code
argument_list|)
expr_stmt|;
return|return
name|buf
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|mpt_ioc_event
parameter_list|(
name|int
name|code
parameter_list|)
block|{
specifier|const
name|struct
name|Error_Map
modifier|*
name|status
init|=
name|IOC_Event
decl_stmt|;
specifier|static
name|char
name|buf
index|[
literal|64
index|]
decl_stmt|;
while|while
condition|(
name|status
operator|->
name|Error_Code
operator|>=
literal|0
condition|)
block|{
if|if
condition|(
name|status
operator|->
name|Error_Code
operator|==
name|code
condition|)
return|return
name|status
operator|->
name|Error_String
return|;
name|status
operator|++
expr_stmt|;
block|}
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
name|buf
argument_list|,
literal|"Unknown (0x%08x)"
argument_list|,
name|code
argument_list|)
expr_stmt|;
return|return
name|buf
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|mpt_scsi_state
parameter_list|(
name|int
name|code
parameter_list|)
block|{
specifier|const
name|struct
name|Error_Map
modifier|*
name|status
init|=
name|IOC_SCSIState
decl_stmt|;
specifier|static
name|char
name|buf
index|[
literal|128
index|]
decl_stmt|;
name|char
modifier|*
name|ptr
init|=
name|buf
decl_stmt|;
name|char
modifier|*
name|end
init|=
operator|&
name|buf
index|[
literal|128
index|]
decl_stmt|;
name|buf
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|ptr
operator|+=
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
name|buf
argument_list|,
literal|"(0x%08x)"
argument_list|,
name|code
argument_list|)
expr_stmt|;
while|while
condition|(
name|status
operator|->
name|Error_Code
operator|>=
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|status
operator|->
name|Error_Code
operator|&
name|code
operator|)
operator|!=
literal|0
condition|)
name|ptr
operator|+=
name|snprintf
argument_list|(
name|ptr
argument_list|,
call|(
name|size_t
call|)
argument_list|(
name|end
operator|-
name|ptr
argument_list|)
argument_list|,
literal|"%s "
argument_list|,
name|status
operator|->
name|Error_String
argument_list|)
expr_stmt|;
name|status
operator|++
expr_stmt|;
block|}
return|return
name|buf
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|mpt_scsi_status
parameter_list|(
name|int
name|code
parameter_list|)
block|{
specifier|const
name|struct
name|Error_Map
modifier|*
name|status
init|=
name|IOC_SCSIStatus
decl_stmt|;
specifier|static
name|char
name|buf
index|[
literal|64
index|]
decl_stmt|;
while|while
condition|(
name|status
operator|->
name|Error_Code
operator|>=
literal|0
condition|)
block|{
if|if
condition|(
name|status
operator|->
name|Error_Code
operator|==
name|code
condition|)
return|return
name|status
operator|->
name|Error_String
return|;
name|status
operator|++
expr_stmt|;
block|}
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
name|buf
argument_list|,
literal|"Unknown (0x%08x)"
argument_list|,
name|code
argument_list|)
expr_stmt|;
return|return
name|buf
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|mpt_who
parameter_list|(
name|int
name|who_init
parameter_list|)
block|{
name|char
modifier|*
name|who
decl_stmt|;
switch|switch
condition|(
name|who_init
condition|)
block|{
case|case
name|MPT_DB_INIT_NOONE
case|:
name|who
operator|=
literal|"No One"
expr_stmt|;
break|break;
case|case
name|MPT_DB_INIT_BIOS
case|:
name|who
operator|=
literal|"BIOS"
expr_stmt|;
break|break;
case|case
name|MPT_DB_INIT_ROMBIOS
case|:
name|who
operator|=
literal|"ROM BIOS"
expr_stmt|;
break|break;
case|case
name|MPT_DB_INIT_PCIPEER
case|:
name|who
operator|=
literal|"PCI Peer"
expr_stmt|;
break|break;
case|case
name|MPT_DB_INIT_HOST
case|:
name|who
operator|=
literal|"Host Driver"
expr_stmt|;
break|break;
case|case
name|MPT_DB_INIT_MANUFACTURE
case|:
name|who
operator|=
literal|"Manufacturing"
expr_stmt|;
break|break;
default|default:
name|who
operator|=
literal|"Unknown"
expr_stmt|;
break|break;
block|}
return|return
name|who
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|mpt_state
parameter_list|(
name|u_int32_t
name|mb
parameter_list|)
block|{
name|char
modifier|*
name|text
decl_stmt|;
switch|switch
condition|(
name|MPT_STATE
argument_list|(
name|mb
argument_list|)
condition|)
block|{
case|case
name|MPT_DB_STATE_RESET
case|:
name|text
operator|=
literal|"Reset"
expr_stmt|;
break|break;
case|case
name|MPT_DB_STATE_READY
case|:
name|text
operator|=
literal|"Ready"
expr_stmt|;
break|break;
case|case
name|MPT_DB_STATE_RUNNING
case|:
name|text
operator|=
literal|"Running"
expr_stmt|;
break|break;
case|case
name|MPT_DB_STATE_FAULT
case|:
name|text
operator|=
literal|"Fault"
expr_stmt|;
break|break;
default|default:
name|text
operator|=
literal|"Unknown"
expr_stmt|;
break|break;
block|}
return|return
name|text
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|mpt_scsi_tm_type
parameter_list|(
name|int
name|code
parameter_list|)
block|{
specifier|const
name|struct
name|Error_Map
modifier|*
name|status
init|=
name|IOC_SCSITMType
decl_stmt|;
specifier|static
name|char
name|buf
index|[
literal|64
index|]
decl_stmt|;
while|while
condition|(
name|status
operator|->
name|Error_Code
operator|>=
literal|0
condition|)
block|{
if|if
condition|(
name|status
operator|->
name|Error_Code
operator|==
name|code
condition|)
return|return
name|status
operator|->
name|Error_String
return|;
name|status
operator|++
expr_stmt|;
block|}
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
name|buf
argument_list|,
literal|"Unknown (0x%08x)"
argument_list|,
name|code
argument_list|)
expr_stmt|;
return|return
name|buf
return|;
block|}
end_function

begin_function
name|void
name|mpt_print_db
parameter_list|(
name|u_int32_t
name|mb
parameter_list|)
block|{
name|printf
argument_list|(
literal|"mpt mailbox: (0x%x) State %s  WhoInit %s\n"
argument_list|,
name|mb
argument_list|,
name|mpt_state
argument_list|(
name|mb
argument_list|)
argument_list|,
name|mpt_who
argument_list|(
name|MPT_WHO
argument_list|(
name|mb
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*  Reply functions                                                          */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
specifier|static
name|void
name|mpt_print_reply_hdr
parameter_list|(
name|MSG_DEFAULT_REPLY
modifier|*
name|msg
parameter_list|)
block|{
name|printf
argument_list|(
literal|"%s Reply @ %p\n"
argument_list|,
name|mpt_ioc_function
argument_list|(
name|msg
operator|->
name|Function
argument_list|)
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tIOC Status    %s\n"
argument_list|,
name|mpt_ioc_status
argument_list|(
name|msg
operator|->
name|IOCStatus
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tIOCLogInfo    0x%08lx\n"
argument_list|,
name|msg
operator|->
name|IOCLogInfo
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tMsgLength     0x%02x\n"
argument_list|,
name|msg
operator|->
name|MsgLength
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tMsgFlags      0x%02x\n"
argument_list|,
name|msg
operator|->
name|MsgFlags
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tMsgContext    0x%08lx\n"
argument_list|,
name|msg
operator|->
name|MsgContext
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mpt_print_init_reply
parameter_list|(
name|MSG_IOC_INIT_REPLY
modifier|*
name|msg
parameter_list|)
block|{
name|mpt_print_reply_hdr
argument_list|(
operator|(
name|MSG_DEFAULT_REPLY
operator|*
operator|)
name|msg
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tWhoInit       %s\n"
argument_list|,
name|mpt_who
argument_list|(
name|msg
operator|->
name|WhoInit
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tMaxDevices    0x%02x\n"
argument_list|,
name|msg
operator|->
name|MaxDevices
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tMaxBuses     0x%02x\n"
argument_list|,
name|msg
operator|->
name|MaxBuses
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mpt_print_ioc_facts
parameter_list|(
name|MSG_IOC_FACTS_REPLY
modifier|*
name|msg
parameter_list|)
block|{
name|mpt_print_reply_hdr
argument_list|(
operator|(
name|MSG_DEFAULT_REPLY
operator|*
operator|)
name|msg
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tIOCNumber     %d\n"
argument_list|,
name|msg
operator|->
name|IOCNumber
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tMaxChainDepth %d\n"
argument_list|,
name|msg
operator|->
name|MaxChainDepth
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tWhoInit       %s\n"
argument_list|,
name|mpt_who
argument_list|(
name|msg
operator|->
name|WhoInit
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tBlockSize     %d\n"
argument_list|,
name|msg
operator|->
name|BlockSize
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tFlags         %d\n"
argument_list|,
name|msg
operator|->
name|Flags
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tReplyQueueDepth %d\n"
argument_list|,
name|msg
operator|->
name|ReplyQueueDepth
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tReqFrameSize  0x%04x\n"
argument_list|,
name|msg
operator|->
name|RequestFrameSize
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tFW Version    0x%08lx\n"
argument_list|,
name|msg
operator|->
name|FWVersion
operator|.
name|Word
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tProduct ID    0x%04x\n"
argument_list|,
name|msg
operator|->
name|ProductID
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tCredits       0x%04x\n"
argument_list|,
name|msg
operator|->
name|GlobalCredits
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tPorts         %d\n"
argument_list|,
name|msg
operator|->
name|NumberOfPorts
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tEventState    0x%02x\n"
argument_list|,
name|msg
operator|->
name|EventState
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tHostMFA_HA    0x%08lx\n"
argument_list|,
name|msg
operator|->
name|CurrentHostMfaHighAddr
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tSenseBuf_HA   0x%08lx\n"
argument_list|,
name|msg
operator|->
name|CurrentSenseBufferHighAddr
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tRepFrameSize  0x%04x\n"
argument_list|,
name|msg
operator|->
name|CurReplyFrameSize
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tMaxDevices    0x%02x\n"
argument_list|,
name|msg
operator|->
name|MaxDevices
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tMaxBuses      0x%02x\n"
argument_list|,
name|msg
operator|->
name|MaxBuses
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tFWImageSize   0x%04lx\n"
argument_list|,
name|msg
operator|->
name|FWImageSize
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mpt_print_enable_reply
parameter_list|(
name|MSG_PORT_ENABLE_REPLY
modifier|*
name|msg
parameter_list|)
block|{
name|mpt_print_reply_hdr
argument_list|(
operator|(
name|MSG_DEFAULT_REPLY
operator|*
operator|)
name|msg
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tPort:         %d\n"
argument_list|,
name|msg
operator|->
name|PortNumber
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mpt_print_scsi_io_reply
parameter_list|(
name|MSG_SCSI_IO_REPLY
modifier|*
name|msg
parameter_list|)
block|{
name|mpt_print_reply_hdr
argument_list|(
operator|(
name|MSG_DEFAULT_REPLY
operator|*
operator|)
name|msg
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tBus:          %d\n"
argument_list|,
name|msg
operator|->
name|Bus
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tTargetID      %d\n"
argument_list|,
name|msg
operator|->
name|TargetID
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tCDBLength     %d\n"
argument_list|,
name|msg
operator|->
name|CDBLength
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tSCSI Status:  %s\n"
argument_list|,
name|mpt_scsi_status
argument_list|(
name|msg
operator|->
name|SCSIStatus
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tSCSI State:   %s\n"
argument_list|,
name|mpt_scsi_state
argument_list|(
name|msg
operator|->
name|SCSIState
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tTransferCnt   0x%04lx\n"
argument_list|,
name|msg
operator|->
name|TransferCount
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tSenseCnt      0x%04lx\n"
argument_list|,
name|msg
operator|->
name|SenseCount
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tResponseInfo  0x%08lx\n"
argument_list|,
name|msg
operator|->
name|ResponseInfo
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mpt_print_event_notice
parameter_list|(
name|MSG_EVENT_NOTIFY_REPLY
modifier|*
name|msg
parameter_list|)
block|{
name|mpt_print_reply_hdr
argument_list|(
operator|(
name|MSG_DEFAULT_REPLY
operator|*
operator|)
name|msg
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tEvent:        %s\n"
argument_list|,
name|mpt_ioc_event
argument_list|(
name|msg
operator|->
name|Event
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tEventContext  0x%04lx\n"
argument_list|,
name|msg
operator|->
name|EventContext
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tAckRequired     %d\n"
argument_list|,
name|msg
operator|->
name|AckRequired
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tEventDataLength %d\n"
argument_list|,
name|msg
operator|->
name|EventDataLength
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tContinuation    %d\n"
argument_list|,
name|msg
operator|->
name|MsgFlags
operator|&
literal|0x80
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|msg
operator|->
name|Event
condition|)
block|{
case|case
name|MPI_EVENT_LOG_DATA
case|:
name|printf
argument_list|(
literal|"\tEvtLogData:   0x%04lx\n"
argument_list|,
name|msg
operator|->
name|Data
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|MPI_EVENT_UNIT_ATTENTION
case|:
name|printf
argument_list|(
literal|"\tTargetID:     0x%04lx\n"
argument_list|,
name|msg
operator|->
name|Data
index|[
literal|0
index|]
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tBus:          0x%04lx\n"
argument_list|,
operator|(
name|msg
operator|->
name|Data
index|[
literal|0
index|]
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
break|break;
case|case
name|MPI_EVENT_IOC_BUS_RESET
case|:
case|case
name|MPI_EVENT_EXT_BUS_RESET
case|:
case|case
name|MPI_EVENT_RESCAN
case|:
name|printf
argument_list|(
literal|"\tPort:           %ld\n"
argument_list|,
operator|(
name|msg
operator|->
name|Data
index|[
literal|0
index|]
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
break|break;
case|case
name|MPI_EVENT_LINK_STATUS_CHANGE
case|:
name|printf
argument_list|(
literal|"\tLinkState:    %ld\n"
argument_list|,
name|msg
operator|->
name|Data
index|[
literal|0
index|]
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tPort:         %ld\n"
argument_list|,
operator|(
name|msg
operator|->
name|Data
index|[
literal|1
index|]
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
break|break;
case|case
name|MPI_EVENT_LOOP_STATE_CHANGE
case|:
name|printf
argument_list|(
literal|"\tType:         %ld\n"
argument_list|,
operator|(
name|msg
operator|->
name|Data
index|[
literal|0
index|]
operator|>>
literal|16
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tChar3:      0x%02lx\n"
argument_list|,
operator|(
name|msg
operator|->
name|Data
index|[
literal|0
index|]
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tChar4:      0x%02lx\n"
argument_list|,
operator|(
name|msg
operator|->
name|Data
index|[
literal|0
index|]
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tPort:         %ld\n"
argument_list|,
operator|(
name|msg
operator|->
name|Data
index|[
literal|1
index|]
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
break|break;
case|case
name|MPI_EVENT_LOGOUT
case|:
name|printf
argument_list|(
literal|"\tN_PortId:   0x%04lx\n"
argument_list|,
name|msg
operator|->
name|Data
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tPort:         %ld\n"
argument_list|,
operator|(
name|msg
operator|->
name|Data
index|[
literal|1
index|]
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
name|void
name|mpt_print_reply
parameter_list|(
name|void
modifier|*
name|vmsg
parameter_list|)
block|{
name|MSG_DEFAULT_REPLY
modifier|*
name|msg
init|=
name|vmsg
decl_stmt|;
switch|switch
condition|(
name|msg
operator|->
name|Function
condition|)
block|{
case|case
name|MPI_FUNCTION_EVENT_NOTIFICATION
case|:
name|mpt_print_event_notice
argument_list|(
operator|(
name|MSG_EVENT_NOTIFY_REPLY
operator|*
operator|)
name|msg
argument_list|)
expr_stmt|;
break|break;
case|case
name|MPI_FUNCTION_PORT_ENABLE
case|:
name|mpt_print_enable_reply
argument_list|(
operator|(
name|MSG_PORT_ENABLE_REPLY
operator|*
operator|)
name|msg
argument_list|)
expr_stmt|;
break|break;
case|case
name|MPI_FUNCTION_IOC_FACTS
case|:
name|mpt_print_ioc_facts
argument_list|(
operator|(
name|MSG_IOC_FACTS_REPLY
operator|*
operator|)
name|msg
argument_list|)
expr_stmt|;
break|break;
case|case
name|MPI_FUNCTION_IOC_INIT
case|:
name|mpt_print_init_reply
argument_list|(
operator|(
name|MSG_IOC_INIT_REPLY
operator|*
operator|)
name|msg
argument_list|)
expr_stmt|;
break|break;
case|case
name|MPI_FUNCTION_SCSI_IO_REQUEST
case|:
name|mpt_print_scsi_io_reply
argument_list|(
operator|(
name|MSG_SCSI_IO_REPLY
operator|*
operator|)
name|msg
argument_list|)
expr_stmt|;
break|break;
default|default:
name|mpt_print_reply_hdr
argument_list|(
operator|(
name|MSG_DEFAULT_REPLY
operator|*
operator|)
name|msg
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*  Request functions                                                        */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
specifier|static
name|void
name|mpt_print_request_hdr
parameter_list|(
name|MSG_REQUEST_HEADER
modifier|*
name|req
parameter_list|)
block|{
name|printf
argument_list|(
literal|"%s @ %p\n"
argument_list|,
name|mpt_ioc_function
argument_list|(
name|req
operator|->
name|Function
argument_list|)
argument_list|,
name|req
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tChain Offset  0x%02x\n"
argument_list|,
name|req
operator|->
name|ChainOffset
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tMsgFlags      0x%02x\n"
argument_list|,
name|req
operator|->
name|MsgFlags
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tMsgContext    0x%08lx\n"
argument_list|,
name|req
operator|->
name|MsgContext
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|mpt_print_scsi_io_request
parameter_list|(
name|MSG_SCSI_IO_REQUEST
modifier|*
name|orig_msg
parameter_list|)
block|{
name|MSG_SCSI_IO_REQUEST
name|local
decl_stmt|,
modifier|*
name|msg
init|=
operator|&
name|local
decl_stmt|;
name|int
name|i
decl_stmt|;
name|bcopy
argument_list|(
name|orig_msg
argument_list|,
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|MSG_SCSI_IO_REQUEST
argument_list|)
argument_list|)
expr_stmt|;
name|mpt_print_request_hdr
argument_list|(
operator|(
name|MSG_REQUEST_HEADER
operator|*
operator|)
name|msg
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tBus:                %d\n"
argument_list|,
name|msg
operator|->
name|Bus
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tTargetID            %d\n"
argument_list|,
name|msg
operator|->
name|TargetID
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tSenseBufferLength   %d\n"
argument_list|,
name|msg
operator|->
name|SenseBufferLength
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tLUN:              0x%0x\n"
argument_list|,
name|msg
operator|->
name|LUN
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tControl           0x%08lx "
argument_list|,
name|msg
operator|->
name|Control
argument_list|)
expr_stmt|;
define|#
directive|define
name|MPI_PRINT_FIELD
parameter_list|(
name|x
parameter_list|)
define|\
value|case MPI_SCSIIO_CONTROL_ ## x :					\ 		printf(" " #x " ");					\ 		break
switch|switch
condition|(
name|msg
operator|->
name|Control
operator|&
name|MPI_SCSIIO_CONTROL_DATADIRECTION_MASK
condition|)
block|{
name|MPI_PRINT_FIELD
argument_list|(
name|NODATATRANSFER
argument_list|)
expr_stmt|;
name|MPI_PRINT_FIELD
argument_list|(
name|WRITE
argument_list|)
expr_stmt|;
name|MPI_PRINT_FIELD
argument_list|(
name|READ
argument_list|)
expr_stmt|;
default|default:
name|printf
argument_list|(
literal|" Invalid DIR! "
argument_list|)
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
name|msg
operator|->
name|Control
operator|&
name|MPI_SCSIIO_CONTROL_TASKATTRIBUTE_MASK
condition|)
block|{
name|MPI_PRINT_FIELD
argument_list|(
name|SIMPLEQ
argument_list|)
expr_stmt|;
name|MPI_PRINT_FIELD
argument_list|(
name|HEADOFQ
argument_list|)
expr_stmt|;
name|MPI_PRINT_FIELD
argument_list|(
name|ORDEREDQ
argument_list|)
expr_stmt|;
name|MPI_PRINT_FIELD
argument_list|(
name|ACAQ
argument_list|)
expr_stmt|;
name|MPI_PRINT_FIELD
argument_list|(
name|UNTAGGED
argument_list|)
expr_stmt|;
name|MPI_PRINT_FIELD
argument_list|(
name|NO_DISCONNECT
argument_list|)
expr_stmt|;
default|default:
name|printf
argument_list|(
literal|" Unknown attribute! "
argument_list|)
expr_stmt|;
break|break;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|MPI_PRINT_FIELD
name|printf
argument_list|(
literal|"\tDataLength\t0x%08lx\n"
argument_list|,
name|msg
operator|->
name|DataLength
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tSenseBufAddr\t0x%08lx\n"
argument_list|,
name|msg
operator|->
name|SenseBufferLowAddr
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tCDB[0:%d]\t"
argument_list|,
name|msg
operator|->
name|CDBLength
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|msg
operator|->
name|CDBLength
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"%02x "
argument_list|,
name|msg
operator|->
name|CDB
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|msg
operator|->
name|Control
operator|&
name|MPI_SCSIIO_CONTROL_DATADIRECTION_MASK
operator|)
operator|!=
name|MPI_SCSIIO_CONTROL_NODATATRANSFER
condition|)
block|{
name|mpt_dump_sgl
argument_list|(
operator|&
name|orig_msg
operator|->
name|SGL
argument_list|,
operator|(
operator|(
name|char
operator|*
operator|)
operator|&
name|orig_msg
operator|->
name|SGL
operator|)
operator|-
operator|(
name|char
operator|*
operator|)
name|orig_msg
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|mpt_print_scsi_tmf_request
parameter_list|(
name|MSG_SCSI_TASK_MGMT
modifier|*
name|msg
parameter_list|)
block|{
name|mpt_print_request_hdr
argument_list|(
operator|(
name|MSG_REQUEST_HEADER
operator|*
operator|)
name|msg
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tLun             0x%02x\n"
argument_list|,
name|msg
operator|->
name|LUN
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tTaskType        %s\n"
argument_list|,
name|mpt_scsi_tm_type
argument_list|(
name|msg
operator|->
name|TaskType
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tTaskMsgContext  0x%08lx\n"
argument_list|,
name|msg
operator|->
name|TaskMsgContext
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|mpt_print_request
parameter_list|(
name|void
modifier|*
name|vreq
parameter_list|)
block|{
name|MSG_REQUEST_HEADER
modifier|*
name|req
init|=
name|vreq
decl_stmt|;
switch|switch
condition|(
name|req
operator|->
name|Function
condition|)
block|{
case|case
name|MPI_FUNCTION_SCSI_IO_REQUEST
case|:
name|mpt_print_scsi_io_request
argument_list|(
operator|(
name|MSG_SCSI_IO_REQUEST
operator|*
operator|)
name|req
argument_list|)
expr_stmt|;
break|break;
case|case
name|MPI_FUNCTION_SCSI_TASK_MGMT
case|:
name|mpt_print_scsi_tmf_request
argument_list|(
operator|(
name|MSG_SCSI_TASK_MGMT
operator|*
operator|)
name|req
argument_list|)
expr_stmt|;
default|default:
name|mpt_print_request_hdr
argument_list|(
name|req
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
name|int
name|mpt_decode_value
parameter_list|(
name|mpt_decode_entry_t
modifier|*
name|table
parameter_list|,
name|u_int
name|num_entries
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|u_int
name|value
parameter_list|,
name|u_int
modifier|*
name|cur_column
parameter_list|,
name|u_int
name|wrap_point
parameter_list|)
block|{
name|int
name|printed
decl_stmt|;
name|u_int
name|printed_mask
decl_stmt|;
name|u_int
name|dummy_column
decl_stmt|;
if|if
condition|(
name|cur_column
operator|==
name|NULL
condition|)
block|{
name|dummy_column
operator|=
literal|0
expr_stmt|;
name|cur_column
operator|=
operator|&
name|dummy_column
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|cur_column
operator|>=
name|wrap_point
condition|)
block|{
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
operator|*
name|cur_column
operator|=
literal|0
expr_stmt|;
block|}
name|printed
operator|=
name|printf
argument_list|(
literal|"%s[0x%x]"
argument_list|,
name|name
argument_list|,
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
name|table
operator|==
name|NULL
condition|)
block|{
name|printed
operator|+=
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
operator|*
name|cur_column
operator|+=
name|printed
expr_stmt|;
return|return
operator|(
name|printed
operator|)
return|;
block|}
name|printed_mask
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|printed_mask
operator|!=
literal|0xFF
condition|)
block|{
name|int
name|entry
decl_stmt|;
for|for
control|(
name|entry
operator|=
literal|0
init|;
name|entry
operator|<
name|num_entries
condition|;
name|entry
operator|++
control|)
block|{
if|if
condition|(
operator|(
operator|(
name|value
operator|&
name|table
index|[
name|entry
index|]
operator|.
name|mask
operator|)
operator|!=
name|table
index|[
name|entry
index|]
operator|.
name|value
operator|)
operator|||
operator|(
operator|(
name|printed_mask
operator|&
name|table
index|[
name|entry
index|]
operator|.
name|mask
operator|)
operator|==
name|table
index|[
name|entry
index|]
operator|.
name|mask
operator|)
condition|)
continue|continue;
name|printed
operator|+=
name|printf
argument_list|(
literal|"%s%s"
argument_list|,
name|printed_mask
operator|==
literal|0
condition|?
literal|":("
else|:
literal|"|"
argument_list|,
name|table
index|[
name|entry
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
name|printed_mask
operator||=
name|table
index|[
name|entry
index|]
operator|.
name|mask
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|entry
operator|>=
name|num_entries
condition|)
break|break;
block|}
if|if
condition|(
name|printed_mask
operator|!=
literal|0
condition|)
name|printed
operator|+=
name|printf
argument_list|(
literal|") "
argument_list|)
expr_stmt|;
else|else
name|printed
operator|+=
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
operator|*
name|cur_column
operator|+=
name|printed
expr_stmt|;
return|return
operator|(
name|printed
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|mpt_decode_entry_t
name|req_state_parse_table
index|[]
init|=
block|{
block|{
literal|"REQ_FREE"
block|,
literal|0x00
block|,
literal|0xff
block|}
block|,
block|{
literal|"REQ_ALLOCATED"
block|,
literal|0x01
block|,
literal|0x01
block|}
block|,
block|{
literal|"REQ_QUEUED"
block|,
literal|0x02
block|,
literal|0x02
block|}
block|,
block|{
literal|"REQ_DONE"
block|,
literal|0x04
block|,
literal|0x04
block|}
block|,
block|{
literal|"REQ_TIMEDOUT"
block|,
literal|0x08
block|,
literal|0x08
block|}
block|,
block|{
literal|"REQ_NEED_WAKEUP"
block|,
literal|0x10
block|,
literal|0x10
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|mpt_req_state
parameter_list|(
name|mpt_req_state_t
name|state
parameter_list|)
block|{
name|mpt_decode_value
argument_list|(
name|req_state_parse_table
argument_list|,
name|NUM_ELEMENTS
argument_list|(
name|req_state_parse_table
argument_list|)
argument_list|,
literal|"REQ_STATE"
argument_list|,
name|state
argument_list|,
name|NULL
argument_list|,
literal|80
argument_list|)
expr_stmt|;
block|}
end_function

begin_define
define|#
directive|define
name|LAST_SGE
value|(		\ 	MPI_SGE_FLAGS_END_OF_LIST |	\ 	MPI_SGE_FLAGS_END_OF_BUFFER|	\ 	MPI_SGE_FLAGS_LAST_ELEMENT)
end_define

begin_function
name|void
name|mpt_dump_sgl
parameter_list|(
name|SGE_IO_UNION
modifier|*
name|su
parameter_list|,
name|int
name|offset
parameter_list|)
block|{
name|SGE_SIMPLE32
modifier|*
name|se
init|=
operator|(
name|SGE_SIMPLE32
operator|*
operator|)
name|su
decl_stmt|;
specifier|const
name|char
name|allfox
index|[
literal|4
index|]
init|=
block|{
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|}
decl_stmt|;
name|void
modifier|*
name|nxtaddr
init|=
name|se
decl_stmt|;
name|void
modifier|*
name|lim
decl_stmt|;
name|int
name|flags
decl_stmt|;
comment|/* 	 * Can't be any bigger than this. 	 */
name|lim
operator|=
operator|&
operator|(
operator|(
name|char
operator|*
operator|)
name|se
operator|)
index|[
name|MPT_REQUEST_AREA
operator|-
name|offset
index|]
expr_stmt|;
do|do
block|{
name|int
name|iprt
decl_stmt|;
name|printf
argument_list|(
literal|"\t"
argument_list|)
expr_stmt|;
if|if
condition|(
name|memcmp
argument_list|(
name|se
argument_list|,
name|allfox
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
name|uint32_t
modifier|*
name|nxt
init|=
operator|(
name|uint32_t
operator|*
operator|)
name|se
decl_stmt|;
name|printf
argument_list|(
literal|"PAD  %p\n"
argument_list|,
name|se
argument_list|)
expr_stmt|;
name|nxtaddr
operator|=
name|nxt
operator|+
literal|1
expr_stmt|;
name|se
operator|=
name|nxtaddr
expr_stmt|;
name|flags
operator|=
literal|0
expr_stmt|;
continue|continue;
block|}
name|nxtaddr
operator|=
name|se
operator|+
literal|1
expr_stmt|;
name|flags
operator|=
name|MPI_SGE_GET_FLAGS
argument_list|(
name|se
operator|->
name|FlagsLength
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|flags
operator|&
name|MPI_SGE_FLAGS_ELEMENT_MASK
condition|)
block|{
case|case
name|MPI_SGE_FLAGS_SIMPLE_ELEMENT
case|:
if|if
condition|(
name|flags
operator|&
name|MPI_SGE_FLAGS_64_BIT_ADDRESSING
condition|)
block|{
name|SGE_SIMPLE64
modifier|*
name|se64
init|=
operator|(
name|SGE_SIMPLE64
operator|*
operator|)
name|se
decl_stmt|;
name|printf
argument_list|(
literal|"SE64 %p: Addr=0x%08lx%08lx FlagsLength"
literal|"=0x%lx\n"
argument_list|,
name|se64
argument_list|,
name|se64
operator|->
name|Address
operator|.
name|High
argument_list|,
name|se64
operator|->
name|Address
operator|.
name|Low
argument_list|,
name|se64
operator|->
name|FlagsLength
argument_list|)
expr_stmt|;
name|nxtaddr
operator|=
name|se64
operator|+
literal|1
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"SE32 %p: Addr=0x%08lx FlagsLength=0x%lx"
literal|"\n"
argument_list|,
name|se
argument_list|,
name|se
operator|->
name|Address
argument_list|,
name|se
operator|->
name|FlagsLength
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
break|break;
case|case
name|MPI_SGE_FLAGS_CHAIN_ELEMENT
case|:
if|if
condition|(
name|flags
operator|&
name|MPI_SGE_FLAGS_64_BIT_ADDRESSING
condition|)
block|{
name|SGE_CHAIN64
modifier|*
name|ce64
init|=
operator|(
name|SGE_CHAIN64
operator|*
operator|)
name|se
decl_stmt|;
name|printf
argument_list|(
literal|"CE64 %p: Addr=0x%08lx%08lx NxtChnO="
literal|"0x%x Flgs=0x%x Len=0x%x\n"
argument_list|,
name|ce64
argument_list|,
name|ce64
operator|->
name|Address
operator|.
name|High
argument_list|,
name|ce64
operator|->
name|Address
operator|.
name|Low
argument_list|,
name|ce64
operator|->
name|NextChainOffset
argument_list|,
name|ce64
operator|->
name|Flags
argument_list|,
name|ce64
operator|->
name|Length
argument_list|)
expr_stmt|;
name|nxtaddr
operator|=
name|ce64
operator|+
literal|1
expr_stmt|;
block|}
else|else
block|{
name|SGE_CHAIN32
modifier|*
name|ce
init|=
operator|(
name|SGE_CHAIN32
operator|*
operator|)
name|se
decl_stmt|;
name|printf
argument_list|(
literal|"CE32 %p: Addr=0x%08lx NxtChnO=0x%x "
literal|" Flgs=0x%x Len=0x%x\n"
argument_list|,
name|ce
argument_list|,
name|ce
operator|->
name|Address
argument_list|,
name|ce
operator|->
name|NextChainOffset
argument_list|,
name|ce
operator|->
name|Flags
argument_list|,
name|ce
operator|->
name|Length
argument_list|)
expr_stmt|;
block|}
name|flags
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|MPI_SGE_FLAGS_TRANSACTION_ELEMENT
case|:
name|printf
argument_list|(
literal|"TE32 @ %p\n"
argument_list|,
name|se
argument_list|)
expr_stmt|;
name|flags
operator|=
literal|0
expr_stmt|;
break|break;
block|}
name|iprt
operator|=
literal|0
expr_stmt|;
define|#
directive|define
name|MPT_PRINT_FLAG
parameter_list|(
name|x
parameter_list|)
define|\
value|if (flags& MPI_SGE_FLAGS_ ## x ) { 			\ 			if (iprt == 0) {				\ 				printf("\t");				\ 			}						\ 			printf(" ");					\ 			printf( #x );					\ 			iprt++;						\ 		}
name|MPT_PRINT_FLAG
argument_list|(
name|LOCAL_ADDRESS
argument_list|)
expr_stmt|;
name|MPT_PRINT_FLAG
argument_list|(
name|HOST_TO_IOC
argument_list|)
expr_stmt|;
name|MPT_PRINT_FLAG
argument_list|(
literal|64_BIT_ADDRESSING
argument_list|)
expr_stmt|;
name|MPT_PRINT_FLAG
argument_list|(
name|LAST_ELEMENT
argument_list|)
expr_stmt|;
name|MPT_PRINT_FLAG
argument_list|(
name|END_OF_BUFFER
argument_list|)
expr_stmt|;
name|MPT_PRINT_FLAG
argument_list|(
name|END_OF_LIST
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|MPT_PRINT_FLAG
if|if
condition|(
name|iprt
condition|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|se
operator|=
name|nxtaddr
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|LAST_SGE
operator|)
operator|==
name|LAST_SGE
condition|)
block|{
break|break;
block|}
block|}
do|while
condition|(
operator|(
name|flags
operator|&
name|MPI_SGE_FLAGS_END_OF_LIST
operator|)
operator|==
literal|0
operator|&&
name|nxtaddr
operator|<
name|lim
condition|)
do|;
block|}
end_function

begin_function
name|void
name|mpt_prt
parameter_list|(
name|struct
name|mpt_softc
modifier|*
name|mpt
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|ap
decl_stmt|;
name|printf
argument_list|(
literal|"%s: "
argument_list|,
name|device_get_nameunit
argument_list|(
name|mpt
operator|->
name|dev
argument_list|)
argument_list|)
expr_stmt|;
name|va_start
argument_list|(
name|ap
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|vprintf
argument_list|(
name|fmt
argument_list|,
name|ap
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|mpt_prtc
parameter_list|(
name|struct
name|mpt_softc
modifier|*
name|mpt
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|ap
decl_stmt|;
name|va_start
argument_list|(
name|ap
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|vprintf
argument_list|(
name|fmt
argument_list|,
name|ap
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


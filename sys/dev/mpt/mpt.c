begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  #include<sys/cdefs.h> __FBSDID("$FreeBSD$");  * Generic routines for LSI '909 FC  adapters.  * FreeBSD Version.  *  * Copyright (c) 2000, 2001 by Greg Ansley  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice immediately at the beginning of the file, without modification,  *    this list of conditions, and the following disclaimer.  * 2. The name of the author may not be used to endorse or promote products  *    derived from this software without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE FOR  * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_comment
comment|/*  * Additional Copyright (c) 2002 by Matthew Jacob under same license.  */
end_comment

begin_include
include|#
directive|include
file|<dev/mpt/mpt_freebsd.h>
end_include

begin_define
define|#
directive|define
name|MPT_MAX_TRYS
value|3
end_define

begin_define
define|#
directive|define
name|MPT_MAX_WAIT
value|300000
end_define

begin_decl_stmt
specifier|static
name|int
name|maxwait_ack
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|maxwait_int
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|maxwait_state
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|INLINE
name|u_int32_t
name|mpt_rd_db
parameter_list|(
name|mpt_softc_t
modifier|*
name|mpt
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|INLINE
name|u_int32_t
name|mpt_rd_intr
parameter_list|(
name|mpt_softc_t
modifier|*
name|mpt
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|INLINE
name|u_int32_t
name|mpt_rd_db
parameter_list|(
name|mpt_softc_t
modifier|*
name|mpt
parameter_list|)
block|{
return|return
name|mpt_read
argument_list|(
name|mpt
argument_list|,
name|MPT_OFFSET_DOORBELL
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|INLINE
name|u_int32_t
name|mpt_rd_intr
parameter_list|(
name|mpt_softc_t
modifier|*
name|mpt
parameter_list|)
block|{
return|return
name|mpt_read
argument_list|(
name|mpt
argument_list|,
name|MPT_OFFSET_INTR_STATUS
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Busy wait for a door bell to be read by IOC */
end_comment

begin_function
specifier|static
name|int
name|mpt_wait_db_ack
parameter_list|(
name|mpt_softc_t
modifier|*
name|mpt
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MPT_MAX_WAIT
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|MPT_DB_IS_BUSY
argument_list|(
name|mpt_rd_intr
argument_list|(
name|mpt
argument_list|)
argument_list|)
condition|)
block|{
name|maxwait_ack
operator|=
name|i
operator|>
name|maxwait_ack
condition|?
name|i
else|:
name|maxwait_ack
expr_stmt|;
return|return
name|MPT_OK
return|;
block|}
name|DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
block|}
return|return
name|MPT_FAIL
return|;
block|}
end_function

begin_comment
comment|/* Busy wait for a door bell interrupt */
end_comment

begin_function
specifier|static
name|int
name|mpt_wait_db_int
parameter_list|(
name|mpt_softc_t
modifier|*
name|mpt
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MPT_MAX_WAIT
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|MPT_DB_INTR
argument_list|(
name|mpt_rd_intr
argument_list|(
name|mpt
argument_list|)
argument_list|)
condition|)
block|{
name|maxwait_int
operator|=
name|i
operator|>
name|maxwait_int
condition|?
name|i
else|:
name|maxwait_int
expr_stmt|;
return|return
name|MPT_OK
return|;
block|}
name|DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
block|}
return|return
name|MPT_FAIL
return|;
block|}
end_function

begin_comment
comment|/* Wait for IOC to transition to a give state */
end_comment

begin_function
name|void
name|mpt_check_doorbell
parameter_list|(
name|mpt_softc_t
modifier|*
name|mpt
parameter_list|)
block|{
name|u_int32_t
name|db
init|=
name|mpt_rd_db
argument_list|(
name|mpt
argument_list|)
decl_stmt|;
if|if
condition|(
name|MPT_STATE
argument_list|(
name|db
argument_list|)
operator|!=
name|MPT_DB_STATE_RUNNING
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"Device not running"
argument_list|)
expr_stmt|;
name|mpt_print_db
argument_list|(
name|db
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* Wait for IOC to transition to a give state */
end_comment

begin_function
specifier|static
name|int
name|mpt_wait_state
parameter_list|(
name|mpt_softc_t
modifier|*
name|mpt
parameter_list|,
name|enum
name|DB_STATE_BITS
name|state
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MPT_MAX_WAIT
condition|;
name|i
operator|++
control|)
block|{
name|u_int32_t
name|db
init|=
name|mpt_rd_db
argument_list|(
name|mpt
argument_list|)
decl_stmt|;
if|if
condition|(
name|MPT_STATE
argument_list|(
name|db
argument_list|)
operator|==
name|state
condition|)
block|{
name|maxwait_state
operator|=
name|i
operator|>
name|maxwait_state
condition|?
name|i
else|:
name|maxwait_state
expr_stmt|;
return|return
operator|(
name|MPT_OK
operator|)
return|;
block|}
name|DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|MPT_FAIL
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Issue the reset COMMAND to the IOC */
end_comment

begin_function
name|int
name|mpt_soft_reset
parameter_list|(
name|mpt_softc_t
modifier|*
name|mpt
parameter_list|)
block|{
if|if
condition|(
name|mpt
operator|->
name|verbose
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"soft reset"
argument_list|)
expr_stmt|;
block|}
comment|/* Have to use hard reset if we are not in Running state */
if|if
condition|(
name|MPT_STATE
argument_list|(
name|mpt_rd_db
argument_list|(
name|mpt
argument_list|)
argument_list|)
operator|!=
name|MPT_DB_STATE_RUNNING
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"soft reset failed: device not running"
argument_list|)
expr_stmt|;
return|return
name|MPT_FAIL
return|;
block|}
comment|/* If door bell is in use we don't have a chance of getting 	 * a word in since the IOC probably crashed in message 	 * processing. So don't waste our time. 	 */
if|if
condition|(
name|MPT_DB_IS_IN_USE
argument_list|(
name|mpt_rd_db
argument_list|(
name|mpt
argument_list|)
argument_list|)
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"soft reset failed: doorbell wedged"
argument_list|)
expr_stmt|;
return|return
name|MPT_FAIL
return|;
block|}
comment|/* Send the reset request to the IOC */
name|mpt_write
argument_list|(
name|mpt
argument_list|,
name|MPT_OFFSET_DOORBELL
argument_list|,
name|MPI_FUNCTION_IOC_MESSAGE_UNIT_RESET
operator|<<
name|MPI_DOORBELL_FUNCTION_SHIFT
argument_list|)
expr_stmt|;
if|if
condition|(
name|mpt_wait_db_ack
argument_list|(
name|mpt
argument_list|)
operator|!=
name|MPT_OK
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"soft reset failed: ack timeout"
argument_list|)
expr_stmt|;
return|return
name|MPT_FAIL
return|;
block|}
comment|/* Wait for the IOC to reload and come out of reset state */
if|if
condition|(
name|mpt_wait_state
argument_list|(
name|mpt
argument_list|,
name|MPT_DB_STATE_READY
argument_list|)
operator|!=
name|MPT_OK
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"soft reset failed: device did not start running"
argument_list|)
expr_stmt|;
return|return
name|MPT_FAIL
return|;
block|}
return|return
name|MPT_OK
return|;
block|}
end_function

begin_comment
comment|/* This is a magic diagnostic reset that resets all the ARM  * processors in the chip.   */
end_comment

begin_function
name|void
name|mpt_hard_reset
parameter_list|(
name|mpt_softc_t
modifier|*
name|mpt
parameter_list|)
block|{
comment|/* This extra read comes for the Linux source 	 * released by LSI. It's function is undocumented! 	 */
if|if
condition|(
name|mpt
operator|->
name|verbose
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"hard reset"
argument_list|)
expr_stmt|;
block|}
name|mpt_read
argument_list|(
name|mpt
argument_list|,
name|MPT_OFFSET_FUBAR
argument_list|)
expr_stmt|;
comment|/* Enable diagnostic registers */
name|mpt_write
argument_list|(
name|mpt
argument_list|,
name|MPT_OFFSET_SEQUENCE
argument_list|,
name|MPT_DIAG_SEQUENCE_1
argument_list|)
expr_stmt|;
name|mpt_write
argument_list|(
name|mpt
argument_list|,
name|MPT_OFFSET_SEQUENCE
argument_list|,
name|MPT_DIAG_SEQUENCE_2
argument_list|)
expr_stmt|;
name|mpt_write
argument_list|(
name|mpt
argument_list|,
name|MPT_OFFSET_SEQUENCE
argument_list|,
name|MPT_DIAG_SEQUENCE_3
argument_list|)
expr_stmt|;
name|mpt_write
argument_list|(
name|mpt
argument_list|,
name|MPT_OFFSET_SEQUENCE
argument_list|,
name|MPT_DIAG_SEQUENCE_4
argument_list|)
expr_stmt|;
name|mpt_write
argument_list|(
name|mpt
argument_list|,
name|MPT_OFFSET_SEQUENCE
argument_list|,
name|MPT_DIAG_SEQUENCE_5
argument_list|)
expr_stmt|;
comment|/* Diag. port is now active so we can now hit the reset bit */
name|mpt_write
argument_list|(
name|mpt
argument_list|,
name|MPT_OFFSET_DIAGNOSTIC
argument_list|,
name|MPT_DIAG_RESET_IOC
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|10000
argument_list|)
expr_stmt|;
comment|/* Disable Diagnostic Register */
name|mpt_write
argument_list|(
name|mpt
argument_list|,
name|MPT_OFFSET_SEQUENCE
argument_list|,
literal|0xFF
argument_list|)
expr_stmt|;
comment|/* Restore the config register values */
comment|/*   Hard resets are known to screw up the BAR for diagnostic 	     memory accesses (Mem1). */
name|mpt_set_config_regs
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
if|if
condition|(
name|mpt
operator|->
name|mpt2
operator|!=
name|NULL
condition|)
block|{
name|mpt_set_config_regs
argument_list|(
name|mpt
operator|->
name|mpt2
argument_list|)
expr_stmt|;
block|}
comment|/* Note that if there is no valid firmware to run, the doorbell will 	   remain in the reset state (0x00000000) */
block|}
end_function

begin_comment
comment|/*  * Reset the IOC when needed. Try software command first then if needed  * poke at the magic diagnostic reset. Note that a hard reset resets  * *both* IOCs on dual function chips (FC929&& LSI1030) as well as  * fouls up the PCI configuration registers.  */
end_comment

begin_function
name|int
name|mpt_reset
parameter_list|(
name|mpt_softc_t
modifier|*
name|mpt
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
comment|/* Try a soft reset */
if|if
condition|(
operator|(
name|ret
operator|=
name|mpt_soft_reset
argument_list|(
name|mpt
argument_list|)
operator|)
operator|!=
name|MPT_OK
condition|)
block|{
comment|/* Failed; do a hard reset */
name|mpt_hard_reset
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
comment|/* Wait for the IOC to reload and come out of reset state */
name|ret
operator|=
name|mpt_wait_state
argument_list|(
name|mpt
argument_list|,
name|MPT_DB_STATE_READY
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|MPT_OK
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"failed to reset device"
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/* Return a command buffer to the free queue */
end_comment

begin_function
name|void
name|mpt_free_request
parameter_list|(
name|mpt_softc_t
modifier|*
name|mpt
parameter_list|,
name|request_t
modifier|*
name|req
parameter_list|)
block|{
if|if
condition|(
name|req
operator|==
name|NULL
operator|||
name|req
operator|!=
operator|&
name|mpt
operator|->
name|request_pool
index|[
name|req
operator|->
name|index
index|]
condition|)
block|{
name|panic
argument_list|(
literal|"mpt_free_request bad req ptr\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|req
operator|->
name|sequence
operator|=
literal|0
expr_stmt|;
name|req
operator|->
name|ccb
operator|=
name|NULL
expr_stmt|;
name|req
operator|->
name|debug
operator|=
name|REQ_FREE
expr_stmt|;
name|SLIST_INSERT_HEAD
argument_list|(
operator|&
name|mpt
operator|->
name|request_free_list
argument_list|,
name|req
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Get a command buffer from the free queue */
end_comment

begin_function
name|request_t
modifier|*
name|mpt_get_request
parameter_list|(
name|mpt_softc_t
modifier|*
name|mpt
parameter_list|)
block|{
name|request_t
modifier|*
name|req
decl_stmt|;
name|req
operator|=
name|SLIST_FIRST
argument_list|(
operator|&
name|mpt
operator|->
name|request_free_list
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|req
operator|!=
operator|&
name|mpt
operator|->
name|request_pool
index|[
name|req
operator|->
name|index
index|]
condition|)
block|{
name|panic
argument_list|(
literal|"mpt_get_request: corrupted request free list\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|req
operator|->
name|ccb
operator|!=
name|NULL
condition|)
block|{
name|panic
argument_list|(
literal|"mpt_get_request: corrupted request free list (ccb)\n"
argument_list|)
expr_stmt|;
block|}
name|SLIST_REMOVE_HEAD
argument_list|(
operator|&
name|mpt
operator|->
name|request_free_list
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|req
operator|->
name|debug
operator|=
name|REQ_IN_PROGRESS
expr_stmt|;
block|}
return|return
name|req
return|;
block|}
end_function

begin_comment
comment|/* Pass the command to the IOC */
end_comment

begin_function
name|void
name|mpt_send_cmd
parameter_list|(
name|mpt_softc_t
modifier|*
name|mpt
parameter_list|,
name|request_t
modifier|*
name|req
parameter_list|)
block|{
name|req
operator|->
name|sequence
operator|=
name|mpt
operator|->
name|sequence
operator|++
expr_stmt|;
if|if
condition|(
name|mpt
operator|->
name|verbose
operator|>
literal|1
condition|)
block|{
name|u_int32_t
modifier|*
name|pReq
decl_stmt|;
name|pReq
operator|=
name|req
operator|->
name|req_vbuf
expr_stmt|;
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"Send Request %d (0x%x):"
argument_list|,
name|req
operator|->
name|index
argument_list|,
name|req
operator|->
name|req_pbuf
argument_list|)
expr_stmt|;
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"%08x %08x %08x %08x"
argument_list|,
name|pReq
index|[
literal|0
index|]
argument_list|,
name|pReq
index|[
literal|1
index|]
argument_list|,
name|pReq
index|[
literal|2
index|]
argument_list|,
name|pReq
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"%08x %08x %08x %08x"
argument_list|,
name|pReq
index|[
literal|4
index|]
argument_list|,
name|pReq
index|[
literal|5
index|]
argument_list|,
name|pReq
index|[
literal|6
index|]
argument_list|,
name|pReq
index|[
literal|7
index|]
argument_list|)
expr_stmt|;
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"%08x %08x %08x %08x"
argument_list|,
name|pReq
index|[
literal|8
index|]
argument_list|,
name|pReq
index|[
literal|9
index|]
argument_list|,
name|pReq
index|[
literal|10
index|]
argument_list|,
name|pReq
index|[
literal|11
index|]
argument_list|)
expr_stmt|;
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"%08x %08x %08x %08x"
argument_list|,
name|pReq
index|[
literal|12
index|]
argument_list|,
name|pReq
index|[
literal|13
index|]
argument_list|,
name|pReq
index|[
literal|14
index|]
argument_list|,
name|pReq
index|[
literal|15
index|]
argument_list|)
expr_stmt|;
block|}
name|bus_dmamap_sync
argument_list|(
name|mpt
operator|->
name|request_dmat
argument_list|,
name|mpt
operator|->
name|request_dmap
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
name|req
operator|->
name|debug
operator|=
name|REQ_ON_CHIP
expr_stmt|;
name|mpt_write
argument_list|(
name|mpt
argument_list|,
name|MPT_OFFSET_REQUEST_Q
argument_list|,
operator|(
name|u_int32_t
operator|)
name|req
operator|->
name|req_pbuf
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Give the reply buffer back to the IOC after we have  * finished processing it.  */
end_comment

begin_function
name|void
name|mpt_free_reply
parameter_list|(
name|mpt_softc_t
modifier|*
name|mpt
parameter_list|,
name|u_int32_t
name|ptr
parameter_list|)
block|{
name|mpt_write
argument_list|(
name|mpt
argument_list|,
name|MPT_OFFSET_REPLY_Q
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Get a reply from the IOC */
end_comment

begin_function
name|u_int32_t
name|mpt_pop_reply_queue
parameter_list|(
name|mpt_softc_t
modifier|*
name|mpt
parameter_list|)
block|{
return|return
name|mpt_read
argument_list|(
name|mpt
argument_list|,
name|MPT_OFFSET_REPLY_Q
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  * Send a command to the IOC via the handshake register.  *  * Only done at initialization time and for certain unusual  * commands such as device/bus reset as specified by LSI.  */
end_comment

begin_function
name|int
name|mpt_send_handshake_cmd
parameter_list|(
name|mpt_softc_t
modifier|*
name|mpt
parameter_list|,
name|size_t
name|len
parameter_list|,
name|void
modifier|*
name|cmd
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|u_int32_t
name|data
decl_stmt|,
modifier|*
name|data32
decl_stmt|;
comment|/* Check condition of the IOC */
name|data
operator|=
name|mpt_rd_db
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|MPT_STATE
argument_list|(
name|data
argument_list|)
operator|!=
name|MPT_DB_STATE_READY
operator|)
operator|&&
operator|(
name|MPT_STATE
argument_list|(
name|data
argument_list|)
operator|!=
name|MPT_DB_STATE_RUNNING
operator|)
operator|&&
operator|(
name|MPT_STATE
argument_list|(
name|data
argument_list|)
operator|!=
name|MPT_DB_STATE_FAULT
operator|)
operator|)
operator|||
operator|(
name|MPT_DB_IS_IN_USE
argument_list|(
name|data
argument_list|)
operator|)
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"handshake aborted due to invalid doorbell state"
argument_list|)
expr_stmt|;
name|mpt_print_db
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
operator|(
name|EBUSY
operator|)
return|;
block|}
comment|/* We move things in 32 bit chunks */
name|len
operator|=
operator|(
name|len
operator|+
literal|3
operator|)
operator|>>
literal|2
expr_stmt|;
name|data32
operator|=
name|cmd
expr_stmt|;
comment|/* Clear any left over pending doorbell interupts */
if|if
condition|(
name|MPT_DB_INTR
argument_list|(
name|mpt_rd_intr
argument_list|(
name|mpt
argument_list|)
argument_list|)
condition|)
name|mpt_write
argument_list|(
name|mpt
argument_list|,
name|MPT_OFFSET_INTR_STATUS
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* 	 * Tell the handshake reg. we are going to send a command          * and how long it is going to be. 	 */
name|data
operator|=
operator|(
name|MPI_FUNCTION_HANDSHAKE
operator|<<
name|MPI_DOORBELL_FUNCTION_SHIFT
operator|)
operator||
operator|(
name|len
operator|<<
name|MPI_DOORBELL_ADD_DWORDS_SHIFT
operator|)
expr_stmt|;
name|mpt_write
argument_list|(
name|mpt
argument_list|,
name|MPT_OFFSET_DOORBELL
argument_list|,
name|data
argument_list|)
expr_stmt|;
comment|/* Wait for the chip to notice */
if|if
condition|(
name|mpt_wait_db_int
argument_list|(
name|mpt
argument_list|)
operator|!=
name|MPT_OK
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"mpt_send_handshake_cmd timeout1"
argument_list|)
expr_stmt|;
return|return
name|ETIMEDOUT
return|;
block|}
comment|/* Clear the interrupt */
name|mpt_write
argument_list|(
name|mpt
argument_list|,
name|MPT_OFFSET_INTR_STATUS
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|mpt_wait_db_ack
argument_list|(
name|mpt
argument_list|)
operator|!=
name|MPT_OK
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"mpt_send_handshake_cmd timeout2"
argument_list|)
expr_stmt|;
return|return
name|ETIMEDOUT
return|;
block|}
comment|/* Send the command */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
block|{
name|mpt_write
argument_list|(
name|mpt
argument_list|,
name|MPT_OFFSET_DOORBELL
argument_list|,
operator|*
name|data32
operator|++
argument_list|)
expr_stmt|;
if|if
condition|(
name|mpt_wait_db_ack
argument_list|(
name|mpt
argument_list|)
operator|!=
name|MPT_OK
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"mpt_send_handshake_cmd timeout! index = %d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
return|return
name|ETIMEDOUT
return|;
block|}
block|}
return|return
name|MPT_OK
return|;
block|}
end_function

begin_comment
comment|/* Get the response from the handshake register */
end_comment

begin_function
name|int
name|mpt_recv_handshake_reply
parameter_list|(
name|mpt_softc_t
modifier|*
name|mpt
parameter_list|,
name|size_t
name|reply_len
parameter_list|,
name|void
modifier|*
name|reply
parameter_list|)
block|{
name|int
name|left
decl_stmt|,
name|reply_left
decl_stmt|;
name|u_int16_t
modifier|*
name|data16
decl_stmt|;
name|MSG_DEFAULT_REPLY
modifier|*
name|hdr
decl_stmt|;
comment|/* We move things out in 16 bit chunks */
name|reply_len
operator|>>=
literal|1
expr_stmt|;
name|data16
operator|=
operator|(
name|u_int16_t
operator|*
operator|)
name|reply
expr_stmt|;
name|hdr
operator|=
operator|(
name|MSG_DEFAULT_REPLY
operator|*
operator|)
name|reply
expr_stmt|;
comment|/* Get first word */
if|if
condition|(
name|mpt_wait_db_int
argument_list|(
name|mpt
argument_list|)
operator|!=
name|MPT_OK
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"mpt_recv_handshake_cmd timeout1"
argument_list|)
expr_stmt|;
return|return
name|ETIMEDOUT
return|;
block|}
operator|*
name|data16
operator|++
operator|=
name|mpt_read
argument_list|(
name|mpt
argument_list|,
name|MPT_OFFSET_DOORBELL
argument_list|)
operator|&
name|MPT_DB_DATA_MASK
expr_stmt|;
name|mpt_write
argument_list|(
name|mpt
argument_list|,
name|MPT_OFFSET_INTR_STATUS
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Get Second Word */
if|if
condition|(
name|mpt_wait_db_int
argument_list|(
name|mpt
argument_list|)
operator|!=
name|MPT_OK
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"mpt_recv_handshake_cmd timeout2"
argument_list|)
expr_stmt|;
return|return
name|ETIMEDOUT
return|;
block|}
operator|*
name|data16
operator|++
operator|=
name|mpt_read
argument_list|(
name|mpt
argument_list|,
name|MPT_OFFSET_DOORBELL
argument_list|)
operator|&
name|MPT_DB_DATA_MASK
expr_stmt|;
name|mpt_write
argument_list|(
name|mpt
argument_list|,
name|MPT_OFFSET_INTR_STATUS
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* With the second word, we can now look at the length */
if|if
condition|(
name|mpt
operator|->
name|verbose
operator|>
literal|1
operator|&&
operator|(
operator|(
name|reply_len
operator|>>
literal|1
operator|)
operator|!=
name|hdr
operator|->
name|MsgLength
operator|)
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"reply length does not match message length: "
literal|"got 0x%02x, expected 0x%02x"
argument_list|,
name|hdr
operator|->
name|MsgLength
operator|<<
literal|2
argument_list|,
name|reply_len
operator|<<
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* Get rest of the reply; but don't overflow the provided buffer */
name|left
operator|=
operator|(
name|hdr
operator|->
name|MsgLength
operator|<<
literal|1
operator|)
operator|-
literal|2
expr_stmt|;
name|reply_left
operator|=
name|reply_len
operator|-
literal|2
expr_stmt|;
while|while
condition|(
name|left
operator|--
condition|)
block|{
name|u_int16_t
name|datum
decl_stmt|;
if|if
condition|(
name|mpt_wait_db_int
argument_list|(
name|mpt
argument_list|)
operator|!=
name|MPT_OK
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"mpt_recv_handshake_cmd timeout3"
argument_list|)
expr_stmt|;
return|return
name|ETIMEDOUT
return|;
block|}
name|datum
operator|=
name|mpt_read
argument_list|(
name|mpt
argument_list|,
name|MPT_OFFSET_DOORBELL
argument_list|)
expr_stmt|;
if|if
condition|(
name|reply_left
operator|--
operator|>
literal|0
condition|)
operator|*
name|data16
operator|++
operator|=
name|datum
operator|&
name|MPT_DB_DATA_MASK
expr_stmt|;
name|mpt_write
argument_list|(
name|mpt
argument_list|,
name|MPT_OFFSET_INTR_STATUS
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
comment|/* One more wait& clear at the end */
if|if
condition|(
name|mpt_wait_db_int
argument_list|(
name|mpt
argument_list|)
operator|!=
name|MPT_OK
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"mpt_recv_handshake_cmd timeout4"
argument_list|)
expr_stmt|;
return|return
name|ETIMEDOUT
return|;
block|}
name|mpt_write
argument_list|(
name|mpt
argument_list|,
name|MPT_OFFSET_INTR_STATUS
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|hdr
operator|->
name|IOCStatus
operator|&
name|MPI_IOCSTATUS_MASK
operator|)
operator|!=
name|MPI_IOCSTATUS_SUCCESS
condition|)
block|{
if|if
condition|(
name|mpt
operator|->
name|verbose
operator|>
literal|1
condition|)
name|mpt_print_reply
argument_list|(
name|hdr
argument_list|)
expr_stmt|;
return|return
operator|(
name|MPT_FAIL
operator||
name|hdr
operator|->
name|IOCStatus
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mpt_get_iocfacts
parameter_list|(
name|mpt_softc_t
modifier|*
name|mpt
parameter_list|,
name|MSG_IOC_FACTS_REPLY
modifier|*
name|freplp
parameter_list|)
block|{
name|MSG_IOC_FACTS
name|f_req
decl_stmt|;
name|int
name|error
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|f_req
argument_list|,
sizeof|sizeof
name|f_req
argument_list|)
expr_stmt|;
name|f_req
operator|.
name|Function
operator|=
name|MPI_FUNCTION_IOC_FACTS
expr_stmt|;
name|f_req
operator|.
name|MsgContext
operator|=
literal|0x12071942
expr_stmt|;
name|error
operator|=
name|mpt_send_handshake_cmd
argument_list|(
name|mpt
argument_list|,
sizeof|sizeof
name|f_req
argument_list|,
operator|&
name|f_req
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|error
operator|=
name|mpt_recv_handshake_reply
argument_list|(
name|mpt
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|freplp
argument_list|)
argument_list|,
name|freplp
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mpt_get_portfacts
parameter_list|(
name|mpt_softc_t
modifier|*
name|mpt
parameter_list|,
name|MSG_PORT_FACTS_REPLY
modifier|*
name|freplp
parameter_list|)
block|{
name|MSG_PORT_FACTS
name|f_req
decl_stmt|;
name|int
name|error
decl_stmt|;
comment|/* XXX: Only getting PORT FACTS for Port 0 */
name|bzero
argument_list|(
operator|&
name|f_req
argument_list|,
sizeof|sizeof
name|f_req
argument_list|)
expr_stmt|;
name|f_req
operator|.
name|Function
operator|=
name|MPI_FUNCTION_PORT_FACTS
expr_stmt|;
name|f_req
operator|.
name|MsgContext
operator|=
literal|0x12071943
expr_stmt|;
name|error
operator|=
name|mpt_send_handshake_cmd
argument_list|(
name|mpt
argument_list|,
sizeof|sizeof
name|f_req
argument_list|,
operator|&
name|f_req
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|error
operator|=
name|mpt_recv_handshake_reply
argument_list|(
name|mpt
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|freplp
argument_list|)
argument_list|,
name|freplp
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Send the initialization request. This is where we specify how many  * SCSI busses and how many devices per bus we wish to emulate.  * This is also the command that specifies the max size of the reply  * frames from the IOC that we will be allocating.  */
end_comment

begin_function
specifier|static
name|int
name|mpt_send_ioc_init
parameter_list|(
name|mpt_softc_t
modifier|*
name|mpt
parameter_list|,
name|u_int32_t
name|who
parameter_list|)
block|{
name|int
name|error
init|=
literal|0
decl_stmt|;
name|MSG_IOC_INIT
name|init
decl_stmt|;
name|MSG_IOC_INIT_REPLY
name|reply
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|init
argument_list|,
sizeof|sizeof
name|init
argument_list|)
expr_stmt|;
name|init
operator|.
name|WhoInit
operator|=
name|who
expr_stmt|;
name|init
operator|.
name|Function
operator|=
name|MPI_FUNCTION_IOC_INIT
expr_stmt|;
if|if
condition|(
name|mpt
operator|->
name|is_fc
condition|)
block|{
name|init
operator|.
name|MaxDevices
operator|=
literal|255
expr_stmt|;
block|}
else|else
block|{
name|init
operator|.
name|MaxDevices
operator|=
literal|16
expr_stmt|;
block|}
name|init
operator|.
name|MaxBuses
operator|=
literal|1
expr_stmt|;
name|init
operator|.
name|ReplyFrameSize
operator|=
name|MPT_REPLY_SIZE
expr_stmt|;
name|init
operator|.
name|MsgContext
operator|=
literal|0x12071941
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|mpt_send_handshake_cmd
argument_list|(
name|mpt
argument_list|,
sizeof|sizeof
name|init
argument_list|,
operator|&
name|init
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
return|return
operator|(
name|error
operator|)
return|;
block|}
name|error
operator|=
name|mpt_recv_handshake_reply
argument_list|(
name|mpt
argument_list|,
sizeof|sizeof
name|reply
argument_list|,
operator|&
name|reply
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Utiltity routine to read configuration headers and pages  */
end_comment

begin_function_decl
specifier|static
name|int
name|mpt_read_cfg_header
parameter_list|(
name|mpt_softc_t
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|,
name|CONFIG_PAGE_HEADER
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|int
name|mpt_read_cfg_header
parameter_list|(
name|mpt_softc_t
modifier|*
name|mpt
parameter_list|,
name|int
name|PageType
parameter_list|,
name|int
name|PageNumber
parameter_list|,
name|int
name|PageAddress
parameter_list|,
name|CONFIG_PAGE_HEADER
modifier|*
name|rslt
parameter_list|)
block|{
name|int
name|count
decl_stmt|;
name|request_t
modifier|*
name|req
decl_stmt|;
name|MSG_CONFIG
modifier|*
name|cfgp
decl_stmt|;
name|MSG_CONFIG_REPLY
modifier|*
name|reply
decl_stmt|;
name|req
operator|=
name|mpt_get_request
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
name|cfgp
operator|=
name|req
operator|->
name|req_vbuf
expr_stmt|;
name|bzero
argument_list|(
name|cfgp
argument_list|,
sizeof|sizeof
expr|*
name|cfgp
argument_list|)
expr_stmt|;
name|cfgp
operator|->
name|Action
operator|=
name|MPI_CONFIG_ACTION_PAGE_HEADER
expr_stmt|;
name|cfgp
operator|->
name|Function
operator|=
name|MPI_FUNCTION_CONFIG
expr_stmt|;
name|cfgp
operator|->
name|Header
operator|.
name|PageNumber
operator|=
operator|(
name|U8
operator|)
name|PageNumber
expr_stmt|;
name|cfgp
operator|->
name|Header
operator|.
name|PageType
operator|=
operator|(
name|U8
operator|)
name|PageType
expr_stmt|;
name|cfgp
operator|->
name|PageAddress
operator|=
name|PageAddress
expr_stmt|;
name|MPI_pSGE_SET_FLAGS
argument_list|(
operator|(
operator|(
name|SGE_SIMPLE32
operator|*
operator|)
operator|&
name|cfgp
operator|->
name|PageBufferSGE
operator|)
argument_list|,
operator|(
name|MPI_SGE_FLAGS_LAST_ELEMENT
operator||
name|MPI_SGE_FLAGS_END_OF_BUFFER
operator||
name|MPI_SGE_FLAGS_SIMPLE_ELEMENT
operator||
name|MPI_SGE_FLAGS_END_OF_LIST
operator|)
argument_list|)
expr_stmt|;
name|cfgp
operator|->
name|MsgContext
operator|=
name|req
operator|->
name|index
operator||
literal|0x80000000
expr_stmt|;
name|mpt_check_doorbell
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
name|mpt_send_cmd
argument_list|(
name|mpt
argument_list|,
name|req
argument_list|)
expr_stmt|;
name|count
operator|=
literal|0
expr_stmt|;
do|do
block|{
name|DELAY
argument_list|(
literal|500
argument_list|)
expr_stmt|;
name|mpt_intr
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
if|if
condition|(
operator|++
name|count
operator|==
literal|1000
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"read_cfg_header timed out"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
do|while
condition|(
name|req
operator|->
name|debug
operator|==
name|REQ_ON_CHIP
condition|)
do|;
name|reply
operator|=
operator|(
name|MSG_CONFIG_REPLY
operator|*
operator|)
name|MPT_REPLY_PTOV
argument_list|(
name|mpt
argument_list|,
name|req
operator|->
name|sequence
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|reply
operator|->
name|IOCStatus
operator|&
name|MPI_IOCSTATUS_MASK
operator|)
operator|!=
name|MPI_IOCSTATUS_SUCCESS
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"mpt_read_cfg_header: Config Info Status %x"
argument_list|,
name|reply
operator|->
name|IOCStatus
argument_list|)
expr_stmt|;
name|mpt_free_reply
argument_list|(
name|mpt
argument_list|,
operator|(
name|req
operator|->
name|sequence
operator|<<
literal|1
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|bcopy
argument_list|(
operator|&
name|reply
operator|->
name|Header
argument_list|,
name|rslt
argument_list|,
sizeof|sizeof
argument_list|(
name|CONFIG_PAGE_HEADER
argument_list|)
argument_list|)
expr_stmt|;
name|mpt_free_reply
argument_list|(
name|mpt
argument_list|,
operator|(
name|req
operator|->
name|sequence
operator|<<
literal|1
operator|)
argument_list|)
expr_stmt|;
name|mpt_free_request
argument_list|(
name|mpt
argument_list|,
name|req
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_define
define|#
directive|define
name|CFG_DATA_OFF
value|128
end_define

begin_function
name|int
name|mpt_read_cfg_page
parameter_list|(
name|mpt_softc_t
modifier|*
name|mpt
parameter_list|,
name|int
name|PageAddress
parameter_list|,
name|CONFIG_PAGE_HEADER
modifier|*
name|hdr
parameter_list|)
block|{
name|int
name|count
decl_stmt|;
name|request_t
modifier|*
name|req
decl_stmt|;
name|SGE_SIMPLE32
modifier|*
name|se
decl_stmt|;
name|MSG_CONFIG
modifier|*
name|cfgp
decl_stmt|;
name|size_t
name|amt
decl_stmt|;
name|MSG_CONFIG_REPLY
modifier|*
name|reply
decl_stmt|;
name|req
operator|=
name|mpt_get_request
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
name|cfgp
operator|=
name|req
operator|->
name|req_vbuf
expr_stmt|;
name|bzero
argument_list|(
name|cfgp
argument_list|,
name|MPT_REQUEST_AREA
argument_list|)
expr_stmt|;
name|cfgp
operator|->
name|Action
operator|=
name|MPI_CONFIG_ACTION_PAGE_READ_CURRENT
expr_stmt|;
name|cfgp
operator|->
name|Function
operator|=
name|MPI_FUNCTION_CONFIG
expr_stmt|;
name|cfgp
operator|->
name|Header
operator|=
operator|*
name|hdr
expr_stmt|;
name|amt
operator|=
operator|(
name|cfgp
operator|->
name|Header
operator|.
name|PageLength
operator|*
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
operator|)
expr_stmt|;
name|cfgp
operator|->
name|Header
operator|.
name|PageType
operator|&=
name|MPI_CONFIG_PAGETYPE_MASK
expr_stmt|;
name|cfgp
operator|->
name|PageAddress
operator|=
name|PageAddress
expr_stmt|;
name|se
operator|=
operator|(
name|SGE_SIMPLE32
operator|*
operator|)
operator|&
name|cfgp
operator|->
name|PageBufferSGE
expr_stmt|;
name|se
operator|->
name|Address
operator|=
name|req
operator|->
name|req_pbuf
operator|+
name|CFG_DATA_OFF
expr_stmt|;
name|MPI_pSGE_SET_LENGTH
argument_list|(
name|se
argument_list|,
name|amt
argument_list|)
expr_stmt|;
name|MPI_pSGE_SET_FLAGS
argument_list|(
name|se
argument_list|,
operator|(
name|MPI_SGE_FLAGS_SIMPLE_ELEMENT
operator||
name|MPI_SGE_FLAGS_LAST_ELEMENT
operator||
name|MPI_SGE_FLAGS_END_OF_BUFFER
operator||
name|MPI_SGE_FLAGS_END_OF_LIST
operator|)
argument_list|)
expr_stmt|;
name|cfgp
operator|->
name|MsgContext
operator|=
name|req
operator|->
name|index
operator||
literal|0x80000000
expr_stmt|;
name|mpt_check_doorbell
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
name|mpt_send_cmd
argument_list|(
name|mpt
argument_list|,
name|req
argument_list|)
expr_stmt|;
name|count
operator|=
literal|0
expr_stmt|;
do|do
block|{
name|DELAY
argument_list|(
literal|500
argument_list|)
expr_stmt|;
name|mpt_intr
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
if|if
condition|(
operator|++
name|count
operator|==
literal|1000
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"read_cfg_page timed out"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
do|while
condition|(
name|req
operator|->
name|debug
operator|==
name|REQ_ON_CHIP
condition|)
do|;
name|reply
operator|=
operator|(
name|MSG_CONFIG_REPLY
operator|*
operator|)
name|MPT_REPLY_PTOV
argument_list|(
name|mpt
argument_list|,
name|req
operator|->
name|sequence
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|reply
operator|->
name|IOCStatus
operator|&
name|MPI_IOCSTATUS_MASK
operator|)
operator|!=
name|MPI_IOCSTATUS_SUCCESS
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"mpt_read_cfg_page: Config Info Status %x"
argument_list|,
name|reply
operator|->
name|IOCStatus
argument_list|)
expr_stmt|;
name|mpt_free_reply
argument_list|(
name|mpt
argument_list|,
operator|(
name|req
operator|->
name|sequence
operator|<<
literal|1
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|mpt_free_reply
argument_list|(
name|mpt
argument_list|,
operator|(
name|req
operator|->
name|sequence
operator|<<
literal|1
operator|)
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|mpt
operator|->
name|request_dmat
argument_list|,
name|mpt
operator|->
name|request_dmap
argument_list|,
name|BUS_DMASYNC_POSTREAD
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfgp
operator|->
name|Header
operator|.
name|PageType
operator|==
name|MPI_CONFIG_PAGETYPE_SCSI_PORT
operator|&&
name|cfgp
operator|->
name|Header
operator|.
name|PageNumber
operator|==
literal|0
condition|)
block|{
name|amt
operator|=
sizeof|sizeof
argument_list|(
name|CONFIG_PAGE_SCSI_PORT_0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cfgp
operator|->
name|Header
operator|.
name|PageType
operator|==
name|MPI_CONFIG_PAGETYPE_SCSI_PORT
operator|&&
name|cfgp
operator|->
name|Header
operator|.
name|PageNumber
operator|==
literal|1
condition|)
block|{
name|amt
operator|=
sizeof|sizeof
argument_list|(
name|CONFIG_PAGE_SCSI_PORT_1
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cfgp
operator|->
name|Header
operator|.
name|PageType
operator|==
name|MPI_CONFIG_PAGETYPE_SCSI_PORT
operator|&&
name|cfgp
operator|->
name|Header
operator|.
name|PageNumber
operator|==
literal|2
condition|)
block|{
name|amt
operator|=
sizeof|sizeof
argument_list|(
name|CONFIG_PAGE_SCSI_PORT_2
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cfgp
operator|->
name|Header
operator|.
name|PageType
operator|==
name|MPI_CONFIG_PAGETYPE_SCSI_DEVICE
operator|&&
name|cfgp
operator|->
name|Header
operator|.
name|PageNumber
operator|==
literal|0
condition|)
block|{
name|amt
operator|=
sizeof|sizeof
argument_list|(
name|CONFIG_PAGE_SCSI_DEVICE_0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cfgp
operator|->
name|Header
operator|.
name|PageType
operator|==
name|MPI_CONFIG_PAGETYPE_SCSI_DEVICE
operator|&&
name|cfgp
operator|->
name|Header
operator|.
name|PageNumber
operator|==
literal|1
condition|)
block|{
name|amt
operator|=
sizeof|sizeof
argument_list|(
name|CONFIG_PAGE_SCSI_DEVICE_1
argument_list|)
expr_stmt|;
block|}
name|bcopy
argument_list|(
operator|(
operator|(
name|caddr_t
operator|)
name|req
operator|->
name|req_vbuf
operator|)
operator|+
name|CFG_DATA_OFF
argument_list|,
name|hdr
argument_list|,
name|amt
argument_list|)
expr_stmt|;
name|mpt_free_request
argument_list|(
name|mpt
argument_list|,
name|req
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|mpt_write_cfg_page
parameter_list|(
name|mpt_softc_t
modifier|*
name|mpt
parameter_list|,
name|int
name|PageAddress
parameter_list|,
name|CONFIG_PAGE_HEADER
modifier|*
name|hdr
parameter_list|)
block|{
name|int
name|count
decl_stmt|,
name|hdr_attr
decl_stmt|;
name|request_t
modifier|*
name|req
decl_stmt|;
name|SGE_SIMPLE32
modifier|*
name|se
decl_stmt|;
name|MSG_CONFIG
modifier|*
name|cfgp
decl_stmt|;
name|size_t
name|amt
decl_stmt|;
name|MSG_CONFIG_REPLY
modifier|*
name|reply
decl_stmt|;
name|req
operator|=
name|mpt_get_request
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
name|cfgp
operator|=
name|req
operator|->
name|req_vbuf
expr_stmt|;
name|bzero
argument_list|(
name|cfgp
argument_list|,
sizeof|sizeof
expr|*
name|cfgp
argument_list|)
expr_stmt|;
name|hdr_attr
operator|=
name|hdr
operator|->
name|PageType
operator|&
name|MPI_CONFIG_PAGEATTR_MASK
expr_stmt|;
if|if
condition|(
name|hdr_attr
operator|!=
name|MPI_CONFIG_PAGEATTR_CHANGEABLE
operator|&&
name|hdr_attr
operator|!=
name|MPI_CONFIG_PAGEATTR_PERSISTENT
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"page type 0x%x not changeable"
argument_list|,
name|hdr
operator|->
name|PageType
operator|&
name|MPI_CONFIG_PAGETYPE_MASK
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|hdr
operator|->
name|PageType
operator|&=
name|MPI_CONFIG_PAGETYPE_MASK
expr_stmt|;
name|cfgp
operator|->
name|Action
operator|=
name|MPI_CONFIG_ACTION_PAGE_WRITE_CURRENT
expr_stmt|;
name|cfgp
operator|->
name|Function
operator|=
name|MPI_FUNCTION_CONFIG
expr_stmt|;
name|cfgp
operator|->
name|Header
operator|=
operator|*
name|hdr
expr_stmt|;
name|amt
operator|=
operator|(
name|cfgp
operator|->
name|Header
operator|.
name|PageLength
operator|*
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
operator|)
expr_stmt|;
name|cfgp
operator|->
name|PageAddress
operator|=
name|PageAddress
expr_stmt|;
name|se
operator|=
operator|(
name|SGE_SIMPLE32
operator|*
operator|)
operator|&
name|cfgp
operator|->
name|PageBufferSGE
expr_stmt|;
name|se
operator|->
name|Address
operator|=
name|req
operator|->
name|req_pbuf
operator|+
name|CFG_DATA_OFF
expr_stmt|;
name|MPI_pSGE_SET_LENGTH
argument_list|(
name|se
argument_list|,
name|amt
argument_list|)
expr_stmt|;
name|MPI_pSGE_SET_FLAGS
argument_list|(
name|se
argument_list|,
operator|(
name|MPI_SGE_FLAGS_SIMPLE_ELEMENT
operator||
name|MPI_SGE_FLAGS_LAST_ELEMENT
operator||
name|MPI_SGE_FLAGS_END_OF_BUFFER
operator||
name|MPI_SGE_FLAGS_END_OF_LIST
operator||
name|MPI_SGE_FLAGS_HOST_TO_IOC
operator|)
argument_list|)
expr_stmt|;
name|cfgp
operator|->
name|MsgContext
operator|=
name|req
operator|->
name|index
operator||
literal|0x80000000
expr_stmt|;
if|if
condition|(
name|cfgp
operator|->
name|Header
operator|.
name|PageType
operator|==
name|MPI_CONFIG_PAGETYPE_SCSI_PORT
operator|&&
name|cfgp
operator|->
name|Header
operator|.
name|PageNumber
operator|==
literal|0
condition|)
block|{
name|amt
operator|=
sizeof|sizeof
argument_list|(
name|CONFIG_PAGE_SCSI_PORT_0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cfgp
operator|->
name|Header
operator|.
name|PageType
operator|==
name|MPI_CONFIG_PAGETYPE_SCSI_PORT
operator|&&
name|cfgp
operator|->
name|Header
operator|.
name|PageNumber
operator|==
literal|1
condition|)
block|{
name|amt
operator|=
sizeof|sizeof
argument_list|(
name|CONFIG_PAGE_SCSI_PORT_1
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cfgp
operator|->
name|Header
operator|.
name|PageType
operator|==
name|MPI_CONFIG_PAGETYPE_SCSI_PORT
operator|&&
name|cfgp
operator|->
name|Header
operator|.
name|PageNumber
operator|==
literal|2
condition|)
block|{
name|amt
operator|=
sizeof|sizeof
argument_list|(
name|CONFIG_PAGE_SCSI_PORT_2
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cfgp
operator|->
name|Header
operator|.
name|PageType
operator|==
name|MPI_CONFIG_PAGETYPE_SCSI_DEVICE
operator|&&
name|cfgp
operator|->
name|Header
operator|.
name|PageNumber
operator|==
literal|0
condition|)
block|{
name|amt
operator|=
sizeof|sizeof
argument_list|(
name|CONFIG_PAGE_SCSI_DEVICE_0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cfgp
operator|->
name|Header
operator|.
name|PageType
operator|==
name|MPI_CONFIG_PAGETYPE_SCSI_DEVICE
operator|&&
name|cfgp
operator|->
name|Header
operator|.
name|PageNumber
operator|==
literal|1
condition|)
block|{
name|amt
operator|=
sizeof|sizeof
argument_list|(
name|CONFIG_PAGE_SCSI_DEVICE_1
argument_list|)
expr_stmt|;
block|}
name|bcopy
argument_list|(
name|hdr
argument_list|,
operator|(
operator|(
name|caddr_t
operator|)
name|req
operator|->
name|req_vbuf
operator|)
operator|+
name|CFG_DATA_OFF
argument_list|,
name|amt
argument_list|)
expr_stmt|;
comment|/* Restore stripped out attributes */
name|hdr
operator|->
name|PageType
operator||=
name|hdr_attr
expr_stmt|;
name|mpt_check_doorbell
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
name|mpt_send_cmd
argument_list|(
name|mpt
argument_list|,
name|req
argument_list|)
expr_stmt|;
name|count
operator|=
literal|0
expr_stmt|;
do|do
block|{
name|DELAY
argument_list|(
literal|500
argument_list|)
expr_stmt|;
name|mpt_intr
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
if|if
condition|(
operator|++
name|count
operator|==
literal|1000
condition|)
block|{
name|hdr
operator|->
name|PageType
operator||=
name|hdr_attr
expr_stmt|;
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"mpt_write_cfg_page timed out"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
do|while
condition|(
name|req
operator|->
name|debug
operator|==
name|REQ_ON_CHIP
condition|)
do|;
name|reply
operator|=
operator|(
name|MSG_CONFIG_REPLY
operator|*
operator|)
name|MPT_REPLY_PTOV
argument_list|(
name|mpt
argument_list|,
name|req
operator|->
name|sequence
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|reply
operator|->
name|IOCStatus
operator|&
name|MPI_IOCSTATUS_MASK
operator|)
operator|!=
name|MPI_IOCSTATUS_SUCCESS
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"mpt_write_cfg_page: Config Info Status %x"
argument_list|,
name|reply
operator|->
name|IOCStatus
argument_list|)
expr_stmt|;
name|mpt_free_reply
argument_list|(
name|mpt
argument_list|,
operator|(
name|req
operator|->
name|sequence
operator|<<
literal|1
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|mpt_free_reply
argument_list|(
name|mpt
argument_list|,
operator|(
name|req
operator|->
name|sequence
operator|<<
literal|1
operator|)
argument_list|)
expr_stmt|;
name|mpt_free_request
argument_list|(
name|mpt
argument_list|,
name|req
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Read SCSI configuration information  */
end_comment

begin_function
specifier|static
name|int
name|mpt_read_config_info_spi
parameter_list|(
name|mpt_softc_t
modifier|*
name|mpt
parameter_list|)
block|{
name|int
name|rv
decl_stmt|,
name|i
decl_stmt|;
name|rv
operator|=
name|mpt_read_cfg_header
argument_list|(
name|mpt
argument_list|,
name|MPI_CONFIG_PAGETYPE_SCSI_PORT
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|mpt
operator|->
name|mpt_port_page0
operator|.
name|Header
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
condition|)
block|{
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|mpt
operator|->
name|verbose
operator|>
literal|1
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"SPI Port Page 0 Header: %x %x %x %x"
argument_list|,
name|mpt
operator|->
name|mpt_port_page0
operator|.
name|Header
operator|.
name|PageVersion
argument_list|,
name|mpt
operator|->
name|mpt_port_page0
operator|.
name|Header
operator|.
name|PageLength
argument_list|,
name|mpt
operator|->
name|mpt_port_page0
operator|.
name|Header
operator|.
name|PageNumber
argument_list|,
name|mpt
operator|->
name|mpt_port_page0
operator|.
name|Header
operator|.
name|PageType
argument_list|)
expr_stmt|;
block|}
name|rv
operator|=
name|mpt_read_cfg_header
argument_list|(
name|mpt
argument_list|,
name|MPI_CONFIG_PAGETYPE_SCSI_PORT
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
operator|&
name|mpt
operator|->
name|mpt_port_page1
operator|.
name|Header
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
condition|)
block|{
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|mpt
operator|->
name|verbose
operator|>
literal|1
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"SPI Port Page 1 Header: %x %x %x %x"
argument_list|,
name|mpt
operator|->
name|mpt_port_page1
operator|.
name|Header
operator|.
name|PageVersion
argument_list|,
name|mpt
operator|->
name|mpt_port_page1
operator|.
name|Header
operator|.
name|PageLength
argument_list|,
name|mpt
operator|->
name|mpt_port_page1
operator|.
name|Header
operator|.
name|PageNumber
argument_list|,
name|mpt
operator|->
name|mpt_port_page1
operator|.
name|Header
operator|.
name|PageType
argument_list|)
expr_stmt|;
block|}
name|rv
operator|=
name|mpt_read_cfg_header
argument_list|(
name|mpt
argument_list|,
name|MPI_CONFIG_PAGETYPE_SCSI_PORT
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|,
operator|&
name|mpt
operator|->
name|mpt_port_page2
operator|.
name|Header
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
condition|)
block|{
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|mpt
operator|->
name|verbose
operator|>
literal|1
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"SPI Port Page 2 Header: %x %x %x %x"
argument_list|,
name|mpt
operator|->
name|mpt_port_page1
operator|.
name|Header
operator|.
name|PageVersion
argument_list|,
name|mpt
operator|->
name|mpt_port_page1
operator|.
name|Header
operator|.
name|PageLength
argument_list|,
name|mpt
operator|->
name|mpt_port_page1
operator|.
name|Header
operator|.
name|PageNumber
argument_list|,
name|mpt
operator|->
name|mpt_port_page1
operator|.
name|Header
operator|.
name|PageType
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
block|{
name|rv
operator|=
name|mpt_read_cfg_header
argument_list|(
name|mpt
argument_list|,
name|MPI_CONFIG_PAGETYPE_SCSI_DEVICE
argument_list|,
literal|0
argument_list|,
name|i
argument_list|,
operator|&
name|mpt
operator|->
name|mpt_dev_page0
index|[
name|i
index|]
operator|.
name|Header
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
condition|)
block|{
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|mpt
operator|->
name|verbose
operator|>
literal|1
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"SPI Target %d Device Page 0 Header: %x %x %x %x"
argument_list|,
name|i
argument_list|,
name|mpt
operator|->
name|mpt_dev_page0
index|[
name|i
index|]
operator|.
name|Header
operator|.
name|PageVersion
argument_list|,
name|mpt
operator|->
name|mpt_dev_page0
index|[
name|i
index|]
operator|.
name|Header
operator|.
name|PageLength
argument_list|,
name|mpt
operator|->
name|mpt_dev_page0
index|[
name|i
index|]
operator|.
name|Header
operator|.
name|PageNumber
argument_list|,
name|mpt
operator|->
name|mpt_dev_page0
index|[
name|i
index|]
operator|.
name|Header
operator|.
name|PageType
argument_list|)
expr_stmt|;
block|}
name|rv
operator|=
name|mpt_read_cfg_header
argument_list|(
name|mpt
argument_list|,
name|MPI_CONFIG_PAGETYPE_SCSI_DEVICE
argument_list|,
literal|1
argument_list|,
name|i
argument_list|,
operator|&
name|mpt
operator|->
name|mpt_dev_page1
index|[
name|i
index|]
operator|.
name|Header
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
condition|)
block|{
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|mpt
operator|->
name|verbose
operator|>
literal|1
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"SPI Target %d Device Page 1 Header: %x %x %x %x"
argument_list|,
name|i
argument_list|,
name|mpt
operator|->
name|mpt_dev_page1
index|[
name|i
index|]
operator|.
name|Header
operator|.
name|PageVersion
argument_list|,
name|mpt
operator|->
name|mpt_dev_page1
index|[
name|i
index|]
operator|.
name|Header
operator|.
name|PageLength
argument_list|,
name|mpt
operator|->
name|mpt_dev_page1
index|[
name|i
index|]
operator|.
name|Header
operator|.
name|PageNumber
argument_list|,
name|mpt
operator|->
name|mpt_dev_page1
index|[
name|i
index|]
operator|.
name|Header
operator|.
name|PageType
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* 	 * At this point, we don't *have* to fail. As long as we have 	 * valid config header information, we can (barely) lurch 	 * along. 	 */
name|rv
operator|=
name|mpt_read_cfg_page
argument_list|(
name|mpt
argument_list|,
literal|0
argument_list|,
operator|&
name|mpt
operator|->
name|mpt_port_page0
operator|.
name|Header
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"failed to read SPI Port Page 0"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|mpt
operator|->
name|verbose
operator|>
literal|1
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"SPI Port Page 0: Capabilities %x PhysicalInterface %x"
argument_list|,
name|mpt
operator|->
name|mpt_port_page0
operator|.
name|Capabilities
argument_list|,
name|mpt
operator|->
name|mpt_port_page0
operator|.
name|PhysicalInterface
argument_list|)
expr_stmt|;
block|}
name|rv
operator|=
name|mpt_read_cfg_page
argument_list|(
name|mpt
argument_list|,
literal|0
argument_list|,
operator|&
name|mpt
operator|->
name|mpt_port_page1
operator|.
name|Header
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"failed to read SPI Port Page 1"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|mpt
operator|->
name|verbose
operator|>
literal|1
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"SPI Port Page 1: Configuration %x OnBusTimerValue %x"
argument_list|,
name|mpt
operator|->
name|mpt_port_page1
operator|.
name|Configuration
argument_list|,
name|mpt
operator|->
name|mpt_port_page1
operator|.
name|OnBusTimerValue
argument_list|)
expr_stmt|;
block|}
name|rv
operator|=
name|mpt_read_cfg_page
argument_list|(
name|mpt
argument_list|,
literal|0
argument_list|,
operator|&
name|mpt
operator|->
name|mpt_port_page2
operator|.
name|Header
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"failed to read SPI Port Page 2"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|mpt
operator|->
name|verbose
operator|>
literal|1
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"SPI Port Page 2: Flags %x Settings %x"
argument_list|,
name|mpt
operator|->
name|mpt_port_page2
operator|.
name|PortFlags
argument_list|,
name|mpt
operator|->
name|mpt_port_page2
operator|.
name|PortSettings
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"SPI Port Page 2 Tgt %d: timo %x SF %x Flags %x"
argument_list|,
name|i
argument_list|,
name|mpt
operator|->
name|mpt_port_page2
operator|.
name|DeviceSettings
index|[
name|i
index|]
operator|.
name|Timeout
argument_list|,
name|mpt
operator|->
name|mpt_port_page2
operator|.
name|DeviceSettings
index|[
name|i
index|]
operator|.
name|SyncFactor
argument_list|,
name|mpt
operator|->
name|mpt_port_page2
operator|.
name|DeviceSettings
index|[
name|i
index|]
operator|.
name|DeviceFlags
argument_list|)
expr_stmt|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
block|{
name|rv
operator|=
name|mpt_read_cfg_page
argument_list|(
name|mpt
argument_list|,
name|i
argument_list|,
operator|&
name|mpt
operator|->
name|mpt_dev_page0
index|[
name|i
index|]
operator|.
name|Header
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"cannot read SPI Tgt %d Device Page 0"
argument_list|,
name|i
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|mpt
operator|->
name|verbose
operator|>
literal|1
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"SPI Tgt %d Page 0: NParms %x Information %x"
argument_list|,
name|i
argument_list|,
name|mpt
operator|->
name|mpt_dev_page0
index|[
name|i
index|]
operator|.
name|NegotiatedParameters
argument_list|,
name|mpt
operator|->
name|mpt_dev_page0
index|[
name|i
index|]
operator|.
name|Information
argument_list|)
expr_stmt|;
block|}
name|rv
operator|=
name|mpt_read_cfg_page
argument_list|(
name|mpt
argument_list|,
name|i
argument_list|,
operator|&
name|mpt
operator|->
name|mpt_dev_page1
index|[
name|i
index|]
operator|.
name|Header
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"cannot read SPI Tgt %d Device Page 1"
argument_list|,
name|i
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|mpt
operator|->
name|verbose
operator|>
literal|1
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"SPI Tgt %d Page 1: RParms %x Configuration %x"
argument_list|,
name|i
argument_list|,
name|mpt
operator|->
name|mpt_dev_page1
index|[
name|i
index|]
operator|.
name|RequestedParameters
argument_list|,
name|mpt
operator|->
name|mpt_dev_page1
index|[
name|i
index|]
operator|.
name|Configuration
argument_list|)
expr_stmt|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Validate SPI configuration information.  *  * In particular, validate SPI Port Page 1.  */
end_comment

begin_function
specifier|static
name|int
name|mpt_set_initial_config_spi
parameter_list|(
name|mpt_softc_t
modifier|*
name|mpt
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|pp1val
init|=
operator|(
operator|(
literal|1
operator|<<
name|mpt
operator|->
name|mpt_ini_id
operator|)
operator|<<
literal|16
operator|)
operator||
name|mpt
operator|->
name|mpt_ini_id
decl_stmt|;
name|mpt
operator|->
name|mpt_disc_enable
operator|=
literal|0xff
expr_stmt|;
name|mpt
operator|->
name|mpt_tag_enable
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|mpt
operator|->
name|mpt_port_page1
operator|.
name|Configuration
operator|!=
name|pp1val
condition|)
block|{
name|CONFIG_PAGE_SCSI_PORT_1
name|tmp
decl_stmt|;
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"SPI Port Page 1 Config value bad (%x)- should be %x"
argument_list|,
name|mpt
operator|->
name|mpt_port_page1
operator|.
name|Configuration
argument_list|,
name|pp1val
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|mpt
operator|->
name|mpt_port_page1
expr_stmt|;
name|tmp
operator|.
name|Configuration
operator|=
name|pp1val
expr_stmt|;
if|if
condition|(
name|mpt_write_cfg_page
argument_list|(
name|mpt
argument_list|,
literal|0
argument_list|,
operator|&
name|tmp
operator|.
name|Header
argument_list|)
condition|)
block|{
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|mpt_read_cfg_page
argument_list|(
name|mpt
argument_list|,
literal|0
argument_list|,
operator|&
name|tmp
operator|.
name|Header
argument_list|)
condition|)
block|{
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|tmp
operator|.
name|Configuration
operator|!=
name|pp1val
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"failed to reset SPI Port Page 1 Config value"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|mpt
operator|->
name|mpt_port_page1
operator|=
name|tmp
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
block|{
name|CONFIG_PAGE_SCSI_DEVICE_1
name|tmp
decl_stmt|;
name|tmp
operator|=
name|mpt
operator|->
name|mpt_dev_page1
index|[
name|i
index|]
expr_stmt|;
name|tmp
operator|.
name|RequestedParameters
operator|=
literal|0
expr_stmt|;
name|tmp
operator|.
name|Configuration
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|mpt
operator|->
name|verbose
operator|>
literal|1
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"Set Tgt %d SPI DevicePage 1 values to %x 0 %x"
argument_list|,
name|i
argument_list|,
name|tmp
operator|.
name|RequestedParameters
argument_list|,
name|tmp
operator|.
name|Configuration
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mpt_write_cfg_page
argument_list|(
name|mpt
argument_list|,
name|i
argument_list|,
operator|&
name|tmp
operator|.
name|Header
argument_list|)
condition|)
block|{
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|mpt_read_cfg_page
argument_list|(
name|mpt
argument_list|,
name|i
argument_list|,
operator|&
name|tmp
operator|.
name|Header
argument_list|)
condition|)
block|{
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|mpt
operator|->
name|mpt_dev_page1
index|[
name|i
index|]
operator|=
name|tmp
expr_stmt|;
if|if
condition|(
name|mpt
operator|->
name|verbose
operator|>
literal|1
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"SPI Tgt %d Page 1: RParm %x Configuration %x"
argument_list|,
name|i
argument_list|,
name|mpt
operator|->
name|mpt_dev_page1
index|[
name|i
index|]
operator|.
name|RequestedParameters
argument_list|,
name|mpt
operator|->
name|mpt_dev_page1
index|[
name|i
index|]
operator|.
name|Configuration
argument_list|)
expr_stmt|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Enable IOC port  */
end_comment

begin_function
specifier|static
name|int
name|mpt_send_port_enable
parameter_list|(
name|mpt_softc_t
modifier|*
name|mpt
parameter_list|,
name|int
name|port
parameter_list|)
block|{
name|int
name|count
decl_stmt|;
name|request_t
modifier|*
name|req
decl_stmt|;
name|MSG_PORT_ENABLE
modifier|*
name|enable_req
decl_stmt|;
name|req
operator|=
name|mpt_get_request
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
name|enable_req
operator|=
name|req
operator|->
name|req_vbuf
expr_stmt|;
name|bzero
argument_list|(
name|enable_req
argument_list|,
sizeof|sizeof
expr|*
name|enable_req
argument_list|)
expr_stmt|;
name|enable_req
operator|->
name|Function
operator|=
name|MPI_FUNCTION_PORT_ENABLE
expr_stmt|;
name|enable_req
operator|->
name|MsgContext
operator|=
name|req
operator|->
name|index
operator||
literal|0x80000000
expr_stmt|;
name|enable_req
operator|->
name|PortNumber
operator|=
name|port
expr_stmt|;
name|mpt_check_doorbell
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
if|if
condition|(
name|mpt
operator|->
name|verbose
operator|>
literal|1
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"enabling port %d"
argument_list|,
name|port
argument_list|)
expr_stmt|;
block|}
name|mpt_send_cmd
argument_list|(
name|mpt
argument_list|,
name|req
argument_list|)
expr_stmt|;
name|count
operator|=
literal|0
expr_stmt|;
do|do
block|{
name|DELAY
argument_list|(
literal|500
argument_list|)
expr_stmt|;
name|mpt_intr
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
if|if
condition|(
operator|++
name|count
operator|==
literal|100000
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"port enable timed out"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
do|while
condition|(
name|req
operator|->
name|debug
operator|==
name|REQ_ON_CHIP
condition|)
do|;
name|mpt_free_request
argument_list|(
name|mpt
argument_list|,
name|req
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Enable/Disable asynchronous event reporting.  *  * NB: this is the first command we send via shared memory  * instead of the handshake register.  */
end_comment

begin_function
specifier|static
name|int
name|mpt_send_event_request
parameter_list|(
name|mpt_softc_t
modifier|*
name|mpt
parameter_list|,
name|int
name|onoff
parameter_list|)
block|{
name|request_t
modifier|*
name|req
decl_stmt|;
name|MSG_EVENT_NOTIFY
modifier|*
name|enable_req
decl_stmt|;
name|req
operator|=
name|mpt_get_request
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
name|enable_req
operator|=
name|req
operator|->
name|req_vbuf
expr_stmt|;
name|bzero
argument_list|(
name|enable_req
argument_list|,
sizeof|sizeof
expr|*
name|enable_req
argument_list|)
expr_stmt|;
name|enable_req
operator|->
name|Function
operator|=
name|MPI_FUNCTION_EVENT_NOTIFICATION
expr_stmt|;
name|enable_req
operator|->
name|MsgContext
operator|=
name|req
operator|->
name|index
operator||
literal|0x80000000
expr_stmt|;
name|enable_req
operator|->
name|Switch
operator|=
name|onoff
expr_stmt|;
name|mpt_check_doorbell
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
if|if
condition|(
name|mpt
operator|->
name|verbose
operator|>
literal|1
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"%sabling async events"
argument_list|,
name|onoff
condition|?
literal|"en"
else|:
literal|"dis"
argument_list|)
expr_stmt|;
block|}
name|mpt_send_cmd
argument_list|(
name|mpt
argument_list|,
name|req
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Un-mask the interupts on the chip.  */
end_comment

begin_function
name|void
name|mpt_enable_ints
parameter_list|(
name|mpt_softc_t
modifier|*
name|mpt
parameter_list|)
block|{
comment|/* Unmask every thing except door bell int */
name|mpt_write
argument_list|(
name|mpt
argument_list|,
name|MPT_OFFSET_INTR_MASK
argument_list|,
name|MPT_INTR_DB_MASK
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Mask the interupts on the chip.  */
end_comment

begin_function
name|void
name|mpt_disable_ints
parameter_list|(
name|mpt_softc_t
modifier|*
name|mpt
parameter_list|)
block|{
comment|/* Mask all interrupts */
name|mpt_write
argument_list|(
name|mpt
argument_list|,
name|MPT_OFFSET_INTR_MASK
argument_list|,
name|MPT_INTR_REPLY_MASK
operator||
name|MPT_INTR_DB_MASK
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* (Re)Initialize the chip for use */
end_comment

begin_function
name|int
name|mpt_init
parameter_list|(
name|mpt_softc_t
modifier|*
name|mpt
parameter_list|,
name|u_int32_t
name|who
parameter_list|)
block|{
name|int
name|try
decl_stmt|;
name|MSG_IOC_FACTS_REPLY
name|facts
decl_stmt|;
name|MSG_PORT_FACTS_REPLY
name|pfp
decl_stmt|;
name|u_int32_t
name|pptr
decl_stmt|;
name|int
name|val
decl_stmt|;
comment|/* Put all request buffers (back) on the free list */
name|SLIST_INIT
argument_list|(
operator|&
name|mpt
operator|->
name|request_free_list
argument_list|)
expr_stmt|;
for|for
control|(
name|val
operator|=
literal|0
init|;
name|val
operator|<
name|MPT_MAX_REQUESTS
argument_list|(
name|mpt
argument_list|)
condition|;
name|val
operator|++
control|)
block|{
name|mpt_free_request
argument_list|(
name|mpt
argument_list|,
operator|&
name|mpt
operator|->
name|request_pool
index|[
name|val
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mpt
operator|->
name|verbose
operator|>
literal|1
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"doorbell req = %s"
argument_list|,
name|mpt_ioc_diag
argument_list|(
name|mpt_read
argument_list|(
name|mpt
argument_list|,
name|MPT_OFFSET_DOORBELL
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Start by making sure we're not at FAULT or RESET state 	 */
switch|switch
condition|(
name|mpt_rd_db
argument_list|(
name|mpt
argument_list|)
operator|&
name|MPT_DB_STATE_MASK
condition|)
block|{
case|case
name|MPT_DB_STATE_RESET
case|:
case|case
name|MPT_DB_STATE_FAULT
case|:
if|if
condition|(
name|mpt_reset
argument_list|(
name|mpt
argument_list|)
operator|!=
name|MPT_OK
condition|)
block|{
return|return
operator|(
name|EIO
operator|)
return|;
block|}
default|default:
break|break;
block|}
for|for
control|(
name|try
operator|=
literal|0
init|;
name|try
operator|<
name|MPT_MAX_TRYS
condition|;
name|try
operator|++
control|)
block|{
comment|/* 		 * No need to reset if the IOC is already in the READY state. 		 * 		 * Force reset if initialization failed previously. 		 * Note that a hard_reset of the second channel of a '929 		 * will stop operation of the first channel.  Hopefully, if the 		 * first channel is ok, the second will not require a hard  		 * reset. 		 */
if|if
condition|(
operator|(
name|mpt_rd_db
argument_list|(
name|mpt
argument_list|)
operator|&
name|MPT_DB_STATE_MASK
operator|)
operator|!=
name|MPT_DB_STATE_READY
condition|)
block|{
if|if
condition|(
name|mpt_reset
argument_list|(
name|mpt
argument_list|)
operator|!=
name|MPT_OK
condition|)
block|{
name|DELAY
argument_list|(
literal|10000
argument_list|)
expr_stmt|;
continue|continue;
block|}
block|}
if|if
condition|(
name|mpt_get_iocfacts
argument_list|(
name|mpt
argument_list|,
operator|&
name|facts
argument_list|)
operator|!=
name|MPT_OK
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"mpt_get_iocfacts failed"
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|mpt
operator|->
name|verbose
operator|>
literal|1
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"IOCFACTS: GlobalCredits=%d BlockSize=%u "
literal|"Request Frame Size %u\n"
argument_list|,
name|facts
operator|.
name|GlobalCredits
argument_list|,
name|facts
operator|.
name|BlockSize
argument_list|,
name|facts
operator|.
name|RequestFrameSize
argument_list|)
expr_stmt|;
block|}
name|mpt
operator|->
name|mpt_global_credits
operator|=
name|facts
operator|.
name|GlobalCredits
expr_stmt|;
name|mpt
operator|->
name|request_frame_size
operator|=
name|facts
operator|.
name|RequestFrameSize
expr_stmt|;
if|if
condition|(
name|mpt_get_portfacts
argument_list|(
name|mpt
argument_list|,
operator|&
name|pfp
argument_list|)
operator|!=
name|MPT_OK
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"mpt_get_portfacts failed"
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|mpt
operator|->
name|verbose
operator|>
literal|1
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"PORTFACTS: Type %x PFlags %x IID %d MaxDev %d\n"
argument_list|,
name|pfp
operator|.
name|PortType
argument_list|,
name|pfp
operator|.
name|ProtocolFlags
argument_list|,
name|pfp
operator|.
name|PortSCSIID
argument_list|,
name|pfp
operator|.
name|MaxDevices
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pfp
operator|.
name|PortType
operator|!=
name|MPI_PORTFACTS_PORTTYPE_SCSI
operator|&&
name|pfp
operator|.
name|PortType
operator|!=
name|MPI_PORTFACTS_PORTTYPE_FC
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"Unsupported Port Type (%x)"
argument_list|,
name|pfp
operator|.
name|PortType
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
if|if
condition|(
operator|!
operator|(
name|pfp
operator|.
name|ProtocolFlags
operator|&
name|MPI_PORTFACTS_PROTOCOL_INITIATOR
operator|)
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"initiator role unsupported"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
if|if
condition|(
name|pfp
operator|.
name|PortType
operator|==
name|MPI_PORTFACTS_PORTTYPE_FC
condition|)
block|{
name|mpt
operator|->
name|is_fc
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|mpt
operator|->
name|is_fc
operator|=
literal|0
expr_stmt|;
block|}
name|mpt
operator|->
name|mpt_ini_id
operator|=
name|pfp
operator|.
name|PortSCSIID
expr_stmt|;
if|if
condition|(
name|mpt_send_ioc_init
argument_list|(
name|mpt
argument_list|,
name|who
argument_list|)
operator|!=
name|MPT_OK
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"mpt_send_ioc_init failed"
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|mpt
operator|->
name|verbose
operator|>
literal|1
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"mpt_send_ioc_init ok"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mpt_wait_state
argument_list|(
name|mpt
argument_list|,
name|MPT_DB_STATE_RUNNING
argument_list|)
operator|!=
name|MPT_OK
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"IOC failed to go to run state"
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|mpt
operator|->
name|verbose
operator|>
literal|1
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"IOC now at RUNSTATE"
argument_list|)
expr_stmt|;
block|}
comment|/* 		 * Give it reply buffers 		 * 		 * Do *not* except global credits. 		 */
for|for
control|(
name|val
operator|=
literal|0
operator|,
name|pptr
operator|=
name|mpt
operator|->
name|reply_phys
init|;
operator|(
name|pptr
operator|+
name|MPT_REPLY_SIZE
operator|)
operator|<
operator|(
name|mpt
operator|->
name|reply_phys
operator|+
name|PAGE_SIZE
operator|)
condition|;
name|pptr
operator|+=
name|MPT_REPLY_SIZE
control|)
block|{
name|mpt_free_reply
argument_list|(
name|mpt
argument_list|,
name|pptr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|++
name|val
operator|==
name|mpt
operator|->
name|mpt_global_credits
operator|-
literal|1
condition|)
break|break;
block|}
comment|/* 		 * Enable asynchronous event reporting 		 */
name|mpt_send_event_request
argument_list|(
name|mpt
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* 		 * Read set up initial configuration information 		 * (SPI only for now) 		 */
if|if
condition|(
name|mpt
operator|->
name|is_fc
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|mpt_read_config_info_spi
argument_list|(
name|mpt
argument_list|)
condition|)
block|{
return|return
operator|(
name|EIO
operator|)
return|;
block|}
if|if
condition|(
name|mpt_set_initial_config_spi
argument_list|(
name|mpt
argument_list|)
condition|)
block|{
return|return
operator|(
name|EIO
operator|)
return|;
block|}
block|}
comment|/* 		 * Now enable the port 		 */
if|if
condition|(
name|mpt_send_port_enable
argument_list|(
name|mpt
argument_list|,
literal|0
argument_list|)
operator|!=
name|MPT_OK
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"failed to enable port 0"
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|mpt
operator|->
name|verbose
operator|>
literal|1
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"enabled port 0"
argument_list|)
expr_stmt|;
block|}
comment|/* Everything worked */
break|break;
block|}
if|if
condition|(
name|try
operator|>=
name|MPT_MAX_TRYS
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"failed to initialize IOC"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EIO
operator|)
return|;
block|}
if|if
condition|(
name|mpt
operator|->
name|verbose
operator|>
literal|1
condition|)
block|{
name|mpt_prt
argument_list|(
name|mpt
argument_list|,
literal|"enabling interrupts"
argument_list|)
expr_stmt|;
block|}
name|mpt_enable_ints
argument_list|(
name|mpt
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2017 Ian Lepore<ian@freebsd.org>  * All rights reserved.  *  * Development sponsored by Microsemi, Inc.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*  * Utility functions for PHY drivers on systems configured using FDT data.  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_media.h>
end_include

begin_include
include|#
directive|include
file|<dev/ofw/openfirm.h>
end_include

begin_include
include|#
directive|include
file|<dev/ofw/ofw_bus.h>
end_include

begin_include
include|#
directive|include
file|<dev/ofw/ofw_bus_subr.h>
end_include

begin_include
include|#
directive|include
file|<dev/mii/mii.h>
end_include

begin_include
include|#
directive|include
file|<dev/mii/miivar.h>
end_include

begin_include
include|#
directive|include
file|<dev/mii/mii_fdt.h>
end_include

begin_comment
comment|/*  * Table to translate MII_CONTYPE_xxxx constants to/from devicetree strings.  * We explicitly associate the enum values with the strings in a table to avoid  * relying on this list being sorted in the same order as the enum in miivar.h,  * and to avoid problems if the enum gains new types that aren't in the FDT  * data.  However, the "unknown" entry must be first because it is referenced  * using subscript 0 in mii_fdt_contype_to_name().  */
end_comment

begin_struct
specifier|static
struct|struct
name|contype_names
block|{
name|mii_contype_t
name|type
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
block|}
name|fdt_contype_names
index|[]
init|=
block|{
block|{
name|MII_CONTYPE_UNKNOWN
block|,
literal|"unknown"
block|}
block|,
block|{
name|MII_CONTYPE_MII
block|,
literal|"mii"
block|}
block|,
block|{
name|MII_CONTYPE_GMII
block|,
literal|"gmii"
block|}
block|,
block|{
name|MII_CONTYPE_SGMII
block|,
literal|"sgmii"
block|}
block|,
block|{
name|MII_CONTYPE_QSGMII
block|,
literal|"qsgmii"
block|}
block|,
block|{
name|MII_CONTYPE_TBI
block|,
literal|"tbi"
block|}
block|,
block|{
name|MII_CONTYPE_REVMII
block|,
literal|"rev-mii"
block|}
block|,
block|{
name|MII_CONTYPE_RMII
block|,
literal|"rmii"
block|}
block|,
block|{
name|MII_CONTYPE_RGMII
block|,
literal|"rgmii"
block|}
block|,
block|{
name|MII_CONTYPE_RGMII_ID
block|,
literal|"rgmii-id"
block|}
block|,
block|{
name|MII_CONTYPE_RGMII_RXID
block|,
literal|"rgmii-rxid"
block|}
block|,
block|{
name|MII_CONTYPE_RGMII_TXID
block|,
literal|"rgmii-txid"
block|}
block|,
block|{
name|MII_CONTYPE_RTBI
block|,
literal|"rtbi"
block|}
block|,
block|{
name|MII_CONTYPE_SMII
block|,
literal|"smii"
block|}
block|,
block|{
name|MII_CONTYPE_XGMII
block|,
literal|"xgmii"
block|}
block|,
block|{
name|MII_CONTYPE_TRGMII
block|,
literal|"trgmii"
block|}
block|,
block|{
name|MII_CONTYPE_2000BX
block|,
literal|"2000base-x"
block|}
block|,
block|{
name|MII_CONTYPE_2500BX
block|,
literal|"2500base-x"
block|}
block|,
block|{
name|MII_CONTYPE_RXAUI
block|,
literal|"rxaui"
block|}
block|, }
struct|;
end_struct

begin_function
specifier|static
name|phandle_t
name|mii_fdt_get_phynode
parameter_list|(
name|phandle_t
name|macnode
parameter_list|)
block|{
specifier|static
specifier|const
name|char
modifier|*
name|props
index|[]
init|=
block|{
literal|"phy-handle"
block|,
literal|"phy"
block|,
literal|"phy-device"
block|}
decl_stmt|;
name|pcell_t
name|xref
decl_stmt|;
name|u_int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nitems
argument_list|(
name|props
argument_list|)
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|OF_getencprop
argument_list|(
name|macnode
argument_list|,
name|props
index|[
name|i
index|]
argument_list|,
operator|&
name|xref
argument_list|,
sizeof|sizeof
argument_list|(
name|xref
argument_list|)
argument_list|)
operator|>
literal|0
condition|)
return|return
operator|(
name|OF_node_from_xref
argument_list|(
name|xref
argument_list|)
operator|)
return|;
block|}
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_function

begin_function
name|mii_contype_t
name|mii_fdt_contype_from_name
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
name|u_int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nitems
argument_list|(
name|fdt_contype_names
argument_list|)
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
name|fdt_contype_names
index|[
name|i
index|]
operator|.
name|name
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|fdt_contype_names
index|[
name|i
index|]
operator|.
name|type
operator|)
return|;
block|}
return|return
operator|(
name|MII_CONTYPE_UNKNOWN
operator|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|mii_fdt_contype_to_name
parameter_list|(
name|mii_contype_t
name|contype
parameter_list|)
block|{
name|u_int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nitems
argument_list|(
name|fdt_contype_names
argument_list|)
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|contype
operator|==
name|fdt_contype_names
index|[
name|i
index|]
operator|.
name|type
condition|)
return|return
operator|(
name|fdt_contype_names
index|[
name|i
index|]
operator|.
name|name
operator|)
return|;
block|}
return|return
operator|(
name|fdt_contype_names
index|[
literal|0
index|]
operator|.
name|name
operator|)
return|;
block|}
end_function

begin_function
name|mii_contype_t
name|mii_fdt_get_contype
parameter_list|(
name|phandle_t
name|macnode
parameter_list|)
block|{
name|char
name|val
index|[
literal|32
index|]
decl_stmt|;
if|if
condition|(
name|OF_getprop
argument_list|(
name|macnode
argument_list|,
literal|"phy-mode"
argument_list|,
name|val
argument_list|,
sizeof|sizeof
argument_list|(
name|val
argument_list|)
argument_list|)
operator|<=
literal|0
operator|&&
name|OF_getprop
argument_list|(
name|macnode
argument_list|,
literal|"phy-connection-type"
argument_list|,
name|val
argument_list|,
sizeof|sizeof
argument_list|(
name|val
argument_list|)
argument_list|)
operator|<=
literal|0
condition|)
block|{
return|return
operator|(
name|MII_CONTYPE_UNKNOWN
operator|)
return|;
block|}
return|return
operator|(
name|mii_fdt_contype_from_name
argument_list|(
name|val
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|void
name|mii_fdt_free_config
parameter_list|(
name|struct
name|mii_fdt_phy_config
modifier|*
name|cfg
parameter_list|)
block|{
name|free
argument_list|(
name|cfg
argument_list|,
name|M_OFWPROP
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|mii_fdt_phy_config_t
modifier|*
name|mii_fdt_get_config
parameter_list|(
name|device_t
name|phydev
parameter_list|)
block|{
name|mii_fdt_phy_config_t
modifier|*
name|cfg
decl_stmt|;
name|device_t
name|miibus
decl_stmt|,
name|macdev
decl_stmt|;
name|pcell_t
name|val
decl_stmt|;
name|miibus
operator|=
name|device_get_parent
argument_list|(
name|phydev
argument_list|)
expr_stmt|;
name|macdev
operator|=
name|device_get_parent
argument_list|(
name|miibus
argument_list|)
expr_stmt|;
name|cfg
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|cfg
argument_list|)
argument_list|,
name|M_OFWPROP
argument_list|,
name|M_ZERO
operator||
name|M_WAITOK
argument_list|)
expr_stmt|;
comment|/* 	 * If we can't find our parent MAC's node, there's nothing more we can 	 * fill in; cfg is already full of zero/default values, return it. 	 */
if|if
condition|(
operator|(
name|cfg
operator|->
name|macnode
operator|=
name|ofw_bus_get_node
argument_list|(
name|macdev
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
name|cfg
operator|)
return|;
name|cfg
operator|->
name|con_type
operator|=
name|mii_fdt_get_contype
argument_list|(
name|cfg
operator|->
name|macnode
argument_list|)
expr_stmt|;
comment|/* 	 * If we can't find our own PHY node, there's nothing more we can fill 	 * in, just return what we've got. 	 */
if|if
condition|(
operator|(
name|cfg
operator|->
name|phynode
operator|=
name|mii_fdt_get_phynode
argument_list|(
name|cfg
operator|->
name|macnode
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
name|cfg
operator|)
return|;
if|if
condition|(
name|OF_getencprop
argument_list|(
name|cfg
operator|->
name|phynode
argument_list|,
literal|"max-speed"
argument_list|,
operator|&
name|val
argument_list|,
sizeof|sizeof
argument_list|(
name|val
argument_list|)
argument_list|)
operator|>
literal|0
condition|)
name|cfg
operator|->
name|max_speed
operator|=
name|val
expr_stmt|;
if|if
condition|(
name|ofw_bus_node_is_compatible
argument_list|(
name|cfg
operator|->
name|phynode
argument_list|,
literal|"ethernet-phy-ieee802.3-c45"
argument_list|)
condition|)
name|cfg
operator|->
name|flags
operator||=
name|MIIF_FDT_COMPAT_CLAUSE45
expr_stmt|;
if|if
condition|(
name|OF_hasprop
argument_list|(
name|cfg
operator|->
name|phynode
argument_list|,
literal|"broken-turn-around"
argument_list|)
condition|)
name|cfg
operator|->
name|flags
operator||=
name|MIIF_FDT_BROKEN_TURNAROUND
expr_stmt|;
if|if
condition|(
name|OF_hasprop
argument_list|(
name|cfg
operator|->
name|phynode
argument_list|,
literal|"enet-phy-lane-swap"
argument_list|)
condition|)
name|cfg
operator|->
name|flags
operator||=
name|MIIF_FDT_LANE_SWAP
expr_stmt|;
if|if
condition|(
name|OF_hasprop
argument_list|(
name|cfg
operator|->
name|phynode
argument_list|,
literal|"enet-phy-lane-no-swap"
argument_list|)
condition|)
name|cfg
operator|->
name|flags
operator||=
name|MIIF_FDT_NO_LANE_SWAP
expr_stmt|;
if|if
condition|(
name|OF_hasprop
argument_list|(
name|cfg
operator|->
name|phynode
argument_list|,
literal|"eee-broken-100tx"
argument_list|)
condition|)
name|cfg
operator|->
name|flags
operator||=
name|MIIF_FDT_EEE_BROKEN_100TX
expr_stmt|;
if|if
condition|(
name|OF_hasprop
argument_list|(
name|cfg
operator|->
name|phynode
argument_list|,
literal|"eee-broken-1000t"
argument_list|)
condition|)
name|cfg
operator|->
name|flags
operator||=
name|MIIF_FDT_EEE_BROKEN_1000T
expr_stmt|;
if|if
condition|(
name|OF_hasprop
argument_list|(
name|cfg
operator|->
name|phynode
argument_list|,
literal|"eee-broken-10gt"
argument_list|)
condition|)
name|cfg
operator|->
name|flags
operator||=
name|MIIF_FDT_EEE_BROKEN_10GT
expr_stmt|;
if|if
condition|(
name|OF_hasprop
argument_list|(
name|cfg
operator|->
name|phynode
argument_list|,
literal|"eee-broken-1000kx"
argument_list|)
condition|)
name|cfg
operator|->
name|flags
operator||=
name|MIIF_FDT_EEE_BROKEN_1000KX
expr_stmt|;
if|if
condition|(
name|OF_hasprop
argument_list|(
name|cfg
operator|->
name|phynode
argument_list|,
literal|"eee-broken-10gkx4"
argument_list|)
condition|)
name|cfg
operator|->
name|flags
operator||=
name|MIIF_FDT_EEE_BROKEN_10GKX4
expr_stmt|;
if|if
condition|(
name|OF_hasprop
argument_list|(
name|cfg
operator|->
name|phynode
argument_list|,
literal|"eee-broken-10gkr"
argument_list|)
condition|)
name|cfg
operator|->
name|flags
operator||=
name|MIIF_FDT_EEE_BROKEN_10GKR
expr_stmt|;
return|return
operator|(
name|cfg
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2011-2012 Semihalf.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<net/ethernet.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_dl.h>
end_include

begin_include
include|#
directive|include
file|<net/if_media.h>
end_include

begin_include
include|#
directive|include
file|<net/if_types.h>
end_include

begin_include
include|#
directive|include
file|<net/if_arp.h>
end_include

begin_include
include|#
directive|include
file|<dev/mii/mii.h>
end_include

begin_include
include|#
directive|include
file|<dev/mii/miivar.h>
end_include

begin_include
include|#
directive|include
file|<dev/ofw/ofw_bus.h>
end_include

begin_include
include|#
directive|include
file|<dev/ofw/ofw_bus_subr.h>
end_include

begin_include
include|#
directive|include
file|<dev/ofw/openfirm.h>
end_include

begin_include
include|#
directive|include
file|"miibus_if.h"
end_include

begin_include
include|#
directive|include
file|<contrib/ncsw/inc/Peripherals/fm_mac_ext.h>
end_include

begin_include
include|#
directive|include
file|<contrib/ncsw/inc/Peripherals/fm_port_ext.h>
end_include

begin_include
include|#
directive|include
file|<contrib/ncsw/inc/xx_ext.h>
end_include

begin_include
include|#
directive|include
file|"fman.h"
end_include

begin_include
include|#
directive|include
file|"if_dtsec.h"
end_include

begin_include
include|#
directive|include
file|"if_dtsec_im.h"
end_include

begin_include
include|#
directive|include
file|"if_dtsec_rm.h"
end_include

begin_comment
comment|/**  * @group dTSEC private defines.  * @{  */
end_comment

begin_comment
comment|/**  * dTSEC FMan MAC exceptions info struct.  */
end_comment

begin_struct
struct|struct
name|dtsec_fm_mac_ex_str
block|{
specifier|const
name|int
name|num
decl_stmt|;
specifier|const
name|char
modifier|*
name|str
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/** @} */
end_comment

begin_comment
comment|/**  * @group FMan MAC routines.  * @{  */
end_comment

begin_define
define|#
directive|define
name|DTSEC_MAC_EXCEPTIONS_END
value|(-1)
end_define

begin_comment
comment|/**  * FMan MAC exceptions.  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|dtsec_fm_mac_ex_str
name|dtsec_fm_mac_exceptions
index|[]
init|=
block|{
block|{
name|e_FM_MAC_EX_10G_MDIO_SCAN_EVENTMDIO
block|,
literal|"MDIO scan event"
block|}
block|,
block|{
name|e_FM_MAC_EX_10G_MDIO_CMD_CMPL
block|,
literal|"MDIO command completion"
block|}
block|,
block|{
name|e_FM_MAC_EX_10G_REM_FAULT
block|,
literal|"Remote fault"
block|}
block|,
block|{
name|e_FM_MAC_EX_10G_LOC_FAULT
block|,
literal|"Local fault"
block|}
block|,
block|{
name|e_FM_MAC_EX_10G_1TX_ECC_ER
block|,
literal|"Transmit frame ECC error"
block|}
block|,
block|{
name|e_FM_MAC_EX_10G_TX_FIFO_UNFL
block|,
literal|"Transmit FIFO underflow"
block|}
block|,
block|{
name|e_FM_MAC_EX_10G_TX_FIFO_OVFL
block|,
literal|"Receive FIFO overflow"
block|}
block|,
block|{
name|e_FM_MAC_EX_10G_TX_ER
block|,
literal|"Transmit frame error"
block|}
block|,
block|{
name|e_FM_MAC_EX_10G_RX_FIFO_OVFL
block|,
literal|"Receive FIFO overflow"
block|}
block|,
block|{
name|e_FM_MAC_EX_10G_RX_ECC_ER
block|,
literal|"Receive frame ECC error"
block|}
block|,
block|{
name|e_FM_MAC_EX_10G_RX_JAB_FRM
block|,
literal|"Receive jabber frame"
block|}
block|,
block|{
name|e_FM_MAC_EX_10G_RX_OVRSZ_FRM
block|,
literal|"Receive oversized frame"
block|}
block|,
block|{
name|e_FM_MAC_EX_10G_RX_RUNT_FRM
block|,
literal|"Receive runt frame"
block|}
block|,
block|{
name|e_FM_MAC_EX_10G_RX_FRAG_FRM
block|,
literal|"Receive fragment frame"
block|}
block|,
block|{
name|e_FM_MAC_EX_10G_RX_LEN_ER
block|,
literal|"Receive payload length error"
block|}
block|,
block|{
name|e_FM_MAC_EX_10G_RX_CRC_ER
block|,
literal|"Receive CRC error"
block|}
block|,
block|{
name|e_FM_MAC_EX_10G_RX_ALIGN_ER
block|,
literal|"Receive alignment error"
block|}
block|,
block|{
name|e_FM_MAC_EX_1G_BAB_RX
block|,
literal|"Babbling receive error"
block|}
block|,
block|{
name|e_FM_MAC_EX_1G_RX_CTL
block|,
literal|"Receive control (pause frame) interrupt"
block|}
block|,
block|{
name|e_FM_MAC_EX_1G_GRATEFUL_TX_STP_COMPLET
block|,
literal|"Graceful transmit stop "
literal|"complete"
block|}
block|,
block|{
name|e_FM_MAC_EX_1G_BAB_TX
block|,
literal|"Babbling transmit error"
block|}
block|,
block|{
name|e_FM_MAC_EX_1G_TX_CTL
block|,
literal|"Transmit control (pause frame) interrupt"
block|}
block|,
block|{
name|e_FM_MAC_EX_1G_TX_ERR
block|,
literal|"Transmit error"
block|}
block|,
block|{
name|e_FM_MAC_EX_1G_LATE_COL
block|,
literal|"Late collision"
block|}
block|,
block|{
name|e_FM_MAC_EX_1G_COL_RET_LMT
block|,
literal|"Collision retry limit"
block|}
block|,
block|{
name|e_FM_MAC_EX_1G_TX_FIFO_UNDRN
block|,
literal|"Transmit FIFO underrun"
block|}
block|,
block|{
name|e_FM_MAC_EX_1G_MAG_PCKT
block|,
literal|"Magic Packet detected when dTSEC is in "
literal|"Magic Packet detection mode"
block|}
block|,
block|{
name|e_FM_MAC_EX_1G_MII_MNG_RD_COMPLET
block|,
literal|"MII management read completion"
block|}
block|,
block|{
name|e_FM_MAC_EX_1G_MII_MNG_WR_COMPLET
block|,
literal|"MII management write completion"
block|}
block|,
block|{
name|e_FM_MAC_EX_1G_GRATEFUL_RX_STP_COMPLET
block|,
literal|"Graceful receive stop "
literal|"complete"
block|}
block|,
block|{
name|e_FM_MAC_EX_1G_TX_DATA_ERR
block|,
literal|"Internal data error on transmit"
block|}
block|,
block|{
name|e_FM_MAC_EX_1G_RX_DATA_ERR
block|,
literal|"Internal data error on receive"
block|}
block|,
block|{
name|e_FM_MAC_EX_1G_1588_TS_RX_ERR
block|,
literal|"Time-Stamp Receive Error"
block|}
block|,
block|{
name|e_FM_MAC_EX_1G_RX_MIB_CNT_OVFL
block|,
literal|"MIB counter overflow"
block|}
block|,
block|{
name|DTSEC_MAC_EXCEPTIONS_END
block|,
literal|""
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|dtsec_fm_mac_ex_to_str
parameter_list|(
name|e_FmMacExceptions
name|exception
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|dtsec_fm_mac_exceptions
index|[
name|i
index|]
operator|.
name|num
operator|!=
name|exception
operator|&&
name|dtsec_fm_mac_exceptions
index|[
name|i
index|]
operator|.
name|num
operator|!=
name|DTSEC_MAC_EXCEPTIONS_END
condition|;
operator|++
name|i
control|)
empty_stmt|;
if|if
condition|(
name|dtsec_fm_mac_exceptions
index|[
name|i
index|]
operator|.
name|num
operator|==
name|DTSEC_MAC_EXCEPTIONS_END
condition|)
return|return
operator|(
literal|"<Unknown Exception>"
operator|)
return|;
return|return
operator|(
name|dtsec_fm_mac_exceptions
index|[
name|i
index|]
operator|.
name|str
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|dtsec_fm_mac_mdio_event_callback
parameter_list|(
name|t_Handle
name|h_App
parameter_list|,
name|e_FmMacExceptions
name|exception
parameter_list|)
block|{
name|struct
name|dtsec_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|h_App
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"MDIO event %i: %s.\n"
argument_list|,
name|exception
argument_list|,
name|dtsec_fm_mac_ex_to_str
argument_list|(
name|exception
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dtsec_fm_mac_exception_callback
parameter_list|(
name|t_Handle
name|app
parameter_list|,
name|e_FmMacExceptions
name|exception
parameter_list|)
block|{
name|struct
name|dtsec_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|app
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"MAC exception %i: %s.\n"
argument_list|,
name|exception
argument_list|,
name|dtsec_fm_mac_ex_to_str
argument_list|(
name|exception
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dtsec_fm_mac_free
parameter_list|(
name|struct
name|dtsec_softc
modifier|*
name|sc
parameter_list|)
block|{
if|if
condition|(
name|sc
operator|->
name|sc_mach
operator|==
name|NULL
condition|)
return|return;
name|FM_MAC_Disable
argument_list|(
name|sc
operator|->
name|sc_mach
argument_list|,
name|e_COMM_MODE_RX_AND_TX
argument_list|)
expr_stmt|;
name|FM_MAC_Free
argument_list|(
name|sc
operator|->
name|sc_mach
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_mach
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|dtsec_fm_mac_init
parameter_list|(
name|struct
name|dtsec_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
modifier|*
name|mac
parameter_list|)
block|{
name|t_FmMacParams
name|params
decl_stmt|;
name|t_Error
name|error
decl_stmt|;
name|memset
argument_list|(
operator|&
name|params
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|params
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|params
operator|.
name|addr
argument_list|,
name|mac
argument_list|,
sizeof|sizeof
argument_list|(
name|params
operator|.
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|params
operator|.
name|baseAddr
operator|=
name|sc
operator|->
name|sc_fm_base
operator|+
name|sc
operator|->
name|sc_mac_mem_offset
expr_stmt|;
name|params
operator|.
name|enetMode
operator|=
name|sc
operator|->
name|sc_mac_enet_mode
expr_stmt|;
name|params
operator|.
name|macId
operator|=
name|sc
operator|->
name|sc_eth_id
expr_stmt|;
name|params
operator|.
name|mdioIrq
operator|=
name|sc
operator|->
name|sc_mac_mdio_irq
expr_stmt|;
name|params
operator|.
name|f_Event
operator|=
name|dtsec_fm_mac_mdio_event_callback
expr_stmt|;
name|params
operator|.
name|f_Exception
operator|=
name|dtsec_fm_mac_exception_callback
expr_stmt|;
name|params
operator|.
name|h_App
operator|=
name|sc
expr_stmt|;
name|params
operator|.
name|h_Fm
operator|=
name|sc
operator|->
name|sc_fmh
expr_stmt|;
name|sc
operator|->
name|sc_mach
operator|=
name|FM_MAC_Config
argument_list|(
operator|&
name|params
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_mach
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"couldn't configure FM_MAC module.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|error
operator|=
name|FM_MAC_ConfigResetOnInit
argument_list|(
name|sc
operator|->
name|sc_mach
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|E_OK
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"couldn't enable reset on init "
literal|"feature.\n"
argument_list|)
expr_stmt|;
name|dtsec_fm_mac_free
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
comment|/* Do not inform about pause frames */
name|error
operator|=
name|FM_MAC_ConfigException
argument_list|(
name|sc
operator|->
name|sc_mach
argument_list|,
name|e_FM_MAC_EX_1G_RX_CTL
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|E_OK
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"couldn't disable pause frames "
literal|"exception.\n"
argument_list|)
expr_stmt|;
name|dtsec_fm_mac_free
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|error
operator|=
name|FM_MAC_Init
argument_list|(
name|sc
operator|->
name|sc_mach
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|E_OK
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"couldn't initialize FM_MAC module."
literal|"\n"
argument_list|)
expr_stmt|;
name|dtsec_fm_mac_free
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/** @} */
end_comment

begin_comment
comment|/**  * @group FMan PORT routines.  * @{  */
end_comment

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|dtsec_fm_port_ex_to_str
parameter_list|(
name|e_FmPortExceptions
name|exception
parameter_list|)
block|{
switch|switch
condition|(
name|exception
condition|)
block|{
case|case
name|e_FM_PORT_EXCEPTION_IM_BUSY
case|:
return|return
operator|(
literal|"IM: RX busy"
operator|)
return|;
default|default:
return|return
operator|(
literal|"<Unknown Exception>"
operator|)
return|;
block|}
block|}
end_function

begin_function
name|void
name|dtsec_fm_port_rx_exception_callback
parameter_list|(
name|t_Handle
name|app
parameter_list|,
name|e_FmPortExceptions
name|exception
parameter_list|)
block|{
name|struct
name|dtsec_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|app
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"RX exception: %i: %s.\n"
argument_list|,
name|exception
argument_list|,
name|dtsec_fm_port_ex_to_str
argument_list|(
name|exception
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dtsec_fm_port_tx_exception_callback
parameter_list|(
name|t_Handle
name|app
parameter_list|,
name|e_FmPortExceptions
name|exception
parameter_list|)
block|{
name|struct
name|dtsec_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|app
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"TX exception: %i: %s.\n"
argument_list|,
name|exception
argument_list|,
name|dtsec_fm_port_ex_to_str
argument_list|(
name|exception
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|e_FmPortType
name|dtsec_fm_port_rx_type
parameter_list|(
name|enum
name|eth_dev_type
name|type
parameter_list|)
block|{
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|ETH_DTSEC
case|:
return|return
operator|(
name|e_FM_PORT_TYPE_RX
operator|)
return|;
case|case
name|ETH_10GSEC
case|:
return|return
operator|(
name|e_FM_PORT_TYPE_RX_10G
operator|)
return|;
default|default:
return|return
operator|(
name|e_FM_PORT_TYPE_DUMMY
operator|)
return|;
block|}
block|}
end_function

begin_function
name|e_FmPortType
name|dtsec_fm_port_tx_type
parameter_list|(
name|enum
name|eth_dev_type
name|type
parameter_list|)
block|{
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|ETH_DTSEC
case|:
return|return
operator|(
name|e_FM_PORT_TYPE_TX
operator|)
return|;
case|case
name|ETH_10GSEC
case|:
return|return
operator|(
name|e_FM_PORT_TYPE_TX_10G
operator|)
return|;
default|default:
return|return
operator|(
name|e_FM_PORT_TYPE_DUMMY
operator|)
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|dtsec_fm_port_free_both
parameter_list|(
name|struct
name|dtsec_softc
modifier|*
name|sc
parameter_list|)
block|{
if|if
condition|(
name|sc
operator|->
name|sc_rxph
condition|)
block|{
name|FM_PORT_Free
argument_list|(
name|sc
operator|->
name|sc_rxph
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_rxph
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|sc_txph
condition|)
block|{
name|FM_PORT_Free
argument_list|(
name|sc
operator|->
name|sc_txph
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_txph
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/** @} */
end_comment

begin_comment
comment|/**  * @group IFnet routines.  * @{  */
end_comment

begin_function
specifier|static
name|int
name|dtsec_if_enable_locked
parameter_list|(
name|struct
name|dtsec_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
name|DTSEC_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|error
operator|=
name|FM_MAC_Enable
argument_list|(
name|sc
operator|->
name|sc_mach
argument_list|,
name|e_COMM_MODE_RX_AND_TX
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|E_OK
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
name|error
operator|=
name|FM_PORT_Enable
argument_list|(
name|sc
operator|->
name|sc_rxph
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|E_OK
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
name|error
operator|=
name|FM_PORT_Enable
argument_list|(
name|sc
operator|->
name|sc_txph
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|E_OK
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
name|sc
operator|->
name|sc_ifnet
operator|->
name|if_drv_flags
operator||=
name|IFF_DRV_RUNNING
expr_stmt|;
comment|/* Refresh link state */
name|dtsec_miibus_statchg
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dtsec_if_disable_locked
parameter_list|(
name|struct
name|dtsec_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
name|DTSEC_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|error
operator|=
name|FM_MAC_Disable
argument_list|(
name|sc
operator|->
name|sc_mach
argument_list|,
name|e_COMM_MODE_RX_AND_TX
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|E_OK
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
name|error
operator|=
name|FM_PORT_Disable
argument_list|(
name|sc
operator|->
name|sc_rxph
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|E_OK
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
name|error
operator|=
name|FM_PORT_Disable
argument_list|(
name|sc
operator|->
name|sc_txph
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|E_OK
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
name|sc
operator|->
name|sc_ifnet
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_RUNNING
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dtsec_if_ioctl
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|u_long
name|command
parameter_list|,
name|caddr_t
name|data
parameter_list|)
block|{
name|struct
name|dtsec_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|ifreq
modifier|*
name|ifr
decl_stmt|;
name|int
name|error
decl_stmt|;
name|sc
operator|=
name|ifp
operator|->
name|if_softc
expr_stmt|;
name|ifr
operator|=
operator|(
expr|struct
name|ifreq
operator|*
operator|)
name|data
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
comment|/* Basic functionality to achieve media status reports */
switch|switch
condition|(
name|command
condition|)
block|{
case|case
name|SIOCSIFFLAGS
case|:
name|DTSEC_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_ifnet
operator|->
name|if_flags
operator|&
name|IFF_UP
condition|)
name|error
operator|=
name|dtsec_if_enable_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
else|else
name|error
operator|=
name|dtsec_if_disable_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|DTSEC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCGIFMEDIA
case|:
case|case
name|SIOCSIFMEDIA
case|:
name|error
operator|=
name|ifmedia_ioctl
argument_list|(
name|ifp
argument_list|,
name|ifr
argument_list|,
operator|&
name|sc
operator|->
name|sc_mii
operator|->
name|mii_media
argument_list|,
name|command
argument_list|)
expr_stmt|;
break|break;
default|default:
name|error
operator|=
name|ether_ioctl
argument_list|(
name|ifp
argument_list|,
name|command
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|dtsec_if_tick
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|dtsec_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|arg
expr_stmt|;
comment|/* TODO */
name|DTSEC_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|mii_tick
argument_list|(
name|sc
operator|->
name|sc_mii
argument_list|)
expr_stmt|;
name|callout_reset
argument_list|(
operator|&
name|sc
operator|->
name|sc_tick_callout
argument_list|,
name|hz
argument_list|,
name|dtsec_if_tick
argument_list|,
name|sc
argument_list|)
expr_stmt|;
name|DTSEC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dtsec_if_deinit_locked
parameter_list|(
name|struct
name|dtsec_softc
modifier|*
name|sc
parameter_list|)
block|{
name|DTSEC_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|DTSEC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|callout_drain
argument_list|(
operator|&
name|sc
operator|->
name|sc_tick_callout
argument_list|)
expr_stmt|;
name|DTSEC_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dtsec_if_init_locked
parameter_list|(
name|struct
name|dtsec_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
name|DTSEC_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Set MAC address */
name|error
operator|=
name|FM_MAC_ModifyMacAddr
argument_list|(
name|sc
operator|->
name|sc_mach
argument_list|,
operator|(
name|t_EnetAddr
operator|*
operator|)
name|IF_LLADDR
argument_list|(
name|sc
operator|->
name|sc_ifnet
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|E_OK
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"couldn't set MAC address.\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
comment|/* Start MII polling */
if|if
condition|(
name|sc
operator|->
name|sc_mii
condition|)
name|callout_reset
argument_list|(
operator|&
name|sc
operator|->
name|sc_tick_callout
argument_list|,
name|hz
argument_list|,
name|dtsec_if_tick
argument_list|,
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_ifnet
operator|->
name|if_flags
operator|&
name|IFF_UP
condition|)
block|{
name|error
operator|=
name|dtsec_if_enable_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|err
goto|;
block|}
else|else
block|{
name|error
operator|=
name|dtsec_if_disable_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|err
goto|;
block|}
return|return;
name|err
label|:
name|dtsec_if_deinit_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"initialization error.\n"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|dtsec_if_init
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|dtsec_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|data
expr_stmt|;
name|DTSEC_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|dtsec_if_init_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|DTSEC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dtsec_if_start
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|struct
name|dtsec_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|ifp
operator|->
name|if_softc
expr_stmt|;
name|DTSEC_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_start_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|DTSEC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dtsec_if_watchdog
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
comment|/* TODO */
block|}
end_function

begin_comment
comment|/** @} */
end_comment

begin_comment
comment|/**  * @group IFmedia routines.  * @{  */
end_comment

begin_function
specifier|static
name|int
name|dtsec_ifmedia_upd
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|struct
name|dtsec_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|DTSEC_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|mii_mediachg
argument_list|(
name|sc
operator|->
name|sc_mii
argument_list|)
expr_stmt|;
name|DTSEC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|dtsec_ifmedia_sts
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|ifmediareq
modifier|*
name|ifmr
parameter_list|)
block|{
name|struct
name|dtsec_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|DTSEC_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|mii_pollstat
argument_list|(
name|sc
operator|->
name|sc_mii
argument_list|)
expr_stmt|;
name|ifmr
operator|->
name|ifm_active
operator|=
name|sc
operator|->
name|sc_mii
operator|->
name|mii_media_active
expr_stmt|;
name|ifmr
operator|->
name|ifm_status
operator|=
name|sc
operator|->
name|sc_mii
operator|->
name|mii_media_status
expr_stmt|;
name|DTSEC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/** @} */
end_comment

begin_comment
comment|/**  * @group dTSEC bus interface.  * @{  */
end_comment

begin_function
specifier|static
name|void
name|dtsec_configure_mode
parameter_list|(
name|struct
name|dtsec_softc
modifier|*
name|sc
parameter_list|)
block|{
name|char
name|tunable
index|[
literal|64
index|]
decl_stmt|;
name|snprintf
argument_list|(
name|tunable
argument_list|,
sizeof|sizeof
argument_list|(
name|tunable
argument_list|)
argument_list|,
literal|"%s.independent_mode"
argument_list|,
name|device_get_nameunit
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_mode
operator|=
name|DTSEC_MODE_REGULAR
expr_stmt|;
name|TUNABLE_INT_FETCH
argument_list|(
name|tunable
argument_list|,
operator|&
name|sc
operator|->
name|sc_mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_mode
operator|==
name|DTSEC_MODE_REGULAR
condition|)
block|{
name|sc
operator|->
name|sc_port_rx_init
operator|=
name|dtsec_rm_fm_port_rx_init
expr_stmt|;
name|sc
operator|->
name|sc_port_tx_init
operator|=
name|dtsec_rm_fm_port_tx_init
expr_stmt|;
name|sc
operator|->
name|sc_start_locked
operator|=
name|dtsec_rm_if_start_locked
expr_stmt|;
block|}
else|else
block|{
name|sc
operator|->
name|sc_port_rx_init
operator|=
name|dtsec_im_fm_port_rx_init
expr_stmt|;
name|sc
operator|->
name|sc_port_tx_init
operator|=
name|dtsec_im_fm_port_tx_init
expr_stmt|;
name|sc
operator|->
name|sc_start_locked
operator|=
name|dtsec_im_if_start_locked
expr_stmt|;
block|}
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"Configured for %s mode.\n"
argument_list|,
operator|(
name|sc
operator|->
name|sc_mode
operator|==
name|DTSEC_MODE_REGULAR
operator|)
condition|?
literal|"regular"
else|:
literal|"independent"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|dtsec_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|dtsec_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|error
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_dev
operator|=
name|dev
expr_stmt|;
name|sc
operator|->
name|sc_mac_mdio_irq
operator|=
name|NO_IRQ
expr_stmt|;
name|sc
operator|->
name|sc_eth_id
operator|=
name|device_get_unit
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* Check if MallocSmart allocator is ready */
if|if
condition|(
name|XX_MallocSmartInit
argument_list|()
operator|!=
name|E_OK
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
comment|/* Init locks */
name|mtx_init
argument_list|(
operator|&
name|sc
operator|->
name|sc_lock
argument_list|,
name|device_get_nameunit
argument_list|(
name|dev
argument_list|)
argument_list|,
literal|"DTSEC Global Lock"
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
name|mtx_init
argument_list|(
operator|&
name|sc
operator|->
name|sc_mii_lock
argument_list|,
name|device_get_nameunit
argument_list|(
name|dev
argument_list|)
argument_list|,
literal|"DTSEC MII Lock"
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
comment|/* Init callouts */
name|callout_init
argument_list|(
operator|&
name|sc
operator|->
name|sc_tick_callout
argument_list|,
name|CALLOUT_MPSAFE
argument_list|)
expr_stmt|;
comment|/* Read configuraton */
if|if
condition|(
operator|(
name|error
operator|=
name|fman_get_handle
argument_list|(
operator|&
name|sc
operator|->
name|sc_fmh
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
if|if
condition|(
operator|(
name|error
operator|=
name|fman_get_muram_handle
argument_list|(
operator|&
name|sc
operator|->
name|sc_muramh
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
if|if
condition|(
operator|(
name|error
operator|=
name|fman_get_bushandle
argument_list|(
operator|&
name|sc
operator|->
name|sc_fm_base
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
comment|/* Configure working mode */
name|dtsec_configure_mode
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* If we are working in regular mode configure BMAN and QMAN */
if|if
condition|(
name|sc
operator|->
name|sc_mode
operator|==
name|DTSEC_MODE_REGULAR
condition|)
block|{
comment|/* Create RX buffer pool */
name|error
operator|=
name|dtsec_rm_pool_rx_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
comment|/* Create RX frame queue range */
name|error
operator|=
name|dtsec_rm_fqr_rx_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
comment|/* Create frame info pool */
name|error
operator|=
name|dtsec_rm_fi_pool_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
comment|/* Create TX frame queue range */
name|error
operator|=
name|dtsec_rm_fqr_tx_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
block|}
comment|/* Init FMan MAC module. */
name|error
operator|=
name|dtsec_fm_mac_init
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|sc_mac_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|dtsec_detach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
comment|/* Init FMan TX port */
name|error
operator|=
name|sc
operator|->
name|sc_port_tx_init
argument_list|(
name|sc
argument_list|,
name|device_get_unit
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|dtsec_detach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
comment|/* Init FMan RX port */
name|error
operator|=
name|sc
operator|->
name|sc_port_rx_init
argument_list|(
name|sc
argument_list|,
name|device_get_unit
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|dtsec_detach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
comment|/* Create network interface for upper layers */
name|ifp
operator|=
name|sc
operator|->
name|sc_ifnet
operator|=
name|if_alloc
argument_list|(
name|IFT_ETHER
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"if_alloc() failed.\n"
argument_list|)
expr_stmt|;
name|dtsec_detach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
name|ifp
operator|->
name|if_softc
operator|=
name|sc
expr_stmt|;
name|ifp
operator|->
name|if_mtu
operator|=
name|ETHERMTU
expr_stmt|;
comment|/* TODO: Configure */
name|ifp
operator|->
name|if_flags
operator|=
name|IFF_SIMPLEX
operator||
name|IFF_BROADCAST
expr_stmt|;
name|ifp
operator|->
name|if_init
operator|=
name|dtsec_if_init
expr_stmt|;
name|ifp
operator|->
name|if_start
operator|=
name|dtsec_if_start
expr_stmt|;
name|ifp
operator|->
name|if_ioctl
operator|=
name|dtsec_if_ioctl
expr_stmt|;
name|ifp
operator|->
name|if_snd
operator|.
name|ifq_maxlen
operator|=
name|IFQ_MAXLEN
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_phy_addr
operator|>=
literal|0
condition|)
name|if_initname
argument_list|(
name|ifp
argument_list|,
name|device_get_name
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|device_get_unit
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|if_initname
argument_list|(
name|ifp
argument_list|,
literal|"dtsec_phy"
argument_list|,
name|device_get_unit
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|)
expr_stmt|;
comment|/* TODO */
if|#
directive|if
literal|0
block|IFQ_SET_MAXLEN(&ifp->if_snd, TSEC_TX_NUM_DESC - 1); 	ifp->if_snd.ifq_drv_maxlen = TSEC_TX_NUM_DESC - 1; 	IFQ_SET_READY(&ifp->if_snd);
endif|#
directive|endif
name|ifp
operator|->
name|if_capabilities
operator|=
literal|0
expr_stmt|;
comment|/* TODO: Check */
name|ifp
operator|->
name|if_capenable
operator|=
name|ifp
operator|->
name|if_capabilities
expr_stmt|;
comment|/* Attach PHY(s) */
name|error
operator|=
name|mii_attach
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
operator|&
name|sc
operator|->
name|sc_mii_dev
argument_list|,
name|ifp
argument_list|,
name|dtsec_ifmedia_upd
argument_list|,
name|dtsec_ifmedia_sts
argument_list|,
name|BMSR_DEFCAPMASK
argument_list|,
name|sc
operator|->
name|sc_phy_addr
argument_list|,
name|MII_OFFSET_ANY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"attaching PHYs failed: %d\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|dtsec_detach
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|sc
operator|->
name|sc_mii
operator|=
name|device_get_softc
argument_list|(
name|sc
operator|->
name|sc_mii_dev
argument_list|)
expr_stmt|;
comment|/* Attach to stack */
name|ether_ifattach
argument_list|(
name|ifp
argument_list|,
name|sc
operator|->
name|sc_mac_addr
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|dtsec_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|dtsec_softc
modifier|*
name|sc
decl_stmt|;
name|if_t
name|ifp
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|sc_ifnet
expr_stmt|;
if|if
condition|(
name|device_is_attached
argument_list|(
name|dev
argument_list|)
condition|)
block|{
name|ether_ifdetach
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
comment|/* Shutdown interface */
name|DTSEC_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|dtsec_if_deinit_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|DTSEC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|sc_ifnet
condition|)
block|{
name|if_free
argument_list|(
name|sc
operator|->
name|sc_ifnet
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_ifnet
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|sc_mode
operator|==
name|DTSEC_MODE_REGULAR
condition|)
block|{
comment|/* Free RX/TX FQRs */
name|dtsec_rm_fqr_rx_free
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|dtsec_rm_fqr_tx_free
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Free frame info pool */
name|dtsec_rm_fi_pool_free
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Free RX buffer pool */
name|dtsec_rm_pool_rx_free
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
name|dtsec_fm_mac_free
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|dtsec_fm_port_free_both
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Destroy lock */
name|mtx_destroy
argument_list|(
operator|&
name|sc
operator|->
name|sc_lock
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|dtsec_suspend
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|dtsec_resume
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|dtsec_shutdown
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/** @} */
end_comment

begin_comment
comment|/**  * @group MII bus interface.  * @{  */
end_comment

begin_function
name|int
name|dtsec_miibus_readreg
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|phy
parameter_list|,
name|int
name|reg
parameter_list|)
block|{
name|struct
name|dtsec_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
name|MIIBUS_READREG
argument_list|(
name|sc
operator|->
name|sc_mdio
argument_list|,
name|phy
argument_list|,
name|reg
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|dtsec_miibus_writereg
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|phy
parameter_list|,
name|int
name|reg
parameter_list|,
name|int
name|value
parameter_list|)
block|{
name|struct
name|dtsec_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
name|MIIBUS_WRITEREG
argument_list|(
name|sc
operator|->
name|sc_mdio
argument_list|,
name|phy
argument_list|,
name|reg
argument_list|,
name|value
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dtsec_miibus_statchg
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|dtsec_softc
modifier|*
name|sc
decl_stmt|;
name|e_EnetSpeed
name|speed
decl_stmt|;
name|bool
name|duplex
decl_stmt|;
name|int
name|error
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|DTSEC_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|duplex
operator|=
operator|(
operator|(
name|sc
operator|->
name|sc_mii
operator|->
name|mii_media_active
operator|&
name|IFM_GMASK
operator|)
operator|==
name|IFM_FDX
operator|)
expr_stmt|;
switch|switch
condition|(
name|IFM_SUBTYPE
argument_list|(
name|sc
operator|->
name|sc_mii
operator|->
name|mii_media_active
argument_list|)
condition|)
block|{
case|case
name|IFM_1000_T
case|:
case|case
name|IFM_1000_SX
case|:
name|speed
operator|=
name|e_ENET_SPEED_1000
expr_stmt|;
break|break;
case|case
name|IFM_100_TX
case|:
name|speed
operator|=
name|e_ENET_SPEED_100
expr_stmt|;
break|break;
case|case
name|IFM_10_T
case|:
name|speed
operator|=
name|e_ENET_SPEED_10
expr_stmt|;
break|break;
default|default:
name|speed
operator|=
name|e_ENET_SPEED_10
expr_stmt|;
block|}
name|error
operator|=
name|FM_MAC_AdjustLink
argument_list|(
name|sc
operator|->
name|sc_mach
argument_list|,
name|speed
argument_list|,
name|duplex
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|E_OK
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"error while adjusting MAC speed.\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/** @} */
end_comment

end_unit


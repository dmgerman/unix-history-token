begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2011-2012 Semihalf.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/pcpu.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<sys/sched.h>
end_include

begin_include
include|#
directive|include
file|<machine/tlb.h>
end_include

begin_include
include|#
directive|include
file|"bman.h"
end_include

begin_decl_stmt
name|devclass_t
name|bman_devclass
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|bman_softc
modifier|*
name|bman_sc
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|extern
name|t_Handle
name|bman_portal_setup
parameter_list|(
name|struct
name|bman_softc
modifier|*
name|bsc
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|void
name|bman_exception
parameter_list|(
name|t_Handle
name|h_App
parameter_list|,
name|e_BmExceptions
name|exception
parameter_list|)
block|{
name|struct
name|bman_softc
modifier|*
name|sc
decl_stmt|;
specifier|const
name|char
modifier|*
name|message
decl_stmt|;
name|sc
operator|=
name|h_App
expr_stmt|;
switch|switch
condition|(
name|exception
condition|)
block|{
case|case
name|e_BM_EX_INVALID_COMMAND
case|:
name|message
operator|=
literal|"Invalid Command Verb"
expr_stmt|;
break|break;
case|case
name|e_BM_EX_FBPR_THRESHOLD
case|:
name|message
operator|=
literal|"FBPR pool exhaused. Consider increasing "
literal|"BMAN_MAX_BUFFERS"
expr_stmt|;
break|break;
case|case
name|e_BM_EX_SINGLE_ECC
case|:
name|message
operator|=
literal|"Single bit ECC error"
expr_stmt|;
break|break;
case|case
name|e_BM_EX_MULTI_ECC
case|:
name|message
operator|=
literal|"Multi bit ECC error"
expr_stmt|;
break|break;
default|default:
name|message
operator|=
literal|"Unknown error"
expr_stmt|;
block|}
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"BMAN Exception: %s.\n"
argument_list|,
name|message
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|bman_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|bman_softc
modifier|*
name|sc
decl_stmt|;
name|t_BmRevisionInfo
name|rev
decl_stmt|;
name|t_Error
name|error
decl_stmt|;
name|t_BmParam
name|bp
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_dev
operator|=
name|dev
expr_stmt|;
name|bman_sc
operator|=
name|sc
expr_stmt|;
comment|/* Check if MallocSmart allocator is ready */
if|if
condition|(
name|XX_MallocSmartInit
argument_list|()
operator|!=
name|E_OK
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
comment|/* Allocate resources */
name|sc
operator|->
name|sc_rrid
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_rres
operator|=
name|bus_alloc_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
operator|&
name|sc
operator|->
name|sc_rrid
argument_list|,
literal|0
argument_list|,
operator|~
literal|0
argument_list|,
name|BMAN_CCSR_SIZE
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_rres
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|sc
operator|->
name|sc_irid
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_ires
operator|=
name|bus_alloc_resource_any
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
operator|&
name|sc
operator|->
name|sc_irid
argument_list|,
name|RF_ACTIVE
operator||
name|RF_SHAREABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_ires
operator|==
name|NULL
condition|)
goto|goto
name|err
goto|;
comment|/* Initialize BMAN */
name|memset
argument_list|(
operator|&
name|bp
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|bp
argument_list|)
argument_list|)
expr_stmt|;
name|bp
operator|.
name|guestId
operator|=
name|NCSW_MASTER_ID
expr_stmt|;
name|bp
operator|.
name|baseAddress
operator|=
name|rman_get_bushandle
argument_list|(
name|sc
operator|->
name|sc_rres
argument_list|)
expr_stmt|;
name|bp
operator|.
name|totalNumOfBuffers
operator|=
name|BMAN_MAX_BUFFERS
expr_stmt|;
name|bp
operator|.
name|f_Exception
operator|=
name|bman_exception
expr_stmt|;
name|bp
operator|.
name|h_App
operator|=
name|sc
expr_stmt|;
name|bp
operator|.
name|errIrq
operator|=
operator|(
name|int
operator|)
name|sc
operator|->
name|sc_ires
expr_stmt|;
name|bp
operator|.
name|partBpidBase
operator|=
literal|0
expr_stmt|;
name|bp
operator|.
name|partNumOfPools
operator|=
name|BM_MAX_NUM_OF_POOLS
expr_stmt|;
name|printf
argument_list|(
literal|"base address: %llx\n"
argument_list|,
operator|(
name|uint64_t
operator|)
name|bp
operator|.
name|baseAddress
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_bh
operator|=
name|BM_Config
argument_list|(
operator|&
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_bh
operator|==
name|NULL
condition|)
goto|goto
name|err
goto|;
comment|/* Warn if there is less than 5% free FPBR's in pool */
name|error
operator|=
name|BM_ConfigFbprThreshold
argument_list|(
name|sc
operator|->
name|sc_bh
argument_list|,
operator|(
name|BMAN_MAX_BUFFERS
operator|/
literal|8
operator|)
operator|/
literal|20
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|E_OK
condition|)
goto|goto
name|err
goto|;
name|error
operator|=
name|BM_Init
argument_list|(
name|sc
operator|->
name|sc_bh
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|E_OK
condition|)
goto|goto
name|err
goto|;
name|error
operator|=
name|BM_GetRevision
argument_list|(
name|sc
operator|->
name|sc_bh
argument_list|,
operator|&
name|rev
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|E_OK
condition|)
goto|goto
name|err
goto|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Hardware version: %d.%d.\n"
argument_list|,
name|rev
operator|.
name|majorRev
argument_list|,
name|rev
operator|.
name|minorRev
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|err
label|:
name|bman_detach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
end_function

begin_function
name|int
name|bman_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|bman_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_bh
operator|!=
name|NULL
condition|)
name|BM_Free
argument_list|(
name|sc
operator|->
name|sc_bh
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_ires
operator|!=
name|NULL
condition|)
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
name|sc
operator|->
name|sc_irid
argument_list|,
name|sc
operator|->
name|sc_ires
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_rres
operator|!=
name|NULL
condition|)
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|sc
operator|->
name|sc_rrid
argument_list|,
name|sc
operator|->
name|sc_rres
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|bman_suspend
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|bman_resume
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|bman_shutdown
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * BMAN API  */
end_comment

begin_function
name|t_Handle
name|bman_pool_create
parameter_list|(
name|uint8_t
modifier|*
name|bpid
parameter_list|,
name|uint16_t
name|bufferSize
parameter_list|,
name|uint16_t
name|maxBuffers
parameter_list|,
name|uint16_t
name|minBuffers
parameter_list|,
name|uint16_t
name|allocBuffers
parameter_list|,
name|t_GetBufFunction
modifier|*
name|f_GetBuf
parameter_list|,
name|t_PutBufFunction
modifier|*
name|f_PutBuf
parameter_list|,
name|uint32_t
name|dep_sw_entry
parameter_list|,
name|uint32_t
name|dep_sw_exit
parameter_list|,
name|uint32_t
name|dep_hw_entry
parameter_list|,
name|uint32_t
name|dep_hw_exit
parameter_list|,
name|t_BmDepletionCallback
modifier|*
name|f_Depletion
parameter_list|,
name|t_Handle
name|h_BufferPool
parameter_list|,
name|t_PhysToVirt
modifier|*
name|f_PhysToVirt
parameter_list|,
name|t_VirtToPhys
modifier|*
name|f_VirtToPhys
parameter_list|)
block|{
name|uint32_t
name|thresholds
index|[
name|MAX_DEPLETION_THRESHOLDS
index|]
decl_stmt|;
name|struct
name|bman_softc
modifier|*
name|sc
decl_stmt|;
name|t_Handle
name|pool
decl_stmt|,
name|portal
decl_stmt|;
name|t_BmPoolParam
name|bpp
decl_stmt|;
name|int
name|error
decl_stmt|;
name|sc
operator|=
name|bman_sc
expr_stmt|;
name|pool
operator|=
name|NULL
expr_stmt|;
name|sched_pin
argument_list|()
expr_stmt|;
name|portal
operator|=
name|bman_portal_setup
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|portal
operator|==
name|NULL
condition|)
goto|goto
name|err
goto|;
name|memset
argument_list|(
operator|&
name|bpp
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|bpp
argument_list|)
argument_list|)
expr_stmt|;
name|bpp
operator|.
name|h_Bm
operator|=
name|sc
operator|->
name|sc_bh
expr_stmt|;
name|bpp
operator|.
name|h_BmPortal
operator|=
name|portal
expr_stmt|;
name|bpp
operator|.
name|h_App
operator|=
name|h_BufferPool
expr_stmt|;
name|bpp
operator|.
name|numOfBuffers
operator|=
name|allocBuffers
expr_stmt|;
name|bpp
operator|.
name|bufferPoolInfo
operator|.
name|h_BufferPool
operator|=
name|h_BufferPool
expr_stmt|;
name|bpp
operator|.
name|bufferPoolInfo
operator|.
name|f_GetBuf
operator|=
name|f_GetBuf
expr_stmt|;
name|bpp
operator|.
name|bufferPoolInfo
operator|.
name|f_PutBuf
operator|=
name|f_PutBuf
expr_stmt|;
name|bpp
operator|.
name|bufferPoolInfo
operator|.
name|f_PhysToVirt
operator|=
name|f_PhysToVirt
expr_stmt|;
name|bpp
operator|.
name|bufferPoolInfo
operator|.
name|f_VirtToPhys
operator|=
name|f_VirtToPhys
expr_stmt|;
name|bpp
operator|.
name|bufferPoolInfo
operator|.
name|bufferSize
operator|=
name|bufferSize
expr_stmt|;
name|pool
operator|=
name|BM_POOL_Config
argument_list|(
operator|&
name|bpp
argument_list|)
expr_stmt|;
if|if
condition|(
name|pool
operator|==
name|NULL
condition|)
goto|goto
name|err
goto|;
comment|/* 	 * Buffer context must be disabled on FreeBSD 	 * as it could cause memory corruption. 	 */
name|BM_POOL_ConfigBuffContextMode
argument_list|(
name|pool
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|minBuffers
operator|!=
literal|0
operator|||
name|maxBuffers
operator|!=
literal|0
condition|)
block|{
name|error
operator|=
name|BM_POOL_ConfigStockpile
argument_list|(
name|pool
argument_list|,
name|maxBuffers
argument_list|,
name|minBuffers
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|E_OK
condition|)
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|f_Depletion
operator|!=
name|NULL
condition|)
block|{
name|thresholds
index|[
name|BM_POOL_DEP_THRESH_SW_ENTRY
index|]
operator|=
name|dep_sw_entry
expr_stmt|;
name|thresholds
index|[
name|BM_POOL_DEP_THRESH_SW_EXIT
index|]
operator|=
name|dep_sw_exit
expr_stmt|;
name|thresholds
index|[
name|BM_POOL_DEP_THRESH_HW_ENTRY
index|]
operator|=
name|dep_hw_entry
expr_stmt|;
name|thresholds
index|[
name|BM_POOL_DEP_THRESH_HW_EXIT
index|]
operator|=
name|dep_hw_exit
expr_stmt|;
name|error
operator|=
name|BM_POOL_ConfigDepletion
argument_list|(
name|pool
argument_list|,
name|f_Depletion
argument_list|,
name|thresholds
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|E_OK
condition|)
goto|goto
name|err
goto|;
block|}
name|error
operator|=
name|BM_POOL_Init
argument_list|(
name|pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|E_OK
condition|)
goto|goto
name|err
goto|;
operator|*
name|bpid
operator|=
name|BM_POOL_GetId
argument_list|(
name|pool
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_bpool_cpu
index|[
operator|*
name|bpid
index|]
operator|=
name|PCPU_GET
argument_list|(
name|cpuid
argument_list|)
expr_stmt|;
name|sched_unpin
argument_list|()
expr_stmt|;
return|return
operator|(
name|pool
operator|)
return|;
name|err
label|:
if|if
condition|(
name|pool
operator|!=
name|NULL
condition|)
name|BM_POOL_Free
argument_list|(
name|pool
argument_list|)
expr_stmt|;
name|sched_unpin
argument_list|()
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_function
name|int
name|bman_pool_destroy
parameter_list|(
name|t_Handle
name|pool
parameter_list|)
block|{
name|struct
name|bman_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|bman_sc
expr_stmt|;
name|thread_lock
argument_list|(
name|curthread
argument_list|)
expr_stmt|;
name|sched_bind
argument_list|(
name|curthread
argument_list|,
name|sc
operator|->
name|sc_bpool_cpu
index|[
name|BM_POOL_GetId
argument_list|(
name|pool
argument_list|)
index|]
argument_list|)
expr_stmt|;
name|thread_unlock
argument_list|(
name|curthread
argument_list|)
expr_stmt|;
name|BM_POOL_Free
argument_list|(
name|pool
argument_list|)
expr_stmt|;
name|thread_lock
argument_list|(
name|curthread
argument_list|)
expr_stmt|;
name|sched_unbind
argument_list|(
name|curthread
argument_list|)
expr_stmt|;
name|thread_unlock
argument_list|(
name|curthread
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|bman_pool_fill
parameter_list|(
name|t_Handle
name|pool
parameter_list|,
name|uint16_t
name|nbufs
parameter_list|)
block|{
name|struct
name|bman_softc
modifier|*
name|sc
decl_stmt|;
name|t_Handle
name|portal
decl_stmt|;
name|int
name|error
decl_stmt|;
name|sc
operator|=
name|bman_sc
expr_stmt|;
name|sched_pin
argument_list|()
expr_stmt|;
name|portal
operator|=
name|bman_portal_setup
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|portal
operator|==
name|NULL
condition|)
block|{
name|sched_unpin
argument_list|()
expr_stmt|;
return|return
operator|(
name|EIO
operator|)
return|;
block|}
name|error
operator|=
name|BM_POOL_FillBufs
argument_list|(
name|pool
argument_list|,
name|portal
argument_list|,
name|nbufs
argument_list|)
expr_stmt|;
name|sched_unpin
argument_list|()
expr_stmt|;
return|return
operator|(
operator|(
name|error
operator|==
name|E_OK
operator|)
condition|?
literal|0
else|:
name|EIO
operator|)
return|;
block|}
end_function

begin_function
name|void
modifier|*
name|bman_get_buffer
parameter_list|(
name|t_Handle
name|pool
parameter_list|)
block|{
name|struct
name|bman_softc
modifier|*
name|sc
decl_stmt|;
name|t_Handle
name|portal
decl_stmt|;
name|void
modifier|*
name|buffer
decl_stmt|;
name|sc
operator|=
name|bman_sc
expr_stmt|;
name|sched_pin
argument_list|()
expr_stmt|;
name|portal
operator|=
name|bman_portal_setup
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|portal
operator|==
name|NULL
condition|)
block|{
name|sched_unpin
argument_list|()
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|buffer
operator|=
name|BM_POOL_GetBuf
argument_list|(
name|pool
argument_list|,
name|portal
argument_list|)
expr_stmt|;
name|sched_unpin
argument_list|()
expr_stmt|;
return|return
operator|(
name|buffer
operator|)
return|;
block|}
end_function

begin_function
name|int
name|bman_put_buffer
parameter_list|(
name|t_Handle
name|pool
parameter_list|,
name|void
modifier|*
name|buffer
parameter_list|)
block|{
name|struct
name|bman_softc
modifier|*
name|sc
decl_stmt|;
name|t_Handle
name|portal
decl_stmt|;
name|int
name|error
decl_stmt|;
name|sc
operator|=
name|bman_sc
expr_stmt|;
name|sched_pin
argument_list|()
expr_stmt|;
name|portal
operator|=
name|bman_portal_setup
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|portal
operator|==
name|NULL
condition|)
block|{
name|sched_unpin
argument_list|()
expr_stmt|;
return|return
operator|(
name|EIO
operator|)
return|;
block|}
name|error
operator|=
name|BM_POOL_PutBuf
argument_list|(
name|pool
argument_list|,
name|portal
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
name|sched_unpin
argument_list|()
expr_stmt|;
return|return
operator|(
operator|(
name|error
operator|==
name|E_OK
operator|)
condition|?
literal|0
else|:
name|EIO
operator|)
return|;
block|}
end_function

begin_function
name|uint32_t
name|bman_count
parameter_list|(
name|t_Handle
name|pool
parameter_list|)
block|{
return|return
operator|(
name|BM_POOL_GetCounter
argument_list|(
name|pool
argument_list|,
name|e_BM_POOL_COUNTERS_CONTENT
argument_list|)
operator|)
return|;
block|}
end_function

end_unit


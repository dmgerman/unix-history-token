begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2012 Semihalf.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_include
include|#
directive|include
file|<net/ethernet.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_dl.h>
end_include

begin_include
include|#
directive|include
file|<net/if_media.h>
end_include

begin_include
include|#
directive|include
file|<net/if_types.h>
end_include

begin_include
include|#
directive|include
file|<net/if_arp.h>
end_include

begin_include
include|#
directive|include
file|<dev/mii/mii.h>
end_include

begin_include
include|#
directive|include
file|<dev/mii/miivar.h>
end_include

begin_include
include|#
directive|include
file|"miibus_if.h"
end_include

begin_include
include|#
directive|include
file|<contrib/ncsw/inc/integrations/dpaa_integration_ext.h>
end_include

begin_include
include|#
directive|include
file|<contrib/ncsw/inc/Peripherals/fm_mac_ext.h>
end_include

begin_include
include|#
directive|include
file|<contrib/ncsw/inc/Peripherals/fm_port_ext.h>
end_include

begin_include
include|#
directive|include
file|<contrib/ncsw/inc/xx_ext.h>
end_include

begin_include
include|#
directive|include
file|"fman.h"
end_include

begin_include
include|#
directive|include
file|"if_dtsec.h"
end_include

begin_include
include|#
directive|include
file|"if_dtsec_im.h"
end_include

begin_comment
comment|/**  * @group dTSEC FMan PORT routines.  * @{  */
end_comment

begin_function
specifier|static
name|e_RxStoreResponse
name|dtsec_im_fm_port_rx_callback
parameter_list|(
name|t_Handle
name|app
parameter_list|,
name|uint8_t
modifier|*
name|data
parameter_list|,
name|uint16_t
name|length
parameter_list|,
name|uint16_t
name|status
parameter_list|,
name|uint8_t
name|position
parameter_list|,
name|t_Handle
name|buf_context
parameter_list|)
block|{
name|struct
name|dtsec_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
comment|/* TODO STATUS / Position checking */
name|sc
operator|=
name|app
expr_stmt|;
name|m
operator|=
name|m_devget
argument_list|(
name|data
argument_list|,
name|length
argument_list|,
literal|0
argument_list|,
name|sc
operator|->
name|sc_ifnet
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
condition|)
call|(
modifier|*
name|sc
operator|->
name|sc_ifnet
operator|->
name|if_input
call|)
argument_list|(
name|sc
operator|->
name|sc_ifnet
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|XX_FreeSmart
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
operator|(
name|e_RX_STORE_RESPONSE_CONTINUE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|dtsec_im_fm_port_tx_conf_callback
parameter_list|(
name|t_Handle
name|app
parameter_list|,
name|uint8_t
modifier|*
name|data
parameter_list|,
name|uint16_t
name|status
parameter_list|,
name|t_Handle
name|buf_context
parameter_list|)
block|{
comment|/* TODO: Check status */
name|XX_FreeSmart
argument_list|(
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|uint8_t
modifier|*
name|dtsec_im_fm_port_rx_get_buf
parameter_list|(
name|t_Handle
name|buffer_pool
parameter_list|,
name|t_Handle
modifier|*
name|buf_context_handle
parameter_list|)
block|{
name|struct
name|dtsec_softc
modifier|*
name|sc
decl_stmt|;
name|uint8_t
modifier|*
name|buffer
decl_stmt|;
name|sc
operator|=
name|buffer_pool
expr_stmt|;
name|buffer
operator|=
name|XX_MallocSmart
argument_list|(
name|FM_PORT_BUFFER_SIZE
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|buffer
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"couldn't allocate RX buffer.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|buffer
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|t_Error
name|dtsec_im_fm_port_rx_put_buf
parameter_list|(
name|t_Handle
name|buffer_pool
parameter_list|,
name|uint8_t
modifier|*
name|buffer
parameter_list|,
name|t_Handle
name|buf_context
parameter_list|)
block|{
name|XX_FreeSmart
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
return|return
operator|(
name|E_OK
operator|)
return|;
block|}
end_function

begin_function
name|int
name|dtsec_im_fm_port_rx_init
parameter_list|(
name|struct
name|dtsec_softc
modifier|*
name|sc
parameter_list|,
name|int
name|unit
parameter_list|)
block|{
name|t_FmPortParams
name|params
decl_stmt|;
name|t_BufferPoolInfo
modifier|*
name|pool_params
decl_stmt|;
name|t_FmPortImRxTxParams
modifier|*
name|im_params
decl_stmt|;
name|t_Error
name|error
decl_stmt|;
name|memset
argument_list|(
operator|&
name|params
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|params
argument_list|)
argument_list|)
expr_stmt|;
name|params
operator|.
name|baseAddr
operator|=
name|sc
operator|->
name|sc_fm_base
operator|+
name|sc
operator|->
name|sc_port_rx_hw_id
expr_stmt|;
name|params
operator|.
name|h_Fm
operator|=
name|sc
operator|->
name|sc_fmh
expr_stmt|;
name|params
operator|.
name|portType
operator|=
name|dtsec_fm_port_rx_type
argument_list|(
name|sc
operator|->
name|sc_eth_dev_type
argument_list|)
expr_stmt|;
name|params
operator|.
name|portId
operator|=
name|sc
operator|->
name|sc_eth_id
expr_stmt|;
name|params
operator|.
name|independentModeEnable
operator|=
name|TRUE
expr_stmt|;
name|params
operator|.
name|liodnBase
operator|=
name|FM_PORT_LIODN_BASE
expr_stmt|;
name|params
operator|.
name|f_Exception
operator|=
name|dtsec_fm_port_rx_exception_callback
expr_stmt|;
name|params
operator|.
name|h_App
operator|=
name|sc
expr_stmt|;
name|im_params
operator|=
operator|&
name|params
operator|.
name|specificParams
operator|.
name|imRxTxParams
expr_stmt|;
name|im_params
operator|->
name|h_FmMuram
operator|=
name|sc
operator|->
name|sc_muramh
expr_stmt|;
name|im_params
operator|->
name|liodnOffset
operator|=
name|FM_PORT_LIODN_OFFSET
expr_stmt|;
name|im_params
operator|->
name|dataMemId
operator|=
name|FM_PORT_MEM_ID
expr_stmt|;
name|im_params
operator|->
name|dataMemAttributes
operator|=
name|FM_PORT_MEM_ATTR
expr_stmt|;
name|im_params
operator|->
name|f_RxStore
operator|=
name|dtsec_im_fm_port_rx_callback
expr_stmt|;
name|pool_params
operator|=
operator|&
name|params
operator|.
name|specificParams
operator|.
name|imRxTxParams
operator|.
name|rxPoolParams
expr_stmt|;
name|pool_params
operator|->
name|h_BufferPool
operator|=
name|sc
expr_stmt|;
name|pool_params
operator|->
name|f_GetBuf
operator|=
name|dtsec_im_fm_port_rx_get_buf
expr_stmt|;
name|pool_params
operator|->
name|f_PutBuf
operator|=
name|dtsec_im_fm_port_rx_put_buf
expr_stmt|;
name|pool_params
operator|->
name|bufferSize
operator|=
name|FM_PORT_BUFFER_SIZE
expr_stmt|;
name|sc
operator|->
name|sc_rxph
operator|=
name|FM_PORT_Config
argument_list|(
operator|&
name|params
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_rxph
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"couldn't configure FM Port RX.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|error
operator|=
name|FM_PORT_Init
argument_list|(
name|sc
operator|->
name|sc_rxph
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|E_OK
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"couldn't initialize FM Port RX.\n"
argument_list|)
expr_stmt|;
name|FM_PORT_Free
argument_list|(
name|sc
operator|->
name|sc_rxph
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
if|if
condition|(
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"RX hw port 0x%02x initialized.\n"
argument_list|,
name|sc
operator|->
name|sc_port_rx_hw_id
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|dtsec_im_fm_port_tx_init
parameter_list|(
name|struct
name|dtsec_softc
modifier|*
name|sc
parameter_list|,
name|int
name|unit
parameter_list|)
block|{
name|t_FmPortParams
name|params
decl_stmt|;
name|t_FmPortImRxTxParams
modifier|*
name|im_params
decl_stmt|;
name|t_Error
name|error
decl_stmt|;
name|memset
argument_list|(
operator|&
name|params
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|params
argument_list|)
argument_list|)
expr_stmt|;
name|params
operator|.
name|baseAddr
operator|=
name|sc
operator|->
name|sc_fm_base
operator|+
name|sc
operator|->
name|sc_port_tx_hw_id
expr_stmt|;
name|params
operator|.
name|h_Fm
operator|=
name|sc
operator|->
name|sc_fmh
expr_stmt|;
name|params
operator|.
name|portType
operator|=
name|dtsec_fm_port_tx_type
argument_list|(
name|sc
operator|->
name|sc_eth_dev_type
argument_list|)
expr_stmt|;
name|params
operator|.
name|portId
operator|=
name|unit
expr_stmt|;
name|params
operator|.
name|independentModeEnable
operator|=
name|TRUE
expr_stmt|;
name|params
operator|.
name|liodnBase
operator|=
name|FM_PORT_LIODN_BASE
expr_stmt|;
name|params
operator|.
name|f_Exception
operator|=
name|dtsec_fm_port_tx_exception_callback
expr_stmt|;
name|params
operator|.
name|h_App
operator|=
name|sc
expr_stmt|;
name|im_params
operator|=
operator|&
name|params
operator|.
name|specificParams
operator|.
name|imRxTxParams
expr_stmt|;
name|im_params
operator|->
name|h_FmMuram
operator|=
name|sc
operator|->
name|sc_muramh
expr_stmt|;
name|im_params
operator|->
name|liodnOffset
operator|=
name|FM_PORT_LIODN_OFFSET
expr_stmt|;
name|im_params
operator|->
name|dataMemId
operator|=
name|FM_PORT_MEM_ID
expr_stmt|;
name|im_params
operator|->
name|dataMemAttributes
operator|=
name|FM_PORT_MEM_ATTR
expr_stmt|;
name|im_params
operator|->
name|f_TxConf
operator|=
name|dtsec_im_fm_port_tx_conf_callback
expr_stmt|;
name|sc
operator|->
name|sc_txph
operator|=
name|FM_PORT_Config
argument_list|(
operator|&
name|params
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_txph
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"couldn't configure FM Port TX.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|error
operator|=
name|FM_PORT_Init
argument_list|(
name|sc
operator|->
name|sc_txph
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|E_OK
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"couldn't initialize FM Port TX.\n"
argument_list|)
expr_stmt|;
name|FM_PORT_Free
argument_list|(
name|sc
operator|->
name|sc_txph
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
if|if
condition|(
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"TX hw port 0x%02x initialized.\n"
argument_list|,
name|sc
operator|->
name|sc_port_tx_hw_id
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/** @} */
end_comment

begin_comment
comment|/**  * @group dTSEC IFnet routines.  * @{  */
end_comment

begin_function
name|void
name|dtsec_im_if_start_locked
parameter_list|(
name|struct
name|dtsec_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint8_t
modifier|*
name|buffer
decl_stmt|;
name|uint16_t
name|length
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|int
name|error
decl_stmt|;
name|DTSEC_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* TODO: IFF_DRV_OACTIVE */
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_mii
operator|->
name|mii_media_status
operator|&
name|IFM_ACTIVE
operator|)
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_ifnet
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
operator|!=
name|IFF_DRV_RUNNING
condition|)
return|return;
while|while
condition|(
operator|!
name|IFQ_DRV_IS_EMPTY
argument_list|(
operator|&
name|sc
operator|->
name|sc_ifnet
operator|->
name|if_snd
argument_list|)
condition|)
block|{
name|IFQ_DRV_DEQUEUE
argument_list|(
operator|&
name|sc
operator|->
name|sc_ifnet
operator|->
name|if_snd
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
break|break;
name|length
operator|=
name|m_length
argument_list|(
name|m
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|buffer
operator|=
name|XX_MallocSmart
argument_list|(
name|length
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|buffer
condition|)
block|{
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
break|break;
block|}
name|m_copydata
argument_list|(
name|m
argument_list|,
literal|0
argument_list|,
name|length
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|error
operator|=
name|FM_PORT_ImTx
argument_list|(
name|sc
operator|->
name|sc_txph
argument_list|,
name|buffer
argument_list|,
name|length
argument_list|,
name|TRUE
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|E_OK
condition|)
block|{
comment|/* TODO: Ring full */
name|XX_FreeSmart
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
end_function

begin_comment
comment|/** @} */
end_comment

end_unit


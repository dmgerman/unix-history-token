begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Cronyx-Sigma Driver Development Kit.  *  * Copyright (C) 1998 Cronyx Engineering.  * Author: Pavel Novikov,<pavel@inr.net.kiae.su>  *  * Copyright (C) 1998-2003 Cronyx Engineering.  * Author: Roman Kurakin,<rik@cronyx.ru>  *  * This software is distributed with NO WARRANTIES, not even the implied  * warranties for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  *  * Authors grant any other persons or organisations permission to use  * or modify this software as long as this message is kept with the software,  * all derivative works or modified versions.  *  * Cronyx Id: cxddk.c,v 1.1.2.2 2003/11/27 14:24:50 rik Exp $  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/cx/machdep.h>
end_include

begin_include
include|#
directive|include
file|<dev/cx/cxddk.h>
end_include

begin_include
include|#
directive|include
file|<dev/cx/cxreg.h>
end_include

begin_include
include|#
directive|include
file|<dev/cx/cronyxfw.h>
end_include

begin_include
include|#
directive|include
file|<dev/cx/csigmafw.h>
end_include

begin_define
define|#
directive|define
name|BYTE
value|*(unsigned char*)&
end_define

begin_comment
comment|/* standard base port set */
end_comment

begin_decl_stmt
specifier|static
name|short
name|porttab
index|[]
init|=
block|{
literal|0x200
block|,
literal|0x220
block|,
literal|0x240
block|,
literal|0x260
block|,
literal|0x280
block|,
literal|0x2a0
block|,
literal|0x2c0
block|,
literal|0x2e0
block|,
literal|0x300
block|,
literal|0x320
block|,
literal|0x340
block|,
literal|0x360
block|,
literal|0x380
block|,
literal|0x3a0
block|,
literal|0x3c0
block|,
literal|0x3e0
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Compute the optimal size of the receive buffer.  */
end_comment

begin_function
specifier|static
name|int
name|cx_compute_buf_len
parameter_list|(
name|cx_chan_t
modifier|*
name|c
parameter_list|)
block|{
name|int
name|rbsz
decl_stmt|;
if|if
condition|(
name|c
operator|->
name|mode
operator|==
name|M_ASYNC
condition|)
block|{
name|rbsz
operator|=
operator|(
name|c
operator|->
name|rxbaud
operator|+
literal|800
operator|-
literal|1
operator|)
operator|/
literal|800
operator|*
literal|2
expr_stmt|;
if|if
condition|(
name|rbsz
operator|<
literal|4
condition|)
name|rbsz
operator|=
literal|4
expr_stmt|;
elseif|else
if|if
condition|(
name|rbsz
operator|>
name|DMABUFSZ
condition|)
name|rbsz
operator|=
name|DMABUFSZ
expr_stmt|;
block|}
else|else
name|rbsz
operator|=
name|DMABUFSZ
expr_stmt|;
return|return
name|rbsz
return|;
block|}
end_function

begin_comment
comment|/*  * Auto-detect the installed adapters.  */
end_comment

begin_function
name|int
name|cx_find
parameter_list|(
name|port_t
modifier|*
name|board_ports
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|n
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|n
operator|=
literal|0
init|;
name|porttab
index|[
name|i
index|]
operator|&&
name|n
operator|<
name|NBRD
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|cx_probe_board
argument_list|(
name|porttab
index|[
name|i
index|]
argument_list|,
operator|-
literal|1
argument_list|,
operator|-
literal|1
argument_list|)
condition|)
name|board_ports
index|[
name|n
operator|++
index|]
operator|=
name|porttab
index|[
name|i
index|]
expr_stmt|;
return|return
name|n
return|;
block|}
end_function

begin_comment
comment|/*  * Initialize the adapter.  */
end_comment

begin_function
name|int
name|cx_open_board
parameter_list|(
name|cx_board_t
modifier|*
name|b
parameter_list|,
name|int
name|num
parameter_list|,
name|port_t
name|port
parameter_list|,
name|int
name|irq
parameter_list|,
name|int
name|dma
parameter_list|)
block|{
name|cx_chan_t
modifier|*
name|c
decl_stmt|;
if|if
condition|(
name|num
operator|>=
name|NBRD
operator|||
operator|!
name|cx_probe_board
argument_list|(
name|port
argument_list|,
name|irq
argument_list|,
name|dma
argument_list|)
condition|)
return|return
literal|0
return|;
comment|/* init callback pointers */
for|for
control|(
name|c
operator|=
name|b
operator|->
name|chan
init|;
name|c
operator|<
name|b
operator|->
name|chan
operator|+
name|NCHAN
condition|;
operator|++
name|c
control|)
block|{
name|c
operator|->
name|call_on_tx
operator|=
literal|0
expr_stmt|;
name|c
operator|->
name|call_on_rx
operator|=
literal|0
expr_stmt|;
name|c
operator|->
name|call_on_msig
operator|=
literal|0
expr_stmt|;
name|c
operator|->
name|call_on_err
operator|=
literal|0
expr_stmt|;
block|}
name|cx_init
argument_list|(
name|b
argument_list|,
name|num
argument_list|,
name|port
argument_list|,
name|irq
argument_list|,
name|dma
argument_list|)
expr_stmt|;
comment|/* Loading firmware */
if|if
condition|(
operator|!
name|cx_setup_board
argument_list|(
name|b
argument_list|,
name|csigma_fw_data
argument_list|,
name|csigma_fw_len
argument_list|,
name|csigma_fw_tvec
argument_list|)
condition|)
return|return
literal|0
return|;
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/*  * Shutdown the adapter.  */
end_comment

begin_function
name|void
name|cx_close_board
parameter_list|(
name|cx_board_t
modifier|*
name|b
parameter_list|)
block|{
name|cx_setup_board
argument_list|(
name|b
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Reset the controller. */
name|outb
argument_list|(
name|BCR0
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|b
operator|->
name|chan
index|[
literal|8
index|]
operator|.
name|type
operator|||
name|b
operator|->
name|chan
index|[
literal|12
index|]
operator|.
name|type
condition|)
name|outb
argument_list|(
name|BCR0
argument_list|(
name|b
operator|->
name|port
operator|+
literal|0x10
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Start the channel.  */
end_comment

begin_function
name|void
name|cx_start_chan
parameter_list|(
name|cx_chan_t
modifier|*
name|c
parameter_list|,
name|cx_buf_t
modifier|*
name|cb
parameter_list|,
name|unsigned
name|long
name|phys
parameter_list|)
block|{
name|int
name|command
init|=
literal|0
decl_stmt|;
name|int
name|mode
init|=
literal|0
decl_stmt|;
name|int
name|ier
init|=
literal|0
decl_stmt|;
name|int
name|rbsz
decl_stmt|;
name|c
operator|->
name|overflow
operator|=
literal|0
expr_stmt|;
comment|/* Setting up buffers */
if|if
condition|(
name|cb
condition|)
block|{
name|c
operator|->
name|arbuf
operator|=
name|cb
operator|->
name|rbuffer
index|[
literal|0
index|]
expr_stmt|;
name|c
operator|->
name|brbuf
operator|=
name|cb
operator|->
name|rbuffer
index|[
literal|1
index|]
expr_stmt|;
name|c
operator|->
name|atbuf
operator|=
name|cb
operator|->
name|tbuffer
index|[
literal|0
index|]
expr_stmt|;
name|c
operator|->
name|btbuf
operator|=
name|cb
operator|->
name|tbuffer
index|[
literal|1
index|]
expr_stmt|;
name|c
operator|->
name|arphys
operator|=
name|phys
operator|+
operator|(
operator|(
name|char
operator|*
operator|)
name|c
operator|->
name|arbuf
operator|-
operator|(
name|char
operator|*
operator|)
name|cb
operator|)
expr_stmt|;
name|c
operator|->
name|brphys
operator|=
name|phys
operator|+
operator|(
operator|(
name|char
operator|*
operator|)
name|c
operator|->
name|brbuf
operator|-
operator|(
name|char
operator|*
operator|)
name|cb
operator|)
expr_stmt|;
name|c
operator|->
name|atphys
operator|=
name|phys
operator|+
operator|(
operator|(
name|char
operator|*
operator|)
name|c
operator|->
name|atbuf
operator|-
operator|(
name|char
operator|*
operator|)
name|cb
operator|)
expr_stmt|;
name|c
operator|->
name|btphys
operator|=
name|phys
operator|+
operator|(
operator|(
name|char
operator|*
operator|)
name|c
operator|->
name|btbuf
operator|-
operator|(
name|char
operator|*
operator|)
name|cb
operator|)
expr_stmt|;
block|}
comment|/* Set current channel number */
name|outb
argument_list|(
name|CAR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|num
operator|&
literal|3
argument_list|)
expr_stmt|;
comment|/* set receiver A buffer physical address */
name|outw
argument_list|(
name|ARBADRU
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
call|(
name|unsigned
name|short
call|)
argument_list|(
name|c
operator|->
name|arphys
operator|>>
literal|16
argument_list|)
argument_list|)
expr_stmt|;
name|outw
argument_list|(
name|ARBADRL
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
operator|(
name|unsigned
name|short
operator|)
name|c
operator|->
name|arphys
argument_list|)
expr_stmt|;
comment|/* set receiver B buffer physical address */
name|outw
argument_list|(
name|BRBADRU
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
call|(
name|unsigned
name|short
call|)
argument_list|(
name|c
operator|->
name|brphys
operator|>>
literal|16
argument_list|)
argument_list|)
expr_stmt|;
name|outw
argument_list|(
name|BRBADRL
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
operator|(
name|unsigned
name|short
operator|)
name|c
operator|->
name|brphys
argument_list|)
expr_stmt|;
comment|/* set transmitter A buffer physical address */
name|outw
argument_list|(
name|ATBADRU
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
call|(
name|unsigned
name|short
call|)
argument_list|(
name|c
operator|->
name|atphys
operator|>>
literal|16
argument_list|)
argument_list|)
expr_stmt|;
name|outw
argument_list|(
name|ATBADRL
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
operator|(
name|unsigned
name|short
operator|)
name|c
operator|->
name|atphys
argument_list|)
expr_stmt|;
comment|/* set transmitter B buffer physical address */
name|outw
argument_list|(
name|BTBADRU
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
call|(
name|unsigned
name|short
call|)
argument_list|(
name|c
operator|->
name|btphys
operator|>>
literal|16
argument_list|)
argument_list|)
expr_stmt|;
name|outw
argument_list|(
name|BTBADRL
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
operator|(
name|unsigned
name|short
operator|)
name|c
operator|->
name|btphys
argument_list|)
expr_stmt|;
comment|/* rx */
name|command
operator||=
name|CCR_ENRX
expr_stmt|;
name|ier
operator||=
name|IER_RXD
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|board
operator|->
name|dma
condition|)
block|{
name|mode
operator||=
name|CMR_RXDMA
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|mode
operator|==
name|M_ASYNC
condition|)
name|ier
operator||=
name|IER_RET
expr_stmt|;
block|}
comment|/* tx */
name|command
operator||=
name|CCR_ENTX
expr_stmt|;
name|ier
operator||=
operator|(
name|c
operator|->
name|mode
operator|==
name|M_ASYNC
operator|)
condition|?
name|IER_TXD
else|:
operator|(
name|IER_TXD
operator||
name|IER_TXMPTY
operator|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|board
operator|->
name|dma
condition|)
name|mode
operator||=
name|CMR_TXDMA
expr_stmt|;
comment|/* Set mode */
name|outb
argument_list|(
name|CMR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|mode
operator||
operator|(
name|c
operator|->
name|mode
operator|==
name|M_ASYNC
condition|?
name|CMR_ASYNC
else|:
name|CMR_HDLC
operator|)
argument_list|)
expr_stmt|;
comment|/* Clear and initialize channel */
name|cx_cmd
argument_list|(
name|c
operator|->
name|port
argument_list|,
name|CCR_CLRCH
argument_list|)
expr_stmt|;
name|cx_cmd
argument_list|(
name|c
operator|->
name|port
argument_list|,
name|CCR_INITCH
operator||
name|command
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|mode
operator|==
name|M_ASYNC
condition|)
name|cx_cmd
argument_list|(
name|c
operator|->
name|port
argument_list|,
name|CCR_ENTX
argument_list|)
expr_stmt|;
comment|/* Start receiver */
name|rbsz
operator|=
name|cx_compute_buf_len
argument_list|(
name|c
argument_list|)
expr_stmt|;
name|outw
argument_list|(
name|ARBCNT
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|rbsz
argument_list|)
expr_stmt|;
name|outw
argument_list|(
name|BRBCNT
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|rbsz
argument_list|)
expr_stmt|;
name|outw
argument_list|(
name|ARBSTS
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|BSTS_OWN24
argument_list|)
expr_stmt|;
name|outw
argument_list|(
name|BRBSTS
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|BSTS_OWN24
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|mode
operator|==
name|M_ASYNC
condition|)
name|ier
operator||=
name|IER_MDM
expr_stmt|;
comment|/* Enable interrupts */
name|outb
argument_list|(
name|IER
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|ier
argument_list|)
expr_stmt|;
comment|/* Clear DTR and RTS */
name|cx_set_dtr
argument_list|(
name|c
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|cx_set_rts
argument_list|(
name|c
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Turn the receiver on/off.  */
end_comment

begin_function
name|void
name|cx_enable_receive
parameter_list|(
name|cx_chan_t
modifier|*
name|c
parameter_list|,
name|int
name|on
parameter_list|)
block|{
name|unsigned
name|char
name|ier
decl_stmt|;
if|if
condition|(
name|cx_receive_enabled
argument_list|(
name|c
argument_list|)
operator|&&
operator|!
name|on
condition|)
block|{
name|outb
argument_list|(
name|CAR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|num
operator|&
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|mode
operator|==
name|M_ASYNC
condition|)
block|{
name|ier
operator|=
name|inb
argument_list|(
name|IER
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|IER
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|ier
operator|&
operator|~
operator|(
name|IER_RXD
operator||
name|IER_RET
operator|)
argument_list|)
expr_stmt|;
block|}
name|cx_cmd
argument_list|(
name|c
operator|->
name|port
argument_list|,
name|CCR_DISRX
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|cx_receive_enabled
argument_list|(
name|c
argument_list|)
operator|&&
name|on
condition|)
block|{
name|outb
argument_list|(
name|CAR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|num
operator|&
literal|3
argument_list|)
expr_stmt|;
name|ier
operator|=
name|inb
argument_list|(
name|IER
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|mode
operator|==
name|M_ASYNC
condition|)
name|outb
argument_list|(
name|IER
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|ier
operator||
operator|(
name|IER_RXD
operator||
name|IER_RET
operator|)
argument_list|)
expr_stmt|;
else|else
name|outb
argument_list|(
name|IER
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|ier
operator||
name|IER_RXD
argument_list|)
expr_stmt|;
name|cx_cmd
argument_list|(
name|c
operator|->
name|port
argument_list|,
name|CCR_ENRX
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Turn the transmiter on/off.  */
end_comment

begin_function
name|void
name|cx_enable_transmit
parameter_list|(
name|cx_chan_t
modifier|*
name|c
parameter_list|,
name|int
name|on
parameter_list|)
block|{
if|if
condition|(
name|cx_transmit_enabled
argument_list|(
name|c
argument_list|)
operator|&&
operator|!
name|on
condition|)
block|{
name|outb
argument_list|(
name|CAR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|num
operator|&
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|mode
operator|!=
name|M_ASYNC
condition|)
name|outb
argument_list|(
name|STCR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|STC_ABORTTX
operator||
name|STC_SNDSPC
argument_list|)
expr_stmt|;
name|cx_cmd
argument_list|(
name|c
operator|->
name|port
argument_list|,
name|CCR_DISTX
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|cx_transmit_enabled
argument_list|(
name|c
argument_list|)
operator|&&
name|on
condition|)
block|{
name|outb
argument_list|(
name|CAR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|num
operator|&
literal|3
argument_list|)
expr_stmt|;
name|cx_cmd
argument_list|(
name|c
operator|->
name|port
argument_list|,
name|CCR_ENTX
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Get channel status.  */
end_comment

begin_function
name|int
name|cx_receive_enabled
parameter_list|(
name|cx_chan_t
modifier|*
name|c
parameter_list|)
block|{
name|outb
argument_list|(
name|CAR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|num
operator|&
literal|3
argument_list|)
expr_stmt|;
return|return
operator|(
name|inb
argument_list|(
name|CSR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|)
operator|&
name|CSRA_RXEN
operator|)
operator|!=
literal|0
return|;
block|}
end_function

begin_function
name|int
name|cx_transmit_enabled
parameter_list|(
name|cx_chan_t
modifier|*
name|c
parameter_list|)
block|{
name|outb
argument_list|(
name|CAR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|num
operator|&
literal|3
argument_list|)
expr_stmt|;
return|return
operator|(
name|inb
argument_list|(
name|CSR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|)
operator|&
name|CSRA_TXEN
operator|)
operator|!=
literal|0
return|;
block|}
end_function

begin_function
name|unsigned
name|long
name|cx_get_baud
parameter_list|(
name|cx_chan_t
modifier|*
name|c
parameter_list|)
block|{
return|return
operator|(
name|c
operator|->
name|opt
operator|.
name|tcor
operator|.
name|clk
operator|==
name|CLK_EXT
operator|)
condition|?
literal|0
else|:
name|c
operator|->
name|txbaud
return|;
block|}
end_function

begin_function
name|int
name|cx_get_loop
parameter_list|(
name|cx_chan_t
modifier|*
name|c
parameter_list|)
block|{
return|return
name|c
operator|->
name|opt
operator|.
name|tcor
operator|.
name|llm
condition|?
literal|1
else|:
literal|0
return|;
block|}
end_function

begin_function
name|int
name|cx_get_nrzi
parameter_list|(
name|cx_chan_t
modifier|*
name|c
parameter_list|)
block|{
return|return
name|c
operator|->
name|opt
operator|.
name|rcor
operator|.
name|encod
operator|==
name|ENCOD_NRZI
return|;
block|}
end_function

begin_function
name|int
name|cx_get_dpll
parameter_list|(
name|cx_chan_t
modifier|*
name|c
parameter_list|)
block|{
return|return
name|c
operator|->
name|opt
operator|.
name|rcor
operator|.
name|dpll
condition|?
literal|1
else|:
literal|0
return|;
block|}
end_function

begin_function
name|void
name|cx_set_baud
parameter_list|(
name|cx_chan_t
modifier|*
name|c
parameter_list|,
name|unsigned
name|long
name|bps
parameter_list|)
block|{
name|int
name|clock
decl_stmt|,
name|period
decl_stmt|;
name|c
operator|->
name|txbaud
operator|=
name|c
operator|->
name|rxbaud
operator|=
name|bps
expr_stmt|;
comment|/* Set current channel number */
name|outb
argument_list|(
name|CAR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|num
operator|&
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
name|bps
condition|)
block|{
if|if
condition|(
name|c
operator|->
name|mode
operator|==
name|M_ASYNC
operator|||
name|c
operator|->
name|opt
operator|.
name|rcor
operator|.
name|dpll
operator|||
name|c
operator|->
name|opt
operator|.
name|tcor
operator|.
name|llm
condition|)
block|{
comment|/* Receive baud - internal */
name|cx_clock
argument_list|(
name|c
operator|->
name|oscfreq
argument_list|,
name|c
operator|->
name|rxbaud
argument_list|,
operator|&
name|clock
argument_list|,
operator|&
name|period
argument_list|)
expr_stmt|;
name|c
operator|->
name|opt
operator|.
name|rcor
operator|.
name|clk
operator|=
name|clock
expr_stmt|;
name|outb
argument_list|(
argument|RCOR(c->port)
argument_list|,
argument|BYTE c->opt.rcor
argument_list|)
empty_stmt|;
name|outb
argument_list|(
name|RBPR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|period
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Receive baud - external */
name|c
operator|->
name|opt
operator|.
name|rcor
operator|.
name|clk
operator|=
name|CLK_EXT
expr_stmt|;
name|outb
argument_list|(
argument|RCOR(c->port)
argument_list|,
argument|BYTE c->opt.rcor
argument_list|)
empty_stmt|;
name|outb
argument_list|(
name|RBPR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* Transmit baud - internal */
name|cx_clock
argument_list|(
name|c
operator|->
name|oscfreq
argument_list|,
name|c
operator|->
name|txbaud
argument_list|,
operator|&
name|clock
argument_list|,
operator|&
name|period
argument_list|)
expr_stmt|;
name|c
operator|->
name|opt
operator|.
name|tcor
operator|.
name|clk
operator|=
name|clock
expr_stmt|;
name|c
operator|->
name|opt
operator|.
name|tcor
operator|.
name|ext1x
operator|=
literal|0
expr_stmt|;
name|outb
argument_list|(
name|TBPR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|period
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|c
operator|->
name|mode
operator|!=
name|M_ASYNC
condition|)
block|{
comment|/* External clock - disable local loopback and DPLL */
name|c
operator|->
name|opt
operator|.
name|tcor
operator|.
name|llm
operator|=
literal|0
expr_stmt|;
name|c
operator|->
name|opt
operator|.
name|rcor
operator|.
name|dpll
operator|=
literal|0
expr_stmt|;
comment|/* Transmit baud - external */
name|c
operator|->
name|opt
operator|.
name|tcor
operator|.
name|ext1x
operator|=
literal|1
expr_stmt|;
name|c
operator|->
name|opt
operator|.
name|tcor
operator|.
name|clk
operator|=
name|CLK_EXT
expr_stmt|;
name|outb
argument_list|(
name|TBPR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* Receive baud - external */
name|c
operator|->
name|opt
operator|.
name|rcor
operator|.
name|clk
operator|=
name|CLK_EXT
expr_stmt|;
name|outb
argument_list|(
argument|RCOR(c->port)
argument_list|,
argument|BYTE c->opt.rcor
argument_list|)
empty_stmt|;
name|outb
argument_list|(
name|RBPR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|c
operator|->
name|opt
operator|.
name|tcor
operator|.
name|llm
condition|)
name|outb
argument_list|(
name|COR2
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
operator|(
name|BYTE
name|c
operator|->
name|hopt
operator|.
name|cor2
operator|)
operator|&
operator|~
literal|3
argument_list|)
expr_stmt|;
else|else
name|outb
argument_list|(
argument|COR2(c->port)
argument_list|,
argument|BYTE c->hopt.cor2
argument_list|)
empty_stmt|;
name|outb
argument_list|(
argument|TCOR(c->port)
argument_list|,
argument|BYTE c->opt.tcor
argument_list|)
empty_stmt|;
block|}
end_function

begin_function
name|void
name|cx_set_loop
parameter_list|(
name|cx_chan_t
modifier|*
name|c
parameter_list|,
name|int
name|on
parameter_list|)
block|{
if|if
condition|(
operator|!
name|c
operator|->
name|txbaud
condition|)
return|return;
name|c
operator|->
name|opt
operator|.
name|tcor
operator|.
name|llm
operator|=
name|on
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|cx_set_baud
argument_list|(
name|c
argument_list|,
name|c
operator|->
name|txbaud
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|cx_set_dpll
parameter_list|(
name|cx_chan_t
modifier|*
name|c
parameter_list|,
name|int
name|on
parameter_list|)
block|{
if|if
condition|(
operator|!
name|c
operator|->
name|txbaud
condition|)
return|return;
name|c
operator|->
name|opt
operator|.
name|rcor
operator|.
name|dpll
operator|=
name|on
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|cx_set_baud
argument_list|(
name|c
argument_list|,
name|c
operator|->
name|txbaud
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|cx_set_nrzi
parameter_list|(
name|cx_chan_t
modifier|*
name|c
parameter_list|,
name|int
name|nrzi
parameter_list|)
block|{
name|c
operator|->
name|opt
operator|.
name|rcor
operator|.
name|encod
operator|=
operator|(
name|nrzi
condition|?
name|ENCOD_NRZI
else|:
name|ENCOD_NRZ
operator|)
expr_stmt|;
name|outb
argument_list|(
name|CAR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|num
operator|&
literal|3
argument_list|)
expr_stmt|;
name|outb
argument_list|(
argument|RCOR(c->port)
argument_list|,
argument|BYTE c->opt.rcor
argument_list|)
empty_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|cx_send
parameter_list|(
name|cx_chan_t
modifier|*
name|c
parameter_list|,
name|char
modifier|*
name|data
parameter_list|,
name|int
name|len
parameter_list|,
name|void
modifier|*
name|attachment
parameter_list|)
block|{
name|unsigned
name|char
modifier|*
name|buf
decl_stmt|;
name|port_t
name|cnt_port
decl_stmt|,
name|sts_port
decl_stmt|;
name|void
modifier|*
modifier|*
name|attp
decl_stmt|;
comment|/* Set the current channel number. */
name|outb
argument_list|(
name|CAR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|num
operator|&
literal|3
argument_list|)
expr_stmt|;
comment|/* Determine the buffer order. */
if|if
condition|(
name|inb
argument_list|(
name|DMABSTS
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|)
operator|&
name|DMABSTS_NTBUF
condition|)
block|{
if|if
condition|(
name|inb
argument_list|(
name|BTBSTS
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|)
operator|&
name|BSTS_OWN24
condition|)
block|{
name|buf
operator|=
name|c
operator|->
name|atbuf
expr_stmt|;
name|cnt_port
operator|=
name|ATBCNT
argument_list|(
name|c
operator|->
name|port
argument_list|)
expr_stmt|;
name|sts_port
operator|=
name|ATBSTS
argument_list|(
name|c
operator|->
name|port
argument_list|)
expr_stmt|;
name|attp
operator|=
operator|&
name|c
operator|->
name|attach
index|[
literal|0
index|]
expr_stmt|;
block|}
else|else
block|{
name|buf
operator|=
name|c
operator|->
name|btbuf
expr_stmt|;
name|cnt_port
operator|=
name|BTBCNT
argument_list|(
name|c
operator|->
name|port
argument_list|)
expr_stmt|;
name|sts_port
operator|=
name|BTBSTS
argument_list|(
name|c
operator|->
name|port
argument_list|)
expr_stmt|;
name|attp
operator|=
operator|&
name|c
operator|->
name|attach
index|[
literal|1
index|]
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|inb
argument_list|(
name|ATBSTS
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|)
operator|&
name|BSTS_OWN24
condition|)
block|{
name|buf
operator|=
name|c
operator|->
name|btbuf
expr_stmt|;
name|cnt_port
operator|=
name|BTBCNT
argument_list|(
name|c
operator|->
name|port
argument_list|)
expr_stmt|;
name|sts_port
operator|=
name|BTBSTS
argument_list|(
name|c
operator|->
name|port
argument_list|)
expr_stmt|;
name|attp
operator|=
operator|&
name|c
operator|->
name|attach
index|[
literal|1
index|]
expr_stmt|;
block|}
else|else
block|{
name|buf
operator|=
name|c
operator|->
name|atbuf
expr_stmt|;
name|cnt_port
operator|=
name|ATBCNT
argument_list|(
name|c
operator|->
name|port
argument_list|)
expr_stmt|;
name|sts_port
operator|=
name|ATBSTS
argument_list|(
name|c
operator|->
name|port
argument_list|)
expr_stmt|;
name|attp
operator|=
operator|&
name|c
operator|->
name|attach
index|[
literal|0
index|]
expr_stmt|;
block|}
block|}
comment|/* Is it busy? */
if|if
condition|(
name|inb
argument_list|(
name|sts_port
argument_list|)
operator|&
name|BSTS_OWN24
condition|)
return|return
operator|-
literal|1
return|;
name|memcpy
argument_list|(
name|buf
argument_list|,
name|data
argument_list|,
name|len
argument_list|)
expr_stmt|;
operator|*
name|attp
operator|=
name|attachment
expr_stmt|;
comment|/* Start transmitter. */
name|outw
argument_list|(
name|cnt_port
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|sts_port
argument_list|,
name|BSTS_EOFR
operator||
name|BSTS_INTR
operator||
name|BSTS_OWN24
argument_list|)
expr_stmt|;
comment|/* Enable TXMPTY interrupt, 	 * to catch the case when the second buffer is empty. */
if|if
condition|(
name|c
operator|->
name|mode
operator|!=
name|M_ASYNC
condition|)
block|{
if|if
condition|(
operator|(
name|inb
argument_list|(
name|ATBSTS
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|)
operator|&
name|BSTS_OWN24
operator|)
operator|&&
operator|(
name|inb
argument_list|(
name|BTBSTS
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|)
operator|&
name|BSTS_OWN24
operator|)
condition|)
block|{
name|outb
argument_list|(
name|IER
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|IER_RXD
operator||
name|IER_TXD
operator||
name|IER_TXMPTY
argument_list|)
expr_stmt|;
block|}
else|else
name|outb
argument_list|(
name|IER
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|IER_RXD
operator||
name|IER_TXD
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Number of free buffs  */
end_comment

begin_function
name|int
name|cx_buf_free
parameter_list|(
name|cx_chan_t
modifier|*
name|c
parameter_list|)
block|{
return|return
operator|!
operator|(
name|inb
argument_list|(
name|ATBSTS
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|)
operator|&
name|BSTS_OWN24
operator|)
operator|+
operator|!
operator|(
name|inb
argument_list|(
name|BTBSTS
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|)
operator|&
name|BSTS_OWN24
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Send the data packet.  */
end_comment

begin_function
name|int
name|cx_send_packet
parameter_list|(
name|cx_chan_t
modifier|*
name|c
parameter_list|,
name|char
modifier|*
name|data
parameter_list|,
name|int
name|len
parameter_list|,
name|void
modifier|*
name|attachment
parameter_list|)
block|{
if|if
condition|(
name|len
operator|>=
name|DMABUFSZ
condition|)
return|return
operator|-
literal|2
return|;
if|if
condition|(
name|c
operator|->
name|mode
operator|==
name|M_ASYNC
condition|)
block|{
specifier|static
name|char
name|buf
index|[
name|DMABUFSZ
index|]
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
name|t
init|=
name|buf
decl_stmt|;
comment|/* Async -- double all nulls. */
for|for
control|(
name|p
operator|=
name|data
init|;
name|p
operator|<
name|data
operator|+
name|len
operator|&&
name|t
operator|<
name|buf
operator|+
name|DMABUFSZ
operator|-
literal|1
condition|;
operator|++
name|p
control|)
if|if
condition|(
operator|(
operator|*
name|t
operator|++
operator|=
operator|*
name|p
operator|)
operator|==
literal|0
condition|)
operator|*
name|t
operator|++
operator|=
literal|0
expr_stmt|;
return|return
name|cx_send
argument_list|(
name|c
argument_list|,
name|buf
argument_list|,
name|t
operator|-
name|buf
argument_list|,
name|attachment
argument_list|)
return|;
block|}
return|return
name|cx_send
argument_list|(
name|c
argument_list|,
name|data
argument_list|,
name|len
argument_list|,
name|attachment
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cx_receive_interrupt
parameter_list|(
name|cx_chan_t
modifier|*
name|c
parameter_list|)
block|{
name|unsigned
name|short
name|risr
decl_stmt|;
name|int
name|len
init|=
literal|0
decl_stmt|,
name|rbsz
decl_stmt|;
operator|++
name|c
operator|->
name|rintr
expr_stmt|;
name|risr
operator|=
name|inw
argument_list|(
name|RISR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Compute optimal receiver buffer length */
name|rbsz
operator|=
name|cx_compute_buf_len
argument_list|(
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|mode
operator|==
name|M_ASYNC
operator|&&
operator|(
name|risr
operator|&
name|RISA_TIMEOUT
operator|)
condition|)
block|{
name|unsigned
name|long
name|rcbadr
init|=
operator|(
name|unsigned
name|short
operator|)
name|inw
argument_list|(
name|RCBADRL
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|)
operator||
operator|(
name|long
operator|)
name|inw
argument_list|(
name|RCBADRU
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|)
operator|<<
literal|16
decl_stmt|;
name|unsigned
name|char
modifier|*
name|buf
init|=
literal|0
decl_stmt|;
name|port_t
name|cnt_port
init|=
literal|0
decl_stmt|,
name|sts_port
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|rcbadr
operator|>=
name|c
operator|->
name|brphys
operator|&&
name|rcbadr
operator|<
name|c
operator|->
name|brphys
operator|+
name|DMABUFSZ
condition|)
block|{
name|buf
operator|=
name|c
operator|->
name|brbuf
expr_stmt|;
name|len
operator|=
name|rcbadr
operator|-
name|c
operator|->
name|brphys
expr_stmt|;
name|cnt_port
operator|=
name|BRBCNT
argument_list|(
name|c
operator|->
name|port
argument_list|)
expr_stmt|;
name|sts_port
operator|=
name|BRBSTS
argument_list|(
name|c
operator|->
name|port
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rcbadr
operator|>=
name|c
operator|->
name|arphys
operator|&&
name|rcbadr
operator|<
name|c
operator|->
name|arphys
operator|+
name|DMABUFSZ
condition|)
block|{
name|buf
operator|=
name|c
operator|->
name|arbuf
expr_stmt|;
name|len
operator|=
name|rcbadr
operator|-
name|c
operator|->
name|arphys
expr_stmt|;
name|cnt_port
operator|=
name|ARBCNT
argument_list|(
name|c
operator|->
name|port
argument_list|)
expr_stmt|;
name|sts_port
operator|=
name|ARBSTS
argument_list|(
name|c
operator|->
name|port
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|len
condition|)
block|{
name|c
operator|->
name|ibytes
operator|+=
name|len
expr_stmt|;
name|c
operator|->
name|received_data
operator|=
name|buf
expr_stmt|;
name|c
operator|->
name|received_len
operator|=
name|len
expr_stmt|;
comment|/* Restart receiver. */
name|outw
argument_list|(
name|cnt_port
argument_list|,
name|rbsz
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|sts_port
argument_list|,
name|BSTS_OWN24
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|REOI_TERMBUFF
operator|)
return|;
block|}
comment|/* Receive errors. */
if|if
condition|(
name|risr
operator|&
name|RIS_OVERRUN
condition|)
block|{
operator|++
name|c
operator|->
name|ierrs
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|call_on_err
condition|)
name|c
operator|->
name|call_on_err
argument_list|(
name|c
argument_list|,
name|CX_OVERRUN
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|c
operator|->
name|mode
operator|!=
name|M_ASYNC
operator|&&
operator|(
name|risr
operator|&
name|RISH_CRCERR
operator|)
condition|)
block|{
operator|++
name|c
operator|->
name|ierrs
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|call_on_err
condition|)
name|c
operator|->
name|call_on_err
argument_list|(
name|c
argument_list|,
name|CX_CRC
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|c
operator|->
name|mode
operator|!=
name|M_ASYNC
operator|&&
operator|(
name|risr
operator|&
operator|(
name|RISH_RXABORT
operator||
name|RISH_RESIND
operator|)
operator|)
condition|)
block|{
operator|++
name|c
operator|->
name|ierrs
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|call_on_err
condition|)
name|c
operator|->
name|call_on_err
argument_list|(
name|c
argument_list|,
name|CX_FRAME
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|c
operator|->
name|mode
operator|==
name|M_ASYNC
operator|&&
operator|(
name|risr
operator|&
name|RISA_PARERR
operator|)
condition|)
block|{
operator|++
name|c
operator|->
name|ierrs
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|call_on_err
condition|)
name|c
operator|->
name|call_on_err
argument_list|(
name|c
argument_list|,
name|CX_CRC
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|c
operator|->
name|mode
operator|==
name|M_ASYNC
operator|&&
operator|(
name|risr
operator|&
name|RISA_FRERR
operator|)
condition|)
block|{
operator|++
name|c
operator|->
name|ierrs
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|call_on_err
condition|)
name|c
operator|->
name|call_on_err
argument_list|(
name|c
argument_list|,
name|CX_FRAME
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|c
operator|->
name|mode
operator|==
name|M_ASYNC
operator|&&
operator|(
name|risr
operator|&
name|RISA_BREAK
operator|)
condition|)
block|{
if|if
condition|(
name|c
operator|->
name|call_on_err
condition|)
name|c
operator|->
name|call_on_err
argument_list|(
name|c
argument_list|,
name|CX_BREAK
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
operator|(
name|risr
operator|&
name|RIS_EOBUF
operator|)
condition|)
block|{
operator|++
name|c
operator|->
name|ierrs
expr_stmt|;
block|}
else|else
block|{
comment|/* Handle received data. */
name|len
operator|=
operator|(
name|risr
operator|&
name|RIS_BB
operator|)
condition|?
name|inw
argument_list|(
name|BRBCNT
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|)
else|:
name|inw
argument_list|(
name|ARBCNT
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|DMABUFSZ
condition|)
block|{
comment|/* Fatal error: actual DMA transfer size 			 * exceeds our buffer size.  It could be caused 			 * by incorrectly programmed DMA register or 			 * hardware fault.  Possibly, should panic here. */
name|len
operator|=
name|DMABUFSZ
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|c
operator|->
name|mode
operator|!=
name|M_ASYNC
operator|&&
operator|!
operator|(
name|risr
operator|&
name|RIS_EOFR
operator|)
condition|)
block|{
comment|/* The received frame does not fit in the DMA buffer. 			 * It could be caused by serial lie noise, 			 * or if the peer has too big MTU. */
if|if
condition|(
operator|!
name|c
operator|->
name|overflow
condition|)
block|{
if|if
condition|(
name|c
operator|->
name|call_on_err
condition|)
name|c
operator|->
name|call_on_err
argument_list|(
name|c
argument_list|,
name|CX_OVERFLOW
argument_list|)
expr_stmt|;
name|c
operator|->
name|overflow
operator|=
literal|1
expr_stmt|;
operator|++
name|c
operator|->
name|ierrs
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
operator|!
name|c
operator|->
name|overflow
condition|)
block|{
if|if
condition|(
name|risr
operator|&
name|RIS_BB
condition|)
block|{
name|c
operator|->
name|received_data
operator|=
name|c
operator|->
name|brbuf
expr_stmt|;
name|c
operator|->
name|received_len
operator|=
name|len
expr_stmt|;
block|}
else|else
block|{
name|c
operator|->
name|received_data
operator|=
name|c
operator|->
name|arbuf
expr_stmt|;
name|c
operator|->
name|received_len
operator|=
name|len
expr_stmt|;
block|}
if|if
condition|(
name|c
operator|->
name|mode
operator|!=
name|M_ASYNC
condition|)
operator|++
name|c
operator|->
name|ipkts
expr_stmt|;
name|c
operator|->
name|ibytes
operator|+=
name|len
expr_stmt|;
block|}
else|else
name|c
operator|->
name|overflow
operator|=
literal|0
expr_stmt|;
block|}
comment|/* Restart receiver. */
if|if
condition|(
operator|!
operator|(
name|inb
argument_list|(
name|ARBSTS
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|)
operator|&
name|BSTS_OWN24
operator|)
condition|)
block|{
name|outw
argument_list|(
name|ARBCNT
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|rbsz
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|ARBSTS
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|BSTS_OWN24
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|(
name|inb
argument_list|(
name|BRBSTS
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|)
operator|&
name|BSTS_OWN24
operator|)
condition|)
block|{
name|outw
argument_list|(
name|BRBCNT
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|rbsz
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|BRBSTS
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|BSTS_OWN24
argument_list|)
expr_stmt|;
block|}
comment|/* Discard exception characters. */
if|if
condition|(
operator|(
name|risr
operator|&
name|RISA_SCMASK
operator|)
operator|&&
name|c
operator|->
name|aopt
operator|.
name|cor2
operator|.
name|ixon
condition|)
return|return
operator|(
name|REOI_DISCEXC
operator|)
return|;
else|else
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|cx_transmit_interrupt
parameter_list|(
name|cx_chan_t
modifier|*
name|c
parameter_list|)
block|{
name|unsigned
name|char
name|tisr
decl_stmt|;
name|int
name|len
init|=
literal|0
decl_stmt|;
operator|++
name|c
operator|->
name|tintr
expr_stmt|;
name|tisr
operator|=
name|inb
argument_list|(
name|TISR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tisr
operator|&
name|TIS_UNDERRUN
condition|)
block|{
comment|/* Transmit underrun error */
if|if
condition|(
name|c
operator|->
name|call_on_err
condition|)
name|c
operator|->
name|call_on_err
argument_list|(
name|c
argument_list|,
name|CX_UNDERRUN
argument_list|)
expr_stmt|;
operator|++
name|c
operator|->
name|oerrs
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|tisr
operator|&
operator|(
name|TIS_EOBUF
operator||
name|TIS_TXEMPTY
operator||
name|TIS_TXDATA
operator|)
condition|)
block|{
comment|/* Call processing function */
if|if
condition|(
name|tisr
operator|&
name|TIS_BB
condition|)
block|{
name|len
operator|=
name|inw
argument_list|(
name|BTBCNT
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|call_on_tx
condition|)
name|c
operator|->
name|call_on_tx
argument_list|(
name|c
argument_list|,
name|c
operator|->
name|attach
index|[
literal|1
index|]
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|len
operator|=
name|inw
argument_list|(
name|ATBCNT
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|call_on_tx
condition|)
name|c
operator|->
name|call_on_tx
argument_list|(
name|c
argument_list|,
name|c
operator|->
name|attach
index|[
literal|0
index|]
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|c
operator|->
name|mode
operator|!=
name|M_ASYNC
operator|&&
name|len
operator|!=
literal|0
condition|)
operator|++
name|c
operator|->
name|opkts
expr_stmt|;
name|c
operator|->
name|obytes
operator|+=
name|len
expr_stmt|;
block|}
comment|/* Enable TXMPTY interrupt, 	 * to catch the case when the second buffer is empty. */
if|if
condition|(
name|c
operator|->
name|mode
operator|!=
name|M_ASYNC
condition|)
block|{
if|if
condition|(
operator|(
name|inb
argument_list|(
name|ATBSTS
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|)
operator|&
name|BSTS_OWN24
operator|)
operator|&&
operator|(
name|inb
argument_list|(
name|BTBSTS
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|)
operator|&
name|BSTS_OWN24
operator|)
condition|)
block|{
name|outb
argument_list|(
name|IER
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|IER_RXD
operator||
name|IER_TXD
operator||
name|IER_TXMPTY
argument_list|)
expr_stmt|;
block|}
else|else
name|outb
argument_list|(
name|IER
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|IER_RXD
operator||
name|IER_TXD
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|cx_int_handler
parameter_list|(
name|cx_board_t
modifier|*
name|b
parameter_list|)
block|{
name|unsigned
name|char
name|livr
decl_stmt|;
name|cx_chan_t
modifier|*
name|c
decl_stmt|;
while|while
condition|(
operator|!
operator|(
name|inw
argument_list|(
name|BSR
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|)
operator|&
name|BSR_NOINTR
operator|)
condition|)
block|{
comment|/* Enter the interrupt context, using IACK bus cycle. 		   Read the local interrupt vector register. */
name|livr
operator|=
name|inb
argument_list|(
name|IACK
argument_list|(
name|b
operator|->
name|port
argument_list|,
name|BRD_INTR_LEVEL
argument_list|)
argument_list|)
expr_stmt|;
name|c
operator|=
name|b
operator|->
name|chan
operator|+
operator|(
name|livr
operator|>>
literal|2
operator|&
literal|0xf
operator|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|type
operator|==
name|T_NONE
condition|)
continue|continue;
switch|switch
condition|(
name|livr
operator|&
literal|3
condition|)
block|{
case|case
name|LIV_MODEM
case|:
comment|/* modem interrupt */
operator|++
name|c
operator|->
name|mintr
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|call_on_msig
condition|)
name|c
operator|->
name|call_on_msig
argument_list|(
name|c
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|MEOIR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|LIV_EXCEP
case|:
comment|/* receive exception */
case|case
name|LIV_RXDATA
case|:
comment|/* receive interrupt */
name|outb
argument_list|(
name|REOIR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|cx_receive_interrupt
argument_list|(
name|c
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|call_on_rx
operator|&&
name|c
operator|->
name|received_data
condition|)
block|{
name|c
operator|->
name|call_on_rx
argument_list|(
name|c
argument_list|,
name|c
operator|->
name|received_data
argument_list|,
name|c
operator|->
name|received_len
argument_list|)
expr_stmt|;
name|c
operator|->
name|received_data
operator|=
literal|0
expr_stmt|;
block|}
break|break;
case|case
name|LIV_TXDATA
case|:
comment|/* transmit interrupt */
name|cx_transmit_interrupt
argument_list|(
name|c
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|TEOIR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
end_function

begin_comment
comment|/*  * Register event processing functions  */
end_comment

begin_function
name|void
name|cx_register_transmit
parameter_list|(
name|cx_chan_t
modifier|*
name|c
parameter_list|,
name|void
function_decl|(
modifier|*
name|func
function_decl|)
parameter_list|(
name|cx_chan_t
modifier|*
name|c
parameter_list|,
name|void
modifier|*
name|attachment
parameter_list|,
name|int
name|len
parameter_list|)
parameter_list|)
block|{
name|c
operator|->
name|call_on_tx
operator|=
name|func
expr_stmt|;
block|}
end_function

begin_function
name|void
name|cx_register_receive
parameter_list|(
name|cx_chan_t
modifier|*
name|c
parameter_list|,
name|void
function_decl|(
modifier|*
name|func
function_decl|)
parameter_list|(
name|cx_chan_t
modifier|*
name|c
parameter_list|,
name|char
modifier|*
name|data
parameter_list|,
name|int
name|len
parameter_list|)
parameter_list|)
block|{
name|c
operator|->
name|call_on_rx
operator|=
name|func
expr_stmt|;
block|}
end_function

begin_function
name|void
name|cx_register_modem
parameter_list|(
name|cx_chan_t
modifier|*
name|c
parameter_list|,
name|void
function_decl|(
modifier|*
name|func
function_decl|)
parameter_list|(
name|cx_chan_t
modifier|*
name|c
parameter_list|)
parameter_list|)
block|{
name|c
operator|->
name|call_on_msig
operator|=
name|func
expr_stmt|;
block|}
end_function

begin_function
name|void
name|cx_register_error
parameter_list|(
name|cx_chan_t
modifier|*
name|c
parameter_list|,
name|void
function_decl|(
modifier|*
name|func
function_decl|)
parameter_list|(
name|cx_chan_t
modifier|*
name|c
parameter_list|,
name|int
name|data
parameter_list|)
parameter_list|)
block|{
name|c
operator|->
name|call_on_err
operator|=
name|func
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Async protocol functions.  */
end_comment

begin_comment
comment|/*  * Enable/disable transmitter.  */
end_comment

begin_function
name|void
name|cx_transmitter_ctl
parameter_list|(
name|cx_chan_t
modifier|*
name|c
parameter_list|,
name|int
name|start
parameter_list|)
block|{
name|outb
argument_list|(
name|CAR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|num
operator|&
literal|3
argument_list|)
expr_stmt|;
name|cx_cmd
argument_list|(
name|c
operator|->
name|port
argument_list|,
name|start
condition|?
name|CCR_ENTX
else|:
name|CCR_DISTX
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Discard all data queued in transmitter.  */
end_comment

begin_function
name|void
name|cx_flush_transmit
parameter_list|(
name|cx_chan_t
modifier|*
name|c
parameter_list|)
block|{
name|outb
argument_list|(
name|CAR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|num
operator|&
literal|3
argument_list|)
expr_stmt|;
name|cx_cmd
argument_list|(
name|c
operator|->
name|port
argument_list|,
name|CCR_CLRTX
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Send the XON/XOFF flow control symbol.  */
end_comment

begin_function
name|void
name|cx_xflow_ctl
parameter_list|(
name|cx_chan_t
modifier|*
name|c
parameter_list|,
name|int
name|on
parameter_list|)
block|{
name|outb
argument_list|(
name|CAR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|num
operator|&
literal|3
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|STCR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|STC_SNDSPC
operator||
operator|(
name|on
condition|?
name|STC_SSPC_1
else|:
name|STC_SSPC_2
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Send the break signal for a given number of milliseconds.  */
end_comment

begin_function
name|void
name|cx_send_break
parameter_list|(
name|cx_chan_t
modifier|*
name|c
parameter_list|,
name|int
name|msec
parameter_list|)
block|{
specifier|static
name|unsigned
name|char
name|buf
index|[
literal|128
index|]
decl_stmt|;
name|unsigned
name|char
modifier|*
name|p
decl_stmt|;
name|p
operator|=
name|buf
expr_stmt|;
operator|*
name|p
operator|++
operator|=
literal|0
expr_stmt|;
comment|/* extended transmit command */
operator|*
name|p
operator|++
operator|=
literal|0x81
expr_stmt|;
comment|/* send break */
if|if
condition|(
name|msec
operator|>
literal|10000
condition|)
comment|/* max 10 seconds */
name|msec
operator|=
literal|10000
expr_stmt|;
if|if
condition|(
name|msec
operator|<
literal|10
condition|)
comment|/* min 10 msec */
name|msec
operator|=
literal|10
expr_stmt|;
while|while
condition|(
name|msec
operator|>
literal|0
condition|)
block|{
name|int
name|ms
init|=
literal|250
decl_stmt|;
comment|/* 250 msec */
if|if
condition|(
name|ms
operator|>
name|msec
condition|)
name|ms
operator|=
name|msec
expr_stmt|;
name|msec
operator|-=
name|ms
expr_stmt|;
operator|*
name|p
operator|++
operator|=
literal|0
expr_stmt|;
comment|/* extended transmit command */
operator|*
name|p
operator|++
operator|=
literal|0x82
expr_stmt|;
comment|/* insert delay */
operator|*
name|p
operator|++
operator|=
name|ms
expr_stmt|;
block|}
operator|*
name|p
operator|++
operator|=
literal|0
expr_stmt|;
comment|/* extended transmit command */
operator|*
name|p
operator|++
operator|=
literal|0x83
expr_stmt|;
comment|/* stop break */
name|cx_send
argument_list|(
name|c
argument_list|,
name|buf
argument_list|,
name|p
operator|-
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Set async parameters.  */
end_comment

begin_function
name|void
name|cx_set_async_param
parameter_list|(
name|cx_chan_t
modifier|*
name|c
parameter_list|,
name|int
name|baud
parameter_list|,
name|int
name|bits
parameter_list|,
name|int
name|parity
parameter_list|,
name|int
name|stop2
parameter_list|,
name|int
name|ignpar
parameter_list|,
name|int
name|rtscts
parameter_list|,
name|int
name|ixon
parameter_list|,
name|int
name|ixany
parameter_list|,
name|int
name|symstart
parameter_list|,
name|int
name|symstop
parameter_list|)
block|{
name|int
name|clock
decl_stmt|,
name|period
decl_stmt|;
name|cx_cor1_async_t
name|cor1
decl_stmt|;
comment|/* Set character length and parity mode. */
name|BYTE
name|cor1
init|=
literal|0
decl_stmt|;
name|cor1
operator|.
name|charlen
operator|=
name|bits
operator|-
literal|1
expr_stmt|;
name|cor1
operator|.
name|parmode
operator|=
name|parity
condition|?
name|PARM_NORMAL
else|:
name|PARM_NOPAR
expr_stmt|;
name|cor1
operator|.
name|parity
operator|=
name|parity
operator|==
literal|1
condition|?
name|PAR_ODD
else|:
name|PAR_EVEN
expr_stmt|;
name|cor1
operator|.
name|ignpar
operator|=
name|ignpar
condition|?
literal|1
else|:
literal|0
expr_stmt|;
comment|/* Enable/disable hardware CTS. */
name|c
operator|->
name|aopt
operator|.
name|cor2
operator|.
name|ctsae
operator|=
name|rtscts
condition|?
literal|1
else|:
literal|0
expr_stmt|;
comment|/* Enable extended transmit command mode. 	 * Unfortunately, there is no other method for sending break. */
name|c
operator|->
name|aopt
operator|.
name|cor2
operator|.
name|etc
operator|=
literal|1
expr_stmt|;
comment|/* Enable/disable hardware XON/XOFF. */
name|c
operator|->
name|aopt
operator|.
name|cor2
operator|.
name|ixon
operator|=
name|ixon
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|c
operator|->
name|aopt
operator|.
name|cor2
operator|.
name|ixany
operator|=
name|ixany
condition|?
literal|1
else|:
literal|0
expr_stmt|;
comment|/* Set the number of stop bits. */
if|if
condition|(
name|stop2
condition|)
name|c
operator|->
name|aopt
operator|.
name|cor3
operator|.
name|stopb
operator|=
name|STOPB_2
expr_stmt|;
else|else
name|c
operator|->
name|aopt
operator|.
name|cor3
operator|.
name|stopb
operator|=
name|STOPB_1
expr_stmt|;
comment|/* Disable/enable passing XON/XOFF chars to the host. */
name|c
operator|->
name|aopt
operator|.
name|cor3
operator|.
name|scde
operator|=
name|ixon
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|c
operator|->
name|aopt
operator|.
name|cor3
operator|.
name|flowct
operator|=
name|ixon
condition|?
name|FLOWCC_NOTPASS
else|:
name|FLOWCC_PASS
expr_stmt|;
name|c
operator|->
name|aopt
operator|.
name|schr1
operator|=
name|symstart
expr_stmt|;
comment|/* XON */
name|c
operator|->
name|aopt
operator|.
name|schr2
operator|=
name|symstop
expr_stmt|;
comment|/* XOFF */
comment|/* Set current channel number. */
name|outb
argument_list|(
name|CAR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|num
operator|&
literal|3
argument_list|)
expr_stmt|;
comment|/* Set up clock values. */
if|if
condition|(
name|baud
condition|)
block|{
name|c
operator|->
name|rxbaud
operator|=
name|c
operator|->
name|txbaud
operator|=
name|baud
expr_stmt|;
comment|/* Receiver. */
name|cx_clock
argument_list|(
name|c
operator|->
name|oscfreq
argument_list|,
name|c
operator|->
name|rxbaud
argument_list|,
operator|&
name|clock
argument_list|,
operator|&
name|period
argument_list|)
expr_stmt|;
name|c
operator|->
name|opt
operator|.
name|rcor
operator|.
name|clk
operator|=
name|clock
expr_stmt|;
name|outb
argument_list|(
argument|RCOR(c->port)
argument_list|,
argument|BYTE c->opt.rcor
argument_list|)
empty_stmt|;
name|outb
argument_list|(
name|RBPR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|period
argument_list|)
expr_stmt|;
comment|/* Transmitter. */
name|cx_clock
argument_list|(
name|c
operator|->
name|oscfreq
argument_list|,
name|c
operator|->
name|txbaud
argument_list|,
operator|&
name|clock
argument_list|,
operator|&
name|period
argument_list|)
expr_stmt|;
name|c
operator|->
name|opt
operator|.
name|tcor
operator|.
name|clk
operator|=
name|clock
expr_stmt|;
name|c
operator|->
name|opt
operator|.
name|tcor
operator|.
name|ext1x
operator|=
literal|0
expr_stmt|;
name|outb
argument_list|(
argument|TCOR(c->port)
argument_list|,
argument|BYTE c->opt.tcor
argument_list|)
empty_stmt|;
name|outb
argument_list|(
name|TBPR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|period
argument_list|)
expr_stmt|;
block|}
name|outb
argument_list|(
argument|COR2(c->port)
argument_list|,
argument|BYTE c->aopt.cor2
argument_list|)
empty_stmt|;
name|outb
argument_list|(
argument|COR3(c->port)
argument_list|,
argument|BYTE c->aopt.cor3
argument_list|)
empty_stmt|;
name|outb
argument_list|(
name|SCHR1
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|aopt
operator|.
name|schr1
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|SCHR2
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|aopt
operator|.
name|schr2
argument_list|)
expr_stmt|;
if|if
condition|(
name|BYTE
name|c
operator|->
name|aopt
operator|.
name|cor1
operator|!=
name|BYTE
name|cor1
condition|)
block|{
name|BYTE
name|c
operator|->
name|aopt
operator|.
name|cor1
init|=
name|BYTE
name|cor1
decl_stmt|;
name|outb
argument_list|(
argument|COR1(c->port)
argument_list|,
argument|BYTE c->aopt.cor1
argument_list|)
empty_stmt|;
comment|/* Any change to COR1 require reinitialization. */
comment|/* Unfortunately, it may cause transmitter glitches... */
name|cx_cmd
argument_list|(
name|c
operator|->
name|port
argument_list|,
name|CCR_INITCH
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Set mode: M_ASYNC or M_HDLC.  * Both receiver and transmitter are disabled.  */
end_comment

begin_function
name|int
name|cx_set_mode
parameter_list|(
name|cx_chan_t
modifier|*
name|c
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
if|if
condition|(
name|mode
operator|==
name|M_HDLC
condition|)
block|{
if|if
condition|(
name|c
operator|->
name|type
operator|==
name|T_ASYNC
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|c
operator|->
name|mode
operator|==
name|M_HDLC
condition|)
return|return
literal|0
return|;
name|c
operator|->
name|mode
operator|=
name|M_HDLC
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|mode
operator|==
name|M_ASYNC
condition|)
block|{
if|if
condition|(
name|c
operator|->
name|type
operator|==
name|T_SYNC_RS232
operator|||
name|c
operator|->
name|type
operator|==
name|T_SYNC_V35
operator|||
name|c
operator|->
name|type
operator|==
name|T_SYNC_RS449
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|c
operator|->
name|mode
operator|==
name|M_ASYNC
condition|)
return|return
literal|0
return|;
name|c
operator|->
name|mode
operator|=
name|M_ASYNC
expr_stmt|;
name|c
operator|->
name|opt
operator|.
name|tcor
operator|.
name|ext1x
operator|=
literal|0
expr_stmt|;
name|c
operator|->
name|opt
operator|.
name|tcor
operator|.
name|llm
operator|=
literal|0
expr_stmt|;
name|c
operator|->
name|opt
operator|.
name|rcor
operator|.
name|dpll
operator|=
literal|0
expr_stmt|;
name|c
operator|->
name|opt
operator|.
name|rcor
operator|.
name|encod
operator|=
name|ENCOD_NRZ
expr_stmt|;
if|if
condition|(
operator|!
name|c
operator|->
name|txbaud
operator|||
operator|!
name|c
operator|->
name|rxbaud
condition|)
name|c
operator|->
name|txbaud
operator|=
name|c
operator|->
name|rxbaud
operator|=
literal|9600
expr_stmt|;
block|}
else|else
return|return
operator|-
literal|1
return|;
name|cx_setup_chan
argument_list|(
name|c
argument_list|)
expr_stmt|;
name|cx_start_chan
argument_list|(
name|c
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|cx_enable_receive
argument_list|(
name|c
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|cx_enable_transmit
argument_list|(
name|c
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Set port type for old models of Sigma  */
end_comment

begin_function
name|void
name|cx_set_port
parameter_list|(
name|cx_chan_t
modifier|*
name|c
parameter_list|,
name|int
name|iftype
parameter_list|)
block|{
if|if
condition|(
name|c
operator|->
name|board
operator|->
name|type
operator|==
name|B_SIGMA_XXX
condition|)
block|{
switch|switch
condition|(
name|c
operator|->
name|num
condition|)
block|{
case|case
literal|0
case|:
if|if
condition|(
operator|(
name|c
operator|->
name|board
operator|->
name|if0type
operator|!=
literal|0
operator|)
operator|==
operator|(
name|iftype
operator|!=
literal|0
operator|)
condition|)
return|return;
name|c
operator|->
name|board
operator|->
name|if0type
operator|=
name|iftype
expr_stmt|;
name|c
operator|->
name|board
operator|->
name|bcr0
operator|&=
operator|~
name|BCR0_UMASK
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|board
operator|->
name|if0type
operator|&&
operator|(
name|c
operator|->
name|type
operator|==
name|T_UNIV_RS449
operator|||
name|c
operator|->
name|type
operator|==
name|T_UNIV_V35
operator|)
condition|)
name|c
operator|->
name|board
operator|->
name|bcr0
operator||=
name|BCR0_UI_RS449
expr_stmt|;
name|outb
argument_list|(
name|BCR0
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|board
operator|->
name|bcr0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|8
case|:
if|if
condition|(
operator|(
name|c
operator|->
name|board
operator|->
name|if8type
operator|!=
literal|0
operator|)
operator|==
operator|(
name|iftype
operator|!=
literal|0
operator|)
condition|)
return|return;
name|c
operator|->
name|board
operator|->
name|if8type
operator|=
name|iftype
expr_stmt|;
name|c
operator|->
name|board
operator|->
name|bcr0b
operator|&=
operator|~
name|BCR0_UMASK
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|board
operator|->
name|if8type
operator|&&
operator|(
name|c
operator|->
name|type
operator|==
name|T_UNIV_RS449
operator|||
name|c
operator|->
name|type
operator|==
name|T_UNIV_V35
operator|)
condition|)
name|c
operator|->
name|board
operator|->
name|bcr0b
operator||=
name|BCR0_UI_RS449
expr_stmt|;
name|outb
argument_list|(
name|BCR0
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
operator|+
literal|0x10
argument_list|)
argument_list|,
name|c
operator|->
name|board
operator|->
name|bcr0b
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
end_function

begin_comment
comment|/*  * Get port type for old models of Sigma  * -1 Fixed port type or auto detect  *  0 RS232  *  1 V35  *  2 RS449  */
end_comment

begin_function
name|int
name|cx_get_port
parameter_list|(
name|cx_chan_t
modifier|*
name|c
parameter_list|)
block|{
name|int
name|iftype
decl_stmt|;
if|if
condition|(
name|c
operator|->
name|board
operator|->
name|type
operator|==
name|B_SIGMA_XXX
condition|)
block|{
switch|switch
condition|(
name|c
operator|->
name|num
condition|)
block|{
case|case
literal|0
case|:
name|iftype
operator|=
name|c
operator|->
name|board
operator|->
name|if0type
expr_stmt|;
break|break;
case|case
literal|8
case|:
name|iftype
operator|=
name|c
operator|->
name|board
operator|->
name|if8type
expr_stmt|;
break|break;
default|default:
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|iftype
condition|)
switch|switch
condition|(
name|c
operator|->
name|type
condition|)
block|{
case|case
name|T_UNIV_V35
case|:
return|return
literal|1
return|;
break|break;
case|case
name|T_UNIV_RS449
case|:
return|return
literal|2
return|;
break|break;
default|default:
return|return
operator|-
literal|1
return|;
break|break;
block|}
else|else
return|return
literal|0
return|;
block|}
else|else
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|void
name|cx_intr_off
parameter_list|(
name|cx_board_t
modifier|*
name|b
parameter_list|)
block|{
name|outb
argument_list|(
name|BCR0
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|,
name|b
operator|->
name|bcr0
operator|&
operator|~
name|BCR0_IRQ_MASK
argument_list|)
expr_stmt|;
if|if
condition|(
name|b
operator|->
name|chan
index|[
literal|8
index|]
operator|.
name|port
operator|||
name|b
operator|->
name|chan
index|[
literal|12
index|]
operator|.
name|port
condition|)
name|outb
argument_list|(
name|BCR0
argument_list|(
name|b
operator|->
name|port
operator|+
literal|0x10
argument_list|)
argument_list|,
name|b
operator|->
name|bcr0b
operator|&
operator|~
name|BCR0_IRQ_MASK
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|cx_intr_on
parameter_list|(
name|cx_board_t
modifier|*
name|b
parameter_list|)
block|{
name|outb
argument_list|(
name|BCR0
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|,
name|b
operator|->
name|bcr0
argument_list|)
expr_stmt|;
if|if
condition|(
name|b
operator|->
name|chan
index|[
literal|8
index|]
operator|.
name|port
operator|||
name|b
operator|->
name|chan
index|[
literal|12
index|]
operator|.
name|port
condition|)
name|outb
argument_list|(
name|BCR0
argument_list|(
name|b
operator|->
name|port
operator|+
literal|0x10
argument_list|)
argument_list|,
name|b
operator|->
name|bcr0b
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|cx_checkintr
parameter_list|(
name|cx_board_t
modifier|*
name|b
parameter_list|)
block|{
return|return
operator|(
operator|!
operator|(
name|inw
argument_list|(
name|BSR
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|)
operator|&
name|BSR_NOINTR
operator|)
operator|)
return|;
block|}
end_function

end_unit


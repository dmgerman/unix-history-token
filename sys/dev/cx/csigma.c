begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Low-level subroutines for Cronyx-Sigma adapter.  *  * Copyright (C) 1994-2000 Cronyx Engineering.  * Author: Serge Vakulenko,<vak@cronyx.ru>  *  * This software is distributed with NO WARRANTIES, not even the implied  * warranties for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  *  * Authors grant any other persons or organisations permission to use  * or modify this software as long as this message is kept with the software,  * all derivative works or modified versions.  *  * Cronyx Id: csigma.c,v 1.1.2.1 2003/11/12 17:13:41 rik Exp $  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<dev/cx/machdep.h>
end_include

begin_include
include|#
directive|include
file|<dev/cx/cxddk.h>
end_include

begin_include
include|#
directive|include
file|<dev/cx/cxreg.h>
end_include

begin_include
include|#
directive|include
file|<dev/cx/cronyxfw.h>
end_include

begin_define
define|#
directive|define
name|DMA_MASK
value|0xd4
end_define

begin_comment
comment|/* DMA mask register */
end_comment

begin_define
define|#
directive|define
name|DMA_MASK_CLEAR
value|0x04
end_define

begin_comment
comment|/* DMA clear mask */
end_comment

begin_define
define|#
directive|define
name|DMA_MODE
value|0xd6
end_define

begin_comment
comment|/* DMA mode register */
end_comment

begin_define
define|#
directive|define
name|DMA_MODE_MASTER
value|0xc0
end_define

begin_comment
comment|/* DMA master mode */
end_comment

begin_define
define|#
directive|define
name|BYTE
value|*(unsigned char*)&
end_define

begin_decl_stmt
specifier|static
name|unsigned
name|char
name|irqmask
index|[]
init|=
block|{
name|BCR0_IRQ_DIS
block|,
name|BCR0_IRQ_DIS
block|,
name|BCR0_IRQ_DIS
block|,
name|BCR0_IRQ_3
block|,
name|BCR0_IRQ_DIS
block|,
name|BCR0_IRQ_5
block|,
name|BCR0_IRQ_DIS
block|,
name|BCR0_IRQ_7
block|,
name|BCR0_IRQ_DIS
block|,
name|BCR0_IRQ_DIS
block|,
name|BCR0_IRQ_10
block|,
name|BCR0_IRQ_11
block|,
name|BCR0_IRQ_12
block|,
name|BCR0_IRQ_DIS
block|,
name|BCR0_IRQ_DIS
block|,
name|BCR0_IRQ_15
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|char
name|dmamask
index|[]
init|=
block|{
name|BCR0_DMA_DIS
block|,
name|BCR0_DMA_DIS
block|,
name|BCR0_DMA_DIS
block|,
name|BCR0_DMA_DIS
block|,
name|BCR0_DMA_DIS
block|,
name|BCR0_DMA_5
block|,
name|BCR0_DMA_6
block|,
name|BCR0_DMA_7
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* standard base port set */
end_comment

begin_decl_stmt
specifier|static
name|short
name|porttab
index|[]
init|=
block|{
literal|0x200
block|,
literal|0x220
block|,
literal|0x240
block|,
literal|0x260
block|,
literal|0x280
block|,
literal|0x2a0
block|,
literal|0x2c0
block|,
literal|0x2e0
block|,
literal|0x300
block|,
literal|0x320
block|,
literal|0x340
block|,
literal|0x360
block|,
literal|0x380
block|,
literal|0x3a0
block|,
literal|0x3c0
block|,
literal|0x3e0
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* valid IRQs and DRQs */
end_comment

begin_decl_stmt
specifier|static
name|short
name|irqtab
index|[]
init|=
block|{
literal|3
block|,
literal|5
block|,
literal|7
block|,
literal|10
block|,
literal|11
block|,
literal|12
block|,
literal|15
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|short
name|dmatab
index|[]
init|=
block|{
literal|5
block|,
literal|6
block|,
literal|7
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|valid
parameter_list|(
name|short
name|value
parameter_list|,
name|short
modifier|*
name|list
parameter_list|)
block|{
while|while
condition|(
operator|*
name|list
condition|)
if|if
condition|(
name|value
operator|==
operator|*
name|list
operator|++
condition|)
return|return
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_decl_stmt
name|long
name|cx_rxbaud
init|=
literal|9600
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* receiver baud rate */
end_comment

begin_decl_stmt
name|long
name|cx_txbaud
init|=
literal|9600
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* transmitter baud rate */
end_comment

begin_decl_stmt
name|int
name|cx_univ_mode
init|=
name|M_HDLC
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* univ. chan. mode: async or sync */
end_comment

begin_decl_stmt
name|int
name|cx_sync_mode
init|=
name|M_HDLC
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* sync. chan. mode: HDLC, Bisync or X.21 */
end_comment

begin_decl_stmt
name|int
name|cx_iftype
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* univ. chan. interface: upper/lower */
end_comment

begin_function_decl
specifier|static
name|int
name|cx_probe_chip
parameter_list|(
name|port_t
name|base
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|cx_setup_chip
parameter_list|(
name|cx_chan_t
modifier|*
name|c
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * Wait for CCR to clear.  */
end_comment

begin_function
name|void
name|cx_cmd
parameter_list|(
name|port_t
name|base
parameter_list|,
name|int
name|cmd
parameter_list|)
block|{
name|port_t
name|port
init|=
name|CCR
argument_list|(
name|base
argument_list|)
decl_stmt|;
name|int
name|count
decl_stmt|;
comment|/* Wait 10 msec for the previous command to complete. */
for|for
control|(
name|count
operator|=
literal|0
init|;
name|inb
argument_list|(
name|port
argument_list|)
operator|&&
name|count
operator|<
literal|20000
condition|;
operator|++
name|count
control|)
continue|continue;
comment|/* Issue the command. */
name|outb
argument_list|(
name|port
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
comment|/* Wait 10 msec for the command to complete. */
for|for
control|(
name|count
operator|=
literal|0
init|;
name|inb
argument_list|(
name|port
argument_list|)
operator|&&
name|count
operator|<
literal|20000
condition|;
operator|++
name|count
control|)
continue|continue;
block|}
end_function

begin_comment
comment|/*  * Reset the chip.  */
end_comment

begin_function
specifier|static
name|int
name|cx_reset
parameter_list|(
name|port_t
name|port
parameter_list|)
block|{
name|int
name|count
decl_stmt|;
comment|/* Wait up to 10 msec for revision code to appear after reset. */
for|for
control|(
name|count
operator|=
literal|0
init|;
name|count
operator|<
literal|20000
condition|;
operator|++
name|count
control|)
if|if
condition|(
name|inb
argument_list|(
name|GFRCR
argument_list|(
name|port
argument_list|)
argument_list|)
operator|!=
literal|0
condition|)
break|break;
name|cx_cmd
argument_list|(
name|port
argument_list|,
name|CCR_RSTALL
argument_list|)
expr_stmt|;
comment|/* Firmware revision code should clear imediately. */
comment|/* Wait up to 10 msec for revision code to appear again. */
for|for
control|(
name|count
operator|=
literal|0
init|;
name|count
operator|<
literal|20000
condition|;
operator|++
name|count
control|)
if|if
condition|(
name|inb
argument_list|(
name|GFRCR
argument_list|(
name|port
argument_list|)
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
literal|1
operator|)
return|;
comment|/* Reset failed. */
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|cx_download
parameter_list|(
name|port_t
name|port
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|firmware
parameter_list|,
name|long
name|bits
parameter_list|,
specifier|const
name|cr_dat_tst_t
modifier|*
name|tst
parameter_list|)
block|{
name|unsigned
name|char
name|cr2
decl_stmt|,
name|sr
decl_stmt|;
name|long
name|i
decl_stmt|,
name|n
decl_stmt|,
name|maxn
init|=
operator|(
name|bits
operator|+
literal|7
operator|)
operator|/
literal|8
decl_stmt|;
name|int
name|v
decl_stmt|,
name|b
decl_stmt|;
name|inb
argument_list|(
name|BDET
argument_list|(
name|port
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|maxn
condition|;
operator|++
name|n
control|)
block|{
name|v
operator|=
operator|(
operator|(
name|firmware
index|[
name|n
index|]
operator|^
literal|' '
operator|)
operator|<<
literal|1
operator|)
operator||
operator|(
name|firmware
index|[
name|n
index|]
operator|>>
literal|7
operator|&
literal|1
operator|)
expr_stmt|;
for|for
control|(
name|b
operator|=
literal|0
init|;
name|b
operator|<
literal|7
condition|;
name|b
operator|+=
literal|2
operator|,
name|i
operator|+=
literal|2
control|)
block|{
if|if
condition|(
name|i
operator|>=
name|bits
condition|)
break|break;
name|cr2
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|v
operator|>>
name|b
operator|&
literal|1
condition|)
name|cr2
operator||=
name|BCR2_TMS
expr_stmt|;
if|if
condition|(
name|v
operator|>>
name|b
operator|&
literal|2
condition|)
name|cr2
operator||=
name|BCR2_TDI
expr_stmt|;
name|outb
argument_list|(
name|BCR2
argument_list|(
name|port
argument_list|)
argument_list|,
name|cr2
argument_list|)
expr_stmt|;
name|sr
operator|=
name|inb
argument_list|(
name|BSR
argument_list|(
name|port
argument_list|)
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|BCR0
argument_list|(
name|port
argument_list|)
argument_list|,
name|BCR0800_TCK
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|BCR0
argument_list|(
name|port
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|>=
name|tst
operator|->
name|end
condition|)
operator|++
name|tst
expr_stmt|;
if|if
condition|(
name|i
operator|>=
name|tst
operator|->
name|start
operator|&&
operator|(
name|sr
operator|&
name|BSR800_LERR
operator|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Check if the Sigma-XXX board is present at the given base port.  */
end_comment

begin_function
specifier|static
name|int
name|cx_probe_chained_board
parameter_list|(
name|port_t
name|port
parameter_list|,
name|int
modifier|*
name|c0
parameter_list|,
name|int
modifier|*
name|c1
parameter_list|)
block|{
name|int
name|rev
decl_stmt|,
name|i
decl_stmt|;
comment|/* Read and check the board revision code. */
name|rev
operator|=
name|inb
argument_list|(
name|BSR
argument_list|(
name|port
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|c0
operator|=
operator|*
name|c1
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|rev
operator|&
name|BSR_VAR_MASK
condition|)
block|{
case|case
name|CRONYX_100
case|:
operator|*
name|c0
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CRONYX_400
case|:
operator|*
name|c1
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CRONYX_500
case|:
operator|*
name|c0
operator|=
operator|*
name|c1
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CRONYX_410
case|:
operator|*
name|c0
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CRONYX_810
case|:
operator|*
name|c0
operator|=
operator|*
name|c1
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CRONYX_410s
case|:
operator|*
name|c0
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CRONYX_810s
case|:
operator|*
name|c0
operator|=
operator|*
name|c1
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CRONYX_440
case|:
operator|*
name|c0
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CRONYX_840
case|:
operator|*
name|c0
operator|=
operator|*
name|c1
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CRONYX_401
case|:
operator|*
name|c0
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CRONYX_801
case|:
operator|*
name|c0
operator|=
operator|*
name|c1
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CRONYX_401s
case|:
operator|*
name|c0
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CRONYX_801s
case|:
operator|*
name|c0
operator|=
operator|*
name|c1
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CRONYX_404
case|:
operator|*
name|c0
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CRONYX_703
case|:
operator|*
name|c0
operator|=
operator|*
name|c1
operator|=
literal|1
expr_stmt|;
break|break;
default|default:
return|return
operator|(
literal|0
operator|)
return|;
comment|/* invalid variant code */
block|}
switch|switch
condition|(
name|rev
operator|&
name|BSR_OSC_MASK
condition|)
block|{
case|case
name|BSR_OSC_20
case|:
comment|/* 20 MHz */
case|case
name|BSR_OSC_18432
case|:
comment|/* 18.432 MHz */
break|break;
default|default:
return|return
operator|(
literal|0
operator|)
return|;
comment|/* oscillator frequency does not match */
block|}
for|for
control|(
name|i
operator|=
literal|2
init|;
name|i
operator|<
literal|0x10
condition|;
name|i
operator|+=
literal|2
control|)
if|if
condition|(
operator|(
name|inb
argument_list|(
name|BSR
argument_list|(
name|port
argument_list|)
operator|+
name|i
argument_list|)
operator|&
name|BSR_REV_MASK
operator|)
operator|!=
operator|(
name|rev
operator|&
name|BSR_REV_MASK
operator|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* status changed? */
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Check if the Sigma-800 board is present at the given base port.  * Read board status register 1 and check identification bits  * which should invert every next read.  */
end_comment

begin_function
specifier|static
name|int
name|cx_probe_800_chained_board
parameter_list|(
name|port_t
name|port
parameter_list|)
block|{
name|unsigned
name|char
name|det
decl_stmt|,
name|odet
decl_stmt|;
name|int
name|i
decl_stmt|;
name|odet
operator|=
name|inb
argument_list|(
name|BDET
argument_list|(
name|port
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|odet
operator|&
operator|(
name|BDET_IB
operator||
name|BDET_IB_NEG
operator|)
operator|)
operator|!=
name|BDET_IB
operator|&&
operator|(
name|odet
operator|&
operator|(
name|BDET_IB
operator||
name|BDET_IB_NEG
operator|)
operator|)
operator|!=
name|BDET_IB_NEG
condition|)
return|return
operator|(
literal|0
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|100
condition|;
operator|++
name|i
control|)
block|{
name|det
operator|=
name|inb
argument_list|(
name|BDET
argument_list|(
name|port
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|det
operator|^
name|odet
operator|)
operator|&
operator|(
name|BDET_IB
operator||
name|BDET_IB_NEG
operator|)
operator|)
operator|!=
operator|(
name|BDET_IB
operator||
name|BDET_IB_NEG
operator|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|odet
operator|=
name|det
expr_stmt|;
block|}
comment|/* Reset the controller. */
name|outb
argument_list|(
name|BCR0
argument_list|(
name|port
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|BCR1
argument_list|(
name|port
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|BCR2
argument_list|(
name|port
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Check if the Sigma-2x board is present at the given base port.  */
end_comment

begin_function
specifier|static
name|int
name|cx_probe_2x_board
parameter_list|(
name|port_t
name|port
parameter_list|)
block|{
name|int
name|rev
decl_stmt|,
name|i
decl_stmt|;
comment|/* Read and check the board revision code. */
name|rev
operator|=
name|inb
argument_list|(
name|BSR
argument_list|(
name|port
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rev
operator|&
name|BSR2X_VAR_MASK
operator|)
operator|!=
name|CRONYX_22
operator|&&
operator|(
name|rev
operator|&
name|BSR2X_VAR_MASK
operator|)
operator|!=
name|CRONYX_24
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* invalid variant code */
for|for
control|(
name|i
operator|=
literal|2
init|;
name|i
operator|<
literal|0x10
condition|;
name|i
operator|+=
literal|2
control|)
if|if
condition|(
operator|(
name|inb
argument_list|(
name|BSR
argument_list|(
name|port
argument_list|)
operator|+
name|i
argument_list|)
operator|&
name|BSR2X_REV_MASK
operator|)
operator|!=
operator|(
name|rev
operator|&
name|BSR2X_REV_MASK
operator|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* status changed? */
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Check if the Cronyx-Sigma board is present at the given base port.  */
end_comment

begin_function
name|int
name|cx_probe_board
parameter_list|(
name|port_t
name|port
parameter_list|,
name|int
name|irq
parameter_list|,
name|int
name|dma
parameter_list|)
block|{
name|int
name|c0
decl_stmt|,
name|c1
decl_stmt|,
name|c2
init|=
literal|0
decl_stmt|,
name|c3
init|=
literal|0
decl_stmt|,
name|result
decl_stmt|;
if|if
condition|(
operator|!
name|valid
argument_list|(
name|port
argument_list|,
name|porttab
argument_list|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|irq
operator|>
literal|0
operator|&&
operator|!
name|valid
argument_list|(
name|irq
argument_list|,
name|irqtab
argument_list|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|dma
operator|>
literal|0
operator|&&
operator|!
name|valid
argument_list|(
name|dma
argument_list|,
name|dmatab
argument_list|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|cx_probe_800_chained_board
argument_list|(
name|port
argument_list|)
condition|)
block|{
comment|/* Sigma-800 detected. */
if|if
condition|(
operator|!
operator|(
name|inb
argument_list|(
name|BSR
argument_list|(
name|port
argument_list|)
argument_list|)
operator|&
name|BSR_NOCHAIN
operator|)
condition|)
block|{
comment|/* chained board attached */
if|if
condition|(
operator|!
name|cx_probe_800_chained_board
argument_list|(
name|port
operator|+
literal|0x10
argument_list|)
condition|)
comment|/* invalid chained board? */
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
operator|!
operator|(
name|inb
argument_list|(
name|BSR
argument_list|(
name|port
operator|+
literal|0x10
argument_list|)
argument_list|)
operator|&
name|BSR_NOCHAIN
operator|)
condition|)
comment|/* invalid chained board flag? */
return|return
operator|(
literal|0
operator|)
return|;
block|}
return|return
literal|1
return|;
block|}
if|if
condition|(
name|cx_probe_chained_board
argument_list|(
name|port
argument_list|,
operator|&
name|c0
argument_list|,
operator|&
name|c1
argument_list|)
condition|)
block|{
comment|/* Sigma-XXX detected. */
if|if
condition|(
operator|!
operator|(
name|inb
argument_list|(
name|BSR
argument_list|(
name|port
argument_list|)
argument_list|)
operator|&
name|BSR_NOCHAIN
operator|)
condition|)
block|{
comment|/* chained board attached */
if|if
condition|(
operator|!
name|cx_probe_chained_board
argument_list|(
name|port
operator|+
literal|0x10
argument_list|,
operator|&
name|c2
argument_list|,
operator|&
name|c3
argument_list|)
condition|)
comment|/* invalid chained board? */
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
operator|!
operator|(
name|inb
argument_list|(
name|BSR
argument_list|(
name|port
operator|+
literal|0x10
argument_list|)
argument_list|)
operator|&
name|BSR_NOCHAIN
operator|)
condition|)
comment|/* invalid chained board flag? */
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|cx_probe_2x_board
argument_list|(
name|port
argument_list|)
condition|)
block|{
name|c0
operator|=
literal|1
expr_stmt|;
comment|/* Sigma-2x detected. */
name|c1
operator|=
literal|0
expr_stmt|;
block|}
else|else
return|return
operator|(
literal|0
operator|)
return|;
comment|/* no board detected */
comment|/* Turn off the reset bit. */
name|outb
argument_list|(
name|BCR0
argument_list|(
name|port
argument_list|)
argument_list|,
name|BCR0_NORESET
argument_list|)
expr_stmt|;
if|if
condition|(
name|c2
operator|||
name|c3
condition|)
name|outb
argument_list|(
name|BCR0
argument_list|(
name|port
operator|+
literal|0x10
argument_list|)
argument_list|,
name|BCR0_NORESET
argument_list|)
expr_stmt|;
name|result
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|c0
operator|&&
operator|!
name|cx_probe_chip
argument_list|(
name|CS0
argument_list|(
name|port
argument_list|)
argument_list|)
condition|)
name|result
operator|=
literal|0
expr_stmt|;
comment|/* no CD2400 chip here */
elseif|else
if|if
condition|(
name|c1
operator|&&
operator|!
name|cx_probe_chip
argument_list|(
name|CS1A
argument_list|(
name|port
argument_list|)
argument_list|)
operator|&&
operator|!
name|cx_probe_chip
argument_list|(
name|CS1
argument_list|(
name|port
argument_list|)
argument_list|)
condition|)
name|result
operator|=
literal|0
expr_stmt|;
comment|/* no second CD2400 chip */
elseif|else
if|if
condition|(
name|c2
operator|&&
operator|!
name|cx_probe_chip
argument_list|(
name|CS0
argument_list|(
name|port
operator|+
literal|0x10
argument_list|)
argument_list|)
condition|)
name|result
operator|=
literal|0
expr_stmt|;
comment|/* no CD2400 chip on the slave board */
elseif|else
if|if
condition|(
name|c3
operator|&&
operator|!
name|cx_probe_chip
argument_list|(
name|CS1
argument_list|(
name|port
operator|+
literal|0x10
argument_list|)
argument_list|)
condition|)
name|result
operator|=
literal|0
expr_stmt|;
comment|/* no second CD2400 chip on the slave board */
comment|/* Reset the controller. */
name|outb
argument_list|(
name|BCR0
argument_list|(
name|port
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|c2
operator|||
name|c3
condition|)
name|outb
argument_list|(
name|BCR0
argument_list|(
name|port
operator|+
literal|0x10
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Yes, we really have valid Sigma board. */
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Check if the CD2400 chip is present at the given base port.  */
end_comment

begin_function
specifier|static
name|int
name|cx_probe_chip
parameter_list|(
name|port_t
name|base
parameter_list|)
block|{
name|int
name|rev
decl_stmt|,
name|newrev
decl_stmt|,
name|count
decl_stmt|;
comment|/* Wait up to 10 msec for revision code to appear after reset. */
name|rev
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|count
operator|=
literal|0
init|;
name|rev
operator|==
literal|0
condition|;
operator|++
name|count
control|)
block|{
if|if
condition|(
name|count
operator|>=
literal|20000
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* reset failed */
name|rev
operator|=
name|inb
argument_list|(
name|GFRCR
argument_list|(
name|base
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* Read and check the global firmware revision code. */
if|if
condition|(
operator|!
operator|(
name|rev
operator|>=
name|REVCL_MIN
operator|&&
name|rev
operator|<=
name|REVCL_MAX
operator|)
operator|&&
operator|!
operator|(
name|rev
operator|>=
name|REVCL31_MIN
operator|&&
name|rev
operator|<=
name|REVCL31_MAX
operator|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* CD2400/2431 revision does not match */
comment|/* Reset the chip. */
if|if
condition|(
operator|!
name|cx_reset
argument_list|(
name|base
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* Read and check the new global firmware revision code. */
name|newrev
operator|=
name|inb
argument_list|(
name|GFRCR
argument_list|(
name|base
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|newrev
operator|!=
name|rev
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* revision changed */
comment|/* Yes, we really have CD2400/2431 chip here. */
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Check that the irq is functional.  * irq>0  - activate the interrupt from the adapter (irq=on)  * irq<0  - deactivate the interrupt (irq=off)  * irq==0 - free the interrupt line (irq=tri-state)  * Return the interrupt mask _before_ activating irq.  */
end_comment

begin_function
name|int
name|cx_probe_irq
parameter_list|(
name|cx_board_t
modifier|*
name|b
parameter_list|,
name|int
name|irq
parameter_list|)
block|{
name|int
name|mask
decl_stmt|,
name|rev
decl_stmt|;
name|port_t
name|port
decl_stmt|;
name|rev
operator|=
name|inb
argument_list|(
name|BSR
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|)
expr_stmt|;
name|port
operator|=
operator|(
operator|(
name|rev
operator|&
name|BSR_VAR_MASK
operator|)
operator|!=
name|CRONYX_400
operator|)
condition|?
name|CS0
argument_list|(
name|b
operator|->
name|port
argument_list|)
else|:
name|CS1
argument_list|(
name|b
operator|->
name|port
argument_list|)
expr_stmt|;
name|outb
argument_list|(
literal|0x20
argument_list|,
literal|0x0a
argument_list|)
expr_stmt|;
name|mask
operator|=
name|inb
argument_list|(
literal|0x20
argument_list|)
expr_stmt|;
name|outb
argument_list|(
literal|0xa0
argument_list|,
literal|0x0a
argument_list|)
expr_stmt|;
name|mask
operator||=
name|inb
argument_list|(
literal|0xa0
argument_list|)
operator|<<
literal|8
expr_stmt|;
if|if
condition|(
name|irq
operator|>
literal|0
condition|)
block|{
name|outb
argument_list|(
name|BCR0
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|,
name|BCR0_NORESET
operator||
name|irqmask
index|[
name|irq
index|]
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|CAR
argument_list|(
name|port
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|cx_cmd
argument_list|(
name|port
argument_list|,
name|CCR_CLRCH
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|CMR
argument_list|(
name|port
argument_list|)
argument_list|,
name|CMR_HDLC
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|TCOR
argument_list|(
name|port
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|TBPR
argument_list|(
name|port
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|cx_cmd
argument_list|(
name|port
argument_list|,
name|CCR_INITCH
operator||
name|CCR_ENTX
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|IER
argument_list|(
name|port
argument_list|)
argument_list|,
name|IER_TXMPTY
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|irq
operator|<
literal|0
condition|)
block|{
name|cx_reset
argument_list|(
name|port
argument_list|)
expr_stmt|;
if|if
condition|(
operator|-
name|irq
operator|>
literal|7
condition|)
block|{
name|outb
argument_list|(
literal|0xa0
argument_list|,
literal|0x60
operator||
operator|(
operator|(
operator|-
name|irq
operator|)
operator|&
literal|7
operator|)
argument_list|)
expr_stmt|;
name|outb
argument_list|(
literal|0x20
argument_list|,
literal|0x62
argument_list|)
expr_stmt|;
block|}
else|else
name|outb
argument_list|(
literal|0x20
argument_list|,
literal|0x60
operator||
operator|(
operator|-
name|irq
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
name|outb
argument_list|(
name|BCR0
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|mask
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cx_chip_revision
parameter_list|(
name|port_t
name|port
parameter_list|,
name|int
name|rev
parameter_list|)
block|{
name|int
name|count
decl_stmt|;
comment|/* Model 400 has no first chip. */
name|port
operator|=
operator|(
operator|(
name|rev
operator|&
name|BSR_VAR_MASK
operator|)
operator|!=
name|CRONYX_400
operator|)
condition|?
name|CS0
argument_list|(
name|port
argument_list|)
else|:
name|CS1
argument_list|(
name|port
argument_list|)
expr_stmt|;
comment|/* Wait up to 10 msec for revision code to appear after reset. */
for|for
control|(
name|count
operator|=
literal|0
init|;
name|inb
argument_list|(
name|GFRCR
argument_list|(
name|port
argument_list|)
argument_list|)
operator|==
literal|0
condition|;
operator|++
name|count
control|)
if|if
condition|(
name|count
operator|>=
literal|20000
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* reset failed */
return|return
name|inb
argument_list|(
name|GFRCR
argument_list|(
name|port
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  * Probe and initialize the board structure.  */
end_comment

begin_function
name|void
name|cx_init
parameter_list|(
name|cx_board_t
modifier|*
name|b
parameter_list|,
name|int
name|num
parameter_list|,
name|port_t
name|port
parameter_list|,
name|int
name|irq
parameter_list|,
name|int
name|dma
parameter_list|)
block|{
name|int
name|gfrcr
decl_stmt|,
name|rev
decl_stmt|,
name|chain
decl_stmt|,
name|mod
init|=
literal|0
decl_stmt|,
name|rev2
init|=
literal|0
decl_stmt|,
name|mod2
init|=
literal|0
decl_stmt|;
name|rev
operator|=
name|inb
argument_list|(
name|BSR
argument_list|(
name|port
argument_list|)
argument_list|)
expr_stmt|;
name|chain
operator|=
operator|!
operator|(
name|rev
operator|&
name|BSR_NOCHAIN
operator|)
expr_stmt|;
if|if
condition|(
name|cx_probe_800_chained_board
argument_list|(
name|port
argument_list|)
condition|)
block|{
name|cx_init_800
argument_list|(
name|b
argument_list|,
name|num
argument_list|,
name|port
argument_list|,
name|irq
argument_list|,
name|dma
argument_list|,
name|chain
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|(
name|rev
operator|&
name|BSR2X_VAR_MASK
operator|)
operator|==
name|CRONYX_22
operator|||
operator|(
name|rev
operator|&
name|BSR2X_VAR_MASK
operator|)
operator|==
name|CRONYX_24
condition|)
block|{
name|cx_init_2x
argument_list|(
name|b
argument_list|,
name|num
argument_list|,
name|port
argument_list|,
name|irq
argument_list|,
name|dma
argument_list|,
operator|(
name|rev
operator|&
name|BSR2X_VAR_MASK
operator|)
argument_list|,
operator|(
name|rev
operator|&
name|BSR2X_OSC_33
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|outb
argument_list|(
name|BCR0
argument_list|(
name|port
argument_list|)
argument_list|,
name|BCR0_NORESET
argument_list|)
expr_stmt|;
if|if
condition|(
name|chain
condition|)
name|outb
argument_list|(
name|BCR0
argument_list|(
name|port
operator|+
literal|0x10
argument_list|)
argument_list|,
name|BCR0_NORESET
argument_list|)
expr_stmt|;
name|gfrcr
operator|=
name|cx_chip_revision
argument_list|(
name|port
argument_list|,
name|rev
argument_list|)
expr_stmt|;
if|if
condition|(
name|gfrcr
operator|>=
name|REVCL31_MIN
operator|&&
name|gfrcr
operator|<=
name|REVCL31_MAX
condition|)
name|mod
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|chain
condition|)
block|{
name|rev2
operator|=
name|inb
argument_list|(
name|BSR
argument_list|(
name|port
operator|+
literal|0x10
argument_list|)
argument_list|)
expr_stmt|;
name|gfrcr
operator|=
name|cx_chip_revision
argument_list|(
name|port
operator|+
literal|0x10
argument_list|,
name|rev2
argument_list|)
expr_stmt|;
if|if
condition|(
name|gfrcr
operator|>=
name|REVCL31_MIN
operator|&&
name|gfrcr
operator|<=
name|REVCL31_MAX
condition|)
name|mod2
operator|=
literal|1
expr_stmt|;
name|outb
argument_list|(
name|BCR0
argument_list|(
name|port
operator|+
literal|0x10
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|outb
argument_list|(
name|BCR0
argument_list|(
name|port
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|cx_init_board
argument_list|(
name|b
argument_list|,
name|num
argument_list|,
name|port
argument_list|,
name|irq
argument_list|,
name|dma
argument_list|,
name|chain
argument_list|,
operator|(
name|rev
operator|&
name|BSR_VAR_MASK
operator|)
argument_list|,
operator|(
name|rev
operator|&
name|BSR_OSC_MASK
operator|)
argument_list|,
name|mod
argument_list|,
operator|(
name|rev2
operator|&
name|BSR_VAR_MASK
operator|)
argument_list|,
operator|(
name|rev2
operator|&
name|BSR_OSC_MASK
operator|)
argument_list|,
name|mod2
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Initialize the board structure, given the type of the board.  */
end_comment

begin_function
name|void
name|cx_init_board
parameter_list|(
name|cx_board_t
modifier|*
name|b
parameter_list|,
name|int
name|num
parameter_list|,
name|port_t
name|port
parameter_list|,
name|int
name|irq
parameter_list|,
name|int
name|dma
parameter_list|,
name|int
name|chain
parameter_list|,
name|int
name|rev
parameter_list|,
name|int
name|osc
parameter_list|,
name|int
name|mod
parameter_list|,
name|int
name|rev2
parameter_list|,
name|int
name|osc2
parameter_list|,
name|int
name|mod2
parameter_list|)
block|{
name|cx_chan_t
modifier|*
name|c
decl_stmt|;
name|char
modifier|*
name|type
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* Initialize board structure. */
name|b
operator|->
name|port
operator|=
name|port
expr_stmt|;
name|b
operator|->
name|num
operator|=
name|num
expr_stmt|;
name|b
operator|->
name|irq
operator|=
name|irq
expr_stmt|;
name|b
operator|->
name|dma
operator|=
name|dma
expr_stmt|;
name|b
operator|->
name|opt
operator|=
name|board_opt_dflt
expr_stmt|;
name|b
operator|->
name|type
operator|=
name|B_SIGMA_XXX
expr_stmt|;
name|b
operator|->
name|if0type
operator|=
name|b
operator|->
name|if8type
operator|=
name|cx_iftype
expr_stmt|;
comment|/* Set channels 0 and 8 mode, set DMA and IRQ. */
name|b
operator|->
name|bcr0
operator|=
name|b
operator|->
name|bcr0b
operator|=
name|BCR0_NORESET
operator||
name|dmamask
index|[
name|b
operator|->
name|dma
index|]
operator||
name|irqmask
index|[
name|b
operator|->
name|irq
index|]
expr_stmt|;
comment|/* Clear DTR[0..3] and DTR[8..12]. */
name|b
operator|->
name|bcr1
operator|=
name|b
operator|->
name|bcr1b
operator|=
literal|0
expr_stmt|;
comment|/*------------------ Master board -------------------*/
comment|/* Read and check the board revision code. */
name|strcpy
argument_list|(
name|b
operator|->
name|name
argument_list|,
name|mod
condition|?
literal|"m"
else|:
literal|""
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|rev
condition|)
block|{
default|default:
name|type
operator|=
literal|""
expr_stmt|;
break|break;
case|case
name|CRONYX_100
case|:
name|type
operator|=
literal|"100"
expr_stmt|;
break|break;
case|case
name|CRONYX_400
case|:
name|type
operator|=
literal|"400"
expr_stmt|;
break|break;
case|case
name|CRONYX_500
case|:
name|type
operator|=
literal|"500"
expr_stmt|;
break|break;
case|case
name|CRONYX_410
case|:
name|type
operator|=
literal|"410"
expr_stmt|;
break|break;
case|case
name|CRONYX_810
case|:
name|type
operator|=
literal|"810"
expr_stmt|;
break|break;
case|case
name|CRONYX_410s
case|:
name|type
operator|=
literal|"410s"
expr_stmt|;
break|break;
case|case
name|CRONYX_810s
case|:
name|type
operator|=
literal|"810s"
expr_stmt|;
break|break;
case|case
name|CRONYX_440
case|:
name|type
operator|=
literal|"440"
expr_stmt|;
break|break;
case|case
name|CRONYX_840
case|:
name|type
operator|=
literal|"840"
expr_stmt|;
break|break;
case|case
name|CRONYX_401
case|:
name|type
operator|=
literal|"401"
expr_stmt|;
break|break;
case|case
name|CRONYX_801
case|:
name|type
operator|=
literal|"801"
expr_stmt|;
break|break;
case|case
name|CRONYX_401s
case|:
name|type
operator|=
literal|"401s"
expr_stmt|;
break|break;
case|case
name|CRONYX_801s
case|:
name|type
operator|=
literal|"801s"
expr_stmt|;
break|break;
case|case
name|CRONYX_404
case|:
name|type
operator|=
literal|"404"
expr_stmt|;
break|break;
case|case
name|CRONYX_703
case|:
name|type
operator|=
literal|"703"
expr_stmt|;
break|break;
block|}
name|strcat
argument_list|(
name|b
operator|->
name|name
argument_list|,
name|type
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|osc
condition|)
block|{
default|default:
case|case
name|BSR_OSC_20
case|:
comment|/* 20 MHz */
name|b
operator|->
name|chan
index|[
literal|0
index|]
operator|.
name|oscfreq
operator|=
name|b
operator|->
name|chan
index|[
literal|1
index|]
operator|.
name|oscfreq
operator|=
name|b
operator|->
name|chan
index|[
literal|2
index|]
operator|.
name|oscfreq
operator|=
name|b
operator|->
name|chan
index|[
literal|3
index|]
operator|.
name|oscfreq
operator|=
name|b
operator|->
name|chan
index|[
literal|4
index|]
operator|.
name|oscfreq
operator|=
name|b
operator|->
name|chan
index|[
literal|5
index|]
operator|.
name|oscfreq
operator|=
name|b
operator|->
name|chan
index|[
literal|6
index|]
operator|.
name|oscfreq
operator|=
name|b
operator|->
name|chan
index|[
literal|7
index|]
operator|.
name|oscfreq
operator|=
name|mod
condition|?
literal|33000000L
else|:
literal|20000000L
expr_stmt|;
name|strcat
argument_list|(
name|b
operator|->
name|name
argument_list|,
literal|"a"
argument_list|)
expr_stmt|;
break|break;
case|case
name|BSR_OSC_18432
case|:
comment|/* 18.432 MHz */
name|b
operator|->
name|chan
index|[
literal|0
index|]
operator|.
name|oscfreq
operator|=
name|b
operator|->
name|chan
index|[
literal|1
index|]
operator|.
name|oscfreq
operator|=
name|b
operator|->
name|chan
index|[
literal|2
index|]
operator|.
name|oscfreq
operator|=
name|b
operator|->
name|chan
index|[
literal|3
index|]
operator|.
name|oscfreq
operator|=
name|b
operator|->
name|chan
index|[
literal|4
index|]
operator|.
name|oscfreq
operator|=
name|b
operator|->
name|chan
index|[
literal|5
index|]
operator|.
name|oscfreq
operator|=
name|b
operator|->
name|chan
index|[
literal|6
index|]
operator|.
name|oscfreq
operator|=
name|b
operator|->
name|chan
index|[
literal|7
index|]
operator|.
name|oscfreq
operator|=
name|mod
condition|?
literal|20000000L
else|:
literal|18432000L
expr_stmt|;
name|strcat
argument_list|(
name|b
operator|->
name|name
argument_list|,
literal|"b"
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/*------------------ Slave board -------------------*/
if|if
condition|(
name|chain
condition|)
block|{
comment|/* Read and check the board revision code. */
name|strcat
argument_list|(
name|b
operator|->
name|name
argument_list|,
name|mod2
condition|?
literal|"/m"
else|:
literal|"/"
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|rev2
condition|)
block|{
default|default:
name|type
operator|=
literal|""
expr_stmt|;
break|break;
case|case
name|CRONYX_100
case|:
name|type
operator|=
literal|"100"
expr_stmt|;
break|break;
case|case
name|CRONYX_400
case|:
name|type
operator|=
literal|"400"
expr_stmt|;
break|break;
case|case
name|CRONYX_500
case|:
name|type
operator|=
literal|"500"
expr_stmt|;
break|break;
case|case
name|CRONYX_410
case|:
name|type
operator|=
literal|"410"
expr_stmt|;
break|break;
case|case
name|CRONYX_810
case|:
name|type
operator|=
literal|"810"
expr_stmt|;
break|break;
case|case
name|CRONYX_410s
case|:
name|type
operator|=
literal|"410s"
expr_stmt|;
break|break;
case|case
name|CRONYX_810s
case|:
name|type
operator|=
literal|"810s"
expr_stmt|;
break|break;
case|case
name|CRONYX_440
case|:
name|type
operator|=
literal|"440"
expr_stmt|;
break|break;
case|case
name|CRONYX_840
case|:
name|type
operator|=
literal|"840"
expr_stmt|;
break|break;
case|case
name|CRONYX_401
case|:
name|type
operator|=
literal|"401"
expr_stmt|;
break|break;
case|case
name|CRONYX_801
case|:
name|type
operator|=
literal|"801"
expr_stmt|;
break|break;
case|case
name|CRONYX_401s
case|:
name|type
operator|=
literal|"401s"
expr_stmt|;
break|break;
case|case
name|CRONYX_801s
case|:
name|type
operator|=
literal|"801s"
expr_stmt|;
break|break;
case|case
name|CRONYX_404
case|:
name|type
operator|=
literal|"404"
expr_stmt|;
break|break;
case|case
name|CRONYX_703
case|:
name|type
operator|=
literal|"703"
expr_stmt|;
break|break;
block|}
name|strcat
argument_list|(
name|b
operator|->
name|name
argument_list|,
name|type
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|osc2
condition|)
block|{
default|default:
case|case
name|BSR_OSC_20
case|:
comment|/* 20 MHz */
name|b
operator|->
name|chan
index|[
literal|8
index|]
operator|.
name|oscfreq
operator|=
name|b
operator|->
name|chan
index|[
literal|9
index|]
operator|.
name|oscfreq
operator|=
name|b
operator|->
name|chan
index|[
literal|10
index|]
operator|.
name|oscfreq
operator|=
name|b
operator|->
name|chan
index|[
literal|11
index|]
operator|.
name|oscfreq
operator|=
name|b
operator|->
name|chan
index|[
literal|12
index|]
operator|.
name|oscfreq
operator|=
name|b
operator|->
name|chan
index|[
literal|13
index|]
operator|.
name|oscfreq
operator|=
name|b
operator|->
name|chan
index|[
literal|14
index|]
operator|.
name|oscfreq
operator|=
name|b
operator|->
name|chan
index|[
literal|15
index|]
operator|.
name|oscfreq
operator|=
name|mod2
condition|?
literal|33000000L
else|:
literal|20000000L
expr_stmt|;
name|strcat
argument_list|(
name|b
operator|->
name|name
argument_list|,
literal|"a"
argument_list|)
expr_stmt|;
break|break;
case|case
name|BSR_OSC_18432
case|:
comment|/* 18.432 MHz */
name|b
operator|->
name|chan
index|[
literal|8
index|]
operator|.
name|oscfreq
operator|=
name|b
operator|->
name|chan
index|[
literal|9
index|]
operator|.
name|oscfreq
operator|=
name|b
operator|->
name|chan
index|[
literal|10
index|]
operator|.
name|oscfreq
operator|=
name|b
operator|->
name|chan
index|[
literal|11
index|]
operator|.
name|oscfreq
operator|=
name|b
operator|->
name|chan
index|[
literal|12
index|]
operator|.
name|oscfreq
operator|=
name|b
operator|->
name|chan
index|[
literal|13
index|]
operator|.
name|oscfreq
operator|=
name|b
operator|->
name|chan
index|[
literal|14
index|]
operator|.
name|oscfreq
operator|=
name|b
operator|->
name|chan
index|[
literal|15
index|]
operator|.
name|oscfreq
operator|=
name|mod2
condition|?
literal|20000000L
else|:
literal|18432000L
expr_stmt|;
name|strcat
argument_list|(
name|b
operator|->
name|name
argument_list|,
literal|"b"
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
comment|/* Initialize channel structures. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
operator|++
name|i
control|)
block|{
name|b
operator|->
name|chan
index|[
name|i
operator|+
literal|0
index|]
operator|.
name|port
operator|=
name|CS0
argument_list|(
name|port
argument_list|)
expr_stmt|;
name|b
operator|->
name|chan
index|[
name|i
operator|+
literal|4
index|]
operator|.
name|port
operator|=
name|cx_probe_chip
argument_list|(
name|CS1A
argument_list|(
name|port
argument_list|)
argument_list|)
condition|?
name|CS1A
argument_list|(
name|port
argument_list|)
else|:
name|CS1
argument_list|(
name|port
argument_list|)
expr_stmt|;
name|b
operator|->
name|chan
index|[
name|i
operator|+
literal|8
index|]
operator|.
name|port
operator|=
name|CS0
argument_list|(
name|port
operator|+
literal|0x10
argument_list|)
expr_stmt|;
name|b
operator|->
name|chan
index|[
name|i
operator|+
literal|12
index|]
operator|.
name|port
operator|=
name|CS1
argument_list|(
name|port
operator|+
literal|0x10
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|c
operator|=
name|b
operator|->
name|chan
init|;
name|c
operator|<
name|b
operator|->
name|chan
operator|+
name|NCHAN
condition|;
operator|++
name|c
control|)
block|{
name|c
operator|->
name|board
operator|=
name|b
expr_stmt|;
name|c
operator|->
name|num
operator|=
name|c
operator|-
name|b
operator|->
name|chan
expr_stmt|;
name|c
operator|->
name|type
operator|=
name|T_NONE
expr_stmt|;
block|}
comment|/*------------------ Master board -------------------*/
switch|switch
condition|(
name|rev
condition|)
block|{
case|case
name|CRONYX_400
case|:
for|for
control|(
name|i
operator|=
literal|4
init|;
name|i
operator|<
literal|8
condition|;
operator|++
name|i
control|)
name|b
operator|->
name|chan
index|[
name|i
index|]
operator|.
name|type
operator|=
name|T_UNIV_RS232
expr_stmt|;
break|break;
case|case
name|CRONYX_100
case|:
name|b
operator|->
name|chan
index|[
literal|0
index|]
operator|.
name|type
operator|=
name|T_UNIV_RS232
expr_stmt|;
break|break;
case|case
name|CRONYX_500
case|:
name|b
operator|->
name|chan
index|[
literal|0
index|]
operator|.
name|type
operator|=
name|T_UNIV_RS232
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|4
init|;
name|i
operator|<
literal|8
condition|;
operator|++
name|i
control|)
name|b
operator|->
name|chan
index|[
name|i
index|]
operator|.
name|type
operator|=
name|T_UNIV_RS232
expr_stmt|;
break|break;
case|case
name|CRONYX_410
case|:
name|b
operator|->
name|chan
index|[
literal|0
index|]
operator|.
name|type
operator|=
name|T_UNIV_V35
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
literal|4
condition|;
operator|++
name|i
control|)
name|b
operator|->
name|chan
index|[
name|i
index|]
operator|.
name|type
operator|=
name|T_UNIV_RS232
expr_stmt|;
break|break;
case|case
name|CRONYX_810
case|:
name|b
operator|->
name|chan
index|[
literal|0
index|]
operator|.
name|type
operator|=
name|T_UNIV_V35
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
literal|8
condition|;
operator|++
name|i
control|)
name|b
operator|->
name|chan
index|[
name|i
index|]
operator|.
name|type
operator|=
name|T_UNIV_RS232
expr_stmt|;
break|break;
case|case
name|CRONYX_410s
case|:
name|b
operator|->
name|chan
index|[
literal|0
index|]
operator|.
name|type
operator|=
name|T_UNIV_V35
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
literal|4
condition|;
operator|++
name|i
control|)
name|b
operator|->
name|chan
index|[
name|i
index|]
operator|.
name|type
operator|=
name|T_SYNC_RS232
expr_stmt|;
break|break;
case|case
name|CRONYX_810s
case|:
name|b
operator|->
name|chan
index|[
literal|0
index|]
operator|.
name|type
operator|=
name|T_UNIV_V35
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
literal|4
condition|;
operator|++
name|i
control|)
name|b
operator|->
name|chan
index|[
name|i
index|]
operator|.
name|type
operator|=
name|T_SYNC_RS232
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|4
init|;
name|i
operator|<
literal|8
condition|;
operator|++
name|i
control|)
name|b
operator|->
name|chan
index|[
name|i
index|]
operator|.
name|type
operator|=
name|T_UNIV_RS232
expr_stmt|;
break|break;
case|case
name|CRONYX_440
case|:
name|b
operator|->
name|chan
index|[
literal|0
index|]
operator|.
name|type
operator|=
name|T_UNIV_V35
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
literal|4
condition|;
operator|++
name|i
control|)
name|b
operator|->
name|chan
index|[
name|i
index|]
operator|.
name|type
operator|=
name|T_SYNC_V35
expr_stmt|;
break|break;
case|case
name|CRONYX_840
case|:
name|b
operator|->
name|chan
index|[
literal|0
index|]
operator|.
name|type
operator|=
name|T_UNIV_V35
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
literal|4
condition|;
operator|++
name|i
control|)
name|b
operator|->
name|chan
index|[
name|i
index|]
operator|.
name|type
operator|=
name|T_SYNC_V35
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|4
init|;
name|i
operator|<
literal|8
condition|;
operator|++
name|i
control|)
name|b
operator|->
name|chan
index|[
name|i
index|]
operator|.
name|type
operator|=
name|T_UNIV_RS232
expr_stmt|;
break|break;
case|case
name|CRONYX_401
case|:
name|b
operator|->
name|chan
index|[
literal|0
index|]
operator|.
name|type
operator|=
name|T_UNIV_RS449
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
literal|4
condition|;
operator|++
name|i
control|)
name|b
operator|->
name|chan
index|[
name|i
index|]
operator|.
name|type
operator|=
name|T_UNIV_RS232
expr_stmt|;
break|break;
case|case
name|CRONYX_801
case|:
name|b
operator|->
name|chan
index|[
literal|0
index|]
operator|.
name|type
operator|=
name|T_UNIV_RS449
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
literal|8
condition|;
operator|++
name|i
control|)
name|b
operator|->
name|chan
index|[
name|i
index|]
operator|.
name|type
operator|=
name|T_UNIV_RS232
expr_stmt|;
break|break;
case|case
name|CRONYX_401s
case|:
name|b
operator|->
name|chan
index|[
literal|0
index|]
operator|.
name|type
operator|=
name|T_UNIV_RS449
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
literal|4
condition|;
operator|++
name|i
control|)
name|b
operator|->
name|chan
index|[
name|i
index|]
operator|.
name|type
operator|=
name|T_SYNC_RS232
expr_stmt|;
break|break;
case|case
name|CRONYX_801s
case|:
name|b
operator|->
name|chan
index|[
literal|0
index|]
operator|.
name|type
operator|=
name|T_UNIV_RS449
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
literal|4
condition|;
operator|++
name|i
control|)
name|b
operator|->
name|chan
index|[
name|i
index|]
operator|.
name|type
operator|=
name|T_SYNC_RS232
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|4
init|;
name|i
operator|<
literal|8
condition|;
operator|++
name|i
control|)
name|b
operator|->
name|chan
index|[
name|i
index|]
operator|.
name|type
operator|=
name|T_UNIV_RS232
expr_stmt|;
break|break;
case|case
name|CRONYX_404
case|:
name|b
operator|->
name|chan
index|[
literal|0
index|]
operator|.
name|type
operator|=
name|T_UNIV_RS449
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
literal|4
condition|;
operator|++
name|i
control|)
name|b
operator|->
name|chan
index|[
name|i
index|]
operator|.
name|type
operator|=
name|T_SYNC_RS449
expr_stmt|;
break|break;
case|case
name|CRONYX_703
case|:
name|b
operator|->
name|chan
index|[
literal|0
index|]
operator|.
name|type
operator|=
name|T_UNIV_RS449
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
literal|3
condition|;
operator|++
name|i
control|)
name|b
operator|->
name|chan
index|[
name|i
index|]
operator|.
name|type
operator|=
name|T_SYNC_RS449
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|4
init|;
name|i
operator|<
literal|8
condition|;
operator|++
name|i
control|)
name|b
operator|->
name|chan
index|[
name|i
index|]
operator|.
name|type
operator|=
name|T_UNIV_RS232
expr_stmt|;
break|break;
block|}
comment|/*------------------ Slave board -------------------*/
if|if
condition|(
name|chain
condition|)
block|{
switch|switch
condition|(
name|rev2
condition|)
block|{
case|case
name|CRONYX_400
case|:
break|break;
case|case
name|CRONYX_100
case|:
name|b
operator|->
name|chan
index|[
literal|8
index|]
operator|.
name|type
operator|=
name|T_UNIV_RS232
expr_stmt|;
break|break;
case|case
name|CRONYX_500
case|:
name|b
operator|->
name|chan
index|[
literal|8
index|]
operator|.
name|type
operator|=
name|T_UNIV_RS232
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|12
init|;
name|i
operator|<
literal|16
condition|;
operator|++
name|i
control|)
name|b
operator|->
name|chan
index|[
name|i
index|]
operator|.
name|type
operator|=
name|T_UNIV_RS232
expr_stmt|;
break|break;
case|case
name|CRONYX_410
case|:
name|b
operator|->
name|chan
index|[
literal|8
index|]
operator|.
name|type
operator|=
name|T_UNIV_V35
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|9
init|;
name|i
operator|<
literal|12
condition|;
operator|++
name|i
control|)
name|b
operator|->
name|chan
index|[
name|i
index|]
operator|.
name|type
operator|=
name|T_UNIV_RS232
expr_stmt|;
break|break;
case|case
name|CRONYX_810
case|:
name|b
operator|->
name|chan
index|[
literal|8
index|]
operator|.
name|type
operator|=
name|T_UNIV_V35
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|9
init|;
name|i
operator|<
literal|16
condition|;
operator|++
name|i
control|)
name|b
operator|->
name|chan
index|[
name|i
index|]
operator|.
name|type
operator|=
name|T_UNIV_RS232
expr_stmt|;
break|break;
case|case
name|CRONYX_410s
case|:
name|b
operator|->
name|chan
index|[
literal|8
index|]
operator|.
name|type
operator|=
name|T_UNIV_V35
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|9
init|;
name|i
operator|<
literal|12
condition|;
operator|++
name|i
control|)
name|b
operator|->
name|chan
index|[
name|i
index|]
operator|.
name|type
operator|=
name|T_SYNC_RS232
expr_stmt|;
break|break;
case|case
name|CRONYX_810s
case|:
name|b
operator|->
name|chan
index|[
literal|8
index|]
operator|.
name|type
operator|=
name|T_UNIV_V35
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|9
init|;
name|i
operator|<
literal|12
condition|;
operator|++
name|i
control|)
name|b
operator|->
name|chan
index|[
name|i
index|]
operator|.
name|type
operator|=
name|T_SYNC_RS232
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|12
init|;
name|i
operator|<
literal|16
condition|;
operator|++
name|i
control|)
name|b
operator|->
name|chan
index|[
name|i
index|]
operator|.
name|type
operator|=
name|T_UNIV_RS232
expr_stmt|;
break|break;
case|case
name|CRONYX_440
case|:
name|b
operator|->
name|chan
index|[
literal|8
index|]
operator|.
name|type
operator|=
name|T_UNIV_V35
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|9
init|;
name|i
operator|<
literal|12
condition|;
operator|++
name|i
control|)
name|b
operator|->
name|chan
index|[
name|i
index|]
operator|.
name|type
operator|=
name|T_SYNC_V35
expr_stmt|;
break|break;
case|case
name|CRONYX_840
case|:
name|b
operator|->
name|chan
index|[
literal|8
index|]
operator|.
name|type
operator|=
name|T_UNIV_V35
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|9
init|;
name|i
operator|<
literal|12
condition|;
operator|++
name|i
control|)
name|b
operator|->
name|chan
index|[
name|i
index|]
operator|.
name|type
operator|=
name|T_SYNC_V35
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|12
init|;
name|i
operator|<
literal|16
condition|;
operator|++
name|i
control|)
name|b
operator|->
name|chan
index|[
name|i
index|]
operator|.
name|type
operator|=
name|T_UNIV_RS232
expr_stmt|;
break|break;
case|case
name|CRONYX_401
case|:
name|b
operator|->
name|chan
index|[
literal|8
index|]
operator|.
name|type
operator|=
name|T_UNIV_RS449
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|9
init|;
name|i
operator|<
literal|12
condition|;
operator|++
name|i
control|)
name|b
operator|->
name|chan
index|[
name|i
index|]
operator|.
name|type
operator|=
name|T_UNIV_RS232
expr_stmt|;
break|break;
case|case
name|CRONYX_801
case|:
name|b
operator|->
name|chan
index|[
literal|8
index|]
operator|.
name|type
operator|=
name|T_UNIV_RS449
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|9
init|;
name|i
operator|<
literal|16
condition|;
operator|++
name|i
control|)
name|b
operator|->
name|chan
index|[
name|i
index|]
operator|.
name|type
operator|=
name|T_UNIV_RS232
expr_stmt|;
break|break;
case|case
name|CRONYX_401s
case|:
name|b
operator|->
name|chan
index|[
literal|8
index|]
operator|.
name|type
operator|=
name|T_UNIV_RS449
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|9
init|;
name|i
operator|<
literal|12
condition|;
operator|++
name|i
control|)
name|b
operator|->
name|chan
index|[
name|i
index|]
operator|.
name|type
operator|=
name|T_UNIV_RS232
expr_stmt|;
break|break;
case|case
name|CRONYX_801s
case|:
name|b
operator|->
name|chan
index|[
literal|8
index|]
operator|.
name|type
operator|=
name|T_UNIV_RS449
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|9
init|;
name|i
operator|<
literal|12
condition|;
operator|++
name|i
control|)
name|b
operator|->
name|chan
index|[
name|i
index|]
operator|.
name|type
operator|=
name|T_SYNC_RS232
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|12
init|;
name|i
operator|<
literal|16
condition|;
operator|++
name|i
control|)
name|b
operator|->
name|chan
index|[
name|i
index|]
operator|.
name|type
operator|=
name|T_UNIV_RS232
expr_stmt|;
break|break;
case|case
name|CRONYX_404
case|:
name|b
operator|->
name|chan
index|[
literal|8
index|]
operator|.
name|type
operator|=
name|T_UNIV_RS449
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|9
init|;
name|i
operator|<
literal|12
condition|;
operator|++
name|i
control|)
name|b
operator|->
name|chan
index|[
name|i
index|]
operator|.
name|type
operator|=
name|T_SYNC_RS449
expr_stmt|;
break|break;
case|case
name|CRONYX_703
case|:
name|b
operator|->
name|chan
index|[
literal|8
index|]
operator|.
name|type
operator|=
name|T_UNIV_RS449
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|9
init|;
name|i
operator|<
literal|11
condition|;
operator|++
name|i
control|)
name|b
operator|->
name|chan
index|[
name|i
index|]
operator|.
name|type
operator|=
name|T_SYNC_RS449
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|12
init|;
name|i
operator|<
literal|16
condition|;
operator|++
name|i
control|)
name|b
operator|->
name|chan
index|[
name|i
index|]
operator|.
name|type
operator|=
name|T_UNIV_RS232
expr_stmt|;
break|break;
block|}
block|}
name|b
operator|->
name|nuniv
operator|=
name|b
operator|->
name|nsync
operator|=
name|b
operator|->
name|nasync
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|c
operator|=
name|b
operator|->
name|chan
init|;
name|c
operator|<
name|b
operator|->
name|chan
operator|+
name|NCHAN
condition|;
operator|++
name|c
control|)
switch|switch
condition|(
name|c
operator|->
name|type
condition|)
block|{
case|case
name|T_ASYNC
case|:
operator|++
name|b
operator|->
name|nasync
expr_stmt|;
break|break;
case|case
name|T_UNIV
case|:
case|case
name|T_UNIV_RS232
case|:
case|case
name|T_UNIV_RS449
case|:
case|case
name|T_UNIV_V35
case|:
operator|++
name|b
operator|->
name|nuniv
expr_stmt|;
break|break;
case|case
name|T_SYNC_RS232
case|:
case|case
name|T_SYNC_V35
case|:
case|case
name|T_SYNC_RS449
case|:
operator|++
name|b
operator|->
name|nsync
expr_stmt|;
break|break;
block|}
name|cx_reinit_board
argument_list|(
name|b
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Initialize the Sigma-800 board structure.  */
end_comment

begin_function
name|void
name|cx_init_800
parameter_list|(
name|cx_board_t
modifier|*
name|b
parameter_list|,
name|int
name|num
parameter_list|,
name|port_t
name|port
parameter_list|,
name|int
name|irq
parameter_list|,
name|int
name|dma
parameter_list|,
name|int
name|chain
parameter_list|)
block|{
name|cx_chan_t
modifier|*
name|c
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* Initialize board structure. */
name|b
operator|->
name|port
operator|=
name|port
expr_stmt|;
name|b
operator|->
name|num
operator|=
name|num
expr_stmt|;
name|b
operator|->
name|irq
operator|=
name|irq
expr_stmt|;
name|b
operator|->
name|dma
operator|=
name|dma
expr_stmt|;
name|b
operator|->
name|opt
operator|=
name|board_opt_dflt
expr_stmt|;
name|b
operator|->
name|type
operator|=
name|B_SIGMA_800
expr_stmt|;
comment|/* Set channels 0 and 8 mode, set DMA and IRQ. */
name|b
operator|->
name|bcr0
operator|=
name|b
operator|->
name|bcr0b
operator|=
name|dmamask
index|[
name|b
operator|->
name|dma
index|]
operator||
name|irqmask
index|[
name|b
operator|->
name|irq
index|]
expr_stmt|;
comment|/* Clear DTR[0..7] and DTR[8..15]. */
name|b
operator|->
name|bcr1
operator|=
name|b
operator|->
name|bcr1b
operator|=
literal|0
expr_stmt|;
name|strcpy
argument_list|(
name|b
operator|->
name|name
argument_list|,
literal|"800"
argument_list|)
expr_stmt|;
if|if
condition|(
name|chain
condition|)
name|strcat
argument_list|(
name|b
operator|->
name|name
argument_list|,
literal|"/800"
argument_list|)
expr_stmt|;
comment|/* Initialize channel structures. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
operator|++
name|i
control|)
block|{
name|b
operator|->
name|chan
index|[
name|i
operator|+
literal|0
index|]
operator|.
name|port
operator|=
name|CS0
argument_list|(
name|port
argument_list|)
expr_stmt|;
name|b
operator|->
name|chan
index|[
name|i
operator|+
literal|4
index|]
operator|.
name|port
operator|=
name|cx_probe_chip
argument_list|(
name|CS1A
argument_list|(
name|port
argument_list|)
argument_list|)
condition|?
name|CS1A
argument_list|(
name|port
argument_list|)
else|:
name|CS1
argument_list|(
name|port
argument_list|)
expr_stmt|;
name|b
operator|->
name|chan
index|[
name|i
operator|+
literal|8
index|]
operator|.
name|port
operator|=
name|CS0
argument_list|(
name|port
operator|+
literal|0x10
argument_list|)
expr_stmt|;
name|b
operator|->
name|chan
index|[
name|i
operator|+
literal|12
index|]
operator|.
name|port
operator|=
name|CS1
argument_list|(
name|port
operator|+
literal|0x10
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|c
operator|=
name|b
operator|->
name|chan
init|;
name|c
operator|<
name|b
operator|->
name|chan
operator|+
name|NCHAN
condition|;
operator|++
name|c
control|)
block|{
name|c
operator|->
name|board
operator|=
name|b
expr_stmt|;
name|c
operator|->
name|num
operator|=
name|c
operator|-
name|b
operator|->
name|chan
expr_stmt|;
name|c
operator|->
name|oscfreq
operator|=
literal|33000000L
expr_stmt|;
name|c
operator|->
name|type
operator|=
operator|(
name|c
operator|->
name|num
operator|<
literal|8
operator|||
name|chain
operator|)
condition|?
name|T_UNIV_RS232
else|:
name|T_NONE
expr_stmt|;
block|}
name|b
operator|->
name|nuniv
operator|=
name|b
operator|->
name|nsync
operator|=
name|b
operator|->
name|nasync
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|c
operator|=
name|b
operator|->
name|chan
init|;
name|c
operator|<
name|b
operator|->
name|chan
operator|+
name|NCHAN
condition|;
operator|++
name|c
control|)
switch|switch
condition|(
name|c
operator|->
name|type
condition|)
block|{
case|case
name|T_ASYNC
case|:
operator|++
name|b
operator|->
name|nasync
expr_stmt|;
break|break;
case|case
name|T_UNIV
case|:
case|case
name|T_UNIV_RS232
case|:
case|case
name|T_UNIV_RS449
case|:
case|case
name|T_UNIV_V35
case|:
operator|++
name|b
operator|->
name|nuniv
expr_stmt|;
break|break;
case|case
name|T_SYNC_RS232
case|:
case|case
name|T_SYNC_V35
case|:
case|case
name|T_SYNC_RS449
case|:
operator|++
name|b
operator|->
name|nsync
expr_stmt|;
break|break;
block|}
name|cx_reinit_board
argument_list|(
name|b
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Initialize the Sigma-2x board structure.  */
end_comment

begin_function
name|void
name|cx_init_2x
parameter_list|(
name|cx_board_t
modifier|*
name|b
parameter_list|,
name|int
name|num
parameter_list|,
name|port_t
name|port
parameter_list|,
name|int
name|irq
parameter_list|,
name|int
name|dma
parameter_list|,
name|int
name|rev
parameter_list|,
name|int
name|osc
parameter_list|)
block|{
name|cx_chan_t
modifier|*
name|c
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* Initialize board structure. */
name|b
operator|->
name|port
operator|=
name|port
expr_stmt|;
name|b
operator|->
name|num
operator|=
name|num
expr_stmt|;
name|b
operator|->
name|irq
operator|=
name|irq
expr_stmt|;
name|b
operator|->
name|dma
operator|=
name|dma
expr_stmt|;
name|b
operator|->
name|opt
operator|=
name|board_opt_dflt
expr_stmt|;
name|b
operator|->
name|type
operator|=
name|B_SIGMA_2X
expr_stmt|;
comment|/* Set channels 0 and 8 mode, set DMA and IRQ. */
name|b
operator|->
name|bcr0
operator|=
name|BCR0_NORESET
operator||
name|dmamask
index|[
name|b
operator|->
name|dma
index|]
operator||
name|irqmask
index|[
name|b
operator|->
name|irq
index|]
expr_stmt|;
if|if
condition|(
name|b
operator|->
name|type
operator|==
name|B_SIGMA_2X
operator|&&
name|b
operator|->
name|opt
operator|.
name|fast
condition|)
name|b
operator|->
name|bcr0
operator||=
name|BCR02X_FAST
expr_stmt|;
comment|/* Clear DTR[0..3] and DTR[8..12]. */
name|b
operator|->
name|bcr1
operator|=
literal|0
expr_stmt|;
comment|/* Initialize channel structures. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
operator|++
name|i
control|)
block|{
name|b
operator|->
name|chan
index|[
name|i
operator|+
literal|0
index|]
operator|.
name|port
operator|=
name|CS0
argument_list|(
name|port
argument_list|)
expr_stmt|;
name|b
operator|->
name|chan
index|[
name|i
operator|+
literal|4
index|]
operator|.
name|port
operator|=
name|CS1
argument_list|(
name|port
argument_list|)
expr_stmt|;
name|b
operator|->
name|chan
index|[
name|i
operator|+
literal|8
index|]
operator|.
name|port
operator|=
name|CS0
argument_list|(
name|port
operator|+
literal|0x10
argument_list|)
expr_stmt|;
name|b
operator|->
name|chan
index|[
name|i
operator|+
literal|12
index|]
operator|.
name|port
operator|=
name|CS1
argument_list|(
name|port
operator|+
literal|0x10
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|c
operator|=
name|b
operator|->
name|chan
init|;
name|c
operator|<
name|b
operator|->
name|chan
operator|+
name|NCHAN
condition|;
operator|++
name|c
control|)
block|{
name|c
operator|->
name|board
operator|=
name|b
expr_stmt|;
name|c
operator|->
name|num
operator|=
name|c
operator|-
name|b
operator|->
name|chan
expr_stmt|;
name|c
operator|->
name|type
operator|=
name|T_NONE
expr_stmt|;
name|c
operator|->
name|oscfreq
operator|=
operator|(
name|osc
operator|&
name|BSR2X_OSC_33
operator|)
condition|?
literal|33000000L
else|:
literal|20000000L
expr_stmt|;
block|}
comment|/* Check the board revision code. */
name|strcpy
argument_list|(
name|b
operator|->
name|name
argument_list|,
literal|"22"
argument_list|)
expr_stmt|;
name|b
operator|->
name|chan
index|[
literal|0
index|]
operator|.
name|type
operator|=
name|T_UNIV
expr_stmt|;
name|b
operator|->
name|chan
index|[
literal|1
index|]
operator|.
name|type
operator|=
name|T_UNIV
expr_stmt|;
name|b
operator|->
name|nsync
operator|=
name|b
operator|->
name|nasync
operator|=
literal|0
expr_stmt|;
name|b
operator|->
name|nuniv
operator|=
literal|2
expr_stmt|;
if|if
condition|(
name|rev
operator|==
name|CRONYX_24
condition|)
block|{
name|strcpy
argument_list|(
name|b
operator|->
name|name
argument_list|,
literal|"24"
argument_list|)
expr_stmt|;
name|b
operator|->
name|chan
index|[
literal|2
index|]
operator|.
name|type
operator|=
name|T_UNIV
expr_stmt|;
name|b
operator|->
name|chan
index|[
literal|3
index|]
operator|.
name|type
operator|=
name|T_UNIV
expr_stmt|;
name|b
operator|->
name|nuniv
operator|+=
literal|2
expr_stmt|;
block|}
name|strcat
argument_list|(
name|b
operator|->
name|name
argument_list|,
operator|(
name|osc
operator|&
name|BSR2X_OSC_33
operator|)
condition|?
literal|"c"
else|:
literal|"a"
argument_list|)
expr_stmt|;
name|cx_reinit_board
argument_list|(
name|b
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Reinitialize all channels, using new options and baud rate.  */
end_comment

begin_function
name|void
name|cx_reinit_board
parameter_list|(
name|cx_board_t
modifier|*
name|b
parameter_list|)
block|{
name|cx_chan_t
modifier|*
name|c
decl_stmt|;
name|b
operator|->
name|opt
operator|=
name|board_opt_dflt
expr_stmt|;
if|if
condition|(
name|b
operator|->
name|type
operator|==
name|B_SIGMA_2X
condition|)
block|{
name|b
operator|->
name|bcr0
operator|&=
operator|~
name|BCR02X_FAST
expr_stmt|;
if|if
condition|(
name|b
operator|->
name|opt
operator|.
name|fast
condition|)
name|b
operator|->
name|bcr0
operator||=
name|BCR02X_FAST
expr_stmt|;
block|}
else|else
name|b
operator|->
name|if0type
operator|=
name|b
operator|->
name|if8type
operator|=
name|cx_iftype
expr_stmt|;
for|for
control|(
name|c
operator|=
name|b
operator|->
name|chan
init|;
name|c
operator|<
name|b
operator|->
name|chan
operator|+
name|NCHAN
condition|;
operator|++
name|c
control|)
block|{
switch|switch
condition|(
name|c
operator|->
name|type
condition|)
block|{
default|default:
case|case
name|T_NONE
case|:
continue|continue;
case|case
name|T_UNIV
case|:
case|case
name|T_UNIV_RS232
case|:
case|case
name|T_UNIV_RS449
case|:
case|case
name|T_UNIV_V35
case|:
name|c
operator|->
name|mode
operator|=
operator|(
name|cx_univ_mode
operator|==
name|M_ASYNC
operator|)
condition|?
name|M_ASYNC
else|:
name|cx_sync_mode
expr_stmt|;
break|break;
case|case
name|T_SYNC_RS232
case|:
case|case
name|T_SYNC_V35
case|:
case|case
name|T_SYNC_RS449
case|:
name|c
operator|->
name|mode
operator|=
name|cx_sync_mode
expr_stmt|;
break|break;
case|case
name|T_ASYNC
case|:
name|c
operator|->
name|mode
operator|=
name|M_ASYNC
expr_stmt|;
break|break;
block|}
name|c
operator|->
name|rxbaud
operator|=
name|cx_rxbaud
expr_stmt|;
name|c
operator|->
name|txbaud
operator|=
name|cx_txbaud
expr_stmt|;
name|c
operator|->
name|opt
operator|=
name|chan_opt_dflt
expr_stmt|;
name|c
operator|->
name|aopt
operator|=
name|opt_async_dflt
expr_stmt|;
name|c
operator|->
name|hopt
operator|=
name|opt_hdlc_dflt
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Set up the board.  */
end_comment

begin_function
name|int
name|cx_setup_board
parameter_list|(
name|cx_board_t
modifier|*
name|b
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|firmware
parameter_list|,
name|long
name|bits
parameter_list|,
specifier|const
name|cr_dat_tst_t
modifier|*
name|tst
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
ifndef|#
directive|ifndef
name|NDIS_MINIPORT_DRIVER
comment|/* Disable DMA channel. */
name|outb
argument_list|(
name|DMA_MASK
argument_list|,
operator|(
name|b
operator|->
name|dma
operator|&
literal|3
operator|)
operator||
name|DMA_MASK_CLEAR
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* Reset the controller. */
name|outb
argument_list|(
name|BCR0
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|b
operator|->
name|chan
index|[
literal|8
index|]
operator|.
name|type
operator|||
name|b
operator|->
name|chan
index|[
literal|12
index|]
operator|.
name|type
condition|)
name|outb
argument_list|(
name|BCR0
argument_list|(
name|b
operator|->
name|port
operator|+
literal|0x10
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Load the firmware. */
if|if
condition|(
name|b
operator|->
name|type
operator|==
name|B_SIGMA_800
condition|)
block|{
comment|/* Reset the controllers. */
name|outb
argument_list|(
name|BCR2
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|,
name|BCR2_TMS
argument_list|)
expr_stmt|;
if|if
condition|(
name|b
operator|->
name|chan
index|[
literal|8
index|]
operator|.
name|type
operator|||
name|b
operator|->
name|chan
index|[
literal|12
index|]
operator|.
name|type
condition|)
name|outb
argument_list|(
name|BCR2
argument_list|(
name|b
operator|->
name|port
operator|+
literal|0x10
argument_list|)
argument_list|,
name|BCR2_TMS
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|BCR2
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|b
operator|->
name|chan
index|[
literal|8
index|]
operator|.
name|type
operator|||
name|b
operator|->
name|chan
index|[
literal|12
index|]
operator|.
name|type
condition|)
name|outb
argument_list|(
name|BCR2
argument_list|(
name|b
operator|->
name|port
operator|+
literal|0x10
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|firmware
operator|&&
operator|(
operator|!
name|cx_download
argument_list|(
name|b
operator|->
name|port
argument_list|,
name|firmware
argument_list|,
name|bits
argument_list|,
name|tst
argument_list|)
operator|||
operator|(
operator|(
name|b
operator|->
name|chan
index|[
literal|8
index|]
operator|.
name|type
operator|||
name|b
operator|->
name|chan
index|[
literal|12
index|]
operator|.
name|type
operator|)
operator|&&
operator|!
name|cx_download
argument_list|(
name|b
operator|->
name|port
operator|+
literal|0x10
argument_list|,
name|firmware
argument_list|,
name|bits
argument_list|,
name|tst
argument_list|)
operator|)
operator|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
block|}
comment|/* 	 * Set channels 0 and 8 to RS232 async. mode. 	 * Enable DMA and IRQ. 	 */
name|outb
argument_list|(
name|BCR0
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|,
name|b
operator|->
name|bcr0
argument_list|)
expr_stmt|;
if|if
condition|(
name|b
operator|->
name|chan
index|[
literal|8
index|]
operator|.
name|type
operator|||
name|b
operator|->
name|chan
index|[
literal|12
index|]
operator|.
name|type
condition|)
name|outb
argument_list|(
name|BCR0
argument_list|(
name|b
operator|->
name|port
operator|+
literal|0x10
argument_list|)
argument_list|,
name|b
operator|->
name|bcr0b
argument_list|)
expr_stmt|;
comment|/* Clear DTR[0..3] and DTR[8..12]. */
name|outw
argument_list|(
name|BCR1
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|,
name|b
operator|->
name|bcr1
argument_list|)
expr_stmt|;
if|if
condition|(
name|b
operator|->
name|chan
index|[
literal|8
index|]
operator|.
name|type
operator|||
name|b
operator|->
name|chan
index|[
literal|12
index|]
operator|.
name|type
condition|)
name|outw
argument_list|(
name|BCR1
argument_list|(
name|b
operator|->
name|port
operator|+
literal|0x10
argument_list|)
argument_list|,
name|b
operator|->
name|bcr1b
argument_list|)
expr_stmt|;
if|if
condition|(
name|b
operator|->
name|type
operator|==
name|B_SIGMA_800
condition|)
name|outb
argument_list|(
name|BCR2
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|,
name|b
operator|->
name|opt
operator|.
name|fast
operator|&
operator|(
name|BCR2_BUS0
operator||
name|BCR2_BUS1
operator|)
argument_list|)
expr_stmt|;
comment|/* Initialize all controllers. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NCHAN
condition|;
name|i
operator|+=
literal|4
control|)
if|if
condition|(
name|b
operator|->
name|chan
index|[
name|i
index|]
operator|.
name|type
operator|!=
name|T_NONE
condition|)
name|cx_setup_chip
argument_list|(
name|b
operator|->
name|chan
operator|+
name|i
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|NDIS_MINIPORT_DRIVER
comment|/* Set up DMA channel to master mode. */
name|outb
argument_list|(
name|DMA_MODE
argument_list|,
operator|(
name|b
operator|->
name|dma
operator|&
literal|3
operator|)
operator||
name|DMA_MODE_MASTER
argument_list|)
expr_stmt|;
comment|/* Enable DMA channel. */
name|outb
argument_list|(
name|DMA_MASK
argument_list|,
name|b
operator|->
name|dma
operator|&
literal|3
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* Initialize all channels. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NCHAN
condition|;
operator|++
name|i
control|)
if|if
condition|(
name|b
operator|->
name|chan
index|[
name|i
index|]
operator|.
name|type
operator|!=
name|T_NONE
condition|)
name|cx_setup_chan
argument_list|(
name|b
operator|->
name|chan
operator|+
name|i
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Initialize the board.  */
end_comment

begin_function
specifier|static
name|void
name|cx_setup_chip
parameter_list|(
name|cx_chan_t
modifier|*
name|c
parameter_list|)
block|{
comment|/* Reset the chip. */
name|cx_reset
argument_list|(
name|c
operator|->
name|port
argument_list|)
expr_stmt|;
comment|/* 	 * Set all interrupt level registers to the same value. 	 * This enables the internal CD2400 priority scheme. 	 */
name|outb
argument_list|(
name|RPILR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|BRD_INTR_LEVEL
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|TPILR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|BRD_INTR_LEVEL
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|MPILR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|BRD_INTR_LEVEL
argument_list|)
expr_stmt|;
comment|/* Set bus error count to zero. */
name|outb
argument_list|(
name|BERCNT
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Set 16-bit DMA mode. */
name|outb
argument_list|(
name|DMR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Set timer period register to 1 msec (approximately). */
name|outb
argument_list|(
name|TPR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Initialize the CD2400 channel.  */
end_comment

begin_function
name|void
name|cx_update_chan
parameter_list|(
name|cx_chan_t
modifier|*
name|c
parameter_list|)
block|{
name|int
name|clock
decl_stmt|,
name|period
decl_stmt|;
if|if
condition|(
name|c
operator|->
name|board
operator|->
name|type
operator|==
name|B_SIGMA_XXX
condition|)
switch|switch
condition|(
name|c
operator|->
name|num
condition|)
block|{
case|case
literal|0
case|:
name|c
operator|->
name|board
operator|->
name|bcr0
operator|&=
operator|~
name|BCR0_UMASK
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|mode
operator|!=
name|M_ASYNC
condition|)
name|c
operator|->
name|board
operator|->
name|bcr0
operator||=
name|BCR0_UM_SYNC
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|board
operator|->
name|if0type
operator|&&
operator|(
name|c
operator|->
name|type
operator|==
name|T_UNIV_RS449
operator|||
name|c
operator|->
name|type
operator|==
name|T_UNIV_V35
operator|)
condition|)
name|c
operator|->
name|board
operator|->
name|bcr0
operator||=
name|BCR0_UI_RS449
expr_stmt|;
name|outb
argument_list|(
name|BCR0
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|board
operator|->
name|bcr0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|8
case|:
name|c
operator|->
name|board
operator|->
name|bcr0b
operator|&=
operator|~
name|BCR0_UMASK
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|mode
operator|!=
name|M_ASYNC
condition|)
name|c
operator|->
name|board
operator|->
name|bcr0b
operator||=
name|BCR0_UM_SYNC
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|board
operator|->
name|if8type
operator|&&
operator|(
name|c
operator|->
name|type
operator|==
name|T_UNIV_RS449
operator|||
name|c
operator|->
name|type
operator|==
name|T_UNIV_V35
operator|)
condition|)
name|c
operator|->
name|board
operator|->
name|bcr0b
operator||=
name|BCR0_UI_RS449
expr_stmt|;
name|outb
argument_list|(
name|BCR0
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
operator|+
literal|0x10
argument_list|)
argument_list|,
name|c
operator|->
name|board
operator|->
name|bcr0b
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* set current channel number */
name|outb
argument_list|(
name|CAR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|num
operator|&
literal|3
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|c
operator|->
name|mode
condition|)
block|{
comment|/* initialize the channel mode */
case|case
name|M_ASYNC
case|:
comment|/* set receiver timeout register */
name|outw
argument_list|(
name|RTPR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
literal|10
argument_list|)
expr_stmt|;
comment|/* 10 msec, see TPR */
name|c
operator|->
name|opt
operator|.
name|rcor
operator|.
name|encod
operator|=
name|ENCOD_NRZ
expr_stmt|;
name|outb
argument_list|(
name|CMR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|CMR_RXDMA
operator||
name|CMR_TXDMA
operator||
name|CMR_ASYNC
argument_list|)
expr_stmt|;
name|outb
argument_list|(
argument|COR1(c->port)
argument_list|,
argument|BYTE c->aopt.cor1
argument_list|)
empty_stmt|;
name|outb
argument_list|(
argument|COR2(c->port)
argument_list|,
argument|BYTE c->aopt.cor2
argument_list|)
empty_stmt|;
name|outb
argument_list|(
argument|COR3(c->port)
argument_list|,
argument|BYTE c->aopt.cor3
argument_list|)
empty_stmt|;
name|outb
argument_list|(
argument|COR6(c->port)
argument_list|,
argument|BYTE c->aopt.cor6
argument_list|)
empty_stmt|;
name|outb
argument_list|(
argument|COR7(c->port)
argument_list|,
argument|BYTE c->aopt.cor7
argument_list|)
empty_stmt|;
name|outb
argument_list|(
name|SCHR1
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|aopt
operator|.
name|schr1
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|SCHR2
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|aopt
operator|.
name|schr2
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|SCHR3
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|aopt
operator|.
name|schr3
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|SCHR4
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|aopt
operator|.
name|schr4
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|SCRL
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|aopt
operator|.
name|scrl
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|SCRH
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|aopt
operator|.
name|scrh
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|LNXT
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|aopt
operator|.
name|lnxt
argument_list|)
expr_stmt|;
break|break;
case|case
name|M_HDLC
case|:
name|outb
argument_list|(
name|CMR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|CMR_RXDMA
operator||
name|CMR_TXDMA
operator||
name|CMR_HDLC
argument_list|)
expr_stmt|;
name|outb
argument_list|(
argument|COR1(c->port)
argument_list|,
argument|BYTE c->hopt.cor1
argument_list|)
empty_stmt|;
name|outb
argument_list|(
argument|COR2(c->port)
argument_list|,
argument|BYTE c->hopt.cor2
argument_list|)
empty_stmt|;
name|outb
argument_list|(
argument|COR3(c->port)
argument_list|,
argument|BYTE c->hopt.cor3
argument_list|)
empty_stmt|;
name|outb
argument_list|(
name|RFAR1
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|hopt
operator|.
name|rfar1
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|RFAR2
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|hopt
operator|.
name|rfar2
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|RFAR3
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|hopt
operator|.
name|rfar3
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|RFAR4
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|hopt
operator|.
name|rfar4
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|CPSR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|hopt
operator|.
name|cpsr
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* set mode-independent options */
name|outb
argument_list|(
argument|COR4(c->port)
argument_list|,
argument|BYTE c->opt.cor4
argument_list|)
empty_stmt|;
name|outb
argument_list|(
argument|COR5(c->port)
argument_list|,
argument|BYTE c->opt.cor5
argument_list|)
empty_stmt|;
comment|/* set up receiver clock values */
if|if
condition|(
name|c
operator|->
name|mode
operator|==
name|M_ASYNC
operator|||
name|c
operator|->
name|opt
operator|.
name|rcor
operator|.
name|dpll
operator|||
name|c
operator|->
name|opt
operator|.
name|tcor
operator|.
name|llm
condition|)
block|{
name|cx_clock
argument_list|(
name|c
operator|->
name|oscfreq
argument_list|,
name|c
operator|->
name|rxbaud
argument_list|,
operator|&
name|clock
argument_list|,
operator|&
name|period
argument_list|)
expr_stmt|;
name|c
operator|->
name|opt
operator|.
name|rcor
operator|.
name|clk
operator|=
name|clock
expr_stmt|;
block|}
else|else
block|{
name|c
operator|->
name|opt
operator|.
name|rcor
operator|.
name|clk
operator|=
name|CLK_EXT
expr_stmt|;
name|period
operator|=
literal|1
expr_stmt|;
block|}
name|outb
argument_list|(
argument|RCOR(c->port)
argument_list|,
argument|BYTE c->opt.rcor
argument_list|)
empty_stmt|;
name|outb
argument_list|(
name|RBPR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|period
argument_list|)
expr_stmt|;
comment|/* set up transmitter clock values */
if|if
condition|(
name|c
operator|->
name|mode
operator|==
name|M_ASYNC
operator|||
operator|!
name|c
operator|->
name|opt
operator|.
name|tcor
operator|.
name|ext1x
condition|)
block|{
name|unsigned
name|ext1x
init|=
name|c
operator|->
name|opt
operator|.
name|tcor
operator|.
name|ext1x
decl_stmt|;
name|c
operator|->
name|opt
operator|.
name|tcor
operator|.
name|ext1x
operator|=
literal|0
expr_stmt|;
name|cx_clock
argument_list|(
name|c
operator|->
name|oscfreq
argument_list|,
name|c
operator|->
name|txbaud
argument_list|,
operator|&
name|clock
argument_list|,
operator|&
name|period
argument_list|)
expr_stmt|;
name|c
operator|->
name|opt
operator|.
name|tcor
operator|.
name|clk
operator|=
name|clock
expr_stmt|;
name|c
operator|->
name|opt
operator|.
name|tcor
operator|.
name|ext1x
operator|=
name|ext1x
expr_stmt|;
block|}
else|else
block|{
name|c
operator|->
name|opt
operator|.
name|tcor
operator|.
name|clk
operator|=
name|CLK_EXT
expr_stmt|;
name|period
operator|=
literal|1
expr_stmt|;
block|}
name|outb
argument_list|(
argument|TCOR(c->port)
argument_list|,
argument|BYTE c->opt.tcor
argument_list|)
empty_stmt|;
name|outb
argument_list|(
name|TBPR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|period
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Initialize the CD2400 channel.  */
end_comment

begin_function
name|void
name|cx_setup_chan
parameter_list|(
name|cx_chan_t
modifier|*
name|c
parameter_list|)
block|{
comment|/* set current channel number */
name|outb
argument_list|(
name|CAR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|num
operator|&
literal|3
argument_list|)
expr_stmt|;
comment|/* reset the channel */
name|cx_cmd
argument_list|(
name|c
operator|->
name|port
argument_list|,
name|CCR_CLRCH
argument_list|)
expr_stmt|;
comment|/* set LIVR to contain the board and channel numbers */
name|outb
argument_list|(
name|LIVR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|board
operator|->
name|num
operator|<<
literal|6
operator||
name|c
operator|->
name|num
operator|<<
literal|2
argument_list|)
expr_stmt|;
comment|/* clear DTR, RTS, set TXCout/DTR pin */
name|outb
argument_list|(
name|MSVR_RTS
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|MSVR_DTR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|mode
operator|==
name|M_ASYNC
condition|?
literal|0
else|:
name|MSV_TXCOUT
argument_list|)
expr_stmt|;
comment|/* set receiver A buffer physical address */
name|outw
argument_list|(
name|ARBADRU
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
call|(
name|unsigned
name|short
call|)
argument_list|(
name|c
operator|->
name|arphys
operator|>>
literal|16
argument_list|)
argument_list|)
expr_stmt|;
name|outw
argument_list|(
name|ARBADRL
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
operator|(
name|unsigned
name|short
operator|)
name|c
operator|->
name|arphys
argument_list|)
expr_stmt|;
comment|/* set receiver B buffer physical address */
name|outw
argument_list|(
name|BRBADRU
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
call|(
name|unsigned
name|short
call|)
argument_list|(
name|c
operator|->
name|brphys
operator|>>
literal|16
argument_list|)
argument_list|)
expr_stmt|;
name|outw
argument_list|(
name|BRBADRL
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
operator|(
name|unsigned
name|short
operator|)
name|c
operator|->
name|brphys
argument_list|)
expr_stmt|;
comment|/* set transmitter A buffer physical address */
name|outw
argument_list|(
name|ATBADRU
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
call|(
name|unsigned
name|short
call|)
argument_list|(
name|c
operator|->
name|atphys
operator|>>
literal|16
argument_list|)
argument_list|)
expr_stmt|;
name|outw
argument_list|(
name|ATBADRL
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
operator|(
name|unsigned
name|short
operator|)
name|c
operator|->
name|atphys
argument_list|)
expr_stmt|;
comment|/* set transmitter B buffer physical address */
name|outw
argument_list|(
name|BTBADRU
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
call|(
name|unsigned
name|short
call|)
argument_list|(
name|c
operator|->
name|btphys
operator|>>
literal|16
argument_list|)
argument_list|)
expr_stmt|;
name|outw
argument_list|(
name|BTBADRL
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
operator|(
name|unsigned
name|short
operator|)
name|c
operator|->
name|btphys
argument_list|)
expr_stmt|;
name|c
operator|->
name|dtr
operator|=
literal|0
expr_stmt|;
name|c
operator|->
name|rts
operator|=
literal|0
expr_stmt|;
name|cx_update_chan
argument_list|(
name|c
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Control DTR signal for the channel.  * Turn it on/off.  */
end_comment

begin_function
name|void
name|cx_set_dtr
parameter_list|(
name|cx_chan_t
modifier|*
name|c
parameter_list|,
name|int
name|on
parameter_list|)
block|{
name|cx_board_t
modifier|*
name|b
init|=
name|c
operator|->
name|board
decl_stmt|;
name|c
operator|->
name|dtr
operator|=
name|on
condition|?
literal|1
else|:
literal|0
expr_stmt|;
if|if
condition|(
name|b
operator|->
name|type
operator|==
name|B_SIGMA_2X
condition|)
block|{
if|if
condition|(
name|on
condition|)
name|b
operator|->
name|bcr1
operator||=
name|BCR1_DTR
argument_list|(
name|c
operator|->
name|num
argument_list|)
expr_stmt|;
else|else
name|b
operator|->
name|bcr1
operator|&=
operator|~
name|BCR1_DTR
argument_list|(
name|c
operator|->
name|num
argument_list|)
expr_stmt|;
name|outw
argument_list|(
name|BCR1
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|,
name|b
operator|->
name|bcr1
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|b
operator|->
name|type
operator|==
name|B_SIGMA_800
condition|)
block|{
if|if
condition|(
name|c
operator|->
name|num
operator|>=
literal|8
condition|)
block|{
if|if
condition|(
name|on
condition|)
name|b
operator|->
name|bcr1b
operator||=
name|BCR1800_DTR
argument_list|(
name|c
operator|->
name|num
argument_list|)
expr_stmt|;
else|else
name|b
operator|->
name|bcr1b
operator|&=
operator|~
name|BCR1800_DTR
argument_list|(
name|c
operator|->
name|num
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|BCR1
argument_list|(
name|b
operator|->
name|port
operator|+
literal|0x10
argument_list|)
argument_list|,
name|b
operator|->
name|bcr1b
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|on
condition|)
name|b
operator|->
name|bcr1
operator||=
name|BCR1800_DTR
argument_list|(
name|c
operator|->
name|num
argument_list|)
expr_stmt|;
else|else
name|b
operator|->
name|bcr1
operator|&=
operator|~
name|BCR1800_DTR
argument_list|(
name|c
operator|->
name|num
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|BCR1
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|,
name|b
operator|->
name|bcr1
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
if|if
condition|(
name|c
operator|->
name|mode
operator|==
name|M_ASYNC
condition|)
block|{
name|outb
argument_list|(
name|CAR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|num
operator|&
literal|3
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|MSVR_DTR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|on
condition|?
name|MSV_DTR
else|:
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
switch|switch
condition|(
name|c
operator|->
name|num
condition|)
block|{
default|default:
comment|/* Channels 4..7 and 12..15 in synchronous mode 		 * have no DTR signal. */
break|break;
case|case
literal|1
case|:
case|case
literal|2
case|:
case|case
literal|3
case|:
if|if
condition|(
name|c
operator|->
name|type
operator|==
name|T_UNIV_RS232
condition|)
break|break;
case|case
literal|0
case|:
if|if
condition|(
name|on
condition|)
name|b
operator|->
name|bcr1
operator||=
name|BCR1_DTR
argument_list|(
name|c
operator|->
name|num
argument_list|)
expr_stmt|;
else|else
name|b
operator|->
name|bcr1
operator|&=
operator|~
name|BCR1_DTR
argument_list|(
name|c
operator|->
name|num
argument_list|)
expr_stmt|;
name|outw
argument_list|(
name|BCR1
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|,
name|b
operator|->
name|bcr1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|9
case|:
case|case
literal|10
case|:
case|case
literal|11
case|:
if|if
condition|(
name|c
operator|->
name|type
operator|==
name|T_UNIV_RS232
condition|)
break|break;
case|case
literal|8
case|:
if|if
condition|(
name|on
condition|)
name|b
operator|->
name|bcr1b
operator||=
name|BCR1_DTR
argument_list|(
name|c
operator|->
name|num
operator|&
literal|3
argument_list|)
expr_stmt|;
else|else
name|b
operator|->
name|bcr1b
operator|&=
operator|~
name|BCR1_DTR
argument_list|(
name|c
operator|->
name|num
operator|&
literal|3
argument_list|)
expr_stmt|;
name|outw
argument_list|(
name|BCR1
argument_list|(
name|b
operator|->
name|port
operator|+
literal|0x10
argument_list|)
argument_list|,
name|b
operator|->
name|bcr1b
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/*  * Control RTS signal for the channel.  * Turn it on/off.  */
end_comment

begin_function
name|void
name|cx_set_rts
parameter_list|(
name|cx_chan_t
modifier|*
name|c
parameter_list|,
name|int
name|on
parameter_list|)
block|{
name|c
operator|->
name|rts
operator|=
name|on
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|outb
argument_list|(
name|CAR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|num
operator|&
literal|3
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|MSVR_RTS
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|on
condition|?
name|MSV_RTS
else|:
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Get the state of DSR signal of the channel.  */
end_comment

begin_function
name|int
name|cx_get_dsr
parameter_list|(
name|cx_chan_t
modifier|*
name|c
parameter_list|)
block|{
name|unsigned
name|char
name|sigval
decl_stmt|;
if|if
condition|(
name|c
operator|->
name|board
operator|->
name|type
operator|==
name|B_SIGMA_2X
operator|||
name|c
operator|->
name|board
operator|->
name|type
operator|==
name|B_SIGMA_800
operator|||
name|c
operator|->
name|mode
operator|==
name|M_ASYNC
condition|)
block|{
name|outb
argument_list|(
name|CAR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|num
operator|&
literal|3
argument_list|)
expr_stmt|;
return|return
operator|(
name|inb
argument_list|(
name|MSVR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|)
operator|&
name|MSV_DSR
condition|?
literal|1
else|:
literal|0
operator|)
return|;
block|}
comment|/* 	 * Channels 4..7 and 12..15 don't have DSR signal available. 	 */
switch|switch
condition|(
name|c
operator|->
name|num
condition|)
block|{
default|default:
return|return
operator|(
literal|1
operator|)
return|;
case|case
literal|1
case|:
case|case
literal|2
case|:
case|case
literal|3
case|:
if|if
condition|(
name|c
operator|->
name|type
operator|==
name|T_UNIV_RS232
condition|)
return|return
operator|(
literal|1
operator|)
return|;
case|case
literal|0
case|:
name|sigval
operator|=
name|inw
argument_list|(
name|BSR
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|)
operator|>>
literal|8
expr_stmt|;
break|break;
case|case
literal|9
case|:
case|case
literal|10
case|:
case|case
literal|11
case|:
if|if
condition|(
name|c
operator|->
name|type
operator|==
name|T_UNIV_RS232
condition|)
return|return
operator|(
literal|1
operator|)
return|;
case|case
literal|8
case|:
name|sigval
operator|=
name|inw
argument_list|(
name|BSR
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
operator|+
literal|0x10
argument_list|)
argument_list|)
operator|>>
literal|8
expr_stmt|;
break|break;
block|}
return|return
operator|(
operator|~
name|sigval
operator|>>
operator|(
name|c
operator|->
name|num
operator|&
literal|3
operator|)
operator|&
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Get the state of CARRIER signal of the channel.  */
end_comment

begin_function
name|int
name|cx_get_cd
parameter_list|(
name|cx_chan_t
modifier|*
name|c
parameter_list|)
block|{
name|unsigned
name|char
name|sigval
decl_stmt|;
if|if
condition|(
name|c
operator|->
name|board
operator|->
name|type
operator|==
name|B_SIGMA_2X
operator|||
name|c
operator|->
name|board
operator|->
name|type
operator|==
name|B_SIGMA_800
operator|||
name|c
operator|->
name|mode
operator|==
name|M_ASYNC
condition|)
block|{
name|outb
argument_list|(
name|CAR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|num
operator|&
literal|3
argument_list|)
expr_stmt|;
return|return
operator|(
name|inb
argument_list|(
name|MSVR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|)
operator|&
name|MSV_CD
condition|?
literal|1
else|:
literal|0
operator|)
return|;
block|}
comment|/* 	 * Channels 4..7 and 12..15 don't have CD signal available. 	 */
switch|switch
condition|(
name|c
operator|->
name|num
condition|)
block|{
default|default:
return|return
operator|(
literal|1
operator|)
return|;
case|case
literal|1
case|:
case|case
literal|2
case|:
case|case
literal|3
case|:
if|if
condition|(
name|c
operator|->
name|type
operator|==
name|T_UNIV_RS232
condition|)
return|return
operator|(
literal|1
operator|)
return|;
case|case
literal|0
case|:
name|sigval
operator|=
name|inw
argument_list|(
name|BSR
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|)
operator|>>
literal|8
expr_stmt|;
break|break;
case|case
literal|9
case|:
case|case
literal|10
case|:
case|case
literal|11
case|:
if|if
condition|(
name|c
operator|->
name|type
operator|==
name|T_UNIV_RS232
condition|)
return|return
operator|(
literal|1
operator|)
return|;
case|case
literal|8
case|:
name|sigval
operator|=
name|inw
argument_list|(
name|BSR
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
operator|+
literal|0x10
argument_list|)
argument_list|)
operator|>>
literal|8
expr_stmt|;
break|break;
block|}
return|return
operator|(
operator|~
name|sigval
operator|>>
literal|4
operator|>>
operator|(
name|c
operator|->
name|num
operator|&
literal|3
operator|)
operator|&
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Get the state of CTS signal of the channel.  */
end_comment

begin_function
name|int
name|cx_get_cts
parameter_list|(
name|cx_chan_t
modifier|*
name|c
parameter_list|)
block|{
name|outb
argument_list|(
name|CAR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|num
operator|&
literal|3
argument_list|)
expr_stmt|;
return|return
operator|(
name|inb
argument_list|(
name|MSVR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|)
operator|&
name|MSV_CTS
condition|?
literal|1
else|:
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Compute CD2400 clock values.  */
end_comment

begin_function
name|void
name|cx_clock
parameter_list|(
name|long
name|hz
parameter_list|,
name|long
name|ba
parameter_list|,
name|int
modifier|*
name|clk
parameter_list|,
name|int
modifier|*
name|div
parameter_list|)
block|{
specifier|static
name|short
name|clocktab
index|[]
init|=
block|{
literal|8
block|,
literal|32
block|,
literal|128
block|,
literal|512
block|,
literal|2048
block|,
literal|0
block|}
decl_stmt|;
for|for
control|(
operator|*
name|clk
operator|=
literal|0
init|;
name|clocktab
index|[
operator|*
name|clk
index|]
condition|;
operator|++
operator|*
name|clk
control|)
block|{
name|long
name|c
init|=
name|ba
operator|*
name|clocktab
index|[
operator|*
name|clk
index|]
decl_stmt|;
if|if
condition|(
name|hz
operator|<=
name|c
operator|*
literal|256
condition|)
block|{
operator|*
name|div
operator|=
operator|(
literal|2
operator|*
name|hz
operator|+
name|c
operator|)
operator|/
operator|(
literal|2
operator|*
name|c
operator|)
operator|-
literal|1
expr_stmt|;
return|return;
block|}
block|}
comment|/* Incorrect baud rate.  Return some meaningful values. */
operator|*
name|clk
operator|=
literal|0
expr_stmt|;
operator|*
name|div
operator|=
literal|255
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Turn LED on/off.  */
end_comment

begin_function
name|void
name|cx_led
parameter_list|(
name|cx_board_t
modifier|*
name|b
parameter_list|,
name|int
name|on
parameter_list|)
block|{
switch|switch
condition|(
name|b
operator|->
name|type
condition|)
block|{
case|case
name|B_SIGMA_2X
case|:
if|if
condition|(
name|on
condition|)
name|b
operator|->
name|bcr0
operator||=
name|BCR02X_LED
expr_stmt|;
else|else
name|b
operator|->
name|bcr0
operator|&=
operator|~
name|BCR02X_LED
expr_stmt|;
name|outb
argument_list|(
name|BCR0
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|,
name|b
operator|->
name|bcr0
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
name|void
name|cx_disable_dma
parameter_list|(
name|cx_board_t
modifier|*
name|b
parameter_list|)
block|{
ifndef|#
directive|ifndef
name|NDIS_MINIPORT_DRIVER
comment|/* Disable DMA channel. */
name|outb
argument_list|(
name|DMA_MASK
argument_list|,
operator|(
name|b
operator|->
name|dma
operator|&
literal|3
operator|)
operator||
name|DMA_MASK_CLEAR
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_decl_stmt
name|cx_board_opt_t
name|board_opt_dflt
init|=
block|{
comment|/* board options */
name|BUS_NORMAL
block|,
comment|/* normal bus master timing */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|cx_chan_opt_t
name|chan_opt_dflt
init|=
block|{
comment|/* mode-independent options */
block|{
comment|/* cor4 */
literal|7
block|,
comment|/* FIFO threshold, odd is better */
literal|0
block|,
literal|0
block|,
comment|/* don't detect 1 to 0 on CTS */
literal|1
block|,
comment|/* detect 1 to 0 on CD */
literal|0
block|,
comment|/* detect 1 to 0 on DSR */
block|}
block|,
block|{
comment|/* cor5 */
literal|0
block|,
comment|/* receive flow control FIFO threshold */
literal|0
block|,
literal|0
block|,
comment|/* don't detect 0 to 1 on CTS */
literal|1
block|,
comment|/* detect 0 to 1 on CD */
literal|0
block|,
comment|/* detect 0 to 1 on DSR */
block|}
block|,
block|{
comment|/* rcor */
literal|0
block|,
comment|/* dummy clock source */
name|ENCOD_NRZ
block|,
comment|/* NRZ mode */
literal|0
block|,
comment|/* disable DPLL */
literal|0
block|,
literal|0
block|,
comment|/* transmit line value */
block|}
block|,
block|{
comment|/* tcor */
literal|0
block|,
literal|0
block|,
comment|/* local loopback mode */
literal|0
block|,
literal|1
block|,
comment|/* external 1x clock mode */
literal|0
block|,
literal|0
block|,
comment|/* dummy transmit clock source */
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|cx_opt_async_t
name|opt_async_dflt
init|=
block|{
comment|/* default async options */
block|{
comment|/* cor1 */
literal|8
operator|-
literal|1
block|,
comment|/* 8-bit char length */
literal|0
block|,
comment|/* don't ignore parity */
name|PARM_NOPAR
block|,
comment|/* no parity */
name|PAR_EVEN
block|,
comment|/* even parity */
block|}
block|,
block|{
comment|/* cor2 */
literal|0
block|,
comment|/* disable automatic DSR */
literal|1
block|,
comment|/* enable automatic CTS */
literal|0
block|,
comment|/* disable automatic RTS */
literal|0
block|,
comment|/* no remote loopback */
literal|0
block|,
literal|0
block|,
comment|/* disable embedded cmds */
literal|0
block|,
comment|/* disable XON/XOFF */
literal|0
block|,
comment|/* disable XANY */
block|}
block|,
block|{
comment|/* cor3 */
name|STOPB_1
block|,
comment|/* 1 stop bit */
literal|0
block|,
literal|0
block|,
comment|/* disable special char detection */
name|FLOWCC_PASS
block|,
comment|/* pass flow ctl chars to the host */
literal|0
block|,
comment|/* range detect disable */
literal|0
block|,
comment|/* disable extended spec. char detect */
block|}
block|,
block|{
comment|/* cor6 */
name|PERR_INTR
block|,
comment|/* generate exception on parity errors */
name|BRK_INTR
block|,
comment|/* generate exception on break condition */
literal|0
block|,
comment|/* don't translate NL to CR on input */
literal|0
block|,
comment|/* don't translate CR to NL on input */
literal|0
block|,
comment|/* don't discard CR on input */
block|}
block|,
block|{
comment|/* cor7 */
literal|0
block|,
comment|/* don't translate CR to NL on output */
literal|0
block|,
comment|/* don't translate NL to CR on output */
literal|0
block|,
literal|0
block|,
comment|/* don't process flow ctl err chars */
literal|0
block|,
comment|/* disable LNext option */
literal|0
block|,
comment|/* don't strip 8 bit on input */
block|}
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
comment|/* clear schr1-4, scrl, scrh, lnxt */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|cx_opt_hdlc_t
name|opt_hdlc_dflt
init|=
block|{
comment|/* default hdlc options */
block|{
comment|/* cor1 */
literal|2
block|,
comment|/* 2 inter-frame flags */
literal|0
block|,
comment|/* no-address mode */
name|CLRDET_DISABLE
block|,
comment|/* disable clear detect */
name|AFLO_1OCT
block|,
comment|/* 1-byte address field length */
block|}
block|,
block|{
comment|/* cor2 */
literal|0
block|,
comment|/* disable automatic DSR */
literal|0
block|,
comment|/* disable automatic CTS */
literal|0
block|,
comment|/* disable automatic RTS */
literal|0
block|,
name|CRC_INVERT
block|,
comment|/* use CRC V.41 */
literal|0
block|,
name|FCS_NOTPASS
block|,
comment|/* don't pass received CRC to the host */
literal|0
block|, 	}
block|,
block|{
comment|/* cor3 */
literal|0
block|,
comment|/* 0 pad characters sent */
name|IDLE_FLAG
block|,
comment|/* idle in flag */
literal|0
block|,
comment|/* enable FCS */
name|FCSP_ONES
block|,
comment|/* FCS preset to all ones (V.41) */
name|SYNC_AA
block|,
comment|/* use AAh as sync char */
literal|0
block|,
comment|/* disable pad characters */
block|}
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
comment|/* clear rfar1-4 */
name|POLY_V41
block|,
comment|/* use V.41 CRC polynomial */
block|}
decl_stmt|;
end_decl_stmt

end_unit


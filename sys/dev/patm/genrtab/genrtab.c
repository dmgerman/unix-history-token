begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2003  *	Fraunhofer Institute for Open Communication Systems (FhG Fokus).  * 	All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * Author: Hartmut Brandt<harti@freebsd.org>  *  * This program is used to generate the different rate tables for the IDT77252  * driver. The generated tables are slightly different from those in the  * IDT manual.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<math.h>
end_include

begin_include
include|#
directive|include
file|<ieeefp.h>
end_include

begin_comment
comment|/* verbosity flag */
end_comment

begin_decl_stmt
specifier|static
name|int
name|verbose
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* number of table entries */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|u_int
name|tsize
init|=
literal|256
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* number of rate difference tables to create */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|u_int
name|ndtables
init|=
literal|16
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* cell rate offset for log 0 */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|double
name|offset
init|=
literal|10.0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Make an internal form of the interval and be sure to round down.  */
end_comment

begin_function
specifier|static
name|u_int
name|d2interval
parameter_list|(
name|double
name|d
parameter_list|)
block|{
name|fp_rnd_t
name|r
decl_stmt|;
name|u_int
name|s
decl_stmt|,
name|id
decl_stmt|;
name|r
operator|=
name|fpsetround
argument_list|(
name|FP_RZ
argument_list|)
expr_stmt|;
name|id
operator|=
operator|(
name|u_int
operator|)
name|rint
argument_list|(
literal|32
operator|*
name|d
argument_list|)
expr_stmt|;
name|fpsetround
argument_list|(
name|r
argument_list|)
expr_stmt|;
name|s
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|id
operator|>=
literal|32
operator|*
literal|32
condition|)
block|{
name|s
operator|++
expr_stmt|;
name|id
operator|>>=
literal|1
expr_stmt|;
block|}
return|return
operator|(
operator|(
name|s
operator|<<
literal|10
operator|)
operator||
operator|(
name|id
operator|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Convert an internal interval back to a real one.  */
end_comment

begin_function
specifier|static
name|double
name|interval2d
parameter_list|(
name|u_int
name|id
parameter_list|)
block|{
return|return
operator|(
operator|(
literal|1
operator|<<
operator|(
operator|(
name|id
operator|>>
literal|10
operator|)
operator|&
literal|0xf
operator|)
operator|)
operator|*
operator|(
operator|(
name|id
operator|&
literal|0x3ff
operator|)
operator|/
literal|32.0
operator|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Convert double to ATM-Forum format. Make sure to round up.  */
end_comment

begin_function
specifier|static
name|u_int
name|cps2atmf
parameter_list|(
name|double
name|cps
parameter_list|)
block|{
name|fp_rnd_t
name|r
decl_stmt|;
name|u_int
name|s
decl_stmt|,
name|id
decl_stmt|;
if|if
condition|(
name|cps
operator|<
literal|1.0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|s
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|cps
operator|>=
literal|2.0
condition|)
block|{
name|s
operator|++
expr_stmt|;
name|cps
operator|/=
literal|2
expr_stmt|;
block|}
name|r
operator|=
name|fpsetround
argument_list|(
name|FP_RP
argument_list|)
expr_stmt|;
name|id
operator|=
operator|(
name|u_int
operator|)
name|rint
argument_list|(
literal|512
operator|*
name|cps
argument_list|)
expr_stmt|;
name|fpsetround
argument_list|(
name|r
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
literal|1
operator|<<
literal|14
operator|)
operator||
operator|(
name|s
operator|<<
literal|9
operator|)
operator||
operator|(
name|id
operator|&
literal|0x1ff
operator|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Convert ATM forum format to double  */
end_comment

begin_function
specifier|static
name|double
name|atmf2cps
parameter_list|(
name|u_int
name|atmf
parameter_list|)
block|{
return|return
operator|(
operator|(
operator|(
name|atmf
operator|>>
literal|14
operator|)
operator|&
literal|1
operator|)
operator|*
operator|(
literal|1
operator|<<
operator|(
operator|(
name|atmf
operator|>>
literal|9
operator|)
operator|&
literal|0x1f
operator|)
operator|)
operator|*
operator|(
operator|(
literal|512
operator|+
operator|(
name|atmf
operator|&
literal|0x1ff
operator|)
operator|)
operator|/
literal|512.0
operator|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * A cell rate to the logarithmic one  */
end_comment

begin_function
specifier|static
name|double
name|cps2log
parameter_list|(
name|u_int
name|alink
parameter_list|,
name|double
name|lg
parameter_list|)
block|{
if|if
condition|(
name|lg
operator|<=
name|offset
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|lg
operator|>=
name|alink
condition|)
return|return
operator|(
name|tsize
operator|-
literal|1
operator|)
return|;
return|return
operator|(
operator|(
name|tsize
operator|-
literal|1
operator|)
operator|*
operator|(
literal|1
operator|-
name|log
argument_list|(
name|alink
operator|/
name|lg
argument_list|)
operator|/
name|log
argument_list|(
name|alink
operator|/
name|offset
argument_list|)
operator|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Convert log to cell rate  */
end_comment

begin_function
specifier|static
name|double
name|log2cps
parameter_list|(
name|u_int
name|alink
parameter_list|,
name|u_int
name|lg
parameter_list|)
block|{
return|return
operator|(
name|alink
operator|/
name|pow
argument_list|(
name|alink
operator|/
name|offset
argument_list|,
call|(
name|double
call|)
argument_list|(
name|tsize
operator|-
name|lg
operator|-
literal|1
argument_list|)
operator|/
operator|(
name|tsize
operator|-
literal|1
operator|)
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Convert a double to an internal scaled double  */
end_comment

begin_function
specifier|static
name|u_int
name|d2ifp
parameter_list|(
name|double
name|fp
parameter_list|)
block|{
name|fp_rnd_t
name|r
decl_stmt|;
name|u_int
name|s
decl_stmt|,
name|ifp
decl_stmt|;
name|fp
operator|*=
operator|(
literal|1
operator|<<
literal|16
operator|)
expr_stmt|;
name|r
operator|=
name|fpsetround
argument_list|(
name|FP_RN
argument_list|)
expr_stmt|;
name|ifp
operator|=
operator|(
name|u_int
operator|)
name|rint
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|fpsetround
argument_list|(
name|r
argument_list|)
expr_stmt|;
name|s
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|ifp
operator|>=
literal|1024
condition|)
block|{
name|s
operator|++
expr_stmt|;
name|ifp
operator|>>=
literal|1
expr_stmt|;
block|}
return|return
operator|(
operator|(
name|s
operator|<<
literal|10
operator|)
operator||
operator|(
name|ifp
operator|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Convert internal scaled float to double  */
end_comment

begin_function
specifier|static
name|double
name|ifp2d
parameter_list|(
name|u_int
name|p
parameter_list|)
block|{
return|return
operator|(
operator|(
name|p
operator|&
literal|0x3ff
operator|)
operator|*
operator|(
literal|1
operator|<<
operator|(
operator|(
name|p
operator|>>
literal|10
operator|)
operator|&
literal|0xf
operator|)
operator|)
operator|/
literal|65536.0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Generate log to rate conversion table  */
end_comment

begin_function
specifier|static
name|void
name|gen_log2rate
parameter_list|(
name|u_int
name|alink
parameter_list|)
block|{
name|u_int
name|i
decl_stmt|,
name|iinterval
decl_stmt|,
name|atmf
decl_stmt|,
name|n
decl_stmt|,
name|nrm
decl_stmt|;
name|double
name|rate
decl_stmt|,
name|interval
decl_stmt|,
name|xinterval
decl_stmt|,
name|cps
decl_stmt|,
name|xcps
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|256
condition|;
name|i
operator|++
control|)
block|{
comment|/* get the desired rate */
name|rate
operator|=
name|alink
operator|/
name|pow
argument_list|(
name|alink
operator|/
name|offset
argument_list|,
call|(
name|double
call|)
argument_list|(
name|tsize
operator|-
name|i
operator|-
literal|1
argument_list|)
operator|/
operator|(
name|tsize
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
comment|/* convert this to an interval */
name|interval
operator|=
name|alink
operator|/
name|rate
expr_stmt|;
comment|/* make the internal form of this interval, be sure to 		 * round down */
name|iinterval
operator|=
name|d2interval
argument_list|(
name|interval
argument_list|)
expr_stmt|;
comment|/* now convert back */
name|xinterval
operator|=
name|interval2d
argument_list|(
name|iinterval
argument_list|)
expr_stmt|;
comment|/* make a cps from this interval */
name|cps
operator|=
name|alink
operator|/
name|xinterval
expr_stmt|;
comment|/* convert this to its ATM forum format */
name|atmf
operator|=
name|cps2atmf
argument_list|(
name|cps
argument_list|)
expr_stmt|;
comment|/* and back */
name|xcps
operator|=
name|atmf2cps
argument_list|(
name|atmf
argument_list|)
expr_stmt|;
comment|/* decide on NRM */
if|if
condition|(
name|xcps
operator|<
literal|40.0
condition|)
block|{
name|nrm
operator|=
literal|0
expr_stmt|;
name|n
operator|=
literal|3
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|xcps
operator|<
literal|80.0
condition|)
block|{
name|nrm
operator|=
literal|1
expr_stmt|;
name|n
operator|=
literal|4
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|xcps
operator|<
literal|160.0
condition|)
block|{
name|nrm
operator|=
literal|2
expr_stmt|;
name|n
operator|=
literal|8
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|xcps
operator|<
literal|320.0
condition|)
block|{
name|nrm
operator|=
literal|3
expr_stmt|;
name|n
operator|=
literal|16
expr_stmt|;
block|}
else|else
block|{
name|nrm
operator|=
literal|4
expr_stmt|;
name|n
operator|=
literal|32
expr_stmt|;
block|}
comment|/* print */
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|" 0x%08x, /* %03u: cps=%f nrm=%u int=%f */\n"
argument_list|,
operator|(
name|atmf
operator|<<
literal|17
operator|)
operator||
operator|(
name|nrm
operator|<<
literal|14
operator|)
operator||
name|iinterval
argument_list|,
name|i
argument_list|,
name|xcps
argument_list|,
name|n
argument_list|,
name|xinterval
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"0x%08x,\n"
argument_list|,
operator|(
name|atmf
operator|<<
literal|17
operator|)
operator||
operator|(
name|nrm
operator|<<
literal|14
operator|)
operator||
name|iinterval
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Generate rate to log conversion table  */
end_comment

begin_function
specifier|static
name|void
name|gen_rate2log
parameter_list|(
name|u_int
name|alink
parameter_list|)
block|{
name|u_int
name|i
decl_stmt|,
name|atmf
decl_stmt|,
name|val
decl_stmt|,
name|ilcr
decl_stmt|;
name|double
name|cps
decl_stmt|,
name|lcr
decl_stmt|;
name|fp_rnd_t
name|r
decl_stmt|;
name|val
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|512
condition|;
name|i
operator|++
control|)
block|{
comment|/* make ATM Forum CPS from index */
name|atmf
operator|=
operator|(
operator|(
operator|(
name|i
operator|&
literal|0x1f0
operator|)
operator|>>
literal|4
operator|)
operator|<<
literal|9
operator|)
operator||
operator|(
operator|(
name|i
operator|&
literal|0xf
operator|)
operator|<<
literal|5
operator|)
operator||
operator|(
literal|1
operator|<<
literal|14
operator|)
expr_stmt|;
comment|/* make cps */
name|cps
operator|=
name|atmf2cps
argument_list|(
name|atmf
argument_list|)
expr_stmt|;
comment|/* convert to log */
name|lcr
operator|=
name|cps2log
argument_list|(
name|alink
argument_list|,
name|cps
argument_list|)
expr_stmt|;
name|r
operator|=
name|fpsetround
argument_list|(
name|FP_RN
argument_list|)
expr_stmt|;
name|ilcr
operator|=
operator|(
name|u_int
operator|)
name|rint
argument_list|(
name|lcr
argument_list|)
expr_stmt|;
name|fpsetround
argument_list|(
name|r
argument_list|)
expr_stmt|;
comment|/* put together */
name|val
operator||=
name|ilcr
operator|<<
operator|(
literal|8
operator|*
operator|(
name|i
operator|%
literal|4
operator|)
operator|)
expr_stmt|;
comment|/* print */
if|if
condition|(
name|i
operator|%
literal|4
operator|==
literal|3
condition|)
block|{
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|" 0x%08x,\t"
argument_list|,
name|val
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"0x%08x,\n"
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"\t\t"
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"/* %03u: %f -> %f */\n"
argument_list|,
name|i
argument_list|,
name|cps
argument_list|,
name|log2cps
argument_list|(
name|alink
argument_list|,
name|ilcr
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Generate one entry into the global table  */
end_comment

begin_function
specifier|static
name|void
name|gen_glob_entry
parameter_list|(
name|u_int
name|alink
parameter_list|,
name|u_int
name|fill
parameter_list|,
name|u_int
name|ci
parameter_list|,
name|u_int
name|ni
parameter_list|)
block|{
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"  0x%08x,	/* %2u/32 %8.6f, %6u, ci=%u, ni=%u */\n"
argument_list|,
name|cps2atmf
argument_list|(
name|alink
operator|*
name|fill
operator|/
literal|32.0
argument_list|)
operator||
operator|(
name|ci
operator|<<
literal|17
operator|)
operator||
operator|(
name|ni
operator|<<
literal|16
operator|)
argument_list|,
name|fill
argument_list|,
name|fill
operator|/
literal|32.0
argument_list|,
name|alink
operator|*
name|fill
operator|/
literal|32
argument_list|,
name|ci
argument_list|,
name|ni
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"0x%08x,\n"
argument_list|,
name|cps2atmf
argument_list|(
name|alink
operator|*
name|fill
operator|/
literal|32.0
argument_list|)
operator||
operator|(
name|ci
operator|<<
literal|17
operator|)
operator||
operator|(
name|ni
operator|<<
literal|16
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Generate global parameter table  */
end_comment

begin_function
specifier|static
name|void
name|gen_glob
parameter_list|(
name|u_int
name|alink
parameter_list|)
block|{
name|u_int
name|i
decl_stmt|;
name|gen_glob_entry
argument_list|(
name|alink
argument_list|,
literal|32
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gen_glob_entry
argument_list|(
name|alink
argument_list|,
literal|16
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gen_glob_entry
argument_list|(
name|alink
argument_list|,
literal|8
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|gen_glob_entry
argument_list|(
name|alink
argument_list|,
literal|4
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|gen_glob_entry
argument_list|(
name|alink
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|gen_glob_entry
argument_list|(
name|alink
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|gen_glob_entry
argument_list|(
name|alink
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|gen_glob_entry
argument_list|(
name|alink
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|tsize
operator|/
literal|2
operator|-
literal|8
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|%
literal|16
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" 0,"
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|%
literal|16
operator|==
literal|15
condition|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Generate additive rate increase tables  */
end_comment

begin_function
specifier|static
name|void
name|gen_air
parameter_list|(
name|u_int
name|alink
parameter_list|)
block|{
name|u_int
name|t
decl_stmt|,
name|i
decl_stmt|;
name|double
name|diff
decl_stmt|;
comment|/* cell rate to increase by */
name|double
name|cps
decl_stmt|;
name|double
name|add
decl_stmt|;
name|u_int
name|val
decl_stmt|,
name|a
decl_stmt|;
for|for
control|(
name|t
operator|=
literal|0
init|;
name|t
operator|<
name|ndtables
condition|;
name|t
operator|++
control|)
block|{
name|diff
operator|=
operator|(
name|double
operator|)
name|alink
operator|/
operator|(
literal|1
operator|<<
name|t
operator|)
expr_stmt|;
name|printf
argument_list|(
literal|"/* AIR %u: diff=%f */\n"
argument_list|,
name|t
argument_list|,
name|diff
argument_list|)
expr_stmt|;
name|val
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|tsize
condition|;
name|i
operator|++
control|)
block|{
name|cps
operator|=
name|log2cps
argument_list|(
name|alink
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|cps
operator|+=
name|diff
expr_stmt|;
if|if
condition|(
name|cps
operator|>
name|alink
condition|)
name|cps
operator|=
name|alink
expr_stmt|;
name|add
operator|=
name|cps2log
argument_list|(
name|alink
argument_list|,
name|cps
argument_list|)
operator|-
name|i
expr_stmt|;
name|a
operator|=
name|d2ifp
argument_list|(
name|add
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|%
literal|2
condition|)
block|{
name|val
operator||=
name|a
operator|<<
literal|16
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"  0x%08x,\t"
argument_list|,
name|val
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"0x%08x,\n"
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|val
operator|=
name|a
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"\t\t"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"/* %3u: %f */\n"
argument_list|,
name|i
argument_list|,
name|ifp2d
argument_list|(
name|add
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*  * Generate rate decrease table  */
end_comment

begin_function
specifier|static
name|void
name|gen_rdf
parameter_list|(
name|u_int
name|alink
parameter_list|)
block|{
name|double
name|d
decl_stmt|;
name|u_int
name|t
decl_stmt|,
name|i
decl_stmt|,
name|f
decl_stmt|,
name|val
decl_stmt|,
name|diff
decl_stmt|;
for|for
control|(
name|t
operator|=
literal|0
init|;
name|t
operator|<
name|ndtables
condition|;
name|t
operator|++
control|)
block|{
comment|/* compute the log index difference */
if|if
condition|(
name|t
operator|==
literal|0
condition|)
block|{
name|d
operator|=
name|tsize
operator|-
literal|1
expr_stmt|;
block|}
else|else
block|{
name|f
operator|=
literal|1
operator|<<
name|t
expr_stmt|;
name|d
operator|=
operator|(
name|tsize
operator|-
literal|1
operator|)
operator|/
name|log
argument_list|(
name|alink
operator|/
name|offset
argument_list|)
expr_stmt|;
name|d
operator|*=
name|log
argument_list|(
operator|(
name|double
operator|)
name|f
operator|/
operator|(
name|f
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|" /* RDF %u: 1/%u: %f */\n"
argument_list|,
name|t
argument_list|,
literal|1
operator|<<
name|t
argument_list|,
name|d
argument_list|)
expr_stmt|;
name|val
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|tsize
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|<
name|d
condition|)
name|diff
operator|=
name|d2ifp
argument_list|(
name|i
argument_list|)
expr_stmt|;
else|else
name|diff
operator|=
name|d2ifp
argument_list|(
name|d
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|%
literal|2
condition|)
block|{
name|val
operator||=
name|diff
operator|<<
literal|16
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"  0x%08x,\t"
argument_list|,
name|val
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"0x%08x,\n"
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|val
operator|=
name|diff
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"\t\t"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"/* %3u: %f */\n"
argument_list|,
name|i
argument_list|,
name|ifp2d
argument_list|(
name|diff
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*  * Create all the tables for a given link cell rate and link bit rate.  * The link bit rate is only used to name the table.  */
end_comment

begin_function
specifier|static
name|void
name|gen_tables
parameter_list|(
name|u_int
name|alink
parameter_list|,
name|u_int
name|mbps
parameter_list|)
block|{
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"/*\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" * Tables for %ucps and %uMbps\n"
argument_list|,
name|alink
argument_list|,
name|mbps
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" */\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"const uint32_t patm_rtables%u[128 * (4 + 2 * %u)] = {\n"
argument_list|,
name|mbps
argument_list|,
name|ndtables
argument_list|)
expr_stmt|;
name|gen_log2rate
argument_list|(
name|alink
argument_list|)
expr_stmt|;
name|gen_rate2log
argument_list|(
name|alink
argument_list|)
expr_stmt|;
name|gen_glob
argument_list|(
name|alink
argument_list|)
expr_stmt|;
name|gen_air
argument_list|(
name|alink
argument_list|)
expr_stmt|;
name|gen_rdf
argument_list|(
name|alink
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"};\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|int
name|opt
decl_stmt|;
while|while
condition|(
operator|(
name|opt
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"v"
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
switch|switch
condition|(
name|opt
condition|)
block|{
case|case
literal|'v'
case|:
name|verbose
operator|=
literal|1
expr_stmt|;
break|break;
block|}
name|printf
argument_list|(
literal|"/*\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" * This file was generated by `%s'\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" */\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"#include<sys/cdefs.h>\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"__FBSDID(\"$FreeBSD$\");\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"#include<sys/types.h>\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"const u_int patm_rtables_size = 128 * (4 + 2 * %u);\n"
argument_list|,
name|ndtables
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"const u_int patm_rtables_ntab = %u;\n"
argument_list|,
name|ndtables
argument_list|)
expr_stmt|;
name|gen_tables
argument_list|(
literal|352768
argument_list|,
literal|155
argument_list|)
expr_stmt|;
name|gen_tables
argument_list|(
literal|59259
argument_list|,
literal|25
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


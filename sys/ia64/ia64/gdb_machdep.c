begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2004 Marcel Moolenaar  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHORS ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHORS BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kdb.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/signal.h>
end_include

begin_include
include|#
directive|include
file|<machine/gdb_machdep.h>
end_include

begin_include
include|#
directive|include
file|<machine/md_var.h>
end_include

begin_include
include|#
directive|include
file|<machine/pcb.h>
end_include

begin_include
include|#
directive|include
file|<machine/reg.h>
end_include

begin_include
include|#
directive|include
file|<gdb/gdb.h>
end_include

begin_include
include|#
directive|include
file|<gdb/gdb_int.h>
end_include

begin_function
name|void
modifier|*
name|gdb_cpu_getreg
parameter_list|(
name|int
name|regnum
parameter_list|,
name|size_t
modifier|*
name|regsz
parameter_list|)
block|{
specifier|static
name|uint64_t
name|synth
decl_stmt|;
name|uint64_t
name|cfm
decl_stmt|;
operator|*
name|regsz
operator|=
name|gdb_cpu_regsz
argument_list|(
name|regnum
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|regnum
condition|)
block|{
comment|/* Registers 0-127: general registers. */
case|case
literal|1
case|:
return|return
operator|(
operator|&
name|kdb_thrctx
operator|->
name|pcb_special
operator|.
name|gp
operator|)
return|;
case|case
literal|4
case|:
return|return
operator|(
operator|&
name|kdb_thrctx
operator|->
name|pcb_preserved
operator|.
name|gr4
operator|)
return|;
case|case
literal|5
case|:
return|return
operator|(
operator|&
name|kdb_thrctx
operator|->
name|pcb_preserved
operator|.
name|gr5
operator|)
return|;
case|case
literal|6
case|:
return|return
operator|(
operator|&
name|kdb_thrctx
operator|->
name|pcb_preserved
operator|.
name|gr6
operator|)
return|;
case|case
literal|7
case|:
return|return
operator|(
operator|&
name|kdb_thrctx
operator|->
name|pcb_preserved
operator|.
name|gr7
operator|)
return|;
case|case
literal|12
case|:
return|return
operator|(
operator|&
name|kdb_thrctx
operator|->
name|pcb_special
operator|.
name|sp
operator|)
return|;
case|case
literal|13
case|:
return|return
operator|(
operator|&
name|kdb_thrctx
operator|->
name|pcb_special
operator|.
name|tp
operator|)
return|;
comment|/* Registers 128-255: floating-point registers. */
case|case
literal|130
case|:
return|return
operator|(
operator|&
name|kdb_thrctx
operator|->
name|pcb_preserved_fp
operator|.
name|fr2
operator|)
return|;
case|case
literal|131
case|:
return|return
operator|(
operator|&
name|kdb_thrctx
operator|->
name|pcb_preserved_fp
operator|.
name|fr3
operator|)
return|;
case|case
literal|132
case|:
return|return
operator|(
operator|&
name|kdb_thrctx
operator|->
name|pcb_preserved_fp
operator|.
name|fr4
operator|)
return|;
case|case
literal|133
case|:
return|return
operator|(
operator|&
name|kdb_thrctx
operator|->
name|pcb_preserved_fp
operator|.
name|fr5
operator|)
return|;
case|case
literal|144
case|:
return|return
operator|(
operator|&
name|kdb_thrctx
operator|->
name|pcb_preserved_fp
operator|.
name|fr16
operator|)
return|;
case|case
literal|145
case|:
return|return
operator|(
operator|&
name|kdb_thrctx
operator|->
name|pcb_preserved_fp
operator|.
name|fr17
operator|)
return|;
case|case
literal|146
case|:
return|return
operator|(
operator|&
name|kdb_thrctx
operator|->
name|pcb_preserved_fp
operator|.
name|fr18
operator|)
return|;
case|case
literal|147
case|:
return|return
operator|(
operator|&
name|kdb_thrctx
operator|->
name|pcb_preserved_fp
operator|.
name|fr19
operator|)
return|;
case|case
literal|148
case|:
return|return
operator|(
operator|&
name|kdb_thrctx
operator|->
name|pcb_preserved_fp
operator|.
name|fr20
operator|)
return|;
case|case
literal|149
case|:
return|return
operator|(
operator|&
name|kdb_thrctx
operator|->
name|pcb_preserved_fp
operator|.
name|fr21
operator|)
return|;
case|case
literal|150
case|:
return|return
operator|(
operator|&
name|kdb_thrctx
operator|->
name|pcb_preserved_fp
operator|.
name|fr22
operator|)
return|;
case|case
literal|151
case|:
return|return
operator|(
operator|&
name|kdb_thrctx
operator|->
name|pcb_preserved_fp
operator|.
name|fr23
operator|)
return|;
case|case
literal|152
case|:
return|return
operator|(
operator|&
name|kdb_thrctx
operator|->
name|pcb_preserved_fp
operator|.
name|fr24
operator|)
return|;
case|case
literal|153
case|:
return|return
operator|(
operator|&
name|kdb_thrctx
operator|->
name|pcb_preserved_fp
operator|.
name|fr25
operator|)
return|;
case|case
literal|154
case|:
return|return
operator|(
operator|&
name|kdb_thrctx
operator|->
name|pcb_preserved_fp
operator|.
name|fr26
operator|)
return|;
case|case
literal|155
case|:
return|return
operator|(
operator|&
name|kdb_thrctx
operator|->
name|pcb_preserved_fp
operator|.
name|fr27
operator|)
return|;
case|case
literal|156
case|:
return|return
operator|(
operator|&
name|kdb_thrctx
operator|->
name|pcb_preserved_fp
operator|.
name|fr28
operator|)
return|;
case|case
literal|157
case|:
return|return
operator|(
operator|&
name|kdb_thrctx
operator|->
name|pcb_preserved_fp
operator|.
name|fr29
operator|)
return|;
case|case
literal|158
case|:
return|return
operator|(
operator|&
name|kdb_thrctx
operator|->
name|pcb_preserved_fp
operator|.
name|fr30
operator|)
return|;
case|case
literal|159
case|:
return|return
operator|(
operator|&
name|kdb_thrctx
operator|->
name|pcb_preserved_fp
operator|.
name|fr31
operator|)
return|;
comment|/* Registers 320-327: branch registers. */
case|case
literal|320
case|:
if|if
condition|(
name|kdb_thrctx
operator|->
name|pcb_special
operator|.
name|__spare
operator|==
operator|~
literal|0UL
condition|)
return|return
operator|(
operator|&
name|kdb_thrctx
operator|->
name|pcb_special
operator|.
name|rp
operator|)
return|;
break|break;
case|case
literal|321
case|:
return|return
operator|(
operator|&
name|kdb_thrctx
operator|->
name|pcb_preserved
operator|.
name|br1
operator|)
return|;
case|case
literal|322
case|:
return|return
operator|(
operator|&
name|kdb_thrctx
operator|->
name|pcb_preserved
operator|.
name|br2
operator|)
return|;
case|case
literal|323
case|:
return|return
operator|(
operator|&
name|kdb_thrctx
operator|->
name|pcb_preserved
operator|.
name|br3
operator|)
return|;
case|case
literal|324
case|:
return|return
operator|(
operator|&
name|kdb_thrctx
operator|->
name|pcb_preserved
operator|.
name|br4
operator|)
return|;
case|case
literal|325
case|:
return|return
operator|(
operator|&
name|kdb_thrctx
operator|->
name|pcb_preserved
operator|.
name|br5
operator|)
return|;
comment|/* Registers 328-333: misc. other registers. */
case|case
literal|330
case|:
return|return
operator|(
operator|&
name|kdb_thrctx
operator|->
name|pcb_special
operator|.
name|pr
operator|)
return|;
case|case
literal|331
case|:
if|if
condition|(
name|kdb_thrctx
operator|->
name|pcb_special
operator|.
name|__spare
operator|==
operator|~
literal|0UL
condition|)
block|{
name|synth
operator|=
name|kdb_thrctx
operator|->
name|pcb_special
operator|.
name|iip
expr_stmt|;
name|synth
operator|+=
operator|(
name|kdb_thrctx
operator|->
name|pcb_special
operator|.
name|psr
operator|>>
literal|41
operator|)
operator|&
literal|3
expr_stmt|;
return|return
operator|(
operator|&
name|synth
operator|)
return|;
block|}
return|return
operator|(
operator|&
name|kdb_thrctx
operator|->
name|pcb_special
operator|.
name|rp
operator|)
return|;
case|case
literal|333
case|:
if|if
condition|(
name|kdb_thrctx
operator|->
name|pcb_special
operator|.
name|__spare
operator|==
operator|~
literal|0UL
condition|)
return|return
operator|(
operator|&
name|kdb_thrctx
operator|->
name|pcb_special
operator|.
name|cfm
operator|)
return|;
return|return
operator|(
operator|&
name|kdb_thrctx
operator|->
name|pcb_special
operator|.
name|pfs
operator|)
return|;
comment|/* Registers 334-461: application registers. */
case|case
literal|350
case|:
return|return
operator|(
operator|&
name|kdb_thrctx
operator|->
name|pcb_special
operator|.
name|rsc
operator|)
return|;
case|case
literal|351
case|:
comment|/* bsp */
case|case
literal|352
case|:
comment|/* bspstore. */
name|synth
operator|=
name|kdb_thrctx
operator|->
name|pcb_special
operator|.
name|bspstore
expr_stmt|;
if|if
condition|(
name|kdb_thrctx
operator|->
name|pcb_special
operator|.
name|__spare
operator|==
operator|~
literal|0UL
condition|)
block|{
name|synth
operator|+=
name|kdb_thrctx
operator|->
name|pcb_special
operator|.
name|ndirty
expr_stmt|;
block|}
else|else
block|{
name|cfm
operator|=
name|kdb_thrctx
operator|->
name|pcb_special
operator|.
name|pfs
expr_stmt|;
name|synth
operator|=
name|ia64_bsp_adjust
argument_list|(
name|synth
argument_list|,
name|IA64_CFM_SOF
argument_list|(
name|cfm
argument_list|)
operator|-
name|IA64_CFM_SOL
argument_list|(
name|cfm
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
operator|&
name|synth
operator|)
return|;
case|case
literal|353
case|:
return|return
operator|(
operator|&
name|kdb_thrctx
operator|->
name|pcb_special
operator|.
name|rnat
operator|)
return|;
case|case
literal|370
case|:
return|return
operator|(
operator|&
name|kdb_thrctx
operator|->
name|pcb_special
operator|.
name|unat
operator|)
return|;
case|case
literal|374
case|:
return|return
operator|(
operator|&
name|kdb_thrctx
operator|->
name|pcb_special
operator|.
name|fpsr
operator|)
return|;
case|case
literal|398
case|:
if|if
condition|(
name|kdb_thrctx
operator|->
name|pcb_special
operator|.
name|__spare
operator|==
operator|~
literal|0UL
condition|)
return|return
operator|(
operator|&
name|kdb_thrctx
operator|->
name|pcb_special
operator|.
name|pfs
operator|)
return|;
break|break;
case|case
literal|399
case|:
return|return
operator|(
operator|&
name|kdb_thrctx
operator|->
name|pcb_preserved
operator|.
name|lc
operator|)
return|;
block|}
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_function
name|void
name|gdb_cpu_setreg
parameter_list|(
name|int
name|regnum
parameter_list|,
name|void
modifier|*
name|val
parameter_list|)
block|{
switch|switch
condition|(
name|regnum
condition|)
block|{
case|case
name|GDB_REG_PC
case|:
break|break;
block|}
block|}
end_function

begin_function
name|int
name|gdb_cpu_signal
parameter_list|(
name|int
name|vector
parameter_list|,
name|int
name|dummy
name|__unused
parameter_list|)
block|{
if|if
condition|(
name|vector
operator|==
name|IA64_VEC_BREAK
operator|||
name|vector
operator|==
name|IA64_VEC_SINGLE_STEP_TRAP
condition|)
return|return
operator|(
name|SIGTRAP
operator|)
return|;
comment|/* Add 100 so GDB won't translate the vector into signal names. */
return|return
operator|(
name|vector
operator|+
literal|100
operator|)
return|;
block|}
end_function

begin_function
name|int
name|gdb_cpu_query
parameter_list|(
name|void
parameter_list|)
block|{
if|#
directive|if
literal|0
block|uint64_t bspstore, *kstack;
endif|#
directive|endif
name|uintmax_t
name|slot
decl_stmt|;
if|if
condition|(
operator|!
name|gdb_rx_equal
argument_list|(
literal|"Part:dirty:read::"
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|gdb_rx_varhex
argument_list|(
operator|&
name|slot
argument_list|)
operator|<
literal|0
condition|)
block|{
name|gdb_tx_err
argument_list|(
name|EINVAL
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|gdb_tx_err
argument_list|(
name|EINVAL
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|#
directive|if
literal|0
comment|/* slot is unsigned. No need to test for negative values. */
block|if (slot>= (kdb_frame->tf_special.ndirty>> 3)) { 		return (-1); 	}
comment|/* 	 * If the trapframe describes a kernel entry, bspstore holds 	 * the address of the user backing store. Calculate the right 	 * kernel stack address. See also ptrace_machdep(). 	 */
block|bspstore = kdb_frame->tf_special.bspstore; 	kstack = (bspstore>= IA64_RR_BASE(5)) ? (uint64_t*)bspstore : 	    (uint64_t*)(kdb_thread->td_kstack + (bspstore& 0x1ffUL)); 	gdb_tx_begin('\0'); 	gdb_tx_mem((void*)(kstack + slot), 8); 	gdb_tx_end(); 	return (1);
endif|#
directive|endif
block|}
end_function

end_unit


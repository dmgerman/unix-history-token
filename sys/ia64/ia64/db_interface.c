begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* $FreeBSD$ */
end_comment

begin_comment
comment|/*   * Mach Operating System  * Copyright (c) 1992,1991,1990 Carnegie Mellon University  * All Rights Reserved.  *   * Permission to use, copy, modify and distribute this software and its  * documentation is hereby granted, provided that both the copyright  * notice and this permission notice appear in all copies of the  * software, derivative works or modified versions, and any portions  * thereof, and that both notices appear in supporting documentation.  *   * CARNEGIE MELLON ALLOWS FREE USE OF THIS SOFTWARE IN ITS   * CONDITION.  CARNEGIE MELLON DISCLAIMS ANY LIABILITY OF ANY KIND FOR  * ANY DAMAGES WHATSOEVER RESULTING FROM THE USE OF THIS SOFTWARE.  *   * Carnegie Mellon requests users of this software to return to  *   *  Software Distribution Coordinator  or  Software.Distribution@CS.CMU.EDU  *  School of Computer Science  *  Carnegie Mellon University  *  Pittsburgh PA 15213-3890  *   * any improvements or extensions that they make and grant Carnegie the  * rights to redistribute these changes.  *  *	db_interface.c,v 2.4 1991/02/05 17:11:13 mrt (CMU)  */
end_comment

begin_comment
comment|/*  * Parts of this file are derived from Mach 3:  *  *	File: alpha_instruction.c  *	Author: Alessandro Forin, Carnegie Mellon University  *	Date:	6/92  */
end_comment

begin_comment
comment|/*  * Interface to DDB.  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/reboot.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/smp.h>
end_include

begin_include
include|#
directive|include
file|<sys/cons.h>
end_include

begin_include
include|#
directive|include
file|<sys/ktr.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm.h>
end_include

begin_include
include|#
directive|include
file|<machine/db_machdep.h>
end_include

begin_include
include|#
directive|include
file|<machine/mutex.h>
end_include

begin_include
include|#
directive|include
file|<machine/setjmp.h>
end_include

begin_include
include|#
directive|include
file|<ddb/ddb.h>
end_include

begin_include
include|#
directive|include
file|<ddb/db_access.h>
end_include

begin_include
include|#
directive|include
file|<ddb/db_sym.h>
end_include

begin_include
include|#
directive|include
file|<ddb/db_variables.h>
end_include

begin_include
include|#
directive|include
file|<ia64/disasm/disasm.h>
end_include

begin_decl_stmt
specifier|static
name|jmp_buf
modifier|*
name|db_nofault
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|jmp_buf
name|db_jmpbuf
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|extern
name|void
name|gdb_handle_exception
parameter_list|(
name|db_regs_t
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
name|int
name|db_active
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|db_regs_t
name|ddb_regs
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|int
name|db_get_rse_reg
parameter_list|(
name|struct
name|db_variable
modifier|*
name|vp
parameter_list|,
name|db_expr_t
modifier|*
name|valuep
parameter_list|,
name|int
name|op
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|db_get_ip_reg
parameter_list|(
name|struct
name|db_variable
modifier|*
name|vp
parameter_list|,
name|db_expr_t
modifier|*
name|valuep
parameter_list|,
name|int
name|op
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
name|struct
name|db_variable
name|db_regs
index|[]
init|=
block|{
comment|/* Misc control/app registers */
define|#
directive|define
name|DB_MISC_REGS
value|13
comment|/* make sure this is correct */
block|{
literal|"ip"
block|,
name|NULL
block|,
name|db_get_ip_reg
block|}
block|,
block|{
literal|"psr"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_special
operator|.
name|psr
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"cr.isr"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_special
operator|.
name|isr
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"cr.ifa"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_special
operator|.
name|ifa
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"pr"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_special
operator|.
name|pr
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"ar.rsc"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_special
operator|.
name|rsc
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"ar.pfs"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_special
operator|.
name|pfs
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"cr.ifs"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_special
operator|.
name|cfm
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"ar.bspstore"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_special
operator|.
name|bspstore
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"ndirty"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_special
operator|.
name|ndirty
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"ar.rnat"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_special
operator|.
name|rnat
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"ar.unat"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_special
operator|.
name|unat
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"ar.fpsr"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_special
operator|.
name|fpsr
block|,
name|FCN_NULL
block|}
block|,
comment|/* Branch registers */
block|{
literal|"rp"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_special
operator|.
name|rp
block|,
name|FCN_NULL
block|}
block|,
comment|/* b1, b2, b3, b4, b5 are preserved */
block|{
literal|"b6"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_scratch
operator|.
name|br6
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"b7"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_scratch
operator|.
name|br7
block|,
name|FCN_NULL
block|}
block|,
comment|/* Static registers */
block|{
literal|"gp"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_special
operator|.
name|gp
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r2"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_scratch
operator|.
name|gr2
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r3"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_scratch
operator|.
name|gr3
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r8"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_scratch
operator|.
name|gr8
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r9"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_scratch
operator|.
name|gr9
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r10"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_scratch
operator|.
name|gr10
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r11"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_scratch
operator|.
name|gr11
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"sp"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_special
operator|.
name|sp
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"tp"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_special
operator|.
name|tp
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r14"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_scratch
operator|.
name|gr14
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r15"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_scratch
operator|.
name|gr15
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r16"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_scratch
operator|.
name|gr16
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r17"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_scratch
operator|.
name|gr17
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r18"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_scratch
operator|.
name|gr18
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r19"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_scratch
operator|.
name|gr19
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r20"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_scratch
operator|.
name|gr20
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r21"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_scratch
operator|.
name|gr21
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r22"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_scratch
operator|.
name|gr22
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r23"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_scratch
operator|.
name|gr23
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r24"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_scratch
operator|.
name|gr24
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r25"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_scratch
operator|.
name|gr25
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r26"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_scratch
operator|.
name|gr26
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r27"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_scratch
operator|.
name|gr27
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r28"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_scratch
operator|.
name|gr28
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r29"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_scratch
operator|.
name|gr29
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r30"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_scratch
operator|.
name|gr30
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r31"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_scratch
operator|.
name|gr31
block|,
name|FCN_NULL
block|}
block|,
comment|/* Stacked registers */
block|{
literal|"r32"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|32
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r33"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|33
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r34"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|34
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r35"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|35
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r36"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|36
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r37"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|37
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r38"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|38
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r39"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|39
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r40"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|40
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r41"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|41
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r42"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|42
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r43"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|43
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r44"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|44
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r45"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|45
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r46"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|46
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r47"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|47
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r48"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|48
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r49"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|49
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r50"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|50
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r51"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|51
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r52"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|52
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r53"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|53
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r54"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|54
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r55"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|55
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r56"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|56
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r57"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|57
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r58"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|58
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r59"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|59
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r60"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|60
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r61"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|61
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r62"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|62
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r63"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|63
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r64"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|64
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r65"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|65
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r66"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|66
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r67"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|67
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r68"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|68
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r69"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|69
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r70"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|70
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r71"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|71
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r72"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|72
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r73"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|73
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r74"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|74
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r75"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|75
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r76"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|76
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r77"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|77
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r78"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|78
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r79"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|79
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r80"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|80
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r81"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|81
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r82"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|82
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r83"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|83
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r84"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|84
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r85"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|85
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r86"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|86
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r87"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|87
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r88"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|88
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r89"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|89
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r90"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|90
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r91"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|91
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r92"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|92
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r93"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|93
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r94"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|94
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r95"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|95
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r96"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|96
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r97"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|97
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r98"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|98
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r99"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|99
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r100"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|100
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r101"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|101
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r102"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|102
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r103"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|103
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r104"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|104
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r105"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|105
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r106"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|106
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r107"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|107
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r108"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|108
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r109"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|109
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r110"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|110
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r111"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|111
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r112"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|112
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r113"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|113
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r114"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|114
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r115"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|115
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r116"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|116
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r117"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|117
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r118"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|118
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r119"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|119
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r120"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|120
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r121"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|121
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r122"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|122
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r123"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|123
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r124"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|124
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r125"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|125
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r126"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|126
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r127"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|127
block|,
name|db_get_rse_reg
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|db_variable
modifier|*
name|db_eregs
init|=
name|db_regs
operator|+
sizeof|sizeof
argument_list|(
name|db_regs
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|db_regs
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|db_get_rse_reg
parameter_list|(
name|struct
name|db_variable
modifier|*
name|vp
parameter_list|,
name|db_expr_t
modifier|*
name|valuep
parameter_list|,
name|int
name|op
parameter_list|)
block|{
name|u_int64_t
modifier|*
name|reg
decl_stmt|;
name|uint64_t
name|bsp
decl_stmt|;
name|int
name|nats
decl_stmt|,
name|regno
decl_stmt|,
name|sof
decl_stmt|;
name|bsp
operator|=
name|ddb_regs
operator|.
name|tf_special
operator|.
name|bspstore
operator|+
name|ddb_regs
operator|.
name|tf_special
operator|.
name|ndirty
expr_stmt|;
name|regno
operator|=
operator|(
name|db_expr_t
operator|)
name|vp
operator|->
name|valuep
operator|-
literal|32
expr_stmt|;
name|sof
operator|=
call|(
name|int
call|)
argument_list|(
name|ddb_regs
operator|.
name|tf_special
operator|.
name|cfm
operator|&
literal|0x7f
argument_list|)
expr_stmt|;
name|nats
operator|=
operator|(
name|sof
operator|-
name|regno
operator|+
literal|63
operator|-
operator|(
call|(
name|int
call|)
argument_list|(
name|bsp
operator|>>
literal|3
argument_list|)
operator|&
literal|0x3f
operator|)
operator|)
operator|/
literal|63
expr_stmt|;
name|reg
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
name|bsp
operator|-
operator|(
operator|(
name|sof
operator|-
name|regno
operator|+
name|nats
operator|)
operator|<<
literal|3
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|regno
operator|<
name|sof
condition|)
block|{
if|if
condition|(
name|op
operator|==
name|DB_VAR_GET
condition|)
operator|*
name|valuep
operator|=
operator|*
name|reg
expr_stmt|;
else|else
operator|*
name|reg
operator|=
operator|*
name|valuep
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|op
operator|==
name|DB_VAR_GET
condition|)
operator|*
name|valuep
operator|=
literal|0xdeadbeefdeadbeef
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|db_get_ip_reg
parameter_list|(
name|struct
name|db_variable
modifier|*
name|vp
parameter_list|,
name|db_expr_t
modifier|*
name|valuep
parameter_list|,
name|int
name|op
parameter_list|)
block|{
comment|/* Read only */
if|if
condition|(
name|op
operator|==
name|DB_VAR_GET
condition|)
operator|*
name|valuep
operator|=
name|PC_REGS
argument_list|(
name|DDB_REGS
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_if
if|#
directive|if
literal|0
end_if

begin_comment
comment|/*  * Print trap reason.  */
end_comment

begin_comment
unit|static void ddbprinttrap(int vector) {
comment|/* XXX Implement. */
end_comment

begin_endif
unit|printf("ddbprinttrap(%d)\n", vector); }
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|CPUSTOP_ON_DDBBREAK
end_define

begin_define
define|#
directive|define
name|VERBOSE_CPUSTOP_ON_DDBBREAK
end_define

begin_comment
comment|/*  *  ddb_trap - field a kernel trap  */
end_comment

begin_function
name|int
name|kdb_trap
parameter_list|(
name|int
name|vector
parameter_list|,
name|struct
name|trapframe
modifier|*
name|regs
parameter_list|)
block|{
name|int
name|ddb_mode
init|=
operator|!
operator|(
name|boothowto
operator|&
name|RB_GDB
operator|)
decl_stmt|;
name|register_t
name|s
decl_stmt|;
comment|/* 	 * Don't bother checking for usermode, since a benign entry 	 * by the kernel (call to Debugger() or a breakpoint) has 	 * already checked for usermode.  If neither of those 	 * conditions exist, something Bad has happened. 	 */
if|if
condition|(
name|vector
operator|!=
name|IA64_VEC_BREAK
operator|&&
name|vector
operator|!=
name|IA64_VEC_SINGLE_STEP_TRAP
condition|)
block|{
if|#
directive|if
literal|0
block|if (ddb_mode) { 			db_printf("ddbprinttrap from 0x%lx\n",
comment|/* XXX */
block|regs->tf_regs[FRAME_PC]); 			ddbprinttrap(a0, a1, a2, entry);
comment|/* 			 * Tell caller "We did NOT handle the trap." 			 * Caller should panic, or whatever. 			 */
block|return (0); 		}
endif|#
directive|endif
if|if
condition|(
name|db_nofault
condition|)
block|{
name|jmp_buf
modifier|*
name|no_fault
init|=
name|db_nofault
decl_stmt|;
name|db_nofault
operator|=
literal|0
expr_stmt|;
name|longjmp
argument_list|(
operator|*
name|no_fault
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* 	 * XXX Should switch to DDB's own stack, here. 	 */
name|s
operator|=
name|intr_disable
argument_list|()
expr_stmt|;
ifdef|#
directive|ifdef
name|SMP
ifdef|#
directive|ifdef
name|CPUSTOP_ON_DDBBREAK
if|#
directive|if
name|defined
argument_list|(
name|VERBOSE_CPUSTOP_ON_DDBBREAK
argument_list|)
name|db_printf
argument_list|(
literal|"CPU%d stopping CPUs: 0x%08x..."
argument_list|,
name|PCPU_GET
argument_list|(
name|cpuid
argument_list|)
argument_list|,
name|PCPU_GET
argument_list|(
name|other_cpus
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* VERBOSE_CPUSTOP_ON_DDBBREAK */
comment|/* We stop all CPUs except ourselves (obviously) */
name|stop_cpus
argument_list|(
name|PCPU_GET
argument_list|(
name|other_cpus
argument_list|)
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VERBOSE_CPUSTOP_ON_DDBBREAK
argument_list|)
name|db_printf
argument_list|(
literal|" stopped.\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* VERBOSE_CPUSTOP_ON_DDBBREAK */
endif|#
directive|endif
comment|/* CPUSTOP_ON_DDBBREAK */
endif|#
directive|endif
comment|/* SMP */
name|ddb_regs
operator|=
operator|*
name|regs
expr_stmt|;
comment|/* 	 * XXX pretend that registers outside the current frame don't exist. 	 */
name|db_eregs
operator|=
name|db_regs
operator|+
name|DB_MISC_REGS
operator|+
literal|3
operator|+
literal|27
operator|+
operator|(
name|ddb_regs
operator|.
name|tf_special
operator|.
name|cfm
operator|&
literal|0x7f
operator|)
expr_stmt|;
asm|__asm __volatile("flushrs");
comment|/* so we can look at them */
name|db_active
operator|++
expr_stmt|;
if|if
condition|(
name|ddb_mode
condition|)
block|{
name|cndbctl
argument_list|(
name|TRUE
argument_list|)
expr_stmt|;
comment|/* DDB active, unblank video */
name|db_trap
argument_list|(
name|vector
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Where the work happens */
name|cndbctl
argument_list|(
name|FALSE
argument_list|)
expr_stmt|;
comment|/* DDB inactive */
block|}
else|else
name|gdb_handle_exception
argument_list|(
operator|&
name|ddb_regs
argument_list|,
name|vector
argument_list|)
expr_stmt|;
name|db_active
operator|--
expr_stmt|;
ifdef|#
directive|ifdef
name|SMP
ifdef|#
directive|ifdef
name|CPUSTOP_ON_DDBBREAK
if|#
directive|if
name|defined
argument_list|(
name|VERBOSE_CPUSTOP_ON_DDBBREAK
argument_list|)
name|db_printf
argument_list|(
literal|"CPU%d restarting CPUs: 0x%08x..."
argument_list|,
name|PCPU_GET
argument_list|(
name|cpuid
argument_list|)
argument_list|,
name|stopped_cpus
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* VERBOSE_CPUSTOP_ON_DDBBREAK */
comment|/* Restart all the CPUs we previously stopped */
if|if
condition|(
name|stopped_cpus
operator|!=
name|PCPU_GET
argument_list|(
name|other_cpus
argument_list|)
operator|&&
name|smp_started
operator|!=
literal|0
condition|)
block|{
name|db_printf
argument_list|(
literal|"whoa, other_cpus: 0x%08x, stopped_cpus: 0x%08x\n"
argument_list|,
name|PCPU_GET
argument_list|(
name|other_cpus
argument_list|)
argument_list|,
name|stopped_cpus
argument_list|)
expr_stmt|;
name|panic
argument_list|(
literal|"stop_cpus() failed"
argument_list|)
expr_stmt|;
block|}
name|restart_cpus
argument_list|(
name|stopped_cpus
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VERBOSE_CPUSTOP_ON_DDBBREAK
argument_list|)
name|db_printf
argument_list|(
literal|" restarted.\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* VERBOSE_CPUSTOP_ON_DDBBREAK */
endif|#
directive|endif
comment|/* CPUSTOP_ON_DDBBREAK */
endif|#
directive|endif
comment|/* SMP */
operator|*
name|regs
operator|=
name|ddb_regs
expr_stmt|;
name|intr_restore
argument_list|(
name|s
argument_list|)
expr_stmt|;
comment|/* 	 * Tell caller "We HAVE handled the trap." 	 */
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Read bytes from kernel address space for debugger.  */
end_comment

begin_function
name|void
name|db_read_bytes
parameter_list|(
name|vm_offset_t
name|addr
parameter_list|,
name|size_t
name|size
parameter_list|,
name|char
modifier|*
name|data
parameter_list|)
block|{
name|db_nofault
operator|=
operator|&
name|db_jmpbuf
expr_stmt|;
if|if
condition|(
name|addr
operator|<
name|VM_MAX_ADDRESS
condition|)
name|copyin
argument_list|(
operator|(
name|char
operator|*
operator|)
name|addr
argument_list|,
name|data
argument_list|,
name|size
argument_list|)
expr_stmt|;
else|else
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|addr
argument_list|,
name|data
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|db_nofault
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Write bytes to kernel address space for debugger.  */
end_comment

begin_function
name|void
name|db_write_bytes
parameter_list|(
name|vm_offset_t
name|addr
parameter_list|,
name|size_t
name|size
parameter_list|,
name|char
modifier|*
name|data
parameter_list|)
block|{
name|db_nofault
operator|=
operator|&
name|db_jmpbuf
expr_stmt|;
if|if
condition|(
name|addr
operator|<
name|VM_MAX_ADDRESS
condition|)
name|copyout
argument_list|(
name|data
argument_list|,
operator|(
name|char
operator|*
operator|)
name|addr
argument_list|,
name|size
argument_list|)
expr_stmt|;
else|else
name|bcopy
argument_list|(
name|data
argument_list|,
operator|(
name|char
operator|*
operator|)
name|addr
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|db_nofault
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
name|void
name|Debugger
parameter_list|(
specifier|const
name|char
modifier|*
name|msg
parameter_list|)
block|{
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|msg
argument_list|)
expr_stmt|;
asm|__asm("break 0x80100");
block|}
end_function

begin_function
name|u_long
name|db_register_value
parameter_list|(
name|db_regs_t
modifier|*
name|regs
parameter_list|,
name|int
name|regno
parameter_list|)
block|{
name|uint64_t
modifier|*
name|rsp
decl_stmt|;
name|uint64_t
name|bsp
decl_stmt|;
name|int
name|nats
decl_stmt|,
name|sof
decl_stmt|;
if|if
condition|(
name|regno
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|regno
operator|==
literal|1
condition|)
return|return
operator|(
name|regs
operator|->
name|tf_special
operator|.
name|gp
operator|)
return|;
if|if
condition|(
name|regno
operator|>=
literal|2
operator|&&
name|regno
operator|<=
literal|3
condition|)
return|return
operator|(
operator|(
operator|&
name|regs
operator|->
name|tf_scratch
operator|.
name|gr2
operator|)
index|[
name|regno
operator|-
literal|2
index|]
operator|)
return|;
if|if
condition|(
name|regno
operator|>=
literal|8
operator|&&
name|regno
operator|<=
literal|11
condition|)
return|return
operator|(
operator|(
operator|&
name|regs
operator|->
name|tf_scratch
operator|.
name|gr8
operator|)
index|[
name|regno
operator|-
literal|8
index|]
operator|)
return|;
if|if
condition|(
name|regno
operator|==
literal|12
condition|)
return|return
operator|(
name|regs
operator|->
name|tf_special
operator|.
name|sp
operator|)
return|;
if|if
condition|(
name|regno
operator|==
literal|13
condition|)
return|return
operator|(
name|regs
operator|->
name|tf_special
operator|.
name|tp
operator|)
return|;
if|if
condition|(
name|regno
operator|>=
literal|14
operator|&&
name|regno
operator|<=
literal|31
condition|)
return|return
operator|(
operator|(
operator|&
name|regs
operator|->
name|tf_scratch
operator|.
name|gr14
operator|)
index|[
name|regno
operator|-
literal|14
index|]
operator|)
return|;
name|sof
operator|=
call|(
name|int
call|)
argument_list|(
name|regs
operator|->
name|tf_special
operator|.
name|cfm
operator|&
literal|0x7f
argument_list|)
expr_stmt|;
if|if
condition|(
name|regno
operator|>=
literal|32
operator|&&
name|regno
operator|<
name|sof
operator|+
literal|32
condition|)
block|{
name|bsp
operator|=
name|regs
operator|->
name|tf_special
operator|.
name|bspstore
operator|+
name|regs
operator|->
name|tf_special
operator|.
name|ndirty
expr_stmt|;
name|regno
operator|-=
literal|32
expr_stmt|;
name|nats
operator|=
operator|(
name|sof
operator|-
name|regno
operator|+
literal|63
operator|-
operator|(
call|(
name|int
call|)
argument_list|(
name|bsp
operator|>>
literal|3
argument_list|)
operator|&
literal|0x3f
operator|)
operator|)
operator|/
literal|63
expr_stmt|;
name|rsp
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
name|bsp
operator|-
operator|(
operator|(
name|sof
operator|-
name|regno
operator|+
name|nats
operator|)
operator|<<
literal|3
operator|)
operator|)
expr_stmt|;
return|return
operator|(
operator|*
name|rsp
operator|)
return|;
block|}
name|db_printf
argument_list|(
literal|" **** STRANGE REGISTER NUMBER %d **** "
argument_list|,
name|regno
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|void
name|db_write_breakpoint
parameter_list|(
name|vm_offset_t
name|addr
parameter_list|,
name|u_int64_t
modifier|*
name|storage
parameter_list|)
block|{ }
end_function

begin_function
name|void
name|db_clear_breakpoint
parameter_list|(
name|vm_offset_t
name|addr
parameter_list|,
name|u_int64_t
modifier|*
name|storage
parameter_list|)
block|{ }
end_function

begin_function
name|void
name|db_skip_breakpoint
parameter_list|()
block|{
name|ddb_regs
operator|.
name|tf_special
operator|.
name|psr
operator|+=
name|IA64_PSR_RI_1
expr_stmt|;
if|if
condition|(
operator|(
name|ddb_regs
operator|.
name|tf_special
operator|.
name|psr
operator|&
name|IA64_PSR_RI
operator|)
operator|>
name|IA64_PSR_RI_2
condition|)
block|{
name|ddb_regs
operator|.
name|tf_special
operator|.
name|psr
operator|&=
operator|~
name|IA64_PSR_RI
expr_stmt|;
name|ddb_regs
operator|.
name|tf_special
operator|.
name|iip
operator|+=
literal|16
expr_stmt|;
block|}
block|}
end_function

begin_function
name|db_addr_t
name|db_disasm
parameter_list|(
name|db_addr_t
name|loc
parameter_list|,
name|boolean_t
name|altfmt
parameter_list|)
block|{
name|char
name|buf
index|[
literal|32
index|]
decl_stmt|;
name|struct
name|asm_bundle
name|bundle
decl_stmt|;
specifier|const
name|struct
name|asm_inst
modifier|*
name|i
decl_stmt|;
specifier|const
name|char
modifier|*
name|tmpl
decl_stmt|;
name|int
name|n
decl_stmt|,
name|slot
decl_stmt|;
name|slot
operator|=
name|loc
operator|&
literal|0xf
expr_stmt|;
name|loc
operator|&=
operator|~
literal|0xful
expr_stmt|;
name|db_read_bytes
argument_list|(
name|loc
argument_list|,
literal|16
argument_list|,
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|asm_decode
argument_list|(
operator|(
name|uintptr_t
operator|)
name|buf
argument_list|,
operator|&
name|bundle
argument_list|)
condition|)
block|{
name|i
operator|=
name|bundle
operator|.
name|b_inst
operator|+
name|slot
expr_stmt|;
name|tmpl
operator|=
name|bundle
operator|.
name|b_templ
operator|+
name|slot
expr_stmt|;
if|if
condition|(
operator|*
name|tmpl
operator|==
literal|';'
operator|||
operator|(
name|slot
operator|==
literal|2
operator|&&
name|bundle
operator|.
name|b_templ
index|[
literal|1
index|]
operator|==
literal|';'
operator|)
condition|)
name|tmpl
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|tmpl
operator|==
literal|'L'
operator|||
name|i
operator|->
name|i_op
operator|==
name|ASM_OP_NONE
condition|)
block|{
name|db_printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* Unit + slot. */
name|db_printf
argument_list|(
literal|"[%c%d] "
argument_list|,
operator|*
name|tmpl
argument_list|,
name|slot
argument_list|)
expr_stmt|;
comment|/* Predicate. */
if|if
condition|(
name|i
operator|->
name|i_oper
index|[
literal|0
index|]
operator|.
name|o_value
operator|!=
literal|0
condition|)
block|{
name|asm_operand
argument_list|(
name|i
operator|->
name|i_oper
operator|+
literal|0
argument_list|,
name|buf
argument_list|,
name|loc
argument_list|)
expr_stmt|;
name|db_printf
argument_list|(
literal|"(%s) "
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
else|else
name|db_printf
argument_list|(
literal|"   "
argument_list|)
expr_stmt|;
comment|/* Mnemonic& completers. */
name|asm_mnemonic
argument_list|(
name|i
operator|->
name|i_op
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|db_printf
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|n
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|n
operator|<
name|i
operator|->
name|i_ncmpltrs
condition|)
block|{
name|asm_completer
argument_list|(
name|i
operator|->
name|i_cmpltr
operator|+
name|n
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|db_printf
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|n
operator|++
expr_stmt|;
block|}
name|db_printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
comment|/* Operands. */
name|n
operator|=
literal|1
expr_stmt|;
while|while
condition|(
name|n
operator|<
literal|7
operator|&&
name|i
operator|->
name|i_oper
index|[
name|n
index|]
operator|.
name|o_type
operator|!=
name|ASM_OPER_NONE
condition|)
block|{
if|if
condition|(
name|n
operator|>
literal|1
condition|)
block|{
if|if
condition|(
name|n
operator|==
name|i
operator|->
name|i_srcidx
condition|)
name|db_printf
argument_list|(
literal|"="
argument_list|)
expr_stmt|;
else|else
name|db_printf
argument_list|(
literal|","
argument_list|)
expr_stmt|;
block|}
name|asm_operand
argument_list|(
name|i
operator|->
name|i_oper
operator|+
name|n
argument_list|,
name|buf
argument_list|,
name|loc
argument_list|)
expr_stmt|;
name|db_printf
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|n
operator|++
expr_stmt|;
block|}
block|}
else|else
block|{
name|tmpl
operator|=
name|NULL
expr_stmt|;
name|slot
operator|=
literal|2
expr_stmt|;
block|}
name|db_printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|out
label|:
name|slot
operator|++
expr_stmt|;
if|if
condition|(
name|slot
operator|==
literal|1
operator|&&
name|tmpl
index|[
literal|1
index|]
operator|==
literal|'L'
condition|)
name|slot
operator|++
expr_stmt|;
if|if
condition|(
name|slot
operator|>
literal|2
condition|)
name|slot
operator|=
literal|16
expr_stmt|;
return|return
operator|(
name|loc
operator|+
name|slot
operator|)
return|;
block|}
end_function

begin_function
name|void
name|db_show_mdpcpu
parameter_list|(
name|struct
name|pcpu
modifier|*
name|pc
parameter_list|)
block|{ }
end_function

end_unit


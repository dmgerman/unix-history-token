begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* $FreeBSD$ */
end_comment

begin_comment
comment|/*   * Mach Operating System  * Copyright (c) 1992,1991,1990 Carnegie Mellon University  * All Rights Reserved.  *   * Permission to use, copy, modify and distribute this software and its  * documentation is hereby granted, provided that both the copyright  * notice and this permission notice appear in all copies of the  * software, derivative works or modified versions, and any portions  * thereof, and that both notices appear in supporting documentation.  *   * CARNEGIE MELLON ALLOWS FREE USE OF THIS SOFTWARE IN ITS   * CONDITION.  CARNEGIE MELLON DISCLAIMS ANY LIABILITY OF ANY KIND FOR  * ANY DAMAGES WHATSOEVER RESULTING FROM THE USE OF THIS SOFTWARE.  *   * Carnegie Mellon requests users of this software to return to  *   *  Software Distribution Coordinator  or  Software.Distribution@CS.CMU.EDU  *  School of Computer Science  *  Carnegie Mellon University  *  Pittsburgh PA 15213-3890  *   * any improvements or extensions that they make and grant Carnegie the  * rights to redistribute these changes.  *  *	db_interface.c,v 2.4 1991/02/05 17:11:13 mrt (CMU)  */
end_comment

begin_comment
comment|/*  * Parts of this file are derived from Mach 3:  *  *	File: alpha_instruction.c  *	Author: Alessandro Forin, Carnegie Mellon University  *	Date:	6/92  */
end_comment

begin_comment
comment|/*  * Interface to DDB.  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/reboot.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/smp.h>
end_include

begin_include
include|#
directive|include
file|<sys/cons.h>
end_include

begin_include
include|#
directive|include
file|<sys/ktr.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm.h>
end_include

begin_include
include|#
directive|include
file|<machine/inst.h>
end_include

begin_include
include|#
directive|include
file|<machine/rse.h>
end_include

begin_include
include|#
directive|include
file|<machine/db_machdep.h>
end_include

begin_include
include|#
directive|include
file|<machine/mutex.h>
end_include

begin_include
include|#
directive|include
file|<ddb/ddb.h>
end_include

begin_include
include|#
directive|include
file|<ddb/db_access.h>
end_include

begin_include
include|#
directive|include
file|<ddb/db_sym.h>
end_include

begin_include
include|#
directive|include
file|<ddb/db_variables.h>
end_include

begin_include
include|#
directive|include
file|<machine/setjmp.h>
end_include

begin_decl_stmt
specifier|static
name|jmp_buf
modifier|*
name|db_nofault
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|jmp_buf
name|db_jmpbuf
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|extern
name|void
name|gdb_handle_exception
parameter_list|(
name|db_regs_t
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
name|int
name|db_active
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|db_regs_t
name|ddb_regs
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|u_int64_t
name|zero
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|int
name|db_get_rse_reg
parameter_list|(
name|struct
name|db_variable
modifier|*
name|vp
parameter_list|,
name|db_expr_t
modifier|*
name|valuep
parameter_list|,
name|int
name|op
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|db_get_pc_reg
parameter_list|(
name|struct
name|db_variable
modifier|*
name|vp
parameter_list|,
name|db_expr_t
modifier|*
name|valuep
parameter_list|,
name|int
name|op
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
name|struct
name|db_variable
name|db_regs
index|[]
init|=
block|{
comment|/* Misc control/app registers */
define|#
directive|define
name|DB_MISC_REGS
value|15
comment|/* make sure this is correct */
block|{
literal|"pc"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|0
block|,
name|db_get_pc_reg
block|}
block|,
block|{
literal|"ip"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_cr_iip
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"psr"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_cr_ipsr
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"cr.isr"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_cr_isr
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"cr.ifa"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_cr_ifa
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"pr"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_pr
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"ar.rsc"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_ar_rsc
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"ar.pfs"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_ar_pfs
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"cr.ifs"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_cr_ifs
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"ar.bspstore"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_ar_bspstore
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"ar.rnat"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_ar_rnat
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"ndirty"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_ndirty
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"ar.unat"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_ar_unat
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"ar.ccv"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_ar_ccv
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"ar.fpsr"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_ar_fpsr
block|,
name|FCN_NULL
block|}
block|,
comment|/* Branch registers */
block|{
literal|"rp"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_b
index|[
literal|0
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"b1"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_b
index|[
literal|1
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"b2"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_b
index|[
literal|2
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"b3"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_b
index|[
literal|3
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"b4"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_b
index|[
literal|4
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"b5"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_b
index|[
literal|5
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"b6"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_b
index|[
literal|6
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"b7"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_b
index|[
literal|7
index|]
block|,
name|FCN_NULL
block|}
block|,
comment|/* Static registers */
block|{
literal|"r0"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|zero
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"gp"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_r
index|[
name|FRAME_R1
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r2"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_r
index|[
name|FRAME_R2
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r3"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_r
index|[
name|FRAME_R3
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r4"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_r
index|[
name|FRAME_R4
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r5"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_r
index|[
name|FRAME_R5
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r6"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_r
index|[
name|FRAME_R6
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r7"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_r
index|[
name|FRAME_R7
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r8"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_r
index|[
name|FRAME_R8
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r9"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_r
index|[
name|FRAME_R9
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r10"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_r
index|[
name|FRAME_R10
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r11"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_r
index|[
name|FRAME_R11
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"sp"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_r
index|[
name|FRAME_R12
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r13"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_r
index|[
name|FRAME_R13
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r14"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_r
index|[
name|FRAME_R14
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r15"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_r
index|[
name|FRAME_R15
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r16"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_r
index|[
name|FRAME_R16
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r17"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_r
index|[
name|FRAME_R17
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r18"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_r
index|[
name|FRAME_R18
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r19"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_r
index|[
name|FRAME_R19
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r20"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_r
index|[
name|FRAME_R20
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r21"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_r
index|[
name|FRAME_R21
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r22"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_r
index|[
name|FRAME_R22
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r23"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_r
index|[
name|FRAME_R23
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r24"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_r
index|[
name|FRAME_R24
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r25"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_r
index|[
name|FRAME_R25
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r26"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_r
index|[
name|FRAME_R26
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r27"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_r
index|[
name|FRAME_R27
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r28"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_r
index|[
name|FRAME_R28
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r29"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_r
index|[
name|FRAME_R29
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r30"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_r
index|[
name|FRAME_R30
index|]
block|,
name|FCN_NULL
block|}
block|,
block|{
literal|"r31"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
operator|&
name|ddb_regs
operator|.
name|tf_r
index|[
name|FRAME_R31
index|]
block|,
name|FCN_NULL
block|}
block|,
comment|/* Stacked registers */
block|{
literal|"r32"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|32
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r33"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|33
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r34"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|34
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r35"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|35
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r36"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|36
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r37"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|37
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r38"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|38
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r39"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|39
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r40"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|40
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r41"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|41
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r42"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|42
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r43"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|43
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r44"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|44
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r45"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|45
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r46"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|46
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r47"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|47
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r48"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|48
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r49"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|49
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r50"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|50
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r51"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|51
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r52"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|52
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r53"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|53
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r54"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|54
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r55"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|55
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r56"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|56
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r57"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|57
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r58"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|58
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r59"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|59
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r60"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|60
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r61"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|61
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r62"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|62
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r63"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|63
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r64"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|64
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r65"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|65
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r66"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|66
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r67"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|67
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r68"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|68
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r69"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|69
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r70"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|70
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r71"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|71
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r72"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|72
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r73"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|73
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r74"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|74
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r75"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|75
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r76"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|76
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r77"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|77
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r78"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|78
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r79"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|79
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r80"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|80
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r81"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|81
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r82"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|82
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r83"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|83
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r84"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|84
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r85"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|85
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r86"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|86
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r87"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|87
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r88"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|88
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r89"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|89
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r90"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|90
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r91"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|91
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r92"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|92
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r93"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|93
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r94"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|94
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r95"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|95
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r96"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|96
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r97"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|97
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r98"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|98
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r99"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|99
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r100"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|100
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r101"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|101
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r102"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|102
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r103"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|103
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r104"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|104
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r105"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|105
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r106"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|106
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r107"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|107
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r108"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|108
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r109"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|109
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r110"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|110
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r111"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|111
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r112"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|112
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r113"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|113
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r114"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|114
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r115"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|115
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r116"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|116
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r117"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|117
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r118"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|118
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r119"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|119
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r120"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|120
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r121"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|121
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r122"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|122
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r123"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|123
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r124"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|124
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r125"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|125
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r126"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|126
block|,
name|db_get_rse_reg
block|}
block|,
block|{
literal|"r127"
block|,
operator|(
name|db_expr_t
operator|*
operator|)
literal|127
block|,
name|db_get_rse_reg
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|db_variable
modifier|*
name|db_eregs
init|=
name|db_regs
operator|+
sizeof|sizeof
argument_list|(
name|db_regs
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|db_regs
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|db_get_rse_reg
parameter_list|(
name|struct
name|db_variable
modifier|*
name|vp
parameter_list|,
name|db_expr_t
modifier|*
name|valuep
parameter_list|,
name|int
name|op
parameter_list|)
block|{
name|int
name|sof
init|=
name|ddb_regs
operator|.
name|tf_cr_ifs
operator|&
literal|0x7f
decl_stmt|;
name|int
name|regno
init|=
operator|(
name|db_expr_t
operator|)
name|vp
operator|->
name|valuep
decl_stmt|;
name|u_int64_t
modifier|*
name|bsp
init|=
operator|(
name|u_int64_t
operator|*
operator|)
operator|(
name|ddb_regs
operator|.
name|tf_ar_bspstore
operator|+
name|ddb_regs
operator|.
name|tf_ndirty
operator|)
decl_stmt|;
name|u_int64_t
modifier|*
name|reg
decl_stmt|;
if|if
condition|(
name|regno
operator|-
literal|32
operator|>=
name|sof
condition|)
block|{
if|if
condition|(
name|op
operator|==
name|DB_VAR_GET
condition|)
operator|*
name|valuep
operator|=
literal|0xdeadbeefdeadbeef
expr_stmt|;
block|}
else|else
block|{
name|bsp
operator|=
name|ia64_rse_previous_frame
argument_list|(
name|bsp
argument_list|,
name|sof
argument_list|)
expr_stmt|;
name|reg
operator|=
name|ia64_rse_register_address
argument_list|(
name|bsp
argument_list|,
name|regno
argument_list|)
expr_stmt|;
if|if
condition|(
name|op
operator|==
name|DB_VAR_GET
condition|)
operator|*
name|valuep
operator|=
operator|*
name|reg
expr_stmt|;
else|else
operator|*
name|reg
operator|=
operator|*
name|valuep
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|db_get_pc_reg
parameter_list|(
name|struct
name|db_variable
modifier|*
name|vp
parameter_list|,
name|db_expr_t
modifier|*
name|valuep
parameter_list|,
name|int
name|op
parameter_list|)
block|{
comment|/* Read only */
if|if
condition|(
name|op
operator|==
name|DB_VAR_GET
condition|)
operator|*
name|valuep
operator|=
name|PC_REGS
argument_list|(
name|DDB_REGS
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_if
if|#
directive|if
literal|0
end_if

begin_comment
comment|/*  * Print trap reason.  */
end_comment

begin_comment
unit|static void ddbprinttrap(int vector) {
comment|/* XXX Implement. */
end_comment

begin_endif
unit|printf("ddbprinttrap(%d)\n", vector); }
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|CPUSTOP_ON_DDBBREAK
end_define

begin_define
define|#
directive|define
name|VERBOSE_CPUSTOP_ON_DDBBREAK
end_define

begin_comment
comment|/*  *  ddb_trap - field a kernel trap  */
end_comment

begin_function
name|int
name|kdb_trap
parameter_list|(
name|int
name|vector
parameter_list|,
name|struct
name|trapframe
modifier|*
name|regs
parameter_list|)
block|{
name|int
name|ddb_mode
init|=
operator|!
operator|(
name|boothowto
operator|&
name|RB_GDB
operator|)
decl_stmt|;
name|critical_t
name|s
decl_stmt|;
comment|/* 	 * Don't bother checking for usermode, since a benign entry 	 * by the kernel (call to Debugger() or a breakpoint) has 	 * already checked for usermode.  If neither of those 	 * conditions exist, something Bad has happened. 	 */
if|if
condition|(
name|vector
operator|!=
name|IA64_VEC_BREAK
operator|&&
name|vector
operator|!=
name|IA64_VEC_SINGLE_STEP_TRAP
condition|)
block|{
if|#
directive|if
literal|0
block|if (ddb_mode) { 			db_printf("ddbprinttrap from 0x%lx\n",
comment|/* XXX */
block|regs->tf_regs[FRAME_PC]); 			ddbprinttrap(a0, a1, a2, entry);
comment|/* 			 * Tell caller "We did NOT handle the trap." 			 * Caller should panic, or whatever. 			 */
block|return (0); 		}
endif|#
directive|endif
if|if
condition|(
name|db_nofault
condition|)
block|{
name|jmp_buf
modifier|*
name|no_fault
init|=
name|db_nofault
decl_stmt|;
name|db_nofault
operator|=
literal|0
expr_stmt|;
name|longjmp
argument_list|(
operator|*
name|no_fault
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* 	 * XXX Should switch to DDB's own stack, here. 	 */
name|s
operator|=
name|intr_disable
argument_list|()
expr_stmt|;
ifdef|#
directive|ifdef
name|SMP
ifdef|#
directive|ifdef
name|CPUSTOP_ON_DDBBREAK
if|#
directive|if
name|defined
argument_list|(
name|VERBOSE_CPUSTOP_ON_DDBBREAK
argument_list|)
name|db_printf
argument_list|(
literal|"CPU%d stopping CPUs: 0x%08x..."
argument_list|,
name|PCPU_GET
argument_list|(
name|cpuid
argument_list|)
argument_list|,
name|PCPU_GET
argument_list|(
name|other_cpus
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* VERBOSE_CPUSTOP_ON_DDBBREAK */
comment|/* We stop all CPUs except ourselves (obviously) */
name|stop_cpus
argument_list|(
name|PCPU_GET
argument_list|(
name|other_cpus
argument_list|)
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VERBOSE_CPUSTOP_ON_DDBBREAK
argument_list|)
name|db_printf
argument_list|(
literal|" stopped.\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* VERBOSE_CPUSTOP_ON_DDBBREAK */
endif|#
directive|endif
comment|/* CPUSTOP_ON_DDBBREAK */
endif|#
directive|endif
comment|/* SMP */
name|ddb_regs
operator|=
operator|*
name|regs
expr_stmt|;
comment|/* 	 * XXX pretend that registers outside the current frame don't exist. 	 */
name|db_eregs
operator|=
name|db_regs
operator|+
name|DB_MISC_REGS
operator|+
literal|8
operator|+
literal|32
operator|+
operator|(
name|ddb_regs
operator|.
name|tf_cr_ifs
operator|&
literal|0x7f
operator|)
expr_stmt|;
asm|__asm __volatile("flushrs");
comment|/* so we can look at them */
name|db_active
operator|++
expr_stmt|;
if|if
condition|(
name|ddb_mode
condition|)
block|{
name|cndbctl
argument_list|(
name|TRUE
argument_list|)
expr_stmt|;
comment|/* DDB active, unblank video */
name|db_trap
argument_list|(
name|vector
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Where the work happens */
name|cndbctl
argument_list|(
name|FALSE
argument_list|)
expr_stmt|;
comment|/* DDB inactive */
block|}
else|else
name|gdb_handle_exception
argument_list|(
operator|&
name|ddb_regs
argument_list|,
name|vector
argument_list|)
expr_stmt|;
name|db_active
operator|--
expr_stmt|;
ifdef|#
directive|ifdef
name|SMP
ifdef|#
directive|ifdef
name|CPUSTOP_ON_DDBBREAK
if|#
directive|if
name|defined
argument_list|(
name|VERBOSE_CPUSTOP_ON_DDBBREAK
argument_list|)
name|db_printf
argument_list|(
literal|"CPU%d restarting CPUs: 0x%08x..."
argument_list|,
name|PCPU_GET
argument_list|(
name|cpuid
argument_list|)
argument_list|,
name|stopped_cpus
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* VERBOSE_CPUSTOP_ON_DDBBREAK */
comment|/* Restart all the CPUs we previously stopped */
if|if
condition|(
name|stopped_cpus
operator|!=
name|PCPU_GET
argument_list|(
name|other_cpus
argument_list|)
operator|&&
name|smp_started
operator|!=
literal|0
condition|)
block|{
name|db_printf
argument_list|(
literal|"whoa, other_cpus: 0x%08x, stopped_cpus: 0x%08x\n"
argument_list|,
name|PCPU_GET
argument_list|(
name|other_cpus
argument_list|)
argument_list|,
name|stopped_cpus
argument_list|)
expr_stmt|;
name|panic
argument_list|(
literal|"stop_cpus() failed"
argument_list|)
expr_stmt|;
block|}
name|restart_cpus
argument_list|(
name|stopped_cpus
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VERBOSE_CPUSTOP_ON_DDBBREAK
argument_list|)
name|db_printf
argument_list|(
literal|" restarted.\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* VERBOSE_CPUSTOP_ON_DDBBREAK */
endif|#
directive|endif
comment|/* CPUSTOP_ON_DDBBREAK */
endif|#
directive|endif
comment|/* SMP */
operator|*
name|regs
operator|=
name|ddb_regs
expr_stmt|;
name|intr_restore
argument_list|(
name|s
argument_list|)
expr_stmt|;
comment|/* 	 * Tell caller "We HAVE handled the trap." 	 */
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Read bytes from kernel address space for debugger.  */
end_comment

begin_function
name|void
name|db_read_bytes
parameter_list|(
name|addr
parameter_list|,
name|size
parameter_list|,
name|data
parameter_list|)
name|vm_offset_t
name|addr
decl_stmt|;
specifier|register
name|size_t
name|size
decl_stmt|;
specifier|register
name|char
modifier|*
name|data
decl_stmt|;
block|{
specifier|register
name|char
modifier|*
name|src
decl_stmt|;
name|db_nofault
operator|=
operator|&
name|db_jmpbuf
expr_stmt|;
name|src
operator|=
operator|(
name|char
operator|*
operator|)
name|addr
expr_stmt|;
while|while
condition|(
name|size
operator|--
operator|>
literal|0
condition|)
operator|*
name|data
operator|++
operator|=
operator|*
name|src
operator|++
expr_stmt|;
name|db_nofault
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Write bytes to kernel address space for debugger.  */
end_comment

begin_function
name|void
name|db_write_bytes
parameter_list|(
name|addr
parameter_list|,
name|size
parameter_list|,
name|data
parameter_list|)
name|vm_offset_t
name|addr
decl_stmt|;
specifier|register
name|size_t
name|size
decl_stmt|;
specifier|register
name|char
modifier|*
name|data
decl_stmt|;
block|{
specifier|register
name|char
modifier|*
name|dst
decl_stmt|;
name|db_nofault
operator|=
operator|&
name|db_jmpbuf
expr_stmt|;
name|dst
operator|=
operator|(
name|char
operator|*
operator|)
name|addr
expr_stmt|;
while|while
condition|(
name|size
operator|--
operator|>
literal|0
condition|)
operator|*
name|dst
operator|++
operator|=
operator|*
name|data
operator|++
expr_stmt|;
name|db_nofault
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
name|void
name|Debugger
parameter_list|(
specifier|const
name|char
modifier|*
name|msg
parameter_list|)
block|{
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|msg
argument_list|)
expr_stmt|;
asm|__asm("break 0x80100");
block|}
end_function

begin_function
name|u_long
name|db_register_value
parameter_list|(
name|regs
parameter_list|,
name|regno
parameter_list|)
name|db_regs_t
modifier|*
name|regs
decl_stmt|;
name|int
name|regno
decl_stmt|;
block|{
if|if
condition|(
name|regno
operator|>
literal|127
operator|||
name|regno
operator|<
literal|0
condition|)
block|{
name|db_printf
argument_list|(
literal|" **** STRANGE REGISTER NUMBER %d **** "
argument_list|,
name|regno
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|regno
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|regno
operator|<
literal|32
condition|)
block|{
return|return
operator|(
name|regs
operator|->
name|tf_r
index|[
name|regno
operator|-
literal|1
index|]
operator|)
return|;
block|}
else|else
block|{
name|int
name|sof
init|=
name|ddb_regs
operator|.
name|tf_cr_ifs
operator|&
literal|0x7f
decl_stmt|;
name|u_int64_t
modifier|*
name|bsp
init|=
operator|(
name|u_int64_t
operator|*
operator|)
operator|(
name|ddb_regs
operator|.
name|tf_ar_bspstore
operator|+
name|ddb_regs
operator|.
name|tf_ndirty
operator|)
decl_stmt|;
name|u_int64_t
modifier|*
name|reg
decl_stmt|;
if|if
condition|(
name|regno
operator|-
literal|32
operator|>=
name|sof
condition|)
block|{
return|return
literal|0xdeadbeefdeadbeef
return|;
block|}
else|else
block|{
name|bsp
operator|=
name|ia64_rse_previous_frame
argument_list|(
name|bsp
argument_list|,
name|sof
argument_list|)
expr_stmt|;
name|reg
operator|=
name|ia64_rse_register_address
argument_list|(
name|bsp
argument_list|,
name|regno
argument_list|)
expr_stmt|;
return|return
operator|*
name|reg
return|;
block|}
block|}
block|}
end_function

begin_function
name|void
name|db_read_bundle
parameter_list|(
name|db_addr_t
name|addr
parameter_list|,
name|struct
name|ia64_bundle
modifier|*
name|bp
parameter_list|)
block|{
name|u_int64_t
name|low
decl_stmt|,
name|high
decl_stmt|;
name|db_read_bytes
argument_list|(
name|addr
argument_list|,
literal|8
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|low
argument_list|)
expr_stmt|;
name|db_read_bytes
argument_list|(
name|addr
operator|+
literal|8
argument_list|,
literal|8
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|high
argument_list|)
expr_stmt|;
name|ia64_unpack_bundle
argument_list|(
name|low
argument_list|,
name|high
argument_list|,
name|bp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|db_write_bundle
parameter_list|(
name|db_addr_t
name|addr
parameter_list|,
name|struct
name|ia64_bundle
modifier|*
name|bp
parameter_list|)
block|{
name|u_int64_t
name|low
decl_stmt|,
name|high
decl_stmt|;
name|ia64_pack_bundle
argument_list|(
operator|&
name|low
argument_list|,
operator|&
name|high
argument_list|,
name|bp
argument_list|)
expr_stmt|;
name|db_write_bytes
argument_list|(
name|addr
argument_list|,
literal|8
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|low
argument_list|)
expr_stmt|;
name|db_write_bytes
argument_list|(
name|addr
operator|+
literal|8
argument_list|,
literal|8
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|high
argument_list|)
expr_stmt|;
name|ia64_fc
argument_list|(
name|addr
argument_list|)
expr_stmt|;
name|ia64_sync_i
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|void
name|db_write_breakpoint
parameter_list|(
name|vm_offset_t
name|addr
parameter_list|,
name|u_int64_t
modifier|*
name|storage
parameter_list|)
block|{
name|struct
name|ia64_bundle
name|b
decl_stmt|;
name|int
name|slot
decl_stmt|;
name|slot
operator|=
name|addr
operator|&
literal|15
expr_stmt|;
name|addr
operator|&=
operator|~
literal|15
expr_stmt|;
name|db_read_bundle
argument_list|(
name|addr
argument_list|,
operator|&
name|b
argument_list|)
expr_stmt|;
operator|*
name|storage
operator|=
name|b
operator|.
name|slot
index|[
name|slot
index|]
expr_stmt|;
name|b
operator|.
name|slot
index|[
name|slot
index|]
operator|=
literal|0x80100
operator|<<
literal|6
expr_stmt|;
comment|/* break.* 0x80100 */
name|db_write_bundle
argument_list|(
name|addr
argument_list|,
operator|&
name|b
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|db_clear_breakpoint
parameter_list|(
name|vm_offset_t
name|addr
parameter_list|,
name|u_int64_t
modifier|*
name|storage
parameter_list|)
block|{
name|struct
name|ia64_bundle
name|b
decl_stmt|;
name|int
name|slot
decl_stmt|;
name|slot
operator|=
name|addr
operator|&
literal|15
expr_stmt|;
name|addr
operator|&=
operator|~
literal|15
expr_stmt|;
name|db_read_bundle
argument_list|(
name|addr
argument_list|,
operator|&
name|b
argument_list|)
expr_stmt|;
name|b
operator|.
name|slot
index|[
name|slot
index|]
operator|=
operator|*
name|storage
expr_stmt|;
name|db_write_bundle
argument_list|(
name|addr
argument_list|,
operator|&
name|b
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|db_skip_breakpoint
parameter_list|(
name|void
parameter_list|)
block|{
comment|/* 	 * Skip past the break instruction. 	 */
name|ddb_regs
operator|.
name|tf_cr_ipsr
operator|+=
name|IA64_PSR_RI_1
expr_stmt|;
if|if
condition|(
operator|(
name|ddb_regs
operator|.
name|tf_cr_ipsr
operator|&
name|IA64_PSR_RI
operator|)
operator|>
name|IA64_PSR_RI_2
condition|)
block|{
name|ddb_regs
operator|.
name|tf_cr_ipsr
operator|&=
operator|~
name|IA64_PSR_RI
expr_stmt|;
name|ddb_regs
operator|.
name|tf_cr_iip
operator|+=
literal|16
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|db_show_mdpcpu
parameter_list|(
name|struct
name|pcpu
modifier|*
name|pc
parameter_list|)
block|{ }
end_function

end_unit


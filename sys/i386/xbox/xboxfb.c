begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2005, 2006 Rink Springer<rink@il.fontys.nl>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. The name of the author may not be used to endorse or promote products  *    derived from this software without specific prior written permission  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*  * This is the syscon(4)-ized version of the Xbox Frame Buffer driver. It  * supports about all features required, such as mouse support.  *  * A lot of functions that are not useful to us have not been implemented.  * It appears that some functions are never called, but these implementations  * are here nevertheless.  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm_param.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/cons.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_include
include|#
directive|include
file|<sys/consio.h>
end_include

begin_include
include|#
directive|include
file|<sys/limits.h>
end_include

begin_include
include|#
directive|include
file|<sys/tty.h>
end_include

begin_include
include|#
directive|include
file|<sys/kbio.h>
end_include

begin_include
include|#
directive|include
file|<sys/fbio.h>
end_include

begin_include
include|#
directive|include
file|<dev/kbd/kbdreg.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm.h>
end_include

begin_include
include|#
directive|include
file|<vm/pmap.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/xbox.h>
end_include

begin_include
include|#
directive|include
file|<machine/legacyvar.h>
end_include

begin_include
include|#
directive|include
file|<dev/fb/fbreg.h>
end_include

begin_include
include|#
directive|include
file|<dev/fb/gfb.h>
end_include

begin_include
include|#
directive|include
file|<dev/syscons/syscons.h>
end_include

begin_struct
struct|struct
name|xboxfb_softc
block|{
name|video_adapter_t
name|sc_va
decl_stmt|;
comment|/* screen height (pixels) */
name|uint32_t
name|sc_height
decl_stmt|;
comment|/* screen width (pixels) */
name|uint32_t
name|sc_width
decl_stmt|;
comment|/* pointer to the actual XBOX video memory */
name|char
modifier|*
name|sc_framebuffer
decl_stmt|;
comment|/* pointer to the font used */
specifier|const
name|struct
name|gfb_font
modifier|*
name|sc_font
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|SCREEN_WIDTH
value|640
end_define

begin_define
define|#
directive|define
name|SCREEN_HEIGHT
value|480
end_define

begin_define
define|#
directive|define
name|XBOXFB_DRIVER_NAME
value|"xboxsc"
end_define

begin_decl_stmt
specifier|extern
specifier|const
name|struct
name|gfb_font
name|bold8x16
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_probe_t
name|xboxfb_probe
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_init_t
name|xboxfb_init
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_get_info_t
name|xboxfb_get_info
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_query_mode_t
name|xboxfb_query_mode
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_set_mode_t
name|xboxfb_set_mode
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_save_font_t
name|xboxfb_save_font
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_load_font_t
name|xboxfb_load_font
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_show_font_t
name|xboxfb_show_font
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_save_palette_t
name|xboxfb_save_palette
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_load_palette_t
name|xboxfb_load_palette
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_set_border_t
name|xboxfb_set_border
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_save_state_t
name|xboxfb_save_state
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_load_state_t
name|xboxfb_load_state
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_set_win_org_t
name|xboxfb_set_win_org
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_read_hw_cursor_t
name|xboxfb_read_hw_cursor
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_set_hw_cursor_t
name|xboxfb_set_hw_cursor
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_set_hw_cursor_shape_t
name|xboxfb_set_hw_cursor_shape
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_blank_display_t
name|xboxfb_blank_display
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_mmap_t
name|xboxfb_mmap
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_ioctl_t
name|xboxfb_ioctl
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_clear_t
name|xboxfb_clear
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_fill_rect_t
name|xboxfb_fill_rect
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_bitblt_t
name|xboxfb_bitblt
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_diag_t
name|xboxfb_diag
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_save_cursor_palette_t
name|xboxfb_save_cursor_palette
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_load_cursor_palette_t
name|xboxfb_load_cursor_palette
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_copy_t
name|xboxfb_copy
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_putp_t
name|xboxfb_putp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_putc_t
name|xboxfb_putc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_puts_t
name|xboxfb_puts
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_putm_t
name|xboxfb_putm
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|video_switch_t
name|xboxvidsw
init|=
block|{
operator|.
name|probe
operator|=
name|xboxfb_probe
block|,
operator|.
name|init
operator|=
name|xboxfb_init
block|,
operator|.
name|get_info
operator|=
name|xboxfb_get_info
block|,
operator|.
name|query_mode
operator|=
name|xboxfb_query_mode
block|,
operator|.
name|set_mode
operator|=
name|xboxfb_set_mode
block|,
operator|.
name|save_font
operator|=
name|xboxfb_save_font
block|,
operator|.
name|load_font
operator|=
name|xboxfb_load_font
block|,
operator|.
name|show_font
operator|=
name|xboxfb_show_font
block|,
operator|.
name|save_palette
operator|=
name|xboxfb_save_palette
block|,
operator|.
name|load_palette
operator|=
name|xboxfb_load_palette
block|,
operator|.
name|set_border
operator|=
name|xboxfb_set_border
block|,
operator|.
name|save_state
operator|=
name|xboxfb_save_state
block|,
operator|.
name|load_state
operator|=
name|xboxfb_load_state
block|,
operator|.
name|set_win_org
operator|=
name|xboxfb_set_win_org
block|,
operator|.
name|read_hw_cursor
operator|=
name|xboxfb_read_hw_cursor
block|,
operator|.
name|set_hw_cursor
operator|=
name|xboxfb_set_hw_cursor
block|,
operator|.
name|set_hw_cursor_shape
operator|=
name|xboxfb_set_hw_cursor_shape
block|,
operator|.
name|blank_display
operator|=
name|xboxfb_blank_display
block|,
operator|.
name|mmap
operator|=
name|xboxfb_mmap
block|,
operator|.
name|ioctl
operator|=
name|xboxfb_ioctl
block|,
operator|.
name|clear
operator|=
name|xboxfb_clear
block|,
operator|.
name|fill_rect
operator|=
name|xboxfb_fill_rect
block|,
operator|.
name|bitblt
operator|=
name|xboxfb_bitblt
block|,
name|NULL
block|,
name|NULL
block|,
operator|.
name|diag
operator|=
name|xboxfb_diag
block|,
operator|.
name|save_cursor_palette
operator|=
name|xboxfb_save_cursor_palette
block|,
operator|.
name|load_cursor_palette
operator|=
name|xboxfb_load_cursor_palette
block|,
operator|.
name|copy
operator|=
name|xboxfb_copy
block|,
operator|.
name|putp
operator|=
name|xboxfb_putp
block|,
operator|.
name|putc
operator|=
name|xboxfb_putc
block|,
operator|.
name|puts
operator|=
name|xboxfb_puts
block|,
operator|.
name|putm
operator|=
name|xboxfb_putm
block|}
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|int
name|xboxfb_configure
parameter_list|(
name|int
name|flags
parameter_list|)
function_decl|;
end_function_decl

begin_expr_stmt
name|VIDEO_DRIVER
argument_list|(
name|xboxsc
argument_list|,
name|xboxvidsw
argument_list|,
name|xboxfb_configure
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|vr_init_t
name|xbr_init
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vr_clear_t
name|xbr_clear
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vr_draw_border_t
name|xbr_draw_border
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vr_draw_t
name|xbr_draw
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vr_set_cursor_t
name|xbr_set_cursor
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vr_draw_cursor_t
name|xbr_draw_cursor
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vr_blink_cursor_t
name|xbr_blink_cursor
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vr_set_mouse_t
name|xbr_set_mouse
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vr_draw_mouse_t
name|xbr_draw_mouse
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * We use our own renderer; this is because we must emulate a hardware  * cursor.  */
end_comment

begin_decl_stmt
specifier|static
name|sc_rndr_sw_t
name|xboxrend
init|=
block|{
name|xbr_init
block|,
name|xbr_clear
block|,
name|xbr_draw_border
block|,
name|xbr_draw
block|,
name|xbr_set_cursor
block|,
name|xbr_draw_cursor
block|,
name|xbr_blink_cursor
block|,
name|xbr_set_mouse
block|,
name|xbr_draw_mouse
block|}
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|RENDERER
argument_list|(
name|xboxsc
argument_list|,
literal|0
argument_list|,
name|xboxrend
argument_list|,
name|gfb_set
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|struct
name|xboxfb_softc
name|xboxfb_sc
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* color mappings, from dev/fb/creator.c */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|uint32_t
name|cmap
index|[]
init|=
block|{
literal|0x00000000
block|,
comment|/* black */
literal|0x000000ff
block|,
comment|/* blue */
literal|0x0000ff00
block|,
comment|/* green */
literal|0x0000c0c0
block|,
comment|/* cyan */
literal|0x00ff0000
block|,
comment|/* red */
literal|0x00c000c0
block|,
comment|/* magenta */
literal|0x00c0c000
block|,
comment|/* brown */
literal|0x00c0c0c0
block|,
comment|/* light grey */
literal|0x00808080
block|,
comment|/* dark grey */
literal|0x008080ff
block|,
comment|/* light blue */
literal|0x0080ff80
block|,
comment|/* light green */
literal|0x0080ffff
block|,
comment|/* light cyan */
literal|0x00ff8080
block|,
comment|/* light red */
literal|0x00ff80ff
block|,
comment|/* light magenta */
literal|0x00ffff80
block|,
comment|/* yellow */
literal|0x00ffffff
comment|/* white */
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* mouse pointer from dev/syscons/scgfbrndr.c */
end_comment

begin_decl_stmt
specifier|static
name|u_char
name|mouse_pointer
index|[
literal|16
index|]
init|=
block|{
literal|0x00
block|,
literal|0x40
block|,
literal|0x60
block|,
literal|0x70
block|,
literal|0x78
block|,
literal|0x7c
block|,
literal|0x7e
block|,
literal|0x68
block|,
literal|0x0c
block|,
literal|0x0c
block|,
literal|0x06
block|,
literal|0x06
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|xboxfb_init
parameter_list|(
name|int
name|unit
parameter_list|,
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
name|struct
name|xboxfb_softc
modifier|*
name|sc
init|=
operator|&
name|xboxfb_sc
decl_stmt|;
name|video_info_t
modifier|*
name|vi
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
modifier|*
name|iptr
decl_stmt|;
name|vi
operator|=
operator|&
name|adp
operator|->
name|va_info
expr_stmt|;
name|vid_init_struct
argument_list|(
name|adp
argument_list|,
name|XBOXFB_DRIVER_NAME
argument_list|,
operator|-
literal|1
argument_list|,
name|unit
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_height
operator|=
name|SCREEN_HEIGHT
expr_stmt|;
name|sc
operator|->
name|sc_width
operator|=
name|SCREEN_WIDTH
expr_stmt|;
name|sc
operator|->
name|sc_font
operator|=
operator|&
name|bold8x16
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|adp
operator|->
name|va_flags
operator|&
name|V_ADP_INITIALIZED
operator|)
condition|)
block|{
comment|/* 		 * We must make a mapping from video framebuffer memory 		 * to real. This is very crude:  we map the entire 		 * videomemory to PAGE_SIZE! Since our kernel lives at 		 * it's relocated address range (0xc0xxxxxx), it won't 		 * care. 		 * 		 * We use address PAGE_SIZE and up so we can still trap 		 * NULL pointers.  Once the real init is called, the 		 * mapping will be done via the OS and stored in a more 		 * sensible location ... but since we're not fully 		 * initialized, this is our only way to go :-( 		 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|XBOX_FB_SIZE
operator|/
name|PAGE_SIZE
operator|)
condition|;
name|i
operator|++
control|)
block|{
name|pmap_kenter
argument_list|(
operator|(
operator|(
name|i
operator|+
literal|1
operator|)
operator|*
name|PAGE_SIZE
operator|)
argument_list|,
name|XBOX_FB_START
operator|+
operator|(
name|i
operator|*
name|PAGE_SIZE
operator|)
argument_list|)
expr_stmt|;
block|}
name|pmap_kenter
argument_list|(
operator|(
name|i
operator|+
literal|1
operator|)
operator|*
name|PAGE_SIZE
argument_list|,
name|XBOX_FB_START_PTR
operator|-
name|XBOX_FB_START_PTR
operator|%
name|PAGE_SIZE
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_framebuffer
operator|=
operator|(
name|char
operator|*
operator|)
name|PAGE_SIZE
expr_stmt|;
comment|/* ensure the framebuffer is where we want it to be */
operator|*
operator|(
name|uint32_t
operator|*
operator|)
operator|(
operator|(
name|i
operator|+
literal|1
operator|)
operator|*
name|PAGE_SIZE
operator|+
name|XBOX_FB_START_PTR
operator|%
name|PAGE_SIZE
operator|)
operator|=
name|XBOX_FB_START
expr_stmt|;
comment|/* clear the screen */
name|iptr
operator|=
operator|(
name|uint32_t
operator|*
operator|)
name|sc
operator|->
name|sc_framebuffer
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|sc_height
operator|*
name|sc
operator|->
name|sc_width
condition|;
name|i
operator|++
control|)
operator|*
name|iptr
operator|++
operator|=
name|cmap
index|[
literal|0
index|]
expr_stmt|;
comment|/* don't ever do this again! */
name|adp
operator|->
name|va_flags
operator||=
name|V_ADP_INITIALIZED
expr_stmt|;
block|}
name|vi
operator|->
name|vi_mode
operator|=
name|M_TEXT_80x25
expr_stmt|;
name|vi
operator|->
name|vi_cwidth
operator|=
name|sc
operator|->
name|sc_font
operator|->
name|width
expr_stmt|;
name|vi
operator|->
name|vi_cheight
operator|=
name|sc
operator|->
name|sc_font
operator|->
name|height
expr_stmt|;
name|vi
operator|->
name|vi_height
operator|=
operator|(
name|sc
operator|->
name|sc_height
operator|/
name|vi
operator|->
name|vi_cheight
operator|)
expr_stmt|;
name|vi
operator|->
name|vi_width
operator|=
operator|(
name|sc
operator|->
name|sc_width
operator|/
name|vi
operator|->
name|vi_cwidth
operator|)
expr_stmt|;
name|vi
operator|->
name|vi_flags
operator|=
name|V_INFO_COLOR
operator||
name|V_INFO_LINEAR
expr_stmt|;
name|vi
operator|->
name|vi_mem_model
operator|=
name|V_INFO_MM_DIRECT
expr_stmt|;
name|adp
operator|->
name|va_flags
operator||=
name|V_ADP_COLOR
expr_stmt|;
if|if
condition|(
name|vid_register
argument_list|(
name|adp
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|adp
operator|->
name|va_flags
operator||=
name|V_ADP_REGISTERED
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|xboxfb_probe
parameter_list|(
name|int
name|unit
parameter_list|,
name|video_adapter_t
modifier|*
modifier|*
name|adp
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|xboxfb_configure
parameter_list|(
name|int
name|flags
parameter_list|)
block|{
name|struct
name|xboxfb_softc
modifier|*
name|sc
init|=
operator|&
name|xboxfb_sc
decl_stmt|;
comment|/* Don't init the framebuffer on non-XBOX-es */
if|if
condition|(
operator|!
name|arch_i386_is_xbox
condition|)
return|return
literal|0
return|;
comment|/* 	 * If we do only a probe, we are in such an early boot stadium 	 * that we cannot yet do a 'clean' initialization. 	 */
if|if
condition|(
name|flags
operator|&
name|VIO_PROBE_ONLY
condition|)
block|{
name|xboxfb_init
argument_list|(
literal|0
argument_list|,
operator|&
name|sc
operator|->
name|sc_va
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
comment|/* Do a clean mapping of the framebuffer memory */
name|sc
operator|->
name|sc_framebuffer
operator|=
name|pmap_mapdev
argument_list|(
name|XBOX_FB_START
argument_list|,
name|XBOX_FB_SIZE
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|sc_identify
parameter_list|(
name|driver_t
modifier|*
name|driver
parameter_list|,
name|device_t
name|parent
parameter_list|)
block|{
name|BUS_ADD_CHILD
argument_list|(
name|parent
argument_list|,
name|INT_MAX
argument_list|,
name|SC_DRIVER_NAME
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|sc_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"XBox System console"
argument_list|)
expr_stmt|;
return|return
operator|(
name|sc_probe_unit
argument_list|(
name|device_get_unit
argument_list|(
name|dev
argument_list|)
argument_list|,
name|device_get_flags
argument_list|(
name|dev
argument_list|)
operator||
name|SC_AUTODETECT_KBD
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sc_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
return|return
operator|(
name|sc_attach_unit
argument_list|(
name|device_get_unit
argument_list|(
name|dev
argument_list|)
argument_list|,
name|device_get_flags
argument_list|(
name|dev
argument_list|)
operator||
name|SC_AUTODETECT_KBD
argument_list|)
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|device_method_t
name|sc_methods
index|[]
init|=
block|{
comment|/* Device interface */
name|DEVMETHOD
argument_list|(
name|device_identify
argument_list|,
name|sc_identify
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|sc_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|sc_attach
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|xboxfb_sc_driver
init|=
block|{
name|SC_DRIVER_NAME
block|,
name|sc_methods
block|,
expr|sizeof
operator|(
name|sc_softc_t
operator|)
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|sc_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|sc
argument_list|,
name|legacy
argument_list|,
name|xboxfb_sc_driver
argument_list|,
name|sc_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|void
name|xbr_init
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|)
block|{ }
end_function

begin_function
specifier|static
name|void
name|xbr_clear
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|int
name|c
parameter_list|,
name|int
name|attr
parameter_list|)
block|{ }
end_function

begin_function
specifier|static
name|void
name|xbr_draw_border
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|int
name|color
parameter_list|)
block|{ }
end_function

begin_function
specifier|static
name|void
name|xbr_draw
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|int
name|from
parameter_list|,
name|int
name|count
parameter_list|,
name|int
name|flip
parameter_list|)
block|{
name|video_adapter_t
modifier|*
name|adp
init|=
name|scp
operator|->
name|sc
operator|->
name|adp
decl_stmt|;
name|int
name|i
decl_stmt|,
name|c
decl_stmt|,
name|a
decl_stmt|;
if|if
condition|(
operator|!
name|flip
condition|)
block|{
comment|/* Normal printing */
name|vidd_puts
argument_list|(
name|adp
argument_list|,
name|from
argument_list|,
operator|(
name|uint16_t
operator|*
operator|)
name|sc_vtb_pointer
argument_list|(
operator|&
name|scp
operator|->
name|vtb
argument_list|,
name|from
argument_list|)
argument_list|,
name|count
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* This is for selections and such: invert the color attribute */
for|for
control|(
name|i
operator|=
name|count
init|;
name|i
operator|--
operator|>
literal|0
condition|;
operator|++
name|from
control|)
block|{
name|c
operator|=
name|sc_vtb_getc
argument_list|(
operator|&
name|scp
operator|->
name|vtb
argument_list|,
name|from
argument_list|)
expr_stmt|;
name|a
operator|=
name|sc_vtb_geta
argument_list|(
operator|&
name|scp
operator|->
name|vtb
argument_list|,
name|from
argument_list|)
operator|>>
literal|8
expr_stmt|;
name|vidd_putc
argument_list|(
name|adp
argument_list|,
name|from
argument_list|,
name|c
argument_list|,
operator|(
name|a
operator|>>
literal|4
operator|)
operator||
operator|(
operator|(
name|a
operator|&
literal|0xf
operator|)
operator|<<
literal|4
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|xbr_set_cursor
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|int
name|base
parameter_list|,
name|int
name|height
parameter_list|,
name|int
name|blink
parameter_list|)
block|{ }
end_function

begin_function
specifier|static
name|void
name|xbr_draw_cursor
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|int
name|at
parameter_list|,
name|int
name|blink
parameter_list|,
name|int
name|on
parameter_list|,
name|int
name|flip
parameter_list|)
block|{
name|struct
name|xboxfb_softc
modifier|*
name|sc
init|=
operator|&
name|xboxfb_sc
decl_stmt|;
name|video_adapter_t
modifier|*
name|adp
init|=
name|scp
operator|->
name|sc
operator|->
name|adp
decl_stmt|;
name|uint32_t
modifier|*
name|ptri
init|=
operator|(
name|uint32_t
operator|*
operator|)
name|sc
operator|->
name|sc_framebuffer
decl_stmt|;
name|int
name|row
decl_stmt|,
name|col
decl_stmt|,
name|i
decl_stmt|,
name|j
decl_stmt|;
if|if
condition|(
name|scp
operator|->
name|curs_attr
operator|.
name|height
operator|<=
literal|0
condition|)
return|return;
comment|/* calculate the coordinates in the video buffer */
name|row
operator|=
operator|(
name|at
operator|/
name|adp
operator|->
name|va_info
operator|.
name|vi_width
operator|)
operator|*
name|adp
operator|->
name|va_info
operator|.
name|vi_cheight
expr_stmt|;
name|col
operator|=
operator|(
name|at
operator|%
name|adp
operator|->
name|va_info
operator|.
name|vi_width
operator|)
operator|*
name|adp
operator|->
name|va_info
operator|.
name|vi_cwidth
expr_stmt|;
name|ptri
operator|+=
operator|(
name|row
operator|*
name|sc
operator|->
name|sc_width
operator|)
operator|+
name|col
expr_stmt|;
comment|/* our cursor consists of simply inverting the char under it */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|adp
operator|->
name|va_info
operator|.
name|vi_cheight
condition|;
name|i
operator|++
control|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|adp
operator|->
name|va_info
operator|.
name|vi_cwidth
condition|;
name|j
operator|++
control|)
block|{
operator|*
name|ptri
operator|++
operator|^=
literal|0x00FFFFFF
expr_stmt|;
block|}
name|ptri
operator|+=
operator|(
name|sc
operator|->
name|sc_width
operator|-
name|adp
operator|->
name|va_info
operator|.
name|vi_cwidth
operator|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|xbr_blink_cursor
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|int
name|at
parameter_list|,
name|int
name|flip
parameter_list|)
block|{ }
end_function

begin_function
specifier|static
name|void
name|xbr_set_mouse
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|)
block|{ }
end_function

begin_function
specifier|static
name|void
name|xbr_draw_mouse
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|int
name|x
parameter_list|,
name|int
name|y
parameter_list|,
name|int
name|on
parameter_list|)
block|{
name|vidd_putm
argument_list|(
name|scp
operator|->
name|sc
operator|->
name|adp
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|mouse_pointer
argument_list|,
literal|0xffffffff
argument_list|,
literal|16
argument_list|,
literal|8
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|xboxfb_get_info
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|int
name|mode
parameter_list|,
name|video_info_t
modifier|*
name|info
parameter_list|)
block|{
name|bcopy
argument_list|(
operator|&
name|adp
operator|->
name|va_info
argument_list|,
name|info
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|info
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|xboxfb_query_mode
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|video_info_t
modifier|*
name|info
parameter_list|)
block|{
return|return
operator|(
name|ENODEV
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|xboxfb_set_mode
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|xboxfb_save_font
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|int
name|page
parameter_list|,
name|int
name|size
parameter_list|,
name|int
name|width
parameter_list|,
name|u_char
modifier|*
name|data
parameter_list|,
name|int
name|c
parameter_list|,
name|int
name|count
parameter_list|)
block|{
return|return
operator|(
name|ENODEV
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|xboxfb_load_font
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|int
name|page
parameter_list|,
name|int
name|size
parameter_list|,
name|int
name|width
parameter_list|,
name|u_char
modifier|*
name|data
parameter_list|,
name|int
name|c
parameter_list|,
name|int
name|count
parameter_list|)
block|{
return|return
operator|(
name|ENODEV
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|xboxfb_show_font
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|int
name|page
parameter_list|)
block|{
return|return
operator|(
name|ENODEV
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|xboxfb_save_palette
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|u_char
modifier|*
name|palette
parameter_list|)
block|{
return|return
operator|(
name|ENODEV
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|xboxfb_load_palette
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|u_char
modifier|*
name|palette
parameter_list|)
block|{
return|return
operator|(
name|ENODEV
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|xboxfb_set_border
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|int
name|border
parameter_list|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|xboxfb_save_state
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|void
modifier|*
name|p
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
return|return
operator|(
name|ENODEV
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|xboxfb_load_state
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|void
modifier|*
name|p
parameter_list|)
block|{
return|return
operator|(
name|ENODEV
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|xboxfb_set_win_org
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|off_t
name|offset
parameter_list|)
block|{
return|return
operator|(
name|ENODEV
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|xboxfb_read_hw_cursor
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|int
modifier|*
name|col
parameter_list|,
name|int
modifier|*
name|row
parameter_list|)
block|{
operator|*
name|col
operator|=
literal|0
expr_stmt|;
operator|*
name|row
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|xboxfb_set_hw_cursor
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|int
name|col
parameter_list|,
name|int
name|row
parameter_list|)
block|{
return|return
operator|(
name|ENODEV
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|xboxfb_set_hw_cursor_shape
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|int
name|base
parameter_list|,
name|int
name|height
parameter_list|,
name|int
name|celsize
parameter_list|,
name|int
name|blink
parameter_list|)
block|{
return|return
operator|(
name|ENODEV
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|xboxfb_blank_display
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|xboxfb_mmap
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|vm_ooffset_t
name|offset
parameter_list|,
name|vm_paddr_t
modifier|*
name|paddr
parameter_list|,
name|int
name|prot
parameter_list|,
name|vm_memattr_t
modifier|*
name|memattr
parameter_list|)
block|{
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|xboxfb_ioctl
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|u_long
name|cmd
parameter_list|,
name|caddr_t
name|data
parameter_list|)
block|{
return|return
operator|(
name|fb_commonioctl
argument_list|(
name|adp
argument_list|,
name|cmd
argument_list|,
name|data
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|xboxfb_clear
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|xboxfb_fill_rect
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|int
name|val
parameter_list|,
name|int
name|x
parameter_list|,
name|int
name|y
parameter_list|,
name|int
name|cx
parameter_list|,
name|int
name|cy
parameter_list|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|xboxfb_bitblt
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
modifier|...
parameter_list|)
block|{
return|return
operator|(
name|ENODEV
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|xboxfb_diag
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|int
name|level
parameter_list|)
block|{
name|video_info_t
name|info
decl_stmt|;
name|fb_dump_adp_info
argument_list|(
name|adp
operator|->
name|va_name
argument_list|,
name|adp
argument_list|,
name|level
argument_list|)
expr_stmt|;
name|xboxfb_get_info
argument_list|(
name|adp
argument_list|,
literal|0
argument_list|,
operator|&
name|info
argument_list|)
expr_stmt|;
name|fb_dump_mode_info
argument_list|(
name|adp
operator|->
name|va_name
argument_list|,
name|adp
argument_list|,
operator|&
name|info
argument_list|,
name|level
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|xboxfb_save_cursor_palette
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|u_char
modifier|*
name|palette
parameter_list|)
block|{
return|return
operator|(
name|ENODEV
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|xboxfb_load_cursor_palette
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|u_char
modifier|*
name|palette
parameter_list|)
block|{
return|return
operator|(
name|ENODEV
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|xboxfb_copy
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|vm_offset_t
name|src
parameter_list|,
name|vm_offset_t
name|dst
parameter_list|,
name|int
name|n
parameter_list|)
block|{
return|return
operator|(
name|ENODEV
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|xboxfb_putp
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|vm_offset_t
name|off
parameter_list|,
name|u_int32_t
name|p
parameter_list|,
name|u_int32_t
name|a
parameter_list|,
name|int
name|size
parameter_list|,
name|int
name|bpp
parameter_list|,
name|int
name|bit_ltor
parameter_list|,
name|int
name|byte_ltor
parameter_list|)
block|{
return|return
operator|(
name|ENODEV
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|xboxfb_putc
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|vm_offset_t
name|off
parameter_list|,
name|u_int8_t
name|c
parameter_list|,
name|u_int8_t
name|a
parameter_list|)
block|{
name|int
name|row
decl_stmt|,
name|col
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|struct
name|xboxfb_softc
modifier|*
name|sc
init|=
operator|&
name|xboxfb_sc
decl_stmt|;
name|uint32_t
modifier|*
name|ptri
init|=
operator|(
name|uint32_t
operator|*
operator|)
name|sc
operator|->
name|sc_framebuffer
decl_stmt|;
specifier|const
name|uint8_t
modifier|*
name|fontdata
decl_stmt|;
name|uint32_t
name|clr
decl_stmt|;
name|uint8_t
name|mask
decl_stmt|;
comment|/* calculate the position in the frame buffer */
name|row
operator|=
operator|(
name|off
operator|/
name|adp
operator|->
name|va_info
operator|.
name|vi_width
operator|)
operator|*
name|adp
operator|->
name|va_info
operator|.
name|vi_cheight
expr_stmt|;
name|col
operator|=
operator|(
name|off
operator|%
name|adp
operator|->
name|va_info
operator|.
name|vi_width
operator|)
operator|*
name|adp
operator|->
name|va_info
operator|.
name|vi_cwidth
expr_stmt|;
name|fontdata
operator|=
operator|&
name|sc
operator|->
name|sc_font
operator|->
name|data
index|[
name|c
operator|*
name|adp
operator|->
name|va_info
operator|.
name|vi_cheight
index|]
expr_stmt|;
name|ptri
operator|+=
operator|(
name|row
operator|*
name|sc
operator|->
name|sc_width
operator|)
operator|+
name|col
expr_stmt|;
comment|/* Place the character on the screen, pixel by pixel */
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|adp
operator|->
name|va_info
operator|.
name|vi_cheight
condition|;
name|j
operator|++
control|)
block|{
name|mask
operator|=
literal|0x80
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|adp
operator|->
name|va_info
operator|.
name|vi_cwidth
condition|;
name|i
operator|++
control|)
block|{
name|clr
operator|=
operator|(
operator|*
name|fontdata
operator|&
name|mask
operator|)
condition|?
name|cmap
index|[
name|a
operator|&
literal|0xf
index|]
else|:
name|cmap
index|[
operator|(
name|a
operator|>>
literal|4
operator|)
operator|&
literal|0xf
index|]
expr_stmt|;
operator|*
name|ptri
operator|++
operator|=
name|clr
expr_stmt|;
name|mask
operator|>>=
literal|1
expr_stmt|;
block|}
name|ptri
operator|+=
operator|(
name|sc
operator|->
name|sc_width
operator|-
name|adp
operator|->
name|va_info
operator|.
name|vi_cwidth
operator|)
expr_stmt|;
name|fontdata
operator|++
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|xboxfb_puts
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|vm_offset_t
name|off
parameter_list|,
name|u_int16_t
modifier|*
name|s
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
block|{
name|vidd_putc
argument_list|(
name|adp
argument_list|,
name|off
operator|+
name|i
argument_list|,
name|s
index|[
name|i
index|]
operator|&
literal|0xff
argument_list|,
operator|(
name|s
index|[
name|i
index|]
operator|&
literal|0xff00
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|xboxfb_putm
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|int
name|x
parameter_list|,
name|int
name|y
parameter_list|,
name|u_int8_t
modifier|*
name|pixel_image
parameter_list|,
name|u_int32_t
name|pixel_mask
parameter_list|,
name|int
name|size
parameter_list|,
name|int
name|width
parameter_list|)
block|{
name|struct
name|xboxfb_softc
modifier|*
name|sc
init|=
operator|&
name|xboxfb_sc
decl_stmt|;
name|uint32_t
modifier|*
name|ptri
init|=
operator|(
name|uint32_t
operator|*
operator|)
name|sc
operator|->
name|sc_framebuffer
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
if|if
condition|(
name|x
operator|<
literal|0
operator|||
name|y
operator|<
literal|0
operator|||
name|x
operator|+
name|width
operator|>
name|sc
operator|->
name|sc_width
operator|||
name|y
operator|+
operator|(
literal|2
operator|*
name|size
operator|)
operator|>
name|sc
operator|->
name|sc_height
condition|)
return|return
literal|0
return|;
name|ptri
operator|+=
operator|(
name|y
operator|*
name|sc
operator|->
name|sc_width
operator|)
operator|+
name|x
expr_stmt|;
comment|/* plot the mousecursor wherever the user wants it */
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|size
condition|;
name|j
operator|++
control|)
block|{
for|for
control|(
name|i
operator|=
name|width
init|;
name|i
operator|>
literal|0
condition|;
name|i
operator|--
control|)
block|{
if|if
condition|(
name|pixel_image
index|[
name|j
index|]
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
condition|)
operator|*
name|ptri
operator|=
name|cmap
index|[
literal|0xf
index|]
expr_stmt|;
name|ptri
operator|++
expr_stmt|;
block|}
name|ptri
operator|+=
operator|(
name|sc
operator|->
name|sc_width
operator|-
name|width
operator|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


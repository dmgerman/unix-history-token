begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 1994 Mostyn Lewis  * All rights reserved.  *  * This software is based on code which is:  * Copyright (c) 1994  Mike Jagdis (jaggy@purplet.demon.co.uk)  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer  *    in this position and unchanged.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. The name of the author may not be used to endorse or promote products  *    derived from this software withough specific prior written permission  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/filedesc.h>
end_include

begin_include
include|#
directive|include
file|<sys/file.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/protosw.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/socketvar.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/exec.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<sys/syscall.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysent.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/un.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_arp.h>
end_include

begin_include
include|#
directive|include
file|<net/route.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm.h>
end_include

begin_include
include|#
directive|include
file|<i386/ibcs2/ibcs2.h>
end_include

begin_include
include|#
directive|include
file|<i386/ibcs2/ibcs2_socksys.h>
end_include

begin_comment
comment|/* Socksys pseudo driver entry points */
end_comment

begin_function_decl
name|int
name|sockopen
parameter_list|(
name|dev_t
name|dev
parameter_list|,
name|int
name|mode
parameter_list|,
name|int
name|devtype
parameter_list|,
name|struct
name|proc
modifier|*
name|p
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|sockioctl
parameter_list|(
name|dev_t
name|dev
parameter_list|,
name|int
name|cmd
parameter_list|,
name|caddr_t
name|arg
parameter_list|,
name|int
name|fflag
parameter_list|,
name|struct
name|proc
modifier|*
name|p
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|sockclose
parameter_list|(
name|dev_t
name|dev
parameter_list|,
name|int
name|flag
parameter_list|,
name|int
name|mode
parameter_list|,
name|struct
name|proc
modifier|*
name|p
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* Socksys internal functions */
end_comment

begin_function_decl
specifier|static
name|void
name|put_socket_fops
parameter_list|(
name|struct
name|proc
modifier|*
name|p
parameter_list|,
name|int
name|fd
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ss_fop_close
parameter_list|(
name|struct
name|file
modifier|*
name|fp
parameter_list|,
name|struct
name|proc
modifier|*
name|p
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ss_fop_ioctl
parameter_list|(
name|struct
name|file
modifier|*
name|fp
parameter_list|,
name|int
name|cmd
parameter_list|,
name|caddr_t
name|arg
parameter_list|,
name|struct
name|proc
modifier|*
name|p
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ss_syscall
parameter_list|(
name|caddr_t
name|arg
parameter_list|,
name|struct
name|proc
modifier|*
name|p
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  *	This structure is setup on first usage. Its address is planted  *	into a socket's file structure fileops pointer after a successful  *	socket creation or accept.  */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|fileops
name|ss_socket_fops
init|=
block|{
name|NULL
block|,
comment|/* normal socket read */
name|NULL
block|,
comment|/* normal socket write */
name|NULL
block|,
comment|/* socksys ioctl */
name|NULL
block|,
comment|/* normal socket select */
name|NULL
block|,
comment|/* socksys close */
block|}
decl_stmt|;
end_decl_stmt

begin_expr_stmt
specifier|static
name|int
argument_list|(
argument|*close_s
argument_list|)
name|__P
argument_list|(
operator|(
expr|struct
name|file
operator|*
name|fp
operator|,
expr|struct
name|proc
operator|*
name|p
operator|)
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|int
argument_list|(
argument|*ioctl_s
argument_list|)
name|__P
argument_list|(
operator|(
expr|struct
name|file
operator|*
name|fp
operator|,
name|int
name|cmd
operator|,
name|caddr_t
name|data
operator|,
expr|struct
name|proc
operator|*
name|p
operator|)
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|ss_debug
init|=
literal|10
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|ss_syscall
parameter_list|(
name|arg
parameter_list|,
name|p
parameter_list|)
name|caddr_t
name|arg
decl_stmt|;
name|struct
name|proc
modifier|*
name|p
decl_stmt|;
block|{
name|int
name|cmd
decl_stmt|;
name|int
name|error
decl_stmt|;
name|int
name|retval
index|[
literal|2
index|]
decl_stmt|;
name|retval
index|[
literal|0
index|]
operator|=
name|retval
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|cmd
operator|=
operator|(
operator|(
expr|struct
name|ss_call
operator|*
operator|)
name|arg
operator|)
operator|->
name|arg
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|ss_debug
condition|)
block|{
specifier|static
name|char
modifier|*
name|ss_syscall_strings
index|[]
init|=
block|{
literal|"0?"
block|,
literal|"accept"
block|,
literal|"bind"
block|,
literal|"connect"
block|,
literal|"getpeername"
block|,
literal|"getsockname"
block|,
literal|"getsockopt"
block|,
literal|"listen"
block|,
literal|"recv(from)"
block|,
literal|"recvfrom"
block|,
literal|"send(to)"
block|,
literal|"sendto"
block|,
literal|"setsockopt"
block|,
literal|"shutdown"
block|,
literal|"socket"
block|,
literal|"select"
block|,
literal|"getipdomain"
block|,
literal|"setipdomain"
block|,
literal|"adjtime"
block|,
literal|"setreuid"
block|,
literal|"setregid"
block|,
literal|"gettimeofday"
block|,
literal|"settimeofday"
block|,
literal|"getitimer"
block|,
literal|"setitimer"
block|, 	}
decl_stmt|;
name|printf
argument_list|(
literal|"ss_syscall: [%d] "
argument_list|,
name|p
operator|->
name|p_pid
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd
operator|<
literal|0
operator|||
operator|(
name|cmd
operator|>
name|CMD_SO_SETITIMER
operator|&&
name|cmd
operator|!=
name|CMD_SO_SS_DEBUG
operator|)
condition|)
name|printf
argument_list|(
literal|"? "
argument_list|)
expr_stmt|;
else|else
block|{
if|if
condition|(
name|cmd
operator|==
name|CMD_SO_SS_DEBUG
condition|)
name|printf
argument_list|(
literal|"%s "
argument_list|,
literal|"ss_debug"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%s "
argument_list|,
name|ss_syscall_strings
index|[
name|cmd
index|]
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"(%d)<0x%x,0x%x,0x%x,0x%x,0x%x,0x%x>\n"
argument_list|,
name|cmd
argument_list|,
operator|(
operator|(
expr|struct
name|ss_call
operator|*
operator|)
name|arg
operator|)
operator|->
name|arg
index|[
literal|1
index|]
argument_list|,
operator|(
operator|(
expr|struct
name|ss_call
operator|*
operator|)
name|arg
operator|)
operator|->
name|arg
index|[
literal|2
index|]
argument_list|,
operator|(
operator|(
expr|struct
name|ss_call
operator|*
operator|)
name|arg
operator|)
operator|->
name|arg
index|[
literal|3
index|]
argument_list|,
operator|(
operator|(
expr|struct
name|ss_call
operator|*
operator|)
name|arg
operator|)
operator|->
name|arg
index|[
literal|4
index|]
argument_list|,
operator|(
operator|(
expr|struct
name|ss_call
operator|*
operator|)
name|arg
operator|)
operator|->
name|arg
index|[
literal|5
index|]
argument_list|,
operator|(
operator|(
expr|struct
name|ss_call
operator|*
operator|)
name|arg
operator|)
operator|->
name|arg
index|[
literal|6
index|]
argument_list|)
expr_stmt|;
block|}
name|error
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|CMD_SO_SS_DEBUG
case|:
comment|/* ss_debug = ((struct ss_call *)arg)->arg[1]; */
break|break;
case|case
name|CMD_SO_SOCKET
case|:
block|{
comment|/* NO CONV */
if|if
condition|(
name|ss_debug
operator|>
literal|1
condition|)
name|printf
argument_list|(
literal|"SO_SOCKET af in %d\n"
argument_list|,
operator|(
operator|(
expr|struct
name|ss_call
operator|*
operator|)
name|arg
operator|)
operator|->
name|arg
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
operator|(
operator|(
expr|struct
name|ss_call
operator|*
operator|)
name|arg
operator|)
operator|->
name|arg
index|[
literal|1
index|]
operator|=
name|ss_convert
argument_list|(
name|af_whatevers
argument_list|,
operator|&
operator|(
operator|(
operator|(
expr|struct
name|ss_call
operator|*
operator|)
name|arg
operator|)
operator|->
name|arg
index|[
literal|1
index|]
operator|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ss_debug
operator|>
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"SO_SOCKET af out %d\n"
argument_list|,
operator|(
operator|(
expr|struct
name|ss_call
operator|*
operator|)
name|arg
operator|)
operator|->
name|arg
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"SO_SOCKET type in %d\n"
argument_list|,
operator|(
operator|(
expr|struct
name|ss_call
operator|*
operator|)
name|arg
operator|)
operator|->
name|arg
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
block|}
operator|(
operator|(
expr|struct
name|ss_call
operator|*
operator|)
name|arg
operator|)
operator|->
name|arg
index|[
literal|2
index|]
operator|=
name|ss_convert
argument_list|(
name|type_whatevers
argument_list|,
operator|&
operator|(
operator|(
operator|(
expr|struct
name|ss_call
operator|*
operator|)
name|arg
operator|)
operator|->
name|arg
index|[
literal|2
index|]
operator|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ss_debug
operator|>
literal|1
condition|)
name|printf
argument_list|(
literal|"SO_SOCKET type out %d\n"
argument_list|,
operator|(
operator|(
expr|struct
name|ss_call
operator|*
operator|)
name|arg
operator|)
operator|->
name|arg
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|SYSCALL
argument_list|(
name|SYS_socket
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ss_debug
condition|)
name|printf
argument_list|(
literal|"ss_syscall: [%d] socket fd=%d\n"
argument_list|,
name|p
operator|->
name|p_pid
argument_list|,
name|retval
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|put_socket_fops
argument_list|(
name|p
argument_list|,
name|retval
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|CMD_SO_ACCEPT
case|:
block|{
comment|/* CONVERSION in arg 2 */
name|SYSCALL
argument_list|(
name|SYS_accept
argument_list|,
literal|2
argument_list|,
name|SS_STRUCT_SOCKADDR
argument_list|)
expr_stmt|;
if|if
condition|(
name|ss_debug
condition|)
name|printf
argument_list|(
literal|"ss_syscall: [%d] accept fd=%d\n"
argument_list|,
name|p
operator|->
name|p_pid
argument_list|,
name|retval
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|put_socket_fops
argument_list|(
name|p
argument_list|,
name|retval
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|CMD_SO_BIND
case|:
name|SYSCALL
argument_list|(
name|SYS_bind
argument_list|,
literal|2
argument_list|,
name|SS_STRUCT_SOCKADDR
argument_list|)
expr_stmt|;
break|break;
case|case
name|CMD_SO_CONNECT
case|:
block|{
name|struct
name|alien_sockaddr
modifier|*
name|sa
decl_stmt|;
name|unsigned
name|short
name|family
decl_stmt|;
comment|/* Remap any INADDR_ANY (0.0.0.0) to localhost */
name|sa
operator|=
operator|(
expr|struct
name|alien_sockaddr
operator|*
operator|)
operator|(
operator|(
expr|struct
name|ss_call
operator|*
operator|)
name|arg
operator|)
operator|->
name|arg
index|[
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|error
operator|=
name|copyin
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
name|sa
operator|->
name|sa_family
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|family
argument_list|,
sizeof|sizeof
argument_list|(
name|short
argument_list|)
argument_list|)
condition|)
return|return
operator|(
name|error
operator|)
return|;
if|if
condition|(
name|family
operator|==
name|AF_INET
condition|)
block|{
name|unsigned
name|long
modifier|*
name|addr
decl_stmt|;
name|unsigned
name|long
name|saddr
decl_stmt|;
name|addr
operator|=
operator|&
operator|(
operator|(
operator|(
expr|struct
name|alien_sockaddr_in
operator|*
operator|)
name|sa
operator|)
operator|->
name|sin_addr
operator|.
name|s_addr
operator|)
expr_stmt|;
if|if
condition|(
name|error
operator|=
name|copyin
argument_list|(
operator|(
name|caddr_t
operator|)
name|addr
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|saddr
argument_list|,
sizeof|sizeof
argument_list|(
name|long
argument_list|)
argument_list|)
condition|)
return|return
operator|(
name|error
operator|)
return|;
if|if
condition|(
name|saddr
operator|==
name|INADDR_ANY
condition|)
block|{
comment|/* 0x0100007f is 127.0.0.1 reversed */
name|saddr
operator|=
literal|0x0100007f
expr_stmt|;
if|if
condition|(
name|error
operator|=
name|copyout
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
name|saddr
argument_list|,
operator|(
name|caddr_t
operator|)
name|addr
argument_list|,
sizeof|sizeof
argument_list|(
name|long
argument_list|)
argument_list|)
condition|)
return|return
operator|(
name|error
operator|)
return|;
if|if
condition|(
name|ss_debug
condition|)
name|printf
argument_list|(
literal|"ss_syscall: remapped INADDR_ANY to localhost\n"
argument_list|)
expr_stmt|;
block|}
block|}
name|SYSCALL
argument_list|(
name|SYS_connect
argument_list|,
literal|2
argument_list|,
name|SS_STRUCT_SOCKADDR
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|CMD_SO_GETPEERNAME
case|:
name|SYSCALL
argument_list|(
name|SYS_getpeername
argument_list|,
literal|2
argument_list|,
name|SS_STRUCT_SOCKADDR
argument_list|)
expr_stmt|;
break|break;
case|case
name|CMD_SO_GETSOCKNAME
case|:
name|SYSCALL
argument_list|(
name|SYS_getsockname
argument_list|,
literal|2
argument_list|,
name|SS_STRUCT_SOCKADDR
argument_list|)
expr_stmt|;
break|break;
case|case
name|CMD_SO_GETSOCKOPT
case|:
if|if
condition|(
name|error
operator|=
name|ss_getsockopt
argument_list|(
call|(
name|caddr_t
call|)
argument_list|(
operator|(
operator|(
name|int
operator|*
operator|)
name|arg
operator|)
operator|+
literal|1
argument_list|)
argument_list|,
name|retval
argument_list|,
name|p
argument_list|)
condition|)
return|return
operator|(
name|error
operator|)
return|;
break|break;
case|case
name|CMD_SO_LISTEN
case|:
name|SYSCALL
argument_list|(
name|SYS_listen
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|CMD_SO_RECV
case|:
operator|(
operator|(
expr|struct
name|ss_call
operator|*
operator|)
name|arg
operator|)
operator|->
name|arg
index|[
literal|5
index|]
operator|=
call|(
name|int
call|)
argument_list|(
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
operator|(
operator|(
expr|struct
name|ss_call
operator|*
operator|)
name|arg
operator|)
operator|->
name|arg
index|[
literal|6
index|]
operator|=
literal|0
expr_stmt|;
name|SYSCALL
argument_list|(
name|SYS_recvfrom
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|CMD_SO_RECVFROM
case|:
name|SYSCALL
argument_list|(
name|SYS_recvfrom
argument_list|,
literal|5
argument_list|,
name|SS_STRUCT_SOCKADDR
argument_list|)
expr_stmt|;
break|break;
case|case
name|CMD_SO_SEND
case|:
operator|(
operator|(
expr|struct
name|ss_call
operator|*
operator|)
name|arg
operator|)
operator|->
name|arg
index|[
literal|5
index|]
operator|=
call|(
name|int
call|)
argument_list|(
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
operator|(
operator|(
expr|struct
name|ss_call
operator|*
operator|)
name|arg
operator|)
operator|->
name|arg
index|[
literal|6
index|]
operator|=
literal|0
expr_stmt|;
name|SYSCALL
argument_list|(
name|SYS_sendto
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|CMD_SO_SENDTO
case|:
name|SYSCALL
argument_list|(
name|SYS_sendto
argument_list|,
literal|5
argument_list|,
name|SS_STRUCT_SOCKADDR
argument_list|)
expr_stmt|;
break|break;
case|case
name|CMD_SO_SETSOCKOPT
case|:
if|if
condition|(
name|error
operator|=
name|ss_setsockopt
argument_list|(
call|(
name|caddr_t
call|)
argument_list|(
operator|(
operator|(
name|int
operator|*
operator|)
name|arg
operator|)
operator|+
literal|1
argument_list|)
argument_list|,
name|retval
argument_list|,
name|p
argument_list|)
condition|)
return|return
operator|(
name|error
operator|)
return|;
case|case
name|CMD_SO_SHUTDOWN
case|:
name|SYSCALL
argument_list|(
name|SYS_shutdown
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|CMD_SO_GETIPDOMAIN
case|:
name|SYSCALL
argument_list|(
name|SYS_getdomainname
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|CMD_SO_SETIPDOMAIN
case|:
comment|/* Note check on BSD utsname no change? */
name|SYSCALL
argument_list|(
name|SYS_setdomainname
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|CMD_SO_SETREUID
case|:
name|SYSCALL
argument_list|(
literal|126
comment|/*SYS_setreuid*/
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|CMD_SO_SETREGID
case|:
name|SYSCALL
argument_list|(
literal|127
comment|/*SYS_setregid*/
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|CMD_SO_GETTIME
case|:
name|SYSCALL
argument_list|(
name|SYS_gettimeofday
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|CMD_SO_SETTIME
case|:
name|SYSCALL
argument_list|(
name|SYS_settimeofday
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|CMD_SO_GETITIMER
case|:
name|SYSCALL
argument_list|(
name|SYS_getitimer
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|CMD_SO_SETITIMER
case|:
name|SYSCALL
argument_list|(
name|SYS_setitimer
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|CMD_SO_SELECT
case|:
name|SYSCALL
argument_list|(
name|SYS_select
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|CMD_SO_ADJTIME
case|:
name|SYSCALL
argument_list|(
name|SYS_adjtime
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"ss_syscall: default 0x%x\n"
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
name|IBCS2_MAGIC_RETURN
argument_list|(
name|arg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|ss_fop_ioctl
parameter_list|(
name|fp
parameter_list|,
name|cmd
parameter_list|,
name|arg
parameter_list|,
name|p
parameter_list|)
name|struct
name|file
modifier|*
name|fp
decl_stmt|;
name|int
name|cmd
decl_stmt|;
name|caddr_t
name|arg
decl_stmt|;
name|struct
name|proc
modifier|*
name|p
decl_stmt|;
block|{
name|int
name|error
decl_stmt|;
name|int
name|retval
index|[
literal|2
index|]
decl_stmt|;
if|if
condition|(
name|ss_debug
condition|)
block|{
specifier|static
name|char
modifier|*
modifier|*
name|ioctl_strings
decl_stmt|;
name|int
name|fd
decl_stmt|;
name|struct
name|filedesc
modifier|*
name|fdp
decl_stmt|;
name|unsigned
name|int
name|ioctl_type
decl_stmt|;
name|unsigned
name|int
name|ioctl_len
decl_stmt|;
name|char
name|cmd_type
decl_stmt|;
name|int
name|cmd_ordinal
decl_stmt|;
specifier|static
name|char
modifier|*
name|ioctl_type_strings
index|[]
init|=
block|{
literal|"0?"
block|,
literal|"SS_IO"
block|,
literal|"SS_IOR"
block|,
literal|"3?"
block|,
literal|"SS_IOW"
block|,
literal|"5?"
block|,
literal|"SS_IOWR"
block|}
decl_stmt|;
specifier|static
name|char
modifier|*
name|ioctl_S_strings
index|[]
init|=
block|{
literal|"0?"
block|,
literal|"SIOCSHIWAT"
block|,
literal|"SIOCGHIWAT"
block|,
literal|"SIOCSLOWAT"
block|,
literal|"SIOCGLOWAT"
block|,
literal|"SIOCATMARK"
block|,
literal|"SIOCSPGRP"
block|,
literal|"SIOCGPGRP"
block|,
literal|"FIONREAD"
block|,
literal|"FIONBIO"
block|,
literal|"FIOASYNC"
block|,
literal|"SIOCPROTO"
block|,
literal|"SIOCGETNAME"
block|,
literal|"SIOCGETPEER"
block|,
literal|"IF_UNITSEL"
block|,
literal|"SIOCXPROTO"
block|}
decl_stmt|;
specifier|static
name|char
modifier|*
name|ioctl_R_strings
index|[]
init|=
block|{
literal|"0?"
block|,
literal|"1?"
block|,
literal|"2?"
block|,
literal|"3?"
block|,
literal|"4?"
block|,
literal|"5?"
block|,
literal|"6?"
block|,
literal|"7?"
block|,
literal|"8?"
block|,
literal|"SIOCADDRT"
block|,
literal|"SIOCDELRT"
block|}
decl_stmt|;
specifier|static
name|char
modifier|*
name|ioctl_I_strings
index|[]
init|=
block|{
literal|"0?"
block|,
literal|"1?"
block|,
literal|"2?"
block|,
literal|"3?"
block|,
literal|"4?"
block|,
literal|"5?"
block|,
literal|"6?"
block|,
literal|"7?"
block|,
literal|"8?"
block|,
literal|"9?"
block|,
literal|"10?"
block|,
literal|"SIOCSIFADDR"
block|,
literal|"SIOCGIFADDR"
block|,
literal|"SIOCSIFDSTADDR"
block|,
literal|"SIOCGIFDSTADDR"
block|,
literal|"SIOCSIFFLAGS"
block|,
literal|"SIOCGIFFLAGS"
block|,
literal|"SIOCGIFCONF"
block|,
literal|"18?"
block|,
literal|"19?"
block|,
literal|"20?"
block|,
literal|"SIOCSIFMTU"
block|,
literal|"SIOCGIFMTU"
block|,
literal|"23?"
block|,
literal|"24?"
block|,
literal|"25?"
block|,
literal|"SIOCIFDETACH"
block|,
literal|"SIOCGENPSTATS"
block|,
literal|"28?"
block|,
literal|"SIOCX25XMT"
block|,
literal|"SS_SIOCX25RCV"
block|,
literal|"SS_SIOCX25TBL"
block|,
literal|"SIOCGIFBRDADDR"
block|,
literal|"SIOCSIFBRDADDR"
block|,
literal|"SIOCGIFNETMASK"
block|,
literal|"SIOCSIFNETMASK"
block|,
literal|"SIOCGIFMETRIC"
block|,
literal|"SIOCSIFMETRIC"
block|,
literal|"SIOCSARP"
block|,
literal|"SIOCGARP"
block|,
literal|"SIOCDARP"
block|,
literal|"SIOCSIFNAME"
block|,
literal|"SIOCGIFONEP"
block|,
literal|"SIOCSIFONEP "
block|,
literal|"44?"
block|,
literal|"45?"
block|,
literal|"46?"
block|,
literal|"47?"
block|,
literal|"48?"
block|,
literal|"49?"
block|,
literal|"50?"
block|,
literal|"51?"
block|,
literal|"52?"
block|,
literal|"53?"
block|,
literal|"54?"
block|,
literal|"55?"
block|,
literal|"56?"
block|,
literal|"57?"
block|,
literal|"58?"
block|,
literal|"59?"
block|,
literal|"60?"
block|,
literal|"61?"
block|,
literal|"62?"
block|,
literal|"63?"
block|,
literal|"64?"
block|,
literal|"SIOCGENADDR"
block|,
literal|"SIOCSOCKSYS"
block|}
decl_stmt|;
name|cmd_type
operator|=
operator|(
name|cmd
operator|>>
literal|8
operator|)
operator|&
literal|0xff
expr_stmt|;
name|cmd_ordinal
operator|=
name|cmd
operator|&
literal|0xff
expr_stmt|;
switch|switch
condition|(
name|cmd_type
condition|)
block|{
case|case
literal|'S'
case|:
name|ioctl_strings
operator|=
name|ioctl_S_strings
expr_stmt|;
if|if
condition|(
name|cmd_ordinal
operator|>
literal|15
condition|)
name|cmd_ordinal
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
case|case
literal|'R'
case|:
name|ioctl_strings
operator|=
name|ioctl_R_strings
expr_stmt|;
if|if
condition|(
name|cmd_ordinal
operator|>
literal|10
condition|)
name|cmd_ordinal
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
case|case
literal|'I'
case|:
name|ioctl_strings
operator|=
name|ioctl_I_strings
expr_stmt|;
if|if
condition|(
name|cmd_ordinal
operator|>
literal|66
condition|)
name|cmd_ordinal
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
default|default:
name|cmd_type
operator|=
literal|'?'
expr_stmt|;
break|break;
block|}
name|fdp
operator|=
name|p
operator|->
name|p_fd
expr_stmt|;
name|fd
operator|=
operator|-
literal|1
expr_stmt|;
while|while
condition|(
operator|++
name|fd
operator|<
name|NOFILE
condition|)
if|if
condition|(
name|fp
operator|==
name|fdp
operator|->
name|fd_ofiles
index|[
name|fd
index|]
condition|)
break|break;
name|ioctl_type
operator|=
operator|(
literal|0xe0000000
operator|&
name|cmd
operator|)
operator|>>
literal|29
expr_stmt|;
name|ioctl_len
operator|=
operator|(
name|cmd
operator|>>
literal|16
operator|)
operator|&
name|SS_IOCPARM_MASK
expr_stmt|;
name|printf
argument_list|(
literal|"ss_fop_ioctl: [%d] fd=%d "
argument_list|,
name|p
operator|->
name|p_pid
argument_list|,
name|fd
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd_type
operator|!=
literal|'?'
condition|)
block|{
if|if
condition|(
name|cmd_ordinal
operator|!=
operator|-
literal|1
condition|)
name|printf
argument_list|(
literal|"%s %s('%c',%d,l=%d) "
argument_list|,
name|ioctl_strings
index|[
name|cmd_ordinal
index|]
argument_list|,
name|ioctl_type_strings
index|[
name|ioctl_type
index|]
argument_list|,
name|cmd_type
argument_list|,
name|cmd_ordinal
argument_list|,
name|ioctl_len
argument_list|)
expr_stmt|;
else|else
block|{
name|cmd_ordinal
operator|=
name|cmd
operator|&
literal|0xff
expr_stmt|;
name|printf
argument_list|(
literal|"[unknown ordinal %d] %s('%c',%d,l=%d) "
argument_list|,
name|cmd_ordinal
argument_list|,
name|ioctl_type_strings
index|[
name|ioctl_type
index|]
argument_list|,
name|cmd_type
argument_list|,
name|cmd_ordinal
argument_list|,
name|ioctl_len
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|printf
argument_list|(
literal|"? %s('%c',%d,l=%d) "
argument_list|,
name|ioctl_type_strings
index|[
name|ioctl_type
index|]
argument_list|,
name|cmd_type
argument_list|,
name|cmd_ordinal
argument_list|,
name|ioctl_len
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"0x%x (0x%x)<0x%x>\n"
argument_list|,
name|fp
argument_list|,
name|cmd
argument_list|,
name|arg
argument_list|)
expr_stmt|;
block|}
comment|/* No dogs allowed */
if|if
condition|(
operator|*
operator|(
operator|(
operator|(
name|int
operator|*
operator|)
name|arg
operator|)
operator|-
literal|3
operator|)
operator|!=
name|IBCS2_MAGIC_IN
condition|)
block|{
name|printf
argument_list|(
literal|"ss_fop_ioctl: bad magic (sys_generic.c has no socksys mods?)\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
if|if
condition|(
name|fp
operator|->
name|f_type
operator|!=
name|DTYPE_SOCKET
condition|)
return|return
operator|(
name|ENOTSOCK
operator|)
return|;
name|retval
index|[
literal|0
index|]
operator|=
name|retval
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|SS_SIOCSOCKSYS
case|:
comment|/* ss syscall */
return|return
name|ss_syscall
argument_list|(
name|arg
argument_list|,
name|p
argument_list|)
return|;
case|case
name|SS_SIOCSHIWAT
case|:
comment|/* set high watermark */
case|case
name|SS_SIOCSLOWAT
case|:
comment|/* set low watermark */
break|break;
comment|/* return value of 0 and no error */
case|case
name|SS_SIOCGHIWAT
case|:
comment|/* get high watermark */
case|case
name|SS_SIOCGLOWAT
case|:
comment|/* get low watermark */
break|break;
comment|/* return value of 0 and no error */
case|case
name|SS_SIOCATMARK
case|:
comment|/* at oob mark */
name|IOCTL
argument_list|(
name|SIOCATMARK
argument_list|)
expr_stmt|;
break|break;
case|case
name|SS_SIOCSPGRP
case|:
comment|/* set process group */
name|IOCTL
argument_list|(
name|SIOCSPGRP
argument_list|)
expr_stmt|;
break|break;
case|case
name|SS_SIOCGPGRP
case|:
comment|/* get process group */
name|IOCTL
argument_list|(
name|SIOCGPGRP
argument_list|)
expr_stmt|;
break|break;
case|case
name|FIONREAD
case|:
case|case
name|SS_FIONREAD
case|:
comment|/* get # bytes to read */
name|IOCTL
argument_list|(
name|FIONREAD
argument_list|)
expr_stmt|;
break|break;
case|case
name|SS_FIONBIO
case|:
comment|/* set/clear non-blocking i/o */
name|IOCTL
argument_list|(
name|FIONBIO
argument_list|)
expr_stmt|;
break|break;
case|case
name|SS_FIOASYNC
case|:
comment|/* set/clear async i/o */
name|IOCTL
argument_list|(
name|FIOASYNC
argument_list|)
expr_stmt|;
break|break;
case|case
name|SS_SIOCADDRT
case|:
comment|/* add route - uses struct ortentry */
name|IOCTL
argument_list|(
name|SIOCADDRT
argument_list|)
expr_stmt|;
break|break;
case|case
name|SS_SIOCDELRT
case|:
comment|/* delete route - uses struct ortentry */
name|IOCTL
argument_list|(
name|SIOCDELRT
argument_list|)
expr_stmt|;
break|break;
case|case
name|SS_SIOCSIFADDR
case|:
comment|/* set ifnet address */
name|IOCTL
argument_list|(
name|SIOCSIFADDR
argument_list|)
expr_stmt|;
break|break;
case|case
name|SS_SIOCGIFADDR
case|:
comment|/* get ifnet address */
name|IOCTL
argument_list|(
name|SIOCGIFADDR
argument_list|)
expr_stmt|;
break|break;
case|case
name|SS_SIOCSIFDSTADDR
case|:
comment|/* set p-p address */
name|IOCTL
argument_list|(
name|SIOCSIFDSTADDR
argument_list|)
expr_stmt|;
break|break;
case|case
name|SS_SIOCGIFDSTADDR
case|:
comment|/* get p-p address */
name|IOCTL
argument_list|(
name|SIOCGIFDSTADDR
argument_list|)
expr_stmt|;
break|break;
case|case
name|SS_SIOCSIFFLAGS
case|:
comment|/* set ifnet flags */
name|IOCTL
argument_list|(
name|SIOCSIFFLAGS
argument_list|)
expr_stmt|;
break|break;
case|case
name|SS_SIOCGIFFLAGS
case|:
comment|/* get ifnet flags */
name|IOCTL
argument_list|(
name|SIOCGIFFLAGS
argument_list|)
expr_stmt|;
break|break;
case|case
name|SS_SIOCGIFCONF
case|:
comment|/* get ifnet ltst */
name|IOCTL
argument_list|(
name|SIOCGIFCONF
argument_list|)
expr_stmt|;
break|break;
case|case
name|SS_SIOCGIFBRDADDR
case|:
comment|/* get broadcast addr */
name|IOCTL
argument_list|(
name|SIOCGIFBRDADDR
argument_list|)
expr_stmt|;
break|break;
case|case
name|SS_SIOCSIFBRDADDR
case|:
comment|/* set broadcast addr */
name|IOCTL
argument_list|(
name|SIOCSIFBRDADDR
argument_list|)
expr_stmt|;
break|break;
case|case
name|SS_SIOCGIFNETMASK
case|:
comment|/* get net addr mask */
name|IOCTL
argument_list|(
name|SIOCGIFNETMASK
argument_list|)
expr_stmt|;
break|break;
case|case
name|SS_SIOCSIFNETMASK
case|:
comment|/* set net addr mask */
name|IOCTL
argument_list|(
name|SIOCSIFNETMASK
argument_list|)
expr_stmt|;
break|break;
case|case
name|SS_SIOCGIFMETRIC
case|:
comment|/* get IF metric */
name|IOCTL
argument_list|(
name|SIOCGIFMETRIC
argument_list|)
expr_stmt|;
break|break;
case|case
name|SS_SIOCSIFMETRIC
case|:
comment|/* set IF metric */
name|IOCTL
argument_list|(
name|SIOCSIFMETRIC
argument_list|)
expr_stmt|;
break|break;
comment|/*		FreeBSD 2.0 does not have socket ARPs */
ifdef|#
directive|ifdef
name|SIOCSARP
case|case
name|SS_SIOCSARP
case|:
comment|/* set arp entry */
name|IOCTL
argument_list|(
name|SIOCSARP
argument_list|)
expr_stmt|;
break|break;
case|case
name|SS_SIOCGARP
case|:
comment|/* get arp entry */
name|IOCTL
argument_list|(
name|SIOCGARP
argument_list|)
expr_stmt|;
break|break;
case|case
name|SS_SIOCDARP
case|:
comment|/* delete arp entry */
name|IOCTL
argument_list|(
name|SIOCDARP
argument_list|)
expr_stmt|;
break|break;
else|#
directive|else
comment|/* SIOCSARP */
case|case
name|SS_SIOCSARP
case|:
comment|/* set arp entry */
return|return
operator|(
name|EINVAL
operator|)
return|;
case|case
name|SS_SIOCGARP
case|:
comment|/* get arp entry */
return|return
operator|(
name|EINVAL
operator|)
return|;
case|case
name|SS_SIOCDARP
case|:
comment|/* delete arp entry */
return|return
operator|(
name|EINVAL
operator|)
return|;
endif|#
directive|endif
comment|/* SIOCSARP */
case|case
name|SS_SIOCGENADDR
case|:
comment|/* Get ethernet addr XXX */
return|return
operator|(
name|EINVAL
operator|)
return|;
comment|/*		return (error = ioctl_s(fp, SIOCGIFHWADDR, arg, p)); */
case|case
name|SS_SIOCSIFMTU
case|:
comment|/* get if_mtu */
name|IOCTL
argument_list|(
name|SIOCSIFMTU
argument_list|)
expr_stmt|;
break|break;
case|case
name|SS_SIOCGIFMTU
case|:
comment|/* set if_mtu */
name|IOCTL
argument_list|(
name|SIOCGIFMTU
argument_list|)
expr_stmt|;
break|break;
case|case
name|SS_SIOCGETNAME
case|:
comment|/* getsockname XXX */
return|return
operator|(
name|EINVAL
operator|)
return|;
comment|/*		return (ioctl_s(fp, SIOCGIFNAME, arg, p)); MMM */
case|case
name|SS_SIOCGETPEER
case|:
block|{
comment|/* getpeername */
struct|struct
name|moose
block|{
name|int
name|fd
decl_stmt|;
name|caddr_t
name|asa
decl_stmt|;
name|int
modifier|*
name|alen
decl_stmt|;
name|int
name|compat_43
decl_stmt|;
block|}
name|args
struct|;
name|struct
name|alien_sockaddr
name|uaddr
decl_stmt|;
name|struct
name|sockaddr
name|nuaddr
decl_stmt|;
name|int
name|nuaddr_len
init|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr
argument_list|)
decl_stmt|;
name|struct
name|filedesc
modifier|*
name|fdp
decl_stmt|;
if|if
condition|(
name|fp
operator|->
name|f_type
operator|!=
name|DTYPE_SOCKET
condition|)
return|return
operator|(
name|ENOTSOCK
operator|)
return|;
name|bzero
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
name|nuaddr
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr
argument_list|)
argument_list|)
expr_stmt|;
name|fdp
operator|=
name|p
operator|->
name|p_fd
expr_stmt|;
name|args
operator|.
name|fd
operator|=
operator|-
literal|1
expr_stmt|;
while|while
condition|(
operator|++
name|args
operator|.
name|fd
operator|<
name|NOFILE
condition|)
if|if
condition|(
name|fp
operator|==
name|fdp
operator|->
name|fd_ofiles
index|[
name|args
operator|.
name|fd
index|]
condition|)
break|break;
if|if
condition|(
name|args
operator|.
name|fd
operator|==
name|NOFILE
condition|)
block|{
name|printf
argument_list|(
literal|"ss_fop_ioctl: [%d] SS_SIOCGETPEER args.fd> NOFILE\n"
argument_list|,
name|p
operator|->
name|p_pid
argument_list|)
expr_stmt|;
return|return
operator|(
name|EBADF
operator|)
return|;
block|}
name|args
operator|.
name|asa
operator|=
operator|(
name|caddr_t
operator|)
operator|&
name|nuaddr
expr_stmt|;
name|args
operator|.
name|alen
operator|=
operator|&
name|nuaddr_len
expr_stmt|;
name|args
operator|.
name|compat_43
operator|=
literal|0
expr_stmt|;
name|error
operator|=
name|SYSCALLX
argument_list|(
name|SYS_getpeername
argument_list|,
operator|&
name|args
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|bzero
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
name|uaddr
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|alien_sockaddr
argument_list|)
argument_list|)
expr_stmt|;
name|uaddr
operator|.
name|sa_family
operator|=
operator|(
name|unsigned
name|short
operator|)
name|nuaddr
operator|.
name|sa_family
expr_stmt|;
name|bcopy
argument_list|(
operator|&
name|nuaddr
operator|.
name|sa_data
argument_list|,
operator|&
name|uaddr
operator|.
name|sa_data
argument_list|,
name|__ALIEN_SOCK_SIZE__
operator|-
expr|sizeof
operator|(
name|unsigned
name|short
operator|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|copyout
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
name|uaddr
argument_list|,
operator|(
name|caddr_t
operator|)
name|arg
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|alien_sockaddr
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
default|default:
name|printf
argument_list|(
literal|"ss_fop_ioctl: [%d] %lx unknown ioctl 0x%x, 0x%lx\n"
argument_list|,
name|p
operator|->
name|p_pid
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|fp
argument_list|,
name|cmd
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|arg
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
name|IBCS2_MAGIC_RETURN
argument_list|(
name|arg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|sockioctl
parameter_list|(
name|dev
parameter_list|,
name|cmd
parameter_list|,
name|arg
parameter_list|,
name|fflag
parameter_list|,
name|p
parameter_list|)
name|dev_t
name|dev
decl_stmt|;
name|int
name|cmd
decl_stmt|;
name|caddr_t
name|arg
decl_stmt|;
name|int
name|fflag
decl_stmt|;
name|struct
name|proc
modifier|*
name|p
decl_stmt|;
block|{
name|int
name|error
decl_stmt|;
name|int
name|retval
index|[
literal|2
index|]
decl_stmt|;
if|if
condition|(
name|ss_debug
condition|)
block|{
name|char
name|cmd_type
decl_stmt|;
name|int
name|cmd_ordinal
decl_stmt|;
specifier|static
name|char
modifier|*
modifier|*
name|ioctl_strings
decl_stmt|;
name|unsigned
name|int
name|ioctl_type
decl_stmt|;
name|unsigned
name|int
name|ioctl_len
decl_stmt|;
specifier|static
name|char
modifier|*
name|ioctl_type_strings
index|[]
init|=
block|{
literal|"NIOCxx"
block|,
literal|"SS_IO"
block|,
literal|"SS_IOR"
block|,
literal|"3?"
block|,
literal|"SS_IOW"
block|,
literal|"5?"
block|,
literal|"SS_IOWR"
block|}
decl_stmt|;
specifier|static
name|char
modifier|*
name|ioctl_S_strings
index|[]
init|=
block|{
literal|"0?"
block|,
literal|"SIOCSHIWAT"
block|,
literal|"SIOCGHIWAT"
block|,
literal|"SIOCSLOWAT"
block|,
literal|"SIOCGLOWAT"
block|,
literal|"SIOCATMARK"
block|,
literal|"SIOCSPGRP"
block|,
literal|"SIOCGPGRP"
block|,
literal|"FIONREAD"
block|,
literal|"FIONBIO"
block|,
literal|"FIOASYNC"
block|,
literal|"SIOCPROTO"
block|,
literal|"SIOCGETNAME"
block|,
literal|"SIOCGETPEER"
block|,
literal|"IF_UNITSEL"
block|,
literal|"SIOCXPROTO"
block|}
decl_stmt|;
specifier|static
name|char
modifier|*
name|ioctl_R_strings
index|[]
init|=
block|{
literal|"0?"
block|,
literal|"1?"
block|,
literal|"2?"
block|,
literal|"3?"
block|,
literal|"4?"
block|,
literal|"5?"
block|,
literal|"6?"
block|,
literal|"7?"
block|,
literal|"8?"
block|,
literal|"SIOCADDRT"
block|,
literal|"SIOCDELRT"
block|}
decl_stmt|;
specifier|static
name|char
modifier|*
name|ioctl_I_strings
index|[]
init|=
block|{
literal|"0?"
block|,
literal|"1?"
block|,
literal|"2?"
block|,
literal|"3?"
block|,
literal|"4?"
block|,
literal|"5?"
block|,
literal|"6?"
block|,
literal|"7?"
block|,
literal|"8?"
block|,
literal|"9?"
block|,
literal|"10?"
block|,
literal|"SIOCSIFADDR"
block|,
literal|"SIOCGIFADDR"
block|,
literal|"SIOCSIFDSTADDR"
block|,
literal|"SIOCGIFDSTADDR"
block|,
literal|"SIOCSIFFLAGS"
block|,
literal|"SIOCGIFFLAGS"
block|,
literal|"SIOCGIFCONF"
block|,
literal|"18?"
block|,
literal|"19?"
block|,
literal|"20?"
block|,
literal|"SIOCSIFMTU"
block|,
literal|"SIOCGIFMTU"
block|,
literal|"23?"
block|,
literal|"24?"
block|,
literal|"25?"
block|,
literal|"SIOCIFDETACH"
block|,
literal|"SIOCGENPSTATS"
block|,
literal|"28?"
block|,
literal|"SIOCX25XMT"
block|,
literal|"SS_SIOCX25RCV"
block|,
literal|"SS_SIOCX25TBL"
block|,
literal|"SIOCGIFBRDADDR"
block|,
literal|"SIOCSIFBRDADDR"
block|,
literal|"SIOCGIFNETMASK"
block|,
literal|"SIOCSIFNETMASK"
block|,
literal|"SIOCGIFMETRIC"
block|,
literal|"SIOCSIFMETRIC"
block|,
literal|"SIOCSARP"
block|,
literal|"SIOCGARP"
block|,
literal|"SIOCDARP"
block|,
literal|"SIOCSIFNAME"
block|,
literal|"SIOCGIFONEP"
block|,
literal|"SIOCSIFONEP "
block|,
literal|"44?"
block|,
literal|"45?"
block|,
literal|"46?"
block|,
literal|"47?"
block|,
literal|"48?"
block|,
literal|"49?"
block|,
literal|"50?"
block|,
literal|"51?"
block|,
literal|"52?"
block|,
literal|"53?"
block|,
literal|"54?"
block|,
literal|"55?"
block|,
literal|"56?"
block|,
literal|"57?"
block|,
literal|"58?"
block|,
literal|"59?"
block|,
literal|"60?"
block|,
literal|"61?"
block|,
literal|"62?"
block|,
literal|"63?"
block|,
literal|"64?"
block|,
literal|"SIOCGENADDR"
block|,
literal|"SIOCSOCKSYS"
block|}
decl_stmt|;
specifier|static
name|char
modifier|*
name|ioctl_NIOC_strings
index|[]
init|=
block|{
literal|"0?"
block|,
literal|"NIOCNFSD"
block|,
literal|"NIOCOLDGETFH"
block|,
literal|"NIOCASYNCD"
block|,
literal|"NIOCSETDOMNAM"
block|,
literal|"NIOCGETDOMNAM"
block|,
literal|"NIOCCLNTHAND"
block|,
literal|"NIOCEXPORTFS"
block|,
literal|"NIOCGETFH"
block|,
literal|"NIOCLSTAT"
block|}
decl_stmt|;
name|cmd_ordinal
operator|=
name|cmd
operator|&
literal|0xff
expr_stmt|;
name|cmd_type
operator|=
operator|(
name|cmd
operator|>>
literal|8
operator|)
operator|&
literal|0xff
expr_stmt|;
switch|switch
condition|(
name|cmd_type
condition|)
block|{
case|case
literal|0
case|:
name|ioctl_strings
operator|=
name|ioctl_NIOC_strings
expr_stmt|;
name|cmd_type
operator|=
literal|' '
expr_stmt|;
if|if
condition|(
name|cmd_ordinal
operator|>
literal|9
condition|)
name|cmd_ordinal
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
case|case
literal|'S'
case|:
name|ioctl_strings
operator|=
name|ioctl_S_strings
expr_stmt|;
if|if
condition|(
name|cmd_ordinal
operator|>
literal|15
condition|)
name|cmd_ordinal
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
case|case
literal|'R'
case|:
name|ioctl_strings
operator|=
name|ioctl_R_strings
expr_stmt|;
if|if
condition|(
name|cmd_ordinal
operator|>
literal|10
condition|)
name|cmd_ordinal
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
case|case
literal|'I'
case|:
name|ioctl_strings
operator|=
name|ioctl_I_strings
expr_stmt|;
if|if
condition|(
name|cmd_ordinal
operator|>
literal|66
condition|)
name|cmd_ordinal
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
default|default:
name|cmd_type
operator|=
literal|'?'
expr_stmt|;
break|break;
block|}
name|ioctl_type
operator|=
operator|(
literal|0xe0000000
operator|&
name|cmd
operator|)
operator|>>
literal|29
expr_stmt|;
name|ioctl_len
operator|=
operator|(
name|cmd
operator|>>
literal|16
operator|)
operator|&
name|SS_IOCPARM_MASK
expr_stmt|;
name|printf
argument_list|(
literal|"sockioctl: [%d] "
argument_list|,
name|p
operator|->
name|p_pid
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd_type
operator|!=
literal|'?'
condition|)
block|{
if|if
condition|(
name|cmd_ordinal
operator|!=
operator|-
literal|1
condition|)
name|printf
argument_list|(
literal|"%s %s('%c',%d,l=%d) "
argument_list|,
name|ioctl_strings
index|[
name|cmd_ordinal
index|]
argument_list|,
name|ioctl_type_strings
index|[
name|ioctl_type
index|]
argument_list|,
name|cmd_type
argument_list|,
name|cmd_ordinal
argument_list|,
name|ioctl_len
argument_list|)
expr_stmt|;
else|else
block|{
name|cmd_ordinal
operator|=
name|cmd
operator|&
literal|0xff
expr_stmt|;
name|printf
argument_list|(
literal|"[unknown ordinal %d] %s('%c',%d,l=%d) "
argument_list|,
name|cmd_ordinal
argument_list|,
name|ioctl_type_strings
index|[
name|ioctl_type
index|]
argument_list|,
name|cmd_type
argument_list|,
name|cmd_ordinal
argument_list|,
name|ioctl_len
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|printf
argument_list|(
literal|"? %s('%c',%d,l=%d) "
argument_list|,
name|ioctl_type_strings
index|[
name|ioctl_type
index|]
argument_list|,
name|cmd_type
argument_list|,
name|cmd_ordinal
argument_list|,
name|ioctl_len
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"0x%x (0x%x)<0x%x>\n"
argument_list|,
name|dev
argument_list|,
name|cmd
argument_list|,
name|arg
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|*
operator|(
operator|(
operator|(
name|int
operator|*
operator|)
name|arg
operator|)
operator|-
literal|3
operator|)
operator|!=
name|IBCS2_MAGIC_IN
condition|)
block|{
name|printf
argument_list|(
literal|"sockioctl: bad magic (sys_generic.c has no socksys mods?)\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|SS_SIOCSOCKSYS
case|:
comment|/* ss syscall */
return|return
name|ss_syscall
argument_list|(
name|arg
argument_list|,
name|p
argument_list|)
return|;
comment|/* NIOCxx: These ioctls are really just integers 	 *	   (no other information to go on). 	 */
case|case
name|NIOCSETDOMNAM
case|:
block|{
name|struct
name|sgdomarg
name|domargs
decl_stmt|;
if|if
condition|(
name|error
operator|=
name|copyin
argument_list|(
operator|(
name|caddr_t
operator|)
operator|*
operator|(
operator|(
name|caddr_t
operator|*
operator|)
name|arg
operator|)
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|domargs
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sgdomarg
argument_list|)
argument_list|)
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|arg
operator|=
operator|(
name|caddr_t
operator|)
operator|&
name|domargs
expr_stmt|;
name|SYSCALL_N
argument_list|(
name|SYS_setdomainname
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|NIOCGETDOMNAM
case|:
block|{
name|struct
name|sgdomarg
name|domargs
decl_stmt|;
if|if
condition|(
name|error
operator|=
name|copyin
argument_list|(
operator|(
name|caddr_t
operator|)
operator|*
operator|(
operator|(
name|caddr_t
operator|*
operator|)
name|arg
operator|)
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|domargs
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sgdomarg
argument_list|)
argument_list|)
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|arg
operator|=
operator|(
name|caddr_t
operator|)
operator|&
name|domargs
expr_stmt|;
name|SYSCALL_N
argument_list|(
name|SYS_getdomainname
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|NIOCLSTAT
case|:
block|{
name|struct
name|lstatarg
name|st
decl_stmt|;
if|if
condition|(
name|error
operator|=
name|copyin
argument_list|(
operator|(
name|caddr_t
operator|)
operator|*
operator|(
operator|(
name|caddr_t
operator|*
operator|)
name|arg
operator|)
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|st
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|lstatarg
argument_list|)
argument_list|)
condition|)
return|return
operator|(
name|error
operator|)
return|;
comment|/* DO WE HAVE A FOREIGN LSTAT */
comment|/*		return mumbo_lstat(st.fname, st.statb); */
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
case|case
name|NIOCNFSD
case|:
case|case
name|NIOCOLDGETFH
case|:
case|case
name|NIOCASYNCD
case|:
case|case
name|NIOCCLNTHAND
case|:
case|case
name|NIOCEXPORTFS
case|:
case|case
name|NIOCGETFH
case|:
return|return
operator|(
name|EINVAL
operator|)
return|;
case|case
name|SS_IF_UNITSEL
case|:
comment|/* set unit number */
case|case
name|SS_SIOCXPROTO
case|:
comment|/* empty proto table */
case|case
name|SS_SIOCIFDETACH
case|:
comment|/* detach interface */
case|case
name|SS_SIOCGENPSTATS
case|:
comment|/* get ENP stats */
case|case
name|SS_SIOCSIFNAME
case|:
comment|/* set interface name */
case|case
name|SS_SIOCGIFONEP
case|:
comment|/* get one-packet params */
case|case
name|SS_SIOCSIFONEP
case|:
comment|/* set one-packet params */
case|case
name|SS_SIOCPROTO
case|:
comment|/* link proto */
case|case
name|SS_SIOCX25XMT
case|:
case|case
name|SS_SIOCX25RCV
case|:
case|case
name|SS_SIOCX25TBL
case|:
name|printf
argument_list|(
literal|"sockioctl: [%d] unsupported ioctl 0x%x , 0x%lx\n"
argument_list|,
name|p
operator|->
name|p_pid
argument_list|,
name|cmd
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|arg
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
default|default:
name|printf
argument_list|(
literal|"sockioctl: [%d] unknown ioctl 0x%x , 0x%lx\n"
argument_list|,
name|p
operator|->
name|p_pid
argument_list|,
name|cmd
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|arg
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
name|IBCS2_MAGIC_RETURN
argument_list|(
name|arg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|sockopen
parameter_list|(
name|dev
parameter_list|,
name|mode
parameter_list|,
name|devtype
parameter_list|,
name|p
parameter_list|)
name|dev_t
name|dev
decl_stmt|;
name|int
name|mode
decl_stmt|;
name|int
name|devtype
decl_stmt|;
name|struct
name|proc
modifier|*
name|p
decl_stmt|;
block|{
if|if
condition|(
name|ss_debug
condition|)
name|printf
argument_list|(
literal|"sockopen: [%d] 0x%x\n"
argument_list|,
name|p
operator|->
name|p_pid
argument_list|,
name|dev
argument_list|)
expr_stmt|;
comment|/* minor = 0 is the socksys device itself. No special handling 	 *           will be needed as it is controlled by the application 	 *           via ioctls. 	 */
if|if
condition|(
name|minor
argument_list|(
name|dev
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|0
return|;
comment|/* minor = 1 is the spx device. This is the client side of a 	 *           streams pipe to the X server. Under SCO and friends 	 *           the library code messes around setting the connection 	 *           up itself. We do it ourselves - this means we don't 	 *           need to worry about the implementation of the server 	 *           side (/dev/X0R - which must exist but can be a link 	 *           to /dev/null) nor do we need to actually implement 	 *           getmsg/putmsg. 	 */
block|{
comment|/* SPX */
name|int
name|fd
decl_stmt|,
name|error
decl_stmt|,
name|args
index|[
literal|3
index|]
decl_stmt|;
name|int
name|retval
index|[
literal|2
index|]
decl_stmt|;
define|#
directive|define
name|SUN_LEN
parameter_list|(
name|su
parameter_list|)
define|\
value|(sizeof(*(su)) - sizeof((su)->sun_path) + strlen((su)->sun_path)) + 1
name|struct
name|sockaddr_un
modifier|*
name|Xaddr
init|=
operator|(
expr|struct
name|sockaddr_un
operator|*
operator|)
name|UA_ALLOC
argument_list|()
decl_stmt|;
name|retval
index|[
literal|0
index|]
operator|=
name|retval
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ss_debug
condition|)
name|printf
argument_list|(
literal|"sockopen: SPX: [%d] opening\n"
argument_list|,
name|p
operator|->
name|p_pid
argument_list|)
expr_stmt|;
comment|/* Grab a socket. */
if|if
condition|(
name|ss_debug
condition|)
name|printf
argument_list|(
literal|"sockopen: SPX: [%d] get a unix domain socket\n"
argument_list|,
name|p
operator|->
name|p_pid
argument_list|)
expr_stmt|;
name|args
index|[
literal|0
index|]
operator|=
name|AF_UNIX
expr_stmt|;
name|args
index|[
literal|1
index|]
operator|=
name|SOCK_STREAM
expr_stmt|;
name|args
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|error
operator|=
name|SYSCALLX
argument_list|(
name|SYS_socket
argument_list|,
name|args
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
name|fd
operator|=
name|retval
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|fd
operator|<
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"sockopen: SPX: [%d] unexpected fd of %d\n"
argument_list|,
name|p
operator|->
name|p_pid
argument_list|,
name|fd
argument_list|)
expr_stmt|;
return|return
operator|(
name|EOPNOTSUPP
operator|)
return|;
comment|/* MRL whatever */
block|}
comment|/* Connect the socket to X. */
if|if
condition|(
name|ss_debug
condition|)
name|printf
argument_list|(
literal|"sockopen: SPX: [%d] connect to /tmp/X11-unix/X0\n"
argument_list|,
name|p
operator|->
name|p_pid
argument_list|)
expr_stmt|;
name|args
index|[
literal|0
index|]
operator|=
name|fd
expr_stmt|;
name|Xaddr
operator|->
name|sun_family
operator|=
name|AF_UNIX
expr_stmt|;
name|copyout
argument_list|(
literal|"/tmp/.X11-unix/X0"
argument_list|,
name|Xaddr
operator|->
name|sun_path
argument_list|,
literal|18
argument_list|)
expr_stmt|;
name|Xaddr
operator|->
name|sun_len
operator|=
name|SUN_LEN
argument_list|(
name|Xaddr
argument_list|)
expr_stmt|;
name|args
index|[
literal|1
index|]
operator|=
operator|(
name|int
operator|)
name|Xaddr
expr_stmt|;
name|args
index|[
literal|2
index|]
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_un
argument_list|)
expr_stmt|;
name|error
operator|=
name|SYSCALLX
argument_list|(
name|SYS_connect
argument_list|,
name|args
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
operator|(
name|void
operator|)
name|SYSCALLX
argument_list|(
name|SYS_close
argument_list|,
operator|&
name|fd
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
name|put_socket_fops
argument_list|(
name|p
argument_list|,
name|fd
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* SPX */
block|}
end_function

begin_function
name|int
name|sockclose
parameter_list|(
name|dev
parameter_list|,
name|flag
parameter_list|,
name|mode
parameter_list|,
name|p
parameter_list|)
name|dev_t
name|dev
decl_stmt|;
name|int
name|flag
decl_stmt|;
name|int
name|mode
decl_stmt|;
name|struct
name|proc
modifier|*
name|p
decl_stmt|;
block|{
if|if
condition|(
name|ss_debug
condition|)
name|printf
argument_list|(
literal|"sockclose: [%d] 0x%x\n"
argument_list|,
name|p
operator|->
name|p_pid
argument_list|,
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ss_fop_close
parameter_list|(
name|struct
name|file
modifier|*
name|fp
parameter_list|,
name|struct
name|proc
modifier|*
name|p
parameter_list|)
block|{
name|int
name|fd
decl_stmt|;
name|struct
name|filedesc
modifier|*
name|fdp
decl_stmt|;
if|if
condition|(
name|ss_debug
condition|)
block|{
name|fdp
operator|=
name|p
operator|->
name|p_fd
expr_stmt|;
name|fd
operator|=
operator|-
literal|1
expr_stmt|;
while|while
condition|(
operator|++
name|fd
operator|<
name|NOFILE
condition|)
if|if
condition|(
name|fp
operator|==
name|fdp
operator|->
name|fd_ofiles
index|[
name|fd
index|]
condition|)
break|break;
name|printf
argument_list|(
literal|"ss_fop_close: [%d] fd=%d "
argument_list|,
name|p
operator|->
name|p_pid
argument_list|,
name|fd
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|f_type
operator|==
name|DTYPE_SOCKET
condition|)
block|{
if|if
condition|(
name|ss_debug
condition|)
name|printf
argument_list|(
literal|"is a socket\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|close_s
argument_list|(
name|fp
argument_list|,
name|p
argument_list|)
operator|)
return|;
block|}
else|else
block|{
if|if
condition|(
name|ss_debug
condition|)
name|printf
argument_list|(
literal|"is not a socket\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOTSOCK
operator|)
return|;
block|}
block|}
end_function

begin_function
name|void
name|put_socket_fops
parameter_list|(
name|struct
name|proc
modifier|*
name|p
parameter_list|,
name|int
name|fd
parameter_list|)
block|{
name|struct
name|filedesc
modifier|*
name|fdp
decl_stmt|;
name|struct
name|file
modifier|*
name|fp
decl_stmt|;
name|fdp
operator|=
name|p
operator|->
name|p_fd
expr_stmt|;
name|fp
operator|=
name|fdp
operator|->
name|fd_ofiles
index|[
name|fd
index|]
expr_stmt|;
if|if
condition|(
name|ss_socket_fops
operator|.
name|fo_ioctl
operator|!=
name|fp
operator|->
name|f_ops
operator|->
name|fo_ioctl
condition|)
block|{
name|bcopy
argument_list|(
name|fp
operator|->
name|f_ops
argument_list|,
operator|&
name|ss_socket_fops
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|fileops
argument_list|)
argument_list|)
expr_stmt|;
name|ioctl_s
operator|=
name|ss_socket_fops
operator|.
name|fo_ioctl
expr_stmt|;
comment|/* save standard ioctl */
name|close_s
operator|=
name|ss_socket_fops
operator|.
name|fo_close
expr_stmt|;
comment|/* save standard close */
name|ss_socket_fops
operator|.
name|fo_ioctl
operator|=
name|ss_fop_ioctl
expr_stmt|;
name|ss_socket_fops
operator|.
name|fo_close
operator|=
name|ss_fop_close
expr_stmt|;
block|}
name|fp
operator|->
name|f_ops
operator|=
operator|&
name|ss_socket_fops
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|int
name|ss_SYSCALL
parameter_list|(
name|n
parameter_list|,
name|convert_arg
parameter_list|,
name|indicator
parameter_list|,
name|arg
parameter_list|,
name|p
parameter_list|,
name|retval
parameter_list|)
name|int
name|n
decl_stmt|;
comment|/* syscall ordinal */
name|int
name|convert_arg
decl_stmt|;
comment|/* if not 0, argument to convert */
name|int
name|indicator
decl_stmt|;
comment|/* type of argument to convert */
name|int
modifier|*
name|arg
decl_stmt|;
comment|/* address of alien arg */
name|struct
name|proc
modifier|*
name|p
decl_stmt|;
name|int
modifier|*
name|retval
decl_stmt|;
block|{
name|int
name|error
decl_stmt|;
name|int
name|rc
decl_stmt|;
if|if
condition|(
name|convert_arg
condition|)
block|{
if|if
condition|(
name|rc
operator|=
name|ss_convert_struct
argument_list|(
operator|(
name|caddr_t
operator|)
operator|*
operator|(
name|arg
operator|+
name|convert_arg
operator|)
argument_list|,
name|indicator
argument_list|,
name|SS_ALIEN_TO_NATIVE
argument_list|)
condition|)
return|return
operator|(
name|rc
operator|)
return|;
name|error
operator|=
operator|(
operator|*
name|sysent
index|[
name|n
index|]
operator|.
name|sy_call
operator|)
operator|(
name|p
operator|,
name|arg
operator|+
literal|1
operator|,
name|retval
operator|)
expr_stmt|;
name|rc
operator|=
name|ss_convert_struct
argument_list|(
operator|(
name|caddr_t
operator|)
operator|*
operator|(
name|arg
operator|+
name|convert_arg
operator|)
argument_list|,
name|indicator
argument_list|,
name|SS_NATIVE_TO_ALIEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|ss_debug
condition|)
name|printf
argument_list|(
literal|"ss_SYSCALL: [%d] error=%d, rc=%d\n"
argument_list|,
name|p
operator|->
name|p_pid
argument_list|,
name|error
argument_list|,
name|rc
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|rc
operator|=
literal|0
expr_stmt|;
name|error
operator|=
operator|(
operator|*
name|sysent
index|[
name|n
index|]
operator|.
name|sy_call
operator|)
operator|(
name|p
operator|,
name|arg
operator|+
literal|1
operator|,
name|retval
operator|)
expr_stmt|;
if|if
condition|(
name|ss_debug
condition|)
name|printf
argument_list|(
literal|"ss_SYSCALL: [%d] error=%d\n"
argument_list|,
name|p
operator|->
name|p_pid
argument_list|,
name|error
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|error
condition|?
name|error
else|:
name|rc
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ss_IOCTL
parameter_list|(
name|fp
parameter_list|,
name|cmd
parameter_list|,
name|arg
parameter_list|,
name|p
parameter_list|)
name|struct
name|file
modifier|*
name|fp
decl_stmt|;
name|int
name|cmd
decl_stmt|;
name|int
modifier|*
name|arg
decl_stmt|;
comment|/* address of alien arg */
name|struct
name|proc
modifier|*
name|p
decl_stmt|;
block|{
name|int
name|error
decl_stmt|,
name|rc
decl_stmt|;
name|int
name|these
index|[
literal|2
index|]
decl_stmt|;
name|char
name|cmd_type
decl_stmt|;
name|int
name|cmd_ordinal
decl_stmt|;
name|int
name|indicator
decl_stmt|;
name|cmd_type
operator|=
operator|(
name|cmd
operator|>>
literal|8
operator|)
operator|&
literal|0xff
expr_stmt|;
name|cmd_ordinal
operator|=
name|cmd
operator|&
literal|0xff
expr_stmt|;
name|these
index|[
literal|0
index|]
operator|=
name|cmd_type
expr_stmt|;
name|these
index|[
literal|1
index|]
operator|=
name|cmd_ordinal
expr_stmt|;
if|if
condition|(
name|ss_debug
operator|>
literal|1
condition|)
name|printf
argument_list|(
literal|"ss_IOCTL: calling ss_convert with %d(%c) %d\n"
argument_list|,
name|these
index|[
literal|0
index|]
argument_list|,
name|these
index|[
literal|0
index|]
argument_list|,
name|these
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|indicator
operator|=
name|ss_convert
argument_list|(
name|struct_whatevers
argument_list|,
name|these
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ss_debug
operator|>
literal|1
condition|)
name|printf
argument_list|(
literal|"ss_IOCTL: ss_convert returns indicator %d\n"
argument_list|,
name|indicator
argument_list|)
expr_stmt|;
if|if
condition|(
name|indicator
condition|)
block|{
name|error
operator|=
name|ss_convert_struct
argument_list|(
operator|(
name|caddr_t
operator|)
operator|*
operator|(
name|arg
operator|+
literal|2
operator|)
argument_list|,
name|indicator
argument_list|,
name|SS_ALIEN_TO_NATIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|ss_debug
operator|>
literal|1
condition|)
name|printf
argument_list|(
literal|"ss_IOCTL: ss_convert_struct returns %d\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
comment|/* change len in ioctl now - in the general case */
name|error
operator|=
name|ioctl_s
argument_list|(
name|fp
argument_list|,
name|cmd
argument_list|,
operator|(
name|caddr_t
operator|)
name|arg
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|rc
operator|=
name|ss_convert_struct
argument_list|(
operator|(
name|caddr_t
operator|)
operator|*
operator|(
name|arg
operator|+
literal|2
operator|)
argument_list|,
name|indicator
argument_list|,
name|SS_NATIVE_TO_ALIEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|ss_debug
condition|)
name|printf
argument_list|(
literal|"ss_IOCTL: [%d] error=%d, rc=%d\n"
argument_list|,
name|p
operator|->
name|p_pid
argument_list|,
name|error
argument_list|,
name|rc
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|rc
operator|=
literal|0
expr_stmt|;
name|error
operator|=
name|ioctl_s
argument_list|(
name|fp
argument_list|,
name|cmd
argument_list|,
operator|(
name|caddr_t
operator|)
name|arg
argument_list|,
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|ss_debug
condition|)
name|printf
argument_list|(
literal|"ss_IOCTL: [%d] error=%d\n"
argument_list|,
name|p
operator|->
name|p_pid
argument_list|,
name|error
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|error
condition|?
name|error
else|:
name|rc
operator|)
return|;
block|}
end_function

begin_struct
struct|struct
name|ss_socketopt_args
block|{
name|int
name|s
decl_stmt|;
name|int
name|level
decl_stmt|;
name|int
name|name
decl_stmt|;
name|caddr_t
name|val
decl_stmt|;
name|int
name|valsize
decl_stmt|;
block|}
struct|;
end_struct

begin_function
name|int
name|ss_setsockopt
parameter_list|(
name|arg
parameter_list|,
name|ret
parameter_list|,
name|p
parameter_list|)
name|struct
name|ss_socketopt_args
modifier|*
name|arg
decl_stmt|;
name|int
modifier|*
name|ret
decl_stmt|;
name|struct
name|proc
modifier|*
name|p
decl_stmt|;
block|{
name|int
name|error
decl_stmt|,
name|optname
decl_stmt|;
name|int
name|retval
index|[
literal|2
index|]
decl_stmt|;
if|if
condition|(
name|arg
operator|->
name|level
operator|!=
literal|0xffff
condition|)
comment|/* FreeBSD, SCO and ? */
return|return
operator|(
name|ENOPROTOOPT
operator|)
return|;
name|optname
operator|=
name|ss_convert
argument_list|(
name|sopt_whatevers
argument_list|,
operator|&
name|arg
operator|->
name|name
argument_list|,
literal|0
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|optname
condition|)
block|{
case|case
name|SO_ACCEPTCONN
case|:
case|case
name|SO_BROADCAST
case|:
case|case
name|SO_DEBUG
case|:
case|case
name|SO_DONTROUTE
case|:
case|case
name|SO_LINGER
case|:
case|case
name|SO_KEEPALIVE
case|:
case|case
name|SO_OOBINLINE
case|:
case|case
name|SO_RCVBUF
case|:
case|case
name|SO_RCVLOWAT
case|:
case|case
name|SO_RCVTIMEO
case|:
case|case
name|SO_REUSEADDR
case|:
case|case
name|SO_SNDBUF
case|:
case|case
name|SO_SNDLOWAT
case|:
case|case
name|SO_SNDTIMEO
case|:
case|case
name|SO_USELOOPBACK
case|:
name|error
operator|=
name|SYSCALLX
argument_list|(
name|SYS_setsockopt
argument_list|,
name|arg
argument_list|)
expr_stmt|;
operator|*
name|ret
operator|=
name|retval
index|[
literal|0
index|]
expr_stmt|;
operator|*
operator|(
name|ret
operator|+
literal|1
operator|)
operator|=
name|retval
index|[
literal|1
index|]
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
case|case
name|SO_ERROR
case|:
case|case
name|SO_IMASOCKET
case|:
case|case
name|SO_NO_CHECK
case|:
case|case
name|SO_ORDREL
case|:
case|case
name|SO_PRIORITY
case|:
case|case
name|SO_PROTOTYPE
case|:
case|case
name|SO_TYPE
case|:
return|return
operator|(
name|ENOPROTOOPT
operator|)
return|;
block|}
return|return
operator|(
name|ENOPROTOOPT
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ss_getsockopt
parameter_list|(
name|arg
parameter_list|,
name|ret
parameter_list|,
name|p
parameter_list|)
name|struct
name|ss_socketopt_args
modifier|*
name|arg
decl_stmt|;
name|int
modifier|*
name|ret
decl_stmt|;
name|struct
name|proc
modifier|*
name|p
decl_stmt|;
block|{
name|int
name|error
decl_stmt|,
name|optname
decl_stmt|;
name|int
name|retval
index|[
literal|2
index|]
decl_stmt|;
if|if
condition|(
name|arg
operator|->
name|level
operator|!=
literal|0xffff
condition|)
comment|/* FreeBSD, SCO and ? */
return|return
operator|(
name|ENOPROTOOPT
operator|)
return|;
name|optname
operator|=
name|ss_convert
argument_list|(
name|sopt_whatevers
argument_list|,
operator|&
name|arg
operator|->
name|name
argument_list|,
literal|0
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|optname
condition|)
block|{
case|case
name|SO_ACCEPTCONN
case|:
case|case
name|SO_BROADCAST
case|:
case|case
name|SO_DEBUG
case|:
case|case
name|SO_DONTROUTE
case|:
case|case
name|SO_ERROR
case|:
case|case
name|SO_KEEPALIVE
case|:
case|case
name|SO_LINGER
case|:
case|case
name|SO_OOBINLINE
case|:
case|case
name|SO_RCVBUF
case|:
case|case
name|SO_RCVLOWAT
case|:
case|case
name|SO_RCVTIMEO
case|:
case|case
name|SO_REUSEADDR
case|:
case|case
name|SO_SNDBUF
case|:
case|case
name|SO_SNDLOWAT
case|:
case|case
name|SO_SNDTIMEO
case|:
case|case
name|SO_TYPE
case|:
case|case
name|SO_USELOOPBACK
case|:
name|error
operator|=
name|SYSCALLX
argument_list|(
name|SYS_getsockopt
argument_list|,
name|arg
argument_list|)
expr_stmt|;
operator|*
name|ret
operator|=
name|retval
index|[
literal|0
index|]
expr_stmt|;
operator|*
operator|(
name|ret
operator|+
literal|1
operator|)
operator|=
name|retval
index|[
literal|1
index|]
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
case|case
name|SO_PROTOTYPE
case|:
block|{
name|int
name|value
init|=
literal|0
decl_stmt|;
name|error
operator|=
name|copyout
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
name|value
argument_list|,
operator|(
name|caddr_t
operator|)
name|arg
operator|->
name|s
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
case|case
name|SO_IMASOCKET
case|:
block|{
name|int
name|value
init|=
literal|1
decl_stmt|;
name|error
operator|=
name|copyout
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
name|value
argument_list|,
operator|(
name|caddr_t
operator|)
name|arg
operator|->
name|s
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
case|case
name|SO_NO_CHECK
case|:
case|case
name|SO_ORDREL
case|:
case|case
name|SO_PRIORITY
case|:
return|return
operator|(
name|ENOPROTOOPT
operator|)
return|;
block|}
return|return
operator|(
name|ENOPROTOOPT
operator|)
return|;
block|}
end_function

begin_define
define|#
directive|define
name|SS_CONVERT
end_define

begin_decl_stmt
name|int
name|system_type
init|=
name|SS_FREEBSD
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* FreeBSD */
end_comment

begin_function
name|int
name|ss_convert
parameter_list|(
name|what
parameter_list|,
name|this
parameter_list|,
name|otherwise
parameter_list|)
name|struct
name|whatever
modifier|*
modifier|*
name|what
decl_stmt|;
name|int
modifier|*
name|this
decl_stmt|;
name|int
name|otherwise
decl_stmt|;
block|{
name|struct
name|whatever
modifier|*
name|specific
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|specific
operator|=
name|what
index|[
name|system_type
index|]
operator|)
condition|)
return|return
operator|*
name|this
return|;
for|for
control|(
init|;
name|specific
operator|->
name|from
operator|!=
operator|-
literal|1
condition|;
name|specific
operator|++
control|)
if|if
condition|(
name|specific
operator|->
name|from
operator|<=
operator|*
name|this
operator|&&
operator|*
name|this
operator|<=
name|specific
operator|->
name|to
condition|)
if|if
condition|(
name|specific
operator|->
name|from
operator|==
name|specific
operator|->
name|to
condition|)
block|{
if|if
condition|(
name|specific
operator|->
name|more
condition|)
block|{
name|specific
operator|=
name|specific
operator|->
name|more
expr_stmt|;
name|this
operator|++
expr_stmt|;
continue|continue;
block|}
else|else
block|{
return|return
operator|(
operator|(
name|int
operator|)
name|specific
operator|->
name|conversion
operator|)
return|;
block|}
block|}
else|else
block|{
return|return
operator|(
name|specific
operator|->
name|conversion
condition|?
operator|(
name|specific
operator|->
name|all_the_same
condition|?
operator|(
name|int
operator|)
name|specific
operator|->
name|conversion
else|:
name|specific
operator|->
name|conversion
index|[
operator|*
name|this
operator|-
name|specific
operator|->
name|from
index|]
operator|)
else|:
operator|*
name|this
operator|)
return|;
block|}
return|return
name|otherwise
return|;
block|}
end_function

begin_comment
comment|/*	Returns	0 - no conversion, no pointer modification 		1 - converted, relevant pointer modification 	       -1 - error  */
end_comment

begin_function
name|int
name|ss_convert_struct
parameter_list|(
name|alien
parameter_list|,
name|indicator
parameter_list|,
name|direction
parameter_list|)
name|char
modifier|*
name|alien
decl_stmt|;
name|int
name|indicator
decl_stmt|;
name|int
name|direction
decl_stmt|;
block|{
name|int
name|error
decl_stmt|,
name|len
decl_stmt|;
switch|switch
condition|(
name|system_type
condition|)
block|{
case|case
name|SS_FREEBSD
case|:
return|return
operator|(
literal|0
operator|)
return|;
case|case
name|SS_SYSVR4
case|:
case|case
name|SS_SYSVR3
case|:
case|case
name|SS_SCO_32
case|:
case|case
name|SS_WYSE_321
case|:
case|case
name|SS_ISC
case|:
case|case
name|SS_LINUX
case|:
switch|switch
condition|(
name|direction
condition|)
block|{
case|case
name|SS_ALIEN_TO_NATIVE
case|:
name|error
operator|=
name|ss_atn
argument_list|(
name|alien
argument_list|,
name|indicator
argument_list|)
expr_stmt|;
if|if
condition|(
name|ss_debug
operator|>
literal|1
condition|)
name|printf
argument_list|(
literal|"ss_convert: ATN ss_atn error %d\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
case|case
name|SS_NATIVE_TO_ALIEN
case|:
name|error
operator|=
name|ss_nta
argument_list|(
name|alien
argument_list|,
name|indicator
argument_list|)
expr_stmt|;
if|if
condition|(
name|ss_debug
operator|>
literal|1
condition|)
name|printf
argument_list|(
literal|"ss_convert: NTA ss_nta error %d\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
default|default:
name|printf
argument_list|(
literal|"ss_convert_struct: not expecting system_type %d\n"
argument_list|,
name|system_type
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
end_function

begin_comment
comment|/* note sockaddr_un linux unsigned short fam,  108 path    BSD uchar , uchar 104 */
end_comment

begin_function
name|int
name|ss_atn
parameter_list|(
name|alien
parameter_list|,
name|indicator
parameter_list|)
name|char
modifier|*
name|alien
decl_stmt|;
name|int
name|indicator
decl_stmt|;
block|{
name|int
name|error
decl_stmt|;
switch|switch
condition|(
name|indicator
condition|)
block|{
case|case
name|SS_STRUCT_ARPREQ
case|:
comment|/* compatible */
return|return
operator|(
literal|0
operator|)
return|;
case|case
name|SS_STRUCT_IFCONF
case|:
comment|/* compatible */
return|return
operator|(
literal|0
operator|)
return|;
case|case
name|SS_STRUCT_IFREQ
case|:
comment|/* length OK - more unions - function dependent */
return|return
operator|(
literal|0
operator|)
return|;
case|case
name|SS_STRUCT_ORTENTRY
case|:
comment|/* compatible */
return|return
operator|(
literal|0
operator|)
return|;
case|case
name|SS_STRUCT_SOCKADDR
case|:
block|{
struct|struct
name|native_hdr
block|{
name|u_char
name|len
decl_stmt|;
name|u_char
name|family
decl_stmt|;
block|}
struct|;
union|union
name|hdr_part
block|{
name|struct
name|native_hdr
name|native
decl_stmt|;
name|u_short
name|alien_family
decl_stmt|;
block|}
name|hdr
union|;
if|if
condition|(
name|error
operator|=
name|copyin
argument_list|(
operator|(
name|caddr_t
operator|)
name|alien
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|hdr
argument_list|,
sizeof|sizeof
argument_list|(
name|hdr
argument_list|)
argument_list|)
condition|)
return|return
operator|(
name|error
operator|)
return|;
if|if
condition|(
name|ss_debug
operator|>
literal|1
condition|)
name|printf
argument_list|(
literal|"ss_atn:copyin 0x%x\n"
argument_list|,
name|hdr
operator|.
name|alien_family
argument_list|)
expr_stmt|;
if|if
condition|(
name|hdr
operator|.
name|alien_family
operator|<
name|AF_MAX
condition|)
block|{
name|hdr
operator|.
name|native
operator|.
name|family
operator|=
name|hdr
operator|.
name|alien_family
operator|>>
literal|8
expr_stmt|;
comment|/* 386 endianess */
comment|/* OR LEN FOM A PARAM ? */
name|hdr
operator|.
name|native
operator|.
name|len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ss_debug
operator|>
literal|1
condition|)
name|printf
argument_list|(
literal|"ss_atn:copyout 0x%x\n"
argument_list|,
name|hdr
operator|.
name|alien_family
argument_list|)
expr_stmt|;
name|error
operator|=
name|copyout
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
name|hdr
argument_list|,
operator|(
name|caddr_t
operator|)
name|alien
argument_list|,
sizeof|sizeof
argument_list|(
name|hdr
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"ss_atn: sa_family = %d\n"
argument_list|,
name|hdr
operator|.
name|alien_family
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
block|}
case|case
name|SS_STRUCT_SOCKNEWPROTO
case|:
comment|/* don't have */
name|printf
argument_list|(
literal|"ss_atn: not expecting SS_STRUCT_SOCKNEWPROTO\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
default|default:
name|printf
argument_list|(
literal|"ss_atn: not expecting case %d\n"
argument_list|,
name|indicator
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
block|}
end_function

begin_comment
comment|/* note sockaddr_un linux unsigned short fam,  108 path    BSD uchar , uchar 104 */
end_comment

begin_function
name|int
name|ss_nta
parameter_list|(
name|alien
parameter_list|,
name|indicator
parameter_list|)
name|char
modifier|*
name|alien
decl_stmt|;
name|int
name|indicator
decl_stmt|;
block|{
name|int
name|error
decl_stmt|;
switch|switch
condition|(
name|indicator
condition|)
block|{
case|case
name|SS_STRUCT_ARPREQ
case|:
comment|/* compatible */
return|return
operator|(
literal|0
operator|)
return|;
case|case
name|SS_STRUCT_IFCONF
case|:
comment|/* compatible */
return|return
operator|(
literal|0
operator|)
return|;
case|case
name|SS_STRUCT_IFREQ
case|:
comment|/* length OK - more unions - function dependent */
return|return
operator|(
literal|0
operator|)
return|;
case|case
name|SS_STRUCT_ORTENTRY
case|:
comment|/* compatible */
return|return
operator|(
literal|0
operator|)
return|;
case|case
name|SS_STRUCT_SOCKADDR
case|:
block|{
struct|struct
name|native_hdr
block|{
name|u_char
name|len
decl_stmt|;
name|u_char
name|family
decl_stmt|;
block|}
struct|;
union|union
name|hdr_part
block|{
name|struct
name|native_hdr
name|native
decl_stmt|;
name|u_short
name|alien_family
decl_stmt|;
block|}
name|hdr
union|;
if|if
condition|(
name|error
operator|=
name|copyin
argument_list|(
operator|(
name|caddr_t
operator|)
name|alien
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|hdr
argument_list|,
sizeof|sizeof
argument_list|(
name|hdr
argument_list|)
argument_list|)
condition|)
return|return
operator|(
name|error
operator|)
return|;
if|if
condition|(
name|ss_debug
operator|>
literal|1
condition|)
name|printf
argument_list|(
literal|"ss_nta:copyin 0x%x\n"
argument_list|,
name|hdr
operator|.
name|alien_family
argument_list|)
expr_stmt|;
name|hdr
operator|.
name|alien_family
operator|=
name|hdr
operator|.
name|native
operator|.
name|family
expr_stmt|;
if|if
condition|(
name|ss_debug
operator|>
literal|1
condition|)
name|printf
argument_list|(
literal|"ss_nta:copyout 0x%x\n"
argument_list|,
name|hdr
operator|.
name|alien_family
argument_list|)
expr_stmt|;
name|error
operator|=
name|copyout
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
name|hdr
argument_list|,
operator|(
name|caddr_t
operator|)
name|alien
argument_list|,
sizeof|sizeof
argument_list|(
name|hdr
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
case|case
name|SS_STRUCT_SOCKNEWPROTO
case|:
comment|/* don't have */
name|printf
argument_list|(
literal|"ss_nta: not expecting SS_STRUCT_SOCKNEWPROTO\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
default|default:
name|printf
argument_list|(
literal|"ss_nta: not expecting case %d\n"
argument_list|,
name|indicator
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1995 Scott Bartram  * Copyright (c) 1995 Steven Wallace  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. The name of the author may not be used to endorse or promote products  *    derived from this software without specific prior written permission  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  *  * $Id: ibcs2_ipc.c,v 1.13 1997/11/06 19:28:28 phk Exp $  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/msg.h>
end_include

begin_include
include|#
directive|include
file|<sys/sem.h>
end_include

begin_include
include|#
directive|include
file|<sys/shm.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysproto.h>
end_include

begin_include
include|#
directive|include
file|<i386/ibcs2/ibcs2_types.h>
end_include

begin_include
include|#
directive|include
file|<i386/ibcs2/ibcs2_signal.h>
end_include

begin_include
include|#
directive|include
file|<i386/ibcs2/ibcs2_proto.h>
end_include

begin_include
include|#
directive|include
file|<i386/ibcs2/ibcs2_util.h>
end_include

begin_include
include|#
directive|include
file|<i386/ibcs2/ibcs2_ipc.h>
end_include

begin_define
define|#
directive|define
name|IBCS2_IPC_RMID
value|0
end_define

begin_define
define|#
directive|define
name|IBCS2_IPC_SET
value|1
end_define

begin_define
define|#
directive|define
name|IBCS2_IPC_STAT
value|2
end_define

begin_define
define|#
directive|define
name|IBCS2_SETVAL
value|8
end_define

begin_decl_stmt
specifier|static
name|void
name|cvt_msqid2imsqid
name|__P
argument_list|(
operator|(
expr|struct
name|msqid_ds
operator|*
operator|,
expr|struct
name|ibcs2_msqid_ds
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|cvt_imsqid2msqid
name|__P
argument_list|(
operator|(
expr|struct
name|ibcs2_msqid_ds
operator|*
operator|,
expr|struct
name|msqid_ds
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|unused
end_ifdef

begin_decl_stmt
specifier|static
name|void
name|cvt_sem2isem
name|__P
argument_list|(
operator|(
expr|struct
name|sem
operator|*
operator|,
expr|struct
name|ibcs2_sem
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|cvt_isem2sem
name|__P
argument_list|(
operator|(
expr|struct
name|ibcs2_sem
operator|*
operator|,
expr|struct
name|sem
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|static
name|void
name|cvt_semid2isemid
name|__P
argument_list|(
operator|(
expr|struct
name|semid_ds
operator|*
operator|,
expr|struct
name|ibcs2_semid_ds
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|cvt_isemid2semid
name|__P
argument_list|(
operator|(
expr|struct
name|ibcs2_semid_ds
operator|*
operator|,
expr|struct
name|semid_ds
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|cvt_shmid2ishmid
name|__P
argument_list|(
operator|(
expr|struct
name|shmid_ds
operator|*
operator|,
expr|struct
name|ibcs2_shmid_ds
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|cvt_ishmid2shmid
name|__P
argument_list|(
operator|(
expr|struct
name|ibcs2_shmid_ds
operator|*
operator|,
expr|struct
name|shmid_ds
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|cvt_perm2iperm
name|__P
argument_list|(
operator|(
expr|struct
name|ipc_perm
operator|*
operator|,
expr|struct
name|ibcs2_ipc_perm
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|cvt_iperm2perm
name|__P
argument_list|(
operator|(
expr|struct
name|ibcs2_ipc_perm
operator|*
operator|,
expr|struct
name|ipc_perm
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * iBCS2 msgsys call  */
end_comment

begin_function
specifier|static
name|void
name|cvt_msqid2imsqid
parameter_list|(
name|bp
parameter_list|,
name|ibp
parameter_list|)
name|struct
name|msqid_ds
modifier|*
name|bp
decl_stmt|;
name|struct
name|ibcs2_msqid_ds
modifier|*
name|ibp
decl_stmt|;
block|{
name|cvt_perm2iperm
argument_list|(
operator|&
name|bp
operator|->
name|msg_perm
argument_list|,
operator|&
name|ibp
operator|->
name|msg_perm
argument_list|)
expr_stmt|;
name|ibp
operator|->
name|msg_first
operator|=
name|bp
operator|->
name|msg_first
expr_stmt|;
name|ibp
operator|->
name|msg_last
operator|=
name|bp
operator|->
name|msg_last
expr_stmt|;
name|ibp
operator|->
name|msg_cbytes
operator|=
operator|(
name|u_short
operator|)
name|bp
operator|->
name|msg_cbytes
expr_stmt|;
name|ibp
operator|->
name|msg_qnum
operator|=
operator|(
name|u_short
operator|)
name|bp
operator|->
name|msg_qnum
expr_stmt|;
name|ibp
operator|->
name|msg_qbytes
operator|=
operator|(
name|u_short
operator|)
name|bp
operator|->
name|msg_qbytes
expr_stmt|;
name|ibp
operator|->
name|msg_lspid
operator|=
operator|(
name|u_short
operator|)
name|bp
operator|->
name|msg_lspid
expr_stmt|;
name|ibp
operator|->
name|msg_lrpid
operator|=
operator|(
name|u_short
operator|)
name|bp
operator|->
name|msg_lrpid
expr_stmt|;
name|ibp
operator|->
name|msg_stime
operator|=
name|bp
operator|->
name|msg_stime
expr_stmt|;
name|ibp
operator|->
name|msg_rtime
operator|=
name|bp
operator|->
name|msg_rtime
expr_stmt|;
name|ibp
operator|->
name|msg_ctime
operator|=
name|bp
operator|->
name|msg_ctime
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|cvt_imsqid2msqid
parameter_list|(
name|ibp
parameter_list|,
name|bp
parameter_list|)
name|struct
name|ibcs2_msqid_ds
modifier|*
name|ibp
decl_stmt|;
name|struct
name|msqid_ds
modifier|*
name|bp
decl_stmt|;
block|{
name|cvt_iperm2perm
argument_list|(
operator|&
name|ibp
operator|->
name|msg_perm
argument_list|,
operator|&
name|bp
operator|->
name|msg_perm
argument_list|)
expr_stmt|;
name|bp
operator|->
name|msg_first
operator|=
name|ibp
operator|->
name|msg_first
expr_stmt|;
name|bp
operator|->
name|msg_last
operator|=
name|ibp
operator|->
name|msg_last
expr_stmt|;
name|bp
operator|->
name|msg_cbytes
operator|=
name|ibp
operator|->
name|msg_cbytes
expr_stmt|;
name|bp
operator|->
name|msg_qnum
operator|=
name|ibp
operator|->
name|msg_qnum
expr_stmt|;
name|bp
operator|->
name|msg_qbytes
operator|=
name|ibp
operator|->
name|msg_qbytes
expr_stmt|;
name|bp
operator|->
name|msg_lspid
operator|=
name|ibp
operator|->
name|msg_lspid
expr_stmt|;
name|bp
operator|->
name|msg_lrpid
operator|=
name|ibp
operator|->
name|msg_lrpid
expr_stmt|;
name|bp
operator|->
name|msg_stime
operator|=
name|ibp
operator|->
name|msg_stime
expr_stmt|;
name|bp
operator|->
name|msg_rtime
operator|=
name|ibp
operator|->
name|msg_rtime
expr_stmt|;
name|bp
operator|->
name|msg_ctime
operator|=
name|ibp
operator|->
name|msg_ctime
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|int
name|ibcs2_msgsys
parameter_list|(
name|p
parameter_list|,
name|uap
parameter_list|)
name|struct
name|proc
modifier|*
name|p
decl_stmt|;
name|struct
name|ibcs2_msgsys_args
modifier|*
name|uap
decl_stmt|;
block|{
switch|switch
condition|(
name|SCARG
argument_list|(
name|uap
argument_list|,
name|which
argument_list|)
condition|)
block|{
case|case
literal|0
case|:
comment|/* msgget */
name|SCARG
argument_list|(
name|uap
argument_list|,
name|which
argument_list|)
operator|=
literal|1
expr_stmt|;
return|return
name|msgsys
argument_list|(
name|p
argument_list|,
operator|(
expr|struct
name|msgsys_args
operator|*
operator|)
name|uap
argument_list|)
return|;
case|case
literal|1
case|:
block|{
comment|/* msgctl */
name|int
name|error
decl_stmt|;
name|struct
name|msgsys_args
name|margs
decl_stmt|;
name|caddr_t
name|sg
init|=
name|stackgap_init
argument_list|()
decl_stmt|;
name|SCARG
argument_list|(
operator|&
name|margs
argument_list|,
name|which
argument_list|)
operator|=
literal|0
expr_stmt|;
name|SCARG
argument_list|(
operator|&
name|margs
argument_list|,
name|a2
argument_list|)
operator|=
name|SCARG
argument_list|(
name|uap
argument_list|,
name|a2
argument_list|)
expr_stmt|;
name|SCARG
argument_list|(
operator|&
name|margs
argument_list|,
name|a4
argument_list|)
operator|=
operator|(
name|int
operator|)
name|stackgap_alloc
argument_list|(
operator|&
name|sg
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|msqid_ds
argument_list|)
argument_list|)
expr_stmt|;
name|SCARG
argument_list|(
operator|&
name|margs
argument_list|,
name|a3
argument_list|)
operator|=
name|SCARG
argument_list|(
name|uap
argument_list|,
name|a3
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|SCARG
argument_list|(
operator|&
name|margs
argument_list|,
name|a3
argument_list|)
condition|)
block|{
case|case
name|IBCS2_IPC_STAT
case|:
name|error
operator|=
name|msgsys
argument_list|(
name|p
argument_list|,
operator|&
name|margs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
name|cvt_msqid2imsqid
argument_list|(
operator|(
expr|struct
name|msqid_ds
operator|*
operator|)
name|SCARG
argument_list|(
operator|&
name|margs
argument_list|,
name|a4
argument_list|)
argument_list|,
operator|(
expr|struct
name|ibcs2_msqid_ds
operator|*
operator|)
name|SCARG
argument_list|(
name|uap
argument_list|,
name|a4
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|error
return|;
case|case
name|IBCS2_IPC_SET
case|:
name|cvt_imsqid2msqid
argument_list|(
operator|(
expr|struct
name|ibcs2_msqid_ds
operator|*
operator|)
name|SCARG
argument_list|(
name|uap
argument_list|,
name|a4
argument_list|)
argument_list|,
operator|(
expr|struct
name|msqid_ds
operator|*
operator|)
name|SCARG
argument_list|(
operator|&
name|margs
argument_list|,
name|a4
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|msgsys
argument_list|(
name|p
argument_list|,
operator|&
name|margs
argument_list|)
return|;
case|case
name|IBCS2_IPC_RMID
case|:
return|return
name|msgsys
argument_list|(
name|p
argument_list|,
operator|&
name|margs
argument_list|)
return|;
block|}
return|return
name|EINVAL
return|;
block|}
case|case
literal|2
case|:
comment|/* msgrcv */
name|SCARG
argument_list|(
name|uap
argument_list|,
name|which
argument_list|)
operator|=
literal|3
expr_stmt|;
return|return
name|msgsys
argument_list|(
name|p
argument_list|,
operator|(
expr|struct
name|msgsys_args
operator|*
operator|)
name|uap
argument_list|)
return|;
case|case
literal|3
case|:
comment|/* msgsnd */
name|SCARG
argument_list|(
name|uap
argument_list|,
name|which
argument_list|)
operator|=
literal|2
expr_stmt|;
return|return
name|msgsys
argument_list|(
name|p
argument_list|,
operator|(
expr|struct
name|msgsys_args
operator|*
operator|)
name|uap
argument_list|)
return|;
default|default:
return|return
name|EINVAL
return|;
block|}
block|}
end_function

begin_comment
comment|/*  * iBCS2 semsys call  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|unused
end_ifdef

begin_function
specifier|static
name|void
name|cvt_sem2isem
parameter_list|(
name|bp
parameter_list|,
name|ibp
parameter_list|)
name|struct
name|sem
modifier|*
name|bp
decl_stmt|;
name|struct
name|ibcs2_sem
modifier|*
name|ibp
decl_stmt|;
block|{
name|ibp
operator|->
name|semval
operator|=
name|bp
operator|->
name|semval
expr_stmt|;
name|ibp
operator|->
name|sempid
operator|=
name|bp
operator|->
name|sempid
expr_stmt|;
name|ibp
operator|->
name|semncnt
operator|=
name|bp
operator|->
name|semncnt
expr_stmt|;
name|ibp
operator|->
name|semzcnt
operator|=
name|bp
operator|->
name|semzcnt
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|cvt_isem2sem
parameter_list|(
name|ibp
parameter_list|,
name|bp
parameter_list|)
name|struct
name|ibcs2_sem
modifier|*
name|ibp
decl_stmt|;
name|struct
name|sem
modifier|*
name|bp
decl_stmt|;
block|{
name|bp
operator|->
name|semval
operator|=
name|ibp
operator|->
name|semval
expr_stmt|;
name|bp
operator|->
name|sempid
operator|=
name|ibp
operator|->
name|sempid
expr_stmt|;
name|bp
operator|->
name|semncnt
operator|=
name|ibp
operator|->
name|semncnt
expr_stmt|;
name|bp
operator|->
name|semzcnt
operator|=
name|ibp
operator|->
name|semzcnt
expr_stmt|;
return|return;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|void
name|cvt_iperm2perm
parameter_list|(
name|ipp
parameter_list|,
name|pp
parameter_list|)
name|struct
name|ibcs2_ipc_perm
modifier|*
name|ipp
decl_stmt|;
name|struct
name|ipc_perm
modifier|*
name|pp
decl_stmt|;
block|{
name|pp
operator|->
name|uid
operator|=
name|ipp
operator|->
name|uid
expr_stmt|;
name|pp
operator|->
name|gid
operator|=
name|ipp
operator|->
name|gid
expr_stmt|;
name|pp
operator|->
name|cuid
operator|=
name|ipp
operator|->
name|cuid
expr_stmt|;
name|pp
operator|->
name|cgid
operator|=
name|ipp
operator|->
name|cgid
expr_stmt|;
name|pp
operator|->
name|mode
operator|=
name|ipp
operator|->
name|mode
expr_stmt|;
name|pp
operator|->
name|seq
operator|=
name|ipp
operator|->
name|seq
expr_stmt|;
name|pp
operator|->
name|key
operator|=
name|ipp
operator|->
name|key
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|cvt_perm2iperm
parameter_list|(
name|pp
parameter_list|,
name|ipp
parameter_list|)
name|struct
name|ipc_perm
modifier|*
name|pp
decl_stmt|;
name|struct
name|ibcs2_ipc_perm
modifier|*
name|ipp
decl_stmt|;
block|{
name|ipp
operator|->
name|uid
operator|=
name|pp
operator|->
name|uid
expr_stmt|;
name|ipp
operator|->
name|gid
operator|=
name|pp
operator|->
name|gid
expr_stmt|;
name|ipp
operator|->
name|cuid
operator|=
name|pp
operator|->
name|cuid
expr_stmt|;
name|ipp
operator|->
name|cgid
operator|=
name|pp
operator|->
name|cgid
expr_stmt|;
name|ipp
operator|->
name|mode
operator|=
name|pp
operator|->
name|mode
expr_stmt|;
name|ipp
operator|->
name|seq
operator|=
name|pp
operator|->
name|seq
expr_stmt|;
name|ipp
operator|->
name|key
operator|=
name|pp
operator|->
name|key
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|cvt_semid2isemid
parameter_list|(
name|bp
parameter_list|,
name|ibp
parameter_list|)
name|struct
name|semid_ds
modifier|*
name|bp
decl_stmt|;
name|struct
name|ibcs2_semid_ds
modifier|*
name|ibp
decl_stmt|;
block|{
name|cvt_perm2iperm
argument_list|(
operator|&
name|bp
operator|->
name|sem_perm
argument_list|,
operator|&
name|ibp
operator|->
name|sem_perm
argument_list|)
expr_stmt|;
name|ibp
operator|->
name|sem_base
operator|=
operator|(
expr|struct
name|ibcs2_sem
operator|*
operator|)
name|bp
operator|->
name|sem_base
expr_stmt|;
name|ibp
operator|->
name|sem_nsems
operator|=
name|bp
operator|->
name|sem_nsems
expr_stmt|;
name|ibp
operator|->
name|sem_otime
operator|=
name|bp
operator|->
name|sem_otime
expr_stmt|;
name|ibp
operator|->
name|sem_ctime
operator|=
name|bp
operator|->
name|sem_ctime
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|cvt_isemid2semid
parameter_list|(
name|ibp
parameter_list|,
name|bp
parameter_list|)
name|struct
name|ibcs2_semid_ds
modifier|*
name|ibp
decl_stmt|;
name|struct
name|semid_ds
modifier|*
name|bp
decl_stmt|;
block|{
name|cvt_iperm2perm
argument_list|(
operator|&
name|ibp
operator|->
name|sem_perm
argument_list|,
operator|&
name|bp
operator|->
name|sem_perm
argument_list|)
expr_stmt|;
name|bp
operator|->
name|sem_base
operator|=
operator|(
expr|struct
name|sem
operator|*
operator|)
name|ibp
operator|->
name|sem_base
expr_stmt|;
name|bp
operator|->
name|sem_nsems
operator|=
name|ibp
operator|->
name|sem_nsems
expr_stmt|;
name|bp
operator|->
name|sem_otime
operator|=
name|ibp
operator|->
name|sem_otime
expr_stmt|;
name|bp
operator|->
name|sem_ctime
operator|=
name|ibp
operator|->
name|sem_ctime
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|int
name|ibcs2_semsys
parameter_list|(
name|p
parameter_list|,
name|uap
parameter_list|)
name|struct
name|proc
modifier|*
name|p
decl_stmt|;
name|struct
name|ibcs2_semsys_args
modifier|*
name|uap
decl_stmt|;
block|{
name|int
name|error
decl_stmt|;
switch|switch
condition|(
name|SCARG
argument_list|(
name|uap
argument_list|,
name|which
argument_list|)
condition|)
block|{
case|case
literal|0
case|:
comment|/* semctl */
switch|switch
condition|(
name|SCARG
argument_list|(
name|uap
argument_list|,
name|a4
argument_list|)
condition|)
block|{
case|case
name|IBCS2_IPC_STAT
case|:
block|{
name|struct
name|ibcs2_semid_ds
modifier|*
name|isp
decl_stmt|;
name|struct
name|semid_ds
modifier|*
name|sp
decl_stmt|;
name|union
name|semun
modifier|*
name|sup
decl_stmt|,
name|ssu
decl_stmt|;
name|caddr_t
name|sg
init|=
name|stackgap_init
argument_list|()
decl_stmt|;
name|ssu
operator|=
operator|(
expr|union
name|semun
operator|)
name|SCARG
argument_list|(
name|uap
argument_list|,
name|a5
argument_list|)
expr_stmt|;
name|sp
operator|=
name|stackgap_alloc
argument_list|(
operator|&
name|sg
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|semid_ds
argument_list|)
argument_list|)
expr_stmt|;
name|sup
operator|=
name|stackgap_alloc
argument_list|(
operator|&
name|sg
argument_list|,
sizeof|sizeof
argument_list|(
expr|union
name|semun
argument_list|)
argument_list|)
expr_stmt|;
name|sup
operator|->
name|buf
operator|=
name|sp
expr_stmt|;
name|SCARG
argument_list|(
name|uap
argument_list|,
name|a5
argument_list|)
operator|=
operator|(
name|int
operator|)
name|sup
expr_stmt|;
name|error
operator|=
name|semsys
argument_list|(
name|p
argument_list|,
operator|(
expr|struct
name|semsys_args
operator|*
operator|)
name|uap
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
block|{
name|SCARG
argument_list|(
name|uap
argument_list|,
name|a5
argument_list|)
operator|=
operator|(
name|int
operator|)
name|ssu
operator|.
name|buf
expr_stmt|;
name|isp
operator|=
name|stackgap_alloc
argument_list|(
operator|&
name|sg
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|isp
argument_list|)
argument_list|)
expr_stmt|;
name|cvt_semid2isemid
argument_list|(
name|sp
argument_list|,
name|isp
argument_list|)
expr_stmt|;
name|error
operator|=
name|copyout
argument_list|(
operator|(
name|caddr_t
operator|)
name|isp
argument_list|,
operator|(
name|caddr_t
operator|)
name|ssu
operator|.
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|isp
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|error
return|;
block|}
case|case
name|IBCS2_IPC_SET
case|:
block|{
name|struct
name|ibcs2_semid_ds
modifier|*
name|isp
decl_stmt|;
name|struct
name|semid_ds
modifier|*
name|sp
decl_stmt|;
name|caddr_t
name|sg
init|=
name|stackgap_init
argument_list|()
decl_stmt|;
name|isp
operator|=
name|stackgap_alloc
argument_list|(
operator|&
name|sg
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|isp
argument_list|)
argument_list|)
expr_stmt|;
name|sp
operator|=
name|stackgap_alloc
argument_list|(
operator|&
name|sg
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|sp
argument_list|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|copyin
argument_list|(
operator|(
name|caddr_t
operator|)
name|SCARG
argument_list|(
name|uap
argument_list|,
name|a5
argument_list|)
argument_list|,
operator|(
name|caddr_t
operator|)
name|isp
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|isp
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
name|cvt_isemid2semid
argument_list|(
name|isp
argument_list|,
name|sp
argument_list|)
expr_stmt|;
name|SCARG
argument_list|(
name|uap
argument_list|,
name|a5
argument_list|)
operator|=
operator|(
name|int
operator|)
name|sp
expr_stmt|;
return|return
name|semsys
argument_list|(
name|p
argument_list|,
operator|(
expr|struct
name|semsys_args
operator|*
operator|)
name|uap
argument_list|)
return|;
block|}
case|case
name|IBCS2_SETVAL
case|:
block|{
name|union
name|semun
modifier|*
name|sp
decl_stmt|;
name|caddr_t
name|sg
init|=
name|stackgap_init
argument_list|()
decl_stmt|;
name|sp
operator|=
name|stackgap_alloc
argument_list|(
operator|&
name|sg
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|sp
argument_list|)
argument_list|)
expr_stmt|;
name|sp
operator|->
name|val
operator|=
operator|(
name|int
operator|)
name|SCARG
argument_list|(
name|uap
argument_list|,
name|a5
argument_list|)
expr_stmt|;
name|SCARG
argument_list|(
name|uap
argument_list|,
name|a5
argument_list|)
operator|=
operator|(
name|int
operator|)
name|sp
expr_stmt|;
return|return
name|semsys
argument_list|(
name|p
argument_list|,
operator|(
expr|struct
name|semsys_args
operator|*
operator|)
name|uap
argument_list|)
return|;
block|}
block|}
return|return
name|semsys
argument_list|(
name|p
argument_list|,
operator|(
expr|struct
name|semsys_args
operator|*
operator|)
name|uap
argument_list|)
return|;
case|case
literal|1
case|:
comment|/* semget */
return|return
name|semsys
argument_list|(
name|p
argument_list|,
operator|(
expr|struct
name|semsys_args
operator|*
operator|)
name|uap
argument_list|)
return|;
case|case
literal|2
case|:
comment|/* semop */
return|return
name|semsys
argument_list|(
name|p
argument_list|,
operator|(
expr|struct
name|semsys_args
operator|*
operator|)
name|uap
argument_list|)
return|;
block|}
return|return
name|EINVAL
return|;
block|}
end_function

begin_comment
comment|/*  * iBCS2 shmsys call  */
end_comment

begin_function
specifier|static
name|void
name|cvt_shmid2ishmid
parameter_list|(
name|bp
parameter_list|,
name|ibp
parameter_list|)
name|struct
name|shmid_ds
modifier|*
name|bp
decl_stmt|;
name|struct
name|ibcs2_shmid_ds
modifier|*
name|ibp
decl_stmt|;
block|{
name|cvt_perm2iperm
argument_list|(
operator|&
name|bp
operator|->
name|shm_perm
argument_list|,
operator|&
name|ibp
operator|->
name|shm_perm
argument_list|)
expr_stmt|;
name|ibp
operator|->
name|shm_segsz
operator|=
name|bp
operator|->
name|shm_segsz
expr_stmt|;
name|ibp
operator|->
name|shm_lpid
operator|=
name|bp
operator|->
name|shm_lpid
expr_stmt|;
name|ibp
operator|->
name|shm_cpid
operator|=
name|bp
operator|->
name|shm_cpid
expr_stmt|;
name|ibp
operator|->
name|shm_nattch
operator|=
name|bp
operator|->
name|shm_nattch
expr_stmt|;
name|ibp
operator|->
name|shm_cnattch
operator|=
literal|0
expr_stmt|;
comment|/* ignored anyway */
name|ibp
operator|->
name|shm_atime
operator|=
name|bp
operator|->
name|shm_atime
expr_stmt|;
name|ibp
operator|->
name|shm_dtime
operator|=
name|bp
operator|->
name|shm_dtime
expr_stmt|;
name|ibp
operator|->
name|shm_ctime
operator|=
name|bp
operator|->
name|shm_ctime
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|cvt_ishmid2shmid
parameter_list|(
name|ibp
parameter_list|,
name|bp
parameter_list|)
name|struct
name|ibcs2_shmid_ds
modifier|*
name|ibp
decl_stmt|;
name|struct
name|shmid_ds
modifier|*
name|bp
decl_stmt|;
block|{
name|cvt_iperm2perm
argument_list|(
operator|&
name|ibp
operator|->
name|shm_perm
argument_list|,
operator|&
name|bp
operator|->
name|shm_perm
argument_list|)
expr_stmt|;
name|bp
operator|->
name|shm_segsz
operator|=
name|ibp
operator|->
name|shm_segsz
expr_stmt|;
name|bp
operator|->
name|shm_lpid
operator|=
name|ibp
operator|->
name|shm_lpid
expr_stmt|;
name|bp
operator|->
name|shm_cpid
operator|=
name|ibp
operator|->
name|shm_cpid
expr_stmt|;
name|bp
operator|->
name|shm_nattch
operator|=
name|ibp
operator|->
name|shm_nattch
expr_stmt|;
name|bp
operator|->
name|shm_atime
operator|=
name|ibp
operator|->
name|shm_atime
expr_stmt|;
name|bp
operator|->
name|shm_dtime
operator|=
name|ibp
operator|->
name|shm_dtime
expr_stmt|;
name|bp
operator|->
name|shm_ctime
operator|=
name|ibp
operator|->
name|shm_ctime
expr_stmt|;
name|bp
operator|->
name|shm_internal
operator|=
operator|(
name|void
operator|*
operator|)
literal|0
expr_stmt|;
comment|/* ignored anyway */
return|return;
block|}
end_function

begin_function
name|int
name|ibcs2_shmsys
parameter_list|(
name|p
parameter_list|,
name|uap
parameter_list|)
name|struct
name|proc
modifier|*
name|p
decl_stmt|;
name|struct
name|ibcs2_shmsys_args
modifier|*
name|uap
decl_stmt|;
block|{
name|int
name|error
decl_stmt|;
switch|switch
condition|(
name|SCARG
argument_list|(
name|uap
argument_list|,
name|which
argument_list|)
condition|)
block|{
case|case
literal|0
case|:
comment|/* shmat */
return|return
name|shmsys
argument_list|(
name|p
argument_list|,
operator|(
expr|struct
name|shmsys_args
operator|*
operator|)
name|uap
argument_list|)
return|;
case|case
literal|1
case|:
comment|/* shmctl */
switch|switch
condition|(
name|SCARG
argument_list|(
name|uap
argument_list|,
name|a3
argument_list|)
condition|)
block|{
case|case
name|IBCS2_IPC_STAT
case|:
block|{
name|struct
name|ibcs2_shmid_ds
modifier|*
name|isp
decl_stmt|;
name|struct
name|shmid_ds
modifier|*
name|sp
decl_stmt|;
name|caddr_t
name|sg
init|=
name|stackgap_init
argument_list|()
decl_stmt|;
name|isp
operator|=
operator|(
expr|struct
name|ibcs2_shmid_ds
operator|*
operator|)
name|SCARG
argument_list|(
name|uap
argument_list|,
name|a4
argument_list|)
expr_stmt|;
name|sp
operator|=
name|stackgap_alloc
argument_list|(
operator|&
name|sg
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|sp
argument_list|)
argument_list|)
expr_stmt|;
name|SCARG
argument_list|(
name|uap
argument_list|,
name|a4
argument_list|)
operator|=
operator|(
name|int
operator|)
name|sp
expr_stmt|;
name|error
operator|=
name|shmsys
argument_list|(
name|p
argument_list|,
operator|(
expr|struct
name|shmsys_args
operator|*
operator|)
name|uap
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
block|{
name|SCARG
argument_list|(
name|uap
argument_list|,
name|a4
argument_list|)
operator|=
operator|(
name|int
operator|)
name|isp
expr_stmt|;
name|isp
operator|=
name|stackgap_alloc
argument_list|(
operator|&
name|sg
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|isp
argument_list|)
argument_list|)
expr_stmt|;
name|cvt_shmid2ishmid
argument_list|(
name|sp
argument_list|,
name|isp
argument_list|)
expr_stmt|;
name|error
operator|=
name|copyout
argument_list|(
operator|(
name|caddr_t
operator|)
name|isp
argument_list|,
operator|(
name|caddr_t
operator|)
name|SCARG
argument_list|(
name|uap
argument_list|,
name|a4
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|isp
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|error
return|;
block|}
case|case
name|IBCS2_IPC_SET
case|:
block|{
name|struct
name|ibcs2_shmid_ds
modifier|*
name|isp
decl_stmt|;
name|struct
name|shmid_ds
modifier|*
name|sp
decl_stmt|;
name|caddr_t
name|sg
init|=
name|stackgap_init
argument_list|()
decl_stmt|;
name|isp
operator|=
name|stackgap_alloc
argument_list|(
operator|&
name|sg
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|isp
argument_list|)
argument_list|)
expr_stmt|;
name|sp
operator|=
name|stackgap_alloc
argument_list|(
operator|&
name|sg
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|sp
argument_list|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|copyin
argument_list|(
operator|(
name|caddr_t
operator|)
name|SCARG
argument_list|(
name|uap
argument_list|,
name|a4
argument_list|)
argument_list|,
operator|(
name|caddr_t
operator|)
name|isp
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|isp
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
name|cvt_ishmid2shmid
argument_list|(
name|isp
argument_list|,
name|sp
argument_list|)
expr_stmt|;
name|SCARG
argument_list|(
name|uap
argument_list|,
name|a4
argument_list|)
operator|=
operator|(
name|int
operator|)
name|sp
expr_stmt|;
return|return
name|shmsys
argument_list|(
name|p
argument_list|,
operator|(
expr|struct
name|shmsys_args
operator|*
operator|)
name|uap
argument_list|)
return|;
block|}
block|}
return|return
name|shmsys
argument_list|(
name|p
argument_list|,
operator|(
expr|struct
name|shmsys_args
operator|*
operator|)
name|uap
argument_list|)
return|;
case|case
literal|2
case|:
comment|/* shmdt */
return|return
name|shmsys
argument_list|(
name|p
argument_list|,
operator|(
expr|struct
name|shmsys_args
operator|*
operator|)
name|uap
argument_list|)
return|;
case|case
literal|3
case|:
comment|/* shmget */
return|return
name|shmsys
argument_list|(
name|p
argument_list|,
operator|(
expr|struct
name|shmsys_args
operator|*
operator|)
name|uap
argument_list|)
return|;
block|}
return|return
name|EINVAL
return|;
block|}
end_function

end_unit


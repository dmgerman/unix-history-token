begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 1995 Scott Bartram  * Copyright (c) 1995 Steven Wallace  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. The name of the author may not be used to endorse or promote products  *    derived from this software without specific prior written permission  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/msg.h>
end_include

begin_include
include|#
directive|include
file|<sys/sem.h>
end_include

begin_include
include|#
directive|include
file|<sys/shm.h>
end_include

begin_include
include|#
directive|include
file|<sys/syscallsubr.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysproto.h>
end_include

begin_include
include|#
directive|include
file|<i386/ibcs2/ibcs2_types.h>
end_include

begin_include
include|#
directive|include
file|<i386/ibcs2/ibcs2_signal.h>
end_include

begin_include
include|#
directive|include
file|<i386/ibcs2/ibcs2_proto.h>
end_include

begin_include
include|#
directive|include
file|<i386/ibcs2/ibcs2_util.h>
end_include

begin_include
include|#
directive|include
file|<i386/ibcs2/ibcs2_ipc.h>
end_include

begin_define
define|#
directive|define
name|IBCS2_IPC_RMID
value|0
end_define

begin_define
define|#
directive|define
name|IBCS2_IPC_SET
value|1
end_define

begin_define
define|#
directive|define
name|IBCS2_IPC_STAT
value|2
end_define

begin_define
define|#
directive|define
name|IBCS2_SETVAL
value|8
end_define

begin_function_decl
specifier|static
name|void
name|cvt_msqid2imsqid
parameter_list|(
name|struct
name|msqid_ds
modifier|*
parameter_list|,
name|struct
name|ibcs2_msqid_ds
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|cvt_imsqid2msqid
parameter_list|(
name|struct
name|ibcs2_msqid_ds
modifier|*
parameter_list|,
name|struct
name|msqid_ds
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|unused
end_ifdef

begin_function_decl
specifier|static
name|void
name|cvt_sem2isem
parameter_list|(
name|struct
name|sem
modifier|*
parameter_list|,
name|struct
name|ibcs2_sem
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|cvt_isem2sem
parameter_list|(
name|struct
name|ibcs2_sem
modifier|*
parameter_list|,
name|struct
name|sem
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|void
name|cvt_semid2isemid
parameter_list|(
name|struct
name|semid_ds
modifier|*
parameter_list|,
name|struct
name|ibcs2_semid_ds
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|cvt_isemid2semid
parameter_list|(
name|struct
name|ibcs2_semid_ds
modifier|*
parameter_list|,
name|struct
name|semid_ds
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|cvt_shmid2ishmid
parameter_list|(
name|struct
name|shmid_ds
modifier|*
parameter_list|,
name|struct
name|ibcs2_shmid_ds
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|cvt_ishmid2shmid
parameter_list|(
name|struct
name|ibcs2_shmid_ds
modifier|*
parameter_list|,
name|struct
name|shmid_ds
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|cvt_perm2iperm
parameter_list|(
name|struct
name|ipc_perm
modifier|*
parameter_list|,
name|struct
name|ibcs2_ipc_perm
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|cvt_iperm2perm
parameter_list|(
name|struct
name|ibcs2_ipc_perm
modifier|*
parameter_list|,
name|struct
name|ipc_perm
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * iBCS2 msgsys call  */
end_comment

begin_function
specifier|static
name|void
name|cvt_msqid2imsqid
parameter_list|(
name|bp
parameter_list|,
name|ibp
parameter_list|)
name|struct
name|msqid_ds
modifier|*
name|bp
decl_stmt|;
name|struct
name|ibcs2_msqid_ds
modifier|*
name|ibp
decl_stmt|;
block|{
name|cvt_perm2iperm
argument_list|(
operator|&
name|bp
operator|->
name|msg_perm
argument_list|,
operator|&
name|ibp
operator|->
name|msg_perm
argument_list|)
expr_stmt|;
name|ibp
operator|->
name|msg_first
operator|=
name|bp
operator|->
name|msg_first
expr_stmt|;
name|ibp
operator|->
name|msg_last
operator|=
name|bp
operator|->
name|msg_last
expr_stmt|;
name|ibp
operator|->
name|msg_cbytes
operator|=
operator|(
name|u_short
operator|)
name|bp
operator|->
name|msg_cbytes
expr_stmt|;
name|ibp
operator|->
name|msg_qnum
operator|=
operator|(
name|u_short
operator|)
name|bp
operator|->
name|msg_qnum
expr_stmt|;
name|ibp
operator|->
name|msg_qbytes
operator|=
operator|(
name|u_short
operator|)
name|bp
operator|->
name|msg_qbytes
expr_stmt|;
name|ibp
operator|->
name|msg_lspid
operator|=
operator|(
name|u_short
operator|)
name|bp
operator|->
name|msg_lspid
expr_stmt|;
name|ibp
operator|->
name|msg_lrpid
operator|=
operator|(
name|u_short
operator|)
name|bp
operator|->
name|msg_lrpid
expr_stmt|;
name|ibp
operator|->
name|msg_stime
operator|=
name|bp
operator|->
name|msg_stime
expr_stmt|;
name|ibp
operator|->
name|msg_rtime
operator|=
name|bp
operator|->
name|msg_rtime
expr_stmt|;
name|ibp
operator|->
name|msg_ctime
operator|=
name|bp
operator|->
name|msg_ctime
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|cvt_imsqid2msqid
parameter_list|(
name|ibp
parameter_list|,
name|bp
parameter_list|)
name|struct
name|ibcs2_msqid_ds
modifier|*
name|ibp
decl_stmt|;
name|struct
name|msqid_ds
modifier|*
name|bp
decl_stmt|;
block|{
name|cvt_iperm2perm
argument_list|(
operator|&
name|ibp
operator|->
name|msg_perm
argument_list|,
operator|&
name|bp
operator|->
name|msg_perm
argument_list|)
expr_stmt|;
name|bp
operator|->
name|msg_first
operator|=
name|ibp
operator|->
name|msg_first
expr_stmt|;
name|bp
operator|->
name|msg_last
operator|=
name|ibp
operator|->
name|msg_last
expr_stmt|;
name|bp
operator|->
name|msg_cbytes
operator|=
name|ibp
operator|->
name|msg_cbytes
expr_stmt|;
name|bp
operator|->
name|msg_qnum
operator|=
name|ibp
operator|->
name|msg_qnum
expr_stmt|;
name|bp
operator|->
name|msg_qbytes
operator|=
name|ibp
operator|->
name|msg_qbytes
expr_stmt|;
name|bp
operator|->
name|msg_lspid
operator|=
name|ibp
operator|->
name|msg_lspid
expr_stmt|;
name|bp
operator|->
name|msg_lrpid
operator|=
name|ibp
operator|->
name|msg_lrpid
expr_stmt|;
name|bp
operator|->
name|msg_stime
operator|=
name|ibp
operator|->
name|msg_stime
expr_stmt|;
name|bp
operator|->
name|msg_rtime
operator|=
name|ibp
operator|->
name|msg_rtime
expr_stmt|;
name|bp
operator|->
name|msg_ctime
operator|=
name|ibp
operator|->
name|msg_ctime
expr_stmt|;
return|return;
block|}
end_function

begin_struct
struct|struct
name|ibcs2_msgget_args
block|{
name|int
name|what
decl_stmt|;
name|ibcs2_key_t
name|key
decl_stmt|;
name|int
name|msgflg
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|ibcs2_msgget
parameter_list|(
name|struct
name|thread
modifier|*
name|td
parameter_list|,
name|void
modifier|*
name|v
parameter_list|)
block|{
name|struct
name|ibcs2_msgget_args
modifier|*
name|uap
init|=
name|v
decl_stmt|;
name|struct
name|msgget_args
name|ap
decl_stmt|;
name|ap
operator|.
name|key
operator|=
name|uap
operator|->
name|key
expr_stmt|;
name|ap
operator|.
name|msgflg
operator|=
name|uap
operator|->
name|msgflg
expr_stmt|;
return|return
name|msgget
argument_list|(
name|td
argument_list|,
operator|&
name|ap
argument_list|)
return|;
block|}
end_function

begin_struct
struct|struct
name|ibcs2_msgctl_args
block|{
name|int
name|what
decl_stmt|;
name|int
name|msqid
decl_stmt|;
name|int
name|cmd
decl_stmt|;
name|struct
name|ibcs2_msqid_ds
modifier|*
name|buf
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|ibcs2_msgctl
parameter_list|(
name|struct
name|thread
modifier|*
name|td
parameter_list|,
name|void
modifier|*
name|v
parameter_list|)
block|{
name|struct
name|ibcs2_msgctl_args
modifier|*
name|uap
init|=
name|v
decl_stmt|;
name|struct
name|ibcs2_msqid_ds
name|is
decl_stmt|;
name|struct
name|msqid_ds
name|bs
decl_stmt|;
name|int
name|error
decl_stmt|;
switch|switch
condition|(
name|uap
operator|->
name|cmd
condition|)
block|{
case|case
name|IBCS2_IPC_STAT
case|:
name|error
operator|=
name|kern_msgctl
argument_list|(
name|td
argument_list|,
name|uap
operator|->
name|msqid
argument_list|,
name|IPC_STAT
argument_list|,
operator|&
name|bs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
block|{
name|cvt_msqid2imsqid
argument_list|(
operator|&
name|bs
argument_list|,
operator|&
name|is
argument_list|)
expr_stmt|;
name|error
operator|=
name|copyout
argument_list|(
operator|&
name|is
argument_list|,
name|uap
operator|->
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|is
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
case|case
name|IBCS2_IPC_SET
case|:
name|error
operator|=
name|copyin
argument_list|(
name|uap
operator|->
name|buf
argument_list|,
operator|&
name|is
argument_list|,
sizeof|sizeof
argument_list|(
name|is
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|cvt_imsqid2msqid
argument_list|(
operator|&
name|is
argument_list|,
operator|&
name|bs
argument_list|)
expr_stmt|;
return|return
operator|(
name|kern_msgctl
argument_list|(
name|td
argument_list|,
name|uap
operator|->
name|msqid
argument_list|,
name|IPC_SET
argument_list|,
operator|&
name|bs
argument_list|)
operator|)
return|;
case|case
name|IBCS2_IPC_RMID
case|:
return|return
operator|(
name|kern_msgctl
argument_list|(
name|td
argument_list|,
name|uap
operator|->
name|msqid
argument_list|,
name|IPC_RMID
argument_list|,
name|NULL
argument_list|)
operator|)
return|;
block|}
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
end_function

begin_struct
struct|struct
name|ibcs2_msgrcv_args
block|{
name|int
name|what
decl_stmt|;
name|int
name|msqid
decl_stmt|;
name|void
modifier|*
name|msgp
decl_stmt|;
name|size_t
name|msgsz
decl_stmt|;
name|long
name|msgtyp
decl_stmt|;
name|int
name|msgflg
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|ibcs2_msgrcv
parameter_list|(
name|struct
name|thread
modifier|*
name|td
parameter_list|,
name|void
modifier|*
name|v
parameter_list|)
block|{
name|struct
name|ibcs2_msgrcv_args
modifier|*
name|uap
init|=
name|v
decl_stmt|;
name|struct
name|msgrcv_args
name|ap
decl_stmt|;
name|ap
operator|.
name|msqid
operator|=
name|uap
operator|->
name|msqid
expr_stmt|;
name|ap
operator|.
name|msgp
operator|=
name|uap
operator|->
name|msgp
expr_stmt|;
name|ap
operator|.
name|msgsz
operator|=
name|uap
operator|->
name|msgsz
expr_stmt|;
name|ap
operator|.
name|msgtyp
operator|=
name|uap
operator|->
name|msgtyp
expr_stmt|;
name|ap
operator|.
name|msgflg
operator|=
name|uap
operator|->
name|msgflg
expr_stmt|;
return|return
operator|(
name|msgrcv
argument_list|(
name|td
argument_list|,
operator|&
name|ap
argument_list|)
operator|)
return|;
block|}
end_function

begin_struct
struct|struct
name|ibcs2_msgsnd_args
block|{
name|int
name|what
decl_stmt|;
name|int
name|msqid
decl_stmt|;
name|void
modifier|*
name|msgp
decl_stmt|;
name|size_t
name|msgsz
decl_stmt|;
name|int
name|msgflg
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|ibcs2_msgsnd
parameter_list|(
name|struct
name|thread
modifier|*
name|td
parameter_list|,
name|void
modifier|*
name|v
parameter_list|)
block|{
name|struct
name|ibcs2_msgsnd_args
modifier|*
name|uap
init|=
name|v
decl_stmt|;
name|struct
name|msgsnd_args
name|ap
decl_stmt|;
name|ap
operator|.
name|msqid
operator|=
name|uap
operator|->
name|msqid
expr_stmt|;
name|ap
operator|.
name|msgp
operator|=
name|uap
operator|->
name|msgp
expr_stmt|;
name|ap
operator|.
name|msgsz
operator|=
name|uap
operator|->
name|msgsz
expr_stmt|;
name|ap
operator|.
name|msgflg
operator|=
name|uap
operator|->
name|msgflg
expr_stmt|;
return|return
operator|(
name|msgsnd
argument_list|(
name|td
argument_list|,
operator|&
name|ap
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ibcs2_msgsys
parameter_list|(
name|td
parameter_list|,
name|uap
parameter_list|)
name|struct
name|thread
modifier|*
name|td
decl_stmt|;
name|struct
name|ibcs2_msgsys_args
modifier|*
name|uap
decl_stmt|;
block|{
switch|switch
condition|(
name|uap
operator|->
name|which
condition|)
block|{
case|case
literal|0
case|:
return|return
operator|(
name|ibcs2_msgget
argument_list|(
name|td
argument_list|,
name|uap
argument_list|)
operator|)
return|;
case|case
literal|1
case|:
return|return
operator|(
name|ibcs2_msgctl
argument_list|(
name|td
argument_list|,
name|uap
argument_list|)
operator|)
return|;
case|case
literal|2
case|:
return|return
operator|(
name|ibcs2_msgrcv
argument_list|(
name|td
argument_list|,
name|uap
argument_list|)
operator|)
return|;
case|case
literal|3
case|:
return|return
operator|(
name|ibcs2_msgsnd
argument_list|(
name|td
argument_list|,
name|uap
argument_list|)
operator|)
return|;
default|default:
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
block|}
end_function

begin_comment
comment|/*  * iBCS2 semsys call  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|unused
end_ifdef

begin_function
specifier|static
name|void
name|cvt_sem2isem
parameter_list|(
name|bp
parameter_list|,
name|ibp
parameter_list|)
name|struct
name|sem
modifier|*
name|bp
decl_stmt|;
name|struct
name|ibcs2_sem
modifier|*
name|ibp
decl_stmt|;
block|{
name|ibp
operator|->
name|semval
operator|=
name|bp
operator|->
name|semval
expr_stmt|;
name|ibp
operator|->
name|sempid
operator|=
name|bp
operator|->
name|sempid
expr_stmt|;
name|ibp
operator|->
name|semncnt
operator|=
name|bp
operator|->
name|semncnt
expr_stmt|;
name|ibp
operator|->
name|semzcnt
operator|=
name|bp
operator|->
name|semzcnt
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|cvt_isem2sem
parameter_list|(
name|ibp
parameter_list|,
name|bp
parameter_list|)
name|struct
name|ibcs2_sem
modifier|*
name|ibp
decl_stmt|;
name|struct
name|sem
modifier|*
name|bp
decl_stmt|;
block|{
name|bp
operator|->
name|semval
operator|=
name|ibp
operator|->
name|semval
expr_stmt|;
name|bp
operator|->
name|sempid
operator|=
name|ibp
operator|->
name|sempid
expr_stmt|;
name|bp
operator|->
name|semncnt
operator|=
name|ibp
operator|->
name|semncnt
expr_stmt|;
name|bp
operator|->
name|semzcnt
operator|=
name|ibp
operator|->
name|semzcnt
expr_stmt|;
return|return;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|void
name|cvt_iperm2perm
parameter_list|(
name|ipp
parameter_list|,
name|pp
parameter_list|)
name|struct
name|ibcs2_ipc_perm
modifier|*
name|ipp
decl_stmt|;
name|struct
name|ipc_perm
modifier|*
name|pp
decl_stmt|;
block|{
name|pp
operator|->
name|uid
operator|=
name|ipp
operator|->
name|uid
expr_stmt|;
name|pp
operator|->
name|gid
operator|=
name|ipp
operator|->
name|gid
expr_stmt|;
name|pp
operator|->
name|cuid
operator|=
name|ipp
operator|->
name|cuid
expr_stmt|;
name|pp
operator|->
name|cgid
operator|=
name|ipp
operator|->
name|cgid
expr_stmt|;
name|pp
operator|->
name|mode
operator|=
name|ipp
operator|->
name|mode
expr_stmt|;
name|pp
operator|->
name|seq
operator|=
name|ipp
operator|->
name|seq
expr_stmt|;
name|pp
operator|->
name|key
operator|=
name|ipp
operator|->
name|key
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|cvt_perm2iperm
parameter_list|(
name|pp
parameter_list|,
name|ipp
parameter_list|)
name|struct
name|ipc_perm
modifier|*
name|pp
decl_stmt|;
name|struct
name|ibcs2_ipc_perm
modifier|*
name|ipp
decl_stmt|;
block|{
name|ipp
operator|->
name|uid
operator|=
name|pp
operator|->
name|uid
expr_stmt|;
name|ipp
operator|->
name|gid
operator|=
name|pp
operator|->
name|gid
expr_stmt|;
name|ipp
operator|->
name|cuid
operator|=
name|pp
operator|->
name|cuid
expr_stmt|;
name|ipp
operator|->
name|cgid
operator|=
name|pp
operator|->
name|cgid
expr_stmt|;
name|ipp
operator|->
name|mode
operator|=
name|pp
operator|->
name|mode
expr_stmt|;
name|ipp
operator|->
name|seq
operator|=
name|pp
operator|->
name|seq
expr_stmt|;
name|ipp
operator|->
name|key
operator|=
name|pp
operator|->
name|key
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|cvt_semid2isemid
parameter_list|(
name|bp
parameter_list|,
name|ibp
parameter_list|)
name|struct
name|semid_ds
modifier|*
name|bp
decl_stmt|;
name|struct
name|ibcs2_semid_ds
modifier|*
name|ibp
decl_stmt|;
block|{
name|cvt_perm2iperm
argument_list|(
operator|&
name|bp
operator|->
name|sem_perm
argument_list|,
operator|&
name|ibp
operator|->
name|sem_perm
argument_list|)
expr_stmt|;
name|ibp
operator|->
name|sem_base
operator|=
operator|(
expr|struct
name|ibcs2_sem
operator|*
operator|)
name|bp
operator|->
name|sem_base
expr_stmt|;
name|ibp
operator|->
name|sem_nsems
operator|=
name|bp
operator|->
name|sem_nsems
expr_stmt|;
name|ibp
operator|->
name|sem_otime
operator|=
name|bp
operator|->
name|sem_otime
expr_stmt|;
name|ibp
operator|->
name|sem_ctime
operator|=
name|bp
operator|->
name|sem_ctime
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|cvt_isemid2semid
parameter_list|(
name|ibp
parameter_list|,
name|bp
parameter_list|)
name|struct
name|ibcs2_semid_ds
modifier|*
name|ibp
decl_stmt|;
name|struct
name|semid_ds
modifier|*
name|bp
decl_stmt|;
block|{
name|cvt_iperm2perm
argument_list|(
operator|&
name|ibp
operator|->
name|sem_perm
argument_list|,
operator|&
name|bp
operator|->
name|sem_perm
argument_list|)
expr_stmt|;
name|bp
operator|->
name|sem_base
operator|=
operator|(
expr|struct
name|sem
operator|*
operator|)
name|ibp
operator|->
name|sem_base
expr_stmt|;
name|bp
operator|->
name|sem_nsems
operator|=
name|ibp
operator|->
name|sem_nsems
expr_stmt|;
name|bp
operator|->
name|sem_otime
operator|=
name|ibp
operator|->
name|sem_otime
expr_stmt|;
name|bp
operator|->
name|sem_ctime
operator|=
name|ibp
operator|->
name|sem_ctime
expr_stmt|;
return|return;
block|}
end_function

begin_struct
struct|struct
name|ibcs2_semctl_args
block|{
name|int
name|what
decl_stmt|;
name|int
name|semid
decl_stmt|;
name|int
name|semnum
decl_stmt|;
name|int
name|cmd
decl_stmt|;
name|union
name|semun
name|arg
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|ibcs2_semctl
parameter_list|(
name|struct
name|thread
modifier|*
name|td
parameter_list|,
name|void
modifier|*
name|v
parameter_list|)
block|{
name|struct
name|ibcs2_semctl_args
modifier|*
name|uap
init|=
name|v
decl_stmt|;
name|struct
name|ibcs2_semid_ds
name|is
decl_stmt|;
name|struct
name|semid_ds
name|bs
decl_stmt|;
name|union
name|semun
name|semun
decl_stmt|;
name|register_t
name|rval
decl_stmt|;
name|int
name|error
decl_stmt|;
switch|switch
condition|(
name|uap
operator|->
name|cmd
condition|)
block|{
case|case
name|IBCS2_IPC_STAT
case|:
name|semun
operator|.
name|buf
operator|=
operator|&
name|bs
expr_stmt|;
name|error
operator|=
name|kern_semctl
argument_list|(
name|td
argument_list|,
name|uap
operator|->
name|semid
argument_list|,
name|uap
operator|->
name|semnum
argument_list|,
name|IPC_STAT
argument_list|,
operator|&
name|semun
argument_list|,
operator|&
name|rval
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|cvt_semid2isemid
argument_list|(
operator|&
name|bs
argument_list|,
operator|&
name|is
argument_list|)
expr_stmt|;
name|error
operator|=
name|copyout
argument_list|(
operator|&
name|is
argument_list|,
name|uap
operator|->
name|arg
operator|.
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|is
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|td
operator|->
name|td_retval
index|[
literal|0
index|]
operator|=
name|rval
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
case|case
name|IBCS2_IPC_SET
case|:
name|error
operator|=
name|copyin
argument_list|(
name|uap
operator|->
name|arg
operator|.
name|buf
argument_list|,
operator|&
name|is
argument_list|,
sizeof|sizeof
argument_list|(
name|is
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|cvt_isemid2semid
argument_list|(
operator|&
name|is
argument_list|,
operator|&
name|bs
argument_list|)
expr_stmt|;
name|semun
operator|.
name|buf
operator|=
operator|&
name|bs
expr_stmt|;
return|return
operator|(
name|kern_semctl
argument_list|(
name|td
argument_list|,
name|uap
operator|->
name|semid
argument_list|,
name|uap
operator|->
name|semnum
argument_list|,
name|IPC_SET
argument_list|,
operator|&
name|semun
argument_list|,
name|td
operator|->
name|td_retval
argument_list|)
operator|)
return|;
block|}
return|return
operator|(
name|kern_semctl
argument_list|(
name|td
argument_list|,
name|uap
operator|->
name|semid
argument_list|,
name|uap
operator|->
name|semnum
argument_list|,
name|uap
operator|->
name|cmd
argument_list|,
operator|&
name|uap
operator|->
name|arg
argument_list|,
name|td
operator|->
name|td_retval
argument_list|)
operator|)
return|;
block|}
end_function

begin_struct
struct|struct
name|ibcs2_semget_args
block|{
name|int
name|what
decl_stmt|;
name|ibcs2_key_t
name|key
decl_stmt|;
name|int
name|nsems
decl_stmt|;
name|int
name|semflg
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|ibcs2_semget
parameter_list|(
name|struct
name|thread
modifier|*
name|td
parameter_list|,
name|void
modifier|*
name|v
parameter_list|)
block|{
name|struct
name|ibcs2_semget_args
modifier|*
name|uap
init|=
name|v
decl_stmt|;
name|struct
name|semget_args
name|ap
decl_stmt|;
name|ap
operator|.
name|key
operator|=
name|uap
operator|->
name|key
expr_stmt|;
name|ap
operator|.
name|nsems
operator|=
name|uap
operator|->
name|nsems
expr_stmt|;
name|ap
operator|.
name|semflg
operator|=
name|uap
operator|->
name|semflg
expr_stmt|;
return|return
operator|(
name|semget
argument_list|(
name|td
argument_list|,
operator|&
name|ap
argument_list|)
operator|)
return|;
block|}
end_function

begin_struct
struct|struct
name|ibcs2_semop_args
block|{
name|int
name|what
decl_stmt|;
name|int
name|semid
decl_stmt|;
name|struct
name|sembuf
modifier|*
name|sops
decl_stmt|;
name|size_t
name|nsops
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|ibcs2_semop
parameter_list|(
name|struct
name|thread
modifier|*
name|td
parameter_list|,
name|void
modifier|*
name|v
parameter_list|)
block|{
name|struct
name|ibcs2_semop_args
modifier|*
name|uap
init|=
name|v
decl_stmt|;
name|struct
name|semop_args
name|ap
decl_stmt|;
name|ap
operator|.
name|semid
operator|=
name|uap
operator|->
name|semid
expr_stmt|;
name|ap
operator|.
name|sops
operator|=
name|uap
operator|->
name|sops
expr_stmt|;
name|ap
operator|.
name|nsops
operator|=
name|uap
operator|->
name|nsops
expr_stmt|;
return|return
operator|(
name|semop
argument_list|(
name|td
argument_list|,
operator|&
name|ap
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ibcs2_semsys
parameter_list|(
name|td
parameter_list|,
name|uap
parameter_list|)
name|struct
name|thread
modifier|*
name|td
decl_stmt|;
name|struct
name|ibcs2_semsys_args
modifier|*
name|uap
decl_stmt|;
block|{
switch|switch
condition|(
name|uap
operator|->
name|which
condition|)
block|{
case|case
literal|0
case|:
return|return
operator|(
name|ibcs2_semctl
argument_list|(
name|td
argument_list|,
name|uap
argument_list|)
operator|)
return|;
case|case
literal|1
case|:
return|return
operator|(
name|ibcs2_semget
argument_list|(
name|td
argument_list|,
name|uap
argument_list|)
operator|)
return|;
case|case
literal|2
case|:
return|return
operator|(
name|ibcs2_semop
argument_list|(
name|td
argument_list|,
name|uap
argument_list|)
operator|)
return|;
block|}
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * iBCS2 shmsys call  */
end_comment

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|ibcs2
argument_list|,
name|sysvmsg
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|ibcs2
argument_list|,
name|sysvsem
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|ibcs2
argument_list|,
name|sysvshm
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|void
name|cvt_shmid2ishmid
parameter_list|(
name|bp
parameter_list|,
name|ibp
parameter_list|)
name|struct
name|shmid_ds
modifier|*
name|bp
decl_stmt|;
name|struct
name|ibcs2_shmid_ds
modifier|*
name|ibp
decl_stmt|;
block|{
name|cvt_perm2iperm
argument_list|(
operator|&
name|bp
operator|->
name|shm_perm
argument_list|,
operator|&
name|ibp
operator|->
name|shm_perm
argument_list|)
expr_stmt|;
name|ibp
operator|->
name|shm_segsz
operator|=
name|bp
operator|->
name|shm_segsz
expr_stmt|;
name|ibp
operator|->
name|shm_lpid
operator|=
name|bp
operator|->
name|shm_lpid
expr_stmt|;
name|ibp
operator|->
name|shm_cpid
operator|=
name|bp
operator|->
name|shm_cpid
expr_stmt|;
name|ibp
operator|->
name|shm_nattch
operator|=
name|bp
operator|->
name|shm_nattch
expr_stmt|;
name|ibp
operator|->
name|shm_cnattch
operator|=
literal|0
expr_stmt|;
comment|/* ignored anyway */
name|ibp
operator|->
name|shm_atime
operator|=
name|bp
operator|->
name|shm_atime
expr_stmt|;
name|ibp
operator|->
name|shm_dtime
operator|=
name|bp
operator|->
name|shm_dtime
expr_stmt|;
name|ibp
operator|->
name|shm_ctime
operator|=
name|bp
operator|->
name|shm_ctime
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|cvt_ishmid2shmid
parameter_list|(
name|ibp
parameter_list|,
name|bp
parameter_list|)
name|struct
name|ibcs2_shmid_ds
modifier|*
name|ibp
decl_stmt|;
name|struct
name|shmid_ds
modifier|*
name|bp
decl_stmt|;
block|{
name|cvt_iperm2perm
argument_list|(
operator|&
name|ibp
operator|->
name|shm_perm
argument_list|,
operator|&
name|bp
operator|->
name|shm_perm
argument_list|)
expr_stmt|;
name|bp
operator|->
name|shm_segsz
operator|=
name|ibp
operator|->
name|shm_segsz
expr_stmt|;
name|bp
operator|->
name|shm_lpid
operator|=
name|ibp
operator|->
name|shm_lpid
expr_stmt|;
name|bp
operator|->
name|shm_cpid
operator|=
name|ibp
operator|->
name|shm_cpid
expr_stmt|;
name|bp
operator|->
name|shm_nattch
operator|=
name|ibp
operator|->
name|shm_nattch
expr_stmt|;
name|bp
operator|->
name|shm_atime
operator|=
name|ibp
operator|->
name|shm_atime
expr_stmt|;
name|bp
operator|->
name|shm_dtime
operator|=
name|ibp
operator|->
name|shm_dtime
expr_stmt|;
name|bp
operator|->
name|shm_ctime
operator|=
name|ibp
operator|->
name|shm_ctime
expr_stmt|;
name|bp
operator|->
name|shm_internal
operator|=
operator|(
name|void
operator|*
operator|)
literal|0
expr_stmt|;
comment|/* ignored anyway */
return|return;
block|}
end_function

begin_struct
struct|struct
name|ibcs2_shmat_args
block|{
name|int
name|what
decl_stmt|;
name|int
name|shmid
decl_stmt|;
specifier|const
name|void
modifier|*
name|shmaddr
decl_stmt|;
name|int
name|shmflg
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|ibcs2_shmat
parameter_list|(
name|struct
name|thread
modifier|*
name|td
parameter_list|,
name|void
modifier|*
name|v
parameter_list|)
block|{
name|struct
name|ibcs2_shmat_args
modifier|*
name|uap
init|=
name|v
decl_stmt|;
name|struct
name|shmat_args
name|ap
decl_stmt|;
name|ap
operator|.
name|shmid
operator|=
name|uap
operator|->
name|shmid
expr_stmt|;
name|ap
operator|.
name|shmaddr
operator|=
name|uap
operator|->
name|shmaddr
expr_stmt|;
name|ap
operator|.
name|shmflg
operator|=
name|uap
operator|->
name|shmflg
expr_stmt|;
return|return
operator|(
name|shmat
argument_list|(
name|td
argument_list|,
operator|&
name|ap
argument_list|)
operator|)
return|;
block|}
end_function

begin_struct
struct|struct
name|ibcs2_shmctl_args
block|{
name|int
name|what
decl_stmt|;
name|int
name|shmid
decl_stmt|;
name|int
name|cmd
decl_stmt|;
name|struct
name|ibcs2_shmid_ds
modifier|*
name|buf
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|ibcs2_shmctl
parameter_list|(
name|struct
name|thread
modifier|*
name|td
parameter_list|,
name|void
modifier|*
name|v
parameter_list|)
block|{
name|struct
name|ibcs2_shmctl_args
modifier|*
name|uap
init|=
name|v
decl_stmt|;
name|struct
name|ibcs2_shmid_ds
name|is
decl_stmt|;
name|struct
name|shmid_ds
name|bs
decl_stmt|;
name|int
name|error
decl_stmt|;
switch|switch
condition|(
name|uap
operator|->
name|cmd
condition|)
block|{
case|case
name|IBCS2_IPC_STAT
case|:
name|error
operator|=
name|kern_shmctl
argument_list|(
name|td
argument_list|,
name|uap
operator|->
name|shmid
argument_list|,
name|IPC_STAT
argument_list|,
operator|&
name|bs
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|cvt_shmid2ishmid
argument_list|(
operator|&
name|bs
argument_list|,
operator|&
name|is
argument_list|)
expr_stmt|;
return|return
operator|(
name|copyout
argument_list|(
operator|&
name|is
argument_list|,
name|uap
operator|->
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|is
argument_list|)
argument_list|)
operator|)
return|;
case|case
name|IBCS2_IPC_SET
case|:
name|error
operator|=
name|copyin
argument_list|(
name|uap
operator|->
name|buf
argument_list|,
operator|&
name|is
argument_list|,
sizeof|sizeof
argument_list|(
name|is
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|cvt_ishmid2shmid
argument_list|(
operator|&
name|is
argument_list|,
operator|&
name|bs
argument_list|)
expr_stmt|;
return|return
operator|(
name|kern_shmctl
argument_list|(
name|td
argument_list|,
name|uap
operator|->
name|shmid
argument_list|,
name|IPC_SET
argument_list|,
operator|&
name|bs
argument_list|,
name|NULL
argument_list|)
operator|)
return|;
case|case
name|IPC_INFO
case|:
case|case
name|SHM_INFO
case|:
case|case
name|SHM_STAT
case|:
comment|/* XXX: */
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
return|return
operator|(
name|kern_shmctl
argument_list|(
name|td
argument_list|,
name|uap
operator|->
name|shmid
argument_list|,
name|uap
operator|->
name|cmd
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|)
return|;
block|}
end_function

begin_struct
struct|struct
name|ibcs2_shmdt_args
block|{
name|int
name|what
decl_stmt|;
specifier|const
name|void
modifier|*
name|shmaddr
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|ibcs2_shmdt
parameter_list|(
name|struct
name|thread
modifier|*
name|td
parameter_list|,
name|void
modifier|*
name|v
parameter_list|)
block|{
name|struct
name|ibcs2_shmdt_args
modifier|*
name|uap
init|=
name|v
decl_stmt|;
name|struct
name|shmdt_args
name|ap
decl_stmt|;
name|ap
operator|.
name|shmaddr
operator|=
name|uap
operator|->
name|shmaddr
expr_stmt|;
return|return
operator|(
name|shmdt
argument_list|(
name|td
argument_list|,
operator|&
name|ap
argument_list|)
operator|)
return|;
block|}
end_function

begin_struct
struct|struct
name|ibcs2_shmget_args
block|{
name|int
name|what
decl_stmt|;
name|ibcs2_key_t
name|key
decl_stmt|;
name|size_t
name|size
decl_stmt|;
name|int
name|shmflg
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|ibcs2_shmget
parameter_list|(
name|struct
name|thread
modifier|*
name|td
parameter_list|,
name|void
modifier|*
name|v
parameter_list|)
block|{
name|struct
name|ibcs2_shmget_args
modifier|*
name|uap
init|=
name|v
decl_stmt|;
name|struct
name|shmget_args
name|ap
decl_stmt|;
name|ap
operator|.
name|key
operator|=
name|uap
operator|->
name|key
expr_stmt|;
name|ap
operator|.
name|size
operator|=
name|uap
operator|->
name|size
expr_stmt|;
name|ap
operator|.
name|shmflg
operator|=
name|uap
operator|->
name|shmflg
expr_stmt|;
return|return
operator|(
name|shmget
argument_list|(
name|td
argument_list|,
operator|&
name|ap
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ibcs2_shmsys
parameter_list|(
name|td
parameter_list|,
name|uap
parameter_list|)
name|struct
name|thread
modifier|*
name|td
decl_stmt|;
name|struct
name|ibcs2_shmsys_args
modifier|*
name|uap
decl_stmt|;
block|{
switch|switch
condition|(
name|uap
operator|->
name|which
condition|)
block|{
case|case
literal|0
case|:
return|return
operator|(
name|ibcs2_shmat
argument_list|(
name|td
argument_list|,
name|uap
argument_list|)
operator|)
return|;
case|case
literal|1
case|:
return|return
operator|(
name|ibcs2_shmctl
argument_list|(
name|td
argument_list|,
name|uap
argument_list|)
operator|)
return|;
case|case
literal|2
case|:
return|return
operator|(
name|ibcs2_shmdt
argument_list|(
name|td
argument_list|,
name|uap
argument_list|)
operator|)
return|;
case|case
literal|3
case|:
return|return
operator|(
name|ibcs2_shmget
argument_list|(
name|td
argument_list|,
name|uap
argument_list|)
operator|)
return|;
block|}
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
end_function

end_unit


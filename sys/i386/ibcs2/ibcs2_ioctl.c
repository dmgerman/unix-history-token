begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 1994 SÃ¸ren Schmidt  * Copyright (c) 1994 Sean Eric Fagan  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer  *    in this position and unchanged.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. The name of the author may not be used to endorse or promote products  *    derived from this software withough specific prior written permission  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  *  *	$Id: ibcs2_ioctl.c,v 1.13 1994/10/12 20:28:06 sos Exp $  */
end_comment

begin_include
include|#
directive|include
file|<i386/ibcs2/ibcs2.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl_compat.h>
end_include

begin_include
include|#
directive|include
file|<sys/file.h>
end_include

begin_include
include|#
directive|include
file|<sys/filedesc.h>
end_include

begin_include
include|#
directive|include
file|<sys/tty.h>
end_include

begin_include
include|#
directive|include
file|<sys/termios.h>
end_include

begin_include
include|#
directive|include
file|<machine/console.h>
end_include

begin_struct
struct|struct
name|ibcs2_termio
block|{
name|unsigned
name|short
name|c_iflag
decl_stmt|;
name|unsigned
name|short
name|c_oflag
decl_stmt|;
name|unsigned
name|short
name|c_cflag
decl_stmt|;
name|unsigned
name|short
name|c_lflag
decl_stmt|;
name|char
name|c_line
decl_stmt|;
name|unsigned
name|char
name|c_cc
index|[
name|IBCS2_NCC
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|ibcs2_termios
block|{
name|unsigned
name|short
name|c_iflag
decl_stmt|;
name|unsigned
name|short
name|c_oflag
decl_stmt|;
name|unsigned
name|short
name|c_cflag
decl_stmt|;
name|unsigned
name|short
name|c_lflag
decl_stmt|;
name|char
name|c_line
decl_stmt|;
name|unsigned
name|char
name|c_cc
index|[
name|IBCS2_NCCS
index|]
decl_stmt|;
name|char
name|c_ispeed
decl_stmt|;
name|char
name|c_ospeed
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|ibcs2_winsize
block|{
name|char
name|bytex
decl_stmt|,
name|bytey
decl_stmt|;
name|short
name|bitx
decl_stmt|,
name|bity
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|struct
name|speedtab
name|sptab
index|[]
init|=
block|{
block|{
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|50
block|,
literal|1
block|}
block|,
block|{
literal|75
block|,
literal|2
block|}
block|,
block|{
literal|110
block|,
literal|3
block|}
block|,
block|{
literal|134
block|,
literal|4
block|}
block|,
block|{
literal|135
block|,
literal|4
block|}
block|,
block|{
literal|150
block|,
literal|5
block|}
block|,
block|{
literal|200
block|,
literal|6
block|}
block|,
block|{
literal|300
block|,
literal|7
block|}
block|,
block|{
literal|600
block|,
literal|8
block|}
block|,
block|{
literal|1200
block|,
literal|9
block|}
block|,
block|{
literal|1800
block|,
literal|10
block|}
block|,
block|{
literal|2400
block|,
literal|11
block|}
block|,
block|{
literal|4800
block|,
literal|12
block|}
block|,
block|{
literal|9600
block|,
literal|13
block|}
block|,
block|{
literal|19200
block|,
literal|14
block|}
block|,
block|{
literal|38400
block|,
literal|15
block|}
block|,
block|{
literal|57600
block|,
literal|15
block|}
block|,
block|{
literal|115200
block|,
literal|15
block|}
block|,
block|{
operator|-
literal|1
block|,
operator|-
literal|1
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|ibcs2_to_bsd_speed
parameter_list|(
name|int
name|code
parameter_list|,
name|struct
name|speedtab
modifier|*
name|table
parameter_list|)
block|{
for|for
control|(
init|;
name|table
operator|->
name|sp_code
operator|!=
operator|-
literal|1
condition|;
name|table
operator|++
control|)
if|if
condition|(
name|table
operator|->
name|sp_code
operator|==
name|code
condition|)
return|return
operator|(
name|table
operator|->
name|sp_speed
operator|)
return|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bsd_to_ibcs2_speed
parameter_list|(
name|int
name|speed
parameter_list|,
name|struct
name|speedtab
modifier|*
name|table
parameter_list|)
block|{
for|for
control|(
init|;
name|table
operator|->
name|sp_speed
operator|!=
operator|-
literal|1
condition|;
name|table
operator|++
control|)
if|if
condition|(
name|table
operator|->
name|sp_speed
operator|==
name|speed
condition|)
return|return
operator|(
name|table
operator|->
name|sp_code
operator|)
return|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bsd_termios_to_ibcs2_termio
parameter_list|(
name|struct
name|termios
modifier|*
name|bsd_termios
parameter_list|,
name|struct
name|ibcs2_termio
modifier|*
name|ibcs2_termio
parameter_list|)
block|{
name|int
name|speed
decl_stmt|;
if|if
condition|(
name|ibcs2_trace
operator|&
name|IBCS2_TRACE_IOCTLCNV
condition|)
block|{
name|int
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"IBCS2: BSD termios structure (input):\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"i=%08x o=%08x c=%08x l=%08x ispeed=%d ospeed=%d\n"
argument_list|,
name|bsd_termios
operator|->
name|c_iflag
argument_list|,
name|bsd_termios
operator|->
name|c_oflag
argument_list|,
name|bsd_termios
operator|->
name|c_cflag
argument_list|,
name|bsd_termios
operator|->
name|c_lflag
argument_list|,
name|bsd_termios
operator|->
name|c_ispeed
argument_list|,
name|bsd_termios
operator|->
name|c_ospeed
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"c_cc "
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NCCS
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"%02x "
argument_list|,
name|bsd_termios
operator|->
name|c_cc
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|ibcs2_termio
operator|->
name|c_iflag
operator|=
name|bsd_termios
operator|->
name|c_iflag
operator|&
operator|(
name|IGNBRK
operator||
name|BRKINT
operator||
name|IGNPAR
operator||
name|PARMRK
operator||
name|INPCK
operator||
name|ISTRIP
operator||
name|INLCR
operator||
name|IGNCR
operator||
name|ICRNL
operator||
name|IXANY
operator|)
expr_stmt|;
if|if
condition|(
name|bsd_termios
operator|->
name|c_iflag
operator|&
name|IXON
condition|)
name|ibcs2_termio
operator|->
name|c_iflag
operator||=
name|IBCS2_IXON
expr_stmt|;
if|if
condition|(
name|bsd_termios
operator|->
name|c_iflag
operator|&
name|IXOFF
condition|)
name|ibcs2_termio
operator|->
name|c_iflag
operator||=
name|IBCS2_IXOFF
expr_stmt|;
name|ibcs2_termio
operator|->
name|c_oflag
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|bsd_termios
operator|->
name|c_oflag
operator|&
name|OPOST
condition|)
name|ibcs2_termio
operator|->
name|c_oflag
operator||=
name|IBCS2_OPOST
expr_stmt|;
if|if
condition|(
name|bsd_termios
operator|->
name|c_oflag
operator|&
name|ONLCR
condition|)
name|ibcs2_termio
operator|->
name|c_oflag
operator||=
name|IBCS2_ONLCR
expr_stmt|;
if|if
condition|(
name|bsd_termios
operator|->
name|c_oflag
operator|&
name|OXTABS
condition|)
name|ibcs2_termio
operator|->
name|c_oflag
operator||=
operator|(
name|IBCS2_TAB1
operator||
name|IBCS2_TAB2
operator|)
expr_stmt|;
name|speed
operator|=
name|bsd_to_ibcs2_speed
argument_list|(
name|bsd_termios
operator|->
name|c_ospeed
argument_list|,
name|sptab
argument_list|)
expr_stmt|;
name|ibcs2_termio
operator|->
name|c_cflag
operator|=
name|speed
operator|>=
literal|0
condition|?
name|speed
else|:
literal|0
expr_stmt|;
name|ibcs2_termio
operator|->
name|c_cflag
operator||=
operator|(
name|bsd_termios
operator|->
name|c_cflag
operator|&
name|CSIZE
operator|)
operator|>>
literal|4
expr_stmt|;
comment|/* XXX */
if|if
condition|(
name|bsd_termios
operator|->
name|c_cflag
operator|&
name|CSTOPB
condition|)
name|ibcs2_termio
operator|->
name|c_cflag
operator||=
name|IBCS2_CSTOPB
expr_stmt|;
if|if
condition|(
name|bsd_termios
operator|->
name|c_cflag
operator|&
name|PARENB
condition|)
name|ibcs2_termio
operator|->
name|c_cflag
operator||=
name|IBCS2_PARENB
expr_stmt|;
if|if
condition|(
name|bsd_termios
operator|->
name|c_cflag
operator|&
name|PARODD
condition|)
name|ibcs2_termio
operator|->
name|c_cflag
operator||=
name|IBCS2_PARODD
expr_stmt|;
if|if
condition|(
name|bsd_termios
operator|->
name|c_cflag
operator|&
name|HUPCL
condition|)
name|ibcs2_termio
operator|->
name|c_cflag
operator||=
name|IBCS2_HUPCL
expr_stmt|;
if|if
condition|(
name|bsd_termios
operator|->
name|c_cflag
operator|&
name|CLOCAL
condition|)
name|ibcs2_termio
operator|->
name|c_cflag
operator||=
name|IBCS2_CLOCAL
expr_stmt|;
name|ibcs2_termio
operator|->
name|c_lflag
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|bsd_termios
operator|->
name|c_lflag
operator|&
name|ISIG
condition|)
name|ibcs2_termio
operator|->
name|c_lflag
operator||=
name|IBCS2_ISIG
expr_stmt|;
if|if
condition|(
name|bsd_termios
operator|->
name|c_lflag
operator|&
name|ICANON
condition|)
name|ibcs2_termio
operator|->
name|c_lflag
operator||=
name|IBCS2_ICANON
expr_stmt|;
if|if
condition|(
name|bsd_termios
operator|->
name|c_lflag
operator|&
name|ECHO
condition|)
name|ibcs2_termio
operator|->
name|c_lflag
operator||=
name|IBCS2_ECHO
expr_stmt|;
if|if
condition|(
name|bsd_termios
operator|->
name|c_lflag
operator|&
name|ECHOE
condition|)
name|ibcs2_termio
operator|->
name|c_lflag
operator||=
name|IBCS2_ECHOE
expr_stmt|;
if|if
condition|(
name|bsd_termios
operator|->
name|c_lflag
operator|&
name|ECHOK
condition|)
name|ibcs2_termio
operator|->
name|c_lflag
operator||=
name|IBCS2_ECHOK
expr_stmt|;
if|if
condition|(
name|bsd_termios
operator|->
name|c_lflag
operator|&
name|ECHONL
condition|)
name|ibcs2_termio
operator|->
name|c_lflag
operator||=
name|IBCS2_ECHONL
expr_stmt|;
if|if
condition|(
name|bsd_termios
operator|->
name|c_lflag
operator|&
name|NOFLSH
condition|)
name|ibcs2_termio
operator|->
name|c_lflag
operator||=
name|IBCS2_NOFLSH
expr_stmt|;
if|if
condition|(
name|bsd_termios
operator|->
name|c_lflag
operator|&
name|ECHOCTL
condition|)
name|ibcs2_termio
operator|->
name|c_lflag
operator||=
literal|0x0200
expr_stmt|;
comment|/* XXX */
if|if
condition|(
name|bsd_termios
operator|->
name|c_lflag
operator|&
name|ECHOPRT
condition|)
name|ibcs2_termio
operator|->
name|c_lflag
operator||=
literal|0x0400
expr_stmt|;
comment|/* XXX */
if|if
condition|(
name|bsd_termios
operator|->
name|c_lflag
operator|&
name|ECHOKE
condition|)
name|ibcs2_termio
operator|->
name|c_lflag
operator||=
literal|0x0800
expr_stmt|;
comment|/* XXX */
if|if
condition|(
name|bsd_termios
operator|->
name|c_lflag
operator|&
name|IEXTEN
condition|)
name|ibcs2_termio
operator|->
name|c_lflag
operator||=
literal|0x8000
expr_stmt|;
comment|/* XXX */
name|ibcs2_termio
operator|->
name|c_cc
index|[
name|IBCS2_VINTR
index|]
operator|=
name|bsd_termios
operator|->
name|c_cc
index|[
name|VINTR
index|]
expr_stmt|;
name|ibcs2_termio
operator|->
name|c_cc
index|[
name|IBCS2_VQUIT
index|]
operator|=
name|bsd_termios
operator|->
name|c_cc
index|[
name|VQUIT
index|]
expr_stmt|;
name|ibcs2_termio
operator|->
name|c_cc
index|[
name|IBCS2_VERASE
index|]
operator|=
name|bsd_termios
operator|->
name|c_cc
index|[
name|VERASE
index|]
expr_stmt|;
name|ibcs2_termio
operator|->
name|c_cc
index|[
name|IBCS2_VKILL
index|]
operator|=
name|bsd_termios
operator|->
name|c_cc
index|[
name|VKILL
index|]
expr_stmt|;
if|if
condition|(
name|bsd_termios
operator|->
name|c_lflag
operator|&
name|ICANON
condition|)
block|{
name|ibcs2_termio
operator|->
name|c_cc
index|[
name|IBCS2_VEOF
index|]
operator|=
name|bsd_termios
operator|->
name|c_cc
index|[
name|VEOF
index|]
expr_stmt|;
name|ibcs2_termio
operator|->
name|c_cc
index|[
name|IBCS2_VEOL
index|]
operator|=
name|bsd_termios
operator|->
name|c_cc
index|[
name|VEOL
index|]
expr_stmt|;
block|}
else|else
block|{
name|ibcs2_termio
operator|->
name|c_cc
index|[
name|IBCS2_VMIN
index|]
operator|=
name|bsd_termios
operator|->
name|c_cc
index|[
name|VMIN
index|]
expr_stmt|;
name|ibcs2_termio
operator|->
name|c_cc
index|[
name|IBCS2_VTIME
index|]
operator|=
name|bsd_termios
operator|->
name|c_cc
index|[
name|VTIME
index|]
expr_stmt|;
block|}
name|ibcs2_termio
operator|->
name|c_cc
index|[
name|IBCS2_VEOL2
index|]
operator|=
name|bsd_termios
operator|->
name|c_cc
index|[
name|VEOL2
index|]
expr_stmt|;
name|ibcs2_termio
operator|->
name|c_cc
index|[
name|IBCS2_VSWTCH
index|]
operator|=
literal|0xff
expr_stmt|;
name|ibcs2_termio
operator|->
name|c_line
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ibcs2_trace
operator|&
name|IBCS2_TRACE_IOCTLCNV
condition|)
block|{
name|int
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"IBCS2: IBCS2 termio structure (output):\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"i=%08x o=%08x c=%08x l=%08x speed=%d line=%d\n"
argument_list|,
name|ibcs2_termio
operator|->
name|c_iflag
argument_list|,
name|ibcs2_termio
operator|->
name|c_oflag
argument_list|,
name|ibcs2_termio
operator|->
name|c_cflag
argument_list|,
name|ibcs2_termio
operator|->
name|c_lflag
argument_list|,
name|ibcs2_to_bsd_speed
argument_list|(
name|ibcs2_termio
operator|->
name|c_cflag
operator|&
name|IBCS2_CBAUD
argument_list|,
name|sptab
argument_list|)
argument_list|,
name|ibcs2_termio
operator|->
name|c_line
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"c_cc "
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|IBCS2_NCC
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"%02x "
argument_list|,
name|ibcs2_termio
operator|->
name|c_cc
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ibcs2_termio_to_bsd_termios
parameter_list|(
name|struct
name|ibcs2_termio
modifier|*
name|ibcs2_termio
parameter_list|,
name|struct
name|termios
modifier|*
name|bsd_termios
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|speed
decl_stmt|;
if|if
condition|(
name|ibcs2_trace
operator|&
name|IBCS2_TRACE_IOCTLCNV
condition|)
block|{
name|int
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"IBCS2: IBCS2 termio structure (input):\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"i=%08x o=%08x c=%08x l=%08x speed=%d line=%d\n"
argument_list|,
name|ibcs2_termio
operator|->
name|c_iflag
argument_list|,
name|ibcs2_termio
operator|->
name|c_oflag
argument_list|,
name|ibcs2_termio
operator|->
name|c_cflag
argument_list|,
name|ibcs2_termio
operator|->
name|c_lflag
argument_list|,
name|ibcs2_to_bsd_speed
argument_list|(
name|ibcs2_termio
operator|->
name|c_cflag
operator|&
name|IBCS2_CBAUD
argument_list|,
name|sptab
argument_list|)
argument_list|,
name|ibcs2_termio
operator|->
name|c_line
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"c_cc "
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|IBCS2_NCC
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"%02x "
argument_list|,
name|ibcs2_termio
operator|->
name|c_cc
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|bsd_termios
operator|->
name|c_iflag
operator|=
name|ibcs2_termio
operator|->
name|c_iflag
operator|&
operator|(
name|IBCS2_IGNBRK
operator||
name|IBCS2_BRKINT
operator||
name|IBCS2_IGNPAR
operator||
name|IBCS2_PARMRK
operator||
name|IBCS2_INPCK
operator||
name|IBCS2_ISTRIP
operator||
name|IBCS2_INLCR
operator||
name|IBCS2_IGNCR
operator||
name|IBCS2_ICRNL
operator||
name|IBCS2_IXANY
operator|)
expr_stmt|;
if|if
condition|(
name|ibcs2_termio
operator|->
name|c_iflag
operator|&
name|IBCS2_IXON
condition|)
name|bsd_termios
operator|->
name|c_iflag
operator||=
name|IXON
expr_stmt|;
if|if
condition|(
name|ibcs2_termio
operator|->
name|c_iflag
operator|&
name|IBCS2_IXOFF
condition|)
name|bsd_termios
operator|->
name|c_iflag
operator||=
name|IXOFF
expr_stmt|;
name|bsd_termios
operator|->
name|c_oflag
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ibcs2_termio
operator|->
name|c_oflag
operator|&
name|IBCS2_OPOST
condition|)
name|bsd_termios
operator|->
name|c_oflag
operator||=
name|OPOST
expr_stmt|;
if|if
condition|(
name|ibcs2_termio
operator|->
name|c_oflag
operator|&
name|IBCS2_ONLCR
condition|)
name|bsd_termios
operator|->
name|c_oflag
operator||=
name|ONLCR
expr_stmt|;
if|if
condition|(
name|ibcs2_termio
operator|->
name|c_oflag
operator|&
operator|(
name|IBCS2_TAB1
operator||
name|IBCS2_TAB2
operator|)
condition|)
name|bsd_termios
operator|->
name|c_oflag
operator||=
name|OXTABS
expr_stmt|;
name|speed
operator|=
name|ibcs2_to_bsd_speed
argument_list|(
name|ibcs2_termio
operator|->
name|c_cflag
operator|&
name|IBCS2_CBAUD
argument_list|,
name|sptab
argument_list|)
expr_stmt|;
name|bsd_termios
operator|->
name|c_ospeed
operator|=
name|bsd_termios
operator|->
name|c_ispeed
operator|=
name|speed
operator|>=
literal|0
condition|?
name|speed
else|:
literal|0
expr_stmt|;
name|bsd_termios
operator|->
name|c_cflag
operator|=
operator|(
name|ibcs2_termio
operator|->
name|c_cflag
operator|&
name|IBCS2_CSIZE
operator|)
operator|<<
literal|4
expr_stmt|;
if|if
condition|(
name|ibcs2_termio
operator|->
name|c_cflag
operator|&
name|IBCS2_CSTOPB
condition|)
name|bsd_termios
operator|->
name|c_cflag
operator||=
name|CSTOPB
expr_stmt|;
if|if
condition|(
name|ibcs2_termio
operator|->
name|c_cflag
operator|&
name|IBCS2_PARENB
condition|)
name|bsd_termios
operator|->
name|c_cflag
operator||=
name|PARENB
expr_stmt|;
if|if
condition|(
name|ibcs2_termio
operator|->
name|c_cflag
operator|&
name|IBCS2_PARODD
condition|)
name|bsd_termios
operator|->
name|c_cflag
operator||=
name|PARODD
expr_stmt|;
if|if
condition|(
name|ibcs2_termio
operator|->
name|c_cflag
operator|&
name|IBCS2_HUPCL
condition|)
name|bsd_termios
operator|->
name|c_cflag
operator||=
name|HUPCL
expr_stmt|;
if|if
condition|(
name|ibcs2_termio
operator|->
name|c_cflag
operator|&
name|IBCS2_CLOCAL
condition|)
name|bsd_termios
operator|->
name|c_cflag
operator||=
name|CLOCAL
expr_stmt|;
name|bsd_termios
operator|->
name|c_lflag
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ibcs2_termio
operator|->
name|c_lflag
operator|&
name|IBCS2_ISIG
condition|)
name|bsd_termios
operator|->
name|c_lflag
operator||=
name|ISIG
expr_stmt|;
if|if
condition|(
name|ibcs2_termio
operator|->
name|c_lflag
operator|&
name|IBCS2_ICANON
condition|)
name|bsd_termios
operator|->
name|c_lflag
operator||=
name|ICANON
expr_stmt|;
if|if
condition|(
name|ibcs2_termio
operator|->
name|c_lflag
operator|&
name|IBCS2_ECHO
condition|)
name|bsd_termios
operator|->
name|c_lflag
operator||=
name|ECHO
expr_stmt|;
if|if
condition|(
name|ibcs2_termio
operator|->
name|c_lflag
operator|&
name|IBCS2_ECHOE
condition|)
name|bsd_termios
operator|->
name|c_lflag
operator||=
name|ECHOE
expr_stmt|;
if|if
condition|(
name|ibcs2_termio
operator|->
name|c_lflag
operator|&
name|IBCS2_ECHOK
condition|)
name|bsd_termios
operator|->
name|c_lflag
operator||=
name|ECHOK
expr_stmt|;
if|if
condition|(
name|ibcs2_termio
operator|->
name|c_lflag
operator|&
name|IBCS2_ECHONL
condition|)
name|bsd_termios
operator|->
name|c_lflag
operator||=
name|ECHONL
expr_stmt|;
if|if
condition|(
name|ibcs2_termio
operator|->
name|c_lflag
operator|&
name|IBCS2_NOFLSH
condition|)
name|bsd_termios
operator|->
name|c_lflag
operator||=
name|NOFLSH
expr_stmt|;
if|if
condition|(
name|ibcs2_termio
operator|->
name|c_lflag
operator|&
literal|0x0200
condition|)
comment|/* XXX */
name|bsd_termios
operator|->
name|c_lflag
operator||=
name|ECHOCTL
expr_stmt|;
if|if
condition|(
name|ibcs2_termio
operator|->
name|c_lflag
operator|&
literal|0x0400
condition|)
comment|/* XXX */
name|bsd_termios
operator|->
name|c_lflag
operator||=
name|ECHOPRT
expr_stmt|;
if|if
condition|(
name|ibcs2_termio
operator|->
name|c_lflag
operator|&
literal|0x0800
condition|)
comment|/* XXX */
name|bsd_termios
operator|->
name|c_lflag
operator||=
name|ECHOKE
expr_stmt|;
if|if
condition|(
name|ibcs2_termio
operator|->
name|c_lflag
operator|&
literal|0x8000
condition|)
comment|/* XXX */
name|bsd_termios
operator|->
name|c_lflag
operator||=
name|IEXTEN
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NCCS
condition|;
name|bsd_termios
operator|->
name|c_cc
index|[
name|i
operator|++
index|]
operator|=
literal|0
control|)
empty_stmt|;
name|bsd_termios
operator|->
name|c_cc
index|[
name|VINTR
index|]
operator|=
name|ibcs2_termio
operator|->
name|c_cc
index|[
name|IBCS2_VINTR
index|]
expr_stmt|;
name|bsd_termios
operator|->
name|c_cc
index|[
name|VQUIT
index|]
operator|=
name|ibcs2_termio
operator|->
name|c_cc
index|[
name|IBCS2_VQUIT
index|]
expr_stmt|;
name|bsd_termios
operator|->
name|c_cc
index|[
name|VERASE
index|]
operator|=
name|ibcs2_termio
operator|->
name|c_cc
index|[
name|IBCS2_VERASE
index|]
expr_stmt|;
name|bsd_termios
operator|->
name|c_cc
index|[
name|VKILL
index|]
operator|=
name|ibcs2_termio
operator|->
name|c_cc
index|[
name|IBCS2_VKILL
index|]
expr_stmt|;
if|if
condition|(
name|ibcs2_termio
operator|->
name|c_lflag
operator|&
name|IBCS2_ICANON
condition|)
block|{
name|bsd_termios
operator|->
name|c_cc
index|[
name|VEOF
index|]
operator|=
name|ibcs2_termio
operator|->
name|c_cc
index|[
name|IBCS2_VEOF
index|]
expr_stmt|;
name|bsd_termios
operator|->
name|c_cc
index|[
name|VEOL
index|]
operator|=
name|ibcs2_termio
operator|->
name|c_cc
index|[
name|IBCS2_VEOL
index|]
expr_stmt|;
block|}
else|else
block|{
name|bsd_termios
operator|->
name|c_cc
index|[
name|VMIN
index|]
operator|=
name|ibcs2_termio
operator|->
name|c_cc
index|[
name|IBCS2_VMIN
index|]
expr_stmt|;
name|bsd_termios
operator|->
name|c_cc
index|[
name|VTIME
index|]
operator|=
name|ibcs2_termio
operator|->
name|c_cc
index|[
name|IBCS2_VTIME
index|]
expr_stmt|;
block|}
name|bsd_termios
operator|->
name|c_cc
index|[
name|VEOL2
index|]
operator|=
name|ibcs2_termio
operator|->
name|c_cc
index|[
name|IBCS2_VEOL2
index|]
expr_stmt|;
if|if
condition|(
name|ibcs2_trace
operator|&
name|IBCS2_TRACE_IOCTLCNV
condition|)
block|{
name|int
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"IBCS2: BSD termios structure (output):\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"i=%08x o=%08x c=%08x l=%08x ispeed=%d ospeed=%d\n"
argument_list|,
name|bsd_termios
operator|->
name|c_iflag
argument_list|,
name|bsd_termios
operator|->
name|c_oflag
argument_list|,
name|bsd_termios
operator|->
name|c_cflag
argument_list|,
name|bsd_termios
operator|->
name|c_lflag
argument_list|,
name|bsd_termios
operator|->
name|c_ispeed
argument_list|,
name|bsd_termios
operator|->
name|c_ospeed
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"c_cc "
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NCCS
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"%02x "
argument_list|,
name|bsd_termios
operator|->
name|c_cc
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|bsd_to_ibcs2_termios
parameter_list|(
name|struct
name|termios
modifier|*
name|bsd_termios
parameter_list|,
name|struct
name|ibcs2_termios
modifier|*
name|ibcs2_termios
parameter_list|)
block|{
name|int
name|speed
decl_stmt|;
if|if
condition|(
name|ibcs2_trace
operator|&
name|IBCS2_TRACE_IOCTLCNV
condition|)
block|{
name|int
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"IBCS2: BSD termios structure (input):\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"i=%08x o=%08x c=%08x l=%08x ispeed=%d ospeed=%d\n"
argument_list|,
name|bsd_termios
operator|->
name|c_iflag
argument_list|,
name|bsd_termios
operator|->
name|c_oflag
argument_list|,
name|bsd_termios
operator|->
name|c_cflag
argument_list|,
name|bsd_termios
operator|->
name|c_lflag
argument_list|,
name|bsd_termios
operator|->
name|c_ispeed
argument_list|,
name|bsd_termios
operator|->
name|c_ospeed
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"c_cc "
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NCCS
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"%02x "
argument_list|,
name|bsd_termios
operator|->
name|c_cc
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|ibcs2_termios
operator|->
name|c_iflag
operator|=
name|bsd_termios
operator|->
name|c_iflag
operator|&
operator|(
name|IGNBRK
operator||
name|BRKINT
operator||
name|IGNPAR
operator||
name|PARMRK
operator||
name|INPCK
operator||
name|ISTRIP
operator||
name|INLCR
operator||
name|IGNCR
operator||
name|ICRNL
operator||
name|IXANY
operator|)
expr_stmt|;
if|if
condition|(
name|bsd_termios
operator|->
name|c_iflag
operator|&
name|IXON
condition|)
name|ibcs2_termios
operator|->
name|c_iflag
operator||=
name|IBCS2_IXON
expr_stmt|;
if|if
condition|(
name|bsd_termios
operator|->
name|c_iflag
operator|&
name|IXOFF
condition|)
name|ibcs2_termios
operator|->
name|c_iflag
operator||=
name|IBCS2_IXOFF
expr_stmt|;
name|ibcs2_termios
operator|->
name|c_oflag
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|bsd_termios
operator|->
name|c_oflag
operator|&
name|OPOST
condition|)
name|ibcs2_termios
operator|->
name|c_oflag
operator||=
name|IBCS2_OPOST
expr_stmt|;
if|if
condition|(
name|bsd_termios
operator|->
name|c_oflag
operator|&
name|ONLCR
condition|)
name|ibcs2_termios
operator|->
name|c_oflag
operator||=
name|IBCS2_ONLCR
expr_stmt|;
if|if
condition|(
name|bsd_termios
operator|->
name|c_oflag
operator|&
name|OXTABS
condition|)
name|ibcs2_termios
operator|->
name|c_oflag
operator||=
operator|(
name|IBCS2_TAB1
operator||
name|IBCS2_TAB2
operator|)
expr_stmt|;
name|ibcs2_termios
operator|->
name|c_cflag
operator|=
operator|(
name|bsd_termios
operator|->
name|c_cflag
operator|&
name|CSIZE
operator|)
operator|>>
literal|4
expr_stmt|;
comment|/* XXX */
if|if
condition|(
name|bsd_termios
operator|->
name|c_cflag
operator|&
name|CSTOPB
condition|)
name|ibcs2_termios
operator|->
name|c_cflag
operator||=
name|IBCS2_CSTOPB
expr_stmt|;
if|if
condition|(
name|bsd_termios
operator|->
name|c_cflag
operator|&
name|PARENB
condition|)
name|ibcs2_termios
operator|->
name|c_cflag
operator||=
name|IBCS2_PARENB
expr_stmt|;
if|if
condition|(
name|bsd_termios
operator|->
name|c_cflag
operator|&
name|PARODD
condition|)
name|ibcs2_termios
operator|->
name|c_cflag
operator||=
name|IBCS2_PARODD
expr_stmt|;
if|if
condition|(
name|bsd_termios
operator|->
name|c_cflag
operator|&
name|HUPCL
condition|)
name|ibcs2_termios
operator|->
name|c_cflag
operator||=
name|IBCS2_HUPCL
expr_stmt|;
if|if
condition|(
name|bsd_termios
operator|->
name|c_cflag
operator|&
name|CLOCAL
condition|)
name|ibcs2_termios
operator|->
name|c_cflag
operator||=
name|IBCS2_CLOCAL
expr_stmt|;
if|if
condition|(
name|bsd_termios
operator|->
name|c_cflag
operator|&
name|CRTSCTS
condition|)
name|ibcs2_termios
operator|->
name|c_cflag
operator||=
literal|0x8000
expr_stmt|;
comment|/* XXX */
name|ibcs2_termios
operator|->
name|c_lflag
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|bsd_termios
operator|->
name|c_lflag
operator|&
name|ISIG
condition|)
name|ibcs2_termios
operator|->
name|c_lflag
operator||=
name|IBCS2_ISIG
expr_stmt|;
if|if
condition|(
name|bsd_termios
operator|->
name|c_lflag
operator|&
name|ICANON
condition|)
name|ibcs2_termios
operator|->
name|c_lflag
operator||=
name|IBCS2_ICANON
expr_stmt|;
if|if
condition|(
name|bsd_termios
operator|->
name|c_lflag
operator|&
name|ECHO
condition|)
name|ibcs2_termios
operator|->
name|c_lflag
operator||=
name|IBCS2_ECHO
expr_stmt|;
if|if
condition|(
name|bsd_termios
operator|->
name|c_lflag
operator|&
name|ECHOE
condition|)
name|ibcs2_termios
operator|->
name|c_lflag
operator||=
name|IBCS2_ECHOE
expr_stmt|;
if|if
condition|(
name|bsd_termios
operator|->
name|c_lflag
operator|&
name|ECHOK
condition|)
name|ibcs2_termios
operator|->
name|c_lflag
operator||=
name|IBCS2_ECHOK
expr_stmt|;
if|if
condition|(
name|bsd_termios
operator|->
name|c_lflag
operator|&
name|ECHONL
condition|)
name|ibcs2_termios
operator|->
name|c_lflag
operator||=
name|IBCS2_ECHONL
expr_stmt|;
if|if
condition|(
name|bsd_termios
operator|->
name|c_lflag
operator|&
name|NOFLSH
condition|)
name|ibcs2_termios
operator|->
name|c_lflag
operator||=
name|IBCS2_NOFLSH
expr_stmt|;
if|if
condition|(
name|bsd_termios
operator|->
name|c_lflag
operator|&
name|ECHOCTL
condition|)
name|ibcs2_termios
operator|->
name|c_lflag
operator||=
literal|0x0200
expr_stmt|;
comment|/* XXX */
if|if
condition|(
name|bsd_termios
operator|->
name|c_lflag
operator|&
name|ECHOPRT
condition|)
name|ibcs2_termios
operator|->
name|c_lflag
operator||=
literal|0x0400
expr_stmt|;
comment|/* XXX */
if|if
condition|(
name|bsd_termios
operator|->
name|c_lflag
operator|&
name|ECHOKE
condition|)
name|ibcs2_termios
operator|->
name|c_lflag
operator||=
literal|0x0800
expr_stmt|;
comment|/* XXX */
if|if
condition|(
name|bsd_termios
operator|->
name|c_lflag
operator|&
name|IEXTEN
condition|)
name|ibcs2_termios
operator|->
name|c_lflag
operator||=
literal|0x8000
expr_stmt|;
comment|/* XXX */
name|ibcs2_termios
operator|->
name|c_cc
index|[
name|IBCS2_VINTR
index|]
operator|=
name|bsd_termios
operator|->
name|c_cc
index|[
name|VINTR
index|]
expr_stmt|;
name|ibcs2_termios
operator|->
name|c_cc
index|[
name|IBCS2_VQUIT
index|]
operator|=
name|bsd_termios
operator|->
name|c_cc
index|[
name|VQUIT
index|]
expr_stmt|;
name|ibcs2_termios
operator|->
name|c_cc
index|[
name|IBCS2_VERASE
index|]
operator|=
name|bsd_termios
operator|->
name|c_cc
index|[
name|VERASE
index|]
expr_stmt|;
name|ibcs2_termios
operator|->
name|c_cc
index|[
name|IBCS2_VKILL
index|]
operator|=
name|bsd_termios
operator|->
name|c_cc
index|[
name|VKILL
index|]
expr_stmt|;
if|if
condition|(
name|bsd_termios
operator|->
name|c_lflag
operator|&
name|ICANON
condition|)
block|{
name|ibcs2_termios
operator|->
name|c_cc
index|[
name|IBCS2_VEOF
index|]
operator|=
name|bsd_termios
operator|->
name|c_cc
index|[
name|VEOF
index|]
expr_stmt|;
name|ibcs2_termios
operator|->
name|c_cc
index|[
name|IBCS2_VEOL
index|]
operator|=
name|bsd_termios
operator|->
name|c_cc
index|[
name|VEOL
index|]
expr_stmt|;
block|}
else|else
block|{
name|ibcs2_termios
operator|->
name|c_cc
index|[
name|IBCS2_VMIN
index|]
operator|=
name|bsd_termios
operator|->
name|c_cc
index|[
name|VMIN
index|]
expr_stmt|;
name|ibcs2_termios
operator|->
name|c_cc
index|[
name|IBCS2_VTIME
index|]
operator|=
name|bsd_termios
operator|->
name|c_cc
index|[
name|VTIME
index|]
expr_stmt|;
block|}
name|ibcs2_termios
operator|->
name|c_cc
index|[
name|IBCS2_VEOL2
index|]
operator|=
name|bsd_termios
operator|->
name|c_cc
index|[
name|VEOL2
index|]
expr_stmt|;
name|ibcs2_termios
operator|->
name|c_cc
index|[
name|IBCS2_VSWTCH
index|]
operator|=
literal|0xff
expr_stmt|;
name|ibcs2_termios
operator|->
name|c_cc
index|[
name|IBCS2_VSUSP
index|]
operator|=
name|bsd_termios
operator|->
name|c_cc
index|[
name|VSUSP
index|]
expr_stmt|;
name|ibcs2_termios
operator|->
name|c_cc
index|[
name|IBCS2_VSTART
index|]
operator|=
name|bsd_termios
operator|->
name|c_cc
index|[
name|VSTART
index|]
expr_stmt|;
name|ibcs2_termios
operator|->
name|c_cc
index|[
name|IBCS2_VSTOP
index|]
operator|=
name|bsd_termios
operator|->
name|c_cc
index|[
name|VSTOP
index|]
expr_stmt|;
name|ibcs2_termios
operator|->
name|c_ispeed
operator|=
name|bsd_to_ibcs2_speed
argument_list|(
name|bsd_termios
operator|->
name|c_ispeed
argument_list|,
name|sptab
argument_list|)
expr_stmt|;
name|ibcs2_termios
operator|->
name|c_ospeed
operator|=
name|bsd_to_ibcs2_speed
argument_list|(
name|bsd_termios
operator|->
name|c_ospeed
argument_list|,
name|sptab
argument_list|)
expr_stmt|;
name|ibcs2_termios
operator|->
name|c_line
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ibcs2_trace
operator|&
name|IBCS2_TRACE_IOCTLCNV
condition|)
block|{
name|int
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"IBCS2: IBCS2 termios structure (output):\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"i=%08x o=%08x c=%08x l=%08x ispeed=%d ospeed=%d "
literal|"line=%d\n"
argument_list|,
name|ibcs2_termios
operator|->
name|c_iflag
argument_list|,
name|ibcs2_termios
operator|->
name|c_oflag
argument_list|,
name|ibcs2_termios
operator|->
name|c_cflag
argument_list|,
name|ibcs2_termios
operator|->
name|c_lflag
argument_list|,
name|ibcs2_to_bsd_speed
argument_list|(
name|ibcs2_termios
operator|->
name|c_ispeed
argument_list|,
name|sptab
argument_list|)
argument_list|,
name|ibcs2_to_bsd_speed
argument_list|(
name|ibcs2_termios
operator|->
name|c_ospeed
argument_list|,
name|sptab
argument_list|)
argument_list|,
name|ibcs2_termios
operator|->
name|c_line
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"c_cc "
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|IBCS2_NCCS
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"%02x "
argument_list|,
name|ibcs2_termios
operator|->
name|c_cc
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ibcs2_to_bsd_termios
parameter_list|(
name|struct
name|ibcs2_termios
modifier|*
name|ibcs2_termios
parameter_list|,
name|struct
name|termios
modifier|*
name|bsd_termios
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|speed
decl_stmt|;
if|if
condition|(
name|ibcs2_trace
operator|&
name|IBCS2_TRACE_IOCTLCNV
condition|)
block|{
name|int
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"IBCS2: IBCS2 termios structure (input):\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"i=%08x o=%08x c=%08x l=%08x ispeed=%d ospeed=%d "
literal|"line=%d\n"
argument_list|,
name|ibcs2_termios
operator|->
name|c_iflag
argument_list|,
name|ibcs2_termios
operator|->
name|c_oflag
argument_list|,
name|ibcs2_termios
operator|->
name|c_cflag
argument_list|,
name|ibcs2_termios
operator|->
name|c_lflag
argument_list|,
name|ibcs2_to_bsd_speed
argument_list|(
name|ibcs2_termios
operator|->
name|c_ispeed
argument_list|,
name|sptab
argument_list|)
argument_list|,
name|ibcs2_to_bsd_speed
argument_list|(
name|ibcs2_termios
operator|->
name|c_ospeed
argument_list|,
name|sptab
argument_list|)
argument_list|,
name|ibcs2_termios
operator|->
name|c_line
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"c_cc "
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|IBCS2_NCCS
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"%02x "
argument_list|,
name|ibcs2_termios
operator|->
name|c_cc
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|bsd_termios
operator|->
name|c_iflag
operator|=
name|ibcs2_termios
operator|->
name|c_iflag
operator|&
operator|(
name|IBCS2_IGNBRK
operator||
name|IBCS2_BRKINT
operator||
name|IBCS2_IGNPAR
operator||
name|IBCS2_PARMRK
operator||
name|IBCS2_INPCK
operator||
name|IBCS2_ISTRIP
operator||
name|IBCS2_INLCR
operator||
name|IBCS2_IGNCR
operator||
name|IBCS2_ICRNL
operator||
name|IBCS2_IXANY
operator|)
expr_stmt|;
if|if
condition|(
name|ibcs2_termios
operator|->
name|c_iflag
operator|&
name|IBCS2_IXON
condition|)
name|bsd_termios
operator|->
name|c_iflag
operator||=
name|IXON
expr_stmt|;
if|if
condition|(
name|ibcs2_termios
operator|->
name|c_iflag
operator|&
name|IBCS2_IXOFF
condition|)
name|bsd_termios
operator|->
name|c_iflag
operator||=
name|IXOFF
expr_stmt|;
name|bsd_termios
operator|->
name|c_oflag
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ibcs2_termios
operator|->
name|c_oflag
operator|&
name|IBCS2_OPOST
condition|)
name|bsd_termios
operator|->
name|c_oflag
operator||=
name|OPOST
expr_stmt|;
if|if
condition|(
name|ibcs2_termios
operator|->
name|c_oflag
operator|&
name|IBCS2_ONLCR
condition|)
name|bsd_termios
operator|->
name|c_oflag
operator||=
name|ONLCR
expr_stmt|;
if|if
condition|(
name|ibcs2_termios
operator|->
name|c_oflag
operator|&
operator|(
name|IBCS2_TAB1
operator||
name|IBCS2_TAB2
operator|)
condition|)
name|bsd_termios
operator|->
name|c_oflag
operator||=
name|OXTABS
expr_stmt|;
name|bsd_termios
operator|->
name|c_cflag
operator|=
operator|(
name|ibcs2_termios
operator|->
name|c_cflag
operator|&
name|IBCS2_CSIZE
operator|)
operator|<<
literal|4
expr_stmt|;
if|if
condition|(
name|ibcs2_termios
operator|->
name|c_cflag
operator|&
name|IBCS2_CSTOPB
condition|)
name|bsd_termios
operator|->
name|c_cflag
operator||=
name|CSTOPB
expr_stmt|;
if|if
condition|(
name|ibcs2_termios
operator|->
name|c_cflag
operator|&
name|IBCS2_PARENB
condition|)
name|bsd_termios
operator|->
name|c_cflag
operator||=
name|PARENB
expr_stmt|;
if|if
condition|(
name|ibcs2_termios
operator|->
name|c_cflag
operator|&
name|IBCS2_PARODD
condition|)
name|bsd_termios
operator|->
name|c_cflag
operator||=
name|PARODD
expr_stmt|;
if|if
condition|(
name|ibcs2_termios
operator|->
name|c_cflag
operator|&
name|IBCS2_HUPCL
condition|)
name|bsd_termios
operator|->
name|c_cflag
operator||=
name|HUPCL
expr_stmt|;
if|if
condition|(
name|ibcs2_termios
operator|->
name|c_cflag
operator|&
name|IBCS2_CLOCAL
condition|)
name|bsd_termios
operator|->
name|c_cflag
operator||=
name|CLOCAL
expr_stmt|;
if|if
condition|(
name|ibcs2_termios
operator|->
name|c_cflag
operator|&
literal|0x8000
condition|)
name|bsd_termios
operator|->
name|c_cflag
operator||=
name|CRTSCTS
expr_stmt|;
comment|/* XXX */
name|bsd_termios
operator|->
name|c_lflag
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ibcs2_termios
operator|->
name|c_lflag
operator|&
name|IBCS2_ISIG
condition|)
name|bsd_termios
operator|->
name|c_lflag
operator||=
name|ISIG
expr_stmt|;
if|if
condition|(
name|ibcs2_termios
operator|->
name|c_lflag
operator|&
name|IBCS2_ICANON
condition|)
name|bsd_termios
operator|->
name|c_lflag
operator||=
name|ICANON
expr_stmt|;
if|if
condition|(
name|ibcs2_termios
operator|->
name|c_lflag
operator|&
name|IBCS2_ECHO
condition|)
name|bsd_termios
operator|->
name|c_lflag
operator||=
name|ECHO
expr_stmt|;
if|if
condition|(
name|ibcs2_termios
operator|->
name|c_lflag
operator|&
name|IBCS2_ECHOE
condition|)
name|bsd_termios
operator|->
name|c_lflag
operator||=
name|ECHOE
expr_stmt|;
if|if
condition|(
name|ibcs2_termios
operator|->
name|c_lflag
operator|&
name|IBCS2_ECHOK
condition|)
name|bsd_termios
operator|->
name|c_lflag
operator||=
name|ECHOK
expr_stmt|;
if|if
condition|(
name|ibcs2_termios
operator|->
name|c_lflag
operator|&
name|IBCS2_ECHONL
condition|)
name|bsd_termios
operator|->
name|c_lflag
operator||=
name|ECHONL
expr_stmt|;
if|if
condition|(
name|ibcs2_termios
operator|->
name|c_lflag
operator|&
name|IBCS2_NOFLSH
condition|)
name|bsd_termios
operator|->
name|c_lflag
operator||=
name|NOFLSH
expr_stmt|;
if|if
condition|(
name|ibcs2_termios
operator|->
name|c_lflag
operator|&
literal|0x0200
condition|)
comment|/* XXX */
name|bsd_termios
operator|->
name|c_lflag
operator||=
name|ECHOCTL
expr_stmt|;
if|if
condition|(
name|ibcs2_termios
operator|->
name|c_lflag
operator|&
literal|0x0400
condition|)
comment|/* XXX */
name|bsd_termios
operator|->
name|c_lflag
operator||=
name|ECHOPRT
expr_stmt|;
if|if
condition|(
name|ibcs2_termios
operator|->
name|c_lflag
operator|&
literal|0x0800
condition|)
comment|/* XXX */
name|bsd_termios
operator|->
name|c_lflag
operator||=
name|ECHOKE
expr_stmt|;
if|if
condition|(
name|ibcs2_termios
operator|->
name|c_lflag
operator|&
literal|0x8000
condition|)
comment|/* XXX */
name|bsd_termios
operator|->
name|c_lflag
operator||=
name|IEXTEN
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NCCS
condition|;
name|bsd_termios
operator|->
name|c_cc
index|[
name|i
operator|++
index|]
operator|=
literal|0
control|)
empty_stmt|;
name|bsd_termios
operator|->
name|c_cc
index|[
name|VINTR
index|]
operator|=
name|ibcs2_termios
operator|->
name|c_cc
index|[
name|IBCS2_VINTR
index|]
expr_stmt|;
name|bsd_termios
operator|->
name|c_cc
index|[
name|VQUIT
index|]
operator|=
name|ibcs2_termios
operator|->
name|c_cc
index|[
name|IBCS2_VQUIT
index|]
expr_stmt|;
name|bsd_termios
operator|->
name|c_cc
index|[
name|VERASE
index|]
operator|=
name|ibcs2_termios
operator|->
name|c_cc
index|[
name|IBCS2_VERASE
index|]
expr_stmt|;
name|bsd_termios
operator|->
name|c_cc
index|[
name|VKILL
index|]
operator|=
name|ibcs2_termios
operator|->
name|c_cc
index|[
name|IBCS2_VKILL
index|]
expr_stmt|;
if|if
condition|(
name|ibcs2_termios
operator|->
name|c_lflag
operator|&
name|IBCS2_ICANON
condition|)
block|{
name|bsd_termios
operator|->
name|c_cc
index|[
name|VEOF
index|]
operator|=
name|ibcs2_termios
operator|->
name|c_cc
index|[
name|IBCS2_VEOF
index|]
expr_stmt|;
name|bsd_termios
operator|->
name|c_cc
index|[
name|VEOL
index|]
operator|=
name|ibcs2_termios
operator|->
name|c_cc
index|[
name|IBCS2_VEOL
index|]
expr_stmt|;
block|}
else|else
block|{
name|bsd_termios
operator|->
name|c_cc
index|[
name|VMIN
index|]
operator|=
name|ibcs2_termios
operator|->
name|c_cc
index|[
name|IBCS2_VMIN
index|]
expr_stmt|;
name|bsd_termios
operator|->
name|c_cc
index|[
name|VTIME
index|]
operator|=
name|ibcs2_termios
operator|->
name|c_cc
index|[
name|IBCS2_VTIME
index|]
expr_stmt|;
block|}
name|bsd_termios
operator|->
name|c_cc
index|[
name|VEOL2
index|]
operator|=
name|ibcs2_termios
operator|->
name|c_cc
index|[
name|IBCS2_VEOL2
index|]
expr_stmt|;
name|bsd_termios
operator|->
name|c_cc
index|[
name|VSUSP
index|]
operator|=
name|ibcs2_termios
operator|->
name|c_cc
index|[
name|IBCS2_VSUSP
index|]
expr_stmt|;
name|bsd_termios
operator|->
name|c_cc
index|[
name|VSTART
index|]
operator|=
name|ibcs2_termios
operator|->
name|c_cc
index|[
name|IBCS2_VSTART
index|]
expr_stmt|;
name|bsd_termios
operator|->
name|c_cc
index|[
name|VSTOP
index|]
operator|=
name|ibcs2_termios
operator|->
name|c_cc
index|[
name|IBCS2_VSTOP
index|]
expr_stmt|;
name|bsd_termios
operator|->
name|c_ispeed
operator|=
name|ibcs2_to_bsd_speed
argument_list|(
name|ibcs2_termios
operator|->
name|c_ispeed
argument_list|,
name|sptab
argument_list|)
expr_stmt|;
name|bsd_termios
operator|->
name|c_ospeed
operator|=
name|ibcs2_to_bsd_speed
argument_list|(
name|ibcs2_termios
operator|->
name|c_ospeed
argument_list|,
name|sptab
argument_list|)
expr_stmt|;
if|if
condition|(
name|ibcs2_trace
operator|&
name|IBCS2_TRACE_IOCTLCNV
condition|)
block|{
name|int
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"IBCS2: BSD termios structure (output):\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"i=%08x o=%08x c=%08x l=%08x ispeed=%d ospeed=%d\n"
argument_list|,
name|bsd_termios
operator|->
name|c_iflag
argument_list|,
name|bsd_termios
operator|->
name|c_oflag
argument_list|,
name|bsd_termios
operator|->
name|c_cflag
argument_list|,
name|bsd_termios
operator|->
name|c_lflag
argument_list|,
name|bsd_termios
operator|->
name|c_ispeed
argument_list|,
name|bsd_termios
operator|->
name|c_ospeed
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"c_cc "
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NCCS
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"%02x "
argument_list|,
name|bsd_termios
operator|->
name|c_cc
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_struct
struct|struct
name|ibcs2_ioctl_args
block|{
name|int
name|fd
decl_stmt|;
name|int
name|cmd
decl_stmt|;
name|int
name|arg
decl_stmt|;
block|}
struct|;
end_struct

begin_function
name|int
name|ibcs2_ioctl
parameter_list|(
name|struct
name|proc
modifier|*
name|p
parameter_list|,
name|struct
name|ibcs2_ioctl_args
modifier|*
name|args
parameter_list|,
name|int
modifier|*
name|retval
parameter_list|)
block|{
name|struct
name|termios
name|bsd_termios
decl_stmt|;
name|struct
name|winsize
name|bsd_winsize
decl_stmt|;
name|struct
name|ibcs2_termio
name|ibcs2_termio
decl_stmt|;
name|struct
name|ibcs2_termios
name|ibcs2_termios
decl_stmt|;
name|struct
name|ibcs2_winsize
name|ibcs2_winsize
decl_stmt|;
name|struct
name|filedesc
modifier|*
name|fdp
init|=
name|p
operator|->
name|p_fd
decl_stmt|;
name|struct
name|file
modifier|*
name|fp
decl_stmt|;
name|int
function_decl|(
modifier|*
name|func
function_decl|)
parameter_list|()
function_decl|;
name|int
name|type
init|=
operator|(
name|args
operator|->
name|cmd
operator|&
literal|0xffff00
operator|)
operator|>>
literal|8
decl_stmt|;
name|int
name|num
init|=
name|args
operator|->
name|cmd
operator|&
literal|0xff
decl_stmt|;
name|int
name|error
decl_stmt|;
if|if
condition|(
name|ibcs2_trace
operator|&
name|IBCS2_TRACE_IOCTL
condition|)
name|printf
argument_list|(
literal|"IBCS2: 'ioctl' fd=%d, typ=%d(%c), num=%d\n"
argument_list|,
name|args
operator|->
name|fd
argument_list|,
name|type
argument_list|,
name|type
argument_list|,
name|num
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|unsigned
operator|)
name|args
operator|->
name|fd
operator|>=
name|fdp
operator|->
name|fd_nfiles
operator|||
operator|(
name|fp
operator|=
name|fdp
operator|->
name|fd_ofiles
index|[
name|args
operator|->
name|fd
index|]
operator|)
operator|==
literal|0
condition|)
return|return
name|EBADF
return|;
if|if
condition|(
operator|!
name|fp
operator|||
operator|(
name|fp
operator|->
name|f_flag
operator|&
operator|(
name|FREAD
operator||
name|FWRITE
operator|)
operator|)
operator|==
literal|0
condition|)
block|{
return|return
name|EBADF
return|;
block|}
name|func
operator|=
name|fp
operator|->
name|f_ops
operator|->
name|fo_ioctl
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
literal|'f'
case|:
switch|switch
condition|(
name|num
condition|)
block|{
case|case
literal|1
case|:
name|args
operator|->
name|cmd
operator|=
name|FIOCLEX
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
name|args
argument_list|,
name|retval
argument_list|)
return|;
case|case
literal|2
case|:
name|args
operator|->
name|cmd
operator|=
name|FIONCLEX
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
name|args
argument_list|,
name|retval
argument_list|)
return|;
case|case
literal|3
case|:
name|args
operator|->
name|cmd
operator|=
name|FIONREAD
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
name|args
argument_list|,
name|retval
argument_list|)
return|;
block|}
break|break;
if|#
directive|if
literal|0
block|case 'j': 		switch (num) { 		case 5:
comment|/* jerq winsize ?? */
block|ibcs2_winsize.bytex = 80;
comment|/* p->p_session->s_ttyp->t_winsize.ws_col; XXX */
block|ibcs2_winsize.bytey = 25;
comment|/* p->p_session->s_ttyp->t_winsize.ws_row; XXX */
block|ibcs2_winsize.bitx =  				p->p_session->s_ttyp->t_winsize.ws_xpixel; 			ibcs2_winsize.bity = 				p->p_session->s_ttyp->t_winsize.ws_ypixel; 			return copyout((caddr_t)&ibcs2_winsize,  					(caddr_t)args->arg, 					sizeof(ibcs2_winsize)); 		}
endif|#
directive|endif
case|case
literal|'t'
case|:
switch|switch
condition|(
name|num
condition|)
block|{
case|case
literal|0
case|:
name|args
operator|->
name|cmd
operator|=
name|TIOCGETD
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
name|args
argument_list|,
name|retval
argument_list|)
return|;
case|case
literal|1
case|:
name|args
operator|->
name|cmd
operator|=
name|TIOCSETD
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
name|args
argument_list|,
name|retval
argument_list|)
return|;
case|case
literal|2
case|:
name|args
operator|->
name|cmd
operator|=
name|TIOCHPCL
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
name|args
argument_list|,
name|retval
argument_list|)
return|;
case|case
literal|8
case|:
name|args
operator|->
name|cmd
operator|=
name|TIOCGETP
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
name|args
argument_list|,
name|retval
argument_list|)
return|;
case|case
literal|9
case|:
name|args
operator|->
name|cmd
operator|=
name|TIOCSETP
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
name|args
argument_list|,
name|retval
argument_list|)
return|;
case|case
literal|10
case|:
name|args
operator|->
name|cmd
operator|=
name|TIOCSETN
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
name|args
argument_list|,
name|retval
argument_list|)
return|;
case|case
literal|13
case|:
name|args
operator|->
name|cmd
operator|=
name|TIOCEXCL
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
name|args
argument_list|,
name|retval
argument_list|)
return|;
case|case
literal|14
case|:
name|args
operator|->
name|cmd
operator|=
name|TIOCNXCL
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
name|args
argument_list|,
name|retval
argument_list|)
return|;
case|case
literal|16
case|:
name|args
operator|->
name|cmd
operator|=
name|TIOCFLUSH
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
name|args
argument_list|,
name|retval
argument_list|)
return|;
case|case
literal|17
case|:
name|args
operator|->
name|cmd
operator|=
name|TIOCSETC
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
name|args
argument_list|,
name|retval
argument_list|)
return|;
case|case
literal|18
case|:
name|args
operator|->
name|cmd
operator|=
name|TIOCGETC
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
name|args
argument_list|,
name|retval
argument_list|)
return|;
block|}
break|break;
case|case
literal|'T'
case|:
switch|switch
condition|(
name|num
condition|)
block|{
case|case
literal|1
case|:
comment|/* TCGETA */
if|if
condition|(
operator|(
name|error
operator|=
call|(
modifier|*
name|func
call|)
argument_list|(
name|fp
argument_list|,
name|TIOCGETA
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|bsd_termios
argument_list|,
name|p
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|error
return|;
name|bsd_termios_to_ibcs2_termio
argument_list|(
operator|&
name|bsd_termios
argument_list|,
operator|&
name|ibcs2_termio
argument_list|)
expr_stmt|;
return|return
name|copyout
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
name|ibcs2_termio
argument_list|,
operator|(
name|caddr_t
operator|)
name|args
operator|->
name|arg
argument_list|,
sizeof|sizeof
argument_list|(
name|ibcs2_termio
argument_list|)
argument_list|)
return|;
case|case
literal|2
case|:
comment|/* TCSETA */
name|ibcs2_termio_to_bsd_termios
argument_list|(
operator|(
expr|struct
name|ibcs2_termio
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|,
operator|&
name|bsd_termios
argument_list|)
expr_stmt|;
return|return
call|(
modifier|*
name|func
call|)
argument_list|(
name|fp
argument_list|,
name|TIOCSETA
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|bsd_termios
argument_list|,
name|p
argument_list|)
return|;
case|case
literal|3
case|:
comment|/* TCSETAW */
name|ibcs2_termio_to_bsd_termios
argument_list|(
operator|(
expr|struct
name|ibcs2_termio
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|,
operator|&
name|bsd_termios
argument_list|)
expr_stmt|;
return|return
call|(
modifier|*
name|func
call|)
argument_list|(
name|fp
argument_list|,
name|TIOCSETAW
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|bsd_termios
argument_list|,
name|p
argument_list|)
return|;
case|case
literal|4
case|:
comment|/* TCSETAF */
name|ibcs2_termio_to_bsd_termios
argument_list|(
operator|(
expr|struct
name|ibcs2_termio
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|,
operator|&
name|bsd_termios
argument_list|)
expr_stmt|;
return|return
call|(
modifier|*
name|func
call|)
argument_list|(
name|fp
argument_list|,
name|TIOCSETAF
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|bsd_termios
argument_list|,
name|p
argument_list|)
return|;
case|case
literal|5
case|:
comment|/* TCSBRK */
name|args
operator|->
name|cmd
operator|=
name|TIOCDRAIN
expr_stmt|;
if|if
condition|(
name|error
operator|=
name|ioctl
argument_list|(
name|p
argument_list|,
name|args
argument_list|,
name|retval
argument_list|)
condition|)
return|return
name|error
return|;
name|args
operator|->
name|cmd
operator|=
name|TIOCSBRK
expr_stmt|;
name|ioctl
argument_list|(
name|p
argument_list|,
name|args
argument_list|,
name|retval
argument_list|)
expr_stmt|;
name|args
operator|->
name|cmd
operator|=
name|TIOCCBRK
expr_stmt|;
name|error
operator|=
name|ioctl
argument_list|(
name|p
argument_list|,
name|args
argument_list|,
name|retval
argument_list|)
expr_stmt|;
return|return
name|error
return|;
case|case
literal|6
case|:
comment|/* TCONC */
if|if
condition|(
name|args
operator|->
name|arg
operator|==
literal|0
condition|)
name|args
operator|->
name|cmd
operator|=
name|TIOCSTOP
expr_stmt|;
else|else
name|args
operator|->
name|cmd
operator|=
name|TIOCSTART
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
name|args
argument_list|,
name|retval
argument_list|)
return|;
case|case
literal|7
case|:
comment|/* TCFLSH */
name|args
operator|->
name|cmd
operator|=
name|TIOCFLUSH
expr_stmt|;
if|if
condition|(
operator|(
name|int
operator|)
name|args
operator|->
name|arg
operator|==
literal|0
condition|)
operator|(
name|int
operator|)
name|args
operator|->
name|arg
operator|=
name|FREAD
expr_stmt|;
if|if
condition|(
operator|(
name|int
operator|)
name|args
operator|->
name|arg
operator|==
literal|1
condition|)
operator|(
name|int
operator|)
name|args
operator|->
name|arg
operator|=
name|FWRITE
expr_stmt|;
if|if
condition|(
operator|(
name|int
operator|)
name|args
operator|->
name|arg
operator|==
literal|2
condition|)
operator|(
name|int
operator|)
name|args
operator|->
name|arg
operator|=
name|FREAD
operator||
name|FWRITE
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
name|args
argument_list|,
name|retval
argument_list|)
return|;
case|case
literal|103
case|:
comment|/* TIOCSWINSZ */
name|bsd_winsize
operator|.
name|ws_row
operator|=
operator|(
operator|(
expr|struct
name|ibcs2_winsize
operator|*
operator|)
operator|(
name|args
operator|->
name|arg
operator|)
operator|)
operator|->
name|bytex
expr_stmt|;
name|bsd_winsize
operator|.
name|ws_col
operator|=
operator|(
operator|(
expr|struct
name|ibcs2_winsize
operator|*
operator|)
operator|(
name|args
operator|->
name|arg
operator|)
operator|)
operator|->
name|bytey
expr_stmt|;
name|bsd_winsize
operator|.
name|ws_xpixel
operator|=
operator|(
operator|(
expr|struct
name|ibcs2_winsize
operator|*
operator|)
operator|(
name|args
operator|->
name|arg
operator|)
operator|)
operator|->
name|bitx
expr_stmt|;
name|bsd_winsize
operator|.
name|ws_ypixel
operator|=
operator|(
operator|(
expr|struct
name|ibcs2_winsize
operator|*
operator|)
operator|(
name|args
operator|->
name|arg
operator|)
operator|)
operator|->
name|bity
expr_stmt|;
return|return
call|(
modifier|*
name|func
call|)
argument_list|(
name|fp
argument_list|,
name|TIOCSWINSZ
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|bsd_winsize
argument_list|,
name|p
argument_list|)
return|;
case|case
literal|104
case|:
comment|/* TIOCGWINSZ */
if|if
condition|(
operator|(
name|error
operator|=
call|(
modifier|*
name|func
call|)
argument_list|(
name|fp
argument_list|,
name|TIOCGWINSZ
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|bsd_winsize
argument_list|,
name|p
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|error
return|;
name|ibcs2_winsize
operator|.
name|bytex
operator|=
name|bsd_winsize
operator|.
name|ws_col
expr_stmt|;
name|ibcs2_winsize
operator|.
name|bytey
operator|=
name|bsd_winsize
operator|.
name|ws_row
expr_stmt|;
name|ibcs2_winsize
operator|.
name|bitx
operator|=
name|bsd_winsize
operator|.
name|ws_xpixel
expr_stmt|;
name|ibcs2_winsize
operator|.
name|bity
operator|=
name|bsd_winsize
operator|.
name|ws_ypixel
expr_stmt|;
return|return
name|copyout
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
name|ibcs2_winsize
argument_list|,
operator|(
name|caddr_t
operator|)
name|args
operator|->
name|arg
argument_list|,
sizeof|sizeof
argument_list|(
name|ibcs2_winsize
argument_list|)
argument_list|)
return|;
case|case
literal|20
case|:
comment|/* TCSETPGRP */
case|case
literal|118
case|:
comment|/* TIOCSPGRP */
name|args
operator|->
name|cmd
operator|=
name|TIOCSPGRP
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
name|args
argument_list|,
name|retval
argument_list|)
return|;
case|case
literal|21
case|:
comment|/* TCGETPGRP */
case|case
literal|119
case|:
comment|/* TIOCGPGRP */
name|args
operator|->
name|cmd
operator|=
name|TIOCGPGRP
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
name|args
argument_list|,
name|retval
argument_list|)
return|;
block|}
break|break;
case|case
operator|(
literal|'x'
operator|)
case|:
switch|switch
condition|(
name|num
condition|)
block|{
case|case
literal|1
case|:
if|if
condition|(
operator|(
name|error
operator|=
call|(
modifier|*
name|func
call|)
argument_list|(
name|fp
argument_list|,
name|TIOCGETA
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|bsd_termios
argument_list|,
name|p
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|error
return|;
name|bsd_to_ibcs2_termios
argument_list|(
operator|&
name|bsd_termios
argument_list|,
operator|&
name|ibcs2_termios
argument_list|)
expr_stmt|;
return|return
name|copyout
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
name|ibcs2_termios
argument_list|,
operator|(
name|caddr_t
operator|)
name|args
operator|->
name|arg
argument_list|,
sizeof|sizeof
argument_list|(
name|ibcs2_termios
argument_list|)
argument_list|)
return|;
case|case
literal|2
case|:
name|ibcs2_to_bsd_termios
argument_list|(
operator|(
expr|struct
name|ibcs2_termios
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|,
operator|&
name|bsd_termios
argument_list|)
expr_stmt|;
return|return
call|(
modifier|*
name|func
call|)
argument_list|(
name|fp
argument_list|,
name|TIOCSETA
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|bsd_termios
argument_list|,
name|p
argument_list|)
return|;
case|case
literal|3
case|:
name|ibcs2_to_bsd_termios
argument_list|(
operator|(
expr|struct
name|ibcs2_termios
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|,
operator|&
name|bsd_termios
argument_list|)
expr_stmt|;
return|return
call|(
modifier|*
name|func
call|)
argument_list|(
name|fp
argument_list|,
name|TIOCSETAW
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|bsd_termios
argument_list|,
name|p
argument_list|)
return|;
case|case
literal|4
case|:
name|ibcs2_to_bsd_termios
argument_list|(
operator|(
expr|struct
name|ibcs2_termios
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|,
operator|&
name|bsd_termios
argument_list|)
expr_stmt|;
return|return
call|(
modifier|*
name|func
call|)
argument_list|(
name|fp
argument_list|,
name|TIOCSETAF
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|bsd_termios
argument_list|,
name|p
argument_list|)
return|;
block|}
break|break;
comment|/* below is console ioctl's, we have syscons so no problem here */
case|case
literal|'c'
case|:
switch|switch
condition|(
name|num
condition|)
block|{
case|case
literal|4
case|:
name|args
operator|->
name|cmd
operator|=
name|CONS_BLANKTIME
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
name|args
argument_list|,
name|retval
argument_list|)
return|;
case|case
literal|64
case|:
name|args
operator|->
name|cmd
operator|=
name|PIO_FONT8x8
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
name|args
argument_list|,
name|retval
argument_list|)
return|;
case|case
literal|65
case|:
name|args
operator|->
name|cmd
operator|=
name|GIO_FONT8x8
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
name|args
argument_list|,
name|retval
argument_list|)
return|;
case|case
literal|66
case|:
name|args
operator|->
name|cmd
operator|=
name|PIO_FONT8x14
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
name|args
argument_list|,
name|retval
argument_list|)
return|;
case|case
literal|67
case|:
name|args
operator|->
name|cmd
operator|=
name|GIO_FONT8x14
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
name|args
argument_list|,
name|retval
argument_list|)
return|;
case|case
literal|68
case|:
name|args
operator|->
name|cmd
operator|=
name|PIO_FONT8x16
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
name|args
argument_list|,
name|retval
argument_list|)
return|;
case|case
literal|69
case|:
name|args
operator|->
name|cmd
operator|=
name|GIO_FONT8x16
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
name|args
argument_list|,
name|retval
argument_list|)
return|;
case|case
literal|73
case|:
name|args
operator|->
name|cmd
operator|=
name|CONS_GETINFO
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
name|args
argument_list|,
name|retval
argument_list|)
return|;
block|}
break|break;
case|case
literal|'k'
case|:
switch|switch
condition|(
name|num
condition|)
block|{
case|case
literal|0
case|:
name|args
operator|->
name|cmd
operator|=
name|GETFKEY
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
name|args
argument_list|,
name|retval
argument_list|)
return|;
case|case
literal|1
case|:
name|args
operator|->
name|cmd
operator|=
name|SETFKEY
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
name|args
argument_list|,
name|retval
argument_list|)
return|;
case|case
literal|2
case|:
name|args
operator|->
name|cmd
operator|=
name|GIO_SCRNMAP
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
name|args
argument_list|,
name|retval
argument_list|)
return|;
case|case
literal|3
case|:
name|args
operator|->
name|cmd
operator|=
name|PIO_SCRNMAP
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
name|args
argument_list|,
name|retval
argument_list|)
return|;
case|case
literal|6
case|:
name|args
operator|->
name|cmd
operator|=
name|GIO_KEYMAP
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
name|args
argument_list|,
name|retval
argument_list|)
return|;
case|case
literal|7
case|:
name|args
operator|->
name|cmd
operator|=
name|PIO_KEYMAP
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
name|args
argument_list|,
name|retval
argument_list|)
return|;
block|}
break|break;
case|case
literal|'K'
case|:
switch|switch
condition|(
name|num
condition|)
block|{
case|case
literal|6
case|:
name|args
operator|->
name|cmd
operator|=
name|KDGKBMODE
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
name|args
argument_list|,
name|retval
argument_list|)
return|;
case|case
literal|7
case|:
name|args
operator|->
name|cmd
operator|=
name|KDSKBMODE
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
name|args
argument_list|,
name|retval
argument_list|)
return|;
case|case
literal|8
case|:
name|args
operator|->
name|cmd
operator|=
name|KDMKTONE
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
name|args
argument_list|,
name|retval
argument_list|)
return|;
case|case
literal|9
case|:
name|args
operator|->
name|cmd
operator|=
name|KDGETMODE
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
name|args
argument_list|,
name|retval
argument_list|)
return|;
case|case
literal|10
case|:
name|args
operator|->
name|cmd
operator|=
name|KDSETMODE
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
name|args
argument_list|,
name|retval
argument_list|)
return|;
case|case
literal|13
case|:
name|args
operator|->
name|cmd
operator|=
name|KDSBORDER
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
name|args
argument_list|,
name|retval
argument_list|)
return|;
case|case
literal|19
case|:
name|args
operator|->
name|cmd
operator|=
name|KDGKBSTATE
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
name|args
argument_list|,
name|retval
argument_list|)
return|;
case|case
literal|20
case|:
name|args
operator|->
name|cmd
operator|=
name|KDSETRAD
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
name|args
argument_list|,
name|retval
argument_list|)
return|;
case|case
literal|60
case|:
name|args
operator|->
name|cmd
operator|=
name|KDENABIO
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
name|args
argument_list|,
name|retval
argument_list|)
return|;
case|case
literal|61
case|:
name|args
operator|->
name|cmd
operator|=
name|KDDISABIO
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
name|args
argument_list|,
name|retval
argument_list|)
return|;
case|case
literal|63
case|:
name|args
operator|->
name|cmd
operator|=
name|KIOCSOUND
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
name|args
argument_list|,
name|retval
argument_list|)
return|;
case|case
literal|64
case|:
name|args
operator|->
name|cmd
operator|=
name|KDGKBTYPE
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
name|args
argument_list|,
name|retval
argument_list|)
return|;
case|case
literal|65
case|:
name|args
operator|->
name|cmd
operator|=
name|KDGETLED
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
name|args
argument_list|,
name|retval
argument_list|)
return|;
case|case
literal|66
case|:
name|args
operator|->
name|cmd
operator|=
name|KDSETLED
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
name|args
argument_list|,
name|retval
argument_list|)
return|;
block|}
break|break;
case|case
literal|'S'
case|:
name|args
operator|->
name|cmd
operator|=
name|_IO
argument_list|(
literal|'S'
argument_list|,
name|num
argument_list|)
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
name|args
argument_list|,
name|retval
argument_list|)
return|;
case|case
literal|'v'
case|:
switch|switch
condition|(
name|num
condition|)
block|{
case|case
literal|1
case|:
name|args
operator|->
name|cmd
operator|=
name|VT_OPENQRY
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
name|args
argument_list|,
name|retval
argument_list|)
return|;
case|case
literal|2
case|:
name|args
operator|->
name|cmd
operator|=
name|VT_SETMODE
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
name|args
argument_list|,
name|retval
argument_list|)
return|;
case|case
literal|3
case|:
name|args
operator|->
name|cmd
operator|=
name|VT_GETMODE
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
name|args
argument_list|,
name|retval
argument_list|)
return|;
case|case
literal|4
case|:
name|args
operator|->
name|cmd
operator|=
name|VT_RELDISP
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
name|args
argument_list|,
name|retval
argument_list|)
return|;
case|case
literal|5
case|:
name|args
operator|->
name|cmd
operator|=
name|VT_ACTIVATE
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
name|args
argument_list|,
name|retval
argument_list|)
return|;
case|case
literal|6
case|:
name|args
operator|->
name|cmd
operator|=
name|VT_WAITACTIVE
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
name|args
argument_list|,
name|retval
argument_list|)
return|;
block|}
break|break;
block|}
name|uprintf
argument_list|(
literal|"IBCS2: 'ioctl' fd=%d, typ=%d(%c), num=%d not implemented\n"
argument_list|,
name|args
operator|->
name|fd
argument_list|,
name|type
argument_list|,
name|type
argument_list|,
name|num
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
end_function

begin_struct
struct|struct
name|ibcs2_sgtty_args
block|{
name|int
name|fd
decl_stmt|;
name|struct
name|sgttyb
modifier|*
name|buf
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|ioctl_args
block|{
name|int
name|fd
decl_stmt|;
name|int
name|cmd
decl_stmt|;
name|caddr_t
name|arg
decl_stmt|;
block|}
struct|;
end_struct

begin_function
name|int
name|ibcs2_gtty
parameter_list|(
name|struct
name|proc
modifier|*
name|p
parameter_list|,
name|struct
name|ibcs2_sgtty_args
modifier|*
name|args
parameter_list|,
name|int
modifier|*
name|retval
parameter_list|)
block|{
name|struct
name|ioctl_args
name|ioctl_arg
decl_stmt|;
if|if
condition|(
name|ibcs2_trace
operator|&
name|IBCS2_TRACE_IOCTL
condition|)
name|printf
argument_list|(
literal|"IBCS2: 'gtty' fd=%d\n"
argument_list|,
name|args
operator|->
name|fd
argument_list|)
expr_stmt|;
name|ioctl_arg
operator|.
name|fd
operator|=
name|args
operator|->
name|fd
expr_stmt|;
name|ioctl_arg
operator|.
name|cmd
operator|=
name|TIOCGETC
expr_stmt|;
name|ioctl_arg
operator|.
name|arg
operator|=
operator|(
name|caddr_t
operator|)
name|args
operator|->
name|buf
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
operator|&
name|ioctl_arg
argument_list|,
name|retval
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|ibcs2_stty
parameter_list|(
name|struct
name|proc
modifier|*
name|p
parameter_list|,
name|struct
name|ibcs2_sgtty_args
modifier|*
name|args
parameter_list|,
name|int
modifier|*
name|retval
parameter_list|)
block|{
name|struct
name|ioctl_args
name|ioctl_arg
decl_stmt|;
if|if
condition|(
name|ibcs2_trace
operator|&
name|IBCS2_TRACE_IOCTL
condition|)
name|printf
argument_list|(
literal|"IBCS2: 'stty' fd=%d\n"
argument_list|,
name|args
operator|->
name|fd
argument_list|)
expr_stmt|;
name|ioctl_arg
operator|.
name|fd
operator|=
name|args
operator|->
name|fd
expr_stmt|;
name|ioctl_arg
operator|.
name|cmd
operator|=
name|TIOCSETC
expr_stmt|;
name|ioctl_arg
operator|.
name|arg
operator|=
operator|(
name|caddr_t
operator|)
name|args
operator|->
name|buf
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
operator|&
name|ioctl_arg
argument_list|,
name|retval
argument_list|)
return|;
block|}
end_function

end_unit


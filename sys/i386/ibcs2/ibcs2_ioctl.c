begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	$NetBSD: ibcs2_ioctl.c,v 1.6 1995/03/14 15:12:28 scottb Exp $	*/
end_comment

begin_comment
comment|/*  * Copyright (c) 1994, 1995 Scott Bartram  * All rights reserved.  *  * based on compat/sunos/sun_ioctl.c  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. The name of the author may not be used to endorse or promote products  *    derived from this software without specific prior written permission  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/namei.h>
end_include

begin_include
include|#
directive|include
file|<sys/dir.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/fcntl.h>
end_include

begin_include
include|#
directive|include
file|<sys/file.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<sys/filedesc.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl_compat.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/mman.h>
end_include

begin_include
include|#
directive|include
file|<sys/mount.h>
end_include

begin_include
include|#
directive|include
file|<sys/reboot.h>
end_include

begin_include
include|#
directive|include
file|<sys/resource.h>
end_include

begin_include
include|#
directive|include
file|<sys/resourcevar.h>
end_include

begin_include
include|#
directive|include
file|<sys/signal.h>
end_include

begin_include
include|#
directive|include
file|<sys/signalvar.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/termios.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/times.h>
end_include

begin_include
include|#
directive|include
file|<sys/tty.h>
end_include

begin_include
include|#
directive|include
file|<sys/vnode.h>
end_include

begin_include
include|#
directive|include
file|<sys/uio.h>
end_include

begin_include
include|#
directive|include
file|<sys/wait.h>
end_include

begin_include
include|#
directive|include
file|<sys/utsname.h>
end_include

begin_include
include|#
directive|include
file|<sys/unistd.h>
end_include

begin_include
include|#
directive|include
file|<machine/console.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysproto.h>
end_include

begin_include
include|#
directive|include
file|<i386/ibcs2/ibcs2_types.h>
end_include

begin_include
include|#
directive|include
file|<i386/ibcs2/ibcs2_signal.h>
end_include

begin_include
include|#
directive|include
file|<i386/ibcs2/ibcs2_socksys.h>
end_include

begin_include
include|#
directive|include
file|<i386/ibcs2/ibcs2_stropts.h>
end_include

begin_include
include|#
directive|include
file|<i386/ibcs2/ibcs2_proto.h>
end_include

begin_include
include|#
directive|include
file|<i386/ibcs2/ibcs2_termios.h>
end_include

begin_include
include|#
directive|include
file|<i386/ibcs2/ibcs2_util.h>
end_include

begin_include
include|#
directive|include
file|<i386/ibcs2/ibcs2_ioctl.h>
end_include

begin_decl_stmt
specifier|static
name|void
name|stios2btios
name|__P
argument_list|(
operator|(
expr|struct
name|ibcs2_termios
operator|*
operator|,
expr|struct
name|termios
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|btios2stios
name|__P
argument_list|(
operator|(
expr|struct
name|termios
operator|*
operator|,
expr|struct
name|ibcs2_termios
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|stios2stio
name|__P
argument_list|(
operator|(
expr|struct
name|ibcs2_termios
operator|*
operator|,
expr|struct
name|ibcs2_termio
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|stio2stios
name|__P
argument_list|(
operator|(
expr|struct
name|ibcs2_termio
operator|*
operator|,
expr|struct
name|ibcs2_termios
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|ibcs2_gtty
parameter_list|(
name|struct
name|proc
modifier|*
name|p
parameter_list|,
name|struct
name|ibcs2_gtty_args
modifier|*
name|args
parameter_list|,
name|int
modifier|*
name|retval
parameter_list|)
block|{
name|struct
name|ioctl_args
name|ioctl_arg
decl_stmt|;
name|ioctl_arg
operator|.
name|fd
operator|=
name|args
operator|->
name|fd
expr_stmt|;
name|ioctl_arg
operator|.
name|com
operator|=
name|TIOCGETC
expr_stmt|;
name|ioctl_arg
operator|.
name|data
operator|=
operator|(
name|caddr_t
operator|)
name|args
operator|->
name|buf
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
operator|&
name|ioctl_arg
argument_list|,
name|retval
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|ibcs2_stty
parameter_list|(
name|struct
name|proc
modifier|*
name|p
parameter_list|,
name|struct
name|ibcs2_stty_args
modifier|*
name|args
parameter_list|,
name|int
modifier|*
name|retval
parameter_list|)
block|{
name|struct
name|ioctl_args
name|ioctl_arg
decl_stmt|;
name|ioctl_arg
operator|.
name|fd
operator|=
name|args
operator|->
name|fd
expr_stmt|;
name|ioctl_arg
operator|.
name|com
operator|=
name|TIOCSETC
expr_stmt|;
name|ioctl_arg
operator|.
name|data
operator|=
operator|(
name|caddr_t
operator|)
name|args
operator|->
name|buf
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
operator|&
name|ioctl_arg
argument_list|,
name|retval
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  * iBCS2 ioctl calls.  */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|speedtab
name|sptab
index|[]
init|=
block|{
block|{
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|50
block|,
literal|1
block|}
block|,
block|{
literal|75
block|,
literal|2
block|}
block|,
block|{
literal|110
block|,
literal|3
block|}
block|,
block|{
literal|134
block|,
literal|4
block|}
block|,
block|{
literal|135
block|,
literal|4
block|}
block|,
block|{
literal|150
block|,
literal|5
block|}
block|,
block|{
literal|200
block|,
literal|6
block|}
block|,
block|{
literal|300
block|,
literal|7
block|}
block|,
block|{
literal|600
block|,
literal|8
block|}
block|,
block|{
literal|1200
block|,
literal|9
block|}
block|,
block|{
literal|1800
block|,
literal|10
block|}
block|,
block|{
literal|2400
block|,
literal|11
block|}
block|,
block|{
literal|4800
block|,
literal|12
block|}
block|,
block|{
literal|9600
block|,
literal|13
block|}
block|,
block|{
literal|19200
block|,
literal|14
block|}
block|,
block|{
literal|38400
block|,
literal|15
block|}
block|,
block|{
operator|-
literal|1
block|,
operator|-
literal|1
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|u_long
name|s2btab
index|[]
init|=
block|{
literal|0
block|,
literal|50
block|,
literal|75
block|,
literal|110
block|,
literal|134
block|,
literal|150
block|,
literal|200
block|,
literal|300
block|,
literal|600
block|,
literal|1200
block|,
literal|1800
block|,
literal|2400
block|,
literal|4800
block|,
literal|9600
block|,
literal|19200
block|,
literal|38400
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|stios2btios
parameter_list|(
name|st
parameter_list|,
name|bt
parameter_list|)
name|struct
name|ibcs2_termios
modifier|*
name|st
decl_stmt|;
name|struct
name|termios
modifier|*
name|bt
decl_stmt|;
block|{
specifier|register
name|u_long
name|l
decl_stmt|,
name|r
decl_stmt|;
name|l
operator|=
name|st
operator|->
name|c_iflag
expr_stmt|;
name|r
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|l
operator|&
name|IBCS2_IGNBRK
condition|)
name|r
operator||=
name|IGNBRK
expr_stmt|;
if|if
condition|(
name|l
operator|&
name|IBCS2_BRKINT
condition|)
name|r
operator||=
name|BRKINT
expr_stmt|;
if|if
condition|(
name|l
operator|&
name|IBCS2_IGNPAR
condition|)
name|r
operator||=
name|IGNPAR
expr_stmt|;
if|if
condition|(
name|l
operator|&
name|IBCS2_PARMRK
condition|)
name|r
operator||=
name|PARMRK
expr_stmt|;
if|if
condition|(
name|l
operator|&
name|IBCS2_INPCK
condition|)
name|r
operator||=
name|INPCK
expr_stmt|;
if|if
condition|(
name|l
operator|&
name|IBCS2_ISTRIP
condition|)
name|r
operator||=
name|ISTRIP
expr_stmt|;
if|if
condition|(
name|l
operator|&
name|IBCS2_INLCR
condition|)
name|r
operator||=
name|INLCR
expr_stmt|;
if|if
condition|(
name|l
operator|&
name|IBCS2_IGNCR
condition|)
name|r
operator||=
name|IGNCR
expr_stmt|;
if|if
condition|(
name|l
operator|&
name|IBCS2_ICRNL
condition|)
name|r
operator||=
name|ICRNL
expr_stmt|;
if|if
condition|(
name|l
operator|&
name|IBCS2_IXON
condition|)
name|r
operator||=
name|IXON
expr_stmt|;
if|if
condition|(
name|l
operator|&
name|IBCS2_IXANY
condition|)
name|r
operator||=
name|IXANY
expr_stmt|;
if|if
condition|(
name|l
operator|&
name|IBCS2_IXOFF
condition|)
name|r
operator||=
name|IXOFF
expr_stmt|;
if|if
condition|(
name|l
operator|&
name|IBCS2_IMAXBEL
condition|)
name|r
operator||=
name|IMAXBEL
expr_stmt|;
name|bt
operator|->
name|c_iflag
operator|=
name|r
expr_stmt|;
name|l
operator|=
name|st
operator|->
name|c_oflag
expr_stmt|;
name|r
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|l
operator|&
name|IBCS2_OPOST
condition|)
name|r
operator||=
name|OPOST
expr_stmt|;
if|if
condition|(
name|l
operator|&
name|IBCS2_ONLCR
condition|)
name|r
operator||=
name|ONLCR
expr_stmt|;
if|if
condition|(
name|l
operator|&
name|IBCS2_TAB3
condition|)
name|r
operator||=
name|OXTABS
expr_stmt|;
name|bt
operator|->
name|c_oflag
operator|=
name|r
expr_stmt|;
name|l
operator|=
name|st
operator|->
name|c_cflag
expr_stmt|;
name|r
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|l
operator|&
name|IBCS2_CSIZE
condition|)
block|{
case|case
name|IBCS2_CS5
case|:
name|r
operator||=
name|CS5
expr_stmt|;
break|break;
case|case
name|IBCS2_CS6
case|:
name|r
operator||=
name|CS6
expr_stmt|;
break|break;
case|case
name|IBCS2_CS7
case|:
name|r
operator||=
name|CS7
expr_stmt|;
break|break;
case|case
name|IBCS2_CS8
case|:
name|r
operator||=
name|CS8
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|l
operator|&
name|IBCS2_CSTOPB
condition|)
name|r
operator||=
name|CSTOPB
expr_stmt|;
if|if
condition|(
name|l
operator|&
name|IBCS2_CREAD
condition|)
name|r
operator||=
name|CREAD
expr_stmt|;
if|if
condition|(
name|l
operator|&
name|IBCS2_PARENB
condition|)
name|r
operator||=
name|PARENB
expr_stmt|;
if|if
condition|(
name|l
operator|&
name|IBCS2_PARODD
condition|)
name|r
operator||=
name|PARODD
expr_stmt|;
if|if
condition|(
name|l
operator|&
name|IBCS2_HUPCL
condition|)
name|r
operator||=
name|HUPCL
expr_stmt|;
if|if
condition|(
name|l
operator|&
name|IBCS2_CLOCAL
condition|)
name|r
operator||=
name|CLOCAL
expr_stmt|;
name|bt
operator|->
name|c_cflag
operator|=
name|r
expr_stmt|;
name|l
operator|=
name|st
operator|->
name|c_lflag
expr_stmt|;
name|r
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|l
operator|&
name|IBCS2_ISIG
condition|)
name|r
operator||=
name|ISIG
expr_stmt|;
if|if
condition|(
name|l
operator|&
name|IBCS2_ICANON
condition|)
name|r
operator||=
name|ICANON
expr_stmt|;
if|if
condition|(
name|l
operator|&
name|IBCS2_ECHO
condition|)
name|r
operator||=
name|ECHO
expr_stmt|;
if|if
condition|(
name|l
operator|&
name|IBCS2_ECHOE
condition|)
name|r
operator||=
name|ECHOE
expr_stmt|;
if|if
condition|(
name|l
operator|&
name|IBCS2_ECHOK
condition|)
name|r
operator||=
name|ECHOK
expr_stmt|;
if|if
condition|(
name|l
operator|&
name|IBCS2_ECHONL
condition|)
name|r
operator||=
name|ECHONL
expr_stmt|;
if|if
condition|(
name|l
operator|&
name|IBCS2_NOFLSH
condition|)
name|r
operator||=
name|NOFLSH
expr_stmt|;
if|if
condition|(
name|l
operator|&
name|IBCS2_TOSTOP
condition|)
name|r
operator||=
name|TOSTOP
expr_stmt|;
name|bt
operator|->
name|c_lflag
operator|=
name|r
expr_stmt|;
name|bt
operator|->
name|c_ispeed
operator|=
name|bt
operator|->
name|c_ospeed
operator|=
name|s2btab
index|[
name|l
operator|&
literal|0x0000000f
index|]
expr_stmt|;
name|bt
operator|->
name|c_cc
index|[
name|VINTR
index|]
operator|=
name|st
operator|->
name|c_cc
index|[
name|IBCS2_VINTR
index|]
condition|?
name|st
operator|->
name|c_cc
index|[
name|IBCS2_VINTR
index|]
else|:
name|_POSIX_VDISABLE
expr_stmt|;
name|bt
operator|->
name|c_cc
index|[
name|VQUIT
index|]
operator|=
name|st
operator|->
name|c_cc
index|[
name|IBCS2_VQUIT
index|]
condition|?
name|st
operator|->
name|c_cc
index|[
name|IBCS2_VQUIT
index|]
else|:
name|_POSIX_VDISABLE
expr_stmt|;
name|bt
operator|->
name|c_cc
index|[
name|VERASE
index|]
operator|=
name|st
operator|->
name|c_cc
index|[
name|IBCS2_VERASE
index|]
condition|?
name|st
operator|->
name|c_cc
index|[
name|IBCS2_VERASE
index|]
else|:
name|_POSIX_VDISABLE
expr_stmt|;
name|bt
operator|->
name|c_cc
index|[
name|VKILL
index|]
operator|=
name|st
operator|->
name|c_cc
index|[
name|IBCS2_VKILL
index|]
condition|?
name|st
operator|->
name|c_cc
index|[
name|IBCS2_VKILL
index|]
else|:
name|_POSIX_VDISABLE
expr_stmt|;
if|if
condition|(
name|bt
operator|->
name|c_lflag
operator|&
name|ICANON
condition|)
block|{
name|bt
operator|->
name|c_cc
index|[
name|VEOF
index|]
operator|=
name|st
operator|->
name|c_cc
index|[
name|IBCS2_VEOF
index|]
condition|?
name|st
operator|->
name|c_cc
index|[
name|IBCS2_VEOF
index|]
else|:
name|_POSIX_VDISABLE
expr_stmt|;
name|bt
operator|->
name|c_cc
index|[
name|VEOL
index|]
operator|=
name|st
operator|->
name|c_cc
index|[
name|IBCS2_VEOL
index|]
condition|?
name|st
operator|->
name|c_cc
index|[
name|IBCS2_VEOL
index|]
else|:
name|_POSIX_VDISABLE
expr_stmt|;
block|}
else|else
block|{
name|bt
operator|->
name|c_cc
index|[
name|VMIN
index|]
operator|=
name|st
operator|->
name|c_cc
index|[
name|IBCS2_VMIN
index|]
expr_stmt|;
name|bt
operator|->
name|c_cc
index|[
name|VTIME
index|]
operator|=
name|st
operator|->
name|c_cc
index|[
name|IBCS2_VTIME
index|]
expr_stmt|;
block|}
name|bt
operator|->
name|c_cc
index|[
name|VEOL2
index|]
operator|=
name|st
operator|->
name|c_cc
index|[
name|IBCS2_VEOL2
index|]
condition|?
name|st
operator|->
name|c_cc
index|[
name|IBCS2_VEOL2
index|]
else|:
name|_POSIX_VDISABLE
expr_stmt|;
if|#
directive|if
literal|0
block|bt->c_cc[VSWTCH] = 	    st->c_cc[IBCS2_VSWTCH] ? st->c_cc[IBCS2_VSWTCH] : _POSIX_VDISABLE;
endif|#
directive|endif
name|bt
operator|->
name|c_cc
index|[
name|VSTART
index|]
operator|=
name|st
operator|->
name|c_cc
index|[
name|IBCS2_VSTART
index|]
condition|?
name|st
operator|->
name|c_cc
index|[
name|IBCS2_VSTART
index|]
else|:
name|_POSIX_VDISABLE
expr_stmt|;
name|bt
operator|->
name|c_cc
index|[
name|VSTOP
index|]
operator|=
name|st
operator|->
name|c_cc
index|[
name|IBCS2_VSTOP
index|]
condition|?
name|st
operator|->
name|c_cc
index|[
name|IBCS2_VSTOP
index|]
else|:
name|_POSIX_VDISABLE
expr_stmt|;
name|bt
operator|->
name|c_cc
index|[
name|VSUSP
index|]
operator|=
name|st
operator|->
name|c_cc
index|[
name|IBCS2_VSUSP
index|]
condition|?
name|st
operator|->
name|c_cc
index|[
name|IBCS2_VSUSP
index|]
else|:
name|_POSIX_VDISABLE
expr_stmt|;
name|bt
operator|->
name|c_cc
index|[
name|VDSUSP
index|]
operator|=
name|_POSIX_VDISABLE
expr_stmt|;
name|bt
operator|->
name|c_cc
index|[
name|VREPRINT
index|]
operator|=
name|_POSIX_VDISABLE
expr_stmt|;
name|bt
operator|->
name|c_cc
index|[
name|VDISCARD
index|]
operator|=
name|_POSIX_VDISABLE
expr_stmt|;
name|bt
operator|->
name|c_cc
index|[
name|VWERASE
index|]
operator|=
name|_POSIX_VDISABLE
expr_stmt|;
name|bt
operator|->
name|c_cc
index|[
name|VLNEXT
index|]
operator|=
name|_POSIX_VDISABLE
expr_stmt|;
name|bt
operator|->
name|c_cc
index|[
name|VSTATUS
index|]
operator|=
name|_POSIX_VDISABLE
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|btios2stios
parameter_list|(
name|bt
parameter_list|,
name|st
parameter_list|)
name|struct
name|termios
modifier|*
name|bt
decl_stmt|;
name|struct
name|ibcs2_termios
modifier|*
name|st
decl_stmt|;
block|{
specifier|register
name|u_long
name|l
decl_stmt|,
name|r
decl_stmt|;
name|l
operator|=
name|bt
operator|->
name|c_iflag
expr_stmt|;
name|r
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|l
operator|&
name|IGNBRK
condition|)
name|r
operator||=
name|IBCS2_IGNBRK
expr_stmt|;
if|if
condition|(
name|l
operator|&
name|BRKINT
condition|)
name|r
operator||=
name|IBCS2_BRKINT
expr_stmt|;
if|if
condition|(
name|l
operator|&
name|IGNPAR
condition|)
name|r
operator||=
name|IBCS2_IGNPAR
expr_stmt|;
if|if
condition|(
name|l
operator|&
name|PARMRK
condition|)
name|r
operator||=
name|IBCS2_PARMRK
expr_stmt|;
if|if
condition|(
name|l
operator|&
name|INPCK
condition|)
name|r
operator||=
name|IBCS2_INPCK
expr_stmt|;
if|if
condition|(
name|l
operator|&
name|ISTRIP
condition|)
name|r
operator||=
name|IBCS2_ISTRIP
expr_stmt|;
if|if
condition|(
name|l
operator|&
name|INLCR
condition|)
name|r
operator||=
name|IBCS2_INLCR
expr_stmt|;
if|if
condition|(
name|l
operator|&
name|IGNCR
condition|)
name|r
operator||=
name|IBCS2_IGNCR
expr_stmt|;
if|if
condition|(
name|l
operator|&
name|ICRNL
condition|)
name|r
operator||=
name|IBCS2_ICRNL
expr_stmt|;
if|if
condition|(
name|l
operator|&
name|IXON
condition|)
name|r
operator||=
name|IBCS2_IXON
expr_stmt|;
if|if
condition|(
name|l
operator|&
name|IXANY
condition|)
name|r
operator||=
name|IBCS2_IXANY
expr_stmt|;
if|if
condition|(
name|l
operator|&
name|IXOFF
condition|)
name|r
operator||=
name|IBCS2_IXOFF
expr_stmt|;
if|if
condition|(
name|l
operator|&
name|IMAXBEL
condition|)
name|r
operator||=
name|IBCS2_IMAXBEL
expr_stmt|;
name|st
operator|->
name|c_iflag
operator|=
name|r
expr_stmt|;
name|l
operator|=
name|bt
operator|->
name|c_oflag
expr_stmt|;
name|r
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|l
operator|&
name|OPOST
condition|)
name|r
operator||=
name|IBCS2_OPOST
expr_stmt|;
if|if
condition|(
name|l
operator|&
name|ONLCR
condition|)
name|r
operator||=
name|IBCS2_ONLCR
expr_stmt|;
if|if
condition|(
name|l
operator|&
name|OXTABS
condition|)
name|r
operator||=
name|IBCS2_TAB3
expr_stmt|;
name|st
operator|->
name|c_oflag
operator|=
name|r
expr_stmt|;
name|l
operator|=
name|bt
operator|->
name|c_cflag
expr_stmt|;
name|r
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|l
operator|&
name|CSIZE
condition|)
block|{
case|case
name|CS5
case|:
name|r
operator||=
name|IBCS2_CS5
expr_stmt|;
break|break;
case|case
name|CS6
case|:
name|r
operator||=
name|IBCS2_CS6
expr_stmt|;
break|break;
case|case
name|CS7
case|:
name|r
operator||=
name|IBCS2_CS7
expr_stmt|;
break|break;
case|case
name|CS8
case|:
name|r
operator||=
name|IBCS2_CS8
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|l
operator|&
name|CSTOPB
condition|)
name|r
operator||=
name|IBCS2_CSTOPB
expr_stmt|;
if|if
condition|(
name|l
operator|&
name|CREAD
condition|)
name|r
operator||=
name|IBCS2_CREAD
expr_stmt|;
if|if
condition|(
name|l
operator|&
name|PARENB
condition|)
name|r
operator||=
name|IBCS2_PARENB
expr_stmt|;
if|if
condition|(
name|l
operator|&
name|PARODD
condition|)
name|r
operator||=
name|IBCS2_PARODD
expr_stmt|;
if|if
condition|(
name|l
operator|&
name|HUPCL
condition|)
name|r
operator||=
name|IBCS2_HUPCL
expr_stmt|;
if|if
condition|(
name|l
operator|&
name|CLOCAL
condition|)
name|r
operator||=
name|IBCS2_CLOCAL
expr_stmt|;
name|st
operator|->
name|c_cflag
operator|=
name|r
expr_stmt|;
name|l
operator|=
name|bt
operator|->
name|c_lflag
expr_stmt|;
name|r
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|l
operator|&
name|ISIG
condition|)
name|r
operator||=
name|IBCS2_ISIG
expr_stmt|;
if|if
condition|(
name|l
operator|&
name|ICANON
condition|)
name|r
operator||=
name|IBCS2_ICANON
expr_stmt|;
if|if
condition|(
name|l
operator|&
name|ECHO
condition|)
name|r
operator||=
name|IBCS2_ECHO
expr_stmt|;
if|if
condition|(
name|l
operator|&
name|ECHOE
condition|)
name|r
operator||=
name|IBCS2_ECHOE
expr_stmt|;
if|if
condition|(
name|l
operator|&
name|ECHOK
condition|)
name|r
operator||=
name|IBCS2_ECHOK
expr_stmt|;
if|if
condition|(
name|l
operator|&
name|ECHONL
condition|)
name|r
operator||=
name|IBCS2_ECHONL
expr_stmt|;
if|if
condition|(
name|l
operator|&
name|NOFLSH
condition|)
name|r
operator||=
name|IBCS2_NOFLSH
expr_stmt|;
if|if
condition|(
name|l
operator|&
name|TOSTOP
condition|)
name|r
operator||=
name|IBCS2_TOSTOP
expr_stmt|;
name|st
operator|->
name|c_lflag
operator|=
name|r
expr_stmt|;
name|l
operator|=
name|ttspeedtab
argument_list|(
name|bt
operator|->
name|c_ospeed
argument_list|,
name|sptab
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|int
operator|)
name|l
operator|>=
literal|0
condition|)
name|st
operator|->
name|c_cflag
operator||=
name|l
expr_stmt|;
name|st
operator|->
name|c_cc
index|[
name|IBCS2_VINTR
index|]
operator|=
name|bt
operator|->
name|c_cc
index|[
name|VINTR
index|]
operator|!=
name|_POSIX_VDISABLE
condition|?
name|bt
operator|->
name|c_cc
index|[
name|VINTR
index|]
else|:
literal|0
expr_stmt|;
name|st
operator|->
name|c_cc
index|[
name|IBCS2_VQUIT
index|]
operator|=
name|bt
operator|->
name|c_cc
index|[
name|VQUIT
index|]
operator|!=
name|_POSIX_VDISABLE
condition|?
name|bt
operator|->
name|c_cc
index|[
name|VQUIT
index|]
else|:
literal|0
expr_stmt|;
name|st
operator|->
name|c_cc
index|[
name|IBCS2_VERASE
index|]
operator|=
name|bt
operator|->
name|c_cc
index|[
name|VERASE
index|]
operator|!=
name|_POSIX_VDISABLE
condition|?
name|bt
operator|->
name|c_cc
index|[
name|VERASE
index|]
else|:
literal|0
expr_stmt|;
name|st
operator|->
name|c_cc
index|[
name|IBCS2_VKILL
index|]
operator|=
name|bt
operator|->
name|c_cc
index|[
name|VKILL
index|]
operator|!=
name|_POSIX_VDISABLE
condition|?
name|bt
operator|->
name|c_cc
index|[
name|VKILL
index|]
else|:
literal|0
expr_stmt|;
if|if
condition|(
name|bt
operator|->
name|c_lflag
operator|&
name|ICANON
condition|)
block|{
name|st
operator|->
name|c_cc
index|[
name|IBCS2_VEOF
index|]
operator|=
name|bt
operator|->
name|c_cc
index|[
name|VEOF
index|]
operator|!=
name|_POSIX_VDISABLE
condition|?
name|bt
operator|->
name|c_cc
index|[
name|VEOF
index|]
else|:
literal|0
expr_stmt|;
name|st
operator|->
name|c_cc
index|[
name|IBCS2_VEOL
index|]
operator|=
name|bt
operator|->
name|c_cc
index|[
name|VEOL
index|]
operator|!=
name|_POSIX_VDISABLE
condition|?
name|bt
operator|->
name|c_cc
index|[
name|VEOL
index|]
else|:
literal|0
expr_stmt|;
block|}
else|else
block|{
name|st
operator|->
name|c_cc
index|[
name|IBCS2_VMIN
index|]
operator|=
name|bt
operator|->
name|c_cc
index|[
name|VMIN
index|]
expr_stmt|;
name|st
operator|->
name|c_cc
index|[
name|IBCS2_VTIME
index|]
operator|=
name|bt
operator|->
name|c_cc
index|[
name|VTIME
index|]
expr_stmt|;
block|}
name|st
operator|->
name|c_cc
index|[
name|IBCS2_VEOL2
index|]
operator|=
name|bt
operator|->
name|c_cc
index|[
name|VEOL2
index|]
operator|!=
name|_POSIX_VDISABLE
condition|?
name|bt
operator|->
name|c_cc
index|[
name|VEOL2
index|]
else|:
literal|0
expr_stmt|;
name|st
operator|->
name|c_cc
index|[
name|IBCS2_VSWTCH
index|]
operator|=
literal|0
expr_stmt|;
name|st
operator|->
name|c_cc
index|[
name|IBCS2_VSUSP
index|]
operator|=
name|bt
operator|->
name|c_cc
index|[
name|VSUSP
index|]
operator|!=
name|_POSIX_VDISABLE
condition|?
name|bt
operator|->
name|c_cc
index|[
name|VSUSP
index|]
else|:
literal|0
expr_stmt|;
name|st
operator|->
name|c_cc
index|[
name|IBCS2_VSTART
index|]
operator|=
name|bt
operator|->
name|c_cc
index|[
name|VSTART
index|]
operator|!=
name|_POSIX_VDISABLE
condition|?
name|bt
operator|->
name|c_cc
index|[
name|VSTART
index|]
else|:
literal|0
expr_stmt|;
name|st
operator|->
name|c_cc
index|[
name|IBCS2_VSTOP
index|]
operator|=
name|bt
operator|->
name|c_cc
index|[
name|VSTOP
index|]
operator|!=
name|_POSIX_VDISABLE
condition|?
name|bt
operator|->
name|c_cc
index|[
name|VSTOP
index|]
else|:
literal|0
expr_stmt|;
name|st
operator|->
name|c_line
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|stios2stio
parameter_list|(
name|ts
parameter_list|,
name|t
parameter_list|)
name|struct
name|ibcs2_termios
modifier|*
name|ts
decl_stmt|;
name|struct
name|ibcs2_termio
modifier|*
name|t
decl_stmt|;
block|{
name|t
operator|->
name|c_iflag
operator|=
name|ts
operator|->
name|c_iflag
expr_stmt|;
name|t
operator|->
name|c_oflag
operator|=
name|ts
operator|->
name|c_oflag
expr_stmt|;
name|t
operator|->
name|c_cflag
operator|=
name|ts
operator|->
name|c_cflag
expr_stmt|;
name|t
operator|->
name|c_lflag
operator|=
name|ts
operator|->
name|c_lflag
expr_stmt|;
name|t
operator|->
name|c_line
operator|=
name|ts
operator|->
name|c_line
expr_stmt|;
name|bcopy
argument_list|(
name|ts
operator|->
name|c_cc
argument_list|,
name|t
operator|->
name|c_cc
argument_list|,
name|IBCS2_NCC
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|stio2stios
parameter_list|(
name|t
parameter_list|,
name|ts
parameter_list|)
name|struct
name|ibcs2_termio
modifier|*
name|t
decl_stmt|;
name|struct
name|ibcs2_termios
modifier|*
name|ts
decl_stmt|;
block|{
name|ts
operator|->
name|c_iflag
operator|=
name|t
operator|->
name|c_iflag
expr_stmt|;
name|ts
operator|->
name|c_oflag
operator|=
name|t
operator|->
name|c_oflag
expr_stmt|;
name|ts
operator|->
name|c_cflag
operator|=
name|t
operator|->
name|c_cflag
expr_stmt|;
name|ts
operator|->
name|c_lflag
operator|=
name|t
operator|->
name|c_lflag
expr_stmt|;
name|ts
operator|->
name|c_line
operator|=
name|t
operator|->
name|c_line
expr_stmt|;
name|bcopy
argument_list|(
name|t
operator|->
name|c_cc
argument_list|,
name|ts
operator|->
name|c_cc
argument_list|,
name|IBCS2_NCC
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|ibcs2_ioctl
parameter_list|(
name|p
parameter_list|,
name|uap
parameter_list|,
name|retval
parameter_list|)
name|struct
name|proc
modifier|*
name|p
decl_stmt|;
name|struct
name|ibcs2_ioctl_args
modifier|*
name|uap
decl_stmt|;
name|int
modifier|*
name|retval
decl_stmt|;
block|{
name|struct
name|filedesc
modifier|*
name|fdp
init|=
name|p
operator|->
name|p_fd
decl_stmt|;
name|struct
name|file
modifier|*
name|fp
decl_stmt|;
name|int
argument_list|(
argument|*ctl
argument_list|)
name|__P
argument_list|(
operator|(
expr|struct
name|file
operator|*
operator|,
name|int
operator|,
name|caddr_t
operator|,
expr|struct
name|proc
operator|*
operator|)
argument_list|)
expr_stmt|;
name|int
name|error
decl_stmt|;
if|if
condition|(
name|SCARG
argument_list|(
name|uap
argument_list|,
name|fd
argument_list|)
operator|<
literal|0
operator|||
name|SCARG
argument_list|(
name|uap
argument_list|,
name|fd
argument_list|)
operator|>=
name|fdp
operator|->
name|fd_nfiles
operator|||
operator|(
name|fp
operator|=
name|fdp
operator|->
name|fd_ofiles
index|[
name|SCARG
argument_list|(
name|uap
argument_list|,
name|fd
argument_list|)
index|]
operator|)
operator|==
name|NULL
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"ibcs2_ioctl(%d): bad fd %d "
operator|,
name|p
operator|->
name|p_pid
operator|,
name|SCARG
argument_list|(
name|uap
argument_list|,
name|fd
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|EBADF
return|;
block|}
if|if
condition|(
operator|(
name|fp
operator|->
name|f_flag
operator|&
operator|(
name|FREAD
operator||
name|FWRITE
operator|)
operator|)
operator|==
literal|0
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"ibcs2_ioctl(%d): bad fp flag "
operator|,
name|p
operator|->
name|p_pid
operator|)
argument_list|)
expr_stmt|;
return|return
name|EBADF
return|;
block|}
name|ctl
operator|=
name|fp
operator|->
name|f_ops
operator|->
name|fo_ioctl
expr_stmt|;
switch|switch
condition|(
name|SCARG
argument_list|(
name|uap
argument_list|,
name|cmd
argument_list|)
condition|)
block|{
case|case
name|IBCS2_TCGETA
case|:
case|case
name|IBCS2_XCGETA
case|:
case|case
name|IBCS2_OXCGETA
case|:
block|{
name|struct
name|termios
name|bts
decl_stmt|;
name|struct
name|ibcs2_termios
name|sts
decl_stmt|;
name|struct
name|ibcs2_termio
name|st
decl_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
call|(
modifier|*
name|ctl
call|)
argument_list|(
name|fp
argument_list|,
name|TIOCGETA
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|bts
argument_list|,
name|p
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|error
return|;
name|btios2stios
argument_list|(
operator|&
name|bts
argument_list|,
operator|&
name|sts
argument_list|)
expr_stmt|;
if|if
condition|(
name|SCARG
argument_list|(
name|uap
argument_list|,
name|cmd
argument_list|)
operator|==
name|IBCS2_TCGETA
condition|)
block|{
name|stios2stio
argument_list|(
operator|&
name|sts
argument_list|,
operator|&
name|st
argument_list|)
expr_stmt|;
name|error
operator|=
name|copyout
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
name|st
argument_list|,
name|SCARG
argument_list|(
name|uap
argument_list|,
name|data
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|st
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG_IBCS2
if|if
condition|(
name|error
condition|)
name|DPRINTF
argument_list|(
operator|(
literal|"ibcs2_ioctl(%d): copyout failed "
operator|,
name|p
operator|->
name|p_pid
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|error
return|;
block|}
else|else
return|return
name|copyout
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
name|sts
argument_list|,
name|SCARG
argument_list|(
name|uap
argument_list|,
name|data
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|sts
argument_list|)
argument_list|)
return|;
comment|/*NOTREACHED*/
block|}
case|case
name|IBCS2_TCSETA
case|:
case|case
name|IBCS2_TCSETAW
case|:
case|case
name|IBCS2_TCSETAF
case|:
block|{
name|struct
name|termios
name|bts
decl_stmt|;
name|struct
name|ibcs2_termios
name|sts
decl_stmt|;
name|struct
name|ibcs2_termio
name|st
decl_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|copyin
argument_list|(
name|SCARG
argument_list|(
name|uap
argument_list|,
name|data
argument_list|)
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|st
argument_list|,
sizeof|sizeof
argument_list|(
name|st
argument_list|)
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"ibcs2_ioctl(%d): TCSET copyin failed "
operator|,
name|p
operator|->
name|p_pid
operator|)
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
comment|/* get full BSD termios so we don't lose information */
if|if
condition|(
operator|(
name|error
operator|=
call|(
modifier|*
name|ctl
call|)
argument_list|(
name|fp
argument_list|,
name|TIOCGETA
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|bts
argument_list|,
name|p
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"ibcs2_ioctl(%d): TCSET ctl failed fd %d "
operator|,
name|p
operator|->
name|p_pid
operator|,
name|SCARG
argument_list|(
name|uap
argument_list|,
name|fd
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
comment|/* 		 * convert to iBCS2 termios, copy in information from 		 * termio, and convert back, then set new values. 		 */
name|btios2stios
argument_list|(
operator|&
name|bts
argument_list|,
operator|&
name|sts
argument_list|)
expr_stmt|;
name|stio2stios
argument_list|(
operator|&
name|st
argument_list|,
operator|&
name|sts
argument_list|)
expr_stmt|;
name|stios2btios
argument_list|(
operator|&
name|sts
argument_list|,
operator|&
name|bts
argument_list|)
expr_stmt|;
return|return
call|(
modifier|*
name|ctl
call|)
argument_list|(
name|fp
argument_list|,
name|SCARG
argument_list|(
name|uap
argument_list|,
name|cmd
argument_list|)
operator|-
name|IBCS2_TCSETA
operator|+
name|TIOCSETA
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|bts
argument_list|,
name|p
argument_list|)
return|;
block|}
case|case
name|IBCS2_XCSETA
case|:
case|case
name|IBCS2_XCSETAW
case|:
case|case
name|IBCS2_XCSETAF
case|:
block|{
name|struct
name|termios
name|bts
decl_stmt|;
name|struct
name|ibcs2_termios
name|sts
decl_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|copyin
argument_list|(
name|SCARG
argument_list|(
name|uap
argument_list|,
name|data
argument_list|)
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|sts
argument_list|,
sizeof|sizeof
argument_list|(
name|sts
argument_list|)
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
return|return
name|error
return|;
block|}
name|stios2btios
argument_list|(
operator|&
name|sts
argument_list|,
operator|&
name|bts
argument_list|)
expr_stmt|;
return|return
call|(
modifier|*
name|ctl
call|)
argument_list|(
name|fp
argument_list|,
name|SCARG
argument_list|(
name|uap
argument_list|,
name|cmd
argument_list|)
operator|-
name|IBCS2_XCSETA
operator|+
name|TIOCSETA
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|bts
argument_list|,
name|p
argument_list|)
return|;
block|}
case|case
name|IBCS2_OXCSETA
case|:
case|case
name|IBCS2_OXCSETAW
case|:
case|case
name|IBCS2_OXCSETAF
case|:
block|{
name|struct
name|termios
name|bts
decl_stmt|;
name|struct
name|ibcs2_termios
name|sts
decl_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|copyin
argument_list|(
name|SCARG
argument_list|(
name|uap
argument_list|,
name|data
argument_list|)
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|sts
argument_list|,
sizeof|sizeof
argument_list|(
name|sts
argument_list|)
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
return|return
name|error
return|;
block|}
name|stios2btios
argument_list|(
operator|&
name|sts
argument_list|,
operator|&
name|bts
argument_list|)
expr_stmt|;
return|return
call|(
modifier|*
name|ctl
call|)
argument_list|(
name|fp
argument_list|,
name|SCARG
argument_list|(
name|uap
argument_list|,
name|cmd
argument_list|)
operator|-
name|IBCS2_OXCSETA
operator|+
name|TIOCSETA
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|bts
argument_list|,
name|p
argument_list|)
return|;
block|}
case|case
name|IBCS2_TCSBRK
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"ibcs2_ioctl(%d): TCSBRK "
operator|,
name|p
operator|->
name|p_pid
operator|)
argument_list|)
expr_stmt|;
return|return
name|ENOSYS
return|;
case|case
name|IBCS2_TCXONC
case|:
block|{
switch|switch
condition|(
operator|(
name|int
operator|)
name|SCARG
argument_list|(
name|uap
argument_list|,
name|data
argument_list|)
condition|)
block|{
case|case
literal|0
case|:
case|case
literal|1
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"ibcs2_ioctl(%d): TCXONC "
operator|,
name|p
operator|->
name|p_pid
operator|)
argument_list|)
expr_stmt|;
return|return
name|ENOSYS
return|;
case|case
literal|2
case|:
return|return
call|(
modifier|*
name|ctl
call|)
argument_list|(
name|fp
argument_list|,
name|TIOCSTOP
argument_list|,
operator|(
name|caddr_t
operator|)
literal|0
argument_list|,
name|p
argument_list|)
return|;
case|case
literal|3
case|:
return|return
call|(
modifier|*
name|ctl
call|)
argument_list|(
name|fp
argument_list|,
name|TIOCSTART
argument_list|,
operator|(
name|caddr_t
operator|)
literal|1
argument_list|,
name|p
argument_list|)
return|;
default|default:
return|return
name|EINVAL
return|;
block|}
block|}
case|case
name|IBCS2_TCFLSH
case|:
block|{
name|int
name|arg
decl_stmt|;
switch|switch
condition|(
operator|(
name|int
operator|)
name|SCARG
argument_list|(
name|uap
argument_list|,
name|data
argument_list|)
condition|)
block|{
case|case
literal|0
case|:
name|arg
operator|=
name|FREAD
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|arg
operator|=
name|FWRITE
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|arg
operator|=
name|FREAD
operator||
name|FWRITE
expr_stmt|;
break|break;
default|default:
return|return
name|EINVAL
return|;
block|}
return|return
call|(
modifier|*
name|ctl
call|)
argument_list|(
name|fp
argument_list|,
name|TIOCFLUSH
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|arg
argument_list|,
name|p
argument_list|)
return|;
block|}
case|case
name|IBCS2_TIOCGWINSZ
case|:
name|SCARG
argument_list|(
name|uap
argument_list|,
name|cmd
argument_list|)
operator|=
name|TIOCGWINSZ
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|uap
argument_list|,
name|retval
argument_list|)
return|;
case|case
name|IBCS2_TIOCSWINSZ
case|:
name|SCARG
argument_list|(
name|uap
argument_list|,
name|cmd
argument_list|)
operator|=
name|TIOCSWINSZ
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|uap
argument_list|,
name|retval
argument_list|)
return|;
case|case
name|IBCS2_TIOCGPGRP
case|:
return|return
name|copyout
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
name|p
operator|->
name|p_pgrp
operator|->
name|pg_id
argument_list|,
name|SCARG
argument_list|(
name|uap
argument_list|,
name|data
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|p
operator|->
name|p_pgrp
operator|->
name|pg_id
argument_list|)
argument_list|)
return|;
case|case
name|IBCS2_TIOCSPGRP
case|:
comment|/* XXX - is uap->data a pointer to pgid? */
block|{
name|struct
name|setpgid_args
name|sa
decl_stmt|;
name|SCARG
argument_list|(
operator|&
name|sa
argument_list|,
name|pid
argument_list|)
operator|=
literal|0
expr_stmt|;
name|SCARG
argument_list|(
operator|&
name|sa
argument_list|,
name|pgid
argument_list|)
operator|=
operator|(
name|int
operator|)
name|SCARG
argument_list|(
name|uap
argument_list|,
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|=
name|setpgid
argument_list|(
name|p
argument_list|,
operator|&
name|sa
argument_list|,
name|retval
argument_list|)
condition|)
return|return
name|error
return|;
return|return
literal|0
return|;
block|}
case|case
name|IBCS2_TCGETSC
case|:
comment|/* SCO console - get scancode flags */
return|return
name|EINTR
return|;
comment|/* ENOSYS; */
case|case
name|IBCS2_TCSETSC
case|:
comment|/* SCO console - set scancode flags */
return|return
literal|0
return|;
comment|/* ENOSYS; */
case|case
name|IBCS2_JWINSIZE
case|:
comment|/* Unix to Jerq I/O control */
block|{
struct|struct
name|ibcs2_jwinsize
block|{
name|char
name|bytex
decl_stmt|,
name|bytey
decl_stmt|;
name|short
name|bitx
decl_stmt|,
name|bity
decl_stmt|;
block|}
name|ibcs2_jwinsize
struct|;
name|ibcs2_jwinsize
operator|.
name|bytex
operator|=
literal|80
expr_stmt|;
comment|/* p->p_session->s_ttyp->t_winsize.ws_col; XXX */
name|ibcs2_jwinsize
operator|.
name|bytey
operator|=
literal|25
expr_stmt|;
comment|/* p->p_session->s_ttyp->t_winsize.ws_row; XXX */
name|ibcs2_jwinsize
operator|.
name|bitx
operator|=
name|p
operator|->
name|p_session
operator|->
name|s_ttyp
operator|->
name|t_winsize
operator|.
name|ws_xpixel
expr_stmt|;
name|ibcs2_jwinsize
operator|.
name|bity
operator|=
name|p
operator|->
name|p_session
operator|->
name|s_ttyp
operator|->
name|t_winsize
operator|.
name|ws_ypixel
expr_stmt|;
return|return
name|copyout
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
name|ibcs2_jwinsize
argument_list|,
name|SCARG
argument_list|(
name|uap
argument_list|,
name|data
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|ibcs2_jwinsize
argument_list|)
argument_list|)
return|;
block|}
comment|/* keyboard and display ioctl's -- type 'K' */
case|case
name|IBCS2_KDGKBMODE
case|:
comment|/* get keyboard translation mode */
name|SCARG
argument_list|(
name|uap
argument_list|,
name|cmd
argument_list|)
operator|=
name|KDGKBMODE
expr_stmt|;
comment|/* printf("ioctl KDGKBMODE = %x\n", SCARG(uap, cmd));*/
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|uap
argument_list|,
name|retval
argument_list|)
return|;
case|case
name|IBCS2_KDSKBMODE
case|:
comment|/* set keyboard translation mode */
name|SCARG
argument_list|(
name|uap
argument_list|,
name|cmd
argument_list|)
operator|=
name|KDSKBMODE
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|uap
argument_list|,
name|retval
argument_list|)
return|;
case|case
name|IBCS2_KDMKTONE
case|:
comment|/* sound tone */
name|SCARG
argument_list|(
name|uap
argument_list|,
name|cmd
argument_list|)
operator|=
name|KDMKTONE
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|uap
argument_list|,
name|retval
argument_list|)
return|;
case|case
name|IBCS2_KDGETMODE
case|:
comment|/* get text/graphics mode */
name|SCARG
argument_list|(
name|uap
argument_list|,
name|cmd
argument_list|)
operator|=
name|KDGETMODE
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|uap
argument_list|,
name|retval
argument_list|)
return|;
case|case
name|IBCS2_KDSETMODE
case|:
comment|/* set text/graphics mode */
name|SCARG
argument_list|(
name|uap
argument_list|,
name|cmd
argument_list|)
operator|=
name|KDSETMODE
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|uap
argument_list|,
name|retval
argument_list|)
return|;
case|case
name|IBCS2_KDSBORDER
case|:
comment|/* set ega color border */
name|SCARG
argument_list|(
name|uap
argument_list|,
name|cmd
argument_list|)
operator|=
name|KDSBORDER
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|uap
argument_list|,
name|retval
argument_list|)
return|;
case|case
name|IBCS2_KDGKBSTATE
case|:
name|SCARG
argument_list|(
name|uap
argument_list|,
name|cmd
argument_list|)
operator|=
name|KDGKBSTATE
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|uap
argument_list|,
name|retval
argument_list|)
return|;
case|case
name|IBCS2_KDSETRAD
case|:
name|SCARG
argument_list|(
name|uap
argument_list|,
name|cmd
argument_list|)
operator|=
name|KDSETRAD
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|uap
argument_list|,
name|retval
argument_list|)
return|;
case|case
name|IBCS2_KDENABIO
case|:
comment|/* enable direct I/O to ports */
name|SCARG
argument_list|(
name|uap
argument_list|,
name|cmd
argument_list|)
operator|=
name|KDENABIO
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|uap
argument_list|,
name|retval
argument_list|)
return|;
case|case
name|IBCS2_KDDISABIO
case|:
comment|/* disable direct I/O to ports */
name|SCARG
argument_list|(
name|uap
argument_list|,
name|cmd
argument_list|)
operator|=
name|KDDISABIO
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|uap
argument_list|,
name|retval
argument_list|)
return|;
case|case
name|IBCS2_KIOCSOUND
case|:
comment|/* start sound generation */
name|SCARG
argument_list|(
name|uap
argument_list|,
name|cmd
argument_list|)
operator|=
name|KIOCSOUND
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|uap
argument_list|,
name|retval
argument_list|)
return|;
case|case
name|IBCS2_KDGKBTYPE
case|:
comment|/* get keyboard type */
name|SCARG
argument_list|(
name|uap
argument_list|,
name|cmd
argument_list|)
operator|=
name|KDGKBTYPE
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|uap
argument_list|,
name|retval
argument_list|)
return|;
case|case
name|IBCS2_KDGETLED
case|:
comment|/* get keyboard LED status */
name|SCARG
argument_list|(
name|uap
argument_list|,
name|cmd
argument_list|)
operator|=
name|KDGETLED
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|uap
argument_list|,
name|retval
argument_list|)
return|;
case|case
name|IBCS2_KDSETLED
case|:
comment|/* set keyboard LED status */
name|SCARG
argument_list|(
name|uap
argument_list|,
name|cmd
argument_list|)
operator|=
name|KDSETLED
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|uap
argument_list|,
name|retval
argument_list|)
return|;
comment|/* Xenix keyboard and display ioctl's from sys/kd.h -- type 'k' */
case|case
name|IBCS2_GETFKEY
case|:
comment|/* Get function key */
name|SCARG
argument_list|(
name|uap
argument_list|,
name|cmd
argument_list|)
operator|=
name|GETFKEY
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|uap
argument_list|,
name|retval
argument_list|)
return|;
case|case
name|IBCS2_SETFKEY
case|:
comment|/* Set function key */
name|SCARG
argument_list|(
name|uap
argument_list|,
name|cmd
argument_list|)
operator|=
name|SETFKEY
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|uap
argument_list|,
name|retval
argument_list|)
return|;
case|case
name|IBCS2_GIO_SCRNMAP
case|:
comment|/* Get screen output map table */
name|SCARG
argument_list|(
name|uap
argument_list|,
name|cmd
argument_list|)
operator|=
name|GIO_SCRNMAP
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|uap
argument_list|,
name|retval
argument_list|)
return|;
case|case
name|IBCS2_PIO_SCRNMAP
case|:
comment|/* Set screen output map table */
name|SCARG
argument_list|(
name|uap
argument_list|,
name|cmd
argument_list|)
operator|=
name|PIO_SCRNMAP
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|uap
argument_list|,
name|retval
argument_list|)
return|;
case|case
name|IBCS2_GIO_KEYMAP
case|:
comment|/* Get keyboard map table */
name|SCARG
argument_list|(
name|uap
argument_list|,
name|cmd
argument_list|)
operator|=
name|GIO_KEYMAP
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|uap
argument_list|,
name|retval
argument_list|)
return|;
case|case
name|IBCS2_PIO_KEYMAP
case|:
comment|/* Set keyboard map table */
name|SCARG
argument_list|(
name|uap
argument_list|,
name|cmd
argument_list|)
operator|=
name|PIO_KEYMAP
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|uap
argument_list|,
name|retval
argument_list|)
return|;
comment|/* socksys */
case|case
name|IBCS2_SIOCSOCKSYS
case|:
return|return
name|ibcs2_socksys
argument_list|(
name|p
argument_list|,
operator|(
expr|struct
name|ibcs2_socksys_args
operator|*
operator|)
name|uap
argument_list|,
name|retval
argument_list|)
return|;
case|case
name|IBCS2_I_NREAD
case|:
comment|/* STREAMS */
name|SCARG
argument_list|(
name|uap
argument_list|,
name|cmd
argument_list|)
operator|=
name|FIONREAD
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|p
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|uap
argument_list|,
name|retval
argument_list|)
return|;
default|default:
name|DPRINTF
argument_list|(
operator|(
literal|"ibcs2_ioctl(%d): unknown cmd 0x%lx "
operator|,
name|p
operator|->
name|p_pid
operator|,
name|SCARG
argument_list|(
name|uap
argument_list|,
name|cmd
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|ENOSYS
return|;
block|}
return|return
name|ENOSYS
return|;
block|}
end_function

end_unit


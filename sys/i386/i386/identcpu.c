begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 1992 Terrence R. Lambert.  * Copyright (c) 1982, 1987, 1990 The Regents of the University of California.  * Copyright (c) 1997 KATO Takenori.  * All rights reserved.  *  * This code is derived from software contributed to Berkeley by  * William Jolitz.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. All advertising materials mentioning features or use of this software  *    must display the following acknowledgement:  *	This product includes software developed by the University of  *	California, Berkeley and its contributors.  * 4. Neither the name of the University nor the names of its contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  *	from: Id: machdep.c,v 1.193 1996/06/18 01:22:04 bde Exp  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"opt_cpu.h"
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/cpu.h>
end_include

begin_include
include|#
directive|include
file|<sys/eventhandler.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/power.h>
end_include

begin_include
include|#
directive|include
file|<machine/asmacros.h>
end_include

begin_include
include|#
directive|include
file|<machine/clock.h>
end_include

begin_include
include|#
directive|include
file|<machine/cputypes.h>
end_include

begin_include
include|#
directive|include
file|<machine/intr_machdep.h>
end_include

begin_include
include|#
directive|include
file|<machine/md_var.h>
end_include

begin_include
include|#
directive|include
file|<machine/segments.h>
end_include

begin_include
include|#
directive|include
file|<machine/specialreg.h>
end_include

begin_define
define|#
directive|define
name|IDENTBLUE_CYRIX486
value|0
end_define

begin_define
define|#
directive|define
name|IDENTBLUE_IBMCPU
value|1
end_define

begin_define
define|#
directive|define
name|IDENTBLUE_CYRIXM2
value|2
end_define

begin_comment
comment|/* XXX - should be in header file: */
end_comment

begin_function_decl
name|void
name|printcpuinfo
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|finishidentcpu
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|earlysetcpuclass
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_if
if|#
directive|if
name|defined
argument_list|(
name|I586_CPU
argument_list|)
operator|&&
name|defined
argument_list|(
name|CPU_WT_ALLOC
argument_list|)
end_if

begin_function_decl
name|void
name|enable_K5_wt_alloc
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|enable_K6_wt_alloc
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|enable_K6_2_wt_alloc
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
name|void
name|panicifcpuunsupported
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|identifycyrix
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|init_exthigh
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u_int
name|find_cpu_vendor_id
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|print_AMD_info
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|print_INTEL_info
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|print_INTEL_TLB
parameter_list|(
name|u_int
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|print_AMD_assoc
parameter_list|(
name|int
name|i
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|print_transmeta_info
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|print_via_padlock_info
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
name|int
name|cpu_class
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_int
name|cpu_exthigh
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Highest arg to extended CPUID */
end_comment

begin_decl_stmt
name|u_int
name|cyrix_did
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Device ID of Cyrix CPU */
end_comment

begin_decl_stmt
name|char
name|machine
index|[]
init|=
name|MACHINE
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|SYSCTL_STRING
argument_list|(
name|_hw
argument_list|,
name|HW_MACHINE
argument_list|,
name|machine
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|machine
argument_list|,
literal|0
argument_list|,
literal|"Machine class"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|char
name|cpu_model
index|[
literal|128
index|]
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|SYSCTL_STRING
argument_list|(
name|_hw
argument_list|,
name|HW_MODEL
argument_list|,
name|model
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|cpu_model
argument_list|,
literal|0
argument_list|,
literal|"Machine model"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|int
name|hw_clockrate
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_hw
argument_list|,
name|OID_AUTO
argument_list|,
name|clockrate
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|hw_clockrate
argument_list|,
literal|0
argument_list|,
literal|"CPU instruction clock rate"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|char
name|cpu_brand
index|[
literal|48
index|]
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|MAX_BRAND_INDEX
value|8
end_define

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|cpu_brandtable
index|[
name|MAX_BRAND_INDEX
operator|+
literal|1
index|]
init|=
block|{
name|NULL
block|,
comment|/* No brand */
literal|"Intel Celeron"
block|,
literal|"Intel Pentium III"
block|,
literal|"Intel Pentium III Xeon"
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
literal|"Intel Pentium 4"
block|}
decl_stmt|;
end_decl_stmt

begin_struct
specifier|static
struct|struct
block|{
name|char
modifier|*
name|cpu_name
decl_stmt|;
name|int
name|cpu_class
decl_stmt|;
block|}
name|i386_cpus
index|[]
init|=
block|{
block|{
literal|"Intel 80286"
block|,
name|CPUCLASS_286
block|}
block|,
comment|/* CPU_286   */
block|{
literal|"i386SX"
block|,
name|CPUCLASS_386
block|}
block|,
comment|/* CPU_386SX */
block|{
literal|"i386DX"
block|,
name|CPUCLASS_386
block|}
block|,
comment|/* CPU_386   */
block|{
literal|"i486SX"
block|,
name|CPUCLASS_486
block|}
block|,
comment|/* CPU_486SX */
block|{
literal|"i486DX"
block|,
name|CPUCLASS_486
block|}
block|,
comment|/* CPU_486   */
block|{
literal|"Pentium"
block|,
name|CPUCLASS_586
block|}
block|,
comment|/* CPU_586   */
block|{
literal|"Cyrix 486"
block|,
name|CPUCLASS_486
block|}
block|,
comment|/* CPU_486DLC */
block|{
literal|"Pentium Pro"
block|,
name|CPUCLASS_686
block|}
block|,
comment|/* CPU_686 */
block|{
literal|"Cyrix 5x86"
block|,
name|CPUCLASS_486
block|}
block|,
comment|/* CPU_M1SC */
block|{
literal|"Cyrix 6x86"
block|,
name|CPUCLASS_486
block|}
block|,
comment|/* CPU_M1 */
block|{
literal|"Blue Lightning"
block|,
name|CPUCLASS_486
block|}
block|,
comment|/* CPU_BLUE */
block|{
literal|"Cyrix 6x86MX"
block|,
name|CPUCLASS_686
block|}
block|,
comment|/* CPU_M2 */
block|{
literal|"NexGen 586"
block|,
name|CPUCLASS_386
block|}
block|,
comment|/* CPU_NX586 (XXX) */
block|{
literal|"Cyrix 486S/DX"
block|,
name|CPUCLASS_486
block|}
block|,
comment|/* CPU_CY486DX */
block|{
literal|"Pentium II"
block|,
name|CPUCLASS_686
block|}
block|,
comment|/* CPU_PII */
block|{
literal|"Pentium III"
block|,
name|CPUCLASS_686
block|}
block|,
comment|/* CPU_PIII */
block|{
literal|"Pentium 4"
block|,
name|CPUCLASS_686
block|}
block|,
comment|/* CPU_P4 */
block|}
struct|;
end_struct

begin_struct
specifier|static
struct|struct
block|{
name|char
modifier|*
name|vendor
decl_stmt|;
name|u_int
name|vendor_id
decl_stmt|;
block|}
name|cpu_vendors
index|[]
init|=
block|{
block|{
name|INTEL_VENDOR_ID
block|,
name|CPU_VENDOR_INTEL
block|}
block|,
comment|/* GenuineIntel */
block|{
name|AMD_VENDOR_ID
block|,
name|CPU_VENDOR_AMD
block|}
block|,
comment|/* AuthenticAMD */
block|{
name|CENTAUR_VENDOR_ID
block|,
name|CPU_VENDOR_CENTAUR
block|}
block|,
comment|/* CentaurHauls */
block|{
name|NSC_VENDOR_ID
block|,
name|CPU_VENDOR_NSC
block|}
block|,
comment|/* Geode by NSC */
block|{
name|CYRIX_VENDOR_ID
block|,
name|CPU_VENDOR_CYRIX
block|}
block|,
comment|/* CyrixInstead */
block|{
name|TRANSMETA_VENDOR_ID
block|,
name|CPU_VENDOR_TRANSMETA
block|}
block|,
comment|/* GenuineTMx86 */
block|{
name|SIS_VENDOR_ID
block|,
name|CPU_VENDOR_SIS
block|}
block|,
comment|/* SiS SiS SiS  */
block|{
name|UMC_VENDOR_ID
block|,
name|CPU_VENDOR_UMC
block|}
block|,
comment|/* UMC UMC UMC  */
block|{
name|NEXGEN_VENDOR_ID
block|,
name|CPU_VENDOR_NEXGEN
block|}
block|,
comment|/* NexGenDriven */
block|{
name|RISE_VENDOR_ID
block|,
name|CPU_VENDOR_RISE
block|}
block|,
comment|/* RiseRiseRise */
if|#
directive|if
literal|0
comment|/* XXX CPUID 8000_0000h and 8086_0000h, not 0000_0000h */
block|{ "TransmetaCPU",	CPU_VENDOR_TRANSMETA },
endif|#
directive|endif
block|}
struct|;
end_struct

begin_if
if|#
directive|if
name|defined
argument_list|(
name|I586_CPU
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|NO_F00F_HACK
argument_list|)
end_if

begin_decl_stmt
name|int
name|has_f00f_bug
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Initialized so that it can be patched. */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|void
name|init_exthigh
parameter_list|(
name|void
parameter_list|)
block|{
specifier|static
name|int
name|done
init|=
literal|0
decl_stmt|;
name|u_int
name|regs
index|[
literal|4
index|]
decl_stmt|;
if|if
condition|(
name|done
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|cpu_high
operator|>
literal|0
operator|&&
operator|(
name|cpu_vendor_id
operator|==
name|CPU_VENDOR_INTEL
operator|||
name|cpu_vendor_id
operator|==
name|CPU_VENDOR_AMD
operator|||
name|cpu_vendor_id
operator|==
name|CPU_VENDOR_TRANSMETA
operator|||
name|cpu_vendor_id
operator|==
name|CPU_VENDOR_CENTAUR
operator|||
name|cpu_vendor_id
operator|==
name|CPU_VENDOR_NSC
operator|)
condition|)
block|{
name|do_cpuid
argument_list|(
literal|0x80000000
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
name|regs
index|[
literal|0
index|]
operator|>=
literal|0x80000000
condition|)
name|cpu_exthigh
operator|=
name|regs
index|[
literal|0
index|]
expr_stmt|;
block|}
name|done
operator|=
literal|1
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|printcpuinfo
parameter_list|(
name|void
parameter_list|)
block|{
name|u_int
name|regs
index|[
literal|4
index|]
decl_stmt|,
name|i
decl_stmt|;
name|char
modifier|*
name|brand
decl_stmt|;
name|cpu_class
operator|=
name|i386_cpus
index|[
name|cpu
index|]
operator|.
name|cpu_class
expr_stmt|;
name|printf
argument_list|(
literal|"CPU: "
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|cpu_model
argument_list|,
name|i386_cpus
index|[
name|cpu
index|]
operator|.
name|cpu_name
argument_list|,
sizeof|sizeof
argument_list|(
name|cpu_model
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Check for extended CPUID information and a processor name. */
name|init_exthigh
argument_list|()
expr_stmt|;
if|if
condition|(
name|cpu_exthigh
operator|>=
literal|0x80000004
condition|)
block|{
name|brand
operator|=
name|cpu_brand
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0x80000002
init|;
name|i
operator|<
literal|0x80000005
condition|;
name|i
operator|++
control|)
block|{
name|do_cpuid
argument_list|(
name|i
argument_list|,
name|regs
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|brand
argument_list|,
name|regs
argument_list|,
sizeof|sizeof
argument_list|(
name|regs
argument_list|)
argument_list|)
expr_stmt|;
name|brand
operator|+=
sizeof|sizeof
argument_list|(
name|regs
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|cpu_vendor_id
operator|==
name|CPU_VENDOR_INTEL
condition|)
block|{
if|if
condition|(
operator|(
name|cpu_id
operator|&
literal|0xf00
operator|)
operator|>
literal|0x300
condition|)
block|{
name|u_int
name|brand_index
decl_stmt|;
name|u_int
name|model
decl_stmt|;
name|cpu_model
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
switch|switch
condition|(
name|cpu_id
operator|&
literal|0x3000
condition|)
block|{
case|case
literal|0x1000
case|:
name|strcpy
argument_list|(
name|cpu_model
argument_list|,
literal|"Overdrive "
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x2000
case|:
name|strcpy
argument_list|(
name|cpu_model
argument_list|,
literal|"Dual "
argument_list|)
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
name|cpu_id
operator|&
literal|0xf00
condition|)
block|{
case|case
literal|0x400
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"i486 "
argument_list|)
expr_stmt|;
comment|/* Check the particular flavor of 486 */
switch|switch
condition|(
name|cpu_id
operator|&
literal|0xf0
condition|)
block|{
case|case
literal|0x00
case|:
case|case
literal|0x10
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"DX"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x20
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"SX"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x30
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"DX2"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x40
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"SL"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x50
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"SX2"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x70
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"DX2 Write-Back Enhanced"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x80
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"DX4"
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|0x500
case|:
comment|/* Check the particular flavor of 586 */
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"Pentium"
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cpu_id
operator|&
literal|0xf0
condition|)
block|{
case|case
literal|0x00
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|" A-step"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x10
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"/P5"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x20
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"/P54C"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x30
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"/P54T Overdrive"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x40
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"/P55C"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x70
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"/P54C"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x80
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"/P55C (quarter-micron)"
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|/* nothing */
break|break;
block|}
if|#
directive|if
name|defined
argument_list|(
name|I586_CPU
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|NO_F00F_HACK
argument_list|)
comment|/* 				 * XXX - If/when Intel fixes the bug, this 				 * should also check the version of the 				 * CPU, not just that it's a Pentium. 				 */
name|has_f00f_bug
operator|=
literal|1
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
literal|0x600
case|:
comment|/* Check the particular flavor of 686 */
switch|switch
condition|(
name|cpu_id
operator|&
literal|0xf0
condition|)
block|{
case|case
literal|0x00
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"Pentium Pro A-step"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x10
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"Pentium Pro"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x30
case|:
case|case
literal|0x50
case|:
case|case
literal|0x60
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"Pentium II/Pentium II Xeon/Celeron"
argument_list|)
expr_stmt|;
name|cpu
operator|=
name|CPU_PII
expr_stmt|;
break|break;
case|case
literal|0x70
case|:
case|case
literal|0x80
case|:
case|case
literal|0xa0
case|:
case|case
literal|0xb0
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"Pentium III/Pentium III Xeon/Celeron"
argument_list|)
expr_stmt|;
name|cpu
operator|=
name|CPU_PIII
expr_stmt|;
break|break;
default|default:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"Unknown 80686"
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|0xf00
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"Pentium 4"
argument_list|)
expr_stmt|;
name|cpu
operator|=
name|CPU_P4
expr_stmt|;
name|model
operator|=
operator|(
name|cpu_id
operator|&
literal|0x0f0
operator|)
operator|>>
literal|4
expr_stmt|;
if|if
condition|(
name|model
operator|==
literal|3
operator|||
name|model
operator|==
literal|4
operator|||
name|model
operator|==
literal|6
condition|)
block|{
name|uint64_t
name|tmp
decl_stmt|;
name|tmp
operator|=
name|rdmsr
argument_list|(
name|MSR_IA32_MISC_ENABLE
argument_list|)
expr_stmt|;
name|wrmsr
argument_list|(
name|MSR_IA32_MISC_ENABLE
argument_list|,
name|tmp
operator|&
operator|~
operator|(
literal|1LL
operator|<<
literal|22
operator|)
argument_list|)
expr_stmt|;
name|do_cpuid
argument_list|(
literal|0
argument_list|,
name|regs
argument_list|)
expr_stmt|;
name|cpu_high
operator|=
name|regs
index|[
literal|0
index|]
expr_stmt|;
block|}
break|break;
default|default:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"unknown"
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* 			 * If we didn't get a brand name from the extended 			 * CPUID, try to look it up in the brand table. 			 */
if|if
condition|(
name|cpu_high
operator|>
literal|0
operator|&&
operator|*
name|cpu_brand
operator|==
literal|'\0'
condition|)
block|{
name|brand_index
operator|=
name|cpu_procinfo
operator|&
name|CPUID_BRAND_INDEX
expr_stmt|;
if|if
condition|(
name|brand_index
operator|<=
name|MAX_BRAND_INDEX
operator|&&
name|cpu_brandtable
index|[
name|brand_index
index|]
operator|!=
name|NULL
condition|)
name|strcpy
argument_list|(
name|cpu_brand
argument_list|,
name|cpu_brandtable
index|[
name|brand_index
index|]
argument_list|)
expr_stmt|;
block|}
block|}
block|}
elseif|else
if|if
condition|(
name|cpu_vendor_id
operator|==
name|CPU_VENDOR_AMD
condition|)
block|{
comment|/* 		 * Values taken from AMD Processor Recognition 		 * http://www.amd.com/K6/k6docs/pdf/20734g.pdf 		 * (also describes ``Features'' encodings. 		 */
name|strcpy
argument_list|(
name|cpu_model
argument_list|,
literal|"AMD "
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cpu_id
operator|&
literal|0xFF0
condition|)
block|{
case|case
literal|0x410
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"Standard Am486DX"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x430
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"Enhanced Am486DX2 Write-Through"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x470
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"Enhanced Am486DX2 Write-Back"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x480
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"Enhanced Am486DX4/Am5x86 Write-Through"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x490
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"Enhanced Am486DX4/Am5x86 Write-Back"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x4E0
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"Am5x86 Write-Through"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x4F0
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"Am5x86 Write-Back"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x500
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"K5 model 0"
argument_list|)
expr_stmt|;
name|tsc_is_broken
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|0x510
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"K5 model 1"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x520
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"K5 PR166 (model 2)"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x530
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"K5 PR200 (model 3)"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x560
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"K6"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x570
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"K6 266 (model 1)"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x580
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"K6-2"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x590
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"K6-III"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x5a0
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"Geode LX"
argument_list|)
expr_stmt|;
comment|/* 			 * Make sure the TSC runs through suspension, 			 * otherwise we can't use it as timecounter 			 */
name|wrmsr
argument_list|(
literal|0x1900
argument_list|,
name|rdmsr
argument_list|(
literal|0x1900
argument_list|)
operator||
literal|0x20ULL
argument_list|)
expr_stmt|;
break|break;
default|default:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"Unknown"
argument_list|)
expr_stmt|;
break|break;
block|}
if|#
directive|if
name|defined
argument_list|(
name|I586_CPU
argument_list|)
operator|&&
name|defined
argument_list|(
name|CPU_WT_ALLOC
argument_list|)
if|if
condition|(
operator|(
name|cpu_id
operator|&
literal|0xf00
operator|)
operator|==
literal|0x500
condition|)
block|{
if|if
condition|(
operator|(
operator|(
name|cpu_id
operator|&
literal|0x0f0
operator|)
operator|>
literal|0
operator|)
operator|&&
operator|(
operator|(
name|cpu_id
operator|&
literal|0x0f0
operator|)
operator|<
literal|0x60
operator|)
operator|&&
operator|(
operator|(
name|cpu_id
operator|&
literal|0x00f
operator|)
operator|>
literal|3
operator|)
condition|)
name|enable_K5_wt_alloc
argument_list|()
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
operator|(
name|cpu_id
operator|&
literal|0x0f0
operator|)
operator|>
literal|0x80
operator|)
operator|||
operator|(
operator|(
operator|(
name|cpu_id
operator|&
literal|0x0f0
operator|)
operator|==
literal|0x80
operator|)
operator|&&
operator|(
name|cpu_id
operator|&
literal|0x00f
operator|)
operator|>
literal|0x07
operator|)
condition|)
name|enable_K6_2_wt_alloc
argument_list|()
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|cpu_id
operator|&
literal|0x0f0
operator|)
operator|>
literal|0x50
condition|)
name|enable_K6_wt_alloc
argument_list|()
expr_stmt|;
block|}
endif|#
directive|endif
block|}
elseif|else
if|if
condition|(
name|cpu_vendor_id
operator|==
name|CPU_VENDOR_CYRIX
condition|)
block|{
name|strcpy
argument_list|(
name|cpu_model
argument_list|,
literal|"Cyrix "
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cpu_id
operator|&
literal|0xff0
condition|)
block|{
case|case
literal|0x440
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"MediaGX"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x520
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"6x86"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x540
case|:
name|cpu_class
operator|=
name|CPUCLASS_586
expr_stmt|;
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"GXm"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x600
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"6x86MX"
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|/* 			 * Even though CPU supports the cpuid 			 * instruction, it can be disabled. 			 * Therefore, this routine supports all Cyrix 			 * CPUs. 			 */
switch|switch
condition|(
name|cyrix_did
operator|&
literal|0xf0
condition|)
block|{
case|case
literal|0x00
case|:
switch|switch
condition|(
name|cyrix_did
operator|&
literal|0x0f
condition|)
block|{
case|case
literal|0x00
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486SLC"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x01
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486DLC"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x02
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486SLC2"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x03
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486DLC2"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x04
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486SRx"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x05
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486DRx"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x06
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486SRx2"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x07
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486DRx2"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x08
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486SRu"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x09
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486DRu"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x0a
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486SRu2"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x0b
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486DRu2"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"Unknown"
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|0x10
case|:
switch|switch
condition|(
name|cyrix_did
operator|&
literal|0x0f
condition|)
block|{
case|case
literal|0x00
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486S"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x01
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486S2"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x02
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486Se"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x03
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486S2e"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x0a
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486DX"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x0b
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486DX2"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x0f
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486DX4"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"Unknown"
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|0x20
case|:
if|if
condition|(
operator|(
name|cyrix_did
operator|&
literal|0x0f
operator|)
operator|<
literal|8
condition|)
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"6x86"
argument_list|)
expr_stmt|;
comment|/* Where did you get it? */
else|else
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"5x86"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x30
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"6x86"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x40
case|:
if|if
condition|(
operator|(
name|cyrix_did
operator|&
literal|0xf000
operator|)
operator|==
literal|0x3000
condition|)
block|{
name|cpu_class
operator|=
name|CPUCLASS_586
expr_stmt|;
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"GXm"
argument_list|)
expr_stmt|;
block|}
else|else
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"MediaGX"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x50
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"6x86MX"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xf0
case|:
switch|switch
condition|(
name|cyrix_did
operator|&
literal|0x0f
condition|)
block|{
case|case
literal|0x0d
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"Overdrive CPU"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x0e
case|:
name|strcpy
argument_list|(
name|cpu_model
argument_list|,
literal|"Texas Instruments 486SXL"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x0f
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486SLC/DLC"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"Unknown"
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
default|default:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"Unknown"
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
block|}
block|}
elseif|else
if|if
condition|(
name|cpu_vendor_id
operator|==
name|CPU_VENDOR_RISE
condition|)
block|{
name|strcpy
argument_list|(
name|cpu_model
argument_list|,
literal|"Rise "
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cpu_id
operator|&
literal|0xff0
condition|)
block|{
case|case
literal|0x500
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"mP6"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"Unknown"
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|cpu_vendor_id
operator|==
name|CPU_VENDOR_CENTAUR
condition|)
block|{
switch|switch
condition|(
name|cpu_id
operator|&
literal|0xff0
condition|)
block|{
case|case
literal|0x540
case|:
name|strcpy
argument_list|(
name|cpu_model
argument_list|,
literal|"IDT WinChip C6"
argument_list|)
expr_stmt|;
name|tsc_is_broken
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|0x580
case|:
name|strcpy
argument_list|(
name|cpu_model
argument_list|,
literal|"IDT WinChip 2"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x660
case|:
name|strcpy
argument_list|(
name|cpu_model
argument_list|,
literal|"VIA C3 Samuel"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x670
case|:
if|if
condition|(
name|cpu_id
operator|&
literal|0x8
condition|)
name|strcpy
argument_list|(
name|cpu_model
argument_list|,
literal|"VIA C3 Ezra"
argument_list|)
expr_stmt|;
else|else
name|strcpy
argument_list|(
name|cpu_model
argument_list|,
literal|"VIA C3 Samuel 2"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x680
case|:
name|strcpy
argument_list|(
name|cpu_model
argument_list|,
literal|"VIA C3 Ezra-T"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x690
case|:
name|strcpy
argument_list|(
name|cpu_model
argument_list|,
literal|"VIA C3 Nehemiah"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x6a0
case|:
case|case
literal|0x6d0
case|:
name|strcpy
argument_list|(
name|cpu_model
argument_list|,
literal|"VIA C7 Esther"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x6f0
case|:
name|strcpy
argument_list|(
name|cpu_model
argument_list|,
literal|"VIA Nano"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|strcpy
argument_list|(
name|cpu_model
argument_list|,
literal|"VIA/IDT Unknown"
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|cpu_vendor_id
operator|==
name|CPU_VENDOR_IBM
condition|)
block|{
name|strcpy
argument_list|(
name|cpu_model
argument_list|,
literal|"Blue Lightning CPU"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cpu_vendor_id
operator|==
name|CPU_VENDOR_NSC
condition|)
block|{
switch|switch
condition|(
name|cpu_id
operator|&
literal|0xfff
condition|)
block|{
case|case
literal|0x540
case|:
name|strcpy
argument_list|(
name|cpu_model
argument_list|,
literal|"Geode SC1100"
argument_list|)
expr_stmt|;
name|cpu
operator|=
name|CPU_GEODE1100
expr_stmt|;
name|tsc_is_broken
operator|=
literal|1
expr_stmt|;
break|break;
default|default:
name|strcpy
argument_list|(
name|cpu_model
argument_list|,
literal|"Geode/NSC unknown"
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
comment|/* 	 * Replace cpu_model with cpu_brand minus leading spaces if 	 * we have one. 	 */
name|brand
operator|=
name|cpu_brand
expr_stmt|;
while|while
condition|(
operator|*
name|brand
operator|==
literal|' '
condition|)
operator|++
name|brand
expr_stmt|;
if|if
condition|(
operator|*
name|brand
operator|!=
literal|'\0'
condition|)
name|strcpy
argument_list|(
name|cpu_model
argument_list|,
name|brand
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s ("
argument_list|,
name|cpu_model
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cpu_class
condition|)
block|{
case|case
name|CPUCLASS_286
case|:
name|printf
argument_list|(
literal|"286"
argument_list|)
expr_stmt|;
break|break;
case|case
name|CPUCLASS_386
case|:
name|printf
argument_list|(
literal|"386"
argument_list|)
expr_stmt|;
break|break;
if|#
directive|if
name|defined
argument_list|(
name|I486_CPU
argument_list|)
case|case
name|CPUCLASS_486
case|:
name|printf
argument_list|(
literal|"486"
argument_list|)
expr_stmt|;
name|bzero_vector
operator|=
name|i486_bzero
expr_stmt|;
break|break;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|I586_CPU
argument_list|)
case|case
name|CPUCLASS_586
case|:
name|hw_clockrate
operator|=
operator|(
name|tsc_freq
operator|+
literal|5000
operator|)
operator|/
literal|1000000
expr_stmt|;
name|printf
argument_list|(
literal|"%jd.%02d-MHz "
argument_list|,
call|(
name|intmax_t
call|)
argument_list|(
name|tsc_freq
operator|+
literal|4999
argument_list|)
operator|/
literal|1000000
argument_list|,
call|(
name|u_int
call|)
argument_list|(
operator|(
name|tsc_freq
operator|+
literal|4999
operator|)
operator|/
literal|10000
argument_list|)
operator|%
literal|100
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"586"
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|I686_CPU
argument_list|)
case|case
name|CPUCLASS_686
case|:
name|hw_clockrate
operator|=
operator|(
name|tsc_freq
operator|+
literal|5000
operator|)
operator|/
literal|1000000
expr_stmt|;
name|printf
argument_list|(
literal|"%jd.%02d-MHz "
argument_list|,
call|(
name|intmax_t
call|)
argument_list|(
name|tsc_freq
operator|+
literal|4999
argument_list|)
operator|/
literal|1000000
argument_list|,
call|(
name|u_int
call|)
argument_list|(
operator|(
name|tsc_freq
operator|+
literal|4999
operator|)
operator|/
literal|10000
argument_list|)
operator|%
literal|100
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"686"
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
name|printf
argument_list|(
literal|"Unknown"
argument_list|)
expr_stmt|;
comment|/* will panic below... */
block|}
name|printf
argument_list|(
literal|"-class CPU)\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|cpu_vendor
condition|)
name|printf
argument_list|(
literal|"  Origin = \"%s\""
argument_list|,
name|cpu_vendor
argument_list|)
expr_stmt|;
if|if
condition|(
name|cpu_id
condition|)
name|printf
argument_list|(
literal|"  Id = 0x%x"
argument_list|,
name|cpu_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|cpu_vendor_id
operator|==
name|CPU_VENDOR_INTEL
operator|||
name|cpu_vendor_id
operator|==
name|CPU_VENDOR_AMD
operator|||
name|cpu_vendor_id
operator|==
name|CPU_VENDOR_TRANSMETA
operator|||
name|cpu_vendor_id
operator|==
name|CPU_VENDOR_RISE
operator|||
name|cpu_vendor_id
operator|==
name|CPU_VENDOR_CENTAUR
operator|||
name|cpu_vendor_id
operator|==
name|CPU_VENDOR_NSC
operator|||
operator|(
name|cpu_vendor_id
operator|==
name|CPU_VENDOR_CYRIX
operator|&&
operator|(
operator|(
name|cpu_id
operator|&
literal|0xf00
operator|)
operator|>
literal|0x500
operator|)
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"  Stepping = %u"
argument_list|,
name|cpu_id
operator|&
literal|0xf
argument_list|)
expr_stmt|;
if|if
condition|(
name|cpu_vendor_id
operator|==
name|CPU_VENDOR_CYRIX
condition|)
name|printf
argument_list|(
literal|"  DIR=0x%04x"
argument_list|,
name|cyrix_did
argument_list|)
expr_stmt|;
if|if
condition|(
name|cpu_high
operator|>
literal|0
condition|)
block|{
comment|/* 			 * Here we should probably set up flags indicating 			 * whether or not various features are available. 			 * The interesting ones are probably VME, PSE, PAE, 			 * and PGE.  The code already assumes without bothering 			 * to check that all CPUs>= Pentium have a TSC and 			 * MSRs. 			 */
name|printf
argument_list|(
literal|"\n  Features=0x%b"
argument_list|,
name|cpu_feature
argument_list|,
literal|"\020"
literal|"\001FPU"
comment|/* Integral FPU */
literal|"\002VME"
comment|/* Extended VM86 mode support */
literal|"\003DE"
comment|/* Debugging Extensions (CR4.DE) */
literal|"\004PSE"
comment|/* 4MByte page tables */
literal|"\005TSC"
comment|/* Timestamp counter */
literal|"\006MSR"
comment|/* Machine specific registers */
literal|"\007PAE"
comment|/* Physical address extension */
literal|"\010MCE"
comment|/* Machine Check support */
literal|"\011CX8"
comment|/* CMPEXCH8 instruction */
literal|"\012APIC"
comment|/* SMP local APIC */
literal|"\013oldMTRR"
comment|/* Previous implementation of MTRR */
literal|"\014SEP"
comment|/* Fast System Call */
literal|"\015MTRR"
comment|/* Memory Type Range Registers */
literal|"\016PGE"
comment|/* PG_G (global bit) support */
literal|"\017MCA"
comment|/* Machine Check Architecture */
literal|"\020CMOV"
comment|/* CMOV instruction */
literal|"\021PAT"
comment|/* Page attributes table */
literal|"\022PSE36"
comment|/* 36 bit address space support */
literal|"\023PN"
comment|/* Processor Serial number */
literal|"\024CLFLUSH"
comment|/* Has the CLFLUSH instruction */
literal|"\025<b20>"
literal|"\026DTS"
comment|/* Debug Trace Store */
literal|"\027ACPI"
comment|/* ACPI support */
literal|"\030MMX"
comment|/* MMX instructions */
literal|"\031FXSR"
comment|/* FXSAVE/FXRSTOR */
literal|"\032SSE"
comment|/* Streaming SIMD Extensions */
literal|"\033SSE2"
comment|/* Streaming SIMD Extensions #2 */
literal|"\034SS"
comment|/* Self snoop */
literal|"\035HTT"
comment|/* Hyperthreading (see EBX bit 16-23) */
literal|"\036TM"
comment|/* Thermal Monitor clock slowdown */
literal|"\037IA64"
comment|/* CPU can execute IA64 instructions */
literal|"\040PBE"
comment|/* Pending Break Enable */
argument_list|)
expr_stmt|;
if|if
condition|(
name|cpu_feature2
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"\n  Features2=0x%b"
argument_list|,
name|cpu_feature2
argument_list|,
literal|"\020"
literal|"\001SSE3"
comment|/* SSE3 */
literal|"\002<b1>"
literal|"\003DTES64"
comment|/* 64-bit Debug Trace */
literal|"\004MON"
comment|/* MONITOR/MWAIT Instructions */
literal|"\005DS_CPL"
comment|/* CPL Qualified Debug Store */
literal|"\006VMX"
comment|/* Virtual Machine Extensions */
literal|"\007SMX"
comment|/* Safer Mode Extensions */
literal|"\010EST"
comment|/* Enhanced SpeedStep */
literal|"\011TM2"
comment|/* Thermal Monitor 2 */
literal|"\012SSSE3"
comment|/* SSSE3 */
literal|"\013CNXT-ID"
comment|/* L1 context ID available */
literal|"\014<b11>"
literal|"\015<b12>"
literal|"\016CX16"
comment|/* CMPXCHG16B Instruction */
literal|"\017xTPR"
comment|/* Send Task Priority Messages*/
literal|"\020PDCM"
comment|/* Perf/Debug Capability MSR */
literal|"\021<b16>"
literal|"\022<b17>"
literal|"\023DCA"
comment|/* Direct Cache Access */
literal|"\024SSE4.1"
literal|"\025SSE4.2"
literal|"\026x2APIC"
comment|/* xAPIC Extensions */
literal|"\027<b22>"
literal|"\030POPCNT"
literal|"\031<b24>"
literal|"\032<b25>"
literal|"\033XSAVE"
literal|"\034OSXSAVE"
literal|"\035<b28>"
literal|"\036<b29>"
literal|"\037<b30>"
literal|"\040<b31>"
argument_list|)
expr_stmt|;
block|}
comment|/* 			 * AMD64 Architecture Programmer's Manual Volume 3: 			 * General-Purpose and System Instructions 			 * http://www.amd.com/us-en/assets/content_type/white_papers_and_tech_docs/24594.pdf 			 * 			 * IA-32 Intel Architecture Software Developer's Manual, 			 * Volume 2A: Instruction Set Reference, A-M 			 * ftp://download.intel.com/design/Pentium4/manuals/25366617.pdf 			 */
if|if
condition|(
name|amd_feature
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"\n  AMD Features=0x%b"
argument_list|,
name|amd_feature
argument_list|,
literal|"\020"
comment|/* in hex */
literal|"\001<s0>"
comment|/* Same */
literal|"\002<s1>"
comment|/* Same */
literal|"\003<s2>"
comment|/* Same */
literal|"\004<s3>"
comment|/* Same */
literal|"\005<s4>"
comment|/* Same */
literal|"\006<s5>"
comment|/* Same */
literal|"\007<s6>"
comment|/* Same */
literal|"\010<s7>"
comment|/* Same */
literal|"\011<s8>"
comment|/* Same */
literal|"\012<s9>"
comment|/* Same */
literal|"\013<b10>"
comment|/* Undefined */
literal|"\014SYSCALL"
comment|/* Have SYSCALL/SYSRET */
literal|"\015<s12>"
comment|/* Same */
literal|"\016<s13>"
comment|/* Same */
literal|"\017<s14>"
comment|/* Same */
literal|"\020<s15>"
comment|/* Same */
literal|"\021<s16>"
comment|/* Same */
literal|"\022<s17>"
comment|/* Same */
literal|"\023<b18>"
comment|/* Reserved, unknown */
literal|"\024MP"
comment|/* Multiprocessor Capable */
literal|"\025NX"
comment|/* Has EFER.NXE, NX */
literal|"\026<b21>"
comment|/* Undefined */
literal|"\027MMX+"
comment|/* AMD MMX Extensions */
literal|"\030<s23>"
comment|/* Same */
literal|"\031<s24>"
comment|/* Same */
literal|"\032FFXSR"
comment|/* Fast FXSAVE/FXRSTOR */
literal|"\033Page1GB"
comment|/* 1-GB large page support */
literal|"\034RDTSCP"
comment|/* RDTSCP */
literal|"\035<b28>"
comment|/* Undefined */
literal|"\036LM"
comment|/* 64 bit long mode */
literal|"\0373DNow!+"
comment|/* AMD 3DNow! Extensions */
literal|"\0403DNow!"
comment|/* AMD 3DNow! */
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|amd_feature2
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"\n  AMD Features2=0x%b"
argument_list|,
name|amd_feature2
argument_list|,
literal|"\020"
literal|"\001LAHF"
comment|/* LAHF/SAHF in long mode */
literal|"\002CMP"
comment|/* CMP legacy */
literal|"\003SVM"
comment|/* Secure Virtual Mode */
literal|"\004ExtAPIC"
comment|/* Extended APIC register */
literal|"\005CR8"
comment|/* CR8 in legacy mode */
literal|"\006ABM"
comment|/* LZCNT instruction */
literal|"\007SSE4A"
comment|/* SSE4A */
literal|"\010MAS"
comment|/* Misaligned SSE mode */
literal|"\011Prefetch"
comment|/* 3DNow! Prefetch/PrefetchW */
literal|"\012OSVW"
comment|/* OS visible workaround */
literal|"\013IBS"
comment|/* Instruction based sampling */
literal|"\014SSE5"
comment|/* SSE5 */
literal|"\015SKINIT"
comment|/* SKINIT/STGI */
literal|"\016WDT"
comment|/* Watchdog timer */
literal|"\017<b14>"
literal|"\020<b15>"
literal|"\021<b16>"
literal|"\022<b17>"
literal|"\023<b18>"
literal|"\024<b19>"
literal|"\025<b20>"
literal|"\026<b21>"
literal|"\027<b22>"
literal|"\030<b23>"
literal|"\031<b24>"
literal|"\032<b25>"
literal|"\033<b26>"
literal|"\034<b27>"
literal|"\035<b28>"
literal|"\036<b29>"
literal|"\037<b30>"
literal|"\040<b31>"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|cpu_vendor_id
operator|==
name|CPU_VENDOR_CENTAUR
condition|)
name|print_via_padlock_info
argument_list|()
expr_stmt|;
if|if
condition|(
operator|(
name|cpu_feature
operator|&
name|CPUID_HTT
operator|)
operator|&&
name|cpu_vendor_id
operator|==
name|CPU_VENDOR_AMD
condition|)
name|cpu_feature
operator|&=
operator|~
name|CPUID_HTT
expr_stmt|;
comment|/* 			 * If this CPU supports P-state invariant TSC then 			 * mention the capability. 			 */
switch|switch
condition|(
name|cpu_vendor_id
condition|)
block|{
case|case
name|CPU_VENDOR_AMD
case|:
if|if
condition|(
operator|(
name|amd_pminfo
operator|&
name|AMDPM_TSC_INVARIANT
operator|)
operator|||
name|I386_CPU_FAMILY
argument_list|(
name|cpu_id
argument_list|)
operator|>=
literal|0x10
operator|||
name|cpu_id
operator|==
literal|0x60fb2
condition|)
name|tsc_is_invariant
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CPU_VENDOR_INTEL
case|:
if|if
condition|(
operator|(
name|amd_pminfo
operator|&
name|AMDPM_TSC_INVARIANT
operator|)
operator|||
operator|(
name|I386_CPU_FAMILY
argument_list|(
name|cpu_id
argument_list|)
operator|==
literal|0x6
operator|&&
name|I386_CPU_MODEL
argument_list|(
name|cpu_id
argument_list|)
operator|>=
literal|0xe
operator|)
operator|||
operator|(
name|I386_CPU_FAMILY
argument_list|(
name|cpu_id
argument_list|)
operator|==
literal|0xf
operator|&&
name|I386_CPU_MODEL
argument_list|(
name|cpu_id
argument_list|)
operator|>=
literal|0x3
operator|)
condition|)
name|tsc_is_invariant
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CPU_VENDOR_CENTAUR
case|:
if|if
condition|(
name|I386_CPU_FAMILY
argument_list|(
name|cpu_id
argument_list|)
operator|==
literal|0x6
operator|&&
name|I386_CPU_MODEL
argument_list|(
name|cpu_id
argument_list|)
operator|>=
literal|0xf
operator|&&
operator|(
name|rdmsr
argument_list|(
literal|0x1203
argument_list|)
operator|&
literal|0x100000000ULL
operator|)
operator|==
literal|0
condition|)
name|tsc_is_invariant
operator|=
literal|1
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|tsc_is_invariant
condition|)
name|printf
argument_list|(
literal|"\n  TSC: P-state invariant"
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|cpu_vendor_id
operator|==
name|CPU_VENDOR_CYRIX
condition|)
block|{
name|printf
argument_list|(
literal|"  DIR=0x%04x"
argument_list|,
name|cyrix_did
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  Stepping=%u"
argument_list|,
operator|(
name|cyrix_did
operator|&
literal|0xf000
operator|)
operator|>>
literal|12
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  Revision=%u"
argument_list|,
operator|(
name|cyrix_did
operator|&
literal|0x0f00
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|CYRIX_CACHE_REALLY_WORKS
if|if
condition|(
name|cpu
operator|==
name|CPU_M1
operator|&&
operator|(
name|cyrix_did
operator|&
literal|0xff00
operator|)
operator|<
literal|0x1700
condition|)
name|printf
argument_list|(
literal|"\n  CPU cache: write-through mode"
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
comment|/* Avoid ugly blank lines: only print newline when we have to. */
if|if
condition|(
operator|*
name|cpu_vendor
operator|||
name|cpu_id
condition|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bootverbose
condition|)
return|return;
if|if
condition|(
name|cpu_vendor_id
operator|==
name|CPU_VENDOR_AMD
condition|)
name|print_AMD_info
argument_list|()
expr_stmt|;
elseif|else
if|if
condition|(
name|cpu_vendor_id
operator|==
name|CPU_VENDOR_INTEL
condition|)
name|print_INTEL_info
argument_list|()
expr_stmt|;
elseif|else
if|if
condition|(
name|cpu_vendor_id
operator|==
name|CPU_VENDOR_TRANSMETA
condition|)
name|print_transmeta_info
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|void
name|panicifcpuunsupported
parameter_list|(
name|void
parameter_list|)
block|{
if|#
directive|if
operator|!
name|defined
argument_list|(
name|lint
argument_list|)
if|#
directive|if
operator|!
name|defined
argument_list|(
name|I486_CPU
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|I586_CPU
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|I686_CPU
argument_list|)
error|#
directive|error
error|This kernel is not configured for one of the supported CPUs
endif|#
directive|endif
else|#
directive|else
comment|/* lint */
endif|#
directive|endif
comment|/* lint */
comment|/* 	 * Now that we have told the user what they have, 	 * let them know if that machine type isn't configured. 	 */
switch|switch
condition|(
name|cpu_class
condition|)
block|{
case|case
name|CPUCLASS_286
case|:
comment|/* a 286 should not make it this far, anyway */
case|case
name|CPUCLASS_386
case|:
if|#
directive|if
operator|!
name|defined
argument_list|(
name|I486_CPU
argument_list|)
case|case
name|CPUCLASS_486
case|:
endif|#
directive|endif
if|#
directive|if
operator|!
name|defined
argument_list|(
name|I586_CPU
argument_list|)
case|case
name|CPUCLASS_586
case|:
endif|#
directive|endif
if|#
directive|if
operator|!
name|defined
argument_list|(
name|I686_CPU
argument_list|)
case|case
name|CPUCLASS_686
case|:
endif|#
directive|endif
name|panic
argument_list|(
literal|"CPU class not configured"
argument_list|)
expr_stmt|;
default|default:
break|break;
block|}
block|}
end_function

begin_decl_stmt
specifier|static
specifier|volatile
name|u_int
name|trap_by_rdmsr
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Special exception 6 handler.  * The rdmsr instruction generates invalid opcodes fault on 486-class  * Cyrix CPU.  Stacked eip register points the rdmsr instruction in the  * function identblue() when this handler is called.  Stacked eip should  * be advanced.  */
end_comment

begin_decl_stmt
name|inthand_t
name|bluetrap6
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|__GNUCLIKE_ASM
end_ifdef

begin_asm
asm|__asm
end_asm

begin_expr_stmt
operator|(
literal|"									\n\ 	.text								\n\ 	.p2align 2,0x90							\n\ 	.type	"
name|__XSTRING
argument_list|(
name|CNAME
argument_list|(
name|bluetrap6
argument_list|)
argument_list|)
literal|",@function		\n\ "
name|__XSTRING
argument_list|(
name|CNAME
argument_list|(
name|bluetrap6
argument_list|)
argument_list|)
literal|":					\n\ 	ss								\n\ 	movl	$0xa8c1d,"
name|__XSTRING
argument_list|(
name|CNAME
argument_list|(
name|trap_by_rdmsr
argument_list|)
argument_list|)
literal|"		\n\ 	addl	$2, (%esp)	/* rdmsr is a 2-byte instruction */	\n\ 	iret								\n\ "
operator|)
expr_stmt|;
end_expr_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * Special exception 13 handler.  * Accessing non-existent MSR generates general protection fault.  */
end_comment

begin_decl_stmt
name|inthand_t
name|bluetrap13
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|__GNUCLIKE_ASM
end_ifdef

begin_asm
asm|__asm
end_asm

begin_expr_stmt
operator|(
literal|"									\n\ 	.text								\n\ 	.p2align 2,0x90							\n\ 	.type	"
name|__XSTRING
argument_list|(
name|CNAME
argument_list|(
name|bluetrap13
argument_list|)
argument_list|)
literal|",@function		\n\ "
name|__XSTRING
argument_list|(
name|CNAME
argument_list|(
name|bluetrap13
argument_list|)
argument_list|)
literal|":					\n\ 	ss								\n\ 	movl	$0xa89c4,"
name|__XSTRING
argument_list|(
name|CNAME
argument_list|(
name|trap_by_rdmsr
argument_list|)
argument_list|)
literal|"		\n\ 	popl	%eax		/* discard error code */		\n\ 	addl	$2, (%esp)	/* rdmsr is a 2-byte instruction */	\n\ 	iret								\n\ "
operator|)
expr_stmt|;
end_expr_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * Distinguish IBM Blue Lightning CPU from Cyrix CPUs that does not  * support cpuid instruction.  This function should be called after  * loading interrupt descriptor table register.  *  * I don't like this method that handles fault, but I couldn't get  * information for any other methods.  Does blue giant know?  */
end_comment

begin_function
specifier|static
name|int
name|identblue
parameter_list|(
name|void
parameter_list|)
block|{
name|trap_by_rdmsr
operator|=
literal|0
expr_stmt|;
comment|/* 	 * Cyrix 486-class CPU does not support rdmsr instruction. 	 * The rdmsr instruction generates invalid opcode fault, and exception 	 * will be trapped by bluetrap6() on Cyrix 486-class CPU.  The 	 * bluetrap6() set the magic number to trap_by_rdmsr. 	 */
name|setidt
argument_list|(
name|IDT_UD
argument_list|,
name|bluetrap6
argument_list|,
name|SDT_SYS386TGT
argument_list|,
name|SEL_KPL
argument_list|,
name|GSEL
argument_list|(
name|GCODE_SEL
argument_list|,
name|SEL_KPL
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Certain BIOS disables cpuid instruction of Cyrix 6x86MX CPU. 	 * In this case, rdmsr generates general protection fault, and 	 * exception will be trapped by bluetrap13(). 	 */
name|setidt
argument_list|(
name|IDT_GP
argument_list|,
name|bluetrap13
argument_list|,
name|SDT_SYS386TGT
argument_list|,
name|SEL_KPL
argument_list|,
name|GSEL
argument_list|(
name|GCODE_SEL
argument_list|,
name|SEL_KPL
argument_list|)
argument_list|)
expr_stmt|;
name|rdmsr
argument_list|(
literal|0x1002
argument_list|)
expr_stmt|;
comment|/* Cyrix CPU generates fault. */
if|if
condition|(
name|trap_by_rdmsr
operator|==
literal|0xa8c1d
condition|)
return|return
name|IDENTBLUE_CYRIX486
return|;
elseif|else
if|if
condition|(
name|trap_by_rdmsr
operator|==
literal|0xa89c4
condition|)
return|return
name|IDENTBLUE_CYRIXM2
return|;
return|return
name|IDENTBLUE_IBMCPU
return|;
block|}
end_function

begin_comment
comment|/*  * identifycyrix() set lower 16 bits of cyrix_did as follows:  *  *  F E D C B A 9 8 7 6 5 4 3 2 1 0  * +-------+-------+---------------+  * |  SID  |  RID  |   Device ID   |  * |    (DIR 1)    |    (DIR 0)    |  * +-------+-------+---------------+  */
end_comment

begin_function
specifier|static
name|void
name|identifycyrix
parameter_list|(
name|void
parameter_list|)
block|{
name|u_int
name|eflags
decl_stmt|;
name|int
name|ccr2_test
init|=
literal|0
decl_stmt|,
name|dir_test
init|=
literal|0
decl_stmt|;
name|u_char
name|ccr2
decl_stmt|,
name|ccr3
decl_stmt|;
name|eflags
operator|=
name|read_eflags
argument_list|()
expr_stmt|;
name|disable_intr
argument_list|()
expr_stmt|;
name|ccr2
operator|=
name|read_cyrix_reg
argument_list|(
name|CCR2
argument_list|)
expr_stmt|;
name|write_cyrix_reg
argument_list|(
name|CCR2
argument_list|,
name|ccr2
operator|^
name|CCR2_LOCK_NW
argument_list|)
expr_stmt|;
name|read_cyrix_reg
argument_list|(
name|CCR2
argument_list|)
expr_stmt|;
if|if
condition|(
name|read_cyrix_reg
argument_list|(
name|CCR2
argument_list|)
operator|!=
name|ccr2
condition|)
name|ccr2_test
operator|=
literal|1
expr_stmt|;
name|write_cyrix_reg
argument_list|(
name|CCR2
argument_list|,
name|ccr2
argument_list|)
expr_stmt|;
name|ccr3
operator|=
name|read_cyrix_reg
argument_list|(
name|CCR3
argument_list|)
expr_stmt|;
name|write_cyrix_reg
argument_list|(
name|CCR3
argument_list|,
name|ccr3
operator|^
name|CCR3_MAPEN3
argument_list|)
expr_stmt|;
name|read_cyrix_reg
argument_list|(
name|CCR3
argument_list|)
expr_stmt|;
if|if
condition|(
name|read_cyrix_reg
argument_list|(
name|CCR3
argument_list|)
operator|!=
name|ccr3
condition|)
name|dir_test
operator|=
literal|1
expr_stmt|;
comment|/* CPU supports DIRs. */
name|write_cyrix_reg
argument_list|(
name|CCR3
argument_list|,
name|ccr3
argument_list|)
expr_stmt|;
if|if
condition|(
name|dir_test
condition|)
block|{
comment|/* Device ID registers are available. */
name|cyrix_did
operator|=
name|read_cyrix_reg
argument_list|(
name|DIR1
argument_list|)
operator|<<
literal|8
expr_stmt|;
name|cyrix_did
operator|+=
name|read_cyrix_reg
argument_list|(
name|DIR0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ccr2_test
condition|)
name|cyrix_did
operator|=
literal|0x0010
expr_stmt|;
comment|/* 486S A-step */
else|else
name|cyrix_did
operator|=
literal|0x00ff
expr_stmt|;
comment|/* Old 486SLC/DLC and TI486SXLC/SXL */
name|write_eflags
argument_list|(
name|eflags
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Update TSC freq with the value indicated by the caller. */
end_comment

begin_function
specifier|static
name|void
name|tsc_freq_changed
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
specifier|const
name|struct
name|cf_level
modifier|*
name|level
parameter_list|,
name|int
name|status
parameter_list|)
block|{
comment|/* 	 * If there was an error during the transition or 	 * TSC is P-state invariant, don't do anything. 	 */
if|if
condition|(
name|status
operator|!=
literal|0
operator|||
name|tsc_is_invariant
condition|)
return|return;
comment|/* Total setting for this level gives the new frequency in MHz. */
name|hw_clockrate
operator|=
name|level
operator|->
name|total_set
operator|.
name|freq
expr_stmt|;
block|}
end_function

begin_expr_stmt
name|EVENTHANDLER_DEFINE
argument_list|(
name|cpufreq_post_change
argument_list|,
name|tsc_freq_changed
argument_list|,
name|NULL
argument_list|,
name|EVENTHANDLER_PRI_ANY
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*  * Final stage of CPU identification. -- Should I check TI?  */
end_comment

begin_function
name|void
name|finishidentcpu
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|isblue
init|=
literal|0
decl_stmt|;
name|u_char
name|ccr3
decl_stmt|;
name|u_int
name|regs
index|[
literal|4
index|]
decl_stmt|;
name|cpu_vendor_id
operator|=
name|find_cpu_vendor_id
argument_list|()
expr_stmt|;
comment|/* Detect AMD features (PTE no-execute bit, 3dnow, 64 bit mode etc) */
if|if
condition|(
name|cpu_vendor_id
operator|==
name|CPU_VENDOR_INTEL
operator|||
name|cpu_vendor_id
operator|==
name|CPU_VENDOR_AMD
condition|)
block|{
name|init_exthigh
argument_list|()
expr_stmt|;
if|if
condition|(
name|cpu_exthigh
operator|>=
literal|0x80000001
condition|)
block|{
name|do_cpuid
argument_list|(
literal|0x80000001
argument_list|,
name|regs
argument_list|)
expr_stmt|;
name|amd_feature
operator|=
name|regs
index|[
literal|3
index|]
operator|&
operator|~
operator|(
name|cpu_feature
operator|&
literal|0x0183f3ff
operator|)
expr_stmt|;
name|amd_feature2
operator|=
name|regs
index|[
literal|2
index|]
expr_stmt|;
block|}
if|if
condition|(
name|cpu_exthigh
operator|>=
literal|0x80000007
condition|)
block|{
name|do_cpuid
argument_list|(
literal|0x80000007
argument_list|,
name|regs
argument_list|)
expr_stmt|;
name|amd_pminfo
operator|=
name|regs
index|[
literal|3
index|]
expr_stmt|;
block|}
if|if
condition|(
name|cpu_exthigh
operator|>=
literal|0x80000008
condition|)
block|{
name|do_cpuid
argument_list|(
literal|0x80000008
argument_list|,
name|regs
argument_list|)
expr_stmt|;
name|cpu_procinfo2
operator|=
name|regs
index|[
literal|2
index|]
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|cpu_vendor_id
operator|==
name|CPU_VENDOR_CYRIX
condition|)
block|{
if|if
condition|(
name|cpu
operator|==
name|CPU_486
condition|)
block|{
comment|/* 			 * These conditions are equivalent to: 			 *     - CPU does not support cpuid instruction. 			 *     - Cyrix/IBM CPU is detected. 			 */
name|isblue
operator|=
name|identblue
argument_list|()
expr_stmt|;
if|if
condition|(
name|isblue
operator|==
name|IDENTBLUE_IBMCPU
condition|)
block|{
name|strcpy
argument_list|(
name|cpu_vendor
argument_list|,
literal|"IBM"
argument_list|)
expr_stmt|;
name|cpu_vendor_id
operator|=
name|CPU_VENDOR_IBM
expr_stmt|;
name|cpu
operator|=
name|CPU_BLUE
expr_stmt|;
return|return;
block|}
block|}
switch|switch
condition|(
name|cpu_id
operator|&
literal|0xf00
condition|)
block|{
case|case
literal|0x600
case|:
comment|/* 			 * Cyrix's datasheet does not describe DIRs. 			 * Therefor, I assume it does not have them 			 * and use the result of the cpuid instruction. 			 * XXX they seem to have it for now at least. -Peter 			 */
name|identifycyrix
argument_list|()
expr_stmt|;
name|cpu
operator|=
name|CPU_M2
expr_stmt|;
break|break;
default|default:
name|identifycyrix
argument_list|()
expr_stmt|;
comment|/* 			 * This routine contains a trick. 			 * Don't check (cpu_id& 0x00f0) == 0x50 to detect M2, now. 			 */
switch|switch
condition|(
name|cyrix_did
operator|&
literal|0x00f0
condition|)
block|{
case|case
literal|0x00
case|:
case|case
literal|0xf0
case|:
name|cpu
operator|=
name|CPU_486DLC
expr_stmt|;
break|break;
case|case
literal|0x10
case|:
name|cpu
operator|=
name|CPU_CY486DX
expr_stmt|;
break|break;
case|case
literal|0x20
case|:
if|if
condition|(
operator|(
name|cyrix_did
operator|&
literal|0x000f
operator|)
operator|<
literal|8
condition|)
name|cpu
operator|=
name|CPU_M1
expr_stmt|;
else|else
name|cpu
operator|=
name|CPU_M1SC
expr_stmt|;
break|break;
case|case
literal|0x30
case|:
name|cpu
operator|=
name|CPU_M1
expr_stmt|;
break|break;
case|case
literal|0x40
case|:
comment|/* MediaGX CPU */
name|cpu
operator|=
name|CPU_M1SC
expr_stmt|;
break|break;
default|default:
comment|/* M2 and later CPUs are treated as M2. */
name|cpu
operator|=
name|CPU_M2
expr_stmt|;
comment|/* 				 * enable cpuid instruction. 				 */
name|ccr3
operator|=
name|read_cyrix_reg
argument_list|(
name|CCR3
argument_list|)
expr_stmt|;
name|write_cyrix_reg
argument_list|(
name|CCR3
argument_list|,
name|CCR3_MAPEN0
argument_list|)
expr_stmt|;
name|write_cyrix_reg
argument_list|(
name|CCR4
argument_list|,
name|read_cyrix_reg
argument_list|(
name|CCR4
argument_list|)
operator||
name|CCR4_CPUID
argument_list|)
expr_stmt|;
name|write_cyrix_reg
argument_list|(
name|CCR3
argument_list|,
name|ccr3
argument_list|)
expr_stmt|;
name|do_cpuid
argument_list|(
literal|0
argument_list|,
name|regs
argument_list|)
expr_stmt|;
name|cpu_high
operator|=
name|regs
index|[
literal|0
index|]
expr_stmt|;
comment|/* eax */
name|do_cpuid
argument_list|(
literal|1
argument_list|,
name|regs
argument_list|)
expr_stmt|;
name|cpu_id
operator|=
name|regs
index|[
literal|0
index|]
expr_stmt|;
comment|/* eax */
name|cpu_feature
operator|=
name|regs
index|[
literal|3
index|]
expr_stmt|;
comment|/* edx */
break|break;
block|}
block|}
block|}
elseif|else
if|if
condition|(
name|cpu
operator|==
name|CPU_486
operator|&&
operator|*
name|cpu_vendor
operator|==
literal|'\0'
condition|)
block|{
comment|/* 		 * There are BlueLightning CPUs that do not change 		 * undefined flags by dividing 5 by 2.  In this case, 		 * the CPU identification routine in locore.s leaves 		 * cpu_vendor null string and puts CPU_486 into the 		 * cpu. 		 */
name|isblue
operator|=
name|identblue
argument_list|()
expr_stmt|;
if|if
condition|(
name|isblue
operator|==
name|IDENTBLUE_IBMCPU
condition|)
block|{
name|strcpy
argument_list|(
name|cpu_vendor
argument_list|,
literal|"IBM"
argument_list|)
expr_stmt|;
name|cpu_vendor_id
operator|=
name|CPU_VENDOR_IBM
expr_stmt|;
name|cpu
operator|=
name|CPU_BLUE
expr_stmt|;
return|return;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|u_int
name|find_cpu_vendor_id
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|cpu_vendors
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|cpu_vendors
index|[
literal|0
index|]
argument_list|)
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|strcmp
argument_list|(
name|cpu_vendor
argument_list|,
name|cpu_vendors
index|[
name|i
index|]
operator|.
name|vendor
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|cpu_vendors
index|[
name|i
index|]
operator|.
name|vendor_id
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_AMD_assoc
parameter_list|(
name|int
name|i
parameter_list|)
block|{
if|if
condition|(
name|i
operator|==
literal|255
condition|)
name|printf
argument_list|(
literal|", fully associative\n"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|", %d-way associative\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_AMD_info
parameter_list|(
name|void
parameter_list|)
block|{
name|quad_t
name|amd_whcr
decl_stmt|;
if|if
condition|(
name|cpu_exthigh
operator|>=
literal|0x80000005
condition|)
block|{
name|u_int
name|regs
index|[
literal|4
index|]
decl_stmt|;
name|do_cpuid
argument_list|(
literal|0x80000005
argument_list|,
name|regs
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Data TLB: %d entries"
argument_list|,
operator|(
name|regs
index|[
literal|1
index|]
operator|>>
literal|16
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|print_AMD_assoc
argument_list|(
name|regs
index|[
literal|1
index|]
operator|>>
literal|24
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Instruction TLB: %d entries"
argument_list|,
name|regs
index|[
literal|1
index|]
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|print_AMD_assoc
argument_list|(
operator|(
name|regs
index|[
literal|1
index|]
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"L1 data cache: %d kbytes"
argument_list|,
name|regs
index|[
literal|2
index|]
operator|>>
literal|24
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|", %d bytes/line"
argument_list|,
name|regs
index|[
literal|2
index|]
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|", %d lines/tag"
argument_list|,
operator|(
name|regs
index|[
literal|2
index|]
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|print_AMD_assoc
argument_list|(
operator|(
name|regs
index|[
literal|2
index|]
operator|>>
literal|16
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"L1 instruction cache: %d kbytes"
argument_list|,
name|regs
index|[
literal|3
index|]
operator|>>
literal|24
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|", %d bytes/line"
argument_list|,
name|regs
index|[
literal|3
index|]
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|", %d lines/tag"
argument_list|,
operator|(
name|regs
index|[
literal|3
index|]
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|print_AMD_assoc
argument_list|(
operator|(
name|regs
index|[
literal|3
index|]
operator|>>
literal|16
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
if|if
condition|(
name|cpu_exthigh
operator|>=
literal|0x80000006
condition|)
block|{
comment|/* K6-III only */
name|do_cpuid
argument_list|(
literal|0x80000006
argument_list|,
name|regs
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"L2 internal cache: %d kbytes"
argument_list|,
name|regs
index|[
literal|2
index|]
operator|>>
literal|16
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|", %d bytes/line"
argument_list|,
name|regs
index|[
literal|2
index|]
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|", %d lines/tag"
argument_list|,
operator|(
name|regs
index|[
literal|2
index|]
operator|>>
literal|8
operator|)
operator|&
literal|0x0f
argument_list|)
expr_stmt|;
name|print_AMD_assoc
argument_list|(
operator|(
name|regs
index|[
literal|2
index|]
operator|>>
literal|12
operator|)
operator|&
literal|0x0f
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
operator|(
name|cpu_id
operator|&
literal|0xf00
operator|)
operator|==
literal|0x500
operator|)
operator|&&
operator|(
operator|(
operator|(
name|cpu_id
operator|&
literal|0x0f0
operator|)
operator|>
literal|0x80
operator|)
operator|||
operator|(
operator|(
operator|(
name|cpu_id
operator|&
literal|0x0f0
operator|)
operator|==
literal|0x80
operator|)
operator|&&
operator|(
name|cpu_id
operator|&
literal|0x00f
operator|)
operator|>
literal|0x07
operator|)
operator|)
condition|)
block|{
comment|/* K6-2(new core [Stepping 8-F]), K6-III or later */
name|amd_whcr
operator|=
name|rdmsr
argument_list|(
literal|0xc0000082
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|amd_whcr
operator|&
operator|(
literal|0x3ff
operator|<<
literal|22
operator|)
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"Write Allocate Disable\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"Write Allocate Enable Limit: %dM bytes\n"
argument_list|,
call|(
name|u_int32_t
call|)
argument_list|(
operator|(
name|amd_whcr
operator|&
operator|(
literal|0x3ff
operator|<<
literal|22
operator|)
operator|)
operator|>>
literal|22
argument_list|)
operator|*
literal|4
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Write Allocate 15-16M bytes: %s\n"
argument_list|,
operator|(
name|amd_whcr
operator|&
operator|(
literal|1
operator|<<
literal|16
operator|)
operator|)
condition|?
literal|"Enable"
else|:
literal|"Disable"
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
operator|(
operator|(
name|cpu_id
operator|&
literal|0xf00
operator|)
operator|==
literal|0x500
operator|)
operator|&&
operator|(
operator|(
name|cpu_id
operator|&
literal|0x0f0
operator|)
operator|>
literal|0x50
operator|)
condition|)
block|{
comment|/* K6, K6-2(old core) */
name|amd_whcr
operator|=
name|rdmsr
argument_list|(
literal|0xc0000082
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|amd_whcr
operator|&
operator|(
literal|0x7f
operator|<<
literal|1
operator|)
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"Write Allocate Disable\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"Write Allocate Enable Limit: %dM bytes\n"
argument_list|,
call|(
name|u_int32_t
call|)
argument_list|(
operator|(
name|amd_whcr
operator|&
operator|(
literal|0x7f
operator|<<
literal|1
operator|)
operator|)
operator|>>
literal|1
argument_list|)
operator|*
literal|4
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Write Allocate 15-16M bytes: %s\n"
argument_list|,
operator|(
name|amd_whcr
operator|&
literal|0x0001
operator|)
condition|?
literal|"Enable"
else|:
literal|"Disable"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Hardware Write Allocate Control: %s\n"
argument_list|,
operator|(
name|amd_whcr
operator|&
literal|0x0100
operator|)
condition|?
literal|"Enable"
else|:
literal|"Disable"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|print_INTEL_info
parameter_list|(
name|void
parameter_list|)
block|{
name|u_int
name|regs
index|[
literal|4
index|]
decl_stmt|;
name|u_int
name|rounds
decl_stmt|,
name|regnum
decl_stmt|;
name|u_int
name|nwaycode
decl_stmt|,
name|nway
decl_stmt|;
if|if
condition|(
name|cpu_high
operator|>=
literal|2
condition|)
block|{
name|rounds
operator|=
literal|0
expr_stmt|;
do|do
block|{
name|do_cpuid
argument_list|(
literal|0x2
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
name|rounds
operator|==
literal|0
operator|&&
operator|(
name|rounds
operator|=
operator|(
name|regs
index|[
literal|0
index|]
operator|&
literal|0xff
operator|)
operator|)
operator|==
literal|0
condition|)
break|break;
comment|/* we have a buggy CPU */
for|for
control|(
name|regnum
operator|=
literal|0
init|;
name|regnum
operator|<=
literal|3
condition|;
operator|++
name|regnum
control|)
block|{
if|if
condition|(
name|regs
index|[
name|regnum
index|]
operator|&
operator|(
literal|1
operator|<<
literal|31
operator|)
condition|)
continue|continue;
if|if
condition|(
name|regnum
operator|!=
literal|0
condition|)
name|print_INTEL_TLB
argument_list|(
name|regs
index|[
name|regnum
index|]
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|print_INTEL_TLB
argument_list|(
operator|(
name|regs
index|[
name|regnum
index|]
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|print_INTEL_TLB
argument_list|(
operator|(
name|regs
index|[
name|regnum
index|]
operator|>>
literal|16
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|print_INTEL_TLB
argument_list|(
operator|(
name|regs
index|[
name|regnum
index|]
operator|>>
literal|24
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
block|}
block|}
do|while
condition|(
operator|--
name|rounds
operator|>
literal|0
condition|)
do|;
block|}
if|if
condition|(
name|cpu_exthigh
operator|>=
literal|0x80000006
condition|)
block|{
name|do_cpuid
argument_list|(
literal|0x80000006
argument_list|,
name|regs
argument_list|)
expr_stmt|;
name|nwaycode
operator|=
operator|(
name|regs
index|[
literal|2
index|]
operator|>>
literal|12
operator|)
operator|&
literal|0x0f
expr_stmt|;
if|if
condition|(
name|nwaycode
operator|>=
literal|0x02
operator|&&
name|nwaycode
operator|<=
literal|0x08
condition|)
name|nway
operator|=
literal|1
operator|<<
operator|(
name|nwaycode
operator|/
literal|2
operator|)
expr_stmt|;
else|else
name|nway
operator|=
literal|0
expr_stmt|;
name|printf
argument_list|(
literal|"\nL2 cache: %u kbytes, %u-way associative, %u bytes/line"
argument_list|,
operator|(
name|regs
index|[
literal|2
index|]
operator|>>
literal|16
operator|)
operator|&
literal|0xffff
argument_list|,
name|nway
argument_list|,
name|regs
index|[
literal|2
index|]
operator|&
literal|0xff
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_INTEL_TLB
parameter_list|(
name|u_int
name|data
parameter_list|)
block|{
switch|switch
condition|(
name|data
condition|)
block|{
case|case
literal|0x0
case|:
case|case
literal|0x40
case|:
default|default:
break|break;
case|case
literal|0x1
case|:
name|printf
argument_list|(
literal|"\nInstruction TLB: 4 KB pages, 4-way set associative, 32 entries"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x2
case|:
name|printf
argument_list|(
literal|"\nInstruction TLB: 4 MB pages, fully associative, 2 entries"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x3
case|:
name|printf
argument_list|(
literal|"\nData TLB: 4 KB pages, 4-way set associative, 64 entries"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x4
case|:
name|printf
argument_list|(
literal|"\nData TLB: 4 MB Pages, 4-way set associative, 8 entries"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x6
case|:
name|printf
argument_list|(
literal|"\n1st-level instruction cache: 8 KB, 4-way set associative, 32 byte line size"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x8
case|:
name|printf
argument_list|(
literal|"\n1st-level instruction cache: 16 KB, 4-way set associative, 32 byte line size"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xa
case|:
name|printf
argument_list|(
literal|"\n1st-level data cache: 8 KB, 2-way set associative, 32 byte line size"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xc
case|:
name|printf
argument_list|(
literal|"\n1st-level data cache: 16 KB, 4-way set associative, 32 byte line size"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x22
case|:
name|printf
argument_list|(
literal|"\n3rd-level cache: 512 KB, 4-way set associative, sectored cache, 64 byte line size"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x23
case|:
name|printf
argument_list|(
literal|"\n3rd-level cache: 1 MB, 8-way set associative, sectored cache, 64 byte line size"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x25
case|:
name|printf
argument_list|(
literal|"\n3rd-level cache: 2 MB, 8-way set associative, sectored cache, 64 byte line size"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x29
case|:
name|printf
argument_list|(
literal|"\n3rd-level cache: 4 MB, 8-way set associative, sectored cache, 64 byte line size"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x2c
case|:
name|printf
argument_list|(
literal|"\n1st-level data cache: 32 KB, 8-way set associative, 64 byte line size"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x30
case|:
name|printf
argument_list|(
literal|"\n1st-level instruction cache: 32 KB, 8-way set associative, 64 byte line size"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x39
case|:
name|printf
argument_list|(
literal|"\n2nd-level cache: 128 KB, 4-way set associative, sectored cache, 64 byte line size"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x3b
case|:
name|printf
argument_list|(
literal|"\n2nd-level cache: 128 KB, 2-way set associative, sectored cache, 64 byte line size"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x3c
case|:
name|printf
argument_list|(
literal|"\n2nd-level cache: 256 KB, 4-way set associative, sectored cache, 64 byte line size"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x41
case|:
name|printf
argument_list|(
literal|"\n2nd-level cache: 128 KB, 4-way set associative, 32 byte line size"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x42
case|:
name|printf
argument_list|(
literal|"\n2nd-level cache: 256 KB, 4-way set associative, 32 byte line size"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x43
case|:
name|printf
argument_list|(
literal|"\n2nd-level cache: 512 KB, 4-way set associative, 32 byte line size"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x44
case|:
name|printf
argument_list|(
literal|"\n2nd-level cache: 1 MB, 4-way set associative, 32 byte line size"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x45
case|:
name|printf
argument_list|(
literal|"\n2nd-level cache: 2 MB, 4-way set associative, 32 byte line size"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x46
case|:
name|printf
argument_list|(
literal|"\n3rd-level cache: 4 MB, 4-way set associative, 64 byte line size"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x47
case|:
name|printf
argument_list|(
literal|"\n3rd-level cache: 8 MB, 8-way set associative, 64 byte line size"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x50
case|:
name|printf
argument_list|(
literal|"\nInstruction TLB: 4 KB, 2 MB or 4 MB pages, fully associative, 64 entries"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x51
case|:
name|printf
argument_list|(
literal|"\nInstruction TLB: 4 KB, 2 MB or 4 MB pages, fully associative, 128 entries"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x52
case|:
name|printf
argument_list|(
literal|"\nInstruction TLB: 4 KB, 2 MB or 4 MB pages, fully associative, 256 entries"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x5b
case|:
name|printf
argument_list|(
literal|"\nData TLB: 4 KB or 4 MB pages, fully associative, 64 entries"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x5c
case|:
name|printf
argument_list|(
literal|"\nData TLB: 4 KB or 4 MB pages, fully associative, 128 entries"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x5d
case|:
name|printf
argument_list|(
literal|"\nData TLB: 4 KB or 4 MB pages, fully associative, 256 entries"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x60
case|:
name|printf
argument_list|(
literal|"\n1st-level data cache: 16 KB, 8-way set associative, sectored cache, 64 byte line size"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x66
case|:
name|printf
argument_list|(
literal|"\n1st-level data cache: 8 KB, 4-way set associative, sectored cache, 64 byte line size"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x67
case|:
name|printf
argument_list|(
literal|"\n1st-level data cache: 16 KB, 4-way set associative, sectored cache, 64 byte line size"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x68
case|:
name|printf
argument_list|(
literal|"\n1st-level data cache: 32 KB, 4 way set associative, sectored cache, 64 byte line size"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x70
case|:
name|printf
argument_list|(
literal|"\nTrace cache: 12K-uops, 8-way set associative"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x71
case|:
name|printf
argument_list|(
literal|"\nTrace cache: 16K-uops, 8-way set associative"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x72
case|:
name|printf
argument_list|(
literal|"\nTrace cache: 32K-uops, 8-way set associative"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x78
case|:
name|printf
argument_list|(
literal|"\n2nd-level cache: 1 MB, 4-way set associative, 64-byte line size"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x79
case|:
name|printf
argument_list|(
literal|"\n2nd-level cache: 128 KB, 8-way set associative, sectored cache, 64 byte line size"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x7a
case|:
name|printf
argument_list|(
literal|"\n2nd-level cache: 256 KB, 8-way set associative, sectored cache, 64 byte line size"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x7b
case|:
name|printf
argument_list|(
literal|"\n2nd-level cache: 512 KB, 8-way set associative, sectored cache, 64 byte line size"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x7c
case|:
name|printf
argument_list|(
literal|"\n2nd-level cache: 1 MB, 8-way set associative, sectored cache, 64 byte line size"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x7d
case|:
name|printf
argument_list|(
literal|"\n2nd-level cache: 2-MB, 8-way set associative, 64-byte line size"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x7f
case|:
name|printf
argument_list|(
literal|"\n2nd-level cache: 512-KB, 2-way set associative, 64-byte line size"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x82
case|:
name|printf
argument_list|(
literal|"\n2nd-level cache: 256 KB, 8-way set associative, 32 byte line size"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x83
case|:
name|printf
argument_list|(
literal|"\n2nd-level cache: 512 KB, 8-way set associative, 32 byte line size"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x84
case|:
name|printf
argument_list|(
literal|"\n2nd-level cache: 1 MB, 8-way set associative, 32 byte line size"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x85
case|:
name|printf
argument_list|(
literal|"\n2nd-level cache: 2 MB, 8-way set associative, 32 byte line size"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x86
case|:
name|printf
argument_list|(
literal|"\n2nd-level cache: 512 KB, 4-way set associative, 64 byte line size"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x87
case|:
name|printf
argument_list|(
literal|"\n2nd-level cache: 1 MB, 8-way set associative, 64 byte line size"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xb0
case|:
name|printf
argument_list|(
literal|"\nInstruction TLB: 4 KB Pages, 4-way set associative, 128 entries"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xb3
case|:
name|printf
argument_list|(
literal|"\nData TLB: 4 KB Pages, 4-way set associative, 128 entries"
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|print_transmeta_info
parameter_list|(
name|void
parameter_list|)
block|{
name|u_int
name|regs
index|[
literal|4
index|]
decl_stmt|,
name|nreg
init|=
literal|0
decl_stmt|;
name|do_cpuid
argument_list|(
literal|0x80860000
argument_list|,
name|regs
argument_list|)
expr_stmt|;
name|nreg
operator|=
name|regs
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|nreg
operator|>=
literal|0x80860001
condition|)
block|{
name|do_cpuid
argument_list|(
literal|0x80860001
argument_list|,
name|regs
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  Processor revision %u.%u.%u.%u\n"
argument_list|,
operator|(
name|regs
index|[
literal|1
index|]
operator|>>
literal|24
operator|)
operator|&
literal|0xff
argument_list|,
operator|(
name|regs
index|[
literal|1
index|]
operator|>>
literal|16
operator|)
operator|&
literal|0xff
argument_list|,
operator|(
name|regs
index|[
literal|1
index|]
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|,
name|regs
index|[
literal|1
index|]
operator|&
literal|0xff
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|nreg
operator|>=
literal|0x80860002
condition|)
block|{
name|do_cpuid
argument_list|(
literal|0x80860002
argument_list|,
name|regs
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  Code Morphing Software revision %u.%u.%u-%u-%u\n"
argument_list|,
operator|(
name|regs
index|[
literal|1
index|]
operator|>>
literal|24
operator|)
operator|&
literal|0xff
argument_list|,
operator|(
name|regs
index|[
literal|1
index|]
operator|>>
literal|16
operator|)
operator|&
literal|0xff
argument_list|,
operator|(
name|regs
index|[
literal|1
index|]
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|,
name|regs
index|[
literal|1
index|]
operator|&
literal|0xff
argument_list|,
name|regs
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|nreg
operator|>=
literal|0x80860006
condition|)
block|{
name|char
name|info
index|[
literal|65
index|]
decl_stmt|;
name|do_cpuid
argument_list|(
literal|0x80860003
argument_list|,
operator|(
name|u_int
operator|*
operator|)
operator|&
name|info
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|do_cpuid
argument_list|(
literal|0x80860004
argument_list|,
operator|(
name|u_int
operator|*
operator|)
operator|&
name|info
index|[
literal|16
index|]
argument_list|)
expr_stmt|;
name|do_cpuid
argument_list|(
literal|0x80860005
argument_list|,
operator|(
name|u_int
operator|*
operator|)
operator|&
name|info
index|[
literal|32
index|]
argument_list|)
expr_stmt|;
name|do_cpuid
argument_list|(
literal|0x80860006
argument_list|,
operator|(
name|u_int
operator|*
operator|)
operator|&
name|info
index|[
literal|48
index|]
argument_list|)
expr_stmt|;
name|info
index|[
literal|64
index|]
operator|=
literal|0
expr_stmt|;
name|printf
argument_list|(
literal|"  %s\n"
argument_list|,
name|info
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|print_via_padlock_info
parameter_list|(
name|void
parameter_list|)
block|{
name|u_int
name|regs
index|[
literal|4
index|]
decl_stmt|;
comment|/* Check for supported models. */
switch|switch
condition|(
name|cpu_id
operator|&
literal|0xff0
condition|)
block|{
case|case
literal|0x690
case|:
if|if
condition|(
operator|(
name|cpu_id
operator|&
literal|0xf
operator|)
operator|<
literal|3
condition|)
return|return;
case|case
literal|0x6a0
case|:
case|case
literal|0x6d0
case|:
case|case
literal|0x6f0
case|:
break|break;
default|default:
return|return;
block|}
name|do_cpuid
argument_list|(
literal|0xc0000000
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
name|regs
index|[
literal|0
index|]
operator|>=
literal|0xc0000001
condition|)
name|do_cpuid
argument_list|(
literal|0xc0000001
argument_list|,
name|regs
argument_list|)
expr_stmt|;
else|else
return|return;
name|printf
argument_list|(
literal|"\n  VIA Padlock Features=0x%b"
argument_list|,
name|regs
index|[
literal|3
index|]
argument_list|,
literal|"\020"
literal|"\003RNG"
comment|/* RNG */
literal|"\007AES"
comment|/* ACE */
literal|"\011AES-CTR"
comment|/* ACE2 */
literal|"\013SHA1,SHA256"
comment|/* PHE */
literal|"\015RSA"
comment|/* PMM */
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


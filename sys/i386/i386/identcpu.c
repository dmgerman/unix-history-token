begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1992 Terrence R. Lambert.  * Copyright (c) 1982, 1987, 1990 The Regents of the University of California.  * Copyright (c) 1997 KATO Takenori.  * All rights reserved.  *  * This code is derived from software contributed to Berkeley by  * William Jolitz.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. All advertising materials mentioning features or use of this software  *    must display the following acknowledgement:  *	This product includes software developed by the University of  *	California, Berkeley and its contributors.  * 4. Neither the name of the University nor the names of its contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  *	from: Id: machdep.c,v 1.193 1996/06/18 01:22:04 bde Exp  *	$Id: identcpu.c,v 1.36 1997/12/26 20:41:32 phk Exp $  */
end_comment

begin_include
include|#
directive|include
file|"opt_cpu.h"
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<machine/asmacros.h>
end_include

begin_include
include|#
directive|include
file|<machine/clock.h>
end_include

begin_include
include|#
directive|include
file|<machine/cputypes.h>
end_include

begin_include
include|#
directive|include
file|<machine/segments.h>
end_include

begin_include
include|#
directive|include
file|<machine/specialreg.h>
end_include

begin_include
include|#
directive|include
file|<machine/md_var.h>
end_include

begin_include
include|#
directive|include
file|<i386/isa/intr_machdep.h>
end_include

begin_comment
comment|/* XXX - should be in header file */
end_comment

begin_decl_stmt
name|void
name|i486_bzero
name|__P
argument_list|(
operator|(
name|void
operator|*
name|buf
operator|,
name|size_t
name|len
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function_decl
name|void
name|printcpuinfo
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* XXX should be in different header file */
end_comment

begin_function_decl
name|void
name|finishidentcpu
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|earlysetcpuclass
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|panicifcpuunsupported
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|identifycyrix
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|print_AMD_info
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|print_AMD_assoc
parameter_list|(
name|int
name|i
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|do_cpuid
parameter_list|(
name|u_long
name|ax
parameter_list|,
name|u_long
modifier|*
name|p
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
name|u_long
name|cyrix_did
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Device ID of Cyrix CPU */
end_comment

begin_decl_stmt
name|int
name|cpu_class
init|=
name|CPUCLASS_386
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* least common denominator */
end_comment

begin_decl_stmt
name|char
name|machine
index|[]
init|=
literal|"i386"
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|SYSCTL_STRING
argument_list|(
name|_hw
argument_list|,
name|HW_MACHINE
argument_list|,
name|machine
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|machine
argument_list|,
literal|0
argument_list|,
literal|""
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|char
name|cpu_model
index|[
literal|128
index|]
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|SYSCTL_STRING
argument_list|(
name|_hw
argument_list|,
name|HW_MODEL
argument_list|,
name|model
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|cpu_model
argument_list|,
literal|0
argument_list|,
literal|""
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|struct
name|cpu_nameclass
name|i386_cpus
index|[]
init|=
block|{
block|{
literal|"Intel 80286"
block|,
name|CPUCLASS_286
block|}
block|,
comment|/* CPU_286   */
block|{
literal|"i386SX"
block|,
name|CPUCLASS_386
block|}
block|,
comment|/* CPU_386SX */
block|{
literal|"i386DX"
block|,
name|CPUCLASS_386
block|}
block|,
comment|/* CPU_386   */
block|{
literal|"i486SX"
block|,
name|CPUCLASS_486
block|}
block|,
comment|/* CPU_486SX */
block|{
literal|"i486DX"
block|,
name|CPUCLASS_486
block|}
block|,
comment|/* CPU_486   */
block|{
literal|"Pentium"
block|,
name|CPUCLASS_586
block|}
block|,
comment|/* CPU_586   */
block|{
literal|"Cyrix 486"
block|,
name|CPUCLASS_486
block|}
block|,
comment|/* CPU_486DLC */
block|{
literal|"Pentium Pro"
block|,
name|CPUCLASS_686
block|}
block|,
comment|/* CPU_686 */
block|{
literal|"Cyrix 5x86"
block|,
name|CPUCLASS_486
block|}
block|,
comment|/* CPU_M1SC */
block|{
literal|"Cyrix 6x86"
block|,
name|CPUCLASS_486
block|}
block|,
comment|/* CPU_M1 */
block|{
literal|"Blue Lightning"
block|,
name|CPUCLASS_486
block|}
block|,
comment|/* CPU_BLUE */
block|{
literal|"Cyrix 6x86MX"
block|,
name|CPUCLASS_686
block|}
block|,
comment|/* CPU_M2 */
block|{
literal|"NexGen 586"
block|,
name|CPUCLASS_386
block|}
block|,
comment|/* CPU_NX586 (XXX) */
block|{
literal|"Cyrix 486S/DX"
block|,
name|CPUCLASS_486
block|}
block|,
comment|/* CPU_CY486DX */
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|do_cpuid
parameter_list|(
name|u_long
name|ax
parameter_list|,
name|u_long
modifier|*
name|p
parameter_list|)
block|{
asm|__asm __volatile(
literal|".byte	0x0f, 0xa2;"
literal|"movl	%%eax, (%%esi);"
literal|"movl	%%ebx, (4)(%%esi);"
literal|"movl	%%ecx, (8)(%%esi);"
literal|"movl	%%edx, (12)(%%esi);"
operator|:
operator|:
literal|"a"
operator|(
name|ax
operator|)
operator|,
literal|"S"
operator|(
name|p
operator|)
operator|:
literal|"ax"
operator|,
literal|"bx"
operator|,
literal|"cx"
operator|,
literal|"dx"
block|)
function|;
end_function

begin_if
unit|}
if|#
directive|if
name|defined
argument_list|(
name|I586_CPU
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|NO_F00F_HACK
argument_list|)
end_if

begin_expr_stmt
unit|int
name|has_f00f_bug
operator|=
literal|0
expr_stmt|;
end_expr_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|void
name|printcpuinfo
parameter_list|(
name|void
parameter_list|)
block|{
name|u_long
name|regs
index|[
literal|4
index|]
decl_stmt|,
name|nreg
decl_stmt|;
name|cpu_class
operator|=
name|i386_cpus
index|[
name|cpu
index|]
operator|.
name|cpu_class
expr_stmt|;
name|printf
argument_list|(
literal|"CPU: "
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|cpu_model
argument_list|,
name|i386_cpus
index|[
name|cpu
index|]
operator|.
name|cpu_name
argument_list|,
sizeof|sizeof
name|cpu_model
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|I486_CPU
argument_list|)
operator|||
name|defined
argument_list|(
name|I586_CPU
argument_list|)
operator|||
name|defined
argument_list|(
name|I686_CPU
argument_list|)
if|if
condition|(
name|strcmp
argument_list|(
name|cpu_vendor
argument_list|,
literal|"GenuineIntel"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|cpu_id
operator|&
literal|0xf00
operator|)
operator|>
literal|3
condition|)
block|{
name|cpu_model
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
switch|switch
condition|(
name|cpu_id
operator|&
literal|0x3000
condition|)
block|{
case|case
literal|0x1000
case|:
name|strcpy
argument_list|(
name|cpu_model
argument_list|,
literal|"Overdrive "
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x2000
case|:
name|strcpy
argument_list|(
name|cpu_model
argument_list|,
literal|"Dual "
argument_list|)
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
name|cpu_id
operator|&
literal|0xf00
condition|)
block|{
case|case
literal|0x400
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"i486 "
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x500
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"Pentium"
argument_list|)
expr_stmt|;
comment|/* nb no space */
if|#
directive|if
name|defined
argument_list|(
name|I586_CPU
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|NO_F00F_HACK
argument_list|)
comment|/* 				 * XXX - If/when Intel fixes the bug, this 				 * should also check the version of the 				 * CPU, not just that it's a Pentium. 				 */
name|has_f00f_bug
operator|=
literal|1
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
literal|0x600
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"Pentium Pro"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"unknown"
argument_list|)
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
name|cpu_id
operator|&
literal|0xff0
condition|)
block|{
case|case
literal|0x400
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"DX"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x410
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"DX"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x420
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"SX"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x430
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"DX2"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x440
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"SL"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x450
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"SX2"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x470
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"DX2 Write-Back Enhanced"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x480
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"DX4"
argument_list|)
expr_stmt|;
break|break;
break|break;
block|}
block|}
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|cpu_vendor
argument_list|,
literal|"AuthenticAMD"
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* 		 * Values taken from AMD Processor Recognition 		 * http://www.amd.com/K6/k6docs/pdf/20734g.pdf 		 * (also describes ``Features'' encodings. 		 */
name|strcpy
argument_list|(
name|cpu_model
argument_list|,
literal|"AMD "
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cpu_id
operator|&
literal|0xFF0
condition|)
block|{
case|case
literal|0x410
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"Standard Am486DX"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x430
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"Am486DX2/4 Write-Through"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x470
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"Enhanced Am486DX4 Write-Back"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x480
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"Enhanced Am486DX4 Write-Through"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x490
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"Enhanced Am486DX4 Write-Back"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x4E0
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"Am5x86 Write-Through"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x4F0
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"Am5x86 Write-Back"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x500
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"K5 model 0"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x510
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"K5 model 1"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x520
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"K5 PR166"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x530
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"K5 PR200"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x560
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"K6"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"Unknown"
argument_list|)
expr_stmt|;
break|break;
block|}
name|do_cpuid
argument_list|(
literal|0x80000000
argument_list|,
name|regs
argument_list|)
expr_stmt|;
name|nreg
operator|=
name|regs
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|nreg
operator|>=
literal|0x80000004
condition|)
block|{
name|do_cpuid
argument_list|(
literal|0x80000002
argument_list|,
name|regs
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|cpu_model
argument_list|,
name|regs
argument_list|,
sizeof|sizeof
name|regs
argument_list|)
expr_stmt|;
name|do_cpuid
argument_list|(
literal|0x80000003
argument_list|,
name|regs
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|cpu_model
operator|+
literal|16
argument_list|,
name|regs
argument_list|,
sizeof|sizeof
name|regs
argument_list|)
expr_stmt|;
name|do_cpuid
argument_list|(
literal|0x80000004
argument_list|,
name|regs
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|cpu_model
operator|+
literal|32
argument_list|,
name|regs
argument_list|,
sizeof|sizeof
name|regs
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|cpu_vendor
argument_list|,
literal|"CyrixInstead"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|strcpy
argument_list|(
name|cpu_model
argument_list|,
literal|"Cyrix "
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cpu_id
operator|&
literal|0xff0
condition|)
block|{
case|case
literal|0x440
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"MediaGX"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x520
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"6x86"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x540
case|:
name|cpu_class
operator|=
name|CPUCLASS_586
expr_stmt|;
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"GXm"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x600
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"6x86MX"
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|/* 			 * Even though CPU supports the cpuid 			 * instruction, it can be disabled. 			 * Therefore, this routine supports all Cyrix 			 * CPUs. 			 */
switch|switch
condition|(
name|cyrix_did
operator|&
literal|0xf0
condition|)
block|{
case|case
literal|0x00
case|:
switch|switch
condition|(
name|cyrix_did
operator|&
literal|0x0f
condition|)
block|{
case|case
literal|0x00
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486SLC"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x01
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486DLC"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x02
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486SLC2"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x03
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486DLC2"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x04
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486SRx"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x05
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486DRx"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x06
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486SRx2"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x07
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486DRx2"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x08
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486SRu"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x09
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486DRu"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x0a
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486SRu2"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x0b
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486DRu2"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"Unknown"
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|0x10
case|:
switch|switch
condition|(
name|cyrix_did
operator|&
literal|0x0f
condition|)
block|{
case|case
literal|0x00
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486S"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x01
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486S2"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x02
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486Se"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x03
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486S2e"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x0a
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486DX"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x0b
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486DX2"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x0f
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486DX4"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"Unknown"
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|0x20
case|:
if|if
condition|(
operator|(
name|cyrix_did
operator|&
literal|0x0f
operator|)
operator|<
literal|8
condition|)
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"6x86"
argument_list|)
expr_stmt|;
comment|/* Where did you get it? */
else|else
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"5x86"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x30
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"6x86"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x40
case|:
if|if
condition|(
operator|(
name|cyrix_did
operator|&
literal|0xf000
operator|)
operator|==
literal|0x3000
condition|)
block|{
name|cpu_class
operator|=
name|CPUCLASS_586
expr_stmt|;
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"GXm"
argument_list|)
expr_stmt|;
block|}
else|else
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"MediaGX"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x50
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"6x86MX"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xf0
case|:
switch|switch
condition|(
name|cyrix_did
operator|&
literal|0x0f
condition|)
block|{
case|case
literal|0x0d
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"Overdrive CPU"
argument_list|)
expr_stmt|;
case|case
literal|0x0e
case|:
name|strcpy
argument_list|(
name|cpu_model
argument_list|,
literal|"Texas Instruments 486SXL"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x0f
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486SLC/DLC"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"Unknown"
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
default|default:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"Unknown"
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
block|}
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|cpu_vendor
argument_list|,
literal|"IBM"
argument_list|)
operator|==
literal|0
condition|)
name|strcpy
argument_list|(
name|cpu_model
argument_list|,
literal|"Blue Lightning CPU"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|printf
argument_list|(
literal|"%s ("
argument_list|,
name|cpu_model
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cpu_class
condition|)
block|{
case|case
name|CPUCLASS_286
case|:
name|printf
argument_list|(
literal|"286"
argument_list|)
expr_stmt|;
break|break;
if|#
directive|if
name|defined
argument_list|(
name|I386_CPU
argument_list|)
case|case
name|CPUCLASS_386
case|:
name|printf
argument_list|(
literal|"386"
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|I486_CPU
argument_list|)
case|case
name|CPUCLASS_486
case|:
name|printf
argument_list|(
literal|"486"
argument_list|)
expr_stmt|;
name|bzero
operator|=
name|i486_bzero
expr_stmt|;
break|break;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|I586_CPU
argument_list|)
case|case
name|CPUCLASS_586
case|:
ifndef|#
directive|ifndef
name|SMP
name|printf
argument_list|(
literal|"%d.%02d-MHz "
argument_list|,
operator|(
name|tsc_freq
operator|+
literal|4999
operator|)
operator|/
literal|1000000
argument_list|,
operator|(
operator|(
name|tsc_freq
operator|+
literal|4999
operator|)
operator|/
literal|10000
operator|)
operator|%
literal|100
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|printf
argument_list|(
literal|"586"
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|I686_CPU
argument_list|)
case|case
name|CPUCLASS_686
case|:
ifndef|#
directive|ifndef
name|SMP
name|printf
argument_list|(
literal|"%d.%02d-MHz "
argument_list|,
operator|(
name|tsc_freq
operator|+
literal|4999
operator|)
operator|/
literal|1000000
argument_list|,
operator|(
operator|(
name|tsc_freq
operator|+
literal|4999
operator|)
operator|/
literal|10000
operator|)
operator|%
literal|100
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|printf
argument_list|(
literal|"686"
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
name|printf
argument_list|(
literal|"unknown"
argument_list|)
expr_stmt|;
comment|/* will panic below... */
block|}
name|printf
argument_list|(
literal|"-class CPU)\n"
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|I486_CPU
argument_list|)
operator|||
name|defined
argument_list|(
name|I586_CPU
argument_list|)
operator|||
name|defined
argument_list|(
name|I686_CPU
argument_list|)
if|if
condition|(
operator|*
name|cpu_vendor
condition|)
name|printf
argument_list|(
literal|"  Origin = \"%s\""
argument_list|,
name|cpu_vendor
argument_list|)
expr_stmt|;
if|if
condition|(
name|cpu_id
condition|)
name|printf
argument_list|(
literal|"  Id = 0x%lx"
argument_list|,
name|cpu_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|cpu_vendor
argument_list|,
literal|"GenuineIntel"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|cpu_vendor
argument_list|,
literal|"AuthenticAMD"
argument_list|)
operator|==
literal|0
operator|||
operator|(
operator|(
name|strcmp
argument_list|(
name|cpu_vendor
argument_list|,
literal|"CyrixInstead"
argument_list|)
operator|==
literal|0
operator|)
operator|&&
operator|(
name|cpu_id
operator|&
literal|0xf00
operator|>
literal|5
operator|)
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"  Stepping=%ld"
argument_list|,
name|cpu_id
operator|&
literal|0xf
argument_list|)
expr_stmt|;
if|if
condition|(
name|cpu_high
operator|>
literal|0
condition|)
block|{
comment|/* 			 * Here we should probably set up flags indicating 			 * whether or not various features are available. 			 * The interesting ones are probably VME, PSE, PAE, 			 * and PGE.  The code already assumes without bothering 			 * to check that all CPUs>= Pentium have a TSC and 			 * MSRs. 			 */
name|printf
argument_list|(
literal|"\n  Features=0x%b"
argument_list|,
name|cpu_feature
argument_list|,
literal|"\020"
literal|"\001FPU"
literal|"\002VME"
literal|"\003DE"
literal|"\004PSE"
literal|"\005TSC"
literal|"\006MSR"
literal|"\007PAE"
literal|"\010MCE"
literal|"\011CX8"
literal|"\012APIC"
literal|"\013oldMTRR"
literal|"\014SEP"
literal|"\015MTRR"
literal|"\016PGE"
literal|"\017MCA"
literal|"\020CMOV"
literal|"\021<b16>"
literal|"\022<b17>"
literal|"\023<b18>"
literal|"\024<b19>"
literal|"\025<b20>"
literal|"\026<b21>"
literal|"\027<b22>"
literal|"\030MMX"
literal|"\031<b24>"
literal|"\032<b25>"
literal|"\033<b26>"
literal|"\034<b27>"
literal|"\035<b28>"
literal|"\036<b29>"
literal|"\037<b30>"
literal|"\040<b31>"
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|cpu_vendor
argument_list|,
literal|"CyrixInstead"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"  DIR=0x%lx"
argument_list|,
name|cyrix_did
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  Stepping=%ld"
argument_list|,
operator|(
name|cyrix_did
operator|&
literal|0xf000
operator|)
operator|>>
literal|12
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  Revision=%ld"
argument_list|,
operator|(
name|cyrix_did
operator|&
literal|0x0fff
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|CYRIX_CACHE_REALLY_WORKS
if|if
condition|(
name|cpu
operator|==
name|CPU_M1
operator|&&
operator|(
name|cyrix_did
operator|&
literal|0xff00
operator|)
operator|<
literal|0x1700
condition|)
name|printf
argument_list|(
literal|"\n  CPU cache: write-through mode"
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
comment|/* Avoid ugly blank lines: only print newline when we have to. */
if|if
condition|(
operator|*
name|cpu_vendor
operator|||
name|cpu_id
condition|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|bootverbose
condition|)
return|return;
if|if
condition|(
name|strcmp
argument_list|(
name|cpu_vendor
argument_list|,
literal|"AuthenticAMD"
argument_list|)
operator|==
literal|0
condition|)
name|print_AMD_info
argument_list|()
expr_stmt|;
ifdef|#
directive|ifdef
name|I686_CPU
comment|/* 	 * XXX - Do PPro CPUID level=2 stuff here? 	 * 	 * No, but maybe in a print_Intel_info() function called from here. 	 */
endif|#
directive|endif
block|}
end_function

begin_function
name|void
name|panicifcpuunsupported
parameter_list|(
name|void
parameter_list|)
block|{
comment|/* 	 * Now that we have told the user what they have, 	 * let them know if that machine type isn't configured. 	 */
switch|switch
condition|(
name|cpu_class
condition|)
block|{
case|case
name|CPUCLASS_286
case|:
comment|/* a 286 should not make it this far, anyway */
if|#
directive|if
operator|!
name|defined
argument_list|(
name|I386_CPU
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|I486_CPU
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|I586_CPU
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|I686_CPU
argument_list|)
error|#
directive|error
error|This kernel is not configured for one of the supported CPUs
endif|#
directive|endif
if|#
directive|if
operator|!
name|defined
argument_list|(
name|I386_CPU
argument_list|)
case|case
name|CPUCLASS_386
case|:
endif|#
directive|endif
if|#
directive|if
operator|!
name|defined
argument_list|(
name|I486_CPU
argument_list|)
case|case
name|CPUCLASS_486
case|:
endif|#
directive|endif
if|#
directive|if
operator|!
name|defined
argument_list|(
name|I586_CPU
argument_list|)
case|case
name|CPUCLASS_586
case|:
endif|#
directive|endif
if|#
directive|if
operator|!
name|defined
argument_list|(
name|I686_CPU
argument_list|)
case|case
name|CPUCLASS_686
case|:
endif|#
directive|endif
name|panic
argument_list|(
literal|"CPU class not configured"
argument_list|)
expr_stmt|;
default|default:
break|break;
block|}
block|}
end_function

begin_decl_stmt
specifier|static
specifier|volatile
name|u_int
name|trap_by_wrmsr
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Special exception 16 handler.  * The wrmsr instruction generates invalid opcodes fault on 486-class  * Cyrix CPU.  Stacked eip register points the wrmsr instruction in the  * function identblue() when this handler is called.  Stacked eip should  * be advanced.  */
end_comment

begin_decl_stmt
name|inthand_t
name|bluetrap
decl_stmt|;
end_decl_stmt

begin_asm
asm|asm (" 	.text 	.p2align 2,0x90 " __XSTRING(CNAME(bluetrap)) ": 	ss 	movl	$0xa8c1d," __XSTRING(CNAME(trap_by_wrmsr)) " # Don't ask meaning of the number :-). 	addl	$2, (%esp)				  # I know wrmsr is a 2-bytes instruction. 	iret ");
end_asm

begin_comment
comment|/*  * Distinguish IBM Blue Lightning CPU from Cyrix CPUs that does not  * support cpuid instruction.  This function should be called after  * loading interrupt descriptor table register.  *  * I don't like this method that handles fault, but I couldn't get  * information for any other methods.  Does blue giant know?  */
end_comment

begin_function
specifier|static
name|int
name|identblue
parameter_list|(
name|void
parameter_list|)
block|{
name|trap_by_wrmsr
operator|=
literal|0
expr_stmt|;
comment|/*  	 * Cyrix 486-class CPU does not support wrmsr instruction. 	 * The wrmsr instruction causes invalid opcode fault, and exception 	 * will be trapped by bluetrap() on Cyrix 486-class CPU.  The bluetrap() 	 * set the magic number to trap_by_wrmsr. 	 */
name|setidt
argument_list|(
literal|6
argument_list|,
name|bluetrap
argument_list|,
name|SDT_SYS386TGT
argument_list|,
name|SEL_KPL
argument_list|,
name|GSEL
argument_list|(
name|GCODE_SEL
argument_list|,
name|SEL_KPL
argument_list|)
argument_list|)
expr_stmt|;
name|wrmsr
argument_list|(
literal|0x1002
argument_list|,
literal|0x03000000LL
argument_list|)
expr_stmt|;
comment|/* Fault on Cyrix 486-class CPU. */
if|if
condition|(
name|trap_by_wrmsr
operator|==
literal|0xa8c1d
condition|)
return|return
literal|0
return|;
comment|/* Cyrix CPU sets the magic number. */
return|return
literal|1
return|;
comment|/* IBM Blue Lightnig CPU */
block|}
end_function

begin_comment
comment|/*  * identifycyrix() set lower 16 bits of cyrix_did as follows:  *  *  F E D C B A 9 8 7 6 5 4 3 2 1 0  * +-------+-------+---------------+  * |  SID  |  RID  |   Device ID   |  * |    (DIR 1)    |    (DIR 0)    |  * +-------+-------+---------------+  */
end_comment

begin_function
specifier|static
name|void
name|identifycyrix
parameter_list|(
name|void
parameter_list|)
block|{
name|u_long
name|eflags
decl_stmt|;
name|int
name|ccr2_test
init|=
literal|0
decl_stmt|,
name|dir_test
init|=
literal|0
decl_stmt|;
name|u_char
name|ccr2
decl_stmt|,
name|ccr3
decl_stmt|;
name|eflags
operator|=
name|read_eflags
argument_list|()
expr_stmt|;
name|disable_intr
argument_list|()
expr_stmt|;
name|ccr2
operator|=
name|read_cyrix_reg
argument_list|(
name|CCR2
argument_list|)
expr_stmt|;
name|write_cyrix_reg
argument_list|(
name|CCR2
argument_list|,
name|ccr2
operator|^
name|CCR2_LOCK_NW
argument_list|)
expr_stmt|;
name|read_cyrix_reg
argument_list|(
name|CCR2
argument_list|)
expr_stmt|;
if|if
condition|(
name|read_cyrix_reg
argument_list|(
name|CCR2
argument_list|)
operator|!=
name|ccr2
condition|)
name|ccr2_test
operator|=
literal|1
expr_stmt|;
name|write_cyrix_reg
argument_list|(
name|CCR2
argument_list|,
name|ccr2
argument_list|)
expr_stmt|;
name|ccr3
operator|=
name|read_cyrix_reg
argument_list|(
name|CCR3
argument_list|)
expr_stmt|;
name|write_cyrix_reg
argument_list|(
name|CCR3
argument_list|,
name|ccr3
operator|^
name|CCR3_MAPEN3
argument_list|)
expr_stmt|;
name|read_cyrix_reg
argument_list|(
name|CCR3
argument_list|)
expr_stmt|;
if|if
condition|(
name|read_cyrix_reg
argument_list|(
name|CCR3
argument_list|)
operator|!=
name|ccr3
condition|)
name|dir_test
operator|=
literal|1
expr_stmt|;
comment|/* CPU supports DIRs. */
name|write_cyrix_reg
argument_list|(
name|CCR3
argument_list|,
name|ccr3
argument_list|)
expr_stmt|;
if|if
condition|(
name|dir_test
condition|)
block|{
comment|/* Device ID registers are available. */
name|cyrix_did
operator|=
name|read_cyrix_reg
argument_list|(
name|DIR1
argument_list|)
operator|<<
literal|8
expr_stmt|;
name|cyrix_did
operator|+=
name|read_cyrix_reg
argument_list|(
name|DIR0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ccr2_test
condition|)
name|cyrix_did
operator|=
literal|0x0010
expr_stmt|;
comment|/* 486S A-step */
else|else
name|cyrix_did
operator|=
literal|0x00ff
expr_stmt|;
comment|/* Old 486SLC/DLC and TI486SXLC/SXL */
name|write_eflags
argument_list|(
name|eflags
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Final stage of CPU identification. -- Should I check TI?  */
end_comment

begin_function
name|void
name|finishidentcpu
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|cpu_vendor
argument_list|,
literal|"CyrixInstead"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|cpu
operator|==
name|CPU_486
condition|)
block|{
comment|/* 			 * These conditions are equivalent to: 			 *     - CPU does not support cpuid instruction. 			 *     - Cyrix/IBM CPU is detected. 			 */
if|if
condition|(
name|identblue
argument_list|()
condition|)
block|{
name|strcpy
argument_list|(
name|cpu_vendor
argument_list|,
literal|"IBM"
argument_list|)
expr_stmt|;
name|cpu
operator|=
name|CPU_BLUE
expr_stmt|;
return|return;
block|}
block|}
switch|switch
condition|(
name|cpu_id
operator|&
literal|0xf00
condition|)
block|{
case|case
literal|0x600
case|:
comment|/* 			 * Cyrix's datasheet does not describe DIRs. 			 * Therefor, I assume it does not have them 			 * and use the result of the cpuid instruction. 			 */
name|identifycyrix
argument_list|()
expr_stmt|;
name|cpu
operator|=
name|CPU_M2
expr_stmt|;
break|break;
default|default:
name|identifycyrix
argument_list|()
expr_stmt|;
comment|/* 			 * This routine contains a trick. 			 * Don't check (cpu_id& 0x00f0) == 0x50 to detect M2, now. 			 */
switch|switch
condition|(
name|cyrix_did
operator|&
literal|0x00f0
condition|)
block|{
case|case
literal|0x00
case|:
case|case
literal|0xf0
case|:
name|cpu
operator|=
name|CPU_486DLC
expr_stmt|;
break|break;
case|case
literal|0x10
case|:
name|cpu
operator|=
name|CPU_CY486DX
expr_stmt|;
break|break;
case|case
literal|0x20
case|:
if|if
condition|(
operator|(
name|cyrix_did
operator|&
literal|0x000f
operator|)
operator|<
literal|8
condition|)
name|cpu
operator|=
name|CPU_M1
expr_stmt|;
else|else
name|cpu
operator|=
name|CPU_M1SC
expr_stmt|;
break|break;
case|case
literal|0x30
case|:
name|cpu
operator|=
name|CPU_M1
expr_stmt|;
break|break;
case|case
literal|0x40
case|:
comment|/* MediaGX CPU */
name|cpu
operator|=
name|CPU_M1SC
expr_stmt|;
break|break;
default|default:
comment|/* M2 and later CPUs are treated as M2. */
name|cpu
operator|=
name|CPU_M2
expr_stmt|;
break|break;
block|}
block|}
block|}
block|}
end_function

begin_comment
comment|/*  * This routine is called specifically to set up cpu_class before   * startrtclock() uses it.  Probably this should be rearranged so that  * startrtclock() doesn't need to run until after identifycpu() has been  * called.  Another alternative formulation would be for this routine  * to do all the identification work, and make identifycpu() into a  * printing-only routine.  */
end_comment

begin_function
name|void
name|earlysetcpuclass
parameter_list|(
name|void
parameter_list|)
block|{
name|cpu_class
operator|=
name|i386_cpus
index|[
name|cpu
index|]
operator|.
name|cpu_class
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_AMD_assoc
parameter_list|(
name|int
name|i
parameter_list|)
block|{
if|if
condition|(
name|i
operator|==
literal|255
condition|)
name|printf
argument_list|(
literal|", fully associative\n"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|", %d-way associative\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_AMD_info
parameter_list|(
name|void
parameter_list|)
block|{
name|u_long
name|regs
index|[
literal|4
index|]
decl_stmt|;
name|do_cpuid
argument_list|(
literal|0x80000000
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
name|regs
index|[
literal|0
index|]
operator|>=
literal|0x80000005
condition|)
block|{
name|do_cpuid
argument_list|(
literal|0x80000005
argument_list|,
name|regs
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Data TLB: %d entries"
argument_list|,
operator|(
name|regs
index|[
literal|1
index|]
operator|>>
literal|16
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|print_AMD_assoc
argument_list|(
name|regs
index|[
literal|1
index|]
operator|>>
literal|24
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Instruction TLB: %d entries"
argument_list|,
name|regs
index|[
literal|1
index|]
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|print_AMD_assoc
argument_list|(
operator|(
name|regs
index|[
literal|1
index|]
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"L1 data cache: %d kbytes"
argument_list|,
name|regs
index|[
literal|2
index|]
operator|>>
literal|24
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|", %d bytes/line"
argument_list|,
name|regs
index|[
literal|2
index|]
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|", %d lines/tag"
argument_list|,
operator|(
name|regs
index|[
literal|2
index|]
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|print_AMD_assoc
argument_list|(
operator|(
name|regs
index|[
literal|2
index|]
operator|>>
literal|16
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"L1 instruction cache: %d kbytes"
argument_list|,
name|regs
index|[
literal|3
index|]
operator|>>
literal|24
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|", %d bytes/line"
argument_list|,
name|regs
index|[
literal|3
index|]
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|", %d lines/tag"
argument_list|,
operator|(
name|regs
index|[
literal|3
index|]
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|print_AMD_assoc
argument_list|(
operator|(
name|regs
index|[
literal|3
index|]
operator|>>
literal|16
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
block|}
block|}
end_function

end_unit


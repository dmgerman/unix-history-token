begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1992 Terrence R. Lambert.  * Copyright (c) 1982, 1987, 1990 The Regents of the University of California.  * Copyright (c) 1997 KATO Takenori.  * Copyright (c) 2001 Tamotsu Hattori.  * Copyright (c) 2001 Mitsuru IWASAKI.  * All rights reserved.  *  * This code is derived from software contributed to Berkeley by  * William Jolitz.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. All advertising materials mentioning features or use of this software  *    must display the following acknowledgement:  *	This product includes software developed by the University of  *	California, Berkeley and its contributors.  * 4. Neither the name of the University nor the names of its contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  *	from: Id: machdep.c,v 1.193 1996/06/18 01:22:04 bde Exp  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|"opt_cpu.h"
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<machine/asmacros.h>
end_include

begin_include
include|#
directive|include
file|<machine/clock.h>
end_include

begin_include
include|#
directive|include
file|<machine/cputypes.h>
end_include

begin_include
include|#
directive|include
file|<machine/segments.h>
end_include

begin_include
include|#
directive|include
file|<machine/specialreg.h>
end_include

begin_include
include|#
directive|include
file|<machine/md_var.h>
end_include

begin_include
include|#
directive|include
file|<i386/isa/intr_machdep.h>
end_include

begin_define
define|#
directive|define
name|IDENTBLUE_CYRIX486
value|0
end_define

begin_define
define|#
directive|define
name|IDENTBLUE_IBMCPU
value|1
end_define

begin_define
define|#
directive|define
name|IDENTBLUE_CYRIXM2
value|2
end_define

begin_comment
comment|/* XXX - should be in header file: */
end_comment

begin_function_decl
name|void
name|printcpuinfo
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|finishidentcpu
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|earlysetcpuclass
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_if
if|#
directive|if
name|defined
argument_list|(
name|I586_CPU
argument_list|)
operator|&&
name|defined
argument_list|(
name|CPU_WT_ALLOC
argument_list|)
end_if

begin_function_decl
name|void
name|enable_K5_wt_alloc
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|enable_K6_wt_alloc
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|enable_K6_2_wt_alloc
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
name|void
name|panicifcpuunsupported
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|identifycyrix
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|print_AMD_features
parameter_list|(
name|u_int
modifier|*
name|regs
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|print_AMD_info
parameter_list|(
name|u_int
name|amd_maxregs
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|print_AMD_assoc
parameter_list|(
name|int
name|i
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|print_transmeta_info
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|setup_tmx86_longrun
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|do_cpuid
parameter_list|(
name|u_int
name|ax
parameter_list|,
name|u_int
modifier|*
name|p
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
name|u_int
name|cyrix_did
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Device ID of Cyrix CPU */
end_comment

begin_decl_stmt
name|int
name|cpu_class
init|=
name|CPUCLASS_386
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* least common denominator */
end_comment

begin_decl_stmt
name|char
name|machine
index|[]
init|=
literal|"i386"
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|SYSCTL_STRING
argument_list|(
name|_hw
argument_list|,
name|HW_MACHINE
argument_list|,
name|machine
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|machine
argument_list|,
literal|0
argument_list|,
literal|"Machine class"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|char
name|cpu_model
index|[
literal|128
index|]
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|SYSCTL_STRING
argument_list|(
name|_hw
argument_list|,
name|HW_MODEL
argument_list|,
name|model
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|cpu_model
argument_list|,
literal|0
argument_list|,
literal|"Machine model"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|struct
name|cpu_nameclass
name|i386_cpus
index|[]
init|=
block|{
block|{
literal|"Intel 80286"
block|,
name|CPUCLASS_286
block|}
block|,
comment|/* CPU_286   */
block|{
literal|"i386SX"
block|,
name|CPUCLASS_386
block|}
block|,
comment|/* CPU_386SX */
block|{
literal|"i386DX"
block|,
name|CPUCLASS_386
block|}
block|,
comment|/* CPU_386   */
block|{
literal|"i486SX"
block|,
name|CPUCLASS_486
block|}
block|,
comment|/* CPU_486SX */
block|{
literal|"i486DX"
block|,
name|CPUCLASS_486
block|}
block|,
comment|/* CPU_486   */
block|{
literal|"Pentium"
block|,
name|CPUCLASS_586
block|}
block|,
comment|/* CPU_586   */
block|{
literal|"Cyrix 486"
block|,
name|CPUCLASS_486
block|}
block|,
comment|/* CPU_486DLC */
block|{
literal|"Pentium Pro"
block|,
name|CPUCLASS_686
block|}
block|,
comment|/* CPU_686 */
block|{
literal|"Cyrix 5x86"
block|,
name|CPUCLASS_486
block|}
block|,
comment|/* CPU_M1SC */
block|{
literal|"Cyrix 6x86"
block|,
name|CPUCLASS_486
block|}
block|,
comment|/* CPU_M1 */
block|{
literal|"Blue Lightning"
block|,
name|CPUCLASS_486
block|}
block|,
comment|/* CPU_BLUE */
block|{
literal|"Cyrix 6x86MX"
block|,
name|CPUCLASS_686
block|}
block|,
comment|/* CPU_M2 */
block|{
literal|"NexGen 586"
block|,
name|CPUCLASS_386
block|}
block|,
comment|/* CPU_NX586 (XXX) */
block|{
literal|"Cyrix 486S/DX"
block|,
name|CPUCLASS_486
block|}
block|,
comment|/* CPU_CY486DX */
block|{
literal|"Pentium II"
block|,
name|CPUCLASS_686
block|}
block|,
comment|/* CPU_PII */
block|{
literal|"Pentium III"
block|,
name|CPUCLASS_686
block|}
block|,
comment|/* CPU_PIII */
block|{
literal|"Pentium 4"
block|,
name|CPUCLASS_686
block|}
block|,
comment|/* CPU_P4 */
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|do_cpuid
parameter_list|(
name|u_int
name|ax
parameter_list|,
name|u_int
modifier|*
name|p
parameter_list|)
block|{
asm|__asm __volatile(
literal|"cpuid"
operator|:
literal|"=a"
operator|(
name|p
index|[
literal|0
index|]
operator|)
operator|,
literal|"=b"
operator|(
name|p
index|[
literal|1
index|]
operator|)
operator|,
literal|"=c"
operator|(
name|p
index|[
literal|2
index|]
operator|)
operator|,
literal|"=d"
operator|(
name|p
index|[
literal|3
index|]
operator|)
operator|:
literal|"0"
operator|(
name|ax
operator|)
block|)
function|;
end_function

begin_if
unit|}
if|#
directive|if
name|defined
argument_list|(
name|I586_CPU
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|NO_F00F_HACK
argument_list|)
end_if

begin_expr_stmt
unit|int
name|has_f00f_bug
operator|=
literal|0
expr_stmt|;
end_expr_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|void
name|printcpuinfo
parameter_list|(
name|void
parameter_list|)
block|{
name|u_int
name|regs
index|[
literal|4
index|]
decl_stmt|,
name|nreg
init|=
literal|0
decl_stmt|;
name|cpu_class
operator|=
name|i386_cpus
index|[
name|cpu
index|]
operator|.
name|cpu_class
expr_stmt|;
name|printf
argument_list|(
literal|"CPU: "
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|cpu_model
argument_list|,
name|i386_cpus
index|[
name|cpu
index|]
operator|.
name|cpu_name
argument_list|,
sizeof|sizeof
name|cpu_model
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|I486_CPU
argument_list|)
operator|||
name|defined
argument_list|(
name|I586_CPU
argument_list|)
operator|||
name|defined
argument_list|(
name|I686_CPU
argument_list|)
if|if
condition|(
name|strcmp
argument_list|(
name|cpu_vendor
argument_list|,
literal|"GenuineIntel"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|cpu_id
operator|&
literal|0xf00
operator|)
operator|>
literal|0x300
condition|)
block|{
name|cpu_model
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
switch|switch
condition|(
name|cpu_id
operator|&
literal|0x3000
condition|)
block|{
case|case
literal|0x1000
case|:
name|strcpy
argument_list|(
name|cpu_model
argument_list|,
literal|"Overdrive "
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x2000
case|:
name|strcpy
argument_list|(
name|cpu_model
argument_list|,
literal|"Dual "
argument_list|)
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
name|cpu_id
operator|&
literal|0xf00
condition|)
block|{
case|case
literal|0x400
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"i486 "
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x500
case|:
comment|/* Check the particular flavor of 586 */
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"Pentium"
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cpu_id
operator|&
literal|0xf0
condition|)
block|{
case|case
literal|0x00
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|" A-step"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x10
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"/P5"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x20
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"/P54C"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x30
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"/P54T Overdrive"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x40
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"/P55C"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x70
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"/P54C"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x80
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"/P55C (quarter-micron)"
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|/* nothing */
break|break;
block|}
if|#
directive|if
name|defined
argument_list|(
name|I586_CPU
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|NO_F00F_HACK
argument_list|)
comment|/* 				 * XXX - If/when Intel fixes the bug, this 				 * should also check the version of the 				 * CPU, not just that it's a Pentium. 				 */
name|has_f00f_bug
operator|=
literal|1
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
literal|0x600
case|:
comment|/* Check the particular flavor of 686 */
switch|switch
condition|(
name|cpu_id
operator|&
literal|0xf0
condition|)
block|{
case|case
literal|0x00
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"Pentium Pro A-step"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x10
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"Pentium Pro"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x30
case|:
case|case
literal|0x50
case|:
case|case
literal|0x60
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"Pentium II/Pentium II Xeon/Celeron"
argument_list|)
expr_stmt|;
name|cpu
operator|=
name|CPU_PII
expr_stmt|;
break|break;
case|case
literal|0x70
case|:
case|case
literal|0x80
case|:
case|case
literal|0xa0
case|:
case|case
literal|0xb0
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"Pentium III/Pentium III Xeon/Celeron"
argument_list|)
expr_stmt|;
name|cpu
operator|=
name|CPU_PIII
expr_stmt|;
break|break;
default|default:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"Unknown 80686"
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|0xf00
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"Pentium 4"
argument_list|)
expr_stmt|;
name|cpu
operator|=
name|CPU_P4
expr_stmt|;
break|break;
default|default:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"unknown"
argument_list|)
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
name|cpu_id
operator|&
literal|0xff0
condition|)
block|{
case|case
literal|0x400
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"DX"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x410
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"DX"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x420
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"SX"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x430
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"DX2"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x440
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"SL"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x450
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"SX2"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x470
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"DX2 Write-Back Enhanced"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x480
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"DX4"
argument_list|)
expr_stmt|;
break|break;
break|break;
block|}
block|}
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|cpu_vendor
argument_list|,
literal|"AuthenticAMD"
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* 		 * Values taken from AMD Processor Recognition 		 * http://www.amd.com/K6/k6docs/pdf/20734g.pdf 		 * (also describes ``Features'' encodings. 		 */
name|strcpy
argument_list|(
name|cpu_model
argument_list|,
literal|"AMD "
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cpu_id
operator|&
literal|0xFF0
condition|)
block|{
case|case
literal|0x410
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"Standard Am486DX"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x430
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"Am486DX2/4 Write-Through"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x470
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"Enhanced Am486DX4 Write-Back"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x480
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"Enhanced Am486DX4 Write-Through"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x490
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"Enhanced Am486DX4 Write-Back"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x4E0
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"Am5x86 Write-Through"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x4F0
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"Am5x86 Write-Back"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x500
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"K5 model 0"
argument_list|)
expr_stmt|;
name|tsc_is_broken
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|0x510
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"K5 model 1"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x520
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"K5 PR166 (model 2)"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x530
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"K5 PR200 (model 3)"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x560
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"K6"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x570
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"K6 266 (model 1)"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x580
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"K6-2"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x590
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"K6-III"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"Unknown"
argument_list|)
expr_stmt|;
break|break;
block|}
if|#
directive|if
name|defined
argument_list|(
name|I586_CPU
argument_list|)
operator|&&
name|defined
argument_list|(
name|CPU_WT_ALLOC
argument_list|)
if|if
condition|(
operator|(
name|cpu_id
operator|&
literal|0xf00
operator|)
operator|==
literal|0x500
condition|)
block|{
if|if
condition|(
operator|(
operator|(
name|cpu_id
operator|&
literal|0x0f0
operator|)
operator|>
literal|0
operator|)
operator|&&
operator|(
operator|(
name|cpu_id
operator|&
literal|0x0f0
operator|)
operator|<
literal|0x60
operator|)
operator|&&
operator|(
operator|(
name|cpu_id
operator|&
literal|0x00f
operator|)
operator|>
literal|3
operator|)
condition|)
name|enable_K5_wt_alloc
argument_list|()
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
operator|(
name|cpu_id
operator|&
literal|0x0f0
operator|)
operator|>
literal|0x80
operator|)
operator|||
operator|(
operator|(
operator|(
name|cpu_id
operator|&
literal|0x0f0
operator|)
operator|==
literal|0x80
operator|)
operator|&&
operator|(
name|cpu_id
operator|&
literal|0x00f
operator|)
operator|>
literal|0x07
operator|)
condition|)
name|enable_K6_2_wt_alloc
argument_list|()
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|cpu_id
operator|&
literal|0x0f0
operator|)
operator|>
literal|0x50
condition|)
name|enable_K6_wt_alloc
argument_list|()
expr_stmt|;
block|}
endif|#
directive|endif
name|do_cpuid
argument_list|(
literal|0x80000000
argument_list|,
name|regs
argument_list|)
expr_stmt|;
name|nreg
operator|=
name|regs
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|nreg
operator|>=
literal|0x80000004
condition|)
block|{
name|do_cpuid
argument_list|(
literal|0x80000002
argument_list|,
name|regs
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|cpu_model
argument_list|,
name|regs
argument_list|,
sizeof|sizeof
name|regs
argument_list|)
expr_stmt|;
name|do_cpuid
argument_list|(
literal|0x80000003
argument_list|,
name|regs
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|cpu_model
operator|+
literal|16
argument_list|,
name|regs
argument_list|,
sizeof|sizeof
name|regs
argument_list|)
expr_stmt|;
name|do_cpuid
argument_list|(
literal|0x80000004
argument_list|,
name|regs
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|cpu_model
operator|+
literal|32
argument_list|,
name|regs
argument_list|,
sizeof|sizeof
name|regs
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|cpu_vendor
argument_list|,
literal|"CyrixInstead"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|strcpy
argument_list|(
name|cpu_model
argument_list|,
literal|"Cyrix "
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cpu_id
operator|&
literal|0xff0
condition|)
block|{
case|case
literal|0x440
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"MediaGX"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x520
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"6x86"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x540
case|:
name|cpu_class
operator|=
name|CPUCLASS_586
expr_stmt|;
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"GXm"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x600
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"6x86MX"
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|/* 			 * Even though CPU supports the cpuid 			 * instruction, it can be disabled. 			 * Therefore, this routine supports all Cyrix 			 * CPUs. 			 */
switch|switch
condition|(
name|cyrix_did
operator|&
literal|0xf0
condition|)
block|{
case|case
literal|0x00
case|:
switch|switch
condition|(
name|cyrix_did
operator|&
literal|0x0f
condition|)
block|{
case|case
literal|0x00
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486SLC"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x01
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486DLC"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x02
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486SLC2"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x03
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486DLC2"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x04
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486SRx"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x05
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486DRx"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x06
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486SRx2"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x07
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486DRx2"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x08
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486SRu"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x09
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486DRu"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x0a
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486SRu2"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x0b
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486DRu2"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"Unknown"
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|0x10
case|:
switch|switch
condition|(
name|cyrix_did
operator|&
literal|0x0f
condition|)
block|{
case|case
literal|0x00
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486S"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x01
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486S2"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x02
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486Se"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x03
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486S2e"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x0a
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486DX"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x0b
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486DX2"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x0f
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486DX4"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"Unknown"
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|0x20
case|:
if|if
condition|(
operator|(
name|cyrix_did
operator|&
literal|0x0f
operator|)
operator|<
literal|8
condition|)
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"6x86"
argument_list|)
expr_stmt|;
comment|/* Where did you get it? */
else|else
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"5x86"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x30
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"6x86"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x40
case|:
if|if
condition|(
operator|(
name|cyrix_did
operator|&
literal|0xf000
operator|)
operator|==
literal|0x3000
condition|)
block|{
name|cpu_class
operator|=
name|CPUCLASS_586
expr_stmt|;
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"GXm"
argument_list|)
expr_stmt|;
block|}
else|else
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"MediaGX"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x50
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"6x86MX"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xf0
case|:
switch|switch
condition|(
name|cyrix_did
operator|&
literal|0x0f
condition|)
block|{
case|case
literal|0x0d
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"Overdrive CPU"
argument_list|)
expr_stmt|;
case|case
literal|0x0e
case|:
name|strcpy
argument_list|(
name|cpu_model
argument_list|,
literal|"Texas Instruments 486SXL"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x0f
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"486SLC/DLC"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"Unknown"
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
default|default:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"Unknown"
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
block|}
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|cpu_vendor
argument_list|,
literal|"RiseRiseRise"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|strcpy
argument_list|(
name|cpu_model
argument_list|,
literal|"Rise "
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cpu_id
operator|&
literal|0xff0
condition|)
block|{
case|case
literal|0x500
case|:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"mP6"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|strcat
argument_list|(
name|cpu_model
argument_list|,
literal|"Unknown"
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|cpu_vendor
argument_list|,
literal|"CentaurHauls"
argument_list|)
operator|==
literal|0
condition|)
block|{
switch|switch
condition|(
name|cpu_id
operator|&
literal|0xff0
condition|)
block|{
case|case
literal|0x540
case|:
name|strcpy
argument_list|(
name|cpu_model
argument_list|,
literal|"IDT WinChip C6"
argument_list|)
expr_stmt|;
name|tsc_is_broken
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|0x580
case|:
name|strcpy
argument_list|(
name|cpu_model
argument_list|,
literal|"IDT WinChip 2"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x670
case|:
name|strcpy
argument_list|(
name|cpu_model
argument_list|,
literal|"VIA C3 Samuel 2"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|strcpy
argument_list|(
name|cpu_model
argument_list|,
literal|"VIA/IDT Unknown"
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|cpu_vendor
argument_list|,
literal|"IBM"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|strcpy
argument_list|(
name|cpu_model
argument_list|,
literal|"Blue Lightning CPU"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|cpu_vendor
argument_list|,
literal|"GenuineTMx86"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|cpu_vendor
argument_list|,
literal|"TransmetaCPU"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|do_cpuid
argument_list|(
literal|0x80000000
argument_list|,
name|regs
argument_list|)
expr_stmt|;
name|nreg
operator|=
name|regs
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|nreg
operator|>=
literal|0x80000004
condition|)
block|{
name|do_cpuid
argument_list|(
literal|0x80000002
argument_list|,
name|regs
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|cpu_model
argument_list|,
name|regs
argument_list|,
sizeof|sizeof
name|regs
argument_list|)
expr_stmt|;
name|do_cpuid
argument_list|(
literal|0x80000003
argument_list|,
name|regs
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|cpu_model
operator|+
literal|16
argument_list|,
name|regs
argument_list|,
sizeof|sizeof
name|regs
argument_list|)
expr_stmt|;
name|do_cpuid
argument_list|(
literal|0x80000004
argument_list|,
name|regs
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|cpu_model
operator|+
literal|32
argument_list|,
name|regs
argument_list|,
sizeof|sizeof
name|regs
argument_list|)
expr_stmt|;
block|}
name|cpu_model
index|[
literal|64
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
endif|#
directive|endif
name|printf
argument_list|(
literal|"%s ("
argument_list|,
name|cpu_model
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cpu_class
condition|)
block|{
case|case
name|CPUCLASS_286
case|:
name|printf
argument_list|(
literal|"286"
argument_list|)
expr_stmt|;
break|break;
if|#
directive|if
name|defined
argument_list|(
name|I386_CPU
argument_list|)
case|case
name|CPUCLASS_386
case|:
name|printf
argument_list|(
literal|"386"
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|I486_CPU
argument_list|)
case|case
name|CPUCLASS_486
case|:
name|printf
argument_list|(
literal|"486"
argument_list|)
expr_stmt|;
name|bzero
operator|=
name|i486_bzero
expr_stmt|;
break|break;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|I586_CPU
argument_list|)
case|case
name|CPUCLASS_586
case|:
name|printf
argument_list|(
literal|"%d.%02d-MHz "
argument_list|,
operator|(
name|tsc_freq
operator|+
literal|4999
operator|)
operator|/
literal|1000000
argument_list|,
operator|(
operator|(
name|tsc_freq
operator|+
literal|4999
operator|)
operator|/
literal|10000
operator|)
operator|%
literal|100
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"586"
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|I686_CPU
argument_list|)
case|case
name|CPUCLASS_686
case|:
name|printf
argument_list|(
literal|"%d.%02d-MHz "
argument_list|,
operator|(
name|tsc_freq
operator|+
literal|4999
operator|)
operator|/
literal|1000000
argument_list|,
operator|(
operator|(
name|tsc_freq
operator|+
literal|4999
operator|)
operator|/
literal|10000
operator|)
operator|%
literal|100
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"686"
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
name|printf
argument_list|(
literal|"unknown"
argument_list|)
expr_stmt|;
comment|/* will panic below... */
block|}
name|printf
argument_list|(
literal|"-class CPU)\n"
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|I486_CPU
argument_list|)
operator|||
name|defined
argument_list|(
name|I586_CPU
argument_list|)
operator|||
name|defined
argument_list|(
name|I686_CPU
argument_list|)
if|if
condition|(
operator|*
name|cpu_vendor
condition|)
name|printf
argument_list|(
literal|"  Origin = \"%s\""
argument_list|,
name|cpu_vendor
argument_list|)
expr_stmt|;
if|if
condition|(
name|cpu_id
condition|)
name|printf
argument_list|(
literal|"  Id = 0x%x"
argument_list|,
name|cpu_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|cpu_vendor
argument_list|,
literal|"GenuineIntel"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|cpu_vendor
argument_list|,
literal|"AuthenticAMD"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|cpu_vendor
argument_list|,
literal|"RiseRiseRise"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|cpu_vendor
argument_list|,
literal|"CentaurHauls"
argument_list|)
operator|==
literal|0
operator|||
operator|(
operator|(
name|strcmp
argument_list|(
name|cpu_vendor
argument_list|,
literal|"CyrixInstead"
argument_list|)
operator|==
literal|0
operator|)
operator|&&
operator|(
operator|(
name|cpu_id
operator|&
literal|0xf00
operator|)
operator|>
literal|0x500
operator|)
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"  Stepping = %u"
argument_list|,
name|cpu_id
operator|&
literal|0xf
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|cpu_vendor
argument_list|,
literal|"CyrixInstead"
argument_list|)
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"  DIR=0x%04x"
argument_list|,
name|cyrix_did
argument_list|)
expr_stmt|;
if|if
condition|(
name|cpu_high
operator|>
literal|0
condition|)
block|{
comment|/* 			 * Here we should probably set up flags indicating 			 * whether or not various features are available. 			 * The interesting ones are probably VME, PSE, PAE, 			 * and PGE.  The code already assumes without bothering 			 * to check that all CPUs>= Pentium have a TSC and 			 * MSRs. 			 */
name|printf
argument_list|(
literal|"\n  Features=0x%b"
argument_list|,
name|cpu_feature
argument_list|,
literal|"\020"
literal|"\001FPU"
comment|/* Integral FPU */
literal|"\002VME"
comment|/* Extended VM86 mode support */
literal|"\003DE"
comment|/* Debugging Extensions (CR4.DE) */
literal|"\004PSE"
comment|/* 4MByte page tables */
literal|"\005TSC"
comment|/* Timestamp counter */
literal|"\006MSR"
comment|/* Machine specific registers */
literal|"\007PAE"
comment|/* Physical address extension */
literal|"\010MCE"
comment|/* Machine Check support */
literal|"\011CX8"
comment|/* CMPEXCH8 instruction */
literal|"\012APIC"
comment|/* SMP local APIC */
literal|"\013oldMTRR"
literal|"\014SEP"
comment|/* Fast System Call */
literal|"\015MTRR"
comment|/* Memory Type Range Registers */
literal|"\016PGE"
comment|/* PG_G (global bit) support */
literal|"\017MCA"
comment|/* Machine Check Architecture */
literal|"\020CMOV"
comment|/* CMOV instruction */
literal|"\021PAT"
comment|/* Page attributes table */
literal|"\022PSE36"
comment|/* 36 bit address space support */
literal|"\023PN"
comment|/* Processor Serial number */
literal|"\024CLFLUSH"
comment|/* Has the CLFLUSH instruction */
literal|"\025<b20>"
literal|"\026DTS"
comment|/* Debug Trace Store */
literal|"\027ACPI"
comment|/* ACPI support */
literal|"\030MMX"
comment|/* MMX instructions */
literal|"\031FXSR"
comment|/* FXSAVE/FXRSTOR */
literal|"\032SSE"
comment|/* Streaming SIMD Extensions */
literal|"\033SSE2"
comment|/* Streaming SIMD Extensions #2 */
literal|"\034SS"
comment|/* Self snoop */
literal|"\035<b28>"
literal|"\036ACC"
comment|/* Auto Clock Correction (TCC/ACPI) */
literal|"\037<b30>"
literal|"\040<b31>"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|cpu_vendor
argument_list|,
literal|"AuthenticAMD"
argument_list|)
operator|==
literal|0
operator|&&
name|nreg
operator|>=
literal|0x80000001
condition|)
name|print_AMD_features
argument_list|(
name|regs
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|cpu_vendor
argument_list|,
literal|"CyrixInstead"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"  DIR=0x%04x"
argument_list|,
name|cyrix_did
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  Stepping=%u"
argument_list|,
operator|(
name|cyrix_did
operator|&
literal|0xf000
operator|)
operator|>>
literal|12
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  Revision=%u"
argument_list|,
operator|(
name|cyrix_did
operator|&
literal|0x0f00
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|CYRIX_CACHE_REALLY_WORKS
if|if
condition|(
name|cpu
operator|==
name|CPU_M1
operator|&&
operator|(
name|cyrix_did
operator|&
literal|0xff00
operator|)
operator|<
literal|0x1700
condition|)
name|printf
argument_list|(
literal|"\n  CPU cache: write-through mode"
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
comment|/* Avoid ugly blank lines: only print newline when we have to. */
if|if
condition|(
operator|*
name|cpu_vendor
operator|||
name|cpu_id
condition|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|strcmp
argument_list|(
name|cpu_vendor
argument_list|,
literal|"GenuineTMx86"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|cpu_vendor
argument_list|,
literal|"TransmetaCPU"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|setup_tmx86_longrun
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|bootverbose
condition|)
return|return;
if|if
condition|(
name|strcmp
argument_list|(
name|cpu_vendor
argument_list|,
literal|"AuthenticAMD"
argument_list|)
operator|==
literal|0
condition|)
name|print_AMD_info
argument_list|(
name|nreg
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|cpu_vendor
argument_list|,
literal|"GenuineTMx86"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|cpu_vendor
argument_list|,
literal|"TransmetaCPU"
argument_list|)
operator|==
literal|0
condition|)
name|print_transmeta_info
argument_list|()
expr_stmt|;
ifdef|#
directive|ifdef
name|I686_CPU
comment|/* 	 * XXX - Do PPro CPUID level=2 stuff here? 	 * 	 * No, but maybe in a print_Intel_info() function called from here. 	 */
endif|#
directive|endif
block|}
end_function

begin_function
name|void
name|panicifcpuunsupported
parameter_list|(
name|void
parameter_list|)
block|{
comment|/* 	 * Now that we have told the user what they have, 	 * let them know if that machine type isn't configured. 	 */
switch|switch
condition|(
name|cpu_class
condition|)
block|{
case|case
name|CPUCLASS_286
case|:
comment|/* a 286 should not make it this far, anyway */
if|#
directive|if
operator|!
name|defined
argument_list|(
name|I386_CPU
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|I486_CPU
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|I586_CPU
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|I686_CPU
argument_list|)
error|#
directive|error
error|This kernel is not configured for one of the supported CPUs
endif|#
directive|endif
if|#
directive|if
operator|!
name|defined
argument_list|(
name|I386_CPU
argument_list|)
case|case
name|CPUCLASS_386
case|:
endif|#
directive|endif
if|#
directive|if
operator|!
name|defined
argument_list|(
name|I486_CPU
argument_list|)
case|case
name|CPUCLASS_486
case|:
endif|#
directive|endif
if|#
directive|if
operator|!
name|defined
argument_list|(
name|I586_CPU
argument_list|)
case|case
name|CPUCLASS_586
case|:
endif|#
directive|endif
if|#
directive|if
operator|!
name|defined
argument_list|(
name|I686_CPU
argument_list|)
case|case
name|CPUCLASS_686
case|:
endif|#
directive|endif
name|panic
argument_list|(
literal|"CPU class not configured"
argument_list|)
expr_stmt|;
default|default:
break|break;
block|}
block|}
end_function

begin_decl_stmt
specifier|static
specifier|volatile
name|u_int
name|trap_by_rdmsr
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Special exception 6 handler.  * The rdmsr instruction generates invalid opcodes fault on 486-class  * Cyrix CPU.  Stacked eip register points the rdmsr instruction in the  * function identblue() when this handler is called.  Stacked eip should  * be advanced.  */
end_comment

begin_decl_stmt
name|inthand_t
name|bluetrap6
decl_stmt|;
end_decl_stmt

begin_asm
asm|__asm
end_asm

begin_expr_stmt
operator|(
literal|" 	.text 	.p2align 2,0x90 	.type	"
name|__XSTRING
argument_list|(
name|CNAME
argument_list|(
name|bluetrap6
argument_list|)
argument_list|)
literal|",@function "
name|__XSTRING
argument_list|(
name|CNAME
argument_list|(
name|bluetrap6
argument_list|)
argument_list|)
literal|": 	ss 	movl	$0xa8c1d,"
name|__XSTRING
argument_list|(
name|CNAME
argument_list|(
name|trap_by_rdmsr
argument_list|)
argument_list|)
literal|" 	addl	$2, (%esp)		  # I know rdmsr is a 2-bytes instruction. 	iret "
operator|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*  * Special exception 13 handler.  * Accessing non-existent MSR generates general protection fault.  */
end_comment

begin_decl_stmt
name|inthand_t
name|bluetrap13
decl_stmt|;
end_decl_stmt

begin_asm
asm|__asm
end_asm

begin_expr_stmt
operator|(
literal|" 	.text 	.p2align 2,0x90 	.type "
name|__XSTRING
argument_list|(
name|CNAME
argument_list|(
name|bluetrap13
argument_list|)
argument_list|)
literal|",@function "
name|__XSTRING
argument_list|(
name|CNAME
argument_list|(
name|bluetrap13
argument_list|)
argument_list|)
literal|": 	ss 	movl	$0xa89c4,"
name|__XSTRING
argument_list|(
name|CNAME
argument_list|(
name|trap_by_rdmsr
argument_list|)
argument_list|)
literal|" 	popl	%eax				# discard errorcode. 	addl	$2, (%esp)			# I know rdmsr is a 2-bytes instruction. 	iret "
operator|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*  * Distinguish IBM Blue Lightning CPU from Cyrix CPUs that does not  * support cpuid instruction.  This function should be called after  * loading interrupt descriptor table register.  *  * I don't like this method that handles fault, but I couldn't get  * information for any other methods.  Does blue giant know?  */
end_comment

begin_function
specifier|static
name|int
name|identblue
parameter_list|(
name|void
parameter_list|)
block|{
name|trap_by_rdmsr
operator|=
literal|0
expr_stmt|;
comment|/* 	 * Cyrix 486-class CPU does not support rdmsr instruction. 	 * The rdmsr instruction generates invalid opcode fault, and exception 	 * will be trapped by bluetrap6() on Cyrix 486-class CPU.  The 	 * bluetrap6() set the magic number to trap_by_rdmsr. 	 */
name|setidt
argument_list|(
literal|6
argument_list|,
name|bluetrap6
argument_list|,
name|SDT_SYS386TGT
argument_list|,
name|SEL_KPL
argument_list|,
name|GSEL
argument_list|(
name|GCODE_SEL
argument_list|,
name|SEL_KPL
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Certain BIOS disables cpuid instructnion of Cyrix 6x86MX CPU. 	 * In this case, rdmsr generates general protection fault, and 	 * exception will be trapped by bluetrap13(). 	 */
name|setidt
argument_list|(
literal|13
argument_list|,
name|bluetrap13
argument_list|,
name|SDT_SYS386TGT
argument_list|,
name|SEL_KPL
argument_list|,
name|GSEL
argument_list|(
name|GCODE_SEL
argument_list|,
name|SEL_KPL
argument_list|)
argument_list|)
expr_stmt|;
name|rdmsr
argument_list|(
literal|0x1002
argument_list|)
expr_stmt|;
comment|/* Cyrix CPU generates fault. */
if|if
condition|(
name|trap_by_rdmsr
operator|==
literal|0xa8c1d
condition|)
return|return
name|IDENTBLUE_CYRIX486
return|;
elseif|else
if|if
condition|(
name|trap_by_rdmsr
operator|==
literal|0xa89c4
condition|)
return|return
name|IDENTBLUE_CYRIXM2
return|;
return|return
name|IDENTBLUE_IBMCPU
return|;
block|}
end_function

begin_comment
comment|/*  * identifycyrix() set lower 16 bits of cyrix_did as follows:  *  *  F E D C B A 9 8 7 6 5 4 3 2 1 0  * +-------+-------+---------------+  * |  SID  |  RID  |   Device ID   |  * |    (DIR 1)    |    (DIR 0)    |  * +-------+-------+---------------+  */
end_comment

begin_function
specifier|static
name|void
name|identifycyrix
parameter_list|(
name|void
parameter_list|)
block|{
name|u_int
name|eflags
decl_stmt|;
name|int
name|ccr2_test
init|=
literal|0
decl_stmt|,
name|dir_test
init|=
literal|0
decl_stmt|;
name|u_char
name|ccr2
decl_stmt|,
name|ccr3
decl_stmt|;
name|eflags
operator|=
name|read_eflags
argument_list|()
expr_stmt|;
name|disable_intr
argument_list|()
expr_stmt|;
name|ccr2
operator|=
name|read_cyrix_reg
argument_list|(
name|CCR2
argument_list|)
expr_stmt|;
name|write_cyrix_reg
argument_list|(
name|CCR2
argument_list|,
name|ccr2
operator|^
name|CCR2_LOCK_NW
argument_list|)
expr_stmt|;
name|read_cyrix_reg
argument_list|(
name|CCR2
argument_list|)
expr_stmt|;
if|if
condition|(
name|read_cyrix_reg
argument_list|(
name|CCR2
argument_list|)
operator|!=
name|ccr2
condition|)
name|ccr2_test
operator|=
literal|1
expr_stmt|;
name|write_cyrix_reg
argument_list|(
name|CCR2
argument_list|,
name|ccr2
argument_list|)
expr_stmt|;
name|ccr3
operator|=
name|read_cyrix_reg
argument_list|(
name|CCR3
argument_list|)
expr_stmt|;
name|write_cyrix_reg
argument_list|(
name|CCR3
argument_list|,
name|ccr3
operator|^
name|CCR3_MAPEN3
argument_list|)
expr_stmt|;
name|read_cyrix_reg
argument_list|(
name|CCR3
argument_list|)
expr_stmt|;
if|if
condition|(
name|read_cyrix_reg
argument_list|(
name|CCR3
argument_list|)
operator|!=
name|ccr3
condition|)
name|dir_test
operator|=
literal|1
expr_stmt|;
comment|/* CPU supports DIRs. */
name|write_cyrix_reg
argument_list|(
name|CCR3
argument_list|,
name|ccr3
argument_list|)
expr_stmt|;
if|if
condition|(
name|dir_test
condition|)
block|{
comment|/* Device ID registers are available. */
name|cyrix_did
operator|=
name|read_cyrix_reg
argument_list|(
name|DIR1
argument_list|)
operator|<<
literal|8
expr_stmt|;
name|cyrix_did
operator|+=
name|read_cyrix_reg
argument_list|(
name|DIR0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ccr2_test
condition|)
name|cyrix_did
operator|=
literal|0x0010
expr_stmt|;
comment|/* 486S A-step */
else|else
name|cyrix_did
operator|=
literal|0x00ff
expr_stmt|;
comment|/* Old 486SLC/DLC and TI486SXLC/SXL */
name|write_eflags
argument_list|(
name|eflags
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Final stage of CPU identification. -- Should I check TI?  */
end_comment

begin_function
name|void
name|finishidentcpu
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|isblue
init|=
literal|0
decl_stmt|;
name|u_char
name|ccr3
decl_stmt|;
name|u_int
name|regs
index|[
literal|4
index|]
decl_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|cpu_vendor
argument_list|,
literal|"CyrixInstead"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|cpu
operator|==
name|CPU_486
condition|)
block|{
comment|/* 			 * These conditions are equivalent to: 			 *     - CPU does not support cpuid instruction. 			 *     - Cyrix/IBM CPU is detected. 			 */
name|isblue
operator|=
name|identblue
argument_list|()
expr_stmt|;
if|if
condition|(
name|isblue
operator|==
name|IDENTBLUE_IBMCPU
condition|)
block|{
name|strcpy
argument_list|(
name|cpu_vendor
argument_list|,
literal|"IBM"
argument_list|)
expr_stmt|;
name|cpu
operator|=
name|CPU_BLUE
expr_stmt|;
return|return;
block|}
block|}
switch|switch
condition|(
name|cpu_id
operator|&
literal|0xf00
condition|)
block|{
case|case
literal|0x600
case|:
comment|/* 			 * Cyrix's datasheet does not describe DIRs. 			 * Therefor, I assume it does not have them 			 * and use the result of the cpuid instruction. 			 * XXX they seem to have it for now at least. -Peter 			 */
name|identifycyrix
argument_list|()
expr_stmt|;
name|cpu
operator|=
name|CPU_M2
expr_stmt|;
break|break;
default|default:
name|identifycyrix
argument_list|()
expr_stmt|;
comment|/* 			 * This routine contains a trick. 			 * Don't check (cpu_id& 0x00f0) == 0x50 to detect M2, now. 			 */
switch|switch
condition|(
name|cyrix_did
operator|&
literal|0x00f0
condition|)
block|{
case|case
literal|0x00
case|:
case|case
literal|0xf0
case|:
name|cpu
operator|=
name|CPU_486DLC
expr_stmt|;
break|break;
case|case
literal|0x10
case|:
name|cpu
operator|=
name|CPU_CY486DX
expr_stmt|;
break|break;
case|case
literal|0x20
case|:
if|if
condition|(
operator|(
name|cyrix_did
operator|&
literal|0x000f
operator|)
operator|<
literal|8
condition|)
name|cpu
operator|=
name|CPU_M1
expr_stmt|;
else|else
name|cpu
operator|=
name|CPU_M1SC
expr_stmt|;
break|break;
case|case
literal|0x30
case|:
name|cpu
operator|=
name|CPU_M1
expr_stmt|;
break|break;
case|case
literal|0x40
case|:
comment|/* MediaGX CPU */
name|cpu
operator|=
name|CPU_M1SC
expr_stmt|;
break|break;
default|default:
comment|/* M2 and later CPUs are treated as M2. */
name|cpu
operator|=
name|CPU_M2
expr_stmt|;
comment|/* 				 * enable cpuid instruction. 				 */
name|ccr3
operator|=
name|read_cyrix_reg
argument_list|(
name|CCR3
argument_list|)
expr_stmt|;
name|write_cyrix_reg
argument_list|(
name|CCR3
argument_list|,
name|CCR3_MAPEN0
argument_list|)
expr_stmt|;
name|write_cyrix_reg
argument_list|(
name|CCR4
argument_list|,
name|read_cyrix_reg
argument_list|(
name|CCR4
argument_list|)
operator||
name|CCR4_CPUID
argument_list|)
expr_stmt|;
name|write_cyrix_reg
argument_list|(
name|CCR3
argument_list|,
name|ccr3
argument_list|)
expr_stmt|;
name|do_cpuid
argument_list|(
literal|0
argument_list|,
name|regs
argument_list|)
expr_stmt|;
name|cpu_high
operator|=
name|regs
index|[
literal|0
index|]
expr_stmt|;
comment|/* eax */
name|do_cpuid
argument_list|(
literal|1
argument_list|,
name|regs
argument_list|)
expr_stmt|;
name|cpu_id
operator|=
name|regs
index|[
literal|0
index|]
expr_stmt|;
comment|/* eax */
name|cpu_feature
operator|=
name|regs
index|[
literal|3
index|]
expr_stmt|;
comment|/* edx */
break|break;
block|}
block|}
block|}
elseif|else
if|if
condition|(
name|cpu
operator|==
name|CPU_486
operator|&&
operator|*
name|cpu_vendor
operator|==
literal|'\0'
condition|)
block|{
comment|/* 		 * There are BlueLightning CPUs that do not change 		 * undefined flags by dividing 5 by 2.  In this case, 		 * the CPU identification routine in locore.s leaves 		 * cpu_vendor null string and puts CPU_486 into the 		 * cpu. 		 */
name|isblue
operator|=
name|identblue
argument_list|()
expr_stmt|;
if|if
condition|(
name|isblue
operator|==
name|IDENTBLUE_IBMCPU
condition|)
block|{
name|strcpy
argument_list|(
name|cpu_vendor
argument_list|,
literal|"IBM"
argument_list|)
expr_stmt|;
name|cpu
operator|=
name|CPU_BLUE
expr_stmt|;
return|return;
block|}
block|}
block|}
end_function

begin_comment
comment|/*  * This routine is called specifically to set up cpu_class before  * startrtclock() uses it.  Probably this should be rearranged so that  * startrtclock() doesn't need to run until after identifycpu() has been  * called.  Another alternative formulation would be for this routine  * to do all the identification work, and make identifycpu() into a  * printing-only routine.  */
end_comment

begin_function
name|void
name|earlysetcpuclass
parameter_list|(
name|void
parameter_list|)
block|{
name|cpu_class
operator|=
name|i386_cpus
index|[
name|cpu
index|]
operator|.
name|cpu_class
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_AMD_assoc
parameter_list|(
name|int
name|i
parameter_list|)
block|{
if|if
condition|(
name|i
operator|==
literal|255
condition|)
name|printf
argument_list|(
literal|", fully associative\n"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|", %d-way associative\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_AMD_info
parameter_list|(
name|u_int
name|amd_maxregs
parameter_list|)
block|{
name|quad_t
name|amd_whcr
decl_stmt|;
if|if
condition|(
name|amd_maxregs
operator|>=
literal|0x80000005
condition|)
block|{
name|u_int
name|regs
index|[
literal|4
index|]
decl_stmt|;
name|do_cpuid
argument_list|(
literal|0x80000005
argument_list|,
name|regs
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Data TLB: %d entries"
argument_list|,
operator|(
name|regs
index|[
literal|1
index|]
operator|>>
literal|16
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|print_AMD_assoc
argument_list|(
name|regs
index|[
literal|1
index|]
operator|>>
literal|24
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Instruction TLB: %d entries"
argument_list|,
name|regs
index|[
literal|1
index|]
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|print_AMD_assoc
argument_list|(
operator|(
name|regs
index|[
literal|1
index|]
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"L1 data cache: %d kbytes"
argument_list|,
name|regs
index|[
literal|2
index|]
operator|>>
literal|24
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|", %d bytes/line"
argument_list|,
name|regs
index|[
literal|2
index|]
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|", %d lines/tag"
argument_list|,
operator|(
name|regs
index|[
literal|2
index|]
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|print_AMD_assoc
argument_list|(
operator|(
name|regs
index|[
literal|2
index|]
operator|>>
literal|16
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"L1 instruction cache: %d kbytes"
argument_list|,
name|regs
index|[
literal|3
index|]
operator|>>
literal|24
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|", %d bytes/line"
argument_list|,
name|regs
index|[
literal|3
index|]
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|", %d lines/tag"
argument_list|,
operator|(
name|regs
index|[
literal|3
index|]
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|print_AMD_assoc
argument_list|(
operator|(
name|regs
index|[
literal|3
index|]
operator|>>
literal|16
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
if|if
condition|(
name|amd_maxregs
operator|>=
literal|0x80000006
condition|)
block|{
comment|/* K6-III only */
name|do_cpuid
argument_list|(
literal|0x80000006
argument_list|,
name|regs
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"L2 internal cache: %d kbytes"
argument_list|,
name|regs
index|[
literal|2
index|]
operator|>>
literal|16
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|", %d bytes/line"
argument_list|,
name|regs
index|[
literal|2
index|]
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|", %d lines/tag"
argument_list|,
operator|(
name|regs
index|[
literal|2
index|]
operator|>>
literal|8
operator|)
operator|&
literal|0x0f
argument_list|)
expr_stmt|;
name|print_AMD_assoc
argument_list|(
operator|(
name|regs
index|[
literal|2
index|]
operator|>>
literal|12
operator|)
operator|&
literal|0x0f
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
operator|(
name|cpu_id
operator|&
literal|0xf00
operator|)
operator|==
literal|0x500
operator|)
operator|&&
operator|(
operator|(
operator|(
name|cpu_id
operator|&
literal|0x0f0
operator|)
operator|>
literal|0x80
operator|)
operator|||
operator|(
operator|(
operator|(
name|cpu_id
operator|&
literal|0x0f0
operator|)
operator|==
literal|0x80
operator|)
operator|&&
operator|(
name|cpu_id
operator|&
literal|0x00f
operator|)
operator|>
literal|0x07
operator|)
operator|)
condition|)
block|{
comment|/* K6-2(new core [Stepping 8-F]), K6-III or later */
name|amd_whcr
operator|=
name|rdmsr
argument_list|(
literal|0xc0000082
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|amd_whcr
operator|&
operator|(
literal|0x3ff
operator|<<
literal|22
operator|)
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"Write Allocate Disable\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"Write Allocate Enable Limit: %dM bytes\n"
argument_list|,
call|(
name|u_int32_t
call|)
argument_list|(
operator|(
name|amd_whcr
operator|&
operator|(
literal|0x3ff
operator|<<
literal|22
operator|)
operator|)
operator|>>
literal|22
argument_list|)
operator|*
literal|4
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Write Allocate 15-16M bytes: %s\n"
argument_list|,
operator|(
name|amd_whcr
operator|&
operator|(
literal|1
operator|<<
literal|16
operator|)
operator|)
condition|?
literal|"Enable"
else|:
literal|"Disable"
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
operator|(
operator|(
name|cpu_id
operator|&
literal|0xf00
operator|)
operator|==
literal|0x500
operator|)
operator|&&
operator|(
operator|(
name|cpu_id
operator|&
literal|0x0f0
operator|)
operator|>
literal|0x50
operator|)
condition|)
block|{
comment|/* K6, K6-2(old core) */
name|amd_whcr
operator|=
name|rdmsr
argument_list|(
literal|0xc0000082
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|amd_whcr
operator|&
operator|(
literal|0x7f
operator|<<
literal|1
operator|)
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"Write Allocate Disable\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"Write Allocate Enable Limit: %dM bytes\n"
argument_list|,
call|(
name|u_int32_t
call|)
argument_list|(
operator|(
name|amd_whcr
operator|&
operator|(
literal|0x7f
operator|<<
literal|1
operator|)
operator|)
operator|>>
literal|1
argument_list|)
operator|*
literal|4
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Write Allocate 15-16M bytes: %s\n"
argument_list|,
operator|(
name|amd_whcr
operator|&
literal|0x0001
operator|)
condition|?
literal|"Enable"
else|:
literal|"Disable"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Hardware Write Allocate Control: %s\n"
argument_list|,
operator|(
name|amd_whcr
operator|&
literal|0x0100
operator|)
condition|?
literal|"Enable"
else|:
literal|"Disable"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|print_AMD_features
parameter_list|(
name|u_int
modifier|*
name|regs
parameter_list|)
block|{
comment|/* 	 * Values taken from AMD Processor Recognition 	 * http://www.amd.com/products/cpg/athlon/techdocs/pdf/20734.pdf 	 */
name|do_cpuid
argument_list|(
literal|0x80000001
argument_list|,
name|regs
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n  AMD Features=0x%b"
argument_list|,
name|regs
index|[
literal|3
index|]
operator|&
operator|~
name|cpu_feature
argument_list|,
literal|"\020"
comment|/* in hex */
literal|"\001FPU"
comment|/* Integral FPU */
literal|"\002VME"
comment|/* Extended VM86 mode support */
literal|"\003DE"
comment|/* Debug extensions */
literal|"\004PSE"
comment|/* 4MByte page tables */
literal|"\005TSC"
comment|/* Timestamp counter */
literal|"\006MSR"
comment|/* Machine specific registers */
literal|"\007PAE"
comment|/* Physical address extension */
literal|"\010MCE"
comment|/* Machine Check support */
literal|"\011CX8"
comment|/* CMPEXCH8 instruction */
literal|"\012APIC"
comment|/* SMP local APIC */
literal|"\013<b10>"
literal|"\014SYSCALL"
comment|/* SYSENTER/SYSEXIT instructions */
literal|"\015MTRR"
comment|/* Memory Type Range Registers */
literal|"\016PGE"
comment|/* PG_G (global bit) support */
literal|"\017MCA"
comment|/* Machine Check Architecture */
literal|"\020ICMOV"
comment|/* CMOV instruction */
literal|"\021PAT"
comment|/* Page attributes table */
literal|"\022PGE36"
comment|/* 36 bit address space support */
literal|"\023<b18>"
literal|"\024<b19>"
literal|"\025<b20>"
literal|"\026<b21>"
literal|"\027AMIE"
comment|/* AMD MMX Instruction Extensions */
literal|"\030MMX"
literal|"\031FXSAVE"
comment|/* FXSAVE/FXRSTOR */
literal|"\032<b25>"
literal|"\033<b26>"
literal|"\034<b27>"
literal|"\035<b28>"
literal|"\036<b29>"
literal|"\037DSP"
comment|/* AMD 3DNow! Instruction Extensions */
literal|"\0403DNow!"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Transmeta Crusoe LongRun Support by Tamotsu Hattori.   */
end_comment

begin_define
define|#
directive|define
name|MSR_TMx86_LONGRUN
value|0x80868010
end_define

begin_define
define|#
directive|define
name|MSR_TMx86_LONGRUN_FLAGS
value|0x80868011
end_define

begin_define
define|#
directive|define
name|LONGRUN_MODE_MASK
parameter_list|(
name|x
parameter_list|)
value|((x)& 0x000000007f)
end_define

begin_define
define|#
directive|define
name|LONGRUN_MODE_RESERVED
parameter_list|(
name|x
parameter_list|)
value|((x)& 0xffffff80)
end_define

begin_define
define|#
directive|define
name|LONGRUN_MODE_WRITE
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|)
value|(LONGRUN_MODE_RESERVED(x) | LONGRUN_MODE_MASK(y))
end_define

begin_define
define|#
directive|define
name|LONGRUN_MODE_MINFREQUENCY
value|0x00
end_define

begin_define
define|#
directive|define
name|LONGRUN_MODE_ECONOMY
value|0x01
end_define

begin_define
define|#
directive|define
name|LONGRUN_MODE_PERFORMANCE
value|0x02
end_define

begin_define
define|#
directive|define
name|LONGRUN_MODE_MAXFREQUENCY
value|0x03
end_define

begin_define
define|#
directive|define
name|LONGRUN_MODE_UNKNOWN
value|0x04
end_define

begin_define
define|#
directive|define
name|LONGRUN_MODE_MAX
value|0x04
end_define

begin_union
union|union
name|msrinfo
block|{
name|u_int64_t
name|msr
decl_stmt|;
name|u_int32_t
name|regs
index|[
literal|2
index|]
decl_stmt|;
block|}
union|;
end_union

begin_decl_stmt
name|u_int32_t
name|longrun_modes
index|[
name|LONGRUN_MODE_MAX
index|]
index|[
literal|3
index|]
init|=
block|{
comment|/*  MSR low, MSR high, flags bit0 */
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|/* LONGRUN_MODE_MINFREQUENCY */
block|{
literal|0
block|,
literal|100
block|,
literal|0
block|}
block|,
comment|/* LONGRUN_MODE_ECONOMY */
block|{
literal|0
block|,
literal|100
block|,
literal|1
block|}
block|,
comment|/* LONGRUN_MODE_PERFORMANCE */
block|{
literal|100
block|,
literal|100
block|,
literal|1
block|}
block|,
comment|/* LONGRUN_MODE_MAXFREQUENCY */
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|u_int
name|tmx86_get_longrun_mode
parameter_list|(
name|void
parameter_list|)
block|{
name|u_long
name|eflags
decl_stmt|;
name|union
name|msrinfo
name|msrinfo
decl_stmt|;
name|u_int
name|low
decl_stmt|,
name|high
decl_stmt|,
name|flags
decl_stmt|,
name|mode
decl_stmt|;
name|eflags
operator|=
name|read_eflags
argument_list|()
expr_stmt|;
name|disable_intr
argument_list|()
expr_stmt|;
name|msrinfo
operator|.
name|msr
operator|=
name|rdmsr
argument_list|(
name|MSR_TMx86_LONGRUN
argument_list|)
expr_stmt|;
name|low
operator|=
name|LONGRUN_MODE_MASK
argument_list|(
name|msrinfo
operator|.
name|regs
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|high
operator|=
name|LONGRUN_MODE_MASK
argument_list|(
name|msrinfo
operator|.
name|regs
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|flags
operator|=
name|rdmsr
argument_list|(
name|MSR_TMx86_LONGRUN_FLAGS
argument_list|)
operator|&
literal|0x01
expr_stmt|;
for|for
control|(
name|mode
operator|=
literal|0
init|;
name|mode
operator|<
name|LONGRUN_MODE_MAX
condition|;
name|mode
operator|++
control|)
block|{
if|if
condition|(
name|low
operator|==
name|longrun_modes
index|[
name|mode
index|]
index|[
literal|0
index|]
operator|&&
name|high
operator|==
name|longrun_modes
index|[
name|mode
index|]
index|[
literal|1
index|]
operator|&&
name|flags
operator|==
name|longrun_modes
index|[
name|mode
index|]
index|[
literal|2
index|]
condition|)
block|{
goto|goto
name|out
goto|;
block|}
block|}
name|mode
operator|=
name|LONGRUN_MODE_UNKNOWN
expr_stmt|;
name|out
label|:
name|write_eflags
argument_list|(
name|eflags
argument_list|)
expr_stmt|;
return|return
operator|(
name|mode
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|u_int
name|tmx86_get_longrun_status
parameter_list|(
name|u_int
modifier|*
name|frequency
parameter_list|,
name|u_int
modifier|*
name|voltage
parameter_list|,
name|u_int
modifier|*
name|percentage
parameter_list|)
block|{
name|u_long
name|eflags
decl_stmt|;
name|u_int
name|regs
index|[
literal|4
index|]
decl_stmt|;
name|eflags
operator|=
name|read_eflags
argument_list|()
expr_stmt|;
name|disable_intr
argument_list|()
expr_stmt|;
name|do_cpuid
argument_list|(
literal|0x80860007
argument_list|,
name|regs
argument_list|)
expr_stmt|;
operator|*
name|frequency
operator|=
name|regs
index|[
literal|0
index|]
expr_stmt|;
operator|*
name|voltage
operator|=
name|regs
index|[
literal|1
index|]
expr_stmt|;
operator|*
name|percentage
operator|=
name|regs
index|[
literal|2
index|]
expr_stmt|;
name|write_eflags
argument_list|(
name|eflags
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|u_int
name|tmx86_set_longrun_mode
parameter_list|(
name|u_int
name|mode
parameter_list|)
block|{
name|u_long
name|eflags
decl_stmt|;
name|union
name|msrinfo
name|msrinfo
decl_stmt|;
if|if
condition|(
name|mode
operator|>=
name|LONGRUN_MODE_UNKNOWN
condition|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|eflags
operator|=
name|read_eflags
argument_list|()
expr_stmt|;
name|disable_intr
argument_list|()
expr_stmt|;
comment|/* Write LongRun mode values to Model Specific Register. */
name|msrinfo
operator|.
name|msr
operator|=
name|rdmsr
argument_list|(
name|MSR_TMx86_LONGRUN
argument_list|)
expr_stmt|;
name|msrinfo
operator|.
name|regs
index|[
literal|0
index|]
operator|=
name|LONGRUN_MODE_WRITE
argument_list|(
name|msrinfo
operator|.
name|regs
index|[
literal|0
index|]
argument_list|,
name|longrun_modes
index|[
name|mode
index|]
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|msrinfo
operator|.
name|regs
index|[
literal|1
index|]
operator|=
name|LONGRUN_MODE_WRITE
argument_list|(
name|msrinfo
operator|.
name|regs
index|[
literal|1
index|]
argument_list|,
name|longrun_modes
index|[
name|mode
index|]
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|wrmsr
argument_list|(
name|MSR_TMx86_LONGRUN
argument_list|,
name|msrinfo
operator|.
name|msr
argument_list|)
expr_stmt|;
comment|/* Write LongRun mode flags to Model Specific Register. */
name|msrinfo
operator|.
name|msr
operator|=
name|rdmsr
argument_list|(
name|MSR_TMx86_LONGRUN_FLAGS
argument_list|)
expr_stmt|;
name|msrinfo
operator|.
name|regs
index|[
literal|0
index|]
operator|=
operator|(
name|msrinfo
operator|.
name|regs
index|[
literal|0
index|]
operator|&
operator|~
literal|0x01
operator|)
operator||
name|longrun_modes
index|[
name|mode
index|]
index|[
literal|2
index|]
expr_stmt|;
name|wrmsr
argument_list|(
name|MSR_TMx86_LONGRUN_FLAGS
argument_list|,
name|msrinfo
operator|.
name|msr
argument_list|)
expr_stmt|;
name|write_eflags
argument_list|(
name|eflags
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|u_int
name|crusoe_longrun
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|u_int
name|crusoe_frequency
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|u_int
name|crusoe_voltage
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|u_int
name|crusoe_percentage
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|sysctl_ctx_list
name|crusoe_sysctl_ctx
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|sysctl_oid
modifier|*
name|crusoe_sysctl_tree
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|tmx86_longrun_sysctl
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|u_int
name|mode
decl_stmt|;
name|int
name|error
decl_stmt|;
name|crusoe_longrun
operator|=
name|tmx86_get_longrun_mode
argument_list|()
expr_stmt|;
name|mode
operator|=
name|crusoe_longrun
expr_stmt|;
name|error
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|mode
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|||
operator|!
name|req
operator|->
name|newptr
condition|)
block|{
return|return
operator|(
name|error
operator|)
return|;
block|}
if|if
condition|(
name|mode
operator|>=
name|LONGRUN_MODE_UNKNOWN
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
if|if
condition|(
name|crusoe_longrun
operator|!=
name|mode
condition|)
block|{
name|crusoe_longrun
operator|=
name|mode
expr_stmt|;
name|tmx86_set_longrun_mode
argument_list|(
name|crusoe_longrun
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tmx86_status_sysctl
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|u_int
name|val
decl_stmt|;
name|int
name|error
decl_stmt|;
name|tmx86_get_longrun_status
argument_list|(
operator|&
name|crusoe_frequency
argument_list|,
operator|&
name|crusoe_voltage
argument_list|,
operator|&
name|crusoe_percentage
argument_list|)
expr_stmt|;
name|val
operator|=
operator|*
operator|(
name|u_int
operator|*
operator|)
name|oidp
operator|->
name|oid_arg1
expr_stmt|;
name|error
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|val
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|setup_tmx86_longrun
parameter_list|(
name|void
parameter_list|)
block|{
specifier|static
name|int
name|done
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|done
condition|)
return|return;
name|done
operator|++
expr_stmt|;
name|sysctl_ctx_init
argument_list|(
operator|&
name|crusoe_sysctl_ctx
argument_list|)
expr_stmt|;
name|crusoe_sysctl_tree
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
operator|&
name|crusoe_sysctl_ctx
argument_list|,
name|SYSCTL_STATIC_CHILDREN
argument_list|(
name|_hw
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"crusoe"
argument_list|,
name|CTLFLAG_RD
argument_list|,
literal|0
argument_list|,
literal|"Transmeta Crusoe LongRun support"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
operator|&
name|crusoe_sysctl_ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|crusoe_sysctl_tree
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"longrun"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RW
argument_list|,
operator|&
name|crusoe_longrun
argument_list|,
literal|0
argument_list|,
name|tmx86_longrun_sysctl
argument_list|,
literal|"I"
argument_list|,
literal|"LongRun mode [0-3]"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
operator|&
name|crusoe_sysctl_ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|crusoe_sysctl_tree
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"frequency"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RD
argument_list|,
operator|&
name|crusoe_frequency
argument_list|,
literal|0
argument_list|,
name|tmx86_status_sysctl
argument_list|,
literal|"I"
argument_list|,
literal|"Current frequency (MHz)"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
operator|&
name|crusoe_sysctl_ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|crusoe_sysctl_tree
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"voltage"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RD
argument_list|,
operator|&
name|crusoe_voltage
argument_list|,
literal|0
argument_list|,
name|tmx86_status_sysctl
argument_list|,
literal|"I"
argument_list|,
literal|"Current voltage (mV)"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
operator|&
name|crusoe_sysctl_ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|crusoe_sysctl_tree
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"percentage"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RD
argument_list|,
operator|&
name|crusoe_percentage
argument_list|,
literal|0
argument_list|,
name|tmx86_status_sysctl
argument_list|,
literal|"I"
argument_list|,
literal|"Processing performance (%)"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_transmeta_info
parameter_list|()
block|{
name|u_int
name|regs
index|[
literal|4
index|]
decl_stmt|,
name|nreg
init|=
literal|0
decl_stmt|;
name|do_cpuid
argument_list|(
literal|0x80860000
argument_list|,
name|regs
argument_list|)
expr_stmt|;
name|nreg
operator|=
name|regs
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|nreg
operator|>=
literal|0x80860001
condition|)
block|{
name|do_cpuid
argument_list|(
literal|0x80860001
argument_list|,
name|regs
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  Processor revision %u.%u.%u.%u\n"
argument_list|,
operator|(
name|regs
index|[
literal|1
index|]
operator|>>
literal|24
operator|)
operator|&
literal|0xff
argument_list|,
operator|(
name|regs
index|[
literal|1
index|]
operator|>>
literal|16
operator|)
operator|&
literal|0xff
argument_list|,
operator|(
name|regs
index|[
literal|1
index|]
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|,
name|regs
index|[
literal|1
index|]
operator|&
literal|0xff
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|nreg
operator|>=
literal|0x80860002
condition|)
block|{
name|do_cpuid
argument_list|(
literal|0x80860002
argument_list|,
name|regs
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  Code Morphing Software revision %u.%u.%u-%u-%u\n"
argument_list|,
operator|(
name|regs
index|[
literal|1
index|]
operator|>>
literal|24
operator|)
operator|&
literal|0xff
argument_list|,
operator|(
name|regs
index|[
literal|1
index|]
operator|>>
literal|16
operator|)
operator|&
literal|0xff
argument_list|,
operator|(
name|regs
index|[
literal|1
index|]
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|,
name|regs
index|[
literal|1
index|]
operator|&
literal|0xff
argument_list|,
name|regs
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|nreg
operator|>=
literal|0x80860006
condition|)
block|{
name|char
name|info
index|[
literal|65
index|]
decl_stmt|;
name|do_cpuid
argument_list|(
literal|0x80860003
argument_list|,
operator|(
name|u_int
operator|*
operator|)
operator|&
name|info
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|do_cpuid
argument_list|(
literal|0x80860004
argument_list|,
operator|(
name|u_int
operator|*
operator|)
operator|&
name|info
index|[
literal|16
index|]
argument_list|)
expr_stmt|;
name|do_cpuid
argument_list|(
literal|0x80860005
argument_list|,
operator|(
name|u_int
operator|*
operator|)
operator|&
name|info
index|[
literal|32
index|]
argument_list|)
expr_stmt|;
name|do_cpuid
argument_list|(
literal|0x80860006
argument_list|,
operator|(
name|u_int
operator|*
operator|)
operator|&
name|info
index|[
literal|48
index|]
argument_list|)
expr_stmt|;
name|info
index|[
literal|64
index|]
operator|=
literal|0
expr_stmt|;
name|printf
argument_list|(
literal|"  %s\n"
argument_list|,
name|info
argument_list|)
expr_stmt|;
block|}
name|crusoe_longrun
operator|=
name|tmx86_get_longrun_mode
argument_list|()
expr_stmt|;
name|tmx86_get_longrun_status
argument_list|(
operator|&
name|crusoe_frequency
argument_list|,
operator|&
name|crusoe_voltage
argument_list|,
operator|&
name|crusoe_percentage
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  LongRun mode: %d<%dMHz %dmV %d%%>\n"
argument_list|,
name|crusoe_longrun
argument_list|,
name|crusoe_frequency
argument_list|,
name|crusoe_voltage
argument_list|,
name|crusoe_percentage
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2000 Michael Smith<msmith@freebsd.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  *	$FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|"opt_acpi.h"
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm.h>
end_include

begin_include
include|#
directive|include
file|<vm/pmap.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/md_var.h>
end_include

begin_include
include|#
directive|include
file|<machine/vmparam.h>
end_include

begin_include
include|#
directive|include
file|<machine/vm86.h>
end_include

begin_include
include|#
directive|include
file|<machine/pc/bios.h>
end_include

begin_include
include|#
directive|include
file|<dev/acpi/acpireg.h>
end_include

begin_include
include|#
directive|include
file|<dev/acpi/acpivar.h>
end_include

begin_function
name|struct
name|ACPIrsdp
modifier|*
name|acpi_find_rsdp
parameter_list|(
name|void
parameter_list|)
block|{
name|u_long
name|sigaddr
decl_stmt|;
name|struct
name|ACPIrsdp
modifier|*
name|rsdp
decl_stmt|;
name|u_int8_t
name|ck
decl_stmt|,
modifier|*
name|cv
decl_stmt|;
name|int
name|i
decl_stmt|,
name|year
decl_stmt|;
name|char
modifier|*
name|dp
decl_stmt|;
comment|/*      * Search for the RSD PTR signature.      */
if|if
condition|(
operator|(
name|sigaddr
operator|=
name|bios_sigsearch
argument_list|(
literal|0
argument_list|,
literal|"RSD PTR "
argument_list|,
literal|8
argument_list|,
literal|16
argument_list|,
literal|0
argument_list|)
operator|)
operator|==
literal|0
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
comment|/* get a virtual pointer to the structure */
name|rsdp
operator|=
operator|(
expr|struct
name|ACPIrsdp
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|BIOS_PADDRTOVADDR
argument_list|(
name|sigaddr
argument_list|)
expr_stmt|;
for|for
control|(
name|cv
operator|=
operator|(
name|u_int8_t
operator|*
operator|)
name|rsdp
operator|,
name|ck
operator|=
literal|0
operator|,
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|ACPIrsdp
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|ck
operator|+=
name|cv
index|[
name|i
index|]
expr_stmt|;
block|}
comment|/*      * Fail if the checksum doesn't match.      */
if|if
condition|(
name|ck
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"ACPI: Bad ACPI BIOS data checksum\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
comment|/*      * Fail if the BIOS is too old to be trustworthy.      * XXX we should check the ACPI BIOS blacklist/goodlist here.      */
name|dp
operator|=
operator|(
name|char
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|BIOS_PADDRTOVADDR
argument_list|(
literal|0xffff5
argument_list|)
expr_stmt|;
name|year
operator|=
operator|(
operator|(
operator|*
operator|(
name|dp
operator|+
literal|6
operator|)
operator|-
literal|'0'
operator|)
operator|*
literal|10
operator|)
operator|+
operator|(
operator|*
operator|(
name|dp
operator|+
literal|7
operator|)
operator|-
literal|'0'
operator|)
expr_stmt|;
if|if
condition|(
name|year
operator|<
literal|70
condition|)
name|year
operator|+=
literal|100
expr_stmt|;
if|if
condition|(
name|year
operator|<
literal|99
condition|)
block|{
name|printf
argument_list|(
literal|"ACPI: BIOS too old (%.8s< 01/01/99)\n"
argument_list|,
name|dp
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
return|return
operator|(
name|rsdp
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Find and map all memory regions that are regarded as belonging to ACPI  * and let the MI code know about them.  Scan the ACPI memory map as managed  * by the MI code and map it into kernel space.  */
end_comment

begin_function
name|void
name|acpi_mapmem
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|vm86frame
name|vmf
decl_stmt|;
name|struct
name|vm86context
name|vmc
decl_stmt|;
name|struct
name|bios_smap
modifier|*
name|smap
decl_stmt|;
name|vm_offset_t
name|va
decl_stmt|;
name|int
name|i
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|vmf
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|vm86frame
argument_list|)
argument_list|)
expr_stmt|;
name|acpi_init_addr_range
argument_list|()
expr_stmt|;
comment|/*      * Scan memory map with INT 15:E820      */
name|vmc
operator|.
name|npages
operator|=
literal|0
expr_stmt|;
name|smap
operator|=
operator|(
name|void
operator|*
operator|)
name|vm86_addpage
argument_list|(
operator|&
name|vmc
argument_list|,
literal|1
argument_list|,
name|KERNBASE
operator|+
operator|(
literal|1
operator|<<
name|PAGE_SHIFT
operator|)
argument_list|)
expr_stmt|;
name|vm86_getptr
argument_list|(
operator|&
name|vmc
argument_list|,
operator|(
name|vm_offset_t
operator|)
name|smap
argument_list|,
operator|&
name|vmf
operator|.
name|vmf_es
argument_list|,
operator|&
name|vmf
operator|.
name|vmf_di
argument_list|)
expr_stmt|;
name|vmf
operator|.
name|vmf_ebx
operator|=
literal|0
expr_stmt|;
do|do
block|{
name|vmf
operator|.
name|vmf_eax
operator|=
literal|0xE820
expr_stmt|;
name|vmf
operator|.
name|vmf_edx
operator|=
name|SMAP_SIG
expr_stmt|;
name|vmf
operator|.
name|vmf_ecx
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|bios_smap
argument_list|)
expr_stmt|;
name|i
operator|=
name|vm86_datacall
argument_list|(
literal|0x15
argument_list|,
operator|&
name|vmf
argument_list|,
operator|&
name|vmc
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|||
name|vmf
operator|.
name|vmf_eax
operator|!=
name|SMAP_SIG
condition|)
break|break;
comment|/* ACPI-owned memory? */
if|if
condition|(
name|smap
operator|->
name|type
operator|==
literal|0x03
operator|||
name|smap
operator|->
name|type
operator|==
literal|0x04
condition|)
block|{
name|acpi_register_addr_range
argument_list|(
name|smap
operator|->
name|base
argument_list|,
name|smap
operator|->
name|length
argument_list|,
name|smap
operator|->
name|type
argument_list|)
expr_stmt|;
block|}
block|}
do|while
condition|(
name|vmf
operator|.
name|vmf_ebx
operator|!=
literal|0
condition|)
do|;
comment|/*      * Map the physical ranges that have been registered into the kernel.      */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|acpi_addr
operator|.
name|entries
condition|;
name|i
operator|++
control|)
block|{
name|va
operator|=
operator|(
name|vm_offset_t
operator|)
name|pmap_mapdev
argument_list|(
name|acpi_addr
operator|.
name|t
index|[
name|i
index|]
operator|.
name|pa_base
argument_list|,
name|acpi_addr
operator|.
name|t
index|[
name|i
index|]
operator|.
name|size
argument_list|)
expr_stmt|;
name|acpi_addr
operator|.
name|t
index|[
name|i
index|]
operator|.
name|va_base
operator|=
name|va
expr_stmt|;
block|}
block|}
end_function

end_unit


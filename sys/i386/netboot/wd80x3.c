begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/************************************************************************** NETBOOT -  BOOTP/TFTP Bootstrap Program  Author: Martin Renters   Date: Dec/93  **************************************************************************/
end_comment

begin_include
include|#
directive|include
file|"netboot.h"
end_include

begin_decl_stmt
name|unsigned
name|short
name|we_base
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|char
modifier|*
name|we_bmem
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|WE_LOW_BASE
value|0x200
end_define

begin_define
define|#
directive|define
name|WE_HIGH_BASE
value|0x3e0
end_define

begin_define
define|#
directive|define
name|WE_DEFAULT_MEM
value|0xD0000
end_define

begin_define
define|#
directive|define
name|WE_MIN_PACKET
value|64
end_define

begin_define
define|#
directive|define
name|WE_TXBUF_SIZE
value|6
end_define

begin_define
define|#
directive|define
name|WE_RXBUF_END
value|32
end_define

begin_define
define|#
directive|define
name|WE_MSR
value|0x00
end_define

begin_define
define|#
directive|define
name|WE_ICR
value|0x01
end_define

begin_define
define|#
directive|define
name|WE_IAR
value|0x02
end_define

begin_define
define|#
directive|define
name|WE_BIO
value|0x03
end_define

begin_define
define|#
directive|define
name|WE_IRR
value|0x04
end_define

begin_define
define|#
directive|define
name|WE_LAAR
value|0x05
end_define

begin_define
define|#
directive|define
name|WE_IJR
value|0x06
end_define

begin_define
define|#
directive|define
name|WE_GP2
value|0x07
end_define

begin_define
define|#
directive|define
name|WE_LAR
value|0x08
end_define

begin_define
define|#
directive|define
name|WE_BID
value|0x0E
end_define

begin_define
define|#
directive|define
name|WE_P0_COMMAND
value|0x10
end_define

begin_define
define|#
directive|define
name|WE_P0_PSTART
value|0x11
end_define

begin_define
define|#
directive|define
name|WE_P0_PSTOP
value|0x12
end_define

begin_define
define|#
directive|define
name|WE_P0_BOUND
value|0x13
end_define

begin_define
define|#
directive|define
name|WE_P0_TSR
value|0x14
end_define

begin_define
define|#
directive|define
name|WE_P0_TPSR
value|0x14
end_define

begin_define
define|#
directive|define
name|WE_P0_TBCR0
value|0x15
end_define

begin_define
define|#
directive|define
name|WE_P0_TBCR1
value|0x16
end_define

begin_define
define|#
directive|define
name|WE_P0_ISR
value|0x17
end_define

begin_define
define|#
directive|define
name|WE_P0_RBCR0
value|0x1A
end_define

begin_define
define|#
directive|define
name|WE_P0_RBCR1
value|0x1B
end_define

begin_define
define|#
directive|define
name|WE_P0_RSR
value|0x1C
end_define

begin_define
define|#
directive|define
name|WE_P0_RCR
value|0x1C
end_define

begin_define
define|#
directive|define
name|WE_P0_TCR
value|0x1D
end_define

begin_define
define|#
directive|define
name|WE_P0_DCR
value|0x1E
end_define

begin_define
define|#
directive|define
name|WE_P0_IMR
value|0x1F
end_define

begin_define
define|#
directive|define
name|WE_P1_COMMAND
value|0x10
end_define

begin_define
define|#
directive|define
name|WE_P1_PAR0
value|0x11
end_define

begin_define
define|#
directive|define
name|WE_P1_PAR1
value|0x12
end_define

begin_define
define|#
directive|define
name|WE_P1_PAR2
value|0x13
end_define

begin_define
define|#
directive|define
name|WE_P1_PAR3
value|0x14
end_define

begin_define
define|#
directive|define
name|WE_P1_PAR4
value|0x15
end_define

begin_define
define|#
directive|define
name|WE_P1_PAR5
value|0x16
end_define

begin_define
define|#
directive|define
name|WE_P1_CURR
value|0x17
end_define

begin_define
define|#
directive|define
name|WE_P1_MAR0
value|0x18
end_define

begin_define
define|#
directive|define
name|WE_COMMAND_PS0
value|0x0
end_define

begin_comment
comment|/* Page 0 select */
end_comment

begin_define
define|#
directive|define
name|WE_COMMAND_PS1
value|0x40
end_define

begin_comment
comment|/* Page 1 select */
end_comment

begin_define
define|#
directive|define
name|WE_COMMAND_PS2
value|0x80
end_define

begin_comment
comment|/* Page 2 select */
end_comment

begin_define
define|#
directive|define
name|WE_COMMAND_TXP
value|0x04
end_define

begin_comment
comment|/* transmit packet */
end_comment

begin_define
define|#
directive|define
name|WE_COMMAND_STA
value|0x02
end_define

begin_comment
comment|/* start */
end_comment

begin_define
define|#
directive|define
name|WE_COMMAND_STP
value|0x01
end_define

begin_comment
comment|/* stop */
end_comment

begin_define
define|#
directive|define
name|WE_ISR_PRX
value|0x01
end_define

begin_comment
comment|/* successful recv */
end_comment

begin_define
define|#
directive|define
name|WE_ISR_PTX
value|0x02
end_define

begin_comment
comment|/* successful xmit */
end_comment

begin_define
define|#
directive|define
name|WE_ISR_RXE
value|0x04
end_define

begin_comment
comment|/* receive error */
end_comment

begin_define
define|#
directive|define
name|WE_ISR_TXE
value|0x08
end_define

begin_comment
comment|/* transmit error */
end_comment

begin_define
define|#
directive|define
name|WE_ISR_OVW
value|0x10
end_define

begin_comment
comment|/* Overflow */
end_comment

begin_define
define|#
directive|define
name|WE_ISR_CNT
value|0x20
end_define

begin_comment
comment|/* Counter overflow */
end_comment

begin_define
define|#
directive|define
name|WE_ISR_RST
value|0x80
end_define

begin_comment
comment|/* reset */
end_comment

begin_define
define|#
directive|define
name|WE_RSTAT_PRX
value|0x01
end_define

begin_comment
comment|/* successful recv */
end_comment

begin_define
define|#
directive|define
name|WE_RSTAT_CRC
value|0x02
end_define

begin_comment
comment|/* CRC error */
end_comment

begin_define
define|#
directive|define
name|WE_RSTAT_FAE
value|0x04
end_define

begin_comment
comment|/* Frame alignment error */
end_comment

begin_define
define|#
directive|define
name|WE_RSTAT_OVER
value|0x08
end_define

begin_comment
comment|/* overflow */
end_comment

begin_decl_stmt
name|char
name|packet
index|[
literal|1600
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|packetlen
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|bit16
decl_stmt|;
end_decl_stmt

begin_comment
comment|/************************************************************************** ETH_PROBE - Look for an adapter **************************************************************************/
end_comment

begin_macro
name|eth_probe
argument_list|()
end_macro

begin_block
block|{
name|unsigned
name|short
name|base
decl_stmt|;
name|unsigned
name|short
name|chksum
decl_stmt|;
name|unsigned
name|char
name|c
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|we_base
operator|=
name|WE_LOW_BASE
init|;
name|we_base
operator|<=
name|WE_HIGH_BASE
condition|;
name|we_base
operator|+=
literal|0x20
control|)
block|{
name|chksum
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|8
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
name|chksum
operator|+=
name|inb
argument_list|(
name|i
operator|+
name|we_base
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|chksum
operator|&
literal|0x00FF
operator|)
operator|==
literal|0x00FF
condition|)
break|break;
block|}
if|if
condition|(
name|we_base
operator|>
name|WE_HIGH_BASE
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* No adapter found */
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
literal|6
condition|;
name|i
operator|++
control|)
comment|/* Look for aliased registers */
if|if
condition|(
name|inb
argument_list|(
name|we_base
operator|+
name|i
argument_list|)
operator|!=
name|inb
argument_list|(
name|we_base
operator|+
name|i
operator|+
name|WE_LAR
argument_list|)
condition|)
break|break;
if|if
condition|(
name|i
operator|==
literal|6
condition|)
block|{
comment|/* Aliased */
name|we_bmem
operator|=
operator|(
name|char
operator|*
operator|)
name|WE_DEFAULT_MEM
expr_stmt|;
name|bit16
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|we_bmem
operator|=
operator|(
name|char
operator|*
operator|)
operator|(
literal|0x80000
operator||
operator|(
operator|(
name|inb
argument_list|(
name|we_base
operator|+
name|WE_MSR
argument_list|)
operator|&
literal|0x3F
operator|)
operator|<<
literal|13
operator|)
operator|)
expr_stmt|;
name|bit16
operator|=
literal|1
expr_stmt|;
block|}
name|outb
argument_list|(
name|we_base
operator|+
name|WE_MSR
argument_list|,
literal|0x80
argument_list|)
expr_stmt|;
comment|/* Reset */
name|printf
argument_list|(
literal|"\r\nSMC80x3 base 0x%x, memory 0x%X, etheraddr "
argument_list|,
name|we_base
argument_list|,
name|we_bmem
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|6
condition|;
name|i
operator|++
control|)
name|printhb
argument_list|(
call|(
name|int
call|)
argument_list|(
name|arptable
index|[
name|ARP_CLIENT
index|]
operator|.
name|node
index|[
name|i
index|]
operator|=
name|inb
argument_list|(
name|i
operator|+
name|we_base
operator|+
name|WE_LAR
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\r\n"
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|we_base
operator|+
name|WE_MSR
argument_list|,
operator|(
operator|(
operator|(
name|unsigned
operator|)
name|we_bmem
operator|>>
literal|13
operator|)
operator|&
literal|0x3F
operator|)
operator||
literal|0x40
argument_list|)
expr_stmt|;
name|iskey
argument_list|()
expr_stmt|;
comment|/* Kill some time while device resets */
name|eth_reset
argument_list|()
expr_stmt|;
block|}
end_block

begin_comment
comment|/************************************************************************** ETH_RESET - Reset adapter **************************************************************************/
end_comment

begin_macro
name|eth_reset
argument_list|()
end_macro

begin_block
block|{
name|int
name|i
decl_stmt|;
name|outb
argument_list|(
name|we_base
operator|+
name|WE_P0_COMMAND
argument_list|,
name|WE_COMMAND_PS0
operator||
name|WE_COMMAND_STP
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|we_base
operator|+
name|WE_P0_DCR
argument_list|,
literal|0x48
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|we_base
operator|+
name|WE_P0_RBCR0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|we_base
operator|+
name|WE_P0_RBCR1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|we_base
operator|+
name|WE_P0_RCR
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/* allow broadcast frames */
name|outb
argument_list|(
name|we_base
operator|+
name|WE_P0_TCR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|we_base
operator|+
name|WE_P0_TPSR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|we_base
operator|+
name|WE_P0_PSTART
argument_list|,
name|WE_TXBUF_SIZE
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|we_base
operator|+
name|WE_P0_PSTOP
argument_list|,
name|WE_RXBUF_END
argument_list|)
expr_stmt|;
comment|/* All cards have 8K */
name|outb
argument_list|(
name|we_base
operator|+
name|WE_P0_BOUND
argument_list|,
name|WE_TXBUF_SIZE
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|we_base
operator|+
name|WE_P0_IMR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|we_base
operator|+
name|WE_P0_ISR
argument_list|,
literal|0xFF
argument_list|)
expr_stmt|;
if|if
condition|(
name|bit16
condition|)
name|outb
argument_list|(
name|we_base
operator|+
name|WE_LAAR
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* Turn off 16bit mode */
name|outb
argument_list|(
name|we_base
operator|+
name|WE_P0_COMMAND
argument_list|,
name|WE_COMMAND_PS1
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|6
condition|;
name|i
operator|++
control|)
name|outb
argument_list|(
name|we_base
operator|+
name|WE_P1_PAR0
operator|+
name|i
argument_list|,
name|inb
argument_list|(
name|we_base
operator|+
name|WE_LAR
operator|+
name|i
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|6
condition|;
name|i
operator|++
control|)
name|outb
argument_list|(
name|we_base
operator|+
name|WE_P1_MAR0
operator|+
name|i
argument_list|,
literal|0xFF
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|we_base
operator|+
name|WE_P1_CURR
argument_list|,
name|WE_TXBUF_SIZE
operator|+
literal|1
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|we_base
operator|+
name|WE_P0_COMMAND
argument_list|,
name|WE_COMMAND_PS0
operator||
name|WE_COMMAND_STA
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_block

begin_comment
comment|/************************************************************************** ETH_TRANSMIT - Transmit a frame **************************************************************************/
end_comment

begin_macro
name|eth_transmit
argument_list|(
argument|d
argument_list|,
argument|t
argument_list|,
argument|s
argument_list|,
argument|p
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|d
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Destination */
end_comment

begin_decl_stmt
name|unsigned
name|short
name|t
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Type */
end_comment

begin_decl_stmt
name|unsigned
name|short
name|s
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* size */
end_comment

begin_decl_stmt
name|char
modifier|*
name|p
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Packet */
end_comment

begin_block
block|{
name|unsigned
name|char
name|c
decl_stmt|;
name|bcopy
argument_list|(
name|d
argument_list|,
name|we_bmem
argument_list|,
literal|6
argument_list|)
expr_stmt|;
comment|/* Copy destination */
name|bcopy
argument_list|(
name|arptable
index|[
name|ARP_CLIENT
index|]
operator|.
name|node
argument_list|,
name|we_bmem
operator|+
literal|6
argument_list|,
name|ETHER_ADDR_SIZE
argument_list|)
expr_stmt|;
comment|/* My ether addr */
operator|*
operator|(
name|we_bmem
operator|+
literal|12
operator|)
operator|=
name|t
operator|>>
literal|8
expr_stmt|;
comment|/* Type field */
operator|*
operator|(
name|we_bmem
operator|+
literal|13
operator|)
operator|=
name|t
expr_stmt|;
name|bcopy
argument_list|(
name|p
argument_list|,
name|we_bmem
operator|+
literal|14
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|s
operator|+=
literal|14
expr_stmt|;
while|while
condition|(
name|s
operator|<
name|WE_MIN_PACKET
condition|)
operator|*
operator|(
name|we_bmem
operator|+
operator|(
name|s
operator|++
operator|)
operator|)
operator|=
literal|0
expr_stmt|;
name|twiddle
argument_list|()
expr_stmt|;
name|outb
argument_list|(
name|we_base
operator|+
name|WE_P0_COMMAND
argument_list|,
name|WE_COMMAND_PS0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|we_base
operator|+
name|WE_P0_TPSR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|we_base
operator|+
name|WE_P0_TBCR0
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|we_base
operator|+
name|WE_P0_TBCR1
argument_list|,
name|s
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|we_base
operator|+
name|WE_P0_COMMAND
argument_list|,
name|WE_COMMAND_PS0
operator||
name|WE_COMMAND_TXP
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_comment
comment|/************************************************************************** ETH_POLL - Wait for a frame **************************************************************************/
end_comment

begin_macro
name|eth_poll
argument_list|()
end_macro

begin_block
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|unsigned
name|short
name|type
init|=
literal|0
decl_stmt|;
name|unsigned
name|char
name|bound
decl_stmt|,
name|curr
decl_stmt|,
name|rstat
decl_stmt|;
name|unsigned
name|short
name|len
decl_stmt|;
name|unsigned
name|char
modifier|*
name|pkt
decl_stmt|,
modifier|*
name|p
decl_stmt|;
name|rstat
operator|=
name|inb
argument_list|(
name|we_base
operator|+
name|WE_P0_RSR
argument_list|)
expr_stmt|;
if|if
condition|(
name|rstat
operator|&
name|WE_RSTAT_OVER
condition|)
block|{
name|eth_reset
argument_list|()
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
operator|!
operator|(
name|rstat
operator|&
name|WE_RSTAT_PRX
operator|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|bound
operator|=
name|inb
argument_list|(
name|we_base
operator|+
name|WE_P0_BOUND
argument_list|)
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|bound
operator|==
name|WE_RXBUF_END
condition|)
name|bound
operator|=
name|WE_TXBUF_SIZE
expr_stmt|;
name|outb
argument_list|(
name|we_base
operator|+
name|WE_P0_COMMAND
argument_list|,
name|WE_COMMAND_PS1
argument_list|)
expr_stmt|;
name|curr
operator|=
name|inb
argument_list|(
name|we_base
operator|+
name|WE_P1_CURR
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|we_base
operator|+
name|WE_P0_COMMAND
argument_list|,
name|WE_COMMAND_PS0
argument_list|)
expr_stmt|;
if|if
condition|(
name|curr
operator|==
name|WE_RXBUF_END
condition|)
name|curr
operator|=
name|WE_TXBUF_SIZE
expr_stmt|;
if|if
condition|(
name|curr
operator|==
name|bound
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|pkt
operator|=
name|we_bmem
operator|+
operator|(
name|bound
operator|<<
literal|8
operator|)
expr_stmt|;
name|len
operator|=
operator|*
operator|(
operator|(
name|unsigned
name|short
operator|*
operator|)
operator|(
name|pkt
operator|+
literal|2
operator|)
operator|)
operator|-
literal|4
expr_stmt|;
comment|/* sub CRC */
if|if
condition|(
name|len
operator|>
literal|1514
condition|)
name|len
operator|=
literal|1514
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|printf
argument_list|(
literal|"[R%dS%dC%dB%dN%d]"
argument_list|,
name|len
argument_list|,
name|rstat
argument_list|,
name|curr
argument_list|,
name|bound
argument_list|,
operator|*
operator|(
name|pkt
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|bound
operator|=
operator|*
operator|(
name|pkt
operator|+
literal|1
operator|)
expr_stmt|;
comment|/* New bound ptr */
name|p
operator|=
name|packet
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|pkt
operator|&
name|WE_RSTAT_PRX
operator|)
operator|&&
operator|(
name|len
operator|>
literal|14
operator|)
operator|&&
operator|(
name|len
operator|<
literal|1518
operator|)
condition|)
block|{
name|pkt
operator|+=
literal|4
expr_stmt|;
name|packetlen
operator|=
name|len
expr_stmt|;
while|while
condition|(
name|len
condition|)
block|{
while|while
condition|(
name|len
operator|&&
operator|(
name|pkt
operator|<
operator|(
name|we_bmem
operator|+
literal|8192
operator|)
operator|)
condition|)
block|{
operator|*
operator|(
name|p
operator|++
operator|)
operator|=
operator|*
operator|(
name|pkt
operator|++
operator|)
expr_stmt|;
name|len
operator|--
expr_stmt|;
block|}
name|pkt
operator|=
name|we_bmem
operator|+
operator|(
name|WE_TXBUF_SIZE
operator|<<
literal|8
operator|)
expr_stmt|;
block|}
name|type
operator|=
operator|(
name|packet
index|[
literal|12
index|]
operator|<<
literal|8
operator|)
operator||
name|packet
index|[
literal|13
index|]
expr_stmt|;
name|ret
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|bound
operator|==
name|WE_TXBUF_SIZE
condition|)
name|bound
operator|=
name|WE_RXBUF_END
expr_stmt|;
name|outb
argument_list|(
name|we_base
operator|+
name|WE_P0_BOUND
argument_list|,
name|bound
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|&&
operator|(
name|type
operator|==
name|ARP
operator|)
condition|)
block|{
name|struct
name|arprequest
modifier|*
name|arpreq
decl_stmt|;
name|unsigned
name|long
name|reqip
decl_stmt|;
name|arpreq
operator|=
operator|(
expr|struct
name|arprequest
operator|*
operator|)
operator|&
name|packet
index|[
name|ETHER_HDR_SIZE
index|]
expr_stmt|;
name|convert_ipaddr
argument_list|(
operator|&
name|reqip
argument_list|,
name|arpreq
operator|->
name|tipaddr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ntohs
argument_list|(
name|arpreq
operator|->
name|opcode
argument_list|)
operator|==
name|ARP_REQUEST
operator|)
operator|&&
operator|(
name|reqip
operator|==
name|arptable
index|[
name|ARP_CLIENT
index|]
operator|.
name|ipaddr
operator|)
condition|)
block|{
name|arpreq
operator|->
name|opcode
operator|=
name|htons
argument_list|(
name|ARP_REPLY
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|arpreq
operator|->
name|sipaddr
argument_list|,
name|arpreq
operator|->
name|tipaddr
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|arpreq
operator|->
name|shwaddr
argument_list|,
name|arpreq
operator|->
name|thwaddr
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|arptable
index|[
name|ARP_CLIENT
index|]
operator|.
name|node
argument_list|,
name|arpreq
operator|->
name|shwaddr
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|convert_ipaddr
argument_list|(
name|arpreq
operator|->
name|sipaddr
argument_list|,
operator|&
name|reqip
argument_list|)
expr_stmt|;
name|eth_transmit
argument_list|(
name|arpreq
operator|->
name|thwaddr
argument_list|,
name|ARP
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|arprequest
argument_list|)
argument_list|,
name|arpreq
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_block

end_unit


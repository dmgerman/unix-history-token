begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/************************************************************************** NETBOOT -  BOOTP/TFTP Bootstrap Program  Author: Martin Renters   Date: Dec/93  **************************************************************************/
end_comment

begin_comment
comment|/* #define MDEBUG */
end_comment

begin_include
include|#
directive|include
file|"netboot.h"
end_include

begin_decl_stmt
name|int
name|jmp_bootmenu
index|[
literal|10
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|exec
name|head
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|loadpoint
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|kernel
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|kernel_buf
index|[
literal|128
index|]
decl_stmt|;
end_decl_stmt

begin_function_decl
name|void
function_decl|(
modifier|*
name|kernelentry
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|struct
name|nfs_diskless
name|nfsdiskless
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|hostnamelen
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|config_buffer
index|[
literal|512
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Max TFTP packet */
end_comment

begin_decl_stmt
name|struct
name|bootinfo
name|bootinfo
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|root_nfs_port
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|long
name|netmask
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|kernel_handle
index|[
literal|32
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|offset
decl_stmt|,
name|howto
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
name|eth_driver
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
name|packet
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|packetlen
decl_stmt|,
name|rpc_id
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|broadcast
index|[]
init|=
block|{
literal|0xFF
block|,
literal|0xFF
block|,
literal|0xFF
block|,
literal|0xFF
block|,
literal|0xFF
block|,
literal|0xFF
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/************************************************************************** MAIN - Kick off routine **************************************************************************/
end_comment

begin_function
name|main
parameter_list|()
block|{
name|int
name|c
decl_stmt|;
specifier|extern
name|char
name|edata
index|[]
decl_stmt|,
name|end
index|[]
decl_stmt|;
name|bzero
argument_list|(
name|edata
argument_list|,
name|end
operator|-
name|edata
argument_list|)
expr_stmt|;
comment|/* Zero BSS */
ifdef|#
directive|ifdef
name|ASK_BOOT
while|while
condition|(
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"\nBoot from Network (Y/N) ? "
argument_list|)
expr_stmt|;
name|c
operator|=
name|getchar
argument_list|()
expr_stmt|;
if|if
condition|(
operator|(
name|c
operator|>=
literal|'a'
operator|)
operator|&&
operator|(
name|c
operator|<=
literal|'z'
operator|)
condition|)
name|c
operator|&=
literal|0x5F
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|'\r'
condition|)
break|break;
name|putchar
argument_list|(
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|'N'
condition|)
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|'Y'
condition|)
break|break;
name|printf
argument_list|(
literal|" - bad response\n\r"
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* get the bios's idea about the disks geometry */
for|for
control|(
name|c
operator|=
literal|0
init|;
name|c
operator|<
name|N_BIOS_GEOM
condition|;
name|c
operator|++
control|)
name|bootinfo
operator|.
name|bi_bios_geom
index|[
name|c
index|]
operator|=
name|get_diskinfo
argument_list|(
name|c
operator|+
literal|0x80
argument_list|)
expr_stmt|;
name|gateA20
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"\nBOOTP/TFTP/NFS bootstrap loader    ESC for menu\n"
literal|"\nSearching for adapter..."
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|eth_probe
argument_list|()
condition|)
block|{
name|printf
argument_list|(
literal|"No adapter found.\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|kernel
operator|=
name|DEFAULT_BOOTFILE
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
if|if
condition|(
name|setjmp
argument_list|(
name|jmp_bootmenu
argument_list|)
condition|)
name|bootmenu
argument_list|()
expr_stmt|;
else|else
name|load
argument_list|()
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|nfsload
parameter_list|(
name|length
parameter_list|)
block|{
name|int
name|err
decl_stmt|,
name|read_size
decl_stmt|;
while|while
condition|(
name|length
operator|>
literal|0
condition|)
block|{
name|read_size
operator|=
name|length
operator|>
name|NFS_READ_SIZE
condition|?
name|NFS_READ_SIZE
else|:
name|length
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|nfs_read
argument_list|(
name|ARP_ROOTSERVER
argument_list|,
name|root_nfs_port
argument_list|,
operator|&
name|kernel_handle
argument_list|,
name|offset
argument_list|,
name|read_size
argument_list|,
name|loadpoint
argument_list|)
operator|)
operator|!=
name|read_size
condition|)
block|{
if|if
condition|(
name|err
operator|<
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Unable to read data: "
argument_list|)
expr_stmt|;
name|nfs_err
argument_list|(
name|err
argument_list|)
expr_stmt|;
block|}
name|longjmp
argument_list|(
name|jmp_bootmenu
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|loadpoint
operator|+=
name|err
expr_stmt|;
name|length
operator|-=
name|err
expr_stmt|;
name|offset
operator|+=
name|err
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/************************************************************************** LOAD - Try to get booted **************************************************************************/
end_comment

begin_macro
name|load
argument_list|()
end_macro

begin_block
block|{
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
name|q
decl_stmt|;
name|char
name|cfg
index|[
literal|64
index|]
decl_stmt|;
name|int
name|root_mount_port
decl_stmt|;
name|int
name|swap_nfs_port
decl_stmt|;
name|int
name|swap_mount_port
decl_stmt|;
name|char
name|cmd_line
index|[
literal|80
index|]
decl_stmt|;
name|int
name|err
decl_stmt|,
name|read_size
decl_stmt|,
name|i
decl_stmt|;
name|long
name|addr
decl_stmt|,
name|broadcast
decl_stmt|;
name|int
name|swsize
decl_stmt|;
name|unsigned
name|long
name|pad
decl_stmt|;
name|config_buffer
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
comment|/* clear; bootp might fill this up */
comment|/* Initialize this early on */
name|nfsdiskless
operator|.
name|root_args
operator|.
name|rsize
operator|=
literal|8192
expr_stmt|;
name|nfsdiskless
operator|.
name|root_args
operator|.
name|wsize
operator|=
literal|8192
expr_stmt|;
name|nfsdiskless
operator|.
name|swap_args
operator|.
name|rsize
operator|=
literal|8192
expr_stmt|;
name|nfsdiskless
operator|.
name|swap_args
operator|.
name|wsize
operator|=
literal|8192
expr_stmt|;
name|nfsdiskless
operator|.
name|root_args
operator|.
name|sotype
operator|=
name|SOCK_DGRAM
expr_stmt|;
name|nfsdiskless
operator|.
name|root_args
operator|.
name|flags
operator|=
operator|(
name|NFSMNT_WSIZE
operator||
name|NFSMNT_RSIZE
operator||
name|NFSMNT_RESVPORT
operator|)
expr_stmt|;
name|nfsdiskless
operator|.
name|swap_args
operator|.
name|sotype
operator|=
name|SOCK_DGRAM
expr_stmt|;
name|nfsdiskless
operator|.
name|swap_args
operator|.
name|flags
operator|=
operator|(
name|NFSMNT_WSIZE
operator||
name|NFSMNT_RSIZE
operator||
name|NFSMNT_RESVPORT
operator|)
expr_stmt|;
comment|/* Find a server to get BOOTP reply from */
if|if
condition|(
operator|!
name|arptable
index|[
name|ARP_CLIENT
index|]
operator|.
name|ipaddr
operator|||
operator|!
name|arptable
index|[
name|ARP_SERVER
index|]
operator|.
name|ipaddr
condition|)
block|{
name|printf
argument_list|(
literal|"\r\nSearching for server...\r\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bootp
argument_list|()
condition|)
block|{
name|printf
argument_list|(
literal|"No Server found.\r\n"
argument_list|)
expr_stmt|;
name|longjmp
argument_list|(
name|jmp_bootmenu
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
name|printf
argument_list|(
literal|"My IP %I, Server IP %I, GW IP %I\r\n"
argument_list|,
name|arptable
index|[
name|ARP_CLIENT
index|]
operator|.
name|ipaddr
argument_list|,
name|arptable
index|[
name|ARP_SERVER
index|]
operator|.
name|ipaddr
argument_list|,
name|arptable
index|[
name|ARP_GATEWAY
index|]
operator|.
name|ipaddr
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MDEBUG
name|printf
argument_list|(
literal|"\n=>>"
argument_list|)
expr_stmt|;
name|getchar
argument_list|()
expr_stmt|;
endif|#
directive|endif
comment|/*** check if have got info from bootp ***/
if|if
condition|(
name|config_buffer
index|[
literal|0
index|]
condition|)
goto|goto
name|cfg_done
goto|;
ifndef|#
directive|ifndef
name|NO_TFTP
comment|/* Now use TFTP to load configuration file */
name|sprintf
argument_list|(
name|cfg
argument_list|,
literal|"/tftpboot/freebsd.%I"
argument_list|,
name|arptable
index|[
name|ARP_CLIENT
index|]
operator|.
name|ipaddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|tftp
argument_list|(
name|cfg
argument_list|)
operator|||
name|tftp
argument_list|(
name|cfg
operator|+
literal|10
argument_list|)
condition|)
goto|goto
name|cfg_done
goto|;
name|cfg
index|[
literal|17
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|tftp
argument_list|(
name|cfg
argument_list|)
operator|||
name|tftp
argument_list|(
name|cfg
operator|+
literal|10
argument_list|)
condition|)
goto|goto
name|cfg_done
goto|;
name|sprintf
argument_list|(
name|cfg
argument_list|,
literal|"/tftpboot/cfg.%I"
argument_list|,
name|arptable
index|[
name|ARP_CLIENT
index|]
operator|.
name|ipaddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|tftp
argument_list|(
name|cfg
argument_list|)
operator|||
name|tftp
argument_list|(
name|cfg
operator|+
literal|10
argument_list|)
condition|)
goto|goto
name|cfg_done
goto|;
endif|#
directive|endif
comment|/* not found; using default values... */
name|sprintf
argument_list|(
name|config_buffer
argument_list|,
literal|"rootfs %I:/usr/diskless_root"
argument_list|,
name|arptable
index|[
name|ARP_SERVER
index|]
operator|.
name|ipaddr
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Unable to load config file, guessing:\r\n\t%s\r\n"
argument_list|,
name|config_buffer
argument_list|)
expr_stmt|;
name|cfg_done
label|:
ifdef|#
directive|ifdef
name|MDEBUG
name|printf
argument_list|(
literal|"\n=>>"
argument_list|)
expr_stmt|;
name|getchar
argument_list|()
expr_stmt|;
endif|#
directive|endif
name|p
operator|=
name|config_buffer
expr_stmt|;
while|while
condition|(
operator|*
name|p
condition|)
block|{
name|q
operator|=
name|cmd_line
expr_stmt|;
while|while
condition|(
operator|(
operator|*
name|p
operator|!=
literal|'\n'
operator|)
operator|&&
operator|(
operator|*
name|p
operator|)
condition|)
operator|*
operator|(
name|q
operator|++
operator|)
operator|=
operator|*
operator|(
name|p
operator|++
operator|)
expr_stmt|;
operator|*
name|q
operator|=
literal|0
expr_stmt|;
name|printf
argument_list|(
literal|"%s\r\n"
argument_list|,
name|cmd_line
argument_list|)
expr_stmt|;
name|execute
argument_list|(
name|cmd_line
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|p
condition|)
name|p
operator|++
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|MDEBUG
name|printf
argument_list|(
literal|"\n=>>"
argument_list|)
expr_stmt|;
name|getchar
argument_list|()
expr_stmt|;
endif|#
directive|endif
comment|/* Check to make sure we've got a rootfs */
if|if
condition|(
operator|!
name|arptable
index|[
name|ARP_ROOTSERVER
index|]
operator|.
name|ipaddr
condition|)
block|{
name|printf
argument_list|(
literal|"No ROOT filesystem server!\r\n"
argument_list|)
expr_stmt|;
name|longjmp
argument_list|(
name|jmp_bootmenu
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* Fill in nfsdiskless.myif */
name|sprintf
argument_list|(
operator|&
name|nfsdiskless
operator|.
name|myif
operator|.
name|ifra_name
argument_list|,
name|eth_driver
argument_list|)
expr_stmt|;
name|nfsdiskless
operator|.
name|myif
operator|.
name|ifra_addr
operator|.
name|sa_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr
argument_list|)
expr_stmt|;
name|nfsdiskless
operator|.
name|myif
operator|.
name|ifra_addr
operator|.
name|sa_family
operator|=
name|AF_INET
expr_stmt|;
name|addr
operator|=
name|htonl
argument_list|(
name|arptable
index|[
name|ARP_CLIENT
index|]
operator|.
name|ipaddr
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|&
name|addr
argument_list|,
operator|&
name|nfsdiskless
operator|.
name|myif
operator|.
name|ifra_addr
operator|.
name|sa_data
index|[
literal|2
index|]
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|broadcast
operator|=
operator|(
name|addr
operator|&
name|netmask
operator|)
operator||
operator|~
name|netmask
expr_stmt|;
name|nfsdiskless
operator|.
name|myif
operator|.
name|ifra_broadaddr
operator|.
name|sa_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr
argument_list|)
expr_stmt|;
name|nfsdiskless
operator|.
name|myif
operator|.
name|ifra_broadaddr
operator|.
name|sa_family
operator|=
name|AF_INET
expr_stmt|;
name|bcopy
argument_list|(
operator|&
name|broadcast
argument_list|,
operator|&
name|nfsdiskless
operator|.
name|myif
operator|.
name|ifra_broadaddr
operator|.
name|sa_data
index|[
literal|2
index|]
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|addr
operator|=
name|htonl
argument_list|(
name|arptable
index|[
name|ARP_GATEWAY
index|]
operator|.
name|ipaddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|addr
condition|)
block|{
name|nfsdiskless
operator|.
name|mygateway
operator|.
name|sin_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr
argument_list|)
expr_stmt|;
name|nfsdiskless
operator|.
name|mygateway
operator|.
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|bcopy
argument_list|(
operator|&
name|addr
argument_list|,
operator|&
name|nfsdiskless
operator|.
name|mygateway
operator|.
name|sin_addr
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|nfsdiskless
operator|.
name|mygateway
operator|.
name|sin_len
operator|=
literal|0
expr_stmt|;
block|}
name|nfsdiskless
operator|.
name|myif
operator|.
name|ifra_mask
operator|.
name|sa_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr
argument_list|)
expr_stmt|;
name|nfsdiskless
operator|.
name|myif
operator|.
name|ifra_mask
operator|.
name|sa_family
operator|=
name|AF_UNSPEC
expr_stmt|;
name|bcopy
argument_list|(
operator|&
name|netmask
argument_list|,
operator|&
name|nfsdiskless
operator|.
name|myif
operator|.
name|ifra_mask
operator|.
name|sa_data
index|[
literal|2
index|]
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|rpc_id
operator|=
name|currticks
argument_list|()
expr_stmt|;
comment|/* Lookup NFS/MOUNTD ports for SWAP using PORTMAP */
if|if
condition|(
name|arptable
index|[
name|ARP_SWAPSERVER
index|]
operator|.
name|ipaddr
condition|)
block|{
name|char
name|swapfs_fh
index|[
literal|32
index|]
decl_stmt|,
name|swapfile
index|[
literal|32
index|]
decl_stmt|;
name|swap_nfs_port
operator|=
name|rpclookup
argument_list|(
name|ARP_SWAPSERVER
argument_list|,
name|PROG_NFS
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|swap_mount_port
operator|=
name|rpclookup
argument_list|(
name|ARP_SWAPSERVER
argument_list|,
name|PROG_MOUNT
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|swap_nfs_port
operator|==
operator|-
literal|1
operator|)
operator|||
operator|(
name|swap_mount_port
operator|==
operator|-
literal|1
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"Unable to get SWAP NFS/MOUNT ports\r\n"
argument_list|)
expr_stmt|;
name|longjmp
argument_list|(
name|jmp_bootmenu
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|err
operator|=
name|nfs_mount
argument_list|(
name|ARP_SWAPSERVER
argument_list|,
name|swap_mount_port
argument_list|,
name|nfsdiskless
operator|.
name|swap_hostnam
argument_list|,
operator|&
name|swapfs_fh
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Unable to mount SWAP filesystem: "
argument_list|)
expr_stmt|;
name|nfs_err
argument_list|(
name|err
argument_list|)
expr_stmt|;
name|longjmp
argument_list|(
name|jmp_bootmenu
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|sprintf
argument_list|(
name|swapfile
argument_list|,
literal|"swap.%I"
argument_list|,
name|arptable
index|[
name|ARP_CLIENT
index|]
operator|.
name|ipaddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|=
name|nfs_lookup
argument_list|(
name|ARP_SWAPSERVER
argument_list|,
name|swap_nfs_port
argument_list|,
operator|&
name|swapfs_fh
argument_list|,
name|swapfile
argument_list|,
operator|&
name|nfsdiskless
operator|.
name|swap_fh
argument_list|,
operator|&
name|swsize
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Unable to open %s: "
argument_list|,
name|swapfile
argument_list|)
expr_stmt|;
name|nfs_err
argument_list|(
name|err
argument_list|)
expr_stmt|;
name|longjmp
argument_list|(
name|jmp_bootmenu
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|nfsdiskless
operator|.
name|swap_nblks
condition|)
block|{
name|nfsdiskless
operator|.
name|swap_nblks
operator|=
name|swsize
operator|/
literal|1024
expr_stmt|;
name|printf
argument_list|(
literal|"Swap size is: %d blocks\n"
argument_list|,
name|nfsdiskless
operator|.
name|swap_nblks
argument_list|)
expr_stmt|;
block|}
name|nfsdiskless
operator|.
name|swap_saddr
operator|.
name|sin_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
expr_stmt|;
name|nfsdiskless
operator|.
name|swap_saddr
operator|.
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|nfsdiskless
operator|.
name|swap_saddr
operator|.
name|sin_port
operator|=
name|htons
argument_list|(
name|swap_nfs_port
argument_list|)
expr_stmt|;
name|nfsdiskless
operator|.
name|swap_saddr
operator|.
name|sin_addr
operator|.
name|s_addr
operator|=
name|htonl
argument_list|(
name|arptable
index|[
name|ARP_SWAPSERVER
index|]
operator|.
name|ipaddr
argument_list|)
expr_stmt|;
name|nfsdiskless
operator|.
name|swap_args
operator|.
name|timeo
operator|=
literal|10
expr_stmt|;
name|nfsdiskless
operator|.
name|swap_args
operator|.
name|retrans
operator|=
literal|100
expr_stmt|;
block|}
comment|/* Lookup NFS/MOUNTD ports for ROOT using PORTMAP */
name|root_nfs_port
operator|=
name|rpclookup
argument_list|(
name|ARP_ROOTSERVER
argument_list|,
name|PROG_NFS
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|root_mount_port
operator|=
name|rpclookup
argument_list|(
name|ARP_ROOTSERVER
argument_list|,
name|PROG_MOUNT
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|root_nfs_port
operator|==
operator|-
literal|1
operator|)
operator|||
operator|(
name|root_mount_port
operator|==
operator|-
literal|1
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"Unable to get ROOT NFS/MOUNT ports\r\n"
argument_list|)
expr_stmt|;
name|longjmp
argument_list|(
name|jmp_bootmenu
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|err
operator|=
name|nfs_mount
argument_list|(
name|ARP_ROOTSERVER
argument_list|,
name|root_mount_port
argument_list|,
name|nfsdiskless
operator|.
name|root_hostnam
argument_list|,
operator|&
name|nfsdiskless
operator|.
name|root_fh
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Unable to mount ROOT filesystem: "
argument_list|)
expr_stmt|;
name|nfs_err
argument_list|(
name|err
argument_list|)
expr_stmt|;
name|longjmp
argument_list|(
name|jmp_bootmenu
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|nfsdiskless
operator|.
name|root_saddr
operator|.
name|sin_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
expr_stmt|;
name|nfsdiskless
operator|.
name|root_saddr
operator|.
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|nfsdiskless
operator|.
name|root_saddr
operator|.
name|sin_port
operator|=
name|htons
argument_list|(
name|root_nfs_port
argument_list|)
expr_stmt|;
name|nfsdiskless
operator|.
name|root_saddr
operator|.
name|sin_addr
operator|.
name|s_addr
operator|=
name|htonl
argument_list|(
name|arptable
index|[
name|ARP_ROOTSERVER
index|]
operator|.
name|ipaddr
argument_list|)
expr_stmt|;
name|nfsdiskless
operator|.
name|root_args
operator|.
name|timeo
operator|=
literal|10
expr_stmt|;
name|nfsdiskless
operator|.
name|root_args
operator|.
name|retrans
operator|=
literal|100
expr_stmt|;
name|nfsdiskless
operator|.
name|root_time
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|err
operator|=
name|nfs_lookup
argument_list|(
name|ARP_ROOTSERVER
argument_list|,
name|root_nfs_port
argument_list|,
operator|&
name|nfsdiskless
operator|.
name|root_fh
argument_list|,
operator|*
name|kernel
operator|==
literal|'/'
condition|?
name|kernel
operator|+
literal|1
else|:
name|kernel
argument_list|,
operator|&
name|kernel_handle
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Unable to open %s: "
argument_list|,
name|kernel
argument_list|)
expr_stmt|;
name|nfs_err
argument_list|(
name|err
argument_list|)
expr_stmt|;
name|longjmp
argument_list|(
name|jmp_bootmenu
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* Load the kernel using NFS */
name|printf
argument_list|(
literal|"Loading %s...\r\n"
argument_list|,
name|kernel
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|nfs_read
argument_list|(
name|ARP_ROOTSERVER
argument_list|,
name|root_nfs_port
argument_list|,
operator|&
name|kernel_handle
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|exec
argument_list|)
argument_list|,
operator|&
name|head
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Unable to read %s: "
argument_list|,
name|kernel
argument_list|)
expr_stmt|;
name|nfs_err
argument_list|(
name|err
argument_list|)
expr_stmt|;
name|longjmp
argument_list|(
name|jmp_bootmenu
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|N_BADMAG
argument_list|(
name|head
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Bad executable format!\r\n"
argument_list|)
expr_stmt|;
name|longjmp
argument_list|(
name|jmp_bootmenu
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|loadpoint
operator|=
operator|(
name|char
operator|*
operator|)
literal|0x100000
expr_stmt|;
name|offset
operator|=
name|N_TXTOFF
argument_list|(
name|head
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"text=0x%X, "
argument_list|,
name|head
operator|.
name|a_text
argument_list|)
expr_stmt|;
name|nfsload
argument_list|(
name|head
operator|.
name|a_text
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
operator|(
name|int
operator|)
name|loadpoint
operator|)
operator|&
name|PAGE_MASK
condition|)
operator|*
operator|(
name|loadpoint
operator|++
operator|)
operator|=
literal|0
expr_stmt|;
name|printf
argument_list|(
literal|"data=0x%X, "
argument_list|,
name|head
operator|.
name|a_data
argument_list|)
expr_stmt|;
name|nfsload
argument_list|(
name|head
operator|.
name|a_data
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"bss=0x%X, "
argument_list|,
name|head
operator|.
name|a_bss
argument_list|)
expr_stmt|;
while|while
condition|(
name|head
operator|.
name|a_bss
operator|--
condition|)
operator|*
operator|(
name|loadpoint
operator|++
operator|)
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
operator|(
name|int
operator|)
name|loadpoint
operator|)
operator|&
name|PAGE_MASK
condition|)
operator|*
operator|(
name|loadpoint
operator|++
operator|)
operator|=
literal|0
expr_stmt|;
name|bootinfo
operator|.
name|bi_symtab
operator|=
operator|(
name|int
operator|)
name|loadpoint
expr_stmt|;
name|p
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
name|head
operator|.
name|a_syms
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|head
operator|.
name|a_syms
argument_list|)
condition|;
name|i
operator|++
control|)
operator|*
name|loadpoint
operator|++
operator|=
operator|*
name|p
operator|++
expr_stmt|;
name|printf
argument_list|(
literal|"symbols=[+0x%x+0x%x"
argument_list|,
sizeof|sizeof
argument_list|(
name|head
operator|.
name|a_syms
argument_list|)
argument_list|,
name|head
operator|.
name|a_syms
argument_list|)
expr_stmt|;
name|nfsload
argument_list|(
name|head
operator|.
name|a_syms
argument_list|)
expr_stmt|;
name|i
operator|=
sizeof|sizeof
argument_list|(
name|int
argument_list|)
expr_stmt|;
name|p
operator|=
name|loadpoint
expr_stmt|;
name|nfsload
argument_list|(
name|i
argument_list|)
expr_stmt|;
name|i
operator|=
operator|*
operator|(
name|int
operator|*
operator|)
name|p
expr_stmt|;
name|printf
argument_list|(
literal|"+0x%x]\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|i
operator|-=
sizeof|sizeof
argument_list|(
name|int
argument_list|)
expr_stmt|;
name|nfsload
argument_list|(
name|i
argument_list|)
expr_stmt|;
name|bootinfo
operator|.
name|bi_esymtab
operator|=
operator|(
name|int
operator|)
name|loadpoint
expr_stmt|;
name|printf
argument_list|(
literal|"entry=0x%X.\n\r"
argument_list|,
name|head
operator|.
name|a_entry
argument_list|)
expr_stmt|;
comment|/* Jump to kernel */
name|bootinfo
operator|.
name|bi_version
operator|=
name|BOOTINFO_VERSION
expr_stmt|;
name|bootinfo
operator|.
name|bi_kernelname
operator|=
name|kernel
expr_stmt|;
name|bootinfo
operator|.
name|bi_nfs_diskless
operator|=
operator|&
name|nfsdiskless
expr_stmt|;
name|bootinfo
operator|.
name|bi_size
operator|=
sizeof|sizeof
name|bootinfo
expr_stmt|;
name|kernelentry
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
name|head
operator|.
name|a_entry
operator|&
literal|0x00FFFFFF
operator|)
expr_stmt|;
call|(
modifier|*
name|kernelentry
call|)
argument_list|(
name|howto
operator||
name|RB_BOOTINFO
argument_list|,
name|NODEV
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|bootinfo
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"*** %s execute failure ***\n"
argument_list|,
name|kernel
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/************************************************************************** POLLKBD - Check for Interrupt from keyboard **************************************************************************/
end_comment

begin_macro
name|pollkbd
argument_list|()
end_macro

begin_block
block|{
if|if
condition|(
name|iskey
argument_list|()
operator|&&
operator|(
name|getchar
argument_list|()
operator|==
name|ESC
operator|)
condition|)
name|longjmp
argument_list|(
name|jmp_bootmenu
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/************************************************************************** DEFAULT_NETMASK - Set a default netmask for IP address **************************************************************************/
end_comment

begin_macro
name|default_netmask
argument_list|()
end_macro

begin_block
block|{
name|int
name|net
init|=
name|arptable
index|[
name|ARP_CLIENT
index|]
operator|.
name|ipaddr
operator|>>
literal|24
decl_stmt|;
if|if
condition|(
name|net
operator|<=
literal|127
condition|)
name|netmask
operator|=
name|htonl
argument_list|(
literal|0xff000000
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|net
operator|<
literal|192
condition|)
name|netmask
operator|=
name|htonl
argument_list|(
literal|0xffff0000
argument_list|)
expr_stmt|;
else|else
name|netmask
operator|=
name|htonl
argument_list|(
literal|0xffffff00
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/************************************************************************** UDP_TRANSMIT - Send a UDP datagram **************************************************************************/
end_comment

begin_macro
name|udp_transmit
argument_list|(
argument|destip
argument_list|,
argument|srcsock
argument_list|,
argument|destsock
argument_list|,
argument|len
argument_list|,
argument|buf
argument_list|)
end_macro

begin_decl_stmt
name|unsigned
name|long
name|destip
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|short
name|srcsock
decl_stmt|,
name|destsock
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|len
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|buf
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|iphdr
modifier|*
name|ip
decl_stmt|;
name|struct
name|udphdr
modifier|*
name|udp
decl_stmt|;
name|struct
name|arprequest
name|arpreq
decl_stmt|;
name|int
name|arpentry
decl_stmt|,
name|i
decl_stmt|;
name|unsigned
name|long
name|time
decl_stmt|;
name|int
name|retry
init|=
name|MAX_ARP_RETRIES
decl_stmt|;
name|ip
operator|=
operator|(
expr|struct
name|iphdr
operator|*
operator|)
name|buf
expr_stmt|;
name|udp
operator|=
operator|(
expr|struct
name|udphdr
operator|*
operator|)
operator|(
name|buf
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|iphdr
argument_list|)
operator|)
expr_stmt|;
name|ip
operator|->
name|verhdrlen
operator|=
literal|0x45
expr_stmt|;
name|ip
operator|->
name|service
operator|=
literal|0
expr_stmt|;
name|ip
operator|->
name|len
operator|=
name|htons
argument_list|(
name|len
argument_list|)
expr_stmt|;
name|ip
operator|->
name|ident
operator|=
literal|0
expr_stmt|;
name|ip
operator|->
name|frags
operator|=
literal|0
expr_stmt|;
name|ip
operator|->
name|ttl
operator|=
literal|60
expr_stmt|;
name|ip
operator|->
name|protocol
operator|=
name|IP_UDP
expr_stmt|;
name|ip
operator|->
name|chksum
operator|=
literal|0
expr_stmt|;
name|convert_ipaddr
argument_list|(
name|ip
operator|->
name|src
argument_list|,
operator|&
name|arptable
index|[
name|ARP_CLIENT
index|]
operator|.
name|ipaddr
argument_list|)
expr_stmt|;
name|convert_ipaddr
argument_list|(
name|ip
operator|->
name|dest
argument_list|,
operator|&
name|destip
argument_list|)
expr_stmt|;
name|ip
operator|->
name|chksum
operator|=
name|ipchksum
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|iphdr
argument_list|)
argument_list|)
expr_stmt|;
name|udp
operator|->
name|src
operator|=
name|htons
argument_list|(
name|srcsock
argument_list|)
expr_stmt|;
name|udp
operator|->
name|dest
operator|=
name|htons
argument_list|(
name|destsock
argument_list|)
expr_stmt|;
name|udp
operator|->
name|len
operator|=
name|htons
argument_list|(
name|len
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|iphdr
argument_list|)
argument_list|)
expr_stmt|;
name|udp
operator|->
name|chksum
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|destip
operator|==
name|IP_BROADCAST
condition|)
block|{
name|eth_transmit
argument_list|(
name|broadcast
argument_list|,
name|IP
argument_list|,
name|len
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|long
name|h_netmask
init|=
name|ntohl
argument_list|(
name|netmask
argument_list|)
decl_stmt|;
comment|/* Check to see if we need gateway */
if|if
condition|(
operator|(
operator|(
name|destip
operator|&
name|h_netmask
operator|)
operator|!=
operator|(
name|arptable
index|[
name|ARP_CLIENT
index|]
operator|.
name|ipaddr
operator|&
name|h_netmask
operator|)
operator|)
operator|&&
name|arptable
index|[
name|ARP_GATEWAY
index|]
operator|.
name|ipaddr
condition|)
name|destip
operator|=
name|arptable
index|[
name|ARP_GATEWAY
index|]
operator|.
name|ipaddr
expr_stmt|;
for|for
control|(
name|arpentry
operator|=
literal|0
init|;
name|arpentry
operator|<
name|MAX_ARP
condition|;
name|arpentry
operator|++
control|)
if|if
condition|(
name|arptable
index|[
name|arpentry
index|]
operator|.
name|ipaddr
operator|==
name|destip
condition|)
break|break;
if|if
condition|(
name|arpentry
operator|==
name|MAX_ARP
condition|)
block|{
name|printf
argument_list|(
literal|"%I is not in my arp table!\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ETHER_ADDR_LEN
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|arptable
index|[
name|arpentry
index|]
operator|.
name|node
index|[
name|i
index|]
condition|)
break|break;
if|if
condition|(
name|i
operator|==
name|ETHER_ADDR_LEN
condition|)
block|{
comment|/* Need to do arp request */
name|arpreq
operator|.
name|hwtype
operator|=
name|htons
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|arpreq
operator|.
name|protocol
operator|=
name|htons
argument_list|(
name|IP
argument_list|)
expr_stmt|;
name|arpreq
operator|.
name|hwlen
operator|=
name|ETHER_ADDR_LEN
expr_stmt|;
name|arpreq
operator|.
name|protolen
operator|=
literal|4
expr_stmt|;
name|arpreq
operator|.
name|opcode
operator|=
name|htons
argument_list|(
name|ARP_REQUEST
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|arptable
index|[
name|ARP_CLIENT
index|]
operator|.
name|node
argument_list|,
name|arpreq
operator|.
name|shwaddr
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|convert_ipaddr
argument_list|(
name|arpreq
operator|.
name|sipaddr
argument_list|,
operator|&
name|arptable
index|[
name|ARP_CLIENT
index|]
operator|.
name|ipaddr
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|arpreq
operator|.
name|thwaddr
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|convert_ipaddr
argument_list|(
name|arpreq
operator|.
name|tipaddr
argument_list|,
operator|&
name|destip
argument_list|)
expr_stmt|;
while|while
condition|(
name|retry
operator|--
condition|)
block|{
name|eth_transmit
argument_list|(
name|broadcast
argument_list|,
name|ARP
argument_list|,
sizeof|sizeof
argument_list|(
name|arpreq
argument_list|)
argument_list|,
operator|&
name|arpreq
argument_list|)
expr_stmt|;
if|if
condition|(
name|await_reply
argument_list|(
name|AWAIT_ARP
argument_list|,
name|arpentry
argument_list|,
name|arpreq
operator|.
name|tipaddr
argument_list|)
condition|)
goto|goto
name|xmit
goto|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|xmit
label|:
name|eth_transmit
argument_list|(
name|arptable
index|[
name|arpentry
index|]
operator|.
name|node
argument_list|,
name|IP
argument_list|,
name|len
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_block

begin_comment
comment|/************************************************************************** TFTP - Try to load configuation file **************************************************************************/
end_comment

begin_macro
name|tftp
argument_list|(
argument|name
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|name
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|tftp_t
modifier|*
name|tr
decl_stmt|;
name|int
name|retry
init|=
name|MAX_TFTP_RETRIES
decl_stmt|;
specifier|static
name|unsigned
name|short
name|isocket
init|=
literal|2000
decl_stmt|;
name|unsigned
name|short
name|osocket
init|=
name|TFTP
decl_stmt|;
name|unsigned
name|short
name|len
decl_stmt|,
name|block
init|=
literal|1
decl_stmt|;
name|struct
name|tftp_t
name|tp
decl_stmt|;
name|int
name|code
decl_stmt|;
name|printf
argument_list|(
literal|"Loading %s...\r\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|isocket
operator|++
expr_stmt|;
name|tp
operator|.
name|opcode
operator|=
name|htons
argument_list|(
name|TFTP_RRQ
argument_list|)
expr_stmt|;
name|len
operator|=
operator|(
name|sprintf
argument_list|(
operator|(
name|char
operator|*
operator|)
name|tp
operator|.
name|u
operator|.
name|rrq
argument_list|,
literal|"%s%c%s"
argument_list|,
name|name
argument_list|,
literal|0
argument_list|,
literal|"octet"
argument_list|)
operator|-
operator|(
operator|(
name|char
operator|*
operator|)
operator|&
name|tp
operator|)
operator|)
operator|+
literal|1
expr_stmt|;
while|while
condition|(
name|retry
operator|--
condition|)
block|{
if|if
condition|(
operator|!
name|udp_transmit
argument_list|(
name|arptable
index|[
name|ARP_SERVER
index|]
operator|.
name|ipaddr
argument_list|,
name|isocket
argument_list|,
name|osocket
argument_list|,
name|len
argument_list|,
operator|&
name|tp
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|await_reply
argument_list|(
name|AWAIT_TFTP
argument_list|,
name|isocket
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|tr
operator|=
operator|(
expr|struct
name|tftp_t
operator|*
operator|)
operator|&
name|packet
index|[
name|ETHER_HDR_LEN
index|]
expr_stmt|;
if|if
condition|(
name|tr
operator|->
name|opcode
operator|==
name|ntohs
argument_list|(
name|TFTP_ERROR
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"TFTP error %d (%s)\r\n"
argument_list|,
name|ntohs
argument_list|(
name|tr
operator|->
name|u
operator|.
name|err
operator|.
name|errcode
argument_list|)
argument_list|,
name|tr
operator|->
name|u
operator|.
name|err
operator|.
name|errmsg
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
comment|/* ACK PACKET */
if|if
condition|(
name|tr
operator|->
name|opcode
operator|!=
name|ntohs
argument_list|(
name|TFTP_DATA
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|tp
operator|.
name|opcode
operator|=
name|htons
argument_list|(
name|TFTP_ACK
argument_list|)
expr_stmt|;
name|tp
operator|.
name|u
operator|.
name|ack
operator|.
name|block
operator|=
name|tr
operator|->
name|u
operator|.
name|data
operator|.
name|block
expr_stmt|;
name|udp_transmit
argument_list|(
name|arptable
index|[
name|ARP_SERVER
index|]
operator|.
name|ipaddr
argument_list|,
name|isocket
argument_list|,
name|osocket
argument_list|,
name|TFTP_MIN_PACKET_SIZE
argument_list|,
operator|&
name|tp
argument_list|)
expr_stmt|;
name|len
operator|=
name|ntohs
argument_list|(
name|tr
operator|->
name|udp
operator|.
name|len
argument_list|)
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|udphdr
argument_list|)
operator|-
literal|4
expr_stmt|;
if|if
condition|(
name|len
operator|>=
literal|512
condition|)
block|{
name|printf
argument_list|(
literal|"Config file too large.\r\n"
argument_list|)
expr_stmt|;
name|config_buffer
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
else|else
block|{
name|bcopy
argument_list|(
name|tr
operator|->
name|u
operator|.
name|data
operator|.
name|download
argument_list|,
name|config_buffer
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|config_buffer
index|[
name|len
index|]
operator|=
literal|0
expr_stmt|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_comment
comment|/************************************************************************** BOOTP - Get my IP address and load information **************************************************************************/
end_comment

begin_macro
name|bootp
argument_list|()
end_macro

begin_block
block|{
name|int
name|retry
init|=
name|MAX_BOOTP_RETRIES
decl_stmt|;
name|struct
name|bootp_t
name|bp
decl_stmt|;
name|unsigned
name|long
name|starttime
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|bp
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|bootp_t
argument_list|)
argument_list|)
expr_stmt|;
name|bp
operator|.
name|bp_op
operator|=
name|BOOTP_REQUEST
expr_stmt|;
name|bp
operator|.
name|bp_htype
operator|=
literal|1
expr_stmt|;
name|bp
operator|.
name|bp_hlen
operator|=
name|ETHER_ADDR_LEN
expr_stmt|;
name|bp
operator|.
name|bp_xid
operator|=
name|starttime
operator|=
name|currticks
argument_list|()
expr_stmt|;
name|bcopy
argument_list|(
name|arptable
index|[
name|ARP_CLIENT
index|]
operator|.
name|node
argument_list|,
name|bp
operator|.
name|bp_hwaddr
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
while|while
condition|(
name|retry
operator|--
condition|)
block|{
name|udp_transmit
argument_list|(
name|IP_BROADCAST
argument_list|,
literal|0
argument_list|,
name|BOOTP_SERVER
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|bootp_t
argument_list|)
argument_list|,
operator|&
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
name|await_reply
argument_list|(
name|AWAIT_BOOTP
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
condition|)
return|return
operator|(
literal|1
operator|)
return|;
name|bp
operator|.
name|bp_secs
operator|=
name|htons
argument_list|(
operator|(
name|currticks
argument_list|()
operator|-
name|starttime
operator|)
operator|/
literal|20
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_comment
comment|/************************************************************************** AWAIT_REPLY - Wait until we get a response for our request **************************************************************************/
end_comment

begin_macro
name|await_reply
argument_list|(
argument|type
argument_list|,
argument|ival
argument_list|,
argument|ptr
argument_list|)
end_macro

begin_decl_stmt
name|int
name|type
decl_stmt|,
name|ival
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|ptr
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|unsigned
name|long
name|time
decl_stmt|;
name|struct
name|iphdr
modifier|*
name|ip
decl_stmt|;
name|struct
name|udphdr
modifier|*
name|udp
decl_stmt|;
name|struct
name|arprequest
modifier|*
name|arpreply
decl_stmt|;
name|struct
name|bootp_t
modifier|*
name|bootpreply
decl_stmt|;
name|struct
name|rpc_t
modifier|*
name|rpc
decl_stmt|;
name|int
name|protohdrlen
init|=
name|ETHER_HDR_LEN
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|iphdr
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|udphdr
argument_list|)
decl_stmt|;
name|time
operator|=
name|currticks
argument_list|()
operator|+
name|TIMEOUT
expr_stmt|;
while|while
condition|(
name|time
operator|>
name|currticks
argument_list|()
condition|)
block|{
name|pollkbd
argument_list|()
expr_stmt|;
if|if
condition|(
name|eth_poll
argument_list|()
condition|)
block|{
comment|/* We have something! */
comment|/* Check for ARP - No IP hdr */
if|if
condition|(
operator|(
name|type
operator|==
name|AWAIT_ARP
operator|)
operator|&&
operator|(
name|packetlen
operator|>=
name|ETHER_HDR_LEN
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|arprequest
argument_list|)
operator|)
operator|&&
operator|(
operator|(
operator|(
name|packet
index|[
literal|12
index|]
operator|<<
literal|8
operator|)
operator||
name|packet
index|[
literal|13
index|]
operator|)
operator|==
name|ARP
operator|)
condition|)
block|{
name|arpreply
operator|=
operator|(
expr|struct
name|arprequest
operator|*
operator|)
operator|&
name|packet
index|[
name|ETHER_HDR_LEN
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|arpreply
operator|->
name|opcode
operator|==
name|ntohs
argument_list|(
name|ARP_REPLY
argument_list|)
operator|)
operator|&&
name|bcompare
argument_list|(
name|arpreply
operator|->
name|sipaddr
argument_list|,
name|ptr
argument_list|,
literal|4
argument_list|)
condition|)
block|{
name|bcopy
argument_list|(
name|arpreply
operator|->
name|shwaddr
argument_list|,
name|arptable
index|[
name|ival
index|]
operator|.
name|node
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
continue|continue;
block|}
comment|/* Anything else has IP header */
if|if
condition|(
operator|(
name|packetlen
operator|<
name|protohdrlen
operator|)
operator|||
operator|(
operator|(
operator|(
name|packet
index|[
literal|12
index|]
operator|<<
literal|8
operator|)
operator||
name|packet
index|[
literal|13
index|]
operator|)
operator|!=
name|IP
operator|)
condition|)
continue|continue;
name|ip
operator|=
operator|(
expr|struct
name|iphdr
operator|*
operator|)
operator|&
name|packet
index|[
name|ETHER_HDR_LEN
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|ip
operator|->
name|verhdrlen
operator|!=
literal|0x45
operator|)
operator|||
name|ipchksum
argument_list|(
name|ip
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|iphdr
argument_list|)
argument_list|)
operator|||
operator|(
name|ip
operator|->
name|protocol
operator|!=
name|IP_UDP
operator|)
condition|)
continue|continue;
name|udp
operator|=
operator|(
expr|struct
name|udphdr
operator|*
operator|)
operator|&
name|packet
index|[
name|ETHER_HDR_LEN
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|iphdr
argument_list|)
index|]
expr_stmt|;
comment|/* BOOTP ? */
name|bootpreply
operator|=
operator|(
expr|struct
name|bootp_t
operator|*
operator|)
operator|&
name|packet
index|[
name|ETHER_HDR_LEN
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|type
operator|==
name|AWAIT_BOOTP
operator|)
operator|&&
operator|(
name|packetlen
operator|>=
operator|(
name|ETHER_HDR_LEN
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|iphdr
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|udphdr
argument_list|)
operator|+
name|BOOTP_MIN_LEN
operator|)
operator|)
operator|&&
operator|(
name|ntohs
argument_list|(
name|udp
operator|->
name|dest
argument_list|)
operator|==
name|BOOTP_CLIENT
operator|)
operator|&&
operator|(
name|bootpreply
operator|->
name|bp_op
operator|==
name|BOOTP_REPLY
operator|)
condition|)
block|{
name|convert_ipaddr
argument_list|(
operator|&
name|arptable
index|[
name|ARP_CLIENT
index|]
operator|.
name|ipaddr
argument_list|,
name|bootpreply
operator|->
name|bp_yiaddr
argument_list|)
expr_stmt|;
name|default_netmask
argument_list|()
expr_stmt|;
name|convert_ipaddr
argument_list|(
operator|&
name|arptable
index|[
name|ARP_SERVER
index|]
operator|.
name|ipaddr
argument_list|,
name|bootpreply
operator|->
name|bp_siaddr
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|arptable
index|[
name|ARP_SERVER
index|]
operator|.
name|node
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
comment|/* Kill arp */
name|convert_ipaddr
argument_list|(
operator|&
name|arptable
index|[
name|ARP_GATEWAY
index|]
operator|.
name|ipaddr
argument_list|,
name|bootpreply
operator|->
name|bp_giaddr
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|arptable
index|[
name|ARP_GATEWAY
index|]
operator|.
name|node
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
comment|/* Kill arp */
if|if
condition|(
name|bootpreply
operator|->
name|bp_file
index|[
literal|0
index|]
condition|)
block|{
name|bcopy
argument_list|(
name|bootpreply
operator|->
name|bp_file
argument_list|,
name|kernel_buf
argument_list|,
literal|128
argument_list|)
expr_stmt|;
name|kernel
operator|=
name|kernel_buf
expr_stmt|;
block|}
name|decode_rfc1048
argument_list|(
name|bootpreply
operator|->
name|bp_vend
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
comment|/* TFTP ? */
if|if
condition|(
operator|(
name|type
operator|==
name|AWAIT_TFTP
operator|)
operator|&&
operator|(
name|ntohs
argument_list|(
name|udp
operator|->
name|dest
argument_list|)
operator|==
name|ival
operator|)
condition|)
return|return
operator|(
literal|1
operator|)
return|;
comment|/* RPC */
name|rpc
operator|=
operator|(
expr|struct
name|rpc_t
operator|*
operator|)
operator|&
name|packet
index|[
name|ETHER_HDR_LEN
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|type
operator|==
name|AWAIT_RPC
operator|)
operator|&&
operator|(
name|ntohs
argument_list|(
name|udp
operator|->
name|dest
argument_list|)
operator|==
name|RPC_SOCKET
operator|)
operator|&&
operator|(
name|ntohl
argument_list|(
name|rpc
operator|->
name|u
operator|.
name|reply
operator|.
name|id
argument_list|)
operator|==
name|ival
operator|)
operator|&&
operator|(
name|ntohl
argument_list|(
name|rpc
operator|->
name|u
operator|.
name|reply
operator|.
name|type
argument_list|)
operator|==
name|MSG_REPLY
operator|)
condition|)
block|{
name|rpc_id
operator|++
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_function
name|void
name|bootp_string
parameter_list|(
name|char
modifier|*
name|name
parameter_list|,
name|char
modifier|*
name|bootp_ptr
parameter_list|)
block|{
name|char
name|tmp_buf
index|[
literal|512
index|]
decl_stmt|;
comment|/* oversized, but who cares ! */
name|bzero
argument_list|(
name|tmp_buf
argument_list|,
sizeof|sizeof
argument_list|(
name|tmp_buf
argument_list|)
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|bootp_ptr
operator|+
literal|2
argument_list|,
name|tmp_buf
argument_list|,
name|TAG_LEN
argument_list|(
name|bootp_ptr
argument_list|)
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|config_buffer
operator|+
name|strlen
argument_list|(
name|config_buffer
argument_list|)
argument_list|,
literal|"%s %s\n"
argument_list|,
name|name
argument_list|,
name|tmp_buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/************************************************************************** DECODE_RFC1048 - Decodes RFC1048 header **************************************************************************/
end_comment

begin_macro
name|decode_rfc1048
argument_list|(
argument|p
argument_list|)
end_macro

begin_decl_stmt
name|unsigned
name|char
modifier|*
name|p
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|static
name|char
name|rfc1048_cookie
index|[
literal|4
index|]
init|=
name|RFC1048_COOKIE
decl_stmt|;
name|unsigned
name|char
modifier|*
name|end
init|=
name|p
operator|+
name|BOOTP_VENDOR_LEN
decl_stmt|,
modifier|*
name|q
decl_stmt|;
if|if
condition|(
name|bcompare
argument_list|(
name|p
argument_list|,
name|rfc1048_cookie
argument_list|,
literal|4
argument_list|)
condition|)
block|{
comment|/* RFC 1048 header */
name|p
operator|+=
literal|4
expr_stmt|;
while|while
condition|(
name|p
operator|<
name|end
condition|)
block|{
switch|switch
condition|(
operator|*
name|p
condition|)
block|{
case|case
name|RFC1048_PAD
case|:
name|p
operator|++
expr_stmt|;
continue|continue;
case|case
name|RFC1048_END
case|:
name|p
operator|=
name|end
expr_stmt|;
continue|continue;
case|case
name|RFC1048_GATEWAY
case|:
name|convert_ipaddr
argument_list|(
operator|&
name|arptable
index|[
name|ARP_GATEWAY
index|]
operator|.
name|ipaddr
argument_list|,
name|p
operator|+
literal|2
argument_list|)
expr_stmt|;
break|break;
case|case
name|RFC1048_NETMASK
case|:
name|bcopy
argument_list|(
name|p
operator|+
literal|2
argument_list|,
operator|&
name|netmask
argument_list|,
literal|4
argument_list|)
expr_stmt|;
break|break;
case|case
name|RFC1048_HOSTNAME
case|:
name|bcopy
argument_list|(
name|p
operator|+
literal|2
argument_list|,
operator|&
name|nfsdiskless
operator|.
name|my_hostnam
argument_list|,
name|TAG_LEN
argument_list|(
name|p
argument_list|)
argument_list|)
expr_stmt|;
name|hostnamelen
operator|=
operator|(
name|TAG_LEN
argument_list|(
name|p
argument_list|)
operator|+
literal|3
operator|)
operator|&
operator|~
literal|3
expr_stmt|;
break|break;
case|case
name|RFC1048_ROOT_PATH
case|:
comment|/* XXX check len */
name|bootp_string
argument_list|(
literal|"rootfs"
argument_list|,
name|p
argument_list|)
expr_stmt|;
break|break;
case|case
name|RFC1048_SWAP_PATH
case|:
name|bootp_string
argument_list|(
literal|"swapfs"
argument_list|,
name|p
argument_list|)
expr_stmt|;
break|break;
case|case
name|RFC1048_SWAP_LEN
case|:
comment|/* T129 */
name|sprintf
argument_list|(
name|config_buffer
operator|+
name|strlen
argument_list|(
name|config_buffer
argument_list|)
argument_list|,
literal|"swapsize %d\n"
argument_list|,
name|ntohl
argument_list|(
operator|*
operator|(
name|long
operator|*
operator|)
operator|(
name|p
operator|+
literal|2
operator|)
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|130
case|:
comment|/* root mount options */
name|bootp_string
argument_list|(
literal|"rootopts"
argument_list|,
name|p
argument_list|)
expr_stmt|;
break|break;
case|case
literal|131
case|:
comment|/* swap mount options */
name|bootp_string
argument_list|(
literal|"swapopts"
argument_list|,
name|p
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"Unknown RFC1048-tag "
argument_list|)
expr_stmt|;
for|for
control|(
name|q
operator|=
name|p
init|;
name|q
operator|<
name|p
operator|+
literal|2
operator|+
name|TAG_LEN
argument_list|(
name|p
argument_list|)
condition|;
name|q
operator|++
control|)
name|printf
argument_list|(
literal|"%x "
argument_list|,
operator|*
name|q
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n\r"
argument_list|)
expr_stmt|;
block|}
name|p
operator|+=
name|TAG_LEN
argument_list|(
name|p
argument_list|)
operator|+
literal|2
expr_stmt|;
block|}
block|}
block|}
end_block

begin_comment
comment|/************************************************************************** IPCHKSUM - Checksum IP Header **************************************************************************/
end_comment

begin_macro
name|ipchksum
argument_list|(
argument|ip
argument_list|,
argument|len
argument_list|)
end_macro

begin_decl_stmt
name|unsigned
name|short
modifier|*
name|ip
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|len
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|unsigned
name|long
name|sum
init|=
literal|0
decl_stmt|;
name|len
operator|>>=
literal|1
expr_stmt|;
while|while
condition|(
name|len
operator|--
condition|)
block|{
name|sum
operator|+=
operator|*
operator|(
name|ip
operator|++
operator|)
expr_stmt|;
if|if
condition|(
name|sum
operator|>
literal|0xFFFF
condition|)
name|sum
operator|-=
literal|0xFFFF
expr_stmt|;
block|}
return|return
operator|(
operator|(
operator|~
name|sum
operator|)
operator|&
literal|0x0000FFFF
operator|)
return|;
block|}
end_block

begin_comment
comment|/************************************************************************** CONVERT_IPADDR - Convert IP address from net to machine order **************************************************************************/
end_comment

begin_macro
name|convert_ipaddr
argument_list|(
argument|d
argument_list|,
argument|s
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|d
decl_stmt|,
modifier|*
name|s
decl_stmt|;
end_decl_stmt

begin_block
block|{
operator|*
operator|(
name|d
operator|+
literal|3
operator|)
operator|=
operator|*
name|s
expr_stmt|;
operator|*
operator|(
name|d
operator|+
literal|2
operator|)
operator|=
operator|*
operator|(
name|s
operator|+
literal|1
operator|)
expr_stmt|;
operator|*
operator|(
name|d
operator|+
literal|1
operator|)
operator|=
operator|*
operator|(
name|s
operator|+
literal|2
operator|)
expr_stmt|;
operator|*
name|d
operator|=
operator|*
operator|(
name|s
operator|+
literal|3
operator|)
expr_stmt|;
block|}
end_block

end_unit


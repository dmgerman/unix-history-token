begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * $Id$  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<machine/soundcard.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<sys/errno.h>
end_include

begin_expr_stmt
name|SEQ_DEFINEBUF
argument_list|(
literal|2048
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|SEQ_PM_DEFINES
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|seqfd
decl_stmt|,
name|dev
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|char
name|buf
index|[
literal|100
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|bufp
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* LRU list for free operators */
end_comment

begin_decl_stmt
name|unsigned
name|char
name|free_list
index|[
literal|256
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|fhead
init|=
literal|0
decl_stmt|,
name|ftail
init|=
literal|0
decl_stmt|,
name|flen
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* LRU list for still playing notes */
end_comment

begin_decl_stmt
name|unsigned
name|char
name|note_list
index|[
literal|256
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|nhead
init|=
literal|0
decl_stmt|,
name|ntail
init|=
literal|0
decl_stmt|,
name|nlen
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|char
name|oper_note
index|[
literal|32
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|pgm
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|num_voices
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|bender
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Initially off */
end_comment

begin_function
name|void
name|seqbuf_dump
parameter_list|()
block|{
if|if
condition|(
name|_seqbufptr
condition|)
if|if
condition|(
name|write
argument_list|(
name|seqfd
argument_list|,
name|_seqbuf
argument_list|,
name|_seqbufptr
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"write /dev/sequencer"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
name|_seqbufptr
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
name|void
name|stop_note
parameter_list|(
name|int
name|note
parameter_list|,
name|int
name|velocity
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|op
decl_stmt|;
name|op
operator|=
literal|255
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_voices
operator|&&
name|op
operator|==
literal|255
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|oper_note
index|[
name|i
index|]
operator|==
name|note
condition|)
name|op
operator|=
name|i
expr_stmt|;
block|}
if|if
condition|(
name|op
operator|==
literal|255
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Note %d off, note not started\n"
argument_list|,
name|note
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d, %d\n"
argument_list|,
name|flen
argument_list|,
name|nlen
argument_list|)
expr_stmt|;
return|return;
comment|/* Has already been killed ??? */
block|}
name|SEQ_STOP_NOTE
argument_list|(
name|dev
argument_list|,
name|op
argument_list|,
name|note
argument_list|,
name|velocity
argument_list|)
expr_stmt|;
name|SEQ_DUMPBUF
argument_list|()
expr_stmt|;
name|oper_note
index|[
name|op
index|]
operator|=
literal|255
expr_stmt|;
name|free_list
index|[
name|ftail
index|]
operator|=
name|op
expr_stmt|;
name|flen
operator|++
expr_stmt|;
name|ftail
operator|=
operator|(
name|ftail
operator|+
literal|1
operator|)
operator|%
name|num_voices
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|note_list
index|[
name|i
index|]
operator|==
name|op
condition|)
name|note_list
index|[
name|i
index|]
operator|=
literal|255
expr_stmt|;
while|while
condition|(
name|nlen
operator|&&
name|note_list
index|[
name|nhead
index|]
operator|==
literal|255
condition|)
block|{
name|nlen
operator|--
expr_stmt|;
comment|/* printf("Remove from note queue %d, len %d\n", nhead, nlen);	*/
name|nhead
operator|=
operator|(
name|nhead
operator|+
literal|1
operator|)
operator|%
literal|256
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|kill_one_note
parameter_list|()
block|{
name|int
name|oldest
decl_stmt|;
if|if
condition|(
operator|!
name|nlen
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Free list empty but no notes playing\n"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* No notes playing */
name|oldest
operator|=
name|note_list
index|[
name|nhead
index|]
expr_stmt|;
name|nlen
operator|--
expr_stmt|;
name|nhead
operator|=
operator|(
name|nhead
operator|+
literal|1
operator|)
operator|%
literal|256
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Killing oper %d, note %d\n"
argument_list|,
name|oldest
argument_list|,
name|oper_note
index|[
name|oldest
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|oldest
operator|==
literal|255
condition|)
return|return;
comment|/* Was already stopped. Why? */
name|stop_note
argument_list|(
name|oper_note
index|[
name|oldest
index|]
argument_list|,
literal|127
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|start_note
parameter_list|(
name|int
name|note
parameter_list|,
name|int
name|velocity
parameter_list|)
block|{
name|int
name|free
decl_stmt|;
if|if
condition|(
operator|!
name|flen
condition|)
name|kill_one_note
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|flen
condition|)
block|{
name|printf
argument_list|(
literal|"** no free voices\n"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Panic??? */
name|free
operator|=
name|free_list
index|[
name|fhead
index|]
expr_stmt|;
name|flen
operator|--
expr_stmt|;
name|fhead
operator|=
operator|(
name|fhead
operator|+
literal|1
operator|)
operator|%
name|num_voices
expr_stmt|;
name|note_list
index|[
name|ntail
index|]
operator|=
name|free
expr_stmt|;
if|if
condition|(
name|nlen
operator|>
literal|255
condition|)
block|{
if|#
directive|if
literal|0
block|fprintf(stderr, "Note list overflow %d, %d, %d\n", 	                   nlen, nhead, ntail);
endif|#
directive|endif
name|nlen
operator|=
literal|0
expr_stmt|;
comment|/* Overflow -> hard reset */
block|}
name|nlen
operator|++
expr_stmt|;
name|ntail
operator|=
operator|(
name|ntail
operator|+
literal|1
operator|)
operator|%
literal|256
expr_stmt|;
name|oper_note
index|[
name|free
index|]
operator|=
name|note
expr_stmt|;
name|SEQ_SET_PATCH
argument_list|(
name|dev
argument_list|,
name|free
argument_list|,
name|pgm
argument_list|)
expr_stmt|;
name|SEQ_PITCHBEND
argument_list|(
name|dev
argument_list|,
name|free
argument_list|,
name|bender
argument_list|)
expr_stmt|;
name|SEQ_START_NOTE
argument_list|(
name|dev
argument_list|,
name|free
argument_list|,
name|note
argument_list|,
name|velocity
argument_list|)
expr_stmt|;
name|SEQ_DUMPBUF
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|void
name|channel_pressure
parameter_list|(
name|int
name|ch
parameter_list|,
name|int
name|pressure
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_voices
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|oper_note
index|[
name|i
index|]
operator|!=
literal|255
condition|)
block|{
if|#
directive|if
literal|1
name|SEQ_CHN_PRESSURE
argument_list|(
name|dev
argument_list|,
name|i
argument_list|,
name|pressure
argument_list|)
expr_stmt|;
else|#
directive|else
name|SEQ_EXPRESSION
argument_list|(
name|dev
argument_list|,
name|i
argument_list|,
name|pressure
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|SEQ_DUMPBUF
argument_list|()
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|void
name|pitch_bender
parameter_list|(
name|int
name|ch
parameter_list|,
name|int
name|value
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|value
operator|-=
literal|8192
expr_stmt|;
name|bender
operator|=
name|value
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_voices
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|oper_note
index|[
name|i
index|]
operator|!=
literal|255
condition|)
block|{
name|bender
operator|=
name|value
expr_stmt|;
name|SEQ_PITCHBEND
argument_list|(
name|dev
argument_list|,
name|i
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|SEQ_DUMPBUF
argument_list|()
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|void
name|do_buf
parameter_list|()
block|{
name|int
name|ch
init|=
name|buf
index|[
literal|0
index|]
operator|&
literal|0x0f
decl_stmt|;
name|int
name|value
decl_stmt|;
switch|switch
condition|(
name|buf
index|[
literal|0
index|]
operator|&
literal|0xf0
condition|)
block|{
case|case
literal|0x90
case|:
comment|/* Note on */
if|if
condition|(
name|bufp
operator|<
literal|3
condition|)
break|break;
comment|/*	printf("Note on %d %d %d\n", ch, buf[1], buf[2]);	*/
if|if
condition|(
name|buf
index|[
literal|2
index|]
condition|)
name|start_note
argument_list|(
name|buf
index|[
literal|1
index|]
argument_list|,
name|buf
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
else|else
name|stop_note
argument_list|(
name|buf
index|[
literal|1
index|]
argument_list|,
name|buf
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|bufp
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|0xb0
case|:
comment|/* Control change */
if|if
condition|(
name|bufp
operator|<
literal|3
condition|)
break|break;
comment|/*	printf("Control change %d %d %d\n", ch, buf[1], buf[2]);	*/
name|bufp
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|0x80
case|:
comment|/* Note off */
if|if
condition|(
name|bufp
operator|<
literal|3
condition|)
break|break;
comment|/*	printf("Note off %d %d %d\n", ch, buf[1], buf[2]);	*/
name|stop_note
argument_list|(
name|buf
index|[
literal|1
index|]
argument_list|,
name|buf
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|bufp
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|0xe0
case|:
comment|/* Pitch bender */
if|if
condition|(
name|bufp
operator|<
literal|3
condition|)
break|break;
name|value
operator|=
operator|(
operator|(
name|buf
index|[
literal|2
index|]
operator|&
literal|0x7f
operator|)
operator|<<
literal|7
operator|)
operator||
operator|(
name|buf
index|[
literal|1
index|]
operator|&
literal|0x7f
operator|)
expr_stmt|;
comment|/*	printf("Pitch bender %d %d\n", ch, value>> 7);		*/
name|pitch_bender
argument_list|(
name|ch
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|bufp
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|0xc0
case|:
comment|/* Pgm change */
if|if
condition|(
name|bufp
operator|<
literal|2
condition|)
break|break;
comment|/*	printf("Pgm change %d %d\n", ch, buf[1]);	*/
name|pgm
operator|=
name|buf
index|[
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|PM_LOAD_PATCH
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|,
name|pgm
argument_list|)
operator|<
literal|0
condition|)
if|if
condition|(
name|errno
operator|!=
name|ESRCH
condition|)
comment|/* No such process */
name|perror
argument_list|(
literal|"PM_LOAD_PATCH"
argument_list|)
expr_stmt|;
name|bufp
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|0xd0
case|:
comment|/* Channel pressure */
if|if
condition|(
name|bufp
operator|<
literal|2
condition|)
break|break;
comment|/*	printf("Channel pressure %d %d\n", ch, buf[1]);	*/
name|channel_pressure
argument_list|(
name|ch
argument_list|,
name|buf
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|bufp
operator|=
literal|1
expr_stmt|;
break|break;
default|default:
name|bufp
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|n
decl_stmt|,
name|max_voice
init|=
literal|999
decl_stmt|;
name|struct
name|synth_info
name|info
decl_stmt|;
name|unsigned
name|char
name|ev
index|[
literal|4
index|]
decl_stmt|,
modifier|*
name|p
decl_stmt|;
if|if
condition|(
name|argc
operator|>=
literal|2
condition|)
name|dev
operator|=
name|atoi
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
name|oper_note
index|[
name|i
index|]
operator|=
literal|255
expr_stmt|;
if|if
condition|(
operator|(
name|seqfd
operator|=
name|open
argument_list|(
literal|"/dev/sequencer"
argument_list|,
name|O_RDWR
argument_list|,
literal|0
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"open /dev/sequencer"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|argc
operator|>=
literal|3
condition|)
block|{
name|int
name|d
init|=
name|dev
decl_stmt|;
name|ioctl
argument_list|(
name|seqfd
argument_list|,
name|SNDCTL_FM_4OP_ENABLE
argument_list|,
operator|&
name|d
argument_list|)
expr_stmt|;
block|}
name|info
operator|.
name|device
operator|=
name|dev
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|seqfd
argument_list|,
name|SNDCTL_SYNTH_INFO
argument_list|,
operator|&
name|info
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"info /dev/sequencer"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
name|num_voices
operator|=
name|info
operator|.
name|nr_voices
expr_stmt|;
if|if
condition|(
name|num_voices
operator|>
name|max_voice
condition|)
name|num_voices
operator|=
name|max_voice
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Output to synth device %d (%s)\n"
argument_list|,
name|dev
argument_list|,
name|info
operator|.
name|name
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d voices available\n"
argument_list|,
name|num_voices
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_voices
condition|;
name|i
operator|++
control|)
block|{
name|flen
operator|++
expr_stmt|;
name|free_list
index|[
name|fhead
index|]
operator|=
name|i
expr_stmt|;
name|fhead
operator|=
operator|(
name|fhead
operator|+
literal|1
operator|)
operator|%
name|num_voices
expr_stmt|;
block|}
name|bufp
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|PM_LOAD_PATCH
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
comment|/* Load the default instrument */
if|if
condition|(
name|errno
operator|!=
name|ESRCH
condition|)
comment|/* No such process */
name|perror
argument_list|(
literal|"PM_LOAD_PATCH"
argument_list|)
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
if|if
condition|(
operator|(
name|n
operator|=
name|read
argument_list|(
name|seqfd
argument_list|,
name|ev
argument_list|,
sizeof|sizeof
argument_list|(
name|ev
argument_list|)
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"read /dev/sequencer"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
operator|(
name|n
operator|/
literal|4
operator|)
condition|;
name|i
operator|++
control|)
block|{
name|p
operator|=
operator|&
name|ev
index|[
name|i
operator|*
literal|4
index|]
expr_stmt|;
if|if
condition|(
name|p
index|[
literal|0
index|]
operator|==
name|SEQ_MIDIPUTC
operator|&&
name|p
index|[
literal|2
index|]
operator|==
literal|0
comment|/* Midi if# == 0 */
condition|)
block|{
comment|/*	      printf("%02x ", p[1]);fflush(stdout);		*/
if|if
condition|(
name|p
index|[
literal|1
index|]
operator|&
literal|0x80
condition|)
comment|/* Status */
block|{
if|if
condition|(
name|bufp
condition|)
name|do_buf
argument_list|()
expr_stmt|;
name|buf
index|[
literal|0
index|]
operator|=
name|p
index|[
literal|1
index|]
expr_stmt|;
name|bufp
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|bufp
condition|)
block|{
name|buf
index|[
name|bufp
operator|++
index|]
operator|=
name|p
index|[
literal|1
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|buf
index|[
literal|0
index|]
operator|&
literal|0xf0
operator|)
operator|==
literal|0x90
operator|||
operator|(
name|buf
index|[
literal|0
index|]
operator|&
literal|0xf0
operator|)
operator|==
literal|0x80
operator|||
operator|(
name|buf
index|[
literal|0
index|]
operator|&
literal|0xf0
operator|)
operator|==
literal|0xb0
operator|||
operator|(
name|buf
index|[
literal|0
index|]
operator|&
literal|0xf0
operator|)
operator|==
literal|0xe0
condition|)
block|{
if|if
condition|(
name|bufp
operator|==
literal|3
condition|)
name|do_buf
argument_list|()
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|buf
index|[
literal|0
index|]
operator|&
literal|0xf0
operator|)
operator|==
literal|0xc0
operator|||
operator|(
name|buf
index|[
literal|0
index|]
operator|&
literal|0xf0
operator|)
operator|==
literal|0xd0
condition|)
block|{
if|if
condition|(
name|bufp
operator|==
literal|2
condition|)
name|do_buf
argument_list|()
expr_stmt|;
block|}
block|}
block|}
block|}
block|}
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * CAUTION!	This program is just an incompletely implemented version  *		of the patch manager daemon for GUS. Using this program  *		with the driver version 1.99.9 will hang your system  *		completely (sooner or later).  *  *		This program is for information only. The final  *		implementation of the patch manager will not be  *		compatible with this one.  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<machine/ultrasound.h>
end_include

begin_include
include|#
directive|include
file|<strings.h>
end_include

begin_include
include|#
directive|include
file|<sys/errno.h>
end_include

begin_include
include|#
directive|include
file|"gmidi.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|PATCH_PATH
end_ifndef

begin_define
define|#
directive|define
name|PATCH_PATH
value|"/D/ultrasnd/midi"
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
name|char
name|loadmap
index|[
literal|256
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* 1 if the patch is already loaded */
end_comment

begin_struct
struct|struct
name|pat_header
block|{
name|char
name|magic
index|[
literal|12
index|]
decl_stmt|;
name|char
name|version
index|[
literal|10
index|]
decl_stmt|;
name|char
name|description
index|[
literal|60
index|]
decl_stmt|;
name|unsigned
name|char
name|instruments
decl_stmt|;
name|char
name|voices
decl_stmt|;
name|char
name|channels
decl_stmt|;
name|unsigned
name|short
name|nr_waveforms
decl_stmt|;
name|unsigned
name|short
name|master_volume
decl_stmt|;
name|unsigned
name|long
name|data_size
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|sample_header
block|{
name|char
name|name
index|[
literal|7
index|]
decl_stmt|;
name|unsigned
name|char
name|fractions
decl_stmt|;
name|long
name|len
decl_stmt|;
name|long
name|loop_start
decl_stmt|;
name|long
name|loop_end
decl_stmt|;
name|unsigned
name|short
name|base_freq
decl_stmt|;
name|long
name|low_note
decl_stmt|;
name|long
name|high_note
decl_stmt|;
name|long
name|base_note
decl_stmt|;
name|short
name|detune
decl_stmt|;
name|unsigned
name|char
name|panning
decl_stmt|;
name|unsigned
name|char
name|envelope_rate
index|[
literal|6
index|]
decl_stmt|;
name|unsigned
name|char
name|envelope_offset
index|[
literal|6
index|]
decl_stmt|;
name|unsigned
name|char
name|tremolo_sweep
decl_stmt|;
name|unsigned
name|char
name|tremolo_rate
decl_stmt|;
name|unsigned
name|char
name|tremolo_depth
decl_stmt|;
name|unsigned
name|char
name|vibrato_sweep
decl_stmt|;
name|unsigned
name|char
name|vibrato_rate
decl_stmt|;
name|unsigned
name|char
name|vibrato_depth
decl_stmt|;
name|char
name|modes
decl_stmt|;
name|short
name|scale_frequency
decl_stmt|;
name|unsigned
name|short
name|scale_factor
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
name|int
name|seqfd
init|=
literal|0
decl_stmt|,
name|gus_dev
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|patch_info
modifier|*
name|patch
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|do_load_patch
parameter_list|(
name|struct
name|patmgr_info
modifier|*
name|rec
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|patfd
decl_stmt|,
name|pgm
decl_stmt|,
name|print_only
init|=
literal|0
decl_stmt|;
name|struct
name|pat_header
name|header
decl_stmt|;
name|struct
name|sample_header
name|sample
decl_stmt|;
name|char
name|buf
index|[
literal|256
index|]
decl_stmt|;
name|char
name|name
index|[
literal|256
index|]
decl_stmt|;
name|long
name|offset
decl_stmt|;
name|pgm
operator|=
name|rec
operator|->
name|data
operator|.
name|data8
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|loadmap
index|[
name|pgm
index|]
condition|)
return|return
literal|0
return|;
comment|/* Already loaded */
name|sprintf
argument_list|(
name|name
argument_list|,
name|PATCH_PATH
literal|"/%s.pat"
argument_list|,
name|patch_names
index|[
name|pgm
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|patfd
operator|=
name|open
argument_list|(
name|name
argument_list|,
name|O_RDONLY
argument_list|,
literal|0
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
name|name
argument_list|)
expr_stmt|;
return|return
name|errno
return|;
block|}
if|if
condition|(
name|read
argument_list|(
name|patfd
argument_list|,
name|buf
argument_list|,
literal|0xef
argument_list|)
operator|!=
literal|0xef
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: Short file\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return
name|EIO
return|;
block|}
name|memcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|header
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|header
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|strncmp
argument_list|(
name|header
operator|.
name|magic
argument_list|,
literal|"GF1PATCH110"
argument_list|,
literal|12
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: Not a patch file\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
if|if
condition|(
name|strncmp
argument_list|(
name|header
operator|.
name|version
argument_list|,
literal|"ID#000002"
argument_list|,
literal|10
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: Incompatible patch file version\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
name|header
operator|.
name|nr_waveforms
operator|=
operator|*
operator|(
name|unsigned
name|short
operator|*
operator|)
operator|&
name|buf
index|[
literal|85
index|]
expr_stmt|;
name|header
operator|.
name|master_volume
operator|=
operator|*
operator|(
name|unsigned
name|short
operator|*
operator|)
operator|&
name|buf
index|[
literal|87
index|]
expr_stmt|;
name|printf
argument_list|(
literal|"GUS: Loading: %s\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|offset
operator|=
literal|0xef
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|header
operator|.
name|nr_waveforms
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|lseek
argument_list|(
name|patfd
argument_list|,
name|offset
argument_list|,
literal|0
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
name|name
argument_list|)
expr_stmt|;
return|return
name|errno
return|;
block|}
if|if
condition|(
name|read
argument_list|(
name|patfd
argument_list|,
operator|&
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|sample
argument_list|)
argument_list|)
operator|!=
sizeof|sizeof
argument_list|(
name|sample
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: Short file\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return
name|EIO
return|;
block|}
name|memcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|sample
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|sample
argument_list|)
argument_list|)
expr_stmt|;
comment|/*        * Since some fields of the patch record are not 32bit aligned, we must        * handle them specially.        */
name|sample
operator|.
name|low_note
operator|=
operator|*
operator|(
name|long
operator|*
operator|)
operator|&
name|buf
index|[
literal|22
index|]
expr_stmt|;
name|sample
operator|.
name|high_note
operator|=
operator|*
operator|(
name|long
operator|*
operator|)
operator|&
name|buf
index|[
literal|26
index|]
expr_stmt|;
name|sample
operator|.
name|base_note
operator|=
operator|*
operator|(
name|long
operator|*
operator|)
operator|&
name|buf
index|[
literal|30
index|]
expr_stmt|;
name|sample
operator|.
name|detune
operator|=
operator|*
operator|(
name|short
operator|*
operator|)
operator|&
name|buf
index|[
literal|34
index|]
expr_stmt|;
name|sample
operator|.
name|panning
operator|=
operator|(
name|unsigned
name|char
operator|)
name|buf
index|[
literal|36
index|]
expr_stmt|;
name|memcpy
argument_list|(
name|sample
operator|.
name|envelope_rate
argument_list|,
operator|&
name|buf
index|[
literal|37
index|]
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|sample
operator|.
name|envelope_offset
argument_list|,
operator|&
name|buf
index|[
literal|43
index|]
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|sample
operator|.
name|tremolo_sweep
operator|=
operator|(
name|unsigned
name|char
operator|)
name|buf
index|[
literal|49
index|]
expr_stmt|;
name|sample
operator|.
name|tremolo_rate
operator|=
operator|(
name|unsigned
name|char
operator|)
name|buf
index|[
literal|50
index|]
expr_stmt|;
name|sample
operator|.
name|tremolo_depth
operator|=
operator|(
name|unsigned
name|char
operator|)
name|buf
index|[
literal|51
index|]
expr_stmt|;
name|sample
operator|.
name|vibrato_sweep
operator|=
operator|(
name|unsigned
name|char
operator|)
name|buf
index|[
literal|52
index|]
expr_stmt|;
name|sample
operator|.
name|vibrato_rate
operator|=
operator|(
name|unsigned
name|char
operator|)
name|buf
index|[
literal|53
index|]
expr_stmt|;
name|sample
operator|.
name|vibrato_depth
operator|=
operator|(
name|unsigned
name|char
operator|)
name|buf
index|[
literal|54
index|]
expr_stmt|;
name|sample
operator|.
name|modes
operator|=
operator|(
name|unsigned
name|char
operator|)
name|buf
index|[
literal|55
index|]
expr_stmt|;
name|sample
operator|.
name|scale_frequency
operator|=
operator|*
operator|(
name|short
operator|*
operator|)
operator|&
name|buf
index|[
literal|56
index|]
expr_stmt|;
name|sample
operator|.
name|scale_factor
operator|=
operator|*
operator|(
name|unsigned
name|short
operator|*
operator|)
operator|&
name|buf
index|[
literal|58
index|]
expr_stmt|;
if|if
condition|(
name|print_only
condition|)
block|{
name|printf
argument_list|(
literal|"\nSample: %03d / %s\n"
argument_list|,
name|i
argument_list|,
name|sample
operator|.
name|name
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Len: %d, Loop start: %d, Loop end: %d\n"
argument_list|,
name|sample
operator|.
name|len
argument_list|,
name|sample
operator|.
name|loop_start
argument_list|,
name|sample
operator|.
name|loop_end
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Flags: "
argument_list|)
expr_stmt|;
if|if
condition|(
name|sample
operator|.
name|modes
operator|&
name|WAVE_16_BITS
condition|)
name|printf
argument_list|(
literal|"16 bit "
argument_list|)
expr_stmt|;
if|if
condition|(
name|sample
operator|.
name|modes
operator|&
name|WAVE_UNSIGNED
condition|)
name|printf
argument_list|(
literal|"unsigned "
argument_list|)
expr_stmt|;
if|if
condition|(
name|sample
operator|.
name|modes
operator|&
name|WAVE_LOOP_BACK
condition|)
name|printf
argument_list|(
literal|"reverse "
argument_list|)
expr_stmt|;
if|if
condition|(
name|sample
operator|.
name|modes
operator|&
name|WAVE_BIDIR_LOOP
condition|)
name|printf
argument_list|(
literal|"bidir "
argument_list|)
expr_stmt|;
if|if
condition|(
name|sample
operator|.
name|modes
operator|&
name|WAVE_LOOPING
condition|)
name|printf
argument_list|(
literal|"looping "
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"one_shot"
argument_list|)
expr_stmt|;
if|if
condition|(
name|sample
operator|.
name|modes
operator|&
name|WAVE_SUSTAIN_ON
condition|)
name|printf
argument_list|(
literal|"sustain "
argument_list|)
expr_stmt|;
if|if
condition|(
name|sample
operator|.
name|modes
operator|&
name|WAVE_ENVELOPES
condition|)
name|printf
argument_list|(
literal|"enveloped "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|sample
operator|.
name|modes
operator|&
name|WAVE_ENVELOPES
condition|)
block|{
name|int
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"Envelope info: "
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|6
condition|;
name|i
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"%d/%d "
argument_list|,
name|sample
operator|.
name|envelope_rate
index|[
name|i
index|]
argument_list|,
name|sample
operator|.
name|envelope_offset
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Tremolo: sweep=%d, rate=%d, depth=%d\n"
argument_list|,
name|sample
operator|.
name|tremolo_sweep
argument_list|,
name|sample
operator|.
name|tremolo_rate
argument_list|,
name|sample
operator|.
name|tremolo_depth
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Vibrato: sweep=%d, rate=%d, depth=%d\n"
argument_list|,
name|sample
operator|.
name|vibrato_sweep
argument_list|,
name|sample
operator|.
name|vibrato_rate
argument_list|,
name|sample
operator|.
name|vibrato_depth
argument_list|)
expr_stmt|;
block|}
name|offset
operator|=
name|offset
operator|+
literal|96
expr_stmt|;
name|patch
operator|=
operator|(
expr|struct
name|patch_info
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|patch
argument_list|)
operator|+
name|sample
operator|.
name|len
argument_list|)
expr_stmt|;
name|patch
operator|->
name|key
operator|=
name|GUS_PATCH
expr_stmt|;
name|patch
operator|->
name|device_no
operator|=
name|gus_dev
expr_stmt|;
name|patch
operator|->
name|instr_no
operator|=
name|pgm
expr_stmt|;
name|patch
operator|->
name|mode
operator|=
name|sample
operator|.
name|modes
operator||
name|WAVE_TREMOLO
operator||
name|WAVE_VIBRATO
operator||
name|WAVE_SCALE
expr_stmt|;
name|patch
operator|->
name|len
operator|=
name|sample
operator|.
name|len
expr_stmt|;
name|patch
operator|->
name|loop_start
operator|=
name|sample
operator|.
name|loop_start
expr_stmt|;
name|patch
operator|->
name|loop_end
operator|=
name|sample
operator|.
name|loop_end
expr_stmt|;
name|patch
operator|->
name|base_note
operator|=
name|sample
operator|.
name|base_note
expr_stmt|;
name|patch
operator|->
name|high_note
operator|=
name|sample
operator|.
name|high_note
expr_stmt|;
name|patch
operator|->
name|low_note
operator|=
name|sample
operator|.
name|low_note
expr_stmt|;
name|patch
operator|->
name|base_freq
operator|=
name|sample
operator|.
name|base_freq
expr_stmt|;
name|patch
operator|->
name|detuning
operator|=
name|sample
operator|.
name|detune
expr_stmt|;
name|patch
operator|->
name|panning
operator|=
operator|(
name|sample
operator|.
name|panning
operator|-
literal|7
operator|)
operator|*
literal|16
expr_stmt|;
name|memcpy
argument_list|(
name|patch
operator|->
name|env_rate
argument_list|,
name|sample
operator|.
name|envelope_rate
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|patch
operator|->
name|env_offset
argument_list|,
name|sample
operator|.
name|envelope_offset
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|patch
operator|->
name|tremolo_sweep
operator|=
name|sample
operator|.
name|tremolo_sweep
expr_stmt|;
name|patch
operator|->
name|tremolo_rate
operator|=
name|sample
operator|.
name|tremolo_rate
expr_stmt|;
name|patch
operator|->
name|tremolo_depth
operator|=
name|sample
operator|.
name|tremolo_depth
expr_stmt|;
name|patch
operator|->
name|vibrato_sweep
operator|=
name|sample
operator|.
name|vibrato_sweep
expr_stmt|;
name|patch
operator|->
name|vibrato_rate
operator|=
name|sample
operator|.
name|vibrato_rate
expr_stmt|;
name|patch
operator|->
name|vibrato_depth
operator|=
name|sample
operator|.
name|vibrato_depth
expr_stmt|;
name|patch
operator|->
name|scale_frequency
operator|=
name|sample
operator|.
name|scale_frequency
expr_stmt|;
name|patch
operator|->
name|scale_factor
operator|=
name|sample
operator|.
name|scale_factor
expr_stmt|;
name|patch
operator|->
name|volume
operator|=
name|header
operator|.
name|master_volume
expr_stmt|;
if|if
condition|(
name|lseek
argument_list|(
name|patfd
argument_list|,
name|offset
argument_list|,
literal|0
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
name|name
argument_list|)
expr_stmt|;
return|return
name|errno
return|;
block|}
if|if
condition|(
operator|!
name|print_only
condition|)
block|{
if|if
condition|(
name|read
argument_list|(
name|patfd
argument_list|,
name|patch
operator|->
name|data
argument_list|,
name|sample
operator|.
name|len
argument_list|)
operator|!=
name|sample
operator|.
name|len
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: Short file\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return
name|EIO
return|;
block|}
if|if
condition|(
name|write
argument_list|(
name|seqfd
argument_list|,
name|patch
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|patch
argument_list|)
operator|+
name|sample
operator|.
name|len
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"/dev/pmgr0"
argument_list|)
expr_stmt|;
return|return
name|errno
return|;
block|}
block|}
name|offset
operator|=
name|offset
operator|+
name|sample
operator|.
name|len
expr_stmt|;
block|}
name|loadmap
index|[
name|pgm
index|]
operator|=
literal|1
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|struct
name|patmgr_info
name|inf
decl_stmt|;
name|int
name|err
decl_stmt|,
name|i
decl_stmt|,
name|n
decl_stmt|;
name|struct
name|synth_info
name|info
decl_stmt|;
if|if
condition|(
operator|(
name|seqfd
operator|=
name|open
argument_list|(
literal|"/dev/patmgr0"
argument_list|,
name|O_RDWR
argument_list|,
literal|0
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Cannot open\n"
argument_list|)
expr_stmt|;
name|perror
argument_list|(
literal|"/dev/patmgr0"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ioctl
argument_list|(
name|seqfd
argument_list|,
name|SNDCTL_SEQ_NRSYNTHS
argument_list|,
operator|&
name|n
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"NRSYNTH: /dev/patmgr0"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
name|info
operator|.
name|device
operator|=
name|i
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|seqfd
argument_list|,
name|SNDCTL_SYNTH_INFO
argument_list|,
operator|&
name|info
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"SYNTH_INFO: /dev/patmgr0"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|info
operator|.
name|synth_type
operator|==
name|SYNTH_TYPE_SAMPLE
operator|&&
name|info
operator|.
name|synth_subtype
operator|==
name|SAMPLE_TYPE_GUS
condition|)
name|gus_dev
operator|=
name|i
expr_stmt|;
block|}
if|if
condition|(
name|gus_dev
operator|==
operator|-
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Error: Gravis Ultrasound not detected\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ioctl
argument_list|(
name|seqfd
argument_list|,
name|SNDCTL_SEQ_RESETSAMPLES
argument_list|,
operator|&
name|gus_dev
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|perror
argument_list|(
literal|"Sample reset"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|256
condition|;
name|i
operator|++
control|)
name|loadmap
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
if|if
condition|(
name|read
argument_list|(
name|seqfd
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|inf
argument_list|,
sizeof|sizeof
argument_list|(
name|inf
argument_list|)
argument_list|)
operator|!=
sizeof|sizeof
argument_list|(
name|inf
argument_list|)
condition|)
block|{
name|perror
argument_list|(
literal|"Read"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|inf
operator|.
name|key
operator|==
name|PM_K_EVENT
condition|)
switch|switch
condition|(
name|inf
operator|.
name|command
condition|)
block|{
case|case
name|PM_E_OPENED
case|:
name|printf
argument_list|(
literal|"Opened\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PM_E_CLOSED
case|:
name|printf
argument_list|(
literal|"Closed\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|seqfd
argument_list|,
name|SNDCTL_SEQ_RESETSAMPLES
argument_list|,
operator|&
name|gus_dev
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|perror
argument_list|(
literal|"Sample reset"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|256
condition|;
name|i
operator|++
control|)
name|loadmap
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|PM_E_PATCH_RESET
case|:
name|printf
argument_list|(
literal|"Patch reset called\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|256
condition|;
name|i
operator|++
control|)
name|loadmap
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|PM_E_PATCH_LOADED
case|:
name|printf
argument_list|(
literal|"Patch loaded by client\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"Unknown event %d\n"
argument_list|,
name|inf
operator|.
name|command
argument_list|)
expr_stmt|;
name|inf
operator|.
name|key
operator|=
name|PM_ERROR
expr_stmt|;
name|inf
operator|.
name|parm1
operator|=
name|EINVAL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|inf
operator|.
name|key
operator|==
name|PM_K_COMMAND
condition|)
switch|switch
condition|(
name|inf
operator|.
name|command
condition|)
block|{
case|case
name|_PM_LOAD_PATCH
case|:
if|if
condition|(
operator|(
name|err
operator|=
name|do_load_patch
argument_list|(
operator|&
name|inf
argument_list|)
operator|)
condition|)
if|if
condition|(
name|err
operator|==
name|ENOSPC
condition|)
block|{
if|if
condition|(
name|ioctl
argument_list|(
name|seqfd
argument_list|,
name|SNDCTL_SEQ_RESETSAMPLES
argument_list|,
operator|&
name|gus_dev
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"Sample reset"
argument_list|)
expr_stmt|;
return|return
name|errno
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|256
condition|;
name|i
operator|++
control|)
name|loadmap
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|err
operator|=
name|do_load_patch
argument_list|(
operator|&
name|inf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|err
condition|)
block|{
name|inf
operator|.
name|key
operator|=
name|PM_ERROR
expr_stmt|;
name|inf
operator|.
name|parm1
operator|=
name|err
expr_stmt|;
name|printf
argument_list|(
literal|"Error = %d\n"
argument_list|,
name|err
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|inf
operator|.
name|key
operator|=
name|PM_K_COMMAND
expr_stmt|;
name|inf
operator|.
name|parm1
operator|=
literal|0
expr_stmt|;
block|}
break|break;
default|default:
name|printf
argument_list|(
literal|"Unknown command %d\n"
argument_list|,
name|inf
operator|.
name|command
argument_list|)
expr_stmt|;
name|inf
operator|.
name|key
operator|=
name|PM_ERROR
expr_stmt|;
name|inf
operator|.
name|parm1
operator|=
name|EINVAL
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"Unknown event %d/%d\n"
argument_list|,
name|inf
operator|.
name|key
argument_list|,
name|inf
operator|.
name|command
argument_list|)
expr_stmt|;
name|inf
operator|.
name|key
operator|=
name|PM_ERROR
expr_stmt|;
name|inf
operator|.
name|parm1
operator|=
name|EINVAL
expr_stmt|;
block|}
if|if
condition|(
name|write
argument_list|(
name|seqfd
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|inf
argument_list|,
sizeof|sizeof
argument_list|(
name|inf
argument_list|)
argument_list|)
operator|!=
sizeof|sizeof
argument_list|(
name|inf
argument_list|)
condition|)
block|{
name|perror
argument_list|(
literal|"write"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


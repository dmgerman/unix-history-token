begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  *	gmod.c	- Module player for GUS and Linux.  *		(C) Hannu Savolainen, 1993  *  *	NOTE!	This program doesn't try to be a complete module player.  *		It's just a too I used while developing the driver. In  *		addition it can be used as an example on programming  *		the LInux Sound Driver with GUS.  * $Id$  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<machine/ultrasound.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<math.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_define
define|#
directive|define
name|CMD_ARPEG
value|0x00
end_define

begin_define
define|#
directive|define
name|CMD_SLIDEUP
value|0x01
end_define

begin_define
define|#
directive|define
name|CMD_SLIDEDOWN
value|0x02
end_define

begin_define
define|#
directive|define
name|CMD_SLIDETO
value|0x03
end_define

begin_define
define|#
directive|define
name|SLIDE_SIZE
value|8
end_define

begin_define
define|#
directive|define
name|CMD_VOLSLIDE
value|0x0a
end_define

begin_define
define|#
directive|define
name|CMD_JUMP
value|0x0b
end_define

begin_define
define|#
directive|define
name|CMD_VOLUME
value|0x0c
end_define

begin_define
define|#
directive|define
name|CMD_BREAK
value|0x0d
end_define

begin_define
define|#
directive|define
name|CMD_SPEED
value|0x0f
end_define

begin_define
define|#
directive|define
name|CMD_NOP
value|0xfe
end_define

begin_define
define|#
directive|define
name|CMD_NONOTE
value|0xff
end_define

begin_define
define|#
directive|define
name|MIN
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
value|((a)< (b) ? (a) : (b))
end_define

begin_define
define|#
directive|define
name|MAX_TRACK
value|8
end_define

begin_define
define|#
directive|define
name|MAX_PATTERN
value|128
end_define

begin_define
define|#
directive|define
name|MAX_POSITION
value|128
end_define

begin_struct
struct|struct
name|note_info
block|{
name|unsigned
name|char
name|note
decl_stmt|;
name|unsigned
name|char
name|vol
decl_stmt|;
name|unsigned
name|char
name|sample
decl_stmt|;
name|unsigned
name|char
name|command
decl_stmt|;
name|short
name|parm1
decl_stmt|,
name|parm2
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|voice_info
block|{
name|int
name|sample
decl_stmt|;
name|int
name|note
decl_stmt|;
name|int
name|volume
decl_stmt|;
name|int
name|pitchbender
decl_stmt|;
comment|/* Pitch sliding */
name|int
name|slide_pitch
decl_stmt|;
name|int
name|slide_goal
decl_stmt|;
name|int
name|slide_rate
decl_stmt|;
name|int
name|volslide
decl_stmt|;
block|}
struct|;
end_struct

begin_typedef
typedef|typedef
name|struct
name|note_info
name|pattern
index|[
name|MAX_TRACK
index|]
index|[
literal|64
index|]
typedef|;
end_typedef

begin_decl_stmt
name|int
name|pattern_len
index|[
name|MAX_POSITION
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|pattern_tempo
index|[
name|MAX_POSITION
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|pattern
modifier|*
name|pattern_table
index|[
name|MAX_PATTERN
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|voice_info
name|voices
index|[
name|MAX_TRACK
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|nr_channels
decl_stmt|,
name|nr_patterns
decl_stmt|,
name|songlength
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|tune
index|[
name|MAX_POSITION
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|double
name|tick_duration
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|period_table
index|[]
init|=
block|{
literal|856
block|,
literal|808
block|,
literal|762
block|,
literal|720
block|,
literal|678
block|,
literal|640
block|,
literal|604
block|,
literal|570
block|,
literal|538
block|,
literal|508
block|,
literal|480
block|,
literal|453
block|,
literal|428
block|,
literal|404
block|,
literal|381
block|,
literal|360
block|,
literal|339
block|,
literal|320
block|,
literal|302
block|,
literal|285
block|,
literal|269
block|,
literal|254
block|,
literal|240
block|,
literal|226
block|,
literal|214
block|,
literal|202
block|,
literal|190
block|,
literal|180
block|,
literal|170
block|,
literal|160
block|,
literal|151
block|,
literal|143
block|,
literal|135
block|,
literal|127
block|,
literal|120
block|,
literal|113
block|}
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|SEQ_DEFINEBUF
argument_list|(
literal|2048
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|seqfd
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|sample_ok
index|[
literal|128
index|]
decl_stmt|,
name|sample_vol
index|[
literal|128
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|tmp
decl_stmt|,
name|gus_dev
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|double
name|this_time
decl_stmt|,
name|next_time
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|ticks_per_division
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|double
name|clock_rate
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* HZ */
end_comment

begin_comment
comment|/*  * The function seqbuf_dump() must always be provided  */
end_comment

begin_function_decl
name|void
name|play_module
parameter_list|(
name|char
modifier|*
name|name
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|load_module
parameter_list|(
name|char
modifier|*
name|name
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|play_note
parameter_list|(
name|int
name|channel
parameter_list|,
name|struct
name|note_info
modifier|*
name|pat
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|lets_play_voice
parameter_list|(
name|int
name|channel
parameter_list|,
name|struct
name|voice_info
modifier|*
name|v
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|void
name|seqbuf_dump
parameter_list|()
block|{
if|if
condition|(
name|_seqbufptr
condition|)
if|if
condition|(
name|write
argument_list|(
name|seqfd
argument_list|,
name|_seqbuf
argument_list|,
name|_seqbufptr
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"write /dev/sequencer"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
name|_seqbufptr
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
name|void
name|init_voices
parameter_list|()
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_TRACK
condition|;
name|i
operator|++
control|)
block|{
name|voices
index|[
name|i
index|]
operator|.
name|sample
operator|=
literal|0
expr_stmt|;
name|voices
index|[
name|i
index|]
operator|.
name|note
operator|=
literal|0
expr_stmt|;
name|voices
index|[
name|i
index|]
operator|.
name|volume
operator|=
literal|64
expr_stmt|;
name|voices
index|[
name|i
index|]
operator|.
name|slide_pitch
operator|=
literal|0
expr_stmt|;
name|voices
index|[
name|i
index|]
operator|.
name|slide_goal
operator|=
literal|0
expr_stmt|;
name|voices
index|[
name|i
index|]
operator|.
name|slide_rate
operator|=
literal|0
expr_stmt|;
name|voices
index|[
name|i
index|]
operator|.
name|pitchbender
operator|=
literal|0
expr_stmt|;
name|voices
index|[
name|i
index|]
operator|.
name|volslide
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|n
decl_stmt|,
name|j
decl_stmt|;
name|struct
name|synth_info
name|info
decl_stmt|;
if|if
condition|(
operator|(
name|seqfd
operator|=
name|open
argument_list|(
literal|"/dev/sequencer"
argument_list|,
name|O_WRONLY
argument_list|,
literal|0
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"/dev/sequencer"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ioctl
argument_list|(
name|seqfd
argument_list|,
name|SNDCTL_SEQ_NRSYNTHS
argument_list|,
operator|&
name|n
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"/dev/sequencer"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
name|info
operator|.
name|device
operator|=
name|i
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|seqfd
argument_list|,
name|SNDCTL_SYNTH_INFO
argument_list|,
operator|&
name|info
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"/dev/sequencer"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|info
operator|.
name|synth_type
operator|==
name|SYNTH_TYPE_SAMPLE
operator|&&
name|info
operator|.
name|synth_subtype
operator|==
name|SAMPLE_TYPE_GUS
condition|)
name|gus_dev
operator|=
name|i
expr_stmt|;
block|}
if|if
condition|(
name|gus_dev
operator|==
operator|-
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Gravis Ultrasound not detected\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
name|GUS_NUMVOICES
argument_list|(
name|gus_dev
argument_list|,
literal|14
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|MAX_PATTERN
condition|;
name|j
operator|++
control|)
name|pattern_table
index|[
name|j
index|]
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|load_module
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|)
condition|)
block|{
name|tick_duration
operator|=
literal|100.0
operator|/
name|clock_rate
expr_stmt|;
name|play_module
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
name|SEQ_DUMPBUF
argument_list|()
expr_stmt|;
name|close
argument_list|(
name|seqfd
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|unsigned
name|short
name|intelize
parameter_list|(
name|unsigned
name|short
name|v
parameter_list|)
block|{
return|return
operator|(
operator|(
name|v
operator|&
literal|0xff
operator|)
operator|<<
literal|8
operator|)
operator||
operator|(
operator|(
name|v
operator|>>
literal|8
operator|)
operator|&
literal|0xff
operator|)
return|;
block|}
end_function

begin_function
name|unsigned
name|long
name|intelize4
parameter_list|(
name|unsigned
name|long
name|v
parameter_list|)
block|{
return|return
operator|(
operator|(
operator|(
name|v
operator|>>
literal|16
operator|)
operator|&
literal|0xff
operator|)
operator|<<
literal|8
operator|)
operator||
operator|(
operator|(
operator|(
name|v
operator|>>
literal|16
operator|)
operator|>>
literal|8
operator|)
operator|&
literal|0xff
operator|)
operator||
operator|(
operator|(
operator|(
name|v
operator|&
literal|0xff
operator|)
operator|<<
literal|8
operator|)
operator||
operator|(
operator|(
name|v
operator|>>
literal|8
operator|)
operator|&
literal|0xff
operator|)
operator|<<
literal|16
operator|)
return|;
block|}
end_function

begin_function
name|int
name|load_stm_module
parameter_list|(
name|int
name|mod_fd
parameter_list|,
name|char
modifier|*
name|name
parameter_list|)
block|{
struct|struct
name|sample_header
block|{
name|char
name|name
index|[
literal|12
index|]
decl_stmt|;
name|unsigned
name|char
name|instr_disk
decl_stmt|;
name|unsigned
name|short
name|reserved1
decl_stmt|;
name|unsigned
name|short
name|length
decl_stmt|;
comment|/* In bytes */
name|unsigned
name|short
name|loop_start
decl_stmt|;
name|unsigned
name|short
name|loop_end
decl_stmt|;
name|unsigned
name|char
name|volume
decl_stmt|;
name|unsigned
name|char
name|reserved2
decl_stmt|;
name|unsigned
name|short
name|C2_speed
decl_stmt|;
name|unsigned
name|short
name|reserved3
decl_stmt|;
block|}
struct|;
name|int
name|i
decl_stmt|,
name|total_mem
decl_stmt|;
name|int
name|sample_ptr
decl_stmt|;
name|int
name|position
decl_stmt|;
name|unsigned
name|char
modifier|*
name|tune_ptr
decl_stmt|;
comment|/* array 0-127 */
name|char
name|header
index|[
literal|1105
index|]
decl_stmt|,
name|sname
index|[
literal|21
index|]
decl_stmt|;
name|int
name|nr_samples
decl_stmt|;
comment|/* 16 or 32 samples (or 64 or ???) */
name|int
name|slen
decl_stmt|,
name|npat
decl_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Loading .STM module: %s\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|read
argument_list|(
name|mod_fd
argument_list|,
name|header
argument_list|,
sizeof|sizeof
argument_list|(
name|header
argument_list|)
argument_list|)
operator|!=
sizeof|sizeof
argument_list|(
name|header
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: Short file (header)\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|mod_fd
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|strncpy
argument_list|(
name|sname
argument_list|,
name|header
argument_list|,
literal|20
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\nModule: %s - "
argument_list|,
name|sname
argument_list|)
expr_stmt|;
if|if
condition|(
name|header
index|[
literal|28
index|]
operator|!=
literal|0x1a
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Not a STM module\n"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|mod_fd
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|npat
operator|=
name|header
index|[
literal|33
index|]
expr_stmt|;
name|slen
operator|=
literal|0
expr_stmt|;
name|tune_ptr
operator|=
operator|&
name|header
index|[
literal|48
operator|+
operator|(
literal|31
operator|*
literal|32
operator|)
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|64
condition|;
name|i
operator|++
control|)
block|{
name|tune
index|[
name|i
index|]
operator|=
name|tune_ptr
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|tune
index|[
name|i
index|]
operator|<
name|npat
condition|)
name|slen
operator|=
name|i
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Song lenght %d, %d patterns.\n"
argument_list|,
name|slen
argument_list|,
name|npat
argument_list|)
expr_stmt|;
name|nr_samples
operator|=
literal|31
expr_stmt|;
name|sample_ptr
operator|=
literal|48
operator|+
operator|(
literal|31
operator|*
literal|32
operator|)
operator|+
literal|64
operator|+
operator|(
name|npat
operator|*
literal|1024
operator|)
expr_stmt|;
comment|/* Location where the 							 * first sample is 							 * stored */
name|total_mem
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
name|sample_ok
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nr_samples
condition|;
name|i
operator|++
control|)
block|{
name|int
name|len
decl_stmt|,
name|loop_start
decl_stmt|,
name|loop_end
decl_stmt|,
name|base_freq
decl_stmt|;
name|unsigned
name|short
name|loop_flags
init|=
literal|0
decl_stmt|;
name|struct
name|sample_header
modifier|*
name|sample
decl_stmt|;
name|struct
name|patch_info
modifier|*
name|patch
decl_stmt|;
name|sample
operator|=
operator|(
expr|struct
name|sample_header
operator|*
operator|)
operator|&
name|header
index|[
literal|48
operator|+
operator|(
name|i
operator|*
literal|32
operator|)
index|]
expr_stmt|;
name|len
operator|=
name|sample
operator|->
name|length
expr_stmt|;
name|loop_start
operator|=
name|sample
operator|->
name|loop_start
expr_stmt|;
name|loop_end
operator|=
name|sample
operator|->
name|loop_end
expr_stmt|;
name|base_freq
operator|=
name|sample
operator|->
name|C2_speed
expr_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|sample
operator|->
name|name
argument_list|)
operator|>
literal|21
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\nInvalid name for sample #%d\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|mod_fd
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|len
operator|>
literal|0
condition|)
block|{
name|int
name|x
decl_stmt|;
if|if
condition|(
name|loop_end
operator|>
name|len
condition|)
name|loop_end
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|loop_end
operator|<
name|loop_start
condition|)
block|{
name|loop_start
operator|=
literal|0
expr_stmt|;
name|loop_end
operator|=
literal|0
expr_stmt|;
block|}
else|else
name|loop_flags
operator|=
name|WAVE_LOOPING
expr_stmt|;
name|total_mem
operator|+=
name|len
expr_stmt|;
name|patch
operator|=
operator|(
expr|struct
name|patch_info
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|patch
argument_list|)
operator|+
name|len
argument_list|)
expr_stmt|;
name|patch
operator|->
name|key
operator|=
name|GUS_PATCH
expr_stmt|;
name|patch
operator|->
name|device_no
operator|=
name|gus_dev
expr_stmt|;
name|patch
operator|->
name|instr_no
operator|=
name|i
expr_stmt|;
name|patch
operator|->
name|mode
operator|=
name|loop_flags
expr_stmt|;
name|patch
operator|->
name|len
operator|=
name|len
expr_stmt|;
name|patch
operator|->
name|loop_start
operator|=
name|loop_start
expr_stmt|;
name|patch
operator|->
name|loop_end
operator|=
name|loop_end
expr_stmt|;
name|patch
operator|->
name|base_freq
operator|=
name|base_freq
expr_stmt|;
name|patch
operator|->
name|base_note
operator|=
literal|261630
expr_stmt|;
comment|/* Mid C */
name|patch
operator|->
name|low_note
operator|=
literal|0
expr_stmt|;
name|patch
operator|->
name|high_note
operator|=
literal|0x7fffffff
expr_stmt|;
name|patch
operator|->
name|volume
operator|=
literal|120
expr_stmt|;
if|if
condition|(
name|lseek
argument_list|(
name|mod_fd
argument_list|,
name|sample_ptr
argument_list|,
literal|0
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|mod_fd
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|patch
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|sample_ptr
operator|+=
name|len
expr_stmt|;
if|if
condition|(
operator|(
name|x
operator|=
name|read
argument_list|(
name|mod_fd
argument_list|,
name|patch
operator|->
name|data
argument_list|,
name|len
argument_list|)
operator|)
operator|!=
name|len
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Short file (sample at %d (%d!=%d)\n"
argument_list|,
name|sample_ptr
argument_list|,
name|x
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|mod_fd
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|patch
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Sample %02d: %05d, %05d, %05d, %07d %s\n"
argument_list|,
name|i
argument_list|,
name|len
argument_list|,
name|loop_start
argument_list|,
name|loop_end
argument_list|,
name|base_freq
argument_list|,
name|sample
operator|->
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|write
argument_list|(
name|seqfd
argument_list|,
name|patch
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|patch
argument_list|)
operator|+
name|len
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl /dev/sequencer"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
name|sample_ok
index|[
name|i
index|]
operator|=
literal|1
expr_stmt|;
name|free
argument_list|(
name|patch
argument_list|)
expr_stmt|;
block|}
block|}
name|nr_patterns
operator|=
name|slen
expr_stmt|;
name|songlength
operator|=
name|slen
expr_stmt|;
name|nr_channels
operator|=
literal|4
expr_stmt|;
for|for
control|(
name|position
operator|=
literal|0
init|;
name|position
operator|<
name|npat
condition|;
name|position
operator|++
control|)
block|{
name|unsigned
name|char
name|patterns
index|[
literal|64
index|]
index|[
literal|4
index|]
index|[
literal|4
index|]
decl_stmt|;
name|int
name|pat
decl_stmt|,
name|channel
decl_stmt|,
name|x
decl_stmt|;
name|int
name|pp
init|=
literal|1104
operator|+
operator|(
name|position
operator|*
literal|1024
operator|)
decl_stmt|;
if|if
condition|(
operator|(
name|pattern_table
index|[
name|position
index|]
operator|=
operator|(
name|pattern
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|note_info
argument_list|)
operator|*
literal|64
operator|*
name|nr_channels
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can't allocate memory for a pattern\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|lseek
argument_list|(
name|mod_fd
argument_list|,
name|pp
argument_list|,
literal|0
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|mod_fd
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|(
name|x
operator|=
name|read
argument_list|(
name|mod_fd
argument_list|,
name|patterns
argument_list|,
literal|1024
argument_list|)
operator|)
operator|!=
literal|1024
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Short file (pattern at %d), %d!=%d\n"
argument_list|,
name|pp
argument_list|,
name|x
argument_list|,
literal|1024
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|mod_fd
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
for|for
control|(
name|pat
operator|=
literal|0
init|;
name|pat
operator|<
literal|64
condition|;
name|pat
operator|++
control|)
block|{
for|for
control|(
name|channel
operator|=
literal|0
init|;
name|channel
operator|<
literal|4
condition|;
name|channel
operator|++
control|)
block|{
name|unsigned
name|char
modifier|*
name|p
decl_stmt|;
name|unsigned
name|vol
decl_stmt|,
name|note
decl_stmt|,
name|octave
decl_stmt|,
name|sample
decl_stmt|,
name|effect
decl_stmt|,
name|params
decl_stmt|;
name|p
operator|=
operator|&
name|patterns
index|[
name|pat
index|]
index|[
name|channel
index|]
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|p
index|[
literal|0
index|]
operator|<
literal|251
condition|)
block|{
name|note
operator|=
name|p
index|[
literal|0
index|]
operator|&
literal|15
expr_stmt|;
name|octave
operator|=
name|p
index|[
literal|0
index|]
operator|/
literal|16
expr_stmt|;
name|note
operator|=
literal|48
operator|+
name|octave
operator|*
literal|12
operator|+
name|note
expr_stmt|;
name|sample
operator|=
name|p
index|[
literal|1
index|]
operator|/
literal|8
expr_stmt|;
name|vol
operator|=
operator|(
name|p
index|[
literal|1
index|]
operator|&
literal|7
operator|)
operator|+
operator|(
name|p
index|[
literal|2
index|]
operator|/
literal|2
operator|)
expr_stmt|;
name|effect
operator|=
name|p
index|[
literal|2
index|]
operator|&
literal|0xF
expr_stmt|;
name|params
operator|=
name|p
index|[
literal|3
index|]
expr_stmt|;
block|}
else|else
block|{
name|note
operator|=
literal|0
expr_stmt|;
name|octave
operator|=
literal|0
expr_stmt|;
name|sample
operator|=
literal|0
expr_stmt|;
name|vol
operator|=
literal|0
expr_stmt|;
name|effect
operator|=
name|CMD_NONOTE
expr_stmt|;
name|params
operator|=
literal|0
expr_stmt|;
block|}
operator|(
operator|*
name|pattern_table
index|[
name|position
index|]
operator|)
index|[
name|channel
index|]
index|[
name|pat
index|]
operator|.
name|note
operator|=
name|note
expr_stmt|;
operator|(
operator|*
name|pattern_table
index|[
name|position
index|]
operator|)
index|[
name|channel
index|]
index|[
name|pat
index|]
operator|.
name|sample
operator|=
name|sample
expr_stmt|;
operator|(
operator|*
name|pattern_table
index|[
name|position
index|]
operator|)
index|[
name|channel
index|]
index|[
name|pat
index|]
operator|.
name|command
operator|=
name|effect
expr_stmt|;
operator|(
operator|*
name|pattern_table
index|[
name|position
index|]
operator|)
index|[
name|channel
index|]
index|[
name|pat
index|]
operator|.
name|parm1
operator|=
name|params
expr_stmt|;
operator|(
operator|*
name|pattern_table
index|[
name|position
index|]
operator|)
index|[
name|channel
index|]
index|[
name|pat
index|]
operator|.
name|parm2
operator|=
literal|0
expr_stmt|;
operator|(
operator|*
name|pattern_table
index|[
name|position
index|]
operator|)
index|[
name|channel
index|]
index|[
name|pat
index|]
operator|.
name|vol
operator|=
name|vol
expr_stmt|;
block|}
block|}
block|}
name|close
argument_list|(
name|mod_fd
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
name|int
name|load_669_module
parameter_list|(
name|int
name|mod_fd
parameter_list|,
name|char
modifier|*
name|name
parameter_list|)
block|{
struct|struct
name|sample_header
block|{
name|char
name|name
index|[
literal|13
index|]
decl_stmt|;
name|unsigned
name|long
name|length
decl_stmt|;
comment|/* In bytes */
name|unsigned
name|long
name|loop_start
decl_stmt|;
name|unsigned
name|long
name|loop_end
decl_stmt|;
block|}
struct|;
name|int
name|i
decl_stmt|,
name|total_mem
decl_stmt|;
name|int
name|sample_ptr
decl_stmt|;
name|int
name|position
decl_stmt|;
name|unsigned
name|char
modifier|*
name|tune_ptr
decl_stmt|,
modifier|*
name|len_ptr
decl_stmt|,
modifier|*
name|tempo_ptr
decl_stmt|;
comment|/* array 0-127 */
name|char
name|header
index|[
literal|1084
index|]
decl_stmt|;
name|char
name|msg
index|[
literal|110
index|]
decl_stmt|;
name|int
name|nr_samples
decl_stmt|;
comment|/* 16 or 32 samples */
name|int
name|slen
decl_stmt|,
name|npat
decl_stmt|;
name|clock_rate
operator|=
literal|25.0
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Loading .669 module: %s\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|read
argument_list|(
name|mod_fd
argument_list|,
name|header
argument_list|,
sizeof|sizeof
argument_list|(
name|header
argument_list|)
argument_list|)
operator|!=
sizeof|sizeof
argument_list|(
name|header
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: Short file (header)\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|mod_fd
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|*
operator|(
name|unsigned
name|short
operator|*
operator|)
operator|&
name|header
index|[
literal|0
index|]
operator|!=
literal|0x6669
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Not a 669 file\n"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|mod_fd
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|strncpy
argument_list|(
name|msg
argument_list|,
operator|&
name|header
index|[
literal|2
index|]
argument_list|,
literal|108
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|strlen
argument_list|(
name|msg
argument_list|)
condition|;
name|i
operator|++
control|)
if|if
condition|(
operator|(
name|msg
index|[
name|i
index|]
operator|>=
literal|' '
operator|&&
name|msg
index|[
name|i
index|]
operator|<=
literal|'z'
operator|)
operator|||
name|msg
index|[
name|i
index|]
operator|==
literal|'\n'
condition|)
name|printf
argument_list|(
literal|"%c"
argument_list|,
name|msg
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|npat
operator|=
name|header
index|[
literal|0x6f
index|]
expr_stmt|;
name|tune_ptr
operator|=
operator|&
name|header
index|[
literal|0x71
index|]
expr_stmt|;
for|for
control|(
name|slen
operator|=
literal|0
init|;
name|slen
operator|<
literal|128
operator|&&
name|tune_ptr
index|[
name|slen
index|]
operator|!=
literal|0xff
condition|;
name|slen
operator|++
control|)
empty_stmt|;
name|slen
operator|--
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|slen
condition|;
name|i
operator|++
control|)
name|tune
index|[
name|i
index|]
operator|=
name|tune_ptr
index|[
name|i
index|]
expr_stmt|;
name|len_ptr
operator|=
operator|&
name|header
index|[
literal|0x171
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|slen
condition|;
name|i
operator|++
control|)
name|pattern_len
index|[
name|i
index|]
operator|=
name|len_ptr
index|[
name|i
index|]
operator|-
literal|1
expr_stmt|;
name|tempo_ptr
operator|=
operator|&
name|header
index|[
literal|0xf1
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|slen
condition|;
name|i
operator|++
control|)
name|pattern_tempo
index|[
name|i
index|]
operator|=
name|tempo_ptr
index|[
name|i
index|]
expr_stmt|;
name|nr_samples
operator|=
name|header
index|[
literal|0x6e
index|]
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Song lenght %d, %d patterns, %d samples.\n"
argument_list|,
name|slen
argument_list|,
name|npat
argument_list|,
name|nr_samples
argument_list|)
expr_stmt|;
name|sample_ptr
operator|=
literal|0x1f1
operator|+
operator|(
name|nr_samples
operator|*
literal|0x19
operator|)
operator|+
operator|(
name|npat
operator|*
literal|0x600
operator|)
expr_stmt|;
comment|/* Location where the 								 * first sample is 								 * stored */
name|total_mem
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|64
condition|;
name|i
operator|++
control|)
name|sample_ok
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nr_samples
condition|;
name|i
operator|++
control|)
block|{
name|int
name|len
decl_stmt|,
name|loop_start
decl_stmt|,
name|loop_end
decl_stmt|;
name|unsigned
name|short
name|loop_flags
init|=
literal|0
decl_stmt|;
name|struct
name|sample_header
modifier|*
name|sample
decl_stmt|;
name|char
name|sname
index|[
literal|14
index|]
decl_stmt|;
name|struct
name|patch_info
modifier|*
name|patch
decl_stmt|;
name|sample
operator|=
operator|(
expr|struct
name|sample_header
operator|*
operator|)
operator|&
name|header
index|[
literal|0x1f1
operator|+
operator|(
name|i
operator|*
literal|0x19
operator|)
index|]
expr_stmt|;
name|len
operator|=
operator|*
operator|(
name|unsigned
name|long
operator|*
operator|)
operator|&
name|sample
operator|->
name|name
index|[
literal|13
index|]
expr_stmt|;
name|loop_start
operator|=
operator|*
operator|(
name|unsigned
name|long
operator|*
operator|)
operator|&
name|sample
operator|->
name|name
index|[
literal|17
index|]
expr_stmt|;
name|loop_end
operator|=
operator|*
operator|(
name|unsigned
name|long
operator|*
operator|)
operator|&
name|sample
operator|->
name|name
index|[
literal|21
index|]
expr_stmt|;
if|if
condition|(
name|loop_end
operator|>
name|len
condition|)
name|loop_end
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|loop_end
operator|==
name|len
condition|)
name|loop_end
operator|--
expr_stmt|;
if|if
condition|(
name|loop_end
operator|<
name|loop_start
condition|)
block|{
name|loop_start
operator|=
literal|0
expr_stmt|;
name|loop_end
operator|=
literal|0
expr_stmt|;
block|}
name|strncpy
argument_list|(
name|sname
argument_list|,
name|sample
operator|->
name|name
argument_list|,
literal|13
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
literal|0
operator|&&
name|len
operator|<
literal|200000
condition|)
block|{
name|total_mem
operator|+=
name|len
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Sample %02d: %05d, %05d, %05d   %s\n"
argument_list|,
name|i
argument_list|,
name|len
argument_list|,
name|loop_start
argument_list|,
name|loop_end
argument_list|,
name|sname
argument_list|)
expr_stmt|;
name|patch
operator|=
operator|(
expr|struct
name|patch_info
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|patch
argument_list|)
operator|+
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|loop_end
operator|==
literal|0
condition|)
name|loop_end
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|loop_end
operator|>=
name|len
condition|)
name|loop_end
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|loop_end
operator|>
literal|1
condition|)
name|loop_flags
operator|=
name|WAVE_LOOPING
expr_stmt|;
name|patch
operator|->
name|key
operator|=
name|GUS_PATCH
expr_stmt|;
name|patch
operator|->
name|device_no
operator|=
name|gus_dev
expr_stmt|;
name|patch
operator|->
name|instr_no
operator|=
name|i
expr_stmt|;
name|patch
operator|->
name|mode
operator|=
name|WAVE_UNSIGNED
operator||
name|loop_flags
expr_stmt|;
name|patch
operator|->
name|len
operator|=
name|len
expr_stmt|;
name|patch
operator|->
name|loop_start
operator|=
name|loop_start
expr_stmt|;
name|patch
operator|->
name|loop_end
operator|=
name|loop_end
expr_stmt|;
name|patch
operator|->
name|base_freq
operator|=
literal|8448
expr_stmt|;
name|patch
operator|->
name|base_note
operator|=
literal|261630
expr_stmt|;
name|patch
operator|->
name|low_note
operator|=
literal|1000
expr_stmt|;
name|patch
operator|->
name|high_note
operator|=
literal|0x7fffffff
expr_stmt|;
name|patch
operator|->
name|volume
operator|=
literal|120
expr_stmt|;
if|if
condition|(
name|lseek
argument_list|(
name|mod_fd
argument_list|,
name|sample_ptr
argument_list|,
literal|0
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Seek failed\n"
argument_list|)
expr_stmt|;
name|perror
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|mod_fd
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|patch
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|sample_ptr
operator|+=
name|len
expr_stmt|;
if|if
condition|(
name|read
argument_list|(
name|mod_fd
argument_list|,
name|patch
operator|->
name|data
argument_list|,
name|len
argument_list|)
operator|!=
name|len
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Short file (sample at %d)\n"
argument_list|,
name|sample_ptr
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|mod_fd
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|patch
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|write
argument_list|(
name|seqfd
argument_list|,
name|patch
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|patch
argument_list|)
operator|+
name|len
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl /dev/sequencer"
argument_list|)
expr_stmt|;
comment|/* exit (-1);	 */
block|}
else|else
name|sample_ok
index|[
name|i
index|]
operator|=
literal|1
expr_stmt|;
name|free
argument_list|(
name|patch
argument_list|)
expr_stmt|;
block|}
block|}
name|nr_patterns
operator|=
name|slen
expr_stmt|;
name|songlength
operator|=
name|slen
expr_stmt|;
name|nr_channels
operator|=
literal|8
expr_stmt|;
for|for
control|(
name|position
operator|=
literal|0
init|;
name|position
operator|<
name|npat
condition|;
name|position
operator|++
control|)
block|{
name|unsigned
name|char
name|patterns
index|[
literal|0x600
index|]
decl_stmt|;
name|int
name|pat
decl_stmt|,
name|channel
decl_stmt|,
name|x
decl_stmt|;
name|int
name|pp
init|=
literal|0x1f1
operator|+
operator|(
name|nr_samples
operator|*
literal|0x19
operator|)
operator|+
operator|(
name|position
operator|*
literal|0x600
operator|)
decl_stmt|;
if|if
condition|(
operator|(
name|pattern_table
index|[
name|position
index|]
operator|=
operator|(
name|pattern
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|note_info
argument_list|)
operator|*
literal|64
operator|*
name|nr_channels
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can't allocate memory for a pattern\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|lseek
argument_list|(
name|mod_fd
argument_list|,
name|pp
argument_list|,
literal|0
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|mod_fd
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|(
name|x
operator|=
name|read
argument_list|(
name|mod_fd
argument_list|,
name|patterns
argument_list|,
literal|1024
argument_list|)
operator|)
operator|!=
literal|1024
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Short file (pattern at %d) %d!=1024\n"
argument_list|,
name|pp
argument_list|,
name|x
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|mod_fd
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
for|for
control|(
name|pat
operator|=
literal|0
init|;
name|pat
operator|<
literal|64
condition|;
name|pat
operator|++
control|)
block|{
for|for
control|(
name|channel
operator|=
literal|0
init|;
name|channel
operator|<
literal|8
condition|;
name|channel
operator|++
control|)
block|{
name|unsigned
name|char
modifier|*
name|p
decl_stmt|;
name|unsigned
name|vol
decl_stmt|,
name|period
decl_stmt|,
name|sample
decl_stmt|,
name|effect
decl_stmt|,
name|params
decl_stmt|;
name|p
operator|=
operator|&
name|patterns
index|[
name|pat
operator|*
literal|24
operator|+
name|channel
operator|*
literal|3
index|]
expr_stmt|;
if|if
condition|(
name|p
index|[
literal|0
index|]
operator|>=
literal|0xfe
operator|||
operator|(
name|p
index|[
literal|0
index|]
operator|==
literal|0xff
operator|&&
name|p
index|[
literal|1
index|]
operator|==
literal|0xff
operator|&&
name|p
index|[
literal|2
index|]
operator|==
literal|0xff
operator|)
operator|||
operator|(
name|p
index|[
literal|0
index|]
operator|==
literal|0
operator|&&
name|p
index|[
literal|1
index|]
operator|==
literal|0
operator|&&
name|p
index|[
literal|2
index|]
operator|==
literal|0
operator|)
operator|||
operator|*
operator|(
name|int
operator|*
operator|)
name|p
operator|==
operator|-
literal|1
condition|)
block|{
name|period
operator|=
literal|0
expr_stmt|;
name|effect
operator|=
name|CMD_NONOTE
expr_stmt|;
name|sample
operator|=
literal|0
expr_stmt|;
name|vol
operator|=
literal|0
expr_stmt|;
name|params
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|p
index|[
literal|0
index|]
operator|==
literal|0
condition|)
block|{
name|effect
operator|=
name|CMD_BREAK
expr_stmt|;
name|params
operator|=
operator|-
literal|2
expr_stmt|;
block|}
block|}
else|else
block|{
name|period
operator|=
operator|(
name|p
index|[
literal|0
index|]
operator|>>
literal|2
operator|)
operator|+
literal|48
expr_stmt|;
name|effect
operator|=
operator|(
name|p
index|[
literal|2
index|]
operator|>>
literal|4
operator|)
expr_stmt|;
name|params
operator|=
name|p
index|[
literal|2
index|]
operator|&
literal|0x0f
expr_stmt|;
name|vol
operator|=
name|p
index|[
literal|1
index|]
operator|&
literal|0x0f
expr_stmt|;
if|if
condition|(
name|p
index|[
literal|2
index|]
operator|==
literal|0xfe
condition|)
block|{
name|effect
operator|=
name|CMD_VOLUME
expr_stmt|;
name|params
operator|=
name|vol
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|p
index|[
literal|2
index|]
operator|==
literal|0xff
condition|)
block|{
name|effect
operator|=
name|CMD_NOP
expr_stmt|;
block|}
else|else
switch|switch
condition|(
name|effect
condition|)
block|{
case|case
literal|0
case|:
comment|/* a - Portamento up */
name|effect
operator|=
name|CMD_SLIDEUP
expr_stmt|;
break|break;
case|case
literal|1
case|:
comment|/* b - Portamento down */
name|effect
operator|=
name|CMD_SLIDEDOWN
expr_stmt|;
break|break;
case|case
literal|2
case|:
comment|/* c - Port to note */
name|effect
operator|=
name|CMD_SLIDETO
expr_stmt|;
break|break;
case|case
literal|3
case|:
comment|/* d - Frequency adjust */
name|effect
operator|=
name|CMD_NOP
expr_stmt|;
comment|/* To be implemented */
break|break;
case|case
literal|4
case|:
comment|/* e - Frequency vibrato */
name|effect
operator|=
name|CMD_NOP
expr_stmt|;
comment|/* To be implemented */
break|break;
case|case
literal|5
case|:
comment|/* f - Set tempo */
name|effect
operator|=
name|CMD_SPEED
expr_stmt|;
break|break;
default|default:
name|effect
operator|=
name|CMD_NOP
expr_stmt|;
block|}
name|sample
operator|=
operator|(
operator|(
operator|(
name|p
index|[
literal|0
index|]
operator|<<
literal|4
operator|)
operator|&
literal|0x30
operator|)
operator||
operator|(
operator|(
name|p
index|[
literal|1
index|]
operator|>>
literal|4
operator|)
operator|&
literal|0x0f
operator|)
operator|)
operator|+
literal|1
expr_stmt|;
block|}
operator|(
operator|*
name|pattern_table
index|[
name|position
index|]
operator|)
index|[
name|channel
index|]
index|[
name|pat
index|]
operator|.
name|note
operator|=
name|period
expr_stmt|;
operator|(
operator|*
name|pattern_table
index|[
name|position
index|]
operator|)
index|[
name|channel
index|]
index|[
name|pat
index|]
operator|.
name|sample
operator|=
name|sample
expr_stmt|;
operator|(
operator|*
name|pattern_table
index|[
name|position
index|]
operator|)
index|[
name|channel
index|]
index|[
name|pat
index|]
operator|.
name|command
operator|=
name|effect
expr_stmt|;
operator|(
operator|*
name|pattern_table
index|[
name|position
index|]
operator|)
index|[
name|channel
index|]
index|[
name|pat
index|]
operator|.
name|parm1
operator|=
name|params
expr_stmt|;
operator|(
operator|*
name|pattern_table
index|[
name|position
index|]
operator|)
index|[
name|channel
index|]
index|[
name|pat
index|]
operator|.
name|parm2
operator|=
literal|0
expr_stmt|;
operator|(
operator|*
name|pattern_table
index|[
name|position
index|]
operator|)
index|[
name|channel
index|]
index|[
name|pat
index|]
operator|.
name|vol
operator|=
name|vol
expr_stmt|;
block|}
block|}
block|}
name|close
argument_list|(
name|mod_fd
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
name|int
name|load_mmd0_module
parameter_list|(
name|int
name|mod_fd
parameter_list|,
name|char
modifier|*
name|name
parameter_list|)
block|{
struct|struct
name|sample_header
block|{
name|unsigned
name|short
name|loop_start
decl_stmt|;
name|unsigned
name|short
name|loop_end
decl_stmt|;
name|unsigned
name|char
name|midich
decl_stmt|;
name|unsigned
name|char
name|midipreset
decl_stmt|;
name|unsigned
name|char
name|volume
decl_stmt|;
name|unsigned
name|char
name|strans
decl_stmt|;
block|}
struct|;
name|int
name|i
decl_stmt|,
name|total_mem
decl_stmt|;
name|int
name|sample_ptr
decl_stmt|;
name|int
name|position
decl_stmt|;
name|unsigned
name|char
modifier|*
name|tune_ptr
decl_stmt|;
comment|/* array 0-127 */
name|char
name|header
index|[
literal|1105
index|]
decl_stmt|;
name|int
name|nr_samples
decl_stmt|;
comment|/* 16 or 32 samples (or 64 or ???) */
name|int
name|slen
decl_stmt|,
name|npat
decl_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Loading .MED module: %s\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|read
argument_list|(
name|mod_fd
argument_list|,
name|header
argument_list|,
sizeof|sizeof
argument_list|(
name|header
argument_list|)
argument_list|)
operator|!=
sizeof|sizeof
argument_list|(
name|header
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: Short file (header)\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|mod_fd
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|strncmp
argument_list|(
name|header
argument_list|,
literal|"MMD0"
argument_list|,
literal|4
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Not a MED module\n"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|mod_fd
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|printf
argument_list|(
literal|"Module len %d\n"
argument_list|,
name|intelize4
argument_list|(
operator|*
operator|(
name|long
operator|*
operator|)
operator|&
name|header
index|[
literal|4
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Song info %d\n"
argument_list|,
name|intelize4
argument_list|(
operator|*
operator|(
name|long
operator|*
operator|)
operator|&
name|header
index|[
literal|8
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Song len %d\n"
argument_list|,
name|intelize4
argument_list|(
operator|*
operator|(
name|long
operator|*
operator|)
operator|&
name|header
index|[
literal|12
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Blockarr %x\n"
argument_list|,
name|intelize4
argument_list|(
operator|*
operator|(
name|long
operator|*
operator|)
operator|&
name|header
index|[
literal|16
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Blockarr len %d\n"
argument_list|,
name|intelize4
argument_list|(
operator|*
operator|(
name|long
operator|*
operator|)
operator|&
name|header
index|[
literal|20
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Sample array %x\n"
argument_list|,
name|intelize4
argument_list|(
operator|*
operator|(
name|long
operator|*
operator|)
operator|&
name|header
index|[
literal|24
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Sample array len %d\n"
argument_list|,
name|intelize4
argument_list|(
operator|*
operator|(
name|long
operator|*
operator|)
operator|&
name|header
index|[
literal|28
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Exp data %x\n"
argument_list|,
name|intelize4
argument_list|(
operator|*
operator|(
name|long
operator|*
operator|)
operator|&
name|header
index|[
literal|32
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Exp size %d\n"
argument_list|,
name|intelize4
argument_list|(
operator|*
operator|(
name|long
operator|*
operator|)
operator|&
name|header
index|[
literal|36
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Pstate %d\n"
argument_list|,
name|intelize
argument_list|(
operator|*
operator|(
name|long
operator|*
operator|)
operator|&
name|header
index|[
literal|40
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Pblock %d\n"
argument_list|,
name|intelize
argument_list|(
operator|*
operator|(
name|long
operator|*
operator|)
operator|&
name|header
index|[
literal|42
index|]
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|npat
operator|=
name|header
index|[
literal|33
index|]
expr_stmt|;
name|slen
operator|=
literal|0
expr_stmt|;
name|tune_ptr
operator|=
operator|&
name|header
index|[
literal|48
operator|+
operator|(
literal|31
operator|*
literal|32
operator|)
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|64
condition|;
name|i
operator|++
control|)
block|{
name|tune
index|[
name|i
index|]
operator|=
name|tune_ptr
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|tune
index|[
name|i
index|]
operator|<
name|npat
condition|)
name|slen
operator|=
name|i
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Song lenght %d, %d patterns.\n"
argument_list|,
name|slen
argument_list|,
name|npat
argument_list|)
expr_stmt|;
name|nr_samples
operator|=
literal|31
expr_stmt|;
name|sample_ptr
operator|=
literal|48
operator|+
operator|(
literal|31
operator|*
literal|32
operator|)
operator|+
literal|64
operator|+
operator|(
name|npat
operator|*
literal|1024
operator|)
expr_stmt|;
comment|/* Location where the 							 * first sample is 							 * stored */
name|total_mem
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
name|sample_ok
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nr_samples
condition|;
name|i
operator|++
control|)
block|{
name|int
name|len
decl_stmt|,
name|loop_start
decl_stmt|,
name|loop_end
decl_stmt|,
name|base_freq
decl_stmt|;
name|unsigned
name|short
name|loop_flags
init|=
literal|0
decl_stmt|;
name|struct
name|sample_header
modifier|*
name|sample
decl_stmt|;
name|struct
name|patch_info
modifier|*
name|patch
decl_stmt|;
name|sample
operator|=
operator|(
expr|struct
name|sample_header
operator|*
operator|)
operator|&
name|header
index|[
literal|48
operator|+
operator|(
name|i
operator|*
literal|32
operator|)
index|]
expr_stmt|;
comment|/*        * len = sample->length; loop_start = sample->loop_start; loop_end =        * sample->loop_end; base_freq = sample->C2_speed;        *         * if (strlen (sample->name)> 21) { fprintf (stderr, "\nInvalid name for        * sample #%d\n", i); close (mod_fd); return 0; }        */
if|if
condition|(
name|len
operator|>
literal|0
condition|)
block|{
name|int
name|x
decl_stmt|;
if|if
condition|(
name|loop_end
operator|>
name|len
condition|)
name|loop_end
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|loop_end
operator|<
name|loop_start
condition|)
block|{
name|loop_start
operator|=
literal|0
expr_stmt|;
name|loop_end
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|loop_end
operator|>
literal|2
condition|)
name|loop_flags
operator|=
name|WAVE_LOOPING
expr_stmt|;
name|total_mem
operator|+=
name|len
expr_stmt|;
name|patch
operator|=
operator|(
expr|struct
name|patch_info
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|patch
argument_list|)
operator|+
name|len
argument_list|)
expr_stmt|;
name|patch
operator|->
name|key
operator|=
name|GUS_PATCH
expr_stmt|;
name|patch
operator|->
name|device_no
operator|=
name|gus_dev
expr_stmt|;
name|patch
operator|->
name|instr_no
operator|=
name|i
expr_stmt|;
name|patch
operator|->
name|mode
operator|=
name|loop_flags
expr_stmt|;
name|patch
operator|->
name|len
operator|=
name|len
expr_stmt|;
name|patch
operator|->
name|loop_start
operator|=
name|loop_start
expr_stmt|;
name|patch
operator|->
name|loop_end
operator|=
name|loop_end
expr_stmt|;
name|patch
operator|->
name|base_freq
operator|=
name|base_freq
expr_stmt|;
name|patch
operator|->
name|base_note
operator|=
literal|261630
expr_stmt|;
comment|/* Mid C */
name|patch
operator|->
name|low_note
operator|=
literal|0
expr_stmt|;
name|patch
operator|->
name|high_note
operator|=
literal|0x7fffffff
expr_stmt|;
name|patch
operator|->
name|volume
operator|=
literal|120
expr_stmt|;
if|if
condition|(
name|lseek
argument_list|(
name|mod_fd
argument_list|,
name|sample_ptr
argument_list|,
literal|0
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|mod_fd
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|patch
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|sample_ptr
operator|+=
name|len
expr_stmt|;
if|if
condition|(
operator|(
name|x
operator|=
name|read
argument_list|(
name|mod_fd
argument_list|,
name|patch
operator|->
name|data
argument_list|,
name|len
argument_list|)
operator|)
operator|!=
name|len
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Short file (sample at %d (%d!=%d)\n"
argument_list|,
name|sample_ptr
argument_list|,
name|x
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|mod_fd
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|patch
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* 	   * fprintf (stderr, "Sample %02d: %05d, %05d, %05d, %07d %s\n", i, 	   * len, loop_start, loop_end, base_freq, sample->name); 	   */
if|if
condition|(
name|write
argument_list|(
name|seqfd
argument_list|,
name|patch
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|patch
argument_list|)
operator|+
name|len
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl /dev/sequencer"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
name|sample_ok
index|[
name|i
index|]
operator|=
literal|1
expr_stmt|;
name|free
argument_list|(
name|patch
argument_list|)
expr_stmt|;
block|}
block|}
name|nr_patterns
operator|=
name|slen
expr_stmt|;
name|songlength
operator|=
name|slen
expr_stmt|;
name|nr_channels
operator|=
literal|4
expr_stmt|;
for|for
control|(
name|position
operator|=
literal|0
init|;
name|position
operator|<
name|npat
condition|;
name|position
operator|++
control|)
block|{
name|unsigned
name|char
name|patterns
index|[
literal|64
index|]
index|[
literal|4
index|]
index|[
literal|4
index|]
decl_stmt|;
name|int
name|pat
decl_stmt|,
name|channel
decl_stmt|,
name|x
decl_stmt|;
name|int
name|pp
init|=
literal|1104
operator|+
operator|(
name|position
operator|*
literal|1024
operator|)
decl_stmt|;
if|if
condition|(
operator|(
name|pattern_table
index|[
name|position
index|]
operator|=
operator|(
name|pattern
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|note_info
argument_list|)
operator|*
literal|64
operator|*
name|nr_channels
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can't allocate memory for a pattern\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|lseek
argument_list|(
name|mod_fd
argument_list|,
name|pp
argument_list|,
literal|0
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|mod_fd
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|(
name|x
operator|=
name|read
argument_list|(
name|mod_fd
argument_list|,
name|patterns
argument_list|,
literal|1024
argument_list|)
operator|)
operator|!=
literal|1024
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Short file (pattern at %d), %d!=%d\n"
argument_list|,
name|pp
argument_list|,
name|x
argument_list|,
literal|1024
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|mod_fd
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
for|for
control|(
name|pat
operator|=
literal|0
init|;
name|pat
operator|<
literal|64
condition|;
name|pat
operator|++
control|)
block|{
for|for
control|(
name|channel
operator|=
literal|0
init|;
name|channel
operator|<
literal|4
condition|;
name|channel
operator|++
control|)
block|{
name|unsigned
name|char
modifier|*
name|p
decl_stmt|;
name|unsigned
name|vol
decl_stmt|,
name|note
decl_stmt|,
name|octave
decl_stmt|,
name|sample
decl_stmt|,
name|effect
decl_stmt|,
name|params
decl_stmt|;
name|p
operator|=
operator|&
name|patterns
index|[
name|pat
index|]
index|[
name|channel
index|]
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|p
index|[
literal|0
index|]
operator|<
literal|251
condition|)
block|{
name|note
operator|=
name|p
index|[
literal|0
index|]
operator|&
literal|15
expr_stmt|;
name|octave
operator|=
name|p
index|[
literal|0
index|]
operator|/
literal|16
expr_stmt|;
name|note
operator|=
literal|48
operator|+
name|octave
operator|*
literal|12
operator|+
name|note
expr_stmt|;
name|sample
operator|=
name|p
index|[
literal|1
index|]
operator|/
literal|8
expr_stmt|;
name|vol
operator|=
operator|(
name|p
index|[
literal|1
index|]
operator|&
literal|7
operator|)
operator|+
operator|(
name|p
index|[
literal|2
index|]
operator|/
literal|2
operator|)
expr_stmt|;
name|effect
operator|=
name|p
index|[
literal|2
index|]
operator|&
literal|0xF
expr_stmt|;
name|params
operator|=
name|p
index|[
literal|3
index|]
expr_stmt|;
block|}
else|else
block|{
name|note
operator|=
literal|0
expr_stmt|;
name|octave
operator|=
literal|0
expr_stmt|;
name|sample
operator|=
literal|0
expr_stmt|;
name|vol
operator|=
literal|0
expr_stmt|;
name|effect
operator|=
name|CMD_NONOTE
expr_stmt|;
name|params
operator|=
literal|0
expr_stmt|;
block|}
operator|(
operator|*
name|pattern_table
index|[
name|position
index|]
operator|)
index|[
name|channel
index|]
index|[
name|pat
index|]
operator|.
name|note
operator|=
name|note
expr_stmt|;
operator|(
operator|*
name|pattern_table
index|[
name|position
index|]
operator|)
index|[
name|channel
index|]
index|[
name|pat
index|]
operator|.
name|sample
operator|=
name|sample
expr_stmt|;
operator|(
operator|*
name|pattern_table
index|[
name|position
index|]
operator|)
index|[
name|channel
index|]
index|[
name|pat
index|]
operator|.
name|command
operator|=
name|effect
expr_stmt|;
operator|(
operator|*
name|pattern_table
index|[
name|position
index|]
operator|)
index|[
name|channel
index|]
index|[
name|pat
index|]
operator|.
name|parm1
operator|=
name|params
expr_stmt|;
operator|(
operator|*
name|pattern_table
index|[
name|position
index|]
operator|)
index|[
name|channel
index|]
index|[
name|pat
index|]
operator|.
name|parm2
operator|=
literal|0
expr_stmt|;
operator|(
operator|*
name|pattern_table
index|[
name|position
index|]
operator|)
index|[
name|channel
index|]
index|[
name|pat
index|]
operator|.
name|vol
operator|=
name|vol
expr_stmt|;
block|}
block|}
block|}
name|close
argument_list|(
name|mod_fd
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
name|int
name|load_module
parameter_list|(
name|char
modifier|*
name|name
parameter_list|)
block|{
struct|struct
name|sample_header
block|{
name|char
name|name
index|[
literal|22
index|]
decl_stmt|;
name|unsigned
name|short
name|length
decl_stmt|;
comment|/* In words */
name|unsigned
name|char
name|finetune
decl_stmt|;
name|unsigned
name|char
name|volume
decl_stmt|;
name|unsigned
name|short
name|repeat_point
decl_stmt|;
comment|/* In words */
name|unsigned
name|short
name|repeat_length
decl_stmt|;
comment|/* In words */
block|}
struct|;
name|int
name|i
decl_stmt|,
name|mod_fd
decl_stmt|,
name|total_mem
decl_stmt|;
name|int
name|sample_ptr
decl_stmt|,
name|pattern_loc
decl_stmt|;
name|int
name|position
decl_stmt|;
name|unsigned
name|char
modifier|*
name|tune_ptr
decl_stmt|;
comment|/* array 0-127 */
name|char
name|header
index|[
literal|1084
index|]
decl_stmt|;
name|int
name|nr_samples
decl_stmt|;
comment|/* 16 or 32 samples */
name|int
name|slen
decl_stmt|,
name|npat
decl_stmt|;
name|char
name|mname
index|[
literal|23
index|]
decl_stmt|;
name|ioctl
argument_list|(
name|seqfd
argument_list|,
name|SNDCTL_SEQ_SYNC
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ioctl
argument_list|(
name|seqfd
argument_list|,
name|SNDCTL_SEQ_RESETSAMPLES
argument_list|,
operator|&
name|gus_dev
argument_list|)
expr_stmt|;
name|clock_rate
operator|=
literal|50.0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_POSITION
condition|;
name|i
operator|++
control|)
name|pattern_len
index|[
name|i
index|]
operator|=
literal|64
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_POSITION
condition|;
name|i
operator|++
control|)
name|pattern_tempo
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|mod_fd
operator|=
name|open
argument_list|(
name|name
argument_list|,
name|O_RDONLY
argument_list|,
literal|0
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
name|name
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|read
argument_list|(
name|mod_fd
argument_list|,
name|header
argument_list|,
sizeof|sizeof
argument_list|(
name|header
argument_list|)
argument_list|)
operator|!=
sizeof|sizeof
argument_list|(
name|header
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: Short file (header)\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|mod_fd
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|lseek
argument_list|(
name|mod_fd
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|mod_fd
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|header
index|[
literal|28
index|]
operator|==
literal|0x1a
condition|)
return|return
name|load_stm_module
argument_list|(
name|mod_fd
argument_list|,
name|name
argument_list|)
return|;
if|if
condition|(
operator|*
operator|(
name|unsigned
name|short
operator|*
operator|)
operator|&
name|header
index|[
literal|0
index|]
operator|==
literal|0x6669
condition|)
return|return
name|load_669_module
argument_list|(
name|mod_fd
argument_list|,
name|name
argument_list|)
return|;
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|header
argument_list|,
literal|"MMD0"
argument_list|,
literal|4
argument_list|)
condition|)
return|return
name|load_mmd0_module
argument_list|(
name|mod_fd
argument_list|,
name|name
argument_list|)
return|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Loading .MOD module: %s\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|mname
argument_list|,
name|header
argument_list|,
literal|22
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\nModule: %s - "
argument_list|,
name|mname
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|strncmp
argument_list|(
operator|&
name|header
index|[
literal|1080
index|]
argument_list|,
literal|"M.K."
argument_list|,
literal|4
argument_list|)
operator|||
operator|!
name|strncmp
argument_list|(
operator|&
name|header
index|[
literal|1080
index|]
argument_list|,
literal|"FLT8"
argument_list|,
literal|4
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"31 samples\n"
argument_list|)
expr_stmt|;
name|nr_samples
operator|=
literal|31
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"15 samples\n"
argument_list|)
expr_stmt|;
name|nr_samples
operator|=
literal|15
expr_stmt|;
block|}
if|if
condition|(
name|nr_samples
operator|==
literal|31
condition|)
block|{
name|sample_ptr
operator|=
name|pattern_loc
operator|=
literal|1084
expr_stmt|;
name|slen
operator|=
name|header
index|[
literal|950
index|]
expr_stmt|;
name|tune_ptr
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
operator|&
name|header
index|[
literal|952
index|]
expr_stmt|;
block|}
else|else
block|{
name|sample_ptr
operator|=
name|pattern_loc
operator|=
literal|600
expr_stmt|;
name|slen
operator|=
name|header
index|[
literal|470
index|]
expr_stmt|;
name|tune_ptr
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
operator|&
name|header
index|[
literal|472
index|]
expr_stmt|;
block|}
name|npat
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|128
condition|;
name|i
operator|++
control|)
block|{
name|tune
index|[
name|i
index|]
operator|=
name|tune_ptr
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|tune_ptr
index|[
name|i
index|]
operator|>
name|npat
condition|)
name|npat
operator|=
name|tune_ptr
index|[
name|i
index|]
expr_stmt|;
block|}
name|npat
operator|++
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Song lenght %d, %d patterns.\n"
argument_list|,
name|slen
argument_list|,
name|npat
argument_list|)
expr_stmt|;
name|sample_ptr
operator|+=
operator|(
name|npat
operator|*
literal|1024
operator|)
expr_stmt|;
comment|/* Location where the first sample is stored */
name|total_mem
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
name|sample_ok
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nr_samples
condition|;
name|i
operator|++
control|)
block|{
name|int
name|len
decl_stmt|,
name|loop_start
decl_stmt|,
name|loop_end
decl_stmt|;
name|unsigned
name|short
name|loop_flags
init|=
literal|0
decl_stmt|;
name|char
name|pname
index|[
literal|22
index|]
decl_stmt|;
name|struct
name|sample_header
modifier|*
name|sample
decl_stmt|;
name|struct
name|patch_info
modifier|*
name|patch
decl_stmt|;
name|sample
operator|=
operator|(
expr|struct
name|sample_header
operator|*
operator|)
operator|&
name|header
index|[
literal|20
operator|+
operator|(
name|i
operator|*
literal|30
operator|)
index|]
expr_stmt|;
name|len
operator|=
name|intelize
argument_list|(
name|sample
operator|->
name|length
argument_list|)
operator|*
literal|2
expr_stmt|;
name|loop_start
operator|=
name|intelize
argument_list|(
name|sample
operator|->
name|repeat_point
argument_list|)
operator|*
literal|2
expr_stmt|;
name|loop_end
operator|=
name|loop_start
operator|+
operator|(
name|intelize
argument_list|(
name|sample
operator|->
name|repeat_length
argument_list|)
operator|*
literal|2
operator|)
expr_stmt|;
if|if
condition|(
name|loop_start
operator|>
name|len
condition|)
name|loop_start
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|loop_end
operator|>
name|len
condition|)
name|loop_end
operator|=
name|len
expr_stmt|;
if|if
condition|(
name|loop_end
operator|<=
name|loop_start
condition|)
name|loop_end
operator|=
name|loop_start
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|loop_end
operator|>
literal|2
operator|&&
name|loop_end
operator|>
name|loop_start
condition|)
name|loop_flags
operator|=
name|WAVE_LOOPING
expr_stmt|;
name|strncpy
argument_list|(
name|pname
argument_list|,
name|sample
operator|->
name|name
argument_list|,
literal|20
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Sample %02d: L%05d, S%05d, E%05d V%02d %s\n"
argument_list|,
name|i
argument_list|,
name|len
argument_list|,
name|loop_start
argument_list|,
name|loop_end
argument_list|,
name|sample
operator|->
name|volume
argument_list|,
name|pname
argument_list|)
expr_stmt|;
name|total_mem
operator|+=
name|len
expr_stmt|;
name|patch
operator|=
operator|(
expr|struct
name|patch_info
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|patch
argument_list|)
operator|+
name|len
argument_list|)
expr_stmt|;
name|patch
operator|->
name|key
operator|=
name|GUS_PATCH
expr_stmt|;
name|patch
operator|->
name|device_no
operator|=
name|gus_dev
expr_stmt|;
name|patch
operator|->
name|instr_no
operator|=
name|i
expr_stmt|;
name|patch
operator|->
name|mode
operator|=
name|loop_flags
expr_stmt|;
name|patch
operator|->
name|len
operator|=
name|len
expr_stmt|;
name|patch
operator|->
name|loop_start
operator|=
name|loop_start
expr_stmt|;
name|patch
operator|->
name|loop_end
operator|=
name|loop_end
expr_stmt|;
name|patch
operator|->
name|base_note
operator|=
literal|261630
expr_stmt|;
comment|/* Middle C */
name|patch
operator|->
name|base_freq
operator|=
literal|8448
expr_stmt|;
name|patch
operator|->
name|low_note
operator|=
literal|0
expr_stmt|;
name|patch
operator|->
name|high_note
operator|=
literal|20000000
expr_stmt|;
name|patch
operator|->
name|volume
operator|=
literal|120
expr_stmt|;
name|patch
operator|->
name|panning
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|lseek
argument_list|(
name|mod_fd
argument_list|,
name|sample_ptr
argument_list|,
literal|0
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|mod_fd
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|patch
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|sample_ptr
operator|+=
name|len
expr_stmt|;
if|if
condition|(
name|read
argument_list|(
name|mod_fd
argument_list|,
name|patch
operator|->
name|data
argument_list|,
name|len
argument_list|)
operator|!=
name|len
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Short file (sample) %d\n"
argument_list|,
name|sample_ptr
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|mod_fd
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|patch
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|SEQ_WRPATCH
argument_list|(
name|patch
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|patch
argument_list|)
operator|+
name|len
argument_list|)
expr_stmt|;
name|sample_ok
index|[
name|i
index|]
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|sample
operator|->
name|volume
operator|==
literal|0
condition|)
name|sample
operator|->
name|volume
operator|=
literal|64
expr_stmt|;
name|sample_vol
index|[
name|i
index|]
operator|=
name|sample
operator|->
name|volume
expr_stmt|;
name|free
argument_list|(
name|patch
argument_list|)
expr_stmt|;
block|}
block|}
name|nr_patterns
operator|=
name|npat
expr_stmt|;
name|songlength
operator|=
name|slen
expr_stmt|;
name|nr_channels
operator|=
literal|4
expr_stmt|;
for|for
control|(
name|position
operator|=
literal|0
init|;
name|position
operator|<
name|npat
condition|;
name|position
operator|++
control|)
block|{
name|unsigned
name|char
name|patterns
index|[
literal|64
index|]
index|[
literal|4
index|]
index|[
literal|4
index|]
decl_stmt|;
name|int
name|pat
decl_stmt|,
name|channel
decl_stmt|;
name|int
name|pp
init|=
name|pattern_loc
operator|+
operator|(
name|position
operator|*
literal|1024
operator|)
decl_stmt|;
if|if
condition|(
name|lseek
argument_list|(
name|mod_fd
argument_list|,
name|pp
argument_list|,
literal|0
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|mod_fd
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|read
argument_list|(
name|mod_fd
argument_list|,
name|patterns
argument_list|,
literal|1024
argument_list|)
operator|!=
literal|1024
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Short file (pattern %d) %d\n"
argument_list|,
name|tune
index|[
name|position
index|]
argument_list|,
name|pp
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|mod_fd
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|(
name|pattern_table
index|[
name|position
index|]
operator|=
operator|(
name|pattern
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|note_info
argument_list|)
operator|*
literal|64
operator|*
name|nr_channels
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can't allocate memory for a pattern\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
for|for
control|(
name|pat
operator|=
literal|0
init|;
name|pat
operator|<
literal|64
condition|;
name|pat
operator|++
control|)
block|{
for|for
control|(
name|channel
operator|=
literal|0
init|;
name|channel
operator|<
literal|4
condition|;
name|channel
operator|++
control|)
block|{
name|unsigned
name|short
name|tmp
decl_stmt|;
name|unsigned
name|char
modifier|*
name|p
decl_stmt|;
name|unsigned
name|period
decl_stmt|,
name|sample
decl_stmt|,
name|effect
decl_stmt|,
name|params
decl_stmt|,
name|note
decl_stmt|,
name|vol
decl_stmt|;
name|p
operator|=
operator|&
name|patterns
index|[
name|pat
index|]
index|[
name|channel
index|]
index|[
literal|0
index|]
expr_stmt|;
name|tmp
operator|=
operator|(
name|p
index|[
literal|0
index|]
operator|<<
literal|8
operator|)
operator||
name|p
index|[
literal|1
index|]
expr_stmt|;
name|sample
operator|=
operator|(
name|tmp
operator|>>
literal|8
operator|)
operator|&
literal|0x10
expr_stmt|;
name|period
operator|=
name|MIN
argument_list|(
name|tmp
operator|&
literal|0xFFF
argument_list|,
literal|1023
argument_list|)
expr_stmt|;
name|tmp
operator|=
operator|(
name|p
index|[
literal|2
index|]
operator|<<
literal|8
operator|)
operator||
name|p
index|[
literal|3
index|]
expr_stmt|;
name|sample
operator||=
name|tmp
operator|>>
literal|12
expr_stmt|;
name|effect
operator|=
operator|(
name|tmp
operator|>>
literal|8
operator|)
operator|&
literal|0xF
expr_stmt|;
name|params
operator|=
name|tmp
operator|&
literal|0xFF
expr_stmt|;
name|note
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|period
condition|)
block|{
comment|/* 		   * Convert period to a Midi note number 		   */
for|for
control|(
name|note
operator|=
literal|0
init|;
name|note
operator|<
literal|37
operator|&&
name|period
operator|!=
name|period_table
index|[
name|note
index|]
condition|;
name|note
operator|++
control|)
empty_stmt|;
if|if
condition|(
name|note
operator|>=
literal|37
condition|)
name|note
operator|=
literal|0
expr_stmt|;
name|note
operator|+=
literal|48
expr_stmt|;
block|}
name|vol
operator|=
literal|64
expr_stmt|;
if|if
condition|(
name|sample
condition|)
if|if
condition|(
name|effect
operator|==
literal|0xc
condition|)
block|{
name|vol
operator|=
name|params
expr_stmt|;
block|}
else|else
name|vol
operator|=
name|sample_vol
index|[
name|sample
operator|-
literal|1
index|]
expr_stmt|;
name|vol
operator|*=
literal|2
expr_stmt|;
if|if
condition|(
name|vol
operator|>
literal|64
condition|)
name|vol
operator|--
expr_stmt|;
operator|(
operator|*
name|pattern_table
index|[
name|position
index|]
operator|)
index|[
name|channel
index|]
index|[
name|pat
index|]
operator|.
name|note
operator|=
name|note
expr_stmt|;
operator|(
operator|*
name|pattern_table
index|[
name|position
index|]
operator|)
index|[
name|channel
index|]
index|[
name|pat
index|]
operator|.
name|sample
operator|=
name|sample
expr_stmt|;
operator|(
operator|*
name|pattern_table
index|[
name|position
index|]
operator|)
index|[
name|channel
index|]
index|[
name|pat
index|]
operator|.
name|command
operator|=
name|effect
expr_stmt|;
operator|(
operator|*
name|pattern_table
index|[
name|position
index|]
operator|)
index|[
name|channel
index|]
index|[
name|pat
index|]
operator|.
name|parm1
operator|=
name|params
expr_stmt|;
operator|(
operator|*
name|pattern_table
index|[
name|position
index|]
operator|)
index|[
name|channel
index|]
index|[
name|pat
index|]
operator|.
name|parm2
operator|=
literal|0
expr_stmt|;
operator|(
operator|*
name|pattern_table
index|[
name|position
index|]
operator|)
index|[
name|channel
index|]
index|[
name|pat
index|]
operator|.
name|vol
operator|=
name|vol
expr_stmt|;
block|}
block|}
block|}
name|close
argument_list|(
name|mod_fd
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
name|int
name|panning
parameter_list|(
name|int
name|ch
parameter_list|)
block|{
specifier|static
name|int
name|panning_tab
index|[]
init|=
block|{
operator|-
literal|110
block|,
literal|110
block|,
literal|110
block|,
operator|-
literal|110
block|}
decl_stmt|;
return|return
name|panning_tab
index|[
name|ch
operator|%
literal|4
index|]
return|;
block|}
end_function

begin_function
name|void
name|set_speed
parameter_list|(
name|int
name|parm
parameter_list|)
block|{
if|if
condition|(
operator|!
name|parm
condition|)
name|parm
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|parm
operator|<
literal|32
condition|)
block|{
name|ticks_per_division
operator|=
name|parm
expr_stmt|;
block|}
else|else
block|{
name|tick_duration
operator|=
operator|(
literal|60.0
operator|/
name|parm
operator|)
operator|*
literal|10.0
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|play_module
parameter_list|(
name|char
modifier|*
name|name
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|position
decl_stmt|,
name|jump_to_pos
decl_stmt|;
name|init_voices
argument_list|()
expr_stmt|;
name|SEQ_START_TIMER
argument_list|()
expr_stmt|;
if|#
directive|if
literal|1
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
block|{
name|SEQ_EXPRESSION
argument_list|(
name|gus_dev
argument_list|,
name|i
argument_list|,
literal|127
argument_list|)
expr_stmt|;
name|SEQ_MAIN_VOLUME
argument_list|(
name|gus_dev
argument_list|,
name|i
argument_list|,
literal|100
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|next_time
operator|=
literal|0.0
expr_stmt|;
name|set_speed
argument_list|(
literal|6
argument_list|)
expr_stmt|;
for|for
control|(
name|position
operator|=
literal|0
init|;
name|position
operator|<
name|songlength
condition|;
name|position
operator|++
control|)
block|{
name|int
name|tick
decl_stmt|,
name|pattern
decl_stmt|,
name|channel
decl_stmt|,
name|pos
decl_stmt|,
name|go_to
decl_stmt|;
name|pos
operator|=
name|tune
index|[
name|position
index|]
expr_stmt|;
if|if
condition|(
name|pattern_tempo
index|[
name|position
index|]
condition|)
name|set_speed
argument_list|(
name|pattern_tempo
index|[
name|position
index|]
argument_list|)
expr_stmt|;
name|jump_to_pos
operator|=
operator|-
literal|1
expr_stmt|;
for|for
control|(
name|pattern
operator|=
literal|0
init|;
name|pattern
operator|<
name|pattern_len
index|[
name|position
index|]
operator|&&
name|jump_to_pos
operator|==
operator|-
literal|1
condition|;
name|pattern
operator|++
control|)
block|{
name|this_time
operator|=
literal|0.0
expr_stmt|;
for|for
control|(
name|channel
operator|=
literal|0
init|;
name|channel
operator|<
name|nr_channels
condition|;
name|channel
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|go_to
operator|=
name|play_note
argument_list|(
name|channel
argument_list|,
operator|&
operator|(
operator|*
name|pattern_table
index|[
name|pos
index|]
operator|)
index|[
name|channel
index|]
index|[
name|pattern
index|]
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
name|jump_to_pos
operator|=
name|go_to
expr_stmt|;
block|}
name|next_time
operator|+=
name|tick_duration
expr_stmt|;
for|for
control|(
name|tick
operator|=
literal|1
init|;
name|tick
operator|<
name|ticks_per_division
condition|;
name|tick
operator|++
control|)
block|{
for|for
control|(
name|channel
operator|=
literal|0
init|;
name|channel
operator|<
name|nr_channels
condition|;
name|channel
operator|++
control|)
name|lets_play_voice
argument_list|(
name|channel
argument_list|,
operator|&
name|voices
index|[
name|channel
index|]
argument_list|)
expr_stmt|;
name|next_time
operator|+=
name|tick_duration
expr_stmt|;
block|}
block|}
if|if
condition|(
name|jump_to_pos
operator|>=
literal|0
condition|)
name|position
operator|=
name|jump_to_pos
expr_stmt|;
block|}
name|SEQ_WAIT_TIME
argument_list|(
operator|(
name|int
operator|)
name|next_time
operator|+
literal|200
argument_list|)
expr_stmt|;
comment|/* Wait extra 2 secs */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nr_channels
condition|;
name|i
operator|++
control|)
name|SEQ_STOP_NOTE
argument_list|(
name|gus_dev
argument_list|,
name|i
argument_list|,
literal|0
argument_list|,
literal|127
argument_list|)
expr_stmt|;
name|SEQ_DUMPBUF
argument_list|()
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nr_patterns
condition|;
name|i
operator|++
control|)
name|free
argument_list|(
name|pattern_table
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|sync_time
parameter_list|()
block|{
if|if
condition|(
name|next_time
operator|>
name|this_time
condition|)
block|{
name|SEQ_WAIT_TIME
argument_list|(
operator|(
name|long
operator|)
name|next_time
argument_list|)
expr_stmt|;
name|this_time
operator|=
name|next_time
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|set_volslide
parameter_list|(
name|int
name|channel
parameter_list|,
name|struct
name|note_info
modifier|*
name|pat
parameter_list|)
block|{
name|int
name|n
decl_stmt|;
name|voices
index|[
name|channel
index|]
operator|.
name|volslide
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|n
operator|=
operator|(
name|pat
operator|->
name|parm1
operator|&
literal|0xf0
operator|)
operator|>>
literal|4
operator|)
condition|)
name|voices
index|[
name|channel
index|]
operator|.
name|volslide
operator|=
name|n
expr_stmt|;
else|else
name|voices
index|[
name|channel
index|]
operator|.
name|volslide
operator|=
name|pat
operator|->
name|parm1
operator|&
literal|0xf
expr_stmt|;
block|}
end_function

begin_function
name|void
name|set_slideto
parameter_list|(
name|int
name|channel
parameter_list|,
name|struct
name|note_info
modifier|*
name|pat
parameter_list|)
block|{
name|int
name|size
decl_stmt|,
name|rate
decl_stmt|,
name|dir
decl_stmt|,
name|range
init|=
literal|200
decl_stmt|;
name|rate
operator|=
name|pat
operator|->
name|parm1
expr_stmt|;
name|size
operator|=
name|voices
index|[
name|channel
index|]
operator|.
name|note
operator|-
name|pat
operator|->
name|note
expr_stmt|;
if|if
condition|(
operator|!
name|size
condition|)
return|return;
if|if
condition|(
name|size
operator|<
literal|0
condition|)
block|{
name|size
operator|*=
operator|-
literal|1
expr_stmt|;
name|dir
operator|=
operator|-
literal|1
expr_stmt|;
block|}
else|else
name|dir
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|size
operator|>
literal|2
condition|)
block|{
name|range
operator|=
name|size
operator|*
literal|100
expr_stmt|;
name|rate
operator|=
name|rate
operator|*
name|size
operator|/
literal|200
expr_stmt|;
block|}
name|rate
operator|=
name|pat
operator|->
name|parm1
operator|*
name|dir
operator|/
literal|30
expr_stmt|;
if|if
condition|(
operator|!
name|rate
condition|)
name|rate
operator|=
literal|1
expr_stmt|;
name|voices
index|[
name|channel
index|]
operator|.
name|slide_pitch
operator|=
literal|1
expr_stmt|;
name|voices
index|[
name|channel
index|]
operator|.
name|slide_goal
operator|=
operator|(
name|dir
operator|*
literal|8192
operator|*
literal|200
operator|*
literal|2
operator|/
name|size
operator|)
operator|/
name|range
expr_stmt|;
name|voices
index|[
name|channel
index|]
operator|.
name|pitchbender
operator|=
literal|0
expr_stmt|;
name|voices
index|[
name|channel
index|]
operator|.
name|slide_rate
operator|=
name|rate
expr_stmt|;
name|SEQ_BENDER_RANGE
argument_list|(
name|gus_dev
argument_list|,
name|channel
argument_list|,
name|range
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|play_note
parameter_list|(
name|int
name|channel
parameter_list|,
name|struct
name|note_info
modifier|*
name|pat
parameter_list|)
block|{
name|int
name|jump
init|=
operator|-
literal|1
decl_stmt|;
name|int
name|sample
decl_stmt|;
if|if
condition|(
name|pat
operator|->
name|sample
operator|==
literal|0x3f
condition|)
name|pat
operator|->
name|sample
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|pat
operator|->
name|command
operator|==
name|CMD_NONOTE
condition|)
return|return
operator|-
literal|1
return|;
comment|/* Undefined */
name|sample
operator|=
name|pat
operator|->
name|sample
expr_stmt|;
if|if
condition|(
name|sample
operator|&&
operator|!
name|pat
operator|->
name|note
condition|)
block|{
name|pat
operator|->
name|note
operator|=
name|voices
index|[
name|channel
index|]
operator|.
name|note
expr_stmt|;
block|}
if|if
condition|(
name|sample
condition|)
name|voices
index|[
name|channel
index|]
operator|.
name|sample
operator|=
name|sample
expr_stmt|;
else|else
name|sample
operator|=
name|voices
index|[
name|channel
index|]
operator|.
name|sample
expr_stmt|;
name|sample
operator|--
expr_stmt|;
if|if
condition|(
name|pat
operator|->
name|note
operator|&&
name|pat
operator|->
name|command
operator|!=
literal|3
condition|)
comment|/* Have a note -> play */
block|{
if|if
condition|(
name|sample
operator|<
literal|0
condition|)
name|sample
operator|=
name|voices
index|[
name|channel
index|]
operator|.
name|sample
operator|-
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|sample_ok
index|[
name|sample
index|]
condition|)
name|sample
operator|=
name|voices
index|[
name|channel
index|]
operator|.
name|sample
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|sample
operator|<
literal|0
condition|)
name|sample
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|sample_ok
index|[
name|sample
index|]
condition|)
block|{
name|sync_time
argument_list|()
expr_stmt|;
if|if
condition|(
name|pat
operator|->
name|vol
operator|>
literal|127
condition|)
name|pat
operator|->
name|vol
operator|=
literal|127
expr_stmt|;
name|SEQ_SET_PATCH
argument_list|(
name|gus_dev
argument_list|,
name|channel
argument_list|,
name|sample
argument_list|)
expr_stmt|;
name|SEQ_PANNING
argument_list|(
name|gus_dev
argument_list|,
name|channel
argument_list|,
name|panning
argument_list|(
name|channel
argument_list|)
argument_list|)
expr_stmt|;
name|SEQ_PITCHBEND
argument_list|(
name|gus_dev
argument_list|,
name|channel
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|SEQ_START_NOTE
argument_list|(
name|gus_dev
argument_list|,
name|channel
argument_list|,
name|pat
operator|->
name|note
argument_list|,
name|pat
operator|->
name|vol
argument_list|)
expr_stmt|;
name|voices
index|[
name|channel
index|]
operator|.
name|volume
operator|=
name|pat
operator|->
name|vol
expr_stmt|;
name|voices
index|[
name|channel
index|]
operator|.
name|note
operator|=
name|pat
operator|->
name|note
expr_stmt|;
name|voices
index|[
name|channel
index|]
operator|.
name|slide_pitch
operator|=
literal|0
expr_stmt|;
block|}
else|else
name|SEQ_STOP_NOTE
argument_list|(
name|gus_dev
argument_list|,
name|channel
argument_list|,
name|pat
operator|->
name|note
argument_list|,
name|pat
operator|->
name|vol
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|pat
operator|->
name|command
condition|)
block|{
case|case
name|CMD_NOP
case|:
empty_stmt|;
break|break;
case|case
name|CMD_JUMP
case|:
name|jump
operator|=
name|pat
operator|->
name|parm1
expr_stmt|;
break|break;
case|case
name|CMD_BREAK
case|:
name|jump
operator|=
operator|-
literal|2
expr_stmt|;
break|break;
case|case
name|CMD_SPEED
case|:
name|set_speed
argument_list|(
name|pat
operator|->
name|parm1
argument_list|)
expr_stmt|;
break|break;
case|case
name|CMD_SLIDEUP
case|:
name|voices
index|[
name|channel
index|]
operator|.
name|slide_pitch
operator|=
literal|1
expr_stmt|;
name|voices
index|[
name|channel
index|]
operator|.
name|slide_goal
operator|=
literal|8191
expr_stmt|;
name|voices
index|[
name|channel
index|]
operator|.
name|pitchbender
operator|=
literal|0
expr_stmt|;
name|voices
index|[
name|channel
index|]
operator|.
name|slide_rate
operator|=
name|pat
operator|->
name|parm1
operator|*
name|SLIDE_SIZE
expr_stmt|;
name|SEQ_BENDER_RANGE
argument_list|(
name|gus_dev
argument_list|,
name|channel
argument_list|,
literal|200
argument_list|)
expr_stmt|;
break|break;
case|case
name|CMD_SLIDEDOWN
case|:
name|voices
index|[
name|channel
index|]
operator|.
name|slide_pitch
operator|=
literal|1
expr_stmt|;
name|voices
index|[
name|channel
index|]
operator|.
name|slide_goal
operator|=
operator|-
literal|8192
expr_stmt|;
name|voices
index|[
name|channel
index|]
operator|.
name|pitchbender
operator|=
literal|0
expr_stmt|;
name|voices
index|[
name|channel
index|]
operator|.
name|slide_rate
operator|=
operator|-
name|pat
operator|->
name|parm1
operator|*
name|SLIDE_SIZE
expr_stmt|;
name|SEQ_BENDER_RANGE
argument_list|(
name|gus_dev
argument_list|,
name|channel
argument_list|,
literal|200
argument_list|)
expr_stmt|;
break|break;
case|case
name|CMD_SLIDETO
case|:
name|set_slideto
argument_list|(
name|channel
argument_list|,
name|pat
argument_list|)
expr_stmt|;
break|break;
case|case
name|CMD_VOLUME
case|:
block|{
name|int
name|vol
init|=
name|pat
operator|->
name|parm1
operator|*
literal|2
decl_stmt|;
if|if
condition|(
name|vol
operator|>
literal|127
condition|)
name|vol
operator|=
literal|127
expr_stmt|;
if|if
condition|(
name|pat
operator|->
name|note
operator|&&
name|pat
operator|->
name|command
operator|!=
literal|3
condition|)
break|break;
name|SEQ_START_NOTE
argument_list|(
name|gus_dev
argument_list|,
name|channel
argument_list|,
literal|255
argument_list|,
name|vol
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|CMD_ARPEG
case|:
break|break;
case|case
literal|0x0e
case|:
comment|/* printf ("Cmd 0xE%02x\n", pat->parm1);	*/
break|break;
case|case
name|CMD_VOLSLIDE
case|:
name|set_slideto
argument_list|(
name|channel
argument_list|,
name|pat
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|/* printf ("Command %x %02x\n", pat->command, pat->parm1);	*/
block|}
return|return
name|jump
return|;
block|}
end_function

begin_function
name|void
name|lets_play_voice
parameter_list|(
name|int
name|channel
parameter_list|,
name|struct
name|voice_info
modifier|*
name|v
parameter_list|)
block|{
if|if
condition|(
name|v
operator|->
name|slide_pitch
condition|)
block|{
name|v
operator|->
name|pitchbender
operator|+=
name|v
operator|->
name|slide_rate
expr_stmt|;
if|if
condition|(
name|v
operator|->
name|slide_goal
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|v
operator|->
name|pitchbender
operator|<=
name|v
operator|->
name|slide_goal
condition|)
block|{
name|v
operator|->
name|pitchbender
operator|=
name|v
operator|->
name|slide_goal
expr_stmt|;
name|v
operator|->
name|slide_pitch
operator|=
literal|0
expr_stmt|;
comment|/* Stop */
block|}
block|}
else|else
block|{
if|if
condition|(
name|v
operator|->
name|pitchbender
operator|>=
name|v
operator|->
name|slide_goal
condition|)
block|{
name|v
operator|->
name|pitchbender
operator|=
name|v
operator|->
name|slide_goal
expr_stmt|;
name|v
operator|->
name|slide_pitch
operator|=
literal|0
expr_stmt|;
comment|/* Stop */
block|}
block|}
name|sync_time
argument_list|()
expr_stmt|;
name|SEQ_PITCHBEND
argument_list|(
name|gus_dev
argument_list|,
name|channel
argument_list|,
name|v
operator|->
name|pitchbender
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|v
operator|->
name|volslide
condition|)
block|{
name|v
operator|->
name|volume
operator|+=
name|v
operator|->
name|volslide
expr_stmt|;
name|sync_time
argument_list|()
expr_stmt|;
if|if
condition|(
name|v
operator|->
name|volume
operator|>
literal|127
condition|)
name|v
operator|->
name|volume
operator|=
literal|127
expr_stmt|;
name|SEQ_START_NOTE
argument_list|(
name|gus_dev
argument_list|,
name|channel
argument_list|,
literal|255
argument_list|,
name|v
operator|->
name|volume
argument_list|)
expr_stmt|;
block|}
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * sound/ics2101.c  *  * Driver for the ICS2101 mixer of GUS v3.7.  *  * Copyright by Hannu Savolainen 1994  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions are  * met: 1. Redistributions of source code must retain the above copyright  * notice, this list of conditions and the following disclaimer. 2.  * Redistributions in binary form must reproduce the above copyright notice,  * this list of conditions and the following disclaimer in the documentation  * and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND ANY  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED  * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE  * DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE FOR  * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR  * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER  * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  */
end_comment

begin_include
include|#
directive|include
file|"sound_config.h"
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|CONFIGURE_SOUNDCARD
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|EXCLUDE_GUS
argument_list|)
end_if

begin_include
include|#
directive|include
file|"ultrasound.h"
end_include

begin_include
include|#
directive|include
file|"gus_hw.h"
end_include

begin_define
define|#
directive|define
name|MIX_DEVS
value|(SOUND_MASK_MIC|SOUND_MASK_LINE| \ 			 SOUND_MASK_SYNTH| \   			 SOUND_MASK_CD | SOUND_MASK_VOLUME)
end_define

begin_decl_stmt
specifier|extern
name|int
name|gus_base
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|volumes
index|[
name|ICS_MIXDEVS
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|left_fix
index|[
name|ICS_MIXDEVS
index|]
init|=
block|{
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|2
block|,
literal|1
block|,
literal|2
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|right_fix
index|[
name|ICS_MIXDEVS
index|]
init|=
block|{
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|1
block|,
literal|2
block|,
literal|1
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|scale_vol
parameter_list|(
name|int
name|vol
parameter_list|)
block|{
if|#
directive|if
literal|1
comment|/*      *  Experimental volume scaling by Risto Kankkunen.      *  This should give smoother volume response than just      *  a plain multiplication.    */
name|int
name|e
decl_stmt|;
if|if
condition|(
name|vol
operator|<
literal|0
condition|)
name|vol
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|vol
operator|>
literal|100
condition|)
name|vol
operator|=
literal|100
expr_stmt|;
name|vol
operator|=
operator|(
literal|31
operator|*
name|vol
operator|+
literal|50
operator|)
operator|/
literal|100
expr_stmt|;
name|e
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|vol
condition|)
block|{
while|while
condition|(
name|vol
operator|<
literal|16
condition|)
block|{
name|vol
operator|<<=
literal|1
expr_stmt|;
name|e
operator|--
expr_stmt|;
block|}
name|vol
operator|-=
literal|16
expr_stmt|;
name|e
operator|+=
literal|7
expr_stmt|;
block|}
return|return
operator|(
operator|(
name|e
operator|<<
literal|4
operator|)
operator|+
name|vol
operator|)
return|;
else|#
directive|else
return|return
operator|(
operator|(
name|vol
operator|*
literal|127
operator|)
operator|+
literal|50
operator|)
operator|/
literal|100
return|;
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|void
name|write_mix
parameter_list|(
name|int
name|dev
parameter_list|,
name|int
name|chn
parameter_list|,
name|int
name|vol
parameter_list|)
block|{
name|int
modifier|*
name|selector
decl_stmt|;
name|unsigned
name|long
name|flags
decl_stmt|;
name|int
name|ctrl_addr
init|=
name|dev
operator|<<
literal|3
decl_stmt|;
name|int
name|attn_addr
init|=
name|dev
operator|<<
literal|3
decl_stmt|;
name|vol
operator|=
name|scale_vol
argument_list|(
name|vol
argument_list|)
expr_stmt|;
if|if
condition|(
name|chn
operator|==
name|CHN_LEFT
condition|)
block|{
name|selector
operator|=
name|left_fix
expr_stmt|;
name|ctrl_addr
operator||=
literal|0x00
expr_stmt|;
name|attn_addr
operator||=
literal|0x02
expr_stmt|;
block|}
else|else
block|{
name|selector
operator|=
name|right_fix
expr_stmt|;
name|ctrl_addr
operator||=
literal|0x01
expr_stmt|;
name|attn_addr
operator||=
literal|0x03
expr_stmt|;
block|}
name|DISABLE_INTR
argument_list|(
name|flags
argument_list|)
expr_stmt|;
name|OUTB
argument_list|(
name|ctrl_addr
argument_list|,
name|u_MixSelect
argument_list|)
expr_stmt|;
name|OUTB
argument_list|(
name|selector
index|[
name|dev
index|]
argument_list|,
name|u_MixData
argument_list|)
expr_stmt|;
name|OUTB
argument_list|(
name|attn_addr
argument_list|,
name|u_MixSelect
argument_list|)
expr_stmt|;
name|OUTB
argument_list|(
operator|(
name|unsigned
name|char
operator|)
name|vol
argument_list|,
name|u_MixData
argument_list|)
expr_stmt|;
name|RESTORE_INTR
argument_list|(
name|flags
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|set_volumes
parameter_list|(
name|int
name|dev
parameter_list|,
name|int
name|vol
parameter_list|)
block|{
name|int
name|left
init|=
name|vol
operator|&
literal|0x00ff
decl_stmt|;
name|int
name|right
init|=
operator|(
name|vol
operator|>>
literal|8
operator|)
operator|&
literal|0x00ff
decl_stmt|;
if|if
condition|(
name|left
operator|<
literal|0
condition|)
name|left
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|left
operator|>
literal|100
condition|)
name|left
operator|=
literal|100
expr_stmt|;
if|if
condition|(
name|right
operator|<
literal|0
condition|)
name|right
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|right
operator|>
literal|100
condition|)
name|right
operator|=
literal|100
expr_stmt|;
name|write_mix
argument_list|(
name|dev
argument_list|,
name|CHN_LEFT
argument_list|,
name|left
argument_list|)
expr_stmt|;
name|write_mix
argument_list|(
name|dev
argument_list|,
name|CHN_RIGHT
argument_list|,
name|right
argument_list|)
expr_stmt|;
name|vol
operator|=
name|left
operator|+
operator|(
name|right
operator|<<
literal|8
operator|)
expr_stmt|;
name|volumes
index|[
name|dev
index|]
operator|=
name|vol
expr_stmt|;
return|return
name|vol
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ics2101_mixer_ioctl
parameter_list|(
name|int
name|dev
parameter_list|,
name|unsigned
name|int
name|cmd
parameter_list|,
name|unsigned
name|int
name|arg
parameter_list|)
block|{
if|if
condition|(
operator|(
operator|(
name|cmd
operator|>>
literal|8
operator|)
operator|&
literal|0xff
operator|)
operator|==
literal|'M'
condition|)
block|{
if|if
condition|(
name|cmd
operator|&
name|IOC_IN
condition|)
switch|switch
condition|(
name|cmd
operator|&
literal|0xff
condition|)
block|{
case|case
name|SOUND_MIXER_RECSRC
case|:
return|return
name|gus_default_mixer_ioctl
argument_list|(
name|dev
argument_list|,
name|cmd
argument_list|,
name|arg
argument_list|)
return|;
break|break;
case|case
name|SOUND_MIXER_MIC
case|:
return|return
name|IOCTL_OUT
argument_list|(
name|arg
argument_list|,
name|set_volumes
argument_list|(
name|DEV_MIC
argument_list|,
name|IOCTL_IN
argument_list|(
name|arg
argument_list|)
argument_list|)
argument_list|)
return|;
break|break;
case|case
name|SOUND_MIXER_CD
case|:
return|return
name|IOCTL_OUT
argument_list|(
name|arg
argument_list|,
name|set_volumes
argument_list|(
name|DEV_CD
argument_list|,
name|IOCTL_IN
argument_list|(
name|arg
argument_list|)
argument_list|)
argument_list|)
return|;
break|break;
case|case
name|SOUND_MIXER_LINE
case|:
return|return
name|IOCTL_OUT
argument_list|(
name|arg
argument_list|,
name|set_volumes
argument_list|(
name|DEV_LINE
argument_list|,
name|IOCTL_IN
argument_list|(
name|arg
argument_list|)
argument_list|)
argument_list|)
return|;
break|break;
case|case
name|SOUND_MIXER_SYNTH
case|:
return|return
name|IOCTL_OUT
argument_list|(
name|arg
argument_list|,
name|set_volumes
argument_list|(
name|DEV_GF1
argument_list|,
name|IOCTL_IN
argument_list|(
name|arg
argument_list|)
argument_list|)
argument_list|)
return|;
break|break;
case|case
name|SOUND_MIXER_VOLUME
case|:
return|return
name|IOCTL_OUT
argument_list|(
name|arg
argument_list|,
name|set_volumes
argument_list|(
name|DEV_VOL
argument_list|,
name|IOCTL_IN
argument_list|(
name|arg
argument_list|)
argument_list|)
argument_list|)
return|;
break|break;
default|default:
return|return
name|RET_ERROR
argument_list|(
name|EINVAL
argument_list|)
return|;
block|}
else|else
switch|switch
condition|(
name|cmd
operator|&
literal|0xff
condition|)
comment|/* 				 * Return parameters 				 */
block|{
case|case
name|SOUND_MIXER_RECSRC
case|:
return|return
name|gus_default_mixer_ioctl
argument_list|(
name|dev
argument_list|,
name|cmd
argument_list|,
name|arg
argument_list|)
return|;
break|break;
case|case
name|SOUND_MIXER_DEVMASK
case|:
return|return
name|IOCTL_OUT
argument_list|(
name|arg
argument_list|,
name|MIX_DEVS
argument_list|)
return|;
break|break;
case|case
name|SOUND_MIXER_STEREODEVS
case|:
return|return
name|IOCTL_OUT
argument_list|(
name|arg
argument_list|,
name|SOUND_MASK_LINE
operator||
name|SOUND_MASK_CD
operator||
name|SOUND_MASK_SYNTH
operator||
name|SOUND_MASK_VOLUME
operator||
name|SOUND_MASK_MIC
argument_list|)
return|;
break|break;
case|case
name|SOUND_MIXER_RECMASK
case|:
return|return
name|IOCTL_OUT
argument_list|(
name|arg
argument_list|,
name|SOUND_MASK_MIC
operator||
name|SOUND_MASK_LINE
argument_list|)
return|;
break|break;
case|case
name|SOUND_MIXER_CAPS
case|:
return|return
name|IOCTL_OUT
argument_list|(
name|arg
argument_list|,
literal|0
argument_list|)
return|;
break|break;
case|case
name|SOUND_MIXER_MIC
case|:
return|return
name|IOCTL_OUT
argument_list|(
name|arg
argument_list|,
name|volumes
index|[
name|DEV_MIC
index|]
argument_list|)
return|;
break|break;
case|case
name|SOUND_MIXER_LINE
case|:
return|return
name|IOCTL_OUT
argument_list|(
name|arg
argument_list|,
name|volumes
index|[
name|DEV_LINE
index|]
argument_list|)
return|;
break|break;
case|case
name|SOUND_MIXER_CD
case|:
return|return
name|IOCTL_OUT
argument_list|(
name|arg
argument_list|,
name|volumes
index|[
name|DEV_CD
index|]
argument_list|)
return|;
break|break;
case|case
name|SOUND_MIXER_VOLUME
case|:
return|return
name|IOCTL_OUT
argument_list|(
name|arg
argument_list|,
name|volumes
index|[
name|DEV_VOL
index|]
argument_list|)
return|;
break|break;
case|case
name|SOUND_MIXER_SYNTH
case|:
return|return
name|IOCTL_OUT
argument_list|(
name|arg
argument_list|,
name|volumes
index|[
name|DEV_GF1
index|]
argument_list|)
return|;
break|break;
default|default:
return|return
name|RET_ERROR
argument_list|(
name|EINVAL
argument_list|)
return|;
block|}
block|}
return|return
name|RET_ERROR
argument_list|(
name|EINVAL
argument_list|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|struct
name|mixer_operations
name|ics2101_mixer_operations
init|=
block|{
literal|"ICS2101 Multimedia Mixer"
block|,
name|ics2101_mixer_ioctl
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|long
name|ics2101_mixer_init
parameter_list|(
name|long
name|mem_start
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|num_mixers
operator|<
name|MAX_MIXER_DEV
condition|)
block|{
name|mixer_devs
index|[
name|num_mixers
operator|++
index|]
operator|=
operator|&
name|ics2101_mixer_operations
expr_stmt|;
comment|/*          * Some GUS v3.7 cards had some channels flipped. Disable          * the flipping feature if the model id is other than 5.        */
if|if
condition|(
name|INB
argument_list|(
name|u_MixSelect
argument_list|)
operator|!=
literal|5
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ICS_MIXDEVS
condition|;
name|i
operator|++
control|)
name|left_fix
index|[
name|i
index|]
operator|=
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ICS_MIXDEVS
condition|;
name|i
operator|++
control|)
name|right_fix
index|[
name|i
index|]
operator|=
literal|2
expr_stmt|;
block|}
name|set_volumes
argument_list|(
name|DEV_GF1
argument_list|,
literal|0x5a5a
argument_list|)
expr_stmt|;
name|set_volumes
argument_list|(
name|DEV_CD
argument_list|,
literal|0x5a5a
argument_list|)
expr_stmt|;
name|set_volumes
argument_list|(
name|DEV_MIC
argument_list|,
literal|0x0000
argument_list|)
expr_stmt|;
name|set_volumes
argument_list|(
name|DEV_LINE
argument_list|,
literal|0x5a5a
argument_list|)
expr_stmt|;
name|set_volumes
argument_list|(
name|DEV_VOL
argument_list|,
literal|0x5a5a
argument_list|)
expr_stmt|;
name|set_volumes
argument_list|(
name|DEV_UNUSED
argument_list|,
literal|0x0000
argument_list|)
expr_stmt|;
block|}
return|return
name|mem_start
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

end_unit


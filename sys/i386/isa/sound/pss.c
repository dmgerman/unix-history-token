begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * sound/pss.c  *   * The low level driver for the Personal Sound System (ECHO ESC614).  *   * Copyright by Hannu Savolainen 1993  *   * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions are  * met: 1. Redistributions of source code must retain the above copyright  * notice, this list of conditions and the following disclaimer. 2.  * Redistributions in binary form must reproduce the above copyright notice,  * this list of conditions and the following disclaimer in the documentation  * and/or other materials provided with the distribution.  *   * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND ANY  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED  * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE  * DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE FOR  * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR  * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER  * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *   */
end_comment

begin_include
include|#
directive|include
file|<i386/isa/sound/sound_config.h>
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|CONFIG_PSS
argument_list|)
operator|&&
name|defined
argument_list|(
name|CONFIG_AUDIO
argument_list|)
end_if

begin_comment
comment|/*  * PSS registers.  */
end_comment

begin_define
define|#
directive|define
name|REG
parameter_list|(
name|x
parameter_list|)
value|(devc->base+x)
end_define

begin_define
define|#
directive|define
name|PSS_DATA
value|0
end_define

begin_define
define|#
directive|define
name|PSS_STATUS
value|2
end_define

begin_define
define|#
directive|define
name|PSS_CONTROL
value|2
end_define

begin_define
define|#
directive|define
name|PSS_ID
value|4
end_define

begin_define
define|#
directive|define
name|PSS_IRQACK
value|4
end_define

begin_define
define|#
directive|define
name|PSS_PIO
value|0x1a
end_define

begin_comment
comment|/*  * Config registers  */
end_comment

begin_define
define|#
directive|define
name|CONF_PSS
value|0x10
end_define

begin_define
define|#
directive|define
name|CONF_WSS
value|0x12
end_define

begin_define
define|#
directive|define
name|CONF_SB
value|0x13
end_define

begin_define
define|#
directive|define
name|CONF_CDROM
value|0x16
end_define

begin_define
define|#
directive|define
name|CONF_MIDI
value|0x18
end_define

begin_comment
comment|/*  * Status bits.  */
end_comment

begin_define
define|#
directive|define
name|PSS_FLAG3
value|0x0800
end_define

begin_define
define|#
directive|define
name|PSS_FLAG2
value|0x0400
end_define

begin_define
define|#
directive|define
name|PSS_FLAG1
value|0x1000
end_define

begin_define
define|#
directive|define
name|PSS_FLAG0
value|0x0800
end_define

begin_define
define|#
directive|define
name|PSS_WRITE_EMPTY
value|0x8000
end_define

begin_define
define|#
directive|define
name|PSS_READ_FULL
value|0x4000
end_define

begin_include
include|#
directive|include
file|"coproc.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|PSS_HAVE_LD
end_ifdef

begin_include
include|#
directive|include
file|"synth-ld.h"
end_include

begin_else
else|#
directive|else
end_else

begin_decl_stmt
specifier|static
name|int
name|pss_synthLen
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|u_char
name|pss_synth
index|[
literal|1
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_typedef
typedef|typedef
struct|struct
name|pss_config
block|{
name|int
name|base
decl_stmt|;
name|int
name|irq
decl_stmt|;
name|int
name|dma
decl_stmt|;
name|sound_os_info
modifier|*
name|osp
decl_stmt|;
block|}
name|pss_config
typedef|;
end_typedef

begin_decl_stmt
specifier|static
name|pss_config
name|pss_data
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|pss_config
modifier|*
name|devc
init|=
operator|&
name|pss_data
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|pss_initialized
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|nonstandard_microcode
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|probe_pss
parameter_list|(
name|struct
name|address_info
modifier|*
name|hw_config
parameter_list|)
block|{
name|u_short
name|id
decl_stmt|;
name|int
name|irq
decl_stmt|,
name|dma
decl_stmt|;
name|devc
operator|->
name|base
operator|=
name|hw_config
operator|->
name|io_base
expr_stmt|;
name|irq
operator|=
name|devc
operator|->
name|irq
operator|=
name|hw_config
operator|->
name|irq
expr_stmt|;
name|dma
operator|=
name|devc
operator|->
name|dma
operator|=
name|hw_config
operator|->
name|dma
expr_stmt|;
name|devc
operator|->
name|osp
operator|=
name|hw_config
operator|->
name|osp
expr_stmt|;
comment|/* these are the possible addresses */
if|if
condition|(
name|devc
operator|->
name|base
operator|!=
literal|0x220
operator|&&
name|devc
operator|->
name|base
operator|!=
literal|0x240
operator|&&
name|devc
operator|->
name|base
operator|!=
literal|0x230
operator|&&
name|devc
operator|->
name|base
operator|!=
literal|0x250
condition|)
return|return
literal|0
return|;
comment|/* these are the possible irqs */
if|if
condition|(
name|irq
operator|!=
literal|3
operator|&&
name|irq
operator|!=
literal|5
operator|&&
name|irq
operator|!=
literal|7
operator|&&
name|irq
operator|!=
literal|9
operator|&&
name|irq
operator|!=
literal|10
operator|&&
name|irq
operator|!=
literal|11
operator|&&
name|irq
operator|!=
literal|12
condition|)
return|return
literal|0
return|;
comment|/* and these are the possible dmas */
if|if
condition|(
name|dma
operator|!=
literal|5
operator|&&
name|dma
operator|!=
literal|6
operator|&&
name|dma
operator|!=
literal|7
condition|)
return|return
literal|0
return|;
name|id
operator|=
name|inb
argument_list|(
name|REG
argument_list|(
name|PSS_ID
argument_list|)
argument_list|)
expr_stmt|;
comment|/* XXX the following test cannot possibly succeed! - lr970714 */
if|if
condition|(
operator|(
name|id
operator|>>
literal|8
operator|)
operator|!=
literal|'E'
condition|)
block|{
comment|/* 		 * printf ("No PSS signature detected at 0x%x (0x%x)\n", 		 * devc->base, id); 		 */
return|return
literal|0
return|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|set_irq
parameter_list|(
name|pss_config
modifier|*
name|devc
parameter_list|,
name|int
name|dev
parameter_list|,
name|int
name|irq
parameter_list|)
block|{
specifier|static
name|u_short
name|irq_bits
index|[
literal|16
index|]
init|=
block|{
literal|0x0000
block|,
literal|0x0000
block|,
literal|0x0000
block|,
literal|0x0008
block|,
literal|0x0000
block|,
literal|0x0010
block|,
literal|0x0000
block|,
literal|0x0018
block|,
literal|0x0000
block|,
literal|0x0020
block|,
literal|0x0028
block|,
literal|0x0030
block|,
literal|0x0038
block|,
literal|0x0000
block|,
literal|0x0000
block|,
literal|0x0000
block|}
decl_stmt|;
name|u_short
name|tmp
decl_stmt|,
name|bits
decl_stmt|;
if|if
condition|(
name|irq
operator|<
literal|0
operator|||
name|irq
operator|>
literal|15
condition|)
return|return
literal|0
return|;
name|tmp
operator|=
name|inb
argument_list|(
name|REG
argument_list|(
name|dev
argument_list|)
argument_list|)
operator|&
operator|~
literal|0x38
expr_stmt|;
comment|/* Load confreg, mask IRQ bits out */
if|if
condition|(
operator|(
name|bits
operator|=
name|irq_bits
index|[
name|irq
index|]
operator|)
operator|==
literal|0
operator|&&
name|irq
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"PSS: Invalid IRQ %d\n"
argument_list|,
name|irq
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|outw
argument_list|(
name|REG
argument_list|(
name|dev
argument_list|)
argument_list|,
name|tmp
operator||
name|bits
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|set_io_base
parameter_list|(
name|pss_config
modifier|*
name|devc
parameter_list|,
name|int
name|dev
parameter_list|,
name|int
name|base
parameter_list|)
block|{
name|u_short
name|tmp
init|=
name|inb
argument_list|(
name|REG
argument_list|(
name|dev
argument_list|)
argument_list|)
operator|&
literal|0x003f
decl_stmt|;
name|u_short
name|bits
init|=
operator|(
name|base
operator|&
literal|0x0ffc
operator|)
operator|<<
literal|4
decl_stmt|;
name|outw
argument_list|(
name|REG
argument_list|(
name|dev
argument_list|)
argument_list|,
name|bits
operator||
name|tmp
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|set_dma
parameter_list|(
name|pss_config
modifier|*
name|devc
parameter_list|,
name|int
name|dev
parameter_list|,
name|int
name|dma
parameter_list|)
block|{
specifier|static
name|u_short
name|dma_bits
index|[
literal|8
index|]
init|=
block|{
literal|0x0001
block|,
literal|0x0002
block|,
literal|0x0000
block|,
literal|0x0003
block|,
literal|0x0000
block|,
literal|0x0005
block|,
literal|0x0006
block|,
literal|0x0007
block|}
decl_stmt|;
name|u_short
name|tmp
decl_stmt|,
name|bits
decl_stmt|;
if|if
condition|(
name|dma
operator|<
literal|0
operator|||
name|dma
operator|>
literal|7
condition|)
return|return
literal|0
return|;
name|tmp
operator|=
name|inb
argument_list|(
name|REG
argument_list|(
name|dev
argument_list|)
argument_list|)
operator|&
operator|~
literal|0x07
expr_stmt|;
comment|/* Load confreg, mask DMA bits out */
if|if
condition|(
operator|(
name|bits
operator|=
name|dma_bits
index|[
name|dma
index|]
operator|)
operator|==
literal|0
operator|&&
name|dma
operator|!=
literal|4
condition|)
block|{
name|printf
argument_list|(
literal|"PSS: Invalid DMA %d\n"
argument_list|,
name|dma
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|outw
argument_list|(
name|REG
argument_list|(
name|dev
argument_list|)
argument_list|,
name|tmp
operator||
name|bits
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|pss_reset_dsp
parameter_list|(
name|pss_config
modifier|*
name|devc
parameter_list|)
block|{
name|u_long
name|i
decl_stmt|,
name|limit
init|=
name|get_time
argument_list|()
operator|+
literal|10
decl_stmt|;
name|outw
argument_list|(
name|REG
argument_list|(
name|PSS_CONTROL
argument_list|)
argument_list|,
literal|0x2000
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32768
operator|&&
name|get_time
argument_list|()
operator|<
name|limit
condition|;
name|i
operator|++
control|)
name|inb
argument_list|(
name|REG
argument_list|(
name|PSS_CONTROL
argument_list|)
argument_list|)
expr_stmt|;
name|outw
argument_list|(
name|REG
argument_list|(
name|PSS_CONTROL
argument_list|)
argument_list|,
literal|0x0000
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|pss_put_dspword
parameter_list|(
name|pss_config
modifier|*
name|devc
parameter_list|,
name|u_short
name|word
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|val
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|327680
condition|;
name|i
operator|++
control|)
block|{
name|val
operator|=
name|inb
argument_list|(
name|REG
argument_list|(
name|PSS_STATUS
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|&
name|PSS_WRITE_EMPTY
condition|)
block|{
name|outw
argument_list|(
name|REG
argument_list|(
name|PSS_DATA
argument_list|)
argument_list|,
name|word
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|pss_get_dspword
parameter_list|(
name|pss_config
modifier|*
name|devc
parameter_list|,
name|u_short
modifier|*
name|word
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|val
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|327680
condition|;
name|i
operator|++
control|)
block|{
name|val
operator|=
name|inb
argument_list|(
name|REG
argument_list|(
name|PSS_STATUS
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|&
name|PSS_READ_FULL
condition|)
block|{
operator|*
name|word
operator|=
name|inb
argument_list|(
name|REG
argument_list|(
name|PSS_DATA
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|pss_download_boot
parameter_list|(
name|pss_config
modifier|*
name|devc
parameter_list|,
name|u_char
modifier|*
name|block
parameter_list|,
name|int
name|size
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|limit
decl_stmt|,
name|val
decl_stmt|,
name|count
decl_stmt|;
if|if
condition|(
name|flags
operator|&
name|CPF_FIRST
condition|)
block|{
comment|/* _____ Warn DSP software that a boot is coming */
name|outw
argument_list|(
name|REG
argument_list|(
name|PSS_DATA
argument_list|)
argument_list|,
literal|0x00fe
argument_list|)
expr_stmt|;
name|limit
operator|=
name|get_time
argument_list|()
operator|+
literal|10
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32768
operator|&&
name|get_time
argument_list|()
operator|<
name|limit
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|inb
argument_list|(
name|REG
argument_list|(
name|PSS_DATA
argument_list|)
argument_list|)
operator|==
literal|0x5500
condition|)
break|break;
name|outw
argument_list|(
name|REG
argument_list|(
name|PSS_DATA
argument_list|)
argument_list|,
operator|*
name|block
operator|++
argument_list|)
expr_stmt|;
name|pss_reset_dsp
argument_list|(
name|devc
argument_list|)
expr_stmt|;
block|}
name|count
operator|=
literal|1
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|int
name|j
decl_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|327670
condition|;
name|j
operator|++
control|)
block|{
comment|/* _____ Wait for BG to appear */
if|if
condition|(
name|inb
argument_list|(
name|REG
argument_list|(
name|PSS_STATUS
argument_list|)
argument_list|)
operator|&
name|PSS_FLAG3
condition|)
break|break;
block|}
if|if
condition|(
name|j
operator|==
literal|327670
condition|)
block|{
comment|/* It's ok we timed out when the file was empty */
if|if
condition|(
name|count
operator|>=
name|size
operator|&&
name|flags
operator|&
name|CPF_LAST
condition|)
break|break;
else|else
block|{
name|printf
argument_list|(
literal|"\nPSS: DownLoad timeout problems, byte %d=%d\n"
argument_list|,
name|count
argument_list|,
name|size
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
comment|/* _____ Send the next byte */
name|outw
argument_list|(
name|REG
argument_list|(
name|PSS_DATA
argument_list|)
argument_list|,
operator|*
name|block
operator|++
argument_list|)
expr_stmt|;
name|count
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|flags
operator|&
name|CPF_LAST
condition|)
block|{
comment|/* _____ Why */
name|outw
argument_list|(
name|REG
argument_list|(
name|PSS_DATA
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|limit
operator|=
name|get_time
argument_list|()
operator|+
literal|10
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32768
operator|&&
name|get_time
argument_list|()
operator|<
name|limit
condition|;
name|i
operator|++
control|)
name|val
operator|=
name|inb
argument_list|(
name|REG
argument_list|(
name|PSS_STATUS
argument_list|)
argument_list|)
expr_stmt|;
name|limit
operator|=
name|get_time
argument_list|()
operator|+
literal|10
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32768
operator|&&
name|get_time
argument_list|()
operator|<
name|limit
condition|;
name|i
operator|++
control|)
block|{
name|val
operator|=
name|inb
argument_list|(
name|REG
argument_list|(
name|PSS_STATUS
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|&
literal|0x4000
condition|)
break|break;
block|}
comment|/* now read the version */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32000
condition|;
name|i
operator|++
control|)
block|{
name|val
operator|=
name|inb
argument_list|(
name|REG
argument_list|(
name|PSS_STATUS
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|&
name|PSS_READ_FULL
condition|)
break|break;
block|}
if|if
condition|(
name|i
operator|==
literal|32000
condition|)
return|return
literal|0
return|;
name|val
operator|=
name|inb
argument_list|(
name|REG
argument_list|(
name|PSS_DATA
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 		 * printf("<PSS: microcode version %d.%d loaded>", val/16, 		 * val % 16); 		 */
block|}
return|return
literal|1
return|;
block|}
end_function

begin_function
name|void
name|attach_pss
parameter_list|(
name|struct
name|address_info
modifier|*
name|hw_config
parameter_list|)
block|{
name|u_short
name|id
decl_stmt|;
name|char
name|tmp
index|[
literal|100
index|]
decl_stmt|;
name|devc
operator|->
name|base
operator|=
name|hw_config
operator|->
name|io_base
expr_stmt|;
name|devc
operator|->
name|irq
operator|=
name|hw_config
operator|->
name|irq
expr_stmt|;
name|devc
operator|->
name|dma
operator|=
name|hw_config
operator|->
name|dma
expr_stmt|;
name|devc
operator|->
name|osp
operator|=
name|hw_config
operator|->
name|osp
expr_stmt|;
if|if
condition|(
operator|!
name|probe_pss
argument_list|(
name|hw_config
argument_list|)
condition|)
return|return;
name|id
operator|=
name|inb
argument_list|(
name|REG
argument_list|(
name|PSS_ID
argument_list|)
argument_list|)
operator|&
literal|0x00ff
expr_stmt|;
comment|/* 	 * Disable all emulations. Will be enabled later (if required). 	 */
name|outw
argument_list|(
name|REG
argument_list|(
name|CONF_PSS
argument_list|)
argument_list|,
literal|0x0000
argument_list|)
expr_stmt|;
name|outw
argument_list|(
name|REG
argument_list|(
name|CONF_WSS
argument_list|)
argument_list|,
literal|0x0000
argument_list|)
expr_stmt|;
name|outw
argument_list|(
name|REG
argument_list|(
name|CONF_SB
argument_list|)
argument_list|,
literal|0x0000
argument_list|)
expr_stmt|;
name|outw
argument_list|(
name|REG
argument_list|(
name|CONF_MIDI
argument_list|)
argument_list|,
literal|0x0000
argument_list|)
expr_stmt|;
name|outw
argument_list|(
name|REG
argument_list|(
name|CONF_CDROM
argument_list|)
argument_list|,
literal|0x0000
argument_list|)
expr_stmt|;
if|#
directive|if
name|YOU_REALLY_WANT_TO_ALLOCATE_THESE_RESOURCES
if|if
condition|(
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"pss.c: Can't allocate DMA channel\n"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|!
name|set_irq
argument_list|(
name|devc
argument_list|,
name|CONF_PSS
argument_list|,
name|devc
operator|->
name|irq
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"PSS: IRQ error\n"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|!
name|set_dma
argument_list|(
name|devc
argument_list|,
name|CONF_PSS
argument_list|,
name|devc
operator|->
name|dma
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"PSS: DRQ error\n"
argument_list|)
expr_stmt|;
return|return;
block|}
endif|#
directive|endif
name|pss_initialized
operator|=
literal|1
expr_stmt|;
name|sprintf
argument_list|(
name|tmp
argument_list|,
literal|"ECHO-PSS  Rev. %d"
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|conf_printf
argument_list|(
name|tmp
argument_list|,
name|hw_config
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|int
name|probe_pss_mpu
parameter_list|(
name|struct
name|address_info
modifier|*
name|hw_config
parameter_list|)
block|{
name|int
name|timeout
decl_stmt|;
if|if
condition|(
operator|!
name|pss_initialized
condition|)
return|return
literal|0
return|;
if|if
condition|(
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"PSS: MPU I/O port conflict\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|set_io_base
argument_list|(
name|devc
argument_list|,
name|CONF_MIDI
argument_list|,
name|hw_config
operator|->
name|io_base
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"PSS: MIDI base error.\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|set_irq
argument_list|(
name|devc
argument_list|,
name|CONF_MIDI
argument_list|,
name|hw_config
operator|->
name|irq
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"PSS: MIDI IRQ error.\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|pss_synthLen
condition|)
block|{
name|printf
argument_list|(
literal|"PSS: Can't enable MPU. MIDI synth microcode not available.\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|pss_download_boot
argument_list|(
name|devc
argument_list|,
name|pss_synth
argument_list|,
name|pss_synthLen
argument_list|,
name|CPF_FIRST
operator||
name|CPF_LAST
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"PSS: Unable to load MIDI synth microcode to DSP.\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* 	 * Finally wait until the DSP algorithm has initialized itself and 	 * deactivates receive interrupt. 	 */
for|for
control|(
name|timeout
operator|=
literal|900000
init|;
name|timeout
operator|>
literal|0
condition|;
name|timeout
operator|--
control|)
block|{
if|if
condition|(
operator|(
name|inb
argument_list|(
name|hw_config
operator|->
name|io_base
operator|+
literal|1
argument_list|)
operator|&
literal|0x80
operator|)
operator|==
literal|0
condition|)
comment|/* Input data avail */
name|inb
argument_list|(
name|hw_config
operator|->
name|io_base
argument_list|)
expr_stmt|;
comment|/* Discard it */
else|else
break|break;
comment|/* No more input */
block|}
if|#
directive|if
operator|(
name|defined
argument_list|(
name|CONFIG_MPU401
argument_list|)
operator|||
name|defined
argument_list|(
name|CONFIG_MPU_EMU
argument_list|)
operator|)
operator|&&
name|defined
argument_list|(
name|CONFIG_MIDI
argument_list|)
return|return
name|probe_mpu401
argument_list|(
name|hw_config
argument_list|)
return|;
else|#
directive|else
return|return
literal|0
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|int
name|pss_coproc_open
parameter_list|(
name|void
modifier|*
name|dev_info
parameter_list|,
name|int
name|sub_device
parameter_list|)
block|{
switch|switch
condition|(
name|sub_device
condition|)
block|{
case|case
name|COPR_MIDI
case|:
if|if
condition|(
name|pss_synthLen
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"PSS: MIDI synth microcode not available.\n"
argument_list|)
expr_stmt|;
return|return
operator|-
operator|(
name|EIO
operator|)
return|;
block|}
if|if
condition|(
name|nonstandard_microcode
condition|)
if|if
condition|(
operator|!
name|pss_download_boot
argument_list|(
name|devc
argument_list|,
name|pss_synth
argument_list|,
name|pss_synthLen
argument_list|,
name|CPF_FIRST
operator||
name|CPF_LAST
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"PSS: Unable to load MIDI synth microcode to DSP.\n"
argument_list|)
expr_stmt|;
return|return
operator|-
operator|(
name|EIO
operator|)
return|;
block|}
name|nonstandard_microcode
operator|=
literal|0
expr_stmt|;
break|break;
default|default:
empty_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|pss_coproc_close
parameter_list|(
name|void
modifier|*
name|dev_info
parameter_list|,
name|int
name|sub_device
parameter_list|)
block|{
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|pss_coproc_reset
parameter_list|(
name|void
modifier|*
name|dev_info
parameter_list|)
block|{
if|if
condition|(
name|pss_synthLen
condition|)
if|if
condition|(
operator|!
name|pss_download_boot
argument_list|(
name|devc
argument_list|,
name|pss_synth
argument_list|,
name|pss_synthLen
argument_list|,
name|CPF_FIRST
operator||
name|CPF_LAST
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"PSS: Unable to load MIDI synth microcode to DSP.\n"
argument_list|)
expr_stmt|;
block|}
name|nonstandard_microcode
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|download_boot_block
parameter_list|(
name|void
modifier|*
name|dev_info
parameter_list|,
name|copr_buffer
modifier|*
name|buf
parameter_list|)
block|{
if|if
condition|(
name|buf
operator|->
name|len
operator|<=
literal|0
operator|||
name|buf
operator|->
name|len
operator|>
sizeof|sizeof
argument_list|(
name|buf
operator|->
name|data
argument_list|)
condition|)
return|return
operator|-
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
operator|!
name|pss_download_boot
argument_list|(
name|devc
argument_list|,
name|buf
operator|->
name|data
argument_list|,
name|buf
operator|->
name|len
argument_list|,
name|buf
operator|->
name|flags
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"PSS: Unable to load microcode block to DSP.\n"
argument_list|)
expr_stmt|;
return|return
operator|-
operator|(
name|EIO
operator|)
return|;
block|}
name|nonstandard_microcode
operator|=
literal|1
expr_stmt|;
comment|/* The MIDI microcode has been 					 * overwritten */
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|pss_coproc_ioctl
parameter_list|(
name|void
modifier|*
name|dev_info
parameter_list|,
name|u_int
name|cmd
parameter_list|,
name|ioctl_arg
name|arg
parameter_list|,
name|int
name|local
parameter_list|)
block|{
comment|/* printf("PSS coproc ioctl %x %x %d\n", cmd, arg, local); */
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|SNDCTL_COPR_RESET
case|:
name|pss_coproc_reset
argument_list|(
name|dev_info
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
break|break;
case|case
name|SNDCTL_COPR_LOAD
case|:
block|{
name|copr_buffer
modifier|*
name|buf
decl_stmt|;
name|int
name|err
decl_stmt|;
name|buf
operator|=
operator|(
name|copr_buffer
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|copr_buffer
argument_list|)
argument_list|,
name|M_TEMP
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
operator|-
operator|(
name|ENOSPC
operator|)
return|;
name|bcopy
argument_list|(
operator|&
operator|(
operator|(
operator|(
name|char
operator|*
operator|)
name|arg
operator|)
index|[
literal|0
index|]
operator|)
argument_list|,
operator|(
name|char
operator|*
operator|)
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|download_boot_block
argument_list|(
name|dev_info
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|buf
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
break|break;
case|case
name|SNDCTL_COPR_RDATA
case|:
block|{
name|copr_debug_buf
name|buf
decl_stmt|;
name|u_long
name|flags
decl_stmt|;
name|u_short
name|tmp
decl_stmt|;
name|bcopy
argument_list|(
operator|&
operator|(
operator|(
operator|(
name|char
operator|*
operator|)
name|arg
operator|)
index|[
literal|0
index|]
operator|)
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|flags
operator|=
name|splhigh
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|pss_put_dspword
argument_list|(
name|devc
argument_list|,
literal|0x00d0
argument_list|)
condition|)
block|{
name|splx
argument_list|(
name|flags
argument_list|)
expr_stmt|;
return|return
operator|-
operator|(
name|EIO
operator|)
return|;
block|}
if|if
condition|(
operator|!
name|pss_put_dspword
argument_list|(
name|devc
argument_list|,
call|(
name|u_short
call|)
argument_list|(
name|buf
operator|.
name|parm1
operator|&
literal|0xffff
argument_list|)
argument_list|)
condition|)
block|{
name|splx
argument_list|(
name|flags
argument_list|)
expr_stmt|;
return|return
operator|-
operator|(
name|EIO
operator|)
return|;
block|}
if|if
condition|(
operator|!
name|pss_get_dspword
argument_list|(
name|devc
argument_list|,
operator|&
name|tmp
argument_list|)
condition|)
block|{
name|splx
argument_list|(
name|flags
argument_list|)
expr_stmt|;
return|return
operator|-
operator|(
name|EIO
operator|)
return|;
block|}
name|buf
operator|.
name|parm1
operator|=
name|tmp
expr_stmt|;
name|splx
argument_list|(
name|flags
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|&
name|buf
argument_list|,
operator|&
operator|(
operator|(
operator|(
name|char
operator|*
operator|)
name|arg
operator|)
index|[
literal|0
index|]
operator|)
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
break|break;
case|case
name|SNDCTL_COPR_WDATA
case|:
block|{
name|copr_debug_buf
name|buf
decl_stmt|;
name|u_long
name|flags
decl_stmt|;
name|u_short
name|tmp
decl_stmt|;
name|bcopy
argument_list|(
operator|&
operator|(
operator|(
operator|(
name|char
operator|*
operator|)
name|arg
operator|)
index|[
literal|0
index|]
operator|)
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|flags
operator|=
name|splhigh
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|pss_put_dspword
argument_list|(
name|devc
argument_list|,
literal|0x00d1
argument_list|)
condition|)
block|{
name|splx
argument_list|(
name|flags
argument_list|)
expr_stmt|;
return|return
operator|-
operator|(
name|EIO
operator|)
return|;
block|}
if|if
condition|(
operator|!
name|pss_put_dspword
argument_list|(
name|devc
argument_list|,
call|(
name|u_short
call|)
argument_list|(
name|buf
operator|.
name|parm1
operator|&
literal|0xffff
argument_list|)
argument_list|)
condition|)
block|{
name|splx
argument_list|(
name|flags
argument_list|)
expr_stmt|;
return|return
operator|-
operator|(
name|EIO
operator|)
return|;
block|}
name|tmp
operator|=
operator|(
name|u_int
operator|)
name|buf
operator|.
name|parm2
operator|&
literal|0xffff
expr_stmt|;
if|if
condition|(
operator|!
name|pss_put_dspword
argument_list|(
name|devc
argument_list|,
name|tmp
argument_list|)
condition|)
block|{
name|splx
argument_list|(
name|flags
argument_list|)
expr_stmt|;
return|return
operator|-
operator|(
name|EIO
operator|)
return|;
block|}
name|splx
argument_list|(
name|flags
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
break|break;
case|case
name|SNDCTL_COPR_WCODE
case|:
block|{
name|copr_debug_buf
name|buf
decl_stmt|;
name|u_long
name|flags
decl_stmt|;
name|u_short
name|tmp
decl_stmt|;
name|bcopy
argument_list|(
operator|&
operator|(
operator|(
operator|(
name|char
operator|*
operator|)
name|arg
operator|)
index|[
literal|0
index|]
operator|)
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|flags
operator|=
name|splhigh
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|pss_put_dspword
argument_list|(
name|devc
argument_list|,
literal|0x00d3
argument_list|)
condition|)
block|{
name|splx
argument_list|(
name|flags
argument_list|)
expr_stmt|;
return|return
operator|-
operator|(
name|EIO
operator|)
return|;
block|}
if|if
condition|(
operator|!
name|pss_put_dspword
argument_list|(
name|devc
argument_list|,
call|(
name|u_short
call|)
argument_list|(
name|buf
operator|.
name|parm1
operator|&
literal|0xffff
argument_list|)
argument_list|)
condition|)
block|{
name|splx
argument_list|(
name|flags
argument_list|)
expr_stmt|;
return|return
operator|-
operator|(
name|EIO
operator|)
return|;
block|}
name|tmp
operator|=
operator|(
operator|(
name|u_int
operator|)
name|buf
operator|.
name|parm2
operator|>>
literal|8
operator|)
operator|&
literal|0xffff
expr_stmt|;
if|if
condition|(
operator|!
name|pss_put_dspword
argument_list|(
name|devc
argument_list|,
name|tmp
argument_list|)
condition|)
block|{
name|splx
argument_list|(
name|flags
argument_list|)
expr_stmt|;
return|return
operator|-
operator|(
name|EIO
operator|)
return|;
block|}
name|tmp
operator|=
operator|(
name|u_int
operator|)
name|buf
operator|.
name|parm2
operator|&
literal|0x00ff
expr_stmt|;
if|if
condition|(
operator|!
name|pss_put_dspword
argument_list|(
name|devc
argument_list|,
name|tmp
argument_list|)
condition|)
block|{
name|splx
argument_list|(
name|flags
argument_list|)
expr_stmt|;
return|return
operator|-
operator|(
name|EIO
operator|)
return|;
block|}
name|splx
argument_list|(
name|flags
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
break|break;
case|case
name|SNDCTL_COPR_RCODE
case|:
block|{
name|copr_debug_buf
name|buf
decl_stmt|;
name|u_long
name|flags
decl_stmt|;
name|u_short
name|tmp
decl_stmt|;
name|bcopy
argument_list|(
operator|&
operator|(
operator|(
operator|(
name|char
operator|*
operator|)
name|arg
operator|)
index|[
literal|0
index|]
operator|)
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|flags
operator|=
name|splhigh
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|pss_put_dspword
argument_list|(
name|devc
argument_list|,
literal|0x00d2
argument_list|)
condition|)
block|{
name|splx
argument_list|(
name|flags
argument_list|)
expr_stmt|;
return|return
operator|-
operator|(
name|EIO
operator|)
return|;
block|}
if|if
condition|(
operator|!
name|pss_put_dspword
argument_list|(
name|devc
argument_list|,
call|(
name|u_short
call|)
argument_list|(
name|buf
operator|.
name|parm1
operator|&
literal|0xffff
argument_list|)
argument_list|)
condition|)
block|{
name|splx
argument_list|(
name|flags
argument_list|)
expr_stmt|;
return|return
operator|-
operator|(
name|EIO
operator|)
return|;
block|}
if|if
condition|(
operator|!
name|pss_get_dspword
argument_list|(
name|devc
argument_list|,
operator|&
name|tmp
argument_list|)
condition|)
block|{
comment|/* Read msb */
name|splx
argument_list|(
name|flags
argument_list|)
expr_stmt|;
return|return
operator|-
operator|(
name|EIO
operator|)
return|;
block|}
name|buf
operator|.
name|parm1
operator|=
name|tmp
operator|<<
literal|8
expr_stmt|;
if|if
condition|(
operator|!
name|pss_get_dspword
argument_list|(
name|devc
argument_list|,
operator|&
name|tmp
argument_list|)
condition|)
block|{
comment|/* Read lsb */
name|splx
argument_list|(
name|flags
argument_list|)
expr_stmt|;
return|return
operator|-
operator|(
name|EIO
operator|)
return|;
block|}
name|buf
operator|.
name|parm1
operator||=
name|tmp
operator|&
literal|0x00ff
expr_stmt|;
name|splx
argument_list|(
name|flags
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|&
name|buf
argument_list|,
operator|&
operator|(
operator|(
operator|(
name|char
operator|*
operator|)
name|arg
operator|)
index|[
literal|0
index|]
operator|)
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
break|break;
default|default:
return|return
operator|-
operator|(
name|EINVAL
operator|)
return|;
block|}
return|return
operator|-
operator|(
name|EINVAL
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|coproc_operations
name|pss_coproc_operations
init|=
block|{
literal|"ADSP-2115"
block|,
name|pss_coproc_open
block|,
name|pss_coproc_close
block|,
name|pss_coproc_ioctl
block|,
name|pss_coproc_reset
block|,
operator|&
name|pss_data
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|attach_pss_mpu
parameter_list|(
name|struct
name|address_info
modifier|*
name|hw_config
parameter_list|)
block|{
name|int
name|prev_devs
decl_stmt|;
if|#
directive|if
operator|(
name|defined
argument_list|(
name|CONFIG_MPU401
argument_list|)
operator|||
name|defined
argument_list|(
name|CONFIG_MPU_EMU
argument_list|)
operator|)
operator|&&
name|defined
argument_list|(
name|CONFIG_MIDI
argument_list|)
name|prev_devs
operator|=
name|num_midis
expr_stmt|;
name|attach_mpu401
argument_list|(
name|hw_config
argument_list|)
expr_stmt|;
if|if
condition|(
name|num_midis
operator|==
operator|(
name|prev_devs
operator|+
literal|1
operator|)
condition|)
comment|/* The MPU driver installed 						 * itself */
name|midi_devs
index|[
name|prev_devs
index|]
operator|->
name|coproc
operator|=
operator|&
name|pss_coproc_operations
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_function
name|int
name|probe_pss_mss
parameter_list|(
name|struct
name|address_info
modifier|*
name|hw_config
parameter_list|)
block|{
name|int
name|timeout
decl_stmt|;
if|if
condition|(
operator|!
name|pss_initialized
condition|)
return|return
literal|0
return|;
if|if
condition|(
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"PSS: WSS I/O port conflict\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|set_io_base
argument_list|(
name|devc
argument_list|,
name|CONF_WSS
argument_list|,
name|hw_config
operator|->
name|io_base
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"PSS: WSS base error.\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|set_irq
argument_list|(
name|devc
argument_list|,
name|CONF_WSS
argument_list|,
name|hw_config
operator|->
name|irq
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"PSS: WSS IRQ error.\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|set_dma
argument_list|(
name|devc
argument_list|,
name|CONF_WSS
argument_list|,
name|hw_config
operator|->
name|dma
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"PSS: WSS DRQ error\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* 	 * For some reason the card returns 0xff in the WSS status register 	 * immediately after boot. Propably MIDI+SB emulation algorithm 	 * downloaded to the ADSP2115 spends some time initializing the card. 	 * Let's try to wait until it finishes this task. 	 */
for|for
control|(
name|timeout
operator|=
literal|0
init|;
name|timeout
operator|<
literal|100000
operator|&&
operator|(
name|inb
argument_list|(
name|hw_config
operator|->
name|io_base
operator|+
literal|3
argument_list|)
operator|&
literal|0x3f
operator|)
operator|!=
literal|0x04
condition|;
name|timeout
operator|++
control|)
empty_stmt|;
return|return
name|probe_mss
argument_list|(
name|hw_config
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|attach_pss_mss
parameter_list|(
name|struct
name|address_info
modifier|*
name|hw_config
parameter_list|)
block|{
name|int
name|prev_devs
decl_stmt|;
name|long
name|ret
decl_stmt|;
name|prev_devs
operator|=
name|num_audiodevs
expr_stmt|;
name|attach_mss
argument_list|(
name|hw_config
argument_list|)
expr_stmt|;
comment|/* Check if The MSS driver installed itself */
if|if
condition|(
name|num_audiodevs
operator|==
operator|(
name|prev_devs
operator|+
literal|1
operator|)
condition|)
name|audio_devs
index|[
name|prev_devs
index|]
operator|->
name|coproc
operator|=
operator|&
name|pss_coproc_operations
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

end_unit


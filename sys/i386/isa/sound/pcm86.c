begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * PC-9801-86 PCM driver for FreeBSD(98).  *  * Copyright (c) 1995  NAGAO Tadaaki (ABTK)  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR AND CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $Id: pcm86.c,v 1.1 1996/11/02 10:37:39 asami Exp $  */
end_comment

begin_comment
comment|/*  * !! NOTE !! :  *   This file DOES NOT belong to the VoxWare distribution though it works  *   as part of the VoxWare drivers.  It is FreeBSD(98) original.  *   -- Nagao (nagao@cs.titech.ac.jp)  */
end_comment

begin_include
include|#
directive|include
file|<i386/isa/sound/sound_config.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIGURE_SOUNDCARD
end_ifdef

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|EXCLUDE_PCM86
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|EXCLUDE_AUDIO
argument_list|)
end_if

begin_comment
comment|/*  * Constants  */
end_comment

begin_define
define|#
directive|define
name|YES
value|1
end_define

begin_define
define|#
directive|define
name|NO
value|0
end_define

begin_define
define|#
directive|define
name|IMODE_NONE
value|0
end_define

begin_define
define|#
directive|define
name|IMODE_INPUT
value|1
end_define

begin_define
define|#
directive|define
name|IMODE_OUTPUT
value|2
end_define

begin_comment
comment|/* PC-9801-86 specific constants */
end_comment

begin_define
define|#
directive|define
name|PCM86_IOBASE
value|0xa460
end_define

begin_comment
comment|/* PCM I/O ports */
end_comment

begin_define
define|#
directive|define
name|PCM86_FIFOSIZE
value|32768
end_define

begin_comment
comment|/* There is a 32kB FIFO buffer on 86-board */
end_comment

begin_comment
comment|/* XXX -- These values should be chosen appropriately. */
end_comment

begin_define
define|#
directive|define
name|PCM86_INTRSIZE_OUT
value|1024
end_define

begin_define
define|#
directive|define
name|PCM86_INTRSIZE_IN
value|(PCM86_FIFOSIZE / 2 - 128)
end_define

begin_define
define|#
directive|define
name|DEFAULT_VOLUME
value|15
end_define

begin_comment
comment|/* 0(min) - 15(max) */
end_comment

begin_comment
comment|/*  * Switches for debugging and experiments  */
end_comment

begin_comment
comment|/* #define PCM86_DEBUG */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|PCM86_DEBUG
end_ifdef

begin_ifdef
ifdef|#
directive|ifdef
name|DEB
end_ifdef

begin_undef
undef|#
directive|undef
name|DEB
end_undef

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|DEB
parameter_list|(
name|x
parameter_list|)
value|x
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * Private variables and types  */
end_comment

begin_typedef
typedef|typedef
name|unsigned
name|char
name|pcm_data
typedef|;
end_typedef

begin_enum
enum|enum
name|board_type
block|{
name|NO_SUPPORTED_BOARD
init|=
literal|0
block|,
name|PC980186_FAMILY
init|=
literal|1
block|,
name|PC980173_FAMILY
init|=
literal|2
block|}
enum|;
end_enum

begin_decl_stmt
specifier|static
name|char
modifier|*
name|board_name
index|[]
init|=
block|{
comment|/* Each must be of the length less than 32 bytes. */
literal|"No supported board"
block|,
literal|"PC-9801-86 soundboard"
block|,
literal|"PC-9801-73 soundboard"
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Current status of the driver */
end_comment

begin_struct
specifier|static
struct|struct
block|{
name|int
name|iobase
decl_stmt|;
name|int
name|irq
decl_stmt|;
name|enum
name|board_type
name|board_type
decl_stmt|;
name|int
name|opened
decl_stmt|;
name|int
name|format
decl_stmt|;
name|int
name|bytes
decl_stmt|;
name|int
name|chipspeedno
decl_stmt|;
name|int
name|chipspeed
decl_stmt|;
name|int
name|speed
decl_stmt|;
name|int
name|stereo
decl_stmt|;
name|int
name|volume
decl_stmt|;
name|int
name|intr_busy
decl_stmt|;
name|int
name|intr_size
decl_stmt|;
name|int
name|intr_mode
decl_stmt|;
name|int
name|intr_last
decl_stmt|;
name|int
name|intr_trailer
decl_stmt|;
name|pcm_data
modifier|*
name|pdma_buf
decl_stmt|;
name|int
name|pdma_count
decl_stmt|;
name|int
name|pdma_chunkcount
decl_stmt|;
name|int
name|acc
decl_stmt|;
name|int
name|last_l
decl_stmt|;
name|int
name|last_r
decl_stmt|;
block|}
name|pcm_s
struct|;
end_struct

begin_struct
specifier|static
struct|struct
block|{
name|pcm_data
name|buff
index|[
literal|4
index|]
decl_stmt|;
name|int
name|size
decl_stmt|;
block|}
name|tmpbuf
struct|;
end_struct

begin_decl_stmt
specifier|static
name|int
name|my_dev
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|pcm_initialized
init|=
name|NO
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* 86-board supports only the following rates. */
end_comment

begin_decl_stmt
specifier|static
name|int
name|rates_tbl
index|[
literal|8
index|]
init|=
block|{
ifndef|#
directive|ifndef
name|WAVEMASTER_FREQ
literal|44100
block|,
literal|33075
block|,
literal|22050
block|,
literal|16538
block|,
literal|11025
block|,
literal|8269
block|,
literal|5513
block|,
literal|4134
else|#
directive|else
comment|/*      * It is said that Q-Vision's WaveMaster of some earlier lot(s?) has      * sampling rates incompatible with PC-9801-86.      * But I'm not sure whether the following rates are correct, especially      * 4000Hz.      */
literal|44100
block|,
literal|33075
block|,
literal|22050
block|,
literal|16000
block|,
literal|11025
block|,
literal|8000
block|,
literal|5510
block|,
literal|4000
endif|#
directive|endif
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* u-law to linear translation table */
end_comment

begin_decl_stmt
specifier|static
name|pcm_data
name|ulaw2linear
index|[
literal|256
index|]
init|=
block|{
literal|130
block|,
literal|134
block|,
literal|138
block|,
literal|142
block|,
literal|146
block|,
literal|150
block|,
literal|154
block|,
literal|158
block|,
literal|162
block|,
literal|166
block|,
literal|170
block|,
literal|174
block|,
literal|178
block|,
literal|182
block|,
literal|186
block|,
literal|190
block|,
literal|193
block|,
literal|195
block|,
literal|197
block|,
literal|199
block|,
literal|201
block|,
literal|203
block|,
literal|205
block|,
literal|207
block|,
literal|209
block|,
literal|211
block|,
literal|213
block|,
literal|215
block|,
literal|217
block|,
literal|219
block|,
literal|221
block|,
literal|223
block|,
literal|225
block|,
literal|226
block|,
literal|227
block|,
literal|228
block|,
literal|229
block|,
literal|230
block|,
literal|231
block|,
literal|232
block|,
literal|233
block|,
literal|234
block|,
literal|235
block|,
literal|236
block|,
literal|237
block|,
literal|238
block|,
literal|239
block|,
literal|240
block|,
literal|240
block|,
literal|241
block|,
literal|241
block|,
literal|242
block|,
literal|242
block|,
literal|243
block|,
literal|243
block|,
literal|244
block|,
literal|244
block|,
literal|245
block|,
literal|245
block|,
literal|246
block|,
literal|246
block|,
literal|247
block|,
literal|247
block|,
literal|248
block|,
literal|248
block|,
literal|248
block|,
literal|249
block|,
literal|249
block|,
literal|249
block|,
literal|249
block|,
literal|250
block|,
literal|250
block|,
literal|250
block|,
literal|250
block|,
literal|251
block|,
literal|251
block|,
literal|251
block|,
literal|251
block|,
literal|252
block|,
literal|252
block|,
literal|252
block|,
literal|252
block|,
literal|252
block|,
literal|252
block|,
literal|253
block|,
literal|253
block|,
literal|253
block|,
literal|253
block|,
literal|253
block|,
literal|253
block|,
literal|253
block|,
literal|253
block|,
literal|254
block|,
literal|254
block|,
literal|254
block|,
literal|254
block|,
literal|254
block|,
literal|254
block|,
literal|254
block|,
literal|254
block|,
literal|254
block|,
literal|254
block|,
literal|254
block|,
literal|254
block|,
literal|255
block|,
literal|255
block|,
literal|255
block|,
literal|255
block|,
literal|255
block|,
literal|255
block|,
literal|255
block|,
literal|255
block|,
literal|255
block|,
literal|255
block|,
literal|255
block|,
literal|255
block|,
literal|255
block|,
literal|255
block|,
literal|255
block|,
literal|255
block|,
literal|255
block|,
literal|255
block|,
literal|255
block|,
literal|255
block|,
literal|255
block|,
literal|255
block|,
literal|255
block|,
literal|255
block|,
literal|125
block|,
literal|121
block|,
literal|117
block|,
literal|113
block|,
literal|109
block|,
literal|105
block|,
literal|101
block|,
literal|97
block|,
literal|93
block|,
literal|89
block|,
literal|85
block|,
literal|81
block|,
literal|77
block|,
literal|73
block|,
literal|69
block|,
literal|65
block|,
literal|62
block|,
literal|60
block|,
literal|58
block|,
literal|56
block|,
literal|54
block|,
literal|52
block|,
literal|50
block|,
literal|48
block|,
literal|46
block|,
literal|44
block|,
literal|42
block|,
literal|40
block|,
literal|38
block|,
literal|36
block|,
literal|34
block|,
literal|32
block|,
literal|30
block|,
literal|29
block|,
literal|28
block|,
literal|27
block|,
literal|26
block|,
literal|25
block|,
literal|24
block|,
literal|23
block|,
literal|22
block|,
literal|21
block|,
literal|20
block|,
literal|19
block|,
literal|18
block|,
literal|17
block|,
literal|16
block|,
literal|15
block|,
literal|15
block|,
literal|14
block|,
literal|14
block|,
literal|13
block|,
literal|13
block|,
literal|12
block|,
literal|12
block|,
literal|11
block|,
literal|11
block|,
literal|10
block|,
literal|10
block|,
literal|9
block|,
literal|9
block|,
literal|8
block|,
literal|8
block|,
literal|7
block|,
literal|7
block|,
literal|7
block|,
literal|6
block|,
literal|6
block|,
literal|6
block|,
literal|6
block|,
literal|5
block|,
literal|5
block|,
literal|5
block|,
literal|5
block|,
literal|4
block|,
literal|4
block|,
literal|4
block|,
literal|4
block|,
literal|3
block|,
literal|3
block|,
literal|3
block|,
literal|3
block|,
literal|3
block|,
literal|3
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* linear to u-law translation table */
end_comment

begin_decl_stmt
specifier|static
name|pcm_data
name|linear2ulaw
index|[
literal|256
index|]
init|=
block|{
literal|255
block|,
literal|231
block|,
literal|219
block|,
literal|211
block|,
literal|205
block|,
literal|201
block|,
literal|197
block|,
literal|193
block|,
literal|190
block|,
literal|188
block|,
literal|186
block|,
literal|184
block|,
literal|182
block|,
literal|180
block|,
literal|178
block|,
literal|176
block|,
literal|175
block|,
literal|174
block|,
literal|173
block|,
literal|172
block|,
literal|171
block|,
literal|170
block|,
literal|169
block|,
literal|168
block|,
literal|167
block|,
literal|166
block|,
literal|165
block|,
literal|164
block|,
literal|163
block|,
literal|162
block|,
literal|161
block|,
literal|160
block|,
literal|159
block|,
literal|159
block|,
literal|158
block|,
literal|158
block|,
literal|157
block|,
literal|157
block|,
literal|156
block|,
literal|156
block|,
literal|155
block|,
literal|155
block|,
literal|154
block|,
literal|154
block|,
literal|153
block|,
literal|153
block|,
literal|152
block|,
literal|152
block|,
literal|151
block|,
literal|151
block|,
literal|150
block|,
literal|150
block|,
literal|149
block|,
literal|149
block|,
literal|148
block|,
literal|148
block|,
literal|147
block|,
literal|147
block|,
literal|146
block|,
literal|146
block|,
literal|145
block|,
literal|145
block|,
literal|144
block|,
literal|144
block|,
literal|143
block|,
literal|143
block|,
literal|143
block|,
literal|143
block|,
literal|142
block|,
literal|142
block|,
literal|142
block|,
literal|142
block|,
literal|141
block|,
literal|141
block|,
literal|141
block|,
literal|141
block|,
literal|140
block|,
literal|140
block|,
literal|140
block|,
literal|140
block|,
literal|139
block|,
literal|139
block|,
literal|139
block|,
literal|139
block|,
literal|138
block|,
literal|138
block|,
literal|138
block|,
literal|138
block|,
literal|137
block|,
literal|137
block|,
literal|137
block|,
literal|137
block|,
literal|136
block|,
literal|136
block|,
literal|136
block|,
literal|136
block|,
literal|135
block|,
literal|135
block|,
literal|135
block|,
literal|135
block|,
literal|134
block|,
literal|134
block|,
literal|134
block|,
literal|134
block|,
literal|133
block|,
literal|133
block|,
literal|133
block|,
literal|133
block|,
literal|132
block|,
literal|132
block|,
literal|132
block|,
literal|132
block|,
literal|131
block|,
literal|131
block|,
literal|131
block|,
literal|131
block|,
literal|130
block|,
literal|130
block|,
literal|130
block|,
literal|130
block|,
literal|129
block|,
literal|129
block|,
literal|129
block|,
literal|129
block|,
literal|128
block|,
literal|128
block|,
literal|128
block|,
literal|128
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|3
block|,
literal|3
block|,
literal|3
block|,
literal|3
block|,
literal|4
block|,
literal|4
block|,
literal|4
block|,
literal|4
block|,
literal|5
block|,
literal|5
block|,
literal|5
block|,
literal|5
block|,
literal|6
block|,
literal|6
block|,
literal|6
block|,
literal|6
block|,
literal|7
block|,
literal|7
block|,
literal|7
block|,
literal|7
block|,
literal|8
block|,
literal|8
block|,
literal|8
block|,
literal|8
block|,
literal|9
block|,
literal|9
block|,
literal|9
block|,
literal|9
block|,
literal|10
block|,
literal|10
block|,
literal|10
block|,
literal|10
block|,
literal|11
block|,
literal|11
block|,
literal|11
block|,
literal|11
block|,
literal|12
block|,
literal|12
block|,
literal|12
block|,
literal|12
block|,
literal|13
block|,
literal|13
block|,
literal|13
block|,
literal|13
block|,
literal|14
block|,
literal|14
block|,
literal|14
block|,
literal|14
block|,
literal|15
block|,
literal|15
block|,
literal|15
block|,
literal|15
block|,
literal|16
block|,
literal|16
block|,
literal|17
block|,
literal|17
block|,
literal|18
block|,
literal|18
block|,
literal|19
block|,
literal|19
block|,
literal|20
block|,
literal|20
block|,
literal|21
block|,
literal|21
block|,
literal|22
block|,
literal|22
block|,
literal|23
block|,
literal|23
block|,
literal|24
block|,
literal|24
block|,
literal|25
block|,
literal|25
block|,
literal|26
block|,
literal|26
block|,
literal|27
block|,
literal|27
block|,
literal|28
block|,
literal|28
block|,
literal|29
block|,
literal|29
block|,
literal|30
block|,
literal|30
block|,
literal|31
block|,
literal|31
block|,
literal|32
block|,
literal|33
block|,
literal|34
block|,
literal|35
block|,
literal|36
block|,
literal|37
block|,
literal|38
block|,
literal|39
block|,
literal|40
block|,
literal|41
block|,
literal|42
block|,
literal|43
block|,
literal|44
block|,
literal|45
block|,
literal|46
block|,
literal|47
block|,
literal|48
block|,
literal|50
block|,
literal|52
block|,
literal|54
block|,
literal|56
block|,
literal|58
block|,
literal|60
block|,
literal|62
block|,
literal|65
block|,
literal|69
block|,
literal|73
block|,
literal|77
block|,
literal|83
block|,
literal|91
block|,
literal|103
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Prototypes  */
end_comment

begin_function_decl
specifier|static
name|int
name|pcm86_detect
parameter_list|(
name|struct
name|address_info
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|pcm86_open
parameter_list|(
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|pcm86_close
parameter_list|(
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|pcm86_output_block
parameter_list|(
name|int
parameter_list|,
name|unsigned
name|long
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|pcm86_start_input
parameter_list|(
name|int
parameter_list|,
name|unsigned
name|long
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|pcm86_ioctl
parameter_list|(
name|int
parameter_list|,
name|unsigned
name|int
parameter_list|,
name|unsigned
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|pcm86_prepare_for_input
parameter_list|(
name|int
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|pcm86_prepare_for_output
parameter_list|(
name|int
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|pcm86_reset
parameter_list|(
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|pcm86_halt_xfer
parameter_list|(
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dsp73_send_command
parameter_list|(
name|unsigned
name|char
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dsp73_send_data
parameter_list|(
name|unsigned
name|char
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dsp73_init
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|set_format
parameter_list|(
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|set_speed
parameter_list|(
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|set_stereo
parameter_list|(
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|set_volume
parameter_list|(
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|fifo_start
parameter_list|(
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|fifo_stop
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|fifo_reset
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|fifo_output_block
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|fifo_send
parameter_list|(
name|pcm_data
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|fifo_sendtrailer
parameter_list|(
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|fifo_send_stereo
parameter_list|(
name|pcm_data
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|fifo_send_monoral
parameter_list|(
name|pcm_data
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|fifo_send_stereo_ulaw
parameter_list|(
name|pcm_data
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|fifo_send_stereo_8
parameter_list|(
name|pcm_data
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|fifo_send_stereo_16le
parameter_list|(
name|pcm_data
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|fifo_send_stereo_16be
parameter_list|(
name|pcm_data
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|fifo_send_mono_ulaw
parameter_list|(
name|pcm_data
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|fifo_send_mono_8
parameter_list|(
name|pcm_data
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|fifo_send_mono_16le
parameter_list|(
name|pcm_data
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|fifo_send_mono_16be
parameter_list|(
name|pcm_data
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|fifo_input_block
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|fifo_recv
parameter_list|(
name|pcm_data
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|fifo_recv_stereo
parameter_list|(
name|pcm_data
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|fifo_recv_monoral
parameter_list|(
name|pcm_data
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|fifo_recv_stereo_ulaw
parameter_list|(
name|pcm_data
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|fifo_recv_stereo_8
parameter_list|(
name|pcm_data
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|fifo_recv_stereo_16le
parameter_list|(
name|pcm_data
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|fifo_recv_stereo_16be
parameter_list|(
name|pcm_data
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|fifo_recv_mono_ulaw
parameter_list|(
name|pcm_data
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|fifo_recv_mono_8
parameter_list|(
name|pcm_data
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|fifo_recv_mono_16le
parameter_list|(
name|pcm_data
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|fifo_recv_mono_16be
parameter_list|(
name|pcm_data
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|pcm_stop
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|pcm_init
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * Identity  */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|audio_operations
name|pcm86_operations
init|=
block|{
literal|"PC-9801-86 SoundBoard"
block|,
comment|/* filled in properly by auto configuration */
name|NOTHING_SPECIAL
block|,
operator|(
name|AFMT_MU_LAW
operator||
name|AFMT_U8
operator||
name|AFMT_S16_LE
operator||
name|AFMT_S16_BE
operator||
name|AFMT_S8
operator||
name|AFMT_U16_LE
operator||
name|AFMT_U16_BE
operator|)
block|,
name|NULL
block|,
name|pcm86_open
block|,
name|pcm86_close
block|,
name|pcm86_output_block
block|,
name|pcm86_start_input
block|,
name|pcm86_ioctl
block|,
name|pcm86_prepare_for_input
block|,
name|pcm86_prepare_for_output
block|,
name|pcm86_reset
block|,
name|pcm86_halt_xfer
block|,
name|NULL
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Codes for internal use  */
end_comment

begin_function
specifier|static
name|void
name|dsp73_send_command
parameter_list|(
name|unsigned
name|char
name|command
parameter_list|)
block|{
comment|/* wait for RDY */
while|while
condition|(
operator|(
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|2
argument_list|)
operator|&
literal|0x48
operator|)
operator|!=
literal|8
condition|)
empty_stmt|;
comment|/* command mode */
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|2
argument_list|,
operator|(
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|2
argument_list|)
operator|&
literal|0x20
operator|)
operator||
literal|3
argument_list|)
expr_stmt|;
comment|/* wait for RDY */
while|while
condition|(
operator|(
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|2
argument_list|)
operator|&
literal|0x48
operator|)
operator|!=
literal|8
condition|)
empty_stmt|;
comment|/* send command */
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|4
argument_list|,
name|command
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dsp73_send_data
parameter_list|(
name|unsigned
name|char
name|data
parameter_list|)
block|{
comment|/* wait for RDY */
while|while
condition|(
operator|(
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|2
argument_list|)
operator|&
literal|0x48
operator|)
operator|!=
literal|8
condition|)
empty_stmt|;
comment|/* data mode */
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|2
argument_list|,
operator|(
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|2
argument_list|)
operator|&
literal|0x20
operator|)
operator||
literal|0x83
argument_list|)
expr_stmt|;
comment|/* wait for RDY */
while|while
condition|(
operator|(
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|2
argument_list|)
operator|&
literal|0x48
operator|)
operator|!=
literal|8
condition|)
empty_stmt|;
comment|/* send command */
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|4
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dsp73_init
parameter_list|(
name|void
parameter_list|)
block|{
specifier|const
name|unsigned
name|char
name|dspinst
index|[
literal|15
index|]
init|=
block|{
literal|0x00
block|,
literal|0x00
block|,
literal|0x27
block|,
literal|0x3f
block|,
literal|0xe0
block|,
literal|0x01
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x27
block|,
literal|0x36
block|,
literal|0x5a
block|,
literal|0x0d
block|,
literal|0x3e
block|,
literal|0x60
block|,
literal|0x04
block|}
decl_stmt|;
name|unsigned
name|char
name|t
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* reset DSP */
name|t
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|2
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|2
argument_list|,
operator|(
name|t
operator|&
literal|0x80
operator|)
operator||
literal|0x23
argument_list|)
expr_stmt|;
comment|/* mute on */
name|dsp73_send_command
argument_list|(
literal|0x04
argument_list|)
expr_stmt|;
name|dsp73_send_data
argument_list|(
literal|0x6f
argument_list|)
expr_stmt|;
name|dsp73_send_data
argument_list|(
literal|0x3c
argument_list|)
expr_stmt|;
comment|/* write DSP instructions */
name|dsp73_send_command
argument_list|(
literal|0x01
argument_list|)
expr_stmt|;
name|dsp73_send_data
argument_list|(
literal|0x00
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
name|dsp73_send_data
argument_list|(
name|dspinst
index|[
name|i
index|]
argument_list|)
expr_stmt|;
comment|/* mute off */
name|dsp73_send_command
argument_list|(
literal|0x04
argument_list|)
expr_stmt|;
name|dsp73_send_data
argument_list|(
literal|0x6f
argument_list|)
expr_stmt|;
name|dsp73_send_data
argument_list|(
literal|0x30
argument_list|)
expr_stmt|;
comment|/* wait for RDY */
while|while
condition|(
operator|(
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|2
argument_list|)
operator|&
literal|0x48
operator|)
operator|!=
literal|8
condition|)
empty_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|2
argument_list|,
literal|3
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|set_format
parameter_list|(
name|int
name|format
parameter_list|)
block|{
switch|switch
condition|(
name|format
condition|)
block|{
case|case
name|AFMT_MU_LAW
case|:
case|case
name|AFMT_S8
case|:
case|case
name|AFMT_U8
case|:
name|pcm_s
operator|.
name|format
operator|=
name|format
expr_stmt|;
name|pcm_s
operator|.
name|bytes
operator|=
literal|1
expr_stmt|;
comment|/* 8bit */
break|break;
case|case
name|AFMT_S16_LE
case|:
case|case
name|AFMT_U16_LE
case|:
case|case
name|AFMT_S16_BE
case|:
case|case
name|AFMT_U16_BE
case|:
name|pcm_s
operator|.
name|format
operator|=
name|format
expr_stmt|;
name|pcm_s
operator|.
name|bytes
operator|=
literal|2
expr_stmt|;
comment|/* 16bit */
break|break;
case|case
name|AFMT_QUERY
case|:
break|break;
default|default:
return|return
operator|-
literal|1
return|;
block|}
return|return
name|pcm_s
operator|.
name|format
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|set_speed
parameter_list|(
name|int
name|speed
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|speed
operator|<
literal|4000
condition|)
comment|/* Minimum 4000Hz */
name|speed
operator|=
literal|4000
expr_stmt|;
if|if
condition|(
name|speed
operator|>
literal|44100
condition|)
comment|/* Maximum 44100Hz */
name|speed
operator|=
literal|44100
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|7
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
block|{
if|if
condition|(
name|speed
operator|<=
name|rates_tbl
index|[
name|i
index|]
condition|)
block|{
name|pcm_s
operator|.
name|chipspeedno
operator|=
name|i
expr_stmt|;
name|pcm_s
operator|.
name|chipspeed
operator|=
name|rates_tbl
index|[
name|i
index|]
expr_stmt|;
break|break;
block|}
block|}
name|pcm_s
operator|.
name|speed
operator|=
name|speed
expr_stmt|;
return|return
name|speed
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|set_stereo
parameter_list|(
name|int
name|stereo
parameter_list|)
block|{
name|pcm_s
operator|.
name|stereo
operator|=
name|stereo
condition|?
name|YES
else|:
name|NO
expr_stmt|;
return|return
name|pcm_s
operator|.
name|stereo
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|set_volume
parameter_list|(
name|int
name|volume
parameter_list|)
block|{
if|if
condition|(
name|volume
operator|<
literal|0
condition|)
name|volume
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|volume
operator|>
literal|15
condition|)
name|volume
operator|=
literal|15
expr_stmt|;
name|pcm_s
operator|.
name|volume
operator|=
name|volume
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|6
argument_list|,
literal|0xaf
operator|-
name|volume
argument_list|)
expr_stmt|;
comment|/* D/A -> LINE OUT */
name|outb
argument_list|(
literal|0x5f
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
literal|0x5f
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
literal|0x5f
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
literal|0x5f
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|6
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
comment|/* FM -> A/D */
name|outb
argument_list|(
literal|0x5f
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
literal|0x5f
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
literal|0x5f
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
literal|0x5f
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|6
argument_list|,
literal|0x60
argument_list|)
expr_stmt|;
comment|/* LINE IN -> A/D */
name|outb
argument_list|(
literal|0x5f
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
literal|0x5f
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
literal|0x5f
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
literal|0x5f
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|fifo_start
parameter_list|(
name|int
name|mode
parameter_list|)
block|{
name|unsigned
name|char
name|tmp
decl_stmt|;
comment|/* Set frame length& panpot(LR). */
name|tmp
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|10
argument_list|)
operator|&
literal|0x88
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|10
argument_list|,
name|tmp
operator||
operator|(
operator|(
name|pcm_s
operator|.
name|bytes
operator|==
literal|1
operator|)
condition|?
literal|0x72
else|:
literal|0x32
operator|)
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|pcm_s
operator|.
name|chipspeedno
expr_stmt|;
if|if
condition|(
name|mode
operator|==
name|IMODE_INPUT
condition|)
name|tmp
operator||=
literal|0x40
expr_stmt|;
comment|/* Reset intr. flag. */
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|8
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|8
argument_list|,
name|tmp
operator||
literal|0x10
argument_list|)
expr_stmt|;
comment|/* Enable FIFO intr. */
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|8
argument_list|,
name|tmp
operator||
literal|0x30
argument_list|)
expr_stmt|;
comment|/* Set intr. interval. */
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|10
argument_list|,
name|pcm_s
operator|.
name|intr_size
operator|/
literal|128
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* Start intr. */
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|8
argument_list|,
name|tmp
operator||
literal|0xb0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|fifo_stop
parameter_list|(
name|void
parameter_list|)
block|{
name|unsigned
name|char
name|tmp
decl_stmt|;
comment|/* Reset intr. flag, and disable FIFO intr. */
name|tmp
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|8
argument_list|)
operator|&
literal|0x0f
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|8
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|fifo_reset
parameter_list|(
name|void
parameter_list|)
block|{
name|unsigned
name|char
name|tmp
decl_stmt|;
comment|/* Reset FIFO. */
name|tmp
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|8
argument_list|)
operator|&
literal|0x77
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|8
argument_list|,
name|tmp
operator||
literal|0x8
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|8
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|fifo_output_block
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|chunksize
decl_stmt|,
name|count
decl_stmt|;
if|if
condition|(
name|pcm_s
operator|.
name|pdma_chunkcount
condition|)
block|{
comment|/* Update chunksize and then send the next chunk to FIFO. */
name|chunksize
operator|=
name|pcm_s
operator|.
name|pdma_count
operator|/
name|pcm_s
operator|.
name|pdma_chunkcount
operator|--
expr_stmt|;
name|count
operator|=
name|fifo_send
argument_list|(
name|pcm_s
operator|.
name|pdma_buf
argument_list|,
name|chunksize
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* ??? something wrong... */
name|printk
argument_list|(
literal|"pcm0: chunkcount overrun\n"
argument_list|)
expr_stmt|;
name|chunksize
operator|=
name|count
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
operator|(
operator|(
name|audio_devs
index|[
name|my_dev
index|]
operator|->
name|dmap
operator|->
name|qlen
operator|<
literal|2
operator|)
operator|&&
operator|(
name|pcm_s
operator|.
name|pdma_chunkcount
operator|==
literal|0
operator|)
operator|)
operator|||
operator|(
name|count
operator|<
name|pcm_s
operator|.
name|intr_size
operator|)
condition|)
block|{
comment|/* The sent chunk seems to be the last one. */
name|fifo_sendtrailer
argument_list|(
name|pcm_s
operator|.
name|intr_size
argument_list|)
expr_stmt|;
name|pcm_s
operator|.
name|intr_last
operator|=
name|YES
expr_stmt|;
block|}
name|pcm_s
operator|.
name|pdma_buf
operator|+=
name|chunksize
expr_stmt|;
name|pcm_s
operator|.
name|pdma_count
operator|-=
name|chunksize
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|fifo_send
parameter_list|(
name|pcm_data
modifier|*
name|buf
parameter_list|,
name|int
name|count
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|length
decl_stmt|,
name|r
decl_stmt|,
name|cnt
decl_stmt|,
name|rslt
decl_stmt|;
name|pcm_data
modifier|*
name|p
decl_stmt|;
comment|/* Calculate the length of PCM frames. */
name|cnt
operator|=
name|count
operator|+
name|tmpbuf
operator|.
name|size
expr_stmt|;
name|length
operator|=
name|pcm_s
operator|.
name|bytes
operator|<<
name|pcm_s
operator|.
name|stereo
expr_stmt|;
name|r
operator|=
name|cnt
operator|%
name|length
expr_stmt|;
name|cnt
operator|-=
name|r
expr_stmt|;
if|if
condition|(
name|cnt
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|pcm_s
operator|.
name|stereo
condition|)
name|fifo_send_stereo
argument_list|(
name|buf
argument_list|,
name|cnt
argument_list|)
expr_stmt|;
else|else
name|fifo_send_monoral
argument_list|(
name|buf
argument_list|,
name|cnt
argument_list|)
expr_stmt|;
comment|/* Carry over extra data which doesn't seem to be a full PCM frame. */
name|p
operator|=
operator|(
name|pcm_data
operator|*
operator|)
name|buf
operator|+
name|count
operator|-
name|r
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|r
condition|;
name|i
operator|++
control|)
name|tmpbuf
operator|.
name|buff
index|[
name|i
index|]
operator|=
operator|*
name|p
operator|++
expr_stmt|;
block|}
else|else
block|{
comment|/* Carry over extra data which doesn't seem to be a full PCM frame. */
name|p
operator|=
operator|(
name|pcm_data
operator|*
operator|)
name|buf
expr_stmt|;
for|for
control|(
name|i
operator|=
name|tmpbuf
operator|.
name|size
init|;
name|i
operator|<
name|r
condition|;
name|i
operator|++
control|)
name|tmpbuf
operator|.
name|buff
index|[
name|i
index|]
operator|=
operator|*
name|p
operator|++
expr_stmt|;
block|}
name|tmpbuf
operator|.
name|size
operator|=
name|r
expr_stmt|;
name|rslt
operator|=
operator|(
operator|(
name|cnt
operator|/
name|length
operator|)
operator|*
name|pcm_s
operator|.
name|chipspeed
operator|/
name|pcm_s
operator|.
name|speed
operator|)
operator|*
name|pcm_s
operator|.
name|bytes
operator|*
literal|2
expr_stmt|;
ifdef|#
directive|ifdef
name|PCM86_DEBUG
name|printk
argument_list|(
literal|"fifo_send(): %d bytes sent\n"
argument_list|,
name|rslt
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|rslt
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|fifo_sendtrailer
parameter_list|(
name|int
name|count
parameter_list|)
block|{
comment|/* Send trailing zeros to the FIFO buffer. */
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|pcm_s
operator|.
name|intr_trailer
operator|=
name|YES
expr_stmt|;
ifdef|#
directive|ifdef
name|PCM86_DEBUG
name|printk
argument_list|(
literal|"fifo_sendtrailer(): %d bytes sent\n"
argument_list|,
name|count
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|void
name|fifo_send_stereo
parameter_list|(
name|pcm_data
modifier|*
name|buf
parameter_list|,
name|int
name|count
parameter_list|)
block|{
comment|/* Convert format and sampling speed. */
switch|switch
condition|(
name|pcm_s
operator|.
name|format
condition|)
block|{
case|case
name|AFMT_MU_LAW
case|:
name|fifo_send_stereo_ulaw
argument_list|(
name|buf
argument_list|,
name|count
argument_list|)
expr_stmt|;
break|break;
case|case
name|AFMT_S8
case|:
name|fifo_send_stereo_8
argument_list|(
name|buf
argument_list|,
name|count
argument_list|,
name|NO
argument_list|)
expr_stmt|;
break|break;
case|case
name|AFMT_U8
case|:
name|fifo_send_stereo_8
argument_list|(
name|buf
argument_list|,
name|count
argument_list|,
name|YES
argument_list|)
expr_stmt|;
break|break;
case|case
name|AFMT_S16_LE
case|:
name|fifo_send_stereo_16le
argument_list|(
name|buf
argument_list|,
name|count
argument_list|,
name|NO
argument_list|)
expr_stmt|;
break|break;
case|case
name|AFMT_U16_LE
case|:
name|fifo_send_stereo_16le
argument_list|(
name|buf
argument_list|,
name|count
argument_list|,
name|YES
argument_list|)
expr_stmt|;
break|break;
case|case
name|AFMT_S16_BE
case|:
name|fifo_send_stereo_16be
argument_list|(
name|buf
argument_list|,
name|count
argument_list|,
name|NO
argument_list|)
expr_stmt|;
break|break;
case|case
name|AFMT_U16_BE
case|:
name|fifo_send_stereo_16be
argument_list|(
name|buf
argument_list|,
name|count
argument_list|,
name|YES
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|fifo_send_monoral
parameter_list|(
name|pcm_data
modifier|*
name|buf
parameter_list|,
name|int
name|count
parameter_list|)
block|{
comment|/* Convert format and sampling speed. */
switch|switch
condition|(
name|pcm_s
operator|.
name|format
condition|)
block|{
case|case
name|AFMT_MU_LAW
case|:
name|fifo_send_mono_ulaw
argument_list|(
name|buf
argument_list|,
name|count
argument_list|)
expr_stmt|;
break|break;
case|case
name|AFMT_S8
case|:
name|fifo_send_mono_8
argument_list|(
name|buf
argument_list|,
name|count
argument_list|,
name|NO
argument_list|)
expr_stmt|;
break|break;
case|case
name|AFMT_U8
case|:
name|fifo_send_mono_8
argument_list|(
name|buf
argument_list|,
name|count
argument_list|,
name|YES
argument_list|)
expr_stmt|;
break|break;
case|case
name|AFMT_S16_LE
case|:
name|fifo_send_mono_16le
argument_list|(
name|buf
argument_list|,
name|count
argument_list|,
name|NO
argument_list|)
expr_stmt|;
break|break;
case|case
name|AFMT_U16_LE
case|:
name|fifo_send_mono_16le
argument_list|(
name|buf
argument_list|,
name|count
argument_list|,
name|YES
argument_list|)
expr_stmt|;
break|break;
case|case
name|AFMT_S16_BE
case|:
name|fifo_send_mono_16be
argument_list|(
name|buf
argument_list|,
name|count
argument_list|,
name|NO
argument_list|)
expr_stmt|;
break|break;
case|case
name|AFMT_U16_BE
case|:
name|fifo_send_mono_16be
argument_list|(
name|buf
argument_list|,
name|count
argument_list|,
name|YES
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|fifo_send_stereo_ulaw
parameter_list|(
name|pcm_data
modifier|*
name|buf
parameter_list|,
name|int
name|count
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|signed
name|char
name|dl
decl_stmt|,
name|dl0
decl_stmt|,
name|dl1
decl_stmt|,
name|dr
decl_stmt|,
name|dr0
decl_stmt|,
name|dr1
decl_stmt|;
name|pcm_data
name|t
index|[
literal|2
index|]
decl_stmt|;
if|if
condition|(
name|tmpbuf
operator|.
name|size
operator|>
literal|0
condition|)
name|t
index|[
literal|0
index|]
operator|=
name|ulaw2linear
index|[
name|tmpbuf
operator|.
name|buff
index|[
literal|0
index|]
index|]
expr_stmt|;
else|else
name|t
index|[
literal|0
index|]
operator|=
name|ulaw2linear
index|[
operator|*
name|buf
operator|++
index|]
expr_stmt|;
name|t
index|[
literal|1
index|]
operator|=
name|ulaw2linear
index|[
operator|*
name|buf
operator|++
index|]
expr_stmt|;
if|if
condition|(
name|pcm_s
operator|.
name|speed
operator|==
name|pcm_s
operator|.
name|chipspeed
condition|)
block|{
comment|/* No reason to convert the pcm speed. */
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
name|t
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
name|t
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|count
operator|-=
literal|2
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
name|ulaw2linear
index|[
operator|*
name|buf
operator|++
index|]
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Speed conversion with linear interpolation method. */
name|dl0
operator|=
name|pcm_s
operator|.
name|last_l
expr_stmt|;
name|dr0
operator|=
name|pcm_s
operator|.
name|last_r
expr_stmt|;
name|dl1
operator|=
name|t
index|[
literal|0
index|]
expr_stmt|;
name|dr1
operator|=
name|t
index|[
literal|1
index|]
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
name|count
operator|/=
literal|2
expr_stmt|;
while|while
condition|(
name|i
operator|<
name|count
condition|)
block|{
while|while
condition|(
name|pcm_s
operator|.
name|acc
operator|>=
name|pcm_s
operator|.
name|chipspeed
condition|)
block|{
name|pcm_s
operator|.
name|acc
operator|-=
name|pcm_s
operator|.
name|chipspeed
expr_stmt|;
name|i
operator|++
expr_stmt|;
name|dl0
operator|=
name|dl1
expr_stmt|;
name|dr0
operator|=
name|dr1
expr_stmt|;
if|if
condition|(
name|i
operator|<
name|count
condition|)
block|{
name|dl1
operator|=
name|ulaw2linear
index|[
operator|*
name|buf
operator|++
index|]
expr_stmt|;
name|dr1
operator|=
name|ulaw2linear
index|[
operator|*
name|buf
operator|++
index|]
expr_stmt|;
block|}
else|else
name|dl1
operator|=
name|dr1
operator|=
literal|0
expr_stmt|;
block|}
name|dl
operator|=
operator|(
operator|(
name|dl0
operator|*
operator|(
name|pcm_s
operator|.
name|chipspeed
operator|-
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|+
operator|(
name|dl1
operator|*
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|/
name|pcm_s
operator|.
name|chipspeed
expr_stmt|;
name|dr
operator|=
operator|(
operator|(
name|dr0
operator|*
operator|(
name|pcm_s
operator|.
name|chipspeed
operator|-
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|+
operator|(
name|dr1
operator|*
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|/
name|pcm_s
operator|.
name|chipspeed
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
name|dl
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
name|dr
argument_list|)
expr_stmt|;
name|pcm_s
operator|.
name|acc
operator|+=
name|pcm_s
operator|.
name|speed
expr_stmt|;
block|}
name|pcm_s
operator|.
name|last_l
operator|=
name|dl0
expr_stmt|;
name|pcm_s
operator|.
name|last_r
operator|=
name|dr0
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|fifo_send_stereo_8
parameter_list|(
name|pcm_data
modifier|*
name|buf
parameter_list|,
name|int
name|count
parameter_list|,
name|int
name|uflag
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|signed
name|char
name|dl
decl_stmt|,
name|dl0
decl_stmt|,
name|dl1
decl_stmt|,
name|dr
decl_stmt|,
name|dr0
decl_stmt|,
name|dr1
decl_stmt|,
name|zlev
decl_stmt|;
name|pcm_data
name|t
index|[
literal|2
index|]
decl_stmt|;
name|zlev
operator|=
name|uflag
condition|?
operator|-
literal|128
else|:
literal|0
expr_stmt|;
if|if
condition|(
name|tmpbuf
operator|.
name|size
operator|>
literal|0
condition|)
name|t
index|[
literal|0
index|]
operator|=
name|tmpbuf
operator|.
name|buff
index|[
literal|0
index|]
operator|+
name|zlev
expr_stmt|;
else|else
name|t
index|[
literal|0
index|]
operator|=
operator|*
name|buf
operator|++
operator|+
name|zlev
expr_stmt|;
name|t
index|[
literal|1
index|]
operator|=
operator|*
name|buf
operator|++
operator|+
name|zlev
expr_stmt|;
if|if
condition|(
name|pcm_s
operator|.
name|speed
operator|==
name|pcm_s
operator|.
name|chipspeed
condition|)
block|{
comment|/* No reason to convert the pcm speed. */
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
name|t
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
name|t
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|count
operator|-=
literal|2
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
operator|*
name|buf
operator|++
operator|+
name|zlev
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Speed conversion with linear interpolation method. */
name|dl0
operator|=
name|pcm_s
operator|.
name|last_l
expr_stmt|;
name|dr0
operator|=
name|pcm_s
operator|.
name|last_r
expr_stmt|;
name|dl1
operator|=
name|t
index|[
literal|0
index|]
expr_stmt|;
name|dr1
operator|=
name|t
index|[
literal|1
index|]
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
name|count
operator|/=
literal|2
expr_stmt|;
while|while
condition|(
name|i
operator|<
name|count
condition|)
block|{
while|while
condition|(
name|pcm_s
operator|.
name|acc
operator|>=
name|pcm_s
operator|.
name|chipspeed
condition|)
block|{
name|pcm_s
operator|.
name|acc
operator|-=
name|pcm_s
operator|.
name|chipspeed
expr_stmt|;
name|i
operator|++
expr_stmt|;
name|dl0
operator|=
name|dl1
expr_stmt|;
name|dr0
operator|=
name|dr1
expr_stmt|;
if|if
condition|(
name|i
operator|<
name|count
condition|)
block|{
name|dl1
operator|=
operator|*
name|buf
operator|++
operator|+
name|zlev
expr_stmt|;
name|dr1
operator|=
operator|*
name|buf
operator|++
operator|+
name|zlev
expr_stmt|;
block|}
else|else
name|dl1
operator|=
name|dr1
operator|=
literal|0
expr_stmt|;
block|}
name|dl
operator|=
operator|(
operator|(
name|dl0
operator|*
operator|(
name|pcm_s
operator|.
name|chipspeed
operator|-
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|+
operator|(
name|dl1
operator|*
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|/
name|pcm_s
operator|.
name|chipspeed
expr_stmt|;
name|dr
operator|=
operator|(
operator|(
name|dr0
operator|*
operator|(
name|pcm_s
operator|.
name|chipspeed
operator|-
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|+
operator|(
name|dr1
operator|*
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|/
name|pcm_s
operator|.
name|chipspeed
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
name|dl
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
name|dr
argument_list|)
expr_stmt|;
name|pcm_s
operator|.
name|acc
operator|+=
name|pcm_s
operator|.
name|speed
expr_stmt|;
block|}
name|pcm_s
operator|.
name|last_l
operator|=
name|dl0
expr_stmt|;
name|pcm_s
operator|.
name|last_r
operator|=
name|dr0
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|fifo_send_stereo_16le
parameter_list|(
name|pcm_data
modifier|*
name|buf
parameter_list|,
name|int
name|count
parameter_list|,
name|int
name|uflag
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|short
name|dl
decl_stmt|,
name|dl0
decl_stmt|,
name|dl1
decl_stmt|,
name|dr
decl_stmt|,
name|dr0
decl_stmt|,
name|dr1
decl_stmt|,
name|zlev
decl_stmt|;
name|pcm_data
name|t
index|[
literal|4
index|]
decl_stmt|;
name|zlev
operator|=
name|uflag
condition|?
operator|-
literal|128
else|:
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
name|t
index|[
name|i
index|]
operator|=
operator|(
name|tmpbuf
operator|.
name|size
operator|>
name|i
operator|)
condition|?
name|tmpbuf
operator|.
name|buff
index|[
name|i
index|]
else|:
operator|*
name|buf
operator|++
expr_stmt|;
if|if
condition|(
name|pcm_s
operator|.
name|speed
operator|==
name|pcm_s
operator|.
name|chipspeed
condition|)
block|{
comment|/* No reason to convert the pcm speed. */
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
name|t
index|[
literal|1
index|]
operator|+
name|zlev
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
name|t
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
name|t
index|[
literal|3
index|]
operator|+
name|zlev
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
name|t
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|count
operator|=
name|count
operator|/
literal|2
operator|-
literal|2
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
block|{
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
operator|*
operator|(
name|buf
operator|+
literal|1
operator|)
operator|+
name|zlev
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
operator|*
name|buf
argument_list|)
expr_stmt|;
name|buf
operator|+=
literal|2
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* Speed conversion with linear interpolation method. */
name|dl0
operator|=
name|pcm_s
operator|.
name|last_l
expr_stmt|;
name|dr0
operator|=
name|pcm_s
operator|.
name|last_r
expr_stmt|;
name|dl1
operator|=
name|t
index|[
literal|0
index|]
operator|+
operator|(
operator|(
name|t
index|[
literal|1
index|]
operator|+
name|zlev
operator|)
operator|<<
literal|8
operator|)
expr_stmt|;
name|dr1
operator|=
name|t
index|[
literal|2
index|]
operator|+
operator|(
operator|(
name|t
index|[
literal|3
index|]
operator|+
name|zlev
operator|)
operator|<<
literal|8
operator|)
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
name|count
operator|/=
literal|4
expr_stmt|;
while|while
condition|(
name|i
operator|<
name|count
condition|)
block|{
while|while
condition|(
name|pcm_s
operator|.
name|acc
operator|>=
name|pcm_s
operator|.
name|chipspeed
condition|)
block|{
name|pcm_s
operator|.
name|acc
operator|-=
name|pcm_s
operator|.
name|chipspeed
expr_stmt|;
name|i
operator|++
expr_stmt|;
name|dl0
operator|=
name|dl1
expr_stmt|;
name|dr0
operator|=
name|dr1
expr_stmt|;
if|if
condition|(
name|i
operator|<
name|count
condition|)
block|{
name|dl1
operator|=
operator|*
name|buf
operator|+
operator|(
operator|(
operator|*
operator|(
name|buf
operator|+
literal|1
operator|)
operator|+
name|zlev
operator|)
operator|<<
literal|8
operator|)
expr_stmt|;
name|buf
operator|+=
literal|2
expr_stmt|;
name|dr1
operator|=
operator|*
name|buf
operator|+
operator|(
operator|(
operator|*
operator|(
name|buf
operator|+
literal|1
operator|)
operator|+
name|zlev
operator|)
operator|<<
literal|8
operator|)
expr_stmt|;
name|buf
operator|+=
literal|2
expr_stmt|;
block|}
else|else
name|dl1
operator|=
name|dr1
operator|=
literal|0
expr_stmt|;
block|}
name|dl
operator|=
operator|(
operator|(
name|dl0
operator|*
operator|(
name|pcm_s
operator|.
name|chipspeed
operator|-
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|+
operator|(
name|dl1
operator|*
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|/
name|pcm_s
operator|.
name|chipspeed
expr_stmt|;
name|dr
operator|=
operator|(
operator|(
name|dr0
operator|*
operator|(
name|pcm_s
operator|.
name|chipspeed
operator|-
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|+
operator|(
name|dr1
operator|*
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|/
name|pcm_s
operator|.
name|chipspeed
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
operator|(
name|dl
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
name|dl
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
operator|(
name|dr
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
name|dr
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|pcm_s
operator|.
name|acc
operator|+=
name|pcm_s
operator|.
name|speed
expr_stmt|;
block|}
name|pcm_s
operator|.
name|last_l
operator|=
name|dl0
expr_stmt|;
name|pcm_s
operator|.
name|last_r
operator|=
name|dr0
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|fifo_send_stereo_16be
parameter_list|(
name|pcm_data
modifier|*
name|buf
parameter_list|,
name|int
name|count
parameter_list|,
name|int
name|uflag
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|short
name|dl
decl_stmt|,
name|dl0
decl_stmt|,
name|dl1
decl_stmt|,
name|dr
decl_stmt|,
name|dr0
decl_stmt|,
name|dr1
decl_stmt|,
name|zlev
decl_stmt|;
name|pcm_data
name|t
index|[
literal|4
index|]
decl_stmt|;
name|zlev
operator|=
name|uflag
condition|?
operator|-
literal|128
else|:
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
name|t
index|[
name|i
index|]
operator|=
operator|(
name|tmpbuf
operator|.
name|size
operator|>
name|i
operator|)
condition|?
name|tmpbuf
operator|.
name|buff
index|[
name|i
index|]
else|:
operator|*
name|buf
operator|++
expr_stmt|;
if|if
condition|(
name|pcm_s
operator|.
name|speed
operator|==
name|pcm_s
operator|.
name|chipspeed
condition|)
block|{
comment|/* No reason to convert the pcm speed. */
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
name|t
index|[
literal|0
index|]
operator|+
name|zlev
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
name|t
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
name|t
index|[
literal|2
index|]
operator|+
name|zlev
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
name|t
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|count
operator|=
name|count
operator|/
literal|2
operator|-
literal|2
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
block|{
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
operator|*
name|buf
operator|+
name|zlev
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
operator|*
operator|(
name|buf
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
name|buf
operator|+=
literal|2
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* Speed conversion with linear interpolation method. */
name|dl0
operator|=
name|pcm_s
operator|.
name|last_l
expr_stmt|;
name|dr0
operator|=
name|pcm_s
operator|.
name|last_r
expr_stmt|;
name|dl1
operator|=
operator|(
operator|(
name|t
index|[
literal|0
index|]
operator|+
name|zlev
operator|)
operator|<<
literal|8
operator|)
operator|+
name|t
index|[
literal|1
index|]
expr_stmt|;
name|dr1
operator|=
operator|(
operator|(
name|t
index|[
literal|2
index|]
operator|+
name|zlev
operator|)
operator|<<
literal|8
operator|)
operator|+
name|t
index|[
literal|3
index|]
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
name|count
operator|/=
literal|4
expr_stmt|;
while|while
condition|(
name|i
operator|<
name|count
condition|)
block|{
while|while
condition|(
name|pcm_s
operator|.
name|acc
operator|>=
name|pcm_s
operator|.
name|chipspeed
condition|)
block|{
name|pcm_s
operator|.
name|acc
operator|-=
name|pcm_s
operator|.
name|chipspeed
expr_stmt|;
name|i
operator|++
expr_stmt|;
name|dl0
operator|=
name|dl1
expr_stmt|;
name|dr0
operator|=
name|dr1
expr_stmt|;
if|if
condition|(
name|i
operator|<
name|count
condition|)
block|{
name|dl1
operator|=
operator|(
operator|(
operator|*
name|buf
operator|+
name|zlev
operator|)
operator|<<
literal|8
operator|)
operator|+
operator|*
operator|(
name|buf
operator|+
literal|1
operator|)
expr_stmt|;
name|buf
operator|+=
literal|2
expr_stmt|;
name|dr1
operator|=
operator|(
operator|(
operator|*
name|buf
operator|+
name|zlev
operator|)
operator|<<
literal|8
operator|)
operator|+
operator|*
operator|(
name|buf
operator|+
literal|1
operator|)
expr_stmt|;
name|buf
operator|+=
literal|2
expr_stmt|;
block|}
else|else
name|dl1
operator|=
name|dr1
operator|=
literal|0
expr_stmt|;
block|}
name|dl
operator|=
operator|(
operator|(
name|dl0
operator|*
operator|(
name|pcm_s
operator|.
name|chipspeed
operator|-
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|+
operator|(
name|dl1
operator|*
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|/
name|pcm_s
operator|.
name|chipspeed
expr_stmt|;
name|dr
operator|=
operator|(
operator|(
name|dr0
operator|*
operator|(
name|pcm_s
operator|.
name|chipspeed
operator|-
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|+
operator|(
name|dr1
operator|*
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|/
name|pcm_s
operator|.
name|chipspeed
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
operator|(
name|dl
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
name|dl
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
operator|(
name|dr
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
name|dr
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|pcm_s
operator|.
name|acc
operator|+=
name|pcm_s
operator|.
name|speed
expr_stmt|;
block|}
name|pcm_s
operator|.
name|last_l
operator|=
name|dl0
expr_stmt|;
name|pcm_s
operator|.
name|last_r
operator|=
name|dr0
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|fifo_send_mono_ulaw
parameter_list|(
name|pcm_data
modifier|*
name|buf
parameter_list|,
name|int
name|count
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|signed
name|char
name|d
decl_stmt|,
name|d0
decl_stmt|,
name|d1
decl_stmt|;
if|if
condition|(
name|pcm_s
operator|.
name|speed
operator|==
name|pcm_s
operator|.
name|chipspeed
condition|)
comment|/* No reason to convert the pcm speed. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
block|{
name|d
operator|=
name|ulaw2linear
index|[
operator|*
name|buf
operator|++
index|]
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
name|d
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
name|d
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Speed conversion with linear interpolation method. */
name|d0
operator|=
name|pcm_s
operator|.
name|last_l
expr_stmt|;
name|d1
operator|=
name|ulaw2linear
index|[
operator|*
name|buf
operator|++
index|]
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|i
operator|<
name|count
condition|)
block|{
while|while
condition|(
name|pcm_s
operator|.
name|acc
operator|>=
name|pcm_s
operator|.
name|chipspeed
condition|)
block|{
name|pcm_s
operator|.
name|acc
operator|-=
name|pcm_s
operator|.
name|chipspeed
expr_stmt|;
name|i
operator|++
expr_stmt|;
name|d0
operator|=
name|d1
expr_stmt|;
name|d1
operator|=
operator|(
name|i
operator|<
name|count
operator|)
condition|?
name|ulaw2linear
index|[
operator|*
name|buf
operator|++
index|]
else|:
literal|0
expr_stmt|;
block|}
name|d
operator|=
operator|(
operator|(
name|d0
operator|*
operator|(
name|pcm_s
operator|.
name|chipspeed
operator|-
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|+
operator|(
name|d1
operator|*
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|/
name|pcm_s
operator|.
name|chipspeed
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
name|d
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
name|d
argument_list|)
expr_stmt|;
name|pcm_s
operator|.
name|acc
operator|+=
name|pcm_s
operator|.
name|speed
expr_stmt|;
block|}
name|pcm_s
operator|.
name|last_l
operator|=
name|d0
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|fifo_send_mono_8
parameter_list|(
name|pcm_data
modifier|*
name|buf
parameter_list|,
name|int
name|count
parameter_list|,
name|int
name|uflag
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|signed
name|char
name|d
decl_stmt|,
name|d0
decl_stmt|,
name|d1
decl_stmt|,
name|zlev
decl_stmt|;
name|zlev
operator|=
name|uflag
condition|?
operator|-
literal|128
else|:
literal|0
expr_stmt|;
if|if
condition|(
name|pcm_s
operator|.
name|speed
operator|==
name|pcm_s
operator|.
name|chipspeed
condition|)
comment|/* No reason to convert the pcm speed. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
block|{
name|d
operator|=
operator|*
name|buf
operator|++
operator|+
name|zlev
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
name|d
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
name|d
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Speed conversion with linear interpolation method. */
name|d0
operator|=
name|pcm_s
operator|.
name|last_l
expr_stmt|;
name|d1
operator|=
operator|*
name|buf
operator|++
operator|+
name|zlev
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|i
operator|<
name|count
condition|)
block|{
while|while
condition|(
name|pcm_s
operator|.
name|acc
operator|>=
name|pcm_s
operator|.
name|chipspeed
condition|)
block|{
name|pcm_s
operator|.
name|acc
operator|-=
name|pcm_s
operator|.
name|chipspeed
expr_stmt|;
name|i
operator|++
expr_stmt|;
name|d0
operator|=
name|d1
expr_stmt|;
name|d1
operator|=
operator|(
name|i
operator|<
name|count
operator|)
condition|?
operator|*
name|buf
operator|++
operator|+
name|zlev
else|:
literal|0
expr_stmt|;
block|}
name|d
operator|=
operator|(
operator|(
name|d0
operator|*
operator|(
name|pcm_s
operator|.
name|chipspeed
operator|-
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|+
operator|(
name|d1
operator|*
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|/
name|pcm_s
operator|.
name|chipspeed
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
name|d
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
name|d
argument_list|)
expr_stmt|;
name|pcm_s
operator|.
name|acc
operator|+=
name|pcm_s
operator|.
name|speed
expr_stmt|;
block|}
name|pcm_s
operator|.
name|last_l
operator|=
name|d0
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|fifo_send_mono_16le
parameter_list|(
name|pcm_data
modifier|*
name|buf
parameter_list|,
name|int
name|count
parameter_list|,
name|int
name|uflag
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|short
name|d
decl_stmt|,
name|d0
decl_stmt|,
name|d1
decl_stmt|,
name|zlev
decl_stmt|;
name|pcm_data
name|t
index|[
literal|2
index|]
decl_stmt|;
name|zlev
operator|=
name|uflag
condition|?
operator|-
literal|128
else|:
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
name|t
index|[
name|i
index|]
operator|=
operator|(
name|tmpbuf
operator|.
name|size
operator|>
name|i
operator|)
condition|?
name|tmpbuf
operator|.
name|buff
index|[
name|i
index|]
else|:
operator|*
name|buf
operator|++
expr_stmt|;
if|if
condition|(
name|pcm_s
operator|.
name|speed
operator|==
name|pcm_s
operator|.
name|chipspeed
condition|)
block|{
comment|/* No reason to convert the pcm speed. */
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
name|t
index|[
literal|1
index|]
operator|+
name|zlev
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
name|t
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
name|t
index|[
literal|1
index|]
operator|+
name|zlev
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
name|t
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|count
operator|=
name|count
operator|/
literal|2
operator|-
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
block|{
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
operator|*
operator|(
name|buf
operator|+
literal|1
operator|)
operator|+
name|zlev
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
operator|*
name|buf
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
operator|*
operator|(
name|buf
operator|+
literal|1
operator|)
operator|+
name|zlev
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
operator|*
name|buf
argument_list|)
expr_stmt|;
name|buf
operator|+=
literal|2
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* Speed conversion with linear interpolation method. */
name|d0
operator|=
name|pcm_s
operator|.
name|last_l
expr_stmt|;
name|d1
operator|=
name|t
index|[
literal|0
index|]
operator|+
operator|(
operator|(
name|t
index|[
literal|1
index|]
operator|+
name|zlev
operator|)
operator|<<
literal|8
operator|)
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
name|count
operator|/=
literal|2
expr_stmt|;
while|while
condition|(
name|i
operator|<
name|count
condition|)
block|{
while|while
condition|(
name|pcm_s
operator|.
name|acc
operator|>=
name|pcm_s
operator|.
name|chipspeed
condition|)
block|{
name|pcm_s
operator|.
name|acc
operator|-=
name|pcm_s
operator|.
name|chipspeed
expr_stmt|;
name|i
operator|++
expr_stmt|;
name|d0
operator|=
name|d1
expr_stmt|;
if|if
condition|(
name|i
operator|<
name|count
condition|)
block|{
name|d1
operator|=
operator|*
name|buf
operator|+
operator|(
operator|(
operator|*
operator|(
name|buf
operator|+
literal|1
operator|)
operator|+
name|zlev
operator|)
operator|<<
literal|8
operator|)
expr_stmt|;
name|buf
operator|+=
literal|2
expr_stmt|;
block|}
else|else
name|d1
operator|=
literal|0
expr_stmt|;
block|}
name|d
operator|=
operator|(
operator|(
name|d0
operator|*
operator|(
name|pcm_s
operator|.
name|chipspeed
operator|-
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|+
operator|(
name|d1
operator|*
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|/
name|pcm_s
operator|.
name|chipspeed
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
operator|(
name|d
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
name|d
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
operator|(
name|d
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
name|d
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|pcm_s
operator|.
name|acc
operator|+=
name|pcm_s
operator|.
name|speed
expr_stmt|;
block|}
name|pcm_s
operator|.
name|last_l
operator|=
name|d0
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|fifo_send_mono_16be
parameter_list|(
name|pcm_data
modifier|*
name|buf
parameter_list|,
name|int
name|count
parameter_list|,
name|int
name|uflag
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|short
name|d
decl_stmt|,
name|d0
decl_stmt|,
name|d1
decl_stmt|,
name|zlev
decl_stmt|;
name|pcm_data
name|t
index|[
literal|2
index|]
decl_stmt|;
name|zlev
operator|=
name|uflag
condition|?
operator|-
literal|128
else|:
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
name|t
index|[
name|i
index|]
operator|=
operator|(
name|tmpbuf
operator|.
name|size
operator|>
name|i
operator|)
condition|?
name|tmpbuf
operator|.
name|buff
index|[
name|i
index|]
else|:
operator|*
name|buf
operator|++
expr_stmt|;
if|if
condition|(
name|pcm_s
operator|.
name|speed
operator|==
name|pcm_s
operator|.
name|chipspeed
condition|)
block|{
comment|/* No reason to convert the pcm speed. */
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
name|t
index|[
literal|0
index|]
operator|+
name|zlev
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
name|t
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
name|t
index|[
literal|0
index|]
operator|+
name|zlev
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
name|t
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|count
operator|=
name|count
operator|/
literal|2
operator|-
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
block|{
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
operator|*
name|buf
operator|+
name|zlev
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
operator|*
operator|(
name|buf
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
operator|*
name|buf
operator|+
name|zlev
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
operator|*
operator|(
name|buf
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
name|buf
operator|+=
literal|2
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* Speed conversion with linear interpolation method. */
name|d0
operator|=
name|pcm_s
operator|.
name|last_l
expr_stmt|;
name|d1
operator|=
operator|(
operator|(
name|t
index|[
literal|0
index|]
operator|+
name|zlev
operator|)
operator|<<
literal|8
operator|)
operator|+
name|t
index|[
literal|1
index|]
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
name|count
operator|/=
literal|2
expr_stmt|;
while|while
condition|(
name|i
operator|<
name|count
condition|)
block|{
while|while
condition|(
name|pcm_s
operator|.
name|acc
operator|>=
name|pcm_s
operator|.
name|chipspeed
condition|)
block|{
name|pcm_s
operator|.
name|acc
operator|-=
name|pcm_s
operator|.
name|chipspeed
expr_stmt|;
name|i
operator|++
expr_stmt|;
name|d0
operator|=
name|d1
expr_stmt|;
if|if
condition|(
name|i
operator|<
name|count
condition|)
block|{
name|d1
operator|=
operator|(
operator|(
operator|*
name|buf
operator|+
name|zlev
operator|)
operator|<<
literal|8
operator|)
operator|+
operator|*
operator|(
name|buf
operator|+
literal|1
operator|)
expr_stmt|;
name|buf
operator|+=
literal|2
expr_stmt|;
block|}
else|else
name|d1
operator|=
literal|0
expr_stmt|;
block|}
name|d
operator|=
operator|(
operator|(
name|d0
operator|*
operator|(
name|pcm_s
operator|.
name|chipspeed
operator|-
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|+
operator|(
name|d1
operator|*
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|/
name|pcm_s
operator|.
name|chipspeed
expr_stmt|;
comment|/*	    outb(pcm_s.iobase + 12, d& 0xff); 	    outb(pcm_s.iobase + 12, (d>> 8)& 0xff); 	    outb(pcm_s.iobase + 12, d& 0xff); 	    outb(pcm_s.iobase + 12, (d>> 8)& 0xff); */
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
operator|(
name|d
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
name|d
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
operator|(
name|d
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|,
name|d
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|pcm_s
operator|.
name|acc
operator|+=
name|pcm_s
operator|.
name|speed
expr_stmt|;
block|}
name|pcm_s
operator|.
name|last_l
operator|=
name|d0
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|fifo_input_block
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|chunksize
decl_stmt|;
if|if
condition|(
name|pcm_s
operator|.
name|pdma_chunkcount
condition|)
block|{
comment|/* Update chunksize and then receive the next chunk from FIFO. */
name|chunksize
operator|=
name|pcm_s
operator|.
name|pdma_count
operator|/
name|pcm_s
operator|.
name|pdma_chunkcount
operator|--
expr_stmt|;
name|fifo_recv
argument_list|(
name|pcm_s
operator|.
name|pdma_buf
argument_list|,
name|chunksize
argument_list|)
expr_stmt|;
name|pcm_s
operator|.
name|pdma_buf
operator|+=
name|chunksize
expr_stmt|;
name|pcm_s
operator|.
name|pdma_count
operator|-=
name|chunksize
expr_stmt|;
block|}
else|else
comment|/* ??? something wrong... */
name|printk
argument_list|(
literal|"pcm0: chunkcount overrun\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|fifo_recv
parameter_list|(
name|pcm_data
modifier|*
name|buf
parameter_list|,
name|int
name|count
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|count
operator|>
name|tmpbuf
operator|.
name|size
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|tmpbuf
operator|.
name|size
condition|;
name|i
operator|++
control|)
operator|*
name|buf
operator|++
operator|=
name|tmpbuf
operator|.
name|buff
index|[
name|i
index|]
expr_stmt|;
name|count
operator|-=
name|tmpbuf
operator|.
name|size
expr_stmt|;
name|tmpbuf
operator|.
name|size
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|pcm_s
operator|.
name|stereo
condition|)
name|fifo_recv_stereo
argument_list|(
name|buf
argument_list|,
name|count
argument_list|)
expr_stmt|;
else|else
name|fifo_recv_monoral
argument_list|(
name|buf
argument_list|,
name|count
argument_list|)
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
operator|*
name|buf
operator|++
operator|=
name|tmpbuf
operator|.
name|buff
index|[
name|i
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|tmpbuf
operator|.
name|size
operator|-
name|count
condition|;
name|i
operator|++
control|)
name|tmpbuf
operator|.
name|buff
index|[
name|i
index|]
operator|=
name|tmpbuf
operator|.
name|buff
index|[
name|i
operator|+
name|count
index|]
expr_stmt|;
name|tmpbuf
operator|.
name|size
operator|-=
name|count
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|PCM86_DEBUG
name|printk
argument_list|(
literal|"fifo_recv(): %d bytes received\n"
argument_list|,
operator|(
operator|(
name|count
operator|/
operator|(
name|pcm_s
operator|.
name|bytes
operator|<<
name|pcm_s
operator|.
name|stereo
operator|)
operator|)
operator|*
name|pcm_s
operator|.
name|chipspeed
operator|/
name|pcm_s
operator|.
name|speed
operator|)
operator|*
name|pcm_s
operator|.
name|bytes
operator|*
literal|2
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|void
name|fifo_recv_stereo
parameter_list|(
name|pcm_data
modifier|*
name|buf
parameter_list|,
name|int
name|count
parameter_list|)
block|{
comment|/* Convert format and sampling speed. */
switch|switch
condition|(
name|pcm_s
operator|.
name|format
condition|)
block|{
case|case
name|AFMT_MU_LAW
case|:
name|fifo_recv_stereo_ulaw
argument_list|(
name|buf
argument_list|,
name|count
argument_list|)
expr_stmt|;
break|break;
case|case
name|AFMT_S8
case|:
name|fifo_recv_stereo_8
argument_list|(
name|buf
argument_list|,
name|count
argument_list|,
name|NO
argument_list|)
expr_stmt|;
break|break;
case|case
name|AFMT_U8
case|:
name|fifo_recv_stereo_8
argument_list|(
name|buf
argument_list|,
name|count
argument_list|,
name|YES
argument_list|)
expr_stmt|;
break|break;
case|case
name|AFMT_S16_LE
case|:
name|fifo_recv_stereo_16le
argument_list|(
name|buf
argument_list|,
name|count
argument_list|,
name|NO
argument_list|)
expr_stmt|;
break|break;
case|case
name|AFMT_U16_LE
case|:
name|fifo_recv_stereo_16le
argument_list|(
name|buf
argument_list|,
name|count
argument_list|,
name|YES
argument_list|)
expr_stmt|;
break|break;
case|case
name|AFMT_S16_BE
case|:
name|fifo_recv_stereo_16be
argument_list|(
name|buf
argument_list|,
name|count
argument_list|,
name|NO
argument_list|)
expr_stmt|;
break|break;
case|case
name|AFMT_U16_BE
case|:
name|fifo_recv_stereo_16be
argument_list|(
name|buf
argument_list|,
name|count
argument_list|,
name|YES
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|fifo_recv_monoral
parameter_list|(
name|pcm_data
modifier|*
name|buf
parameter_list|,
name|int
name|count
parameter_list|)
block|{
comment|/* Convert format and sampling speed. */
switch|switch
condition|(
name|pcm_s
operator|.
name|format
condition|)
block|{
case|case
name|AFMT_MU_LAW
case|:
name|fifo_recv_mono_ulaw
argument_list|(
name|buf
argument_list|,
name|count
argument_list|)
expr_stmt|;
break|break;
case|case
name|AFMT_S8
case|:
name|fifo_recv_mono_8
argument_list|(
name|buf
argument_list|,
name|count
argument_list|,
name|NO
argument_list|)
expr_stmt|;
break|break;
case|case
name|AFMT_U8
case|:
name|fifo_recv_mono_8
argument_list|(
name|buf
argument_list|,
name|count
argument_list|,
name|YES
argument_list|)
expr_stmt|;
break|break;
case|case
name|AFMT_S16_LE
case|:
name|fifo_recv_mono_16le
argument_list|(
name|buf
argument_list|,
name|count
argument_list|,
name|NO
argument_list|)
expr_stmt|;
break|break;
case|case
name|AFMT_U16_LE
case|:
name|fifo_recv_mono_16le
argument_list|(
name|buf
argument_list|,
name|count
argument_list|,
name|YES
argument_list|)
expr_stmt|;
break|break;
case|case
name|AFMT_S16_BE
case|:
name|fifo_recv_mono_16be
argument_list|(
name|buf
argument_list|,
name|count
argument_list|,
name|NO
argument_list|)
expr_stmt|;
break|break;
case|case
name|AFMT_U16_BE
case|:
name|fifo_recv_mono_16be
argument_list|(
name|buf
argument_list|,
name|count
argument_list|,
name|YES
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|fifo_recv_stereo_ulaw
parameter_list|(
name|pcm_data
modifier|*
name|buf
parameter_list|,
name|int
name|count
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|cnt
decl_stmt|;
name|signed
name|char
name|dl
decl_stmt|,
name|dl0
decl_stmt|,
name|dl1
decl_stmt|,
name|dr
decl_stmt|,
name|dr0
decl_stmt|,
name|dr1
decl_stmt|;
name|cnt
operator|=
name|count
operator|/
literal|2
expr_stmt|;
if|if
condition|(
name|pcm_s
operator|.
name|speed
operator|==
name|pcm_s
operator|.
name|chipspeed
condition|)
block|{
comment|/* No reason to convert the pcm speed. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cnt
condition|;
name|i
operator|++
control|)
block|{
operator|*
name|buf
operator|++
operator|=
name|linear2ulaw
index|[
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
index|]
expr_stmt|;
operator|*
name|buf
operator|++
operator|=
name|linear2ulaw
index|[
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
index|]
expr_stmt|;
block|}
if|if
condition|(
name|count
operator|%
literal|2
condition|)
block|{
operator|*
name|buf
operator|++
operator|=
name|linear2ulaw
index|[
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
index|]
expr_stmt|;
name|tmpbuf
operator|.
name|buff
index|[
literal|0
index|]
operator|=
name|linear2ulaw
index|[
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
index|]
expr_stmt|;
name|tmpbuf
operator|.
name|size
operator|=
literal|1
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* Speed conversion with linear interpolation method. */
name|dl0
operator|=
name|pcm_s
operator|.
name|last_l
expr_stmt|;
name|dr0
operator|=
name|pcm_s
operator|.
name|last_r
expr_stmt|;
name|dl1
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
expr_stmt|;
name|dr1
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cnt
condition|;
name|i
operator|++
control|)
block|{
while|while
condition|(
name|pcm_s
operator|.
name|acc
operator|>=
name|pcm_s
operator|.
name|speed
condition|)
block|{
name|pcm_s
operator|.
name|acc
operator|-=
name|pcm_s
operator|.
name|speed
expr_stmt|;
name|dl0
operator|=
name|dl1
expr_stmt|;
name|dr0
operator|=
name|dr1
expr_stmt|;
name|dl1
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
expr_stmt|;
name|dr1
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
expr_stmt|;
block|}
name|dl
operator|=
operator|(
operator|(
name|dl0
operator|*
operator|(
name|pcm_s
operator|.
name|speed
operator|-
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|+
operator|(
name|dl1
operator|*
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|/
name|pcm_s
operator|.
name|speed
expr_stmt|;
name|dr
operator|=
operator|(
operator|(
name|dr0
operator|*
operator|(
name|pcm_s
operator|.
name|speed
operator|-
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|+
operator|(
name|dr1
operator|*
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|/
name|pcm_s
operator|.
name|speed
expr_stmt|;
operator|*
name|buf
operator|++
operator|=
name|linear2ulaw
index|[
name|dl
operator|&
literal|0xff
index|]
expr_stmt|;
operator|*
name|buf
operator|++
operator|=
name|linear2ulaw
index|[
name|dr
operator|&
literal|0xff
index|]
expr_stmt|;
name|pcm_s
operator|.
name|acc
operator|+=
name|pcm_s
operator|.
name|chipspeed
expr_stmt|;
block|}
if|if
condition|(
name|count
operator|%
literal|2
condition|)
block|{
while|while
condition|(
name|pcm_s
operator|.
name|acc
operator|>=
name|pcm_s
operator|.
name|speed
condition|)
block|{
name|pcm_s
operator|.
name|acc
operator|-=
name|pcm_s
operator|.
name|speed
expr_stmt|;
name|dl0
operator|=
name|dl1
expr_stmt|;
name|dr0
operator|=
name|dr1
expr_stmt|;
name|dl1
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
expr_stmt|;
name|dr1
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
expr_stmt|;
block|}
name|dl
operator|=
operator|(
operator|(
name|dl0
operator|*
operator|(
name|pcm_s
operator|.
name|speed
operator|-
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|+
operator|(
name|dl1
operator|*
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|/
name|pcm_s
operator|.
name|speed
expr_stmt|;
name|dr
operator|=
operator|(
operator|(
name|dr0
operator|*
operator|(
name|pcm_s
operator|.
name|speed
operator|-
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|+
operator|(
name|dr1
operator|*
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|/
name|pcm_s
operator|.
name|speed
expr_stmt|;
operator|*
name|buf
operator|++
operator|=
name|linear2ulaw
index|[
name|dl
operator|&
literal|0xff
index|]
expr_stmt|;
name|tmpbuf
operator|.
name|buff
index|[
literal|0
index|]
operator|=
name|linear2ulaw
index|[
name|dr
operator|&
literal|0xff
index|]
expr_stmt|;
name|tmpbuf
operator|.
name|size
operator|=
literal|1
expr_stmt|;
block|}
name|pcm_s
operator|.
name|last_l
operator|=
name|dl0
expr_stmt|;
name|pcm_s
operator|.
name|last_r
operator|=
name|dr0
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|fifo_recv_stereo_8
parameter_list|(
name|pcm_data
modifier|*
name|buf
parameter_list|,
name|int
name|count
parameter_list|,
name|int
name|uflag
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|cnt
decl_stmt|;
name|signed
name|char
name|dl
decl_stmt|,
name|dl0
decl_stmt|,
name|dl1
decl_stmt|,
name|dr
decl_stmt|,
name|dr0
decl_stmt|,
name|dr1
decl_stmt|,
name|zlev
decl_stmt|;
name|zlev
operator|=
name|uflag
condition|?
operator|-
literal|128
else|:
literal|0
expr_stmt|;
name|cnt
operator|=
name|count
operator|/
literal|2
expr_stmt|;
if|if
condition|(
name|pcm_s
operator|.
name|speed
operator|==
name|pcm_s
operator|.
name|chipspeed
condition|)
block|{
comment|/* No reason to convert the pcm speed. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cnt
condition|;
name|i
operator|++
control|)
block|{
operator|*
name|buf
operator|++
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
operator|+
name|zlev
expr_stmt|;
operator|*
name|buf
operator|++
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
operator|+
name|zlev
expr_stmt|;
block|}
if|if
condition|(
name|count
operator|%
literal|2
condition|)
block|{
operator|*
name|buf
operator|++
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
operator|+
name|zlev
expr_stmt|;
name|tmpbuf
operator|.
name|buff
index|[
literal|0
index|]
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
operator|+
name|zlev
expr_stmt|;
name|tmpbuf
operator|.
name|size
operator|=
literal|1
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* Speed conversion with linear interpolation method. */
name|dl0
operator|=
name|pcm_s
operator|.
name|last_l
expr_stmt|;
name|dr0
operator|=
name|pcm_s
operator|.
name|last_r
expr_stmt|;
name|dl1
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
expr_stmt|;
name|dr1
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cnt
condition|;
name|i
operator|++
control|)
block|{
while|while
condition|(
name|pcm_s
operator|.
name|acc
operator|>=
name|pcm_s
operator|.
name|speed
condition|)
block|{
name|pcm_s
operator|.
name|acc
operator|-=
name|pcm_s
operator|.
name|speed
expr_stmt|;
name|dl0
operator|=
name|dl1
expr_stmt|;
name|dr0
operator|=
name|dr1
expr_stmt|;
name|dl1
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
expr_stmt|;
name|dr1
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
expr_stmt|;
block|}
name|dl
operator|=
operator|(
operator|(
name|dl0
operator|*
operator|(
name|pcm_s
operator|.
name|speed
operator|-
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|+
operator|(
name|dl1
operator|*
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|/
name|pcm_s
operator|.
name|speed
expr_stmt|;
name|dr
operator|=
operator|(
operator|(
name|dr0
operator|*
operator|(
name|pcm_s
operator|.
name|speed
operator|-
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|+
operator|(
name|dr1
operator|*
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|/
name|pcm_s
operator|.
name|speed
expr_stmt|;
operator|*
name|buf
operator|++
operator|=
name|dl
operator|+
name|zlev
expr_stmt|;
operator|*
name|buf
operator|++
operator|=
name|dr
operator|+
name|zlev
expr_stmt|;
name|pcm_s
operator|.
name|acc
operator|+=
name|pcm_s
operator|.
name|chipspeed
expr_stmt|;
block|}
if|if
condition|(
name|count
operator|%
literal|2
condition|)
block|{
while|while
condition|(
name|pcm_s
operator|.
name|acc
operator|>=
name|pcm_s
operator|.
name|speed
condition|)
block|{
name|pcm_s
operator|.
name|acc
operator|-=
name|pcm_s
operator|.
name|speed
expr_stmt|;
name|dl0
operator|=
name|dl1
expr_stmt|;
name|dr0
operator|=
name|dr1
expr_stmt|;
name|dl1
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
expr_stmt|;
name|dr1
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
expr_stmt|;
block|}
name|dl
operator|=
operator|(
operator|(
name|dl0
operator|*
operator|(
name|pcm_s
operator|.
name|speed
operator|-
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|+
operator|(
name|dl1
operator|*
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|/
name|pcm_s
operator|.
name|speed
expr_stmt|;
name|dr
operator|=
operator|(
operator|(
name|dr0
operator|*
operator|(
name|pcm_s
operator|.
name|speed
operator|-
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|+
operator|(
name|dr1
operator|*
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|/
name|pcm_s
operator|.
name|speed
expr_stmt|;
operator|*
name|buf
operator|++
operator|=
name|dl
operator|+
name|zlev
expr_stmt|;
name|tmpbuf
operator|.
name|buff
index|[
literal|0
index|]
operator|=
name|dr
operator|+
name|zlev
expr_stmt|;
name|tmpbuf
operator|.
name|size
operator|=
literal|1
expr_stmt|;
block|}
name|pcm_s
operator|.
name|last_l
operator|=
name|dl0
expr_stmt|;
name|pcm_s
operator|.
name|last_r
operator|=
name|dr0
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|fifo_recv_stereo_16le
parameter_list|(
name|pcm_data
modifier|*
name|buf
parameter_list|,
name|int
name|count
parameter_list|,
name|int
name|uflag
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|cnt
decl_stmt|;
name|short
name|dl
decl_stmt|,
name|dl0
decl_stmt|,
name|dl1
decl_stmt|,
name|dr
decl_stmt|,
name|dr0
decl_stmt|,
name|dr1
decl_stmt|,
name|zlev
decl_stmt|;
name|pcm_data
name|t
index|[
literal|4
index|]
decl_stmt|;
name|zlev
operator|=
name|uflag
condition|?
operator|-
literal|128
else|:
literal|0
expr_stmt|;
name|cnt
operator|=
name|count
operator|/
literal|4
expr_stmt|;
if|if
condition|(
name|pcm_s
operator|.
name|speed
operator|==
name|pcm_s
operator|.
name|chipspeed
condition|)
block|{
comment|/* No reason to convert the pcm speed. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cnt
condition|;
name|i
operator|++
control|)
block|{
operator|*
operator|(
name|buf
operator|+
literal|1
operator|)
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
operator|+
name|zlev
expr_stmt|;
operator|*
name|buf
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
expr_stmt|;
operator|*
operator|(
name|buf
operator|+
literal|3
operator|)
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
operator|+
name|zlev
expr_stmt|;
operator|*
operator|(
name|buf
operator|+
literal|2
operator|)
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
expr_stmt|;
name|buf
operator|+=
literal|4
expr_stmt|;
block|}
if|if
condition|(
name|count
operator|%
literal|4
condition|)
block|{
name|t
index|[
literal|1
index|]
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
operator|+
name|zlev
expr_stmt|;
name|t
index|[
literal|0
index|]
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
expr_stmt|;
name|t
index|[
literal|3
index|]
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
operator|+
name|zlev
expr_stmt|;
name|t
index|[
literal|2
index|]
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
expr_stmt|;
name|tmpbuf
operator|.
name|size
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
operator|%
literal|4
condition|;
name|i
operator|++
control|)
operator|*
name|buf
operator|++
operator|=
name|t
index|[
name|i
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
name|count
operator|%
literal|4
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
name|tmpbuf
operator|.
name|buff
index|[
name|tmpbuf
operator|.
name|size
operator|++
index|]
operator|=
name|t
index|[
name|i
index|]
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* Speed conversion with linear interpolation method. */
name|dl0
operator|=
name|pcm_s
operator|.
name|last_l
expr_stmt|;
name|dr0
operator|=
name|pcm_s
operator|.
name|last_r
expr_stmt|;
name|dl1
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
operator|<<
literal|8
expr_stmt|;
name|dl1
operator||=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
expr_stmt|;
name|dr1
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
operator|<<
literal|8
expr_stmt|;
name|dr1
operator||=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cnt
condition|;
name|i
operator|++
control|)
block|{
while|while
condition|(
name|pcm_s
operator|.
name|acc
operator|>=
name|pcm_s
operator|.
name|speed
condition|)
block|{
name|pcm_s
operator|.
name|acc
operator|-=
name|pcm_s
operator|.
name|speed
expr_stmt|;
name|dl0
operator|=
name|dl1
expr_stmt|;
name|dr0
operator|=
name|dr1
expr_stmt|;
name|dl1
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
operator|<<
literal|8
expr_stmt|;
name|dl1
operator||=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
expr_stmt|;
name|dr1
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
operator|<<
literal|8
expr_stmt|;
name|dr1
operator||=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
expr_stmt|;
block|}
name|dl
operator|=
operator|(
operator|(
name|dl0
operator|*
operator|(
name|pcm_s
operator|.
name|speed
operator|-
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|+
operator|(
name|dl1
operator|*
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|/
name|pcm_s
operator|.
name|speed
expr_stmt|;
name|dr
operator|=
operator|(
operator|(
name|dr0
operator|*
operator|(
name|pcm_s
operator|.
name|speed
operator|-
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|+
operator|(
name|dr1
operator|*
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|/
name|pcm_s
operator|.
name|speed
expr_stmt|;
operator|*
name|buf
operator|++
operator|=
name|dl
operator|&
literal|0xff
expr_stmt|;
operator|*
name|buf
operator|++
operator|=
operator|(
operator|(
name|dl
operator|>>
literal|8
operator|)
operator|&
literal|0xff
operator|)
operator|+
name|zlev
expr_stmt|;
operator|*
name|buf
operator|++
operator|=
name|dr
operator|&
literal|0xff
expr_stmt|;
operator|*
name|buf
operator|++
operator|=
operator|(
operator|(
name|dr
operator|>>
literal|8
operator|)
operator|&
literal|0xff
operator|)
operator|+
name|zlev
expr_stmt|;
name|pcm_s
operator|.
name|acc
operator|+=
name|pcm_s
operator|.
name|chipspeed
expr_stmt|;
block|}
if|if
condition|(
name|count
operator|%
literal|4
condition|)
block|{
while|while
condition|(
name|pcm_s
operator|.
name|acc
operator|>=
name|pcm_s
operator|.
name|speed
condition|)
block|{
name|pcm_s
operator|.
name|acc
operator|-=
name|pcm_s
operator|.
name|speed
expr_stmt|;
name|dl0
operator|=
name|dl1
expr_stmt|;
name|dr0
operator|=
name|dr1
expr_stmt|;
name|dl1
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
operator|<<
literal|8
expr_stmt|;
name|dl1
operator||=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
expr_stmt|;
name|dr1
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
operator|<<
literal|8
expr_stmt|;
name|dr1
operator||=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
expr_stmt|;
block|}
name|dl
operator|=
operator|(
operator|(
name|dl0
operator|*
operator|(
name|pcm_s
operator|.
name|speed
operator|-
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|+
operator|(
name|dl1
operator|*
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|/
name|pcm_s
operator|.
name|speed
expr_stmt|;
name|dr
operator|=
operator|(
operator|(
name|dr0
operator|*
operator|(
name|pcm_s
operator|.
name|speed
operator|-
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|+
operator|(
name|dr1
operator|*
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|/
name|pcm_s
operator|.
name|speed
expr_stmt|;
name|t
index|[
literal|0
index|]
operator|=
name|dl
operator|&
literal|0xff
expr_stmt|;
name|t
index|[
literal|1
index|]
operator|=
operator|(
operator|(
name|dl
operator|>>
literal|8
operator|)
operator|&
literal|0xff
operator|)
operator|+
name|zlev
expr_stmt|;
name|t
index|[
literal|2
index|]
operator|=
name|dr
operator|&
literal|0xff
expr_stmt|;
name|t
index|[
literal|3
index|]
operator|=
operator|(
operator|(
name|dr
operator|>>
literal|8
operator|)
operator|&
literal|0xff
operator|)
operator|+
name|zlev
expr_stmt|;
name|tmpbuf
operator|.
name|size
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
operator|%
literal|4
condition|;
name|i
operator|++
control|)
operator|*
name|buf
operator|++
operator|=
name|t
index|[
name|i
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
name|count
operator|%
literal|4
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
name|tmpbuf
operator|.
name|buff
index|[
name|tmpbuf
operator|.
name|size
operator|++
index|]
operator|=
name|t
index|[
name|i
index|]
expr_stmt|;
block|}
name|pcm_s
operator|.
name|last_l
operator|=
name|dl0
expr_stmt|;
name|pcm_s
operator|.
name|last_r
operator|=
name|dr0
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|fifo_recv_stereo_16be
parameter_list|(
name|pcm_data
modifier|*
name|buf
parameter_list|,
name|int
name|count
parameter_list|,
name|int
name|uflag
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|cnt
decl_stmt|;
name|short
name|dl
decl_stmt|,
name|dl0
decl_stmt|,
name|dl1
decl_stmt|,
name|dr
decl_stmt|,
name|dr0
decl_stmt|,
name|dr1
decl_stmt|,
name|zlev
decl_stmt|;
name|pcm_data
name|t
index|[
literal|4
index|]
decl_stmt|;
name|zlev
operator|=
name|uflag
condition|?
operator|-
literal|128
else|:
literal|0
expr_stmt|;
name|cnt
operator|=
name|count
operator|/
literal|4
expr_stmt|;
if|if
condition|(
name|pcm_s
operator|.
name|speed
operator|==
name|pcm_s
operator|.
name|chipspeed
condition|)
block|{
comment|/* No reason to convert the pcm speed. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cnt
condition|;
name|i
operator|++
control|)
block|{
operator|*
name|buf
operator|++
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
operator|+
name|zlev
expr_stmt|;
operator|*
name|buf
operator|++
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
expr_stmt|;
operator|*
name|buf
operator|++
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
operator|+
name|zlev
expr_stmt|;
operator|*
name|buf
operator|++
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|count
operator|%
literal|4
condition|)
block|{
name|t
index|[
literal|0
index|]
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
operator|+
name|zlev
expr_stmt|;
name|t
index|[
literal|1
index|]
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
expr_stmt|;
name|t
index|[
literal|2
index|]
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
operator|+
name|zlev
expr_stmt|;
name|t
index|[
literal|3
index|]
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
expr_stmt|;
name|tmpbuf
operator|.
name|size
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
operator|%
literal|4
condition|;
name|i
operator|++
control|)
operator|*
name|buf
operator|++
operator|=
name|t
index|[
name|i
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
name|count
operator|%
literal|4
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
name|tmpbuf
operator|.
name|buff
index|[
name|tmpbuf
operator|.
name|size
operator|++
index|]
operator|=
name|t
index|[
name|i
index|]
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* Speed conversion with linear interpolation method. */
name|dl0
operator|=
name|pcm_s
operator|.
name|last_l
expr_stmt|;
name|dr0
operator|=
name|pcm_s
operator|.
name|last_r
expr_stmt|;
name|dl1
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
operator|<<
literal|8
expr_stmt|;
name|dl1
operator||=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
expr_stmt|;
name|dr1
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
operator|<<
literal|8
expr_stmt|;
name|dr1
operator||=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cnt
condition|;
name|i
operator|++
control|)
block|{
while|while
condition|(
name|pcm_s
operator|.
name|acc
operator|>=
name|pcm_s
operator|.
name|speed
condition|)
block|{
name|pcm_s
operator|.
name|acc
operator|-=
name|pcm_s
operator|.
name|speed
expr_stmt|;
name|dl0
operator|=
name|dl1
expr_stmt|;
name|dr0
operator|=
name|dr1
expr_stmt|;
name|dl1
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
operator|<<
literal|8
expr_stmt|;
name|dl1
operator||=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
expr_stmt|;
name|dr1
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
operator|<<
literal|8
expr_stmt|;
name|dr1
operator||=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
expr_stmt|;
block|}
name|dl
operator|=
operator|(
operator|(
name|dl0
operator|*
operator|(
name|pcm_s
operator|.
name|speed
operator|-
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|+
operator|(
name|dl1
operator|*
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|/
name|pcm_s
operator|.
name|speed
expr_stmt|;
name|dr
operator|=
operator|(
operator|(
name|dr0
operator|*
operator|(
name|pcm_s
operator|.
name|speed
operator|-
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|+
operator|(
name|dr1
operator|*
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|/
name|pcm_s
operator|.
name|speed
expr_stmt|;
operator|*
name|buf
operator|++
operator|=
operator|(
operator|(
name|dl
operator|>>
literal|8
operator|)
operator|&
literal|0xff
operator|)
operator|+
name|zlev
expr_stmt|;
operator|*
name|buf
operator|++
operator|=
name|dl
operator|&
literal|0xff
expr_stmt|;
operator|*
name|buf
operator|++
operator|=
operator|(
operator|(
name|dr
operator|>>
literal|8
operator|)
operator|&
literal|0xff
operator|)
operator|+
name|zlev
expr_stmt|;
operator|*
name|buf
operator|++
operator|=
name|dr
operator|&
literal|0xff
expr_stmt|;
name|pcm_s
operator|.
name|acc
operator|+=
name|pcm_s
operator|.
name|chipspeed
expr_stmt|;
block|}
if|if
condition|(
name|count
operator|%
literal|4
condition|)
block|{
while|while
condition|(
name|pcm_s
operator|.
name|acc
operator|>=
name|pcm_s
operator|.
name|speed
condition|)
block|{
name|pcm_s
operator|.
name|acc
operator|-=
name|pcm_s
operator|.
name|speed
expr_stmt|;
name|dl0
operator|=
name|dl1
expr_stmt|;
name|dr0
operator|=
name|dr1
expr_stmt|;
name|dl1
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
operator|<<
literal|8
expr_stmt|;
name|dl1
operator||=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
expr_stmt|;
name|dr1
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
operator|<<
literal|8
expr_stmt|;
name|dr1
operator||=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
expr_stmt|;
block|}
name|dl
operator|=
operator|(
operator|(
name|dl0
operator|*
operator|(
name|pcm_s
operator|.
name|speed
operator|-
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|+
operator|(
name|dl1
operator|*
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|/
name|pcm_s
operator|.
name|speed
expr_stmt|;
name|dr
operator|=
operator|(
operator|(
name|dr0
operator|*
operator|(
name|pcm_s
operator|.
name|speed
operator|-
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|+
operator|(
name|dr1
operator|*
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|/
name|pcm_s
operator|.
name|speed
expr_stmt|;
name|t
index|[
literal|0
index|]
operator|=
operator|(
operator|(
name|dl
operator|>>
literal|8
operator|)
operator|&
literal|0xff
operator|)
operator|+
name|zlev
expr_stmt|;
name|t
index|[
literal|1
index|]
operator|=
name|dl
operator|&
literal|0xff
expr_stmt|;
name|t
index|[
literal|2
index|]
operator|=
operator|(
operator|(
name|dr
operator|>>
literal|8
operator|)
operator|&
literal|0xff
operator|)
operator|+
name|zlev
expr_stmt|;
name|t
index|[
literal|3
index|]
operator|=
name|dr
operator|&
literal|0xff
expr_stmt|;
name|tmpbuf
operator|.
name|size
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
operator|%
literal|4
condition|;
name|i
operator|++
control|)
operator|*
name|buf
operator|++
operator|=
name|t
index|[
name|i
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
name|count
operator|%
literal|4
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
name|tmpbuf
operator|.
name|buff
index|[
name|tmpbuf
operator|.
name|size
operator|++
index|]
operator|=
name|t
index|[
name|i
index|]
expr_stmt|;
block|}
name|pcm_s
operator|.
name|last_l
operator|=
name|dl0
expr_stmt|;
name|pcm_s
operator|.
name|last_r
operator|=
name|dr0
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|fifo_recv_mono_ulaw
parameter_list|(
name|pcm_data
modifier|*
name|buf
parameter_list|,
name|int
name|count
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|signed
name|char
name|d
decl_stmt|,
name|d0
decl_stmt|,
name|d1
decl_stmt|;
if|if
condition|(
name|pcm_s
operator|.
name|speed
operator|==
name|pcm_s
operator|.
name|chipspeed
condition|)
block|{
comment|/* No reason to convert the pcm speed. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
block|{
name|d
operator|=
operator|(
operator|(
name|signed
name|char
operator|)
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
operator|+
operator|(
name|signed
name|char
operator|)
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
operator|)
operator|>>
literal|1
expr_stmt|;
operator|*
name|buf
operator|++
operator|=
name|linear2ulaw
index|[
name|d
operator|&
literal|0xff
index|]
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* Speed conversion with linear interpolation method. */
name|d0
operator|=
name|pcm_s
operator|.
name|last_l
expr_stmt|;
name|d1
operator|=
operator|(
operator|(
name|signed
name|char
operator|)
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
operator|+
operator|(
name|signed
name|char
operator|)
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
operator|)
operator|>>
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
block|{
while|while
condition|(
name|pcm_s
operator|.
name|acc
operator|>=
name|pcm_s
operator|.
name|speed
condition|)
block|{
name|pcm_s
operator|.
name|acc
operator|-=
name|pcm_s
operator|.
name|speed
expr_stmt|;
name|d0
operator|=
name|d1
expr_stmt|;
name|d1
operator|=
operator|(
operator|(
name|signed
name|char
operator|)
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
operator|+
operator|(
name|signed
name|char
operator|)
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
operator|)
operator|>>
literal|1
expr_stmt|;
block|}
name|d
operator|=
operator|(
operator|(
name|d0
operator|*
operator|(
name|pcm_s
operator|.
name|speed
operator|-
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|+
operator|(
name|d1
operator|*
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|/
name|pcm_s
operator|.
name|speed
expr_stmt|;
operator|*
name|buf
operator|++
operator|=
name|linear2ulaw
index|[
name|d
operator|&
literal|0xff
index|]
expr_stmt|;
name|pcm_s
operator|.
name|acc
operator|+=
name|pcm_s
operator|.
name|chipspeed
expr_stmt|;
block|}
name|pcm_s
operator|.
name|last_l
operator|=
name|d0
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|fifo_recv_mono_8
parameter_list|(
name|pcm_data
modifier|*
name|buf
parameter_list|,
name|int
name|count
parameter_list|,
name|int
name|uflag
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|signed
name|char
name|d
decl_stmt|,
name|d0
decl_stmt|,
name|d1
decl_stmt|,
name|zlev
decl_stmt|;
name|zlev
operator|=
name|uflag
condition|?
operator|-
literal|128
else|:
literal|0
expr_stmt|;
if|if
condition|(
name|pcm_s
operator|.
name|speed
operator|==
name|pcm_s
operator|.
name|chipspeed
condition|)
block|{
comment|/* No reason to convert the pcm speed. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
block|{
name|d
operator|=
operator|(
operator|(
name|signed
name|char
operator|)
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
operator|+
operator|(
name|signed
name|char
operator|)
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
operator|)
operator|>>
literal|1
expr_stmt|;
operator|*
name|buf
operator|++
operator|=
name|d
operator|+
name|zlev
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* Speed conversion with linear interpolation method. */
name|d0
operator|=
name|pcm_s
operator|.
name|last_l
expr_stmt|;
name|d1
operator|=
operator|(
operator|(
name|signed
name|char
operator|)
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
operator|+
operator|(
name|signed
name|char
operator|)
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
operator|)
operator|>>
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
block|{
while|while
condition|(
name|pcm_s
operator|.
name|acc
operator|>=
name|pcm_s
operator|.
name|speed
condition|)
block|{
name|pcm_s
operator|.
name|acc
operator|-=
name|pcm_s
operator|.
name|speed
expr_stmt|;
name|d0
operator|=
name|d1
expr_stmt|;
name|d1
operator|=
operator|(
operator|(
name|signed
name|char
operator|)
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
operator|+
operator|(
name|signed
name|char
operator|)
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
operator|)
operator|>>
literal|1
expr_stmt|;
block|}
name|d
operator|=
operator|(
operator|(
name|d0
operator|*
operator|(
name|pcm_s
operator|.
name|speed
operator|-
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|+
operator|(
name|d1
operator|*
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|/
name|pcm_s
operator|.
name|speed
expr_stmt|;
operator|*
name|buf
operator|++
operator|=
name|d
operator|+
name|zlev
expr_stmt|;
name|pcm_s
operator|.
name|acc
operator|+=
name|pcm_s
operator|.
name|chipspeed
expr_stmt|;
block|}
name|pcm_s
operator|.
name|last_l
operator|=
name|d0
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|fifo_recv_mono_16le
parameter_list|(
name|pcm_data
modifier|*
name|buf
parameter_list|,
name|int
name|count
parameter_list|,
name|int
name|uflag
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|cnt
decl_stmt|;
name|short
name|d
decl_stmt|,
name|d0
decl_stmt|,
name|d1
decl_stmt|,
name|el
decl_stmt|,
name|er
decl_stmt|,
name|zlev
decl_stmt|;
name|zlev
operator|=
name|uflag
condition|?
operator|-
literal|128
else|:
literal|0
expr_stmt|;
name|cnt
operator|=
name|count
operator|/
literal|2
expr_stmt|;
if|if
condition|(
name|pcm_s
operator|.
name|speed
operator|==
name|pcm_s
operator|.
name|chipspeed
condition|)
block|{
comment|/* No reason to convert the pcm speed. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cnt
condition|;
name|i
operator|++
control|)
block|{
name|el
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
operator|<<
literal|8
expr_stmt|;
name|el
operator||=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
expr_stmt|;
name|er
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
operator|<<
literal|8
expr_stmt|;
name|er
operator||=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
expr_stmt|;
name|d
operator|=
operator|(
name|el
operator|+
name|er
operator|)
operator|>>
literal|1
expr_stmt|;
operator|*
name|buf
operator|++
operator|=
name|d
operator|&
literal|0xff
expr_stmt|;
operator|*
name|buf
operator|++
operator|=
operator|(
operator|(
name|d
operator|>>
literal|8
operator|)
operator|&
literal|0xff
operator|)
operator|+
name|zlev
expr_stmt|;
block|}
if|if
condition|(
name|count
operator|%
literal|2
condition|)
block|{
name|el
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
operator|<<
literal|8
expr_stmt|;
name|el
operator||=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
expr_stmt|;
name|er
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
operator|<<
literal|8
expr_stmt|;
name|er
operator||=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
expr_stmt|;
name|d
operator|=
operator|(
name|el
operator|+
name|er
operator|)
operator|>>
literal|1
expr_stmt|;
operator|*
name|buf
operator|++
operator|=
name|d
operator|&
literal|0xff
expr_stmt|;
name|tmpbuf
operator|.
name|buff
index|[
literal|0
index|]
operator|=
operator|(
operator|(
name|d
operator|>>
literal|8
operator|)
operator|&
literal|0xff
operator|)
operator|+
name|zlev
expr_stmt|;
name|tmpbuf
operator|.
name|size
operator|=
literal|1
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* Speed conversion with linear interpolation method. */
name|d0
operator|=
name|pcm_s
operator|.
name|last_l
expr_stmt|;
name|el
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
operator|<<
literal|8
expr_stmt|;
name|el
operator||=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
expr_stmt|;
name|er
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
operator|<<
literal|8
expr_stmt|;
name|er
operator||=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
expr_stmt|;
name|d1
operator|=
operator|(
name|el
operator|+
name|er
operator|)
operator|>>
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cnt
condition|;
name|i
operator|++
control|)
block|{
while|while
condition|(
name|pcm_s
operator|.
name|acc
operator|>=
name|pcm_s
operator|.
name|speed
condition|)
block|{
name|pcm_s
operator|.
name|acc
operator|-=
name|pcm_s
operator|.
name|speed
expr_stmt|;
name|d0
operator|=
name|d1
expr_stmt|;
name|el
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
operator|<<
literal|8
expr_stmt|;
name|el
operator||=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
expr_stmt|;
name|er
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
operator|<<
literal|8
expr_stmt|;
name|er
operator||=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
expr_stmt|;
name|d1
operator|=
operator|(
name|el
operator|+
name|er
operator|)
operator|>>
literal|1
expr_stmt|;
block|}
name|d
operator|=
operator|(
operator|(
name|d0
operator|*
operator|(
name|pcm_s
operator|.
name|speed
operator|-
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|+
operator|(
name|d1
operator|*
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|/
name|pcm_s
operator|.
name|speed
expr_stmt|;
operator|*
name|buf
operator|++
operator|=
name|d
operator|&
literal|0xff
expr_stmt|;
operator|*
name|buf
operator|++
operator|=
operator|(
operator|(
name|d
operator|>>
literal|8
operator|)
operator|&
literal|0xff
operator|)
operator|+
name|zlev
expr_stmt|;
name|pcm_s
operator|.
name|acc
operator|+=
name|pcm_s
operator|.
name|chipspeed
expr_stmt|;
block|}
if|if
condition|(
name|count
operator|%
literal|2
condition|)
block|{
while|while
condition|(
name|pcm_s
operator|.
name|acc
operator|>=
name|pcm_s
operator|.
name|speed
condition|)
block|{
name|pcm_s
operator|.
name|acc
operator|-=
name|pcm_s
operator|.
name|speed
expr_stmt|;
name|d0
operator|=
name|d1
expr_stmt|;
name|el
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
operator|<<
literal|8
expr_stmt|;
name|el
operator||=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
expr_stmt|;
name|er
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
operator|<<
literal|8
expr_stmt|;
name|er
operator||=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
expr_stmt|;
name|d1
operator|=
operator|(
name|el
operator|+
name|er
operator|)
operator|>>
literal|1
expr_stmt|;
block|}
name|d
operator|=
operator|(
operator|(
name|d0
operator|*
operator|(
name|pcm_s
operator|.
name|speed
operator|-
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|+
operator|(
name|d1
operator|*
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|/
name|pcm_s
operator|.
name|speed
expr_stmt|;
operator|*
name|buf
operator|++
operator|=
name|d
operator|&
literal|0xff
expr_stmt|;
name|tmpbuf
operator|.
name|buff
index|[
literal|0
index|]
operator|=
operator|(
operator|(
name|d
operator|>>
literal|8
operator|)
operator|&
literal|0xff
operator|)
operator|+
name|zlev
expr_stmt|;
name|tmpbuf
operator|.
name|size
operator|=
literal|1
expr_stmt|;
block|}
name|pcm_s
operator|.
name|last_l
operator|=
name|d0
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|fifo_recv_mono_16be
parameter_list|(
name|pcm_data
modifier|*
name|buf
parameter_list|,
name|int
name|count
parameter_list|,
name|int
name|uflag
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|cnt
decl_stmt|;
name|short
name|d
decl_stmt|,
name|d0
decl_stmt|,
name|d1
decl_stmt|,
name|el
decl_stmt|,
name|er
decl_stmt|,
name|zlev
decl_stmt|;
name|zlev
operator|=
name|uflag
condition|?
operator|-
literal|128
else|:
literal|0
expr_stmt|;
name|cnt
operator|=
name|count
operator|/
literal|2
expr_stmt|;
if|if
condition|(
name|pcm_s
operator|.
name|speed
operator|==
name|pcm_s
operator|.
name|chipspeed
condition|)
block|{
comment|/* No reason to convert the pcm speed. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cnt
condition|;
name|i
operator|++
control|)
block|{
name|el
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
operator|<<
literal|8
expr_stmt|;
name|el
operator||=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
expr_stmt|;
name|er
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
operator|<<
literal|8
expr_stmt|;
name|er
operator||=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
expr_stmt|;
name|d
operator|=
operator|(
name|el
operator|+
name|er
operator|)
operator|>>
literal|1
expr_stmt|;
operator|*
name|buf
operator|++
operator|=
operator|(
operator|(
name|d
operator|>>
literal|8
operator|)
operator|&
literal|0xff
operator|)
operator|+
name|zlev
expr_stmt|;
operator|*
name|buf
operator|++
operator|=
name|d
operator|&
literal|0xff
expr_stmt|;
block|}
if|if
condition|(
name|count
operator|%
literal|2
condition|)
block|{
name|el
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
operator|<<
literal|8
expr_stmt|;
name|el
operator||=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
expr_stmt|;
name|er
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
operator|<<
literal|8
expr_stmt|;
name|er
operator||=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
expr_stmt|;
name|d
operator|=
operator|(
name|el
operator|+
name|er
operator|)
operator|>>
literal|1
expr_stmt|;
operator|*
name|buf
operator|++
operator|=
operator|(
operator|(
name|d
operator|>>
literal|8
operator|)
operator|&
literal|0xff
operator|)
operator|+
name|zlev
expr_stmt|;
name|tmpbuf
operator|.
name|buff
index|[
literal|0
index|]
operator|=
name|d
operator|&
literal|0xff
expr_stmt|;
name|tmpbuf
operator|.
name|size
operator|=
literal|1
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* Speed conversion with linear interpolation method. */
name|d0
operator|=
name|pcm_s
operator|.
name|last_l
expr_stmt|;
name|el
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
operator|<<
literal|8
expr_stmt|;
name|el
operator||=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
expr_stmt|;
name|er
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
operator|<<
literal|8
expr_stmt|;
name|er
operator||=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
expr_stmt|;
name|d1
operator|=
operator|(
name|el
operator|+
name|er
operator|)
operator|>>
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cnt
condition|;
name|i
operator|++
control|)
block|{
while|while
condition|(
name|pcm_s
operator|.
name|acc
operator|>=
name|pcm_s
operator|.
name|speed
condition|)
block|{
name|pcm_s
operator|.
name|acc
operator|-=
name|pcm_s
operator|.
name|speed
expr_stmt|;
name|d0
operator|=
name|d1
expr_stmt|;
name|el
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
operator|<<
literal|8
expr_stmt|;
name|el
operator||=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
expr_stmt|;
name|er
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
operator|<<
literal|8
expr_stmt|;
name|er
operator||=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
expr_stmt|;
name|d1
operator|=
operator|(
name|el
operator|+
name|er
operator|)
operator|>>
literal|1
expr_stmt|;
block|}
name|d
operator|=
operator|(
operator|(
name|d0
operator|*
operator|(
name|pcm_s
operator|.
name|speed
operator|-
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|+
operator|(
name|d1
operator|*
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|/
name|pcm_s
operator|.
name|speed
expr_stmt|;
operator|*
name|buf
operator|++
operator|=
operator|(
operator|(
name|d
operator|>>
literal|8
operator|)
operator|&
literal|0xff
operator|)
operator|+
name|zlev
expr_stmt|;
operator|*
name|buf
operator|++
operator|=
name|d
operator|&
literal|0xff
expr_stmt|;
name|pcm_s
operator|.
name|acc
operator|+=
name|pcm_s
operator|.
name|chipspeed
expr_stmt|;
block|}
if|if
condition|(
name|count
operator|%
literal|2
condition|)
block|{
while|while
condition|(
name|pcm_s
operator|.
name|acc
operator|>=
name|pcm_s
operator|.
name|speed
condition|)
block|{
name|pcm_s
operator|.
name|acc
operator|-=
name|pcm_s
operator|.
name|speed
expr_stmt|;
name|d0
operator|=
name|d1
expr_stmt|;
name|el
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
operator|<<
literal|8
expr_stmt|;
name|el
operator||=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
expr_stmt|;
name|er
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
operator|<<
literal|8
expr_stmt|;
name|er
operator||=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|12
argument_list|)
expr_stmt|;
name|d1
operator|=
operator|(
name|el
operator|+
name|er
operator|)
operator|>>
literal|1
expr_stmt|;
block|}
name|d
operator|=
operator|(
operator|(
name|d0
operator|*
operator|(
name|pcm_s
operator|.
name|speed
operator|-
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|+
operator|(
name|d1
operator|*
name|pcm_s
operator|.
name|acc
operator|)
operator|)
operator|/
name|pcm_s
operator|.
name|speed
expr_stmt|;
operator|*
name|buf
operator|++
operator|=
operator|(
operator|(
name|d
operator|>>
literal|8
operator|)
operator|&
literal|0xff
operator|)
operator|+
name|zlev
expr_stmt|;
name|tmpbuf
operator|.
name|buff
index|[
literal|0
index|]
operator|=
name|d
operator|&
literal|0xff
expr_stmt|;
name|tmpbuf
operator|.
name|size
operator|=
literal|1
expr_stmt|;
block|}
name|pcm_s
operator|.
name|last_l
operator|=
name|d0
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|pcm_stop
parameter_list|(
name|void
parameter_list|)
block|{
name|fifo_stop
argument_list|()
expr_stmt|;
comment|/* stop FIFO */
name|fifo_reset
argument_list|()
expr_stmt|;
comment|/* reset FIFO buffer */
comment|/* Reset driver's status. */
name|pcm_s
operator|.
name|intr_busy
operator|=
name|NO
expr_stmt|;
name|pcm_s
operator|.
name|intr_last
operator|=
name|NO
expr_stmt|;
name|pcm_s
operator|.
name|intr_trailer
operator|=
name|NO
expr_stmt|;
name|pcm_s
operator|.
name|acc
operator|=
literal|0
expr_stmt|;
name|pcm_s
operator|.
name|last_l
operator|=
literal|0
expr_stmt|;
name|pcm_s
operator|.
name|last_r
operator|=
literal|0
expr_stmt|;
name|DEB
argument_list|(
name|printk
argument_list|(
literal|"pcm_stop\n"
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|pcm_init
parameter_list|(
name|void
parameter_list|)
block|{
comment|/* Initialize registers on the board. */
name|pcm_stop
argument_list|()
expr_stmt|;
if|if
condition|(
name|pcm_s
operator|.
name|board_type
operator|==
name|PC980173_FAMILY
condition|)
name|dsp73_init
argument_list|()
expr_stmt|;
comment|/* Set default volume. */
name|set_volume
argument_list|(
name|DEFAULT_VOLUME
argument_list|)
expr_stmt|;
comment|/* Initialize driver's status. */
name|pcm_s
operator|.
name|opened
operator|=
name|NO
expr_stmt|;
name|pcm_initialized
operator|=
name|YES
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Codes for global use  */
end_comment

begin_function
name|int
name|probe_pcm86
parameter_list|(
name|struct
name|address_info
modifier|*
name|hw_config
parameter_list|)
block|{
return|return
name|pcm86_detect
argument_list|(
name|hw_config
argument_list|)
return|;
block|}
end_function

begin_function
name|long
name|attach_pcm86
parameter_list|(
name|long
name|mem_start
parameter_list|,
name|struct
name|address_info
modifier|*
name|hw_config
parameter_list|)
block|{
if|if
condition|(
name|pcm_s
operator|.
name|board_type
operator|==
name|NO_SUPPORTED_BOARD
condition|)
return|return
name|mem_start
return|;
comment|/* Initialize the board. */
name|pcm_init
argument_list|()
expr_stmt|;
name|printk
argument_list|(
literal|"pcm0:<%s>"
argument_list|,
name|pcm86_operations
operator|.
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|num_audiodevs
operator|<
name|MAX_AUDIO_DEV
condition|)
block|{
name|my_dev
operator|=
name|num_audiodevs
operator|++
expr_stmt|;
name|audio_devs
index|[
name|my_dev
index|]
operator|=
operator|&
name|pcm86_operations
expr_stmt|;
name|audio_devs
index|[
name|my_dev
index|]
operator|->
name|buffcount
operator|=
name|DSP_BUFFCOUNT
expr_stmt|;
name|audio_devs
index|[
name|my_dev
index|]
operator|->
name|buffsize
operator|=
name|DSP_BUFFSIZE
expr_stmt|;
ifdef|#
directive|ifdef
name|PCM86_DEBUG
name|printk
argument_list|(
literal|"\nbuffsize = %d"
argument_list|,
name|DSP_BUFFSIZE
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
else|else
name|printk
argument_list|(
literal|"pcm0: Too many PCM devices available"
argument_list|)
expr_stmt|;
return|return
name|mem_start
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|pcm86_detect
parameter_list|(
name|struct
name|address_info
modifier|*
name|hw_config
parameter_list|)
block|{
name|int
name|opna_iobase
init|=
literal|0x188
decl_stmt|,
name|irq
init|=
literal|12
decl_stmt|,
name|i
decl_stmt|;
name|unsigned
name|char
name|tmp
decl_stmt|;
if|if
condition|(
name|hw_config
operator|->
name|io_base
operator|==
operator|-
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"pcm0: iobase not specified. Assume default port(0x%x)\n"
argument_list|,
name|PCM86_IOBASE
argument_list|)
expr_stmt|;
name|hw_config
operator|->
name|io_base
operator|=
name|PCM86_IOBASE
expr_stmt|;
block|}
name|pcm_s
operator|.
name|iobase
operator|=
name|hw_config
operator|->
name|io_base
expr_stmt|;
comment|/* auto configuration */
name|tmp
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
argument_list|)
operator|&
literal|0xfc
expr_stmt|;
switch|switch
condition|(
operator|(
name|tmp
operator|&
literal|0xf0
operator|)
operator|>>
literal|4
condition|)
block|{
case|case
literal|2
case|:
name|opna_iobase
operator|=
literal|0x188
expr_stmt|;
name|pcm_s
operator|.
name|board_type
operator|=
name|PC980173_FAMILY
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|opna_iobase
operator|=
literal|0x288
expr_stmt|;
name|pcm_s
operator|.
name|board_type
operator|=
name|PC980173_FAMILY
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|opna_iobase
operator|=
literal|0x188
expr_stmt|;
name|pcm_s
operator|.
name|board_type
operator|=
name|PC980186_FAMILY
expr_stmt|;
break|break;
case|case
literal|5
case|:
name|opna_iobase
operator|=
literal|0x288
expr_stmt|;
name|pcm_s
operator|.
name|board_type
operator|=
name|PC980186_FAMILY
expr_stmt|;
break|break;
default|default:
name|pcm_s
operator|.
name|board_type
operator|=
name|NO_SUPPORTED_BOARD
expr_stmt|;
return|return
name|NO
return|;
block|}
comment|/* Enable OPNA(YM2608) facilities. */
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
argument_list|,
name|tmp
operator||
literal|0x01
argument_list|)
expr_stmt|;
comment|/* Wait for OPNA to be ready. */
name|i
operator|=
literal|100000
expr_stmt|;
comment|/* Some large value */
while|while
condition|(
operator|(
name|inb
argument_list|(
name|opna_iobase
argument_list|)
operator|&
literal|0x80
operator|)
operator|&&
operator|(
name|i
operator|--
operator|>
literal|0
operator|)
condition|)
empty_stmt|;
comment|/* Make IOA/IOB port ready (IOA:input, IOB:output) */
name|outb
argument_list|(
name|opna_iobase
argument_list|,
literal|0x07
argument_list|)
expr_stmt|;
name|outb
argument_list|(
literal|0x5f
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Because OPNA ports are comparatively slow(?), */
name|outb
argument_list|(
literal|0x5f
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* we'd better wait a moment. */
name|outb
argument_list|(
literal|0x5f
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
literal|0x5f
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|inb
argument_list|(
name|opna_iobase
operator|+
literal|2
argument_list|)
operator|&
literal|0x3f
expr_stmt|;
name|outb
argument_list|(
name|opna_iobase
operator|+
literal|2
argument_list|,
name|tmp
operator||
literal|0x80
argument_list|)
expr_stmt|;
comment|/* Wait for OPNA to be ready. */
name|i
operator|=
literal|100000
expr_stmt|;
comment|/* Some large value */
while|while
condition|(
operator|(
name|inb
argument_list|(
name|opna_iobase
argument_list|)
operator|&
literal|0x80
operator|)
operator|&&
operator|(
name|i
operator|--
operator|>
literal|0
operator|)
condition|)
empty_stmt|;
comment|/* Get irq number from IOA port. */
name|outb
argument_list|(
name|opna_iobase
argument_list|,
literal|0x0e
argument_list|)
expr_stmt|;
name|outb
argument_list|(
literal|0x5f
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
literal|0x5f
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
literal|0x5f
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
literal|0x5f
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|inb
argument_list|(
name|opna_iobase
operator|+
literal|2
argument_list|)
operator|&
literal|0xc0
expr_stmt|;
switch|switch
condition|(
name|tmp
operator|>>
literal|6
condition|)
block|{
case|case
literal|0
case|:
comment|/* INT0 (IRQ3)*/
name|irq
operator|=
literal|3
expr_stmt|;
break|break;
case|case
literal|1
case|:
comment|/* INT6 (IRQ13)*/
name|irq
operator|=
literal|13
expr_stmt|;
break|break;
case|case
literal|2
case|:
comment|/* INT4 (IRQ10)*/
name|irq
operator|=
literal|10
expr_stmt|;
break|break;
case|case
literal|3
case|:
comment|/* INT5 (IRQ12)*/
name|irq
operator|=
literal|12
expr_stmt|;
break|break;
default|default:
comment|/* error */
return|return
name|NO
return|;
block|}
comment|/* Wait for OPNA to be ready. */
name|i
operator|=
literal|100000
expr_stmt|;
comment|/* Some large value */
while|while
condition|(
operator|(
name|inb
argument_list|(
name|opna_iobase
argument_list|)
operator|&
literal|0x80
operator|)
operator|&&
operator|(
name|i
operator|--
operator|>
literal|0
operator|)
condition|)
empty_stmt|;
comment|/* Reset OPNA timer register. */
name|outb
argument_list|(
name|opna_iobase
argument_list|,
literal|0x27
argument_list|)
expr_stmt|;
name|outb
argument_list|(
literal|0x5f
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
literal|0x5f
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
literal|0x5f
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
literal|0x5f
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|opna_iobase
operator|+
literal|2
argument_list|,
literal|0x30
argument_list|)
expr_stmt|;
comment|/* Ok.  Detection finished. */
name|sprintf
argument_list|(
name|pcm86_operations
operator|.
name|name
argument_list|,
name|board_name
index|[
name|pcm_s
operator|.
name|board_type
index|]
argument_list|)
expr_stmt|;
name|pcm_initialized
operator|=
name|NO
expr_stmt|;
name|pcm_s
operator|.
name|irq
operator|=
name|irq
expr_stmt|;
if|if
condition|(
operator|(
name|hw_config
operator|->
name|irq
operator|>
literal|0
operator|)
operator|&&
operator|(
name|hw_config
operator|->
name|irq
operator|!=
name|irq
operator|)
condition|)
name|printf
argument_list|(
literal|"pcm0: change irq %d -> %d\n"
argument_list|,
name|hw_config
operator|->
name|irq
argument_list|,
name|irq
argument_list|)
expr_stmt|;
name|hw_config
operator|->
name|irq
operator|=
name|irq
expr_stmt|;
return|return
name|YES
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|pcm86_open
parameter_list|(
name|int
name|dev
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
if|if
condition|(
operator|!
name|pcm_initialized
condition|)
return|return
name|RET_ERROR
argument_list|(
name|ENXIO
argument_list|)
return|;
if|if
condition|(
name|pcm_s
operator|.
name|intr_busy
operator|||
name|pcm_s
operator|.
name|opened
condition|)
return|return
name|RET_ERROR
argument_list|(
name|EBUSY
argument_list|)
return|;
if|if
condition|(
operator|(
name|err
operator|=
name|snd_set_irq_handler
argument_list|(
name|pcm_s
operator|.
name|irq
argument_list|,
name|pcmintr
argument_list|,
literal|"PC-9801-73/86"
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|err
return|;
name|pcm_stop
argument_list|()
expr_stmt|;
name|tmpbuf
operator|.
name|size
operator|=
literal|0
expr_stmt|;
name|pcm_s
operator|.
name|intr_mode
operator|=
name|IMODE_NONE
expr_stmt|;
name|pcm_s
operator|.
name|opened
operator|=
name|YES
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|pcm86_close
parameter_list|(
name|int
name|dev
parameter_list|)
block|{
name|snd_release_irq
argument_list|(
name|pcm_s
operator|.
name|irq
argument_list|)
expr_stmt|;
name|pcm_s
operator|.
name|opened
operator|=
name|NO
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|pcm86_output_block
parameter_list|(
name|int
name|dev
parameter_list|,
name|unsigned
name|long
name|buf
parameter_list|,
name|int
name|count
parameter_list|,
name|int
name|intrflag
parameter_list|,
name|int
name|dma_restart
parameter_list|)
block|{
name|unsigned
name|long
name|flags
decl_stmt|,
name|cnt
decl_stmt|;
name|int
name|maxchunksize
decl_stmt|;
ifdef|#
directive|ifdef
name|PCM86_DEBUG
name|printk
argument_list|(
literal|"pcm86_output_block():"
argument_list|)
expr_stmt|;
if|if
condition|(
name|audio_devs
index|[
name|dev
index|]
operator|->
name|dmap
operator|->
name|flags
operator|&
name|DMA_BUSY
condition|)
name|printk
argument_list|(
literal|" DMA_BUSY"
argument_list|)
expr_stmt|;
if|if
condition|(
name|audio_devs
index|[
name|dev
index|]
operator|->
name|dmap
operator|->
name|flags
operator|&
name|DMA_RESTART
condition|)
name|printk
argument_list|(
literal|" DMA_RESTART"
argument_list|)
expr_stmt|;
if|if
condition|(
name|audio_devs
index|[
name|dev
index|]
operator|->
name|dmap
operator|->
name|flags
operator|&
name|DMA_ACTIVE
condition|)
name|printk
argument_list|(
literal|" DMA_ACTIVE"
argument_list|)
expr_stmt|;
if|if
condition|(
name|audio_devs
index|[
name|dev
index|]
operator|->
name|dmap
operator|->
name|flags
operator|&
name|DMA_STARTED
condition|)
name|printk
argument_list|(
literal|" DMA_STARTED"
argument_list|)
expr_stmt|;
if|if
condition|(
name|audio_devs
index|[
name|dev
index|]
operator|->
name|dmap
operator|->
name|flags
operator|&
name|DMA_ALLOC_DONE
condition|)
name|printk
argument_list|(
literal|" DMA_ALLOC_DONE"
argument_list|)
expr_stmt|;
name|printk
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|#
directive|if
literal|0
block|DISABLE_INTR(flags);
endif|#
directive|endif
ifdef|#
directive|ifdef
name|PCM86_DEBUG
name|printk
argument_list|(
literal|"pcm86_output_block(): count = %d, intrsize= %d\n"
argument_list|,
name|count
argument_list|,
name|pcm_s
operator|.
name|intr_size
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pcm_s
operator|.
name|pdma_buf
operator|=
operator|(
name|pcm_data
operator|*
operator|)
name|buf
expr_stmt|;
name|pcm_s
operator|.
name|pdma_count
operator|=
name|count
expr_stmt|;
name|pcm_s
operator|.
name|pdma_chunkcount
operator|=
literal|1
expr_stmt|;
name|maxchunksize
operator|=
operator|(
operator|(
operator|(
name|PCM86_FIFOSIZE
operator|-
name|pcm_s
operator|.
name|intr_size
operator|*
literal|2
operator|)
operator|/
operator|(
name|pcm_s
operator|.
name|bytes
operator|*
literal|2
operator|)
operator|)
operator|*
name|pcm_s
operator|.
name|speed
operator|/
name|pcm_s
operator|.
name|chipspeed
operator|)
operator|*
operator|(
name|pcm_s
operator|.
name|bytes
operator|<<
name|pcm_s
operator|.
name|stereo
operator|)
expr_stmt|;
if|if
condition|(
name|count
operator|>
name|maxchunksize
condition|)
name|pcm_s
operator|.
name|pdma_chunkcount
operator|=
literal|2
operator|*
name|count
operator|/
name|maxchunksize
expr_stmt|;
comment|/*      * Let chunksize = (float)count / (float)pcm_s.pdma_chunkcount.      * Data of size chunksize is sent to the FIFO buffer on the 86-board      * on every occuring of interrupt.      * By assuming that pcm_s.intr_size< PCM86_FIFOSIZE / 2, we can conclude      * that the FIFO buffer never overflows from the following lemma.      *      * Lemma:      *	     maxchunksize / 2<= chunksize<= maxchunksize.      *   (Though pcm_s.pdma_chunkcount is obtained through the flooring      *    function, this inequality holds.)      * Proof) Omitted.      */
name|fifo_output_block
argument_list|()
expr_stmt|;
name|pcm_s
operator|.
name|intr_last
operator|=
name|NO
expr_stmt|;
name|pcm_s
operator|.
name|intr_mode
operator|=
name|IMODE_OUTPUT
expr_stmt|;
if|if
condition|(
operator|!
name|pcm_s
operator|.
name|intr_busy
condition|)
name|fifo_start
argument_list|(
name|IMODE_OUTPUT
argument_list|)
expr_stmt|;
name|pcm_s
operator|.
name|intr_busy
operator|=
name|YES
expr_stmt|;
if|#
directive|if
literal|0
block|RESTORE_INTR(flags);
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|void
name|pcm86_start_input
parameter_list|(
name|int
name|dev
parameter_list|,
name|unsigned
name|long
name|buf
parameter_list|,
name|int
name|count
parameter_list|,
name|int
name|intrflag
parameter_list|,
name|int
name|dma_restart
parameter_list|)
block|{
name|unsigned
name|long
name|flags
decl_stmt|,
name|cnt
decl_stmt|;
name|int
name|maxchunksize
decl_stmt|;
ifdef|#
directive|ifdef
name|PCM86_DEBUG
name|printk
argument_list|(
literal|"pcm86_start_input():"
argument_list|)
expr_stmt|;
if|if
condition|(
name|audio_devs
index|[
name|dev
index|]
operator|->
name|dmap
operator|->
name|flags
operator|&
name|DMA_BUSY
condition|)
name|printk
argument_list|(
literal|" DMA_BUSY"
argument_list|)
expr_stmt|;
if|if
condition|(
name|audio_devs
index|[
name|dev
index|]
operator|->
name|dmap
operator|->
name|flags
operator|&
name|DMA_RESTART
condition|)
name|printk
argument_list|(
literal|" DMA_RESTART"
argument_list|)
expr_stmt|;
if|if
condition|(
name|audio_devs
index|[
name|dev
index|]
operator|->
name|dmap
operator|->
name|flags
operator|&
name|DMA_ACTIVE
condition|)
name|printk
argument_list|(
literal|" DMA_ACTIVE"
argument_list|)
expr_stmt|;
if|if
condition|(
name|audio_devs
index|[
name|dev
index|]
operator|->
name|dmap
operator|->
name|flags
operator|&
name|DMA_STARTED
condition|)
name|printk
argument_list|(
literal|" DMA_STARTED"
argument_list|)
expr_stmt|;
if|if
condition|(
name|audio_devs
index|[
name|dev
index|]
operator|->
name|dmap
operator|->
name|flags
operator|&
name|DMA_ALLOC_DONE
condition|)
name|printk
argument_list|(
literal|" DMA_ALLOC_DONE"
argument_list|)
expr_stmt|;
name|printk
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|#
directive|if
literal|0
block|DISABLE_INTR(flags);
endif|#
directive|endif
name|pcm_s
operator|.
name|intr_size
operator|=
name|PCM86_INTRSIZE_IN
expr_stmt|;
ifdef|#
directive|ifdef
name|PCM86_DEBUG
name|printk
argument_list|(
literal|"pcm86_start_input(): count = %d, intrsize= %d\n"
argument_list|,
name|count
argument_list|,
name|pcm_s
operator|.
name|intr_size
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pcm_s
operator|.
name|pdma_buf
operator|=
operator|(
name|pcm_data
operator|*
operator|)
name|buf
expr_stmt|;
name|pcm_s
operator|.
name|pdma_count
operator|=
name|count
expr_stmt|;
name|pcm_s
operator|.
name|pdma_chunkcount
operator|=
literal|1
expr_stmt|;
name|maxchunksize
operator|=
operator|(
operator|(
name|pcm_s
operator|.
name|intr_size
operator|/
operator|(
name|pcm_s
operator|.
name|bytes
operator|*
literal|2
operator|)
operator|)
operator|*
name|pcm_s
operator|.
name|speed
operator|/
name|pcm_s
operator|.
name|chipspeed
operator|)
operator|*
operator|(
name|pcm_s
operator|.
name|bytes
operator|<<
name|pcm_s
operator|.
name|stereo
operator|)
expr_stmt|;
if|if
condition|(
name|count
operator|>
name|maxchunksize
condition|)
name|pcm_s
operator|.
name|pdma_chunkcount
operator|=
literal|2
operator|*
name|count
operator|/
name|maxchunksize
expr_stmt|;
name|pcm_s
operator|.
name|intr_mode
operator|=
name|IMODE_INPUT
expr_stmt|;
if|if
condition|(
operator|!
name|pcm_s
operator|.
name|intr_busy
condition|)
name|fifo_start
argument_list|(
name|IMODE_INPUT
argument_list|)
expr_stmt|;
name|pcm_s
operator|.
name|intr_busy
operator|=
name|YES
expr_stmt|;
if|#
directive|if
literal|0
block|RESTORE_INTR(flags);
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|int
name|pcm86_ioctl
parameter_list|(
name|int
name|dev
parameter_list|,
name|unsigned
name|int
name|cmd
parameter_list|,
name|unsigned
name|int
name|arg
parameter_list|,
name|int
name|local
parameter_list|)
block|{
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|SOUND_PCM_WRITE_RATE
case|:
if|if
condition|(
name|local
condition|)
return|return
name|set_speed
argument_list|(
name|arg
argument_list|)
return|;
return|return
name|IOCTL_OUT
argument_list|(
name|arg
argument_list|,
name|set_speed
argument_list|(
name|IOCTL_IN
argument_list|(
name|arg
argument_list|)
argument_list|)
argument_list|)
return|;
case|case
name|SOUND_PCM_READ_RATE
case|:
if|if
condition|(
name|local
condition|)
return|return
name|pcm_s
operator|.
name|speed
return|;
return|return
name|IOCTL_OUT
argument_list|(
name|arg
argument_list|,
name|pcm_s
operator|.
name|speed
argument_list|)
return|;
case|case
name|SNDCTL_DSP_STEREO
case|:
if|if
condition|(
name|local
condition|)
return|return
name|set_stereo
argument_list|(
name|arg
argument_list|)
return|;
return|return
name|IOCTL_OUT
argument_list|(
name|arg
argument_list|,
name|set_stereo
argument_list|(
name|IOCTL_IN
argument_list|(
name|arg
argument_list|)
argument_list|)
argument_list|)
return|;
case|case
name|SOUND_PCM_WRITE_CHANNELS
case|:
if|if
condition|(
name|local
condition|)
return|return
name|set_stereo
argument_list|(
name|arg
operator|-
literal|1
argument_list|)
operator|+
literal|1
return|;
return|return
name|IOCTL_OUT
argument_list|(
name|arg
argument_list|,
name|set_stereo
argument_list|(
name|IOCTL_IN
argument_list|(
name|arg
argument_list|)
operator|-
literal|1
argument_list|)
operator|+
literal|1
argument_list|)
return|;
case|case
name|SOUND_PCM_READ_CHANNELS
case|:
if|if
condition|(
name|local
condition|)
return|return
name|pcm_s
operator|.
name|stereo
operator|+
literal|1
return|;
return|return
name|IOCTL_OUT
argument_list|(
name|arg
argument_list|,
name|pcm_s
operator|.
name|stereo
operator|+
literal|1
argument_list|)
return|;
case|case
name|SNDCTL_DSP_SETFMT
case|:
if|if
condition|(
name|local
condition|)
return|return
name|set_format
argument_list|(
name|arg
argument_list|)
return|;
return|return
name|IOCTL_OUT
argument_list|(
name|arg
argument_list|,
name|set_format
argument_list|(
name|IOCTL_IN
argument_list|(
name|arg
argument_list|)
argument_list|)
argument_list|)
return|;
case|case
name|SOUND_PCM_READ_BITS
case|:
if|if
condition|(
name|local
condition|)
return|return
name|pcm_s
operator|.
name|bytes
operator|*
literal|8
return|;
return|return
name|IOCTL_OUT
argument_list|(
name|arg
argument_list|,
name|pcm_s
operator|.
name|bytes
operator|*
literal|8
argument_list|)
return|;
block|}
comment|/* Invalid ioctl request */
return|return
name|RET_ERROR
argument_list|(
name|EINVAL
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|pcm86_prepare_for_input
parameter_list|(
name|int
name|dev
parameter_list|,
name|int
name|bufsize
parameter_list|,
name|int
name|nbufs
parameter_list|)
block|{
name|pcm_s
operator|.
name|intr_size
operator|=
name|PCM86_INTRSIZE_IN
expr_stmt|;
name|pcm_s
operator|.
name|intr_mode
operator|=
name|IMODE_NONE
expr_stmt|;
name|pcm_s
operator|.
name|acc
operator|=
literal|0
expr_stmt|;
name|pcm_s
operator|.
name|last_l
operator|=
literal|0
expr_stmt|;
name|pcm_s
operator|.
name|last_r
operator|=
literal|0
expr_stmt|;
name|DEB
argument_list|(
name|printk
argument_list|(
literal|"pcm86_prepare_for_input\n"
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|pcm86_prepare_for_output
parameter_list|(
name|int
name|dev
parameter_list|,
name|int
name|bufsize
parameter_list|,
name|int
name|nbufs
parameter_list|)
block|{
name|pcm_s
operator|.
name|intr_size
operator|=
name|PCM86_INTRSIZE_OUT
expr_stmt|;
name|pcm_s
operator|.
name|intr_mode
operator|=
name|IMODE_NONE
expr_stmt|;
name|pcm_s
operator|.
name|acc
operator|=
literal|0
expr_stmt|;
name|pcm_s
operator|.
name|last_l
operator|=
literal|0
expr_stmt|;
name|pcm_s
operator|.
name|last_r
operator|=
literal|0
expr_stmt|;
name|DEB
argument_list|(
name|printk
argument_list|(
literal|"pcm86_prepare_for_output\n"
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|pcm86_reset
parameter_list|(
name|int
name|dev
parameter_list|)
block|{
name|pcm_stop
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|pcm86_halt_xfer
parameter_list|(
name|int
name|dev
parameter_list|)
block|{
name|pcm_stop
argument_list|()
expr_stmt|;
name|DEB
argument_list|(
name|printk
argument_list|(
literal|"pcm86_halt_xfer\n"
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|pcmintr
parameter_list|(
name|int
name|unit
parameter_list|)
block|{
name|unsigned
name|char
name|tmp
decl_stmt|;
if|if
condition|(
operator|(
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|8
argument_list|)
operator|&
literal|0x10
operator|)
operator|==
literal|0
condition|)
return|return;
comment|/* not FIFO intr. */
switch|switch
condition|(
name|pcm_s
operator|.
name|intr_mode
condition|)
block|{
case|case
name|IMODE_OUTPUT
case|:
if|if
condition|(
name|pcm_s
operator|.
name|intr_trailer
condition|)
block|{
name|DEB
argument_list|(
name|printk
argument_list|(
literal|"pcmintr(): fifo_reset\n"
argument_list|)
argument_list|)
expr_stmt|;
name|fifo_reset
argument_list|()
expr_stmt|;
name|pcm_s
operator|.
name|intr_trailer
operator|=
name|NO
expr_stmt|;
name|pcm_s
operator|.
name|intr_busy
operator|=
name|NO
expr_stmt|;
block|}
if|if
condition|(
name|pcm_s
operator|.
name|pdma_count
operator|>
literal|0
condition|)
name|fifo_output_block
argument_list|()
expr_stmt|;
else|else
name|DMAbuf_outputintr
argument_list|(
name|my_dev
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* Reset intr. flag. */
name|tmp
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|8
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|8
argument_list|,
name|tmp
operator|&
operator|~
literal|0x10
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|8
argument_list|,
name|tmp
operator||
literal|0x10
argument_list|)
expr_stmt|;
break|break;
case|case
name|IMODE_INPUT
case|:
name|fifo_input_block
argument_list|()
expr_stmt|;
if|if
condition|(
name|pcm_s
operator|.
name|pdma_count
operator|==
literal|0
condition|)
name|DMAbuf_inputintr
argument_list|(
name|my_dev
argument_list|)
expr_stmt|;
comment|/* Reset intr. flag. */
name|tmp
operator|=
name|inb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|8
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|8
argument_list|,
name|tmp
operator|&
operator|~
literal|0x10
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|pcm_s
operator|.
name|iobase
operator|+
literal|8
argument_list|,
name|tmp
operator||
literal|0x10
argument_list|)
expr_stmt|;
break|break;
default|default:
name|pcm_stop
argument_list|()
expr_stmt|;
name|printk
argument_list|(
literal|"pcm0: unexpected interrupt\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* EXCLUDE_PCM86, EXCLUDE_AUDIO */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIGURE_SOUNDCARD */
end_comment

end_unit


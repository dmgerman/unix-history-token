begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 1992-1994 SÃ¸ren Schmidt  * Copyright (c) 1990 The Regents of the University of California.  * All rights reserved.  *  * This code is derived from software contributed to Berkeley by  * William Jolitz and Don Ahn.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer  *    in this position and unchanged.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. All advertising materials mentioning features or use of this software  *    must display the following acknowledgement:  *	This product includes software developed by the University of  *	California, Berkeley and its contributors.  * 4. Neither the name of the University nor the names of its contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  *	$Id: syscons.c,v 1.73 1994/10/26 21:51:22 bde Exp $  */
end_comment

begin_include
include|#
directive|include
file|"sc.h"
end_include

begin_if
if|#
directive|if
name|NSC
operator|>
literal|0
end_if

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/user.h>
end_include

begin_include
include|#
directive|include
file|<sys/tty.h>
end_include

begin_include
include|#
directive|include
file|<sys/uio.h>
end_include

begin_include
include|#
directive|include
file|<sys/callout.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/syslog.h>
end_include

begin_include
include|#
directive|include
file|<sys/errno.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/devconf.h>
end_include

begin_include
include|#
directive|include
file|<machine/clock.h>
end_include

begin_include
include|#
directive|include
file|<machine/console.h>
end_include

begin_include
include|#
directive|include
file|<machine/psl.h>
end_include

begin_include
include|#
directive|include
file|<machine/frame.h>
end_include

begin_include
include|#
directive|include
file|<machine/pc/display.h>
end_include

begin_include
include|#
directive|include
file|<i386/isa/isa.h>
end_include

begin_include
include|#
directive|include
file|<i386/isa/isa_device.h>
end_include

begin_include
include|#
directive|include
file|<i386/isa/timerreg.h>
end_include

begin_include
include|#
directive|include
file|<i386/isa/kbdtables.h>
end_include

begin_include
include|#
directive|include
file|<i386/i386/cons.h>
end_include

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|NCONS
argument_list|)
end_if

begin_define
define|#
directive|define
name|NCONS
value|12
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|defined
argument_list|(
name|HARDFONTS
argument_list|)
end_if

begin_include
include|#
directive|include
file|<i386/isa/iso8859.font>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* vm things */
end_comment

begin_define
define|#
directive|define
name|ISMAPPED
parameter_list|(
name|pa
parameter_list|,
name|width
parameter_list|)
define|\
value|(((pa)<= (u_long)0x1000 - (width)) \ 	 || ((pa)>= 0xa0000&& (pa)<= 0x100000 - (width)))
end_define

begin_define
define|#
directive|define
name|pa_to_va
parameter_list|(
name|pa
parameter_list|)
value|(KERNBASE + (pa))
end_define

begin_comment
comment|/* works if ISMAPPED(pa...) */
end_comment

begin_comment
comment|/* status flags */
end_comment

begin_define
define|#
directive|define
name|LOCK_KEY_MASK
value|0x0000F
end_define

begin_define
define|#
directive|define
name|LED_MASK
value|0x00007
end_define

begin_define
define|#
directive|define
name|UNKNOWN_MODE
value|0x00010
end_define

begin_define
define|#
directive|define
name|KBD_RAW_MODE
value|0x00020
end_define

begin_define
define|#
directive|define
name|SWITCH_WAIT_REL
value|0x00040
end_define

begin_define
define|#
directive|define
name|SWITCH_WAIT_ACQ
value|0x00080
end_define

begin_comment
comment|/* video hardware memory addresses */
end_comment

begin_define
define|#
directive|define
name|VIDEOMEM
value|0x000A0000
end_define

begin_comment
comment|/* misc defines */
end_comment

begin_define
define|#
directive|define
name|MAX_ESC_PAR
value|5
end_define

begin_define
define|#
directive|define
name|LOAD
value|1
end_define

begin_define
define|#
directive|define
name|SAVE
value|0
end_define

begin_define
define|#
directive|define
name|COL
value|80
end_define

begin_define
define|#
directive|define
name|ROW
value|25
end_define

begin_define
define|#
directive|define
name|BELL_DURATION
value|5
end_define

begin_define
define|#
directive|define
name|BELL_PITCH
value|800
end_define

begin_define
define|#
directive|define
name|TIMER_FREQ
value|1193182
end_define

begin_comment
comment|/* should be in isa.h */
end_comment

begin_define
define|#
directive|define
name|CONSOLE_BUFSIZE
value|1024
end_define

begin_define
define|#
directive|define
name|PCBURST
value|128
end_define

begin_define
define|#
directive|define
name|FONT_8_LOADED
value|0x001
end_define

begin_define
define|#
directive|define
name|FONT_14_LOADED
value|0x002
end_define

begin_define
define|#
directive|define
name|FONT_16_LOADED
value|0x004
end_define

begin_comment
comment|/* defines related to hardware addresses */
end_comment

begin_define
define|#
directive|define
name|MONO_BASE
value|0x3B4
end_define

begin_comment
comment|/* crt controller base mono */
end_comment

begin_define
define|#
directive|define
name|COLOR_BASE
value|0x3D4
end_define

begin_comment
comment|/* crt controller base color */
end_comment

begin_define
define|#
directive|define
name|MISC
value|0x3C2
end_define

begin_comment
comment|/* misc output register */
end_comment

begin_define
define|#
directive|define
name|ATC
value|IO_VGA+0x00
end_define

begin_comment
comment|/* attribute controller */
end_comment

begin_define
define|#
directive|define
name|TSIDX
value|IO_VGA+0x04
end_define

begin_comment
comment|/* timing sequencer idx */
end_comment

begin_define
define|#
directive|define
name|TSREG
value|IO_VGA+0x05
end_define

begin_comment
comment|/* timing sequencer data */
end_comment

begin_define
define|#
directive|define
name|PIXMASK
value|IO_VGA+0x06
end_define

begin_comment
comment|/* pixel write mask */
end_comment

begin_define
define|#
directive|define
name|PALRADR
value|IO_VGA+0x07
end_define

begin_comment
comment|/* palette read address */
end_comment

begin_define
define|#
directive|define
name|PALWADR
value|IO_VGA+0x08
end_define

begin_comment
comment|/* palette write address */
end_comment

begin_define
define|#
directive|define
name|PALDATA
value|IO_VGA+0x09
end_define

begin_comment
comment|/* palette data register */
end_comment

begin_define
define|#
directive|define
name|GDCIDX
value|IO_VGA+0x0E
end_define

begin_comment
comment|/* graph data controller idx */
end_comment

begin_define
define|#
directive|define
name|GDCREG
value|IO_VGA+0x0F
end_define

begin_comment
comment|/* graph data controller data */
end_comment

begin_comment
comment|/* special characters */
end_comment

begin_define
define|#
directive|define
name|cntlc
value|0x03
end_define

begin_define
define|#
directive|define
name|cntld
value|0x04
end_define

begin_define
define|#
directive|define
name|bs
value|0x08
end_define

begin_define
define|#
directive|define
name|lf
value|0x0a
end_define

begin_define
define|#
directive|define
name|cr
value|0x0d
end_define

begin_define
define|#
directive|define
name|del
value|0x7f
end_define

begin_typedef
typedef|typedef
struct|struct
name|term_stat
block|{
name|int
name|esc
decl_stmt|;
comment|/* processing escape sequence */
name|int
name|num_param
decl_stmt|;
comment|/* # of parameters to ESC */
name|int
name|last_param
decl_stmt|;
comment|/* last parameter # */
name|int
name|param
index|[
name|MAX_ESC_PAR
index|]
decl_stmt|;
comment|/* contains ESC parameters */
name|int
name|cur_attr
decl_stmt|;
comment|/* current attributes */
name|int
name|std_attr
decl_stmt|;
comment|/* normal attributes */
name|int
name|rev_attr
decl_stmt|;
comment|/* reverse attributes */
block|}
name|term_stat
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|scr_stat
block|{
name|u_short
modifier|*
name|crt_base
decl_stmt|;
comment|/* address of screen memory */
name|u_short
modifier|*
name|scr_buf
decl_stmt|;
comment|/* buffer when off screen */
name|u_short
modifier|*
name|crtat
decl_stmt|;
comment|/* cursor address */
name|int
name|xpos
decl_stmt|;
comment|/* current X position */
name|int
name|ypos
decl_stmt|;
comment|/* current Y position */
name|int
name|xsize
decl_stmt|;
comment|/* X size */
name|int
name|ysize
decl_stmt|;
comment|/* Y size */
name|term_stat
name|term
decl_stmt|;
comment|/* terminal emulation stuff */
name|char
name|cursor_start
decl_stmt|;
comment|/* cursor start line # */
name|char
name|cursor_end
decl_stmt|;
comment|/* cursor end line # */
name|u_char
name|border
decl_stmt|;
comment|/* border color */
name|u_short
name|bell_duration
decl_stmt|;
name|u_short
name|bell_pitch
decl_stmt|;
name|u_short
name|status
decl_stmt|;
comment|/* status (bitfield) */
name|u_short
name|mode
decl_stmt|;
comment|/* mode */
name|pid_t
name|pid
decl_stmt|;
comment|/* pid of controlling proc */
name|struct
name|proc
modifier|*
name|proc
decl_stmt|;
comment|/* proc* of controlling proc */
name|struct
name|vt_mode
name|smode
decl_stmt|;
comment|/* switch mode */
block|}
name|scr_stat
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|default_attr
block|{
name|int
name|std_attr
decl_stmt|;
comment|/* normal attributes */
name|int
name|rev_attr
decl_stmt|;
comment|/* reverse attributes */
block|}
name|default_attr
typedef|;
end_typedef

begin_decl_stmt
specifier|static
name|default_attr
name|user_default
init|=
block|{
operator|(
name|FG_LIGHTGREY
operator||
name|BG_BLACK
operator|)
operator|<<
literal|8
block|,
operator|(
name|FG_BLACK
operator||
name|BG_LIGHTGREY
operator|)
operator|<<
literal|8
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|default_attr
name|kernel_default
init|=
block|{
operator|(
name|FG_WHITE
operator||
name|BG_BLACK
operator|)
operator|<<
literal|8
block|,
operator|(
name|FG_BLACK
operator||
name|BG_LIGHTGREY
operator|)
operator|<<
literal|8
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|scr_stat
name|console
index|[
name|NCONS
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|scr_stat
modifier|*
name|cur_console
init|=
operator|&
name|console
index|[
literal|0
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|scr_stat
modifier|*
name|new_scp
decl_stmt|,
modifier|*
name|old_scp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|term_stat
name|kernel_console
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|default_attr
modifier|*
name|current_default
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|console_buffer_count
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|console_buffer
index|[
name|CONSOLE_BUFSIZE
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|switch_in_progress
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|u_short
modifier|*
name|crtat
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|u_int
name|crtc_addr
init|=
name|MONO_BASE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|crtc_vga
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|u_char
name|shfts
init|=
literal|0
decl_stmt|,
name|ctls
init|=
literal|0
decl_stmt|,
name|alts
init|=
literal|0
decl_stmt|,
name|agrs
init|=
literal|0
decl_stmt|,
name|metas
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|u_char
name|nlkcnt
init|=
literal|0
decl_stmt|,
name|clkcnt
init|=
literal|0
decl_stmt|,
name|slkcnt
init|=
literal|0
decl_stmt|,
name|alkcnt
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|font_8
init|=
name|NULL
decl_stmt|,
modifier|*
name|font_14
init|=
name|NULL
decl_stmt|,
modifier|*
name|font_16
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|fonts_loaded
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|palette
index|[
literal|3
operator|*
literal|256
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|u_int
name|n_fkey_tab
init|=
sizeof|sizeof
argument_list|(
name|fkey_tab
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
operator|*
name|fkey_tab
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|cur_cursor_pos
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|in_putc
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|polling
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_if
if|#
directive|if
name|ASYNCH
end_if

begin_decl_stmt
specifier|static
name|u_char
name|kbd_reply
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|static
name|int
name|delayed_next_scr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|saved_console
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* saved console number	*/
end_comment

begin_decl_stmt
specifier|static
name|long
name|scrn_blank_time
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* screen saver timeout value */
end_comment

begin_decl_stmt
specifier|static
name|int
name|scrn_blanked
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* screen saver active flag */
end_comment

begin_decl_stmt
specifier|static
name|int
name|scrn_saver
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* screen saver routine */
end_comment

begin_decl_stmt
specifier|static
name|long
name|scrn_time_stamp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|u_char
name|scr_map
index|[
literal|256
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|video_mode_ptr
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* function prototypes */
end_comment

begin_function_decl
name|int
name|pcprobe
parameter_list|(
name|struct
name|isa_device
modifier|*
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|pcattach
parameter_list|(
name|struct
name|isa_device
modifier|*
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|pcopen
parameter_list|(
name|dev_t
name|dev
parameter_list|,
name|int
name|flag
parameter_list|,
name|int
name|mode
parameter_list|,
name|struct
name|proc
modifier|*
name|p
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|pcclose
parameter_list|(
name|dev_t
name|dev
parameter_list|,
name|int
name|flag
parameter_list|,
name|int
name|mode
parameter_list|,
name|struct
name|proc
modifier|*
name|p
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|pcread
parameter_list|(
name|dev_t
name|dev
parameter_list|,
name|struct
name|uio
modifier|*
name|uio
parameter_list|,
name|int
name|flag
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|pcwrite
parameter_list|(
name|dev_t
name|dev
parameter_list|,
name|struct
name|uio
modifier|*
name|uio
parameter_list|,
name|int
name|flag
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|pcparam
parameter_list|(
name|struct
name|tty
modifier|*
name|tp
parameter_list|,
name|struct
name|termios
modifier|*
name|t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|pcioctl
parameter_list|(
name|dev_t
name|dev
parameter_list|,
name|int
name|cmd
parameter_list|,
name|caddr_t
name|data
parameter_list|,
name|int
name|flag
parameter_list|,
name|struct
name|proc
modifier|*
name|p
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|pcxint
parameter_list|(
name|dev_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|pcstart
parameter_list|(
name|struct
name|tty
modifier|*
name|tp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|pccnprobe
parameter_list|(
name|struct
name|consdev
modifier|*
name|cp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|pccninit
parameter_list|(
name|struct
name|consdev
modifier|*
name|cp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|pccnputc
parameter_list|(
name|dev_t
name|dev
parameter_list|,
name|char
name|c
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|pccngetc
parameter_list|(
name|dev_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|pccncheckc
parameter_list|(
name|dev_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|scintr
parameter_list|(
name|int
name|unit
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|pcmmap
parameter_list|(
name|dev_t
name|dev
parameter_list|,
name|int
name|offset
parameter_list|,
name|int
name|nprot
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|getchar
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|scinit
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|scput
parameter_list|(
name|u_char
name|c
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u_int
name|scgetc
parameter_list|(
name|int
name|noblock
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|tty
modifier|*
name|get_tty_ptr
parameter_list|(
name|dev_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|scr_stat
modifier|*
name|get_scr_stat
parameter_list|(
name|dev_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|get_scr_num
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|cursor_shape
parameter_list|(
name|int
name|start
parameter_list|,
name|int
name|end
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|get_cursor_shape
parameter_list|(
name|int
modifier|*
name|start
parameter_list|,
name|int
modifier|*
name|end
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|cursor_pos
parameter_list|(
name|int
name|force
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|clear_screen
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|switch_scr
parameter_list|(
name|u_int
name|next_scr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|exchange_scr
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|move_crsr
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|int
name|x
parameter_list|,
name|int
name|y
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|move_up
parameter_list|(
name|u_short
modifier|*
name|s
parameter_list|,
name|u_short
modifier|*
name|d
parameter_list|,
name|u_int
name|len
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|move_down
parameter_list|(
name|u_short
modifier|*
name|s
parameter_list|,
name|u_short
modifier|*
name|d
parameter_list|,
name|u_int
name|len
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|scan_esc
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|u_char
name|c
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ansi_put
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|u_char
name|c
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u_char
modifier|*
name|get_fstr
parameter_list|(
name|u_int
name|c
parameter_list|,
name|u_int
modifier|*
name|len
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|update_leds
parameter_list|(
name|int
name|which
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|kbd_wait
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|kbd_cmd
parameter_list|(
name|u_char
name|command
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|set_mode
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|set_border
parameter_list|(
name|int
name|color
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|set_vgaregs
parameter_list|(
name|char
modifier|*
name|modetable
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|copy_font
parameter_list|(
name|int
name|direction
parameter_list|,
name|int
name|segment
parameter_list|,
name|int
name|size
parameter_list|,
name|char
modifier|*
name|font
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|save_palette
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|load_palette
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* available screen savers */
end_comment

begin_function_decl
specifier|static
name|void
name|none_saver
parameter_list|(
name|int
name|test
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|blank_saver
parameter_list|(
name|int
name|test
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|fade_saver
parameter_list|(
name|int
name|test
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|star_saver
parameter_list|(
name|int
name|test
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|snake_saver
parameter_list|(
name|int
name|test
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|green_saver
parameter_list|(
name|int
name|test
parameter_list|)
function_decl|;
end_function_decl

begin_struct
specifier|static
specifier|const
struct|struct
block|{
name|char
modifier|*
name|name
decl_stmt|;
name|void
function_decl|(
modifier|*
name|routine
function_decl|)
parameter_list|()
function_decl|;
block|}
name|screen_savers
index|[]
init|=
block|{
block|{
literal|"none"
block|,
name|none_saver
block|}
block|,
comment|/* 0 */
block|{
literal|"blank"
block|,
name|blank_saver
block|}
block|,
comment|/* 1 */
block|{
literal|"fade"
block|,
name|fade_saver
block|}
block|,
comment|/* 2 */
block|{
literal|"star"
block|,
name|star_saver
block|}
block|,
comment|/* 3 */
block|{
literal|"snake"
block|,
name|snake_saver
block|}
block|,
comment|/* 4 */
block|{
literal|"green"
block|,
name|green_saver
block|}
block|,
comment|/* 5 */
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|SCRN_SAVER
parameter_list|(
name|arg
parameter_list|)
value|(*screen_savers[scrn_saver].routine)(arg)
end_define

begin_define
define|#
directive|define
name|NUM_SCRN_SAVERS
value|(sizeof(screen_savers) / sizeof(screen_savers[0]))
end_define

begin_comment
comment|/* OS specific stuff */
end_comment

begin_if
if|#
directive|if
literal|0
end_if

begin_define
define|#
directive|define
name|VIRTUAL_TTY
parameter_list|(
name|x
parameter_list|)
value|(pccons[x] = ttymalloc(pccons[x]))
end_define

begin_define
define|#
directive|define
name|CONSOLE_TTY
value|(pccons[NCONS] = ttymalloc(pccons[NCONS]))
end_define

begin_else
unit|struct	tty 		*pccons[NCONS+1];
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|VIRTUAL_TTY
parameter_list|(
name|x
parameter_list|)
value|&pccons[x]
end_define

begin_define
define|#
directive|define
name|CONSOLE_TTY
value|&pccons[NCONS]
end_define

begin_decl_stmt
name|struct
name|tty
name|pccons
index|[
name|NCONS
operator|+
literal|1
index|]
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|timeout_t
value|timeout_func_t
end_define

begin_define
define|#
directive|define
name|MONO_BUF
value|pa_to_va(0xB0000)
end_define

begin_define
define|#
directive|define
name|CGA_BUF
value|pa_to_va(0xB8000)
end_define

begin_decl_stmt
name|u_short
modifier|*
name|Crtat
init|=
operator|(
name|u_short
operator|*
operator|)
name|MONO_BUF
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|consinit
parameter_list|(
name|void
parameter_list|)
block|{
name|scinit
argument_list|()
expr_stmt|;
block|}
end_function

begin_decl_stmt
name|struct
name|isa_driver
name|scdriver
init|=
block|{
name|pcprobe
block|,
name|pcattach
block|,
literal|"sc"
block|,
literal|1
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|pcprobe
parameter_list|(
name|struct
name|isa_device
modifier|*
name|dev
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|retries
init|=
literal|5
decl_stmt|;
name|unsigned
name|char
name|val
decl_stmt|;
comment|/* Enable interrupts and keyboard controller */
name|kbd_wait
argument_list|()
expr_stmt|;
name|outb
argument_list|(
name|KB_STAT
argument_list|,
name|KB_WRITE
argument_list|)
expr_stmt|;
name|kbd_wait
argument_list|()
expr_stmt|;
name|outb
argument_list|(
name|KB_DATA
argument_list|,
name|KB_MODE
argument_list|)
expr_stmt|;
comment|/* flush any noise in the buffer */
while|while
condition|(
name|inb
argument_list|(
name|KB_STAT
argument_list|)
operator|&
name|KB_BUF_FULL
condition|)
block|{
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|inb
argument_list|(
name|KB_DATA
argument_list|)
expr_stmt|;
block|}
comment|/* Reset keyboard hardware */
while|while
condition|(
name|retries
operator|--
condition|)
block|{
name|kbd_wait
argument_list|()
expr_stmt|;
name|outb
argument_list|(
name|KB_DATA
argument_list|,
name|KB_RESET
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|100000
condition|;
name|i
operator|++
control|)
block|{
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|val
operator|=
name|inb
argument_list|(
name|KB_DATA
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|==
name|KB_ACK
operator|||
name|val
operator|==
name|KB_ECHO
condition|)
goto|goto
name|gotres
goto|;
if|if
condition|(
name|val
operator|==
name|KB_RESEND
condition|)
break|break;
block|}
block|}
name|gotres
label|:
if|if
condition|(
operator|!
name|retries
condition|)
name|printf
argument_list|(
literal|"scprobe: keyboard won't accept RESET command\n"
argument_list|)
expr_stmt|;
else|else
block|{
name|gotack
label|:
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|inb
argument_list|(
name|KB_STAT
argument_list|)
operator|&
name|KB_BUF_FULL
operator|)
operator|==
literal|0
condition|)
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|val
operator|=
name|inb
argument_list|(
name|KB_DATA
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|==
name|KB_ACK
condition|)
goto|goto
name|gotack
goto|;
if|if
condition|(
name|val
operator|!=
name|KB_RESET_DONE
condition|)
name|printf
argument_list|(
literal|"scprobe: keyboard RESET failed %02x\n"
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|IO_KBDSIZE
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|struct
name|kern_devconf
name|kdc_sc
index|[
name|NSC
index|]
init|=
block|{
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
comment|/* filled in by dev_attach */
literal|"sc"
block|,
literal|0
block|,
block|{
name|MDDT_ISA
block|,
literal|0
block|,
literal|"tty"
block|}
block|,
name|isa_generic_externalize
block|,
literal|0
block|,
literal|0
block|,
name|ISA_EXTERNALLEN
block|,
operator|&
name|kdc_isa0
block|,
comment|/* parent */
literal|0
block|,
comment|/* parentdata */
name|DC_UNKNOWN
block|,
comment|/* not supported */
literal|"Graphics console"
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
specifier|inline
name|void
name|sc_registerdev
parameter_list|(
name|struct
name|isa_device
modifier|*
name|id
parameter_list|)
block|{
if|if
condition|(
name|id
operator|->
name|id_unit
condition|)
name|kdc_sc
index|[
name|id
operator|->
name|id_unit
index|]
operator|=
name|kdc_sc
index|[
literal|0
index|]
expr_stmt|;
name|kdc_sc
index|[
name|id
operator|->
name|id_unit
index|]
operator|.
name|kdc_unit
operator|=
name|id
operator|->
name|id_unit
expr_stmt|;
name|kdc_sc
index|[
name|id
operator|->
name|id_unit
index|]
operator|.
name|kdc_isa
operator|=
name|id
expr_stmt|;
name|dev_attach
argument_list|(
operator|&
name|kdc_sc
index|[
name|id
operator|->
name|id_unit
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|pcattach
parameter_list|(
name|struct
name|isa_device
modifier|*
name|dev
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|struct
name|scr_stat
modifier|*
name|scp
decl_stmt|;
name|printf
argument_list|(
literal|"sc%d: "
argument_list|,
name|dev
operator|->
name|id_unit
argument_list|)
expr_stmt|;
if|if
condition|(
name|crtc_vga
condition|)
if|if
condition|(
name|crtc_addr
operator|==
name|MONO_BASE
condition|)
name|printf
argument_list|(
literal|"VGA mono"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"VGA color"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|crtc_addr
operator|==
name|MONO_BASE
condition|)
name|printf
argument_list|(
literal|"MDA/hercules"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"CGA/EGA"
argument_list|)
expr_stmt|;
if|if
condition|(
name|NCONS
operator|>
literal|1
condition|)
name|printf
argument_list|(
literal|"<%d virtual consoles>\n"
argument_list|,
name|NCONS
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|crtc_vga
condition|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|HARDFONTS
argument_list|)
name|font_8
operator|=
name|font_8x8
expr_stmt|;
name|font_14
operator|=
name|font_8x14
expr_stmt|;
name|font_16
operator|=
name|font_8x16
expr_stmt|;
name|fonts_loaded
operator|=
name|FONT_8_LOADED
operator||
name|FONT_14_LOADED
operator||
name|FONT_16_LOADED
expr_stmt|;
name|copy_font
argument_list|(
name|LOAD
argument_list|,
literal|1
argument_list|,
literal|8
argument_list|,
name|font_8
argument_list|)
expr_stmt|;
name|copy_font
argument_list|(
name|LOAD
argument_list|,
literal|2
argument_list|,
literal|14
argument_list|,
name|font_14
argument_list|)
expr_stmt|;
name|copy_font
argument_list|(
name|LOAD
argument_list|,
literal|0
argument_list|,
literal|16
argument_list|,
name|font_16
argument_list|)
expr_stmt|;
else|#
directive|else
name|font_8
operator|=
operator|(
name|char
operator|*
operator|)
name|malloc
argument_list|(
literal|8
operator|*
literal|256
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
name|font_14
operator|=
operator|(
name|char
operator|*
operator|)
name|malloc
argument_list|(
literal|14
operator|*
literal|256
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
name|font_16
operator|=
operator|(
name|char
operator|*
operator|)
name|malloc
argument_list|(
literal|16
operator|*
literal|256
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
name|copy_font
argument_list|(
name|SAVE
argument_list|,
literal|0
argument_list|,
literal|16
argument_list|,
name|font_16
argument_list|)
expr_stmt|;
name|fonts_loaded
operator|=
name|FONT_16_LOADED
expr_stmt|;
endif|#
directive|endif
name|save_palette
argument_list|()
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NCONS
condition|;
name|i
operator|++
control|)
block|{
name|scp
operator|=
operator|&
name|console
index|[
name|i
index|]
expr_stmt|;
name|scp
operator|->
name|scr_buf
operator|=
operator|(
name|u_short
operator|*
operator|)
name|malloc
argument_list|(
name|COL
operator|*
name|ROW
operator|*
literal|2
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|>
literal|0
condition|)
block|{
name|scp
operator|->
name|crt_base
operator|=
name|scp
operator|->
name|crtat
operator|=
name|scp
operator|->
name|scr_buf
expr_stmt|;
name|clear_screen
argument_list|(
name|scp
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* get cursor going */
name|cursor_pos
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|update_leds
argument_list|(
name|console
index|[
literal|0
index|]
operator|.
name|status
argument_list|)
expr_stmt|;
name|sc_registerdev
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|tty
modifier|*
name|get_tty_ptr
parameter_list|(
name|dev_t
name|dev
parameter_list|)
block|{
name|int
name|unit
init|=
name|minor
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|unit
operator|>
name|NCONS
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
if|if
condition|(
name|unit
operator|==
name|NCONS
condition|)
return|return
operator|(
name|CONSOLE_TTY
operator|)
return|;
return|return
operator|(
name|VIRTUAL_TTY
argument_list|(
name|unit
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|scr_stat
modifier|*
name|get_scr_stat
parameter_list|(
name|dev_t
name|dev
parameter_list|)
block|{
name|int
name|unit
init|=
name|minor
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|unit
operator|>
name|NCONS
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
if|if
condition|(
name|unit
operator|==
name|NCONS
condition|)
return|return
operator|(
operator|&
name|console
index|[
literal|0
index|]
operator|)
return|;
return|return
operator|(
operator|&
name|console
index|[
name|unit
index|]
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|get_scr_num
parameter_list|()
block|{
name|int
name|i
init|=
literal|0
decl_stmt|;
while|while
condition|(
operator|(
name|i
operator|<
name|NCONS
operator|)
operator|&&
operator|(
name|cur_console
operator|!=
operator|&
name|console
index|[
name|i
index|]
operator|)
condition|)
name|i
operator|++
expr_stmt|;
return|return
name|i
operator|<
name|NCONS
condition|?
name|i
else|:
literal|0
return|;
block|}
end_function

begin_function
name|int
name|pcopen
parameter_list|(
name|dev_t
name|dev
parameter_list|,
name|int
name|flag
parameter_list|,
name|int
name|mode
parameter_list|,
name|struct
name|proc
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|tty
modifier|*
name|tp
init|=
name|get_tty_ptr
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|tp
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|tp
operator|->
name|t_oproc
operator|=
name|pcstart
expr_stmt|;
name|tp
operator|->
name|t_param
operator|=
name|pcparam
expr_stmt|;
name|tp
operator|->
name|t_dev
operator|=
name|dev
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|tp
operator|->
name|t_state
operator|&
name|TS_ISOPEN
operator|)
condition|)
block|{
name|ttychars
argument_list|(
name|tp
argument_list|)
expr_stmt|;
name|tp
operator|->
name|t_iflag
operator|=
name|TTYDEF_IFLAG
expr_stmt|;
name|tp
operator|->
name|t_oflag
operator|=
name|TTYDEF_OFLAG
expr_stmt|;
name|tp
operator|->
name|t_cflag
operator|=
name|TTYDEF_CFLAG
expr_stmt|;
name|tp
operator|->
name|t_lflag
operator|=
name|TTYDEF_LFLAG
expr_stmt|;
name|tp
operator|->
name|t_ispeed
operator|=
name|tp
operator|->
name|t_ospeed
operator|=
name|TTYDEF_SPEED
expr_stmt|;
name|pcparam
argument_list|(
name|tp
argument_list|,
operator|&
name|tp
operator|->
name|t_termios
argument_list|)
expr_stmt|;
name|ttsetwater
argument_list|(
name|tp
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|tp
operator|->
name|t_state
operator|&
name|TS_XCLUDE
operator|&&
name|p
operator|->
name|p_ucred
operator|->
name|cr_uid
operator|!=
literal|0
condition|)
return|return
operator|(
name|EBUSY
operator|)
return|;
name|tp
operator|->
name|t_state
operator||=
name|TS_CARR_ON
expr_stmt|;
name|tp
operator|->
name|t_cflag
operator||=
name|CLOCAL
expr_stmt|;
return|return
operator|(
operator|(
operator|*
name|linesw
index|[
name|tp
operator|->
name|t_line
index|]
operator|.
name|l_open
operator|)
operator|(
name|dev
operator|,
name|tp
operator|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|pcclose
parameter_list|(
name|dev_t
name|dev
parameter_list|,
name|int
name|flag
parameter_list|,
name|int
name|mode
parameter_list|,
name|struct
name|proc
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|tty
modifier|*
name|tp
init|=
name|get_tty_ptr
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|scr_stat
modifier|*
name|scp
decl_stmt|;
if|if
condition|(
operator|!
name|tp
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
name|minor
argument_list|(
name|dev
argument_list|)
operator|<
name|NCONS
condition|)
block|{
name|scp
operator|=
name|get_scr_stat
argument_list|(
name|tp
operator|->
name|t_dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|scp
operator|->
name|status
operator|&
name|SWITCH_WAIT_ACQ
condition|)
name|wakeup
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
name|scp
operator|->
name|smode
argument_list|)
expr_stmt|;
name|scp
operator|->
name|pid
operator|=
literal|0
expr_stmt|;
name|scp
operator|->
name|proc
operator|=
name|NULL
expr_stmt|;
name|scp
operator|->
name|smode
operator|.
name|mode
operator|=
name|VT_AUTO
expr_stmt|;
block|}
operator|(
operator|*
name|linesw
index|[
name|tp
operator|->
name|t_line
index|]
operator|.
name|l_close
operator|)
operator|(
name|tp
operator|,
name|flag
operator|)
expr_stmt|;
name|ttyclose
argument_list|(
name|tp
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|pcread
parameter_list|(
name|dev_t
name|dev
parameter_list|,
name|struct
name|uio
modifier|*
name|uio
parameter_list|,
name|int
name|flag
parameter_list|)
block|{
name|struct
name|tty
modifier|*
name|tp
init|=
name|get_tty_ptr
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|tp
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
return|return
operator|(
operator|(
operator|*
name|linesw
index|[
name|tp
operator|->
name|t_line
index|]
operator|.
name|l_read
operator|)
operator|(
name|tp
operator|,
name|uio
operator|,
name|flag
operator|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|pcwrite
parameter_list|(
name|dev_t
name|dev
parameter_list|,
name|struct
name|uio
modifier|*
name|uio
parameter_list|,
name|int
name|flag
parameter_list|)
block|{
name|struct
name|tty
modifier|*
name|tp
init|=
name|get_tty_ptr
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|tp
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
return|return
operator|(
operator|(
operator|*
name|linesw
index|[
name|tp
operator|->
name|t_line
index|]
operator|.
name|l_write
operator|)
operator|(
name|tp
operator|,
name|uio
operator|,
name|flag
operator|)
operator|)
return|;
block|}
end_function

begin_function
name|void
name|scintr
parameter_list|(
name|int
name|unit
parameter_list|)
block|{
specifier|static
name|struct
name|tty
modifier|*
name|cur_tty
decl_stmt|;
name|int
name|c
decl_stmt|,
name|len
decl_stmt|;
name|u_char
modifier|*
name|cp
decl_stmt|;
comment|/* make screensaver happy */
name|scrn_time_stamp
operator|=
name|time
operator|.
name|tv_sec
expr_stmt|;
if|if
condition|(
name|scrn_blanked
condition|)
name|SCRN_SAVER
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|c
operator|=
name|scgetc
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|cur_tty
operator|=
name|VIRTUAL_TTY
argument_list|(
name|get_scr_num
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|cur_tty
operator|->
name|t_state
operator|&
name|TS_ISOPEN
operator|)
condition|)
name|cur_tty
operator|=
name|CONSOLE_TTY
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|cur_tty
operator|->
name|t_state
operator|&
name|TS_ISOPEN
operator|)
operator|||
name|polling
condition|)
return|return;
switch|switch
condition|(
name|c
operator|&
literal|0xff00
condition|)
block|{
case|case
literal|0x0000
case|:
comment|/* normal key */
operator|(
operator|*
name|linesw
index|[
name|cur_tty
operator|->
name|t_line
index|]
operator|.
name|l_rint
operator|)
operator|(
name|c
operator|&
literal|0xFF
operator|,
name|cur_tty
operator|)
expr_stmt|;
break|break;
case|case
name|NOKEY
case|:
comment|/* nothing there */
break|break;
case|case
name|FKEY
case|:
comment|/* function key, return string */
if|if
condition|(
name|cp
operator|=
name|get_fstr
argument_list|(
operator|(
name|u_int
operator|)
name|c
argument_list|,
operator|(
name|u_int
operator|*
operator|)
operator|&
name|len
argument_list|)
condition|)
block|{
while|while
condition|(
name|len
operator|--
operator|>
literal|0
condition|)
operator|(
operator|*
name|linesw
index|[
name|cur_tty
operator|->
name|t_line
index|]
operator|.
name|l_rint
operator|)
operator|(
operator|*
name|cp
operator|++
operator|&
literal|0xFF
operator|,
name|cur_tty
operator|)
expr_stmt|;
block|}
break|break;
case|case
name|MKEY
case|:
comment|/* meta is active, prepend ESC */
operator|(
operator|*
name|linesw
index|[
name|cur_tty
operator|->
name|t_line
index|]
operator|.
name|l_rint
operator|)
operator|(
literal|0x1b
operator|,
name|cur_tty
operator|)
expr_stmt|;
operator|(
operator|*
name|linesw
index|[
name|cur_tty
operator|->
name|t_line
index|]
operator|.
name|l_rint
operator|)
operator|(
name|c
operator|&
literal|0xFF
operator|,
name|cur_tty
operator|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
name|int
name|pcparam
parameter_list|(
name|struct
name|tty
modifier|*
name|tp
parameter_list|,
name|struct
name|termios
modifier|*
name|t
parameter_list|)
block|{
name|int
name|cflag
init|=
name|t
operator|->
name|c_cflag
decl_stmt|;
comment|/* and copy to tty */
name|tp
operator|->
name|t_ispeed
operator|=
name|t
operator|->
name|c_ispeed
expr_stmt|;
name|tp
operator|->
name|t_ospeed
operator|=
name|t
operator|->
name|c_ospeed
expr_stmt|;
name|tp
operator|->
name|t_cflag
operator|=
name|cflag
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|pcioctl
parameter_list|(
name|dev_t
name|dev
parameter_list|,
name|int
name|cmd
parameter_list|,
name|caddr_t
name|data
parameter_list|,
name|int
name|flag
parameter_list|,
name|struct
name|proc
modifier|*
name|p
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|error
decl_stmt|;
name|struct
name|tty
modifier|*
name|tp
decl_stmt|;
name|struct
name|trapframe
modifier|*
name|fp
decl_stmt|;
name|scr_stat
modifier|*
name|scp
decl_stmt|;
name|tp
operator|=
name|get_tty_ptr
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tp
condition|)
return|return
name|ENXIO
return|;
name|scp
operator|=
name|get_scr_stat
argument_list|(
name|tp
operator|->
name|t_dev
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
comment|/* process console hardware related ioctl's */
case|case
name|GIO_ATTR
case|:
comment|/* get current attributes */
operator|*
operator|(
name|int
operator|*
operator|)
name|data
operator|=
name|scp
operator|->
name|term
operator|.
name|cur_attr
expr_stmt|;
return|return
literal|0
return|;
case|case
name|GIO_COLOR
case|:
comment|/* is this a color console ? */
if|if
condition|(
name|crtc_addr
operator|==
name|COLOR_BASE
condition|)
operator|*
operator|(
name|int
operator|*
operator|)
name|data
operator|=
literal|1
expr_stmt|;
else|else
operator|*
operator|(
name|int
operator|*
operator|)
name|data
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
case|case
name|CONS_CURRENT
case|:
comment|/* get current adapter type */
if|if
condition|(
name|crtc_vga
condition|)
operator|*
operator|(
name|int
operator|*
operator|)
name|data
operator|=
name|KD_VGA
expr_stmt|;
elseif|else
if|if
condition|(
name|crtc_addr
operator|==
name|MONO_BASE
condition|)
operator|*
operator|(
name|int
operator|*
operator|)
name|data
operator|=
name|KD_MONO
expr_stmt|;
else|else
operator|*
operator|(
name|int
operator|*
operator|)
name|data
operator|=
name|KD_CGA
expr_stmt|;
return|return
literal|0
return|;
case|case
name|CONS_GET
case|:
comment|/* get current video mode */
operator|*
operator|(
name|int
operator|*
operator|)
name|data
operator|=
name|scp
operator|->
name|mode
expr_stmt|;
return|return
literal|0
return|;
case|case
name|CONS_BLANKTIME
case|:
comment|/* set screen saver timeout (0 = no saver) */
name|scrn_blank_time
operator|=
operator|*
operator|(
name|int
operator|*
operator|)
name|data
expr_stmt|;
return|return
literal|0
return|;
define|#
directive|define
name|SAVER
parameter_list|(
name|p
parameter_list|)
value|((ssaver_t *)(p))
case|case
name|CONS_SSAVER
case|:
comment|/* set screen saver */
if|if
condition|(
name|SAVER
argument_list|(
name|data
argument_list|)
operator|->
name|num
operator|<
literal|0
operator|||
name|SAVER
argument_list|(
name|data
argument_list|)
operator|->
name|num
operator|>=
name|NUM_SCRN_SAVERS
condition|)
return|return
name|EIO
return|;
name|SCRN_SAVER
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|scrn_saver
operator|=
name|SAVER
argument_list|(
name|data
argument_list|)
operator|->
name|num
expr_stmt|;
name|scrn_blank_time
operator|=
name|SAVER
argument_list|(
name|data
argument_list|)
operator|->
name|time
expr_stmt|;
return|return
literal|0
return|;
case|case
name|CONS_GSAVER
case|:
comment|/* get screen saver info */
if|if
condition|(
name|SAVER
argument_list|(
name|data
argument_list|)
operator|->
name|num
operator|<
literal|0
condition|)
name|SAVER
argument_list|(
name|data
argument_list|)
operator|->
name|num
operator|=
name|scrn_saver
expr_stmt|;
elseif|else
if|if
condition|(
name|SAVER
argument_list|(
name|data
argument_list|)
operator|->
name|num
operator|>=
name|NUM_SCRN_SAVERS
condition|)
return|return
name|EIO
return|;
name|SAVER
argument_list|(
name|data
argument_list|)
operator|->
name|time
operator|=
name|scrn_blank_time
expr_stmt|;
name|strcpy
argument_list|(
name|SAVER
argument_list|(
name|data
argument_list|)
operator|->
name|name
argument_list|,
name|screen_savers
index|[
name|SAVER
argument_list|(
name|data
argument_list|)
operator|->
name|num
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|CONS_GETINFO
case|:
comment|/* get current (virtual) console info */
block|{
name|vid_info_t
modifier|*
name|ptr
init|=
operator|(
name|vid_info_t
operator|*
operator|)
name|data
decl_stmt|;
if|if
condition|(
name|ptr
operator|->
name|size
operator|==
sizeof|sizeof
argument_list|(
expr|struct
name|vid_info
argument_list|)
condition|)
block|{
name|ptr
operator|->
name|m_num
operator|=
name|get_scr_num
argument_list|()
expr_stmt|;
name|ptr
operator|->
name|mv_col
operator|=
name|scp
operator|->
name|xpos
expr_stmt|;
name|ptr
operator|->
name|mv_row
operator|=
name|scp
operator|->
name|ypos
expr_stmt|;
name|ptr
operator|->
name|mv_csz
operator|=
name|scp
operator|->
name|xsize
expr_stmt|;
name|ptr
operator|->
name|mv_rsz
operator|=
name|scp
operator|->
name|ysize
expr_stmt|;
name|ptr
operator|->
name|mv_norm
operator|.
name|fore
operator|=
operator|(
name|scp
operator|->
name|term
operator|.
name|std_attr
operator|&
literal|0x0f00
operator|)
operator|>>
literal|8
expr_stmt|;
name|ptr
operator|->
name|mv_norm
operator|.
name|back
operator|=
operator|(
name|scp
operator|->
name|term
operator|.
name|std_attr
operator|&
literal|0xf000
operator|)
operator|>>
literal|12
expr_stmt|;
name|ptr
operator|->
name|mv_rev
operator|.
name|fore
operator|=
operator|(
name|scp
operator|->
name|term
operator|.
name|rev_attr
operator|&
literal|0x0f00
operator|)
operator|>>
literal|8
expr_stmt|;
name|ptr
operator|->
name|mv_rev
operator|.
name|back
operator|=
operator|(
name|scp
operator|->
name|term
operator|.
name|rev_attr
operator|&
literal|0xf000
operator|)
operator|>>
literal|12
expr_stmt|;
name|ptr
operator|->
name|mv_grfc
operator|.
name|fore
operator|=
literal|0
expr_stmt|;
comment|/* not supported */
name|ptr
operator|->
name|mv_grfc
operator|.
name|back
operator|=
literal|0
expr_stmt|;
comment|/* not supported */
name|ptr
operator|->
name|mv_ovscan
operator|=
name|scp
operator|->
name|border
expr_stmt|;
name|ptr
operator|->
name|mk_keylock
operator|=
name|scp
operator|->
name|status
operator|&
name|LOCK_KEY_MASK
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
name|EINVAL
return|;
block|}
case|case
name|CONS_GETVERS
case|:
comment|/* get version number */
operator|*
operator|(
name|int
operator|*
operator|)
name|data
operator|=
literal|0x103
expr_stmt|;
comment|/* version 1.3 */
return|return
literal|0
return|;
case|case
name|SW_VGA_C40x25
case|:
case|case
name|SW_VGA_C80x25
case|:
comment|/* VGA TEXT MODES */
case|case
name|SW_VGA_M80x25
case|:
case|case
name|SW_VGA_C80x50
case|:
case|case
name|SW_VGA_M80x50
case|:
case|case
name|SW_B40x25
case|:
case|case
name|SW_C40x25
case|:
case|case
name|SW_B80x25
case|:
case|case
name|SW_C80x25
case|:
case|case
name|SW_ENH_B40x25
case|:
case|case
name|SW_ENH_C40x25
case|:
case|case
name|SW_ENH_B80x25
case|:
case|case
name|SW_ENH_C80x25
case|:
case|case
name|SW_ENH_B80x43
case|:
case|case
name|SW_ENH_C80x43
case|:
if|if
condition|(
operator|!
name|crtc_vga
operator|||
name|video_mode_ptr
operator|==
name|NULL
condition|)
return|return
name|ENXIO
return|;
name|cmd
operator|&=
literal|0xFF
expr_stmt|;
name|i
operator|=
name|cmd
operator|<
name|M_VGA_C80x50
condition|?
operator|*
operator|(
name|video_mode_ptr
operator|+
operator|(
name|cmd
operator|*
literal|64
operator|)
operator|+
literal|2
operator|)
else|:
literal|0x08
expr_stmt|;
switch|switch
condition|(
name|i
condition|)
block|{
default|default:
case|case
literal|0x08
case|:
if|if
condition|(
operator|!
operator|(
name|fonts_loaded
operator|&
name|FONT_8_LOADED
operator|)
condition|)
return|return
name|EINVAL
return|;
break|break;
case|case
literal|0x0E
case|:
if|if
condition|(
operator|!
operator|(
name|fonts_loaded
operator|&
name|FONT_14_LOADED
operator|)
condition|)
return|return
name|EINVAL
return|;
break|break;
case|case
literal|0x10
case|:
if|if
condition|(
operator|!
operator|(
name|fonts_loaded
operator|&
name|FONT_16_LOADED
operator|)
condition|)
return|return
name|EINVAL
return|;
break|break;
block|}
name|scp
operator|->
name|mode
operator|=
name|cmd
expr_stmt|;
name|scp
operator|->
name|status
operator|&=
operator|~
name|UNKNOWN_MODE
expr_stmt|;
comment|/* text mode */
if|if
condition|(
name|scp
operator|->
name|mode
operator|<
name|M_VGA_C80x50
condition|)
block|{
name|scp
operator|->
name|xsize
operator|=
operator|*
operator|(
name|video_mode_ptr
operator|+
operator|(
name|scp
operator|->
name|mode
operator|*
literal|64
operator|)
operator|)
expr_stmt|;
name|scp
operator|->
name|ysize
operator|=
operator|*
operator|(
name|video_mode_ptr
operator|+
operator|(
name|scp
operator|->
name|mode
operator|*
literal|64
operator|)
operator|+
literal|1
operator|)
operator|+
literal|1
expr_stmt|;
block|}
else|else
switch|switch
condition|(
name|scp
operator|->
name|mode
condition|)
block|{
case|case
name|M_VGA_C80x50
case|:
case|case
name|M_VGA_M80x50
case|:
name|scp
operator|->
name|xsize
operator|=
literal|80
expr_stmt|;
name|scp
operator|->
name|ysize
operator|=
literal|50
expr_stmt|;
break|break;
case|case
name|M_ENH_B80x43
case|:
case|case
name|M_ENH_C80x43
case|:
name|scp
operator|->
name|xsize
operator|=
literal|80
expr_stmt|;
name|scp
operator|->
name|ysize
operator|=
literal|43
expr_stmt|;
break|break;
block|}
name|free
argument_list|(
name|scp
operator|->
name|scr_buf
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|scp
operator|->
name|scr_buf
operator|=
operator|(
name|u_short
operator|*
operator|)
name|malloc
argument_list|(
name|scp
operator|->
name|xsize
operator|*
name|scp
operator|->
name|ysize
operator|*
literal|2
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|scp
operator|==
name|cur_console
condition|)
name|set_mode
argument_list|(
name|scp
argument_list|)
expr_stmt|;
else|else
name|scp
operator|->
name|crt_base
operator|=
name|scp
operator|->
name|scr_buf
expr_stmt|;
name|clear_screen
argument_list|(
name|scp
argument_list|)
expr_stmt|;
if|if
condition|(
name|tp
operator|->
name|t_winsize
operator|.
name|ws_col
operator|!=
name|scp
operator|->
name|xsize
operator|||
name|tp
operator|->
name|t_winsize
operator|.
name|ws_row
operator|!=
name|scp
operator|->
name|ysize
condition|)
block|{
name|tp
operator|->
name|t_winsize
operator|.
name|ws_col
operator|=
name|scp
operator|->
name|xsize
expr_stmt|;
name|tp
operator|->
name|t_winsize
operator|.
name|ws_row
operator|=
name|scp
operator|->
name|ysize
expr_stmt|;
name|pgsignal
argument_list|(
name|tp
operator|->
name|t_pgrp
argument_list|,
name|SIGWINCH
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
comment|/* GRAPHICS MODES */
case|case
name|SW_BG320
case|:
case|case
name|SW_CG320
case|:
case|case
name|SW_BG640
case|:
case|case
name|SW_CG320_D
case|:
case|case
name|SW_CG640_E
case|:
case|case
name|SW_CG640x350
case|:
case|case
name|SW_ENH_CG640
case|:
case|case
name|SW_BG640x480
case|:
case|case
name|SW_CG640x480
case|:
case|case
name|SW_VGA_CG320
case|:
name|scp
operator|->
name|mode
operator|=
name|cmd
operator|&
literal|0xFF
expr_stmt|;
name|scp
operator|->
name|status
operator||=
name|UNKNOWN_MODE
expr_stmt|;
comment|/* graphics mode */
if|if
condition|(
name|scp
operator|==
name|cur_console
condition|)
name|set_mode
argument_list|(
name|scp
argument_list|)
expr_stmt|;
comment|/* clear_graphics();*/
return|return
literal|0
return|;
case|case
name|VT_SETMODE
case|:
comment|/* set screen switcher mode */
name|bcopy
argument_list|(
name|data
argument_list|,
operator|&
name|scp
operator|->
name|smode
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|vt_mode
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|scp
operator|->
name|smode
operator|.
name|mode
operator|==
name|VT_PROCESS
condition|)
block|{
name|scp
operator|->
name|proc
operator|=
name|p
expr_stmt|;
name|scp
operator|->
name|pid
operator|=
name|scp
operator|->
name|proc
operator|->
name|p_pid
expr_stmt|;
block|}
return|return
literal|0
return|;
case|case
name|VT_GETMODE
case|:
comment|/* get screen switcher mode */
name|bcopy
argument_list|(
operator|&
name|scp
operator|->
name|smode
argument_list|,
name|data
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|vt_mode
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|VT_RELDISP
case|:
comment|/* screen switcher ioctl */
switch|switch
condition|(
operator|*
name|data
condition|)
block|{
case|case
name|VT_FALSE
case|:
comment|/* user refuses to release screen, abort */
if|if
condition|(
name|scp
operator|==
name|old_scp
operator|&&
operator|(
name|scp
operator|->
name|status
operator|&
name|SWITCH_WAIT_REL
operator|)
condition|)
block|{
name|old_scp
operator|->
name|status
operator|&=
operator|~
name|SWITCH_WAIT_REL
expr_stmt|;
name|switch_in_progress
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
name|EINVAL
return|;
case|case
name|VT_TRUE
case|:
comment|/* user has released screen, go on */
if|if
condition|(
name|scp
operator|==
name|old_scp
operator|&&
operator|(
name|scp
operator|->
name|status
operator|&
name|SWITCH_WAIT_REL
operator|)
condition|)
block|{
name|scp
operator|->
name|status
operator|&=
operator|~
name|SWITCH_WAIT_REL
expr_stmt|;
name|exchange_scr
argument_list|()
expr_stmt|;
if|if
condition|(
name|new_scp
operator|->
name|smode
operator|.
name|mode
operator|==
name|VT_PROCESS
condition|)
block|{
name|new_scp
operator|->
name|status
operator||=
name|SWITCH_WAIT_ACQ
expr_stmt|;
name|psignal
argument_list|(
name|new_scp
operator|->
name|proc
argument_list|,
name|new_scp
operator|->
name|smode
operator|.
name|acqsig
argument_list|)
expr_stmt|;
block|}
else|else
name|switch_in_progress
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
name|EINVAL
return|;
case|case
name|VT_ACKACQ
case|:
comment|/* acquire acknowledged, switch completed */
if|if
condition|(
name|scp
operator|==
name|new_scp
operator|&&
operator|(
name|scp
operator|->
name|status
operator|&
name|SWITCH_WAIT_ACQ
operator|)
condition|)
block|{
name|scp
operator|->
name|status
operator|&=
operator|~
name|SWITCH_WAIT_ACQ
expr_stmt|;
name|switch_in_progress
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
name|EINVAL
return|;
default|default:
return|return
name|EINVAL
return|;
block|}
comment|/* NOT REACHED */
case|case
name|VT_OPENQRY
case|:
comment|/* return free virtual console */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NCONS
condition|;
name|i
operator|++
control|)
block|{
name|tp
operator|=
name|VIRTUAL_TTY
argument_list|(
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|tp
operator|->
name|t_state
operator|&
name|TS_ISOPEN
operator|)
condition|)
block|{
operator|*
name|data
operator|=
name|i
operator|+
literal|1
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
return|return
name|EINVAL
return|;
case|case
name|VT_ACTIVATE
case|:
comment|/* switch to screen *data */
return|return
name|switch_scr
argument_list|(
operator|(
operator|*
name|data
operator|)
operator|-
literal|1
argument_list|)
return|;
case|case
name|VT_WAITACTIVE
case|:
comment|/* wait for switch to occur */
if|if
condition|(
operator|*
name|data
operator|>
name|NCONS
condition|)
return|return
name|EINVAL
return|;
if|if
condition|(
name|minor
argument_list|(
name|dev
argument_list|)
operator|==
operator|(
operator|*
name|data
operator|)
operator|-
literal|1
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|*
name|data
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|scp
operator|==
name|cur_console
condition|)
return|return
literal|0
return|;
while|while
condition|(
operator|(
name|error
operator|=
name|tsleep
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
name|scp
operator|->
name|smode
argument_list|,
name|PZERO
operator||
name|PCATCH
argument_list|,
literal|"waitvt"
argument_list|,
literal|0
argument_list|)
operator|)
operator|==
name|ERESTART
condition|)
empty_stmt|;
block|}
else|else
while|while
condition|(
operator|(
name|error
operator|=
name|tsleep
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
name|console
index|[
operator|*
operator|(
name|data
operator|-
literal|1
operator|)
index|]
operator|.
name|smode
argument_list|,
name|PZERO
operator||
name|PCATCH
argument_list|,
literal|"waitvt"
argument_list|,
literal|0
argument_list|)
operator|)
operator|==
name|ERESTART
condition|)
empty_stmt|;
return|return
name|error
return|;
case|case
name|VT_GETACTIVE
case|:
operator|*
name|data
operator|=
name|get_scr_num
argument_list|()
operator|+
literal|1
expr_stmt|;
return|return
literal|0
return|;
case|case
name|KDENABIO
case|:
comment|/* allow io operations */
name|fp
operator|=
operator|(
expr|struct
name|trapframe
operator|*
operator|)
name|p
operator|->
name|p_md
operator|.
name|md_regs
expr_stmt|;
name|fp
operator|->
name|tf_eflags
operator||=
name|PSL_IOPL
expr_stmt|;
return|return
literal|0
return|;
case|case
name|KDDISABIO
case|:
comment|/* disallow io operations (default) */
name|fp
operator|=
operator|(
expr|struct
name|trapframe
operator|*
operator|)
name|p
operator|->
name|p_md
operator|.
name|md_regs
expr_stmt|;
name|fp
operator|->
name|tf_eflags
operator|&=
operator|~
name|PSL_IOPL
expr_stmt|;
return|return
literal|0
return|;
case|case
name|KDSETMODE
case|:
comment|/* set current mode of this (virtual) console */
switch|switch
condition|(
operator|*
name|data
condition|)
block|{
case|case
name|KD_TEXT
case|:
comment|/* switch to TEXT (known) mode */
comment|/* restore fonts& palette ! */
if|if
condition|(
name|crtc_vga
condition|)
block|{
if|if
condition|(
name|fonts_loaded
operator|&
name|FONT_16_LOADED
condition|)
name|copy_font
argument_list|(
name|LOAD
argument_list|,
literal|0
argument_list|,
literal|16
argument_list|,
name|font_16
argument_list|)
expr_stmt|;
if|if
condition|(
name|fonts_loaded
operator|&
name|FONT_8_LOADED
condition|)
name|copy_font
argument_list|(
name|LOAD
argument_list|,
literal|1
argument_list|,
literal|8
argument_list|,
name|font_8
argument_list|)
expr_stmt|;
if|if
condition|(
name|fonts_loaded
operator|&
name|FONT_14_LOADED
condition|)
name|copy_font
argument_list|(
name|LOAD
argument_list|,
literal|2
argument_list|,
literal|14
argument_list|,
name|font_14
argument_list|)
expr_stmt|;
name|load_palette
argument_list|()
expr_stmt|;
block|}
comment|/* FALL THROUGH */
case|case
name|KD_TEXT1
case|:
comment|/* switch to TEXT (known) mode */
comment|/* no restore fonts& palette */
name|scp
operator|->
name|status
operator|&=
operator|~
name|UNKNOWN_MODE
expr_stmt|;
name|set_mode
argument_list|(
name|scp
argument_list|)
expr_stmt|;
name|clear_screen
argument_list|(
name|scp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|KD_GRAPHICS
case|:
comment|/* switch to GRAPHICS (unknown) mode */
name|scp
operator|->
name|status
operator||=
name|UNKNOWN_MODE
expr_stmt|;
return|return
literal|0
return|;
default|default:
return|return
name|EINVAL
return|;
block|}
comment|/* NOT REACHED */
case|case
name|KDGETMODE
case|:
comment|/* get current mode of this (virtual) console */
operator|*
name|data
operator|=
operator|(
name|scp
operator|->
name|status
operator|&
name|UNKNOWN_MODE
operator|)
condition|?
name|KD_GRAPHICS
else|:
name|KD_TEXT
expr_stmt|;
return|return
literal|0
return|;
case|case
name|KDSBORDER
case|:
comment|/* set border color of this (virtual) console */
if|if
condition|(
operator|!
name|crtc_vga
condition|)
return|return
name|ENXIO
return|;
name|scp
operator|->
name|border
operator|=
operator|*
name|data
expr_stmt|;
if|if
condition|(
name|scp
operator|==
name|cur_console
condition|)
name|set_border
argument_list|(
name|scp
operator|->
name|border
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|KDSKBSTATE
case|:
comment|/* set keyboard state (locks) */
if|if
condition|(
operator|*
name|data
operator|>=
literal|0
operator|&&
operator|*
name|data
operator|<=
name|LOCK_KEY_MASK
condition|)
block|{
name|scp
operator|->
name|status
operator|&=
operator|~
name|LOCK_KEY_MASK
expr_stmt|;
name|scp
operator|->
name|status
operator||=
operator|*
name|data
expr_stmt|;
if|if
condition|(
name|scp
operator|==
name|cur_console
condition|)
name|update_leds
argument_list|(
name|scp
operator|->
name|status
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
name|EINVAL
return|;
case|case
name|KDGKBSTATE
case|:
comment|/* get keyboard state (locks) */
operator|*
name|data
operator|=
name|scp
operator|->
name|status
operator|&
name|LOCK_KEY_MASK
expr_stmt|;
return|return
literal|0
return|;
case|case
name|KDSETRAD
case|:
comment|/* set keyboard repeat& delay rates */
if|if
condition|(
operator|*
name|data
operator|&
literal|0x80
condition|)
return|return
name|EINVAL
return|;
name|i
operator|=
name|spltty
argument_list|()
expr_stmt|;
name|kbd_cmd
argument_list|(
name|KB_SETRAD
argument_list|)
expr_stmt|;
name|kbd_cmd
argument_list|(
operator|*
name|data
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|i
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|KDSKBMODE
case|:
comment|/* set keyboard mode */
switch|switch
condition|(
operator|*
name|data
condition|)
block|{
case|case
name|K_RAW
case|:
comment|/* switch to RAW scancode mode */
name|scp
operator|->
name|status
operator||=
name|KBD_RAW_MODE
expr_stmt|;
return|return
literal|0
return|;
case|case
name|K_XLATE
case|:
comment|/* switch to XLT ascii mode */
if|if
condition|(
name|scp
operator|==
name|cur_console
operator|&&
name|scp
operator|->
name|status
operator|==
name|KBD_RAW_MODE
condition|)
name|shfts
operator|=
name|ctls
operator|=
name|alts
operator|=
name|agrs
operator|=
name|metas
operator|=
literal|0
expr_stmt|;
name|scp
operator|->
name|status
operator|&=
operator|~
name|KBD_RAW_MODE
expr_stmt|;
return|return
literal|0
return|;
default|default:
return|return
name|EINVAL
return|;
block|}
comment|/* NOT REACHED */
case|case
name|KDGKBMODE
case|:
comment|/* get keyboard mode */
operator|*
name|data
operator|=
operator|(
name|scp
operator|->
name|status
operator|&
name|KBD_RAW_MODE
operator|)
condition|?
name|K_RAW
else|:
name|K_XLATE
expr_stmt|;
return|return
literal|0
return|;
case|case
name|KDMKTONE
case|:
comment|/* sound the bell */
if|if
condition|(
name|scp
operator|==
name|cur_console
condition|)
name|sysbeep
argument_list|(
name|scp
operator|->
name|bell_pitch
argument_list|,
name|scp
operator|->
name|bell_duration
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|KIOCSOUND
case|:
comment|/* make tone (*data) hz */
if|if
condition|(
name|scp
operator|==
name|cur_console
condition|)
block|{
if|if
condition|(
operator|*
operator|(
name|int
operator|*
operator|)
name|data
condition|)
block|{
name|int
name|pitch
init|=
name|TIMER_FREQ
operator|/
operator|(
operator|*
operator|(
name|int
operator|*
operator|)
name|data
operator|)
decl_stmt|;
comment|/* set command for counter 2, 2 byte write */
if|if
condition|(
name|acquire_timer2
argument_list|(
name|TIMER_16BIT
operator||
name|TIMER_SQWAVE
argument_list|)
condition|)
block|{
return|return
name|EBUSY
return|;
block|}
comment|/* set pitch */
name|outb
argument_list|(
name|TIMER_CNTR2
argument_list|,
name|pitch
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|TIMER_CNTR2
argument_list|,
operator|(
name|pitch
operator|>>
literal|8
operator|)
argument_list|)
expr_stmt|;
comment|/* enable counter 2 output to speaker */
name|outb
argument_list|(
name|IO_PPI
argument_list|,
name|inb
argument_list|(
name|IO_PPI
argument_list|)
operator||
literal|3
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* disable counter 2 output to speaker */
name|outb
argument_list|(
name|IO_PPI
argument_list|,
name|inb
argument_list|(
name|IO_PPI
argument_list|)
operator|&
literal|0xFC
argument_list|)
expr_stmt|;
name|release_timer2
argument_list|()
expr_stmt|;
block|}
block|}
return|return
literal|0
return|;
case|case
name|KDGKBTYPE
case|:
comment|/* get keyboard type */
operator|*
name|data
operator|=
literal|0
expr_stmt|;
comment|/* type not known (yet) */
return|return
literal|0
return|;
case|case
name|KDSETLED
case|:
comment|/* set keyboard LED status */
if|if
condition|(
operator|*
name|data
operator|>=
literal|0
operator|&&
operator|*
name|data
operator|<=
name|LED_MASK
condition|)
block|{
name|scp
operator|->
name|status
operator|&=
operator|~
name|LED_MASK
expr_stmt|;
name|scp
operator|->
name|status
operator||=
operator|*
name|data
expr_stmt|;
if|if
condition|(
name|scp
operator|==
name|cur_console
condition|)
name|update_leds
argument_list|(
name|scp
operator|->
name|status
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
name|EINVAL
return|;
case|case
name|KDGETLED
case|:
comment|/* get keyboard LED status */
operator|*
name|data
operator|=
name|scp
operator|->
name|status
operator|&
name|LED_MASK
expr_stmt|;
return|return
literal|0
return|;
case|case
name|GETFKEY
case|:
comment|/* get functionkey string */
if|if
condition|(
operator|*
operator|(
name|u_short
operator|*
operator|)
name|data
operator|<
name|n_fkey_tab
condition|)
block|{
name|fkeyarg_t
modifier|*
name|ptr
init|=
operator|(
name|fkeyarg_t
operator|*
operator|)
name|data
decl_stmt|;
name|bcopy
argument_list|(
operator|&
name|fkey_tab
index|[
name|ptr
operator|->
name|keynum
index|]
operator|.
name|str
argument_list|,
name|ptr
operator|->
name|keydef
argument_list|,
name|fkey_tab
index|[
name|ptr
operator|->
name|keynum
index|]
operator|.
name|len
argument_list|)
expr_stmt|;
name|ptr
operator|->
name|flen
operator|=
name|fkey_tab
index|[
name|ptr
operator|->
name|keynum
index|]
operator|.
name|len
expr_stmt|;
return|return
literal|0
return|;
block|}
else|else
return|return
name|EINVAL
return|;
case|case
name|SETFKEY
case|:
comment|/* set functionkey string */
if|if
condition|(
operator|*
operator|(
name|u_short
operator|*
operator|)
name|data
operator|<
name|n_fkey_tab
condition|)
block|{
name|fkeyarg_t
modifier|*
name|ptr
init|=
operator|(
name|fkeyarg_t
operator|*
operator|)
name|data
decl_stmt|;
name|bcopy
argument_list|(
name|ptr
operator|->
name|keydef
argument_list|,
operator|&
name|fkey_tab
index|[
name|ptr
operator|->
name|keynum
index|]
operator|.
name|str
argument_list|,
name|min
argument_list|(
name|ptr
operator|->
name|flen
argument_list|,
name|MAXFK
argument_list|)
argument_list|)
expr_stmt|;
name|fkey_tab
index|[
name|ptr
operator|->
name|keynum
index|]
operator|.
name|len
operator|=
name|min
argument_list|(
name|ptr
operator|->
name|flen
argument_list|,
name|MAXFK
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
else|else
return|return
name|EINVAL
return|;
case|case
name|GIO_SCRNMAP
case|:
comment|/* get output translation table */
name|bcopy
argument_list|(
operator|&
name|scr_map
argument_list|,
name|data
argument_list|,
sizeof|sizeof
argument_list|(
name|scr_map
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|PIO_SCRNMAP
case|:
comment|/* set output translation table */
name|bcopy
argument_list|(
name|data
argument_list|,
operator|&
name|scr_map
argument_list|,
sizeof|sizeof
argument_list|(
name|scr_map
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|GIO_KEYMAP
case|:
comment|/* get keyboard translation table */
name|bcopy
argument_list|(
operator|&
name|key_map
argument_list|,
name|data
argument_list|,
sizeof|sizeof
argument_list|(
name|key_map
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|PIO_KEYMAP
case|:
comment|/* set keyboard translation table */
name|bcopy
argument_list|(
name|data
argument_list|,
operator|&
name|key_map
argument_list|,
sizeof|sizeof
argument_list|(
name|key_map
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|PIO_FONT8x8
case|:
comment|/* set 8x8 dot font */
if|if
condition|(
operator|!
name|crtc_vga
condition|)
return|return
name|ENXIO
return|;
name|bcopy
argument_list|(
name|data
argument_list|,
name|font_8
argument_list|,
literal|8
operator|*
literal|256
argument_list|)
expr_stmt|;
name|fonts_loaded
operator||=
name|FONT_8_LOADED
expr_stmt|;
name|copy_font
argument_list|(
name|LOAD
argument_list|,
literal|1
argument_list|,
literal|8
argument_list|,
name|font_8
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|GIO_FONT8x8
case|:
comment|/* get 8x8 dot font */
if|if
condition|(
operator|!
name|crtc_vga
condition|)
return|return
name|ENXIO
return|;
if|if
condition|(
name|fonts_loaded
operator|&
name|FONT_8_LOADED
condition|)
block|{
name|bcopy
argument_list|(
name|font_8
argument_list|,
name|data
argument_list|,
literal|8
operator|*
literal|256
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
else|else
return|return
name|ENXIO
return|;
case|case
name|PIO_FONT8x14
case|:
comment|/* set 8x14 dot font */
if|if
condition|(
operator|!
name|crtc_vga
condition|)
return|return
name|ENXIO
return|;
name|bcopy
argument_list|(
name|data
argument_list|,
name|font_14
argument_list|,
literal|14
operator|*
literal|256
argument_list|)
expr_stmt|;
name|fonts_loaded
operator||=
name|FONT_14_LOADED
expr_stmt|;
name|copy_font
argument_list|(
name|LOAD
argument_list|,
literal|2
argument_list|,
literal|14
argument_list|,
name|font_14
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|GIO_FONT8x14
case|:
comment|/* get 8x14 dot font */
if|if
condition|(
operator|!
name|crtc_vga
condition|)
return|return
name|ENXIO
return|;
if|if
condition|(
name|fonts_loaded
operator|&
name|FONT_14_LOADED
condition|)
block|{
name|bcopy
argument_list|(
name|font_14
argument_list|,
name|data
argument_list|,
literal|14
operator|*
literal|256
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
else|else
return|return
name|ENXIO
return|;
case|case
name|PIO_FONT8x16
case|:
comment|/* set 8x16 dot font */
if|if
condition|(
operator|!
name|crtc_vga
condition|)
return|return
name|ENXIO
return|;
name|bcopy
argument_list|(
name|data
argument_list|,
name|font_16
argument_list|,
literal|16
operator|*
literal|256
argument_list|)
expr_stmt|;
name|fonts_loaded
operator||=
name|FONT_16_LOADED
expr_stmt|;
name|copy_font
argument_list|(
name|LOAD
argument_list|,
literal|0
argument_list|,
literal|16
argument_list|,
name|font_16
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|GIO_FONT8x16
case|:
comment|/* get 8x16 dot font */
if|if
condition|(
operator|!
name|crtc_vga
condition|)
return|return
name|ENXIO
return|;
if|if
condition|(
name|fonts_loaded
operator|&
name|FONT_16_LOADED
condition|)
block|{
name|bcopy
argument_list|(
name|font_16
argument_list|,
name|data
argument_list|,
literal|16
operator|*
literal|256
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
else|else
return|return
name|ENXIO
return|;
case|case
name|CONSOLE_X_MODE_ON
case|:
comment|/* just to be compatible */
if|if
condition|(
name|saved_console
operator|<
literal|0
condition|)
block|{
name|saved_console
operator|=
name|get_scr_num
argument_list|()
expr_stmt|;
name|switch_scr
argument_list|(
name|minor
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
name|fp
operator|=
operator|(
expr|struct
name|trapframe
operator|*
operator|)
name|p
operator|->
name|p_md
operator|.
name|md_regs
expr_stmt|;
name|fp
operator|->
name|tf_eflags
operator||=
name|PSL_IOPL
expr_stmt|;
name|scp
operator|->
name|status
operator||=
name|UNKNOWN_MODE
expr_stmt|;
name|scp
operator|->
name|status
operator||=
name|KBD_RAW_MODE
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
name|EAGAIN
return|;
case|case
name|CONSOLE_X_MODE_OFF
case|:
comment|/* just to be compatible */
name|fp
operator|=
operator|(
expr|struct
name|trapframe
operator|*
operator|)
name|p
operator|->
name|p_md
operator|.
name|md_regs
expr_stmt|;
name|fp
operator|->
name|tf_eflags
operator|&=
operator|~
name|PSL_IOPL
expr_stmt|;
if|if
condition|(
name|crtc_vga
condition|)
block|{
if|if
condition|(
name|fonts_loaded
operator|&
name|FONT_16_LOADED
condition|)
name|copy_font
argument_list|(
name|LOAD
argument_list|,
literal|0
argument_list|,
literal|16
argument_list|,
name|font_16
argument_list|)
expr_stmt|;
if|if
condition|(
name|fonts_loaded
operator|&
name|FONT_8_LOADED
condition|)
name|copy_font
argument_list|(
name|LOAD
argument_list|,
literal|1
argument_list|,
literal|8
argument_list|,
name|font_8
argument_list|)
expr_stmt|;
if|if
condition|(
name|fonts_loaded
operator|&
name|FONT_14_LOADED
condition|)
name|copy_font
argument_list|(
name|LOAD
argument_list|,
literal|2
argument_list|,
literal|14
argument_list|,
name|font_14
argument_list|)
expr_stmt|;
name|load_palette
argument_list|()
expr_stmt|;
block|}
name|scp
operator|->
name|status
operator|&=
operator|~
name|UNKNOWN_MODE
expr_stmt|;
name|set_mode
argument_list|(
name|scp
argument_list|)
expr_stmt|;
name|clear_screen
argument_list|(
name|scp
argument_list|)
expr_stmt|;
name|scp
operator|->
name|status
operator|&=
operator|~
name|KBD_RAW_MODE
expr_stmt|;
name|switch_scr
argument_list|(
name|saved_console
argument_list|)
expr_stmt|;
name|saved_console
operator|=
operator|-
literal|1
expr_stmt|;
return|return
literal|0
return|;
case|case
name|CONSOLE_X_BELL
case|:
comment|/* more compatibility */
comment|/*                  * if set, data is a pointer to a length 2 array of                  * integers. data[0] is the pitch in Hz and data[1]                  * is the duration in msec.                  */
if|if
condition|(
name|data
condition|)
name|sysbeep
argument_list|(
name|TIMER_FREQ
operator|/
operator|(
operator|(
name|int
operator|*
operator|)
name|data
operator|)
index|[
literal|0
index|]
argument_list|,
operator|(
operator|(
name|int
operator|*
operator|)
name|data
operator|)
index|[
literal|1
index|]
operator|*
name|hz
operator|/
literal|1000
argument_list|)
expr_stmt|;
else|else
name|sysbeep
argument_list|(
name|scp
operator|->
name|bell_pitch
argument_list|,
name|scp
operator|->
name|bell_duration
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
default|default:
break|break;
block|}
name|error
operator|=
operator|(
operator|*
name|linesw
index|[
name|tp
operator|->
name|t_line
index|]
operator|.
name|l_ioctl
operator|)
operator|(
name|tp
operator|,
name|cmd
operator|,
name|data
operator|,
name|flag
operator|,
name|p
operator|)
expr_stmt|;
if|if
condition|(
name|error
operator|>=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|error
operator|=
name|ttioctl
argument_list|(
name|tp
argument_list|,
name|cmd
argument_list|,
name|data
argument_list|,
name|flag
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|>=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
return|return
operator|(
name|ENOTTY
operator|)
return|;
block|}
end_function

begin_function
name|void
name|pcxint
parameter_list|(
name|dev_t
name|dev
parameter_list|)
block|{
name|struct
name|tty
modifier|*
name|tp
init|=
name|get_tty_ptr
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|tp
condition|)
return|return;
name|tp
operator|->
name|t_state
operator|&=
operator|~
name|TS_BUSY
expr_stmt|;
if|if
condition|(
name|tp
operator|->
name|t_line
condition|)
operator|(
operator|*
name|linesw
index|[
name|tp
operator|->
name|t_line
index|]
operator|.
name|l_start
operator|)
operator|(
name|tp
operator|)
expr_stmt|;
else|else
name|pcstart
argument_list|(
name|tp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|pcstart
parameter_list|(
name|struct
name|tty
modifier|*
name|tp
parameter_list|)
block|{
name|struct
name|clist
modifier|*
name|rbp
decl_stmt|;
name|int
name|i
decl_stmt|,
name|s
decl_stmt|,
name|len
decl_stmt|;
name|u_char
name|buf
index|[
name|PCBURST
index|]
decl_stmt|;
name|scr_stat
modifier|*
name|scp
init|=
name|get_scr_stat
argument_list|(
name|tp
operator|->
name|t_dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|scp
operator|->
name|status
operator|&
name|SLKED
condition|)
return|return;
name|s
operator|=
name|spltty
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|tp
operator|->
name|t_state
operator|&
operator|(
name|TS_TIMEOUT
operator||
name|TS_BUSY
operator||
name|TS_TTSTOP
operator|)
operator|)
condition|)
block|{
name|tp
operator|->
name|t_state
operator||=
name|TS_BUSY
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|rbp
operator|=
operator|&
name|tp
operator|->
name|t_outq
expr_stmt|;
while|while
condition|(
name|rbp
operator|->
name|c_cc
condition|)
block|{
name|len
operator|=
name|q_to_b
argument_list|(
name|rbp
argument_list|,
name|buf
argument_list|,
name|PCBURST
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|buf
index|[
name|i
index|]
condition|)
name|ansi_put
argument_list|(
name|scp
argument_list|,
name|buf
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|s
operator|=
name|spltty
argument_list|()
expr_stmt|;
name|tp
operator|->
name|t_state
operator|&=
operator|~
name|TS_BUSY
expr_stmt|;
if|#
directive|if
literal|0
block|if (rbp->c_cc) { 			tp->t_state |= TS_TIMEOUT; 			timeout((timeout_t)ttrstrt, (caddr_t)tp, 1); 		}
endif|#
directive|endif
if|if
condition|(
name|rbp
operator|->
name|c_cc
operator|<=
name|tp
operator|->
name|t_lowat
condition|)
block|{
if|if
condition|(
name|tp
operator|->
name|t_state
operator|&
name|TS_ASLEEP
condition|)
block|{
name|tp
operator|->
name|t_state
operator|&=
operator|~
name|TS_ASLEEP
expr_stmt|;
name|wakeup
argument_list|(
operator|(
name|caddr_t
operator|)
name|rbp
argument_list|)
expr_stmt|;
block|}
name|selwakeup
argument_list|(
operator|&
name|tp
operator|->
name|t_wsel
argument_list|)
expr_stmt|;
block|}
block|}
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|pccnprobe
parameter_list|(
name|struct
name|consdev
modifier|*
name|cp
parameter_list|)
block|{
name|int
name|maj
decl_stmt|;
comment|/* locate the major number */
for|for
control|(
name|maj
operator|=
literal|0
init|;
name|maj
operator|<
name|nchrdev
condition|;
name|maj
operator|++
control|)
if|if
condition|(
operator|(
name|void
operator|*
operator|)
name|cdevsw
index|[
name|maj
index|]
operator|.
name|d_open
operator|==
operator|(
name|void
operator|*
operator|)
name|pcopen
condition|)
break|break;
comment|/* initialize required fields */
name|cp
operator|->
name|cn_dev
operator|=
name|makedev
argument_list|(
name|maj
argument_list|,
name|NCONS
argument_list|)
expr_stmt|;
name|cp
operator|->
name|cn_pri
operator|=
name|CN_INTERNAL
expr_stmt|;
block|}
end_function

begin_function
name|void
name|pccninit
parameter_list|(
name|struct
name|consdev
modifier|*
name|cp
parameter_list|)
block|{
name|scinit
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|void
name|pccnputc
parameter_list|(
name|dev_t
name|dev
parameter_list|,
name|char
name|c
parameter_list|)
block|{
if|if
condition|(
name|c
operator|==
literal|'\n'
condition|)
name|scput
argument_list|(
literal|'\r'
argument_list|)
expr_stmt|;
name|scput
argument_list|(
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
name|cur_console
operator|==
operator|&
name|console
index|[
literal|0
index|]
condition|)
block|{
name|int
name|pos
init|=
name|cur_console
operator|->
name|crtat
operator|-
name|cur_console
operator|->
name|crt_base
decl_stmt|;
if|if
condition|(
name|pos
operator|!=
name|cur_cursor_pos
condition|)
block|{
name|cur_cursor_pos
operator|=
name|pos
expr_stmt|;
name|outb
argument_list|(
name|crtc_addr
argument_list|,
literal|14
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|crtc_addr
operator|+
literal|1
argument_list|,
name|pos
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|crtc_addr
argument_list|,
literal|15
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|crtc_addr
operator|+
literal|1
argument_list|,
name|pos
operator|&
literal|0xff
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|int
name|pccngetc
parameter_list|(
name|dev_t
name|dev
parameter_list|)
block|{
name|int
name|s
init|=
name|spltty
argument_list|()
decl_stmt|;
comment|/* block scintr while we poll */
name|int
name|c
init|=
name|scgetc
argument_list|(
literal|0
argument_list|)
decl_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|'\r'
condition|)
name|c
operator|=
literal|'\n'
expr_stmt|;
return|return
operator|(
name|c
operator|)
return|;
block|}
end_function

begin_function
name|int
name|pccncheckc
parameter_list|(
name|dev_t
name|dev
parameter_list|)
block|{
return|return
operator|(
name|scgetc
argument_list|(
literal|1
argument_list|)
operator|&
literal|0xff
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|none_saver
parameter_list|(
name|int
name|test
parameter_list|)
block|{ }
end_function

begin_function
specifier|static
name|void
name|fade_saver
parameter_list|(
name|int
name|test
parameter_list|)
block|{
specifier|static
name|int
name|count
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|test
condition|)
block|{
name|scrn_blanked
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|count
operator|<
literal|64
condition|)
block|{
name|outb
argument_list|(
name|PIXMASK
argument_list|,
literal|0xFF
argument_list|)
expr_stmt|;
comment|/* no pixelmask */
name|outb
argument_list|(
name|PALWADR
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|PALDATA
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|PALDATA
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|PALDATA
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|3
init|;
name|i
operator|<
literal|768
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|palette
index|[
name|i
index|]
operator|-
name|count
operator|>
literal|15
condition|)
name|outb
argument_list|(
name|PALDATA
argument_list|,
name|palette
index|[
name|i
index|]
operator|-
name|count
argument_list|)
expr_stmt|;
else|else
name|outb
argument_list|(
name|PALDATA
argument_list|,
literal|15
argument_list|)
expr_stmt|;
block|}
name|inb
argument_list|(
name|crtc_addr
operator|+
literal|6
argument_list|)
expr_stmt|;
comment|/* reset flip/flop */
name|outb
argument_list|(
name|ATC
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
comment|/* enable palette */
name|count
operator|++
expr_stmt|;
block|}
block|}
else|else
block|{
name|count
operator|=
name|scrn_blanked
operator|=
literal|0
expr_stmt|;
name|load_palette
argument_list|()
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|blank_saver
parameter_list|(
name|int
name|test
parameter_list|)
block|{
name|u_char
name|val
decl_stmt|;
if|if
condition|(
name|test
condition|)
block|{
name|scrn_blanked
operator|=
literal|1
expr_stmt|;
name|outb
argument_list|(
name|TSIDX
argument_list|,
literal|0x01
argument_list|)
expr_stmt|;
name|val
operator|=
name|inb
argument_list|(
name|TSREG
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|TSIDX
argument_list|,
literal|0x01
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|TSREG
argument_list|,
name|val
operator||
literal|0x20
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|scrn_blanked
operator|=
literal|0
expr_stmt|;
name|outb
argument_list|(
name|TSIDX
argument_list|,
literal|0x01
argument_list|)
expr_stmt|;
name|val
operator|=
name|inb
argument_list|(
name|TSREG
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|TSIDX
argument_list|,
literal|0x01
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|TSREG
argument_list|,
name|val
operator|&
literal|0xDF
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|green_saver
parameter_list|(
name|int
name|test
parameter_list|)
block|{
name|u_char
name|val
decl_stmt|;
if|if
condition|(
name|test
condition|)
block|{
name|scrn_blanked
operator|=
literal|1
expr_stmt|;
name|outb
argument_list|(
name|TSIDX
argument_list|,
literal|0x01
argument_list|)
expr_stmt|;
name|val
operator|=
name|inb
argument_list|(
name|TSREG
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|TSIDX
argument_list|,
literal|0x01
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|TSREG
argument_list|,
name|val
operator||
literal|0x20
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|crtc_addr
argument_list|,
literal|0x17
argument_list|)
expr_stmt|;
name|val
operator|=
name|inb
argument_list|(
name|crtc_addr
operator|+
literal|1
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|crtc_addr
operator|+
literal|1
argument_list|,
name|val
operator|&
operator|~
literal|0x80
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|scrn_blanked
operator|=
literal|0
expr_stmt|;
name|outb
argument_list|(
name|TSIDX
argument_list|,
literal|0x01
argument_list|)
expr_stmt|;
name|val
operator|=
name|inb
argument_list|(
name|TSREG
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|TSIDX
argument_list|,
literal|0x01
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|TSREG
argument_list|,
name|val
operator|&
literal|0xDF
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|crtc_addr
argument_list|,
literal|0x17
argument_list|)
expr_stmt|;
name|val
operator|=
name|inb
argument_list|(
name|crtc_addr
operator|+
literal|1
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|crtc_addr
operator|+
literal|1
argument_list|,
name|val
operator||
literal|0x80
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_define
define|#
directive|define
name|NUM_STARS
value|50
end_define

begin_comment
comment|/*  * Alternate saver that got its inspiration from a well known utility  * package for an inferior^H^H^H^H^H^Hfamous OS.  */
end_comment

begin_function
specifier|static
name|void
name|star_saver
parameter_list|(
name|int
name|test
parameter_list|)
block|{
name|scr_stat
modifier|*
name|scp
init|=
name|cur_console
decl_stmt|;
name|int
name|cell
decl_stmt|,
name|i
decl_stmt|;
name|char
name|pattern
index|[]
init|=
block|{
literal|"...........++++***   "
block|}
decl_stmt|;
name|char
name|colors
index|[]
init|=
block|{
name|FG_DARKGREY
block|,
name|FG_LIGHTGREY
block|,
name|FG_WHITE
block|,
name|FG_LIGHTCYAN
block|}
decl_stmt|;
specifier|static
name|u_short
name|stars
index|[
name|NUM_STARS
index|]
index|[
literal|2
index|]
decl_stmt|;
if|if
condition|(
name|test
condition|)
block|{
if|if
condition|(
operator|!
name|scrn_blanked
condition|)
block|{
name|bcopy
argument_list|(
name|Crtat
argument_list|,
name|scp
operator|->
name|scr_buf
argument_list|,
name|scp
operator|->
name|xsize
operator|*
name|scp
operator|->
name|ysize
operator|*
literal|2
argument_list|)
expr_stmt|;
name|fillw
argument_list|(
operator|(
name|FG_LIGHTGREY
operator||
name|BG_BLACK
operator|)
operator|<<
literal|8
operator||
name|scr_map
index|[
literal|0x20
index|]
argument_list|,
name|Crtat
argument_list|,
name|scp
operator|->
name|xsize
operator|*
name|scp
operator|->
name|ysize
argument_list|)
expr_stmt|;
name|set_border
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|i
operator|=
name|scp
operator|->
name|ysize
operator|*
name|scp
operator|->
name|xsize
operator|+
literal|5
expr_stmt|;
name|outb
argument_list|(
name|crtc_addr
argument_list|,
literal|14
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|crtc_addr
operator|+
literal|1
argument_list|,
name|i
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|crtc_addr
argument_list|,
literal|15
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|crtc_addr
operator|+
literal|1
argument_list|,
name|i
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|scrn_blanked
operator|=
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_STARS
condition|;
name|i
operator|++
control|)
block|{
name|stars
index|[
name|i
index|]
index|[
literal|0
index|]
operator|=
name|random
argument_list|()
operator|%
operator|(
name|scp
operator|->
name|xsize
operator|*
name|scp
operator|->
name|ysize
operator|)
expr_stmt|;
name|stars
index|[
name|i
index|]
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
block|}
block|}
name|cell
operator|=
name|random
argument_list|()
operator|%
name|NUM_STARS
expr_stmt|;
operator|*
operator|(
operator|(
name|u_short
operator|*
operator|)
operator|(
name|Crtat
operator|+
name|stars
index|[
name|cell
index|]
index|[
literal|0
index|]
operator|)
operator|)
operator|=
name|scr_map
index|[
name|pattern
index|[
name|stars
index|[
name|cell
index|]
index|[
literal|1
index|]
index|]
index|]
operator||
name|colors
index|[
name|random
argument_list|()
operator|%
sizeof|sizeof
argument_list|(
name|colors
argument_list|)
index|]
operator|<<
literal|8
expr_stmt|;
if|if
condition|(
operator|(
name|stars
index|[
name|cell
index|]
index|[
literal|1
index|]
operator|+=
operator|(
name|random
argument_list|()
operator|%
literal|4
operator|)
operator|)
operator|>=
sizeof|sizeof
argument_list|(
name|pattern
argument_list|)
operator|-
literal|1
condition|)
block|{
name|stars
index|[
name|cell
index|]
index|[
literal|0
index|]
operator|=
name|random
argument_list|()
operator|%
operator|(
name|scp
operator|->
name|xsize
operator|*
name|scp
operator|->
name|ysize
operator|)
expr_stmt|;
name|stars
index|[
name|cell
index|]
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|scrn_blanked
condition|)
block|{
name|bcopy
argument_list|(
name|scp
operator|->
name|scr_buf
argument_list|,
name|Crtat
argument_list|,
name|scp
operator|->
name|xsize
operator|*
name|scp
operator|->
name|ysize
operator|*
literal|2
argument_list|)
expr_stmt|;
name|cur_cursor_pos
operator|=
operator|-
literal|1
expr_stmt|;
name|set_border
argument_list|(
name|scp
operator|->
name|border
argument_list|)
expr_stmt|;
name|scrn_blanked
operator|=
literal|0
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|snake_saver
parameter_list|(
name|int
name|test
parameter_list|)
block|{
specifier|const
name|char
name|saves
index|[]
init|=
block|{
literal|"FreeBSD-2.0"
block|}
decl_stmt|;
specifier|static
name|u_char
modifier|*
name|savs
index|[
sizeof|sizeof
argument_list|(
name|saves
argument_list|)
operator|-
literal|1
index|]
decl_stmt|;
specifier|static
name|int
name|dirx
decl_stmt|,
name|diry
decl_stmt|;
name|int
name|f
decl_stmt|;
name|scr_stat
modifier|*
name|scp
init|=
name|cur_console
decl_stmt|;
if|if
condition|(
name|test
condition|)
block|{
if|if
condition|(
operator|!
name|scrn_blanked
condition|)
block|{
name|bcopy
argument_list|(
name|Crtat
argument_list|,
name|scp
operator|->
name|scr_buf
argument_list|,
name|scp
operator|->
name|xsize
operator|*
name|scp
operator|->
name|ysize
operator|*
literal|2
argument_list|)
expr_stmt|;
name|fillw
argument_list|(
operator|(
name|FG_LIGHTGREY
operator||
name|BG_BLACK
operator|)
operator|<<
literal|8
operator||
name|scr_map
index|[
literal|0x20
index|]
argument_list|,
name|Crtat
argument_list|,
name|scp
operator|->
name|xsize
operator|*
name|scp
operator|->
name|ysize
argument_list|)
expr_stmt|;
name|set_border
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|dirx
operator|=
operator|(
name|scp
operator|->
name|xpos
condition|?
literal|1
else|:
operator|-
literal|1
operator|)
expr_stmt|;
name|diry
operator|=
operator|(
name|scp
operator|->
name|ypos
condition|?
name|scp
operator|->
name|xsize
else|:
operator|-
name|scp
operator|->
name|xsize
operator|)
expr_stmt|;
for|for
control|(
name|f
operator|=
literal|0
init|;
name|f
operator|<
sizeof|sizeof
argument_list|(
name|saves
argument_list|)
operator|-
literal|1
condition|;
name|f
operator|++
control|)
name|savs
index|[
name|f
index|]
operator|=
operator|(
name|u_char
operator|*
operator|)
name|Crtat
operator|+
literal|2
operator|*
operator|(
name|scp
operator|->
name|xpos
operator|+
name|scp
operator|->
name|ypos
operator|*
name|scp
operator|->
name|xsize
operator|)
expr_stmt|;
operator|*
operator|(
name|savs
index|[
literal|0
index|]
operator|)
operator|=
name|scr_map
index|[
operator|*
name|saves
index|]
expr_stmt|;
name|f
operator|=
name|scp
operator|->
name|ysize
operator|*
name|scp
operator|->
name|xsize
operator|+
literal|5
expr_stmt|;
name|outb
argument_list|(
name|crtc_addr
argument_list|,
literal|14
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|crtc_addr
operator|+
literal|1
argument_list|,
name|f
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|crtc_addr
argument_list|,
literal|15
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|crtc_addr
operator|+
literal|1
argument_list|,
name|f
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|scrn_blanked
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|scrn_blanked
operator|++
operator|<
literal|4
condition|)
return|return;
name|scrn_blanked
operator|=
literal|1
expr_stmt|;
operator|*
operator|(
name|savs
index|[
sizeof|sizeof
argument_list|(
name|saves
argument_list|)
operator|-
literal|2
index|]
operator|)
operator|=
name|scr_map
index|[
literal|0x20
index|]
expr_stmt|;
for|for
control|(
name|f
operator|=
sizeof|sizeof
argument_list|(
name|saves
argument_list|)
operator|-
literal|2
init|;
name|f
operator|>
literal|0
condition|;
name|f
operator|--
control|)
name|savs
index|[
name|f
index|]
operator|=
name|savs
index|[
name|f
operator|-
literal|1
index|]
expr_stmt|;
name|f
operator|=
operator|(
name|savs
index|[
literal|0
index|]
operator|-
operator|(
name|u_char
operator|*
operator|)
name|Crtat
operator|)
operator|/
literal|2
expr_stmt|;
if|if
condition|(
operator|(
name|f
operator|%
name|scp
operator|->
name|xsize
operator|)
operator|==
literal|0
operator|||
operator|(
name|f
operator|%
name|scp
operator|->
name|xsize
operator|)
operator|==
name|scp
operator|->
name|xsize
operator|-
literal|1
operator|||
operator|(
name|random
argument_list|()
operator|%
literal|50
operator|)
operator|==
literal|0
condition|)
name|dirx
operator|=
operator|-
name|dirx
expr_stmt|;
if|if
condition|(
operator|(
name|f
operator|/
name|scp
operator|->
name|xsize
operator|)
operator|==
literal|0
operator|||
operator|(
name|f
operator|/
name|scp
operator|->
name|xsize
operator|)
operator|==
name|scp
operator|->
name|ysize
operator|-
literal|1
operator|||
operator|(
name|random
argument_list|()
operator|%
literal|20
operator|)
operator|==
literal|0
condition|)
name|diry
operator|=
operator|-
name|diry
expr_stmt|;
name|savs
index|[
literal|0
index|]
operator|+=
literal|2
operator|*
name|dirx
operator|+
literal|2
operator|*
name|diry
expr_stmt|;
for|for
control|(
name|f
operator|=
sizeof|sizeof
argument_list|(
name|saves
argument_list|)
operator|-
literal|2
init|;
name|f
operator|>=
literal|0
condition|;
name|f
operator|--
control|)
operator|*
operator|(
name|savs
index|[
name|f
index|]
operator|)
operator|=
name|scr_map
index|[
name|saves
index|[
name|f
index|]
index|]
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|scrn_blanked
condition|)
block|{
name|bcopy
argument_list|(
name|scp
operator|->
name|scr_buf
argument_list|,
name|Crtat
argument_list|,
name|scp
operator|->
name|xsize
operator|*
name|scp
operator|->
name|ysize
operator|*
literal|2
argument_list|)
expr_stmt|;
name|cur_cursor_pos
operator|=
operator|-
literal|1
expr_stmt|;
name|set_border
argument_list|(
name|scp
operator|->
name|border
argument_list|)
expr_stmt|;
name|scrn_blanked
operator|=
literal|0
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|cursor_shape
parameter_list|(
name|int
name|start
parameter_list|,
name|int
name|end
parameter_list|)
block|{
name|outb
argument_list|(
name|crtc_addr
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|crtc_addr
operator|+
literal|1
argument_list|,
name|start
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|crtc_addr
argument_list|,
literal|11
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|crtc_addr
operator|+
literal|1
argument_list|,
name|end
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
block|}
end_function

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|FAT_CURSOR
argument_list|)
end_if

begin_function
specifier|static
name|void
name|get_cursor_shape
parameter_list|(
name|int
modifier|*
name|start
parameter_list|,
name|int
modifier|*
name|end
parameter_list|)
block|{
name|outb
argument_list|(
name|crtc_addr
argument_list|,
literal|10
argument_list|)
expr_stmt|;
operator|*
name|start
operator|=
name|inb
argument_list|(
name|crtc_addr
operator|+
literal|1
argument_list|)
operator|&
literal|0x1F
expr_stmt|;
name|outb
argument_list|(
name|crtc_addr
argument_list|,
literal|11
argument_list|)
expr_stmt|;
operator|*
name|end
operator|=
name|inb
argument_list|(
name|crtc_addr
operator|+
literal|1
argument_list|)
operator|&
literal|0x1F
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|void
name|cursor_pos
parameter_list|(
name|int
name|force
parameter_list|)
block|{
name|int
name|pos
decl_stmt|;
if|if
condition|(
name|cur_console
operator|->
name|status
operator|&
name|UNKNOWN_MODE
condition|)
return|return;
if|if
condition|(
name|scrn_blank_time
operator|&&
operator|(
name|time
operator|.
name|tv_sec
operator|>
name|scrn_time_stamp
operator|+
name|scrn_blank_time
operator|)
condition|)
name|SCRN_SAVER
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|pos
operator|=
name|cur_console
operator|->
name|crtat
operator|-
name|cur_console
operator|->
name|crt_base
expr_stmt|;
if|if
condition|(
name|force
operator|||
operator|(
operator|!
name|scrn_blanked
operator|&&
name|pos
operator|!=
name|cur_cursor_pos
operator|)
condition|)
block|{
name|cur_cursor_pos
operator|=
name|pos
expr_stmt|;
name|outb
argument_list|(
name|crtc_addr
argument_list|,
literal|14
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|crtc_addr
operator|+
literal|1
argument_list|,
name|pos
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|crtc_addr
argument_list|,
literal|15
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|crtc_addr
operator|+
literal|1
argument_list|,
name|pos
operator|&
literal|0xff
argument_list|)
expr_stmt|;
block|}
name|timeout
argument_list|(
operator|(
name|timeout_t
operator|)
name|cursor_pos
argument_list|,
literal|0
argument_list|,
name|hz
operator|/
literal|20
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|clear_screen
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|)
block|{
name|move_crsr
argument_list|(
name|scp
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fillw
argument_list|(
name|scp
operator|->
name|term
operator|.
name|cur_attr
operator||
name|scr_map
index|[
literal|0x20
index|]
argument_list|,
name|scp
operator|->
name|crt_base
argument_list|,
name|scp
operator|->
name|xsize
operator|*
name|scp
operator|->
name|ysize
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|switch_scr
parameter_list|(
name|u_int
name|next_scr
parameter_list|)
block|{
if|if
condition|(
name|switch_in_progress
operator|&&
operator|(
name|cur_console
operator|->
name|proc
operator|!=
name|pfind
argument_list|(
name|cur_console
operator|->
name|pid
argument_list|)
operator|)
condition|)
name|switch_in_progress
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|next_scr
operator|>=
name|NCONS
operator|||
name|switch_in_progress
operator|||
operator|(
name|cur_console
operator|->
name|smode
operator|.
name|mode
operator|==
name|VT_AUTO
operator|&&
name|cur_console
operator|->
name|status
operator|&
name|UNKNOWN_MODE
operator|)
condition|)
block|{
name|sysbeep
argument_list|(
name|BELL_PITCH
argument_list|,
name|BELL_DURATION
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
comment|/* is the wanted virtual console open ? */
if|if
condition|(
name|next_scr
condition|)
block|{
name|struct
name|tty
modifier|*
name|tp
init|=
name|VIRTUAL_TTY
argument_list|(
name|next_scr
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|tp
operator|->
name|t_state
operator|&
name|TS_ISOPEN
operator|)
condition|)
block|{
name|sysbeep
argument_list|(
name|BELL_PITCH
argument_list|,
name|BELL_DURATION
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
block|}
if|if
condition|(
name|in_putc
condition|)
block|{
comment|/* delay switch if in putc */
name|delayed_next_scr
operator|=
name|next_scr
operator|+
literal|1
expr_stmt|;
return|return
literal|0
return|;
block|}
name|switch_in_progress
operator|=
literal|1
expr_stmt|;
name|old_scp
operator|=
name|cur_console
expr_stmt|;
name|new_scp
operator|=
operator|&
name|console
index|[
name|next_scr
index|]
expr_stmt|;
name|wakeup
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
name|new_scp
operator|->
name|smode
argument_list|)
expr_stmt|;
if|if
condition|(
name|new_scp
operator|==
name|old_scp
condition|)
block|{
name|switch_in_progress
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* has controlling process died? */
if|if
condition|(
name|old_scp
operator|->
name|proc
operator|&&
operator|(
name|old_scp
operator|->
name|proc
operator|!=
name|pfind
argument_list|(
name|old_scp
operator|->
name|pid
argument_list|)
operator|)
condition|)
name|old_scp
operator|->
name|smode
operator|.
name|mode
operator|=
name|VT_AUTO
expr_stmt|;
if|if
condition|(
name|new_scp
operator|->
name|proc
operator|&&
operator|(
name|new_scp
operator|->
name|proc
operator|!=
name|pfind
argument_list|(
name|new_scp
operator|->
name|pid
argument_list|)
operator|)
condition|)
name|new_scp
operator|->
name|smode
operator|.
name|mode
operator|=
name|VT_AUTO
expr_stmt|;
comment|/* check the modes and switch approbiatly */
if|if
condition|(
name|old_scp
operator|->
name|smode
operator|.
name|mode
operator|==
name|VT_PROCESS
condition|)
block|{
name|old_scp
operator|->
name|status
operator||=
name|SWITCH_WAIT_REL
expr_stmt|;
name|psignal
argument_list|(
name|old_scp
operator|->
name|proc
argument_list|,
name|old_scp
operator|->
name|smode
operator|.
name|relsig
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|exchange_scr
argument_list|()
expr_stmt|;
if|if
condition|(
name|new_scp
operator|->
name|smode
operator|.
name|mode
operator|==
name|VT_PROCESS
condition|)
block|{
name|new_scp
operator|->
name|status
operator||=
name|SWITCH_WAIT_ACQ
expr_stmt|;
name|psignal
argument_list|(
name|new_scp
operator|->
name|proc
argument_list|,
name|new_scp
operator|->
name|smode
operator|.
name|acqsig
argument_list|)
expr_stmt|;
block|}
else|else
name|switch_in_progress
operator|=
literal|0
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|exchange_scr
parameter_list|(
name|void
parameter_list|)
block|{
name|bcopy
argument_list|(
name|Crtat
argument_list|,
name|old_scp
operator|->
name|scr_buf
argument_list|,
name|old_scp
operator|->
name|xsize
operator|*
name|old_scp
operator|->
name|ysize
operator|*
literal|2
argument_list|)
expr_stmt|;
name|old_scp
operator|->
name|crt_base
operator|=
name|old_scp
operator|->
name|scr_buf
expr_stmt|;
name|move_crsr
argument_list|(
name|old_scp
argument_list|,
name|old_scp
operator|->
name|xpos
argument_list|,
name|old_scp
operator|->
name|ypos
argument_list|)
expr_stmt|;
name|cur_console
operator|=
name|new_scp
expr_stmt|;
if|if
condition|(
name|old_scp
operator|->
name|mode
operator|!=
name|new_scp
operator|->
name|mode
operator|||
operator|(
name|old_scp
operator|->
name|status
operator|&
name|UNKNOWN_MODE
operator|)
condition|)
name|set_mode
argument_list|(
name|new_scp
argument_list|)
expr_stmt|;
name|new_scp
operator|->
name|crt_base
operator|=
name|Crtat
expr_stmt|;
name|move_crsr
argument_list|(
name|new_scp
argument_list|,
name|new_scp
operator|->
name|xpos
argument_list|,
name|new_scp
operator|->
name|ypos
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|new_scp
operator|->
name|scr_buf
argument_list|,
name|Crtat
argument_list|,
name|new_scp
operator|->
name|xsize
operator|*
name|new_scp
operator|->
name|ysize
operator|*
literal|2
argument_list|)
expr_stmt|;
name|update_leds
argument_list|(
name|new_scp
operator|->
name|status
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|old_scp
operator|->
name|status
operator|&
name|UNKNOWN_MODE
operator|)
operator|&&
name|crtc_vga
condition|)
block|{
if|if
condition|(
name|fonts_loaded
operator|&
name|FONT_16_LOADED
condition|)
name|copy_font
argument_list|(
name|LOAD
argument_list|,
literal|0
argument_list|,
literal|16
argument_list|,
name|font_16
argument_list|)
expr_stmt|;
if|if
condition|(
name|fonts_loaded
operator|&
name|FONT_8_LOADED
condition|)
name|copy_font
argument_list|(
name|LOAD
argument_list|,
literal|1
argument_list|,
literal|8
argument_list|,
name|font_8
argument_list|)
expr_stmt|;
if|if
condition|(
name|fonts_loaded
operator|&
name|FONT_14_LOADED
condition|)
name|copy_font
argument_list|(
name|LOAD
argument_list|,
literal|2
argument_list|,
literal|14
argument_list|,
name|font_14
argument_list|)
expr_stmt|;
name|load_palette
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|old_scp
operator|->
name|status
operator|&
name|KBD_RAW_MODE
operator|||
name|new_scp
operator|->
name|status
operator|&
name|KBD_RAW_MODE
condition|)
name|shfts
operator|=
name|ctls
operator|=
name|alts
operator|=
name|agrs
operator|=
name|metas
operator|=
literal|0
expr_stmt|;
name|delayed_next_scr
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|move_crsr
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|int
name|x
parameter_list|,
name|int
name|y
parameter_list|)
block|{
if|if
condition|(
name|x
operator|<
literal|0
operator|||
name|y
operator|<
literal|0
operator|||
name|x
operator|>=
name|scp
operator|->
name|xsize
operator|||
name|y
operator|>=
name|scp
operator|->
name|ysize
condition|)
return|return;
name|scp
operator|->
name|xpos
operator|=
name|x
expr_stmt|;
name|scp
operator|->
name|ypos
operator|=
name|y
expr_stmt|;
name|scp
operator|->
name|crtat
operator|=
name|scp
operator|->
name|crt_base
operator|+
name|scp
operator|->
name|ypos
operator|*
name|scp
operator|->
name|xsize
operator|+
name|scp
operator|->
name|xpos
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|move_up
parameter_list|(
name|u_short
modifier|*
name|s
parameter_list|,
name|u_short
modifier|*
name|d
parameter_list|,
name|u_int
name|len
parameter_list|)
block|{
name|s
operator|+=
name|len
expr_stmt|;
name|d
operator|+=
name|len
expr_stmt|;
while|while
condition|(
name|len
operator|--
operator|>
literal|0
condition|)
operator|*
operator|--
name|d
operator|=
operator|*
operator|--
name|s
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|move_down
parameter_list|(
name|u_short
modifier|*
name|s
parameter_list|,
name|u_short
modifier|*
name|d
parameter_list|,
name|u_int
name|len
parameter_list|)
block|{
while|while
condition|(
name|len
operator|--
operator|>
literal|0
condition|)
operator|*
name|d
operator|++
operator|=
operator|*
name|s
operator|++
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|scan_esc
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|u_char
name|c
parameter_list|)
block|{
specifier|static
name|u_char
name|ansi_col
index|[
literal|16
index|]
init|=
block|{
literal|0
block|,
literal|4
block|,
literal|2
block|,
literal|6
block|,
literal|1
block|,
literal|5
block|,
literal|3
block|,
literal|7
block|,
literal|8
block|,
literal|12
block|,
literal|10
block|,
literal|14
block|,
literal|9
block|,
literal|13
block|,
literal|11
block|,
literal|15
block|}
decl_stmt|;
name|int
name|i
decl_stmt|,
name|n
decl_stmt|;
name|u_short
modifier|*
name|src
decl_stmt|,
modifier|*
name|dst
decl_stmt|,
name|count
decl_stmt|;
if|if
condition|(
name|scp
operator|->
name|term
operator|.
name|esc
operator|==
literal|1
condition|)
block|{
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'['
case|:
comment|/* Start ESC [ sequence */
name|scp
operator|->
name|term
operator|.
name|esc
operator|=
literal|2
expr_stmt|;
name|scp
operator|->
name|term
operator|.
name|last_param
operator|=
operator|-
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
name|scp
operator|->
name|term
operator|.
name|num_param
init|;
name|i
operator|<
name|MAX_ESC_PAR
condition|;
name|i
operator|++
control|)
name|scp
operator|->
name|term
operator|.
name|param
index|[
name|i
index|]
operator|=
literal|1
expr_stmt|;
name|scp
operator|->
name|term
operator|.
name|num_param
operator|=
literal|0
expr_stmt|;
return|return;
case|case
literal|'M'
case|:
comment|/* Move cursor up 1 line, scroll if at top */
if|if
condition|(
name|scp
operator|->
name|ypos
operator|>
literal|0
condition|)
name|move_crsr
argument_list|(
name|scp
argument_list|,
name|scp
operator|->
name|xpos
argument_list|,
name|scp
operator|->
name|ypos
operator|-
literal|1
argument_list|)
expr_stmt|;
else|else
block|{
name|move_up
argument_list|(
name|scp
operator|->
name|crt_base
argument_list|,
name|scp
operator|->
name|crt_base
operator|+
name|scp
operator|->
name|xsize
argument_list|,
operator|(
name|scp
operator|->
name|ysize
operator|-
literal|1
operator|)
operator|*
name|scp
operator|->
name|xsize
argument_list|)
expr_stmt|;
name|fillw
argument_list|(
name|scp
operator|->
name|term
operator|.
name|cur_attr
operator||
name|scr_map
index|[
literal|0x20
index|]
argument_list|,
name|scp
operator|->
name|crt_base
argument_list|,
name|scp
operator|->
name|xsize
argument_list|)
expr_stmt|;
block|}
break|break;
if|#
directive|if
name|notyet
case|case
literal|'Q'
case|:
name|scp
operator|->
name|term
operator|.
name|esc
operator|=
literal|4
expr_stmt|;
break|break;
endif|#
directive|endif
case|case
literal|'c'
case|:
comment|/* Clear screen& home */
name|clear_screen
argument_list|(
name|scp
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
elseif|else
if|if
condition|(
name|scp
operator|->
name|term
operator|.
name|esc
operator|==
literal|2
condition|)
block|{
if|if
condition|(
name|c
operator|>=
literal|'0'
operator|&&
name|c
operator|<=
literal|'9'
condition|)
block|{
if|if
condition|(
name|scp
operator|->
name|term
operator|.
name|num_param
operator|<
name|MAX_ESC_PAR
condition|)
block|{
if|if
condition|(
name|scp
operator|->
name|term
operator|.
name|last_param
operator|!=
name|scp
operator|->
name|term
operator|.
name|num_param
condition|)
block|{
name|scp
operator|->
name|term
operator|.
name|last_param
operator|=
name|scp
operator|->
name|term
operator|.
name|num_param
expr_stmt|;
name|scp
operator|->
name|term
operator|.
name|param
index|[
name|scp
operator|->
name|term
operator|.
name|num_param
index|]
operator|=
literal|0
expr_stmt|;
block|}
else|else
name|scp
operator|->
name|term
operator|.
name|param
index|[
name|scp
operator|->
name|term
operator|.
name|num_param
index|]
operator|*=
literal|10
expr_stmt|;
name|scp
operator|->
name|term
operator|.
name|param
index|[
name|scp
operator|->
name|term
operator|.
name|num_param
index|]
operator|+=
name|c
operator|-
literal|'0'
expr_stmt|;
return|return;
block|}
block|}
name|scp
operator|->
name|term
operator|.
name|num_param
operator|=
name|scp
operator|->
name|term
operator|.
name|last_param
operator|+
literal|1
expr_stmt|;
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|';'
case|:
if|if
condition|(
name|scp
operator|->
name|term
operator|.
name|num_param
operator|<
name|MAX_ESC_PAR
condition|)
return|return;
break|break;
case|case
literal|'='
case|:
name|scp
operator|->
name|term
operator|.
name|esc
operator|=
literal|3
expr_stmt|;
name|scp
operator|->
name|term
operator|.
name|last_param
operator|=
operator|-
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
name|scp
operator|->
name|term
operator|.
name|num_param
init|;
name|i
operator|<
name|MAX_ESC_PAR
condition|;
name|i
operator|++
control|)
name|scp
operator|->
name|term
operator|.
name|param
index|[
name|i
index|]
operator|=
literal|1
expr_stmt|;
name|scp
operator|->
name|term
operator|.
name|num_param
operator|=
literal|0
expr_stmt|;
return|return;
case|case
literal|'A'
case|:
comment|/* up n rows */
name|n
operator|=
name|scp
operator|->
name|term
operator|.
name|param
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|n
operator|<
literal|1
condition|)
name|n
operator|=
literal|1
expr_stmt|;
name|move_crsr
argument_list|(
name|scp
argument_list|,
name|scp
operator|->
name|xpos
argument_list|,
name|scp
operator|->
name|ypos
operator|-
name|n
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'B'
case|:
comment|/* down n rows */
name|n
operator|=
name|scp
operator|->
name|term
operator|.
name|param
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|n
operator|<
literal|1
condition|)
name|n
operator|=
literal|1
expr_stmt|;
name|move_crsr
argument_list|(
name|scp
argument_list|,
name|scp
operator|->
name|xpos
argument_list|,
name|scp
operator|->
name|ypos
operator|+
name|n
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'C'
case|:
comment|/* right n columns */
name|n
operator|=
name|scp
operator|->
name|term
operator|.
name|param
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|n
operator|<
literal|1
condition|)
name|n
operator|=
literal|1
expr_stmt|;
name|move_crsr
argument_list|(
name|scp
argument_list|,
name|scp
operator|->
name|xpos
operator|+
name|n
argument_list|,
name|scp
operator|->
name|ypos
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'D'
case|:
comment|/* left n columns */
name|n
operator|=
name|scp
operator|->
name|term
operator|.
name|param
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|n
operator|<
literal|1
condition|)
name|n
operator|=
literal|1
expr_stmt|;
name|move_crsr
argument_list|(
name|scp
argument_list|,
name|scp
operator|->
name|xpos
operator|-
name|n
argument_list|,
name|scp
operator|->
name|ypos
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'E'
case|:
comment|/* cursor to start of line n lines down */
name|n
operator|=
name|scp
operator|->
name|term
operator|.
name|param
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|n
operator|<
literal|1
condition|)
name|n
operator|=
literal|1
expr_stmt|;
name|move_crsr
argument_list|(
name|scp
argument_list|,
literal|0
argument_list|,
name|scp
operator|->
name|ypos
operator|+
name|n
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'F'
case|:
comment|/* cursor to start of line n lines up */
name|n
operator|=
name|scp
operator|->
name|term
operator|.
name|param
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|n
operator|<
literal|1
condition|)
name|n
operator|=
literal|1
expr_stmt|;
name|move_crsr
argument_list|(
name|scp
argument_list|,
literal|0
argument_list|,
name|scp
operator|->
name|ypos
operator|-
name|n
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'f'
case|:
comment|/* System V consoles .. */
case|case
literal|'H'
case|:
comment|/* Cursor move */
if|if
condition|(
name|scp
operator|->
name|term
operator|.
name|num_param
operator|==
literal|0
condition|)
name|move_crsr
argument_list|(
name|scp
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|scp
operator|->
name|term
operator|.
name|num_param
operator|==
literal|2
condition|)
name|move_crsr
argument_list|(
name|scp
argument_list|,
name|scp
operator|->
name|term
operator|.
name|param
index|[
literal|1
index|]
operator|-
literal|1
argument_list|,
name|scp
operator|->
name|term
operator|.
name|param
index|[
literal|0
index|]
operator|-
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'J'
case|:
comment|/* Clear all or part of display */
if|if
condition|(
name|scp
operator|->
name|term
operator|.
name|num_param
operator|==
literal|0
condition|)
name|n
operator|=
literal|0
expr_stmt|;
else|else
name|n
operator|=
name|scp
operator|->
name|term
operator|.
name|param
index|[
literal|0
index|]
expr_stmt|;
switch|switch
condition|(
name|n
condition|)
block|{
case|case
literal|0
case|:
comment|/* clear form cursor to end of display */
name|fillw
argument_list|(
name|scp
operator|->
name|term
operator|.
name|cur_attr
operator||
name|scr_map
index|[
literal|0x20
index|]
argument_list|,
name|scp
operator|->
name|crtat
argument_list|,
name|scp
operator|->
name|crt_base
operator|+
name|scp
operator|->
name|xsize
operator|*
name|scp
operator|->
name|ysize
operator|-
name|scp
operator|->
name|crtat
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
comment|/* clear from beginning of display to cursor */
name|fillw
argument_list|(
name|scp
operator|->
name|term
operator|.
name|cur_attr
operator||
name|scr_map
index|[
literal|0x20
index|]
argument_list|,
name|scp
operator|->
name|crt_base
argument_list|,
name|scp
operator|->
name|crtat
operator|-
name|scp
operator|->
name|crt_base
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
comment|/* clear entire display */
name|clear_screen
argument_list|(
name|scp
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|'K'
case|:
comment|/* Clear all or part of line */
if|if
condition|(
name|scp
operator|->
name|term
operator|.
name|num_param
operator|==
literal|0
condition|)
name|n
operator|=
literal|0
expr_stmt|;
else|else
name|n
operator|=
name|scp
operator|->
name|term
operator|.
name|param
index|[
literal|0
index|]
expr_stmt|;
switch|switch
condition|(
name|n
condition|)
block|{
case|case
literal|0
case|:
comment|/* clear form cursor to end of line */
name|fillw
argument_list|(
name|scp
operator|->
name|term
operator|.
name|cur_attr
operator||
name|scr_map
index|[
literal|0x20
index|]
argument_list|,
name|scp
operator|->
name|crtat
argument_list|,
name|scp
operator|->
name|xsize
operator|-
name|scp
operator|->
name|xpos
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
comment|/* clear from beginning of line to cursor */
name|fillw
argument_list|(
name|scp
operator|->
name|term
operator|.
name|cur_attr
operator||
name|scr_map
index|[
literal|0x20
index|]
argument_list|,
name|scp
operator|->
name|crtat
operator|-
operator|(
name|scp
operator|->
name|xsize
operator|-
name|scp
operator|->
name|xpos
operator|)
argument_list|,
operator|(
name|scp
operator|->
name|xsize
operator|-
name|scp
operator|->
name|xpos
operator|)
operator|+
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
comment|/* clear entire line */
name|fillw
argument_list|(
name|scp
operator|->
name|term
operator|.
name|cur_attr
operator||
name|scr_map
index|[
literal|0x20
index|]
argument_list|,
name|scp
operator|->
name|crtat
operator|-
operator|(
name|scp
operator|->
name|xsize
operator|-
name|scp
operator|->
name|xpos
operator|)
argument_list|,
name|scp
operator|->
name|xsize
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|'L'
case|:
comment|/* Insert n lines */
name|n
operator|=
name|scp
operator|->
name|term
operator|.
name|param
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|n
operator|<
literal|1
condition|)
name|n
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|n
operator|>
name|scp
operator|->
name|ysize
operator|-
name|scp
operator|->
name|ypos
condition|)
name|n
operator|=
name|scp
operator|->
name|ysize
operator|-
name|scp
operator|->
name|ypos
expr_stmt|;
name|src
operator|=
name|scp
operator|->
name|crt_base
operator|+
name|scp
operator|->
name|ypos
operator|*
name|scp
operator|->
name|xsize
expr_stmt|;
name|dst
operator|=
name|src
operator|+
name|n
operator|*
name|scp
operator|->
name|xsize
expr_stmt|;
name|count
operator|=
name|scp
operator|->
name|ysize
operator|-
operator|(
name|scp
operator|->
name|ypos
operator|+
name|n
operator|)
expr_stmt|;
name|move_up
argument_list|(
name|src
argument_list|,
name|dst
argument_list|,
name|count
operator|*
name|scp
operator|->
name|xsize
argument_list|)
expr_stmt|;
name|fillw
argument_list|(
name|scp
operator|->
name|term
operator|.
name|cur_attr
operator||
name|scr_map
index|[
literal|0x20
index|]
argument_list|,
name|src
argument_list|,
name|n
operator|*
name|scp
operator|->
name|xsize
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'M'
case|:
comment|/* Delete n lines */
name|n
operator|=
name|scp
operator|->
name|term
operator|.
name|param
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|n
operator|<
literal|1
condition|)
name|n
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|n
operator|>
name|scp
operator|->
name|ysize
operator|-
name|scp
operator|->
name|ypos
condition|)
name|n
operator|=
name|scp
operator|->
name|ysize
operator|-
name|scp
operator|->
name|ypos
expr_stmt|;
name|dst
operator|=
name|scp
operator|->
name|crt_base
operator|+
name|scp
operator|->
name|ypos
operator|*
name|scp
operator|->
name|xsize
expr_stmt|;
name|src
operator|=
name|dst
operator|+
name|n
operator|*
name|scp
operator|->
name|xsize
expr_stmt|;
name|count
operator|=
name|scp
operator|->
name|ysize
operator|-
operator|(
name|scp
operator|->
name|ypos
operator|+
name|n
operator|)
expr_stmt|;
name|move_down
argument_list|(
name|src
argument_list|,
name|dst
argument_list|,
name|count
operator|*
name|scp
operator|->
name|xsize
argument_list|)
expr_stmt|;
name|src
operator|=
name|dst
operator|+
name|count
operator|*
name|scp
operator|->
name|xsize
expr_stmt|;
name|fillw
argument_list|(
name|scp
operator|->
name|term
operator|.
name|cur_attr
operator||
name|scr_map
index|[
literal|0x20
index|]
argument_list|,
name|src
argument_list|,
name|n
operator|*
name|scp
operator|->
name|xsize
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'P'
case|:
comment|/* Delete n chars */
name|n
operator|=
name|scp
operator|->
name|term
operator|.
name|param
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|n
operator|<
literal|1
condition|)
name|n
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|n
operator|>
name|scp
operator|->
name|xsize
operator|-
name|scp
operator|->
name|xpos
condition|)
name|n
operator|=
name|scp
operator|->
name|xsize
operator|-
name|scp
operator|->
name|xpos
expr_stmt|;
name|dst
operator|=
name|scp
operator|->
name|crtat
expr_stmt|;
name|src
operator|=
name|dst
operator|+
name|n
expr_stmt|;
name|count
operator|=
name|scp
operator|->
name|xsize
operator|-
operator|(
name|scp
operator|->
name|xpos
operator|+
name|n
operator|)
expr_stmt|;
name|move_down
argument_list|(
name|src
argument_list|,
name|dst
argument_list|,
name|count
argument_list|)
expr_stmt|;
name|src
operator|=
name|dst
operator|+
name|count
expr_stmt|;
name|fillw
argument_list|(
name|scp
operator|->
name|term
operator|.
name|cur_attr
operator||
name|scr_map
index|[
literal|0x20
index|]
argument_list|,
name|src
argument_list|,
name|n
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'@'
case|:
comment|/* Insert n chars */
name|n
operator|=
name|scp
operator|->
name|term
operator|.
name|param
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|n
operator|<
literal|1
condition|)
name|n
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|n
operator|>
name|scp
operator|->
name|xsize
operator|-
name|scp
operator|->
name|xpos
condition|)
name|n
operator|=
name|scp
operator|->
name|xsize
operator|-
name|scp
operator|->
name|xpos
expr_stmt|;
name|src
operator|=
name|scp
operator|->
name|crtat
expr_stmt|;
name|dst
operator|=
name|src
operator|+
name|n
expr_stmt|;
name|count
operator|=
name|scp
operator|->
name|xsize
operator|-
operator|(
name|scp
operator|->
name|xpos
operator|+
name|n
operator|)
expr_stmt|;
name|move_up
argument_list|(
name|src
argument_list|,
name|dst
argument_list|,
name|count
argument_list|)
expr_stmt|;
name|fillw
argument_list|(
name|scp
operator|->
name|term
operator|.
name|cur_attr
operator||
name|scr_map
index|[
literal|0x20
index|]
argument_list|,
name|src
argument_list|,
name|n
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'S'
case|:
comment|/* scroll up n lines */
name|n
operator|=
name|scp
operator|->
name|term
operator|.
name|param
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|n
operator|<
literal|1
condition|)
name|n
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|n
operator|>
name|scp
operator|->
name|ypos
condition|)
name|n
operator|=
name|scp
operator|->
name|ypos
expr_stmt|;
name|bcopy
argument_list|(
name|scp
operator|->
name|crt_base
operator|+
operator|(
name|scp
operator|->
name|xsize
operator|*
name|n
operator|)
argument_list|,
name|scp
operator|->
name|crt_base
argument_list|,
name|scp
operator|->
name|xsize
operator|*
operator|(
name|scp
operator|->
name|ysize
operator|-
name|n
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|u_short
argument_list|)
argument_list|)
expr_stmt|;
name|fillw
argument_list|(
name|scp
operator|->
name|term
operator|.
name|cur_attr
operator||
name|scr_map
index|[
literal|0x20
index|]
argument_list|,
name|scp
operator|->
name|crt_base
operator|+
name|scp
operator|->
name|xsize
operator|*
operator|(
name|scp
operator|->
name|ysize
operator|-
literal|1
operator|)
argument_list|,
name|scp
operator|->
name|xsize
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'T'
case|:
comment|/* scroll down n lines */
name|n
operator|=
name|scp
operator|->
name|term
operator|.
name|param
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|n
operator|<
literal|1
condition|)
name|n
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|n
operator|>
name|scp
operator|->
name|ysize
operator|-
name|scp
operator|->
name|ypos
condition|)
name|n
operator|=
name|scp
operator|->
name|ysize
operator|-
name|scp
operator|->
name|ypos
expr_stmt|;
name|bcopy
argument_list|(
name|scp
operator|->
name|crt_base
argument_list|,
name|scp
operator|->
name|crt_base
operator|+
operator|(
name|scp
operator|->
name|xsize
operator|*
name|n
operator|)
argument_list|,
name|scp
operator|->
name|xsize
operator|*
operator|(
name|scp
operator|->
name|ysize
operator|-
name|n
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|u_short
argument_list|)
argument_list|)
expr_stmt|;
name|fillw
argument_list|(
name|scp
operator|->
name|term
operator|.
name|cur_attr
operator||
name|scr_map
index|[
literal|0x20
index|]
argument_list|,
name|scp
operator|->
name|crt_base
argument_list|,
name|scp
operator|->
name|xsize
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'X'
case|:
comment|/* delete n characters in line */
name|n
operator|=
name|scp
operator|->
name|term
operator|.
name|param
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|n
operator|<
literal|1
condition|)
name|n
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|n
operator|>
name|scp
operator|->
name|xsize
operator|-
name|scp
operator|->
name|xpos
condition|)
name|n
operator|=
name|scp
operator|->
name|xsize
operator|-
name|scp
operator|->
name|xpos
expr_stmt|;
name|fillw
argument_list|(
name|scp
operator|->
name|term
operator|.
name|cur_attr
operator||
name|scr_map
index|[
literal|0x20
index|]
argument_list|,
name|scp
operator|->
name|crt_base
operator|+
name|scp
operator|->
name|xpos
operator|+
operator|(
operator|(
name|scp
operator|->
name|xsize
operator|*
name|scp
operator|->
name|ypos
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|u_short
argument_list|)
operator|)
argument_list|,
name|n
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'Z'
case|:
comment|/* move n tabs backwards */
name|n
operator|=
name|scp
operator|->
name|term
operator|.
name|param
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|n
operator|<
literal|1
condition|)
name|n
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|=
name|scp
operator|->
name|xpos
operator|&
literal|0xf8
operator|)
operator|==
name|scp
operator|->
name|xpos
condition|)
name|i
operator|-=
literal|8
operator|*
name|n
expr_stmt|;
else|else
name|i
operator|-=
literal|8
operator|*
operator|(
name|n
operator|-
literal|1
operator|)
expr_stmt|;
if|if
condition|(
name|i
operator|<
literal|0
condition|)
name|i
operator|=
literal|0
expr_stmt|;
name|move_crsr
argument_list|(
name|scp
argument_list|,
name|i
argument_list|,
name|scp
operator|->
name|ypos
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'`'
case|:
comment|/* move cursor to column n */
name|n
operator|=
name|scp
operator|->
name|term
operator|.
name|param
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|n
operator|<
literal|1
condition|)
name|n
operator|=
literal|1
expr_stmt|;
name|move_crsr
argument_list|(
name|scp
argument_list|,
name|n
argument_list|,
name|scp
operator|->
name|ypos
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'a'
case|:
comment|/* move cursor n columns to the right */
name|n
operator|=
name|scp
operator|->
name|term
operator|.
name|param
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|n
operator|<
literal|1
condition|)
name|n
operator|=
literal|1
expr_stmt|;
name|move_crsr
argument_list|(
name|scp
argument_list|,
name|scp
operator|->
name|xpos
operator|+
name|n
argument_list|,
name|scp
operator|->
name|ypos
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
comment|/* move cursor to row n */
name|n
operator|=
name|scp
operator|->
name|term
operator|.
name|param
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|n
operator|<
literal|1
condition|)
name|n
operator|=
literal|1
expr_stmt|;
name|move_crsr
argument_list|(
name|scp
argument_list|,
name|scp
operator|->
name|xpos
argument_list|,
name|n
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'e'
case|:
comment|/* move cursor n rows down */
name|n
operator|=
name|scp
operator|->
name|term
operator|.
name|param
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|n
operator|<
literal|1
condition|)
name|n
operator|=
literal|1
expr_stmt|;
name|move_crsr
argument_list|(
name|scp
argument_list|,
name|scp
operator|->
name|xpos
argument_list|,
name|scp
operator|->
name|ypos
operator|+
name|n
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'m'
case|:
comment|/* change attribute */
if|if
condition|(
name|scp
operator|->
name|term
operator|.
name|num_param
operator|==
literal|0
condition|)
block|{
name|scp
operator|->
name|term
operator|.
name|cur_attr
operator|=
name|scp
operator|->
name|term
operator|.
name|std_attr
expr_stmt|;
break|break;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|scp
operator|->
name|term
operator|.
name|num_param
condition|;
name|i
operator|++
control|)
block|{
switch|switch
condition|(
name|n
operator|=
name|scp
operator|->
name|term
operator|.
name|param
index|[
name|i
index|]
condition|)
block|{
case|case
literal|0
case|:
comment|/* back to normal */
name|scp
operator|->
name|term
operator|.
name|cur_attr
operator|=
name|scp
operator|->
name|term
operator|.
name|std_attr
expr_stmt|;
break|break;
case|case
literal|1
case|:
comment|/* highlight (bold) */
name|scp
operator|->
name|term
operator|.
name|cur_attr
operator|&=
literal|0xFF00
expr_stmt|;
name|scp
operator|->
name|term
operator|.
name|cur_attr
operator||=
literal|0x0800
expr_stmt|;
break|break;
case|case
literal|4
case|:
comment|/* highlight (underline) */
name|scp
operator|->
name|term
operator|.
name|cur_attr
operator|&=
literal|0xFF00
expr_stmt|;
name|scp
operator|->
name|term
operator|.
name|cur_attr
operator||=
literal|0x0800
expr_stmt|;
break|break;
case|case
literal|5
case|:
comment|/* blink */
name|scp
operator|->
name|term
operator|.
name|cur_attr
operator|&=
literal|0xFF00
expr_stmt|;
name|scp
operator|->
name|term
operator|.
name|cur_attr
operator||=
literal|0x8000
expr_stmt|;
break|break;
case|case
literal|7
case|:
comment|/* reverse video */
name|scp
operator|->
name|term
operator|.
name|cur_attr
operator|=
name|scp
operator|->
name|term
operator|.
name|rev_attr
expr_stmt|;
break|break;
case|case
literal|30
case|:
case|case
literal|31
case|:
comment|/* set fg color */
case|case
literal|32
case|:
case|case
literal|33
case|:
case|case
literal|34
case|:
case|case
literal|35
case|:
case|case
literal|36
case|:
case|case
literal|37
case|:
name|scp
operator|->
name|term
operator|.
name|cur_attr
operator|=
operator|(
name|scp
operator|->
name|term
operator|.
name|cur_attr
operator|&
literal|0xF8FF
operator|)
operator||
operator|(
name|ansi_col
index|[
operator|(
name|n
operator|-
literal|30
operator|)
operator|&
literal|7
index|]
operator|<<
literal|8
operator|)
expr_stmt|;
break|break;
case|case
literal|40
case|:
case|case
literal|41
case|:
comment|/* set bg color */
case|case
literal|42
case|:
case|case
literal|43
case|:
case|case
literal|44
case|:
case|case
literal|45
case|:
case|case
literal|46
case|:
case|case
literal|47
case|:
name|scp
operator|->
name|term
operator|.
name|cur_attr
operator|=
operator|(
name|scp
operator|->
name|term
operator|.
name|cur_attr
operator|&
literal|0x8FFF
operator|)
operator||
operator|(
name|ansi_col
index|[
operator|(
name|n
operator|-
literal|40
operator|)
operator|&
literal|7
index|]
operator|<<
literal|12
operator|)
expr_stmt|;
break|break;
block|}
block|}
break|break;
case|case
literal|'x'
case|:
if|if
condition|(
name|scp
operator|->
name|term
operator|.
name|num_param
operator|==
literal|0
condition|)
name|n
operator|=
literal|0
expr_stmt|;
else|else
name|n
operator|=
name|scp
operator|->
name|term
operator|.
name|param
index|[
literal|0
index|]
expr_stmt|;
switch|switch
condition|(
name|n
condition|)
block|{
case|case
literal|0
case|:
comment|/* reset attributes */
name|scp
operator|->
name|term
operator|.
name|cur_attr
operator|=
name|scp
operator|->
name|term
operator|.
name|std_attr
operator|=
name|current_default
operator|->
name|std_attr
expr_stmt|;
name|scp
operator|->
name|term
operator|.
name|rev_attr
operator|=
name|current_default
operator|->
name|rev_attr
expr_stmt|;
break|break;
case|case
literal|1
case|:
comment|/* set ansi background */
name|scp
operator|->
name|term
operator|.
name|cur_attr
operator|=
name|scp
operator|->
name|term
operator|.
name|std_attr
operator|=
operator|(
name|scp
operator|->
name|term
operator|.
name|std_attr
operator|&
literal|0x0F00
operator|)
operator||
operator|(
name|ansi_col
index|[
operator|(
name|scp
operator|->
name|term
operator|.
name|param
index|[
literal|1
index|]
operator|)
operator|&
literal|0x0F
index|]
operator|<<
literal|12
operator|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
comment|/* set ansi foreground */
name|scp
operator|->
name|term
operator|.
name|cur_attr
operator|=
name|scp
operator|->
name|term
operator|.
name|std_attr
operator|=
operator|(
name|scp
operator|->
name|term
operator|.
name|std_attr
operator|&
literal|0xF000
operator|)
operator||
operator|(
name|ansi_col
index|[
operator|(
name|scp
operator|->
name|term
operator|.
name|param
index|[
literal|1
index|]
operator|)
operator|&
literal|0x0F
index|]
operator|<<
literal|8
operator|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
comment|/* set ansi attribute directly */
name|scp
operator|->
name|term
operator|.
name|cur_attr
operator|=
name|scp
operator|->
name|term
operator|.
name|std_attr
operator|=
operator|(
name|scp
operator|->
name|term
operator|.
name|param
index|[
literal|1
index|]
operator|&
literal|0xFF
operator|)
operator|<<
literal|8
expr_stmt|;
break|break;
case|case
literal|5
case|:
comment|/* set ansi reverse video background */
name|scp
operator|->
name|term
operator|.
name|rev_attr
operator|=
operator|(
name|scp
operator|->
name|term
operator|.
name|rev_attr
operator|&
literal|0x0F00
operator|)
operator||
operator|(
name|ansi_col
index|[
operator|(
name|scp
operator|->
name|term
operator|.
name|param
index|[
literal|1
index|]
operator|)
operator|&
literal|0x0F
index|]
operator|<<
literal|12
operator|)
expr_stmt|;
break|break;
case|case
literal|6
case|:
comment|/* set ansi reverse video foreground */
name|scp
operator|->
name|term
operator|.
name|rev_attr
operator|=
operator|(
name|scp
operator|->
name|term
operator|.
name|rev_attr
operator|&
literal|0xF000
operator|)
operator||
operator|(
name|ansi_col
index|[
operator|(
name|scp
operator|->
name|term
operator|.
name|param
index|[
literal|1
index|]
operator|)
operator|&
literal|0x0F
index|]
operator|<<
literal|8
operator|)
expr_stmt|;
break|break;
case|case
literal|7
case|:
comment|/* set ansi reverse video directly */
name|scp
operator|->
name|term
operator|.
name|rev_attr
operator|=
operator|(
name|scp
operator|->
name|term
operator|.
name|param
index|[
literal|1
index|]
operator|&
literal|0xFF
operator|)
operator|<<
literal|8
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|'z'
case|:
comment|/* switch to (virtual) console n */
if|if
condition|(
name|scp
operator|->
name|term
operator|.
name|num_param
operator|==
literal|1
condition|)
name|switch_scr
argument_list|(
name|scp
operator|->
name|term
operator|.
name|param
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
elseif|else
if|if
condition|(
name|scp
operator|->
name|term
operator|.
name|esc
operator|==
literal|3
condition|)
block|{
if|if
condition|(
name|c
operator|>=
literal|'0'
operator|&&
name|c
operator|<=
literal|'9'
condition|)
block|{
if|if
condition|(
name|scp
operator|->
name|term
operator|.
name|num_param
operator|<
name|MAX_ESC_PAR
condition|)
block|{
if|if
condition|(
name|scp
operator|->
name|term
operator|.
name|last_param
operator|!=
name|scp
operator|->
name|term
operator|.
name|num_param
condition|)
block|{
name|scp
operator|->
name|term
operator|.
name|last_param
operator|=
name|scp
operator|->
name|term
operator|.
name|num_param
expr_stmt|;
name|scp
operator|->
name|term
operator|.
name|param
index|[
name|scp
operator|->
name|term
operator|.
name|num_param
index|]
operator|=
literal|0
expr_stmt|;
block|}
else|else
name|scp
operator|->
name|term
operator|.
name|param
index|[
name|scp
operator|->
name|term
operator|.
name|num_param
index|]
operator|*=
literal|10
expr_stmt|;
name|scp
operator|->
name|term
operator|.
name|param
index|[
name|scp
operator|->
name|term
operator|.
name|num_param
index|]
operator|+=
name|c
operator|-
literal|'0'
expr_stmt|;
return|return;
block|}
block|}
name|scp
operator|->
name|term
operator|.
name|num_param
operator|=
name|scp
operator|->
name|term
operator|.
name|last_param
operator|+
literal|1
expr_stmt|;
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|';'
case|:
if|if
condition|(
name|scp
operator|->
name|term
operator|.
name|num_param
operator|<
name|MAX_ESC_PAR
condition|)
return|return;
break|break;
case|case
literal|'A'
case|:
comment|/* set display border color */
if|if
condition|(
name|scp
operator|->
name|term
operator|.
name|num_param
operator|==
literal|1
condition|)
name|scp
operator|->
name|border
operator|=
name|scp
operator|->
name|term
operator|.
name|param
index|[
literal|0
index|]
operator|&
literal|0xff
expr_stmt|;
if|if
condition|(
name|scp
operator|==
name|cur_console
condition|)
name|set_border
argument_list|(
name|scp
operator|->
name|border
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'B'
case|:
comment|/* set bell pitch and duration */
if|if
condition|(
name|scp
operator|->
name|term
operator|.
name|num_param
operator|==
literal|2
condition|)
block|{
name|scp
operator|->
name|bell_pitch
operator|=
name|scp
operator|->
name|term
operator|.
name|param
index|[
literal|0
index|]
expr_stmt|;
name|scp
operator|->
name|bell_duration
operator|=
name|scp
operator|->
name|term
operator|.
name|param
index|[
literal|1
index|]
operator|*
literal|10
expr_stmt|;
block|}
break|break;
case|case
literal|'C'
case|:
comment|/* set cursor shape (start& end line) */
if|if
condition|(
name|scp
operator|->
name|term
operator|.
name|num_param
operator|==
literal|2
condition|)
block|{
name|scp
operator|->
name|cursor_start
operator|=
name|scp
operator|->
name|term
operator|.
name|param
index|[
literal|0
index|]
operator|&
literal|0x1F
expr_stmt|;
name|scp
operator|->
name|cursor_end
operator|=
name|scp
operator|->
name|term
operator|.
name|param
index|[
literal|1
index|]
operator|&
literal|0x1F
expr_stmt|;
if|if
condition|(
name|scp
operator|==
name|cur_console
condition|)
name|cursor_shape
argument_list|(
name|scp
operator|->
name|cursor_start
argument_list|,
name|scp
operator|->
name|cursor_end
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|'F'
case|:
comment|/* set ansi foreground */
if|if
condition|(
name|scp
operator|->
name|term
operator|.
name|num_param
operator|==
literal|1
condition|)
name|scp
operator|->
name|term
operator|.
name|cur_attr
operator|=
name|scp
operator|->
name|term
operator|.
name|std_attr
operator|=
operator|(
name|scp
operator|->
name|term
operator|.
name|std_attr
operator|&
literal|0xF000
operator|)
operator||
operator|(
operator|(
name|scp
operator|->
name|term
operator|.
name|param
index|[
literal|0
index|]
operator|&
literal|0x0F
operator|)
operator|<<
literal|8
operator|)
expr_stmt|;
break|break;
case|case
literal|'G'
case|:
comment|/* set ansi background */
if|if
condition|(
name|scp
operator|->
name|term
operator|.
name|num_param
operator|==
literal|1
condition|)
name|scp
operator|->
name|term
operator|.
name|cur_attr
operator|=
name|scp
operator|->
name|term
operator|.
name|std_attr
operator|=
operator|(
name|scp
operator|->
name|term
operator|.
name|std_attr
operator|&
literal|0x0F00
operator|)
operator||
operator|(
operator|(
name|scp
operator|->
name|term
operator|.
name|param
index|[
literal|0
index|]
operator|&
literal|0x0F
operator|)
operator|<<
literal|12
operator|)
expr_stmt|;
break|break;
case|case
literal|'H'
case|:
comment|/* set ansi reverse video foreground */
if|if
condition|(
name|scp
operator|->
name|term
operator|.
name|num_param
operator|==
literal|1
condition|)
name|scp
operator|->
name|term
operator|.
name|rev_attr
operator|=
operator|(
name|scp
operator|->
name|term
operator|.
name|rev_attr
operator|&
literal|0xF000
operator|)
operator||
operator|(
operator|(
name|scp
operator|->
name|term
operator|.
name|param
index|[
literal|0
index|]
operator|&
literal|0x0F
operator|)
operator|<<
literal|8
operator|)
expr_stmt|;
break|break;
case|case
literal|'I'
case|:
comment|/* set ansi reverse video background */
if|if
condition|(
name|scp
operator|->
name|term
operator|.
name|num_param
operator|==
literal|1
condition|)
name|scp
operator|->
name|term
operator|.
name|rev_attr
operator|=
operator|(
name|scp
operator|->
name|term
operator|.
name|rev_attr
operator|&
literal|0x0F00
operator|)
operator||
operator|(
operator|(
name|scp
operator|->
name|term
operator|.
name|param
index|[
literal|0
index|]
operator|&
literal|0x0F
operator|)
operator|<<
literal|12
operator|)
expr_stmt|;
break|break;
block|}
block|}
name|scp
operator|->
name|term
operator|.
name|esc
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ansi_put
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|u_char
name|c
parameter_list|)
block|{
if|if
condition|(
name|scp
operator|->
name|status
operator|&
name|UNKNOWN_MODE
condition|)
return|return;
comment|/* make screensaver happy */
if|if
condition|(
name|scp
operator|==
name|cur_console
condition|)
block|{
name|scrn_time_stamp
operator|=
name|time
operator|.
name|tv_sec
expr_stmt|;
if|if
condition|(
name|scrn_blanked
condition|)
name|SCRN_SAVER
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|in_putc
operator|++
expr_stmt|;
if|if
condition|(
name|scp
operator|->
name|term
operator|.
name|esc
condition|)
name|scan_esc
argument_list|(
name|scp
argument_list|,
name|c
argument_list|)
expr_stmt|;
else|else
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|0x1B
case|:
comment|/* start escape sequence */
name|scp
operator|->
name|term
operator|.
name|esc
operator|=
literal|1
expr_stmt|;
name|scp
operator|->
name|term
operator|.
name|num_param
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|0x07
case|:
if|if
condition|(
name|scp
operator|==
name|cur_console
condition|)
name|sysbeep
argument_list|(
name|scp
operator|->
name|bell_pitch
argument_list|,
name|scp
operator|->
name|bell_duration
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'\t'
case|:
comment|/* non-destructive tab */
name|scp
operator|->
name|crtat
operator|+=
operator|(
literal|8
operator|-
name|scp
operator|->
name|xpos
operator|%
literal|8
operator|)
expr_stmt|;
name|scp
operator|->
name|xpos
operator|+=
operator|(
literal|8
operator|-
name|scp
operator|->
name|xpos
operator|%
literal|8
operator|)
expr_stmt|;
break|break;
case|case
literal|'\b'
case|:
comment|/* non-destructive backspace */
if|if
condition|(
name|scp
operator|->
name|crtat
operator|>
name|scp
operator|->
name|crt_base
condition|)
block|{
name|scp
operator|->
name|crtat
operator|--
expr_stmt|;
if|if
condition|(
name|scp
operator|->
name|xpos
operator|>
literal|0
condition|)
name|scp
operator|->
name|xpos
operator|--
expr_stmt|;
else|else
block|{
name|scp
operator|->
name|xpos
operator|+=
name|scp
operator|->
name|xsize
operator|-
literal|1
expr_stmt|;
name|scp
operator|->
name|ypos
operator|--
expr_stmt|;
block|}
block|}
break|break;
case|case
literal|'\r'
case|:
comment|/* return to pos 0 */
name|move_crsr
argument_list|(
name|scp
argument_list|,
literal|0
argument_list|,
name|scp
operator|->
name|ypos
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'\n'
case|:
comment|/* newline, same pos */
name|scp
operator|->
name|crtat
operator|+=
name|scp
operator|->
name|xsize
expr_stmt|;
name|scp
operator|->
name|ypos
operator|++
expr_stmt|;
break|break;
case|case
literal|'\f'
case|:
comment|/* form feed, clears screen */
name|clear_screen
argument_list|(
name|scp
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|/* Print only printables */
operator|*
name|scp
operator|->
name|crtat
operator|=
operator|(
name|scp
operator|->
name|term
operator|.
name|cur_attr
operator||
name|scr_map
index|[
name|c
index|]
operator|)
expr_stmt|;
name|scp
operator|->
name|crtat
operator|++
expr_stmt|;
if|if
condition|(
operator|++
name|scp
operator|->
name|xpos
operator|>=
name|scp
operator|->
name|xsize
condition|)
block|{
name|scp
operator|->
name|xpos
operator|=
literal|0
expr_stmt|;
name|scp
operator|->
name|ypos
operator|++
expr_stmt|;
block|}
break|break;
block|}
if|if
condition|(
name|scp
operator|->
name|crtat
operator|>=
name|scp
operator|->
name|crt_base
operator|+
name|scp
operator|->
name|ysize
operator|*
name|scp
operator|->
name|xsize
condition|)
block|{
name|bcopy
argument_list|(
name|scp
operator|->
name|crt_base
operator|+
name|scp
operator|->
name|xsize
argument_list|,
name|scp
operator|->
name|crt_base
argument_list|,
name|scp
operator|->
name|xsize
operator|*
operator|(
name|scp
operator|->
name|ysize
operator|-
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|u_short
argument_list|)
argument_list|)
expr_stmt|;
name|fillw
argument_list|(
name|scp
operator|->
name|term
operator|.
name|cur_attr
operator||
name|scr_map
index|[
literal|0x20
index|]
argument_list|,
name|scp
operator|->
name|crt_base
operator|+
name|scp
operator|->
name|xsize
operator|*
operator|(
name|scp
operator|->
name|ysize
operator|-
literal|1
operator|)
argument_list|,
name|scp
operator|->
name|xsize
argument_list|)
expr_stmt|;
name|scp
operator|->
name|crtat
operator|-=
name|scp
operator|->
name|xsize
expr_stmt|;
name|scp
operator|->
name|ypos
operator|--
expr_stmt|;
block|}
name|in_putc
operator|--
expr_stmt|;
if|if
condition|(
name|delayed_next_scr
condition|)
name|switch_scr
argument_list|(
name|delayed_next_scr
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|scinit
parameter_list|(
name|void
parameter_list|)
block|{
name|u_short
specifier|volatile
modifier|*
name|cp
init|=
name|Crtat
operator|+
operator|(
name|CGA_BUF
operator|-
name|MONO_BUF
operator|)
operator|/
sizeof|sizeof
argument_list|(
name|u_short
argument_list|)
decl_stmt|,
name|was
decl_stmt|;
name|unsigned
name|cursorat
decl_stmt|;
name|int
name|start
init|=
operator|-
literal|1
decl_stmt|,
name|end
init|=
operator|-
literal|1
decl_stmt|,
name|i
decl_stmt|;
name|scr_stat
modifier|*
name|scp
decl_stmt|;
comment|/* 	 * catch that once in a blue moon occurence when scinit is called  	 * TWICE, adding the CGA_BUF offset again -> poooff 	 */
if|if
condition|(
name|crtat
operator|!=
literal|0
condition|)
return|return;
comment|/* 	 * Crtat initialized to point to MONO buffer, if not present change 	 * to CGA_BUF offset. ONLY ADD the difference since locore.s adds 	 * in the remapped offset at the "right" time 	 */
name|was
operator|=
operator|*
name|cp
expr_stmt|;
operator|*
name|cp
operator|=
operator|(
name|u_short
operator|)
literal|0xA55A
expr_stmt|;
if|if
condition|(
operator|*
name|cp
operator|!=
literal|0xA55A
condition|)
name|crtc_addr
operator|=
name|MONO_BASE
expr_stmt|;
else|else
block|{
operator|*
name|cp
operator|=
name|was
expr_stmt|;
name|crtc_addr
operator|=
name|COLOR_BASE
expr_stmt|;
name|Crtat
operator|=
name|Crtat
operator|+
operator|(
name|CGA_BUF
operator|-
name|MONO_BUF
operator|)
operator|/
sizeof|sizeof
argument_list|(
name|u_short
argument_list|)
expr_stmt|;
block|}
comment|/* Extract cursor location */
name|outb
argument_list|(
name|crtc_addr
argument_list|,
literal|14
argument_list|)
expr_stmt|;
name|cursorat
operator|=
name|inb
argument_list|(
name|crtc_addr
operator|+
literal|1
argument_list|)
operator|<<
literal|8
expr_stmt|;
name|outb
argument_list|(
name|crtc_addr
argument_list|,
literal|15
argument_list|)
expr_stmt|;
name|cursorat
operator||=
name|inb
argument_list|(
name|crtc_addr
operator|+
literal|1
argument_list|)
expr_stmt|;
name|crtat
operator|=
name|Crtat
operator|+
name|cursorat
expr_stmt|;
comment|/* is this a VGA or higher ? */
name|outb
argument_list|(
name|crtc_addr
argument_list|,
literal|7
argument_list|)
expr_stmt|;
if|if
condition|(
name|inb
argument_list|(
name|crtc_addr
argument_list|)
operator|==
literal|7
condition|)
block|{
name|u_long
name|pa
decl_stmt|;
name|u_long
name|segoff
decl_stmt|;
name|crtc_vga
operator|=
literal|1
expr_stmt|;
comment|/* 		 * Get the BIOS video mode pointer. 		 */
name|segoff
operator|=
operator|*
operator|(
name|u_long
operator|*
operator|)
name|pa_to_va
argument_list|(
literal|0x4a8
argument_list|)
expr_stmt|;
name|pa
operator|=
operator|(
operator|(
operator|(
name|segoff
operator|&
literal|0xffff0000
operator|)
operator|>>
literal|12
operator|)
operator|+
operator|(
name|segoff
operator|&
literal|0xffff
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|ISMAPPED
argument_list|(
name|pa
argument_list|,
sizeof|sizeof
argument_list|(
name|u_long
argument_list|)
argument_list|)
condition|)
block|{
name|segoff
operator|=
operator|*
operator|(
name|u_long
operator|*
operator|)
name|pa_to_va
argument_list|(
name|pa
argument_list|)
expr_stmt|;
name|pa
operator|=
operator|(
operator|(
operator|(
name|segoff
operator|&
literal|0xffff0000
operator|)
operator|>>
literal|12
operator|)
operator|+
operator|(
name|segoff
operator|&
literal|0xffff
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|ISMAPPED
argument_list|(
name|pa
argument_list|,
literal|64
argument_list|)
condition|)
name|video_mode_ptr
operator|=
operator|(
name|char
operator|*
operator|)
name|pa_to_va
argument_list|(
name|pa
argument_list|)
expr_stmt|;
block|}
if|#
directive|if
name|defined
argument_list|(
name|FAT_CURSOR
argument_list|)
name|start
operator|=
literal|0
expr_stmt|;
name|end
operator|=
literal|18
expr_stmt|;
name|cursor_shape
argument_list|(
name|start
argument_list|,
name|end
argument_list|)
expr_stmt|;
else|#
directive|else
name|get_cursor_shape
argument_list|(
operator|&
name|start
argument_list|,
operator|&
name|end
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
name|current_default
operator|=
operator|&
name|user_default
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NCONS
condition|;
name|i
operator|++
control|)
block|{
name|scp
operator|=
operator|&
name|console
index|[
name|i
index|]
expr_stmt|;
name|scp
operator|->
name|mode
operator|=
name|M_VGA_C80x25
expr_stmt|;
name|scp
operator|->
name|term
operator|.
name|esc
operator|=
literal|0
expr_stmt|;
name|scp
operator|->
name|term
operator|.
name|std_attr
operator|=
name|current_default
operator|->
name|std_attr
expr_stmt|;
name|scp
operator|->
name|term
operator|.
name|rev_attr
operator|=
name|current_default
operator|->
name|rev_attr
expr_stmt|;
name|scp
operator|->
name|term
operator|.
name|cur_attr
operator|=
name|scp
operator|->
name|term
operator|.
name|std_attr
expr_stmt|;
name|scp
operator|->
name|border
operator|=
name|BG_BLACK
expr_stmt|;
name|scp
operator|->
name|cursor_start
operator|=
name|start
expr_stmt|;
name|scp
operator|->
name|cursor_end
operator|=
name|end
expr_stmt|;
name|scp
operator|->
name|xsize
operator|=
name|COL
expr_stmt|;
name|scp
operator|->
name|ysize
operator|=
name|ROW
expr_stmt|;
name|scp
operator|->
name|bell_pitch
operator|=
name|BELL_PITCH
expr_stmt|;
name|scp
operator|->
name|bell_duration
operator|=
name|BELL_DURATION
expr_stmt|;
name|scp
operator|->
name|status
operator|=
operator|*
operator|(
name|char
operator|*
operator|)
operator|(
name|KERNBASE
operator|+
literal|0x417
operator|)
operator|&
literal|0x20
condition|?
name|NLKED
else|:
literal|0
expr_stmt|;
name|scp
operator|->
name|pid
operator|=
literal|0
expr_stmt|;
name|scp
operator|->
name|proc
operator|=
name|NULL
expr_stmt|;
name|scp
operator|->
name|smode
operator|.
name|mode
operator|=
name|VT_AUTO
expr_stmt|;
if|if
condition|(
name|i
operator|==
literal|0
condition|)
block|{
name|scp
operator|->
name|xpos
operator|=
name|cursorat
operator|%
name|COL
expr_stmt|;
name|scp
operator|->
name|ypos
operator|=
name|cursorat
operator|/
name|COL
expr_stmt|;
name|scp
operator|->
name|crt_base
operator|=
name|Crtat
expr_stmt|;
name|scp
operator|->
name|crtat
operator|=
name|crtat
expr_stmt|;
block|}
block|}
name|kernel_console
operator|.
name|esc
operator|=
literal|0
expr_stmt|;
name|kernel_console
operator|.
name|std_attr
operator|=
name|kernel_default
operator|.
name|std_attr
expr_stmt|;
name|kernel_console
operator|.
name|rev_attr
operator|=
name|kernel_default
operator|.
name|rev_attr
expr_stmt|;
name|kernel_console
operator|.
name|cur_attr
operator|=
name|kernel_default
operator|.
name|std_attr
expr_stmt|;
comment|/* initialize mapscrn array to a one to one map */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|scr_map
argument_list|)
condition|;
name|i
operator|++
control|)
name|scr_map
index|[
name|i
index|]
operator|=
name|i
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|scput
parameter_list|(
name|u_char
name|c
parameter_list|)
block|{
name|scr_stat
modifier|*
name|scp
init|=
operator|&
name|console
index|[
literal|0
index|]
decl_stmt|;
name|term_stat
name|save
decl_stmt|;
if|if
condition|(
name|crtat
operator|==
literal|0
condition|)
name|scinit
argument_list|()
expr_stmt|;
if|if
condition|(
name|in_putc
operator|==
literal|0
condition|)
block|{
operator|++
name|in_putc
expr_stmt|;
name|save
operator|=
name|scp
operator|->
name|term
expr_stmt|;
name|scp
operator|->
name|term
operator|=
name|kernel_console
expr_stmt|;
name|current_default
operator|=
operator|&
name|kernel_default
expr_stmt|;
name|ansi_put
argument_list|(
name|scp
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|kernel_console
operator|=
name|scp
operator|->
name|term
expr_stmt|;
name|current_default
operator|=
operator|&
name|user_default
expr_stmt|;
name|scp
operator|->
name|term
operator|=
name|save
expr_stmt|;
operator|--
name|in_putc
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|console_buffer_count
operator|<
name|CONSOLE_BUFSIZE
condition|)
name|console_buffer
index|[
name|console_buffer_count
operator|++
index|]
operator|=
name|c
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|u_char
modifier|*
name|get_fstr
parameter_list|(
name|u_int
name|c
parameter_list|,
name|u_int
modifier|*
name|len
parameter_list|)
block|{
name|u_int
name|i
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|c
operator|&
name|FKEY
operator|)
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|i
operator|=
operator|(
name|c
operator|&
literal|0xFF
operator|)
operator|-
name|F_FN
expr_stmt|;
if|if
condition|(
name|i
operator|>
name|n_fkey_tab
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
operator|*
name|len
operator|=
name|fkey_tab
index|[
name|i
index|]
operator|.
name|len
expr_stmt|;
return|return
operator|(
name|fkey_tab
index|[
name|i
index|]
operator|.
name|str
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|update_leds
parameter_list|(
name|int
name|which
parameter_list|)
block|{
name|int
name|s
decl_stmt|;
specifier|static
name|u_char
name|xlate_leds
index|[
literal|8
index|]
init|=
block|{
literal|0
block|,
literal|4
block|,
literal|2
block|,
literal|6
block|,
literal|1
block|,
literal|5
block|,
literal|3
block|,
literal|7
block|}
decl_stmt|;
comment|/* replace CAPS led with ALTGR led for ALTGR keyboards */
if|if
condition|(
name|key_map
operator|.
name|n_keys
operator|>
name|ALTGR_OFFSET
condition|)
block|{
if|if
condition|(
name|which
operator|&
name|ALKED
condition|)
name|which
operator||=
name|CLKED
expr_stmt|;
else|else
name|which
operator|&=
operator|~
name|CLKED
expr_stmt|;
block|}
name|s
operator|=
name|spltty
argument_list|()
expr_stmt|;
name|kbd_cmd
argument_list|(
name|KB_SETLEDS
argument_list|)
expr_stmt|;
name|kbd_cmd
argument_list|(
name|xlate_leds
index|[
name|which
operator|&
name|LED_MASK
index|]
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * scgetc(noblock) - get character from keyboard.   * If noblock = 0 wait until a key is pressed.  * Else return NOKEY.  */
end_comment

begin_function
name|u_int
name|scgetc
parameter_list|(
name|int
name|noblock
parameter_list|)
block|{
name|u_char
name|scancode
decl_stmt|,
name|keycode
decl_stmt|;
name|u_int
name|state
decl_stmt|,
name|action
decl_stmt|;
name|struct
name|key_t
modifier|*
name|key
decl_stmt|;
specifier|static
name|u_char
name|esc_flag
init|=
literal|0
decl_stmt|,
name|compose
init|=
literal|0
decl_stmt|;
specifier|static
name|u_int
name|chr
init|=
literal|0
decl_stmt|;
name|next_code
label|:
name|kbd_wait
argument_list|()
expr_stmt|;
comment|/* First see if there is something in the keyboard port */
if|if
condition|(
name|inb
argument_list|(
name|KB_STAT
argument_list|)
operator|&
name|KB_BUF_FULL
condition|)
name|scancode
operator|=
name|inb
argument_list|(
name|KB_DATA
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|noblock
condition|)
return|return
operator|(
name|NOKEY
operator|)
return|;
else|else
goto|goto
name|next_code
goto|;
if|if
condition|(
name|cur_console
operator|->
name|status
operator|&
name|KBD_RAW_MODE
condition|)
return|return
name|scancode
return|;
if|#
directive|if
name|ASYNCH
if|if
condition|(
name|scancode
operator|==
name|KB_ACK
operator|||
name|scancode
operator|==
name|KB_RESEND
condition|)
block|{
name|kbd_reply
operator|=
name|scancode
expr_stmt|;
if|if
condition|(
name|noblock
condition|)
return|return
operator|(
name|NOKEY
operator|)
return|;
goto|goto
name|next_code
goto|;
block|}
endif|#
directive|endif
name|keycode
operator|=
name|scancode
operator|&
literal|0x7F
expr_stmt|;
switch|switch
condition|(
name|esc_flag
condition|)
block|{
case|case
literal|0x00
case|:
comment|/* normal scancode */
switch|switch
condition|(
name|scancode
condition|)
block|{
case|case
literal|0xB8
case|:
comment|/* left alt  (compose key) */
if|if
condition|(
name|compose
condition|)
block|{
name|compose
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|chr
operator|>
literal|255
condition|)
block|{
name|sysbeep
argument_list|(
name|BELL_PITCH
argument_list|,
name|BELL_DURATION
argument_list|)
expr_stmt|;
name|chr
operator|=
literal|0
expr_stmt|;
block|}
block|}
break|break;
case|case
literal|0x38
case|:
if|if
condition|(
operator|!
name|compose
condition|)
block|{
name|compose
operator|=
literal|1
expr_stmt|;
name|chr
operator|=
literal|0
expr_stmt|;
block|}
break|break;
case|case
literal|0xE0
case|:
case|case
literal|0xE1
case|:
name|esc_flag
operator|=
name|scancode
expr_stmt|;
goto|goto
name|next_code
goto|;
block|}
break|break;
case|case
literal|0xE0
case|:
comment|/* 0xE0 prefix */
name|esc_flag
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|keycode
condition|)
block|{
case|case
literal|0x1C
case|:
comment|/* right enter key */
name|keycode
operator|=
literal|0x59
expr_stmt|;
break|break;
case|case
literal|0x1D
case|:
comment|/* right ctrl key */
name|keycode
operator|=
literal|0x5A
expr_stmt|;
break|break;
case|case
literal|0x35
case|:
comment|/* keypad divide key */
name|keycode
operator|=
literal|0x5B
expr_stmt|;
break|break;
case|case
literal|0x37
case|:
comment|/* print scrn key */
name|keycode
operator|=
literal|0x5C
expr_stmt|;
break|break;
case|case
literal|0x38
case|:
comment|/* right alt key (alt gr) */
name|keycode
operator|=
literal|0x5D
expr_stmt|;
break|break;
case|case
literal|0x47
case|:
comment|/* grey home key */
name|keycode
operator|=
literal|0x5E
expr_stmt|;
break|break;
case|case
literal|0x48
case|:
comment|/* grey up arrow key */
name|keycode
operator|=
literal|0x5F
expr_stmt|;
break|break;
case|case
literal|0x49
case|:
comment|/* grey page up key */
name|keycode
operator|=
literal|0x60
expr_stmt|;
break|break;
case|case
literal|0x4B
case|:
comment|/* grey left arrow key */
name|keycode
operator|=
literal|0x61
expr_stmt|;
break|break;
case|case
literal|0x4D
case|:
comment|/* grey right arrow key */
name|keycode
operator|=
literal|0x62
expr_stmt|;
break|break;
case|case
literal|0x4F
case|:
comment|/* grey end key */
name|keycode
operator|=
literal|0x63
expr_stmt|;
break|break;
case|case
literal|0x50
case|:
comment|/* grey down arrow key */
name|keycode
operator|=
literal|0x64
expr_stmt|;
break|break;
case|case
literal|0x51
case|:
comment|/* grey page down key */
name|keycode
operator|=
literal|0x65
expr_stmt|;
break|break;
case|case
literal|0x52
case|:
comment|/* grey insert key */
name|keycode
operator|=
literal|0x66
expr_stmt|;
break|break;
case|case
literal|0x53
case|:
comment|/* grey delete key */
name|keycode
operator|=
literal|0x67
expr_stmt|;
break|break;
default|default:
comment|/* ignore everything else */
goto|goto
name|next_code
goto|;
block|}
break|break;
case|case
literal|0xE1
case|:
comment|/* 0xE1 prefix */
name|esc_flag
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|keycode
operator|==
literal|0x1D
condition|)
name|esc_flag
operator|=
literal|0x1D
expr_stmt|;
goto|goto
name|next_code
goto|;
comment|/* NOT REACHED */
case|case
literal|0x1D
case|:
comment|/* pause / break */
name|esc_flag
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|keycode
operator|!=
literal|0x45
condition|)
goto|goto
name|next_code
goto|;
name|keycode
operator|=
literal|0x68
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|compose
condition|)
block|{
switch|switch
condition|(
name|scancode
condition|)
block|{
comment|/* key pressed process it */
case|case
literal|0x47
case|:
case|case
literal|0x48
case|:
case|case
literal|0x49
case|:
comment|/* keypad 7,8,9 */
name|chr
operator|=
operator|(
name|scancode
operator|-
literal|0x40
operator|)
operator|+
name|chr
operator|*
literal|10
expr_stmt|;
goto|goto
name|next_code
goto|;
case|case
literal|0x4B
case|:
case|case
literal|0x4C
case|:
case|case
literal|0x4D
case|:
comment|/* keypad 4,5,6 */
name|chr
operator|=
operator|(
name|scancode
operator|-
literal|0x47
operator|)
operator|+
name|chr
operator|*
literal|10
expr_stmt|;
goto|goto
name|next_code
goto|;
case|case
literal|0x4F
case|:
case|case
literal|0x50
case|:
case|case
literal|0x51
case|:
comment|/* keypad 1,2,3 */
name|chr
operator|=
operator|(
name|scancode
operator|-
literal|0x4E
operator|)
operator|+
name|chr
operator|*
literal|10
expr_stmt|;
goto|goto
name|next_code
goto|;
case|case
literal|0x52
case|:
comment|/* keypad 0 */
name|chr
operator|*=
literal|10
expr_stmt|;
goto|goto
name|next_code
goto|;
comment|/* key release, no interest here */
case|case
literal|0xC7
case|:
case|case
literal|0xC8
case|:
case|case
literal|0xC9
case|:
comment|/* keypad 7,8,9 */
case|case
literal|0xCB
case|:
case|case
literal|0xCC
case|:
case|case
literal|0xCD
case|:
comment|/* keypad 4,5,6 */
case|case
literal|0xCF
case|:
case|case
literal|0xD0
case|:
case|case
literal|0xD1
case|:
comment|/* keypad 1,2,3 */
case|case
literal|0xD2
case|:
comment|/* keypad 0 */
goto|goto
name|next_code
goto|;
case|case
literal|0x38
case|:
comment|/* left alt key */
break|break;
default|default:
if|if
condition|(
name|chr
condition|)
block|{
name|compose
operator|=
name|chr
operator|=
literal|0
expr_stmt|;
name|sysbeep
argument_list|(
name|BELL_PITCH
argument_list|,
name|BELL_DURATION
argument_list|)
expr_stmt|;
goto|goto
name|next_code
goto|;
block|}
break|break;
block|}
block|}
name|state
operator|=
operator|(
name|shfts
condition|?
literal|1
else|:
literal|0
operator|)
operator||
operator|(
literal|2
operator|*
operator|(
name|ctls
condition|?
literal|1
else|:
literal|0
operator|)
operator|)
operator||
operator|(
literal|4
operator|*
operator|(
name|alts
condition|?
literal|1
else|:
literal|0
operator|)
operator|)
expr_stmt|;
if|if
condition|(
operator|(
operator|!
name|agrs
operator|&&
operator|(
name|cur_console
operator|->
name|status
operator|&
name|ALKED
operator|)
operator|)
operator|||
operator|(
name|agrs
operator|&&
operator|!
operator|(
name|cur_console
operator|->
name|status
operator|&
name|ALKED
operator|)
operator|)
condition|)
name|keycode
operator|+=
name|ALTGR_OFFSET
expr_stmt|;
name|key
operator|=
operator|&
name|key_map
operator|.
name|key
index|[
name|keycode
index|]
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|key
operator|->
name|flgs
operator|&
name|FLAG_LOCK_C
operator|)
operator|&&
operator|(
name|cur_console
operator|->
name|status
operator|&
name|CLKED
operator|)
operator|)
operator|||
operator|(
operator|(
name|key
operator|->
name|flgs
operator|&
name|FLAG_LOCK_N
operator|)
operator|&&
operator|(
name|cur_console
operator|->
name|status
operator|&
name|NLKED
operator|)
operator|)
condition|)
name|state
operator|^=
literal|1
expr_stmt|;
comment|/* Check for make/break */
name|action
operator|=
name|key
operator|->
name|map
index|[
name|state
index|]
expr_stmt|;
if|if
condition|(
name|scancode
operator|&
literal|0x80
condition|)
block|{
comment|/* key released */
if|if
condition|(
name|key
operator|->
name|spcl
operator|&
literal|0x80
condition|)
block|{
switch|switch
condition|(
name|action
condition|)
block|{
case|case
name|LSH
case|:
name|shfts
operator|&=
operator|~
literal|1
expr_stmt|;
break|break;
case|case
name|RSH
case|:
name|shfts
operator|&=
operator|~
literal|2
expr_stmt|;
break|break;
case|case
name|LCTR
case|:
name|ctls
operator|&=
operator|~
literal|1
expr_stmt|;
break|break;
case|case
name|RCTR
case|:
name|ctls
operator|&=
operator|~
literal|2
expr_stmt|;
break|break;
case|case
name|LALT
case|:
name|alts
operator|&=
operator|~
literal|1
expr_stmt|;
break|break;
case|case
name|RALT
case|:
name|alts
operator|&=
operator|~
literal|2
expr_stmt|;
break|break;
case|case
name|NLK
case|:
name|nlkcnt
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|CLK
case|:
name|clkcnt
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|SLK
case|:
name|slkcnt
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|ASH
case|:
name|agrs
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|ALK
case|:
name|alkcnt
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|META
case|:
name|metas
operator|=
literal|0
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|chr
operator|&&
operator|!
name|compose
condition|)
block|{
name|action
operator|=
name|chr
expr_stmt|;
name|chr
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|action
operator|)
return|;
block|}
block|}
else|else
block|{
comment|/* key pressed */
if|if
condition|(
name|key
operator|->
name|spcl
operator|&
operator|(
literal|0x80
operator|>>
name|state
operator|)
condition|)
block|{
switch|switch
condition|(
name|action
condition|)
block|{
comment|/* LOCKING KEYS */
case|case
name|NLK
case|:
if|if
condition|(
operator|!
name|nlkcnt
condition|)
block|{
name|nlkcnt
operator|++
expr_stmt|;
if|if
condition|(
name|cur_console
operator|->
name|status
operator|&
name|NLKED
condition|)
name|cur_console
operator|->
name|status
operator|&=
operator|~
name|NLKED
expr_stmt|;
else|else
name|cur_console
operator|->
name|status
operator||=
name|NLKED
expr_stmt|;
name|update_leds
argument_list|(
name|cur_console
operator|->
name|status
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|CLK
case|:
if|if
condition|(
operator|!
name|clkcnt
condition|)
block|{
name|clkcnt
operator|++
expr_stmt|;
if|if
condition|(
name|cur_console
operator|->
name|status
operator|&
name|CLKED
condition|)
name|cur_console
operator|->
name|status
operator|&=
operator|~
name|CLKED
expr_stmt|;
else|else
name|cur_console
operator|->
name|status
operator||=
name|CLKED
expr_stmt|;
name|update_leds
argument_list|(
name|cur_console
operator|->
name|status
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SLK
case|:
if|if
condition|(
operator|!
name|slkcnt
condition|)
block|{
name|slkcnt
operator|++
expr_stmt|;
if|if
condition|(
name|cur_console
operator|->
name|status
operator|&
name|SLKED
condition|)
block|{
name|cur_console
operator|->
name|status
operator|&=
operator|~
name|SLKED
expr_stmt|;
name|pcstart
argument_list|(
name|VIRTUAL_TTY
argument_list|(
name|get_scr_num
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|cur_console
operator|->
name|status
operator||=
name|SLKED
expr_stmt|;
name|update_leds
argument_list|(
name|cur_console
operator|->
name|status
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|ALK
case|:
if|if
condition|(
operator|!
name|alkcnt
condition|)
block|{
name|alkcnt
operator|++
expr_stmt|;
if|if
condition|(
name|cur_console
operator|->
name|status
operator|&
name|ALKED
condition|)
name|cur_console
operator|->
name|status
operator|&=
operator|~
name|ALKED
expr_stmt|;
else|else
name|cur_console
operator|->
name|status
operator||=
name|ALKED
expr_stmt|;
name|update_leds
argument_list|(
name|cur_console
operator|->
name|status
argument_list|)
expr_stmt|;
block|}
break|break;
comment|/* NON-LOCKING KEYS */
case|case
name|NOP
case|:
break|break;
case|case
name|RBT
case|:
name|shutdown_nice
argument_list|()
expr_stmt|;
break|break;
case|case
name|SUSP
case|:
break|break;
case|case
name|DBG
case|:
ifdef|#
directive|ifdef
name|DDB
comment|/* try to switch to console 0 */
if|if
condition|(
name|cur_console
operator|->
name|smode
operator|.
name|mode
operator|==
name|VT_AUTO
operator|&&
name|console
index|[
literal|0
index|]
operator|.
name|smode
operator|.
name|mode
operator|==
name|VT_AUTO
condition|)
name|switch_scr
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|Debugger
argument_list|(
literal|"manual escape to debugger"
argument_list|)
expr_stmt|;
return|return
operator|(
name|NOKEY
operator|)
return|;
else|#
directive|else
name|printf
argument_list|(
literal|"No debugger in kernel\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
name|LSH
case|:
name|shfts
operator||=
literal|1
expr_stmt|;
break|break;
case|case
name|RSH
case|:
name|shfts
operator||=
literal|2
expr_stmt|;
break|break;
case|case
name|LCTR
case|:
name|ctls
operator||=
literal|1
expr_stmt|;
break|break;
case|case
name|RCTR
case|:
name|ctls
operator||=
literal|2
expr_stmt|;
break|break;
case|case
name|LALT
case|:
name|alts
operator||=
literal|1
expr_stmt|;
break|break;
case|case
name|RALT
case|:
name|alts
operator||=
literal|2
expr_stmt|;
break|break;
case|case
name|ASH
case|:
name|agrs
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|META
case|:
name|metas
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|NEXT
case|:
name|switch_scr
argument_list|(
operator|(
name|get_scr_num
argument_list|()
operator|+
literal|1
operator|)
operator|%
name|NCONS
argument_list|)
expr_stmt|;
break|break;
default|default:
if|if
condition|(
name|action
operator|>=
name|F_SCR
operator|&&
name|action
operator|<=
name|L_SCR
condition|)
block|{
name|switch_scr
argument_list|(
name|action
operator|-
name|F_SCR
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|action
operator|>=
name|F_FN
operator|&&
name|action
operator|<=
name|L_FN
condition|)
name|action
operator||=
name|FKEY
expr_stmt|;
return|return
operator|(
name|action
operator|)
return|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|metas
condition|)
name|action
operator||=
name|MKEY
expr_stmt|;
return|return
operator|(
name|action
operator|)
return|;
block|}
block|}
goto|goto
name|next_code
goto|;
block|}
end_function

begin_function
name|int
name|getchar
parameter_list|(
name|void
parameter_list|)
block|{
name|u_char
name|thechar
decl_stmt|;
name|int
name|s
decl_stmt|;
name|polling
operator|=
literal|1
expr_stmt|;
name|s
operator|=
name|splhigh
argument_list|()
expr_stmt|;
name|scput
argument_list|(
literal|'>'
argument_list|)
expr_stmt|;
name|thechar
operator|=
operator|(
name|u_char
operator|)
name|scgetc
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|polling
operator|=
literal|0
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|thechar
condition|)
block|{
default|default:
if|if
condition|(
name|thechar
operator|>=
name|scr_map
index|[
literal|0x20
index|]
condition|)
name|scput
argument_list|(
name|thechar
argument_list|)
expr_stmt|;
return|return
operator|(
name|thechar
operator|)
return|;
case|case
name|cr
case|:
case|case
name|lf
case|:
name|scput
argument_list|(
name|cr
argument_list|)
expr_stmt|;
name|scput
argument_list|(
name|lf
argument_list|)
expr_stmt|;
return|return
operator|(
name|lf
operator|)
return|;
case|case
name|bs
case|:
case|case
name|del
case|:
name|scput
argument_list|(
name|bs
argument_list|)
expr_stmt|;
name|scput
argument_list|(
name|scr_map
index|[
literal|0x20
index|]
argument_list|)
expr_stmt|;
name|scput
argument_list|(
name|bs
argument_list|)
expr_stmt|;
return|return
operator|(
name|thechar
operator|)
return|;
case|case
name|cntld
case|:
name|scput
argument_list|(
literal|'^'
argument_list|)
expr_stmt|;
name|scput
argument_list|(
literal|'D'
argument_list|)
expr_stmt|;
name|scput
argument_list|(
literal|'\r'
argument_list|)
expr_stmt|;
name|scput
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
end_function

begin_function
name|int
name|pcmmap
parameter_list|(
name|dev_t
name|dev
parameter_list|,
name|int
name|offset
parameter_list|,
name|int
name|nprot
parameter_list|)
block|{
if|if
condition|(
name|offset
operator|>
literal|0x20000
condition|)
return|return
name|EINVAL
return|;
return|return
name|i386_btop
argument_list|(
operator|(
name|VIDEOMEM
operator|+
name|offset
operator|)
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|kbd_wait
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|i
init|=
literal|1000
decl_stmt|;
while|while
condition|(
name|i
operator|--
condition|)
block|{
if|if
condition|(
operator|(
name|inb
argument_list|(
name|KB_STAT
argument_list|)
operator|&
name|KB_READY
operator|)
operator|==
literal|0
condition|)
break|break;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|kbd_cmd
parameter_list|(
name|u_char
name|command
parameter_list|)
block|{
name|int
name|retry
init|=
literal|5
decl_stmt|;
do|do
block|{
name|int
name|i
init|=
literal|100000
decl_stmt|;
name|kbd_wait
argument_list|()
expr_stmt|;
if|#
directive|if
name|ASYNCH
name|kbd_reply
operator|=
literal|0
expr_stmt|;
name|outb
argument_list|(
name|KB_DATA
argument_list|,
name|command
argument_list|)
expr_stmt|;
while|while
condition|(
name|i
operator|--
condition|)
block|{
if|if
condition|(
name|kbd_reply
operator|==
name|KB_ACK
condition|)
return|return;
if|if
condition|(
name|kbd_reply
operator|==
name|KB_RESEND
condition|)
break|break;
block|}
else|#
directive|else
name|outb
argument_list|(
name|KB_DATA
argument_list|,
name|command
argument_list|)
expr_stmt|;
while|while
condition|(
name|i
operator|--
condition|)
block|{
if|if
condition|(
name|inb
argument_list|(
name|KB_STAT
argument_list|)
operator|&
name|KB_BUF_FULL
condition|)
block|{
name|int
name|val
decl_stmt|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|val
operator|=
name|inb
argument_list|(
name|KB_DATA
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|==
name|KB_ACK
condition|)
return|return;
if|if
condition|(
name|val
operator|==
name|KB_RESEND
condition|)
break|break;
block|}
block|}
endif|#
directive|endif
block|}
do|while
condition|(
name|retry
operator|--
condition|)
do|;
block|}
end_function

begin_function
specifier|static
name|void
name|set_mode
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|)
block|{
name|char
modifier|*
name|modetable
decl_stmt|;
name|char
name|special_modetable
index|[
literal|64
index|]
decl_stmt|;
name|int
name|mode
decl_stmt|,
name|font_size
decl_stmt|;
if|if
condition|(
name|scp
operator|!=
name|cur_console
condition|)
return|return;
comment|/* mode change only on VGA's */
if|if
condition|(
operator|!
name|crtc_vga
operator|||
name|video_mode_ptr
operator|==
name|NULL
condition|)
block|{
comment|/* (re)activate cursor */
name|untimeout
argument_list|(
operator|(
name|timeout_t
operator|)
name|cursor_pos
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|cursor_pos
argument_list|(
literal|1
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* setup video hardware for the given mode */
switch|switch
condition|(
name|scp
operator|->
name|mode
condition|)
block|{
case|case
name|M_VGA_C80x50
case|:
name|bcopy
argument_list|(
name|video_mode_ptr
operator|+
operator|(
literal|64
operator|*
name|M_VGA_C80x25
operator|)
argument_list|,
operator|&
name|special_modetable
argument_list|,
literal|64
argument_list|)
expr_stmt|;
name|special_modetable
index|[
literal|2
index|]
operator|=
literal|8
expr_stmt|;
name|special_modetable
index|[
literal|19
index|]
operator|=
literal|7
expr_stmt|;
name|modetable
operator|=
name|special_modetable
expr_stmt|;
goto|goto
name|setup_mode
goto|;
case|case
name|M_VGA_M80x50
case|:
name|bcopy
argument_list|(
name|video_mode_ptr
operator|+
operator|(
literal|64
operator|*
name|M_VGA_M80x25
operator|)
argument_list|,
operator|&
name|special_modetable
argument_list|,
literal|64
argument_list|)
expr_stmt|;
name|special_modetable
index|[
literal|2
index|]
operator|=
literal|8
expr_stmt|;
name|special_modetable
index|[
literal|19
index|]
operator|=
literal|7
expr_stmt|;
name|modetable
operator|=
name|special_modetable
expr_stmt|;
goto|goto
name|setup_mode
goto|;
case|case
name|M_ENH_B80x43
case|:
name|bcopy
argument_list|(
name|video_mode_ptr
operator|+
operator|(
literal|64
operator|*
name|M_ENH_B80x25
operator|)
argument_list|,
operator|&
name|special_modetable
argument_list|,
literal|64
argument_list|)
expr_stmt|;
name|special_modetable
index|[
literal|2
index|]
operator|=
literal|8
expr_stmt|;
name|special_modetable
index|[
literal|19
index|]
operator|=
literal|7
expr_stmt|;
name|special_modetable
index|[
literal|28
index|]
operator|=
literal|87
expr_stmt|;
name|modetable
operator|=
name|special_modetable
expr_stmt|;
goto|goto
name|setup_mode
goto|;
case|case
name|M_ENH_C80x43
case|:
name|bcopy
argument_list|(
name|video_mode_ptr
operator|+
operator|(
literal|64
operator|*
name|M_ENH_C80x25
operator|)
argument_list|,
operator|&
name|special_modetable
argument_list|,
literal|64
argument_list|)
expr_stmt|;
name|special_modetable
index|[
literal|2
index|]
operator|=
literal|8
expr_stmt|;
name|special_modetable
index|[
literal|19
index|]
operator|=
literal|7
expr_stmt|;
name|special_modetable
index|[
literal|28
index|]
operator|=
literal|87
expr_stmt|;
name|modetable
operator|=
name|special_modetable
expr_stmt|;
goto|goto
name|setup_mode
goto|;
case|case
name|M_VGA_C40x25
case|:
case|case
name|M_VGA_C80x25
case|:
comment|/* VGA TEXT MODES */
case|case
name|M_VGA_M80x25
case|:
case|case
name|M_B40x25
case|:
case|case
name|M_C40x25
case|:
case|case
name|M_B80x25
case|:
case|case
name|M_C80x25
case|:
case|case
name|M_ENH_B40x25
case|:
case|case
name|M_ENH_C40x25
case|:
case|case
name|M_ENH_B80x25
case|:
case|case
name|M_ENH_C80x25
case|:
name|modetable
operator|=
name|video_mode_ptr
operator|+
operator|(
name|scp
operator|->
name|mode
operator|*
literal|64
operator|)
expr_stmt|;
name|setup_mode
label|:
name|set_vgaregs
argument_list|(
name|modetable
argument_list|)
expr_stmt|;
name|font_size
operator|=
operator|*
operator|(
name|modetable
operator|+
literal|2
operator|)
expr_stmt|;
comment|/* change cursor type if set */
if|if
condition|(
name|scp
operator|->
name|cursor_start
operator|!=
operator|-
literal|1
operator|&&
name|scp
operator|->
name|cursor_end
operator|!=
operator|-
literal|1
condition|)
name|cursor_shape
argument_list|(
operator|(
name|scp
operator|->
name|cursor_start
operator|>=
name|font_size
operator|)
condition|?
name|font_size
operator|-
literal|1
else|:
name|scp
operator|->
name|cursor_start
argument_list|,
operator|(
name|scp
operator|->
name|cursor_end
operator|>=
name|font_size
operator|)
condition|?
name|font_size
operator|-
literal|1
else|:
name|scp
operator|->
name|cursor_end
argument_list|)
expr_stmt|;
comment|/* set font type (size) */
switch|switch
condition|(
name|font_size
condition|)
block|{
case|case
literal|0x08
case|:
name|outb
argument_list|(
name|TSIDX
argument_list|,
literal|0x03
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|TSREG
argument_list|,
literal|0x05
argument_list|)
expr_stmt|;
comment|/* font 1 */
break|break;
case|case
literal|0x0E
case|:
name|outb
argument_list|(
name|TSIDX
argument_list|,
literal|0x03
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|TSREG
argument_list|,
literal|0x0A
argument_list|)
expr_stmt|;
comment|/* font 2 */
break|break;
case|case
literal|0x10
case|:
name|outb
argument_list|(
name|TSIDX
argument_list|,
literal|0x03
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|TSREG
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
comment|/* font 0 */
break|break;
default|default:
name|outb
argument_list|(
name|TSIDX
argument_list|,
literal|0x03
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|TSREG
argument_list|,
literal|0x05
argument_list|)
expr_stmt|;
comment|/* font 1 */
block|}
comment|/* (re)activate cursor */
name|untimeout
argument_list|(
operator|(
name|timeout_t
operator|)
name|cursor_pos
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|cursor_pos
argument_list|(
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|M_BG320
case|:
case|case
name|M_CG320
case|:
case|case
name|M_BG640
case|:
case|case
name|M_CG320_D
case|:
case|case
name|M_CG640_E
case|:
case|case
name|M_CG640x350
case|:
case|case
name|M_ENH_CG640
case|:
case|case
name|M_BG640x480
case|:
case|case
name|M_CG640x480
case|:
case|case
name|M_VGA_CG320
case|:
name|set_vgaregs
argument_list|(
name|video_mode_ptr
operator|+
operator|(
name|scp
operator|->
name|mode
operator|*
literal|64
operator|)
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|/* call user defined function XXX */
break|break;
block|}
comment|/* set border color for this (virtual) console */
name|set_border
argument_list|(
name|scp
operator|->
name|border
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|set_border
parameter_list|(
name|int
name|color
parameter_list|)
block|{
name|inb
argument_list|(
name|crtc_addr
operator|+
literal|6
argument_list|)
expr_stmt|;
comment|/* reset flip-flop */
name|outb
argument_list|(
name|ATC
argument_list|,
literal|0x11
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|ATC
argument_list|,
name|color
argument_list|)
expr_stmt|;
name|inb
argument_list|(
name|crtc_addr
operator|+
literal|6
argument_list|)
expr_stmt|;
comment|/* reset flip-flop */
name|outb
argument_list|(
name|ATC
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
comment|/* enable Palette */
block|}
end_function

begin_function
specifier|static
name|void
name|set_vgaregs
parameter_list|(
name|char
modifier|*
name|modetable
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|s
init|=
name|splhigh
argument_list|()
decl_stmt|;
name|outb
argument_list|(
name|TSIDX
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|TSREG
argument_list|,
literal|0x01
argument_list|)
expr_stmt|;
comment|/* stop sequencer */
name|outb
argument_list|(
name|TSIDX
argument_list|,
literal|0x07
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|TSREG
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
comment|/* unlock registers */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
comment|/* program sequencer */
name|outb
argument_list|(
name|TSIDX
argument_list|,
name|i
operator|+
literal|1
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|TSREG
argument_list|,
name|modetable
index|[
name|i
operator|+
literal|5
index|]
argument_list|)
expr_stmt|;
block|}
name|outb
argument_list|(
name|MISC
argument_list|,
name|modetable
index|[
literal|9
index|]
argument_list|)
expr_stmt|;
comment|/* set dot-clock */
name|outb
argument_list|(
name|TSIDX
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|TSREG
argument_list|,
literal|0x03
argument_list|)
expr_stmt|;
comment|/* start sequencer */
name|outb
argument_list|(
name|crtc_addr
argument_list|,
literal|0x11
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|crtc_addr
operator|+
literal|1
argument_list|,
name|inb
argument_list|(
name|crtc_addr
operator|+
literal|1
argument_list|)
operator|&
literal|0x7F
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|25
condition|;
name|i
operator|++
control|)
block|{
comment|/* program crtc */
name|outb
argument_list|(
name|crtc_addr
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|crtc_addr
operator|+
literal|1
argument_list|,
name|modetable
index|[
name|i
operator|+
literal|10
index|]
argument_list|)
expr_stmt|;
block|}
name|inb
argument_list|(
name|crtc_addr
operator|+
literal|6
argument_list|)
expr_stmt|;
comment|/* reset flip-flop */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|20
condition|;
name|i
operator|++
control|)
block|{
comment|/* program attribute ctrl */
name|outb
argument_list|(
name|ATC
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|ATC
argument_list|,
name|modetable
index|[
name|i
operator|+
literal|35
index|]
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|9
condition|;
name|i
operator|++
control|)
block|{
comment|/* program graph data ctrl */
name|outb
argument_list|(
name|GDCIDX
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|GDCREG
argument_list|,
name|modetable
index|[
name|i
operator|+
literal|55
index|]
argument_list|)
expr_stmt|;
block|}
name|inb
argument_list|(
name|crtc_addr
operator|+
literal|6
argument_list|)
expr_stmt|;
comment|/* reset flip-flop */
name|outb
argument_list|(
name|ATC
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
comment|/* enable palette */
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|copy_font
parameter_list|(
name|int
name|direction
parameter_list|,
name|int
name|segment
parameter_list|,
name|int
name|size
parameter_list|,
name|char
modifier|*
name|font
parameter_list|)
block|{
name|int
name|ch
decl_stmt|,
name|line
decl_stmt|,
name|s
decl_stmt|;
name|u_char
name|val
decl_stmt|;
name|outb
argument_list|(
name|TSIDX
argument_list|,
literal|0x01
argument_list|)
expr_stmt|;
name|val
operator|=
name|inb
argument_list|(
name|TSREG
argument_list|)
expr_stmt|;
comment|/* blank screen */
name|outb
argument_list|(
name|TSIDX
argument_list|,
literal|0x01
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|TSREG
argument_list|,
name|val
operator||
literal|0x20
argument_list|)
expr_stmt|;
comment|/* setup vga for loading fonts (graphics plane mode) */
name|inb
argument_list|(
name|crtc_addr
operator|+
literal|6
argument_list|)
expr_stmt|;
comment|/* reset flip/flop */
name|outb
argument_list|(
name|ATC
argument_list|,
literal|0x30
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|ATC
argument_list|,
literal|0x01
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|TSIDX
argument_list|,
literal|0x02
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|TSREG
argument_list|,
literal|0x04
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|TSIDX
argument_list|,
literal|0x04
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|TSREG
argument_list|,
literal|0x06
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|GDCIDX
argument_list|,
literal|0x04
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|GDCREG
argument_list|,
literal|0x02
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|GDCIDX
argument_list|,
literal|0x05
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|GDCREG
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|GDCIDX
argument_list|,
literal|0x06
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|GDCREG
argument_list|,
literal|0x05
argument_list|)
expr_stmt|;
comment|/* addr = a0000, 64kb */
for|for
control|(
name|ch
operator|=
literal|0
init|;
name|ch
operator|<
literal|256
condition|;
name|ch
operator|++
control|)
for|for
control|(
name|line
operator|=
literal|0
init|;
name|line
operator|<
name|size
condition|;
name|line
operator|++
control|)
if|if
condition|(
name|direction
condition|)
operator|*
operator|(
name|char
operator|*
operator|)
name|pa_to_va
argument_list|(
name|VIDEOMEM
operator|+
operator|(
name|segment
operator|*
literal|0x4000
operator|)
operator|+
operator|(
name|ch
operator|*
literal|32
operator|)
operator|+
name|line
argument_list|)
operator|=
name|font
index|[
operator|(
name|ch
operator|*
name|size
operator|)
operator|+
name|line
index|]
expr_stmt|;
else|else
name|font
index|[
operator|(
name|ch
operator|*
name|size
operator|)
operator|+
name|line
index|]
operator|=
operator|*
operator|(
name|char
operator|*
operator|)
name|pa_to_va
argument_list|(
name|VIDEOMEM
operator|+
operator|(
name|segment
operator|*
literal|0x4000
operator|)
operator|+
operator|(
name|ch
operator|*
literal|32
operator|)
operator|+
name|line
argument_list|)
expr_stmt|;
comment|/* setup vga for text mode again */
name|s
operator|=
name|splhigh
argument_list|()
expr_stmt|;
name|inb
argument_list|(
name|crtc_addr
operator|+
literal|6
argument_list|)
expr_stmt|;
comment|/* reset flip/flop */
name|outb
argument_list|(
name|ATC
argument_list|,
literal|0x30
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|ATC
argument_list|,
literal|0x0C
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|TSIDX
argument_list|,
literal|0x02
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|TSREG
argument_list|,
literal|0x03
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|TSIDX
argument_list|,
literal|0x04
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|TSREG
argument_list|,
literal|0x02
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|GDCIDX
argument_list|,
literal|0x04
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|GDCREG
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|GDCIDX
argument_list|,
literal|0x05
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|GDCREG
argument_list|,
literal|0x10
argument_list|)
expr_stmt|;
if|if
condition|(
name|crtc_addr
operator|==
name|MONO_BASE
condition|)
block|{
name|outb
argument_list|(
name|GDCIDX
argument_list|,
literal|0x06
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|GDCREG
argument_list|,
literal|0x0A
argument_list|)
expr_stmt|;
comment|/* addr = b0000, 32kb */
block|}
else|else
block|{
name|outb
argument_list|(
name|GDCIDX
argument_list|,
literal|0x06
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|GDCREG
argument_list|,
literal|0x0E
argument_list|)
expr_stmt|;
comment|/* addr = b8000, 32kb */
block|}
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|TSIDX
argument_list|,
literal|0x01
argument_list|)
expr_stmt|;
name|val
operator|=
name|inb
argument_list|(
name|TSREG
argument_list|)
expr_stmt|;
comment|/* unblank screen */
name|outb
argument_list|(
name|TSIDX
argument_list|,
literal|0x01
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|TSREG
argument_list|,
name|val
operator|&
literal|0xDF
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|load_palette
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|outb
argument_list|(
name|PIXMASK
argument_list|,
literal|0xFF
argument_list|)
expr_stmt|;
comment|/* no pixelmask */
name|outb
argument_list|(
name|PALWADR
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0x00
init|;
name|i
operator|<
literal|0x300
condition|;
name|i
operator|++
control|)
name|outb
argument_list|(
name|PALDATA
argument_list|,
name|palette
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|inb
argument_list|(
name|crtc_addr
operator|+
literal|6
argument_list|)
expr_stmt|;
comment|/* reset flip/flop */
name|outb
argument_list|(
name|ATC
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
comment|/* enable palette */
block|}
end_function

begin_function
specifier|static
name|void
name|save_palette
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|outb
argument_list|(
name|PALRADR
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0x00
init|;
name|i
operator|<
literal|0x300
condition|;
name|i
operator|++
control|)
name|palette
index|[
name|i
index|]
operator|=
name|inb
argument_list|(
name|PALDATA
argument_list|)
expr_stmt|;
name|inb
argument_list|(
name|crtc_addr
operator|+
literal|6
argument_list|)
expr_stmt|;
comment|/* reset flip/flop */
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* NSC */
end_comment

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Low-level subroutines for Cronyx-Sigma adapter.  *  * Copyright (C) 1994-95 Cronyx Ltd.  * Author: Serge Vakulenko,<vak@cronyx.ru>  *  * This software is distributed with NO WARRANTIES, not even the implied  * warranties for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  *  * Authors grant any other persons or organisations permission to use  * or modify this software as long as this message is kept with the software,  * all derivative works or modified versions.  *  * Version 1.6, Wed May 31 16:03:20 MSD 1995  * $FreeBSD$  */
end_comment

begin_if
if|#
directive|if
name|defined
argument_list|(
name|MSDOS
argument_list|)
operator|||
name|defined
argument_list|(
name|__MSDOS__
argument_list|)
end_if

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<dos.h>
end_include

begin_define
define|#
directive|define
name|inb
parameter_list|(
name|port
parameter_list|)
value|inportb(port)
end_define

begin_define
define|#
directive|define
name|inw
parameter_list|(
name|port
parameter_list|)
value|inport(port)
end_define

begin_define
define|#
directive|define
name|outb
parameter_list|(
name|port
parameter_list|,
name|b
parameter_list|)
value|outportb(port,b)
end_define

begin_define
define|#
directive|define
name|outw
parameter_list|(
name|port
parameter_list|,
name|w
parameter_list|)
value|outport(port,w)
end_define

begin_define
define|#
directive|define
name|vtophys
parameter_list|(
name|a
parameter_list|)
value|(((unsigned long)(a)>>12& 0xffff0) +\ 			((unsigned)(a)& 0xffff))
end_define

begin_include
include|#
directive|include
file|"cronyx.h"
end_include

begin_include
include|#
directive|include
file|"cxreg.h"
end_include

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm_param.h>
end_include

begin_include
include|#
directive|include
file|<vm/pmap.h>
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|__FreeBSD__
end_ifndef

begin_include
include|#
directive|include
file|<machine/inline.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<machine/cronyx.h>
end_include

begin_include
include|#
directive|include
file|<i386/isa/cxreg.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|DMA_MASK
value|0xd4
end_define

begin_comment
comment|/* DMA mask register */
end_comment

begin_define
define|#
directive|define
name|DMA_MASK_CLEAR
value|0x04
end_define

begin_comment
comment|/* DMA clear mask */
end_comment

begin_define
define|#
directive|define
name|DMA_MODE
value|0xd6
end_define

begin_comment
comment|/* DMA mode register */
end_comment

begin_define
define|#
directive|define
name|DMA_MODE_MASTER
value|0xc0
end_define

begin_comment
comment|/* DMA master mode */
end_comment

begin_define
define|#
directive|define
name|BYTE
value|*(unsigned char*)&
end_define

begin_decl_stmt
specifier|static
name|unsigned
name|char
name|irqmask
index|[]
init|=
block|{
name|BCR0_IRQ_DIS
block|,
name|BCR0_IRQ_DIS
block|,
name|BCR0_IRQ_DIS
block|,
name|BCR0_IRQ_3
block|,
name|BCR0_IRQ_DIS
block|,
name|BCR0_IRQ_5
block|,
name|BCR0_IRQ_DIS
block|,
name|BCR0_IRQ_7
block|,
name|BCR0_IRQ_DIS
block|,
name|BCR0_IRQ_DIS
block|,
name|BCR0_IRQ_10
block|,
name|BCR0_IRQ_11
block|,
name|BCR0_IRQ_12
block|,
name|BCR0_IRQ_DIS
block|,
name|BCR0_IRQ_DIS
block|,
name|BCR0_IRQ_15
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|char
name|dmamask
index|[]
init|=
block|{
name|BCR0_DMA_DIS
block|,
name|BCR0_DMA_DIS
block|,
name|BCR0_DMA_DIS
block|,
name|BCR0_DMA_DIS
block|,
name|BCR0_DMA_DIS
block|,
name|BCR0_DMA_5
block|,
name|BCR0_DMA_6
block|,
name|BCR0_DMA_7
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|long
name|cx_rxbaud
init|=
name|CX_SPEED_DFLT
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* receiver baud rate */
end_comment

begin_decl_stmt
specifier|static
name|long
name|cx_txbaud
init|=
name|CX_SPEED_DFLT
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* transmitter baud rate */
end_comment

begin_decl_stmt
specifier|static
name|int
name|cx_univ_mode
init|=
name|M_ASYNC
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* univ. chan. mode: async or sync */
end_comment

begin_decl_stmt
specifier|static
name|int
name|cx_sync_mode
init|=
name|M_HDLC
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* sync. chan. mode: HDLC, Bisync or X.21 */
end_comment

begin_decl_stmt
specifier|static
name|int
name|cx_iftype
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* univ. chan. interface: upper/lower */
end_comment

begin_decl_stmt
specifier|static
name|cx_chan_opt_t
name|chan_opt_dflt
init|=
block|{
comment|/* mode-independent options */
block|{
comment|/* cor4 */
literal|7
block|,
comment|/* FIFO threshold, odd is better */
literal|0
block|,
literal|0
block|,
comment|/* don't detect 1 to 0 on CTS */
literal|1
block|,
comment|/* detect 1 to 0 on CD */
literal|0
block|,
comment|/* detect 1 to 0 on DSR */
block|}
block|,
block|{
comment|/* cor5 */
literal|0
block|,
comment|/* receive flow control FIFO threshold */
literal|0
block|,
literal|0
block|,
comment|/* don't detect 0 to 1 on CTS */
literal|1
block|,
comment|/* detect 0 to 1 on CD */
literal|0
block|,
comment|/* detect 0 to 1 on DSR */
block|}
block|,
block|{
comment|/* rcor */
literal|0
block|,
comment|/* dummy clock source */
name|ENCOD_NRZ
block|,
comment|/* NRZ mode */
literal|0
block|,
comment|/* disable DPLL */
literal|0
block|,
literal|0
block|,
comment|/* transmit line value */
block|}
block|,
block|{
comment|/* tcor */
literal|0
block|,
literal|0
block|,
comment|/* local loopback mode */
literal|0
block|,
literal|1
block|,
comment|/* external 1x clock mode */
literal|0
block|,
literal|0
block|,
comment|/* dummy transmit clock source */
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|cx_opt_async_t
name|opt_async_dflt
init|=
block|{
comment|/* default async options */
block|{
comment|/* cor1 */
literal|8
operator|-
literal|1
block|,
comment|/* 8-bit char length */
literal|0
block|,
comment|/* don't ignore parity */
name|PARM_NOPAR
block|,
comment|/* no parity */
name|PAR_EVEN
block|,
comment|/* even parity */
block|}
block|,
block|{
comment|/* cor2 */
literal|0
block|,
comment|/* disable automatic DSR */
literal|1
block|,
comment|/* enable automatic CTS */
literal|0
block|,
comment|/* disable automatic RTS */
literal|0
block|,
comment|/* no remote loopback */
literal|0
block|,
literal|0
block|,
comment|/* disable embedded cmds */
literal|0
block|,
comment|/* disable XON/XOFF */
literal|0
block|,
comment|/* disable XANY */
block|}
block|,
block|{
comment|/* cor3 */
name|STOPB_1
block|,
comment|/* 1 stop bit */
literal|0
block|,
literal|0
block|,
comment|/* disable special char detection */
name|FLOWCC_PASS
block|,
comment|/* pass flow ctl chars to the host */
literal|0
block|,
comment|/* range detect disable */
literal|0
block|,
comment|/* disable extended spec. char detect */
block|}
block|,
block|{
comment|/* cor6 */
name|PERR_INTR
block|,
comment|/* generate exception on parity errors */
name|BRK_INTR
block|,
comment|/* generate exception on break condition */
literal|0
block|,
comment|/* don't translate NL to CR on input */
literal|0
block|,
comment|/* don't translate CR to NL on input */
literal|0
block|,
comment|/* don't discard CR on input */
block|}
block|,
block|{
comment|/* cor7 */
literal|0
block|,
comment|/* don't translate CR to NL on output */
literal|0
block|,
comment|/* don't translate NL to CR on output */
literal|0
block|,
literal|0
block|,
comment|/* don't process flow ctl err chars */
literal|0
block|,
comment|/* disable LNext option */
literal|0
block|,
comment|/* don't strip 8 bit on input */
block|}
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
comment|/* clear schr1-4, scrl, scrh, lnxt */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|cx_opt_hdlc_t
name|opt_hdlc_dflt
init|=
block|{
comment|/* default hdlc options */
block|{
comment|/* cor1 */
literal|2
block|,
comment|/* 2 inter-frame flags */
literal|0
block|,
comment|/* no-address mode */
name|CLRDET_DISABLE
block|,
comment|/* disable clear detect */
name|AFLO_1OCT
block|,
comment|/* 1-byte address field length */
block|}
block|,
block|{
comment|/* cor2 */
literal|0
block|,
comment|/* disable automatic DSR */
literal|0
block|,
comment|/* disable automatic CTS */
literal|0
block|,
comment|/* disable automatic RTS */
literal|0
block|,
name|CRC_INVERT
block|,
comment|/* use CRC V.41 */
literal|0
block|,
name|FCS_NOTPASS
block|,
comment|/* don't pass received CRC to the host */
literal|0
block|, 	}
block|,
block|{
comment|/* cor3 */
literal|0
block|,
comment|/* 0 pad characters sent */
name|IDLE_FLAG
block|,
comment|/* idle in flag */
literal|0
block|,
comment|/* enable FCS */
name|FCSP_ONES
block|,
comment|/* FCS preset to all ones (V.41) */
name|SYNC_AA
block|,
comment|/* use AAh as sync char */
literal|0
block|,
comment|/* disable pad characters */
block|}
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
comment|/* clear rfar1-4 */
name|POLY_V41
block|,
comment|/* use V.41 CRC polynomial */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|cx_opt_bisync_t
name|opt_bisync_dflt
init|=
block|{
comment|/* default bisync options */
block|{
comment|/* cor1 */
literal|8
operator|-
literal|1
block|,
comment|/* 8-bit char length */
literal|0
block|,
comment|/* don't ignore parity */
name|PARM_NOPAR
block|,
comment|/* no parity */
name|PAR_EVEN
block|,
comment|/* even parity */
block|}
block|,
block|{
comment|/* cor2 */
literal|3
operator|-
literal|2
block|,
comment|/* send three SYN chars */
name|CRC_DONT_INVERT
block|,
comment|/* don't invert CRC (CRC-16) */
literal|0
block|,
comment|/* use ASCII, not EBCDIC */
literal|0
block|,
comment|/* disable bcc append */
name|BCC_CRC16
block|,
comment|/* user CRC16, not LRC */
block|}
block|,
block|{
comment|/* cor3 */
literal|0
block|,
comment|/* send 0 pad chars */
name|IDLE_FLAG
block|,
comment|/* idle in SYN */
literal|0
block|,
comment|/* enable FCS */
name|FCSP_ZEROS
block|,
comment|/* FCS preset to all zeros (CRC-16) */
name|PAD_AA
block|,
comment|/* use AAh as pad char */
literal|0
block|,
comment|/* disable pad characters */
block|}
block|,
block|{
comment|/* cor6 */
literal|10
block|,
comment|/* DLE - disable special termination char */
block|}
block|,
name|POLY_16
block|,
comment|/* use CRC-16 polynomial */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|cx_opt_x21_t
name|opt_x21_dflt
init|=
block|{
comment|/* default x21 options */
block|{
comment|/* cor1 */
literal|8
operator|-
literal|1
block|,
comment|/* 8-bit char length */
literal|0
block|,
comment|/* don't ignore parity */
name|PARM_NOPAR
block|,
comment|/* no parity */
name|PAR_EVEN
block|,
comment|/* even parity */
block|}
block|,
block|{
comment|/* cor2 */
literal|0
block|,
literal|0
block|,
comment|/* disable embedded transmitter cmds */
literal|0
block|, 	}
block|,
block|{
comment|/* cor3 */
literal|0
block|,
literal|0
block|,
comment|/* disable special character detect */
literal|0
block|,
comment|/* don't treat SYN as special condition */
literal|0
block|,
comment|/* disable steady state detect */
name|X21SYN_2
block|,
comment|/* 2 SYN chars on receive are required */
block|}
block|,
block|{
comment|/* cor6 */
literal|16
block|,
comment|/* SYN - standard SYN character */
block|}
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
comment|/* clear schr1-3 */
block|}
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|int
name|cx_probe_chip
parameter_list|(
name|int
name|base
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|cx_setup_chip
parameter_list|(
name|cx_chip_t
modifier|*
name|c
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|cx_init_board
parameter_list|(
name|cx_board_t
modifier|*
name|b
parameter_list|,
name|int
name|num
parameter_list|,
name|int
name|port
parameter_list|,
name|int
name|irq
parameter_list|,
name|int
name|dma
parameter_list|,
name|int
name|chain
parameter_list|,
name|int
name|rev
parameter_list|,
name|int
name|osc
parameter_list|,
name|int
name|rev2
parameter_list|,
name|int
name|osc2
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|cx_reinit_board
parameter_list|(
name|cx_board_t
modifier|*
name|b
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * Wait for CCR to clear.  */
end_comment

begin_function
name|void
name|cx_cmd
parameter_list|(
name|int
name|base
parameter_list|,
name|int
name|cmd
parameter_list|)
block|{
name|unsigned
name|short
name|port
init|=
name|CCR
argument_list|(
name|base
argument_list|)
decl_stmt|;
name|unsigned
name|short
name|count
decl_stmt|;
comment|/* Wait 10 msec for the previous command to complete. */
for|for
control|(
name|count
operator|=
literal|0
init|;
name|inb
argument_list|(
name|port
argument_list|)
operator|&&
name|count
operator|<
literal|20000
condition|;
operator|++
name|count
control|)
continue|continue;
comment|/* Issue the command. */
name|outb
argument_list|(
name|port
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
comment|/* Wait 10 msec for the command to complete. */
for|for
control|(
name|count
operator|=
literal|0
init|;
name|inb
argument_list|(
name|port
argument_list|)
operator|&&
name|count
operator|<
literal|20000
condition|;
operator|++
name|count
control|)
continue|continue;
block|}
end_function

begin_comment
comment|/*  * Reset the chip.  */
end_comment

begin_function
specifier|static
name|int
name|cx_reset
parameter_list|(
name|unsigned
name|short
name|port
parameter_list|)
block|{
name|int
name|count
decl_stmt|;
comment|/* Wait up to 10 msec for revision code to appear after reset. */
for|for
control|(
name|count
operator|=
literal|0
init|;
name|count
operator|<
literal|20000
condition|;
operator|++
name|count
control|)
if|if
condition|(
name|inb
argument_list|(
name|GFRCR
argument_list|(
name|port
argument_list|)
argument_list|)
operator|!=
literal|0
condition|)
break|break;
name|cx_cmd
argument_list|(
name|port
argument_list|,
name|CCR_RSTALL
argument_list|)
expr_stmt|;
comment|/* Firmware revision code should clear imediately. */
comment|/* Wait up to 10 msec for revision code to appear again. */
for|for
control|(
name|count
operator|=
literal|0
init|;
name|count
operator|<
literal|20000
condition|;
operator|++
name|count
control|)
if|if
condition|(
name|inb
argument_list|(
name|GFRCR
argument_list|(
name|port
argument_list|)
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
literal|1
operator|)
return|;
comment|/* Reset failed. */
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Check if the CD2400 board is present at the given base port.  */
end_comment

begin_function
specifier|static
name|int
name|cx_probe_chained_board
parameter_list|(
name|int
name|port
parameter_list|,
name|int
modifier|*
name|c0
parameter_list|,
name|int
modifier|*
name|c1
parameter_list|)
block|{
name|int
name|rev
decl_stmt|,
name|i
decl_stmt|;
comment|/* Read and check the board revision code. */
name|rev
operator|=
name|inb
argument_list|(
name|BSR
argument_list|(
name|port
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|c0
operator|=
operator|*
name|c1
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|rev
operator|&
name|BSR_VAR_MASK
condition|)
block|{
case|case
name|CRONYX_100
case|:
operator|*
name|c0
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CRONYX_400
case|:
operator|*
name|c1
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CRONYX_500
case|:
operator|*
name|c0
operator|=
operator|*
name|c1
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CRONYX_410
case|:
operator|*
name|c0
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CRONYX_810
case|:
operator|*
name|c0
operator|=
operator|*
name|c1
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CRONYX_410s
case|:
operator|*
name|c0
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CRONYX_810s
case|:
operator|*
name|c0
operator|=
operator|*
name|c1
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CRONYX_440
case|:
operator|*
name|c0
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CRONYX_840
case|:
operator|*
name|c0
operator|=
operator|*
name|c1
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CRONYX_401
case|:
operator|*
name|c0
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CRONYX_801
case|:
operator|*
name|c0
operator|=
operator|*
name|c1
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CRONYX_401s
case|:
operator|*
name|c0
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CRONYX_801s
case|:
operator|*
name|c0
operator|=
operator|*
name|c1
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CRONYX_404
case|:
operator|*
name|c0
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CRONYX_703
case|:
operator|*
name|c0
operator|=
operator|*
name|c1
operator|=
literal|1
expr_stmt|;
break|break;
default|default:
return|return
operator|(
literal|0
operator|)
return|;
comment|/* invalid variant code */
block|}
switch|switch
condition|(
name|rev
operator|&
name|BSR_OSC_MASK
condition|)
block|{
case|case
name|BSR_OSC_20
case|:
comment|/* 20 MHz */
case|case
name|BSR_OSC_18432
case|:
comment|/* 18.432 MHz */
break|break;
default|default:
return|return
operator|(
literal|0
operator|)
return|;
comment|/* oscillator frequency does not match */
block|}
for|for
control|(
name|i
operator|=
literal|2
init|;
name|i
operator|<
literal|0x10
condition|;
name|i
operator|+=
literal|2
control|)
if|if
condition|(
operator|(
name|inb
argument_list|(
name|BSR
argument_list|(
name|port
argument_list|)
operator|+
name|i
argument_list|)
operator|&
name|BSR_REV_MASK
operator|)
operator|!=
operator|(
name|rev
operator|&
name|BSR_REV_MASK
operator|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* status changed? */
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Check if the CD2400 board is present at the given base port.  */
end_comment

begin_function
name|int
name|cx_probe_board
parameter_list|(
name|int
name|port
parameter_list|)
block|{
name|int
name|c0
decl_stmt|,
name|c1
decl_stmt|,
name|c2
init|=
literal|0
decl_stmt|,
name|c3
init|=
literal|0
decl_stmt|,
name|result
decl_stmt|;
if|if
condition|(
operator|!
name|cx_probe_chained_board
argument_list|(
name|port
argument_list|,
operator|&
name|c0
argument_list|,
operator|&
name|c1
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* no board detected */
if|if
condition|(
operator|!
operator|(
name|inb
argument_list|(
name|BSR
argument_list|(
name|port
argument_list|)
argument_list|)
operator|&
name|BSR_NOCHAIN
operator|)
condition|)
block|{
comment|/* chained board attached */
if|if
condition|(
operator|!
name|cx_probe_chained_board
argument_list|(
name|port
operator|+
literal|0x10
argument_list|,
operator|&
name|c2
argument_list|,
operator|&
name|c3
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* invalid chained board? */
if|if
condition|(
operator|!
operator|(
name|inb
argument_list|(
name|BSR
argument_list|(
name|port
operator|+
literal|0x10
argument_list|)
argument_list|)
operator|&
name|BSR_NOCHAIN
operator|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* invalid chained board flag? */
block|}
comment|/* Turn off the reset bit. */
name|outb
argument_list|(
name|BCR0
argument_list|(
name|port
argument_list|)
argument_list|,
name|BCR0_NORESET
argument_list|)
expr_stmt|;
if|if
condition|(
name|c2
operator|||
name|c3
condition|)
name|outb
argument_list|(
name|BCR0
argument_list|(
name|port
operator|+
literal|0x10
argument_list|)
argument_list|,
name|BCR0_NORESET
argument_list|)
expr_stmt|;
name|result
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|c0
operator|&&
operator|!
name|cx_probe_chip
argument_list|(
name|CS0
argument_list|(
name|port
argument_list|)
argument_list|)
condition|)
name|result
operator|=
literal|0
expr_stmt|;
comment|/* no CD2400 chip here */
elseif|else
if|if
condition|(
name|c1
operator|&&
operator|!
name|cx_probe_chip
argument_list|(
name|CS1
argument_list|(
name|port
argument_list|)
argument_list|)
condition|)
name|result
operator|=
literal|0
expr_stmt|;
comment|/* no second CD2400 chip */
elseif|else
if|if
condition|(
name|c2
operator|&&
operator|!
name|cx_probe_chip
argument_list|(
name|CS0
argument_list|(
name|port
operator|+
literal|0x10
argument_list|)
argument_list|)
condition|)
name|result
operator|=
literal|0
expr_stmt|;
comment|/* no CD2400 chip on the slave board */
elseif|else
if|if
condition|(
name|c3
operator|&&
operator|!
name|cx_probe_chip
argument_list|(
name|CS1
argument_list|(
name|port
operator|+
literal|0x10
argument_list|)
argument_list|)
condition|)
name|result
operator|=
literal|0
expr_stmt|;
comment|/* no second CD2400 chip on the slave board */
comment|/* Reset the controller. */
name|outb
argument_list|(
name|BCR0
argument_list|(
name|port
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|c2
operator|||
name|c3
condition|)
name|outb
argument_list|(
name|BCR0
argument_list|(
name|port
operator|+
literal|0x10
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Yes, we really have valid CD2400 board. */
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Check if the CD2400 chip is present at the given base port.  */
end_comment

begin_function
specifier|static
name|int
name|cx_probe_chip
parameter_list|(
name|int
name|base
parameter_list|)
block|{
name|int
name|rev
decl_stmt|,
name|newrev
decl_stmt|,
name|count
decl_stmt|;
comment|/* Wait up to 10 msec for revision code to appear after reset. */
for|for
control|(
name|count
operator|=
literal|0
init|;
name|inb
argument_list|(
name|GFRCR
argument_list|(
name|base
argument_list|)
argument_list|)
operator|==
literal|0
condition|;
operator|++
name|count
control|)
if|if
condition|(
name|count
operator|>=
literal|20000
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* reset failed */
comment|/* Read and check the global firmware revision code. */
name|rev
operator|=
name|inb
argument_list|(
name|GFRCR
argument_list|(
name|base
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rev
operator|<
name|REVCL_MIN
operator|||
name|rev
operator|>
name|REVCL_MAX
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* CD2400 revision does not match */
comment|/* Reset the chip. */
if|if
condition|(
operator|!
name|cx_reset
argument_list|(
name|base
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* Read and check the new global firmware revision code. */
name|newrev
operator|=
name|inb
argument_list|(
name|GFRCR
argument_list|(
name|base
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|newrev
operator|!=
name|rev
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* revision changed */
comment|/* Yes, we really have CD2400 chip here. */
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Probe and initialize the board structure.  */
end_comment

begin_function
name|void
name|cx_init
parameter_list|(
name|cx_board_t
modifier|*
name|b
parameter_list|,
name|int
name|num
parameter_list|,
name|int
name|port
parameter_list|,
name|int
name|irq
parameter_list|,
name|int
name|dma
parameter_list|)
block|{
name|int
name|rev
decl_stmt|,
name|chain
decl_stmt|,
name|rev2
decl_stmt|;
name|rev
operator|=
name|inb
argument_list|(
name|BSR
argument_list|(
name|port
argument_list|)
argument_list|)
expr_stmt|;
name|chain
operator|=
operator|!
operator|(
name|rev
operator|&
name|BSR_NOCHAIN
operator|)
expr_stmt|;
name|rev2
operator|=
name|chain
condition|?
name|inb
argument_list|(
name|BSR
argument_list|(
name|port
operator|+
literal|0x10
argument_list|)
argument_list|)
else|:
literal|0
expr_stmt|;
name|cx_init_board
argument_list|(
name|b
argument_list|,
name|num
argument_list|,
name|port
argument_list|,
name|irq
argument_list|,
name|dma
argument_list|,
name|chain
argument_list|,
operator|(
name|rev
operator|&
name|BSR_VAR_MASK
operator|)
argument_list|,
operator|(
name|rev
operator|&
name|BSR_OSC_MASK
operator|)
argument_list|,
operator|(
name|rev2
operator|&
name|BSR_VAR_MASK
operator|)
argument_list|,
operator|(
name|rev2
operator|&
name|BSR_OSC_MASK
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Initialize the board structure, given the type of the board.  */
end_comment

begin_function
specifier|static
name|void
name|cx_init_board
parameter_list|(
name|cx_board_t
modifier|*
name|b
parameter_list|,
name|int
name|num
parameter_list|,
name|int
name|port
parameter_list|,
name|int
name|irq
parameter_list|,
name|int
name|dma
parameter_list|,
name|int
name|chain
parameter_list|,
name|int
name|rev
parameter_list|,
name|int
name|osc
parameter_list|,
name|int
name|rev2
parameter_list|,
name|int
name|osc2
parameter_list|)
block|{
name|cx_chan_t
modifier|*
name|c
decl_stmt|;
name|int
name|i
decl_stmt|,
name|c0
decl_stmt|,
name|c1
decl_stmt|;
comment|/* Initialize board structure. */
name|b
operator|->
name|port
operator|=
name|port
expr_stmt|;
name|b
operator|->
name|num
operator|=
name|num
expr_stmt|;
name|b
operator|->
name|irq
operator|=
name|irq
expr_stmt|;
name|b
operator|->
name|dma
operator|=
name|dma
expr_stmt|;
name|b
operator|->
name|if0type
operator|=
name|b
operator|->
name|if8type
operator|=
name|cx_iftype
expr_stmt|;
comment|/* Set channels 0 and 8 mode, set DMA and IRQ. */
name|b
operator|->
name|bcr0
operator|=
name|b
operator|->
name|bcr0b
operator|=
name|BCR0_NORESET
operator||
name|dmamask
index|[
name|b
operator|->
name|dma
index|]
operator||
name|irqmask
index|[
name|b
operator|->
name|irq
index|]
expr_stmt|;
comment|/* Clear DTR[0..3] and DTR[8..12]. */
name|b
operator|->
name|bcr1
operator|=
name|b
operator|->
name|bcr1b
operator|=
literal|0
expr_stmt|;
comment|/* Initialize chip structures. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NCHIP
condition|;
operator|++
name|i
control|)
block|{
name|b
operator|->
name|chip
index|[
name|i
index|]
operator|.
name|num
operator|=
name|i
expr_stmt|;
name|b
operator|->
name|chip
index|[
name|i
index|]
operator|.
name|board
operator|=
name|b
expr_stmt|;
block|}
name|b
operator|->
name|chip
index|[
literal|0
index|]
operator|.
name|port
operator|=
name|CS0
argument_list|(
name|port
argument_list|)
expr_stmt|;
name|b
operator|->
name|chip
index|[
literal|1
index|]
operator|.
name|port
operator|=
name|CS1
argument_list|(
name|port
argument_list|)
expr_stmt|;
name|b
operator|->
name|chip
index|[
literal|2
index|]
operator|.
name|port
operator|=
name|CS0
argument_list|(
name|port
operator|+
literal|0x10
argument_list|)
expr_stmt|;
name|b
operator|->
name|chip
index|[
literal|3
index|]
operator|.
name|port
operator|=
name|CS1
argument_list|(
name|port
operator|+
literal|0x10
argument_list|)
expr_stmt|;
comment|/*------------------ Master board -------------------*/
comment|/* Read and check the board revision code. */
name|c0
operator|=
name|c1
operator|=
literal|0
expr_stmt|;
name|b
operator|->
name|name
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|rev
condition|)
block|{
case|case
name|CRONYX_100
case|:
name|strcpy
argument_list|(
name|b
operator|->
name|name
argument_list|,
literal|"100"
argument_list|)
expr_stmt|;
name|c0
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CRONYX_400
case|:
name|strcpy
argument_list|(
name|b
operator|->
name|name
argument_list|,
literal|"400"
argument_list|)
expr_stmt|;
name|c1
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CRONYX_500
case|:
name|strcpy
argument_list|(
name|b
operator|->
name|name
argument_list|,
literal|"500"
argument_list|)
expr_stmt|;
name|c0
operator|=
name|c1
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CRONYX_410
case|:
name|strcpy
argument_list|(
name|b
operator|->
name|name
argument_list|,
literal|"410"
argument_list|)
expr_stmt|;
name|c0
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CRONYX_810
case|:
name|strcpy
argument_list|(
name|b
operator|->
name|name
argument_list|,
literal|"810"
argument_list|)
expr_stmt|;
name|c0
operator|=
name|c1
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CRONYX_410s
case|:
name|strcpy
argument_list|(
name|b
operator|->
name|name
argument_list|,
literal|"410s"
argument_list|)
expr_stmt|;
name|c0
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CRONYX_810s
case|:
name|strcpy
argument_list|(
name|b
operator|->
name|name
argument_list|,
literal|"810s"
argument_list|)
expr_stmt|;
name|c0
operator|=
name|c1
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CRONYX_440
case|:
name|strcpy
argument_list|(
name|b
operator|->
name|name
argument_list|,
literal|"440"
argument_list|)
expr_stmt|;
name|c0
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CRONYX_840
case|:
name|strcpy
argument_list|(
name|b
operator|->
name|name
argument_list|,
literal|"840"
argument_list|)
expr_stmt|;
name|c0
operator|=
name|c1
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CRONYX_401
case|:
name|strcpy
argument_list|(
name|b
operator|->
name|name
argument_list|,
literal|"401"
argument_list|)
expr_stmt|;
name|c0
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CRONYX_801
case|:
name|strcpy
argument_list|(
name|b
operator|->
name|name
argument_list|,
literal|"801"
argument_list|)
expr_stmt|;
name|c0
operator|=
name|c1
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CRONYX_401s
case|:
name|strcpy
argument_list|(
name|b
operator|->
name|name
argument_list|,
literal|"401s"
argument_list|)
expr_stmt|;
name|c0
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CRONYX_801s
case|:
name|strcpy
argument_list|(
name|b
operator|->
name|name
argument_list|,
literal|"801s"
argument_list|)
expr_stmt|;
name|c0
operator|=
name|c1
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CRONYX_404
case|:
name|strcpy
argument_list|(
name|b
operator|->
name|name
argument_list|,
literal|"404"
argument_list|)
expr_stmt|;
name|c0
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CRONYX_703
case|:
name|strcpy
argument_list|(
name|b
operator|->
name|name
argument_list|,
literal|"703"
argument_list|)
expr_stmt|;
name|c0
operator|=
name|c1
operator|=
literal|1
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
name|osc
condition|)
block|{
default|default:
case|case
name|BSR_OSC_20
case|:
comment|/* 20 MHz */
name|b
operator|->
name|chip
index|[
literal|0
index|]
operator|.
name|oscfreq
operator|=
name|b
operator|->
name|chip
index|[
literal|1
index|]
operator|.
name|oscfreq
operator|=
literal|20000000L
expr_stmt|;
name|strcat
argument_list|(
name|b
operator|->
name|name
argument_list|,
literal|"a"
argument_list|)
expr_stmt|;
break|break;
case|case
name|BSR_OSC_18432
case|:
comment|/* 18.432 MHz */
name|b
operator|->
name|chip
index|[
literal|0
index|]
operator|.
name|oscfreq
operator|=
name|b
operator|->
name|chip
index|[
literal|1
index|]
operator|.
name|oscfreq
operator|=
literal|18432000L
expr_stmt|;
name|strcat
argument_list|(
name|b
operator|->
name|name
argument_list|,
literal|"b"
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
name|c0
condition|)
name|b
operator|->
name|chip
index|[
literal|0
index|]
operator|.
name|port
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|c1
condition|)
name|b
operator|->
name|chip
index|[
literal|1
index|]
operator|.
name|port
operator|=
literal|0
expr_stmt|;
comment|/*------------------ Slave board -------------------*/
if|if
condition|(
operator|!
name|chain
condition|)
block|{
name|b
operator|->
name|chip
index|[
literal|2
index|]
operator|.
name|oscfreq
operator|=
name|b
operator|->
name|chip
index|[
literal|3
index|]
operator|.
name|oscfreq
operator|=
literal|0L
expr_stmt|;
name|b
operator|->
name|chip
index|[
literal|2
index|]
operator|.
name|port
operator|=
name|b
operator|->
name|chip
index|[
literal|3
index|]
operator|.
name|port
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
comment|/* Read and check the board revision code. */
name|c0
operator|=
name|c1
operator|=
literal|0
expr_stmt|;
name|strcat
argument_list|(
name|b
operator|->
name|name
argument_list|,
literal|"/"
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|rev2
condition|)
block|{
case|case
name|CRONYX_100
case|:
name|strcat
argument_list|(
name|b
operator|->
name|name
argument_list|,
literal|"100"
argument_list|)
expr_stmt|;
name|c0
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CRONYX_400
case|:
name|strcat
argument_list|(
name|b
operator|->
name|name
argument_list|,
literal|"400"
argument_list|)
expr_stmt|;
name|c1
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CRONYX_500
case|:
name|strcat
argument_list|(
name|b
operator|->
name|name
argument_list|,
literal|"500"
argument_list|)
expr_stmt|;
name|c0
operator|=
name|c1
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CRONYX_410
case|:
name|strcat
argument_list|(
name|b
operator|->
name|name
argument_list|,
literal|"410"
argument_list|)
expr_stmt|;
name|c0
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CRONYX_810
case|:
name|strcat
argument_list|(
name|b
operator|->
name|name
argument_list|,
literal|"810"
argument_list|)
expr_stmt|;
name|c0
operator|=
name|c1
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CRONYX_410s
case|:
name|strcat
argument_list|(
name|b
operator|->
name|name
argument_list|,
literal|"410s"
argument_list|)
expr_stmt|;
name|c0
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CRONYX_810s
case|:
name|strcat
argument_list|(
name|b
operator|->
name|name
argument_list|,
literal|"810s"
argument_list|)
expr_stmt|;
name|c0
operator|=
name|c1
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CRONYX_440
case|:
name|strcat
argument_list|(
name|b
operator|->
name|name
argument_list|,
literal|"440"
argument_list|)
expr_stmt|;
name|c0
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CRONYX_840
case|:
name|strcat
argument_list|(
name|b
operator|->
name|name
argument_list|,
literal|"840"
argument_list|)
expr_stmt|;
name|c0
operator|=
name|c1
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CRONYX_401
case|:
name|strcat
argument_list|(
name|b
operator|->
name|name
argument_list|,
literal|"401"
argument_list|)
expr_stmt|;
name|c0
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CRONYX_801
case|:
name|strcat
argument_list|(
name|b
operator|->
name|name
argument_list|,
literal|"801"
argument_list|)
expr_stmt|;
name|c0
operator|=
name|c1
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CRONYX_401s
case|:
name|strcat
argument_list|(
name|b
operator|->
name|name
argument_list|,
literal|"401s"
argument_list|)
expr_stmt|;
name|c0
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CRONYX_801s
case|:
name|strcat
argument_list|(
name|b
operator|->
name|name
argument_list|,
literal|"801s"
argument_list|)
expr_stmt|;
name|c0
operator|=
name|c1
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CRONYX_404
case|:
name|strcat
argument_list|(
name|b
operator|->
name|name
argument_list|,
literal|"404"
argument_list|)
expr_stmt|;
name|c0
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CRONYX_703
case|:
name|strcat
argument_list|(
name|b
operator|->
name|name
argument_list|,
literal|"703"
argument_list|)
expr_stmt|;
name|c0
operator|=
name|c1
operator|=
literal|1
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
name|osc2
condition|)
block|{
default|default:
case|case
name|BSR_OSC_20
case|:
comment|/* 20 MHz */
name|b
operator|->
name|chip
index|[
literal|2
index|]
operator|.
name|oscfreq
operator|=
name|b
operator|->
name|chip
index|[
literal|3
index|]
operator|.
name|oscfreq
operator|=
literal|20000000L
expr_stmt|;
name|strcat
argument_list|(
name|b
operator|->
name|name
argument_list|,
literal|"a"
argument_list|)
expr_stmt|;
break|break;
case|case
name|BSR_OSC_18432
case|:
comment|/* 18.432 MHz */
name|b
operator|->
name|chip
index|[
literal|2
index|]
operator|.
name|oscfreq
operator|=
name|b
operator|->
name|chip
index|[
literal|3
index|]
operator|.
name|oscfreq
operator|=
literal|18432000L
expr_stmt|;
name|strcat
argument_list|(
name|b
operator|->
name|name
argument_list|,
literal|"b"
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
name|c0
condition|)
name|b
operator|->
name|chip
index|[
literal|2
index|]
operator|.
name|port
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|c1
condition|)
name|b
operator|->
name|chip
index|[
literal|3
index|]
operator|.
name|port
operator|=
literal|0
expr_stmt|;
block|}
comment|/* Initialize channel structures. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NCHAN
condition|;
operator|++
name|i
control|)
block|{
name|cx_chan_t
modifier|*
name|c
init|=
name|b
operator|->
name|chan
operator|+
name|i
decl_stmt|;
name|c
operator|->
name|num
operator|=
name|i
expr_stmt|;
name|c
operator|->
name|board
operator|=
name|b
expr_stmt|;
name|c
operator|->
name|chip
operator|=
name|b
operator|->
name|chip
operator|+
name|i
operator|*
name|NCHIP
operator|/
name|NCHAN
expr_stmt|;
name|c
operator|->
name|stat
operator|=
name|b
operator|->
name|stat
operator|+
name|i
expr_stmt|;
name|c
operator|->
name|type
operator|=
name|T_NONE
expr_stmt|;
block|}
comment|/*------------------ Master board -------------------*/
switch|switch
condition|(
name|rev
condition|)
block|{
case|case
name|CRONYX_400
case|:
break|break;
case|case
name|CRONYX_100
case|:
case|case
name|CRONYX_500
case|:
name|b
operator|->
name|chan
index|[
literal|0
index|]
operator|.
name|type
operator|=
name|T_UNIV_RS232
expr_stmt|;
break|break;
case|case
name|CRONYX_410
case|:
case|case
name|CRONYX_810
case|:
name|b
operator|->
name|chan
index|[
literal|0
index|]
operator|.
name|type
operator|=
name|T_UNIV_V35
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
literal|4
condition|;
operator|++
name|i
control|)
name|b
operator|->
name|chan
index|[
name|i
index|]
operator|.
name|type
operator|=
name|T_UNIV_RS232
expr_stmt|;
break|break;
case|case
name|CRONYX_410s
case|:
case|case
name|CRONYX_810s
case|:
name|b
operator|->
name|chan
index|[
literal|0
index|]
operator|.
name|type
operator|=
name|T_UNIV_V35
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
literal|4
condition|;
operator|++
name|i
control|)
name|b
operator|->
name|chan
index|[
name|i
index|]
operator|.
name|type
operator|=
name|T_SYNC_RS232
expr_stmt|;
break|break;
case|case
name|CRONYX_440
case|:
case|case
name|CRONYX_840
case|:
name|b
operator|->
name|chan
index|[
literal|0
index|]
operator|.
name|type
operator|=
name|T_UNIV_V35
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
literal|4
condition|;
operator|++
name|i
control|)
name|b
operator|->
name|chan
index|[
name|i
index|]
operator|.
name|type
operator|=
name|T_SYNC_V35
expr_stmt|;
break|break;
case|case
name|CRONYX_401
case|:
case|case
name|CRONYX_801
case|:
name|b
operator|->
name|chan
index|[
literal|0
index|]
operator|.
name|type
operator|=
name|T_UNIV_RS449
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
literal|4
condition|;
operator|++
name|i
control|)
name|b
operator|->
name|chan
index|[
name|i
index|]
operator|.
name|type
operator|=
name|T_UNIV_RS232
expr_stmt|;
break|break;
case|case
name|CRONYX_401s
case|:
case|case
name|CRONYX_801s
case|:
name|b
operator|->
name|chan
index|[
literal|0
index|]
operator|.
name|type
operator|=
name|T_UNIV_RS449
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
literal|4
condition|;
operator|++
name|i
control|)
name|b
operator|->
name|chan
index|[
name|i
index|]
operator|.
name|type
operator|=
name|T_SYNC_RS232
expr_stmt|;
break|break;
case|case
name|CRONYX_404
case|:
name|b
operator|->
name|chan
index|[
literal|0
index|]
operator|.
name|type
operator|=
name|T_UNIV_RS449
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
literal|4
condition|;
operator|++
name|i
control|)
name|b
operator|->
name|chan
index|[
name|i
index|]
operator|.
name|type
operator|=
name|T_SYNC_RS449
expr_stmt|;
break|break;
case|case
name|CRONYX_703
case|:
name|b
operator|->
name|chan
index|[
literal|0
index|]
operator|.
name|type
operator|=
name|T_UNIV_RS449
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
literal|3
condition|;
operator|++
name|i
control|)
name|b
operator|->
name|chan
index|[
name|i
index|]
operator|.
name|type
operator|=
name|T_SYNC_RS449
expr_stmt|;
break|break;
block|}
comment|/* If the second controller is present, 	 * then we have 4..7 channels in async. mode */
if|if
condition|(
name|b
operator|->
name|chip
index|[
literal|1
index|]
operator|.
name|port
condition|)
for|for
control|(
name|i
operator|=
literal|4
init|;
name|i
operator|<
literal|8
condition|;
operator|++
name|i
control|)
name|b
operator|->
name|chan
index|[
name|i
index|]
operator|.
name|type
operator|=
name|T_UNIV_RS232
expr_stmt|;
comment|/*------------------ Slave board -------------------*/
if|if
condition|(
name|chain
condition|)
block|{
switch|switch
condition|(
name|rev2
condition|)
block|{
case|case
name|CRONYX_400
case|:
break|break;
case|case
name|CRONYX_100
case|:
case|case
name|CRONYX_500
case|:
name|b
operator|->
name|chan
index|[
literal|8
index|]
operator|.
name|type
operator|=
name|T_UNIV_RS232
expr_stmt|;
break|break;
case|case
name|CRONYX_410
case|:
case|case
name|CRONYX_810
case|:
name|b
operator|->
name|chan
index|[
literal|8
index|]
operator|.
name|type
operator|=
name|T_UNIV_V35
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|9
init|;
name|i
operator|<
literal|12
condition|;
operator|++
name|i
control|)
name|b
operator|->
name|chan
index|[
name|i
index|]
operator|.
name|type
operator|=
name|T_UNIV_RS232
expr_stmt|;
break|break;
case|case
name|CRONYX_410s
case|:
case|case
name|CRONYX_810s
case|:
name|b
operator|->
name|chan
index|[
literal|8
index|]
operator|.
name|type
operator|=
name|T_UNIV_V35
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|9
init|;
name|i
operator|<
literal|12
condition|;
operator|++
name|i
control|)
name|b
operator|->
name|chan
index|[
name|i
index|]
operator|.
name|type
operator|=
name|T_SYNC_RS232
expr_stmt|;
break|break;
case|case
name|CRONYX_440
case|:
case|case
name|CRONYX_840
case|:
name|b
operator|->
name|chan
index|[
literal|8
index|]
operator|.
name|type
operator|=
name|T_UNIV_V35
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|9
init|;
name|i
operator|<
literal|12
condition|;
operator|++
name|i
control|)
name|b
operator|->
name|chan
index|[
name|i
index|]
operator|.
name|type
operator|=
name|T_SYNC_V35
expr_stmt|;
break|break;
case|case
name|CRONYX_401
case|:
case|case
name|CRONYX_801
case|:
name|b
operator|->
name|chan
index|[
literal|8
index|]
operator|.
name|type
operator|=
name|T_UNIV_RS449
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|9
init|;
name|i
operator|<
literal|12
condition|;
operator|++
name|i
control|)
name|b
operator|->
name|chan
index|[
name|i
index|]
operator|.
name|type
operator|=
name|T_UNIV_RS232
expr_stmt|;
break|break;
case|case
name|CRONYX_401s
case|:
case|case
name|CRONYX_801s
case|:
name|b
operator|->
name|chan
index|[
literal|8
index|]
operator|.
name|type
operator|=
name|T_UNIV_RS449
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|9
init|;
name|i
operator|<
literal|12
condition|;
operator|++
name|i
control|)
name|b
operator|->
name|chan
index|[
name|i
index|]
operator|.
name|type
operator|=
name|T_UNIV_RS232
expr_stmt|;
break|break;
case|case
name|CRONYX_404
case|:
name|b
operator|->
name|chan
index|[
literal|8
index|]
operator|.
name|type
operator|=
name|T_UNIV_RS449
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|9
init|;
name|i
operator|<
literal|12
condition|;
operator|++
name|i
control|)
name|b
operator|->
name|chan
index|[
name|i
index|]
operator|.
name|type
operator|=
name|T_SYNC_RS449
expr_stmt|;
break|break;
case|case
name|CRONYX_703
case|:
name|b
operator|->
name|chan
index|[
literal|8
index|]
operator|.
name|type
operator|=
name|T_UNIV_RS449
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|9
init|;
name|i
operator|<
literal|11
condition|;
operator|++
name|i
control|)
name|b
operator|->
name|chan
index|[
name|i
index|]
operator|.
name|type
operator|=
name|T_SYNC_RS449
expr_stmt|;
break|break;
block|}
comment|/* If the second controller is present, 		 * then we have 4..7 channels in async. mode */
if|if
condition|(
name|b
operator|->
name|chip
index|[
literal|3
index|]
operator|.
name|port
condition|)
for|for
control|(
name|i
operator|=
literal|12
init|;
name|i
operator|<
literal|16
condition|;
operator|++
name|i
control|)
name|b
operator|->
name|chan
index|[
name|i
index|]
operator|.
name|type
operator|=
name|T_UNIV_RS232
expr_stmt|;
block|}
name|b
operator|->
name|nuniv
operator|=
name|b
operator|->
name|nsync
operator|=
name|b
operator|->
name|nasync
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|c
operator|=
name|b
operator|->
name|chan
init|;
name|c
operator|<
name|b
operator|->
name|chan
operator|+
name|NCHAN
condition|;
operator|++
name|c
control|)
switch|switch
condition|(
name|c
operator|->
name|type
condition|)
block|{
case|case
name|T_ASYNC
case|:
operator|++
name|b
operator|->
name|nasync
expr_stmt|;
break|break;
case|case
name|T_UNIV_RS232
case|:
case|case
name|T_UNIV_RS449
case|:
case|case
name|T_UNIV_V35
case|:
operator|++
name|b
operator|->
name|nuniv
expr_stmt|;
break|break;
case|case
name|T_SYNC_RS232
case|:
case|case
name|T_SYNC_V35
case|:
case|case
name|T_SYNC_RS449
case|:
operator|++
name|b
operator|->
name|nsync
expr_stmt|;
break|break;
block|}
name|cx_reinit_board
argument_list|(
name|b
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Reinitialize all channels, using new options and baud rate.  */
end_comment

begin_function
specifier|static
name|void
name|cx_reinit_board
parameter_list|(
name|cx_board_t
modifier|*
name|b
parameter_list|)
block|{
name|cx_chan_t
modifier|*
name|c
decl_stmt|;
name|b
operator|->
name|if0type
operator|=
name|b
operator|->
name|if8type
operator|=
name|cx_iftype
expr_stmt|;
for|for
control|(
name|c
operator|=
name|b
operator|->
name|chan
init|;
name|c
operator|<
name|b
operator|->
name|chan
operator|+
name|NCHAN
condition|;
operator|++
name|c
control|)
block|{
switch|switch
condition|(
name|c
operator|->
name|type
condition|)
block|{
default|default:
case|case
name|T_NONE
case|:
continue|continue;
case|case
name|T_UNIV_RS232
case|:
case|case
name|T_UNIV_RS449
case|:
case|case
name|T_UNIV_V35
case|:
name|c
operator|->
name|mode
operator|=
operator|(
name|cx_univ_mode
operator|==
name|M_ASYNC
operator|)
condition|?
name|M_ASYNC
else|:
name|cx_sync_mode
expr_stmt|;
break|break;
case|case
name|T_SYNC_RS232
case|:
case|case
name|T_SYNC_V35
case|:
case|case
name|T_SYNC_RS449
case|:
name|c
operator|->
name|mode
operator|=
name|cx_sync_mode
expr_stmt|;
break|break;
case|case
name|T_ASYNC
case|:
name|c
operator|->
name|mode
operator|=
name|M_ASYNC
expr_stmt|;
break|break;
block|}
name|c
operator|->
name|rxbaud
operator|=
name|cx_rxbaud
expr_stmt|;
name|c
operator|->
name|txbaud
operator|=
name|cx_txbaud
expr_stmt|;
name|c
operator|->
name|opt
operator|=
name|chan_opt_dflt
expr_stmt|;
name|c
operator|->
name|aopt
operator|=
name|opt_async_dflt
expr_stmt|;
name|c
operator|->
name|hopt
operator|=
name|opt_hdlc_dflt
expr_stmt|;
name|c
operator|->
name|bopt
operator|=
name|opt_bisync_dflt
expr_stmt|;
name|c
operator|->
name|xopt
operator|=
name|opt_x21_dflt
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Set up the board.  */
end_comment

begin_function
name|void
name|cx_setup_board
parameter_list|(
name|cx_board_t
modifier|*
name|b
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
comment|/* Disable DMA channel. */
name|outb
argument_list|(
name|DMA_MASK
argument_list|,
operator|(
name|b
operator|->
name|dma
operator|&
literal|3
operator|)
operator||
name|DMA_MASK_CLEAR
argument_list|)
expr_stmt|;
comment|/* Reset the controller. */
name|outb
argument_list|(
name|BCR0
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|b
operator|->
name|chip
index|[
literal|2
index|]
operator|.
name|port
operator|||
name|b
operator|->
name|chip
index|[
literal|3
index|]
operator|.
name|port
condition|)
name|outb
argument_list|(
name|BCR0
argument_list|(
name|b
operator|->
name|port
operator|+
literal|0x10
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* 	 * Set channels 0 and 8 to RS232 async. mode. 	 * Enable DMA and IRQ. 	 */
name|outb
argument_list|(
name|BCR0
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|,
name|b
operator|->
name|bcr0
argument_list|)
expr_stmt|;
if|if
condition|(
name|b
operator|->
name|chip
index|[
literal|2
index|]
operator|.
name|port
operator|||
name|b
operator|->
name|chip
index|[
literal|3
index|]
operator|.
name|port
condition|)
name|outb
argument_list|(
name|BCR0
argument_list|(
name|b
operator|->
name|port
operator|+
literal|0x10
argument_list|)
argument_list|,
name|b
operator|->
name|bcr0b
argument_list|)
expr_stmt|;
comment|/* Clear DTR[0..3] and DTR[8..12]. */
name|outw
argument_list|(
name|BCR1
argument_list|(
name|b
operator|->
name|port
argument_list|)
argument_list|,
name|b
operator|->
name|bcr1
argument_list|)
expr_stmt|;
if|if
condition|(
name|b
operator|->
name|chip
index|[
literal|2
index|]
operator|.
name|port
operator|||
name|b
operator|->
name|chip
index|[
literal|3
index|]
operator|.
name|port
condition|)
name|outw
argument_list|(
name|BCR1
argument_list|(
name|b
operator|->
name|port
operator|+
literal|0x10
argument_list|)
argument_list|,
name|b
operator|->
name|bcr1b
argument_list|)
expr_stmt|;
comment|/* Initialize all controllers. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NCHIP
condition|;
operator|++
name|i
control|)
if|if
condition|(
name|b
operator|->
name|chip
index|[
name|i
index|]
operator|.
name|port
condition|)
name|cx_setup_chip
argument_list|(
name|b
operator|->
name|chip
operator|+
name|i
argument_list|)
expr_stmt|;
comment|/* Set up DMA channel to master mode. */
name|outb
argument_list|(
name|DMA_MODE
argument_list|,
operator|(
name|b
operator|->
name|dma
operator|&
literal|3
operator|)
operator||
name|DMA_MODE_MASTER
argument_list|)
expr_stmt|;
comment|/* Enable DMA channel. */
name|outb
argument_list|(
name|DMA_MASK
argument_list|,
name|b
operator|->
name|dma
operator|&
literal|3
argument_list|)
expr_stmt|;
comment|/* Initialize all channels. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NCHAN
condition|;
operator|++
name|i
control|)
if|if
condition|(
name|b
operator|->
name|chan
index|[
name|i
index|]
operator|.
name|type
operator|!=
name|T_NONE
condition|)
name|cx_setup_chan
argument_list|(
name|b
operator|->
name|chan
operator|+
name|i
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Initialize the board.  */
end_comment

begin_function
specifier|static
name|void
name|cx_setup_chip
parameter_list|(
name|cx_chip_t
modifier|*
name|c
parameter_list|)
block|{
comment|/* Reset the chip. */
name|cx_reset
argument_list|(
name|c
operator|->
name|port
argument_list|)
expr_stmt|;
comment|/* 	 * Set all interrupt level registers to the same value. 	 * This enables the internal CD2400 priority scheme. 	 */
name|outb
argument_list|(
name|RPILR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|BRD_INTR_LEVEL
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|TPILR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|BRD_INTR_LEVEL
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|MPILR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
name|BRD_INTR_LEVEL
argument_list|)
expr_stmt|;
comment|/* Set bus error count to zero. */
name|outb
argument_list|(
name|BERCNT
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Set 16-bit DMA mode. */
name|outb
argument_list|(
name|DMR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Set timer period register to 1 msec (approximately). */
name|outb
argument_list|(
name|TPR
argument_list|(
name|c
operator|->
name|port
argument_list|)
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Initialize the CD2400 channel.  */
end_comment

begin_function
name|void
name|cx_setup_chan
parameter_list|(
name|cx_chan_t
modifier|*
name|c
parameter_list|)
block|{
name|unsigned
name|short
name|port
init|=
name|c
operator|->
name|chip
operator|->
name|port
decl_stmt|;
name|int
name|clock
decl_stmt|,
name|period
decl_stmt|;
if|if
condition|(
name|c
operator|->
name|num
operator|==
literal|0
condition|)
block|{
name|c
operator|->
name|board
operator|->
name|bcr0
operator|&=
operator|~
name|BCR0_UMASK
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|mode
operator|!=
name|M_ASYNC
condition|)
name|c
operator|->
name|board
operator|->
name|bcr0
operator||=
name|BCR0_UM_SYNC
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|board
operator|->
name|if0type
operator|&&
operator|(
name|c
operator|->
name|type
operator|==
name|T_UNIV_RS449
operator|||
name|c
operator|->
name|type
operator|==
name|T_UNIV_V35
operator|)
condition|)
name|c
operator|->
name|board
operator|->
name|bcr0
operator||=
name|BCR0_UI_RS449
expr_stmt|;
name|outb
argument_list|(
name|BCR0
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|board
operator|->
name|bcr0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|c
operator|->
name|num
operator|==
literal|8
condition|)
block|{
name|c
operator|->
name|board
operator|->
name|bcr0b
operator|&=
operator|~
name|BCR0_UMASK
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|mode
operator|!=
name|M_ASYNC
condition|)
name|c
operator|->
name|board
operator|->
name|bcr0b
operator||=
name|BCR0_UM_SYNC
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|board
operator|->
name|if8type
operator|&&
operator|(
name|c
operator|->
name|type
operator|==
name|T_UNIV_RS449
operator|||
name|c
operator|->
name|type
operator|==
name|T_UNIV_V35
operator|)
condition|)
name|c
operator|->
name|board
operator|->
name|bcr0b
operator||=
name|BCR0_UI_RS449
expr_stmt|;
name|outb
argument_list|(
name|BCR0
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
operator|+
literal|0x10
argument_list|)
argument_list|,
name|c
operator|->
name|board
operator|->
name|bcr0b
argument_list|)
expr_stmt|;
block|}
comment|/* set current channel number */
name|outb
argument_list|(
name|CAR
argument_list|(
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|num
operator|&
literal|3
argument_list|)
expr_stmt|;
comment|/* reset the channel */
name|cx_cmd
argument_list|(
name|port
argument_list|,
name|CCR_CLRCH
argument_list|)
expr_stmt|;
comment|/* set LIVR to contain the board and channel numbers */
name|outb
argument_list|(
name|LIVR
argument_list|(
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|board
operator|->
name|num
operator|<<
literal|6
operator||
name|c
operator|->
name|num
operator|<<
literal|2
argument_list|)
expr_stmt|;
comment|/* clear DTR, RTS, set TXCout/DTR pin */
name|outb
argument_list|(
name|MSVR_RTS
argument_list|(
name|port
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|MSVR_DTR
argument_list|(
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|mode
operator|==
name|M_ASYNC
condition|?
literal|0
else|:
name|MSV_TXCOUT
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|c
operator|->
name|mode
condition|)
block|{
comment|/* initialize the channel mode */
case|case
name|M_ASYNC
case|:
comment|/* set receiver timeout register */
name|outw
argument_list|(
name|RTPR
argument_list|(
name|port
argument_list|)
argument_list|,
literal|10
argument_list|)
expr_stmt|;
comment|/* 10 msec, see TPR */
name|outb
argument_list|(
name|CMR
argument_list|(
name|port
argument_list|)
argument_list|,
name|CMR_RXDMA
operator||
name|CMR_TXDMA
operator||
name|CMR_ASYNC
argument_list|)
expr_stmt|;
name|outb
argument_list|(
argument|COR1(port)
argument_list|,
argument|BYTE c->aopt.cor1
argument_list|)
empty_stmt|;
name|outb
argument_list|(
argument|COR2(port)
argument_list|,
argument|BYTE c->aopt.cor2
argument_list|)
empty_stmt|;
name|outb
argument_list|(
argument|COR3(port)
argument_list|,
argument|BYTE c->aopt.cor3
argument_list|)
empty_stmt|;
name|outb
argument_list|(
argument|COR6(port)
argument_list|,
argument|BYTE c->aopt.cor6
argument_list|)
empty_stmt|;
name|outb
argument_list|(
argument|COR7(port)
argument_list|,
argument|BYTE c->aopt.cor7
argument_list|)
empty_stmt|;
name|outb
argument_list|(
name|SCHR1
argument_list|(
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|aopt
operator|.
name|schr1
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|SCHR2
argument_list|(
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|aopt
operator|.
name|schr2
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|SCHR3
argument_list|(
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|aopt
operator|.
name|schr3
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|SCHR4
argument_list|(
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|aopt
operator|.
name|schr4
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|SCRL
argument_list|(
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|aopt
operator|.
name|scrl
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|SCRH
argument_list|(
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|aopt
operator|.
name|scrh
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|LNXT
argument_list|(
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|aopt
operator|.
name|lnxt
argument_list|)
expr_stmt|;
break|break;
case|case
name|M_HDLC
case|:
name|outb
argument_list|(
name|CMR
argument_list|(
name|port
argument_list|)
argument_list|,
name|CMR_RXDMA
operator||
name|CMR_TXDMA
operator||
name|CMR_HDLC
argument_list|)
expr_stmt|;
name|outb
argument_list|(
argument|COR1(port)
argument_list|,
argument|BYTE c->hopt.cor1
argument_list|)
empty_stmt|;
name|outb
argument_list|(
argument|COR2(port)
argument_list|,
argument|BYTE c->hopt.cor2
argument_list|)
empty_stmt|;
name|outb
argument_list|(
argument|COR3(port)
argument_list|,
argument|BYTE c->hopt.cor3
argument_list|)
empty_stmt|;
name|outb
argument_list|(
name|RFAR1
argument_list|(
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|hopt
operator|.
name|rfar1
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|RFAR2
argument_list|(
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|hopt
operator|.
name|rfar2
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|RFAR3
argument_list|(
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|hopt
operator|.
name|rfar3
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|RFAR4
argument_list|(
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|hopt
operator|.
name|rfar4
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|CPSR
argument_list|(
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|hopt
operator|.
name|cpsr
argument_list|)
expr_stmt|;
break|break;
case|case
name|M_BISYNC
case|:
name|outb
argument_list|(
name|CMR
argument_list|(
name|port
argument_list|)
argument_list|,
name|CMR_RXDMA
operator||
name|CMR_TXDMA
operator||
name|CMR_BISYNC
argument_list|)
expr_stmt|;
name|outb
argument_list|(
argument|COR1(port)
argument_list|,
argument|BYTE c->bopt.cor1
argument_list|)
empty_stmt|;
name|outb
argument_list|(
argument|COR2(port)
argument_list|,
argument|BYTE c->bopt.cor2
argument_list|)
empty_stmt|;
name|outb
argument_list|(
argument|COR3(port)
argument_list|,
argument|BYTE c->bopt.cor3
argument_list|)
empty_stmt|;
name|outb
argument_list|(
argument|COR6(port)
argument_list|,
argument|BYTE c->bopt.cor6
argument_list|)
empty_stmt|;
name|outb
argument_list|(
name|CPSR
argument_list|(
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|bopt
operator|.
name|cpsr
argument_list|)
expr_stmt|;
break|break;
case|case
name|M_X21
case|:
name|outb
argument_list|(
name|CMR
argument_list|(
name|port
argument_list|)
argument_list|,
name|CMR_RXDMA
operator||
name|CMR_TXDMA
operator||
name|CMR_X21
argument_list|)
expr_stmt|;
name|outb
argument_list|(
argument|COR1(port)
argument_list|,
argument|BYTE c->xopt.cor1
argument_list|)
empty_stmt|;
name|outb
argument_list|(
argument|COR2(port)
argument_list|,
argument|BYTE c->xopt.cor2
argument_list|)
empty_stmt|;
name|outb
argument_list|(
argument|COR3(port)
argument_list|,
argument|BYTE c->xopt.cor3
argument_list|)
empty_stmt|;
name|outb
argument_list|(
argument|COR6(port)
argument_list|,
argument|BYTE c->xopt.cor6
argument_list|)
empty_stmt|;
name|outb
argument_list|(
name|SCHR1
argument_list|(
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|xopt
operator|.
name|schr1
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|SCHR2
argument_list|(
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|xopt
operator|.
name|schr2
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|SCHR3
argument_list|(
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|xopt
operator|.
name|schr3
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* set mode-independent options */
name|outb
argument_list|(
argument|COR4(port)
argument_list|,
argument|BYTE c->opt.cor4
argument_list|)
empty_stmt|;
name|outb
argument_list|(
argument|COR5(port)
argument_list|,
argument|BYTE c->opt.cor5
argument_list|)
empty_stmt|;
comment|/* set up receiver clock values */
if|if
condition|(
name|c
operator|->
name|mode
operator|==
name|M_ASYNC
operator|||
name|c
operator|->
name|opt
operator|.
name|rcor
operator|.
name|dpll
condition|)
block|{
name|cx_clock
argument_list|(
name|c
operator|->
name|chip
operator|->
name|oscfreq
argument_list|,
name|c
operator|->
name|rxbaud
argument_list|,
operator|&
name|clock
argument_list|,
operator|&
name|period
argument_list|)
expr_stmt|;
name|c
operator|->
name|opt
operator|.
name|rcor
operator|.
name|clk
operator|=
name|clock
expr_stmt|;
block|}
else|else
block|{
name|c
operator|->
name|opt
operator|.
name|rcor
operator|.
name|clk
operator|=
name|CLK_EXT
expr_stmt|;
name|period
operator|=
literal|1
expr_stmt|;
block|}
name|outb
argument_list|(
argument|RCOR(port)
argument_list|,
argument|BYTE c->opt.rcor
argument_list|)
empty_stmt|;
name|outb
argument_list|(
name|RBPR
argument_list|(
name|port
argument_list|)
argument_list|,
name|period
argument_list|)
expr_stmt|;
comment|/* set up transmitter clock values */
if|if
condition|(
name|c
operator|->
name|mode
operator|==
name|M_ASYNC
operator|||
operator|!
name|c
operator|->
name|opt
operator|.
name|tcor
operator|.
name|ext1x
condition|)
block|{
name|unsigned
name|ext1x
init|=
name|c
operator|->
name|opt
operator|.
name|tcor
operator|.
name|ext1x
decl_stmt|;
name|c
operator|->
name|opt
operator|.
name|tcor
operator|.
name|ext1x
operator|=
literal|0
expr_stmt|;
name|cx_clock
argument_list|(
name|c
operator|->
name|chip
operator|->
name|oscfreq
argument_list|,
name|c
operator|->
name|txbaud
argument_list|,
operator|&
name|clock
argument_list|,
operator|&
name|period
argument_list|)
expr_stmt|;
name|c
operator|->
name|opt
operator|.
name|tcor
operator|.
name|clk
operator|=
name|clock
expr_stmt|;
name|c
operator|->
name|opt
operator|.
name|tcor
operator|.
name|ext1x
operator|=
name|ext1x
expr_stmt|;
block|}
else|else
block|{
name|c
operator|->
name|opt
operator|.
name|tcor
operator|.
name|clk
operator|=
name|CLK_EXT
expr_stmt|;
name|period
operator|=
literal|1
expr_stmt|;
block|}
name|outb
argument_list|(
argument|TCOR(port)
argument_list|,
argument|BYTE c->opt.tcor
argument_list|)
empty_stmt|;
name|outb
argument_list|(
name|TBPR
argument_list|(
name|port
argument_list|)
argument_list|,
name|period
argument_list|)
expr_stmt|;
comment|/* set receiver A buffer physical address */
name|c
operator|->
name|arphys
operator|=
name|vtophys
argument_list|(
name|c
operator|->
name|arbuf
argument_list|)
expr_stmt|;
name|outw
argument_list|(
name|ARBADRU
argument_list|(
name|port
argument_list|)
argument_list|,
call|(
name|unsigned
name|short
call|)
argument_list|(
name|c
operator|->
name|arphys
operator|>>
literal|16
argument_list|)
argument_list|)
expr_stmt|;
name|outw
argument_list|(
name|ARBADRL
argument_list|(
name|port
argument_list|)
argument_list|,
operator|(
name|unsigned
name|short
operator|)
name|c
operator|->
name|arphys
argument_list|)
expr_stmt|;
comment|/* set receiver B buffer physical address */
name|c
operator|->
name|brphys
operator|=
name|vtophys
argument_list|(
name|c
operator|->
name|brbuf
argument_list|)
expr_stmt|;
name|outw
argument_list|(
name|BRBADRU
argument_list|(
name|port
argument_list|)
argument_list|,
call|(
name|unsigned
name|short
call|)
argument_list|(
name|c
operator|->
name|brphys
operator|>>
literal|16
argument_list|)
argument_list|)
expr_stmt|;
name|outw
argument_list|(
name|BRBADRL
argument_list|(
name|port
argument_list|)
argument_list|,
operator|(
name|unsigned
name|short
operator|)
name|c
operator|->
name|brphys
argument_list|)
expr_stmt|;
comment|/* set transmitter A buffer physical address */
name|c
operator|->
name|atphys
operator|=
name|vtophys
argument_list|(
name|c
operator|->
name|atbuf
argument_list|)
expr_stmt|;
name|outw
argument_list|(
name|ATBADRU
argument_list|(
name|port
argument_list|)
argument_list|,
call|(
name|unsigned
name|short
call|)
argument_list|(
name|c
operator|->
name|atphys
operator|>>
literal|16
argument_list|)
argument_list|)
expr_stmt|;
name|outw
argument_list|(
name|ATBADRL
argument_list|(
name|port
argument_list|)
argument_list|,
operator|(
name|unsigned
name|short
operator|)
name|c
operator|->
name|atphys
argument_list|)
expr_stmt|;
comment|/* set transmitter B buffer physical address */
name|c
operator|->
name|btphys
operator|=
name|vtophys
argument_list|(
name|c
operator|->
name|btbuf
argument_list|)
expr_stmt|;
name|outw
argument_list|(
name|BTBADRU
argument_list|(
name|port
argument_list|)
argument_list|,
call|(
name|unsigned
name|short
call|)
argument_list|(
name|c
operator|->
name|btphys
operator|>>
literal|16
argument_list|)
argument_list|)
expr_stmt|;
name|outw
argument_list|(
name|BTBADRL
argument_list|(
name|port
argument_list|)
argument_list|,
operator|(
name|unsigned
name|short
operator|)
name|c
operator|->
name|btphys
argument_list|)
expr_stmt|;
name|c
operator|->
name|dtr
operator|=
literal|0
expr_stmt|;
name|c
operator|->
name|rts
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Control DTR signal for the channel.  * Turn it on/off.  */
end_comment

begin_function
name|void
name|cx_chan_dtr
parameter_list|(
name|cx_chan_t
modifier|*
name|c
parameter_list|,
name|int
name|on
parameter_list|)
block|{
name|c
operator|->
name|dtr
operator|=
name|on
condition|?
literal|1
else|:
literal|0
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|mode
operator|==
name|M_ASYNC
condition|)
block|{
name|outb
argument_list|(
name|CAR
argument_list|(
name|c
operator|->
name|chip
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|num
operator|&
literal|3
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|MSVR_DTR
argument_list|(
name|c
operator|->
name|chip
operator|->
name|port
argument_list|)
argument_list|,
name|on
condition|?
name|MSV_DTR
else|:
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
switch|switch
condition|(
name|c
operator|->
name|num
condition|)
block|{
default|default:
comment|/* Channels 4..7 and 12..15 in syncronous mode 		 * have no DTR signal. */
break|break;
case|case
literal|1
case|:
case|case
literal|2
case|:
case|case
literal|3
case|:
if|if
condition|(
name|c
operator|->
name|type
operator|==
name|T_UNIV_RS232
condition|)
break|break;
case|case
literal|0
case|:
if|if
condition|(
name|on
condition|)
name|c
operator|->
name|board
operator|->
name|bcr1
operator||=
literal|0x100
operator|<<
name|c
operator|->
name|num
expr_stmt|;
else|else
name|c
operator|->
name|board
operator|->
name|bcr1
operator|&=
operator|~
operator|(
literal|0x100
operator|<<
name|c
operator|->
name|num
operator|)
expr_stmt|;
name|outw
argument_list|(
name|BCR1
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|board
operator|->
name|bcr1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|9
case|:
case|case
literal|10
case|:
case|case
literal|11
case|:
if|if
condition|(
name|c
operator|->
name|type
operator|==
name|T_UNIV_RS232
condition|)
break|break;
case|case
literal|8
case|:
if|if
condition|(
name|on
condition|)
name|c
operator|->
name|board
operator|->
name|bcr1b
operator||=
literal|0x100
operator|<<
operator|(
name|c
operator|->
name|num
operator|&
literal|3
operator|)
expr_stmt|;
else|else
name|c
operator|->
name|board
operator|->
name|bcr1b
operator|&=
operator|~
operator|(
literal|0x100
operator|<<
operator|(
name|c
operator|->
name|num
operator|&
literal|3
operator|)
operator|)
expr_stmt|;
name|outw
argument_list|(
name|BCR1
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
operator|+
literal|0x10
argument_list|)
argument_list|,
name|c
operator|->
name|board
operator|->
name|bcr1b
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/*  * Control RTS signal for the channel.  * Turn it on/off.  */
end_comment

begin_function
name|void
name|cx_chan_rts
parameter_list|(
name|cx_chan_t
modifier|*
name|c
parameter_list|,
name|int
name|on
parameter_list|)
block|{
name|c
operator|->
name|rts
operator|=
name|on
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|outb
argument_list|(
name|CAR
argument_list|(
name|c
operator|->
name|chip
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|num
operator|&
literal|3
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|MSVR_RTS
argument_list|(
name|c
operator|->
name|chip
operator|->
name|port
argument_list|)
argument_list|,
name|on
condition|?
name|MSV_RTS
else|:
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Get the state of CARRIER signal of the channel.  */
end_comment

begin_function
name|int
name|cx_chan_cd
parameter_list|(
name|cx_chan_t
modifier|*
name|c
parameter_list|)
block|{
name|unsigned
name|char
name|sigval
decl_stmt|;
if|if
condition|(
name|c
operator|->
name|mode
operator|==
name|M_ASYNC
condition|)
block|{
name|outb
argument_list|(
name|CAR
argument_list|(
name|c
operator|->
name|chip
operator|->
name|port
argument_list|)
argument_list|,
name|c
operator|->
name|num
operator|&
literal|3
argument_list|)
expr_stmt|;
return|return
operator|(
name|inb
argument_list|(
name|MSVR
argument_list|(
name|c
operator|->
name|chip
operator|->
name|port
argument_list|)
argument_list|)
operator|&
name|MSV_CD
condition|?
literal|1
else|:
literal|0
operator|)
return|;
block|}
comment|/* 	 * Channels 4..7 and 12..15 don't have CD signal available. 	 */
switch|switch
condition|(
name|c
operator|->
name|num
condition|)
block|{
default|default:
return|return
operator|(
literal|1
operator|)
return|;
case|case
literal|1
case|:
case|case
literal|2
case|:
case|case
literal|3
case|:
if|if
condition|(
name|c
operator|->
name|type
operator|==
name|T_UNIV_RS232
condition|)
return|return
operator|(
literal|1
operator|)
return|;
case|case
literal|0
case|:
name|sigval
operator|=
name|inw
argument_list|(
name|BSR
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
argument_list|)
argument_list|)
operator|>>
literal|8
expr_stmt|;
break|break;
case|case
literal|9
case|:
case|case
literal|10
case|:
case|case
literal|11
case|:
if|if
condition|(
name|c
operator|->
name|type
operator|==
name|T_UNIV_RS232
condition|)
return|return
operator|(
literal|1
operator|)
return|;
case|case
literal|8
case|:
name|sigval
operator|=
name|inw
argument_list|(
name|BSR
argument_list|(
name|c
operator|->
name|board
operator|->
name|port
operator|+
literal|0x10
argument_list|)
argument_list|)
operator|>>
literal|8
expr_stmt|;
break|break;
block|}
return|return
operator|(
operator|~
name|sigval
operator|>>
literal|4
operator|>>
operator|(
name|c
operator|->
name|num
operator|&
literal|3
operator|)
operator|&
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Compute CD2400 clock values.  */
end_comment

begin_function
name|void
name|cx_clock
parameter_list|(
name|long
name|hz
parameter_list|,
name|long
name|ba
parameter_list|,
name|int
modifier|*
name|clk
parameter_list|,
name|int
modifier|*
name|div
parameter_list|)
block|{
specifier|static
name|short
name|clocktab
index|[]
init|=
block|{
literal|8
block|,
literal|32
block|,
literal|128
block|,
literal|512
block|,
literal|2048
block|,
literal|0
block|}
decl_stmt|;
for|for
control|(
operator|*
name|clk
operator|=
literal|0
init|;
name|clocktab
index|[
operator|*
name|clk
index|]
condition|;
operator|++
operator|*
name|clk
control|)
block|{
name|long
name|c
init|=
name|ba
operator|*
name|clocktab
index|[
operator|*
name|clk
index|]
decl_stmt|;
if|if
condition|(
name|hz
operator|<=
name|c
operator|*
literal|256
condition|)
block|{
operator|*
name|div
operator|=
operator|(
literal|2
operator|*
name|hz
operator|+
name|c
operator|)
operator|/
operator|(
literal|2
operator|*
name|c
operator|)
operator|-
literal|1
expr_stmt|;
return|return;
block|}
block|}
comment|/* Incorrect baud rate.  Return some meaningful values. */
operator|*
name|clk
operator|=
literal|0
expr_stmt|;
operator|*
name|div
operator|=
literal|255
expr_stmt|;
block|}
end_function

end_unit


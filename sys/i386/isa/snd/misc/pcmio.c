begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * pcmio.c -- a simple utility for controlling audio I/O  *     (rate, channels, resolution...)  *  * (C) Luigi Rizzo 1998  *  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<machine/soundcard.h>
end_include

begin_decl_stmt
name|char
modifier|*
name|usage_string
init|=
literal|"Usage: %s [-f device] [+parameters] [len:skip] file { file }\n"
literal|"where device is the device to be used (default /dev/audio)\n"
literal|"[len:skip] is the subsection of the file to be played\n"
literal|"with a '-' indicating the default\n"
literal|"and parameters is a comma-separated list containing one or more of\n"
literal|"  N             the sampling speed\n"
literal|"  stereo|mono   \n"
literal|"  cd|u8|alaw|ulaw|s16   data format\n"
literal|"  loop            loop (play cyclically)\n"
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|BLKSZ
value|32768
end_define

begin_decl_stmt
name|int
name|format
init|=
name|AFMT_MU_LAW
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|rate
init|=
literal|8000
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|stereo
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|dev
index|[
literal|128
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|audiodev
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|play
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* default */
end_comment

begin_decl_stmt
name|int
name|loop
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|skip
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|size
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|optarg
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|optind
decl_stmt|,
name|optopt
decl_stmt|,
name|opterr
decl_stmt|,
name|optreset
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|usage
parameter_list|(
name|char
modifier|*
name|s
parameter_list|)
block|{
name|printf
argument_list|(
name|usage_string
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|parse_len
parameter_list|(
name|char
modifier|*
name|s
parameter_list|)
block|{
name|int
name|par
init|=
operator|-
literal|1
decl_stmt|;
name|int
name|mul
init|=
literal|1
decl_stmt|;
name|int
name|p
init|=
name|strlen
argument_list|(
name|s
argument_list|)
decl_stmt|;
if|if
condition|(
name|p
operator|==
literal|0
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
operator|*
name|s
operator|!=
literal|'-'
condition|)
name|par
operator|=
name|atoi
argument_list|(
name|s
argument_list|)
expr_stmt|;
else|else
return|return
operator|-
literal|1
return|;
switch|switch
condition|(
name|s
index|[
name|p
operator|-
literal|1
index|]
condition|)
block|{
case|case
literal|'k'
case|:
case|case
literal|'K'
case|:
name|mul
operator|=
literal|1024
expr_stmt|;
break|break;
case|case
literal|'m'
case|:
case|case
literal|'M'
case|:
name|mul
operator|=
literal|1024
operator|*
literal|1024
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
name|mul
operator|=
name|rate
operator|*
operator|(
name|stereo
operator|+
literal|1
operator|)
expr_stmt|;
if|if
condition|(
name|format
operator|==
name|AFMT_S16_LE
condition|)
name|mul
operator|+=
name|mul
expr_stmt|;
break|break;
block|}
return|return
name|par
operator|*
name|mul
return|;
block|}
end_function

begin_function
name|void
name|parse_fmt
parameter_list|(
name|char
modifier|*
name|fmt
parameter_list|)
block|{
name|char
modifier|*
name|s
decl_stmt|;
name|int
name|v
decl_stmt|,
name|last
init|=
literal|0
decl_stmt|;
name|again
label|:
while|while
condition|(
operator|*
name|fmt
operator|&&
operator|(
operator|*
name|fmt
operator|==
literal|' '
operator|||
operator|*
name|fmt
operator|==
literal|'\t'
operator|)
condition|)
name|fmt
operator|++
expr_stmt|;
name|s
operator|=
name|fmt
expr_stmt|;
while|while
condition|(
operator|*
name|s
operator|&&
operator|!
operator|(
operator|*
name|s
operator|==
literal|','
operator|||
operator|*
name|s
operator|==
literal|':'
operator|||
operator|*
name|s
operator|==
literal|';'
operator|)
condition|)
name|s
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|s
condition|)
operator|*
name|s
operator|=
literal|'\0'
expr_stmt|;
else|else
name|last
operator|=
literal|1
expr_stmt|;
name|v
operator|=
name|atoi
argument_list|(
name|fmt
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|>
literal|0
operator|&&
name|v
operator|<
literal|1000000
condition|)
name|rate
operator|=
name|v
expr_stmt|;
else|else
block|{
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|fmt
argument_list|,
literal|"ulaw"
argument_list|)
condition|)
name|format
operator|=
name|AFMT_MU_LAW
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|fmt
argument_list|,
literal|"alaw"
argument_list|)
condition|)
name|format
operator|=
name|AFMT_A_LAW
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|fmt
argument_list|,
literal|"u8"
argument_list|)
condition|)
name|format
operator|=
name|AFMT_U8
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|fmt
argument_list|,
literal|"s16"
argument_list|)
condition|)
name|format
operator|=
name|AFMT_S16_LE
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|fmt
argument_list|,
literal|"mono"
argument_list|)
condition|)
name|stereo
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|fmt
argument_list|,
literal|"stereo"
argument_list|)
condition|)
name|stereo
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|fmt
argument_list|,
literal|"loop"
argument_list|)
condition|)
name|loop
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|fmt
argument_list|,
literal|"rec"
argument_list|)
condition|)
name|play
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|fmt
argument_list|,
literal|"play"
argument_list|)
condition|)
name|play
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|fmt
argument_list|,
literal|"cd"
argument_list|)
condition|)
block|{
name|stereo
operator|=
literal|1
expr_stmt|;
name|format
operator|=
name|AFMT_S16_LE
expr_stmt|;
name|rate
operator|=
literal|44100
expr_stmt|;
block|}
block|}
if|if
condition|(
name|last
operator|==
literal|0
condition|)
block|{
name|fmt
operator|=
name|s
operator|+
literal|1
expr_stmt|;
goto|goto
name|again
goto|;
block|}
block|}
end_function

begin_decl_stmt
name|char
name|buf
index|[
name|BLKSZ
index|]
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|c
decl_stmt|;
name|int
name|ac
init|=
name|argc
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|;
name|strcpy
argument_list|(
name|dev
argument_list|,
literal|"/dev/audio"
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"f:"
argument_list|)
operator|)
operator|!=
name|EOF
condition|)
block|{
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'f'
case|:
if|if
condition|(
name|optarg
index|[
literal|0
index|]
operator|>=
literal|'0'
operator|&&
name|optarg
index|[
literal|0
index|]
operator|<=
literal|'9'
condition|)
name|sprintf
argument_list|(
name|dev
argument_list|,
literal|"/dev/audio%s"
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
else|else
name|strcpy
argument_list|(
name|dev
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
operator|*
name|argv
index|[
name|optind
index|]
operator|==
literal|'+'
condition|)
block|{
name|parse_fmt
argument_list|(
name|argv
index|[
name|optind
index|]
operator|+
literal|1
argument_list|)
expr_stmt|;
name|optind
operator|++
expr_stmt|;
block|}
comment|/*      * assume a string with a "," and no "/" as a command      */
if|if
condition|(
name|strstr
argument_list|(
name|argv
index|[
name|optind
index|]
argument_list|,
literal|","
argument_list|)
operator|&&
operator|!
name|strstr
argument_list|(
name|argv
index|[
name|optind
index|]
argument_list|,
literal|"/"
argument_list|)
condition|)
block|{
name|parse_fmt
argument_list|(
name|argv
index|[
name|optind
index|]
argument_list|)
expr_stmt|;
name|optind
operator|++
expr_stmt|;
block|}
comment|/*      * assume a string with a ":" and no "/" as a time limit      */
if|if
condition|(
operator|(
name|p
operator|=
name|strstr
argument_list|(
name|argv
index|[
name|optind
index|]
argument_list|,
literal|":"
argument_list|)
operator|)
operator|&&
operator|!
name|strstr
argument_list|(
name|argv
index|[
name|optind
index|]
argument_list|,
literal|"/"
argument_list|)
condition|)
block|{
operator|*
name|p
operator|=
literal|'\0'
expr_stmt|;
name|size
operator|=
name|parse_len
argument_list|(
name|argv
index|[
name|optind
index|]
argument_list|)
expr_stmt|;
name|skip
operator|=
name|parse_len
argument_list|(
name|p
operator|+
literal|1
argument_list|)
expr_stmt|;
name|optind
operator|++
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Using device %s, speed %d, mode 0x%08x, %s\n"
argument_list|,
name|dev
argument_list|,
name|rate
argument_list|,
name|format
argument_list|,
name|stereo
condition|?
literal|"stereo"
else|:
literal|"mono"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"using files: "
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|optind
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"[%d] %s, "
argument_list|,
name|i
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|audiodev
operator|=
name|open
argument_list|(
name|dev
argument_list|,
name|play
condition|?
literal|1
else|:
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|audiodev
operator|<
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"failed to open %d\n"
argument_list|,
name|dev
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
name|ioctl
argument_list|(
name|audiodev
argument_list|,
name|SNDCTL_DSP_SETFMT
argument_list|,
operator|&
name|format
argument_list|)
expr_stmt|;
name|ioctl
argument_list|(
name|audiodev
argument_list|,
name|SNDCTL_DSP_STEREO
argument_list|,
operator|&
name|stereo
argument_list|)
expr_stmt|;
name|ioctl
argument_list|(
name|audiodev
argument_list|,
name|SNDCTL_DSP_SPEED
argument_list|,
operator|&
name|rate
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"-- format %d,%s,0x%08x, len %d skip %d\n"
argument_list|,
name|rate
argument_list|,
name|stereo
condition|?
literal|"stereo"
else|:
literal|"mono"
argument_list|,
name|format
argument_list|,
name|size
argument_list|,
name|skip
argument_list|)
expr_stmt|;
if|if
condition|(
name|play
condition|)
block|{
name|off_t
name|ofs
decl_stmt|;
name|int
name|limit
decl_stmt|;
name|again
label|:
for|for
control|(
name|i
operator|=
name|optind
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
block|{
name|int
name|l
init|=
operator|-
literal|2
decl_stmt|;
name|int
name|f
init|=
name|open
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
name|O_RDONLY
argument_list|)
decl_stmt|;
name|int
name|sz
decl_stmt|;
name|printf
argument_list|(
literal|"opened %s returns %d\n"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|,
name|f
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|<
literal|0
condition|)
continue|continue;
name|limit
operator|=
name|size
expr_stmt|;
if|if
condition|(
name|skip
operator|>
literal|0
condition|)
block|{
name|ofs
operator|=
name|skip
expr_stmt|;
name|lseek
argument_list|(
name|f
argument_list|,
name|ofs
argument_list|,
literal|0
comment|/* begin */
argument_list|)
expr_stmt|;
block|}
name|sz
operator|=
name|BLKSZ
expr_stmt|;
if|if
condition|(
name|limit
operator|>
literal|0
operator|&&
name|limit
operator|<
name|sz
condition|)
name|sz
operator|=
name|limit
expr_stmt|;
while|while
condition|(
operator|(
name|l
operator|=
name|read
argument_list|(
name|f
argument_list|,
name|buf
argument_list|,
name|sz
argument_list|)
operator|)
operator|>
literal|0
condition|)
block|{
name|write
argument_list|(
name|audiodev
argument_list|,
name|buf
argument_list|,
name|l
argument_list|)
expr_stmt|;
if|if
condition|(
name|limit
operator|>
literal|0
condition|)
block|{
name|limit
operator|-=
name|l
expr_stmt|;
if|if
condition|(
name|limit
operator|>
literal|0
operator|&&
name|limit
operator|<
name|sz
condition|)
name|sz
operator|=
name|limit
expr_stmt|;
if|if
condition|(
name|limit
operator|<=
literal|0
condition|)
break|break;
if|if
condition|(
name|limit
operator|<
name|sz
condition|)
name|sz
operator|=
name|limit
expr_stmt|;
block|}
block|}
name|close
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|loop
condition|)
goto|goto
name|again
goto|;
block|}
else|else
block|{
comment|/* record */
name|int
name|l
init|=
operator|-
literal|2
decl_stmt|;
name|int
name|f
decl_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|optind
index|]
argument_list|,
literal|"-"
argument_list|)
condition|)
name|f
operator|=
literal|1
expr_stmt|;
else|else
name|f
operator|=
name|open
argument_list|(
name|argv
index|[
name|optind
index|]
argument_list|,
name|O_WRONLY
operator||
name|O_CREAT
operator||
name|O_TRUNC
argument_list|,
literal|0664
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"open %s returns %d\n"
argument_list|,
name|argv
index|[
name|optind
index|]
argument_list|,
name|f
argument_list|)
expr_stmt|;
while|while
condition|(
name|size
operator|>
literal|0
operator|&&
operator|(
name|l
operator|=
name|read
argument_list|(
name|audiodev
argument_list|,
name|buf
argument_list|,
name|BLKSZ
argument_list|)
operator|)
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|l
operator|<=
name|skip
condition|)
block|{
name|skip
operator|-=
name|l
expr_stmt|;
comment|/* at most skip = 0 */
continue|continue;
block|}
else|else
block|{
comment|/* l> skip */
name|l
operator|-=
name|skip
expr_stmt|;
if|if
condition|(
name|l
operator|>
name|size
condition|)
name|l
operator|=
name|size
expr_stmt|;
name|write
argument_list|(
name|f
argument_list|,
name|buf
operator|+
name|skip
argument_list|,
name|l
argument_list|)
expr_stmt|;
name|skip
operator|=
literal|0
expr_stmt|;
name|size
operator|-=
name|l
expr_stmt|;
block|}
block|}
name|close
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
block|}
end_function

end_unit


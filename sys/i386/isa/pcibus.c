begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/************************************************************************** ** ** $FreeBSD$ ** **  pci bus subroutines for i386 architecture. ** **  FreeBSD ** **------------------------------------------------------------------------- ** ** Copyright (c) 1994 Wolfgang Stanglmeier.  All rights reserved. ** ** Redistribution and use in source and binary forms, with or without ** modification, are permitted provided that the following conditions ** are met: ** 1. Redistributions of source code must retain the above copyright **    notice, this list of conditions and the following disclaimer. ** 2. Redistributions in binary form must reproduce the above copyright **    notice, this list of conditions and the following disclaimer in the **    documentation and/or other materials provided with the distribution. ** 3. The name of the author may not be used to endorse or promote products **    derived from this software without specific prior written permission. ** ** THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR ** IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES ** OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. ** IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT, ** INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT ** NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, ** DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY ** THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT ** (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF ** THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE. ** *************************************************************************** */
end_comment

begin_include
include|#
directive|include
file|"vector.h"
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<i386/isa/icu.h>
end_include

begin_include
include|#
directive|include
file|<i386/isa/isa_device.h>
end_include

begin_include
include|#
directive|include
file|<pci/pcivar.h>
end_include

begin_include
include|#
directive|include
file|<pci/pcireg.h>
end_include

begin_include
include|#
directive|include
file|<pci/pcibus.h>
end_include

begin_comment
comment|/*----------------------------------------------------------------- ** **	The following functions are provided by the pci bios. **	They are used only by the pci configuration. ** **	pcibus_setup(): **		Probes for a pci system. **		Sets pci_maxdevice and pci_mechanism. ** **	pcibus_tag(): **		Creates a handle for pci configuration space access. **		This handle is given to the read/write functions. ** **	pcibus_ftag(): **		Creates a modified handle. ** **	pcibus_read(): **		Read a long word from the pci configuration space. **		Requires a tag (from pcitag) and the register **		number (should be a long word alligned one). ** **	pcibus_write(): **		Writes a long word to the pci configuration space. **		Requires a tag (from pcitag), the register number **		(should be a long word alligned one), and a value. ** **	pcibus_regirq(): **		Register an interupt handler for a pci device. **		Requires a tag (from pcitag), the register number **		(should be a long word alligned one), and a value. ** **----------------------------------------------------------------- */
end_comment

begin_function_decl
specifier|static
name|int
name|pcibus_check
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|pcibus_setup
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|pcici_t
name|pcibus_tag
parameter_list|(
name|u_char
name|bus
parameter_list|,
name|u_char
name|device
parameter_list|,
name|u_char
name|func
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|pcici_t
name|pcibus_ftag
parameter_list|(
name|pcici_t
name|tag
parameter_list|,
name|u_char
name|func
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|pcibus_bus
parameter_list|(
name|pcici_t
name|tag
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|pcibus_device
parameter_list|(
name|pcici_t
name|tag
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|pcibus_function
parameter_list|(
name|pcici_t
name|tag
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u_long
name|pcibus_read
parameter_list|(
name|pcici_t
name|tag
parameter_list|,
name|u_long
name|reg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|pcibus_write
parameter_list|(
name|pcici_t
name|tag
parameter_list|,
name|u_long
name|reg
parameter_list|,
name|u_long
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|pcibus_ihandler_attach
parameter_list|(
name|int
name|irq
parameter_list|,
name|inthand2_t
modifier|*
name|func
parameter_list|,
name|int
name|arg
parameter_list|,
name|unsigned
modifier|*
name|maskptr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|pcibus_ihandler_detach
parameter_list|(
name|int
name|irq
parameter_list|,
name|inthand2_t
modifier|*
name|func
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|pcibus_imask_include
parameter_list|(
name|int
name|irq
parameter_list|,
name|unsigned
modifier|*
name|maskptr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|pcibus_imask_exclude
parameter_list|(
name|int
name|irq
parameter_list|,
name|unsigned
modifier|*
name|maskptr
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|struct
name|pcibus
name|i386pci
init|=
block|{
literal|"pci"
block|,
name|pcibus_setup
block|,
name|pcibus_tag
block|,
name|pcibus_ftag
block|,
name|pcibus_bus
block|,
name|pcibus_device
block|,
name|pcibus_function
block|,
name|pcibus_read
block|,
name|pcibus_write
block|,
name|pcibus_ihandler_attach
block|,
name|pcibus_ihandler_detach
block|,
name|pcibus_imask_include
block|,
name|pcibus_imask_exclude
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* **	Announce structure to generic driver */
end_comment

begin_expr_stmt
name|DATA_SET
argument_list|(
name|pcibus_set
argument_list|,
name|i386pci
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*-------------------------------------------------------------------- ** **      Determine configuration mode ** **-------------------------------------------------------------------- */
end_comment

begin_define
define|#
directive|define
name|CONF1_ADDR_PORT
value|0x0cf8
end_define

begin_define
define|#
directive|define
name|CONF1_DATA_PORT
value|0x0cfc
end_define

begin_define
define|#
directive|define
name|CONF1_ENABLE
value|0x80000000ul
end_define

begin_define
define|#
directive|define
name|CONF1_ENABLE_CHK
value|0x80000000ul
end_define

begin_define
define|#
directive|define
name|CONF1_ENABLE_MSK
value|0x7ff00000ul
end_define

begin_define
define|#
directive|define
name|CONF1_ENABLE_CHK1
value|0xff000001ul
end_define

begin_define
define|#
directive|define
name|CONF1_ENABLE_MSK1
value|0x80000001ul
end_define

begin_define
define|#
directive|define
name|CONF1_ENABLE_RES1
value|0x80000000ul
end_define

begin_define
define|#
directive|define
name|CONF2_ENABLE_PORT
value|0x0cf8
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|PC98
end_ifdef

begin_define
define|#
directive|define
name|CONF2_FORWARD_PORT
value|0x0cf9
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|CONF2_FORWARD_PORT
value|0x0cfa
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|CONF2_ENABLE_CHK
value|0x0e
end_define

begin_define
define|#
directive|define
name|CONF2_ENABLE_RES
value|0x0e
end_define

begin_function
specifier|static
name|int
name|pcibus_check
parameter_list|(
name|void
parameter_list|)
block|{
name|u_char
name|device
decl_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|printf
argument_list|(
literal|"pcibus_check:\tdevice "
argument_list|)
expr_stmt|;
for|for
control|(
name|device
operator|=
literal|0
init|;
name|device
operator|<
name|pci_maxdevice
condition|;
name|device
operator|++
control|)
block|{
name|unsigned
name|long
name|id
decl_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|printf
argument_list|(
literal|"%d "
argument_list|,
name|device
argument_list|)
expr_stmt|;
name|id
operator|=
name|pcibus_read
argument_list|(
name|pcibus_tag
argument_list|(
literal|0
argument_list|,
name|device
argument_list|,
literal|0
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|id
operator|&&
name|id
operator|!=
literal|0xfffffffful
condition|)
block|{
if|if
condition|(
name|bootverbose
condition|)
name|printf
argument_list|(
literal|"is there (id=%08lx)\n"
argument_list|,
name|id
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
block|}
if|if
condition|(
name|bootverbose
condition|)
name|printf
argument_list|(
literal|"-- nothing found\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|pcibus_setup
parameter_list|(
name|void
parameter_list|)
block|{
name|unsigned
name|long
name|mode1res
decl_stmt|,
name|oldval1
decl_stmt|;
name|unsigned
name|char
name|mode2res
decl_stmt|,
name|oldval2
decl_stmt|;
name|oldval1
operator|=
name|inl
argument_list|(
name|CONF1_ADDR_PORT
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
block|{
name|printf
argument_list|(
literal|"pcibus_setup(1):\tmode 1 addr port (0x0cf8) is 0x%08lx\n"
argument_list|,
name|oldval1
argument_list|)
expr_stmt|;
block|}
comment|/*--------------------------------------- 	**      Assume configuration mechanism 1 for now ... 	**--------------------------------------- 	*/
if|if
condition|(
operator|(
name|oldval1
operator|&
name|CONF1_ENABLE_MSK
operator|)
operator|==
literal|0
condition|)
block|{
name|pci_mechanism
operator|=
literal|1
expr_stmt|;
name|pci_maxdevice
operator|=
literal|32
expr_stmt|;
name|outl
argument_list|(
name|CONF1_ADDR_PORT
argument_list|,
name|CONF1_ENABLE_CHK
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|CONF1_ADDR_PORT
operator|+
literal|3
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mode1res
operator|=
name|inl
argument_list|(
name|CONF1_ADDR_PORT
argument_list|)
expr_stmt|;
name|outl
argument_list|(
name|CONF1_ADDR_PORT
argument_list|,
name|oldval1
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|printf
argument_list|(
literal|"pcibus_setup(1a):\tmode1res=0x%08lx (0x%08lx)\n"
argument_list|,
name|mode1res
argument_list|,
name|CONF1_ENABLE_CHK
argument_list|)
expr_stmt|;
if|if
condition|(
name|mode1res
condition|)
block|{
if|if
condition|(
name|pcibus_check
argument_list|()
condition|)
return|return;
block|}
empty_stmt|;
name|outl
argument_list|(
name|CONF1_ADDR_PORT
argument_list|,
name|CONF1_ENABLE_CHK1
argument_list|)
expr_stmt|;
name|mode1res
operator|=
name|inl
argument_list|(
name|CONF1_ADDR_PORT
argument_list|)
expr_stmt|;
name|outl
argument_list|(
name|CONF1_ADDR_PORT
argument_list|,
name|oldval1
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|printf
argument_list|(
literal|"pcibus_setup(1b):\tmode1res=0x%08lx (0x%08lx)\n"
argument_list|,
name|mode1res
argument_list|,
name|CONF1_ENABLE_CHK1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|mode1res
operator|&
name|CONF1_ENABLE_MSK1
operator|)
operator|==
name|CONF1_ENABLE_RES1
condition|)
block|{
if|if
condition|(
name|pcibus_check
argument_list|()
condition|)
return|return;
block|}
empty_stmt|;
block|}
comment|/*--------------------------------------- 	**      Try configuration mechanism 2 ... 	**--------------------------------------- 	*/
name|oldval2
operator|=
name|inb
argument_list|(
name|CONF2_ENABLE_PORT
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
block|{
name|printf
argument_list|(
literal|"pcibus_setup(2):\tmode 2 enable port (0x0cf8) is 0x%02x\n"
argument_list|,
name|oldval2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|oldval2
operator|&
literal|0xf0
operator|)
operator|==
literal|0
condition|)
block|{
name|pci_mechanism
operator|=
literal|2
expr_stmt|;
name|pci_maxdevice
operator|=
literal|16
expr_stmt|;
name|outb
argument_list|(
name|CONF2_ENABLE_PORT
argument_list|,
name|CONF2_ENABLE_CHK
argument_list|)
expr_stmt|;
name|mode2res
operator|=
name|inb
argument_list|(
name|CONF2_ENABLE_PORT
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|CONF2_ENABLE_PORT
argument_list|,
name|oldval2
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|printf
argument_list|(
literal|"pcibus_setup(2a):\tmode2res=0x%02x (0x%02x)\n"
argument_list|,
name|mode2res
argument_list|,
name|CONF2_ENABLE_CHK
argument_list|)
expr_stmt|;
if|if
condition|(
name|mode2res
operator|==
name|CONF2_ENABLE_RES
condition|)
block|{
if|if
condition|(
name|bootverbose
condition|)
name|printf
argument_list|(
literal|"pcibus_setup(2a):\tnow trying mechanism 2\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pcibus_check
argument_list|()
condition|)
return|return;
block|}
block|}
comment|/*--------------------------------------- 	**      No PCI bus host bridge found 	**--------------------------------------- 	*/
name|pci_mechanism
operator|=
literal|0
expr_stmt|;
name|pci_maxdevice
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_comment
comment|/*-------------------------------------------------------------------- ** **      Build a pcitag from bus, device and function number ** **-------------------------------------------------------------------- */
end_comment

begin_function
specifier|static
name|pcici_t
name|pcibus_tag
parameter_list|(
name|unsigned
name|char
name|bus
parameter_list|,
name|unsigned
name|char
name|device
parameter_list|,
name|unsigned
name|char
name|func
parameter_list|)
block|{
name|pcici_t
name|tag
decl_stmt|;
name|tag
operator|.
name|cfg1
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|func
operator|>=
literal|8
condition|)
return|return
name|tag
return|;
switch|switch
condition|(
name|pci_mechanism
condition|)
block|{
case|case
literal|1
case|:
if|if
condition|(
name|device
operator|<
literal|32
condition|)
block|{
name|tag
operator|.
name|cfg1
operator|=
name|CONF1_ENABLE
operator||
operator|(
operator|(
operator|(
name|u_long
operator|)
name|bus
operator|)
operator|<<
literal|16ul
operator|)
operator||
operator|(
operator|(
operator|(
name|u_long
operator|)
name|device
operator|)
operator|<<
literal|11ul
operator|)
operator||
operator|(
operator|(
operator|(
name|u_long
operator|)
name|func
operator|)
operator|<<
literal|8ul
operator|)
expr_stmt|;
block|}
break|break;
case|case
literal|2
case|:
if|if
condition|(
name|device
operator|<
literal|16
condition|)
block|{
name|tag
operator|.
name|cfg2
operator|.
name|port
operator|=
literal|0xc000
operator||
operator|(
name|device
operator|<<
literal|8ul
operator|)
expr_stmt|;
name|tag
operator|.
name|cfg2
operator|.
name|enable
operator|=
literal|0xf0
operator||
operator|(
name|func
operator|<<
literal|1ul
operator|)
expr_stmt|;
name|tag
operator|.
name|cfg2
operator|.
name|forward
operator|=
name|bus
expr_stmt|;
block|}
break|break;
block|}
empty_stmt|;
return|return
name|tag
return|;
block|}
end_function

begin_function
specifier|static
name|pcici_t
name|pcibus_ftag
parameter_list|(
name|pcici_t
name|tag
parameter_list|,
name|u_char
name|func
parameter_list|)
block|{
switch|switch
condition|(
name|pci_mechanism
condition|)
block|{
case|case
literal|1
case|:
name|tag
operator|.
name|cfg1
operator|&=
operator|~
literal|0x700ul
expr_stmt|;
name|tag
operator|.
name|cfg1
operator||=
operator|(
operator|(
operator|(
name|u_long
operator|)
name|func
operator|)
operator|<<
literal|8ul
operator|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|tag
operator|.
name|cfg2
operator|.
name|enable
operator|=
literal|0xf0
operator||
operator|(
name|func
operator|<<
literal|1ul
operator|)
expr_stmt|;
break|break;
block|}
empty_stmt|;
return|return
name|tag
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|pcibus_bus
parameter_list|(
name|pcici_t
name|tag
parameter_list|)
block|{
name|int
name|bus
decl_stmt|;
name|bus
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|pci_mechanism
condition|)
block|{
case|case
literal|1
case|:
name|bus
operator|=
operator|(
name|tag
operator|.
name|cfg1
operator|>>
literal|16
operator|)
operator|&
literal|0xff
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|bus
operator|=
name|tag
operator|.
name|cfg2
operator|.
name|forward
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|bus
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|pcibus_device
parameter_list|(
name|pcici_t
name|tag
parameter_list|)
block|{
name|int
name|device
decl_stmt|;
name|device
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|pci_mechanism
condition|)
block|{
case|case
literal|1
case|:
name|device
operator|=
operator|(
name|tag
operator|.
name|cfg1
operator|>>
literal|11
operator|)
operator|&
literal|0x1f
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|device
operator|=
operator|(
name|tag
operator|.
name|cfg2
operator|.
name|port
operator|>>
literal|8
operator|)
operator|&
literal|0x3f
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|device
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|pcibus_function
parameter_list|(
name|pcici_t
name|tag
parameter_list|)
block|{
name|int
name|function
decl_stmt|;
name|function
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|pci_mechanism
condition|)
block|{
case|case
literal|1
case|:
name|function
operator|=
operator|(
name|tag
operator|.
name|cfg1
operator|>>
literal|8
operator|)
operator|&
literal|0x7
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|function
operator|=
operator|(
name|tag
operator|.
name|cfg2
operator|.
name|enable
operator|>>
literal|1
operator|)
operator|&
literal|0x7
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|function
operator|)
return|;
block|}
end_function

begin_comment
comment|/*-------------------------------------------------------------------- ** **      Read register from configuration space. ** **-------------------------------------------------------------------- */
end_comment

begin_function
specifier|static
name|u_long
name|pcibus_read
parameter_list|(
name|pcici_t
name|tag
parameter_list|,
name|u_long
name|reg
parameter_list|)
block|{
name|u_long
name|addr
decl_stmt|,
name|data
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|tag
operator|.
name|cfg1
condition|)
return|return
operator|(
literal|0xfffffffful
operator|)
return|;
switch|switch
condition|(
name|pci_mechanism
condition|)
block|{
case|case
literal|1
case|:
name|addr
operator|=
name|tag
operator|.
name|cfg1
operator||
operator|(
name|reg
operator|&
literal|0xfc
operator|)
expr_stmt|;
ifdef|#
directive|ifdef
name|PCI_DEBUG
name|printf
argument_list|(
literal|"pci_conf_read(1): addr=%x "
argument_list|,
name|addr
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|outl
argument_list|(
name|CONF1_ADDR_PORT
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|data
operator|=
name|inl
argument_list|(
name|CONF1_DATA_PORT
argument_list|)
expr_stmt|;
name|outl
argument_list|(
name|CONF1_ADDR_PORT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|addr
operator|=
name|tag
operator|.
name|cfg2
operator|.
name|port
operator||
operator|(
name|reg
operator|&
literal|0xfc
operator|)
expr_stmt|;
ifdef|#
directive|ifdef
name|PCI_DEBUG
name|printf
argument_list|(
literal|"pci_conf_read(2): addr=%x "
argument_list|,
name|addr
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|outb
argument_list|(
name|CONF2_ENABLE_PORT
argument_list|,
name|tag
operator|.
name|cfg2
operator|.
name|enable
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|CONF2_FORWARD_PORT
argument_list|,
name|tag
operator|.
name|cfg2
operator|.
name|forward
argument_list|)
expr_stmt|;
name|data
operator|=
name|inl
argument_list|(
operator|(
name|u_short
operator|)
name|addr
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|CONF2_ENABLE_PORT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|CONF2_FORWARD_PORT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
empty_stmt|;
ifdef|#
directive|ifdef
name|PCI_DEBUG
name|printf
argument_list|(
literal|"data=%x\n"
argument_list|,
name|data
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
name|data
operator|)
return|;
block|}
end_function

begin_comment
comment|/*-------------------------------------------------------------------- ** **      Write register into configuration space. ** **-------------------------------------------------------------------- */
end_comment

begin_function
specifier|static
name|void
name|pcibus_write
parameter_list|(
name|pcici_t
name|tag
parameter_list|,
name|u_long
name|reg
parameter_list|,
name|u_long
name|data
parameter_list|)
block|{
name|u_long
name|addr
decl_stmt|;
if|if
condition|(
operator|!
name|tag
operator|.
name|cfg1
condition|)
return|return;
switch|switch
condition|(
name|pci_mechanism
condition|)
block|{
case|case
literal|1
case|:
name|addr
operator|=
name|tag
operator|.
name|cfg1
operator||
operator|(
name|reg
operator|&
literal|0xfc
operator|)
expr_stmt|;
ifdef|#
directive|ifdef
name|PCI_DEBUG
name|printf
argument_list|(
literal|"pci_conf_write(1): addr=%x data=%x\n"
argument_list|,
name|addr
argument_list|,
name|data
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|outl
argument_list|(
name|CONF1_ADDR_PORT
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|outl
argument_list|(
name|CONF1_DATA_PORT
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|outl
argument_list|(
name|CONF1_ADDR_PORT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|addr
operator|=
name|tag
operator|.
name|cfg2
operator|.
name|port
operator||
operator|(
name|reg
operator|&
literal|0xfc
operator|)
expr_stmt|;
ifdef|#
directive|ifdef
name|PCI_DEBUG
name|printf
argument_list|(
literal|"pci_conf_write(2): addr=%x data=%x\n"
argument_list|,
name|addr
argument_list|,
name|data
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|outb
argument_list|(
name|CONF2_ENABLE_PORT
argument_list|,
name|tag
operator|.
name|cfg2
operator|.
name|enable
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|CONF2_FORWARD_PORT
argument_list|,
name|tag
operator|.
name|cfg2
operator|.
name|forward
argument_list|)
expr_stmt|;
name|outl
argument_list|(
operator|(
name|u_short
operator|)
name|addr
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|CONF2_ENABLE_PORT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|CONF2_FORWARD_PORT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
empty_stmt|;
block|}
end_function

begin_comment
comment|/*----------------------------------------------------------------------- ** **	Register an interupt handler for a pci device. ** **----------------------------------------------------------------------- */
end_comment

begin_function
specifier|static
name|int
name|pcibus_ihandler_attach
parameter_list|(
name|int
name|irq
parameter_list|,
name|inthand2_t
modifier|*
name|func
parameter_list|,
name|int
name|arg
parameter_list|,
name|unsigned
modifier|*
name|maskptr
parameter_list|)
block|{
name|char
name|buf
index|[
literal|16
index|]
decl_stmt|;
name|char
modifier|*
name|cp
decl_stmt|;
name|int
name|free_id
decl_stmt|,
name|id
decl_stmt|,
name|result
decl_stmt|;
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"pci irq%d"
argument_list|,
name|irq
argument_list|)
expr_stmt|;
for|for
control|(
name|cp
operator|=
name|intrnames
operator|,
name|free_id
operator|=
literal|0
operator|,
name|id
operator|=
literal|0
init|;
name|id
operator|<
name|NR_DEVICES
condition|;
name|id
operator|++
control|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|cp
argument_list|,
name|buf
argument_list|)
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
name|free_id
operator|<=
literal|0
operator|&&
name|strcmp
argument_list|(
name|cp
argument_list|,
literal|"pci irqnn"
argument_list|)
operator|==
literal|0
condition|)
name|free_id
operator|=
name|id
expr_stmt|;
while|while
condition|(
operator|*
name|cp
operator|++
operator|!=
literal|'\0'
condition|)
empty_stmt|;
block|}
if|if
condition|(
name|id
operator|==
name|NR_DEVICES
condition|)
block|{
name|id
operator|=
name|free_id
expr_stmt|;
if|if
condition|(
name|id
operator|==
literal|0
condition|)
block|{
comment|/* 			 * All pci irq counters are in use, perhaps because 			 * config is old so there aren't any.  Abuse the 			 * clk0 counter. 			 */
name|printf
argument_list|(
literal|"pcibus_ihandler_attach: counting pci irq%d's as clk0 irqs\n"
argument_list|,
name|irq
argument_list|)
expr_stmt|;
block|}
block|}
name|result
operator|=
name|register_intr
argument_list|(
name|irq
argument_list|,
comment|/* isa irq	    */
name|id
argument_list|,
comment|/* device id    */
literal|0
argument_list|,
comment|/* flags?	    */
name|func
argument_list|,
comment|/* handler	    */
name|maskptr
argument_list|,
comment|/* mask pointer */
name|arg
argument_list|)
expr_stmt|;
comment|/* handler arg  */
if|if
condition|(
name|result
condition|)
block|{
name|printf
argument_list|(
literal|"@@@ pcibus_ihandler_attach: result=%d\n"
argument_list|,
name|result
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
empty_stmt|;
name|update_intr_masks
argument_list|()
expr_stmt|;
name|INTREN
argument_list|(
operator|(
literal|1ul
operator|<<
name|irq
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|pcibus_ihandler_detach
parameter_list|(
name|int
name|irq
parameter_list|,
name|inthand2_t
modifier|*
name|func
parameter_list|)
block|{
name|int
name|result
decl_stmt|;
name|INTRDIS
argument_list|(
operator|(
literal|1ul
operator|<<
name|irq
operator|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|unregister_intr
argument_list|(
name|irq
argument_list|,
name|func
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
condition|)
name|printf
argument_list|(
literal|"@@@ pcibus_ihandler_detach: result=%d\n"
argument_list|,
name|result
argument_list|)
expr_stmt|;
name|update_intr_masks
argument_list|()
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|pcibus_imask_include
parameter_list|(
name|int
name|irq
parameter_list|,
name|unsigned
modifier|*
name|maskptr
parameter_list|)
block|{
name|unsigned
name|mask
decl_stmt|;
if|if
condition|(
operator|!
name|maskptr
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|mask
operator|=
literal|1ul
operator|<<
name|irq
expr_stmt|;
if|if
condition|(
operator|*
name|maskptr
operator|&
name|mask
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|INTRMASK
argument_list|(
operator|*
name|maskptr
argument_list|,
name|mask
argument_list|)
expr_stmt|;
name|update_intr_masks
argument_list|()
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|pcibus_imask_exclude
parameter_list|(
name|int
name|irq
parameter_list|,
name|unsigned
modifier|*
name|maskptr
parameter_list|)
block|{
name|unsigned
name|mask
decl_stmt|;
if|if
condition|(
operator|!
name|maskptr
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|mask
operator|=
literal|1ul
operator|<<
name|irq
expr_stmt|;
if|if
condition|(
operator|!
operator|(
operator|*
name|maskptr
operator|&
name|mask
operator|)
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
operator|*
name|maskptr
operator|&=
operator|~
name|mask
expr_stmt|;
name|update_intr_masks
argument_list|()
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


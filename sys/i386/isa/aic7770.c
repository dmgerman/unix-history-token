begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Product specific probe and attach routines for:  * 	27/284X and aic7770 motherboard SCSI controllers  *  * Copyright (c) 1995 Justin T. Gibbs  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice immediately at the beginning of the file, without modification,  *    this list of conditions, and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. Absolutely no warranty of function or purpose is made by the author  *    Justin T. Gibbs.  * 4. Modifications may be freely made to this file if the above conditions  *    are met.  *  *	$Id$  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<i386/isa/isa.h>
end_include

begin_include
include|#
directive|include
file|<i386/isa/isa_device.h>
end_include

begin_include
include|#
directive|include
file|<scsi/scsi_all.h>
end_include

begin_include
include|#
directive|include
file|<scsi/scsiconf.h>
end_include

begin_include
include|#
directive|include
file|<sys/devconf.h>
end_include

begin_include
include|#
directive|include
file|<machine/cpufunc.h>
end_include

begin_include
include|#
directive|include
file|<i386/scsi/aic7xxx.h>
end_include

begin_decl_stmt
name|int
name|aic7770probe
name|__P
argument_list|(
operator|(
expr|struct
name|isa_device
operator|*
name|dev
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|aic7770_attach
name|__P
argument_list|(
operator|(
expr|struct
name|isa_device
operator|*
name|dev
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*   * Standard EISA Host ID regs  (Offset from slot base)  */
end_comment

begin_define
define|#
directive|define
name|HID0
value|0xC80
end_define

begin_comment
comment|/* 0,1: msb of ID2, 2-7: ID1      */
end_comment

begin_define
define|#
directive|define
name|HID1
value|0xC81
end_define

begin_comment
comment|/* 0-4: ID3, 5-7: LSB ID2         */
end_comment

begin_define
define|#
directive|define
name|HID2
value|0xC82
end_define

begin_comment
comment|/* product                        */
end_comment

begin_define
define|#
directive|define
name|HID3
value|0xC83
end_define

begin_comment
comment|/* firmware revision              */
end_comment

begin_define
define|#
directive|define
name|CHAR1
parameter_list|(
name|B1
parameter_list|,
name|B2
parameter_list|)
value|(((B1>>2)& 0x1F) | '@')
end_define

begin_define
define|#
directive|define
name|CHAR2
parameter_list|(
name|B1
parameter_list|,
name|B2
parameter_list|)
value|(((B1<<3)& 0x18) | ((B2>>5)& 0x7)|'@')
end_define

begin_define
define|#
directive|define
name|CHAR3
parameter_list|(
name|B1
parameter_list|,
name|B2
parameter_list|)
value|((B2& 0x1F) | '@')
end_define

begin_define
define|#
directive|define
name|MAX_SLOTS
value|16
end_define

begin_comment
comment|/* max slots on the EISA bus */
end_comment

begin_expr_stmt
specifier|static
name|ahc_slot
operator|=
literal|0
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* slot last board was found in */
end_comment

begin_decl_stmt
name|struct
name|isa_driver
name|ahcdriver
init|=
block|{
name|aic7770probe
block|,
name|aic7770_attach
block|,
literal|"ahc"
block|}
decl_stmt|;
end_decl_stmt

begin_typedef
typedef|typedef
struct|struct
block|{
name|ahc_type
name|type
decl_stmt|;
name|unsigned
name|char
name|id
decl_stmt|;
comment|/* The Last EISA Host ID reg */
block|}
name|aic7770_sig
typedef|;
end_typedef

begin_decl_stmt
specifier|static
name|struct
name|kern_devconf
name|kdc_aic7770
index|[
name|NAHC
index|]
init|=
block|{
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
comment|/* filled in by dev_attach */
literal|"ahc"
block|,
literal|0
block|,
block|{
name|MDDT_ISA
block|,
literal|0
block|,
literal|"bio"
block|}
block|,
name|isa_generic_externalize
block|,
literal|0
block|,
literal|0
block|,
name|ISA_EXTERNALLEN
block|,
operator|&
name|kdc_isa0
block|,
comment|/* parent */
literal|0
block|,
comment|/* parentdata */
name|DC_BUSY
block|,
comment|/* host adapters are always ``in use'' */
literal|"Adaptec aic7770 based SCSI host adapter"
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
specifier|inline
name|void
name|aic7770_registerdev
parameter_list|(
name|struct
name|isa_device
modifier|*
name|id
parameter_list|)
block|{
if|if
condition|(
name|id
operator|->
name|id_unit
condition|)
name|kdc_aic7770
index|[
name|id
operator|->
name|id_unit
index|]
operator|=
name|kdc_aic7770
index|[
literal|0
index|]
expr_stmt|;
name|kdc_aic7770
index|[
name|id
operator|->
name|id_unit
index|]
operator|.
name|kdc_unit
operator|=
name|id
operator|->
name|id_unit
expr_stmt|;
name|kdc_aic7770
index|[
name|id
operator|->
name|id_unit
index|]
operator|.
name|kdc_parentdata
operator|=
name|id
expr_stmt|;
name|dev_attach
argument_list|(
operator|&
name|kdc_aic7770
index|[
name|id
operator|->
name|id_unit
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|aic7770probe
parameter_list|(
name|struct
name|isa_device
modifier|*
name|dev
parameter_list|)
block|{
name|u_long
name|port
decl_stmt|;
name|int
name|i
decl_stmt|;
name|u_char
name|sig_id
index|[
literal|4
index|]
decl_stmt|;
name|aic7770_sig
name|valid_ids
index|[]
init|=
block|{
comment|/* Entries of other tested adaptors should be added here */
name|AHC_274
block|,
literal|0x71
block|,
comment|/*274x, Card*/
name|AHC_274
block|,
literal|0x70
block|,
comment|/*274x, Motherboard*/
name|AHC_284
block|,
literal|0x56
block|,
comment|/*284x, BIOS enabled*/
name|AHC_284
block|,
literal|0x57
block|,
comment|/*284x, BIOS disabled*/
block|}
decl_stmt|;
name|ahc_slot
operator|++
expr_stmt|;
while|while
condition|(
name|ahc_slot
operator|<=
name|MAX_SLOTS
condition|)
block|{
name|port
operator|=
literal|0x1000
operator|*
name|ahc_slot
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|sig_id
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
comment|/*  			* An outb is required to prime these registers on 			* VL cards 			*/
name|outb
argument_list|(
name|port
operator|+
name|HID0
argument_list|,
name|HID0
operator|+
name|i
argument_list|)
expr_stmt|;
name|sig_id
index|[
name|i
index|]
operator|=
name|inb
argument_list|(
name|port
operator|+
name|HID0
operator|+
name|i
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sig_id
index|[
literal|0
index|]
operator|==
literal|0xff
condition|)
block|{
name|ahc_slot
operator|++
expr_stmt|;
continue|continue;
block|}
comment|/* Check manufacturer's ID. */
if|if
condition|(
operator|(
name|CHAR1
argument_list|(
name|sig_id
index|[
literal|0
index|]
argument_list|,
name|sig_id
index|[
literal|1
index|]
argument_list|)
operator|==
literal|'A'
operator|)
operator|&&
operator|(
name|CHAR2
argument_list|(
name|sig_id
index|[
literal|0
index|]
argument_list|,
name|sig_id
index|[
literal|1
index|]
argument_list|)
operator|==
literal|'D'
operator|)
operator|&&
operator|(
name|CHAR3
argument_list|(
name|sig_id
index|[
literal|0
index|]
argument_list|,
name|sig_id
index|[
literal|1
index|]
argument_list|)
operator|==
literal|'P'
operator|)
operator|&&
operator|(
name|sig_id
index|[
literal|2
index|]
operator|==
literal|0x77
operator|)
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|valid_ids
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|aic7770_sig
argument_list|)
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|sig_id
index|[
literal|3
index|]
operator|==
name|valid_ids
index|[
name|i
index|]
operator|.
name|id
condition|)
block|{
name|int
name|unit
init|=
name|dev
operator|->
name|id_unit
decl_stmt|;
name|dev
operator|->
name|id_iobase
operator|=
name|port
expr_stmt|;
if|if
condition|(
name|ahcprobe
argument_list|(
name|unit
argument_list|,
name|port
argument_list|,
name|valid_ids
index|[
name|i
index|]
operator|.
name|type
argument_list|)
condition|)
block|{
comment|/* 					         * If it's there, put in it's  						 * interrupt vectors 					         */
name|dev
operator|->
name|id_irq
operator|=
operator|(
literal|1
operator|<<
name|ahcdata
index|[
name|unit
index|]
operator|->
name|vect
operator|)
expr_stmt|;
name|dev
operator|->
name|id_drq
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* EISA dma */
name|ahc_unit
operator|++
expr_stmt|;
return|return
name|IO_EISASIZE
return|;
block|}
block|}
block|}
name|ahc_slot
operator|++
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|aic7770_attach
parameter_list|(
name|dev
parameter_list|)
name|struct
name|isa_device
modifier|*
name|dev
decl_stmt|;
block|{
name|int
name|unit
init|=
name|dev
operator|->
name|id_unit
decl_stmt|;
name|aic7770_registerdev
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
name|ahc_attach
argument_list|(
name|unit
argument_list|)
return|;
block|}
end_function

end_unit


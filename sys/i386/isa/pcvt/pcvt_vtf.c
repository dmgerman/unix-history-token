begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1999, 2000 Hellmuth Michaelis  *  * Copyright (c) 1992, 1995 Hellmuth Michaelis and Joerg Wunsch.  *  * Copyright (c) 1992, 1993 Brian Dunford-Shore.  *  * All rights reserved.  *  * This code is derived from software contributed to Berkeley by  * William Jolitz and Don Ahn.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. All advertising materials mentioning features or use of this software  *    must display the following acknowledgement:  *	This product includes software developed by Hellmuth Michaelis,  *	Brian Dunford-Shore and Joerg Wunsch.  * 4. The name authors may not be used to endorse or promote products  *    derived from this software without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHORS ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHORS BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_comment
comment|/*---------------------------------------------------------------------------*  *  *	pcvt_vtf.c	VT220 Terminal Emulator Functions  *	-------------------------------------------------  *  *	Last Edit-Date: [Sun Mar 26 10:38:52 2000]  *  * $FreeBSD$  *  *---------------------------------------------------------------------------*/
end_comment

begin_define
define|#
directive|define
name|PCVT_INCLUDE_VT_SELATTR
end_define

begin_comment
comment|/* get inline function from pcvt_hdr.h */
end_comment

begin_include
include|#
directive|include
file|<i386/isa/pcvt/pcvt_hdr.h>
end_include

begin_comment
comment|/* global include */
end_comment

begin_include
include|#
directive|include
file|<i386/isa/pcvt/pcvt_tbl.h>
end_include

begin_comment
comment|/* character set conversion tables */
end_comment

begin_function_decl
specifier|static
name|void
name|clear_dld
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|init_dld
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|init_udk
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|respond
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|roll_down
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|,
name|int
name|n
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|selective_erase
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|,
name|u_short
modifier|*
name|pcrtat
parameter_list|,
name|int
name|length
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|swcsp
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|,
name|u_short
modifier|*
name|ctp
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*---------------------------------------------------------------------------*  *	DECSTBM - set top and bottom margins  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|vt_stbm
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
comment|/* both 0 => scrolling region = entire screen */
if|if
condition|(
operator|(
name|svsp
operator|->
name|parms
index|[
literal|0
index|]
operator|==
literal|0
operator|)
operator|&&
operator|(
name|svsp
operator|->
name|parms
index|[
literal|1
index|]
operator|==
literal|0
operator|)
condition|)
block|{
name|svsp
operator|->
name|cur_offset
operator|=
literal|0
expr_stmt|;
name|svsp
operator|->
name|scrr_beg
operator|=
literal|0
expr_stmt|;
name|svsp
operator|->
name|scrr_len
operator|=
name|svsp
operator|->
name|screen_rows
expr_stmt|;
name|svsp
operator|->
name|scrr_end
operator|=
name|svsp
operator|->
name|scrr_len
operator|-
literal|1
expr_stmt|;
name|svsp
operator|->
name|col
operator|=
literal|0
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|svsp
operator|->
name|parms
index|[
literal|1
index|]
operator|<=
name|svsp
operator|->
name|parms
index|[
literal|0
index|]
condition|)
return|return;
comment|/* range parm 1 */
if|if
condition|(
name|svsp
operator|->
name|parms
index|[
literal|0
index|]
operator|<
literal|1
condition|)
name|svsp
operator|->
name|parms
index|[
literal|0
index|]
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|svsp
operator|->
name|parms
index|[
literal|0
index|]
operator|>
name|svsp
operator|->
name|screen_rows
operator|-
literal|1
condition|)
name|svsp
operator|->
name|parms
index|[
literal|0
index|]
operator|=
name|svsp
operator|->
name|screen_rows
operator|-
literal|1
expr_stmt|;
comment|/* range parm 2 */
if|if
condition|(
name|svsp
operator|->
name|parms
index|[
literal|1
index|]
operator|<
literal|2
condition|)
name|svsp
operator|->
name|parms
index|[
literal|1
index|]
operator|=
literal|2
expr_stmt|;
elseif|else
if|if
condition|(
name|svsp
operator|->
name|parms
index|[
literal|1
index|]
operator|>
name|svsp
operator|->
name|screen_rows
condition|)
name|svsp
operator|->
name|parms
index|[
literal|1
index|]
operator|=
name|svsp
operator|->
name|screen_rows
expr_stmt|;
name|svsp
operator|->
name|scrr_beg
operator|=
name|svsp
operator|->
name|parms
index|[
literal|0
index|]
operator|-
literal|1
expr_stmt|;
comment|/* begin of scrolling region */
name|svsp
operator|->
name|scrr_len
operator|=
name|svsp
operator|->
name|parms
index|[
literal|1
index|]
operator|-
name|svsp
operator|->
name|parms
index|[
literal|0
index|]
operator|+
literal|1
expr_stmt|;
comment|/* no of lines */
name|svsp
operator|->
name|scrr_end
operator|=
name|svsp
operator|->
name|parms
index|[
literal|1
index|]
operator|-
literal|1
expr_stmt|;
comment|/* cursor to first pos */
if|if
condition|(
name|svsp
operator|->
name|m_om
condition|)
name|svsp
operator|->
name|cur_offset
operator|=
name|svsp
operator|->
name|scrr_beg
operator|*
name|svsp
operator|->
name|maxcol
expr_stmt|;
else|else
name|svsp
operator|->
name|cur_offset
operator|=
literal|0
expr_stmt|;
name|svsp
operator|->
name|col
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	SGR - set graphic rendition  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|vt_sgr
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
specifier|register
name|int
name|i
init|=
literal|0
decl_stmt|;
name|u_short
name|setcolor
init|=
literal|0
decl_stmt|;
name|char
name|colortouched
init|=
literal|0
decl_stmt|;
do|do
block|{
switch|switch
condition|(
name|svsp
operator|->
name|parms
index|[
name|i
operator|++
index|]
condition|)
block|{
case|case
literal|0
case|:
comment|/* reset to normal attributes */
name|svsp
operator|->
name|vtsgr
operator|=
name|VT_NORMAL
expr_stmt|;
break|break;
case|case
literal|1
case|:
comment|/* bold */
name|svsp
operator|->
name|vtsgr
operator||=
name|VT_BOLD
expr_stmt|;
break|break;
case|case
literal|4
case|:
comment|/* underline */
name|svsp
operator|->
name|vtsgr
operator||=
name|VT_UNDER
expr_stmt|;
break|break;
case|case
literal|5
case|:
comment|/* blinking */
name|svsp
operator|->
name|vtsgr
operator||=
name|VT_BLINK
expr_stmt|;
break|break;
case|case
literal|7
case|:
comment|/* reverse */
name|svsp
operator|->
name|vtsgr
operator||=
name|VT_INVERSE
expr_stmt|;
break|break;
case|case
literal|22
case|:
comment|/* not bold */
name|svsp
operator|->
name|vtsgr
operator|&=
operator|~
name|VT_BOLD
expr_stmt|;
break|break;
case|case
literal|24
case|:
comment|/* not underlined */
name|svsp
operator|->
name|vtsgr
operator|&=
operator|~
name|VT_UNDER
expr_stmt|;
break|break;
case|case
literal|25
case|:
comment|/* not blinking */
name|svsp
operator|->
name|vtsgr
operator|&=
operator|~
name|VT_BLINK
expr_stmt|;
break|break;
case|case
literal|27
case|:
comment|/* not reverse */
name|svsp
operator|->
name|vtsgr
operator|&=
operator|~
name|VT_INVERSE
expr_stmt|;
break|break;
case|case
literal|30
case|:
comment|/* foreground colors */
case|case
literal|31
case|:
case|case
literal|32
case|:
case|case
literal|33
case|:
case|case
literal|34
case|:
case|case
literal|35
case|:
case|case
literal|36
case|:
case|case
literal|37
case|:
if|if
condition|(
name|color
condition|)
block|{
name|colortouched
operator|=
literal|1
expr_stmt|;
name|setcolor
operator||=
operator|(
operator|(
name|fgansitopc
index|[
operator|(
name|svsp
operator|->
name|parms
index|[
name|i
operator|-
literal|1
index|]
operator|-
literal|30
operator|)
operator|&
literal|7
index|]
operator|)
operator|<<
literal|8
operator|)
expr_stmt|;
block|}
break|break;
case|case
literal|40
case|:
comment|/* background colors */
case|case
literal|41
case|:
case|case
literal|42
case|:
case|case
literal|43
case|:
case|case
literal|44
case|:
case|case
literal|45
case|:
case|case
literal|46
case|:
case|case
literal|47
case|:
if|if
condition|(
name|color
condition|)
block|{
name|colortouched
operator|=
literal|1
expr_stmt|;
name|setcolor
operator||=
operator|(
operator|(
name|bgansitopc
index|[
operator|(
name|svsp
operator|->
name|parms
index|[
name|i
operator|-
literal|1
index|]
operator|-
literal|40
operator|)
operator|&
literal|7
index|]
operator|)
operator|<<
literal|8
operator|)
expr_stmt|;
block|}
break|break;
block|}
block|}
do|while
condition|(
name|i
operator|<=
name|svsp
operator|->
name|parmi
condition|)
do|;
if|if
condition|(
name|color
condition|)
block|{
if|if
condition|(
name|colortouched
condition|)
name|svsp
operator|->
name|c_attr
operator|=
name|setcolor
expr_stmt|;
else|else
name|svsp
operator|->
name|c_attr
operator|=
operator|(
operator|(
name|sgr_tab_color
index|[
name|svsp
operator|->
name|vtsgr
index|]
operator|)
operator|<<
literal|8
operator|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|adaptor_type
operator|==
name|MDA_ADAPTOR
condition|)
name|svsp
operator|->
name|c_attr
operator|=
operator|(
operator|(
name|sgr_tab_imono
index|[
name|svsp
operator|->
name|vtsgr
index|]
operator|)
operator|<<
literal|8
operator|)
expr_stmt|;
else|else
name|svsp
operator|->
name|c_attr
operator|=
operator|(
operator|(
name|sgr_tab_mono
index|[
name|svsp
operator|->
name|vtsgr
index|]
operator|)
operator|<<
literal|8
operator|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	CUU - cursor up  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|vt_cuu
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
specifier|register
name|int
name|p
init|=
name|svsp
operator|->
name|parms
index|[
literal|0
index|]
decl_stmt|;
if|if
condition|(
name|p
operator|<=
literal|0
condition|)
comment|/* parameter min */
name|p
operator|=
literal|1
expr_stmt|;
name|p
operator|=
name|min
argument_list|(
name|p
argument_list|,
name|svsp
operator|->
name|row
operator|-
name|svsp
operator|->
name|scrr_beg
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|<=
literal|0
condition|)
return|return;
name|svsp
operator|->
name|cur_offset
operator|-=
operator|(
name|svsp
operator|->
name|maxcol
operator|*
name|p
operator|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	CUD - cursor down  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|vt_cud
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
specifier|register
name|int
name|p
init|=
name|svsp
operator|->
name|parms
index|[
literal|0
index|]
decl_stmt|;
if|if
condition|(
name|p
operator|<=
literal|0
condition|)
name|p
operator|=
literal|1
expr_stmt|;
name|p
operator|=
name|min
argument_list|(
name|p
argument_list|,
name|svsp
operator|->
name|scrr_end
operator|-
name|svsp
operator|->
name|row
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|<=
literal|0
condition|)
return|return;
name|svsp
operator|->
name|cur_offset
operator|+=
operator|(
name|svsp
operator|->
name|maxcol
operator|*
name|p
operator|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	CUF - cursor forward  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|vt_cuf
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
specifier|register
name|int
name|p
init|=
name|svsp
operator|->
name|parms
index|[
literal|0
index|]
decl_stmt|;
if|if
condition|(
name|svsp
operator|->
name|col
operator|==
operator|(
operator|(
name|svsp
operator|->
name|maxcol
operator|)
operator|-
literal|1
operator|)
condition|)
comment|/* already at right margin */
return|return;
if|if
condition|(
name|p
operator|<=
literal|0
condition|)
comment|/* parameter min = 1 */
name|p
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|p
operator|>
operator|(
operator|(
name|svsp
operator|->
name|maxcol
operator|)
operator|-
literal|1
operator|)
condition|)
comment|/* parameter max = 79 */
name|p
operator|=
operator|(
operator|(
name|svsp
operator|->
name|maxcol
operator|)
operator|-
literal|1
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|svsp
operator|->
name|col
operator|+
name|p
operator|)
operator|>
operator|(
operator|(
name|svsp
operator|->
name|maxcol
operator|)
operator|-
literal|1
operator|)
condition|)
comment|/* not more than right margin */
name|p
operator|=
operator|(
operator|(
name|svsp
operator|->
name|maxcol
operator|)
operator|-
literal|1
operator|)
operator|-
name|svsp
operator|->
name|col
expr_stmt|;
name|svsp
operator|->
name|cur_offset
operator|+=
name|p
expr_stmt|;
name|svsp
operator|->
name|col
operator|+=
name|p
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	CUB - cursor backward  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|vt_cub
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
specifier|register
name|int
name|p
init|=
name|svsp
operator|->
name|parms
index|[
literal|0
index|]
decl_stmt|;
if|if
condition|(
name|svsp
operator|->
name|col
operator|==
literal|0
condition|)
comment|/* already at left margin ? */
return|return;
if|if
condition|(
name|p
operator|<=
literal|0
condition|)
comment|/* parameter min = 1 */
name|p
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|p
operator|>
operator|(
operator|(
name|svsp
operator|->
name|maxcol
operator|)
operator|-
literal|1
operator|)
condition|)
comment|/* parameter max = 79 */
name|p
operator|=
operator|(
operator|(
name|svsp
operator|->
name|maxcol
operator|)
operator|-
literal|1
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|svsp
operator|->
name|col
operator|-
name|p
operator|)
operator|<=
literal|0
condition|)
comment|/* not more than left margin */
name|p
operator|=
name|svsp
operator|->
name|col
expr_stmt|;
name|svsp
operator|->
name|cur_offset
operator|-=
name|p
expr_stmt|;
name|svsp
operator|->
name|col
operator|-=
name|p
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	ED - erase in display  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|vt_clreos
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
switch|switch
condition|(
name|svsp
operator|->
name|parms
index|[
literal|0
index|]
condition|)
block|{
case|case
literal|0
case|:
name|fillw
argument_list|(
name|user_attr
operator||
literal|' '
argument_list|,
name|svsp
operator|->
name|Crtat
operator|+
name|svsp
operator|->
name|cur_offset
argument_list|,
name|svsp
operator|->
name|Crtat
operator|+
operator|(
name|svsp
operator|->
name|maxcol
operator|*
name|svsp
operator|->
name|screen_rows
operator|)
operator|-
operator|(
name|svsp
operator|->
name|Crtat
operator|+
name|svsp
operator|->
name|cur_offset
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|fillw
argument_list|(
name|user_attr
operator||
literal|' '
argument_list|,
name|svsp
operator|->
name|Crtat
argument_list|,
name|svsp
operator|->
name|Crtat
operator|+
name|svsp
operator|->
name|cur_offset
operator|-
name|svsp
operator|->
name|Crtat
operator|+
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|fillw
argument_list|(
name|user_attr
operator||
literal|' '
argument_list|,
name|svsp
operator|->
name|Crtat
argument_list|,
name|svsp
operator|->
name|maxcol
operator|*
name|svsp
operator|->
name|screen_rows
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	EL - erase in line  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|vt_clreol
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
switch|switch
condition|(
name|svsp
operator|->
name|parms
index|[
literal|0
index|]
condition|)
block|{
case|case
literal|0
case|:
name|fillw
argument_list|(
name|user_attr
operator||
literal|' '
argument_list|,
name|svsp
operator|->
name|Crtat
operator|+
name|svsp
operator|->
name|cur_offset
argument_list|,
name|svsp
operator|->
name|maxcol
operator|-
name|svsp
operator|->
name|col
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|fillw
argument_list|(
name|user_attr
operator||
literal|' '
argument_list|,
name|svsp
operator|->
name|Crtat
operator|+
name|svsp
operator|->
name|cur_offset
operator|-
name|svsp
operator|->
name|col
argument_list|,
name|svsp
operator|->
name|col
operator|+
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|fillw
argument_list|(
name|user_attr
operator||
literal|' '
argument_list|,
name|svsp
operator|->
name|Crtat
operator|+
name|svsp
operator|->
name|cur_offset
operator|-
name|svsp
operator|->
name|col
argument_list|,
name|svsp
operator|->
name|maxcol
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	CUP - cursor position / HVP - horizontal& vertical position  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|vt_curadr
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
if|if
condition|(
name|svsp
operator|->
name|m_om
condition|)
comment|/* relative to scrolling region */
block|{
if|if
condition|(
operator|(
name|svsp
operator|->
name|parms
index|[
literal|0
index|]
operator|==
literal|0
operator|)
operator|&&
operator|(
name|svsp
operator|->
name|parms
index|[
literal|1
index|]
operator|==
literal|0
operator|)
condition|)
block|{
name|svsp
operator|->
name|cur_offset
operator|=
name|svsp
operator|->
name|scrr_beg
operator|*
name|svsp
operator|->
name|maxcol
expr_stmt|;
name|svsp
operator|->
name|col
operator|=
literal|0
expr_stmt|;
name|svsp
operator|->
name|abs_write
operator|=
literal|0
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|svsp
operator|->
name|parms
index|[
literal|0
index|]
operator|<=
literal|0
condition|)
name|svsp
operator|->
name|parms
index|[
literal|0
index|]
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|svsp
operator|->
name|parms
index|[
literal|0
index|]
operator|>
name|svsp
operator|->
name|scrr_len
condition|)
name|svsp
operator|->
name|parms
index|[
literal|0
index|]
operator|=
name|svsp
operator|->
name|scrr_len
expr_stmt|;
if|if
condition|(
name|svsp
operator|->
name|parms
index|[
literal|1
index|]
operator|<=
literal|0
condition|)
name|svsp
operator|->
name|parms
index|[
literal|1
index|]
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|svsp
operator|->
name|parms
index|[
literal|1
index|]
operator|>
name|svsp
operator|->
name|maxcol
condition|)
name|svsp
operator|->
name|parms
index|[
literal|1
index|]
operator|=
name|svsp
operator|->
name|maxcol
expr_stmt|;
name|svsp
operator|->
name|cur_offset
operator|=
operator|(
name|svsp
operator|->
name|scrr_beg
operator|*
name|svsp
operator|->
name|maxcol
operator|)
operator|+
operator|(
operator|(
name|svsp
operator|->
name|parms
index|[
literal|0
index|]
operator|-
literal|1
operator|)
operator|*
name|svsp
operator|->
name|maxcol
operator|)
operator|+
name|svsp
operator|->
name|parms
index|[
literal|1
index|]
operator|-
literal|1
expr_stmt|;
name|svsp
operator|->
name|col
operator|=
name|svsp
operator|->
name|parms
index|[
literal|1
index|]
operator|-
literal|1
expr_stmt|;
name|svsp
operator|->
name|abs_write
operator|=
literal|0
expr_stmt|;
block|}
else|else
comment|/* relative to screen start */
block|{
if|if
condition|(
operator|(
name|svsp
operator|->
name|parms
index|[
literal|0
index|]
operator|==
literal|0
operator|)
operator|&&
operator|(
name|svsp
operator|->
name|parms
index|[
literal|1
index|]
operator|==
literal|0
operator|)
condition|)
block|{
name|svsp
operator|->
name|cur_offset
operator|=
literal|0
expr_stmt|;
name|svsp
operator|->
name|col
operator|=
literal|0
expr_stmt|;
name|svsp
operator|->
name|abs_write
operator|=
literal|0
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|svsp
operator|->
name|parms
index|[
literal|0
index|]
operator|<=
literal|0
condition|)
name|svsp
operator|->
name|parms
index|[
literal|0
index|]
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|svsp
operator|->
name|parms
index|[
literal|0
index|]
operator|>
name|svsp
operator|->
name|screen_rows
condition|)
name|svsp
operator|->
name|parms
index|[
literal|0
index|]
operator|=
name|svsp
operator|->
name|screen_rows
expr_stmt|;
if|if
condition|(
name|svsp
operator|->
name|parms
index|[
literal|1
index|]
operator|<=
literal|0
condition|)
name|svsp
operator|->
name|parms
index|[
literal|1
index|]
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|svsp
operator|->
name|parms
index|[
literal|1
index|]
operator|>
name|svsp
operator|->
name|maxcol
condition|)
comment|/* col */
name|svsp
operator|->
name|parms
index|[
literal|1
index|]
operator|=
name|svsp
operator|->
name|maxcol
expr_stmt|;
name|svsp
operator|->
name|cur_offset
operator|=
operator|(
operator|(
operator|(
name|svsp
operator|->
name|parms
index|[
literal|0
index|]
operator|-
literal|1
operator|)
operator|*
name|svsp
operator|->
name|maxcol
operator|)
operator|+
operator|(
name|svsp
operator|->
name|parms
index|[
literal|1
index|]
operator|-
literal|1
operator|)
operator|)
expr_stmt|;
name|svsp
operator|->
name|col
operator|=
name|svsp
operator|->
name|parms
index|[
literal|1
index|]
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|svsp
operator|->
name|cur_offset
operator|>=
operator|(
operator|(
name|svsp
operator|->
name|scrr_beg
operator|+
name|svsp
operator|->
name|scrr_len
operator|+
literal|1
operator|)
operator|*
name|svsp
operator|->
name|maxcol
operator|)
condition|)
name|svsp
operator|->
name|abs_write
operator|=
literal|1
expr_stmt|;
else|else
name|svsp
operator|->
name|abs_write
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	RIS - reset to initial state (hard emulator runtime reset)  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|vt_ris
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
name|fillw
argument_list|(
name|user_attr
operator||
literal|' '
argument_list|,
name|svsp
operator|->
name|Crtat
argument_list|,
name|svsp
operator|->
name|maxcol
operator|*
name|svsp
operator|->
name|screen_rows
argument_list|)
expr_stmt|;
name|svsp
operator|->
name|cur_offset
operator|=
literal|0
expr_stmt|;
comment|/* cursor upper left corner */
name|svsp
operator|->
name|col
operator|=
literal|0
expr_stmt|;
name|svsp
operator|->
name|row
operator|=
literal|0
expr_stmt|;
name|svsp
operator|->
name|lnm
operator|=
literal|0
expr_stmt|;
comment|/* CR only */
name|clear_dld
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
comment|/* clear download charset */
name|vt_clearudk
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
comment|/* clear user defined keys */
name|svsp
operator|->
name|selchar
operator|=
literal|0
expr_stmt|;
comment|/* selective attribute off */
name|vt_str
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
comment|/* and soft terminal reset */
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	DECSTR - soft terminal reset (SOFT emulator runtime reset)  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|vt_str
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|clr_parms
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
comment|/* escape parameter init */
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
comment|/* initial state */
name|svsp
operator|->
name|dis_fnc
operator|=
literal|0
expr_stmt|;
comment|/* display functions reset */
name|svsp
operator|->
name|sc_flag
operator|=
literal|0
expr_stmt|;
comment|/* save cursor position */
name|svsp
operator|->
name|transparent
operator|=
literal|0
expr_stmt|;
comment|/* enable control code processing */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAXTAB
condition|;
name|i
operator|++
control|)
comment|/* setup tabstops */
block|{
if|if
condition|(
operator|!
operator|(
name|i
operator|%
literal|8
operator|)
condition|)
name|svsp
operator|->
name|tab_stops
index|[
name|i
index|]
operator|=
literal|1
expr_stmt|;
else|else
name|svsp
operator|->
name|tab_stops
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
block|}
name|svsp
operator|->
name|irm
operator|=
literal|0
expr_stmt|;
comment|/* replace mode */
name|svsp
operator|->
name|m_om
operator|=
literal|0
expr_stmt|;
comment|/* origin mode */
name|svsp
operator|->
name|m_awm
operator|=
literal|1
expr_stmt|;
comment|/* auto wrap mode */
if|#
directive|if
name|PCVT_INHIBIT_NUMLOCK
name|svsp
operator|->
name|num_lock
operator|=
literal|0
expr_stmt|;
comment|/* keypad application mode */
else|#
directive|else
name|svsp
operator|->
name|num_lock
operator|=
literal|1
expr_stmt|;
comment|/* keypad numeric mode */
endif|#
directive|endif
name|svsp
operator|->
name|scroll_lock
operator|=
literal|0
expr_stmt|;
comment|/* reset keyboard modes */
name|svsp
operator|->
name|caps_lock
operator|=
literal|0
expr_stmt|;
name|svsp
operator|->
name|ckm
operator|=
literal|1
expr_stmt|;
comment|/* cursor key mode = "normal" ... */
name|svsp
operator|->
name|scrr_beg
operator|=
literal|0
expr_stmt|;
comment|/* start of scrolling region */
name|svsp
operator|->
name|scrr_len
operator|=
name|svsp
operator|->
name|screen_rows
expr_stmt|;
comment|/* no. of lines in scrolling region */
name|svsp
operator|->
name|abs_write
operator|=
literal|0
expr_stmt|;
comment|/* scrr is complete screen */
name|svsp
operator|->
name|scrr_end
operator|=
name|svsp
operator|->
name|scrr_len
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|adaptor_type
operator|==
name|EGA_ADAPTOR
operator|||
name|adaptor_type
operator|==
name|VGA_ADAPTOR
condition|)
block|{
name|svsp
operator|->
name|G0
operator|=
name|cse_ascii
expr_stmt|;
comment|/* G0 = ascii	*/
name|svsp
operator|->
name|G1
operator|=
name|cse_ascii
expr_stmt|;
comment|/* G1 = ascii	*/
name|svsp
operator|->
name|G2
operator|=
name|cse_supplemental
expr_stmt|;
comment|/* G2 = supplemental */
name|svsp
operator|->
name|G3
operator|=
name|cse_supplemental
expr_stmt|;
comment|/* G3 = supplemental */
name|svsp
operator|->
name|GL
operator|=
operator|&
name|svsp
operator|->
name|G0
expr_stmt|;
comment|/* GL = G0 */
name|svsp
operator|->
name|GR
operator|=
operator|&
name|svsp
operator|->
name|G2
expr_stmt|;
comment|/* GR = G2 */
block|}
else|else
block|{
name|svsp
operator|->
name|G0
operator|=
name|csd_ascii
expr_stmt|;
comment|/* G0 = ascii	*/
name|svsp
operator|->
name|G1
operator|=
name|csd_ascii
expr_stmt|;
comment|/* G1 = ascii	*/
name|svsp
operator|->
name|G2
operator|=
name|csd_supplemental
expr_stmt|;
comment|/* G2 = supplemental */
name|svsp
operator|->
name|G3
operator|=
name|csd_supplemental
expr_stmt|;
comment|/* G3 = supplemental */
name|svsp
operator|->
name|GL
operator|=
operator|&
name|svsp
operator|->
name|G0
expr_stmt|;
comment|/* GL = G0 */
name|svsp
operator|->
name|GR
operator|=
operator|&
name|svsp
operator|->
name|G2
expr_stmt|;
comment|/* GR = G2 */
block|}
name|svsp
operator|->
name|vtsgr
operator|=
name|VT_NORMAL
expr_stmt|;
comment|/* no attributes */
name|svsp
operator|->
name|c_attr
operator|=
name|user_attr
expr_stmt|;
comment|/* reset sgr to normal */
name|svsp
operator|->
name|selchar
operator|=
literal|0
expr_stmt|;
comment|/* selective attribute off */
name|vt_initsel
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
name|init_ufkl
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
comment|/* init user fkey labels */
name|init_sfkl
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
comment|/* init system fkey labels */
name|update_led
argument_list|()
expr_stmt|;
comment|/* update keyboard LED's */
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	RI - reverse index, move cursor up  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|vt_ri
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
if|if
condition|(
name|svsp
operator|->
name|cur_offset
operator|>=
operator|(
operator|(
name|svsp
operator|->
name|scrr_beg
operator|*
name|svsp
operator|->
name|maxcol
operator|)
operator|+
name|svsp
operator|->
name|maxcol
operator|)
condition|)
name|svsp
operator|->
name|cur_offset
operator|-=
name|svsp
operator|->
name|maxcol
expr_stmt|;
else|else
name|roll_down
argument_list|(
name|svsp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	IND - index, move cursor down  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|vt_ind
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
if|if
condition|(
name|svsp
operator|->
name|cur_offset
operator|<
operator|(
name|svsp
operator|->
name|scrr_end
operator|*
name|svsp
operator|->
name|maxcol
operator|)
condition|)
name|svsp
operator|->
name|cur_offset
operator|+=
name|svsp
operator|->
name|maxcol
expr_stmt|;
else|else
name|roll_up
argument_list|(
name|svsp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	NEL - next line, first pos of next line  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|vt_nel
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
if|if
condition|(
name|svsp
operator|->
name|cur_offset
operator|<
operator|(
name|svsp
operator|->
name|scrr_end
operator|*
name|svsp
operator|->
name|maxcol
operator|)
condition|)
block|{
name|svsp
operator|->
name|cur_offset
operator|+=
operator|(
name|svsp
operator|->
name|maxcol
operator|-
name|svsp
operator|->
name|col
operator|)
expr_stmt|;
name|svsp
operator|->
name|col
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|roll_up
argument_list|(
name|svsp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|svsp
operator|->
name|cur_offset
operator|-=
name|svsp
operator|->
name|col
expr_stmt|;
name|svsp
operator|->
name|col
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	set dec private modes, esc [ ? x h  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|vt_set_dec_priv_qm
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
switch|switch
condition|(
name|svsp
operator|->
name|parms
index|[
literal|0
index|]
condition|)
block|{
case|case
literal|0
case|:
comment|/* error, ignored */
case|case
literal|1
case|:
comment|/* CKM - cursor key mode */
name|svsp
operator|->
name|ckm
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|2
case|:
comment|/* ANM - ansi/vt52 mode */
break|break;
case|case
literal|3
case|:
comment|/* COLM - column mode */
name|vt_col
argument_list|(
name|svsp
argument_list|,
name|SCR_COL132
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
comment|/* SCLM - scrolling mode */
case|case
literal|5
case|:
comment|/* SCNM - screen mode */
break|break;
case|case
literal|6
case|:
comment|/* OM - origin mode */
name|svsp
operator|->
name|m_om
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|7
case|:
comment|/* AWM - auto wrap mode */
name|svsp
operator|->
name|m_awm
operator|=
literal|1
expr_stmt|;
name|swritefkl
argument_list|(
literal|7
argument_list|,
operator|(
name|u_char
operator|*
operator|)
literal|"AUTOWRAPENABLE *"
argument_list|,
name|svsp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|8
case|:
comment|/* ARM - auto repeat mode */
name|kbrepflag
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|9
case|:
comment|/* INLM - interlace mode */
case|case
literal|10
case|:
comment|/* EDM - edit mode */
case|case
literal|11
case|:
comment|/* LTM - line transmit mode */
case|case
literal|12
case|:
comment|/* */
case|case
literal|13
case|:
comment|/* SCFDM - space compression / field delimiting */
case|case
literal|14
case|:
comment|/* TEM - transmit execution mode */
case|case
literal|15
case|:
comment|/* */
case|case
literal|16
case|:
comment|/* EKEM - edit key execution mode */
break|break;
case|case
literal|25
case|:
comment|/* TCEM - text cursor enable mode */
if|if
condition|(
name|vsp
operator|==
name|svsp
condition|)
name|sw_cursor
argument_list|(
literal|1
argument_list|)
expr_stmt|;
comment|/* cursor on */
name|svsp
operator|->
name|cursor_on
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|42
case|:
comment|/* NRCM - 7bit NRC characters */
break|break;
block|}
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	reset dec private modes, esc [ ? x l  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|vt_reset_dec_priv_qm
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
switch|switch
condition|(
name|svsp
operator|->
name|parms
index|[
literal|0
index|]
condition|)
block|{
case|case
literal|0
case|:
comment|/* error, ignored */
case|case
literal|1
case|:
comment|/* CKM - cursor key mode */
name|svsp
operator|->
name|ckm
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|2
case|:
comment|/* ANM - ansi/vt52 mode */
break|break;
case|case
literal|3
case|:
comment|/* COLM - column mode */
name|vt_col
argument_list|(
name|svsp
argument_list|,
name|SCR_COL80
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
comment|/* SCLM - scrolling mode */
case|case
literal|5
case|:
comment|/* SCNM - screen mode */
break|break;
case|case
literal|6
case|:
comment|/* OM - origin mode */
name|svsp
operator|->
name|m_om
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|7
case|:
comment|/* AWM - auto wrap mode */
name|svsp
operator|->
name|m_awm
operator|=
literal|0
expr_stmt|;
name|swritefkl
argument_list|(
literal|7
argument_list|,
operator|(
name|u_char
operator|*
operator|)
literal|"AUTOWRAPENABLE  "
argument_list|,
name|svsp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|8
case|:
comment|/* ARM - auto repeat mode */
name|kbrepflag
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|9
case|:
comment|/* INLM - interlace mode */
case|case
literal|10
case|:
comment|/* EDM - edit mode */
case|case
literal|11
case|:
comment|/* LTM - line transmit mode */
case|case
literal|12
case|:
comment|/* */
case|case
literal|13
case|:
comment|/* SCFDM - space compression / field delimiting */
case|case
literal|14
case|:
comment|/* TEM - transmit execution mode */
case|case
literal|15
case|:
comment|/* */
case|case
literal|16
case|:
comment|/* EKEM - edit key execution mode */
break|break;
case|case
literal|25
case|:
comment|/* TCEM - text cursor enable mode */
if|if
condition|(
name|vsp
operator|==
name|svsp
condition|)
name|sw_cursor
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|/* cursor off */
name|svsp
operator|->
name|cursor_on
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|42
case|:
comment|/* NRCM - 7bit NRC characters */
break|break;
block|}
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	set ansi modes, esc [ x  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|vt_set_ansi
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
switch|switch
condition|(
name|svsp
operator|->
name|parms
index|[
literal|0
index|]
condition|)
block|{
case|case
literal|0
case|:
comment|/* error, ignored */
case|case
literal|1
case|:
comment|/* GATM - guarded area transfer mode */
case|case
literal|2
case|:
comment|/* KAM - keyboard action mode */
case|case
literal|3
case|:
comment|/* CRM - Control Representation mode */
break|break;
case|case
literal|4
case|:
comment|/* IRM - insert replacement mode */
name|svsp
operator|->
name|irm
operator|=
literal|1
expr_stmt|;
comment|/* Insert mode */
break|break;
case|case
literal|5
case|:
comment|/* SRTM - status report transfer mode */
case|case
literal|6
case|:
comment|/* ERM - erasue mode */
case|case
literal|7
case|:
comment|/* VEM - vertical editing mode */
case|case
literal|10
case|:
comment|/* HEM - horizontal editing mode */
case|case
literal|11
case|:
comment|/* PUM - position unit mode */
case|case
literal|12
case|:
comment|/* SRM - send-receive mode */
case|case
literal|13
case|:
comment|/* FEAM - format effector action mode */
case|case
literal|14
case|:
comment|/* FETM - format effector transfer mode */
case|case
literal|15
case|:
comment|/* MATM - multiple area transfer mode */
case|case
literal|16
case|:
comment|/* TTM - transfer termination */
case|case
literal|17
case|:
comment|/* SATM - selected area transfer mode */
case|case
literal|18
case|:
comment|/* TSM - tabulation stop mode */
case|case
literal|19
case|:
comment|/* EBM - editing boundary mode */
break|break;
case|case
literal|20
case|:
comment|/* LNM - line feed / newline mode */
name|svsp
operator|->
name|lnm
operator|=
literal|1
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	reset ansi modes, esc [ x  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|vt_reset_ansi
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
switch|switch
condition|(
name|svsp
operator|->
name|parms
index|[
literal|0
index|]
condition|)
block|{
case|case
literal|0
case|:
comment|/* error, ignored */
case|case
literal|1
case|:
comment|/* GATM - guarded area transfer mode */
case|case
literal|2
case|:
comment|/* KAM - keyboard action mode */
case|case
literal|3
case|:
comment|/* CRM - Control Representation mode */
break|break;
case|case
literal|4
case|:
comment|/* IRM - insert replacement mode */
name|svsp
operator|->
name|irm
operator|=
literal|0
expr_stmt|;
comment|/* Replace mode */
break|break;
case|case
literal|5
case|:
comment|/* SRTM - status report transfer mode */
case|case
literal|6
case|:
comment|/* ERM - erasue mode */
case|case
literal|7
case|:
comment|/* VEM - vertical editing mode */
case|case
literal|10
case|:
comment|/* HEM - horizontal editing mode */
case|case
literal|11
case|:
comment|/* PUM - position unit mode */
case|case
literal|12
case|:
comment|/* SRM - send-receive mode */
case|case
literal|13
case|:
comment|/* FEAM - format effector action mode */
case|case
literal|14
case|:
comment|/* FETM - format effector transfer mode */
case|case
literal|15
case|:
comment|/* MATM - multiple area transfer mode */
case|case
literal|16
case|:
comment|/* TTM - transfer termination */
case|case
literal|17
case|:
comment|/* SATM - selected area transfer mode */
case|case
literal|18
case|:
comment|/* TSM - tabulation stop mode */
case|case
literal|19
case|:
comment|/* EBM - editing boundary mode */
break|break;
case|case
literal|20
case|:
comment|/* LNM - line feed / newline mode */
name|svsp
operator|->
name|lnm
operator|=
literal|0
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	clear tab stop(s)  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|vt_clrtab
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|svsp
operator|->
name|parms
index|[
literal|0
index|]
operator|==
literal|0
condition|)
name|svsp
operator|->
name|tab_stops
index|[
name|svsp
operator|->
name|col
index|]
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|svsp
operator|->
name|parms
index|[
literal|0
index|]
operator|==
literal|3
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAXTAB
condition|;
name|i
operator|++
control|)
name|svsp
operator|->
name|tab_stops
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	DECSC - save cursor& attributes  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|vt_sc
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
name|svsp
operator|->
name|sc_flag
operator|=
literal|1
expr_stmt|;
name|svsp
operator|->
name|sc_row
operator|=
name|svsp
operator|->
name|row
expr_stmt|;
name|svsp
operator|->
name|sc_col
operator|=
name|svsp
operator|->
name|col
expr_stmt|;
name|svsp
operator|->
name|sc_cur_offset
operator|=
name|svsp
operator|->
name|cur_offset
expr_stmt|;
name|svsp
operator|->
name|sc_attr
operator|=
name|svsp
operator|->
name|c_attr
expr_stmt|;
name|svsp
operator|->
name|sc_awm
operator|=
name|svsp
operator|->
name|m_awm
expr_stmt|;
name|svsp
operator|->
name|sc_om
operator|=
name|svsp
operator|->
name|m_om
expr_stmt|;
name|svsp
operator|->
name|sc_G0
operator|=
name|svsp
operator|->
name|G0
expr_stmt|;
name|svsp
operator|->
name|sc_G1
operator|=
name|svsp
operator|->
name|G1
expr_stmt|;
name|svsp
operator|->
name|sc_G2
operator|=
name|svsp
operator|->
name|G2
expr_stmt|;
name|svsp
operator|->
name|sc_G3
operator|=
name|svsp
operator|->
name|G3
expr_stmt|;
name|svsp
operator|->
name|sc_GL
operator|=
name|svsp
operator|->
name|GL
expr_stmt|;
name|svsp
operator|->
name|sc_GR
operator|=
name|svsp
operator|->
name|GR
expr_stmt|;
name|svsp
operator|->
name|sc_sel
operator|=
name|svsp
operator|->
name|selchar
expr_stmt|;
name|svsp
operator|->
name|sc_vtsgr
operator|=
name|svsp
operator|->
name|vtsgr
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	DECRC - restore cursor& attributes  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|vt_rc
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
if|if
condition|(
name|svsp
operator|->
name|sc_flag
operator|==
literal|1
condition|)
block|{
name|svsp
operator|->
name|sc_flag
operator|=
literal|0
expr_stmt|;
name|svsp
operator|->
name|row
operator|=
name|svsp
operator|->
name|sc_row
expr_stmt|;
name|svsp
operator|->
name|col
operator|=
name|svsp
operator|->
name|sc_col
expr_stmt|;
name|svsp
operator|->
name|cur_offset
operator|=
name|svsp
operator|->
name|sc_cur_offset
expr_stmt|;
name|svsp
operator|->
name|c_attr
operator|=
name|svsp
operator|->
name|sc_attr
expr_stmt|;
name|svsp
operator|->
name|m_awm
operator|=
name|svsp
operator|->
name|sc_awm
expr_stmt|;
name|svsp
operator|->
name|m_om
operator|=
name|svsp
operator|->
name|sc_om
expr_stmt|;
name|svsp
operator|->
name|G0
operator|=
name|svsp
operator|->
name|sc_G0
expr_stmt|;
name|svsp
operator|->
name|G1
operator|=
name|svsp
operator|->
name|sc_G1
expr_stmt|;
name|svsp
operator|->
name|G2
operator|=
name|svsp
operator|->
name|sc_G2
expr_stmt|;
name|svsp
operator|->
name|G3
operator|=
name|svsp
operator|->
name|sc_G3
expr_stmt|;
name|svsp
operator|->
name|GL
operator|=
name|svsp
operator|->
name|sc_GL
expr_stmt|;
name|svsp
operator|->
name|GR
operator|=
name|svsp
operator|->
name|sc_GR
expr_stmt|;
name|svsp
operator|->
name|selchar
operator|=
name|svsp
operator|->
name|sc_sel
expr_stmt|;
name|svsp
operator|->
name|vtsgr
operator|=
name|svsp
operator|->
name|sc_vtsgr
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	designate a character set as G0, G1, G2 or G3 for 94/96 char sets  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|vt_designate
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
name|u_short
modifier|*
name|ctp
init|=
name|NULL
decl_stmt|;
name|u_char
name|ch
decl_stmt|;
if|if
condition|(
name|svsp
operator|->
name|whichi
operator|==
literal|1
condition|)
name|ch
operator|=
name|svsp
operator|->
name|which
index|[
literal|0
index|]
expr_stmt|;
else|else
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|svsp
operator|->
name|dld_id
index|[
literal|0
index|]
operator|==
literal|'\0'
condition|)
return|return;
if|if
condition|(
operator|!
operator|(
operator|(
operator|(
name|adaptor_type
operator|==
name|EGA_ADAPTOR
operator|)
operator|||
operator|(
name|adaptor_type
operator|==
name|VGA_ADAPTOR
operator|)
operator|)
operator|&&
operator|(
name|vgacs
index|[
name|svsp
operator|->
name|vga_charset
index|]
operator|.
name|secondloaded
operator|)
operator|)
condition|)
block|{
return|return;
block|}
for|for
control|(
name|i
operator|=
operator|(
name|svsp
operator|->
name|whichi
operator|)
operator|-
literal|1
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
block|{
if|if
condition|(
name|svsp
operator|->
name|which
index|[
name|i
index|]
operator|!=
name|svsp
operator|->
name|dld_id
index|[
name|i
index|]
condition|)
return|return;
block|}
ifdef|#
directive|ifdef
name|HAVECSE_DOWNLOADABLE
name|ctp
operator|=
name|cse_downloadable
expr_stmt|;
name|swcsp
argument_list|(
name|svsp
argument_list|,
name|ctp
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
if|if
condition|(
operator|(
operator|(
name|adaptor_type
operator|==
name|EGA_ADAPTOR
operator|)
operator|||
operator|(
name|adaptor_type
operator|==
name|VGA_ADAPTOR
operator|)
operator|)
operator|&&
operator|(
name|vgacs
index|[
name|svsp
operator|->
name|vga_charset
index|]
operator|.
name|secondloaded
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|ch
operator|==
name|svsp
operator|->
name|dld_id
index|[
literal|0
index|]
operator|)
operator|&&
operator|(
name|svsp
operator|->
name|dld_id
index|[
literal|1
index|]
operator|==
literal|'\0'
operator|)
condition|)
block|{
ifdef|#
directive|ifdef
name|HAVECSE_DOWNLOADABLE
name|ctp
operator|=
name|cse_downloadable
expr_stmt|;
name|swcsp
argument_list|(
name|svsp
argument_list|,
name|ctp
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'A'
case|:
comment|/* British or ISO-Latin-1 */
switch|switch
condition|(
name|svsp
operator|->
name|state
condition|)
block|{
case|case
name|STATE_BROPN
case|:
comment|/* designate G0 */
case|case
name|STATE_BRCLO
case|:
comment|/* designate G1 */
case|case
name|STATE_STAR
case|:
comment|/* designate G2 */
case|case
name|STATE_PLUS
case|:
comment|/* designate G3 */
ifdef|#
directive|ifdef
name|HAVECSE_BRITISH
name|ctp
operator|=
name|cse_british
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
name|STATE_MINUS
case|:
comment|/* designate G1 (96)*/
case|case
name|STATE_DOT
case|:
comment|/* designate G2 (96)*/
case|case
name|STATE_SLASH
case|:
comment|/* designate G3 (96)*/
ifdef|#
directive|ifdef
name|HAVECSE_ISOLATIN
name|ctp
operator|=
name|cse_isolatin
expr_stmt|;
endif|#
directive|endif
break|break;
block|}
break|break;
case|case
literal|'B'
case|:
comment|/* USASCII */
ifdef|#
directive|ifdef
name|HAVECSE_ASCII
name|ctp
operator|=
name|cse_ascii
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
literal|'C'
case|:
comment|/* Finnish */
case|case
literal|'5'
case|:
comment|/* Finnish */
ifdef|#
directive|ifdef
name|HAVECSE_FINNISH
name|ctp
operator|=
name|cse_finnish
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
literal|'E'
case|:
comment|/* Norwegian/Danish */
case|case
literal|'6'
case|:
comment|/* Norwegian/Danish */
ifdef|#
directive|ifdef
name|HAVECSE_NORWEGIANDANISH
name|ctp
operator|=
name|cse_norwegiandanish
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
literal|'H'
case|:
comment|/* Swedish */
case|case
literal|'7'
case|:
comment|/* Swedish */
ifdef|#
directive|ifdef
name|HAVECSE_SWEDISH
name|ctp
operator|=
name|cse_swedish
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
literal|'K'
case|:
comment|/* German */
ifdef|#
directive|ifdef
name|HAVECSE_GERMAN
name|ctp
operator|=
name|cse_german
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
literal|'Q'
case|:
comment|/* French Canadien */
ifdef|#
directive|ifdef
name|HAVECSE_FRENCHCANADA
name|ctp
operator|=
name|cse_frenchcanada
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
literal|'R'
case|:
comment|/* French */
ifdef|#
directive|ifdef
name|HAVECSE_FRENCH
name|ctp
operator|=
name|cse_french
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
literal|'Y'
case|:
comment|/* Italian */
ifdef|#
directive|ifdef
name|HAVECSE_ITALIAN
name|ctp
operator|=
name|cse_italian
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
literal|'Z'
case|:
comment|/* Spanish */
ifdef|#
directive|ifdef
name|HAVECSE_SPANISH
name|ctp
operator|=
name|cse_spanish
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
literal|'0'
case|:
comment|/* special graphics */
ifdef|#
directive|ifdef
name|HAVECSE_SPECIAL
name|ctp
operator|=
name|cse_special
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
literal|'1'
case|:
comment|/* alternate ROM */
ifdef|#
directive|ifdef
name|HAVECSE_ALTERNATEROM1
name|ctp
operator|=
name|cse_alternaterom1
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
literal|'2'
case|:
comment|/* alt ROM, spec graphics */
ifdef|#
directive|ifdef
name|HAVECSE_ALTERNATEROM2
name|ctp
operator|=
name|cse_alternaterom2
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
literal|'3'
case|:
comment|/* HP Roman 8, upper 128 chars*/
ifdef|#
directive|ifdef
name|HAVECSE_ROMAN8
name|ctp
operator|=
name|cse_roman8
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
literal|'4'
case|:
comment|/* Dutch */
ifdef|#
directive|ifdef
name|HAVECSE_DUTCH
name|ctp
operator|=
name|cse_dutch
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
literal|'<'
case|:
comment|/* DEC Supplemental */
ifdef|#
directive|ifdef
name|HAVECSE_SUPPLEMENTAL
name|ctp
operator|=
name|cse_supplemental
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
literal|'='
case|:
comment|/* Swiss */
ifdef|#
directive|ifdef
name|HAVECSE_SWISS
name|ctp
operator|=
name|cse_swiss
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
literal|'>'
case|:
comment|/* DEC Technical */
ifdef|#
directive|ifdef
name|HAVECSE_TECHNICAL
name|ctp
operator|=
name|cse_technical
expr_stmt|;
endif|#
directive|endif
break|break;
default|default:
break|break;
block|}
block|}
else|else
block|{
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'A'
case|:
comment|/* British or ISO-Latin-1 */
switch|switch
condition|(
name|svsp
operator|->
name|state
condition|)
block|{
case|case
name|STATE_BROPN
case|:
comment|/* designate G0 */
case|case
name|STATE_BRCLO
case|:
comment|/* designate G1 */
case|case
name|STATE_STAR
case|:
comment|/* designate G2 */
case|case
name|STATE_PLUS
case|:
comment|/* designate G3 */
ifdef|#
directive|ifdef
name|HAVECSD_BRITISH
name|ctp
operator|=
name|csd_british
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
name|STATE_MINUS
case|:
comment|/* designate G1 (96)*/
case|case
name|STATE_DOT
case|:
comment|/* designate G2 (96)*/
case|case
name|STATE_SLASH
case|:
comment|/* designate G3 (96)*/
ifdef|#
directive|ifdef
name|HAVECSD_ISOLATIN
name|ctp
operator|=
name|csd_isolatin
expr_stmt|;
endif|#
directive|endif
break|break;
block|}
break|break;
case|case
literal|'B'
case|:
comment|/* USASCII */
ifdef|#
directive|ifdef
name|HAVECSD_ASCII
name|ctp
operator|=
name|csd_ascii
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
literal|'C'
case|:
comment|/* Finnish */
case|case
literal|'5'
case|:
comment|/* Finnish */
ifdef|#
directive|ifdef
name|HAVECSD_FINNISH
name|ctp
operator|=
name|csd_finnish
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
literal|'E'
case|:
comment|/* Norwegian/Danish */
case|case
literal|'6'
case|:
comment|/* Norwegian/Danish */
ifdef|#
directive|ifdef
name|HAVECSD_NORWEGIANDANISH
name|ctp
operator|=
name|csd_norwegiandanish
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
literal|'H'
case|:
comment|/* Swedish */
case|case
literal|'7'
case|:
comment|/* Swedish */
ifdef|#
directive|ifdef
name|HAVECSD_SWEDISH
name|ctp
operator|=
name|csd_swedish
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
literal|'K'
case|:
comment|/* German */
ifdef|#
directive|ifdef
name|HAVECSD_GERMAN
name|ctp
operator|=
name|csd_german
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
literal|'Q'
case|:
comment|/* French Canadien */
ifdef|#
directive|ifdef
name|HAVECSD_FRENCHCANADA
name|ctp
operator|=
name|csd_frenchcanada
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
literal|'R'
case|:
comment|/* French */
ifdef|#
directive|ifdef
name|HAVECSD_FRENCH
name|ctp
operator|=
name|csd_french
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
literal|'Y'
case|:
comment|/* Italian */
ifdef|#
directive|ifdef
name|HAVECSD_ITALIAN
name|ctp
operator|=
name|csd_italian
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
literal|'Z'
case|:
comment|/* Spanish */
ifdef|#
directive|ifdef
name|HAVECSD_SPANISH
name|ctp
operator|=
name|csd_spanish
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
literal|'0'
case|:
comment|/* special graphics */
ifdef|#
directive|ifdef
name|HAVECSD_SPECIAL
name|ctp
operator|=
name|csd_special
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
literal|'1'
case|:
comment|/* alternate ROM */
ifdef|#
directive|ifdef
name|HAVECSD_ALTERNATEROM1
name|ctp
operator|=
name|csd_alternaterom1
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
literal|'2'
case|:
comment|/* alt ROM, spec graphics */
ifdef|#
directive|ifdef
name|HAVECSD_ALTERNATEROM2
name|ctp
operator|=
name|csd_alternaterom2
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
literal|'3'
case|:
comment|/* HP Roman 8, upper 128 chars*/
ifdef|#
directive|ifdef
name|HAVECSD_ROMAN8
name|ctp
operator|=
name|csd_roman8
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
literal|'4'
case|:
comment|/* Dutch */
ifdef|#
directive|ifdef
name|HAVECSD_DUTCH
name|ctp
operator|=
name|csd_dutch
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
literal|'<'
case|:
comment|/* DEC Supplemental */
ifdef|#
directive|ifdef
name|HAVECSD_SUPPLEMENTAL
name|ctp
operator|=
name|csd_supplemental
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
literal|'='
case|:
comment|/* Swiss */
ifdef|#
directive|ifdef
name|HAVECSD_SWISS
name|ctp
operator|=
name|csd_swiss
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
literal|'>'
case|:
comment|/* DEC Technical */
ifdef|#
directive|ifdef
name|HAVECSD_TECHNICAL
name|ctp
operator|=
name|csd_technical
expr_stmt|;
endif|#
directive|endif
break|break;
default|default:
break|break;
block|}
block|}
name|swcsp
argument_list|(
name|svsp
argument_list|,
name|ctp
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	device attributes  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|vt_da
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
specifier|static
name|u_char
modifier|*
name|response
init|=
operator|(
name|u_char
operator|*
operator|)
name|DA_VT220
decl_stmt|;
name|svsp
operator|->
name|report_chars
operator|=
name|response
expr_stmt|;
name|svsp
operator|->
name|report_count
operator|=
literal|18
expr_stmt|;
name|respond
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	screen alignment display  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|vt_aln
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
specifier|register
name|int
name|i
decl_stmt|;
name|svsp
operator|->
name|cur_offset
operator|=
literal|0
expr_stmt|;
name|svsp
operator|->
name|col
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|svsp
operator|->
name|screen_rows
operator|*
name|svsp
operator|->
name|maxcol
operator|)
condition|;
name|i
operator|++
control|)
block|{
operator|*
operator|(
name|svsp
operator|->
name|Crtat
operator|+
name|svsp
operator|->
name|cur_offset
operator|)
operator|=
name|user_attr
operator||
literal|'E'
expr_stmt|;
name|vt_selattr
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
name|svsp
operator|->
name|cur_offset
operator|++
expr_stmt|;
name|svsp
operator|->
name|col
operator|++
expr_stmt|;
block|}
name|svsp
operator|->
name|cur_offset
operator|=
literal|0
expr_stmt|;
comment|/* reset everything ! */
name|svsp
operator|->
name|col
operator|=
literal|0
expr_stmt|;
name|svsp
operator|->
name|row
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	request terminal parameters  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|vt_reqtparm
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
specifier|static
name|u_char
modifier|*
name|answr
init|=
operator|(
name|u_char
operator|*
operator|)
literal|"\033[3;1;1;120;120;1;0x"
decl_stmt|;
name|svsp
operator|->
name|report_chars
operator|=
name|answr
expr_stmt|;
name|svsp
operator|->
name|report_count
operator|=
literal|20
expr_stmt|;
name|respond
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	invoke selftest  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|vt_tst
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
name|clear_dld
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	device status reports  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|vt_dsr
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
specifier|static
name|u_char
modifier|*
name|answr
init|=
operator|(
name|u_char
operator|*
operator|)
literal|"\033[0n"
decl_stmt|;
specifier|static
name|u_char
modifier|*
name|panswr
init|=
operator|(
name|u_char
operator|*
operator|)
literal|"\033[?13n"
decl_stmt|;
comment|/* Printer Unattached */
specifier|static
name|u_char
modifier|*
name|udkanswr
init|=
operator|(
name|u_char
operator|*
operator|)
literal|"\033[?21n"
decl_stmt|;
comment|/* UDK Locked */
specifier|static
name|u_char
modifier|*
name|langanswr
init|=
operator|(
name|u_char
operator|*
operator|)
literal|"\033[?27;1n"
decl_stmt|;
comment|/* North American*/
specifier|static
name|u_char
name|buffer
index|[
literal|16
index|]
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|svsp
operator|->
name|parms
index|[
literal|0
index|]
condition|)
block|{
case|case
literal|5
case|:
comment|/* return status */
name|svsp
operator|->
name|report_chars
operator|=
name|answr
expr_stmt|;
name|svsp
operator|->
name|report_count
operator|=
literal|4
expr_stmt|;
name|respond
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|6
case|:
comment|/* return cursor position */
name|buffer
index|[
name|i
operator|++
index|]
operator|=
literal|0x1b
expr_stmt|;
name|buffer
index|[
name|i
operator|++
index|]
operator|=
literal|'['
expr_stmt|;
if|if
condition|(
operator|(
name|svsp
operator|->
name|row
operator|+
literal|1
operator|)
operator|>
literal|10
condition|)
name|buffer
index|[
name|i
operator|++
index|]
operator|=
operator|(
operator|(
name|svsp
operator|->
name|row
operator|+
literal|1
operator|)
operator|/
literal|10
operator|)
operator|+
literal|'0'
expr_stmt|;
name|buffer
index|[
name|i
operator|++
index|]
operator|=
operator|(
operator|(
name|svsp
operator|->
name|row
operator|+
literal|1
operator|)
operator|%
literal|10
operator|)
operator|+
literal|'0'
expr_stmt|;
name|buffer
index|[
name|i
operator|++
index|]
operator|=
literal|';'
expr_stmt|;
if|if
condition|(
operator|(
name|svsp
operator|->
name|col
operator|+
literal|1
operator|)
operator|>
literal|10
condition|)
name|buffer
index|[
name|i
operator|++
index|]
operator|=
operator|(
operator|(
name|svsp
operator|->
name|col
operator|+
literal|1
operator|)
operator|/
literal|10
operator|)
operator|+
literal|'0'
expr_stmt|;
name|buffer
index|[
name|i
operator|++
index|]
operator|=
operator|(
operator|(
name|svsp
operator|->
name|col
operator|+
literal|1
operator|)
operator|%
literal|10
operator|)
operator|+
literal|'0'
expr_stmt|;
name|buffer
index|[
name|i
operator|++
index|]
operator|=
literal|'R'
expr_stmt|;
name|buffer
index|[
name|i
operator|++
index|]
operator|=
literal|'\0'
expr_stmt|;
name|svsp
operator|->
name|report_chars
operator|=
name|buffer
expr_stmt|;
name|svsp
operator|->
name|report_count
operator|=
name|i
expr_stmt|;
name|respond
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|15
case|:
comment|/* return printer status */
name|svsp
operator|->
name|report_chars
operator|=
name|panswr
expr_stmt|;
name|svsp
operator|->
name|report_count
operator|=
literal|6
expr_stmt|;
name|respond
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|25
case|:
comment|/* return udk status */
name|svsp
operator|->
name|report_chars
operator|=
name|udkanswr
expr_stmt|;
name|svsp
operator|->
name|report_count
operator|=
literal|6
expr_stmt|;
name|respond
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|26
case|:
comment|/* return language status */
name|svsp
operator|->
name|report_chars
operator|=
name|langanswr
expr_stmt|;
name|svsp
operator|->
name|report_count
operator|=
literal|8
expr_stmt|;
name|respond
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|/* nothing else valid */
break|break;
block|}
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	IL - insert line  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|vt_il
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
specifier|register
name|int
name|p
init|=
name|svsp
operator|->
name|parms
index|[
literal|0
index|]
decl_stmt|;
if|if
condition|(
operator|(
name|svsp
operator|->
name|row
operator|>=
name|svsp
operator|->
name|scrr_beg
operator|)
operator|&&
operator|(
name|svsp
operator|->
name|row
operator|<=
name|svsp
operator|->
name|scrr_end
operator|)
condition|)
block|{
if|if
condition|(
name|p
operator|<=
literal|0
condition|)
name|p
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|p
operator|>
name|svsp
operator|->
name|scrr_end
operator|-
name|svsp
operator|->
name|row
condition|)
name|p
operator|=
name|svsp
operator|->
name|scrr_end
operator|-
name|svsp
operator|->
name|row
expr_stmt|;
name|svsp
operator|->
name|cur_offset
operator|-=
name|svsp
operator|->
name|col
expr_stmt|;
name|svsp
operator|->
name|col
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|svsp
operator|->
name|row
operator|==
name|svsp
operator|->
name|scrr_beg
condition|)
name|roll_down
argument_list|(
name|svsp
argument_list|,
name|p
argument_list|)
expr_stmt|;
else|else
block|{
name|bcopy
argument_list|(
name|svsp
operator|->
name|Crtat
operator|+
name|svsp
operator|->
name|cur_offset
argument_list|,
name|svsp
operator|->
name|Crtat
operator|+
name|svsp
operator|->
name|cur_offset
operator|+
operator|(
name|p
operator|*
name|svsp
operator|->
name|maxcol
operator|)
argument_list|,
name|svsp
operator|->
name|maxcol
operator|*
operator|(
name|svsp
operator|->
name|scrr_end
operator|-
name|svsp
operator|->
name|row
operator|+
literal|1
operator|-
name|p
operator|)
operator|*
name|CHR
argument_list|)
expr_stmt|;
name|fillw
argument_list|(
name|user_attr
operator||
literal|' '
argument_list|,
name|svsp
operator|->
name|Crtat
operator|+
name|svsp
operator|->
name|cur_offset
argument_list|,
name|p
operator|*
name|svsp
operator|->
name|maxcol
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	ICH - insert character  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|vt_ic
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
specifier|register
name|int
name|p
init|=
name|svsp
operator|->
name|parms
index|[
literal|0
index|]
decl_stmt|;
if|if
condition|(
name|p
operator|<=
literal|0
condition|)
name|p
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|p
operator|>
name|svsp
operator|->
name|maxcol
operator|-
name|svsp
operator|->
name|col
condition|)
name|p
operator|=
name|svsp
operator|->
name|maxcol
operator|-
name|svsp
operator|->
name|col
expr_stmt|;
while|while
condition|(
name|p
operator|--
condition|)
block|{
name|bcopy
argument_list|(
operator|(
name|svsp
operator|->
name|Crtat
operator|+
name|svsp
operator|->
name|cur_offset
operator|)
argument_list|,
operator|(
name|svsp
operator|->
name|Crtat
operator|+
name|svsp
operator|->
name|cur_offset
operator|)
operator|+
literal|1
argument_list|,
operator|(
operator|(
operator|(
name|svsp
operator|->
name|maxcol
operator|)
operator|-
literal|1
operator|)
operator|-
name|svsp
operator|->
name|col
operator|)
operator|*
name|CHR
argument_list|)
expr_stmt|;
operator|*
operator|(
name|svsp
operator|->
name|Crtat
operator|+
name|svsp
operator|->
name|cur_offset
operator|)
operator|=
name|user_attr
operator||
literal|' '
expr_stmt|;
name|vt_selattr
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	DL - delete line  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|vt_dl
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
specifier|register
name|int
name|p
init|=
name|svsp
operator|->
name|parms
index|[
literal|0
index|]
decl_stmt|;
if|if
condition|(
operator|(
name|svsp
operator|->
name|row
operator|>=
name|svsp
operator|->
name|scrr_beg
operator|)
operator|&&
operator|(
name|svsp
operator|->
name|row
operator|<=
name|svsp
operator|->
name|scrr_end
operator|)
condition|)
block|{
if|if
condition|(
name|p
operator|<=
literal|0
condition|)
name|p
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|p
operator|>
name|svsp
operator|->
name|scrr_end
operator|-
name|svsp
operator|->
name|row
condition|)
name|p
operator|=
name|svsp
operator|->
name|scrr_end
operator|-
name|svsp
operator|->
name|row
expr_stmt|;
name|svsp
operator|->
name|cur_offset
operator|-=
name|svsp
operator|->
name|col
expr_stmt|;
name|svsp
operator|->
name|col
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|svsp
operator|->
name|row
operator|==
name|svsp
operator|->
name|scrr_beg
condition|)
name|roll_up
argument_list|(
name|svsp
argument_list|,
name|p
argument_list|)
expr_stmt|;
else|else
block|{
name|bcopy
argument_list|(
name|svsp
operator|->
name|Crtat
operator|+
name|svsp
operator|->
name|cur_offset
operator|+
operator|(
name|p
operator|*
name|svsp
operator|->
name|maxcol
operator|)
argument_list|,
name|svsp
operator|->
name|Crtat
operator|+
name|svsp
operator|->
name|cur_offset
argument_list|,
name|svsp
operator|->
name|maxcol
operator|*
operator|(
name|svsp
operator|->
name|scrr_end
operator|-
name|svsp
operator|->
name|row
operator|+
literal|1
operator|-
name|p
operator|)
operator|*
name|CHR
argument_list|)
expr_stmt|;
name|fillw
argument_list|(
name|user_attr
operator||
literal|' '
argument_list|,
name|svsp
operator|->
name|Crtat
operator|+
operator|(
operator|(
name|svsp
operator|->
name|scrr_end
operator|-
name|p
operator|+
literal|1
operator|)
operator|*
name|svsp
operator|->
name|maxcol
operator|)
argument_list|,
name|p
operator|*
name|svsp
operator|->
name|maxcol
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	DCH - delete character  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|vt_dch
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
specifier|register
name|int
name|p
init|=
name|svsp
operator|->
name|parms
index|[
literal|0
index|]
decl_stmt|;
if|if
condition|(
name|p
operator|<=
literal|0
condition|)
name|p
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|p
operator|>
name|svsp
operator|->
name|maxcol
operator|-
name|svsp
operator|->
name|col
condition|)
name|p
operator|=
name|svsp
operator|->
name|maxcol
operator|-
name|svsp
operator|->
name|col
expr_stmt|;
while|while
condition|(
name|p
operator|--
condition|)
block|{
name|bcopy
argument_list|(
operator|(
name|svsp
operator|->
name|Crtat
operator|+
name|svsp
operator|->
name|cur_offset
operator|)
operator|+
literal|1
argument_list|,
operator|(
name|svsp
operator|->
name|Crtat
operator|+
name|svsp
operator|->
name|cur_offset
operator|)
argument_list|,
operator|(
operator|(
operator|(
name|svsp
operator|->
name|maxcol
operator|)
operator|-
literal|1
operator|)
operator|-
name|svsp
operator|->
name|col
operator|)
operator|*
name|CHR
argument_list|)
expr_stmt|;
operator|*
operator|(
operator|(
name|svsp
operator|->
name|Crtat
operator|+
name|svsp
operator|->
name|cur_offset
operator|)
operator|+
operator|(
operator|(
name|svsp
operator|->
name|maxcol
operator|)
operator|-
literal|1
operator|)
operator|-
name|svsp
operator|->
name|col
operator|)
operator|=
name|user_attr
operator||
literal|' '
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	scroll up  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|vt_su
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
specifier|register
name|int
name|p
init|=
name|svsp
operator|->
name|parms
index|[
literal|0
index|]
decl_stmt|;
if|if
condition|(
name|p
operator|<=
literal|0
condition|)
name|p
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|p
operator|>
name|svsp
operator|->
name|screen_rows
operator|-
literal|1
condition|)
name|p
operator|=
name|svsp
operator|->
name|screen_rows
operator|-
literal|1
expr_stmt|;
name|roll_up
argument_list|(
name|svsp
argument_list|,
name|p
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	scroll down  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|vt_sd
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
specifier|register
name|int
name|p
init|=
name|svsp
operator|->
name|parms
index|[
literal|0
index|]
decl_stmt|;
if|if
condition|(
name|p
operator|<=
literal|0
condition|)
name|p
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|p
operator|>
name|svsp
operator|->
name|screen_rows
operator|-
literal|1
condition|)
name|p
operator|=
name|svsp
operator|->
name|screen_rows
operator|-
literal|1
expr_stmt|;
name|roll_down
argument_list|(
name|svsp
argument_list|,
name|p
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	ECH - erase character  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|vt_ech
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
specifier|register
name|int
name|p
init|=
name|svsp
operator|->
name|parms
index|[
literal|0
index|]
decl_stmt|;
if|if
condition|(
name|p
operator|<=
literal|0
condition|)
name|p
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|p
operator|>
name|svsp
operator|->
name|maxcol
operator|-
name|svsp
operator|->
name|col
condition|)
name|p
operator|=
name|svsp
operator|->
name|maxcol
operator|-
name|svsp
operator|->
name|col
expr_stmt|;
name|fillw
argument_list|(
name|user_attr
operator||
literal|' '
argument_list|,
operator|(
name|svsp
operator|->
name|Crtat
operator|+
name|svsp
operator|->
name|cur_offset
operator|)
argument_list|,
name|p
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	media copy	(NO PRINTER AVAILABLE IN KERNEL ...)  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|vt_mc
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{ }
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	Device Control String State Machine Entry for:  *  *	DECUDK - user-defined keys	and  *	DECDLD - downloadable charset  *  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|vt_dcsentry
parameter_list|(
name|int
name|ch
parameter_list|,
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
switch|switch
condition|(
name|svsp
operator|->
name|dcs_state
condition|)
block|{
case|case
name|DCS_INIT
case|:
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'0'
case|:
case|case
literal|'1'
case|:
case|case
literal|'2'
case|:
case|case
literal|'3'
case|:
case|case
literal|'4'
case|:
case|case
literal|'5'
case|:
case|case
literal|'6'
case|:
case|case
literal|'7'
case|:
case|case
literal|'8'
case|:
case|case
literal|'9'
case|:
comment|/* parameters */
name|svsp
operator|->
name|parms
index|[
name|svsp
operator|->
name|parmi
index|]
operator|*=
literal|10
expr_stmt|;
name|svsp
operator|->
name|parms
index|[
name|svsp
operator|->
name|parmi
index|]
operator|+=
operator|(
name|ch
operator|-
literal|'0'
operator|)
expr_stmt|;
break|break;
case|case
literal|';'
case|:
comment|/* next parameter */
name|svsp
operator|->
name|parmi
operator|=
operator|(
name|svsp
operator|->
name|parmi
operator|+
literal|1
operator|<
name|MAXPARMS
operator|)
condition|?
name|svsp
operator|->
name|parmi
operator|+
literal|1
else|:
name|svsp
operator|->
name|parmi
expr_stmt|;
break|break;
case|case
literal|'|'
case|:
comment|/* DECUDK */
name|svsp
operator|->
name|transparent
operator|=
literal|1
expr_stmt|;
name|init_udk
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
name|svsp
operator|->
name|dcs_state
operator|=
name|DCS_AND_UDK
expr_stmt|;
break|break;
case|case
literal|'{'
case|:
comment|/* DECDLD */
name|svsp
operator|->
name|transparent
operator|=
literal|1
expr_stmt|;
name|init_dld
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
name|svsp
operator|->
name|dcs_state
operator|=
name|DCS_DLD_DSCS
expr_stmt|;
break|break;
default|default:
comment|/* failsafe */
name|svsp
operator|->
name|transparent
operator|=
literal|0
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
name|svsp
operator|->
name|dcs_state
operator|=
name|DCS_INIT
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|DCS_AND_UDK
case|:
comment|/* DCS ... | */
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'0'
case|:
case|case
literal|'1'
case|:
case|case
literal|'2'
case|:
case|case
literal|'3'
case|:
case|case
literal|'4'
case|:
case|case
literal|'5'
case|:
case|case
literal|'6'
case|:
case|case
literal|'7'
case|:
case|case
literal|'8'
case|:
case|case
literal|'9'
case|:
comment|/* fkey number */
name|svsp
operator|->
name|udk_fnckey
operator|*=
literal|10
expr_stmt|;
name|svsp
operator|->
name|udk_fnckey
operator|+=
operator|(
name|ch
operator|-
literal|'0'
operator|)
expr_stmt|;
break|break;
case|case
literal|'/'
case|:
comment|/* Key */
name|svsp
operator|->
name|dcs_state
operator|=
name|DCS_UDK_DEF
expr_stmt|;
break|break;
case|case
literal|0x1b
case|:
comment|/* ESC */
name|svsp
operator|->
name|dcs_state
operator|=
name|DCS_UDK_ESC
expr_stmt|;
break|break;
default|default:
name|svsp
operator|->
name|transparent
operator|=
literal|0
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
name|svsp
operator|->
name|dcs_state
operator|=
name|DCS_INIT
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|DCS_UDK_DEF
case|:
comment|/* DCS ... | fnckey / */
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'0'
case|:
case|case
literal|'1'
case|:
case|case
literal|'2'
case|:
case|case
literal|'3'
case|:
case|case
literal|'4'
case|:
case|case
literal|'5'
case|:
case|case
literal|'6'
case|:
case|case
literal|'7'
case|:
case|case
literal|'8'
case|:
case|case
literal|'9'
case|:
if|if
condition|(
name|svsp
operator|->
name|udk_deflow
condition|)
comment|/* low nibble */
block|{
name|svsp
operator|->
name|udk_def
index|[
name|svsp
operator|->
name|udk_defi
index|]
operator||=
operator|(
name|ch
operator|-
literal|'0'
operator|)
expr_stmt|;
name|svsp
operator|->
name|udk_deflow
operator|=
literal|0
expr_stmt|;
name|svsp
operator|->
name|udk_defi
operator|=
operator|(
name|svsp
operator|->
name|udk_defi
operator|+
literal|1
operator|>=
name|MAXUDKDEF
operator|)
condition|?
name|svsp
operator|->
name|udk_defi
else|:
name|svsp
operator|->
name|udk_defi
operator|+
literal|1
expr_stmt|;
block|}
else|else
comment|/* high nibble */
block|{
name|svsp
operator|->
name|udk_def
index|[
name|svsp
operator|->
name|udk_defi
index|]
operator|=
operator|(
operator|(
name|ch
operator|-
literal|'0'
operator|)
operator|<<
literal|4
operator|)
expr_stmt|;
name|svsp
operator|->
name|udk_deflow
operator|=
literal|1
expr_stmt|;
block|}
break|break;
case|case
literal|'a'
case|:
case|case
literal|'b'
case|:
case|case
literal|'c'
case|:
case|case
literal|'d'
case|:
case|case
literal|'e'
case|:
case|case
literal|'f'
case|:
if|if
condition|(
name|svsp
operator|->
name|udk_deflow
condition|)
comment|/* low nibble */
block|{
name|svsp
operator|->
name|udk_def
index|[
name|svsp
operator|->
name|udk_defi
index|]
operator||=
operator|(
name|ch
operator|-
literal|'a'
operator|+
literal|10
operator|)
expr_stmt|;
name|svsp
operator|->
name|udk_deflow
operator|=
literal|0
expr_stmt|;
name|svsp
operator|->
name|udk_defi
operator|=
operator|(
name|svsp
operator|->
name|udk_defi
operator|+
literal|1
operator|>=
name|MAXUDKDEF
operator|)
condition|?
name|svsp
operator|->
name|udk_defi
else|:
name|svsp
operator|->
name|udk_defi
operator|+
literal|1
expr_stmt|;
block|}
else|else
comment|/* high nibble */
block|{
name|svsp
operator|->
name|udk_def
index|[
name|svsp
operator|->
name|udk_defi
index|]
operator|=
operator|(
operator|(
name|ch
operator|-
literal|'a'
operator|+
literal|10
operator|)
operator|<<
literal|4
operator|)
expr_stmt|;
name|svsp
operator|->
name|udk_deflow
operator|=
literal|1
expr_stmt|;
block|}
break|break;
case|case
literal|'A'
case|:
case|case
literal|'B'
case|:
case|case
literal|'C'
case|:
case|case
literal|'D'
case|:
case|case
literal|'E'
case|:
case|case
literal|'F'
case|:
if|if
condition|(
name|svsp
operator|->
name|udk_deflow
condition|)
comment|/* low nibble */
block|{
name|svsp
operator|->
name|udk_def
index|[
name|svsp
operator|->
name|udk_defi
index|]
operator||=
operator|(
name|ch
operator|-
literal|'A'
operator|+
literal|10
operator|)
expr_stmt|;
name|svsp
operator|->
name|udk_deflow
operator|=
literal|0
expr_stmt|;
name|svsp
operator|->
name|udk_defi
operator|=
operator|(
name|svsp
operator|->
name|udk_defi
operator|+
literal|1
operator|>=
name|MAXUDKDEF
operator|)
condition|?
name|svsp
operator|->
name|udk_defi
else|:
name|svsp
operator|->
name|udk_defi
operator|+
literal|1
expr_stmt|;
block|}
else|else
comment|/* high nibble */
block|{
name|svsp
operator|->
name|udk_def
index|[
name|svsp
operator|->
name|udk_defi
index|]
operator|=
operator|(
operator|(
name|ch
operator|-
literal|'A'
operator|+
literal|10
operator|)
operator|<<
literal|4
operator|)
expr_stmt|;
name|svsp
operator|->
name|udk_deflow
operator|=
literal|1
expr_stmt|;
block|}
break|break;
case|case
literal|';'
case|:
comment|/* next function key */
name|vt_udk
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
name|svsp
operator|->
name|dcs_state
operator|=
name|DCS_AND_UDK
expr_stmt|;
break|break;
case|case
literal|0x1b
case|:
comment|/* ESC */
name|svsp
operator|->
name|dcs_state
operator|=
name|DCS_UDK_ESC
expr_stmt|;
break|break;
default|default:
name|svsp
operator|->
name|transparent
operator|=
literal|0
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
name|svsp
operator|->
name|dcs_state
operator|=
name|DCS_INIT
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|DCS_UDK_ESC
case|:
comment|/* DCS ... | fkey/def ... ESC */
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'\\'
case|:
comment|/* ST */
name|vt_udk
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
name|svsp
operator|->
name|transparent
operator|=
literal|0
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
name|svsp
operator|->
name|dcs_state
operator|=
name|DCS_INIT
expr_stmt|;
break|break;
default|default:
name|svsp
operator|->
name|transparent
operator|=
literal|0
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
name|svsp
operator|->
name|dcs_state
operator|=
name|DCS_INIT
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|DCS_DLD_DSCS
case|:
comment|/* got DCS ... { */
if|if
condition|(
name|ch
operator|>=
literal|' '
operator|&&
name|ch
operator|<=
literal|'/'
condition|)
comment|/* intermediates ... */
block|{
name|svsp
operator|->
name|dld_dscs
index|[
name|svsp
operator|->
name|dld_dscsi
index|]
operator|=
name|ch
expr_stmt|;
name|svsp
operator|->
name|dld_id
index|[
name|svsp
operator|->
name|dld_dscsi
index|]
operator|=
name|ch
expr_stmt|;
if|if
condition|(
name|svsp
operator|->
name|dld_dscsi
operator|>=
name|DSCS_LENGTH
condition|)
block|{
name|svsp
operator|->
name|transparent
operator|=
literal|0
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
name|svsp
operator|->
name|dcs_state
operator|=
name|DCS_INIT
expr_stmt|;
name|svsp
operator|->
name|dld_id
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
else|else
block|{
name|svsp
operator|->
name|dld_dscsi
operator|++
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|ch
operator|>=
literal|'0'
operator|&&
name|ch
operator|<=
literal|'~'
condition|)
comment|/* final .... */
block|{
name|svsp
operator|->
name|dld_dscs
index|[
name|svsp
operator|->
name|dld_dscsi
index|]
operator|=
name|ch
expr_stmt|;
name|svsp
operator|->
name|dld_id
index|[
name|svsp
operator|->
name|dld_dscsi
operator|++
index|]
operator|=
name|ch
expr_stmt|;
name|svsp
operator|->
name|dld_id
index|[
name|svsp
operator|->
name|dld_dscsi
index|]
operator|=
literal|'\0'
expr_stmt|;
name|svsp
operator|->
name|dcs_state
operator|=
name|DCS_DLD_DEF
expr_stmt|;
block|}
else|else
block|{
name|svsp
operator|->
name|transparent
operator|=
literal|0
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
name|svsp
operator|->
name|dcs_state
operator|=
name|DCS_INIT
expr_stmt|;
name|svsp
operator|->
name|dld_id
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
break|break;
case|case
name|DCS_DLD_DEF
case|:
comment|/* DCS ... { dscs */
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|0x1b
case|:
comment|/* ESC */
name|svsp
operator|->
name|dcs_state
operator|=
name|DCS_DLD_ESC
expr_stmt|;
break|break;
case|case
literal|'/'
case|:
comment|/* sixel upper / lower divider */
name|svsp
operator|->
name|dld_sixel_lower
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|';'
case|:
comment|/* character divider */
name|vt_dld
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
name|svsp
operator|->
name|parms
index|[
literal|1
index|]
operator|++
expr_stmt|;
comment|/* next char */
break|break;
default|default:
if|if
condition|(
name|svsp
operator|->
name|dld_sixel_lower
condition|)
block|{
if|if
condition|(
name|ch
operator|>=
literal|'?'
operator|&&
name|ch
operator|<=
literal|'~'
condition|)
name|svsp
operator|->
name|sixel
operator|.
name|lower
index|[
name|svsp
operator|->
name|dld_sixelli
index|]
operator|=
name|ch
operator|-
literal|'?'
expr_stmt|;
name|svsp
operator|->
name|dld_sixelli
operator|=
operator|(
name|svsp
operator|->
name|dld_sixelli
operator|+
literal|1
operator|<
name|MAXSIXEL
operator|)
condition|?
name|svsp
operator|->
name|dld_sixelli
operator|+
literal|1
else|:
name|svsp
operator|->
name|dld_sixelli
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|ch
operator|>=
literal|'?'
operator|&&
name|ch
operator|<=
literal|'~'
condition|)
name|svsp
operator|->
name|sixel
operator|.
name|upper
index|[
name|svsp
operator|->
name|dld_sixelui
index|]
operator|=
name|ch
operator|-
literal|'?'
expr_stmt|;
name|svsp
operator|->
name|dld_sixelui
operator|=
operator|(
name|svsp
operator|->
name|dld_sixelui
operator|+
literal|1
operator|<
name|MAXSIXEL
operator|)
condition|?
name|svsp
operator|->
name|dld_sixelui
operator|+
literal|1
else|:
name|svsp
operator|->
name|dld_sixelui
expr_stmt|;
block|}
break|break;
block|}
break|break;
case|case
name|DCS_DLD_ESC
case|:
comment|/* DCS ... { dscs ... / ... ESC */
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'\\'
case|:
comment|/* String Terminator ST */
name|vt_dld
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
name|svsp
operator|->
name|transparent
operator|=
literal|0
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
name|svsp
operator|->
name|dcs_state
operator|=
name|DCS_INIT
expr_stmt|;
break|break;
default|default:
name|svsp
operator|->
name|transparent
operator|=
literal|0
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
name|svsp
operator|->
name|dcs_state
operator|=
name|DCS_INIT
expr_stmt|;
name|svsp
operator|->
name|dld_id
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
break|break;
block|}
break|break;
default|default:
name|svsp
operator|->
name|transparent
operator|=
literal|0
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
name|svsp
operator|->
name|dcs_state
operator|=
name|DCS_INIT
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	User Defineable Keys  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|vt_udk
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
name|int
name|key
decl_stmt|,
name|start
decl_stmt|,
name|max
decl_stmt|,
name|i
decl_stmt|;
name|int
name|usedff
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|svsp
operator|->
name|parms
index|[
literal|0
index|]
operator|!=
literal|1
condition|)
comment|/* clear all ? */
block|{
name|vt_clearudk
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
name|svsp
operator|->
name|parms
index|[
literal|0
index|]
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|svsp
operator|->
name|udk_fnckey
operator|<
literal|17
operator|||
name|svsp
operator|->
name|udk_fnckey
operator|>
literal|34
condition|)
block|{
name|init_udk
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
return|return;
block|}
name|key
operator|=
name|svsp
operator|->
name|udk_fnckey
operator|-
literal|17
expr_stmt|;
comment|/* index into table */
if|if
condition|(
name|svsp
operator|->
name|ukt
operator|.
name|length
index|[
name|key
index|]
operator|==
literal|0
condition|)
comment|/* never used ? */
block|{
if|if
condition|(
name|svsp
operator|->
name|udkff
operator|<
name|MAXUDKDEF
operator|-
literal|2
condition|)
comment|/* space available ? */
block|{
name|start
operator|=
name|svsp
operator|->
name|udkff
expr_stmt|;
comment|/* next sequential */
name|max
operator|=
name|MAXUDKDEF
operator|-
name|svsp
operator|->
name|udkff
expr_stmt|;
comment|/* space available */
name|svsp
operator|->
name|ukt
operator|.
name|first
index|[
name|key
index|]
operator|=
name|start
expr_stmt|;
comment|/* start entry */
name|usedff
operator|=
literal|1
expr_stmt|;
comment|/* flag to update later */
block|}
else|else
comment|/* no space */
block|{
name|init_udk
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
else|else
comment|/* in use, redefine */
block|{
name|start
operator|=
name|svsp
operator|->
name|ukt
operator|.
name|first
index|[
name|key
index|]
expr_stmt|;
comment|/* start entry */
name|max
operator|=
name|svsp
operator|->
name|ukt
operator|.
name|length
index|[
name|key
index|]
expr_stmt|;
comment|/* space available */
block|}
if|if
condition|(
name|max
operator|<
literal|2
condition|)
comment|/* hmmm .. */
block|{
name|init_udk
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
return|return;
block|}
name|max
operator|--
expr_stmt|;
comment|/* adjust for tailing '\0' */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|max
operator|&&
name|i
operator|<
name|svsp
operator|->
name|udk_defi
condition|;
name|i
operator|++
control|)
name|svsp
operator|->
name|udkbuf
index|[
name|start
operator|++
index|]
operator|=
name|svsp
operator|->
name|udk_def
index|[
name|i
index|]
expr_stmt|;
name|svsp
operator|->
name|udkbuf
index|[
name|start
index|]
operator|=
literal|'\0'
expr_stmt|;
comment|/* make it a string, see pcvt_kbd.c */
name|svsp
operator|->
name|ukt
operator|.
name|length
index|[
name|key
index|]
operator|=
name|i
operator|+
literal|1
expr_stmt|;
comment|/* count for tailing '\0' */
if|if
condition|(
name|usedff
condition|)
name|svsp
operator|->
name|udkff
operator|+=
operator|(
name|i
operator|+
literal|2
operator|)
expr_stmt|;
comment|/* new start location */
name|init_udk
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	clear all User Defineable Keys  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|vt_clearudk
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
specifier|register
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAXUDKEYS
condition|;
name|i
operator|++
control|)
block|{
name|svsp
operator|->
name|ukt
operator|.
name|first
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|svsp
operator|->
name|ukt
operator|.
name|length
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
block|}
name|svsp
operator|->
name|udkff
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	Down line LoaDable Fonts  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|vt_dld
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
name|unsigned
name|char
name|vgacharset
decl_stmt|;
name|unsigned
name|char
name|vgachar
index|[
literal|16
index|]
decl_stmt|;
name|unsigned
name|char
name|vgacharb
index|[
literal|16
index|]
decl_stmt|;
if|if
condition|(
name|vgacs
index|[
name|svsp
operator|->
name|vga_charset
index|]
operator|.
name|secondloaded
condition|)
name|vgacharset
operator|=
name|vgacs
index|[
name|svsp
operator|->
name|vga_charset
index|]
operator|.
name|secondloaded
expr_stmt|;
else|else
return|return;
name|svsp
operator|->
name|parms
index|[
literal|1
index|]
operator|=
operator|(
name|svsp
operator|->
name|parms
index|[
literal|1
index|]
operator|<
literal|1
operator|)
condition|?
literal|1
else|:
operator|(
operator|(
name|svsp
operator|->
name|parms
index|[
literal|1
index|]
operator|>
literal|0x7E
operator|)
condition|?
literal|0x7E
else|:
name|svsp
operator|->
name|parms
index|[
literal|1
index|]
operator|)
expr_stmt|;
if|if
condition|(
name|svsp
operator|->
name|parms
index|[
literal|2
index|]
operator|!=
literal|1
condition|)
comment|/* Erase all characters ? */
block|{
name|clear_dld
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
name|svsp
operator|->
name|parms
index|[
literal|2
index|]
operator|=
literal|1
expr_stmt|;
comment|/* Only erase all characters once per sequence */
block|}
name|sixel_vga
argument_list|(
operator|&
operator|(
name|svsp
operator|->
name|sixel
operator|)
argument_list|,
name|vgachar
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|vgacs
index|[
name|vgacharset
index|]
operator|.
name|char_scanlines
operator|&
literal|0x1F
condition|)
block|{
case|case
literal|7
case|:
name|vga10_vga8
argument_list|(
name|vgachar
argument_list|,
name|vgacharb
argument_list|)
expr_stmt|;
break|break;
case|case
literal|9
case|:
default|default:
name|vga10_vga10
argument_list|(
name|vgachar
argument_list|,
name|vgacharb
argument_list|)
expr_stmt|;
break|break;
case|case
literal|13
case|:
name|vga10_vga14
argument_list|(
name|vgachar
argument_list|,
name|vgacharb
argument_list|)
expr_stmt|;
break|break;
case|case
literal|15
case|:
name|vga10_vga16
argument_list|(
name|vgachar
argument_list|,
name|vgacharb
argument_list|)
expr_stmt|;
break|break;
block|}
name|loadchar
argument_list|(
name|vgacharset
argument_list|,
name|svsp
operator|->
name|parms
index|[
literal|1
index|]
operator|+
literal|0xA0
argument_list|,
literal|16
argument_list|,
name|vgacharb
argument_list|)
expr_stmt|;
name|init_dld
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	select character attributes  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|vt_sca
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
switch|switch
condition|(
name|svsp
operator|->
name|parms
index|[
literal|0
index|]
condition|)
block|{
case|case
literal|1
case|:
name|svsp
operator|->
name|selchar
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|0
case|:
case|case
literal|2
case|:
default|default:
name|svsp
operator|->
name|selchar
operator|=
literal|0
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	initalize selective attribute bit array  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|vt_initsel
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
specifier|register
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAXDECSCA
condition|;
name|i
operator|++
control|)
name|svsp
operator|->
name|decsca
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	DECSEL - selective erase in line  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|vt_sel
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
switch|switch
condition|(
name|svsp
operator|->
name|parms
index|[
literal|0
index|]
condition|)
block|{
case|case
literal|0
case|:
name|selective_erase
argument_list|(
name|svsp
argument_list|,
operator|(
name|svsp
operator|->
name|Crtat
operator|+
name|svsp
operator|->
name|cur_offset
operator|)
argument_list|,
name|svsp
operator|->
name|maxcol
operator|-
name|svsp
operator|->
name|col
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|selective_erase
argument_list|(
name|svsp
argument_list|,
operator|(
name|svsp
operator|->
name|Crtat
operator|+
name|svsp
operator|->
name|cur_offset
operator|)
operator|-
name|svsp
operator|->
name|col
argument_list|,
name|svsp
operator|->
name|col
operator|+
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|selective_erase
argument_list|(
name|svsp
argument_list|,
operator|(
name|svsp
operator|->
name|Crtat
operator|+
name|svsp
operator|->
name|cur_offset
operator|)
operator|-
name|svsp
operator|->
name|col
argument_list|,
name|svsp
operator|->
name|maxcol
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	DECSED - selective erase in display  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|vt_sed
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
switch|switch
condition|(
name|svsp
operator|->
name|parms
index|[
literal|0
index|]
condition|)
block|{
case|case
literal|0
case|:
name|selective_erase
argument_list|(
name|svsp
argument_list|,
operator|(
name|svsp
operator|->
name|Crtat
operator|+
name|svsp
operator|->
name|cur_offset
operator|)
argument_list|,
name|svsp
operator|->
name|Crtat
operator|+
operator|(
name|svsp
operator|->
name|maxcol
operator|*
name|svsp
operator|->
name|screen_rows
operator|)
operator|-
operator|(
name|svsp
operator|->
name|Crtat
operator|+
name|svsp
operator|->
name|cur_offset
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|selective_erase
argument_list|(
name|svsp
argument_list|,
name|svsp
operator|->
name|Crtat
argument_list|,
operator|(
name|svsp
operator|->
name|Crtat
operator|+
name|svsp
operator|->
name|cur_offset
operator|)
operator|-
name|svsp
operator|->
name|Crtat
operator|+
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|selective_erase
argument_list|(
name|svsp
argument_list|,
name|svsp
operator|->
name|Crtat
argument_list|,
name|svsp
operator|->
name|maxcol
operator|*
name|svsp
operator|->
name|screen_rows
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	scroll screen n lines up  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|roll_up
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|,
name|int
name|n
parameter_list|)
block|{
if|if
condition|(
name|svsp
operator|->
name|scrr_beg
operator|==
literal|0
operator|&&
comment|/* if scroll region is whole screen */
name|svsp
operator|->
name|scrr_len
operator|==
name|svsp
operator|->
name|screen_rows
operator|&&
operator|(
name|svsp
operator|!=
name|vsp
operator|||
comment|/* and either running in memory */
operator|(
name|svsp
operator|->
name|screen_rows
operator|==
name|svsp
operator|->
name|screen_rowsize
operator|&&
comment|/* or no fkeys */
name|adaptor_type
operator|!=
name|MDA_ADAPTOR
operator|)
operator|)
condition|)
comment|/* and not on MDA/Hercules */
block|{
name|u_short
modifier|*
name|Memory
init|=
ifdef|#
directive|ifdef
name|XSERVER
operator|(
name|vsp
operator|!=
name|svsp
operator|||
operator|(
name|vsp
operator|->
name|vt_status
operator|&
name|VT_GRAFX
operator|)
operator|)
condition|?
else|#
directive|else
operator|(
name|vsp
operator|!=
name|svsp
operator|)
condition|?
endif|#
directive|endif
name|svsp
operator|->
name|Memory
else|:
name|Crtat
decl_stmt|;
if|if
condition|(
name|svsp
operator|->
name|Crtat
operator|>
operator|(
name|Memory
operator|+
operator|(
name|svsp
operator|->
name|screen_rows
operator|-
name|n
operator|)
operator|*
name|svsp
operator|->
name|maxcol
operator|)
condition|)
block|{
name|bcopy
argument_list|(
name|svsp
operator|->
name|Crtat
operator|+
name|svsp
operator|->
name|maxcol
operator|*
name|n
argument_list|,
name|Memory
argument_list|,
name|svsp
operator|->
name|maxcol
operator|*
operator|(
name|svsp
operator|->
name|screen_rows
operator|-
name|n
operator|)
operator|*
name|CHR
argument_list|)
expr_stmt|;
name|svsp
operator|->
name|Crtat
operator|=
name|Memory
expr_stmt|;
block|}
else|else
block|{
name|svsp
operator|->
name|Crtat
operator|+=
name|n
operator|*
name|svsp
operator|->
name|maxcol
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|XSERVER
if|if
condition|(
name|vsp
operator|==
name|svsp
operator|&&
operator|!
operator|(
name|vsp
operator|->
name|vt_status
operator|&
name|VT_GRAFX
operator|)
condition|)
else|#
directive|else
if|if
condition|(
name|vsp
operator|==
name|svsp
condition|)
endif|#
directive|endif
block|{
name|outb
argument_list|(
name|addr_6845
argument_list|,
name|CRTC_STARTADRH
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|addr_6845
operator|+
literal|1
argument_list|,
operator|(
name|svsp
operator|->
name|Crtat
operator|-
name|Crtat
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|addr_6845
argument_list|,
name|CRTC_STARTADRL
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|addr_6845
operator|+
literal|1
argument_list|,
operator|(
name|svsp
operator|->
name|Crtat
operator|-
name|Crtat
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|bcopy
argument_list|(
name|svsp
operator|->
name|Crtat
operator|+
operator|(
operator|(
name|svsp
operator|->
name|scrr_beg
operator|+
name|n
operator|)
operator|*
name|svsp
operator|->
name|maxcol
operator|)
argument_list|,
name|svsp
operator|->
name|Crtat
operator|+
operator|(
name|svsp
operator|->
name|scrr_beg
operator|*
name|svsp
operator|->
name|maxcol
operator|)
argument_list|,
name|svsp
operator|->
name|maxcol
operator|*
operator|(
name|svsp
operator|->
name|scrr_len
operator|-
name|n
operator|)
operator|*
name|CHR
argument_list|)
expr_stmt|;
block|}
name|fillw
argument_list|(
name|user_attr
operator||
literal|' '
argument_list|,
name|svsp
operator|->
name|Crtat
operator|+
operator|(
operator|(
name|svsp
operator|->
name|scrr_end
operator|-
name|n
operator|+
literal|1
operator|)
operator|*
name|svsp
operator|->
name|maxcol
operator|)
argument_list|,
name|n
operator|*
name|svsp
operator|->
name|maxcol
argument_list|)
expr_stmt|;
comment|/*XXX*/
if|if
condition|(
name|svsp
operator|->
name|scroll_lock
operator|&&
name|svsp
operator|->
name|openf
operator|&&
name|curproc
condition|)
name|tsleep
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
operator|(
name|svsp
operator|->
name|scroll_lock
operator|)
argument_list|,
name|PPAUSE
argument_list|,
literal|"scrlck"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	scroll screen n lines down  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|roll_down
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|,
name|int
name|n
parameter_list|)
block|{
if|if
condition|(
name|svsp
operator|->
name|scrr_beg
operator|==
literal|0
operator|&&
comment|/* if scroll region is whole screen */
name|svsp
operator|->
name|scrr_len
operator|==
name|svsp
operator|->
name|screen_rows
operator|&&
operator|(
name|svsp
operator|!=
name|vsp
operator|||
comment|/* and either running in memory */
operator|(
name|svsp
operator|->
name|screen_rows
operator|==
name|svsp
operator|->
name|screen_rowsize
operator|&&
comment|/* or no fkeys */
name|adaptor_type
operator|!=
name|MDA_ADAPTOR
operator|)
operator|)
condition|)
comment|/* and not on MDA/Hercules */
block|{
name|u_short
modifier|*
name|Memory
init|=
ifdef|#
directive|ifdef
name|XSERVER
operator|(
name|vsp
operator|!=
name|svsp
operator|||
operator|(
name|vsp
operator|->
name|vt_status
operator|&
name|VT_GRAFX
operator|)
operator|)
condition|?
else|#
directive|else
operator|(
name|vsp
operator|!=
name|svsp
operator|)
condition|?
endif|#
directive|endif
name|svsp
operator|->
name|Memory
else|:
name|Crtat
decl_stmt|;
if|if
condition|(
name|svsp
operator|->
name|Crtat
operator|<
operator|(
name|Memory
operator|+
name|n
operator|*
name|svsp
operator|->
name|maxcol
operator|)
condition|)
block|{
name|bcopy
argument_list|(
name|svsp
operator|->
name|Crtat
argument_list|,
name|Memory
operator|+
name|svsp
operator|->
name|maxcol
operator|*
operator|(
name|svsp
operator|->
name|screen_rows
operator|+
name|n
operator|)
argument_list|,
name|svsp
operator|->
name|maxcol
operator|*
operator|(
name|svsp
operator|->
name|screen_rows
operator|-
name|n
operator|)
operator|*
name|CHR
argument_list|)
expr_stmt|;
name|svsp
operator|->
name|Crtat
operator|=
name|Memory
operator|+
name|svsp
operator|->
name|maxcol
operator|*
name|svsp
operator|->
name|screen_rows
expr_stmt|;
block|}
else|else
block|{
name|svsp
operator|->
name|Crtat
operator|-=
name|n
operator|*
name|svsp
operator|->
name|maxcol
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|XSERVER
if|if
condition|(
name|vsp
operator|==
name|svsp
operator|&&
operator|!
operator|(
name|vsp
operator|->
name|vt_status
operator|&
name|VT_GRAFX
operator|)
condition|)
else|#
directive|else
if|if
condition|(
name|vsp
operator|==
name|svsp
condition|)
endif|#
directive|endif
block|{
name|outb
argument_list|(
name|addr_6845
argument_list|,
name|CRTC_STARTADRH
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|addr_6845
operator|+
literal|1
argument_list|,
operator|(
name|svsp
operator|->
name|Crtat
operator|-
name|Crtat
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|addr_6845
argument_list|,
name|CRTC_STARTADRL
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|addr_6845
operator|+
literal|1
argument_list|,
operator|(
name|svsp
operator|->
name|Crtat
operator|-
name|Crtat
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|bcopy
argument_list|(
name|svsp
operator|->
name|Crtat
operator|+
operator|(
name|svsp
operator|->
name|scrr_beg
operator|*
name|svsp
operator|->
name|maxcol
operator|)
argument_list|,
name|svsp
operator|->
name|Crtat
operator|+
operator|(
operator|(
name|svsp
operator|->
name|scrr_beg
operator|+
name|n
operator|)
operator|*
name|svsp
operator|->
name|maxcol
operator|)
argument_list|,
name|svsp
operator|->
name|maxcol
operator|*
operator|(
name|svsp
operator|->
name|scrr_len
operator|-
name|n
operator|)
operator|*
name|CHR
argument_list|)
expr_stmt|;
block|}
name|fillw
argument_list|(
name|user_attr
operator||
literal|' '
argument_list|,
name|svsp
operator|->
name|Crtat
operator|+
operator|(
name|svsp
operator|->
name|scrr_beg
operator|*
name|svsp
operator|->
name|maxcol
operator|)
argument_list|,
name|n
operator|*
name|svsp
operator|->
name|maxcol
argument_list|)
expr_stmt|;
comment|/*XXX*/
if|if
condition|(
name|svsp
operator|->
name|scroll_lock
operator|&&
name|svsp
operator|->
name|openf
operator|&&
name|curproc
condition|)
name|tsleep
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
operator|(
name|svsp
operator|->
name|scroll_lock
operator|)
argument_list|,
name|PPAUSE
argument_list|,
literal|"scrlck"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	switch charset pointers  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|swcsp
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|,
name|u_short
modifier|*
name|ctp
parameter_list|)
block|{
if|if
condition|(
name|ctp
operator|==
name|NULL
condition|)
return|return;
switch|switch
condition|(
name|svsp
operator|->
name|state
condition|)
block|{
case|case
name|STATE_BROPN
case|:
comment|/* designate G0 */
name|svsp
operator|->
name|G0
operator|=
name|ctp
expr_stmt|;
break|break;
case|case
name|STATE_BRCLO
case|:
comment|/* designate G1 */
case|case
name|STATE_MINUS
case|:
comment|/* designate G1 (96) */
name|svsp
operator|->
name|G1
operator|=
name|ctp
expr_stmt|;
break|break;
case|case
name|STATE_STAR
case|:
comment|/* designate G2 */
case|case
name|STATE_DOT
case|:
comment|/* designate G2 (96) */
name|svsp
operator|->
name|G2
operator|=
name|ctp
expr_stmt|;
break|break;
case|case
name|STATE_PLUS
case|:
comment|/* designate G3 */
case|case
name|STATE_SLASH
case|:
comment|/* designate G3 (96) */
name|svsp
operator|->
name|G3
operator|=
name|ctp
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	process terminal responses  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|respond
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
if|if
condition|(
operator|!
operator|(
name|svsp
operator|->
name|openf
operator|)
condition|)
comment|/* are we opened ? */
return|return;
while|while
condition|(
operator|*
name|svsp
operator|->
name|report_chars
operator|&&
name|svsp
operator|->
name|report_count
operator|>
literal|0
condition|)
block|{
name|ttyld_rint
argument_list|(
name|svsp
operator|->
name|vs_tty
argument_list|,
operator|*
name|svsp
operator|->
name|report_chars
operator|++
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|svsp
operator|->
name|report_count
operator|--
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	Initialization for User Defineable Keys  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|init_udk
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
name|svsp
operator|->
name|udk_defi
operator|=
literal|0
expr_stmt|;
name|svsp
operator|->
name|udk_deflow
operator|=
literal|0
expr_stmt|;
name|svsp
operator|->
name|udk_fnckey
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	Clear loaded downloadable (DLD) character set  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|clear_dld
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
specifier|register
name|int
name|i
decl_stmt|;
name|unsigned
name|char
name|vgacharset
decl_stmt|;
name|unsigned
name|char
name|vgachar
index|[
literal|16
index|]
decl_stmt|;
if|if
condition|(
name|vgacs
index|[
name|svsp
operator|->
name|vga_charset
index|]
operator|.
name|secondloaded
condition|)
name|vgacharset
operator|=
name|vgacs
index|[
name|svsp
operator|->
name|vga_charset
index|]
operator|.
name|secondloaded
expr_stmt|;
else|else
return|return;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
comment|/* A zeroed character, vt220 has inverted '?' */
name|vgachar
index|[
name|i
index|]
operator|=
literal|0x00
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
literal|94
condition|;
name|i
operator|++
control|)
comment|/* Load (erase) all characters */
name|loadchar
argument_list|(
name|vgacharset
argument_list|,
name|i
operator|+
literal|0xA0
argument_list|,
literal|16
argument_list|,
name|vgachar
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	Initialization for Down line LoaDable Fonts  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|init_dld
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
specifier|register
name|int
name|i
decl_stmt|;
name|svsp
operator|->
name|dld_dscsi
operator|=
literal|0
expr_stmt|;
name|svsp
operator|->
name|dld_sixel_lower
operator|=
literal|0
expr_stmt|;
name|svsp
operator|->
name|dld_sixelli
operator|=
literal|0
expr_stmt|;
name|svsp
operator|->
name|dld_sixelui
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAXSIXEL
condition|;
name|i
operator|++
control|)
name|svsp
operator|->
name|sixel
operator|.
name|lower
index|[
name|i
index|]
operator|=
name|svsp
operator|->
name|sixel
operator|.
name|upper
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	selective erase a region  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|selective_erase
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|,
name|u_short
modifier|*
name|pcrtat
parameter_list|,
name|int
name|length
parameter_list|)
block|{
specifier|register
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
for|for
control|(
name|j
operator|=
name|pcrtat
operator|-
name|svsp
operator|->
name|Crtat
operator|,
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|length
condition|;
name|i
operator|++
operator|,
name|pcrtat
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|svsp
operator|->
name|decsca
index|[
name|INT_INDEX
argument_list|(
name|j
operator|+
name|i
argument_list|)
index|]
operator|&
operator|(
literal|1
operator|<<
name|BIT_INDEX
argument_list|(
name|j
operator|+
name|i
argument_list|)
operator|)
operator|)
condition|)
block|{
operator|*
name|pcrtat
operator|&=
literal|0xFF00
expr_stmt|;
comment|/* Keep the video character attributes */
operator|*
name|pcrtat
operator|+=
literal|' '
expr_stmt|;
comment|/* Erase the character */
block|}
block|}
block|}
end_function

begin_comment
comment|/* ------------------------- E O F ------------------------------------------*/
end_comment

end_unit


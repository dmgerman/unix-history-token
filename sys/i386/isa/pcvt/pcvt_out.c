begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1999, 2000 Hellmuth Michaelis  *  * Copyright (c) 1992, 1995 Hellmuth Michaelis and Joerg Wunsch.  *  * Copyright (c) 1992, 1993 Brian Dunford-Shore.  *  * All rights reserved.  *  * This code is derived from software contributed to Berkeley by  * William Jolitz and Don Ahn.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. All advertising materials mentioning features or use of this software  *    must display the following acknowledgement:  *	This product includes software developed by Hellmuth Michaelis,  *	Brian Dunford-Shore and Joerg Wunsch.  * 4. The name authors may not be used to endorse or promote products  *    derived from this software without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHORS ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHORS BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_comment
comment|/*---------------------------------------------------------------------------*  *  *	pcvt_out.c	VT220 Terminal Emulator  *	---------------------------------------  *  *	Last Edit-Date: [Tue Jun  5 17:27:48 2001]  *  * $FreeBSD$  *  *---------------------------------------------------------------------------*/
end_comment

begin_define
define|#
directive|define
name|PCVT_INCLUDE_VT_SELATTR
end_define

begin_comment
comment|/* get inline function from pcvt_hdr.h */
end_comment

begin_include
include|#
directive|include
file|<i386/isa/pcvt/pcvt_hdr.h>
end_include

begin_comment
comment|/* global include */
end_comment

begin_include
include|#
directive|include
file|<vm/vm.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm_param.h>
end_include

begin_include
include|#
directive|include
file|<vm/pmap.h>
end_include

begin_decl_stmt
specifier|extern
name|u_short
name|csd_ascii
index|[]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* pcvt_tbl.h */
end_comment

begin_decl_stmt
specifier|extern
name|u_short
name|csd_supplemental
index|[]
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|write_char
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|,
name|int
name|attrib
parameter_list|,
name|int
name|ch
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|check_scroll
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|hp_entry
parameter_list|(
name|int
name|ch
parameter_list|,
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vt_coldinit
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|wrfkl
parameter_list|(
name|int
name|num
parameter_list|,
name|u_char
modifier|*
name|string
parameter_list|,
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|writefkl
parameter_list|(
name|int
name|num
parameter_list|,
name|u_char
modifier|*
name|string
parameter_list|,
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|check_scrollback
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*---------------------------------------------------------------------------*  *	do character set transformation and write to display memory (inline)  *---------------------------------------------------------------------------*/
end_comment

begin_define
define|#
directive|define
name|video
value|(svsp->Crtat + svsp->cur_offset)
end_define

begin_function
specifier|static
name|__inline
name|void
name|write_char
parameter_list|(
name|svsp
parameter_list|,
name|attrib
parameter_list|,
name|ch
parameter_list|)
name|struct
name|video_state
modifier|*
name|svsp
decl_stmt|;
name|u_short
name|attrib
decl_stmt|,
name|ch
decl_stmt|;
comment|/* XXX inefficient interface */
block|{
if|if
condition|(
operator|(
name|ch
operator|>=
literal|0x20
operator|)
operator|&&
operator|(
name|ch
operator|<=
literal|0x7f
operator|)
condition|)
comment|/* use GL if ch>= 0x20 */
block|{
if|if
condition|(
operator|!
name|svsp
operator|->
name|ss
condition|)
comment|/* single shift G2/G3 -> GL ? */
block|{
operator|*
name|video
operator|=
name|attrib
operator||
operator|(
operator|*
name|svsp
operator|->
name|GL
operator|)
index|[
name|ch
operator|-
literal|0x20
index|]
expr_stmt|;
block|}
else|else
block|{
operator|*
name|video
operator|=
name|attrib
operator||
operator|(
operator|*
name|svsp
operator|->
name|Gs
operator|)
index|[
name|ch
operator|-
literal|0x20
index|]
expr_stmt|;
name|svsp
operator|->
name|ss
operator|=
literal|0
expr_stmt|;
block|}
block|}
else|else
block|{
name|svsp
operator|->
name|ss
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ch
operator|>=
literal|0x80
condition|)
comment|/* display controls C1 */
block|{
if|if
condition|(
name|ch
operator|>=
literal|0xA0
condition|)
comment|/* use GR if ch>= 0xA0 */
block|{
operator|*
name|video
operator|=
name|attrib
operator||
operator|(
operator|*
name|svsp
operator|->
name|GR
operator|)
index|[
name|ch
operator|-
literal|0xA0
index|]
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|vgacs
index|[
name|svsp
operator|->
name|vga_charset
index|]
operator|.
name|secondloaded
condition|)
block|{
operator|*
name|video
operator|=
name|attrib
operator||
operator|(
operator|(
name|ch
operator|-
literal|0x60
operator|)
operator||
name|CSH
operator|)
expr_stmt|;
block|}
else|else
comment|/* use normal ibm charset for 							control display */
block|{
operator|*
name|video
operator|=
name|attrib
operator||
name|ch
expr_stmt|;
block|}
block|}
block|}
else|else
comment|/* display controls C0 */
block|{
if|if
condition|(
name|vgacs
index|[
name|svsp
operator|->
name|vga_charset
index|]
operator|.
name|secondloaded
condition|)
block|{
operator|*
name|video
operator|=
name|attrib
operator||
operator|(
name|ch
operator||
name|CSH
operator|)
expr_stmt|;
block|}
else|else
comment|/* use normal ibm charset for control display*/
block|{
operator|*
name|video
operator|=
name|attrib
operator||
name|ch
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	emulator main entry  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|sput
parameter_list|(
name|u_char
modifier|*
name|s
parameter_list|,
name|int
name|kernel
parameter_list|,
name|int
name|len
parameter_list|,
name|int
name|page
parameter_list|)
block|{
specifier|register
name|struct
name|video_state
modifier|*
name|svsp
decl_stmt|;
name|u_short
name|attrib
decl_stmt|;
name|u_short
name|ch
decl_stmt|;
name|u_short
name|extra
decl_stmt|;
if|if
condition|(
name|page
operator|>=
name|PCVT_NSCREENS
condition|)
comment|/* failsafe */
name|page
operator|=
literal|0
expr_stmt|;
name|svsp
operator|=
operator|&
name|vs
index|[
name|page
index|]
expr_stmt|;
comment|/* pointer to current screen state */
if|if
condition|(
name|do_initialization
condition|)
comment|/* first time called ? */
name|vt_coldinit
argument_list|()
expr_stmt|;
comment|/*   yes, we have to init ourselves */
if|if
condition|(
name|svsp
operator|==
name|vsp
condition|)
comment|/* on current displayed page ?	*/
block|{
name|cursor_pos_valid
operator|=
literal|0
expr_stmt|;
comment|/* do not update cursor */
if|#
directive|if
name|PCVT_SCREENSAVER
if|if
condition|(
name|scrnsv_active
condition|)
comment|/* screen blanked ?	*/
name|pcvt_scrnsv_reset
argument_list|()
expr_stmt|;
comment|/* unblank NOW !	*/
else|else
name|reset_screen_saver
operator|=
literal|1
expr_stmt|;
comment|/* do it asynchronously	*/
endif|#
directive|endif
comment|/* PCVT_SCREENSAVER */
block|}
name|attrib
operator|=
name|kernel
condition|?
name|kern_attr
else|:
name|svsp
operator|->
name|c_attr
expr_stmt|;
while|while
condition|(
name|len
operator|--
operator|>
literal|0
condition|)
if|if
condition|(
operator|(
name|ch
operator|=
operator|*
operator|(
name|s
operator|++
operator|)
operator|)
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|svsp
operator|->
name|sevenbit
condition|)
name|ch
operator|&=
literal|0x7f
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|ch
operator|<=
literal|0x1f
operator|)
operator|||
operator|(
name|ch
operator|==
literal|0x7f
operator|)
operator|)
operator|&&
operator|(
name|svsp
operator|->
name|transparent
operator|==
literal|0
operator|)
condition|)
block|{
comment|/* always process control-chars in the range 0x00..0x1f, 0x7f !!! */
if|if
condition|(
name|svsp
operator|->
name|dis_fnc
condition|)
block|{
if|if
condition|(
name|svsp
operator|->
name|lastchar
operator|&&
name|svsp
operator|->
name|m_awm
operator|&&
operator|(
name|svsp
operator|->
name|lastrow
operator|==
name|svsp
operator|->
name|row
operator|)
condition|)
block|{
name|svsp
operator|->
name|cur_offset
operator|++
expr_stmt|;
name|svsp
operator|->
name|col
operator|=
literal|0
expr_stmt|;
name|svsp
operator|->
name|lastchar
operator|=
literal|0
expr_stmt|;
name|check_scroll
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|svsp
operator|->
name|irm
condition|)
name|bcopy
argument_list|(
operator|(
name|svsp
operator|->
name|Crtat
operator|+
name|svsp
operator|->
name|cur_offset
operator|)
argument_list|,
operator|(
name|svsp
operator|->
name|Crtat
operator|+
name|svsp
operator|->
name|cur_offset
operator|)
operator|+
literal|1
argument_list|,
operator|(
operator|(
operator|(
name|svsp
operator|->
name|maxcol
operator|)
operator|-
literal|1
operator|)
operator|-
name|svsp
operator|->
name|col
operator|)
operator|*
name|CHR
argument_list|)
expr_stmt|;
name|write_char
argument_list|(
name|svsp
argument_list|,
name|attrib
argument_list|,
name|ch
argument_list|)
expr_stmt|;
name|vt_selattr
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
if|if
condition|(
name|svsp
operator|->
name|col
operator|>=
operator|(
operator|(
name|svsp
operator|->
name|maxcol
operator|)
operator|-
literal|1
operator|)
operator|&&
name|ch
operator|!=
literal|0x0a
operator|&&
name|ch
operator|!=
literal|0x0b
operator|&&
name|ch
operator|!=
literal|0x0c
condition|)
block|{
name|svsp
operator|->
name|lastchar
operator|=
literal|1
expr_stmt|;
name|svsp
operator|->
name|lastrow
operator|=
name|svsp
operator|->
name|row
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ch
operator|==
literal|0x0a
operator|||
name|ch
operator|==
literal|0x0b
operator|||
name|ch
operator|==
literal|0x0c
condition|)
block|{
name|svsp
operator|->
name|cur_offset
operator|-=
name|svsp
operator|->
name|col
expr_stmt|;
name|svsp
operator|->
name|cur_offset
operator|+=
name|svsp
operator|->
name|maxcol
expr_stmt|;
name|svsp
operator|->
name|col
operator|=
literal|0
expr_stmt|;
name|svsp
operator|->
name|lastchar
operator|=
literal|0
expr_stmt|;
name|check_scroll
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
comment|/* check scroll up */
block|}
else|else
block|{
name|svsp
operator|->
name|cur_offset
operator|++
expr_stmt|;
name|svsp
operator|->
name|col
operator|++
expr_stmt|;
name|svsp
operator|->
name|lastchar
operator|=
literal|0
expr_stmt|;
block|}
block|}
else|else
block|{
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|0x00
case|:
comment|/* NUL */
case|case
literal|0x01
case|:
comment|/* SOH */
case|case
literal|0x02
case|:
comment|/* STX */
case|case
literal|0x03
case|:
comment|/* ETX */
case|case
literal|0x04
case|:
comment|/* EOT */
case|case
literal|0x05
case|:
comment|/* ENQ */
case|case
literal|0x06
case|:
comment|/* ACK */
break|break;
case|case
literal|0x07
case|:
comment|/* BEL */
if|if
condition|(
name|svsp
operator|->
name|bell_on
condition|)
name|sysbeep
argument_list|(
name|PCVT_SYSBEEPF
operator|/
literal|1500
argument_list|,
name|hz
operator|/
literal|4
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x08
case|:
comment|/* BS */
if|if
condition|(
name|svsp
operator|->
name|col
operator|>
literal|0
condition|)
block|{
name|svsp
operator|->
name|cur_offset
operator|--
expr_stmt|;
name|svsp
operator|->
name|col
operator|--
expr_stmt|;
block|}
break|break;
case|case
literal|0x09
case|:
comment|/* TAB */
while|while
condition|(
name|svsp
operator|->
name|col
operator|<
operator|(
operator|(
name|svsp
operator|->
name|maxcol
operator|)
operator|-
literal|1
operator|)
condition|)
block|{
name|svsp
operator|->
name|cur_offset
operator|++
expr_stmt|;
if|if
condition|(
name|svsp
operator|->
name|tab_stops
index|[
operator|++
name|svsp
operator|->
name|col
index|]
condition|)
break|break;
block|}
break|break;
case|case
literal|0x0a
case|:
comment|/* LF */
case|case
literal|0x0b
case|:
comment|/* VT */
case|case
literal|0x0c
case|:
comment|/* FF */
if|if
condition|(
name|check_scrollback
argument_list|(
name|svsp
argument_list|)
condition|)
block|{
name|extra
operator|=
operator|(
name|svsp
operator|->
name|cur_offset
operator|%
name|svsp
operator|->
name|maxcol
operator|)
condition|?
name|svsp
operator|->
name|col
else|:
literal|0
expr_stmt|;
name|bcopy
argument_list|(
name|svsp
operator|->
name|Crtat
operator|+
name|svsp
operator|->
name|cur_offset
operator|-
name|extra
argument_list|,
name|svsp
operator|->
name|Scrollback
operator|+
operator|(
name|svsp
operator|->
name|scr_offset
operator|*
name|svsp
operator|->
name|maxcol
operator|)
argument_list|,
name|svsp
operator|->
name|maxcol
operator|*
name|CHR
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|svsp
operator|->
name|lnm
condition|)
block|{
name|svsp
operator|->
name|cur_offset
operator|-=
name|svsp
operator|->
name|col
expr_stmt|;
name|svsp
operator|->
name|cur_offset
operator|+=
name|svsp
operator|->
name|maxcol
expr_stmt|;
name|svsp
operator|->
name|col
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|svsp
operator|->
name|cur_offset
operator|+=
name|svsp
operator|->
name|maxcol
expr_stmt|;
block|}
name|check_scroll
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x0d
case|:
comment|/* CR */
name|svsp
operator|->
name|cur_offset
operator|-=
name|svsp
operator|->
name|col
expr_stmt|;
name|svsp
operator|->
name|col
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|0x0e
case|:
comment|/* SO */
name|svsp
operator|->
name|GL
operator|=
operator|&
name|svsp
operator|->
name|G1
expr_stmt|;
break|break;
case|case
literal|0x0f
case|:
comment|/* SI */
name|svsp
operator|->
name|GL
operator|=
operator|&
name|svsp
operator|->
name|G0
expr_stmt|;
break|break;
case|case
literal|0x10
case|:
comment|/* DLE */
case|case
literal|0x11
case|:
comment|/* DC1/XON */
case|case
literal|0x12
case|:
comment|/* DC2 */
case|case
literal|0x13
case|:
comment|/* DC3/XOFF */
case|case
literal|0x14
case|:
comment|/* DC4 */
case|case
literal|0x15
case|:
comment|/* NAK */
case|case
literal|0x16
case|:
comment|/* SYN */
case|case
literal|0x17
case|:
comment|/* ETB */
break|break;
case|case
literal|0x18
case|:
comment|/* CAN */
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
name|clr_parms
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x19
case|:
comment|/* EM */
break|break;
case|case
literal|0x1a
case|:
comment|/* SUB */
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
name|clr_parms
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x1b
case|:
comment|/* ESC */
name|svsp
operator|->
name|state
operator|=
name|STATE_ESC
expr_stmt|;
name|clr_parms
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x1c
case|:
comment|/* FS */
case|case
literal|0x1d
case|:
comment|/* GS */
case|case
literal|0x1e
case|:
comment|/* RS */
case|case
literal|0x1f
case|:
comment|/* US */
case|case
literal|0x7f
case|:
comment|/* DEL */
break|break;
block|}
block|}
block|}
else|else
block|{
comment|/* char range 0x20...0x73, 0x80...0xff processing */
comment|/* depends on current state */
switch|switch
condition|(
name|svsp
operator|->
name|state
condition|)
block|{
case|case
name|STATE_INIT
case|:
if|if
condition|(
name|svsp
operator|->
name|lastchar
operator|&&
name|svsp
operator|->
name|m_awm
operator|&&
operator|(
name|svsp
operator|->
name|lastrow
operator|==
name|svsp
operator|->
name|row
operator|)
condition|)
block|{
name|svsp
operator|->
name|cur_offset
operator|++
expr_stmt|;
name|svsp
operator|->
name|col
operator|=
literal|0
expr_stmt|;
name|svsp
operator|->
name|lastchar
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|check_scrollback
argument_list|(
name|svsp
argument_list|)
condition|)
block|{
name|bcopy
argument_list|(
name|svsp
operator|->
name|Crtat
operator|+
name|svsp
operator|->
name|cur_offset
operator|-
name|svsp
operator|->
name|maxcol
argument_list|,
name|svsp
operator|->
name|Scrollback
operator|+
operator|(
name|svsp
operator|->
name|scr_offset
operator|*
name|svsp
operator|->
name|maxcol
operator|)
argument_list|,
name|svsp
operator|->
name|maxcol
operator|*
name|CHR
argument_list|)
expr_stmt|;
block|}
name|check_scroll
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|svsp
operator|->
name|irm
condition|)
name|bcopy
argument_list|(
operator|(
name|svsp
operator|->
name|Crtat
operator|+
name|svsp
operator|->
name|cur_offset
operator|)
argument_list|,
operator|(
name|svsp
operator|->
name|Crtat
operator|+
name|svsp
operator|->
name|cur_offset
operator|)
operator|+
literal|1
argument_list|,
operator|(
operator|(
operator|(
name|svsp
operator|->
name|maxcol
operator|)
operator|-
literal|1
operator|)
operator|-
name|svsp
operator|->
name|col
operator|)
operator|*
name|CHR
argument_list|)
expr_stmt|;
name|write_char
argument_list|(
name|svsp
argument_list|,
name|attrib
argument_list|,
name|ch
argument_list|)
expr_stmt|;
name|vt_selattr
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
if|if
condition|(
name|svsp
operator|->
name|col
operator|>=
operator|(
operator|(
name|svsp
operator|->
name|maxcol
operator|)
operator|-
literal|1
operator|)
condition|)
block|{
name|svsp
operator|->
name|lastchar
operator|=
literal|1
expr_stmt|;
name|svsp
operator|->
name|lastrow
operator|=
name|svsp
operator|->
name|row
expr_stmt|;
block|}
else|else
block|{
name|svsp
operator|->
name|lastchar
operator|=
literal|0
expr_stmt|;
name|svsp
operator|->
name|cur_offset
operator|++
expr_stmt|;
name|svsp
operator|->
name|col
operator|++
expr_stmt|;
block|}
break|break;
case|case
name|STATE_ESC
case|:
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|' '
case|:
comment|/* ESC sp family */
name|svsp
operator|->
name|state
operator|=
name|STATE_BLANK
expr_stmt|;
break|break;
case|case
literal|'#'
case|:
comment|/* ESC # family */
name|svsp
operator|->
name|state
operator|=
name|STATE_HASH
expr_stmt|;
break|break;
case|case
literal|'&'
case|:
comment|/* ESC& family (HP) */
if|if
condition|(
name|svsp
operator|->
name|vt_pure_mode
operator|==
name|M_HPVT
condition|)
block|{
name|svsp
operator|->
name|state
operator|=
name|STATE_AMPSND
expr_stmt|;
name|svsp
operator|->
name|hp_state
operator|=
name|SHP_INIT
expr_stmt|;
block|}
else|else
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
case|case
literal|'('
case|:
comment|/* ESC ( family */
name|svsp
operator|->
name|state
operator|=
name|STATE_BROPN
expr_stmt|;
break|break;
case|case
literal|')'
case|:
comment|/* ESC ) family */
name|svsp
operator|->
name|state
operator|=
name|STATE_BRCLO
expr_stmt|;
break|break;
case|case
literal|'*'
case|:
comment|/* ESC * family */
name|svsp
operator|->
name|state
operator|=
name|STATE_STAR
expr_stmt|;
break|break;
case|case
literal|'+'
case|:
comment|/* ESC + family */
name|svsp
operator|->
name|state
operator|=
name|STATE_PLUS
expr_stmt|;
break|break;
case|case
literal|'-'
case|:
comment|/* ESC - family */
name|svsp
operator|->
name|state
operator|=
name|STATE_MINUS
expr_stmt|;
break|break;
case|case
literal|'.'
case|:
comment|/* ESC . family */
name|svsp
operator|->
name|state
operator|=
name|STATE_DOT
expr_stmt|;
break|break;
case|case
literal|'/'
case|:
comment|/* ESC / family */
name|svsp
operator|->
name|state
operator|=
name|STATE_SLASH
expr_stmt|;
break|break;
case|case
literal|'7'
case|:
comment|/* SAVE CURSOR */
name|vt_sc
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
case|case
literal|'8'
case|:
comment|/* RESTORE CURSOR */
name|vt_rc
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|kernel
condition|)
name|attrib
operator|=
name|svsp
operator|->
name|c_attr
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
case|case
literal|'='
case|:
comment|/* keypad application mode */
if|#
directive|if
operator|!
name|PCVT_INHIBIT_NUMLOCK
name|vt_keyappl
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
case|case
literal|'>'
case|:
comment|/* keypad numeric mode */
if|#
directive|if
operator|!
name|PCVT_INHIBIT_NUMLOCK
name|vt_keynum
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
case|case
literal|'D'
case|:
comment|/* INDEX */
name|vt_ind
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
case|case
literal|'E'
case|:
comment|/* NEXT LINE */
name|vt_nel
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
case|case
literal|'H'
case|:
comment|/* set TAB at current col */
name|svsp
operator|->
name|tab_stops
index|[
name|svsp
operator|->
name|col
index|]
operator|=
literal|1
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
case|case
literal|'M'
case|:
comment|/* REVERSE INDEX */
name|vt_ri
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
case|case
literal|'N'
case|:
comment|/* SINGLE SHIFT G2 */
name|svsp
operator|->
name|Gs
operator|=
operator|&
name|svsp
operator|->
name|G2
expr_stmt|;
name|svsp
operator|->
name|ss
operator|=
literal|1
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
case|case
literal|'O'
case|:
comment|/* SINGLE SHIFT G3 */
name|svsp
operator|->
name|Gs
operator|=
operator|&
name|svsp
operator|->
name|G3
expr_stmt|;
name|svsp
operator|->
name|ss
operator|=
literal|1
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
case|case
literal|'P'
case|:
comment|/* DCS detected */
name|svsp
operator|->
name|dcs_state
operator|=
name|DCS_INIT
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_DCS
expr_stmt|;
break|break;
case|case
literal|'Z'
case|:
comment|/* What are you = ESC [ c */
name|vt_da
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
case|case
literal|'['
case|:
comment|/* CSI detected */
name|clr_parms
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_CSI
expr_stmt|;
break|break;
case|case
literal|'\\'
case|:
comment|/* String Terminator */
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
comment|/* hard reset */
name|vt_ris
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|kernel
condition|)
name|attrib
operator|=
name|svsp
operator|->
name|c_attr
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
if|#
directive|if
name|PCVT_SETCOLOR
case|case
literal|'d'
case|:
comment|/* set color sgr */
if|if
condition|(
name|color
condition|)
block|{
comment|/* set shiftwidth=4 */
name|sgr_tab_color
index|[
name|svsp
operator|->
name|vtsgr
index|]
operator|=
name|svsp
operator|->
name|c_attr
operator|>>
literal|8
expr_stmt|;
name|user_attr
operator|=
name|sgr_tab_color
index|[
literal|0
index|]
operator|<<
literal|8
expr_stmt|;
block|}
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* PCVT_SETCOLOR */
case|case
literal|'n'
case|:
comment|/* Lock Shift G2 -> GL */
name|svsp
operator|->
name|GL
operator|=
operator|&
name|svsp
operator|->
name|G2
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
case|case
literal|'o'
case|:
comment|/* Lock Shift G3 -> GL */
name|svsp
operator|->
name|GL
operator|=
operator|&
name|svsp
operator|->
name|G3
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
case|case
literal|'}'
case|:
comment|/* Lock Shift G2 -> GR */
name|svsp
operator|->
name|GR
operator|=
operator|&
name|svsp
operator|->
name|G2
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
case|case
literal|'|'
case|:
comment|/* Lock Shift G3 -> GR */
name|svsp
operator|->
name|GR
operator|=
operator|&
name|svsp
operator|->
name|G3
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
case|case
literal|'~'
case|:
comment|/* Lock Shift G1 -> GR */
name|svsp
operator|->
name|GR
operator|=
operator|&
name|svsp
operator|->
name|G1
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
default|default:
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|STATE_BLANK
case|:
comment|/* ESC space [FG], which are */
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
comment|/* currently ignored*/
break|break;
case|case
name|STATE_HASH
case|:
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'3'
case|:
comment|/* double height top half */
case|case
literal|'4'
case|:
comment|/*double height bottom half*/
case|case
literal|'5'
case|:
comment|/*single width sngle height*/
case|case
literal|'6'
case|:
comment|/*double width sngle height*/
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
case|case
literal|'8'
case|:
comment|/* fill sceen with 'E's */
name|vt_aln
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
default|default:
comment|/* anything else */
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|STATE_BROPN
case|:
comment|/* designate G0 */
case|case
name|STATE_BRCLO
case|:
comment|/* designate G1 */
case|case
name|STATE_STAR
case|:
comment|/* designate G2 */
case|case
name|STATE_PLUS
case|:
comment|/* designate G3 */
case|case
name|STATE_MINUS
case|:
comment|/* designate G1 (96) */
case|case
name|STATE_DOT
case|:
comment|/* designate G2 (96) */
case|case
name|STATE_SLASH
case|:
comment|/* designate G3 (96) */
name|svsp
operator|->
name|which
index|[
name|svsp
operator|->
name|whichi
operator|++
index|]
operator|=
name|ch
expr_stmt|;
if|if
condition|(
name|ch
operator|>=
literal|0x20
operator|&&
name|ch
operator|<=
literal|0x2f
operator|&&
name|svsp
operator|->
name|whichi
operator|<=
literal|2
condition|)
break|break;
elseif|else
if|if
condition|(
name|ch
operator|>=
literal|0x30
operator|&&
name|ch
operator|<=
literal|0x7e
condition|)
block|{
name|svsp
operator|->
name|which
index|[
name|svsp
operator|->
name|whichi
index|]
operator|=
literal|'\0'
expr_stmt|;
name|vt_designate
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
block|}
name|svsp
operator|->
name|whichi
operator|=
literal|0
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
case|case
name|STATE_CSIQM
case|:
comment|/* DEC private modes */
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'0'
case|:
case|case
literal|'1'
case|:
case|case
literal|'2'
case|:
case|case
literal|'3'
case|:
case|case
literal|'4'
case|:
case|case
literal|'5'
case|:
case|case
literal|'6'
case|:
case|case
literal|'7'
case|:
case|case
literal|'8'
case|:
case|case
literal|'9'
case|:
comment|/* parameters */
name|svsp
operator|->
name|parms
index|[
name|svsp
operator|->
name|parmi
index|]
operator|*=
literal|10
expr_stmt|;
name|svsp
operator|->
name|parms
index|[
name|svsp
operator|->
name|parmi
index|]
operator|+=
operator|(
name|ch
operator|-
literal|'0'
operator|)
expr_stmt|;
break|break;
case|case
literal|';'
case|:
comment|/* next parameter */
name|svsp
operator|->
name|parmi
operator|=
operator|(
name|svsp
operator|->
name|parmi
operator|+
literal|1
operator|<
name|MAXPARMS
operator|)
condition|?
name|svsp
operator|->
name|parmi
operator|+
literal|1
else|:
name|svsp
operator|->
name|parmi
expr_stmt|;
break|break;
case|case
literal|'h'
case|:
comment|/* set mode */
name|vt_set_dec_priv_qm
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
comment|/* reset mode */
name|vt_reset_dec_priv_qm
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
case|case
literal|'n'
case|:
comment|/* Reports */
name|vt_dsr
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
case|case
literal|'K'
case|:
comment|/* selective erase in line */
name|vt_sel
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
case|case
literal|'J'
case|:
comment|/*selective erase in display*/
name|vt_sed
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
default|default:
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|STATE_CSI
case|:
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'0'
case|:
case|case
literal|'1'
case|:
case|case
literal|'2'
case|:
case|case
literal|'3'
case|:
case|case
literal|'4'
case|:
case|case
literal|'5'
case|:
case|case
literal|'6'
case|:
case|case
literal|'7'
case|:
case|case
literal|'8'
case|:
case|case
literal|'9'
case|:
comment|/* parameters */
name|svsp
operator|->
name|parms
index|[
name|svsp
operator|->
name|parmi
index|]
operator|*=
literal|10
expr_stmt|;
name|svsp
operator|->
name|parms
index|[
name|svsp
operator|->
name|parmi
index|]
operator|+=
operator|(
name|ch
operator|-
literal|'0'
operator|)
expr_stmt|;
break|break;
case|case
literal|';'
case|:
comment|/* next parameter */
name|svsp
operator|->
name|parmi
operator|=
operator|(
name|svsp
operator|->
name|parmi
operator|+
literal|1
operator|<
name|MAXPARMS
operator|)
condition|?
name|svsp
operator|->
name|parmi
operator|+
literal|1
else|:
name|svsp
operator|->
name|parmi
expr_stmt|;
break|break;
case|case
literal|'?'
case|:
comment|/* ESC [ ? family */
name|svsp
operator|->
name|state
operator|=
name|STATE_CSIQM
expr_stmt|;
break|break;
case|case
literal|'@'
case|:
comment|/* insert char */
name|vt_ic
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
case|case
literal|'"'
case|:
comment|/* select char attribute */
name|svsp
operator|->
name|state
operator|=
name|STATE_SCA
expr_stmt|;
break|break;
case|case
literal|'\''
case|:
comment|/* for DECELR/DECSLE */
comment|/* XXX */
comment|/* another state needed -hm */
break|break;
case|case
literal|'!'
case|:
comment|/* soft terminal reset */
name|svsp
operator|->
name|state
operator|=
name|STATE_STR
expr_stmt|;
break|break;
case|case
literal|'A'
case|:
comment|/* cursor up */
name|vt_cuu
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
case|case
literal|'B'
case|:
comment|/* cursor down */
name|vt_cud
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
case|case
literal|'C'
case|:
comment|/* cursor forward */
name|vt_cuf
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
case|case
literal|'D'
case|:
comment|/* cursor backward */
name|vt_cub
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
case|case
literal|'H'
case|:
comment|/* direct cursor addressing*/
name|vt_curadr
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
case|case
literal|'J'
case|:
comment|/* erase screen */
name|vt_clreos
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
case|case
literal|'K'
case|:
comment|/* erase line */
name|vt_clreol
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
if|if
condition|(
name|svsp
operator|->
name|scr_offset
operator|>
literal|0
operator|&&
name|svsp
operator|==
name|vsp
condition|)
name|svsp
operator|->
name|scr_offset
operator|--
expr_stmt|;
break|break;
case|case
literal|'L'
case|:
comment|/* insert line */
name|vt_il
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
case|case
literal|'M'
case|:
comment|/* delete line */
name|vt_dl
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
case|case
literal|'P'
case|:
comment|/* delete character */
name|vt_dch
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
case|case
literal|'S'
case|:
comment|/* scroll up */
name|vt_su
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
case|case
literal|'T'
case|:
comment|/* scroll down */
name|vt_sd
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
case|case
literal|'X'
case|:
comment|/* erase character */
name|vt_ech
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
comment|/* device attributes */
name|vt_da
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
case|case
literal|'f'
case|:
comment|/* direct cursor addressing*/
name|vt_curadr
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
case|case
literal|'g'
case|:
comment|/* clear tabs */
name|vt_clrtab
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
case|case
literal|'h'
case|:
comment|/* set mode(s) */
name|vt_set_ansi
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
case|case
literal|'i'
case|:
comment|/* media copy */
name|vt_mc
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
comment|/* reset mode(s) */
name|vt_reset_ansi
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
case|case
literal|'m'
case|:
comment|/* select graphic rendition*/
name|vt_sgr
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|kernel
condition|)
name|attrib
operator|=
name|svsp
operator|->
name|c_attr
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
case|case
literal|'n'
case|:
comment|/* reports */
name|vt_dsr
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
case|case
literal|'r'
case|:
comment|/* set scrolling region */
name|vt_stbm
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
case|case
literal|'x'
case|:
comment|/*request/report parameters*/
name|vt_reqtparm
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
case|case
literal|'y'
case|:
comment|/* invoke selftest(s) */
name|vt_tst
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
case|case
literal|'z'
case|:
comment|/* DECELR, ignored */
case|case
literal|'{'
case|:
comment|/* DECSLE, ignored */
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
default|default:
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|STATE_AMPSND
case|:
name|hp_entry
argument_list|(
name|ch
argument_list|,
name|svsp
argument_list|)
expr_stmt|;
break|break;
case|case
name|STATE_DCS
case|:
name|vt_dcsentry
argument_list|(
name|ch
argument_list|,
name|svsp
argument_list|)
expr_stmt|;
break|break;
case|case
name|STATE_SCA
case|:
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'q'
case|:
name|vt_sca
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
default|default:
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|STATE_STR
case|:
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'p'
case|:
comment|/* soft terminal reset */
name|vt_str
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|kernel
condition|)
name|attrib
operator|=
name|svsp
operator|->
name|c_attr
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
default|default:
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
block|}
break|break;
default|default:
comment|/* failsafe */
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
block|}
block|}
name|svsp
operator|->
name|row
operator|=
name|svsp
operator|->
name|cur_offset
operator|/
name|svsp
operator|->
name|maxcol
expr_stmt|;
comment|/* current row update */
comment|/* take care of last character on line behaviour */
if|if
condition|(
name|svsp
operator|->
name|lastchar
operator|&&
operator|(
name|svsp
operator|->
name|col
operator|<
operator|(
operator|(
name|svsp
operator|->
name|maxcol
operator|)
operator|-
literal|1
operator|)
operator|)
condition|)
name|svsp
operator|->
name|lastchar
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|svsp
operator|==
name|vsp
condition|)
comment|/* on current displayed page ?	*/
name|cursor_pos_valid
operator|=
literal|1
expr_stmt|;
comment|/* position is valid now */
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	this is the absolute cold initialization of the emulator  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|vt_coldinit
parameter_list|(
name|void
parameter_list|)
block|{
name|u_short
specifier|volatile
modifier|*
name|cp
decl_stmt|;
name|u_short
name|was
decl_stmt|;
name|int
name|nscr
decl_stmt|,
name|charset
decl_stmt|;
name|int
name|equipment
decl_stmt|;
name|u_short
modifier|*
name|SaveCrtat
decl_stmt|;
name|struct
name|video_state
modifier|*
name|svsp
decl_stmt|;
name|Crtat
operator|=
operator|(
name|u_short
operator|*
operator|)
name|MONO_BUF
expr_stmt|;
comment|/* XXX assume static relocation works */
name|SaveCrtat
operator|=
name|Crtat
expr_stmt|;
name|cp
operator|=
name|Crtat
operator|+
operator|(
name|CGA_BUF
operator|-
name|MONO_BUF
operator|)
operator|/
name|CHR
expr_stmt|;
name|do_initialization
operator|=
literal|0
expr_stmt|;
comment|/* reset init necessary flag */
comment|/* get the equipment byte from the RTC chip */
name|equipment
operator|=
operator|(
operator|(
name|rtcin
argument_list|(
name|RTC_EQUIPMENT
argument_list|)
operator|)
operator|>>
literal|4
operator|)
operator|&
literal|0x03
expr_stmt|;
switch|switch
condition|(
name|equipment
condition|)
block|{
case|case
name|EQ_EGAVGA
case|:
comment|/* set memory start to CGA == B8000 */
name|Crtat
operator|=
name|Crtat
operator|+
operator|(
name|CGA_BUF
operator|-
name|MONO_BUF
operator|)
operator|/
name|CHR
expr_stmt|;
comment|/* find out, what monitor is connected */
name|was
operator|=
operator|*
name|cp
expr_stmt|;
operator|*
name|cp
operator|=
operator|(
name|u_short
operator|)
literal|0xA55A
expr_stmt|;
if|if
condition|(
operator|*
name|cp
operator|!=
literal|0xA55A
condition|)
block|{
name|addr_6845
operator|=
name|MONO_BASE
expr_stmt|;
name|color
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
operator|*
name|cp
operator|=
name|was
expr_stmt|;
name|addr_6845
operator|=
name|CGA_BASE
expr_stmt|;
name|color
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|vga_test
argument_list|()
condition|)
comment|/* EGA or VGA ? */
block|{
name|adaptor_type
operator|=
name|VGA_ADAPTOR
expr_stmt|;
name|totalfonts
operator|=
literal|8
expr_stmt|;
if|if
condition|(
name|color
operator|==
literal|0
condition|)
block|{
name|mda2egaorvga
argument_list|()
expr_stmt|;
name|Crtat
operator|=
name|SaveCrtat
expr_stmt|;
comment|/* mono start */
block|}
comment|/* find out which chipset we are running on */
name|vga_type
operator|=
name|vga_chipset
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|adaptor_type
operator|=
name|EGA_ADAPTOR
expr_stmt|;
name|totalfonts
operator|=
literal|4
expr_stmt|;
if|if
condition|(
name|color
operator|==
literal|0
condition|)
block|{
name|mda2egaorvga
argument_list|()
expr_stmt|;
name|Crtat
operator|=
name|SaveCrtat
expr_stmt|;
comment|/* mono start */
block|}
block|}
comment|/* decouple ega/vga charsets and intensity */
name|set_2ndcharset
argument_list|()
expr_stmt|;
break|break;
case|case
name|EQ_40COLOR
case|:
comment|/* XXX should panic in 40 col mode ! */
case|case
name|EQ_80COLOR
case|:
name|Crtat
operator|=
name|Crtat
operator|+
operator|(
name|CGA_BUF
operator|-
name|MONO_BUF
operator|)
operator|/
name|CHR
expr_stmt|;
name|addr_6845
operator|=
name|CGA_BASE
expr_stmt|;
name|adaptor_type
operator|=
name|CGA_ADAPTOR
expr_stmt|;
name|color
operator|=
literal|1
expr_stmt|;
name|totalfonts
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|EQ_80MONO
case|:
name|addr_6845
operator|=
name|MONO_BASE
expr_stmt|;
name|adaptor_type
operator|=
name|MDA_ADAPTOR
expr_stmt|;
name|color
operator|=
literal|0
expr_stmt|;
name|totalfonts
operator|=
literal|0
expr_stmt|;
break|break;
block|}
comment|/* establish default colors */
if|if
condition|(
name|color
condition|)
block|{
name|kern_attr
operator|=
operator|(
name|COLOR_KERNEL_FG
operator||
name|COLOR_KERNEL_BG
operator|)
operator|<<
literal|8
expr_stmt|;
name|user_attr
operator|=
name|sgr_tab_color
index|[
literal|0
index|]
operator|<<
literal|8
expr_stmt|;
block|}
else|else
block|{
name|kern_attr
operator|=
operator|(
name|MONO_KERNEL_FG
operator||
name|MONO_KERNEL_BG
operator|)
operator|<<
literal|8
expr_stmt|;
if|if
condition|(
name|adaptor_type
operator|==
name|MDA_ADAPTOR
condition|)
name|user_attr
operator|=
name|sgr_tab_imono
index|[
literal|0
index|]
operator|<<
literal|8
expr_stmt|;
else|else
name|user_attr
operator|=
name|sgr_tab_mono
index|[
literal|0
index|]
operator|<<
literal|8
expr_stmt|;
block|}
name|totalscreens
operator|=
literal|1
expr_stmt|;
comment|/* for now until malloced */
for|for
control|(
name|nscr
operator|=
literal|0
operator|,
name|svsp
operator|=
name|vs
init|;
name|nscr
operator|<
name|PCVT_NSCREENS
condition|;
name|nscr
operator|++
operator|,
name|svsp
operator|++
control|)
block|{
name|svsp
operator|->
name|Crtat
operator|=
name|Crtat
expr_stmt|;
comment|/* all same until malloc'ed */
name|svsp
operator|->
name|Memory
operator|=
name|Crtat
expr_stmt|;
comment|/* until malloc'ed */
name|svsp
operator|->
name|Scrollback
operator|=
literal|0
expr_stmt|;
comment|/* until malloc'ed */
name|svsp
operator|->
name|scr_offset
operator|=
literal|0
expr_stmt|;
comment|/* scrollback offset (lines) */
name|svsp
operator|->
name|scrolling
operator|=
literal|0
expr_stmt|;
comment|/* current scrollback page */
name|svsp
operator|->
name|cur_offset
operator|=
literal|0
expr_stmt|;
comment|/* cursor offset */
name|svsp
operator|->
name|c_attr
operator|=
name|user_attr
expr_stmt|;
comment|/* non-kernel attributes */
name|svsp
operator|->
name|bell_on
operator|=
literal|1
expr_stmt|;
comment|/* enable bell */
name|svsp
operator|->
name|sevenbit
operator|=
literal|0
expr_stmt|;
comment|/* set to 8-bit path */
name|svsp
operator|->
name|dis_fnc
operator|=
literal|0
expr_stmt|;
comment|/* disable display functions */
name|svsp
operator|->
name|transparent
operator|=
literal|0
expr_stmt|;
comment|/* disable internal tranparency */
name|svsp
operator|->
name|lastchar
operator|=
literal|0
expr_stmt|;
comment|/* VTxxx behaviour of last */
comment|/*            char on line */
name|svsp
operator|->
name|report_chars
operator|=
name|NULL
expr_stmt|;
comment|/* VTxxx reports init */
name|svsp
operator|->
name|report_count
operator|=
literal|0
expr_stmt|;
comment|/* VTxxx reports init */
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
comment|/* main state machine init */
name|svsp
operator|->
name|m_awm
operator|=
literal|1
expr_stmt|;
comment|/* enable auto wrap mode */
name|svsp
operator|->
name|m_om
operator|=
literal|0
expr_stmt|;
comment|/* origin mode = absolute */
name|svsp
operator|->
name|sc_flag
operator|=
literal|0
expr_stmt|;
comment|/* init saved cursor flag */
name|svsp
operator|->
name|which_fkl
operator|=
name|SYS_FKL
expr_stmt|;
comment|/* display system fkey-labels */
name|svsp
operator|->
name|labels_on
operator|=
literal|1
expr_stmt|;
comment|/* if in HP-mode, display */
comment|/*            fkey-labels */
name|svsp
operator|->
name|attribute
operator|=
literal|0
expr_stmt|;
comment|/* HP mode init */
name|svsp
operator|->
name|key
operator|=
literal|0
expr_stmt|;
comment|/* HP mode init */
name|svsp
operator|->
name|l_len
operator|=
literal|0
expr_stmt|;
comment|/* HP mode init */
name|svsp
operator|->
name|s_len
operator|=
literal|0
expr_stmt|;
comment|/* HP mode init */
name|svsp
operator|->
name|m_len
operator|=
literal|0
expr_stmt|;
comment|/* HP mode init */
name|svsp
operator|->
name|i
operator|=
literal|0
expr_stmt|;
comment|/* HP mode init */
name|svsp
operator|->
name|vt_pure_mode
operator|=
name|M_PUREVT
expr_stmt|;
comment|/* initial mode: pure VT220*/
name|svsp
operator|->
name|vga_charset
operator|=
name|CH_SET0
expr_stmt|;
comment|/* use bios default charset */
if|#
directive|if
name|PCVT_24LINESDEF
comment|/* true compatibility */
name|svsp
operator|->
name|screen_rows
operator|=
literal|24
expr_stmt|;
comment|/* default 24 rows on screen */
else|#
directive|else
comment|/* full screen */
name|svsp
operator|->
name|screen_rows
operator|=
literal|25
expr_stmt|;
comment|/* default 25 rows on screen */
endif|#
directive|endif
comment|/* PCVT_24LINESDEF */
name|svsp
operator|->
name|screen_rowsize
operator|=
literal|25
expr_stmt|;
comment|/* default 25 rows on screen */
name|svsp
operator|->
name|max_off
operator|=
name|svsp
operator|->
name|screen_rowsize
operator|*
name|SCROLLBACK_PAGES
operator|-
literal|1
expr_stmt|;
name|svsp
operator|->
name|scrr_beg
operator|=
literal|0
expr_stmt|;
comment|/* scrolling region begin row*/
name|svsp
operator|->
name|scrr_len
operator|=
name|svsp
operator|->
name|screen_rows
expr_stmt|;
comment|/* scrolling region length*/
name|svsp
operator|->
name|scrr_end
operator|=
name|svsp
operator|->
name|scrr_len
operator|-
literal|1
expr_stmt|;
comment|/* scrolling region end */
if|if
condition|(
name|nscr
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|adaptor_type
operator|==
name|VGA_ADAPTOR
condition|)
block|{
comment|/* only VGA can read cursor shape registers ! */
comment|/* Preserve initial cursor shape */
name|outb
argument_list|(
name|addr_6845
argument_list|,
name|CRTC_CURSTART
argument_list|)
expr_stmt|;
name|svsp
operator|->
name|cursor_start
operator|=
name|inb
argument_list|(
name|addr_6845
operator|+
literal|1
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|addr_6845
argument_list|,
name|CRTC_CUREND
argument_list|)
expr_stmt|;
name|svsp
operator|->
name|cursor_end
operator|=
name|inb
argument_list|(
name|addr_6845
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* MDA,HGC,CGA,EGA registers are write-only */
name|svsp
operator|->
name|cursor_start
operator|=
literal|0
expr_stmt|;
name|svsp
operator|->
name|cursor_end
operator|=
literal|15
expr_stmt|;
block|}
block|}
else|else
block|{
name|svsp
operator|->
name|cursor_start
operator|=
name|vs
index|[
literal|0
index|]
operator|.
name|cursor_start
expr_stmt|;
name|svsp
operator|->
name|cursor_end
operator|=
name|vs
index|[
literal|0
index|]
operator|.
name|cursor_end
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|FAT_CURSOR
name|svsp
operator|->
name|cursor_start
operator|=
literal|0
expr_stmt|;
name|svsp
operator|->
name|cursor_end
operator|=
literal|15
expr_stmt|;
comment|/* cursor lower scanline */
endif|#
directive|endif
name|svsp
operator|->
name|cursor_on
operator|=
literal|1
expr_stmt|;
comment|/* cursor is on */
name|svsp
operator|->
name|ckm
operator|=
literal|1
expr_stmt|;
comment|/* normal cursor key mode */
name|svsp
operator|->
name|irm
operator|=
literal|0
expr_stmt|;
comment|/* replace mode */
name|svsp
operator|->
name|lnm
operator|=
literal|0
expr_stmt|;
comment|/* CR only */
name|svsp
operator|->
name|selchar
operator|=
literal|0
expr_stmt|;
comment|/* selective attribute off */
name|svsp
operator|->
name|G0
operator|=
name|csd_ascii
expr_stmt|;
comment|/* G0 = ascii	*/
name|svsp
operator|->
name|G1
operator|=
name|csd_ascii
expr_stmt|;
comment|/* G1 = ascii	*/
name|svsp
operator|->
name|G2
operator|=
name|csd_supplemental
expr_stmt|;
comment|/* G2 = supplemental */
name|svsp
operator|->
name|G3
operator|=
name|csd_supplemental
expr_stmt|;
comment|/* G3 = supplemental */
name|svsp
operator|->
name|GL
operator|=
operator|&
name|svsp
operator|->
name|G0
expr_stmt|;
comment|/* GL = G0 */
name|svsp
operator|->
name|GR
operator|=
operator|&
name|svsp
operator|->
name|G2
expr_stmt|;
comment|/* GR = G2 */
name|svsp
operator|->
name|whichi
operator|=
literal|0
expr_stmt|;
comment|/* char set designate init */
name|svsp
operator|->
name|which
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
comment|/* char set designate init */
name|svsp
operator|->
name|hp_state
operator|=
name|SHP_INIT
expr_stmt|;
comment|/* init HP mode state machine*/
name|svsp
operator|->
name|dcs_state
operator|=
name|DCS_INIT
expr_stmt|;
comment|/* init DCS mode state machine*/
name|svsp
operator|->
name|ss
operator|=
literal|0
expr_stmt|;
comment|/* init single shift 2/3 */
name|svsp
operator|->
name|Gs
operator|=
name|NULL
expr_stmt|;
comment|/* Gs single shift 2/3 */
name|svsp
operator|->
name|maxcol
operator|=
name|SCR_COL80
expr_stmt|;
comment|/* 80 columns now (MUST!!!) */
name|svsp
operator|->
name|wd132col
operator|=
literal|0
expr_stmt|;
comment|/* help good old WD .. */
name|svsp
operator|->
name|scroll_lock
operator|=
literal|0
expr_stmt|;
comment|/* scrollock off */
if|#
directive|if
name|PCVT_INHIBIT_NUMLOCK
name|svsp
operator|->
name|num_lock
operator|=
literal|0
expr_stmt|;
comment|/* numlock off */
else|#
directive|else
name|svsp
operator|->
name|num_lock
operator|=
literal|1
expr_stmt|;
comment|/* numlock on */
endif|#
directive|endif
name|svsp
operator|->
name|caps_lock
operator|=
literal|0
expr_stmt|;
comment|/* capslock off */
name|svsp
operator|->
name|shift_lock
operator|=
literal|0
expr_stmt|;
comment|/* shiftlock off */
if|#
directive|if
name|PCVT_24LINESDEF
comment|/* true compatibility */
name|svsp
operator|->
name|force24
operator|=
literal|1
expr_stmt|;
comment|/* force 24 lines */
else|#
directive|else
comment|/* maximum screen size */
name|svsp
operator|->
name|force24
operator|=
literal|0
expr_stmt|;
comment|/* no 24 lines force yet */
endif|#
directive|endif
comment|/* PCVT_24LINESDEF */
name|vt_clearudk
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
comment|/* clear vt220 udk's */
name|vt_str
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
comment|/* init emulator */
if|if
condition|(
name|nscr
operator|==
literal|0
condition|)
block|{
comment|/* 			 * Preserve data on the startup screen that 			 * precedes the cursor position.  Leave the 			 * cursor where it was found. 			 */
name|unsigned
name|cursorat
decl_stmt|;
name|int
name|filllen
decl_stmt|;
comment|/* CRTC regs 0x0e and 0x0f are r/w everywhere */
name|outb
argument_list|(
name|addr_6845
argument_list|,
name|CRTC_CURSORH
argument_list|)
expr_stmt|;
name|cursorat
operator|=
name|inb
argument_list|(
name|addr_6845
operator|+
literal|1
argument_list|)
operator|<<
literal|8
expr_stmt|;
name|outb
argument_list|(
name|addr_6845
argument_list|,
name|CRTC_CURSORL
argument_list|)
expr_stmt|;
name|cursorat
operator||=
name|inb
argument_list|(
name|addr_6845
operator|+
literal|1
argument_list|)
expr_stmt|;
comment|/* 			 * Reject cursors that are more than one row off a 			 * 25-row screen.  syscons sets the cursor offset 			 * to 0xffff. The scroll up fixup fails for this 			 * because the assignment to svsp->row overflows 			 * and perhaps for other reasons. 			 */
if|if
condition|(
name|cursorat
operator|>
literal|25
operator|*
name|svsp
operator|->
name|maxcol
condition|)
name|cursorat
operator|=
literal|25
operator|*
name|svsp
operator|->
name|maxcol
expr_stmt|;
name|svsp
operator|->
name|cur_offset
operator|=
name|cursorat
expr_stmt|;
name|svsp
operator|->
name|row
operator|=
name|cursorat
operator|/
name|svsp
operator|->
name|maxcol
expr_stmt|;
name|svsp
operator|->
name|col
operator|=
name|cursorat
operator|%
name|svsp
operator|->
name|maxcol
expr_stmt|;
if|if
condition|(
name|svsp
operator|->
name|row
operator|>=
name|svsp
operator|->
name|screen_rows
condition|)
block|{
comment|/* 			 * Scroll up; this should only happen when 			 * PCVT_24LINESDEF is set 			 */
name|int
name|nscroll
init|=
name|svsp
operator|->
name|row
operator|+
literal|1
operator|-
name|svsp
operator|->
name|screen_rows
decl_stmt|;
name|bcopy
argument_list|(
name|svsp
operator|->
name|Crtat
operator|+
name|nscroll
operator|*
name|svsp
operator|->
name|maxcol
argument_list|,
name|svsp
operator|->
name|Crtat
argument_list|,
name|svsp
operator|->
name|screen_rows
operator|*
name|svsp
operator|->
name|maxcol
operator|*
name|CHR
argument_list|)
expr_stmt|;
name|svsp
operator|->
name|row
operator|-=
name|nscroll
expr_stmt|;
name|svsp
operator|->
name|cur_offset
operator|-=
name|nscroll
operator|*
name|svsp
operator|->
name|maxcol
expr_stmt|;
block|}
name|filllen
operator|=
operator|(
name|svsp
operator|->
name|maxcol
operator|*
name|svsp
operator|->
name|screen_rowsize
operator|)
operator|-
name|svsp
operator|->
name|cur_offset
expr_stmt|;
if|if
condition|(
name|filllen
operator|>
literal|0
condition|)
name|fillw
argument_list|(
name|user_attr
operator||
literal|' '
argument_list|,
name|svsp
operator|->
name|Crtat
operator|+
name|svsp
operator|->
name|cur_offset
argument_list|,
name|filllen
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|XSERVER
name|svsp
operator|->
name|smode
operator|.
name|mode
operator|=
name|VT_AUTO
expr_stmt|;
name|svsp
operator|->
name|smode
operator|.
name|relsig
operator|=
name|svsp
operator|->
name|smode
operator|.
name|acqsig
operator|=
name|svsp
operator|->
name|smode
operator|.
name|frsig
operator|=
literal|0
expr_stmt|;
name|svsp
operator|->
name|proc
operator|=
literal|0
expr_stmt|;
name|svsp
operator|->
name|pid
operator|=
name|svsp
operator|->
name|vt_status
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
comment|/* XSERVER */
block|}
for|for
control|(
name|charset
operator|=
literal|0
init|;
name|charset
operator|<
name|NVGAFONTS
condition|;
name|charset
operator|++
control|)
block|{
name|vgacs
index|[
name|charset
index|]
operator|.
name|loaded
operator|=
literal|0
expr_stmt|;
comment|/* not populated yet */
name|vgacs
index|[
name|charset
index|]
operator|.
name|secondloaded
operator|=
literal|0
expr_stmt|;
comment|/* not populated yet */
switch|switch
condition|(
name|adaptor_type
condition|)
block|{
case|case
name|VGA_ADAPTOR
case|:
comment|/* 				 * for a VGA, do not assume any 				 * constant - instead, read the actual 				 * values. This avoid problems with 				 * LCD displays that apparently happen 				 * to use font matrices up to 19 				 * scan lines and 475 scan lines 				 * total in order to make use of the 				 * whole screen area 				 */
name|outb
argument_list|(
name|addr_6845
argument_list|,
name|CRTC_VDE
argument_list|)
expr_stmt|;
name|vgacs
index|[
name|charset
index|]
operator|.
name|scr_scanlines
operator|=
name|inb
argument_list|(
name|addr_6845
operator|+
literal|1
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|addr_6845
argument_list|,
name|CRTC_MAXROW
argument_list|)
expr_stmt|;
name|vgacs
index|[
name|charset
index|]
operator|.
name|char_scanlines
operator|=
name|inb
argument_list|(
name|addr_6845
operator|+
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|EGA_ADAPTOR
case|:
comment|/* 0x5D for 25 lines */
name|vgacs
index|[
name|charset
index|]
operator|.
name|scr_scanlines
operator|=
literal|0x5D
expr_stmt|;
comment|/* 0x4D for 25 lines */
name|vgacs
index|[
name|charset
index|]
operator|.
name|char_scanlines
operator|=
literal|0x4D
expr_stmt|;
break|break;
case|case
name|CGA_ADAPTOR
case|:
case|case
name|MDA_ADAPTOR
case|:
default|default:
comment|/* These shouldn't be used for CGA/MDA */
name|vgacs
index|[
name|charset
index|]
operator|.
name|scr_scanlines
operator|=
literal|0
expr_stmt|;
name|vgacs
index|[
name|charset
index|]
operator|.
name|char_scanlines
operator|=
literal|0
expr_stmt|;
break|break;
block|}
name|vgacs
index|[
name|charset
index|]
operator|.
name|screen_size
operator|=
name|SIZ_25ROWS
expr_stmt|;
comment|/* set screen size */
block|}
name|vgacs
index|[
literal|0
index|]
operator|.
name|loaded
operator|=
literal|1
expr_stmt|;
comment|/* The BIOS loaded this at boot */
comment|/* set cursor for first screen */
name|outb
argument_list|(
name|addr_6845
argument_list|,
name|CRTC_CURSTART
argument_list|)
expr_stmt|;
comment|/* cursor start reg */
name|outb
argument_list|(
name|addr_6845
operator|+
literal|1
argument_list|,
name|vs
index|[
literal|0
index|]
operator|.
name|cursor_start
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|addr_6845
argument_list|,
name|CRTC_CUREND
argument_list|)
expr_stmt|;
comment|/* cursor end reg */
name|outb
argument_list|(
name|addr_6845
operator|+
literal|1
argument_list|,
name|vs
index|[
literal|0
index|]
operator|.
name|cursor_end
argument_list|)
expr_stmt|;
comment|/* this is to satisfy ddb */
if|if
condition|(
operator|!
name|keyboard_is_initialized
condition|)
name|kbd_code_init1
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	get kernel memory for virtual screens  *  *	CAUTION: depends on "can_do_132col" being set properly, or  *	depends on vga_type() being run before calling this !!!  *  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|vt_coldmalloc
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|nscr
decl_stmt|;
name|int
name|screen_max_size
decl_stmt|;
comment|/* we need to initialize in case we are not the console */
if|if
condition|(
name|do_initialization
condition|)
name|vt_coldinit
argument_list|()
expr_stmt|;
switch|switch
condition|(
name|adaptor_type
condition|)
block|{
default|default:
case|case
name|MDA_ADAPTOR
case|:
case|case
name|CGA_ADAPTOR
case|:
name|screen_max_size
operator|=
name|MAXROW_MDACGA
operator|*
name|MAXCOL_MDACGA
operator|*
name|CHR
expr_stmt|;
break|break;
case|case
name|EGA_ADAPTOR
case|:
name|screen_max_size
operator|=
name|MAXROW_EGA
operator|*
name|MAXCOL_EGA
operator|*
name|CHR
expr_stmt|;
break|break;
case|case
name|VGA_ADAPTOR
case|:
if|if
condition|(
name|can_do_132col
condition|)
name|screen_max_size
operator|=
name|MAXROW_VGA
operator|*
name|MAXCOL_SVGA
operator|*
name|CHR
expr_stmt|;
else|else
name|screen_max_size
operator|=
name|MAXROW_VGA
operator|*
name|MAXCOL_VGA
operator|*
name|CHR
expr_stmt|;
block|}
for|for
control|(
name|nscr
operator|=
literal|0
init|;
name|nscr
operator|<
name|PCVT_NSCREENS
condition|;
name|nscr
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|vs
index|[
name|nscr
index|]
operator|.
name|Memory
operator|=
operator|(
name|u_short
operator|*
operator|)
name|malloc
argument_list|(
name|screen_max_size
operator|*
literal|2
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_WAITOK
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"pcvt: screen memory malloc failed, "
literal|"NSCREEN=%d, nscr=%d\n"
argument_list|,
name|PCVT_NSCREENS
argument_list|,
name|nscr
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|nscr
operator|!=
literal|0
condition|)
block|{
name|vs
index|[
name|nscr
index|]
operator|.
name|Crtat
operator|=
name|vs
index|[
name|nscr
index|]
operator|.
name|Memory
expr_stmt|;
name|fillw
argument_list|(
name|user_attr
operator||
literal|' '
argument_list|,
name|vs
index|[
name|nscr
index|]
operator|.
name|Crtat
argument_list|,
name|vs
index|[
name|nscr
index|]
operator|.
name|maxcol
operator|*
name|vs
index|[
name|nscr
index|]
operator|.
name|screen_rowsize
argument_list|)
expr_stmt|;
name|totalscreens
operator|++
expr_stmt|;
block|}
name|vs
index|[
name|nscr
index|]
operator|.
name|scrollback_pages
operator|=
name|SCROLLBACK_PAGES
expr_stmt|;
name|reallocate_scrollbuffer
argument_list|(
operator|&
operator|(
name|vs
index|[
name|nscr
index|]
operator|)
argument_list|,
name|vs
index|[
name|nscr
index|]
operator|.
name|scrollback_pages
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	check if we must scroll up screen  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|check_scroll
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
if|if
condition|(
operator|!
name|svsp
operator|->
name|abs_write
condition|)
block|{
comment|/* we write within scroll region */
if|if
condition|(
name|svsp
operator|->
name|cur_offset
operator|>=
operator|(
operator|(
name|svsp
operator|->
name|scrr_end
operator|+
literal|1
operator|)
operator|*
name|svsp
operator|->
name|maxcol
operator|)
condition|)
block|{
comment|/* the following piece of code has to be protected */
comment|/* from trying to switch to another virtual screen */
comment|/* while being in there ...                        */
name|critical_scroll
operator|=
literal|1
expr_stmt|;
comment|/* flag protect ON */
name|roll_up
argument_list|(
name|svsp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* rolling up .. */
name|svsp
operator|->
name|cur_offset
operator|-=
name|svsp
operator|->
name|maxcol
expr_stmt|;
comment|/* update position */
if|if
condition|(
name|switch_page
operator|!=
operator|-
literal|1
condition|)
comment|/* someone wanted to switch ? */
block|{
name|vgapage
argument_list|(
name|switch_page
argument_list|)
expr_stmt|;
comment|/* yes, then switch ! */
name|switch_page
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* reset switch flag  */
block|}
name|critical_scroll
operator|=
literal|0
expr_stmt|;
comment|/* flag protect OFF */
block|}
block|}
else|else
block|{
comment|/* clip, if outside of screen */
if|if
condition|(
name|svsp
operator|->
name|cur_offset
operator|>=
name|svsp
operator|->
name|screen_rows
operator|*
name|svsp
operator|->
name|maxcol
condition|)
name|svsp
operator|->
name|cur_offset
operator|-=
name|svsp
operator|->
name|maxcol
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|int
name|check_scrollback
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
comment|/* still waiting for scrollback memory or not on current page */
if|if
condition|(
operator|!
name|svsp
operator|->
name|Scrollback
operator|||
name|svsp
operator|!=
name|vsp
condition|)
return|return
literal|0
return|;
comment|/* remove first line of scrollback buffer to make room for new line */
if|if
condition|(
name|svsp
operator|->
name|scr_offset
operator|==
name|svsp
operator|->
name|max_off
condition|)
block|{
name|bcopy
argument_list|(
name|svsp
operator|->
name|Scrollback
operator|+
name|svsp
operator|->
name|maxcol
argument_list|,
name|svsp
operator|->
name|Scrollback
argument_list|,
name|svsp
operator|->
name|maxcol
operator|*
name|svsp
operator|->
name|max_off
operator|*
name|CHR
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* still room left, increase scroll offset (lines) */
name|svsp
operator|->
name|scr_offset
operator|++
expr_stmt|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	write to one user function key label  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|writefkl
parameter_list|(
name|int
name|num
parameter_list|,
name|u_char
modifier|*
name|string
parameter_list|,
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
if|if
condition|(
operator|(
name|num
operator|<
literal|0
operator|)
operator|||
operator|(
name|num
operator|>
literal|7
operator|)
condition|)
comment|/* range ok ? */
return|return;
name|strncpy
argument_list|(
name|svsp
operator|->
name|ufkl
index|[
name|num
index|]
argument_list|,
name|string
argument_list|,
literal|16
argument_list|)
expr_stmt|;
comment|/* save string in static array */
if|if
condition|(
name|svsp
operator|->
name|which_fkl
operator|==
name|USR_FKL
condition|)
name|wrfkl
argument_list|(
name|num
argument_list|,
name|string
argument_list|,
name|svsp
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	write to one system function key label  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|swritefkl
parameter_list|(
name|int
name|num
parameter_list|,
name|u_char
modifier|*
name|string
parameter_list|,
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
if|if
condition|(
operator|(
name|num
operator|<
literal|0
operator|)
operator|||
operator|(
name|num
operator|>
literal|7
operator|)
condition|)
comment|/* range ok ? */
return|return;
name|strncpy
argument_list|(
name|svsp
operator|->
name|sfkl
index|[
name|num
index|]
argument_list|,
name|string
argument_list|,
literal|16
argument_list|)
expr_stmt|;
comment|/* save string in static array */
if|if
condition|(
name|svsp
operator|->
name|which_fkl
operator|==
name|SYS_FKL
condition|)
name|wrfkl
argument_list|(
name|num
argument_list|,
name|string
argument_list|,
name|svsp
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	write function key label onto screen  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|wrfkl
parameter_list|(
name|int
name|num
parameter_list|,
name|u_char
modifier|*
name|string
parameter_list|,
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
specifier|register
name|u_short
modifier|*
name|p
decl_stmt|;
specifier|register
name|u_short
modifier|*
name|p1
decl_stmt|;
specifier|register
name|int
name|cnt
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|svsp
operator|->
name|labels_on
operator|||
operator|(
name|svsp
operator|->
name|vt_pure_mode
operator|==
name|M_PUREVT
operator|)
condition|)
return|return;
name|p
operator|=
operator|(
name|svsp
operator|->
name|Crtat
operator|+
operator|(
name|svsp
operator|->
name|screen_rows
operator|*
name|svsp
operator|->
name|maxcol
operator|)
operator|)
expr_stmt|;
comment|/* screen_rows+1 line */
if|if
condition|(
name|svsp
operator|->
name|maxcol
operator|==
name|SCR_COL80
condition|)
block|{
if|if
condition|(
name|num
operator|<
literal|4
condition|)
comment|/* labels 1 .. 4 */
name|p
operator|+=
operator|(
name|num
operator|*
name|LABEL_LEN
operator|)
expr_stmt|;
else|else
comment|/* labels 5 .. 8 */
name|p
operator|+=
operator|(
operator|(
name|num
operator|*
name|LABEL_LEN
operator|)
operator|+
name|LABEL_MID
operator|+
literal|1
operator|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|num
operator|<
literal|4
condition|)
comment|/* labels 1 .. 4 */
name|p
operator|+=
operator|(
name|num
operator|*
operator|(
name|LABEL_LEN
operator|+
literal|6
operator|)
operator|)
expr_stmt|;
else|else
comment|/* labels 5 .. 8 */
name|p
operator|+=
operator|(
operator|(
name|num
operator|*
operator|(
name|LABEL_LEN
operator|+
literal|6
operator|)
operator|)
operator|+
name|LABEL_MID
operator|+
literal|11
operator|)
expr_stmt|;
block|}
name|p1
operator|=
name|p
operator|+
name|svsp
operator|->
name|maxcol
expr_stmt|;
comment|/* second label line */
while|while
condition|(
operator|(
operator|*
name|string
operator|!=
literal|'\0'
operator|)
operator|&&
operator|(
name|cnt
operator|<
literal|8
operator|)
condition|)
block|{
operator|*
name|p
operator|=
operator|(
operator|(
literal|0x70
operator|<<
literal|8
operator|)
operator|+
operator|(
operator|*
name|string
operator|&
literal|0xff
operator|)
operator|)
expr_stmt|;
name|p
operator|++
expr_stmt|;
name|string
operator|++
expr_stmt|;
name|cnt
operator|++
expr_stmt|;
block|}
while|while
condition|(
name|cnt
operator|<
literal|8
condition|)
block|{
operator|*
name|p
operator|=
operator|(
operator|(
literal|0x70
operator|<<
literal|8
operator|)
operator|+
literal|' '
operator|)
expr_stmt|;
name|p
operator|++
expr_stmt|;
name|cnt
operator|++
expr_stmt|;
block|}
while|while
condition|(
operator|(
operator|*
name|string
operator|!=
literal|'\0'
operator|)
operator|&&
operator|(
name|cnt
operator|<
literal|16
operator|)
condition|)
block|{
operator|*
name|p1
operator|=
operator|(
operator|(
literal|0x70
operator|<<
literal|8
operator|)
operator|+
operator|(
operator|*
name|string
operator|&
literal|0xff
operator|)
operator|)
expr_stmt|;
name|p1
operator|++
expr_stmt|;
name|string
operator|++
expr_stmt|;
name|cnt
operator|++
expr_stmt|;
block|}
while|while
condition|(
name|cnt
operator|<
literal|16
condition|)
block|{
operator|*
name|p1
operator|=
operator|(
operator|(
literal|0x70
operator|<<
literal|8
operator|)
operator|+
literal|' '
operator|)
expr_stmt|;
name|p1
operator|++
expr_stmt|;
name|cnt
operator|++
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	remove (=blank) function key labels, row/col and status line  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|fkl_off
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
specifier|register
name|u_short
modifier|*
name|p
decl_stmt|;
specifier|register
name|int
name|num
decl_stmt|;
specifier|register
name|int
name|size
decl_stmt|;
name|svsp
operator|->
name|labels_on
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|vgacs
index|[
name|svsp
operator|->
name|vga_charset
index|]
operator|.
name|screen_size
operator|==
name|SIZ_28ROWS
operator|)
operator|&&
name|svsp
operator|->
name|force24
condition|)
name|size
operator|=
literal|4
expr_stmt|;
else|else
name|size
operator|=
literal|3
expr_stmt|;
name|p
operator|=
operator|(
name|svsp
operator|->
name|Crtat
operator|+
operator|(
name|svsp
operator|->
name|screen_rows
operator|*
name|svsp
operator|->
name|maxcol
operator|)
operator|)
expr_stmt|;
for|for
control|(
name|num
operator|=
literal|0
init|;
name|num
operator|<
operator|(
name|size
operator|*
name|svsp
operator|->
name|maxcol
operator|)
condition|;
name|num
operator|++
control|)
operator|*
name|p
operator|++
operator|=
literal|' '
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	(re-) display function key labels, row/col and status line  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|fkl_on
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
name|svsp
operator|->
name|labels_on
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|svsp
operator|->
name|which_fkl
operator|==
name|SYS_FKL
condition|)
name|sw_sfkl
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|svsp
operator|->
name|which_fkl
operator|==
name|USR_FKL
condition|)
name|sw_ufkl
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	set emulation mode, switch between pure VTxxx mode and HP/VTxxx mode  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|set_emulation_mode
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
if|if
condition|(
name|svsp
operator|->
name|vt_pure_mode
operator|==
name|mode
condition|)
return|return;
name|clr_parms
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
comment|/* escape parameter init */
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
comment|/* initial state */
name|svsp
operator|->
name|scrr_beg
operator|=
literal|0
expr_stmt|;
comment|/* start of scrolling region */
name|svsp
operator|->
name|sc_flag
operator|=
literal|0
expr_stmt|;
comment|/* invalidate saved cursor position */
name|svsp
operator|->
name|transparent
operator|=
literal|0
expr_stmt|;
comment|/* disable control code processing */
if|if
condition|(
name|mode
operator|==
name|M_HPVT
condition|)
comment|/* vt-pure -> hp/vt-mode */
block|{
name|svsp
operator|->
name|screen_rows
operator|=
name|svsp
operator|->
name|screen_rowsize
operator|-
literal|3
expr_stmt|;
if|if
condition|(
name|svsp
operator|->
name|force24
operator|&&
name|svsp
operator|->
name|screen_rows
operator|==
literal|25
condition|)
name|svsp
operator|->
name|screen_rows
operator|=
literal|24
expr_stmt|;
if|if
condition|(
name|svsp
operator|->
name|row
operator|>=
name|svsp
operator|->
name|screen_rows
condition|)
block|{
comment|/* Scroll up */
name|int
name|nscroll
init|=
name|svsp
operator|->
name|row
operator|+
literal|1
operator|-
name|svsp
operator|->
name|screen_rows
decl_stmt|;
name|bcopy
argument_list|(
name|svsp
operator|->
name|Crtat
operator|+
name|nscroll
operator|*
name|svsp
operator|->
name|maxcol
argument_list|,
name|svsp
operator|->
name|Crtat
argument_list|,
name|svsp
operator|->
name|screen_rows
operator|*
name|svsp
operator|->
name|maxcol
operator|*
name|CHR
argument_list|)
expr_stmt|;
name|svsp
operator|->
name|row
operator|-=
name|nscroll
expr_stmt|;
name|svsp
operator|->
name|cur_offset
operator|-=
name|nscroll
operator|*
name|svsp
operator|->
name|maxcol
expr_stmt|;
block|}
name|svsp
operator|->
name|vt_pure_mode
operator|=
name|M_HPVT
expr_stmt|;
if|if
condition|(
name|svsp
operator|->
name|vs_tty
condition|)
name|svsp
operator|->
name|vs_tty
operator|->
name|t_winsize
operator|.
name|ws_row
operator|=
name|svsp
operator|->
name|screen_rows
expr_stmt|;
name|svsp
operator|->
name|scrr_len
operator|=
name|svsp
operator|->
name|screen_rows
expr_stmt|;
name|svsp
operator|->
name|scrr_end
operator|=
name|svsp
operator|->
name|scrr_len
operator|-
literal|1
expr_stmt|;
name|update_hp
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|mode
operator|==
name|M_PUREVT
condition|)
comment|/* hp/vt-mode -> vt-pure */
block|{
name|fillw
argument_list|(
name|user_attr
operator||
literal|' '
argument_list|,
name|svsp
operator|->
name|Crtat
operator|+
name|svsp
operator|->
name|screen_rows
operator|*
name|svsp
operator|->
name|maxcol
argument_list|,
operator|(
name|svsp
operator|->
name|screen_rowsize
operator|-
name|svsp
operator|->
name|screen_rows
operator|)
operator|*
name|svsp
operator|->
name|maxcol
argument_list|)
expr_stmt|;
name|svsp
operator|->
name|vt_pure_mode
operator|=
name|M_PUREVT
expr_stmt|;
name|svsp
operator|->
name|screen_rows
operator|=
name|svsp
operator|->
name|screen_rowsize
expr_stmt|;
if|if
condition|(
name|svsp
operator|->
name|force24
operator|&&
name|svsp
operator|->
name|screen_rows
operator|==
literal|25
condition|)
name|svsp
operator|->
name|screen_rows
operator|=
literal|24
expr_stmt|;
if|if
condition|(
name|svsp
operator|->
name|vs_tty
condition|)
name|svsp
operator|->
name|vs_tty
operator|->
name|t_winsize
operator|.
name|ws_row
operator|=
name|svsp
operator|->
name|screen_rows
expr_stmt|;
name|svsp
operator|->
name|scrr_len
operator|=
name|svsp
operator|->
name|screen_rows
expr_stmt|;
name|svsp
operator|->
name|scrr_end
operator|=
name|svsp
operator|->
name|scrr_len
operator|-
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|svsp
operator|->
name|vs_tty
operator|&&
name|svsp
operator|->
name|vs_tty
operator|->
name|t_pgrp
condition|)
block|{
name|PGRP_LOCK
argument_list|(
name|svsp
operator|->
name|vs_tty
operator|->
name|t_pgrp
argument_list|)
expr_stmt|;
name|pgsignal
argument_list|(
name|svsp
operator|->
name|vs_tty
operator|->
name|t_pgrp
argument_list|,
name|SIGWINCH
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|PGRP_UNLOCK
argument_list|(
name|svsp
operator|->
name|vs_tty
operator|->
name|t_pgrp
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	initialize user function key labels  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|init_ufkl
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
name|writefkl
argument_list|(
literal|0
argument_list|,
operator|(
name|u_char
operator|*
operator|)
literal|"   f1"
argument_list|,
name|svsp
argument_list|)
expr_stmt|;
comment|/* init fkey labels */
name|writefkl
argument_list|(
literal|1
argument_list|,
operator|(
name|u_char
operator|*
operator|)
literal|"   f2"
argument_list|,
name|svsp
argument_list|)
expr_stmt|;
name|writefkl
argument_list|(
literal|2
argument_list|,
operator|(
name|u_char
operator|*
operator|)
literal|"   f3"
argument_list|,
name|svsp
argument_list|)
expr_stmt|;
name|writefkl
argument_list|(
literal|3
argument_list|,
operator|(
name|u_char
operator|*
operator|)
literal|"   f4"
argument_list|,
name|svsp
argument_list|)
expr_stmt|;
name|writefkl
argument_list|(
literal|4
argument_list|,
operator|(
name|u_char
operator|*
operator|)
literal|"   f5"
argument_list|,
name|svsp
argument_list|)
expr_stmt|;
name|writefkl
argument_list|(
literal|5
argument_list|,
operator|(
name|u_char
operator|*
operator|)
literal|"   f6"
argument_list|,
name|svsp
argument_list|)
expr_stmt|;
name|writefkl
argument_list|(
literal|6
argument_list|,
operator|(
name|u_char
operator|*
operator|)
literal|"   f7"
argument_list|,
name|svsp
argument_list|)
expr_stmt|;
name|writefkl
argument_list|(
literal|7
argument_list|,
operator|(
name|u_char
operator|*
operator|)
literal|"   f8"
argument_list|,
name|svsp
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	initialize system user function key labels  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|init_sfkl
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
comment|/* 1234567812345678 */
if|if
condition|(
name|can_do_132col
condition|)
comment|/* 1234567812345678 */
name|swritefkl
argument_list|(
literal|0
argument_list|,
operator|(
name|u_char
operator|*
operator|)
literal|"132     COLUMNS "
argument_list|,
name|svsp
argument_list|)
expr_stmt|;
else|else
name|swritefkl
argument_list|(
literal|0
argument_list|,
operator|(
name|u_char
operator|*
operator|)
literal|" "
argument_list|,
name|svsp
argument_list|)
expr_stmt|;
comment|/* 1234567812345678 */
name|swritefkl
argument_list|(
literal|1
argument_list|,
operator|(
name|u_char
operator|*
operator|)
literal|"SOFT-RSTTERMINAL"
argument_list|,
name|svsp
argument_list|)
expr_stmt|;
if|if
condition|(
name|svsp
operator|->
name|force24
condition|)
name|swritefkl
argument_list|(
literal|2
argument_list|,
operator|(
name|u_char
operator|*
operator|)
literal|"FORCE24 ENABLE *"
argument_list|,
name|svsp
argument_list|)
expr_stmt|;
else|else
name|swritefkl
argument_list|(
literal|2
argument_list|,
operator|(
name|u_char
operator|*
operator|)
literal|"FORCE24 ENABLE  "
argument_list|,
name|svsp
argument_list|)
expr_stmt|;
if|#
directive|if
name|PCVT_SHOWKEYS
comment|/* 1234567812345678 */
if|if
condition|(
name|svsp
operator|==
operator|&
name|vs
index|[
literal|0
index|]
condition|)
name|swritefkl
argument_list|(
literal|3
argument_list|,
operator|(
name|u_char
operator|*
operator|)
literal|"KEYBSCANDISPLAY "
argument_list|,
name|svsp
argument_list|)
expr_stmt|;
else|else
name|swritefkl
argument_list|(
literal|3
argument_list|,
operator|(
name|u_char
operator|*
operator|)
literal|" "
argument_list|,
name|svsp
argument_list|)
expr_stmt|;
else|#
directive|else
name|swritefkl
argument_list|(
literal|3
argument_list|,
operator|(
name|u_char
operator|*
operator|)
literal|" "
argument_list|,
name|svsp
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* PCVT_SHOWKEYS */
comment|/* 1234567812345678 */
if|if
condition|(
name|svsp
operator|->
name|bell_on
condition|)
name|swritefkl
argument_list|(
literal|4
argument_list|,
operator|(
name|u_char
operator|*
operator|)
literal|"BELL    ENABLE *"
argument_list|,
name|svsp
argument_list|)
expr_stmt|;
else|else
name|swritefkl
argument_list|(
literal|4
argument_list|,
operator|(
name|u_char
operator|*
operator|)
literal|"BELL    ENABLE  "
argument_list|,
name|svsp
argument_list|)
expr_stmt|;
if|if
condition|(
name|svsp
operator|->
name|sevenbit
condition|)
name|swritefkl
argument_list|(
literal|5
argument_list|,
operator|(
name|u_char
operator|*
operator|)
literal|"8-BIT   ENABLE  "
argument_list|,
name|svsp
argument_list|)
expr_stmt|;
else|else
name|swritefkl
argument_list|(
literal|5
argument_list|,
operator|(
name|u_char
operator|*
operator|)
literal|"8-BIT   ENABLE *"
argument_list|,
name|svsp
argument_list|)
expr_stmt|;
name|swritefkl
argument_list|(
literal|6
argument_list|,
operator|(
name|u_char
operator|*
operator|)
literal|"DISPLAY FUNCTNS "
argument_list|,
name|svsp
argument_list|)
expr_stmt|;
name|swritefkl
argument_list|(
literal|7
argument_list|,
operator|(
name|u_char
operator|*
operator|)
literal|"AUTOWRAPENABLE *"
argument_list|,
name|svsp
argument_list|)
expr_stmt|;
comment|/* 1234567812345678 */
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	switch display to user function key labels  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|sw_ufkl
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|svsp
operator|->
name|which_fkl
operator|=
name|USR_FKL
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
name|wrfkl
argument_list|(
name|i
argument_list|,
name|svsp
operator|->
name|ufkl
index|[
name|i
index|]
argument_list|,
name|svsp
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	switch display to system function key labels  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|sw_sfkl
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|svsp
operator|->
name|which_fkl
operator|=
name|SYS_FKL
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
name|wrfkl
argument_list|(
name|i
argument_list|,
name|svsp
operator|->
name|sfkl
index|[
name|i
index|]
argument_list|,
name|svsp
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	toggle force 24 lines  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|toggl_24l
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
if|if
condition|(
name|svsp
operator|->
name|which_fkl
operator|==
name|SYS_FKL
condition|)
block|{
if|if
condition|(
name|svsp
operator|->
name|force24
condition|)
block|{
name|svsp
operator|->
name|force24
operator|=
literal|0
expr_stmt|;
name|swritefkl
argument_list|(
literal|2
argument_list|,
operator|(
name|u_char
operator|*
operator|)
literal|"FORCE24 ENABLE  "
argument_list|,
name|svsp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|svsp
operator|->
name|force24
operator|=
literal|1
expr_stmt|;
name|swritefkl
argument_list|(
literal|2
argument_list|,
operator|(
name|u_char
operator|*
operator|)
literal|"FORCE24 ENABLE *"
argument_list|,
name|svsp
argument_list|)
expr_stmt|;
block|}
name|set_screen_size
argument_list|(
name|svsp
argument_list|,
name|vgacs
index|[
operator|(
name|svsp
operator|->
name|vga_charset
operator|)
index|]
operator|.
name|screen_size
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_if
if|#
directive|if
name|PCVT_SHOWKEYS
end_if

begin_comment
comment|/*---------------------------------------------------------------------------*  *	toggle keyboard scancode display  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|toggl_kbddbg
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
if|if
condition|(
operator|(
name|svsp
operator|->
name|which_fkl
operator|==
name|SYS_FKL
operator|)
operator|&&
operator|(
name|svsp
operator|==
operator|&
name|vs
index|[
literal|0
index|]
operator|)
condition|)
block|{
if|if
condition|(
name|keyboard_show
condition|)
block|{
name|keyboard_show
operator|=
literal|0
expr_stmt|;
name|swritefkl
argument_list|(
literal|3
argument_list|,
operator|(
name|u_char
operator|*
operator|)
literal|"KEYBSCANDISPLAY "
argument_list|,
name|svsp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|keyboard_show
operator|=
literal|1
expr_stmt|;
name|swritefkl
argument_list|(
literal|3
argument_list|,
operator|(
name|u_char
operator|*
operator|)
literal|"KEYBSCANDISPLAY*"
argument_list|,
name|svsp
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* PCVT_SHOWKEYS */
end_comment

begin_comment
comment|/*---------------------------------------------------------------------------*  *	toggle display functions  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|toggl_dspf
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
if|if
condition|(
name|svsp
operator|->
name|which_fkl
operator|==
name|SYS_FKL
condition|)
block|{
if|if
condition|(
name|svsp
operator|->
name|dis_fnc
condition|)
block|{
name|svsp
operator|->
name|dis_fnc
operator|=
literal|0
expr_stmt|;
name|swritefkl
argument_list|(
literal|6
argument_list|,
operator|(
name|u_char
operator|*
operator|)
literal|"DISPLAY FUNCTNS "
argument_list|,
name|svsp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|svsp
operator|->
name|dis_fnc
operator|=
literal|1
expr_stmt|;
name|swritefkl
argument_list|(
literal|6
argument_list|,
operator|(
name|u_char
operator|*
operator|)
literal|"DISPLAY FUNCTNS*"
argument_list|,
name|svsp
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	auto wrap on/off  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|toggl_awm
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
if|if
condition|(
name|svsp
operator|->
name|which_fkl
operator|==
name|SYS_FKL
condition|)
block|{
if|if
condition|(
name|svsp
operator|->
name|m_awm
condition|)
block|{
name|svsp
operator|->
name|m_awm
operator|=
literal|0
expr_stmt|;
name|swritefkl
argument_list|(
literal|7
argument_list|,
operator|(
name|u_char
operator|*
operator|)
literal|"AUTOWRAPENABLE  "
argument_list|,
name|svsp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|svsp
operator|->
name|m_awm
operator|=
literal|1
expr_stmt|;
name|swritefkl
argument_list|(
literal|7
argument_list|,
operator|(
name|u_char
operator|*
operator|)
literal|"AUTOWRAPENABLE *"
argument_list|,
name|svsp
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	bell on/off  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|toggl_bell
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
if|if
condition|(
name|svsp
operator|->
name|which_fkl
operator|==
name|SYS_FKL
condition|)
block|{
if|if
condition|(
name|svsp
operator|->
name|bell_on
condition|)
block|{
name|svsp
operator|->
name|bell_on
operator|=
literal|0
expr_stmt|;
name|swritefkl
argument_list|(
literal|4
argument_list|,
operator|(
name|u_char
operator|*
operator|)
literal|"BELL    ENABLE  "
argument_list|,
name|svsp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|svsp
operator|->
name|bell_on
operator|=
literal|1
expr_stmt|;
name|swritefkl
argument_list|(
literal|4
argument_list|,
operator|(
name|u_char
operator|*
operator|)
literal|"BELL    ENABLE *"
argument_list|,
name|svsp
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	7/8 bit usage  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|toggl_sevenbit
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
if|if
condition|(
name|svsp
operator|->
name|which_fkl
operator|==
name|SYS_FKL
condition|)
block|{
if|if
condition|(
name|svsp
operator|->
name|sevenbit
condition|)
block|{
name|svsp
operator|->
name|sevenbit
operator|=
literal|0
expr_stmt|;
name|swritefkl
argument_list|(
literal|5
argument_list|,
operator|(
name|u_char
operator|*
operator|)
literal|"8-BIT   ENABLE *"
argument_list|,
name|svsp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|svsp
operator|->
name|sevenbit
operator|=
literal|1
expr_stmt|;
name|swritefkl
argument_list|(
literal|5
argument_list|,
operator|(
name|u_char
operator|*
operator|)
literal|"8-BIT   ENABLE  "
argument_list|,
name|svsp
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	80 / 132 columns  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|toggl_columns
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
if|if
condition|(
name|svsp
operator|->
name|which_fkl
operator|==
name|SYS_FKL
condition|)
block|{
if|if
condition|(
name|svsp
operator|->
name|maxcol
operator|==
name|SCR_COL132
condition|)
block|{
if|if
condition|(
name|vt_col
argument_list|(
name|svsp
argument_list|,
name|SCR_COL80
argument_list|)
condition|)
name|svsp
operator|->
name|maxcol
operator|=
literal|80
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|vt_col
argument_list|(
name|svsp
argument_list|,
name|SCR_COL132
argument_list|)
condition|)
name|svsp
operator|->
name|maxcol
operator|=
literal|132
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	toggle vga 80/132 column operation  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|int
name|vt_col
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|,
name|int
name|cols
parameter_list|)
block|{
if|if
condition|(
name|vga_col
argument_list|(
name|svsp
argument_list|,
name|cols
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|cols
operator|==
name|SCR_COL80
condition|)
name|swritefkl
argument_list|(
literal|0
argument_list|,
operator|(
name|u_char
operator|*
operator|)
literal|"132     COLUMNS "
argument_list|,
name|svsp
argument_list|)
expr_stmt|;
else|else
name|swritefkl
argument_list|(
literal|0
argument_list|,
operator|(
name|u_char
operator|*
operator|)
literal|"132     COLUMNS*"
argument_list|,
name|svsp
argument_list|)
expr_stmt|;
name|fillw
argument_list|(
name|user_attr
operator||
literal|' '
argument_list|,
name|svsp
operator|->
name|Crtat
argument_list|,
name|svsp
operator|->
name|maxcol
operator|*
name|svsp
operator|->
name|screen_rowsize
argument_list|)
expr_stmt|;
name|clr_parms
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
comment|/* escape parameter init */
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
comment|/* initial state */
name|svsp
operator|->
name|col
operator|=
literal|0
expr_stmt|;
comment|/* init row */
name|svsp
operator|->
name|row
operator|=
literal|0
expr_stmt|;
comment|/* init col */
name|svsp
operator|->
name|cur_offset
operator|=
literal|0
expr_stmt|;
comment|/* cursor offset init */
name|svsp
operator|->
name|sc_flag
operator|=
literal|0
expr_stmt|;
comment|/* invalidate saved cursor position */
name|svsp
operator|->
name|scrr_beg
operator|=
literal|0
expr_stmt|;
comment|/* reset scrolling region */
name|svsp
operator|->
name|scrr_len
operator|=
name|svsp
operator|->
name|screen_rows
expr_stmt|;
comment|/*reset scrolling region legnth */
name|svsp
operator|->
name|scrr_end
operator|=
name|svsp
operator|->
name|scrr_len
operator|-
literal|1
expr_stmt|;
name|svsp
operator|->
name|transparent
operator|=
literal|0
expr_stmt|;
comment|/* disable control code processing */
name|svsp
operator|->
name|selchar
operator|=
literal|0
expr_stmt|;
comment|/* selective attr off */
name|vt_initsel
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
comment|/* re-init sel attr */
name|update_hp
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
comment|/* update labels, row/col, page ind */
comment|/* Update winsize struct to reflect screen size */
if|if
condition|(
name|svsp
operator|->
name|vs_tty
condition|)
block|{
name|svsp
operator|->
name|vs_tty
operator|->
name|t_winsize
operator|.
name|ws_row
operator|=
name|svsp
operator|->
name|screen_rows
expr_stmt|;
name|svsp
operator|->
name|vs_tty
operator|->
name|t_winsize
operator|.
name|ws_col
operator|=
name|svsp
operator|->
name|maxcol
expr_stmt|;
name|svsp
operator|->
name|vs_tty
operator|->
name|t_winsize
operator|.
name|ws_xpixel
operator|=
operator|(
name|cols
operator|==
name|SCR_COL80
operator|)
condition|?
literal|720
else|:
literal|1056
expr_stmt|;
name|svsp
operator|->
name|vs_tty
operator|->
name|t_winsize
operator|.
name|ws_ypixel
operator|=
literal|400
expr_stmt|;
if|if
condition|(
name|svsp
operator|->
name|vs_tty
operator|->
name|t_pgrp
condition|)
block|{
name|PGRP_LOCK
argument_list|(
name|svsp
operator|->
name|vs_tty
operator|->
name|t_pgrp
argument_list|)
expr_stmt|;
name|pgsignal
argument_list|(
name|svsp
operator|->
name|vs_tty
operator|->
name|t_pgrp
argument_list|,
name|SIGWINCH
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|PGRP_UNLOCK
argument_list|(
name|svsp
operator|->
name|vs_tty
operator|->
name|t_pgrp
argument_list|)
expr_stmt|;
block|}
block|}
name|reallocate_scrollbuffer
argument_list|(
name|svsp
argument_list|,
name|svsp
operator|->
name|scrollback_pages
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	update HP stuff on screen  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|update_hp
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
if|if
condition|(
name|svsp
operator|->
name|vt_pure_mode
operator|!=
name|M_HPVT
condition|)
return|return;
name|fillw
argument_list|(
name|user_attr
operator||
literal|' '
argument_list|,
name|svsp
operator|->
name|Crtat
operator|+
name|svsp
operator|->
name|screen_rows
operator|*
name|svsp
operator|->
name|maxcol
argument_list|,
operator|(
name|svsp
operator|->
name|screen_rowsize
operator|-
name|svsp
operator|->
name|screen_rows
operator|)
operator|*
name|svsp
operator|->
name|maxcol
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|svsp
operator|->
name|labels_on
condition|)
return|return;
comment|/* update fkey labels */
name|fkl_off
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
name|fkl_on
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
if|if
condition|(
name|vsp
operator|==
name|svsp
condition|)
block|{
comment|/* update current displayed screen indicator */
operator|*
operator|(
operator|(
name|svsp
operator|->
name|Crtat
operator|+
operator|(
operator|(
name|svsp
operator|->
name|screen_rows
operator|+
literal|2
operator|)
operator|*
name|svsp
operator|->
name|maxcol
operator|)
operator|)
operator|+
name|svsp
operator|->
name|maxcol
operator|-
literal|3
operator|)
operator|=
name|user_attr
operator||
literal|'['
expr_stmt|;
operator|*
operator|(
operator|(
name|svsp
operator|->
name|Crtat
operator|+
operator|(
operator|(
name|svsp
operator|->
name|screen_rows
operator|+
literal|2
operator|)
operator|*
name|svsp
operator|->
name|maxcol
operator|)
operator|)
operator|+
name|svsp
operator|->
name|maxcol
operator|-
literal|2
operator|)
operator|=
name|user_attr
operator||
operator|(
name|current_video_screen
operator|+
operator|(
name|current_video_screen
operator|<
literal|10
condition|?
literal|'0'
else|:
operator|(
literal|'a'
operator|-
literal|10
operator|)
operator|)
operator|)
expr_stmt|;
operator|*
operator|(
operator|(
name|svsp
operator|->
name|Crtat
operator|+
operator|(
operator|(
name|svsp
operator|->
name|screen_rows
operator|+
literal|2
operator|)
operator|*
name|svsp
operator|->
name|maxcol
operator|)
operator|)
operator|+
name|svsp
operator|->
name|maxcol
operator|-
literal|1
operator|)
operator|=
name|user_attr
operator||
literal|']'
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *	initialize ANSI escape sequence parameter buffers  *---------------------------------------------------------------------------*/
end_comment

begin_function
name|void
name|clr_parms
parameter_list|(
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
specifier|register
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAXPARMS
condition|;
name|i
operator|++
control|)
name|svsp
operator|->
name|parms
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|svsp
operator|->
name|parmi
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_comment
comment|/*---------------------------------------------------------------------------*  *  *	partial HP 2392 ANSI mode Emulator  *	==================================  *  *	this part takes over the emulation of some escape sequences  *	needed to handle the function key labels  *  *	They are modeled after the corresponding escape sequences  *	introduced with the HP2392 terminals from Hewlett-Packard.  *  *	see:  *	"HP2392A, Display Terminal Reference Manual",  *	HP Manual Part Number 02390-90001  *	and:  *	Reference Manual Supplement  *	"2392A Display Terminal Option 049, ANSI Operation"  *	HP Manual Part Number 02390-90023EN  *  *---------------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|hp_entry
parameter_list|(
name|int
name|ch
parameter_list|,
name|struct
name|video_state
modifier|*
name|svsp
parameter_list|)
block|{
switch|switch
condition|(
name|svsp
operator|->
name|hp_state
condition|)
block|{
case|case
name|SHP_INIT
case|:
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'f'
case|:
name|svsp
operator|->
name|hp_state
operator|=
name|SHP_AND_F
expr_stmt|;
name|svsp
operator|->
name|attribute
operator|=
literal|0
expr_stmt|;
name|svsp
operator|->
name|key
operator|=
literal|0
expr_stmt|;
name|svsp
operator|->
name|l_len
operator|=
literal|0
expr_stmt|;
name|svsp
operator|->
name|s_len
operator|=
literal|0
expr_stmt|;
name|svsp
operator|->
name|i
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'j'
case|:
name|svsp
operator|->
name|m_len
operator|=
literal|0
expr_stmt|;
name|svsp
operator|->
name|hp_state
operator|=
name|SHP_AND_J
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
name|svsp
operator|->
name|hp_state
operator|=
name|SHP_AND_ETE
expr_stmt|;
break|break;
default|default:
name|svsp
operator|->
name|hp_state
operator|=
name|SHP_INIT
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|SHP_AND_F
case|:
if|if
condition|(
operator|(
name|ch
operator|>=
literal|'0'
operator|)
operator|&&
operator|(
name|ch
operator|<=
literal|'8'
operator|)
condition|)
block|{
name|svsp
operator|->
name|attribute
operator|=
name|ch
expr_stmt|;
name|svsp
operator|->
name|hp_state
operator|=
name|SHP_AND_Fa
expr_stmt|;
block|}
else|else
block|{
name|svsp
operator|->
name|hp_state
operator|=
name|SHP_INIT
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
block|}
break|break;
case|case
name|SHP_AND_Fa
case|:
if|if
condition|(
name|ch
operator|==
literal|'a'
condition|)
name|svsp
operator|->
name|hp_state
operator|=
name|SHP_AND_Fak
expr_stmt|;
elseif|else
if|if
condition|(
name|ch
operator|==
literal|'k'
condition|)
block|{
name|svsp
operator|->
name|key
operator|=
name|svsp
operator|->
name|attribute
expr_stmt|;
name|svsp
operator|->
name|hp_state
operator|=
name|SHP_AND_Fakd
expr_stmt|;
block|}
else|else
block|{
name|svsp
operator|->
name|hp_state
operator|=
name|SHP_INIT
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
block|}
break|break;
case|case
name|SHP_AND_Fak
case|:
if|if
condition|(
operator|(
name|ch
operator|>=
literal|'1'
operator|)
operator|&&
operator|(
name|ch
operator|<=
literal|'8'
operator|)
condition|)
block|{
name|svsp
operator|->
name|key
operator|=
name|ch
expr_stmt|;
name|svsp
operator|->
name|hp_state
operator|=
name|SHP_AND_Fak1
expr_stmt|;
block|}
else|else
block|{
name|svsp
operator|->
name|hp_state
operator|=
name|SHP_INIT
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
block|}
break|break;
case|case
name|SHP_AND_Fak1
case|:
if|if
condition|(
name|ch
operator|==
literal|'k'
condition|)
name|svsp
operator|->
name|hp_state
operator|=
name|SHP_AND_Fakd
expr_stmt|;
else|else
block|{
name|svsp
operator|->
name|hp_state
operator|=
name|SHP_INIT
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
block|}
break|break;
case|case
name|SHP_AND_Fakd
case|:
if|if
condition|(
name|svsp
operator|->
name|l_len
operator|>
literal|16
condition|)
block|{
name|svsp
operator|->
name|hp_state
operator|=
name|SHP_INIT
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ch
operator|>=
literal|'0'
operator|&&
name|ch
operator|<=
literal|'9'
condition|)
block|{
name|svsp
operator|->
name|l_len
operator|*=
literal|10
expr_stmt|;
name|svsp
operator|->
name|l_len
operator|+=
operator|(
name|ch
operator|-
literal|'0'
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ch
operator|==
literal|'d'
condition|)
name|svsp
operator|->
name|hp_state
operator|=
name|SHP_AND_FakdL
expr_stmt|;
else|else
block|{
name|svsp
operator|->
name|hp_state
operator|=
name|SHP_INIT
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
block|}
break|break;
case|case
name|SHP_AND_FakdL
case|:
if|if
condition|(
name|svsp
operator|->
name|s_len
operator|>
literal|80
condition|)
block|{
name|svsp
operator|->
name|hp_state
operator|=
name|SHP_INIT
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ch
operator|>=
literal|'0'
operator|&&
name|ch
operator|<=
literal|'9'
condition|)
block|{
name|svsp
operator|->
name|s_len
operator|*=
literal|10
expr_stmt|;
name|svsp
operator|->
name|s_len
operator|+=
operator|(
name|ch
operator|-
literal|'0'
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ch
operator|==
literal|'L'
condition|)
block|{
name|svsp
operator|->
name|hp_state
operator|=
name|SHP_AND_FakdLl
expr_stmt|;
name|svsp
operator|->
name|transparent
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|svsp
operator|->
name|hp_state
operator|=
name|SHP_INIT
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
block|}
break|break;
case|case
name|SHP_AND_FakdLl
case|:
name|svsp
operator|->
name|l_buf
index|[
name|svsp
operator|->
name|i
index|]
operator|=
name|ch
expr_stmt|;
if|if
condition|(
name|svsp
operator|->
name|i
operator|>=
name|svsp
operator|->
name|l_len
operator|-
literal|1
condition|)
block|{
name|svsp
operator|->
name|hp_state
operator|=
name|SHP_AND_FakdLls
expr_stmt|;
name|svsp
operator|->
name|i
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|svsp
operator|->
name|s_len
operator|==
literal|0
condition|)
block|{
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
name|svsp
operator|->
name|hp_state
operator|=
name|SHP_INIT
expr_stmt|;
name|svsp
operator|->
name|transparent
operator|=
literal|0
expr_stmt|;
name|svsp
operator|->
name|i
operator|=
literal|0
expr_stmt|;
name|svsp
operator|->
name|l_buf
index|[
name|svsp
operator|->
name|l_len
index|]
operator|=
literal|'\0'
expr_stmt|;
name|svsp
operator|->
name|s_buf
index|[
name|svsp
operator|->
name|s_len
index|]
operator|=
literal|'\0'
expr_stmt|;
name|writefkl
argument_list|(
operator|(
name|svsp
operator|->
name|key
operator|-
literal|'0'
operator|-
literal|1
operator|)
argument_list|,
name|svsp
operator|->
name|l_buf
argument_list|,
name|svsp
argument_list|)
expr_stmt|;
block|}
block|}
else|else
name|svsp
operator|->
name|i
operator|++
expr_stmt|;
break|break;
case|case
name|SHP_AND_FakdLls
case|:
name|svsp
operator|->
name|s_buf
index|[
name|svsp
operator|->
name|i
index|]
operator|=
name|ch
expr_stmt|;
if|if
condition|(
name|svsp
operator|->
name|i
operator|>=
name|svsp
operator|->
name|s_len
operator|-
literal|1
condition|)
block|{
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
name|svsp
operator|->
name|hp_state
operator|=
name|SHP_INIT
expr_stmt|;
name|svsp
operator|->
name|transparent
operator|=
literal|0
expr_stmt|;
name|svsp
operator|->
name|i
operator|=
literal|0
expr_stmt|;
name|svsp
operator|->
name|l_buf
index|[
name|svsp
operator|->
name|l_len
index|]
operator|=
literal|'\0'
expr_stmt|;
name|svsp
operator|->
name|s_buf
index|[
name|svsp
operator|->
name|s_len
index|]
operator|=
literal|'\0'
expr_stmt|;
name|writefkl
argument_list|(
operator|(
name|svsp
operator|->
name|key
operator|-
literal|'0'
operator|-
literal|1
operator|)
argument_list|,
name|svsp
operator|->
name|l_buf
argument_list|,
name|svsp
argument_list|)
expr_stmt|;
block|}
else|else
name|svsp
operator|->
name|i
operator|++
expr_stmt|;
break|break;
case|case
name|SHP_AND_J
case|:
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'@'
case|:
comment|/* enable user keys, remove */
comment|/* all labels& status from */
comment|/* screen 		    */
name|svsp
operator|->
name|hp_state
operator|=
name|SHP_INIT
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
name|fkl_off
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'A'
case|:
comment|/* enable& display "modes" */
name|svsp
operator|->
name|hp_state
operator|=
name|SHP_INIT
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
name|fkl_on
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
name|sw_sfkl
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'B'
case|:
comment|/* enable& display "user"  */
name|svsp
operator|->
name|hp_state
operator|=
name|SHP_INIT
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
name|fkl_on
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
name|sw_ufkl
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'C'
case|:
comment|/* remove (clear) status line*/
comment|/* and restore current labels*/
name|svsp
operator|->
name|hp_state
operator|=
name|SHP_INIT
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
name|fkl_on
argument_list|(
name|svsp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'R'
case|:
comment|/* enable usr/menu keys */
comment|/* and fkey label modes */
name|svsp
operator|->
name|hp_state
operator|=
name|SHP_INIT
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
case|case
literal|'S'
case|:
comment|/* disable usr/menu keys */
comment|/* and fkey label modes */
name|svsp
operator|->
name|hp_state
operator|=
name|SHP_INIT
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
case|case
literal|'0'
case|:
case|case
literal|'1'
case|:
case|case
literal|'2'
case|:
case|case
literal|'3'
case|:
case|case
literal|'4'
case|:
case|case
literal|'5'
case|:
case|case
literal|'6'
case|:
case|case
literal|'7'
case|:
case|case
literal|'8'
case|:
case|case
literal|'9'
case|:
comment|/* parameters for esc& j xx L mm */
name|svsp
operator|->
name|m_len
operator|*=
literal|10
expr_stmt|;
name|svsp
operator|->
name|m_len
operator|+=
operator|(
name|ch
operator|-
literal|'0'
operator|)
expr_stmt|;
break|break;
case|case
literal|'L'
case|:
name|svsp
operator|->
name|hp_state
operator|=
name|SHP_AND_JL
expr_stmt|;
name|svsp
operator|->
name|i
operator|=
literal|0
expr_stmt|;
name|svsp
operator|->
name|transparent
operator|=
literal|1
expr_stmt|;
break|break;
default|default:
name|svsp
operator|->
name|hp_state
operator|=
name|SHP_INIT
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|SHP_AND_JL
case|:
name|svsp
operator|->
name|m_buf
index|[
name|svsp
operator|->
name|i
index|]
operator|=
name|ch
expr_stmt|;
if|if
condition|(
name|svsp
operator|->
name|i
operator|>=
name|svsp
operator|->
name|m_len
operator|-
literal|1
condition|)
block|{
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
name|svsp
operator|->
name|hp_state
operator|=
name|SHP_INIT
expr_stmt|;
name|svsp
operator|->
name|transparent
operator|=
literal|0
expr_stmt|;
name|svsp
operator|->
name|i
operator|=
literal|0
expr_stmt|;
name|svsp
operator|->
name|m_buf
index|[
name|svsp
operator|->
name|m_len
index|]
operator|=
literal|'\0'
expr_stmt|;
comment|/* display status line */
comment|/* needs to be implemented */
comment|/* see 2392 man, 3-14 */
block|}
else|else
name|svsp
operator|->
name|i
operator|++
expr_stmt|;
break|break;
case|case
name|SHP_AND_ETE
case|:
comment|/* eat chars until uppercase */
if|if
condition|(
name|ch
operator|>=
literal|'@'
operator|&&
name|ch
operator|<=
literal|'Z'
condition|)
block|{
name|svsp
operator|->
name|hp_state
operator|=
name|SHP_INIT
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
name|svsp
operator|->
name|transparent
operator|=
literal|0
expr_stmt|;
block|}
break|break;
default|default:
name|svsp
operator|->
name|hp_state
operator|=
name|SHP_INIT
expr_stmt|;
name|svsp
operator|->
name|state
operator|=
name|STATE_INIT
expr_stmt|;
name|svsp
operator|->
name|transparent
operator|=
literal|0
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/* ------------------------- E O F ------------------------------------------*/
end_comment

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2004 Philip Paeps<philip@FreeBSD.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*  * Driver for extra ACPI-controlled gadgets (hotkeys, leds, etc) found on  * recent Asus (and Medion) laptops.  Inspired by the Acpi4Asus project which  * implements these features in the Linux kernel.  *  *<http://sourceforge.net/projects/acpi4asus/>  *  * Currently should support most features, but could use some more testing.  * Particularly the display-switching stuff is a bit hairy.  If you have an  * Asus laptop which doesn't appear to be supported, or strange things happen  * when using this driver, please report to<acpi@FreeBSD.org>.  *  */
end_comment

begin_include
include|#
directive|include
file|"opt_acpi.h"
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/sbuf.h>
end_include

begin_include
include|#
directive|include
file|"acpi.h"
end_include

begin_include
include|#
directive|include
file|<dev/acpica/acpivar.h>
end_include

begin_include
include|#
directive|include
file|<dev/led/led.h>
end_include

begin_define
define|#
directive|define
name|_COMPONENT
value|ACPI_ASUS
end_define

begin_macro
name|ACPI_MODULE_NAME
argument_list|(
literal|"ASUS"
argument_list|)
end_macro

begin_struct
struct|struct
name|acpi_asus_model
block|{
name|char
modifier|*
name|name
decl_stmt|;
name|char
modifier|*
name|mled_set
decl_stmt|;
name|char
modifier|*
name|tled_set
decl_stmt|;
name|char
modifier|*
name|wled_set
decl_stmt|;
name|char
modifier|*
name|brn_get
decl_stmt|;
name|char
modifier|*
name|brn_set
decl_stmt|;
name|char
modifier|*
name|brn_up
decl_stmt|;
name|char
modifier|*
name|brn_dn
decl_stmt|;
name|char
modifier|*
name|lcd_get
decl_stmt|;
name|char
modifier|*
name|lcd_set
decl_stmt|;
name|char
modifier|*
name|disp_get
decl_stmt|;
name|char
modifier|*
name|disp_set
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|acpi_asus_softc
block|{
name|device_t
name|dev
decl_stmt|;
name|ACPI_HANDLE
name|handle
decl_stmt|;
name|struct
name|acpi_asus_model
modifier|*
name|model
decl_stmt|;
name|struct
name|sysctl_ctx_list
name|sysctl_ctx
decl_stmt|;
name|struct
name|sysctl_oid
modifier|*
name|sysctl_tree
decl_stmt|;
name|dev_t
name|s_mled
decl_stmt|;
name|dev_t
name|s_tled
decl_stmt|;
name|dev_t
name|s_wled
decl_stmt|;
name|int
name|s_brn
decl_stmt|;
name|int
name|s_disp
decl_stmt|;
name|int
name|s_lcd
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* Models we know about */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|acpi_asus_model
name|acpi_asus_models
index|[]
init|=
block|{
block|{
operator|.
name|name
operator|=
literal|"L2D"
block|,
operator|.
name|mled_set
operator|=
literal|"MLED"
block|,
operator|.
name|wled_set
operator|=
literal|"WLED"
block|,
operator|.
name|brn_up
operator|=
literal|"\\Q0E"
block|,
operator|.
name|brn_dn
operator|=
literal|"\\Q0F"
block|,
operator|.
name|lcd_get
operator|=
literal|"\\SGP0"
block|,
operator|.
name|lcd_set
operator|=
literal|"\\Q10"
block|}
block|,
block|{
operator|.
name|name
operator|=
literal|"L3C"
block|,
operator|.
name|mled_set
operator|=
literal|"MLED"
block|,
operator|.
name|wled_set
operator|=
literal|"WLED"
block|,
operator|.
name|brn_get
operator|=
literal|"GPLV"
block|,
operator|.
name|brn_set
operator|=
literal|"SPLV"
block|,
operator|.
name|lcd_get
operator|=
literal|"\\GL32"
block|,
operator|.
name|lcd_set
operator|=
literal|"\\_SB.PCI0.PX40.ECD0._Q10"
block|}
block|,
block|{
operator|.
name|name
operator|=
literal|"L3D"
block|,
operator|.
name|mled_set
operator|=
literal|"MLED"
block|,
operator|.
name|wled_set
operator|=
literal|"WLED"
block|,
operator|.
name|brn_get
operator|=
literal|"GPLV"
block|,
operator|.
name|brn_set
operator|=
literal|"SPLV"
block|,
operator|.
name|lcd_get
operator|=
literal|"\\BKLG"
block|,
operator|.
name|lcd_set
operator|=
literal|"\\Q10"
block|}
block|,
block|{
operator|.
name|name
operator|=
literal|"L3H"
block|,
operator|.
name|mled_set
operator|=
literal|"MLED"
block|,
operator|.
name|wled_set
operator|=
literal|"WLED"
block|,
operator|.
name|brn_get
operator|=
literal|"GPLV"
block|,
operator|.
name|brn_set
operator|=
literal|"SPLV"
block|,
operator|.
name|lcd_get
operator|=
literal|"\\_SB.PCI0.PM.PBC"
block|,
operator|.
name|lcd_set
operator|=
literal|"EHK"
block|,
operator|.
name|disp_get
operator|=
literal|"\\_SB.INFB"
block|,
operator|.
name|disp_set
operator|=
literal|"SDSP"
block|}
block|,
block|{
operator|.
name|name
operator|=
literal|"L8L"
comment|/* Only has hotkeys, apparantly */
block|}
block|,
block|{
operator|.
name|name
operator|=
literal|"M1A"
block|,
operator|.
name|mled_set
operator|=
literal|"MLED"
block|,
operator|.
name|brn_up
operator|=
literal|"\\_SB.PCI0.PX40.EC0.Q0E"
block|,
operator|.
name|brn_dn
operator|=
literal|"\\_SB.PCI0.PX40.EC0.Q0F"
block|,
operator|.
name|lcd_get
operator|=
literal|"\\PNOF"
block|,
operator|.
name|lcd_set
operator|=
literal|"\\_SB.PCI0.PX40.EC0.Q10"
block|}
block|,
block|{
operator|.
name|name
operator|=
literal|"M2E"
block|,
operator|.
name|mled_set
operator|=
literal|"MLED"
block|,
operator|.
name|wled_set
operator|=
literal|"WLED"
block|,
operator|.
name|brn_get
operator|=
literal|"GPLV"
block|,
operator|.
name|brn_set
operator|=
literal|"SPLV"
block|,
operator|.
name|lcd_get
operator|=
literal|"\\GP06"
block|,
operator|.
name|lcd_set
operator|=
literal|"\\Q10"
block|}
block|,
block|{
operator|.
name|name
operator|=
literal|"P30"
block|,
operator|.
name|wled_set
operator|=
literal|"WLED"
block|,
operator|.
name|brn_up
operator|=
literal|"\\_SB.PCI0.LPCB.EC0._Q68"
block|,
operator|.
name|brn_dn
operator|=
literal|"\\_SB.PCI0.LPCB.EC0._Q69"
block|,
operator|.
name|lcd_get
operator|=
literal|"\\BKLT"
block|,
operator|.
name|lcd_set
operator|=
literal|"\\_SB.PCI0.LPCB.EC0._Q0E"
block|}
block|,
block|{
operator|.
name|name
operator|=
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Function prototypes */
end_comment

begin_function_decl
specifier|static
name|int
name|acpi_asus_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|acpi_asus_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|acpi_asus_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_asus_mled
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|state
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_asus_tled
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|state
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_asus_wled
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|state
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|acpi_asus_sysctl_brn
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|acpi_asus_sysctl_lcd
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|acpi_asus_sysctl_disp
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_asus_notify
parameter_list|(
name|ACPI_HANDLE
name|h
parameter_list|,
name|UINT32
name|notify
parameter_list|,
name|void
modifier|*
name|context
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|device_method_t
name|acpi_asus_methods
index|[]
init|=
block|{
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|acpi_asus_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|acpi_asus_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|acpi_asus_detach
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|acpi_asus_driver
init|=
block|{
literal|"acpi_asus"
block|,
name|acpi_asus_methods
block|,
expr|sizeof
operator|(
expr|struct
name|acpi_asus_softc
operator|)
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|acpi_asus_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|acpi_asus
argument_list|,
name|acpi
argument_list|,
name|acpi_asus_driver
argument_list|,
name|acpi_asus_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|acpi_asus
argument_list|,
name|acpi
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|int
name|acpi_asus_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|acpi_asus_model
modifier|*
name|model
decl_stmt|;
name|struct
name|acpi_asus_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|sbuf
modifier|*
name|sb
decl_stmt|;
name|ACPI_BUFFER
name|Buf
decl_stmt|;
name|ACPI_OBJECT
name|Arg
decl_stmt|,
modifier|*
name|Obj
decl_stmt|;
name|ACPI_OBJECT_LIST
name|Args
decl_stmt|;
name|ACPI_FUNCTION_TRACE
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|acpi_disabled
argument_list|(
literal|"asus"
argument_list|)
operator|&&
name|acpi_get_type
argument_list|(
name|dev
argument_list|)
operator|==
name|ACPI_TYPE_DEVICE
operator|&&
name|acpi_MatchHid
argument_list|(
name|dev
argument_list|,
literal|"ATK0100"
argument_list|)
condition|)
block|{
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sc
operator|->
name|dev
operator|=
name|dev
expr_stmt|;
name|sc
operator|->
name|handle
operator|=
name|acpi_get_handle
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sb
operator|=
name|sbuf_new
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|SBUF_AUTOEXTEND
argument_list|)
expr_stmt|;
if|if
condition|(
name|sb
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
name|Arg
operator|.
name|Type
operator|=
name|ACPI_TYPE_INTEGER
expr_stmt|;
name|Arg
operator|.
name|Integer
operator|.
name|Value
operator|=
literal|0
expr_stmt|;
name|Args
operator|.
name|Count
operator|=
literal|1
expr_stmt|;
name|Args
operator|.
name|Pointer
operator|=
operator|&
name|Arg
expr_stmt|;
name|Buf
operator|.
name|Pointer
operator|=
name|NULL
expr_stmt|;
name|Buf
operator|.
name|Length
operator|=
name|ACPI_ALLOCATE_BUFFER
expr_stmt|;
name|AcpiEvaluateObject
argument_list|(
name|sc
operator|->
name|handle
argument_list|,
literal|"INIT"
argument_list|,
operator|&
name|Args
argument_list|,
operator|&
name|Buf
argument_list|)
expr_stmt|;
name|Obj
operator|=
name|Buf
operator|.
name|Pointer
expr_stmt|;
for|for
control|(
name|model
operator|=
name|acpi_asus_models
init|;
name|model
operator|->
name|name
operator|!=
name|NULL
condition|;
name|model
operator|++
control|)
if|if
condition|(
name|strcmp
argument_list|(
name|Obj
operator|->
name|String
operator|.
name|Pointer
argument_list|,
name|model
operator|->
name|name
argument_list|)
operator|==
literal|0
condition|)
block|{
name|sbuf_printf
argument_list|(
name|sb
argument_list|,
literal|"Asus %s Laptop Extras"
argument_list|,
name|Obj
operator|->
name|String
operator|.
name|Pointer
argument_list|)
expr_stmt|;
name|sbuf_finish
argument_list|(
name|sb
argument_list|)
expr_stmt|;
name|sc
operator|->
name|model
operator|=
name|model
expr_stmt|;
name|device_set_desc
argument_list|(
name|dev
argument_list|,
name|sbuf_data
argument_list|(
name|sb
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_delete
argument_list|(
name|sb
argument_list|)
expr_stmt|;
name|AcpiOsFree
argument_list|(
name|Buf
operator|.
name|Pointer
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|sbuf_printf
argument_list|(
name|sb
argument_list|,
literal|"Unsupported Asus laptop detected: %s\n"
argument_list|,
name|Obj
operator|->
name|String
operator|.
name|Pointer
argument_list|)
expr_stmt|;
name|sbuf_finish
argument_list|(
name|sb
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
name|sbuf_data
argument_list|(
name|sb
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_delete
argument_list|(
name|sb
argument_list|)
expr_stmt|;
name|AcpiOsFree
argument_list|(
name|Buf
operator|.
name|Pointer
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|acpi_asus_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|acpi_asus_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|acpi_softc
modifier|*
name|acpi_sc
decl_stmt|;
name|ACPI_FUNCTION_TRACE
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|__func__
argument_list|)
expr_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|acpi_sc
operator|=
name|acpi_device_get_parent_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* Build sysctl tree */
name|sysctl_ctx_init
argument_list|(
operator|&
name|sc
operator|->
name|sysctl_ctx
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sysctl_tree
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
operator|&
name|sc
operator|->
name|sysctl_ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|acpi_sc
operator|->
name|acpi_sysctl_tree
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"asus"
argument_list|,
name|CTLFLAG_RD
argument_list|,
literal|0
argument_list|,
literal|""
argument_list|)
expr_stmt|;
comment|/* Attach leds */
if|if
condition|(
name|sc
operator|->
name|model
operator|->
name|mled_set
condition|)
name|sc
operator|->
name|s_mled
operator|=
name|led_create
argument_list|(
operator|(
name|led_t
operator|*
operator|)
name|acpi_asus_mled
argument_list|,
name|dev
argument_list|,
literal|"mled"
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|model
operator|->
name|tled_set
condition|)
name|sc
operator|->
name|s_tled
operator|=
name|led_create
argument_list|(
operator|(
name|led_t
operator|*
operator|)
name|acpi_asus_tled
argument_list|,
name|dev
argument_list|,
literal|"tled"
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|model
operator|->
name|wled_set
condition|)
name|sc
operator|->
name|s_wled
operator|=
name|led_create
argument_list|(
operator|(
name|led_t
operator|*
operator|)
name|acpi_asus_wled
argument_list|,
name|dev
argument_list|,
literal|"wled"
argument_list|)
expr_stmt|;
comment|/* Attach brightness for GPLV/SPLV models */
if|if
condition|(
name|sc
operator|->
name|model
operator|->
name|brn_get
operator|&&
name|ACPI_SUCCESS
argument_list|(
name|acpi_GetInteger
argument_list|(
name|sc
operator|->
name|handle
argument_list|,
name|sc
operator|->
name|model
operator|->
name|brn_get
argument_list|,
operator|&
name|sc
operator|->
name|s_brn
argument_list|)
argument_list|)
condition|)
name|SYSCTL_ADD_PROC
argument_list|(
operator|&
name|sc
operator|->
name|sysctl_ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|sc
operator|->
name|sysctl_tree
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"lcd_brightness"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RW
argument_list|,
name|sc
argument_list|,
literal|0
argument_list|,
name|acpi_asus_sysctl_brn
argument_list|,
literal|"I"
argument_list|,
literal|"brightness of the lcd panel"
argument_list|)
expr_stmt|;
comment|/* Attach brightness for other models */
if|if
condition|(
name|sc
operator|->
name|model
operator|->
name|brn_up
operator|&&
name|ACPI_SUCCESS
argument_list|(
name|AcpiEvaluateObject
argument_list|(
name|sc
operator|->
name|handle
argument_list|,
name|sc
operator|->
name|model
operator|->
name|brn_up
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
argument_list|)
operator|&&
name|ACPI_SUCCESS
argument_list|(
name|AcpiEvaluateObject
argument_list|(
name|sc
operator|->
name|handle
argument_list|,
name|sc
operator|->
name|model
operator|->
name|brn_dn
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
argument_list|)
condition|)
name|SYSCTL_ADD_PROC
argument_list|(
operator|&
name|sc
operator|->
name|sysctl_ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|sc
operator|->
name|sysctl_tree
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"lcd_brightness"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RW
argument_list|,
name|sc
argument_list|,
literal|0
argument_list|,
name|acpi_asus_sysctl_brn
argument_list|,
literal|"I"
argument_list|,
literal|"brightness of the lcd panel"
argument_list|)
expr_stmt|;
comment|/* Attach display switching */
if|if
condition|(
name|sc
operator|->
name|model
operator|->
name|disp_get
operator|&&
name|ACPI_SUCCESS
argument_list|(
name|acpi_GetInteger
argument_list|(
name|sc
operator|->
name|handle
argument_list|,
name|sc
operator|->
name|model
operator|->
name|disp_get
argument_list|,
operator|&
name|sc
operator|->
name|s_disp
argument_list|)
argument_list|)
condition|)
name|SYSCTL_ADD_PROC
argument_list|(
operator|&
name|sc
operator|->
name|sysctl_ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|sc
operator|->
name|sysctl_tree
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"video_output"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RW
argument_list|,
name|sc
argument_list|,
literal|0
argument_list|,
name|acpi_asus_sysctl_disp
argument_list|,
literal|"I"
argument_list|,
literal|"display output state"
argument_list|)
expr_stmt|;
comment|/* Attach LCD state, easy for most models... */
if|if
condition|(
name|sc
operator|->
name|model
operator|->
name|lcd_get
operator|&&
name|strncmp
argument_list|(
name|sc
operator|->
name|model
operator|->
name|name
argument_list|,
literal|"L3H"
argument_list|,
literal|3
argument_list|)
operator|!=
literal|0
operator|&&
name|ACPI_SUCCESS
argument_list|(
name|acpi_GetInteger
argument_list|(
name|sc
operator|->
name|handle
argument_list|,
name|sc
operator|->
name|model
operator|->
name|lcd_get
argument_list|,
operator|&
name|sc
operator|->
name|s_lcd
argument_list|)
argument_list|)
condition|)
name|SYSCTL_ADD_PROC
argument_list|(
operator|&
name|sc
operator|->
name|sysctl_ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|sc
operator|->
name|sysctl_tree
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"lcd_backlight"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RW
argument_list|,
name|sc
argument_list|,
literal|0
argument_list|,
name|acpi_asus_sysctl_lcd
argument_list|,
literal|"I"
argument_list|,
literal|"state of the lcd backlight"
argument_list|)
expr_stmt|;
comment|/* ...a nightmare for the L3H */
elseif|else
if|if
condition|(
name|sc
operator|->
name|model
operator|->
name|lcd_get
condition|)
block|{
name|ACPI_BUFFER
name|Buf
decl_stmt|;
name|ACPI_OBJECT
name|Arg
index|[
literal|2
index|]
decl_stmt|,
name|Obj
decl_stmt|;
name|ACPI_OBJECT_LIST
name|Args
decl_stmt|;
name|Arg
index|[
literal|0
index|]
operator|.
name|Type
operator|=
name|ACPI_TYPE_INTEGER
expr_stmt|;
name|Arg
index|[
literal|0
index|]
operator|.
name|Integer
operator|.
name|Value
operator|=
literal|0x02
expr_stmt|;
name|Arg
index|[
literal|1
index|]
operator|.
name|Type
operator|=
name|ACPI_TYPE_INTEGER
expr_stmt|;
name|Arg
index|[
literal|1
index|]
operator|.
name|Integer
operator|.
name|Value
operator|=
literal|0x03
expr_stmt|;
name|Args
operator|.
name|Count
operator|=
literal|2
expr_stmt|;
name|Args
operator|.
name|Pointer
operator|=
name|Arg
expr_stmt|;
name|Buf
operator|.
name|Length
operator|=
sizeof|sizeof
argument_list|(
name|Obj
argument_list|)
expr_stmt|;
name|Buf
operator|.
name|Pointer
operator|=
operator|&
name|Obj
expr_stmt|;
if|if
condition|(
name|ACPI_SUCCESS
argument_list|(
name|AcpiEvaluateObject
argument_list|(
name|sc
operator|->
name|handle
argument_list|,
name|sc
operator|->
name|model
operator|->
name|lcd_get
argument_list|,
operator|&
name|Args
argument_list|,
operator|&
name|Buf
argument_list|)
argument_list|)
operator|&&
name|Obj
operator|.
name|Type
operator|==
name|ACPI_TYPE_INTEGER
condition|)
block|{
name|sc
operator|->
name|s_lcd
operator|=
name|Obj
operator|.
name|Integer
operator|.
name|Value
operator|>>
literal|8
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
operator|&
name|sc
operator|->
name|sysctl_ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|sc
operator|->
name|sysctl_tree
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"lcd_backlight"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RW
argument_list|,
name|sc
argument_list|,
literal|0
argument_list|,
name|acpi_asus_sysctl_lcd
argument_list|,
literal|"I"
argument_list|,
literal|"state of the lcd backlight"
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Activate hotkeys */
name|AcpiEvaluateObject
argument_list|(
name|sc
operator|->
name|handle
argument_list|,
literal|"BSTS"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* Handle notifies */
name|AcpiInstallNotifyHandler
argument_list|(
name|sc
operator|->
name|handle
argument_list|,
name|ACPI_SYSTEM_NOTIFY
argument_list|,
name|acpi_asus_notify
argument_list|,
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|acpi_asus_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|acpi_asus_softc
modifier|*
name|sc
decl_stmt|;
name|ACPI_FUNCTION_TRACE
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|__func__
argument_list|)
expr_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* Turn the lights off */
if|if
condition|(
name|sc
operator|->
name|model
operator|->
name|mled_set
condition|)
name|led_destroy
argument_list|(
name|sc
operator|->
name|s_mled
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|model
operator|->
name|tled_set
condition|)
name|led_destroy
argument_list|(
name|sc
operator|->
name|s_tled
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|model
operator|->
name|wled_set
condition|)
name|led_destroy
argument_list|(
name|sc
operator|->
name|s_wled
argument_list|)
expr_stmt|;
comment|/* Remove notify handler */
name|AcpiRemoveNotifyHandler
argument_list|(
name|sc
operator|->
name|handle
argument_list|,
name|ACPI_SYSTEM_NOTIFY
argument_list|,
name|acpi_asus_notify
argument_list|)
expr_stmt|;
comment|/* Free sysctl tree */
name|sysctl_ctx_free
argument_list|(
operator|&
name|sc
operator|->
name|sysctl_ctx
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_asus_mled
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|state
parameter_list|)
block|{
name|struct
name|acpi_asus_softc
modifier|*
name|sc
decl_stmt|;
name|ACPI_OBJECT
name|Arg
decl_stmt|;
name|ACPI_OBJECT_LIST
name|Args
decl_stmt|;
name|ACPI_FUNCTION_TRACE
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|__func__
argument_list|)
expr_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|Arg
operator|.
name|Type
operator|=
name|ACPI_TYPE_INTEGER
expr_stmt|;
name|Arg
operator|.
name|Integer
operator|.
name|Value
operator|=
operator|!
name|state
expr_stmt|;
comment|/* Inverted, yes! */
name|Args
operator|.
name|Count
operator|=
literal|1
expr_stmt|;
name|Args
operator|.
name|Pointer
operator|=
operator|&
name|Arg
expr_stmt|;
name|AcpiEvaluateObject
argument_list|(
name|sc
operator|->
name|handle
argument_list|,
name|sc
operator|->
name|model
operator|->
name|mled_set
argument_list|,
operator|&
name|Args
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_asus_tled
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|state
parameter_list|)
block|{
name|struct
name|acpi_asus_softc
modifier|*
name|sc
decl_stmt|;
name|ACPI_OBJECT
name|Arg
decl_stmt|;
name|ACPI_OBJECT_LIST
name|Args
decl_stmt|;
name|ACPI_FUNCTION_TRACE
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|__func__
argument_list|)
expr_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|Arg
operator|.
name|Type
operator|=
name|ACPI_TYPE_INTEGER
expr_stmt|;
name|Arg
operator|.
name|Integer
operator|.
name|Value
operator|=
name|state
expr_stmt|;
name|Args
operator|.
name|Count
operator|=
literal|1
expr_stmt|;
name|Args
operator|.
name|Pointer
operator|=
operator|&
name|Arg
expr_stmt|;
name|AcpiEvaluateObject
argument_list|(
name|sc
operator|->
name|handle
argument_list|,
name|sc
operator|->
name|model
operator|->
name|tled_set
argument_list|,
operator|&
name|Args
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_asus_wled
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|state
parameter_list|)
block|{
name|struct
name|acpi_asus_softc
modifier|*
name|sc
decl_stmt|;
name|ACPI_OBJECT
name|Arg
decl_stmt|;
name|ACPI_OBJECT_LIST
name|Args
decl_stmt|;
name|ACPI_FUNCTION_TRACE
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|__func__
argument_list|)
expr_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|Arg
operator|.
name|Type
operator|=
name|ACPI_TYPE_INTEGER
expr_stmt|;
name|Arg
operator|.
name|Integer
operator|.
name|Value
operator|=
name|state
expr_stmt|;
name|Args
operator|.
name|Count
operator|=
literal|1
expr_stmt|;
name|Args
operator|.
name|Pointer
operator|=
operator|&
name|Arg
expr_stmt|;
name|AcpiEvaluateObject
argument_list|(
name|sc
operator|->
name|handle
argument_list|,
name|sc
operator|->
name|model
operator|->
name|wled_set
argument_list|,
operator|&
name|Args
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|acpi_asus_sysctl_brn
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|struct
name|acpi_asus_softc
modifier|*
name|sc
decl_stmt|;
name|ACPI_OBJECT
name|Arg
decl_stmt|;
name|ACPI_OBJECT_LIST
name|Args
decl_stmt|;
name|int
name|brn
decl_stmt|,
name|err
decl_stmt|;
name|ACPI_FUNCTION_TRACE
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|__func__
argument_list|)
expr_stmt|;
name|sc
operator|=
operator|(
expr|struct
name|acpi_asus_softc
operator|*
operator|)
name|oidp
operator|->
name|oid_arg1
expr_stmt|;
comment|/* Sanity check */
name|brn
operator|=
name|sc
operator|->
name|s_brn
expr_stmt|;
name|err
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|brn
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|!=
literal|0
operator|)
operator|||
operator|(
name|req
operator|->
name|newptr
operator|==
name|NULL
operator|)
condition|)
return|return
operator|(
name|err
operator|)
return|;
if|if
condition|(
operator|(
name|brn
operator|<
literal|0
operator|)
operator|||
operator|(
name|brn
operator|>
literal|15
operator|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
comment|/* Keep track and update */
name|sc
operator|->
name|s_brn
operator|=
name|brn
expr_stmt|;
name|Arg
operator|.
name|Type
operator|=
name|ACPI_TYPE_INTEGER
expr_stmt|;
name|Arg
operator|.
name|Integer
operator|.
name|Value
operator|=
name|brn
expr_stmt|;
name|Args
operator|.
name|Count
operator|=
literal|1
expr_stmt|;
name|Args
operator|.
name|Pointer
operator|=
operator|&
name|Arg
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|model
operator|->
name|brn_set
condition|)
name|AcpiEvaluateObject
argument_list|(
name|sc
operator|->
name|handle
argument_list|,
name|sc
operator|->
name|model
operator|->
name|brn_set
argument_list|,
operator|&
name|Args
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
else|else
block|{
name|brn
operator|-=
name|sc
operator|->
name|s_brn
expr_stmt|;
while|while
condition|(
name|brn
operator|!=
literal|0
condition|)
block|{
name|AcpiEvaluateObject
argument_list|(
name|sc
operator|->
name|handle
argument_list|,
operator|(
name|brn
operator|>
literal|0
operator|)
condition|?
name|sc
operator|->
name|model
operator|->
name|brn_up
else|:
name|sc
operator|->
name|model
operator|->
name|brn_dn
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
operator|(
name|brn
operator|>
literal|0
operator|)
condition|?
name|brn
operator|--
else|:
name|brn
operator|++
expr_stmt|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|acpi_asus_sysctl_lcd
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|struct
name|acpi_asus_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|lcd
decl_stmt|,
name|err
decl_stmt|;
name|ACPI_FUNCTION_TRACE
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|__func__
argument_list|)
expr_stmt|;
name|sc
operator|=
operator|(
expr|struct
name|acpi_asus_softc
operator|*
operator|)
name|oidp
operator|->
name|oid_arg1
expr_stmt|;
comment|/* Sanity check */
name|lcd
operator|=
name|sc
operator|->
name|s_lcd
expr_stmt|;
name|err
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|lcd
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|!=
literal|0
operator|)
operator|||
operator|(
name|req
operator|->
name|newptr
operator|==
name|NULL
operator|)
condition|)
return|return
operator|(
name|err
operator|)
return|;
if|if
condition|(
operator|(
name|lcd
operator|<
literal|0
operator|)
operator|||
operator|(
name|lcd
operator|>
literal|1
operator|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
comment|/* Keep track and update */
name|sc
operator|->
name|s_lcd
operator|=
name|lcd
expr_stmt|;
comment|/* Most models just need a lcd_set evaluated, the L3H is trickier */
if|if
condition|(
name|strncmp
argument_list|(
name|sc
operator|->
name|model
operator|->
name|name
argument_list|,
literal|"L3H"
argument_list|,
literal|3
argument_list|)
operator|!=
literal|0
condition|)
name|AcpiEvaluateObject
argument_list|(
name|sc
operator|->
name|handle
argument_list|,
name|sc
operator|->
name|model
operator|->
name|lcd_set
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
else|else
block|{
name|ACPI_OBJECT
name|Arg
decl_stmt|;
name|ACPI_OBJECT_LIST
name|Args
decl_stmt|;
name|Arg
operator|.
name|Type
operator|=
name|ACPI_TYPE_INTEGER
expr_stmt|;
name|Arg
operator|.
name|Integer
operator|.
name|Value
operator|=
literal|0x07
expr_stmt|;
name|Args
operator|.
name|Count
operator|=
literal|1
expr_stmt|;
name|Args
operator|.
name|Pointer
operator|=
operator|&
name|Arg
expr_stmt|;
name|AcpiEvaluateObject
argument_list|(
name|sc
operator|->
name|handle
argument_list|,
name|sc
operator|->
name|model
operator|->
name|lcd_set
argument_list|,
operator|&
name|Args
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|acpi_asus_sysctl_disp
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|struct
name|acpi_asus_softc
modifier|*
name|sc
decl_stmt|;
name|ACPI_OBJECT
name|Arg
decl_stmt|;
name|ACPI_OBJECT_LIST
name|Args
decl_stmt|;
name|int
name|disp
decl_stmt|,
name|err
decl_stmt|;
name|ACPI_FUNCTION_TRACE
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|__func__
argument_list|)
expr_stmt|;
name|sc
operator|=
operator|(
expr|struct
name|acpi_asus_softc
operator|*
operator|)
name|oidp
operator|->
name|oid_arg1
expr_stmt|;
comment|/* Sanity check */
name|disp
operator|=
name|sc
operator|->
name|s_disp
expr_stmt|;
name|err
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|disp
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|!=
literal|0
operator|)
operator|||
operator|(
name|req
operator|->
name|newptr
operator|==
name|NULL
operator|)
condition|)
return|return
operator|(
name|err
operator|)
return|;
if|if
condition|(
operator|(
name|disp
operator|<
literal|0
operator|)
operator|||
operator|(
name|disp
operator|>
literal|7
operator|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
comment|/* Keep track and update */
name|sc
operator|->
name|s_disp
operator|=
name|disp
expr_stmt|;
name|Arg
operator|.
name|Type
operator|=
name|ACPI_TYPE_INTEGER
expr_stmt|;
name|Arg
operator|.
name|Integer
operator|.
name|Value
operator|=
name|disp
expr_stmt|;
name|Args
operator|.
name|Count
operator|=
literal|1
expr_stmt|;
name|Args
operator|.
name|Pointer
operator|=
operator|&
name|Arg
expr_stmt|;
name|AcpiEvaluateObject
argument_list|(
name|sc
operator|->
name|handle
argument_list|,
name|sc
operator|->
name|model
operator|->
name|disp_set
argument_list|,
operator|&
name|Args
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_asus_notify
parameter_list|(
name|ACPI_HANDLE
name|h
parameter_list|,
name|UINT32
name|notify
parameter_list|,
name|void
modifier|*
name|context
parameter_list|)
block|{
name|struct
name|acpi_asus_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|acpi_softc
modifier|*
name|acpi_sc
decl_stmt|;
name|ACPI_FUNCTION_TRACE
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|__func__
argument_list|)
expr_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
operator|(
name|device_t
operator|)
name|context
argument_list|)
expr_stmt|;
name|acpi_sc
operator|=
name|acpi_device_get_parent_softc
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|notify
operator|&
operator|~
literal|0x10
operator|)
operator|<=
literal|15
condition|)
block|{
name|sc
operator|->
name|s_brn
operator|=
operator|(
name|notify
operator|&
operator|~
literal|0x10
operator|)
expr_stmt|;
name|ACPI_VPRINT
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|acpi_sc
argument_list|,
literal|"Brightness increased\n"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|notify
operator|&
operator|~
literal|0x20
operator|)
operator|<=
literal|15
condition|)
block|{
name|sc
operator|->
name|s_brn
operator|=
operator|(
name|notify
operator|&
operator|~
literal|0x20
operator|)
expr_stmt|;
name|ACPI_VPRINT
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|acpi_sc
argument_list|,
literal|"Brightness decreased\n"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|notify
operator|==
literal|0x33
condition|)
block|{
name|sc
operator|->
name|s_lcd
operator|=
literal|1
expr_stmt|;
name|ACPI_VPRINT
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|acpi_sc
argument_list|,
literal|"LCD turned on\n"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|notify
operator|==
literal|0x34
condition|)
block|{
name|sc
operator|->
name|s_lcd
operator|=
literal|0
expr_stmt|;
name|ACPI_VPRINT
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|acpi_sc
argument_list|,
literal|"LCD turned off\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Notify devd(8) */
name|acpi_UserNotify
argument_list|(
literal|"ASUS"
argument_list|,
name|h
argument_list|,
name|notify
argument_list|)
expr_stmt|;
block|}
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2001 Takanori Watanabe<takawata@jp.freebsd.org>  * Copyright (c) 2001 Mitsuru IWASAKI<iwasaki@jp.freebsd.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm_param.h>
end_include

begin_include
include|#
directive|include
file|<vm/pmap.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm_object.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm_page.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm_map.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm_kern.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm_extern.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/cpufunc.h>
end_include

begin_include
include|#
directive|include
file|<machine/segments.h>
end_include

begin_include
include|#
directive|include
file|<i386/isa/intr_machdep.h>
end_include

begin_include
include|#
directive|include
file|"acpi.h"
end_include

begin_include
include|#
directive|include
file|<dev/acpica/acpica_support.h>
end_include

begin_include
include|#
directive|include
file|<dev/acpica/acpivar.h>
end_include

begin_include
include|#
directive|include
file|"acpi_wakecode.h"
end_include

begin_if
if|#
directive|if
name|__FreeBSD_version
operator|<
literal|500000
end_if

begin_define
define|#
directive|define
name|vm_page_lock_queues
parameter_list|()
end_define

begin_define
define|#
directive|define
name|vm_page_unlock_queues
parameter_list|()
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|extern
name|void
name|initializecpu
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|struct
name|region_descriptor
name|r_idt
decl_stmt|,
name|r_gdt
decl_stmt|,
modifier|*
name|p_gdt
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|u_int16_t
name|r_ldt
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|u_int32_t
name|r_eax
decl_stmt|,
name|r_ebx
decl_stmt|,
name|r_ecx
decl_stmt|,
name|r_edx
decl_stmt|,
name|r_ebp
decl_stmt|,
name|r_esi
decl_stmt|,
name|r_edi
decl_stmt|,
name|r_efl
decl_stmt|,
name|r_cr0
decl_stmt|,
name|r_cr2
decl_stmt|,
name|r_cr3
decl_stmt|,
name|r_cr4
decl_stmt|,
name|ret_addr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|u_int16_t
name|r_cs
decl_stmt|,
name|r_ds
decl_stmt|,
name|r_es
decl_stmt|,
name|r_fs
decl_stmt|,
name|r_gs
decl_stmt|,
name|r_ss
decl_stmt|,
name|r_tr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|u_int32_t
name|r_esp
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|acpi_printcpu
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_realmodeinst
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|segs
parameter_list|,
name|int
name|nsegs
parameter_list|,
name|int
name|error
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_alloc_wakeup_handler
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* XXX shut gcc up */
end_comment

begin_function_decl
specifier|extern
name|int
name|acpi_savecpu
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|int
name|acpi_restorecpu
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|__GNUC__
end_ifdef

begin_asm
asm|__asm__("				\n\ 	.text				\n\ 	.p2align 2, 0x90		\n\ 	.type acpi_restorecpu, @function\n\ acpi_restorecpu:			\n\ 	.align 4			\n\ 	movl	r_eax,%eax		\n\ 	movl	r_ebx,%ebx		\n\ 	movl	r_ecx,%ecx		\n\ 	movl	r_edx,%edx		\n\ 	movl	r_ebp,%ebp		\n\ 	movl	r_esi,%esi		\n\ 	movl	r_edi,%edi		\n\ 	movl	r_esp,%esp		\n\ 					\n\ 	pushl	r_efl			\n\ 	popfl				\n\ 					\n\ 	movl	ret_addr,%eax		\n\ 	movl	%eax,(%esp)		\n\ 	xorl	%eax,%eax		\n\ 	ret				\n\ 					\n\ 	.text				\n\ 	.p2align 2, 0x90		\n\ 	.type acpi_savecpu, @function	\n\ acpi_savecpu:				\n\ 	movw	%cs,r_cs		\n\ 	movw	%ds,r_ds		\n\ 	movw	%es,r_es		\n\ 	movw	%fs,r_fs		\n\ 	movw	%gs,r_gs		\n\ 	movw	%ss,r_ss		\n\ 					\n\ 	movl	%eax,r_eax		\n\ 	movl	%ebx,r_ebx		\n\ 	movl	%ecx,r_ecx		\n\ 	movl	%edx,r_edx		\n\ 	movl	%ebp,r_ebp		\n\ 	movl	%esi,r_esi		\n\ 	movl	%edi,r_edi		\n\ 					\n\ 	movl	%cr0,%eax		\n\ 	movl	%eax,r_cr0		\n\ 	movl	%cr2,%eax		\n\ 	movl	%eax,r_cr2		\n\ 	movl	%cr3,%eax		\n\ 	movl	%eax,r_cr3		\n\ 	movl	%cr4,%eax		\n\ 	movl	%eax,r_cr4		\n\ 					\n\ 	pushfl				\n\ 	popl	r_efl			\n\ 					\n\ 	movl	%esp,r_esp		\n\ 					\n\ 	sgdt	r_gdt			\n\ 	sidt	r_idt			\n\ 	sldt	r_ldt			\n\ 	str	r_tr			\n\ 					\n\ 	movl	(%esp),%eax		\n\ 	movl	%eax,ret_addr		\n\ 	movl	$1,%eax			\n\ 	ret				\n\ ");
end_asm

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* __GNUC__ */
end_comment

begin_function
specifier|static
name|void
name|acpi_printcpu
parameter_list|(
name|void
parameter_list|)
block|{
name|printf
argument_list|(
literal|"======== acpi_printcpu() debug dump ========\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"gdt[%04x:%08x] idt[%04x:%08x] ldt[%04x] tr[%04x] efl[%08x]\n"
argument_list|,
name|r_gdt
operator|.
name|rd_limit
argument_list|,
name|r_gdt
operator|.
name|rd_base
argument_list|,
name|r_idt
operator|.
name|rd_limit
argument_list|,
name|r_idt
operator|.
name|rd_base
argument_list|,
name|r_ldt
argument_list|,
name|r_tr
argument_list|,
name|r_efl
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"eax[%08x] ebx[%08x] ecx[%08x] edx[%08x]\n"
argument_list|,
name|r_eax
argument_list|,
name|r_ebx
argument_list|,
name|r_ecx
argument_list|,
name|r_edx
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"esi[%08x] edi[%08x] ebp[%08x] esp[%08x]\n"
argument_list|,
name|r_esi
argument_list|,
name|r_edi
argument_list|,
name|r_ebp
argument_list|,
name|r_esp
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"cr0[%08x] cr2[%08x] cr3[%08x] cr4[%08x]\n"
argument_list|,
name|r_cr0
argument_list|,
name|r_cr2
argument_list|,
name|r_cr3
argument_list|,
name|r_cr4
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"cs[%04x] ds[%04x] es[%04x] fs[%04x] gs[%04x] ss[%04x]\n"
argument_list|,
name|r_cs
argument_list|,
name|r_ds
argument_list|,
name|r_es
argument_list|,
name|r_fs
argument_list|,
name|r_gs
argument_list|,
name|r_ss
argument_list|)
expr_stmt|;
block|}
end_function

begin_define
define|#
directive|define
name|WAKECODE_FIXUP
parameter_list|(
name|offset
parameter_list|,
name|type
parameter_list|,
name|val
parameter_list|)
value|do	{		\ 	void	**addr;						\ 	addr = (void **)(sc->acpi_wakeaddr + offset);		\ 	(type *)*addr = val;					\ } while (0)
end_define

begin_define
define|#
directive|define
name|WAKECODE_BCOPY
parameter_list|(
name|offset
parameter_list|,
name|type
parameter_list|,
name|val
parameter_list|)
value|do	{		\ 	void	**addr;						\ 	addr = (void **)(sc->acpi_wakeaddr + offset);		\ 	bcopy(&(val), addr, sizeof(type));			\ } while (0)
end_define

begin_function
name|int
name|acpi_sleep_machdep
parameter_list|(
name|struct
name|acpi_softc
modifier|*
name|sc
parameter_list|,
name|int
name|state
parameter_list|)
block|{
name|ACPI_STATUS
name|status
decl_stmt|;
name|vm_paddr_t
name|oldphys
decl_stmt|;
name|struct
name|pmap
modifier|*
name|pm
decl_stmt|;
name|vm_page_t
name|page
decl_stmt|;
specifier|static
name|vm_page_t
name|opage
init|=
name|NULL
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|int
name|pteobj_allocated
init|=
literal|0
decl_stmt|;
name|u_int32_t
name|cr3
decl_stmt|;
name|u_long
name|ef
decl_stmt|;
name|struct
name|proc
modifier|*
name|p
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|acpi_wakeaddr
operator|==
literal|0
condition|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|AcpiSetFirmwareWakingVector
argument_list|(
name|sc
operator|->
name|acpi_wakephys
argument_list|)
expr_stmt|;
name|ef
operator|=
name|read_eflags
argument_list|()
expr_stmt|;
name|disable_intr
argument_list|()
expr_stmt|;
comment|/* Create Identity Mapping */
if|if
condition|(
operator|(
name|p
operator|=
name|curproc
operator|)
operator|==
name|NULL
condition|)
name|p
operator|=
operator|&
name|proc0
expr_stmt|;
name|pm
operator|=
name|vmspace_pmap
argument_list|(
name|p
operator|->
name|p_vmspace
argument_list|)
expr_stmt|;
name|cr3
operator|=
name|rcr3
argument_list|()
expr_stmt|;
ifdef|#
directive|ifdef
name|PAE
name|load_cr3
argument_list|(
name|vtophys
argument_list|(
name|pm
operator|->
name|pm_pdpt
argument_list|)
argument_list|)
expr_stmt|;
else|#
directive|else
name|load_cr3
argument_list|(
name|vtophys
argument_list|(
name|pm
operator|->
name|pm_pdir
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|pm
operator|->
name|pm_pteobj
operator|==
name|NULL
condition|)
block|{
name|pm
operator|->
name|pm_pteobj
operator|=
name|vm_object_allocate
argument_list|(
name|OBJT_DEFAULT
argument_list|,
name|PTDPTDI
operator|+
literal|1
argument_list|)
expr_stmt|;
name|pteobj_allocated
operator|=
literal|1
expr_stmt|;
block|}
name|oldphys
operator|=
name|pmap_extract
argument_list|(
name|pm
argument_list|,
name|sc
operator|->
name|acpi_wakephys
argument_list|)
expr_stmt|;
if|if
condition|(
name|oldphys
condition|)
block|{
name|opage
operator|=
name|PHYS_TO_VM_PAGE
argument_list|(
name|oldphys
argument_list|)
expr_stmt|;
block|}
name|page
operator|=
name|PHYS_TO_VM_PAGE
argument_list|(
name|sc
operator|->
name|acpi_wakephys
argument_list|)
expr_stmt|;
name|pmap_enter
argument_list|(
name|pm
argument_list|,
name|sc
operator|->
name|acpi_wakephys
argument_list|,
name|page
argument_list|,
name|VM_PROT_READ
operator||
name|VM_PROT_WRITE
operator||
name|VM_PROT_EXECUTE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ret_addr
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|acpi_savecpu
argument_list|()
condition|)
block|{
comment|/* Execute Sleep */
name|p_gdt
operator|=
operator|(
expr|struct
name|region_descriptor
operator|*
operator|)
operator|(
name|sc
operator|->
name|acpi_wakeaddr
operator|+
name|physical_gdt
operator|)
expr_stmt|;
name|p_gdt
operator|->
name|rd_limit
operator|=
name|r_gdt
operator|.
name|rd_limit
expr_stmt|;
name|p_gdt
operator|->
name|rd_base
operator|=
name|vtophys
argument_list|(
name|r_gdt
operator|.
name|rd_base
argument_list|)
expr_stmt|;
name|WAKECODE_FIXUP
argument_list|(
name|physical_esp
argument_list|,
name|u_int32_t
argument_list|,
name|vtophys
argument_list|(
name|r_esp
argument_list|)
argument_list|)
expr_stmt|;
name|WAKECODE_FIXUP
argument_list|(
name|previous_cr0
argument_list|,
name|u_int32_t
argument_list|,
name|r_cr0
argument_list|)
expr_stmt|;
name|WAKECODE_FIXUP
argument_list|(
name|previous_cr2
argument_list|,
name|u_int32_t
argument_list|,
name|r_cr2
argument_list|)
expr_stmt|;
name|WAKECODE_FIXUP
argument_list|(
name|previous_cr3
argument_list|,
name|u_int32_t
argument_list|,
name|r_cr3
argument_list|)
expr_stmt|;
name|WAKECODE_FIXUP
argument_list|(
name|previous_cr4
argument_list|,
name|u_int32_t
argument_list|,
name|r_cr4
argument_list|)
expr_stmt|;
name|WAKECODE_FIXUP
argument_list|(
name|previous_tr
argument_list|,
name|u_int16_t
argument_list|,
name|r_tr
argument_list|)
expr_stmt|;
name|WAKECODE_BCOPY
argument_list|(
name|previous_gdt
argument_list|,
expr|struct
name|region_descriptor
argument_list|,
name|r_gdt
argument_list|)
expr_stmt|;
name|WAKECODE_FIXUP
argument_list|(
name|previous_ldt
argument_list|,
name|u_int16_t
argument_list|,
name|r_ldt
argument_list|)
expr_stmt|;
name|WAKECODE_BCOPY
argument_list|(
name|previous_idt
argument_list|,
expr|struct
name|region_descriptor
argument_list|,
name|r_idt
argument_list|)
expr_stmt|;
name|WAKECODE_FIXUP
argument_list|(
name|where_to_recover
argument_list|,
name|void
argument_list|,
name|acpi_restorecpu
argument_list|)
expr_stmt|;
name|WAKECODE_FIXUP
argument_list|(
name|previous_ds
argument_list|,
name|u_int16_t
argument_list|,
name|r_ds
argument_list|)
expr_stmt|;
name|WAKECODE_FIXUP
argument_list|(
name|previous_es
argument_list|,
name|u_int16_t
argument_list|,
name|r_es
argument_list|)
expr_stmt|;
name|WAKECODE_FIXUP
argument_list|(
name|previous_fs
argument_list|,
name|u_int16_t
argument_list|,
name|r_fs
argument_list|)
expr_stmt|;
name|WAKECODE_FIXUP
argument_list|(
name|previous_gs
argument_list|,
name|u_int16_t
argument_list|,
name|r_gs
argument_list|)
expr_stmt|;
name|WAKECODE_FIXUP
argument_list|(
name|previous_ss
argument_list|,
name|u_int16_t
argument_list|,
name|r_ss
argument_list|)
expr_stmt|;
if|if
condition|(
name|acpi_get_verbose
argument_list|(
name|sc
argument_list|)
condition|)
block|{
name|acpi_printcpu
argument_list|()
expr_stmt|;
block|}
name|ACPI_FLUSH_CPU_CACHE
argument_list|()
expr_stmt|;
if|if
condition|(
name|state
operator|==
name|ACPI_STATE_S4
operator|&&
name|sc
operator|->
name|acpi_s4bios
condition|)
block|{
name|status
operator|=
name|AcpiEnterSleepStateS4Bios
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|status
operator|=
name|AcpiEnterSleepState
argument_list|(
name|state
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|!=
name|AE_OK
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|acpi_dev
argument_list|,
literal|"AcpiEnterSleepState failed - %s\n"
argument_list|,
name|AcpiFormatException
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|out
goto|;
block|}
for|for
control|(
init|;
condition|;
control|)
empty_stmt|;
block|}
else|else
block|{
comment|/* Execute Wakeup */
if|#
directive|if
literal|0
block|initializecpu();
endif|#
directive|endif
name|icu_reinit
argument_list|()
expr_stmt|;
if|if
condition|(
name|acpi_get_verbose
argument_list|(
name|sc
argument_list|)
condition|)
block|{
name|acpi_savecpu
argument_list|()
expr_stmt|;
name|acpi_printcpu
argument_list|()
expr_stmt|;
block|}
block|}
name|out
label|:
name|vm_page_lock_queues
argument_list|()
expr_stmt|;
name|pmap_remove
argument_list|(
name|pm
argument_list|,
name|sc
operator|->
name|acpi_wakephys
argument_list|,
name|sc
operator|->
name|acpi_wakephys
operator|+
name|PAGE_SIZE
argument_list|)
expr_stmt|;
name|vm_page_unlock_queues
argument_list|()
expr_stmt|;
if|if
condition|(
name|opage
condition|)
block|{
name|pmap_enter
argument_list|(
name|pm
argument_list|,
name|sc
operator|->
name|acpi_wakephys
argument_list|,
name|page
argument_list|,
name|VM_PROT_READ
operator||
name|VM_PROT_WRITE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pteobj_allocated
condition|)
block|{
name|vm_object_deallocate
argument_list|(
name|pm
operator|->
name|pm_pteobj
argument_list|)
expr_stmt|;
name|pm
operator|->
name|pm_pteobj
operator|=
name|NULL
expr_stmt|;
block|}
name|load_cr3
argument_list|(
name|cr3
argument_list|)
expr_stmt|;
name|write_eflags
argument_list|(
name|ef
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|bus_dma_tag_t
name|acpi_waketag
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|bus_dmamap_t
name|acpi_wakemap
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vm_offset_t
name|acpi_wakeaddr
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|acpi_alloc_wakeup_handler
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
operator|!
name|cold
condition|)
return|return;
if|if
condition|(
name|bus_dma_tag_create
argument_list|(
comment|/* parent */
name|NULL
argument_list|,
comment|/* alignment */
literal|2
argument_list|,
literal|0
argument_list|,
comment|/* lowaddr below 1MB */
literal|0x9ffff
argument_list|,
comment|/* highaddr */
name|BUS_SPACE_MAXADDR
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|PAGE_SIZE
argument_list|,
literal|1
argument_list|,
name|PAGE_SIZE
argument_list|,
literal|0
argument_list|,
name|busdma_lock_mutex
argument_list|,
operator|&
name|Giant
argument_list|,
operator|&
name|acpi_waketag
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"acpi_alloc_wakeup_handler: unable to create wake tag\n"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|bus_dmamem_alloc
argument_list|(
name|acpi_waketag
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|acpi_wakeaddr
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|,
operator|&
name|acpi_wakemap
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"acpi_alloc_wakeup_handler: unable to allocate wake memory\n"
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
end_function

begin_macro
name|SYSINIT
argument_list|(
argument|acpiwakeup
argument_list|,
argument|SI_SUB_KMEM
argument_list|,
argument|SI_ORDER_ANY
argument_list|,
argument|acpi_alloc_wakeup_handler
argument_list|,
literal|0
argument_list|)
end_macro

begin_function
specifier|static
name|void
name|acpi_realmodeinst
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|segs
parameter_list|,
name|int
name|nsegs
parameter_list|,
name|int
name|error
parameter_list|)
block|{
name|struct
name|acpi_softc
modifier|*
name|sc
init|=
name|arg
decl_stmt|;
name|u_int32_t
modifier|*
name|addr
decl_stmt|;
name|addr
operator|=
operator|(
name|u_int32_t
operator|*
operator|)
operator|&
name|wakecode
index|[
name|wakeup_sw32
operator|+
literal|2
index|]
expr_stmt|;
operator|*
name|addr
operator|=
name|segs
index|[
literal|0
index|]
operator|.
name|ds_addr
operator|+
name|wakeup_32
expr_stmt|;
name|bcopy
argument_list|(
name|wakecode
argument_list|,
operator|(
name|void
operator|*
operator|)
name|sc
operator|->
name|acpi_wakeaddr
argument_list|,
sizeof|sizeof
argument_list|(
name|wakecode
argument_list|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|acpi_wakephys
operator|=
name|segs
index|[
literal|0
index|]
operator|.
name|ds_addr
expr_stmt|;
block|}
end_function

begin_function
name|void
name|acpi_install_wakeup_handler
parameter_list|(
name|struct
name|acpi_softc
modifier|*
name|sc
parameter_list|)
block|{
if|if
condition|(
name|acpi_wakeaddr
operator|==
literal|0
condition|)
block|{
return|return;
block|}
name|sc
operator|->
name|acpi_waketag
operator|=
name|acpi_waketag
expr_stmt|;
name|sc
operator|->
name|acpi_wakeaddr
operator|=
name|acpi_wakeaddr
expr_stmt|;
name|sc
operator|->
name|acpi_wakemap
operator|=
name|acpi_wakemap
expr_stmt|;
name|bus_dmamap_load
argument_list|(
name|sc
operator|->
name|acpi_waketag
argument_list|,
name|sc
operator|->
name|acpi_wakemap
argument_list|,
operator|(
name|void
operator|*
operator|)
name|sc
operator|->
name|acpi_wakeaddr
argument_list|,
name|PAGE_SIZE
argument_list|,
name|acpi_realmodeinst
argument_list|,
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


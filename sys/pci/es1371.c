begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Support Sound Cards based on the Ensoniq/Creative Labs ES1371/1373   *  * Copyright (c) 1999 by Russell Cattelan. All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  *  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in  *    the documentation and/or other materials provided with the  *    distribution.  *  * 3. All advertising materials mentioning features or use of this  *    software must display the following acknowledgement:  *      This product includes software developed by Russell Cattelan.  *  * 4. The name of the author may not be used to endorse or promote  *    products derived from this software without specific prior  *    written permission.  *  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESS OR IMPLIED  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE  * DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT,  * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES  * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR  * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,  * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED  * OF THE POSSIBILITY OF SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus_pio.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<i386/isa/snd/sound.h>
end_include

begin_include
include|#
directive|include
file|<pci/es1370_reg.h>
end_include

begin_comment
comment|/* -------------------------------------------------------------------- */
end_comment

begin_comment
comment|/*  * hweightN: returns the hamming weight (i.e. the number  * of bits set) of a N-bit word  */
end_comment

begin_function_decl
name|unsigned
name|int
name|hweight32
parameter_list|(
name|unsigned
name|int
name|w
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|__inline__
name|unsigned
name|int
name|hweight32
parameter_list|(
name|unsigned
name|int
name|w
parameter_list|)
block|{
name|unsigned
name|int
name|res
init|=
operator|(
name|w
operator|&
literal|0x55555555
operator|)
operator|+
operator|(
operator|(
name|w
operator|>>
literal|1
operator|)
operator|&
literal|0x55555555
operator|)
decl_stmt|;
name|res
operator|=
operator|(
name|res
operator|&
literal|0x33333333
operator|)
operator|+
operator|(
operator|(
name|res
operator|>>
literal|2
operator|)
operator|&
literal|0x33333333
operator|)
expr_stmt|;
name|res
operator|=
operator|(
name|res
operator|&
literal|0x0F0F0F0F
operator|)
operator|+
operator|(
operator|(
name|res
operator|>>
literal|4
operator|)
operator|&
literal|0x0F0F0F0F
operator|)
expr_stmt|;
name|res
operator|=
operator|(
name|res
operator|&
literal|0x00FF00FF
operator|)
operator|+
operator|(
operator|(
name|res
operator|>>
literal|8
operator|)
operator|&
literal|0x00FF00FF
operator|)
expr_stmt|;
return|return
operator|(
name|res
operator|&
literal|0x0000FFFF
operator|)
operator|+
operator|(
operator|(
name|res
operator|>>
literal|16
operator|)
operator|&
literal|0x0000FFFF
operator|)
return|;
block|}
end_function

begin_comment
comment|/* #define ES1371_REG_STATUS		        0x14 */
end_comment

begin_define
define|#
directive|define
name|ES1371_REG_CODEC
value|0x14
end_define

begin_comment
comment|/* this is really for the 1371  */
end_comment

begin_define
define|#
directive|define
name|ES1371_CODEC_INDEX_SHIFT
value|16
end_define

begin_comment
comment|/* this is really for the 1371  */
end_comment

begin_define
define|#
directive|define
name|ES1371_REG_RECSRC
value|0x1a
end_define

begin_define
define|#
directive|define
name|ES1371_REG_LEGACY
value|0x18
end_define

begin_comment
comment|/* W/R: Legacy control/status register */
end_comment

begin_define
define|#
directive|define
name|ES1371_REG_SMPRATE
value|0x10
end_define

begin_comment
comment|/* W/R: Codec rate converter interface register */
end_comment

begin_define
define|#
directive|define
name|ES1371_SRC_RAM_ADDRO
parameter_list|(
name|o
parameter_list|)
value|(((o)&0x7f)<<25)
end_define

begin_comment
comment|/* address of the sample rate converter */
end_comment

begin_define
define|#
directive|define
name|ES1371_SRC_RAM_ADDRM
value|(0x7f<<25)
end_define

begin_comment
comment|/* mask for above */
end_comment

begin_define
define|#
directive|define
name|ES1371_SRC_RAM_ADDRI
parameter_list|(
name|i
parameter_list|)
value|(((i)>>25)&0x7f)
end_define

begin_comment
comment|/* address of the sample rate converter */
end_comment

begin_define
define|#
directive|define
name|ES1371_SRC_RAM_WE
value|(1<<24)
end_define

begin_comment
comment|/* R/W: read/write control for sample rate converter */
end_comment

begin_define
define|#
directive|define
name|ES1371_SRC_RAM_BUSY
value|(1<<23)
end_define

begin_comment
comment|/* R/O: sample rate memory is busy */
end_comment

begin_define
define|#
directive|define
name|ES1371_SRC_DISABLE
value|(1<<22)
end_define

begin_comment
comment|/* sample rate converter disable */
end_comment

begin_define
define|#
directive|define
name|ES1371_DIS_P1
value|(1<<21)
end_define

begin_comment
comment|/* playback channel 1 accumulator update disable */
end_comment

begin_define
define|#
directive|define
name|ES1371_DIS_P2
value|(1<<20)
end_define

begin_comment
comment|/* playback channel 1 accumulator update disable */
end_comment

begin_define
define|#
directive|define
name|ES1371_DIS_R1
value|(1<<19)
end_define

begin_comment
comment|/* record channel accumulator update disable */
end_comment

begin_define
define|#
directive|define
name|ES1371_SRC_RAM_DATAO
parameter_list|(
name|o
parameter_list|)
value|(((o)&0xffff)<<0)
end_define

begin_comment
comment|/* current value of the sample rate converter */
end_comment

begin_define
define|#
directive|define
name|ES1371_SRC_RAM_DATAM
value|(0xffff<<0)
end_define

begin_comment
comment|/* mask for above */
end_comment

begin_define
define|#
directive|define
name|ES1371_SRC_RAM_DATAI
parameter_list|(
name|i
parameter_list|)
value|(((i)>>0)&0xffff)
end_define

begin_comment
comment|/* current value of the sample rate converter */
end_comment

begin_define
define|#
directive|define
name|ES_1371_SYNC_RES
value|(1<<14)
end_define

begin_comment
comment|/* Warm AC97 reset */
end_comment

begin_define
define|#
directive|define
name|ES1371_CSTAT
value|(1<<30)
end_define

begin_define
define|#
directive|define
name|CODEC_RDY
value|0x80000000
end_define

begin_comment
comment|/* AC97 read data valid */
end_comment

begin_define
define|#
directive|define
name|CODEC_WIP
value|0x40000000
end_define

begin_comment
comment|/* AC97 write in progress */
end_comment

begin_define
define|#
directive|define
name|CODEC_PORD
value|0x00800000
end_define

begin_comment
comment|/* 0 = write AC97 register */
end_comment

begin_define
define|#
directive|define
name|CODEC_POADD_MASK
value|0x007f0000
end_define

begin_define
define|#
directive|define
name|CODEC_POADD_SHIFT
value|16
end_define

begin_define
define|#
directive|define
name|CODEC_PODAT_MASK
value|0x0000ffff
end_define

begin_define
define|#
directive|define
name|CODEC_PODAT_SHIFT
value|0
end_define

begin_comment
comment|/* codec constants */
end_comment

begin_define
define|#
directive|define
name|CODEC_ID_DEDICATEDMIC
value|0x001
end_define

begin_define
define|#
directive|define
name|CODEC_ID_MODEMCODEC
value|0x002
end_define

begin_define
define|#
directive|define
name|CODEC_ID_BASSTREBLE
value|0x004
end_define

begin_define
define|#
directive|define
name|CODEC_ID_SIMULATEDSTEREO
value|0x008
end_define

begin_define
define|#
directive|define
name|CODEC_ID_HEADPHONEOUT
value|0x010
end_define

begin_define
define|#
directive|define
name|CODEC_ID_LOUDNESS
value|0x020
end_define

begin_define
define|#
directive|define
name|CODEC_ID_18BITDAC
value|0x040
end_define

begin_define
define|#
directive|define
name|CODEC_ID_20BITDAC
value|0x080
end_define

begin_define
define|#
directive|define
name|CODEC_ID_18BITADC
value|0x100
end_define

begin_define
define|#
directive|define
name|CODEC_ID_20BITADC
value|0x200
end_define

begin_define
define|#
directive|define
name|CODEC_ID_SESHIFT
value|10
end_define

begin_define
define|#
directive|define
name|CODEC_ID_SEMASK
value|0x1f
end_define

begin_comment
comment|/* sample rate converter */
end_comment

begin_define
define|#
directive|define
name|SRC_RAMADDR_MASK
value|0xfe000000
end_define

begin_define
define|#
directive|define
name|SRC_RAMADDR_SHIFT
value|25
end_define

begin_define
define|#
directive|define
name|SRC_WE
value|0x01000000
end_define

begin_comment
comment|/* read/write control for SRC RAM */
end_comment

begin_define
define|#
directive|define
name|SRC_BUSY
value|0x00800000
end_define

begin_comment
comment|/* SRC busy */
end_comment

begin_define
define|#
directive|define
name|SRC_DIS
value|0x00400000
end_define

begin_comment
comment|/* 1 = disable SRC */
end_comment

begin_define
define|#
directive|define
name|SRC_DDAC1
value|0x00200000
end_define

begin_comment
comment|/* 1 = disable accum update for DAC1 */
end_comment

begin_define
define|#
directive|define
name|SRC_DDAC2
value|0x00100000
end_define

begin_comment
comment|/* 1 = disable accum update for DAC2 */
end_comment

begin_define
define|#
directive|define
name|SRC_DADC
value|0x00080000
end_define

begin_comment
comment|/* 1 = disable accum update for ADC2 */
end_comment

begin_define
define|#
directive|define
name|SRC_RAMDATA_MASK
value|0x0000ffff
end_define

begin_define
define|#
directive|define
name|SRC_RAMDATA_SHIFT
value|0
end_define

begin_comment
comment|/*  *  Sample rate converter addresses  */
end_comment

begin_define
define|#
directive|define
name|ES_SMPREG_DAC1
value|0x70
end_define

begin_define
define|#
directive|define
name|ES_SMPREG_DAC2
value|0x74
end_define

begin_define
define|#
directive|define
name|ES_SMPREG_ADC
value|0x78
end_define

begin_define
define|#
directive|define
name|ES_SMPREG_VOL_ADC
value|0x6c
end_define

begin_define
define|#
directive|define
name|ES_SMPREG_VOL_DAC1
value|0x7c
end_define

begin_define
define|#
directive|define
name|ES_SMPREG_VOL_DAC2
value|0x7e
end_define

begin_define
define|#
directive|define
name|ES_SMPREG_TRUNC_N
value|0x00
end_define

begin_define
define|#
directive|define
name|ES_SMPREG_INT_REGS
value|0x01
end_define

begin_define
define|#
directive|define
name|ES_SMPREG_ACCUM_FRAC
value|0x02
end_define

begin_define
define|#
directive|define
name|ES_SMPREG_VFREQ_FRAC
value|0x03
end_define

begin_define
define|#
directive|define
name|CODEC_PIRD
value|0x00800000
end_define

begin_comment
comment|/* 0 = write AC97 register */
end_comment

begin_define
define|#
directive|define
name|CODEC_PIADD_MASK
value|0x007f0000
end_define

begin_define
define|#
directive|define
name|CODEC_PIADD_SHIFT
value|16
end_define

begin_define
define|#
directive|define
name|CODEC_PIDAT_MASK
value|0x0000ffff
end_define

begin_define
define|#
directive|define
name|CODEC_PIDAT_SHIFT
value|0
end_define

begin_struct
struct|struct
name|initvol
block|{
name|int
name|mixch
decl_stmt|;
name|int
name|vol
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
name|struct
name|initvol
name|initvol
index|[]
init|=
block|{
block|{
name|SOUND_MIXER_WRITE_LINE
block|,
literal|0x4040
block|}
block|,
block|{
name|SOUND_MIXER_WRITE_CD
block|,
literal|0x4040
block|}
block|,
block|{
name|MIXER_WRITE
argument_list|(
name|SOUND_MIXER_VIDEO
argument_list|)
block|,
literal|0x4040
block|}
block|,
block|{
name|SOUND_MIXER_WRITE_LINE1
block|,
literal|0x4040
block|}
block|,
comment|/* 	{ SOUND_MIXER_WRITE_PCM, 0x4040 }, */
block|{
name|SOUND_MIXER_WRITE_PCM
block|,
literal|0x6464
block|}
block|,
block|{
name|SOUND_MIXER_WRITE_VOLUME
block|,
literal|0x4040
block|}
block|,
block|{
name|SOUND_MIXER_WRITE_BASS
block|,
literal|0x1010
block|}
block|,
block|{
name|SOUND_MIXER_WRITE_TREBLE
block|,
literal|0x1010
block|}
block|,
block|{
name|MIXER_WRITE
argument_list|(
name|SOUND_MIXER_PHONEOUT
argument_list|)
block|,
literal|0x4040
block|}
block|,
block|{
name|SOUND_MIXER_WRITE_OGAIN
block|,
literal|0x4040
block|}
block|,
block|{
name|MIXER_WRITE
argument_list|(
name|SOUND_MIXER_PHONEIN
argument_list|)
block|,
literal|0x4040
block|}
block|,
block|{
name|SOUND_MIXER_WRITE_SPEAKER
block|,
literal|0x4040
block|}
block|,
block|{
name|SOUND_MIXER_WRITE_MIC
block|,
literal|0x4040
block|}
block|,
block|{
name|SOUND_MIXER_WRITE_RECLEV
block|,
literal|0x4040
block|}
block|,
block|{
name|SOUND_MIXER_WRITE_IGAIN
block|,
literal|0x4040
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|stereo_enhancement
index|[]
init|=
block|{
literal|"no 3D stereo enhancement"
block|,
literal|"Analog Devices Phat Stereo"
block|,
literal|"Creative Stereo Enhancement"
block|,
literal|"National Semiconductor 3D Stereo Enhancement"
block|,
literal|"YAMAHA Ymersion"
block|,
literal|"BBE 3D Stereo Enhancement"
block|,
literal|"Crystal Semiconductor 3D Stereo Enhancement"
block|,
literal|"Qsound QXpander"
block|,
literal|"Spatializer 3D Stereo Enhancement"
block|,
literal|"SRS 3D Stereo Enhancement"
block|,
literal|"Platform Technologies 3D Stereo Enhancement"
block|,
literal|"AKM 3D Audio"
block|,
literal|"Aureal Stereo Enhancement"
block|,
literal|"AZTECH  3D Enhancement"
block|,
literal|"Binaura 3D Audio Enhancement"
block|,
literal|"ESS Technology Stereo Enhancement"
block|,
literal|"Harman International VMAx"
block|,
literal|"NVidea 3D Stereo Enhancement"
block|,
literal|"Philips Incredible Sound"
block|,
literal|"Texas Instruments 3D Stereo Enhancement"
block|,
literal|"VLSI Technology 3D Stereo Enhancement"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|unsigned
name|int
name|recsrc
index|[
literal|8
index|]
init|=
block|{
name|SOUND_MASK_MIC
block|,
name|SOUND_MASK_CD
block|,
name|SOUND_MASK_VIDEO
block|,
name|SOUND_MASK_LINE1
block|,
name|SOUND_MASK_LINE
block|,
name|SOUND_MASK_VOLUME
block|,
name|SOUND_MASK_PHONEOUT
block|,
name|SOUND_MASK_PHONEIN
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|unsigned
name|char
name|volreg
index|[]
init|=
block|{
comment|/* 5 bit stereo */
index|[
name|SOUND_MIXER_LINE
index|]
operator|=
literal|0x10
block|,
index|[
name|SOUND_MIXER_CD
index|]
operator|=
literal|0x12
block|,
index|[
name|SOUND_MIXER_VIDEO
index|]
operator|=
literal|0x14
block|,
index|[
name|SOUND_MIXER_LINE1
index|]
operator|=
literal|0x16
block|,
index|[
name|SOUND_MIXER_PCM
index|]
operator|=
literal|0x18
block|,
comment|/* 6 bit stereo */
index|[
name|SOUND_MIXER_VOLUME
index|]
operator|=
literal|0x02
block|,
index|[
name|SOUND_MIXER_PHONEOUT
index|]
operator|=
literal|0x04
block|,
comment|/* 6 bit mono */
index|[
name|SOUND_MIXER_OGAIN
index|]
operator|=
literal|0x06
block|,
index|[
name|SOUND_MIXER_PHONEIN
index|]
operator|=
literal|0x0c
block|,
comment|/* 4 bit mono but shifted by 1 */
index|[
name|SOUND_MIXER_SPEAKER
index|]
operator|=
literal|0x08
block|,
comment|/* 6 bit mono + preamp */
index|[
name|SOUND_MIXER_MIC
index|]
operator|=
literal|0x0e
block|,
comment|/* 4 bit stereo */
index|[
name|SOUND_MIXER_RECLEV
index|]
operator|=
literal|0x1c
block|,
comment|/* 4 bit mono */
index|[
name|SOUND_MIXER_IGAIN
index|]
operator|=
literal|0x1e
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|swab
parameter_list|(
name|x
parameter_list|)
value|((((x)>> 8)& 0xff) | (((x)<< 8)& 0xff00))
end_define

begin_define
define|#
directive|define
name|AC97_PESSIMISTIC
end_define

begin_define
define|#
directive|define
name|put_user
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
value|*b=a
end_define

begin_function
name|int
name|es_init_1371
parameter_list|(
name|snddev_info
modifier|*
name|d
parameter_list|)
block|{
name|struct
name|es_info
modifier|*
name|es
init|=
operator|(
expr|struct
name|es_info
operator|*
operator|)
name|d
operator|->
name|device_data
decl_stmt|;
name|u_int
name|i
decl_stmt|;
name|int
name|idx
decl_stmt|;
name|int
name|val
decl_stmt|,
name|val2
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|es_debug
operator|>
literal|0
condition|)
name|printf
argument_list|(
literal|"es_init_1371\n"
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|d
operator|->
name|name
argument_list|,
literal|"ES1371"
argument_list|,
name|strlen
argument_list|(
literal|"ES1371"
argument_list|)
argument_list|)
expr_stmt|;
name|es
operator|->
name|ctrl
operator|=
literal|0
expr_stmt|;
name|es
operator|->
name|sctrl
operator|=
literal|0
expr_stmt|;
comment|/* initialize the chips */
name|bus_space_write_4
argument_list|(
name|es
operator|->
name|st
argument_list|,
name|es
operator|->
name|sh
argument_list|,
name|ES1370_REG_CONTROL
argument_list|,
name|es
operator|->
name|ctrl
argument_list|)
expr_stmt|;
name|bus_space_write_4
argument_list|(
name|es
operator|->
name|st
argument_list|,
name|es
operator|->
name|sh
argument_list|,
name|ES1370_REG_SERIAL_CONTROL
argument_list|,
name|es
operator|->
name|sctrl
argument_list|)
expr_stmt|;
name|bus_space_write_4
argument_list|(
name|es
operator|->
name|st
argument_list|,
name|es
operator|->
name|sh
argument_list|,
name|ES1371_REG_LEGACY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* AC'97 warm reset to start the bitclk */
name|bus_space_write_4
argument_list|(
name|es
operator|->
name|st
argument_list|,
name|es
operator|->
name|sh
argument_list|,
name|ES1371_REG_LEGACY
argument_list|,
name|es
operator|->
name|ctrl
operator||
name|ES_1371_SYNC_RES
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|2000
argument_list|)
expr_stmt|;
name|bus_space_write_4
argument_list|(
name|es
operator|->
name|st
argument_list|,
name|es
operator|->
name|sh
argument_list|,
name|ES1370_REG_SERIAL_CONTROL
argument_list|,
name|es
operator|->
name|ctrl
argument_list|)
expr_stmt|;
comment|/* Init the sample rate converter */
name|bus_space_write_4
argument_list|(
name|es
operator|->
name|st
argument_list|,
name|es
operator|->
name|sh
argument_list|,
name|ES1371_REG_SMPRATE
argument_list|,
name|ES1371_SRC_DISABLE
argument_list|)
expr_stmt|;
for|for
control|(
name|idx
operator|=
literal|0
init|;
name|idx
operator|<
literal|0x80
condition|;
name|idx
operator|++
control|)
name|es1371_src_write
argument_list|(
name|d
argument_list|,
name|idx
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|es1371_src_write
argument_list|(
name|d
argument_list|,
name|ES_SMPREG_DAC1
operator|+
name|ES_SMPREG_TRUNC_N
argument_list|,
literal|16
operator|<<
literal|4
argument_list|)
expr_stmt|;
name|es1371_src_write
argument_list|(
name|d
argument_list|,
name|ES_SMPREG_DAC1
operator|+
name|ES_SMPREG_INT_REGS
argument_list|,
literal|16
operator|<<
literal|10
argument_list|)
expr_stmt|;
name|es1371_src_write
argument_list|(
name|d
argument_list|,
name|ES_SMPREG_DAC2
operator|+
name|ES_SMPREG_TRUNC_N
argument_list|,
literal|16
operator|<<
literal|4
argument_list|)
expr_stmt|;
name|es1371_src_write
argument_list|(
name|d
argument_list|,
name|ES_SMPREG_DAC2
operator|+
name|ES_SMPREG_INT_REGS
argument_list|,
literal|16
operator|<<
literal|10
argument_list|)
expr_stmt|;
name|es1371_src_write
argument_list|(
name|d
argument_list|,
name|ES_SMPREG_VOL_ADC
argument_list|,
literal|1
operator|<<
literal|12
argument_list|)
expr_stmt|;
name|es1371_src_write
argument_list|(
name|d
argument_list|,
name|ES_SMPREG_VOL_ADC
operator|+
literal|1
argument_list|,
literal|1
operator|<<
literal|12
argument_list|)
expr_stmt|;
name|es1371_src_write
argument_list|(
name|d
argument_list|,
name|ES_SMPREG_VOL_DAC1
argument_list|,
literal|1
operator|<<
literal|12
argument_list|)
expr_stmt|;
name|es1371_src_write
argument_list|(
name|d
argument_list|,
name|ES_SMPREG_VOL_DAC1
operator|+
literal|1
argument_list|,
literal|1
operator|<<
literal|12
argument_list|)
expr_stmt|;
name|es1371_src_write
argument_list|(
name|d
argument_list|,
name|ES_SMPREG_VOL_DAC2
argument_list|,
literal|1
operator|<<
literal|12
argument_list|)
expr_stmt|;
name|es1371_src_write
argument_list|(
name|d
argument_list|,
name|ES_SMPREG_VOL_DAC2
operator|+
literal|1
argument_list|,
literal|1
operator|<<
literal|12
argument_list|)
expr_stmt|;
name|es1371_adc_rate
argument_list|(
name|d
argument_list|,
literal|22050
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|es1371_dac1_rate
argument_list|(
name|d
argument_list|,
literal|22050
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|es1371_dac2_rate
argument_list|(
name|d
argument_list|,
literal|22050
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* WARNING: 	 * enabling the sample rate converter without properly programming 	 * its parameters causes the chip to lock up (the SRC busy bit will 	 * be stuck high, and I've found no way to rectify this other than 	 * power cycle) 	 */
comment|/*outl(0, s->io+ES1371_REG_SRCONV); */
name|bus_space_write_4
argument_list|(
name|es
operator|->
name|st
argument_list|,
name|es
operator|->
name|sh
argument_list|,
name|ES1371_REG_SMPRATE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* codec init */
name|wrcodec
argument_list|(
name|d
argument_list|,
literal|0x00
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* reset codec */
name|d
operator|->
name|bd_id
operator|=
name|rdcodec
argument_list|(
name|d
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
comment|/* get codec ID */
name|val
operator|=
name|rdcodec
argument_list|(
name|d
argument_list|,
literal|0x7c
argument_list|)
expr_stmt|;
name|val2
operator|=
name|rdcodec
argument_list|(
name|d
argument_list|,
literal|0x7e
argument_list|)
expr_stmt|;
if|if
condition|(
name|es_debug
operator|>
literal|0
condition|)
name|printf
argument_list|(
literal|"init: d->bd_id 0x%x val 0x%x val2 0x%x\n"
argument_list|,
name|d
operator|->
name|bd_id
argument_list|,
name|val
argument_list|,
name|val2
argument_list|)
expr_stmt|;
name|d
operator|->
name|bd_id
operator||=
name|CODEC_ID_BASSTREBLE
expr_stmt|;
name|printf
argument_list|(
literal|"es1371: codec vendor %c%c%c revision %d\n"
argument_list|,
operator|(
name|val
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|,
name|val
operator|&
literal|0xff
argument_list|,
operator|(
name|val2
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|,
name|val2
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"es1371: codec features"
argument_list|)
expr_stmt|;
if|if
condition|(
name|d
operator|->
name|bd_id
operator|&
name|CODEC_ID_DEDICATEDMIC
condition|)
name|printf
argument_list|(
literal|" dedicated MIC PCM in"
argument_list|)
expr_stmt|;
if|if
condition|(
name|d
operator|->
name|bd_id
operator|&
name|CODEC_ID_MODEMCODEC
condition|)
name|printf
argument_list|(
literal|" Modem Line Codec"
argument_list|)
expr_stmt|;
if|if
condition|(
name|d
operator|->
name|bd_id
operator|&
name|CODEC_ID_BASSTREBLE
condition|)
name|printf
argument_list|(
literal|" Bass& Treble"
argument_list|)
expr_stmt|;
if|if
condition|(
name|d
operator|->
name|bd_id
operator|&
name|CODEC_ID_SIMULATEDSTEREO
condition|)
name|printf
argument_list|(
literal|" Simulated Stereo"
argument_list|)
expr_stmt|;
if|if
condition|(
name|d
operator|->
name|bd_id
operator|&
name|CODEC_ID_HEADPHONEOUT
condition|)
name|printf
argument_list|(
literal|" Headphone out"
argument_list|)
expr_stmt|;
if|if
condition|(
name|d
operator|->
name|bd_id
operator|&
name|CODEC_ID_LOUDNESS
condition|)
name|printf
argument_list|(
literal|" Loudness"
argument_list|)
expr_stmt|;
if|if
condition|(
name|d
operator|->
name|bd_id
operator|&
name|CODEC_ID_18BITDAC
condition|)
name|printf
argument_list|(
literal|" 18bit DAC"
argument_list|)
expr_stmt|;
if|if
condition|(
name|d
operator|->
name|bd_id
operator|&
name|CODEC_ID_20BITDAC
condition|)
name|printf
argument_list|(
literal|" 20bit DAC"
argument_list|)
expr_stmt|;
if|if
condition|(
name|d
operator|->
name|bd_id
operator|&
name|CODEC_ID_18BITADC
condition|)
name|printf
argument_list|(
literal|" 18bit ADC"
argument_list|)
expr_stmt|;
if|if
condition|(
name|d
operator|->
name|bd_id
operator|&
name|CODEC_ID_20BITADC
condition|)
name|printf
argument_list|(
literal|" 20bit ADC"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
operator|(
name|d
operator|->
name|bd_id
operator|&
literal|0x3ff
operator|)
condition|?
literal|""
else|:
literal|" none"
argument_list|)
expr_stmt|;
name|val
operator|=
operator|(
name|d
operator|->
name|bd_id
operator|>>
name|CODEC_ID_SESHIFT
operator|)
operator|&
name|CODEC_ID_SEMASK
expr_stmt|;
name|printf
argument_list|(
literal|"es1371: stereo enhancement: %s\n"
argument_list|,
operator|(
name|val
operator|<=
literal|20
operator|)
condition|?
name|stereo_enhancement
index|[
name|val
index|]
else|:
literal|"unknown"
argument_list|)
expr_stmt|;
name|val
operator|=
name|SOUND_MASK_LINE
expr_stmt|;
name|mixer_ioctl_1371
argument_list|(
name|d
argument_list|,
name|SOUND_MIXER_WRITE_RECSRC
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|val
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|initvol
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|initvol
index|[
literal|0
index|]
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|val
operator|=
name|initvol
index|[
name|i
index|]
operator|.
name|vol
expr_stmt|;
if|if
condition|(
name|es_debug
operator|>
literal|0
condition|)
name|printf
argument_list|(
literal|"es_init -> mixer_ioctl_1371 0x%x\n"
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|mixer_ioctl_1371
argument_list|(
name|d
argument_list|,
name|initvol
index|[
name|i
index|]
operator|.
name|mixch
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|val
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|mixer_rdch
parameter_list|(
name|snddev_info
modifier|*
name|s
parameter_list|,
name|unsigned
name|int
name|ch
parameter_list|,
name|int
modifier|*
name|arg
parameter_list|)
block|{
name|int
name|j
decl_stmt|;
if|if
condition|(
name|es_debug
operator|>
literal|0
condition|)
name|printf
argument_list|(
literal|"mixer_rdch ch 0x%x\n"
argument_list|,
name|ch
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
name|SOUND_MIXER_MIC
case|:
name|j
operator|=
name|rdcodec
argument_list|(
name|s
argument_list|,
literal|0x0e
argument_list|)
expr_stmt|;
if|if
condition|(
name|j
operator|&
literal|0x8000
condition|)
block|{
name|put_user
argument_list|(
literal|0
argument_list|,
operator|(
name|int
operator|*
operator|)
name|arg
argument_list|)
expr_stmt|;
return|return
operator|(
operator|*
name|arg
operator|)
return|;
block|}
name|put_user
argument_list|(
literal|0x4949
operator|-
literal|0x202
operator|*
operator|(
name|j
operator|&
literal|0x1f
operator|)
operator|+
operator|(
operator|(
name|j
operator|&
literal|0x40
operator|)
condition|?
literal|0x1b1b
else|:
literal|0
operator|)
argument_list|,
operator|(
name|int
operator|*
operator|)
name|arg
argument_list|)
expr_stmt|;
return|return
operator|(
operator|*
name|arg
operator|)
return|;
case|case
name|SOUND_MIXER_OGAIN
case|:
case|case
name|SOUND_MIXER_PHONEIN
case|:
name|j
operator|=
name|rdcodec
argument_list|(
name|s
argument_list|,
name|volreg
index|[
name|ch
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|j
operator|&
literal|0x8000
condition|)
block|{
name|put_user
argument_list|(
literal|0
argument_list|,
operator|(
name|int
operator|*
operator|)
name|arg
argument_list|)
expr_stmt|;
return|return
operator|(
operator|*
name|arg
operator|)
return|;
block|}
name|put_user
argument_list|(
literal|0x6464
operator|-
literal|0x303
operator|*
operator|(
name|j
operator|&
literal|0x1f
operator|)
argument_list|,
operator|(
name|int
operator|*
operator|)
name|arg
argument_list|)
expr_stmt|;
return|return
operator|(
operator|*
name|arg
operator|)
return|;
case|case
name|SOUND_MIXER_PHONEOUT
case|:
if|if
condition|(
operator|!
operator|(
name|s
operator|->
name|bd_id
operator|&
name|CODEC_ID_HEADPHONEOUT
operator|)
condition|)
return|return
name|EINVAL
return|;
comment|/* fall through */
case|case
name|SOUND_MIXER_VOLUME
case|:
name|j
operator|=
name|rdcodec
argument_list|(
name|s
argument_list|,
name|volreg
index|[
name|ch
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|j
operator|&
literal|0x8000
condition|)
block|{
name|put_user
argument_list|(
literal|0
argument_list|,
operator|(
name|int
operator|*
operator|)
name|arg
argument_list|)
expr_stmt|;
return|return
operator|(
operator|*
name|arg
operator|)
return|;
block|}
name|put_user
argument_list|(
literal|0x6464
operator|-
operator|(
name|swab
argument_list|(
name|j
argument_list|)
operator|&
literal|0x1f1f
operator|)
operator|*
literal|3
argument_list|,
operator|(
name|int
operator|*
operator|)
name|arg
argument_list|)
expr_stmt|;
return|return
operator|(
operator|*
name|arg
operator|)
return|;
case|case
name|SOUND_MIXER_SPEAKER
case|:
name|j
operator|=
name|rdcodec
argument_list|(
name|s
argument_list|,
literal|0x0a
argument_list|)
expr_stmt|;
if|if
condition|(
name|j
operator|&
literal|0x8000
condition|)
block|{
name|put_user
argument_list|(
literal|0
argument_list|,
operator|(
name|int
operator|*
operator|)
name|arg
argument_list|)
expr_stmt|;
return|return
operator|(
operator|*
name|arg
operator|)
return|;
block|}
name|put_user
argument_list|(
literal|0x6464
operator|-
operator|(
operator|(
name|j
operator|>>
literal|1
operator|)
operator|&
literal|0xf
operator|)
operator|*
literal|0x606
argument_list|,
operator|(
name|int
operator|*
operator|)
name|arg
argument_list|)
expr_stmt|;
return|return
operator|(
operator|*
name|arg
operator|)
return|;
case|case
name|SOUND_MIXER_LINE
case|:
case|case
name|SOUND_MIXER_CD
case|:
case|case
name|SOUND_MIXER_VIDEO
case|:
case|case
name|SOUND_MIXER_LINE1
case|:
case|case
name|SOUND_MIXER_PCM
case|:
name|j
operator|=
name|rdcodec
argument_list|(
name|s
argument_list|,
name|volreg
index|[
name|ch
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|j
operator|&
literal|0x8000
condition|)
block|{
name|put_user
argument_list|(
literal|0
argument_list|,
operator|(
name|int
operator|*
operator|)
name|arg
argument_list|)
expr_stmt|;
return|return
operator|(
operator|*
name|arg
operator|)
return|;
block|}
name|put_user
argument_list|(
literal|0x6464
operator|-
operator|(
name|swab
argument_list|(
name|j
argument_list|)
operator|&
literal|0x1f1f
operator|)
operator|*
literal|3
argument_list|,
operator|(
name|int
operator|*
operator|)
name|arg
argument_list|)
expr_stmt|;
return|return
operator|(
operator|*
name|arg
operator|)
return|;
case|case
name|SOUND_MIXER_BASS
case|:
case|case
name|SOUND_MIXER_TREBLE
case|:
if|if
condition|(
operator|!
operator|(
name|s
operator|->
name|bd_id
operator|&
name|CODEC_ID_BASSTREBLE
operator|)
condition|)
return|return
name|EINVAL
return|;
name|j
operator|=
name|rdcodec
argument_list|(
name|s
argument_list|,
literal|0x08
argument_list|)
expr_stmt|;
if|if
condition|(
name|ch
operator|==
name|SOUND_MIXER_BASS
condition|)
name|j
operator|>>=
literal|8
expr_stmt|;
name|put_user
argument_list|(
operator|(
operator|(
operator|(
name|j
operator|&
literal|15
operator|)
operator|*
literal|100
operator|)
operator|/
literal|15
operator|)
operator|*
literal|0x101
argument_list|,
operator|(
name|int
operator|*
operator|)
name|arg
argument_list|)
expr_stmt|;
return|return
operator|(
operator|*
name|arg
operator|)
return|;
comment|/* SOUND_MIXER_RECLEV and SOUND_MIXER_IGAIN specify gain */
case|case
name|SOUND_MIXER_RECLEV
case|:
name|j
operator|=
name|rdcodec
argument_list|(
name|s
argument_list|,
literal|0x1c
argument_list|)
expr_stmt|;
if|if
condition|(
name|j
operator|&
literal|0x8000
condition|)
block|{
name|put_user
argument_list|(
literal|0
argument_list|,
operator|(
name|int
operator|*
operator|)
name|arg
argument_list|)
expr_stmt|;
return|return
operator|(
operator|*
name|arg
operator|)
return|;
block|}
name|put_user
argument_list|(
operator|(
name|swab
argument_list|(
name|j
argument_list|)
operator|&
literal|0xf0f
operator|)
operator|*
literal|6
operator|+
literal|0xa0a
argument_list|,
operator|(
name|int
operator|*
operator|)
name|arg
argument_list|)
expr_stmt|;
return|return
operator|(
operator|*
name|arg
operator|)
return|;
case|case
name|SOUND_MIXER_IGAIN
case|:
if|if
condition|(
operator|!
operator|(
name|s
operator|->
name|bd_id
operator|&
name|CODEC_ID_DEDICATEDMIC
operator|)
condition|)
return|return
name|EINVAL
return|;
name|j
operator|=
name|rdcodec
argument_list|(
name|s
argument_list|,
literal|0x1e
argument_list|)
expr_stmt|;
if|if
condition|(
name|j
operator|&
literal|0x8000
condition|)
block|{
name|put_user
argument_list|(
literal|0
argument_list|,
operator|(
name|int
operator|*
operator|)
name|arg
argument_list|)
expr_stmt|;
return|return
operator|(
operator|*
name|arg
operator|)
return|;
block|}
name|put_user
argument_list|(
operator|(
name|j
operator|&
literal|0xf
operator|)
operator|*
literal|0x606
operator|+
literal|0xa0a
argument_list|,
operator|(
name|int
operator|*
operator|)
name|arg
argument_list|)
expr_stmt|;
return|return
operator|(
operator|*
name|arg
operator|)
return|;
default|default:
return|return
name|EINVAL
return|;
block|}
block|}
end_function

begin_function
name|int
name|mixer_wrch
parameter_list|(
name|snddev_info
modifier|*
name|s
parameter_list|,
name|unsigned
name|int
name|ich
parameter_list|,
name|int
name|val
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|unsigned
name|l1
decl_stmt|,
name|r1
decl_stmt|;
name|u_int
name|ch
init|=
operator|(
name|ich
operator|&
literal|0xff
operator|)
decl_stmt|;
if|if
condition|(
name|es_debug
operator|>
literal|0
condition|)
name|printf
argument_list|(
literal|"mixer_wrch ch 0x%x val 0x%x\t"
argument_list|,
name|ch
argument_list|,
operator|(
name|val
operator|&
literal|0xffff
operator|)
argument_list|)
expr_stmt|;
name|l1
operator|=
name|val
operator|&
literal|0xff
expr_stmt|;
name|r1
operator|=
operator|(
name|val
operator|>>
literal|8
operator|)
operator|&
literal|0xff
expr_stmt|;
if|if
condition|(
name|es_debug
operator|>
literal|0
condition|)
name|printf
argument_list|(
literal|"l1 0x%x r1 0x%x\n"
argument_list|,
name|l1
argument_list|,
name|r1
argument_list|)
expr_stmt|;
if|if
condition|(
name|l1
operator|>
literal|100
condition|)
name|l1
operator|=
literal|100
expr_stmt|;
if|if
condition|(
name|r1
operator|>
literal|100
condition|)
name|r1
operator|=
literal|100
expr_stmt|;
name|s
operator|->
name|mix_levels
index|[
name|ch
index|]
operator|=
operator|(
operator|(
name|u_int
operator|)
name|r1
operator|<<
literal|8
operator|)
operator||
name|l1
expr_stmt|;
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
name|SOUND_MIXER_LINE
case|:
comment|/* 	  printf("SOUND_MIXER_LINE\n"); */
case|case
name|SOUND_MIXER_CD
case|:
comment|/* 	  printf("SOUND_MIXER_CD\n"); */
case|case
name|SOUND_MIXER_VIDEO
case|:
comment|/* 	  printf("SOUND_MIXER_VIDEO\n"); */
case|case
name|SOUND_MIXER_LINE1
case|:
comment|/* 	  printf("SOUND_MIXEgR_LINE1\n");*/
case|case
name|SOUND_MIXER_PCM
case|:
if|if
condition|(
name|es_debug
operator|>
literal|0
condition|)
name|printf
argument_list|(
literal|"SOUND_MIXER_PCM\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|l1
operator|<
literal|7
operator|&&
name|r1
operator|<
literal|7
condition|)
block|{
name|wrcodec
argument_list|(
name|s
argument_list|,
name|volreg
index|[
name|ch
index|]
argument_list|,
literal|0x8000
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|l1
operator|<
literal|7
condition|)
name|l1
operator|=
literal|7
expr_stmt|;
if|if
condition|(
name|r1
operator|<
literal|7
condition|)
name|r1
operator|=
literal|7
expr_stmt|;
name|wrcodec
argument_list|(
name|s
argument_list|,
name|volreg
index|[
name|ch
index|]
argument_list|,
operator|(
operator|(
operator|(
literal|100
operator|-
name|l1
operator|)
operator|/
literal|3
operator|)
operator|<<
literal|8
operator|)
operator||
operator|(
operator|(
literal|100
operator|-
name|r1
operator|)
operator|/
literal|3
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|SOUND_MIXER_PHONEOUT
case|:
if|if
condition|(
name|es_debug
operator|>
literal|0
condition|)
name|printf
argument_list|(
literal|"SOUND_MIXER_PHONEOUT\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|s
operator|->
name|bd_id
operator|&
name|CODEC_ID_HEADPHONEOUT
operator|)
condition|)
return|return
name|EINVAL
return|;
comment|/* fall through */
case|case
name|SOUND_MIXER_VOLUME
case|:
if|if
condition|(
name|es_debug
operator|>
literal|0
condition|)
name|printf
argument_list|(
literal|"SOUND_MIXER_VOLUME\n"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|AC97_PESSIMISTIC
if|if
condition|(
name|l1
operator|<
literal|7
operator|&&
name|r1
operator|<
literal|7
condition|)
block|{
name|wrcodec
argument_list|(
name|s
argument_list|,
name|volreg
index|[
name|ch
index|]
argument_list|,
literal|0x8000
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|l1
operator|<
literal|7
condition|)
name|l1
operator|=
literal|7
expr_stmt|;
if|if
condition|(
name|r1
operator|<
literal|7
condition|)
name|r1
operator|=
literal|7
expr_stmt|;
name|wrcodec
argument_list|(
name|s
argument_list|,
name|volreg
index|[
name|ch
index|]
argument_list|,
operator|(
operator|(
operator|(
literal|100
operator|-
name|l1
operator|)
operator|/
literal|3
operator|)
operator|<<
literal|8
operator|)
operator||
operator|(
operator|(
literal|100
operator|-
name|r1
operator|)
operator|/
literal|3
operator|)
argument_list|)
expr_stmt|;
comment|/*	  es1371_src_write(s, volreg[ch], (((100 - l1) / 3)<< 8) | ((100 - r1) / 3)); */
return|return
literal|0
return|;
else|#
directive|else
comment|/* AC97_PESSIMISTIC */
if|if
condition|(
name|l1
operator|<
literal|4
operator|&&
name|r1
operator|<
literal|4
condition|)
block|{
name|wrcodec
argument_list|(
name|s
argument_list|,
name|volreg
index|[
name|ch
index|]
argument_list|,
literal|0x8000
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|l1
operator|<
literal|4
condition|)
name|l1
operator|=
literal|4
expr_stmt|;
if|if
condition|(
name|r1
operator|<
literal|4
condition|)
name|r1
operator|=
literal|4
expr_stmt|;
name|wrcodec
argument_list|(
name|s
argument_list|,
name|volreg
index|[
name|ch
index|]
argument_list|,
operator|(
operator|(
literal|2
operator|*
operator|(
literal|100
operator|-
name|l1
operator|)
operator|/
literal|3
operator|)
operator|<<
literal|8
operator|)
operator||
operator|(
literal|2
operator|*
operator|(
literal|100
operator|-
name|r1
operator|)
operator|/
literal|3
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
endif|#
directive|endif
comment|/* AC97_PESSIMISTIC */
case|case
name|SOUND_MIXER_OGAIN
case|:
if|if
condition|(
name|es_debug
operator|>
literal|0
condition|)
name|printf
argument_list|(
literal|"SOUND_MIXER_OGAIN\n"
argument_list|)
expr_stmt|;
case|case
name|SOUND_MIXER_PHONEIN
case|:
if|if
condition|(
name|es_debug
operator|>
literal|0
condition|)
name|printf
argument_list|(
literal|"SOUND_MIXER_PHONEIN\n"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|AC97_PESSIMISTIC
name|wrcodec
argument_list|(
name|s
argument_list|,
name|volreg
index|[
name|ch
index|]
argument_list|,
operator|(
name|l1
operator|<
literal|7
operator|)
condition|?
literal|0x8000
else|:
operator|(
literal|100
operator|-
name|l1
operator|)
operator|/
literal|3
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
else|#
directive|else
comment|/* AC97_PESSIMISTIC */
name|wrcodec
argument_list|(
name|s
argument_list|,
name|volreg
index|[
name|ch
index|]
argument_list|,
operator|(
name|l1
operator|<
literal|4
operator|)
condition|?
literal|0x8000
else|:
operator|(
literal|2
operator|*
operator|(
literal|100
operator|-
name|l1
operator|)
operator|/
literal|3
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
endif|#
directive|endif
comment|/* AC97_PESSIMISTIC */
case|case
name|SOUND_MIXER_SPEAKER
case|:
name|wrcodec
argument_list|(
name|s
argument_list|,
literal|0x0a
argument_list|,
operator|(
name|l1
operator|<
literal|10
operator|)
condition|?
literal|0x8000
else|:
operator|(
operator|(
literal|100
operator|-
name|l1
operator|)
operator|/
literal|6
operator|)
operator|<<
literal|1
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|SOUND_MIXER_MIC
case|:
if|if
condition|(
name|es_debug
operator|>
literal|0
condition|)
name|printf
argument_list|(
literal|"SOUND_MIXER_MIC\n"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|AC97_PESSIMISTIC
if|if
condition|(
name|l1
operator|<
literal|11
condition|)
block|{
name|wrcodec
argument_list|(
name|s
argument_list|,
literal|0x0e
argument_list|,
literal|0x8000
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|i
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|l1
operator|>=
literal|27
condition|)
block|{
name|l1
operator|-=
literal|27
expr_stmt|;
name|i
operator|=
literal|0x40
expr_stmt|;
block|}
if|if
condition|(
name|l1
operator|<
literal|11
condition|)
name|l1
operator|=
literal|11
expr_stmt|;
name|wrcodec
argument_list|(
name|s
argument_list|,
literal|0x0e
argument_list|,
operator|(
operator|(
literal|73
operator|-
name|l1
operator|)
operator|/
literal|2
operator|)
operator||
name|i
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
else|#
directive|else
comment|/* AC97_PESSIMISTIC */
if|if
condition|(
name|l1
operator|<
literal|9
condition|)
block|{
name|wrcodec
argument_list|(
name|s
argument_list|,
literal|0x0e
argument_list|,
literal|0x8000
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|i
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|l1
operator|>=
literal|13
condition|)
block|{
name|l1
operator|-=
literal|13
expr_stmt|;
name|i
operator|=
literal|0x40
expr_stmt|;
block|}
if|if
condition|(
name|l1
operator|<
literal|9
condition|)
name|l1
operator|=
literal|9
expr_stmt|;
name|wrcodec
argument_list|(
name|s
argument_list|,
literal|0x0e
argument_list|,
operator|(
operator|(
operator|(
literal|87
operator|-
name|l1
operator|)
operator|*
literal|4
operator|)
operator|/
literal|5
operator|)
operator||
name|i
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
endif|#
directive|endif
comment|/* AC97_PESSIMISTIC */
case|case
name|SOUND_MIXER_BASS
case|:
if|if
condition|(
name|es_debug
operator|>
literal|0
condition|)
name|printf
argument_list|(
literal|"SOUND_MIXER_BASS\n"
argument_list|)
expr_stmt|;
name|val
operator|=
operator|(
operator|(
name|l1
operator|*
literal|15
operator|)
operator|/
literal|100
operator|)
operator|&
literal|0xf
expr_stmt|;
name|wrcodec
argument_list|(
name|s
argument_list|,
literal|0x08
argument_list|,
operator|(
name|rdcodec
argument_list|(
name|s
argument_list|,
literal|0x08
argument_list|)
operator|&
literal|0x00ff
operator|)
operator||
operator|(
name|val
operator|<<
literal|8
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|SOUND_MIXER_TREBLE
case|:
if|if
condition|(
name|es_debug
operator|>
literal|0
condition|)
name|printf
argument_list|(
literal|"SOUND_MIXER_TREBLE\n"
argument_list|)
expr_stmt|;
name|val
operator|=
operator|(
operator|(
name|l1
operator|*
literal|15
operator|)
operator|/
literal|100
operator|)
operator|&
literal|0xf
expr_stmt|;
name|wrcodec
argument_list|(
name|s
argument_list|,
literal|0x08
argument_list|,
operator|(
name|rdcodec
argument_list|(
name|s
argument_list|,
literal|0x08
argument_list|)
operator|&
literal|0xff00
operator|)
operator||
name|val
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
comment|/* SOUND_MIXER_RECLEV and SOUND_MIXER_IGAIN specify gain */
case|case
name|SOUND_MIXER_RECLEV
case|:
if|if
condition|(
name|es_debug
operator|>
literal|0
condition|)
name|printf
argument_list|(
literal|"SOUND_MIXER_RECLEV\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|l1
operator|<
literal|10
operator|||
name|r1
operator|<
literal|10
condition|)
block|{
name|wrcodec
argument_list|(
name|s
argument_list|,
literal|0x1c
argument_list|,
literal|0x8000
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|l1
operator|<
literal|10
condition|)
name|l1
operator|=
literal|10
expr_stmt|;
if|if
condition|(
name|r1
operator|<
literal|10
condition|)
name|r1
operator|=
literal|10
expr_stmt|;
name|wrcodec
argument_list|(
name|s
argument_list|,
literal|0x1c
argument_list|,
operator|(
operator|(
operator|(
name|l1
operator|-
literal|10
operator|)
operator|/
literal|6
operator|)
operator|<<
literal|8
operator|)
operator||
operator|(
operator|(
name|r1
operator|-
literal|10
operator|)
operator|/
literal|6
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|SOUND_MIXER_IGAIN
case|:
if|if
condition|(
name|es_debug
operator|>
literal|0
condition|)
name|printf
argument_list|(
literal|"SOUND_MIXER_IGAIN\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|s
operator|->
name|bd_id
operator|&
name|CODEC_ID_DEDICATEDMIC
operator|)
condition|)
return|return
name|EINVAL
return|;
name|wrcodec
argument_list|(
name|s
argument_list|,
literal|0x1e
argument_list|,
operator|(
name|l1
operator|<
literal|10
operator|)
condition|?
literal|0x8000
else|:
operator|(
operator|(
name|l1
operator|-
literal|10
operator|)
operator|/
literal|6
operator|)
operator|&
literal|0xf
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
default|default:
return|return
name|EINVAL
return|;
block|}
block|}
end_function

begin_comment
comment|/* --------------------------------------------------------------------- */
end_comment

begin_if
if|#
directive|if
literal|0
end_if

begin_comment
comment|/* hmm for some reason I changed this in the es1370 code ... should wrcodec handle this */
end_comment

begin_comment
comment|/* make sure to find out where this is called from */
end_comment

begin_comment
unit|static int write_codec_1371(snddev_info *d, u_char i, u_char data) { 	struct es_info *es = (struct es_info *)d->device_data; 	int		wait = 100;
comment|/* 100 msec timeout */
end_comment

begin_comment
unit|u_int32_t ret; 	do { 		if ((ret = bus_space_read_4(es->st, es->sh, ES1371_REG_STATUS)& 		      ES1371_CSTAT) == 0) { 			bus_space_write_2(es->st, es->sh, ES1371_REG_CODEC, 				((u_short)i<< ES1371_CODEC_INDEX_SHIFT) | data); 			return (0); 		} 		if(es_debug> 0) printf("write_codec ret 0x%x ret& ES1371_CSTAT 0x%x\n",ret,ret& STAT_CSTAT); 		DELAY(1000);
comment|/* tsleep(&wait, PZERO, "sndaw", hz / 1000); */
end_comment

begin_endif
unit|} while (--wait); 	printf("pcm: write_codec timed out\n"); 	return (-1); }
endif|#
directive|endif
end_endif

begin_function
name|void
name|wrcodec
parameter_list|(
name|snddev_info
modifier|*
name|s
parameter_list|,
name|unsigned
name|addr
parameter_list|,
name|unsigned
name|data
parameter_list|)
block|{
comment|/*	unsigned long flags; */
name|int
name|sl
decl_stmt|;
name|unsigned
name|t
decl_stmt|,
name|x
decl_stmt|;
name|struct
name|es_info
modifier|*
name|es
init|=
operator|(
expr|struct
name|es_info
operator|*
operator|)
name|s
operator|->
name|device_data
decl_stmt|;
if|if
condition|(
name|es_debug
operator|>
literal|0
condition|)
name|printf
argument_list|(
literal|"wrcodec addr 0x%x data 0x%x\n"
argument_list|,
name|addr
argument_list|,
name|data
argument_list|)
expr_stmt|;
for|for
control|(
name|t
operator|=
literal|0
init|;
name|t
operator|<
literal|0x1000
condition|;
name|t
operator|++
control|)
if|if
condition|(
operator|!
operator|(
name|bus_space_read_4
argument_list|(
name|es
operator|->
name|st
argument_list|,
name|es
operator|->
name|sh
argument_list|,
name|ES1371_REG_CODEC
argument_list|)
operator|&
name|CODEC_WIP
operator|)
condition|)
break|break;
comment|/*	spin_lock_irqsave(&s->lock, flags); */
name|sl
operator|=
name|spltty
argument_list|()
expr_stmt|;
comment|/* save the current state for later */
name|x
operator|=
name|bus_space_read_4
argument_list|(
name|es
operator|->
name|st
argument_list|,
name|es
operator|->
name|sh
argument_list|,
name|ES1371_REG_SMPRATE
argument_list|)
expr_stmt|;
comment|/* enable SRC state data in SRC mux */
name|bus_space_write_4
argument_list|(
name|es
operator|->
name|st
argument_list|,
name|es
operator|->
name|sh
argument_list|,
name|ES1371_REG_SMPRATE
argument_list|,
operator|(
name|es1371_wait_src_ready
argument_list|(
name|s
argument_list|)
operator|&
operator|(
name|SRC_DIS
operator||
name|SRC_DDAC1
operator||
name|SRC_DDAC2
operator||
name|SRC_DADC
operator|)
operator|)
argument_list|)
expr_stmt|;
comment|/* wait for a SAFE time to write addr/data and then do it, dammit */
for|for
control|(
name|t
operator|=
literal|0
init|;
name|t
operator|<
literal|0x1000
condition|;
name|t
operator|++
control|)
if|if
condition|(
operator|(
name|bus_space_read_4
argument_list|(
name|es
operator|->
name|st
argument_list|,
name|es
operator|->
name|sh
argument_list|,
name|ES1371_REG_SMPRATE
argument_list|)
operator|&
literal|0x00070000
operator|)
operator|==
literal|0x00010000
condition|)
break|break;
if|if
condition|(
name|es_debug
operator|>
literal|2
condition|)
name|printf
argument_list|(
literal|"one b_s_w: 0x%x 0x%x 0x%x\n"
argument_list|,
name|es
operator|->
name|sh
argument_list|,
name|ES1371_REG_CODEC
argument_list|,
operator|(
operator|(
name|addr
operator|<<
name|CODEC_POADD_SHIFT
operator|)
operator|&
name|CODEC_POADD_MASK
operator|)
operator||
operator|(
operator|(
name|data
operator|<<
name|CODEC_PODAT_SHIFT
operator|)
operator|&
name|CODEC_PODAT_MASK
operator|)
argument_list|)
expr_stmt|;
name|bus_space_write_4
argument_list|(
name|es
operator|->
name|st
argument_list|,
name|es
operator|->
name|sh
argument_list|,
name|ES1371_REG_CODEC
argument_list|,
operator|(
operator|(
name|addr
operator|<<
name|CODEC_POADD_SHIFT
operator|)
operator|&
name|CODEC_POADD_MASK
operator|)
operator||
operator|(
operator|(
name|data
operator|<<
name|CODEC_PODAT_SHIFT
operator|)
operator|&
name|CODEC_PODAT_MASK
operator|)
argument_list|)
expr_stmt|;
comment|/* restore SRC reg */
name|es1371_wait_src_ready
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|es_debug
operator|>
literal|2
condition|)
name|printf
argument_list|(
literal|"two b_s_w: 0x%x 0x%x 0x%x\n"
argument_list|,
name|es
operator|->
name|sh
argument_list|,
name|ES1371_REG_SMPRATE
argument_list|,
name|x
argument_list|)
expr_stmt|;
name|bus_space_write_4
argument_list|(
name|es
operator|->
name|st
argument_list|,
name|es
operator|->
name|sh
argument_list|,
name|ES1371_REG_SMPRATE
argument_list|,
name|x
argument_list|)
expr_stmt|;
comment|/*	spin_unlock_irqrestore(&s->lock, flags); */
name|splx
argument_list|(
name|sl
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|unsigned
name|rdcodec
parameter_list|(
name|snddev_info
modifier|*
name|s
parameter_list|,
name|unsigned
name|addr
parameter_list|)
block|{
comment|/*  unsigned long flags; */
name|int
name|sl
decl_stmt|;
name|unsigned
name|t
decl_stmt|,
name|x
decl_stmt|;
name|struct
name|es_info
modifier|*
name|es
init|=
operator|(
expr|struct
name|es_info
operator|*
operator|)
name|s
operator|->
name|device_data
decl_stmt|;
if|if
condition|(
name|es_debug
operator|>
literal|5
condition|)
name|printf
argument_list|(
literal|"rdcodec "
argument_list|)
expr_stmt|;
for|for
control|(
name|t
operator|=
literal|0
init|;
name|t
operator|<
literal|0x1000
condition|;
name|t
operator|++
control|)
if|if
condition|(
operator|!
operator|(
name|x
operator|=
name|bus_space_read_4
argument_list|(
name|es
operator|->
name|st
argument_list|,
name|es
operator|->
name|sh
argument_list|,
name|ES1371_REG_CODEC
argument_list|)
operator|&
name|CODEC_WIP
operator|)
condition|)
break|break;
name|sl
operator|=
name|spltty
argument_list|()
expr_stmt|;
comment|/* save the current state for later */
name|x
operator|=
name|bus_space_read_4
argument_list|(
name|es
operator|->
name|st
argument_list|,
name|es
operator|->
name|sh
argument_list|,
name|ES1371_REG_SMPRATE
argument_list|)
expr_stmt|;
comment|/* enable SRC state data in SRC mux */
name|bus_space_write_4
argument_list|(
name|es
operator|->
name|st
argument_list|,
name|es
operator|->
name|sh
argument_list|,
name|ES1371_REG_SMPRATE
argument_list|,
operator|(
name|es1371_wait_src_ready
argument_list|(
name|s
argument_list|)
operator|&
operator|(
name|SRC_DIS
operator||
name|SRC_DDAC1
operator||
name|SRC_DDAC2
operator||
name|SRC_DADC
operator|)
operator|)
argument_list|)
expr_stmt|;
comment|/* wait for a SAFE time to write addr/data and then do it, dammit */
for|for
control|(
name|t
operator|=
literal|0
init|;
name|t
operator|<
literal|0x1000
condition|;
name|t
operator|++
control|)
if|if
condition|(
operator|(
name|bus_space_read_4
argument_list|(
name|es
operator|->
name|st
argument_list|,
name|es
operator|->
name|sh
argument_list|,
name|ES1371_REG_SMPRATE
argument_list|)
operator|&
literal|0x00070000
operator|)
operator|==
literal|0x00010000
condition|)
break|break;
name|bus_space_write_4
argument_list|(
name|es
operator|->
name|st
argument_list|,
name|es
operator|->
name|sh
argument_list|,
name|ES1371_REG_CODEC
argument_list|,
operator|(
operator|(
name|addr
operator|<<
name|CODEC_POADD_SHIFT
operator|)
operator|&
name|CODEC_POADD_MASK
operator|)
operator||
name|CODEC_PORD
argument_list|)
expr_stmt|;
comment|/* restore SRC reg */
name|es1371_wait_src_ready
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|bus_space_write_4
argument_list|(
name|es
operator|->
name|st
argument_list|,
name|es
operator|->
name|sh
argument_list|,
name|ES1371_REG_SMPRATE
argument_list|,
name|x
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|sl
argument_list|)
expr_stmt|;
comment|/* now wait for the stinkin' data (RDY) */
for|for
control|(
name|t
operator|=
literal|0
init|;
name|t
operator|<
literal|0x1000
condition|;
name|t
operator|++
control|)
if|if
condition|(
operator|(
name|x
operator|=
name|bus_space_read_4
argument_list|(
name|es
operator|->
name|st
argument_list|,
name|es
operator|->
name|sh
argument_list|,
name|ES1371_REG_CODEC
argument_list|)
operator|)
operator|&
name|CODEC_RDY
condition|)
break|break;
if|if
condition|(
name|es_debug
operator|>
literal|5
condition|)
name|printf
argument_list|(
literal|"0x%x ret 0x%x\n"
argument_list|,
name|x
argument_list|,
operator|(
operator|(
name|x
operator|&
name|CODEC_PIDAT_MASK
operator|)
operator|>>
name|CODEC_PIDAT_SHIFT
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
name|x
operator|&
name|CODEC_PIDAT_MASK
operator|)
operator|>>
name|CODEC_PIDAT_SHIFT
operator|)
return|;
block|}
end_function

begin_function
name|int
name|mixer_ioctl_1371
parameter_list|(
name|snddev_info
modifier|*
name|s
parameter_list|,
name|u_long
name|cmd
parameter_list|,
name|caddr_t
name|data
parameter_list|,
name|int
name|fflag
parameter_list|,
name|struct
name|proc
modifier|*
name|p
parameter_list|)
block|{
name|int
name|cmdi
decl_stmt|;
name|int
name|val
decl_stmt|;
name|int
modifier|*
name|arg
init|=
operator|(
name|int
operator|*
operator|)
name|data
decl_stmt|;
name|val
operator|=
operator|*
operator|(
name|int
operator|*
operator|)
name|data
expr_stmt|;
name|cmdi
operator|=
name|cmd
operator|&
literal|0xff
expr_stmt|;
if|if
condition|(
name|es_debug
operator|>
literal|0
condition|)
name|printf
argument_list|(
literal|"mixer_ioctl_1371 cmd 0x%x cmdi 0x%x write %s read %s "
argument_list|,
operator|(
name|u_int
operator|)
name|cmd
argument_list|,
name|cmdi
argument_list|,
operator|(
operator|(
operator|(
name|cmd
operator|&
name|MIXER_WRITE
argument_list|(
literal|0
argument_list|)
operator|)
operator|==
name|MIXER_WRITE
argument_list|(
literal|0
argument_list|)
operator|)
condition|?
literal|"yes"
else|:
literal|"no"
operator|)
argument_list|,
operator|(
operator|(
operator|(
name|cmd
operator|&
name|MIXER_READ
argument_list|(
literal|0
argument_list|)
operator|)
operator|==
name|MIXER_READ
argument_list|(
literal|0
argument_list|)
operator|)
condition|?
literal|"yes"
else|:
literal|"no"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmdi
operator|==
name|OSS_GETVERSION
condition|)
block|{
name|put_user
argument_list|(
name|SOUND_VERSION
argument_list|,
operator|(
name|int
operator|*
operator|)
name|arg
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|cmd
operator|&
name|MIXER_READ
argument_list|(
literal|0
argument_list|)
operator|)
operator|==
name|MIXER_READ
argument_list|(
literal|0
argument_list|)
condition|)
block|{
switch|switch
condition|(
name|cmdi
condition|)
block|{
case|case
name|SOUND_MIXER_RECSRC
case|:
comment|/* Arg contains a bit for each recording source */
if|if
condition|(
name|es_debug
operator|>
literal|4
condition|)
name|printf
argument_list|(
literal|"mixer_ioctl_1371: SOUND_MIXER_RECSRC\n"
argument_list|)
expr_stmt|;
name|put_user
argument_list|(
name|recsrc
index|[
name|rdcodec
argument_list|(
name|s
argument_list|,
name|ES1371_REG_RECSRC
argument_list|)
operator|&
literal|7
index|]
argument_list|,
operator|(
name|int
operator|*
operator|)
name|arg
argument_list|)
expr_stmt|;
break|break;
case|case
name|SOUND_MIXER_DEVMASK
case|:
comment|/* Arg contains a bit for each supported device */
name|put_user
argument_list|(
name|SOUND_MASK_LINE
operator||
name|SOUND_MASK_CD
operator||
name|SOUND_MASK_VIDEO
operator||
name|SOUND_MASK_LINE1
operator||
name|SOUND_MASK_PCM
operator||
name|SOUND_MASK_VOLUME
operator||
name|SOUND_MASK_OGAIN
operator||
name|SOUND_MASK_PHONEIN
operator||
name|SOUND_MASK_SPEAKER
operator||
name|SOUND_MASK_MIC
operator||
name|SOUND_MASK_RECLEV
operator||
operator|(
operator|(
name|s
operator|->
name|bd_id
operator|&
name|CODEC_ID_BASSTREBLE
operator|)
condition|?
operator|(
name|SOUND_MASK_BASS
operator||
name|SOUND_MASK_TREBLE
operator|)
else|:
literal|0
operator|)
operator||
operator|(
operator|(
name|s
operator|->
name|bd_id
operator|&
name|CODEC_ID_HEADPHONEOUT
operator|)
condition|?
name|SOUND_MASK_PHONEOUT
else|:
literal|0
operator|)
operator||
operator|(
operator|(
name|s
operator|->
name|bd_id
operator|&
name|CODEC_ID_DEDICATEDMIC
operator|)
condition|?
name|SOUND_MASK_IGAIN
else|:
literal|0
operator|)
argument_list|,
operator|(
name|int
operator|*
operator|)
name|arg
argument_list|)
expr_stmt|;
if|if
condition|(
name|es_debug
operator|>
literal|4
condition|)
name|printf
argument_list|(
literal|"mixer_ioctl_1371: SOUND_MIXER_DEVMASK s->bd_id 0x%x arg 0x%x\n"
argument_list|,
name|s
operator|->
name|bd_id
argument_list|,
operator|*
name|arg
argument_list|)
expr_stmt|;
break|break;
case|case
name|SOUND_MIXER_RECMASK
case|:
comment|/* Arg contains a bit for each supported recording source */
if|if
condition|(
name|es_debug
operator|>
literal|4
condition|)
name|printf
argument_list|(
literal|"mixer_ioctl_1371: SOUND_MIXER_RECMASK\n"
argument_list|)
expr_stmt|;
name|put_user
argument_list|(
name|SOUND_MASK_MIC
operator||
name|SOUND_MASK_CD
operator||
name|SOUND_MASK_VIDEO
operator||
name|SOUND_MASK_LINE1
operator||
name|SOUND_MASK_LINE
operator||
name|SOUND_MASK_VOLUME
operator||
name|SOUND_MASK_PHONEOUT
operator||
name|SOUND_MASK_PHONEIN
argument_list|,
operator|(
name|int
operator|*
operator|)
name|arg
argument_list|)
expr_stmt|;
break|break;
case|case
name|SOUND_MIXER_STEREODEVS
case|:
comment|/* Mixer channels supporting stereo */
if|if
condition|(
name|es_debug
operator|>
literal|4
condition|)
name|printf
argument_list|(
literal|"mixer_ioctl_1371: SOUND_MIXER_STEREODEVS\n"
argument_list|)
expr_stmt|;
name|put_user
argument_list|(
name|SOUND_MASK_LINE
operator||
name|SOUND_MASK_CD
operator||
name|SOUND_MASK_VIDEO
operator||
name|SOUND_MASK_LINE1
operator||
name|SOUND_MASK_PCM
operator||
name|SOUND_MASK_VOLUME
operator||
name|SOUND_MASK_PHONEOUT
operator||
name|SOUND_MASK_RECLEV
argument_list|,
operator|(
name|int
operator|*
operator|)
name|arg
argument_list|)
expr_stmt|;
break|break;
case|case
name|SOUND_MIXER_CAPS
case|:
if|if
condition|(
name|es_debug
operator|>
literal|4
condition|)
name|printf
argument_list|(
literal|"mixer_ioctl_1371: SOUND_MIXER_CAPS\n"
argument_list|)
expr_stmt|;
name|put_user
argument_list|(
name|SOUND_CAP_EXCL_INPUT
argument_list|,
operator|(
name|int
operator|*
operator|)
name|arg
argument_list|)
expr_stmt|;
break|break;
default|default:
if|if
condition|(
name|es_debug
operator|>
literal|4
condition|)
name|printf
argument_list|(
literal|"mixer_ioctl_1371: default\n"
argument_list|)
expr_stmt|;
name|cmdi
operator|=
name|cmd
operator|&
literal|0xff
expr_stmt|;
if|if
condition|(
name|cmdi
operator|>=
name|SOUND_MIXER_NRDEVICES
condition|)
return|return
name|EINVAL
return|;
block|{
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|mixer_rdch
argument_list|(
name|s
argument_list|,
name|cmdi
argument_list|,
name|arg
argument_list|)
expr_stmt|;
if|if
condition|(
name|es_debug
operator|>
literal|0
condition|)
name|printf
argument_list|(
literal|"READ done ret 0x%x arg 0x%x\n"
argument_list|,
name|ret
argument_list|,
operator|*
name|arg
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
operator|(
name|cmd
operator|&
name|MIXER_WRITE
argument_list|(
literal|0
argument_list|)
operator|)
operator|==
name|MIXER_WRITE
argument_list|(
literal|0
argument_list|)
condition|)
block|{
if|if
condition|(
name|es_debug
operator|>
literal|0
condition|)
name|printf
argument_list|(
literal|"WRITE cmdi 0x%x data 0x%x val 0x%x sizeof(val) %d\n"
argument_list|,
name|cmdi
argument_list|,
operator|*
name|data
argument_list|,
name|val
argument_list|,
sizeof|sizeof
argument_list|(
name|val
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cmdi
condition|)
block|{
name|int
name|i
decl_stmt|;
case|case
name|SOUND_MIXER_RECSRC
case|:
comment|/* Arg contains a bit for each recording source */
comment|/*	  get_user_ret(val, (int *)arg, EFAULT); */
name|i
operator|=
name|hweight32
argument_list|(
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|es_debug
operator|>
literal|0
condition|)
name|printf
argument_list|(
literal|"SOUND_MIXER_RECSRC i: %d\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
literal|0
condition|)
return|return
literal|0
return|;
comment|/*val = mixer_recmask(s);*/
elseif|else
if|if
condition|(
name|i
operator|>
literal|1
condition|)
name|val
operator|&=
operator|~
name|recsrc
index|[
name|rdcodec
argument_list|(
name|s
argument_list|,
name|ES1371_REG_RECSRC
argument_list|)
operator|&
literal|7
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|val
operator|&
name|recsrc
index|[
name|i
index|]
condition|)
block|{
name|wrcodec
argument_list|(
name|s
argument_list|,
name|ES1371_REG_RECSRC
argument_list|,
literal|0x101
operator|*
name|i
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
return|return
literal|0
return|;
default|default:
if|if
condition|(
name|es_debug
operator|>
literal|0
condition|)
name|printf
argument_list|(
literal|"mixer_ioctl_1371 default cmdi: %d\n"
argument_list|,
name|cmdi
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmdi
operator|>=
name|SOUND_MIXER_NRDEVICES
condition|)
return|return
name|EINVAL
return|;
comment|/*	  get_user_ret(val, (int *)arg, EFAULT); */
if|if
condition|(
name|mixer_wrch
argument_list|(
name|s
argument_list|,
name|cmdi
argument_list|,
name|val
argument_list|)
condition|)
return|return
name|EINVAL
return|;
block|{
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|mixer_rdch
argument_list|(
name|s
argument_list|,
name|cmdi
argument_list|,
operator|(
name|int
operator|*
operator|)
name|arg
argument_list|)
expr_stmt|;
if|if
condition|(
name|es_debug
operator|>
literal|0
condition|)
name|printf
argument_list|(
literal|"WRITE done ret 0x%x arg 0x%x\n"
argument_list|,
name|ret
argument_list|,
operator|*
name|arg
argument_list|)
expr_stmt|;
block|}
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|u_int
name|es1371_wait_src_ready
parameter_list|(
name|snddev_info
modifier|*
name|d
parameter_list|)
block|{
name|struct
name|es_info
modifier|*
name|es
init|=
operator|(
expr|struct
name|es_info
operator|*
operator|)
name|d
operator|->
name|device_data
decl_stmt|;
name|u_int
name|t
decl_stmt|,
name|r
decl_stmt|;
for|for
control|(
name|t
operator|=
literal|0
init|;
name|t
operator|<
literal|500
condition|;
name|t
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
operator|(
name|r
operator|=
name|bus_space_read_4
argument_list|(
name|es
operator|->
name|st
argument_list|,
name|es
operator|->
name|sh
argument_list|,
name|ES1371_REG_SMPRATE
argument_list|)
operator|)
operator|&
name|ES1371_SRC_RAM_BUSY
operator|)
condition|)
block|{
return|return
name|r
return|;
block|}
comment|/* 	snd_delay(1); */
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"es1371: wait source ready timeout 0x%x [0x%x]\n"
argument_list|,
name|ES1371_REG_SMPRATE
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|u_int
name|es1371_src_read
parameter_list|(
name|snddev_info
modifier|*
name|d
parameter_list|,
name|u_short
name|reg
parameter_list|)
block|{
name|struct
name|es_info
modifier|*
name|es
init|=
operator|(
expr|struct
name|es_info
operator|*
operator|)
name|d
operator|->
name|device_data
decl_stmt|;
name|unsigned
name|int
name|r
decl_stmt|;
name|r
operator|=
name|es1371_wait_src_ready
argument_list|(
name|d
argument_list|)
operator|&
operator|(
name|ES1371_SRC_DISABLE
operator||
name|ES1371_DIS_P1
operator||
name|ES1371_DIS_P2
operator||
name|ES1371_DIS_R1
operator|)
expr_stmt|;
name|r
operator||=
name|ES1371_SRC_RAM_ADDRO
argument_list|(
name|reg
argument_list|)
expr_stmt|;
name|bus_space_write_4
argument_list|(
name|es
operator|->
name|st
argument_list|,
name|es
operator|->
name|sh
argument_list|,
name|ES1371_REG_SMPRATE
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|ES1371_SRC_RAM_DATAI
argument_list|(
name|es1371_wait_src_ready
argument_list|(
name|d
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|es1371_src_write
parameter_list|(
name|snddev_info
modifier|*
name|d
parameter_list|,
name|u_short
name|reg
parameter_list|,
name|u_short
name|data
parameter_list|)
block|{
name|struct
name|es_info
modifier|*
name|es
init|=
operator|(
expr|struct
name|es_info
operator|*
operator|)
name|d
operator|->
name|device_data
decl_stmt|;
name|u_int
name|r
decl_stmt|;
name|r
operator|=
name|es1371_wait_src_ready
argument_list|(
name|d
argument_list|)
operator|&
operator|(
name|ES1371_SRC_DISABLE
operator||
name|ES1371_DIS_P1
operator||
name|ES1371_DIS_P2
operator||
name|ES1371_DIS_R1
operator|)
expr_stmt|;
name|r
operator||=
name|ES1371_SRC_RAM_ADDRO
argument_list|(
name|reg
argument_list|)
operator||
name|ES1371_SRC_RAM_DATAO
argument_list|(
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|es_debug
operator|>
literal|1
condition|)
name|printf
argument_list|(
literal|"es1371_src_write 0x%x 0x%x\n"
argument_list|,
name|ES1371_REG_SMPRATE
argument_list|,
name|r
operator||
name|ES1371_SRC_RAM_WE
argument_list|)
expr_stmt|;
name|bus_space_write_4
argument_list|(
name|es
operator|->
name|st
argument_list|,
name|es
operator|->
name|sh
argument_list|,
name|ES1371_REG_SMPRATE
argument_list|,
name|r
operator||
name|ES1371_SRC_RAM_WE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|u_int
name|es1371_adc_rate
parameter_list|(
name|snddev_info
modifier|*
name|d
parameter_list|,
name|u_int
name|rate
parameter_list|,
name|int
name|set
parameter_list|)
block|{
name|u_int
name|n
decl_stmt|,
name|truncm
decl_stmt|,
name|freq
decl_stmt|,
name|result
decl_stmt|;
if|if
condition|(
name|rate
operator|>
literal|48000
condition|)
name|rate
operator|=
literal|48000
expr_stmt|;
if|if
condition|(
name|rate
operator|<
literal|4000
condition|)
name|rate
operator|=
literal|4000
expr_stmt|;
name|n
operator|=
name|rate
operator|/
literal|3000
expr_stmt|;
if|if
condition|(
operator|(
literal|1
operator|<<
name|n
operator|)
operator|&
operator|(
operator|(
literal|1
operator|<<
literal|15
operator|)
operator||
operator|(
literal|1
operator|<<
literal|13
operator|)
operator||
operator|(
literal|1
operator|<<
literal|11
operator|)
operator||
operator|(
literal|1
operator|<<
literal|9
operator|)
operator|)
condition|)
name|n
operator|--
expr_stmt|;
name|truncm
operator|=
operator|(
literal|21
operator|*
name|n
operator|-
literal|1
operator|)
operator||
literal|1
expr_stmt|;
name|freq
operator|=
operator|(
operator|(
literal|48000UL
operator|<<
literal|15
operator|)
operator|/
name|rate
operator|)
operator|*
name|n
expr_stmt|;
name|result
operator|=
operator|(
literal|48000UL
operator|<<
literal|15
operator|)
operator|/
operator|(
name|freq
operator|/
name|n
operator|)
expr_stmt|;
if|if
condition|(
name|set
condition|)
block|{
if|if
condition|(
name|rate
operator|>=
literal|24000
condition|)
block|{
if|if
condition|(
name|truncm
operator|>
literal|239
condition|)
name|truncm
operator|=
literal|239
expr_stmt|;
name|es1371_src_write
argument_list|(
name|d
argument_list|,
name|ES_SMPREG_ADC
operator|+
name|ES_SMPREG_TRUNC_N
argument_list|,
operator|(
operator|(
operator|(
literal|239
operator|-
name|truncm
operator|)
operator|>>
literal|1
operator|)
operator|<<
literal|9
operator|)
operator||
operator|(
name|n
operator|<<
literal|4
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|truncm
operator|>
literal|119
condition|)
name|truncm
operator|=
literal|119
expr_stmt|;
name|es1371_src_write
argument_list|(
name|d
argument_list|,
name|ES_SMPREG_ADC
operator|+
name|ES_SMPREG_TRUNC_N
argument_list|,
literal|0x8000
operator||
operator|(
operator|(
operator|(
literal|119
operator|-
name|truncm
operator|)
operator|>>
literal|1
operator|)
operator|<<
literal|9
operator|)
operator||
operator|(
name|n
operator|<<
literal|4
operator|)
argument_list|)
expr_stmt|;
block|}
name|es1371_src_write
argument_list|(
name|d
argument_list|,
name|ES_SMPREG_ADC
operator|+
name|ES_SMPREG_INT_REGS
argument_list|,
operator|(
name|es1371_src_read
argument_list|(
name|d
argument_list|,
name|ES_SMPREG_ADC
operator|+
name|ES_SMPREG_INT_REGS
argument_list|)
operator|&
literal|0x00ff
operator|)
operator||
operator|(
operator|(
name|freq
operator|>>
literal|5
operator|)
operator|&
literal|0xfc00
operator|)
argument_list|)
expr_stmt|;
name|es1371_src_write
argument_list|(
name|d
argument_list|,
name|ES_SMPREG_ADC
operator|+
name|ES_SMPREG_VFREQ_FRAC
argument_list|,
name|freq
operator|&
literal|0x7fff
argument_list|)
expr_stmt|;
name|es1371_src_write
argument_list|(
name|d
argument_list|,
name|ES_SMPREG_VOL_ADC
argument_list|,
name|n
operator|<<
literal|8
argument_list|)
expr_stmt|;
name|es1371_src_write
argument_list|(
name|d
argument_list|,
name|ES_SMPREG_VOL_ADC
operator|+
literal|1
argument_list|,
name|n
operator|<<
literal|8
argument_list|)
expr_stmt|;
block|}
return|return
name|result
return|;
block|}
end_function

begin_function
name|u_int
name|es1371_dac1_rate
parameter_list|(
name|snddev_info
modifier|*
name|d
parameter_list|,
name|u_int
name|rate
parameter_list|,
name|int
name|set
parameter_list|)
block|{
name|struct
name|es_info
modifier|*
name|es
init|=
operator|(
expr|struct
name|es_info
operator|*
operator|)
name|d
operator|->
name|device_data
decl_stmt|;
name|u_int
name|freq
decl_stmt|,
name|r
decl_stmt|,
name|result
decl_stmt|;
if|if
condition|(
name|rate
operator|>
literal|48000
condition|)
name|rate
operator|=
literal|48000
expr_stmt|;
if|if
condition|(
name|rate
operator|<
literal|4000
condition|)
name|rate
operator|=
literal|4000
expr_stmt|;
name|freq
operator|=
operator|(
name|rate
operator|<<
literal|15
operator|)
operator|/
literal|3000
expr_stmt|;
name|result
operator|=
operator|(
name|freq
operator|*
literal|3000
operator|)
operator|>>
literal|15
expr_stmt|;
if|if
condition|(
name|set
condition|)
block|{
name|r
operator|=
operator|(
name|es1371_wait_src_ready
argument_list|(
name|d
argument_list|)
operator|&
operator|(
name|ES1371_SRC_DISABLE
operator||
name|ES1371_DIS_P2
operator||
name|ES1371_DIS_R1
operator|)
operator|)
operator||
name|ES1371_DIS_P1
expr_stmt|;
name|bus_space_write_4
argument_list|(
name|es
operator|->
name|st
argument_list|,
name|es
operator|->
name|sh
argument_list|,
name|ES1371_REG_SMPRATE
argument_list|,
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|es_debug
operator|>
literal|0
condition|)
name|printf
argument_list|(
literal|"dac1_rate 0x%x\n"
argument_list|,
name|bus_space_read_4
argument_list|(
name|es
operator|->
name|st
argument_list|,
name|es
operator|->
name|sh
argument_list|,
name|ES1371_REG_SMPRATE
argument_list|)
argument_list|)
expr_stmt|;
name|es1371_src_write
argument_list|(
name|d
argument_list|,
name|ES_SMPREG_DAC1
operator|+
name|ES_SMPREG_INT_REGS
argument_list|,
operator|(
name|es1371_src_read
argument_list|(
name|d
argument_list|,
name|ES_SMPREG_DAC1
operator|+
name|ES_SMPREG_INT_REGS
argument_list|)
operator|&
literal|0x00ff
operator|)
operator||
operator|(
operator|(
name|freq
operator|>>
literal|5
operator|)
operator|&
literal|0xfc00
operator|)
argument_list|)
expr_stmt|;
name|es1371_src_write
argument_list|(
name|d
argument_list|,
name|ES_SMPREG_DAC1
operator|+
name|ES_SMPREG_VFREQ_FRAC
argument_list|,
name|freq
operator|&
literal|0x7fff
argument_list|)
expr_stmt|;
name|r
operator|=
operator|(
name|es1371_wait_src_ready
argument_list|(
name|d
argument_list|)
operator|&
operator|(
name|ES1371_SRC_DISABLE
operator||
name|ES1371_DIS_P2
operator||
name|ES1371_DIS_R1
operator|)
operator|)
expr_stmt|;
name|bus_space_write_4
argument_list|(
name|es
operator|->
name|st
argument_list|,
name|es
operator|->
name|sh
argument_list|,
name|ES1371_REG_SMPRATE
argument_list|,
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|es_debug
operator|>
literal|0
condition|)
name|printf
argument_list|(
literal|"dac1_rate 0x%x\n"
argument_list|,
name|bus_space_read_4
argument_list|(
name|es
operator|->
name|st
argument_list|,
name|es
operator|->
name|sh
argument_list|,
name|ES1371_REG_SMPRATE
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|result
return|;
block|}
end_function

begin_function
name|u_int
name|es1371_dac2_rate
parameter_list|(
name|snddev_info
modifier|*
name|d
parameter_list|,
name|u_int
name|rate
parameter_list|,
name|int
name|set
parameter_list|)
block|{
name|u_int
name|freq
decl_stmt|,
name|r
decl_stmt|,
name|result
decl_stmt|;
name|struct
name|es_info
modifier|*
name|es
init|=
operator|(
expr|struct
name|es_info
operator|*
operator|)
name|d
operator|->
name|device_data
decl_stmt|;
if|if
condition|(
name|rate
operator|>
literal|48000
condition|)
name|rate
operator|=
literal|48000
expr_stmt|;
if|if
condition|(
name|rate
operator|<
literal|4000
condition|)
name|rate
operator|=
literal|4000
expr_stmt|;
name|freq
operator|=
operator|(
name|rate
operator|<<
literal|15
operator|)
operator|/
literal|3000
expr_stmt|;
name|result
operator|=
operator|(
name|freq
operator|*
literal|3000
operator|)
operator|>>
literal|15
expr_stmt|;
if|if
condition|(
name|set
condition|)
block|{
name|r
operator|=
operator|(
name|es1371_wait_src_ready
argument_list|(
name|d
argument_list|)
operator|&
operator|(
name|ES1371_SRC_DISABLE
operator||
name|ES1371_DIS_P1
operator||
name|ES1371_DIS_R1
operator|)
operator|)
operator||
name|ES1371_DIS_P2
expr_stmt|;
name|bus_space_write_4
argument_list|(
name|es
operator|->
name|st
argument_list|,
name|es
operator|->
name|sh
argument_list|,
name|ES1371_REG_SMPRATE
argument_list|,
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|es_debug
operator|>
literal|0
condition|)
name|printf
argument_list|(
literal|"dac2_rate 0x%x\n"
argument_list|,
name|bus_space_read_4
argument_list|(
name|es
operator|->
name|st
argument_list|,
name|es
operator|->
name|sh
argument_list|,
name|ES1371_REG_SMPRATE
argument_list|)
argument_list|)
expr_stmt|;
name|es1371_src_write
argument_list|(
name|d
argument_list|,
name|ES_SMPREG_DAC2
operator|+
name|ES_SMPREG_INT_REGS
argument_list|,
operator|(
name|es1371_src_read
argument_list|(
name|d
argument_list|,
name|ES_SMPREG_DAC2
operator|+
name|ES_SMPREG_INT_REGS
argument_list|)
operator|&
literal|0x00ff
operator|)
operator||
operator|(
operator|(
name|freq
operator|>>
literal|5
operator|)
operator|&
literal|0xfc00
operator|)
argument_list|)
expr_stmt|;
name|es1371_src_write
argument_list|(
name|d
argument_list|,
name|ES_SMPREG_DAC2
operator|+
name|ES_SMPREG_VFREQ_FRAC
argument_list|,
name|freq
operator|&
literal|0x7fff
argument_list|)
expr_stmt|;
name|r
operator|=
operator|(
name|es1371_wait_src_ready
argument_list|(
name|d
argument_list|)
operator|&
operator|(
name|ES1371_SRC_DISABLE
operator||
name|ES1371_DIS_P1
operator||
name|ES1371_DIS_R1
operator|)
operator|)
expr_stmt|;
name|bus_space_write_4
argument_list|(
name|es
operator|->
name|st
argument_list|,
name|es
operator|->
name|sh
argument_list|,
name|ES1371_REG_SMPRATE
argument_list|,
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|es_debug
operator|>
literal|0
condition|)
name|printf
argument_list|(
literal|"dac2_rate 0x%x\n"
argument_list|,
name|bus_space_read_4
argument_list|(
name|es
operator|->
name|st
argument_list|,
name|es
operator|->
name|sh
argument_list|,
name|ES1371_REG_SMPRATE
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|result
return|;
block|}
end_function

end_unit


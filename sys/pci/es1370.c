begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*   * Support the ENSONIQ AudioPCI board based on the ES1370 and Codec  * AK4531.  *  * Copyright (c) 1998 by Joachim Kuebart. All rights reserved.  *   * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *   * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  *   * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in  *    the documentation and/or other materials provided with the  *    distribution.  *   * 3. All advertising materials mentioning features or use of this  *    software must display the following acknowledgement:  *	This product includes software developed by Joachim Kuebart.  *   * 4. The name of the author may not be used to endorse or promote  *    products derived from this software without specific prior  *    written permission.  *   * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESS OR IMPLIED  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE  * DISCLAIMED.	IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT,  * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES  * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR  * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,  * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED  * OF THE POSSIBILITY OF SUCH DAMAGE.  *  *	$Id$  */
end_comment

begin_include
include|#
directive|include
file|"pci.h"
end_include

begin_include
include|#
directive|include
file|"pcm.h"
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus_pio.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus_memio.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<pci/pcireg.h>
end_include

begin_include
include|#
directive|include
file|<pci/pcivar.h>
end_include

begin_include
include|#
directive|include
file|<pci/es1370_reg.h>
end_include

begin_include
include|#
directive|include
file|<i386/isa/snd/sound.h>
end_include

begin_include
include|#
directive|include
file|<i386/isa/snd/ulaw.h>
end_include

begin_if
if|#
directive|if
name|NPCI
operator|!=
literal|0
end_if

begin_comment
comment|/* -------------------------------------------------------------------- */
end_comment

begin_comment
comment|/*  * #defines  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|__alpha__
end_ifdef

begin_define
define|#
directive|define
name|IO_SPACE_MAPPING
value|ALPHA_BUS_SPACE_IO
end_define

begin_define
define|#
directive|define
name|MEM_SPACE_MAPPING
value|ALPHA_BUS_SPACE_MEM
end_define

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* not __alpha__ */
end_comment

begin_define
define|#
directive|define
name|IO_SPACE_MAPPING
value|I386_BUS_SPACE_IO
end_define

begin_define
define|#
directive|define
name|MEM_SPACE_MAPPING
value|I386_BUS_SPACE_MEM
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* not __alpha__ */
end_comment

begin_define
define|#
directive|define
name|DMA_ALIGN_THRESHOLD
value|4
end_define

begin_define
define|#
directive|define
name|DMA_ALIGN_MASK
value|(~(DMA_ALIGN_THRESHOLD - 1))
end_define

begin_define
define|#
directive|define
name|DMA_READ_THRESHOLD
value|0x200
end_define

begin_define
define|#
directive|define
name|MEM_MAP_REG
value|0x14
end_define

begin_define
define|#
directive|define
name|UNIT
parameter_list|(
name|minor
parameter_list|)
value|((minor)>> 4)
end_define

begin_define
define|#
directive|define
name|DEV
parameter_list|(
name|minor
parameter_list|)
value|((minor)& 0xf)
end_define

begin_comment
comment|/* -------------------------------------------------------------------- */
end_comment

begin_comment
comment|/*  * PCI IDs of supported chips  */
end_comment

begin_define
define|#
directive|define
name|ES1370_PCI_ID
value|0x50001274
end_define

begin_comment
comment|/* -------------------------------------------------------------------- */
end_comment

begin_comment
comment|/*  * device private data  */
end_comment

begin_struct
struct|struct
name|es_info
block|{
name|bus_space_tag_t
name|st
decl_stmt|;
name|bus_space_handle_t
name|sh
decl_stmt|;
name|bus_dma_tag_t
name|parent_dmat
decl_stmt|;
name|bus_dmamap_t
name|dmam_in
decl_stmt|,
name|dmam_out
decl_stmt|;
comment|/* Contents of board's registers */
name|u_long
name|ctrl
decl_stmt|;
name|u_long
name|sctrl
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* -------------------------------------------------------------------- */
end_comment

begin_comment
comment|/*  * prototypes  */
end_comment

begin_function_decl
specifier|static
name|void
name|dma_wrintr
parameter_list|(
name|snddev_info
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dma_rdintr
parameter_list|(
name|snddev_info
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|es_init
parameter_list|(
name|snddev_info
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|snd_callback_t
name|es_callback
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|d_open_t
name|es_dsp_open
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|d_close_t
name|es_dsp_close
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|d_ioctl_t
name|es_dsp_ioctl
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|d_read_t
name|es_dsp_read
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|d_write_t
name|es_dsp_write
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|es_intr
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|es_rdabort
parameter_list|(
name|snddev_info
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|es_rd_map
parameter_list|(
name|void
modifier|*
parameter_list|,
name|bus_dma_segment_t
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|es_wrabort
parameter_list|(
name|snddev_info
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|es_wr_map
parameter_list|(
name|void
modifier|*
parameter_list|,
name|bus_dma_segment_t
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|char
modifier|*
name|es_pci_probe
name|__P
argument_list|(
operator|(
name|pcici_t
operator|,
name|pcidi_t
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|es_pci_attach
name|__P
argument_list|(
operator|(
name|pcici_t
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|int
name|es_rd_dmaupdate
parameter_list|(
name|snddev_info
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|d_select_t
name|es_select
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|int
name|es_wr_dmaupdate
parameter_list|(
name|snddev_info
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|alloc_dmabuf
parameter_list|(
name|snddev_info
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|write_codec
parameter_list|(
name|snddev_info
modifier|*
parameter_list|,
name|u_char
parameter_list|,
name|u_char
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* -------------------------------------------------------------------- */
end_comment

begin_comment
comment|/*  * PCI driver and PCM driver method tables  */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|pci_device
name|es_pci_driver
init|=
block|{
literal|"es"
block|,
name|es_pci_probe
block|,
name|es_pci_attach
block|,
operator|&
name|nsnd
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DATA_SET
argument_list|(
name|pcidevice_set
argument_list|,
name|es_pci_driver
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|snddev_info
name|es_op_desc
init|=
block|{
literal|"ENSONIQ AudioPCI"
block|,
literal|0
block|,
comment|/* type, apparently unused */
name|NULL
block|,
comment|/* ISA probe */
name|NULL
block|,
comment|/* ISA attach */
name|es_dsp_open
block|,
name|es_dsp_close
block|,
name|es_dsp_read
block|,
name|es_dsp_write
block|,
name|es_dsp_ioctl
block|,
name|es_select
block|,
name|NULL
block|,
comment|/* Interrupt Service Routine */
name|es_callback
block|,
name|ES_BUFFSIZE
block|,
name|AFMT_FULLDUPLEX
operator||
name|AFMT_STEREO
operator||
name|AFMT_U8
operator||
name|AFMT_S16_LE
block|,
comment|/* brag :-) */
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* -------------------------------------------------------------------- */
end_comment

begin_comment
comment|/*  * The mixer interface  */
end_comment

begin_struct
specifier|static
specifier|const
struct|struct
block|{
name|unsigned
name|volidx
range|:
literal|4
decl_stmt|;
name|unsigned
name|left
range|:
literal|4
decl_stmt|;
name|unsigned
name|right
range|:
literal|4
decl_stmt|;
name|unsigned
name|stereo
range|:
literal|1
decl_stmt|;
name|unsigned
name|recmask
range|:
literal|13
decl_stmt|;
name|unsigned
name|avail
range|:
literal|1
decl_stmt|;
block|}
name|mixtable
index|[
name|SOUND_MIXER_NRDEVICES
index|]
init|=
block|{
index|[
name|SOUND_MIXER_VOLUME
index|]
operator|=
block|{
literal|0
block|,
literal|0x0
block|,
literal|0x1
block|,
literal|1
block|,
literal|0x0000
block|,
literal|1
block|}
block|,
index|[
name|SOUND_MIXER_PCM
index|]
operator|=
block|{
literal|1
block|,
literal|0x2
block|,
literal|0x3
block|,
literal|1
block|,
literal|0x0400
block|,
literal|1
block|}
block|,
index|[
name|SOUND_MIXER_SYNTH
index|]
operator|=
block|{
literal|2
block|,
literal|0x4
block|,
literal|0x5
block|,
literal|1
block|,
literal|0x0060
block|,
literal|1
block|}
block|,
index|[
name|SOUND_MIXER_CD
index|]
operator|=
block|{
literal|3
block|,
literal|0x6
block|,
literal|0x7
block|,
literal|1
block|,
literal|0x0006
block|,
literal|1
block|}
block|,
index|[
name|SOUND_MIXER_LINE
index|]
operator|=
block|{
literal|4
block|,
literal|0x8
block|,
literal|0x9
block|,
literal|1
block|,
literal|0x0018
block|,
literal|1
block|}
block|,
index|[
name|SOUND_MIXER_LINE1
index|]
operator|=
block|{
literal|5
block|,
literal|0xa
block|,
literal|0xb
block|,
literal|1
block|,
literal|0x1800
block|,
literal|1
block|}
block|,
index|[
name|SOUND_MIXER_LINE2
index|]
operator|=
block|{
literal|6
block|,
literal|0xc
block|,
literal|0x0
block|,
literal|0
block|,
literal|0x0100
block|,
literal|1
block|}
block|,
index|[
name|SOUND_MIXER_LINE3
index|]
operator|=
block|{
literal|7
block|,
literal|0xd
block|,
literal|0x0
block|,
literal|0
block|,
literal|0x0200
block|,
literal|1
block|}
block|,
index|[
name|SOUND_MIXER_MIC
index|]
operator|=
block|{
literal|8
block|,
literal|0xe
block|,
literal|0x0
block|,
literal|0
block|,
literal|0x0001
block|,
literal|1
block|}
block|,
index|[
name|SOUND_MIXER_OGAIN
index|]
operator|=
block|{
literal|9
block|,
literal|0xf
block|,
literal|0x0
block|,
literal|0
block|,
literal|0x0000
block|,
literal|1
block|}
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|mixer_ioctl
parameter_list|(
name|snddev_info
modifier|*
name|d
parameter_list|,
name|u_long
name|cmd
parameter_list|,
name|caddr_t
name|data
parameter_list|,
name|int
name|fflag
parameter_list|,
name|struct
name|proc
modifier|*
name|p
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
modifier|*
name|val
decl_stmt|,
name|ret
init|=
literal|0
decl_stmt|;
name|val
operator|=
operator|(
name|int
operator|*
operator|)
name|data
expr_stmt|;
name|i
operator|=
name|cmd
operator|&
literal|0xff
expr_stmt|;
switch|switch
condition|(
name|cmd
operator|&
name|IOC_DIRMASK
condition|)
block|{
case|case
name|IOC_IN
operator||
name|IOC_OUT
case|:
comment|/* _IOWR */
switch|switch
condition|(
name|i
condition|)
block|{
case|case
name|SOUND_MIXER_RECSRC
case|:
for|for
control|(
name|i
operator|=
name|j
operator|=
literal|0
init|;
name|i
operator|!=
name|SOUND_MIXER_NRDEVICES
condition|;
name|i
operator|++
control|)
if|if
condition|(
operator|(
operator|*
name|val
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|mixtable
index|[
name|i
index|]
operator|.
name|recmask
condition|)
operator|*
name|val
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|i
operator|)
expr_stmt|;
else|else
name|j
operator||=
name|mixtable
index|[
name|i
index|]
operator|.
name|recmask
expr_stmt|;
block|}
name|d
operator|->
name|mix_recsrc
operator|=
operator|*
name|val
expr_stmt|;
name|write_codec
argument_list|(
name|d
argument_list|,
name|CODEC_LIMIX1
argument_list|,
name|j
operator|&
literal|0x55
argument_list|)
expr_stmt|;
name|write_codec
argument_list|(
name|d
argument_list|,
name|CODEC_RIMIX1
argument_list|,
name|j
operator|&
literal|0xaa
argument_list|)
expr_stmt|;
name|write_codec
argument_list|(
name|d
argument_list|,
name|CODEC_LIMIX2
argument_list|,
operator|(
name|j
operator|>>
literal|8
operator|)
operator|&
literal|0x17
argument_list|)
expr_stmt|;
name|write_codec
argument_list|(
name|d
argument_list|,
name|CODEC_RIMIX2
argument_list|,
operator|(
name|j
operator|>>
literal|8
operator|)
operator|&
literal|0x0f
argument_list|)
expr_stmt|;
name|write_codec
argument_list|(
name|d
argument_list|,
name|CODEC_OMIX1
argument_list|,
literal|0x7f
argument_list|)
expr_stmt|;
name|write_codec
argument_list|(
name|d
argument_list|,
name|CODEC_OMIX2
argument_list|,
literal|0x3f
argument_list|)
expr_stmt|;
break|break;
default|default:
if|if
condition|(
name|i
operator|>=
name|SOUND_MIXER_NRDEVICES
operator|||
operator|!
name|mixtable
index|[
name|i
index|]
operator|.
name|avail
condition|)
name|ret
operator|=
name|EINVAL
expr_stmt|;
else|else
block|{
name|int
name|l
decl_stmt|,
name|r
decl_stmt|,
name|rl
decl_stmt|,
name|rr
decl_stmt|;
name|l
operator|=
operator|*
name|val
operator|&
literal|0xff
expr_stmt|;
if|if
condition|(
name|l
operator|>
literal|100
condition|)
name|l
operator|=
literal|100
expr_stmt|;
if|if
condition|(
name|mixtable
index|[
name|i
index|]
operator|.
name|left
operator|==
literal|0xf
condition|)
block|{
if|if
condition|(
name|l
operator|<
literal|2
condition|)
name|rl
operator|=
literal|0x80
expr_stmt|;
else|else
name|rl
operator|=
literal|7
operator|-
operator|(
name|l
operator|-
literal|2
operator|)
operator|/
literal|14
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|l
operator|<
literal|10
condition|)
name|rl
operator|=
literal|0x80
expr_stmt|;
else|else
name|rl
operator|=
literal|15
operator|-
operator|(
name|l
operator|-
literal|10
operator|)
operator|/
literal|6
expr_stmt|;
block|}
if|if
condition|(
name|mixtable
index|[
name|i
index|]
operator|.
name|stereo
condition|)
block|{
name|r
operator|=
operator|(
operator|*
name|val
operator|>>
literal|8
operator|)
operator|&
literal|0xff
expr_stmt|;
if|if
condition|(
name|r
operator|>
literal|100
condition|)
name|r
operator|=
literal|100
expr_stmt|;
if|if
condition|(
name|r
operator|<
literal|10
condition|)
name|rr
operator|=
literal|0x80
expr_stmt|;
else|else
name|rr
operator|=
literal|15
operator|-
operator|(
name|r
operator|-
literal|10
operator|)
operator|/
literal|6
expr_stmt|;
name|write_codec
argument_list|(
name|d
argument_list|,
name|mixtable
index|[
name|i
index|]
operator|.
name|right
argument_list|,
name|rr
argument_list|)
expr_stmt|;
block|}
else|else
name|r
operator|=
name|l
expr_stmt|;
name|write_codec
argument_list|(
name|d
argument_list|,
name|mixtable
index|[
name|i
index|]
operator|.
name|left
argument_list|,
name|rl
argument_list|)
expr_stmt|;
operator|*
name|val
operator|=
name|d
operator|->
name|mix_levels
index|[
name|i
index|]
operator|=
operator|(
operator|(
name|u_int
operator|)
name|r
operator|<<
literal|8
operator|)
operator||
name|l
expr_stmt|;
block|}
break|break;
block|}
break|break;
default|default:
name|ret
operator|=
name|ENOSYS
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_comment
comment|/* -------------------------------------------------------------------- */
end_comment

begin_comment
comment|/*  * File operations  */
end_comment

begin_function
specifier|static
name|int
name|es_dsp_open
parameter_list|(
name|dev_t
name|dev
parameter_list|,
name|int
name|oflags
parameter_list|,
name|int
name|devtype
parameter_list|,
name|struct
name|proc
modifier|*
name|p
parameter_list|)
block|{
name|int
name|unit
init|=
name|UNIT
argument_list|(
name|minor
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|snddev_info
modifier|*
name|d
init|=
operator|&
name|pcm_info
index|[
name|unit
index|]
decl_stmt|;
if|if
condition|(
name|d
operator|->
name|flags
operator|&
name|SND_F_BUSY
condition|)
return|return
operator|(
name|EBUSY
operator|)
return|;
name|d
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
name|d
operator|->
name|dbuf_out
operator|.
name|total
operator|=
name|d
operator|->
name|dbuf_out
operator|.
name|prev_total
operator|=
name|d
operator|->
name|dbuf_in
operator|.
name|total
operator|=
name|d
operator|->
name|dbuf_in
operator|.
name|prev_total
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|DEV
argument_list|(
name|minor
argument_list|(
name|dev
argument_list|)
argument_list|)
condition|)
block|{
case|case
name|SND_DEV_DSP16
case|:
name|d
operator|->
name|play_fmt
operator|=
name|d
operator|->
name|rec_fmt
operator|=
name|AFMT_S16_LE
expr_stmt|;
break|break;
case|case
name|SND_DEV_DSP
case|:
name|d
operator|->
name|play_fmt
operator|=
name|d
operator|->
name|rec_fmt
operator|=
name|AFMT_U8
expr_stmt|;
break|break;
case|case
name|SND_DEV_AUDIO
case|:
name|d
operator|->
name|play_fmt
operator|=
name|d
operator|->
name|rec_fmt
operator|=
name|AFMT_MU_LAW
expr_stmt|;
break|break;
default|default:
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|oflags
operator|&
name|FREAD
operator|)
operator|==
literal|0
condition|)
name|d
operator|->
name|rec_fmt
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|oflags
operator|&
name|FWRITE
operator|)
operator|==
literal|0
condition|)
name|d
operator|->
name|play_fmt
operator|=
literal|0
expr_stmt|;
name|d
operator|->
name|play_speed
operator|=
name|d
operator|->
name|rec_speed
operator|=
name|DSP_DEFAULT_SPEED
expr_stmt|;
name|d
operator|->
name|flags
operator||=
name|SND_F_BUSY
expr_stmt|;
if|if
condition|(
name|oflags
operator|&
name|O_NONBLOCK
condition|)
name|d
operator|->
name|flags
operator||=
name|SND_F_NBIO
expr_stmt|;
name|ask_init
argument_list|(
name|d
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|es_dsp_close
parameter_list|(
name|dev_t
name|dev
parameter_list|,
name|int
name|cflags
parameter_list|,
name|int
name|devtype
parameter_list|,
name|struct
name|proc
modifier|*
name|p
parameter_list|)
block|{
name|int
name|unit
init|=
name|UNIT
argument_list|(
name|minor
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|snddev_info
modifier|*
name|d
init|=
operator|&
name|pcm_info
index|[
name|unit
index|]
decl_stmt|;
name|d
operator|->
name|flags
operator|&=
operator|~
name|SND_F_BUSY
expr_stmt|;
name|es_rdabort
argument_list|(
name|d
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|es_dsp_read
parameter_list|(
name|dev_t
name|dev
parameter_list|,
name|struct
name|uio
modifier|*
name|buf
parameter_list|,
name|int
name|flag
parameter_list|)
block|{
name|int
name|l
decl_stmt|,
name|l1
decl_stmt|,
name|limit
decl_stmt|,
name|ret
init|=
literal|0
decl_stmt|,
name|unit
init|=
name|UNIT
argument_list|(
name|minor
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|long
name|s
decl_stmt|;
name|snddev_info
modifier|*
name|d
init|=
operator|&
name|pcm_info
index|[
name|unit
index|]
decl_stmt|;
name|snd_dbuf
modifier|*
name|b
init|=
operator|&
name|d
operator|->
name|dbuf_in
decl_stmt|;
if|if
condition|(
name|d
operator|->
name|flags
operator|&
name|SND_F_READING
condition|)
block|{
comment|/* This shouldn't happen and is actually silly */
name|tsleep
argument_list|(
operator|&
name|s
argument_list|,
name|PZERO
argument_list|,
literal|"sndar"
argument_list|,
name|hz
argument_list|)
expr_stmt|;
return|return
operator|(
name|EBUSY
operator|)
return|;
block|}
name|d
operator|->
name|flags
operator||=
name|SND_F_READING
expr_stmt|;
comment|/* 	 * XXX Check for SND_F_INIT. If set, wait for DMA to run empty and 	 * re-initialize the board 	 */
if|if
condition|(
name|buf
operator|->
name|uio_resid
operator|-
name|d
operator|->
name|rec_blocksize
operator|>
literal|0
condition|)
name|limit
operator|=
name|buf
operator|->
name|uio_resid
operator|-
name|d
operator|->
name|rec_blocksize
expr_stmt|;
else|else
name|limit
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
name|l
operator|=
name|buf
operator|->
name|uio_resid
operator|)
operator|>
name|limit
condition|)
block|{
name|s
operator|=
name|spltty
argument_list|()
expr_stmt|;
name|es_rd_dmaupdate
argument_list|(
name|d
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|l
operator|=
name|min
argument_list|(
name|l
argument_list|,
name|b
operator|->
name|rl
argument_list|)
operator|)
operator|==
literal|0
condition|)
block|{
name|int
name|timeout
decl_stmt|;
if|if
condition|(
name|b
operator|->
name|dl
operator|==
literal|0
condition|)
name|dma_rdintr
argument_list|(
name|d
argument_list|)
expr_stmt|;
if|if
condition|(
name|d
operator|->
name|flags
operator|&
name|SND_F_NBIO
condition|)
block|{
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|buf
operator|->
name|uio_resid
operator|-
name|limit
operator|>
name|b
operator|->
name|dl
condition|)
name|timeout
operator|=
name|hz
expr_stmt|;
else|else
name|timeout
operator|=
literal|1
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ret
operator|=
name|tsleep
argument_list|(
operator|(
name|caddr_t
operator|)
name|b
argument_list|,
name|PRIBIO
operator||
name|PCATCH
argument_list|,
literal|"dsprd"
argument_list|,
name|timeout
argument_list|)
condition|)
block|{
case|case
name|EINTR
case|:
name|es_rdabort
argument_list|(
name|d
argument_list|)
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|ERESTART
case|:
break|break;
default|default:
continue|continue;
block|}
break|break;
block|}
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|l1
operator|=
name|b
operator|->
name|bufsize
operator|-
name|b
operator|->
name|rp
operator|)
operator|<
name|l
condition|)
block|{
if|if
condition|(
name|d
operator|->
name|flags
operator|&
name|SND_F_XLAT8
condition|)
block|{
name|translate_bytes
argument_list|(
name|ulaw_dsp
argument_list|,
name|b
operator|->
name|buf
operator|+
name|b
operator|->
name|rp
argument_list|,
name|l1
argument_list|)
expr_stmt|;
name|translate_bytes
argument_list|(
name|ulaw_dsp
argument_list|,
name|b
operator|->
name|buf
argument_list|,
name|l
operator|-
name|l1
argument_list|)
expr_stmt|;
block|}
name|uiomove
argument_list|(
name|b
operator|->
name|buf
operator|+
name|b
operator|->
name|rp
argument_list|,
name|l1
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|uiomove
argument_list|(
name|b
operator|->
name|buf
argument_list|,
name|l
operator|-
name|l1
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|d
operator|->
name|flags
operator|&
name|SND_F_XLAT8
condition|)
name|translate_bytes
argument_list|(
name|ulaw_dsp
argument_list|,
name|b
operator|->
name|buf
operator|+
name|b
operator|->
name|rp
argument_list|,
name|l
argument_list|)
expr_stmt|;
name|uiomove
argument_list|(
name|b
operator|->
name|buf
operator|+
name|b
operator|->
name|rp
argument_list|,
name|l
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
name|s
operator|=
name|spltty
argument_list|()
expr_stmt|;
name|b
operator|->
name|fl
operator|+=
name|l
expr_stmt|;
name|b
operator|->
name|rl
operator|-=
name|l
expr_stmt|;
name|b
operator|->
name|rp
operator|=
operator|(
name|b
operator|->
name|rp
operator|+
name|l
operator|)
operator|%
name|b
operator|->
name|bufsize
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
name|d
operator|->
name|flags
operator|&=
operator|~
name|SND_F_READING
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|es_dsp_write
parameter_list|(
name|dev_t
name|dev
parameter_list|,
name|struct
name|uio
modifier|*
name|buf
parameter_list|,
name|int
name|flag
parameter_list|)
block|{
name|int
name|l
decl_stmt|,
name|l1
decl_stmt|,
name|ret
init|=
literal|0
decl_stmt|,
name|unit
init|=
name|UNIT
argument_list|(
name|minor
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|long
name|s
decl_stmt|;
name|snddev_info
modifier|*
name|d
init|=
operator|&
name|pcm_info
index|[
name|unit
index|]
decl_stmt|;
name|snd_dbuf
modifier|*
name|b
init|=
operator|&
name|d
operator|->
name|dbuf_out
decl_stmt|;
if|if
condition|(
name|d
operator|->
name|flags
operator|&
name|SND_F_WRITING
condition|)
block|{
comment|/* This shouldn't happen and is actually silly */
name|tsleep
argument_list|(
operator|&
name|s
argument_list|,
name|PZERO
argument_list|,
literal|"sndaw"
argument_list|,
name|hz
argument_list|)
expr_stmt|;
return|return
operator|(
name|EBUSY
operator|)
return|;
block|}
name|d
operator|->
name|flags
operator||=
name|SND_F_WRITING
expr_stmt|;
comment|/* 	 * XXX Check for SND_F_INIT. If set, wait for DMA to run empty and 	 * re-initialize the board 	 */
while|while
condition|(
operator|(
name|l
operator|=
name|buf
operator|->
name|uio_resid
operator|)
operator|!=
literal|0
condition|)
block|{
name|s
operator|=
name|spltty
argument_list|()
expr_stmt|;
name|es_wr_dmaupdate
argument_list|(
name|d
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|l
operator|=
name|min
argument_list|(
name|l
argument_list|,
name|b
operator|->
name|fl
argument_list|)
operator|)
operator|==
literal|0
condition|)
block|{
name|int
name|timeout
decl_stmt|;
if|if
condition|(
name|d
operator|->
name|flags
operator|&
name|SND_F_NBIO
condition|)
block|{
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|buf
operator|->
name|uio_resid
operator|>=
name|b
operator|->
name|dl
condition|)
name|timeout
operator|=
name|hz
expr_stmt|;
else|else
name|timeout
operator|=
literal|1
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ret
operator|=
name|tsleep
argument_list|(
operator|(
name|caddr_t
operator|)
name|b
argument_list|,
name|PRIBIO
operator||
name|PCATCH
argument_list|,
literal|"dspwr"
argument_list|,
name|timeout
argument_list|)
condition|)
block|{
case|case
name|EINTR
case|:
name|es_wrabort
argument_list|(
name|d
argument_list|)
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|ERESTART
case|:
break|break;
default|default:
continue|continue;
block|}
break|break;
block|}
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|l1
operator|=
name|b
operator|->
name|bufsize
operator|-
name|b
operator|->
name|fp
operator|)
operator|<
name|l
condition|)
block|{
name|uiomove
argument_list|(
name|b
operator|->
name|buf
operator|+
name|b
operator|->
name|fp
argument_list|,
name|l1
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|uiomove
argument_list|(
name|b
operator|->
name|buf
argument_list|,
name|l
operator|-
name|l1
argument_list|,
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|d
operator|->
name|flags
operator|&
name|SND_F_XLAT8
condition|)
block|{
name|translate_bytes
argument_list|(
name|ulaw_dsp
argument_list|,
name|b
operator|->
name|buf
operator|+
name|b
operator|->
name|fp
argument_list|,
name|l1
argument_list|)
expr_stmt|;
name|translate_bytes
argument_list|(
name|ulaw_dsp
argument_list|,
name|b
operator|->
name|buf
argument_list|,
name|l
operator|-
name|l1
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|uiomove
argument_list|(
name|b
operator|->
name|buf
operator|+
name|b
operator|->
name|fp
argument_list|,
name|l
argument_list|,
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|d
operator|->
name|flags
operator|&
name|SND_F_XLAT8
condition|)
name|translate_bytes
argument_list|(
name|ulaw_dsp
argument_list|,
name|b
operator|->
name|buf
operator|+
name|b
operator|->
name|fp
argument_list|,
name|l
argument_list|)
expr_stmt|;
block|}
name|s
operator|=
name|spltty
argument_list|()
expr_stmt|;
name|b
operator|->
name|rl
operator|+=
name|l
expr_stmt|;
name|b
operator|->
name|fl
operator|-=
name|l
expr_stmt|;
name|b
operator|->
name|fp
operator|=
operator|(
name|b
operator|->
name|fp
operator|+
name|l
operator|)
operator|%
name|b
operator|->
name|bufsize
expr_stmt|;
if|if
condition|(
name|b
operator|->
name|dl
operator|==
literal|0
condition|)
name|dma_wrintr
argument_list|(
name|d
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
name|d
operator|->
name|flags
operator|&=
operator|~
name|SND_F_WRITING
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|es_dsp_ioctl
parameter_list|(
name|dev_t
name|dev
parameter_list|,
name|u_long
name|cmd
parameter_list|,
name|caddr_t
name|data
parameter_list|,
name|int
name|fflag
parameter_list|,
name|struct
name|proc
modifier|*
name|p
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|,
name|unit
init|=
name|UNIT
argument_list|(
name|minor
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|snddev_info
modifier|*
name|d
init|=
operator|&
name|pcm_info
index|[
name|unit
index|]
decl_stmt|;
name|long
name|s
decl_stmt|;
if|if
condition|(
operator|(
name|cmd
operator|&
name|MIXER_WRITE
argument_list|(
literal|0
argument_list|)
operator|)
operator|==
name|MIXER_WRITE
argument_list|(
literal|0
argument_list|)
condition|)
return|return
name|mixer_ioctl
argument_list|(
name|d
argument_list|,
name|cmd
argument_list|,
name|data
argument_list|,
name|fflag
argument_list|,
name|p
argument_list|)
return|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|AIONWRITE
case|:
if|if
condition|(
name|d
operator|->
name|dbuf_out
operator|.
name|dl
operator|!=
literal|0
condition|)
block|{
name|s
operator|=
name|spltty
argument_list|()
expr_stmt|;
name|es_wr_dmaupdate
argument_list|(
name|d
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
operator|*
operator|(
name|int
operator|*
operator|)
name|data
operator|=
name|d
operator|->
name|dbuf_out
operator|.
name|fl
expr_stmt|;
break|break;
case|case
name|FIONREAD
case|:
if|if
condition|(
name|d
operator|->
name|dbuf_in
operator|.
name|dl
operator|!=
literal|0
condition|)
block|{
name|s
operator|=
name|spltty
argument_list|()
expr_stmt|;
name|es_rd_dmaupdate
argument_list|(
name|d
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
operator|*
operator|(
name|int
operator|*
operator|)
name|data
operator|=
name|d
operator|->
name|dbuf_in
operator|.
name|rl
expr_stmt|;
break|break;
case|case
name|SNDCTL_DSP_GETISPACE
case|:
block|{
name|audio_buf_info
modifier|*
name|a
init|=
operator|(
name|audio_buf_info
operator|*
operator|)
name|data
decl_stmt|;
name|snd_dbuf
modifier|*
name|b
init|=
operator|&
name|d
operator|->
name|dbuf_in
decl_stmt|;
if|if
condition|(
name|b
operator|->
name|dl
operator|!=
literal|0
condition|)
block|{
name|s
operator|=
name|spltty
argument_list|()
expr_stmt|;
name|es_rd_dmaupdate
argument_list|(
name|d
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
name|a
operator|->
name|bytes
operator|=
name|b
operator|->
name|fl
expr_stmt|;
name|a
operator|->
name|fragments
operator|=
name|b
operator|->
name|fl
operator|/
name|d
operator|->
name|rec_blocksize
expr_stmt|;
name|a
operator|->
name|fragstotal
operator|=
name|b
operator|->
name|bufsize
operator|/
name|d
operator|->
name|rec_blocksize
expr_stmt|;
name|a
operator|->
name|fragsize
operator|=
name|d
operator|->
name|rec_blocksize
expr_stmt|;
block|}
break|break;
case|case
name|SNDCTL_DSP_GETOSPACE
case|:
block|{
name|audio_buf_info
modifier|*
name|a
init|=
operator|(
name|audio_buf_info
operator|*
operator|)
name|data
decl_stmt|;
name|snd_dbuf
modifier|*
name|b
init|=
operator|&
name|d
operator|->
name|dbuf_out
decl_stmt|;
if|if
condition|(
name|b
operator|->
name|dl
operator|!=
literal|0
condition|)
block|{
name|s
operator|=
name|spltty
argument_list|()
expr_stmt|;
name|es_wr_dmaupdate
argument_list|(
name|d
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
name|a
operator|->
name|bytes
operator|=
name|b
operator|->
name|fl
expr_stmt|;
name|a
operator|->
name|fragments
operator|=
name|b
operator|->
name|fl
operator|/
name|d
operator|->
name|rec_blocksize
expr_stmt|;
name|a
operator|->
name|fragstotal
operator|=
name|b
operator|->
name|bufsize
operator|/
name|d
operator|->
name|play_blocksize
expr_stmt|;
name|a
operator|->
name|fragsize
operator|=
name|d
operator|->
name|play_blocksize
expr_stmt|;
block|}
break|break;
case|case
name|SNDCTL_DSP_GETIPTR
case|:
block|{
name|count_info
modifier|*
name|c
init|=
operator|(
name|count_info
operator|*
operator|)
name|data
decl_stmt|;
name|snd_dbuf
modifier|*
name|b
init|=
operator|&
name|d
operator|->
name|dbuf_in
decl_stmt|;
if|if
condition|(
name|b
operator|->
name|dl
operator|!=
literal|0
condition|)
block|{
name|s
operator|=
name|spltty
argument_list|()
expr_stmt|;
name|es_rd_dmaupdate
argument_list|(
name|d
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
name|c
operator|->
name|bytes
operator|=
name|b
operator|->
name|total
expr_stmt|;
name|c
operator|->
name|blocks
operator|=
operator|(
name|b
operator|->
name|total
operator|-
name|b
operator|->
name|prev_total
operator|+
name|d
operator|->
name|rec_blocksize
operator|-
literal|1
operator|)
operator|/
name|d
operator|->
name|rec_blocksize
expr_stmt|;
name|c
operator|->
name|ptr
operator|=
name|b
operator|->
name|fp
expr_stmt|;
name|b
operator|->
name|prev_total
operator|=
name|b
operator|->
name|total
expr_stmt|;
block|}
break|break;
case|case
name|SNDCTL_DSP_GETOPTR
case|:
block|{
name|count_info
modifier|*
name|c
init|=
operator|(
name|count_info
operator|*
operator|)
name|data
decl_stmt|;
name|snd_dbuf
modifier|*
name|b
init|=
operator|&
name|d
operator|->
name|dbuf_out
decl_stmt|;
if|if
condition|(
name|b
operator|->
name|dl
operator|!=
literal|0
condition|)
block|{
name|s
operator|=
name|spltty
argument_list|()
expr_stmt|;
name|es_wr_dmaupdate
argument_list|(
name|d
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
name|c
operator|->
name|bytes
operator|=
name|b
operator|->
name|total
expr_stmt|;
name|c
operator|->
name|blocks
operator|=
operator|(
name|b
operator|->
name|total
operator|-
name|b
operator|->
name|prev_total
operator|+
name|d
operator|->
name|play_blocksize
operator|-
literal|1
operator|)
operator|/
name|d
operator|->
name|play_blocksize
expr_stmt|;
name|c
operator|->
name|ptr
operator|=
name|b
operator|->
name|rp
expr_stmt|;
name|b
operator|->
name|prev_total
operator|=
name|b
operator|->
name|total
expr_stmt|;
block|}
break|break;
case|case
name|AIOSTOP
case|:
case|case
name|SNDCTL_DSP_RESET
case|:
case|case
name|SNDCTL_DSP_SYNC
case|:
name|ret
operator|=
name|EINVAL
expr_stmt|;
break|break;
default|default:
name|ret
operator|=
name|ENOSYS
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|es_select
parameter_list|(
name|dev_t
name|i_dev
parameter_list|,
name|int
name|rw
parameter_list|,
name|struct
name|proc
modifier|*
name|p
parameter_list|)
block|{
return|return
operator|(
name|ENOSYS
operator|)
return|;
block|}
end_function

begin_comment
comment|/* -------------------------------------------------------------------- */
end_comment

begin_comment
comment|/*  * The interrupt handler  */
end_comment

begin_function
specifier|static
name|void
name|es_intr
parameter_list|(
name|void
modifier|*
name|p
parameter_list|)
block|{
name|snddev_info
modifier|*
name|d
init|=
operator|(
name|snddev_info
operator|*
operator|)
name|p
decl_stmt|;
name|struct
name|es_info
modifier|*
name|es
init|=
operator|(
expr|struct
name|es_info
operator|*
operator|)
name|d
operator|->
name|device_data
decl_stmt|;
name|unsigned
name|intsrc
decl_stmt|,
name|sctrl
decl_stmt|;
name|intsrc
operator|=
name|bus_space_read_4
argument_list|(
name|es
operator|->
name|st
argument_list|,
name|es
operator|->
name|sh
argument_list|,
name|ES1370_REG_STATUS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|intsrc
operator|&
name|STAT_INTR
operator|)
operator|==
literal|0
condition|)
return|return;
name|sctrl
operator|=
name|es
operator|->
name|sctrl
expr_stmt|;
if|if
condition|(
name|intsrc
operator|&
name|STAT_ADC
condition|)
name|sctrl
operator|&=
operator|~
name|SCTRL_R1INTEN
expr_stmt|;
if|if
condition|(
name|intsrc
operator|&
name|STAT_DAC1
condition|)
name|sctrl
operator|&=
operator|~
name|SCTRL_P1INTEN
expr_stmt|;
if|if
condition|(
name|intsrc
operator|&
name|STAT_DAC2
condition|)
block|{
name|sctrl
operator|&=
operator|~
name|SCTRL_P2INTEN
expr_stmt|;
block|}
name|bus_space_write_4
argument_list|(
name|es
operator|->
name|st
argument_list|,
name|es
operator|->
name|sh
argument_list|,
name|ES1370_REG_SERIAL_CONTROL
argument_list|,
name|sctrl
argument_list|)
expr_stmt|;
name|bus_space_write_4
argument_list|(
name|es
operator|->
name|st
argument_list|,
name|es
operator|->
name|sh
argument_list|,
name|ES1370_REG_SERIAL_CONTROL
argument_list|,
name|es
operator|->
name|sctrl
argument_list|)
expr_stmt|;
if|if
condition|(
name|intsrc
operator|&
name|STAT_DAC2
condition|)
name|dma_wrintr
argument_list|(
name|d
argument_list|)
expr_stmt|;
if|if
condition|(
name|intsrc
operator|&
name|STAT_ADC
condition|)
name|dma_rdintr
argument_list|(
name|d
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* -------------------------------------------------------------------- */
end_comment

begin_comment
comment|/*  * DMA hassle  */
end_comment

begin_function
specifier|static
name|int
name|alloc_dmabuf
parameter_list|(
name|snddev_info
modifier|*
name|d
parameter_list|,
name|int
name|rd
parameter_list|)
block|{
name|struct
name|es_info
modifier|*
name|es
init|=
operator|(
expr|struct
name|es_info
operator|*
operator|)
name|d
operator|->
name|device_data
decl_stmt|;
name|snd_dbuf
modifier|*
name|b
init|=
name|rd
condition|?
operator|&
name|d
operator|->
name|dbuf_in
else|:
operator|&
name|d
operator|->
name|dbuf_out
decl_stmt|;
name|bus_dmamap_t
modifier|*
name|dmam
init|=
name|rd
condition|?
operator|&
name|es
operator|->
name|dmam_in
else|:
operator|&
name|es
operator|->
name|dmam_out
decl_stmt|;
if|if
condition|(
name|bus_dmamem_alloc
argument_list|(
name|es
operator|->
name|parent_dmat
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|b
operator|->
name|buf
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|,
name|dmam
argument_list|)
operator|!=
literal|0
operator|||
name|bus_dmamap_load
argument_list|(
name|es
operator|->
name|parent_dmat
argument_list|,
operator|*
name|dmam
argument_list|,
name|b
operator|->
name|buf
argument_list|,
name|d
operator|->
name|bufsize
argument_list|,
name|rd
condition|?
name|es_rd_map
else|:
name|es_wr_map
argument_list|,
name|es
argument_list|,
literal|0
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|b
operator|->
name|rp
operator|=
name|b
operator|->
name|fp
operator|=
name|b
operator|->
name|dl
operator|=
name|b
operator|->
name|rl
operator|=
literal|0
expr_stmt|;
name|b
operator|->
name|fl
operator|=
name|b
operator|->
name|bufsize
operator|=
name|d
operator|->
name|bufsize
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|es_wr_dmaupdate
parameter_list|(
name|snddev_info
modifier|*
name|d
parameter_list|)
block|{
name|struct
name|es_info
modifier|*
name|es
init|=
operator|(
expr|struct
name|es_info
operator|*
operator|)
name|d
operator|->
name|device_data
decl_stmt|;
name|unsigned
name|hwptr
decl_stmt|,
name|delta
decl_stmt|;
name|bus_space_write_4
argument_list|(
name|es
operator|->
name|st
argument_list|,
name|es
operator|->
name|sh
argument_list|,
name|ES1370_REG_MEMPAGE
argument_list|,
name|ES1370_REG_DAC2_FRAMECNT
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|hwptr
operator|=
operator|(
name|bus_space_read_4
argument_list|(
name|es
operator|->
name|st
argument_list|,
name|es
operator|->
name|sh
argument_list|,
name|ES1370_REG_DAC2_FRAMECNT
operator|&
literal|0xff
argument_list|)
operator|>>
literal|14
operator|)
operator|&
literal|0x3fffc
expr_stmt|;
name|delta
operator|=
operator|(
name|d
operator|->
name|dbuf_out
operator|.
name|bufsize
operator|+
name|hwptr
operator|-
name|d
operator|->
name|dbuf_out
operator|.
name|rp
operator|)
operator|%
name|d
operator|->
name|dbuf_out
operator|.
name|bufsize
expr_stmt|;
name|d
operator|->
name|dbuf_out
operator|.
name|rp
operator|=
name|hwptr
expr_stmt|;
name|d
operator|->
name|dbuf_out
operator|.
name|rl
operator|-=
name|delta
expr_stmt|;
name|d
operator|->
name|dbuf_out
operator|.
name|fl
operator|+=
name|delta
expr_stmt|;
name|d
operator|->
name|dbuf_out
operator|.
name|total
operator|+=
name|delta
expr_stmt|;
return|return
name|delta
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|es_rd_dmaupdate
parameter_list|(
name|snddev_info
modifier|*
name|d
parameter_list|)
block|{
name|struct
name|es_info
modifier|*
name|es
init|=
operator|(
expr|struct
name|es_info
operator|*
operator|)
name|d
operator|->
name|device_data
decl_stmt|;
name|unsigned
name|hwptr
decl_stmt|,
name|delta
decl_stmt|;
name|bus_space_write_4
argument_list|(
name|es
operator|->
name|st
argument_list|,
name|es
operator|->
name|sh
argument_list|,
name|ES1370_REG_MEMPAGE
argument_list|,
name|ES1370_REG_ADC_FRAMECNT
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|hwptr
operator|=
operator|(
name|bus_space_read_4
argument_list|(
name|es
operator|->
name|st
argument_list|,
name|es
operator|->
name|sh
argument_list|,
name|ES1370_REG_ADC_FRAMECNT
operator|&
literal|0xff
argument_list|)
operator|>>
literal|14
operator|)
operator|&
literal|0x3fffc
expr_stmt|;
name|delta
operator|=
operator|(
name|d
operator|->
name|dbuf_in
operator|.
name|bufsize
operator|+
name|hwptr
operator|-
name|d
operator|->
name|dbuf_in
operator|.
name|fp
operator|)
operator|%
name|d
operator|->
name|dbuf_in
operator|.
name|bufsize
expr_stmt|;
name|d
operator|->
name|dbuf_in
operator|.
name|fp
operator|=
name|hwptr
expr_stmt|;
name|d
operator|->
name|dbuf_in
operator|.
name|rl
operator|+=
name|delta
expr_stmt|;
name|d
operator|->
name|dbuf_in
operator|.
name|fl
operator|-=
name|delta
expr_stmt|;
name|d
operator|->
name|dbuf_in
operator|.
name|total
operator|+=
name|delta
expr_stmt|;
return|return
name|delta
return|;
block|}
end_function

begin_comment
comment|/* -------------------------------------------------------------------- */
end_comment

begin_comment
comment|/*  * Hardware  */
end_comment

begin_function
specifier|static
name|int
name|es_callback
parameter_list|(
name|snddev_info
modifier|*
name|d
parameter_list|,
name|int
name|reason
parameter_list|)
block|{
name|struct
name|es_info
modifier|*
name|es
init|=
operator|(
expr|struct
name|es_info
operator|*
operator|)
name|d
operator|->
name|device_data
decl_stmt|;
name|int
name|rd
init|=
name|reason
operator|&
name|SND_CB_RD
decl_stmt|;
switch|switch
condition|(
name|reason
operator|&
name|SND_CB_REASON_MASK
condition|)
block|{
case|case
name|SND_CB_INIT
case|:
name|es
operator|->
name|ctrl
operator|=
operator|(
name|es
operator|->
name|ctrl
operator|&
operator|~
name|CTRL_PCLKDIV
operator|)
operator||
operator|(
name|DAC2_SRTODIV
argument_list|(
name|d
operator|->
name|play_speed
argument_list|)
operator|<<
name|CTRL_SH_PCLKDIV
operator|)
expr_stmt|;
name|snd_set_blocksize
argument_list|(
name|d
argument_list|)
expr_stmt|;
name|es
operator|->
name|sctrl
operator|&=
operator|~
operator|(
name|SCTRL_R1FMT
operator||
name|SCTRL_P2FMT
operator|)
expr_stmt|;
name|d
operator|->
name|flags
operator|&=
operator|~
name|SND_F_XLAT8
expr_stmt|;
switch|switch
condition|(
name|d
operator|->
name|play_fmt
condition|)
block|{
case|case
literal|0
case|:
case|case
name|AFMT_U8
case|:
break|break;
case|case
name|AFMT_S16_LE
case|:
name|es
operator|->
name|sctrl
operator||=
name|SCTRL_P2SEB
expr_stmt|;
break|break;
case|case
name|AFMT_MU_LAW
case|:
name|d
operator|->
name|flags
operator||=
name|SND_F_XLAT8
expr_stmt|;
break|break;
default|default:
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
switch|switch
condition|(
name|d
operator|->
name|rec_fmt
condition|)
block|{
case|case
literal|0
case|:
case|case
name|AFMT_U8
case|:
break|break;
case|case
name|AFMT_S16_LE
case|:
name|es
operator|->
name|sctrl
operator||=
name|SCTRL_R1SEB
expr_stmt|;
break|break;
case|case
name|AFMT_MU_LAW
case|:
name|d
operator|->
name|flags
operator||=
name|SND_F_XLAT8
expr_stmt|;
break|break;
default|default:
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|d
operator|->
name|flags
operator|&
name|SND_F_STEREO
condition|)
name|es
operator|->
name|sctrl
operator||=
name|SCTRL_P2SMB
operator||
name|SCTRL_R1SMB
expr_stmt|;
name|bus_space_write_4
argument_list|(
name|es
operator|->
name|st
argument_list|,
name|es
operator|->
name|sh
argument_list|,
name|ES1370_REG_CONTROL
argument_list|,
name|es
operator|->
name|ctrl
argument_list|)
expr_stmt|;
name|bus_space_write_4
argument_list|(
name|es
operator|->
name|st
argument_list|,
name|es
operator|->
name|sh
argument_list|,
name|ES1370_REG_SERIAL_CONTROL
argument_list|,
name|es
operator|->
name|sctrl
argument_list|)
expr_stmt|;
break|break;
case|case
name|SND_CB_START
case|:
if|if
condition|(
name|rd
condition|)
block|{
name|es
operator|->
name|ctrl
operator||=
name|CTRL_ADC_EN
expr_stmt|;
name|es
operator|->
name|sctrl
operator|=
operator|(
name|es
operator|->
name|sctrl
operator|&
operator|~
name|SCTRL_R1LOOPSEL
operator|)
operator||
name|SCTRL_R1INTEN
expr_stmt|;
name|bus_space_write_4
argument_list|(
name|es
operator|->
name|st
argument_list|,
name|es
operator|->
name|sh
argument_list|,
name|ES1370_REG_ADC_SCOUNT
argument_list|,
name|d
operator|->
name|dbuf_in
operator|.
name|dl
operator|/
name|d
operator|->
name|dbuf_in
operator|.
name|sample_size
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|es
operator|->
name|ctrl
operator||=
name|CTRL_DAC2_EN
expr_stmt|;
name|es
operator|->
name|sctrl
operator|=
operator|(
name|es
operator|->
name|sctrl
operator|&
operator|~
operator|(
name|SCTRL_P2ENDINC
operator||
name|SCTRL_P2STINC
operator||
name|SCTRL_P2LOOPSEL
operator||
name|SCTRL_P2PAUSE
operator||
name|SCTRL_P2DACSEN
operator|)
operator|)
operator||
name|SCTRL_P2INTEN
operator||
operator|(
operator|(
operator|(
name|d
operator|->
name|play_fmt
operator|==
name|AFMT_S16_LE
operator|)
condition|?
literal|2
else|:
literal|1
operator|)
operator|<<
name|SCTRL_SH_P2ENDINC
operator|)
expr_stmt|;
name|bus_space_write_4
argument_list|(
name|es
operator|->
name|st
argument_list|,
name|es
operator|->
name|sh
argument_list|,
name|ES1370_REG_DAC2_SCOUNT
argument_list|,
name|d
operator|->
name|dbuf_out
operator|.
name|dl
operator|/
name|d
operator|->
name|dbuf_out
operator|.
name|sample_size
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
name|bus_space_write_4
argument_list|(
name|es
operator|->
name|st
argument_list|,
name|es
operator|->
name|sh
argument_list|,
name|ES1370_REG_SERIAL_CONTROL
argument_list|,
name|es
operator|->
name|sctrl
argument_list|)
expr_stmt|;
name|bus_space_write_4
argument_list|(
name|es
operator|->
name|st
argument_list|,
name|es
operator|->
name|sh
argument_list|,
name|ES1370_REG_CONTROL
argument_list|,
name|es
operator|->
name|ctrl
argument_list|)
expr_stmt|;
break|break;
case|case
name|SND_CB_ABORT
case|:
case|case
name|SND_CB_STOP
case|:
if|if
condition|(
name|rd
condition|)
name|es
operator|->
name|ctrl
operator|&=
operator|~
name|CTRL_ADC_EN
expr_stmt|;
else|else
name|es
operator|->
name|ctrl
operator|&=
operator|~
name|CTRL_DAC2_EN
expr_stmt|;
name|bus_space_write_4
argument_list|(
name|es
operator|->
name|st
argument_list|,
name|es
operator|->
name|sh
argument_list|,
name|ES1370_REG_CONTROL
argument_list|,
name|es
operator|->
name|ctrl
argument_list|)
expr_stmt|;
break|break;
default|default:
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|write_codec
parameter_list|(
name|snddev_info
modifier|*
name|d
parameter_list|,
name|u_char
name|i
parameter_list|,
name|u_char
name|data
parameter_list|)
block|{
name|struct
name|es_info
modifier|*
name|es
init|=
operator|(
expr|struct
name|es_info
operator|*
operator|)
name|d
operator|->
name|device_data
decl_stmt|;
name|int
name|wait
init|=
literal|100
decl_stmt|;
comment|/* 100 msec timeout */
do|do
block|{
if|if
condition|(
operator|(
name|bus_space_read_4
argument_list|(
name|es
operator|->
name|st
argument_list|,
name|es
operator|->
name|sh
argument_list|,
name|ES1370_REG_STATUS
argument_list|)
operator|&
name|STAT_CSTAT
operator|)
operator|==
literal|0
condition|)
block|{
name|bus_space_write_2
argument_list|(
name|es
operator|->
name|st
argument_list|,
name|es
operator|->
name|sh
argument_list|,
name|ES1370_REG_CODEC
argument_list|,
operator|(
operator|(
name|u_short
operator|)
name|i
operator|<<
name|CODEC_INDEX_SHIFT
operator|)
operator||
name|data
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
comment|/* tsleep(&wait, PZERO, "sndaw", hz / 1000); */
block|}
do|while
condition|(
operator|--
name|wait
condition|)
do|;
name|printf
argument_list|(
literal|"pcm: write_codec timed out\n"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|es_wr_map
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|segs
parameter_list|,
name|int
name|nseg
parameter_list|,
name|int
name|error
parameter_list|)
block|{
name|struct
name|es_info
modifier|*
name|es
init|=
operator|(
expr|struct
name|es_info
operator|*
operator|)
name|arg
decl_stmt|;
name|bus_space_write_1
argument_list|(
name|es
operator|->
name|st
argument_list|,
name|es
operator|->
name|sh
argument_list|,
name|ES1370_REG_MEMPAGE
argument_list|,
name|ES1370_REG_DAC2_FRAMEADR
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|bus_space_write_4
argument_list|(
name|es
operator|->
name|st
argument_list|,
name|es
operator|->
name|sh
argument_list|,
name|ES1370_REG_DAC2_FRAMEADR
operator|&
literal|0xff
argument_list|,
name|segs
operator|->
name|ds_addr
argument_list|)
expr_stmt|;
name|bus_space_write_4
argument_list|(
name|es
operator|->
name|st
argument_list|,
name|es
operator|->
name|sh
argument_list|,
name|ES1370_REG_DAC2_FRAMECNT
operator|&
literal|0xff
argument_list|,
operator|(
name|segs
operator|->
name|ds_len
operator|>>
literal|2
operator|)
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|es_rd_map
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|segs
parameter_list|,
name|int
name|nseg
parameter_list|,
name|int
name|error
parameter_list|)
block|{
name|struct
name|es_info
modifier|*
name|es
init|=
operator|(
expr|struct
name|es_info
operator|*
operator|)
name|arg
decl_stmt|;
name|bus_space_write_1
argument_list|(
name|es
operator|->
name|st
argument_list|,
name|es
operator|->
name|sh
argument_list|,
name|ES1370_REG_MEMPAGE
argument_list|,
name|ES1370_REG_ADC_FRAMEADR
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|bus_space_write_4
argument_list|(
name|es
operator|->
name|st
argument_list|,
name|es
operator|->
name|sh
argument_list|,
name|ES1370_REG_ADC_FRAMEADR
operator|&
literal|0xff
argument_list|,
name|segs
operator|->
name|ds_addr
argument_list|)
expr_stmt|;
name|bus_space_write_4
argument_list|(
name|es
operator|->
name|st
argument_list|,
name|es
operator|->
name|sh
argument_list|,
name|ES1370_REG_ADC_FRAMECNT
operator|&
literal|0xff
argument_list|,
operator|(
name|segs
operator|->
name|ds_len
operator|>>
literal|2
operator|)
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dma_wrintr
parameter_list|(
name|snddev_info
modifier|*
name|d
parameter_list|)
block|{
name|snd_dbuf
modifier|*
name|b
init|=
operator|&
name|d
operator|->
name|dbuf_out
decl_stmt|;
comment|/* 	 * According to Linux driver: 	 * dmaupdate() 	 * Bei underrun error++ 	 * wake_up(dac2.wait) 	 */
if|if
condition|(
name|b
operator|->
name|dl
operator|!=
literal|0
condition|)
block|{
name|es_wr_dmaupdate
argument_list|(
name|d
argument_list|)
expr_stmt|;
name|wakeup
argument_list|(
name|b
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|b
operator|->
name|rl
operator|>=
name|DMA_ALIGN_THRESHOLD
operator|&&
operator|!
operator|(
name|d
operator|->
name|flags
operator|&
name|SND_F_ABORTING
operator|)
condition|)
block|{
name|int
name|l
init|=
name|min
argument_list|(
name|b
operator|->
name|rl
argument_list|,
name|d
operator|->
name|play_blocksize
argument_list|)
decl_stmt|;
name|l
operator|&=
name|DMA_ALIGN_MASK
expr_stmt|;
if|if
condition|(
name|l
operator|!=
name|b
operator|->
name|dl
condition|)
block|{
if|if
condition|(
name|b
operator|->
name|dl
operator|!=
literal|0
condition|)
block|{
name|d
operator|->
name|callback
argument_list|(
name|d
argument_list|,
name|SND_CB_WR
operator||
name|SND_CB_STOP
argument_list|)
expr_stmt|;
name|es_wr_dmaupdate
argument_list|(
name|d
argument_list|)
expr_stmt|;
name|l
operator|=
name|min
argument_list|(
name|b
operator|->
name|rl
argument_list|,
name|d
operator|->
name|play_blocksize
argument_list|)
expr_stmt|;
name|l
operator|&=
name|DMA_ALIGN_MASK
expr_stmt|;
block|}
name|b
operator|->
name|dl
operator|=
name|l
expr_stmt|;
name|d
operator|->
name|callback
argument_list|(
name|d
argument_list|,
name|SND_CB_WR
operator||
name|SND_CB_START
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|b
operator|->
name|dl
operator|!=
literal|0
condition|)
block|{
name|b
operator|->
name|dl
operator|=
literal|0
expr_stmt|;
name|d
operator|->
name|callback
argument_list|(
name|d
argument_list|,
name|SND_CB_WR
operator||
name|SND_CB_STOP
argument_list|)
expr_stmt|;
name|es_wr_dmaupdate
argument_list|(
name|d
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|dma_rdintr
parameter_list|(
name|snddev_info
modifier|*
name|d
parameter_list|)
block|{
name|snd_dbuf
modifier|*
name|b
init|=
operator|&
name|d
operator|->
name|dbuf_in
decl_stmt|;
if|if
condition|(
name|b
operator|->
name|dl
operator|!=
literal|0
condition|)
block|{
name|es_rd_dmaupdate
argument_list|(
name|d
argument_list|)
expr_stmt|;
name|wakeup
argument_list|(
name|b
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|b
operator|->
name|fl
operator|>=
name|DMA_READ_THRESHOLD
operator|&&
operator|!
operator|(
name|d
operator|->
name|flags
operator|&
name|SND_F_ABORTING
operator|)
condition|)
block|{
name|int
name|l
init|=
name|min
argument_list|(
name|b
operator|->
name|fl
argument_list|,
name|d
operator|->
name|rec_blocksize
argument_list|)
decl_stmt|;
name|l
operator|&=
name|DMA_ALIGN_MASK
expr_stmt|;
if|if
condition|(
name|l
operator|!=
name|b
operator|->
name|dl
condition|)
block|{
if|if
condition|(
name|b
operator|->
name|dl
operator|!=
literal|0
condition|)
block|{
name|d
operator|->
name|callback
argument_list|(
name|d
argument_list|,
name|SND_CB_RD
operator||
name|SND_CB_STOP
argument_list|)
expr_stmt|;
name|es_rd_dmaupdate
argument_list|(
name|d
argument_list|)
expr_stmt|;
name|l
operator|=
name|min
argument_list|(
name|b
operator|->
name|fl
argument_list|,
name|d
operator|->
name|rec_blocksize
argument_list|)
expr_stmt|;
name|l
operator|&=
name|DMA_ALIGN_MASK
expr_stmt|;
block|}
name|b
operator|->
name|dl
operator|=
name|l
expr_stmt|;
name|d
operator|->
name|callback
argument_list|(
name|d
argument_list|,
name|SND_CB_RD
operator||
name|SND_CB_START
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|b
operator|->
name|dl
operator|!=
literal|0
condition|)
block|{
name|b
operator|->
name|dl
operator|=
literal|0
expr_stmt|;
name|d
operator|->
name|callback
argument_list|(
name|d
argument_list|,
name|SND_CB_RD
operator||
name|SND_CB_STOP
argument_list|)
expr_stmt|;
name|es_rd_dmaupdate
argument_list|(
name|d
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|es_wrabort
parameter_list|(
name|snddev_info
modifier|*
name|d
parameter_list|)
block|{
name|snd_dbuf
modifier|*
name|b
init|=
operator|&
name|d
operator|->
name|dbuf_out
decl_stmt|;
name|long
name|s
decl_stmt|;
name|int
name|missing
decl_stmt|;
name|s
operator|=
name|spltty
argument_list|()
expr_stmt|;
if|if
condition|(
name|b
operator|->
name|dl
operator|!=
literal|0
condition|)
block|{
name|wakeup
argument_list|(
name|b
argument_list|)
expr_stmt|;
name|b
operator|->
name|dl
operator|=
literal|0
expr_stmt|;
name|d
operator|->
name|callback
argument_list|(
name|d
argument_list|,
name|SND_CB_WR
operator||
name|SND_CB_ABORT
argument_list|)
expr_stmt|;
block|}
name|es_wr_dmaupdate
argument_list|(
name|d
argument_list|)
expr_stmt|;
name|missing
operator|=
name|b
operator|->
name|rl
expr_stmt|;
name|b
operator|->
name|rl
operator|=
literal|0
expr_stmt|;
name|b
operator|->
name|fp
operator|=
name|b
operator|->
name|rp
expr_stmt|;
name|b
operator|->
name|fl
operator|=
name|b
operator|->
name|bufsize
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
name|missing
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|es_rdabort
parameter_list|(
name|snddev_info
modifier|*
name|d
parameter_list|)
block|{
name|snd_dbuf
modifier|*
name|b
init|=
operator|&
name|d
operator|->
name|dbuf_in
decl_stmt|;
name|long
name|s
decl_stmt|;
name|int
name|missing
decl_stmt|;
name|s
operator|=
name|spltty
argument_list|()
expr_stmt|;
if|if
condition|(
name|b
operator|->
name|dl
operator|!=
literal|0
condition|)
block|{
name|wakeup
argument_list|(
name|b
argument_list|)
expr_stmt|;
name|b
operator|->
name|dl
operator|=
literal|0
expr_stmt|;
name|d
operator|->
name|callback
argument_list|(
name|d
argument_list|,
name|SND_CB_RD
operator||
name|SND_CB_ABORT
argument_list|)
expr_stmt|;
name|es_rd_dmaupdate
argument_list|(
name|d
argument_list|)
expr_stmt|;
block|}
name|missing
operator|=
name|b
operator|->
name|rl
expr_stmt|;
name|b
operator|->
name|rl
operator|=
literal|0
expr_stmt|;
name|b
operator|->
name|fp
operator|=
name|b
operator|->
name|rp
expr_stmt|;
name|b
operator|->
name|fl
operator|=
name|b
operator|->
name|bufsize
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
name|missing
return|;
block|}
end_function

begin_comment
comment|/* -------------------------------------------------------------------- */
end_comment

begin_comment
comment|/*  * Probe and attach the card  */
end_comment

begin_function
specifier|static
name|int
name|es_init
parameter_list|(
name|snddev_info
modifier|*
name|d
parameter_list|)
block|{
name|struct
name|es_info
modifier|*
name|es
init|=
operator|(
expr|struct
name|es_info
operator|*
operator|)
name|d
operator|->
name|device_data
decl_stmt|;
name|u_int
name|i
decl_stmt|;
name|es
operator|->
name|ctrl
operator|=
name|CTRL_CDC_EN
operator||
name|CTRL_SERR_DIS
operator||
operator|(
name|DAC2_SRTODIV
argument_list|(
name|DSP_DEFAULT_SPEED
argument_list|)
operator|<<
name|CTRL_SH_PCLKDIV
operator|)
expr_stmt|;
name|bus_space_write_4
argument_list|(
name|es
operator|->
name|st
argument_list|,
name|es
operator|->
name|sh
argument_list|,
name|ES1370_REG_CONTROL
argument_list|,
name|es
operator|->
name|ctrl
argument_list|)
expr_stmt|;
name|es
operator|->
name|sctrl
operator|=
literal|0
expr_stmt|;
name|bus_space_write_4
argument_list|(
name|es
operator|->
name|st
argument_list|,
name|es
operator|->
name|sh
argument_list|,
name|ES1370_REG_SERIAL_CONTROL
argument_list|,
name|es
operator|->
name|sctrl
argument_list|)
expr_stmt|;
name|write_codec
argument_list|(
name|d
argument_list|,
name|CODEC_RES_PD
argument_list|,
literal|3
argument_list|)
expr_stmt|;
comment|/* No RST, PD */
name|write_codec
argument_list|(
name|d
argument_list|,
name|CODEC_CSEL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* CODEC ADC and CODEC DAC use 					 * {LR,B}CLK2 and run off the LRCLK2 					 * PLL; program DAC_SYNC=0!  */
name|write_codec
argument_list|(
name|d
argument_list|,
name|CODEC_ADSEL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Recording source is mixer */
name|write_codec
argument_list|(
name|d
argument_list|,
name|CODEC_MGAIN
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* MIC amp is 0db */
name|i
operator|=
name|SOUND_MASK_MIC
expr_stmt|;
name|mixer_ioctl
argument_list|(
name|d
argument_list|,
name|SOUND_MIXER_WRITE_RECSRC
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|i
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
name|mixer_ioctl
argument_list|(
name|d
argument_list|,
name|SOUND_MIXER_WRITE_VOLUME
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|i
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|mixer_ioctl
argument_list|(
name|d
argument_list|,
name|SOUND_MIXER_WRITE_PCM
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|i
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|mixer_ioctl
argument_list|(
name|d
argument_list|,
name|SOUND_MIXER_WRITE_SYNTH
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|i
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|mixer_ioctl
argument_list|(
name|d
argument_list|,
name|SOUND_MIXER_WRITE_CD
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|i
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|mixer_ioctl
argument_list|(
name|d
argument_list|,
name|SOUND_MIXER_WRITE_LINE
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|i
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|mixer_ioctl
argument_list|(
name|d
argument_list|,
name|SOUND_MIXER_WRITE_LINE1
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|i
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|mixer_ioctl
argument_list|(
name|d
argument_list|,
name|SOUND_MIXER_WRITE_LINE2
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|i
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|mixer_ioctl
argument_list|(
name|d
argument_list|,
name|SOUND_MIXER_WRITE_LINE3
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|i
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|mixer_ioctl
argument_list|(
name|d
argument_list|,
name|SOUND_MIXER_WRITE_MIC
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|i
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|es_pci_probe
parameter_list|(
name|pcici_t
name|tag
parameter_list|,
name|pcidi_t
name|type
parameter_list|)
block|{
if|if
condition|(
name|type
operator|==
name|ES1370_PCI_ID
condition|)
return|return
operator|(
literal|"AudioPCI ES1370"
operator|)
return|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|es_pci_attach
parameter_list|(
name|pcici_t
name|config_id
parameter_list|,
name|int
name|unit
parameter_list|)
block|{
name|snddev_info
modifier|*
name|d
decl_stmt|;
name|u_int32_t
name|data
decl_stmt|;
name|struct
name|es_info
modifier|*
name|es
decl_stmt|;
name|pci_port_t
name|io_port
decl_stmt|;
name|int
name|i
decl_stmt|,
name|mapped
decl_stmt|;
name|vm_offset_t
name|vaddr
decl_stmt|,
name|paddr
decl_stmt|;
if|if
condition|(
name|unit
operator|>
name|NPCM_MAX
condition|)
return|return;
name|d
operator|=
operator|&
name|pcm_info
index|[
name|unit
index|]
expr_stmt|;
operator|*
name|d
operator|=
name|es_op_desc
expr_stmt|;
if|if
condition|(
operator|(
name|es
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|es
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"pcm%d: cannot allocate softc\n"
argument_list|,
name|unit
argument_list|)
expr_stmt|;
return|return;
block|}
name|bzero
argument_list|(
name|es
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|es
argument_list|)
argument_list|)
expr_stmt|;
name|d
operator|->
name|device_data
operator|=
name|es
expr_stmt|;
name|vaddr
operator|=
name|paddr
operator|=
name|NULL
expr_stmt|;
name|mapped
operator|=
literal|0
expr_stmt|;
name|data
operator|=
name|pci_conf_read
argument_list|(
name|config_id
argument_list|,
name|PCI_COMMAND_STATUS_REG
argument_list|)
expr_stmt|;
if|if
condition|(
name|mapped
operator|==
literal|0
operator|&&
operator|(
name|data
operator|&
name|PCI_COMMAND_MEM_ENABLE
operator|)
condition|)
block|{
if|if
condition|(
name|pci_map_mem
argument_list|(
name|config_id
argument_list|,
name|MEM_MAP_REG
argument_list|,
operator|&
name|vaddr
argument_list|,
operator|&
name|paddr
argument_list|)
condition|)
block|{
name|es
operator|->
name|st
operator|=
name|MEM_SPACE_MAPPING
expr_stmt|;
name|es
operator|->
name|sh
operator|=
name|vaddr
expr_stmt|;
name|mapped
operator|++
expr_stmt|;
block|}
block|}
if|if
condition|(
name|mapped
operator|==
literal|0
operator|&&
operator|(
name|data
operator|&
name|PCI_COMMAND_IO_ENABLE
operator|)
condition|)
block|{
if|if
condition|(
name|pci_map_port
argument_list|(
name|config_id
argument_list|,
name|PCI_MAP_REG_START
argument_list|,
operator|&
name|io_port
argument_list|)
condition|)
block|{
name|es
operator|->
name|st
operator|=
name|IO_SPACE_MAPPING
expr_stmt|;
name|es
operator|->
name|sh
operator|=
name|io_port
expr_stmt|;
name|mapped
operator|++
expr_stmt|;
block|}
block|}
if|if
condition|(
name|mapped
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"pcm%d: unable to map any ports\n"
argument_list|,
name|unit
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|es
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
return|return;
block|}
name|printf
argument_list|(
literal|"pcm%d: using %s space register mapping at %#x\n"
argument_list|,
name|unit
argument_list|,
name|es
operator|->
name|st
operator|==
name|IO_SPACE_MAPPING
condition|?
literal|"I/O"
else|:
literal|"Memory"
argument_list|,
name|es
operator|->
name|sh
argument_list|)
expr_stmt|;
name|d
operator|->
name|io_base
operator|=
name|es
operator|->
name|sh
expr_stmt|;
name|d
operator|->
name|mix_devs
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|!=
name|SOUND_MIXER_NRDEVICES
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|mixtable
index|[
name|i
index|]
operator|.
name|avail
condition|)
name|d
operator|->
name|mix_devs
operator||=
operator|(
literal|1
operator|<<
name|i
operator|)
expr_stmt|;
name|d
operator|->
name|mix_rec_devs
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|!=
name|SOUND_MIXER_NRDEVICES
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|mixtable
index|[
name|i
index|]
operator|.
name|recmask
condition|)
name|d
operator|->
name|mix_rec_devs
operator||=
operator|(
literal|1
operator|<<
name|i
operator|)
expr_stmt|;
if|if
condition|(
name|es_init
argument_list|(
name|d
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"pcm%d: unable to initialize the card\n"
argument_list|,
name|unit
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|es
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|d
operator|->
name|io_base
operator|=
literal|0
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|pci_map_int
argument_list|(
name|config_id
argument_list|,
name|es_intr
argument_list|,
name|d
argument_list|,
operator|&
name|tty_imask
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"pcm%d: unable to map interrupt\n"
argument_list|,
name|unit
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|es
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|d
operator|->
name|io_base
operator|=
literal|0
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|bus_dma_tag_create
argument_list|(
comment|/*parent*/
name|NULL
argument_list|,
comment|/*alignment*/
literal|2
argument_list|,
comment|/*boundary*/
literal|0
argument_list|,
comment|/*lowaddr*/
name|BUS_SPACE_MAXADDR_32BIT
argument_list|,
comment|/*highaddr*/
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/*filter*/
name|NULL
argument_list|,
comment|/*filterarg*/
name|NULL
argument_list|,
comment|/*maxsize*/
name|d
operator|->
name|bufsize
argument_list|,
comment|/*nsegments*/
literal|1
argument_list|,
comment|/*maxsegz*/
literal|0x3ffff
argument_list|,
comment|/*flags*/
literal|0
argument_list|,
operator|&
name|es
operator|->
name|parent_dmat
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"pcm%d: unable to create dma tag\n"
argument_list|,
name|unit
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|es
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|d
operator|->
name|io_base
operator|=
literal|0
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|alloc_dmabuf
argument_list|(
name|d
argument_list|,
literal|0
argument_list|)
operator|==
operator|-
literal|1
operator|||
name|alloc_dmabuf
argument_list|(
name|d
argument_list|,
literal|1
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"pcm%d: unable to allocate dma buffers\n"
argument_list|,
name|unit
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|es
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|d
operator|->
name|io_base
operator|=
literal|0
expr_stmt|;
return|return;
block|}
name|pcminit
argument_list|(
name|d
argument_list|,
name|unit
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* NPCI != 0 */
end_comment

end_unit


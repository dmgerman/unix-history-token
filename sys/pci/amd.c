begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  *********************************************************************  *	FILE NAME  : amd.c  *	     BY    : C.L. Huang 	(ching@tekram.com.tw)  *		     Erich Chen     (erich@tekram.com.tw)  *	Description: Device Driver for the amd53c974 PCI Bus Master  *		     SCSI Host adapter found on cards such as  *		     the Tekram DC-390(T).  * (C)Copyright 1995-1999 Tekram Technology Co., Ltd.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. The name of the author may not be used to endorse or promote products  *    derived from this software without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  *********************************************************************  * $FreeBSD$  */
end_comment

begin_comment
comment|/*  *********************************************************************  *	HISTORY:  *  *	REV#	DATE	NAME    	DESCRIPTION  *	1.00  07/02/96	CLH	        First release for RELEASE-2.1.0  *	1.01  08/20/96	CLH	        Update for RELEASE-2.1.5  *	1.02  11/06/96	CLH	        Fixed more than 1 LUN scanning  *	1.03  12/20/96	CLH	        Modify to support 2.2-ALPHA  *	1.04  12/26/97	CLH	        Modify to support RELEASE-2.2.5  *	1.05  01/01/99  ERICH CHEN	Modify to support RELEASE-3.0.x (CAM)  *********************************************************************  */
end_comment

begin_comment
comment|/* #define AMD_DEBUG0           */
end_comment

begin_comment
comment|/* #define AMD_DEBUG_SCSI_PHASE */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<sys/buf.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm.h>
end_include

begin_include
include|#
directive|include
file|<vm/pmap.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus_pio.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/clock.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<cam/cam.h>
end_include

begin_include
include|#
directive|include
file|<cam/cam_ccb.h>
end_include

begin_include
include|#
directive|include
file|<cam/cam_sim.h>
end_include

begin_include
include|#
directive|include
file|<cam/cam_xpt_sim.h>
end_include

begin_include
include|#
directive|include
file|<cam/cam_debug.h>
end_include

begin_include
include|#
directive|include
file|<cam/scsi/scsi_all.h>
end_include

begin_include
include|#
directive|include
file|<cam/scsi/scsi_message.h>
end_include

begin_include
include|#
directive|include
file|<pci/pcivar.h>
end_include

begin_include
include|#
directive|include
file|<pci/pcireg.h>
end_include

begin_include
include|#
directive|include
file|<pci/amd.h>
end_include

begin_define
define|#
directive|define
name|PCI_DEVICE_ID_AMD53C974
value|0x20201022ul
end_define

begin_define
define|#
directive|define
name|PCI_BASE_ADDR0
value|0x10
end_define

begin_typedef
typedef|typedef
name|u_int
function_decl|(
name|phase_handler_t
function_decl|)
parameter_list|(
name|struct
name|amd_softc
modifier|*
parameter_list|,
name|struct
name|amd_srb
modifier|*
parameter_list|,
name|u_int
parameter_list|)
function_decl|;
end_typedef

begin_typedef
typedef|typedef
name|phase_handler_t
modifier|*
name|phase_handler_func_t
typedef|;
end_typedef

begin_function_decl
specifier|static
name|void
name|amd_intr
parameter_list|(
name|void
modifier|*
name|vamd
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|amdstart
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|,
name|struct
name|amd_srb
modifier|*
name|pSRB
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|phase_handler_t
name|amd_NopPhase
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|phase_handler_t
name|amd_DataOutPhase0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|phase_handler_t
name|amd_DataInPhase0
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|amd_CommandPhase0
value|amd_NopPhase
end_define

begin_decl_stmt
specifier|static
name|phase_handler_t
name|amd_StatusPhase0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|phase_handler_t
name|amd_MsgOutPhase0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|phase_handler_t
name|amd_MsgInPhase0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|phase_handler_t
name|amd_DataOutPhase1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|phase_handler_t
name|amd_DataInPhase1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|phase_handler_t
name|amd_CommandPhase1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|phase_handler_t
name|amd_StatusPhase1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|phase_handler_t
name|amd_MsgOutPhase1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|phase_handler_t
name|amd_MsgInPhase1
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|amdsetupcommand
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|,
name|struct
name|amd_srb
modifier|*
name|srb
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|amdparsemsg
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|amdhandlemsgreject
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|amdconstructsdtr
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|,
name|u_int
name|period
parameter_list|,
name|u_int
name|offset
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u_int
name|amdfindclockrate
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|,
name|u_int
modifier|*
name|period
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|amdsentmsg
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|,
name|u_int
name|msgtype
parameter_list|,
name|int
name|full
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|DataIO_Comm
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|,
name|struct
name|amd_srb
modifier|*
name|pSRB
parameter_list|,
name|u_int
name|dir
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|amd_Disconnect
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|amd_Reselect
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|SRBdone
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|,
name|struct
name|amd_srb
modifier|*
name|pSRB
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|amd_ScsiRstDetect
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|amd_ResetSCSIBus
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|RequestSense
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|,
name|struct
name|amd_srb
modifier|*
name|pSRB
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|amd_InvalidCmd
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|amd_timeout
parameter_list|(
name|void
modifier|*
name|arg1
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|amd_reset
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u_int8_t
modifier|*
name|phystovirt
parameter_list|(
name|struct
name|amd_srb
modifier|*
name|pSRB
parameter_list|,
name|u_int32_t
name|xferCnt
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|amd_linkSRB
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|amd_init
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|amd_load_defaults
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|amd_load_eeprom_or_defaults
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|amd_EEpromInDO
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u_int16_t
name|EEpromGetData1
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|amd_EnDisableCE
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|,
name|int
name|mode
parameter_list|,
name|int
modifier|*
name|regval
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|amd_EEpromOutDI
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|,
name|int
modifier|*
name|regval
parameter_list|,
name|int
name|Carry
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|amd_Prepare
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|,
name|int
modifier|*
name|regval
parameter_list|,
name|u_int8_t
name|EEpromCmd
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|amd_ReadEEprom
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|amd_probe
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|amd_attach
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|amdcompletematch
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|,
name|target_id_t
name|target
parameter_list|,
name|lun_id_t
name|lun
parameter_list|,
name|u_int
name|tag
parameter_list|,
name|struct
name|srb_queue
modifier|*
name|queue
parameter_list|,
name|cam_status
name|status
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|amdsetsync
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|,
name|u_int
name|target
parameter_list|,
name|u_int
name|clockrate
parameter_list|,
name|u_int
name|period
parameter_list|,
name|u_int
name|offset
parameter_list|,
name|u_int
name|type
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|amdsettags
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|,
name|u_int
name|target
parameter_list|,
name|int
name|tagenb
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|__inline
name|void
name|amd_clear_msg_state
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|__inline
name|void
name|amd_clear_msg_state
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|)
block|{
name|amd
operator|->
name|msgout_len
operator|=
literal|0
expr_stmt|;
name|amd
operator|->
name|msgout_index
operator|=
literal|0
expr_stmt|;
name|amd
operator|->
name|msgin_index
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_comment
comment|/* CAM SIM entry points */
end_comment

begin_define
define|#
directive|define
name|ccb_srb_ptr
value|spriv_ptr0
end_define

begin_define
define|#
directive|define
name|ccb_amd_ptr
value|spriv_ptr1
end_define

begin_function_decl
specifier|static
name|void
name|amd_action
parameter_list|(
name|struct
name|cam_sim
modifier|*
name|sim
parameter_list|,
name|union
name|ccb
modifier|*
name|ccb
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|amd_poll
parameter_list|(
name|struct
name|cam_sim
modifier|*
name|sim
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * State engine function tables indexed by SCSI phase number  */
end_comment

begin_decl_stmt
name|phase_handler_func_t
name|amd_SCSI_phase0
index|[]
init|=
block|{
name|amd_DataOutPhase0
block|,
name|amd_DataInPhase0
block|,
name|amd_CommandPhase0
block|,
name|amd_StatusPhase0
block|,
name|amd_NopPhase
block|,
name|amd_NopPhase
block|,
name|amd_MsgOutPhase0
block|,
name|amd_MsgInPhase0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|phase_handler_func_t
name|amd_SCSI_phase1
index|[]
init|=
block|{
name|amd_DataOutPhase1
block|,
name|amd_DataInPhase1
block|,
name|amd_CommandPhase1
block|,
name|amd_StatusPhase1
block|,
name|amd_NopPhase
block|,
name|amd_NopPhase
block|,
name|amd_MsgOutPhase1
block|,
name|amd_MsgInPhase1
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * EEProm/BIOS negotiation periods  */
end_comment

begin_decl_stmt
name|u_int8_t
name|eeprom_period
index|[]
init|=
block|{
literal|25
block|,
comment|/* 10.0MHz */
literal|32
block|,
comment|/*  8.0MHz */
literal|38
block|,
comment|/*  6.6MHz */
literal|44
block|,
comment|/*  5.7MHz */
literal|50
block|,
comment|/*  5.0MHz */
literal|63
block|,
comment|/*  4.0MHz */
literal|83
block|,
comment|/*  3.0MHz */
literal|125
comment|/*  2.0MHz */
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * chip clock setting to SCSI specified sync parameter table.  */
end_comment

begin_decl_stmt
name|u_int8_t
name|tinfo_sync_period
index|[]
init|=
block|{
literal|25
block|,
comment|/* 10.0 */
literal|32
block|,
comment|/* 8.0 */
literal|38
block|,
comment|/* 6.6 */
literal|44
block|,
comment|/* 5.7 */
literal|50
block|,
comment|/* 5.0 */
literal|57
block|,
comment|/* 4.4 */
literal|63
block|,
comment|/* 4.0 */
literal|70
block|,
comment|/* 3.6 */
literal|76
block|,
comment|/* 3.3 */
literal|83
comment|/* 3.0 */
block|}
decl_stmt|;
end_decl_stmt

begin_expr_stmt
specifier|static
name|__inline
expr|struct
name|amd_srb
operator|*
name|amdgetsrb
argument_list|(
argument|struct amd_softc * amd
argument_list|)
block|{
name|int
name|intflag
block|; 	struct
name|amd_srb
operator|*
name|pSRB
block|;
name|intflag
operator|=
name|splcam
argument_list|()
block|;
name|pSRB
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|amd
operator|->
name|free_srbs
argument_list|)
block|;
if|if
condition|(
name|pSRB
condition|)
name|TAILQ_REMOVE
argument_list|(
operator|&
name|amd
operator|->
name|free_srbs
argument_list|,
name|pSRB
argument_list|,
name|links
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|intflag
argument_list|)
expr_stmt|;
end_expr_stmt

begin_return
return|return
operator|(
name|pSRB
operator|)
return|;
end_return

begin_function
unit|}  static
name|void
name|amdsetupcommand
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|,
name|struct
name|amd_srb
modifier|*
name|srb
parameter_list|)
block|{
name|struct
name|scsi_request_sense
name|sense_cmd
decl_stmt|;
name|struct
name|ccb_scsiio
modifier|*
name|csio
decl_stmt|;
name|u_int8_t
modifier|*
name|cdb
decl_stmt|;
name|u_int
name|cdb_len
decl_stmt|;
name|csio
operator|=
operator|&
name|srb
operator|->
name|pccb
operator|->
name|csio
expr_stmt|;
if|if
condition|(
name|srb
operator|->
name|SRBFlag
operator|&
name|AUTO_REQSENSE
condition|)
block|{
name|sense_cmd
operator|.
name|opcode
operator|=
name|REQUEST_SENSE
expr_stmt|;
name|sense_cmd
operator|.
name|byte2
operator|=
name|srb
operator|->
name|pccb
operator|->
name|ccb_h
operator|.
name|target_lun
operator|<<
literal|5
expr_stmt|;
name|sense_cmd
operator|.
name|unused
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|sense_cmd
operator|.
name|unused
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|sense_cmd
operator|.
name|length
operator|=
name|csio
operator|->
name|sense_len
expr_stmt|;
name|sense_cmd
operator|.
name|control
operator|=
literal|0
expr_stmt|;
name|cdb
operator|=
operator|&
name|sense_cmd
operator|.
name|opcode
expr_stmt|;
name|cdb_len
operator|=
sizeof|sizeof
argument_list|(
name|sense_cmd
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|cdb
operator|=
operator|&
name|srb
operator|->
name|CmdBlock
index|[
literal|0
index|]
expr_stmt|;
name|cdb_len
operator|=
name|srb
operator|->
name|ScsiCmdLen
expr_stmt|;
block|}
name|amd_write8_multi
argument_list|(
name|amd
argument_list|,
name|SCSIFIFOREG
argument_list|,
name|cdb
argument_list|,
name|cdb_len
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Attempt to start a waiting transaction.  Interrupts must be disabled  * upon entry to this function.  */
end_comment

begin_function
specifier|static
name|void
name|amdrunwaiting
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|)
block|{
name|struct
name|amd_srb
modifier|*
name|srb
decl_stmt|;
if|if
condition|(
name|amd
operator|->
name|last_phase
operator|!=
name|SCSI_BUS_FREE
condition|)
return|return;
name|srb
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|amd
operator|->
name|waiting_srbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|srb
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|amdstart
argument_list|(
name|amd
argument_list|,
name|srb
argument_list|)
operator|==
literal|0
condition|)
block|{
name|TAILQ_REMOVE
argument_list|(
operator|&
name|amd
operator|->
name|waiting_srbs
argument_list|,
name|srb
argument_list|,
name|links
argument_list|)
expr_stmt|;
name|TAILQ_INSERT_HEAD
argument_list|(
operator|&
name|amd
operator|->
name|running_srbs
argument_list|,
name|srb
argument_list|,
name|links
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|amdexecutesrb
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|dm_segs
parameter_list|,
name|int
name|nseg
parameter_list|,
name|int
name|error
parameter_list|)
block|{
name|struct
name|amd_srb
modifier|*
name|srb
decl_stmt|;
name|union
name|ccb
modifier|*
name|ccb
decl_stmt|;
name|struct
name|amd_softc
modifier|*
name|amd
decl_stmt|;
name|int
name|s
decl_stmt|;
name|srb
operator|=
operator|(
expr|struct
name|amd_srb
operator|*
operator|)
name|arg
expr_stmt|;
name|ccb
operator|=
name|srb
operator|->
name|pccb
expr_stmt|;
name|amd
operator|=
operator|(
expr|struct
name|amd_softc
operator|*
operator|)
name|ccb
operator|->
name|ccb_h
operator|.
name|ccb_amd_ptr
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|error
operator|!=
name|EFBIG
condition|)
name|printf
argument_list|(
literal|"amd%d: Unexepected error 0x%x returned from "
literal|"bus_dmamap_load\n"
argument_list|,
name|amd
operator|->
name|unit
argument_list|,
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|==
name|CAM_REQ_INPROG
condition|)
block|{
name|xpt_freeze_devq
argument_list|(
name|ccb
operator|->
name|ccb_h
operator|.
name|path
argument_list|,
comment|/*count*/
literal|1
argument_list|)
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_TOO_BIG
operator||
name|CAM_DEV_QFRZN
expr_stmt|;
block|}
name|TAILQ_INSERT_HEAD
argument_list|(
operator|&
name|amd
operator|->
name|free_srbs
argument_list|,
name|srb
argument_list|,
name|links
argument_list|)
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|nseg
operator|!=
literal|0
condition|)
block|{
name|struct
name|amd_sg
modifier|*
name|sg
decl_stmt|;
name|bus_dma_segment_t
modifier|*
name|end_seg
decl_stmt|;
name|bus_dmasync_op_t
name|op
decl_stmt|;
name|end_seg
operator|=
name|dm_segs
operator|+
name|nseg
expr_stmt|;
comment|/* Copy the segments into our SG list */
name|srb
operator|->
name|pSGlist
operator|=
operator|&
name|srb
operator|->
name|SGsegment
index|[
literal|0
index|]
expr_stmt|;
name|sg
operator|=
name|srb
operator|->
name|pSGlist
expr_stmt|;
while|while
condition|(
name|dm_segs
operator|<
name|end_seg
condition|)
block|{
name|sg
operator|->
name|SGXLen
operator|=
name|dm_segs
operator|->
name|ds_len
expr_stmt|;
name|sg
operator|->
name|SGXPtr
operator|=
name|dm_segs
operator|->
name|ds_addr
expr_stmt|;
name|sg
operator|++
expr_stmt|;
name|dm_segs
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_DIR_MASK
operator|)
operator|==
name|CAM_DIR_IN
condition|)
name|op
operator|=
name|BUS_DMASYNC_PREREAD
expr_stmt|;
else|else
name|op
operator|=
name|BUS_DMASYNC_PREWRITE
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|amd
operator|->
name|buffer_dmat
argument_list|,
name|srb
operator|->
name|dmamap
argument_list|,
name|op
argument_list|)
expr_stmt|;
block|}
name|srb
operator|->
name|SGcount
operator|=
name|nseg
expr_stmt|;
name|srb
operator|->
name|SGIndex
operator|=
literal|0
expr_stmt|;
name|srb
operator|->
name|AdaptStatus
operator|=
literal|0
expr_stmt|;
name|srb
operator|->
name|TargetStatus
operator|=
literal|0
expr_stmt|;
name|srb
operator|->
name|MsgCnt
operator|=
literal|0
expr_stmt|;
name|srb
operator|->
name|SRBStatus
operator|=
literal|0
expr_stmt|;
name|srb
operator|->
name|SRBFlag
operator|=
literal|0
expr_stmt|;
name|srb
operator|->
name|SRBState
operator|=
literal|0
expr_stmt|;
name|srb
operator|->
name|TotalXferredLen
operator|=
literal|0
expr_stmt|;
name|srb
operator|->
name|SGPhysAddr
operator|=
literal|0
expr_stmt|;
name|srb
operator|->
name|SGToBeXferLen
operator|=
literal|0
expr_stmt|;
name|srb
operator|->
name|EndMessage
operator|=
literal|0
expr_stmt|;
name|s
operator|=
name|splcam
argument_list|()
expr_stmt|;
comment|/* 	 * Last time we need to check if this CCB needs to 	 * be aborted. 	 */
if|if
condition|(
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|!=
name|CAM_REQ_INPROG
condition|)
block|{
if|if
condition|(
name|nseg
operator|!=
literal|0
condition|)
name|bus_dmamap_unload
argument_list|(
name|amd
operator|->
name|buffer_dmat
argument_list|,
name|srb
operator|->
name|dmamap
argument_list|)
expr_stmt|;
name|TAILQ_INSERT_HEAD
argument_list|(
operator|&
name|amd
operator|->
name|free_srbs
argument_list|,
name|srb
argument_list|,
name|links
argument_list|)
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return;
block|}
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator||=
name|CAM_SIM_QUEUED
expr_stmt|;
if|#
directive|if
literal|0
comment|/* XXX Need a timeout handler */
block|ccb->ccb_h.timeout_ch = 	    timeout(amdtimeout, (caddr_t)srb, 		    (ccb->ccb_h.timeout * hz) / 1000);
endif|#
directive|endif
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|amd
operator|->
name|waiting_srbs
argument_list|,
name|srb
argument_list|,
name|links
argument_list|)
expr_stmt|;
name|amdrunwaiting
argument_list|(
name|amd
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|amd_action
parameter_list|(
name|struct
name|cam_sim
modifier|*
name|psim
parameter_list|,
name|union
name|ccb
modifier|*
name|pccb
parameter_list|)
block|{
name|struct
name|amd_softc
modifier|*
name|amd
decl_stmt|;
name|u_int
name|target_id
decl_stmt|,
name|target_lun
decl_stmt|;
name|CAM_DEBUG
argument_list|(
name|pccb
operator|->
name|ccb_h
operator|.
name|path
argument_list|,
name|CAM_DEBUG_TRACE
argument_list|,
operator|(
literal|"amd_action\n"
operator|)
argument_list|)
expr_stmt|;
name|amd
operator|=
operator|(
expr|struct
name|amd_softc
operator|*
operator|)
name|cam_sim_softc
argument_list|(
name|psim
argument_list|)
expr_stmt|;
name|target_id
operator|=
name|pccb
operator|->
name|ccb_h
operator|.
name|target_id
expr_stmt|;
name|target_lun
operator|=
name|pccb
operator|->
name|ccb_h
operator|.
name|target_lun
expr_stmt|;
switch|switch
condition|(
name|pccb
operator|->
name|ccb_h
operator|.
name|func_code
condition|)
block|{
case|case
name|XPT_SCSI_IO
case|:
block|{
name|struct
name|amd_srb
modifier|*
name|pSRB
decl_stmt|;
name|struct
name|ccb_scsiio
modifier|*
name|pcsio
decl_stmt|;
name|pcsio
operator|=
operator|&
name|pccb
operator|->
name|csio
expr_stmt|;
comment|/* 		 * Assign an SRB and connect it with this ccb. 		 */
name|pSRB
operator|=
name|amdgetsrb
argument_list|(
name|amd
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pSRB
condition|)
block|{
comment|/* Freeze SIMQ */
name|pccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_RESRC_UNAVAIL
expr_stmt|;
name|xpt_done
argument_list|(
name|pccb
argument_list|)
expr_stmt|;
return|return;
block|}
name|pSRB
operator|->
name|pccb
operator|=
name|pccb
expr_stmt|;
name|pccb
operator|->
name|ccb_h
operator|.
name|ccb_srb_ptr
operator|=
name|pSRB
expr_stmt|;
name|pccb
operator|->
name|ccb_h
operator|.
name|ccb_amd_ptr
operator|=
name|amd
expr_stmt|;
name|pSRB
operator|->
name|ScsiCmdLen
operator|=
name|pcsio
operator|->
name|cdb_len
expr_stmt|;
name|bcopy
argument_list|(
name|pcsio
operator|->
name|cdb_io
operator|.
name|cdb_bytes
argument_list|,
name|pSRB
operator|->
name|CmdBlock
argument_list|,
name|pcsio
operator|->
name|cdb_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_DIR_MASK
operator|)
operator|!=
name|CAM_DIR_NONE
condition|)
block|{
if|if
condition|(
operator|(
name|pccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_SCATTER_VALID
operator|)
operator|==
literal|0
condition|)
block|{
comment|/* 				 * We've been given a pointer 				 * to a single buffer. 				 */
if|if
condition|(
operator|(
name|pccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_DATA_PHYS
operator|)
operator|==
literal|0
condition|)
block|{
name|int
name|s
decl_stmt|;
name|int
name|error
decl_stmt|;
name|s
operator|=
name|splsoftvm
argument_list|()
expr_stmt|;
name|error
operator|=
name|bus_dmamap_load
argument_list|(
name|amd
operator|->
name|buffer_dmat
argument_list|,
name|pSRB
operator|->
name|dmamap
argument_list|,
name|pcsio
operator|->
name|data_ptr
argument_list|,
name|pcsio
operator|->
name|dxfer_len
argument_list|,
name|amdexecutesrb
argument_list|,
name|pSRB
argument_list|,
comment|/*flags*/
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
name|EINPROGRESS
condition|)
block|{
comment|/* 						 * So as to maintain 						 * ordering, freeze the 						 * controller queue 						 * until our mapping is 						 * returned. 						 */
name|xpt_freeze_simq
argument_list|(
name|amd
operator|->
name|psim
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pccb
operator|->
name|ccb_h
operator|.
name|status
operator||=
name|CAM_RELEASE_SIMQ
expr_stmt|;
block|}
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|struct
name|bus_dma_segment
name|seg
decl_stmt|;
comment|/* Pointer to physical buffer */
name|seg
operator|.
name|ds_addr
operator|=
operator|(
name|bus_addr_t
operator|)
name|pcsio
operator|->
name|data_ptr
expr_stmt|;
name|seg
operator|.
name|ds_len
operator|=
name|pcsio
operator|->
name|dxfer_len
expr_stmt|;
name|amdexecutesrb
argument_list|(
name|pSRB
argument_list|,
operator|&
name|seg
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|struct
name|bus_dma_segment
modifier|*
name|segs
decl_stmt|;
if|if
condition|(
operator|(
name|pccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_SG_LIST_PHYS
operator|)
operator|==
literal|0
operator|||
operator|(
name|pccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_DATA_PHYS
operator|)
operator|!=
literal|0
condition|)
block|{
name|TAILQ_INSERT_HEAD
argument_list|(
operator|&
name|amd
operator|->
name|free_srbs
argument_list|,
name|pSRB
argument_list|,
name|links
argument_list|)
expr_stmt|;
name|pccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_PROVIDE_FAIL
expr_stmt|;
name|xpt_done
argument_list|(
name|pccb
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Just use the segments provided */
name|segs
operator|=
operator|(
expr|struct
name|bus_dma_segment
operator|*
operator|)
name|pcsio
operator|->
name|data_ptr
expr_stmt|;
name|amdexecutesrb
argument_list|(
name|pSRB
argument_list|,
name|segs
argument_list|,
name|pcsio
operator|->
name|sglist_cnt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
else|else
name|amdexecutesrb
argument_list|(
name|pSRB
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|XPT_PATH_INQ
case|:
block|{
name|struct
name|ccb_pathinq
modifier|*
name|cpi
init|=
operator|&
name|pccb
operator|->
name|cpi
decl_stmt|;
name|cpi
operator|->
name|version_num
operator|=
literal|1
expr_stmt|;
name|cpi
operator|->
name|hba_inquiry
operator|=
name|PI_SDTR_ABLE
operator||
name|PI_TAG_ABLE
expr_stmt|;
name|cpi
operator|->
name|target_sprt
operator|=
literal|0
expr_stmt|;
name|cpi
operator|->
name|hba_misc
operator|=
literal|0
expr_stmt|;
name|cpi
operator|->
name|hba_eng_cnt
operator|=
literal|0
expr_stmt|;
name|cpi
operator|->
name|max_target
operator|=
literal|7
expr_stmt|;
name|cpi
operator|->
name|max_lun
operator|=
name|amd
operator|->
name|max_lun
expr_stmt|;
comment|/* 7 or 0 */
name|cpi
operator|->
name|initiator_id
operator|=
name|amd
operator|->
name|AdaptSCSIID
expr_stmt|;
name|cpi
operator|->
name|bus_id
operator|=
name|cam_sim_bus
argument_list|(
name|psim
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|cpi
operator|->
name|sim_vid
argument_list|,
literal|"FreeBSD"
argument_list|,
name|SIM_IDLEN
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|cpi
operator|->
name|hba_vid
argument_list|,
literal|"TRM-AMD"
argument_list|,
name|HBA_IDLEN
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|cpi
operator|->
name|dev_name
argument_list|,
name|cam_sim_name
argument_list|(
name|psim
argument_list|)
argument_list|,
name|DEV_IDLEN
argument_list|)
expr_stmt|;
name|cpi
operator|->
name|unit_number
operator|=
name|cam_sim_unit
argument_list|(
name|psim
argument_list|)
expr_stmt|;
name|cpi
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_CMP
expr_stmt|;
name|xpt_done
argument_list|(
name|pccb
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|XPT_ABORT
case|:
name|pccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_INVALID
expr_stmt|;
name|xpt_done
argument_list|(
name|pccb
argument_list|)
expr_stmt|;
break|break;
case|case
name|XPT_RESET_BUS
case|:
block|{
name|int
name|i
decl_stmt|;
name|amd_ResetSCSIBus
argument_list|(
name|amd
argument_list|)
expr_stmt|;
name|amd
operator|->
name|ACBFlag
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|500
condition|;
name|i
operator|++
control|)
block|{
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
comment|/* Wait until our interrupt 					 * handler sees it */
block|}
name|pccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_CMP
expr_stmt|;
name|xpt_done
argument_list|(
name|pccb
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|XPT_RESET_DEV
case|:
name|pccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_INVALID
expr_stmt|;
name|xpt_done
argument_list|(
name|pccb
argument_list|)
expr_stmt|;
break|break;
case|case
name|XPT_TERM_IO
case|:
name|pccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_INVALID
expr_stmt|;
name|xpt_done
argument_list|(
name|pccb
argument_list|)
expr_stmt|;
case|case
name|XPT_GET_TRAN_SETTINGS
case|:
block|{
name|struct
name|ccb_trans_settings
modifier|*
name|cts
decl_stmt|;
name|struct
name|amd_target_info
modifier|*
name|targ_info
decl_stmt|;
name|struct
name|amd_transinfo
modifier|*
name|tinfo
decl_stmt|;
name|int
name|intflag
decl_stmt|;
name|cts
operator|=
operator|&
name|pccb
operator|->
name|cts
expr_stmt|;
name|intflag
operator|=
name|splcam
argument_list|()
expr_stmt|;
name|targ_info
operator|=
operator|&
name|amd
operator|->
name|tinfo
index|[
name|target_id
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|cts
operator|->
name|flags
operator|&
name|CCB_TRANS_CURRENT_SETTINGS
operator|)
operator|!=
literal|0
condition|)
block|{
comment|/* current transfer settings */
if|if
condition|(
name|targ_info
operator|->
name|disc_tag
operator|&
name|AMD_CUR_DISCENB
condition|)
block|{
name|cts
operator|->
name|flags
operator|=
name|CCB_TRANS_DISC_ENB
expr_stmt|;
block|}
else|else
block|{
name|cts
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
comment|/* no tag& disconnect */
block|}
if|if
condition|(
name|targ_info
operator|->
name|disc_tag
operator|&
name|AMD_CUR_TAGENB
condition|)
block|{
name|cts
operator|->
name|flags
operator||=
name|CCB_TRANS_TAG_ENB
expr_stmt|;
block|}
name|tinfo
operator|=
operator|&
name|targ_info
operator|->
name|current
expr_stmt|;
block|}
else|else
block|{
comment|/* default(user) transfer settings */
if|if
condition|(
name|targ_info
operator|->
name|disc_tag
operator|&
name|AMD_USR_DISCENB
condition|)
block|{
name|cts
operator|->
name|flags
operator|=
name|CCB_TRANS_DISC_ENB
expr_stmt|;
block|}
else|else
block|{
name|cts
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|targ_info
operator|->
name|disc_tag
operator|&
name|AMD_USR_TAGENB
condition|)
block|{
name|cts
operator|->
name|flags
operator||=
name|CCB_TRANS_TAG_ENB
expr_stmt|;
block|}
name|tinfo
operator|=
operator|&
name|targ_info
operator|->
name|user
expr_stmt|;
block|}
name|cts
operator|->
name|sync_period
operator|=
name|tinfo
operator|->
name|period
expr_stmt|;
name|cts
operator|->
name|sync_offset
operator|=
name|tinfo
operator|->
name|offset
expr_stmt|;
name|cts
operator|->
name|bus_width
operator|=
name|MSG_EXT_WDTR_BUS_8_BIT
expr_stmt|;
name|splx
argument_list|(
name|intflag
argument_list|)
expr_stmt|;
name|cts
operator|->
name|valid
operator|=
name|CCB_TRANS_SYNC_RATE_VALID
operator||
name|CCB_TRANS_SYNC_OFFSET_VALID
operator||
name|CCB_TRANS_BUS_WIDTH_VALID
operator||
name|CCB_TRANS_DISC_VALID
operator||
name|CCB_TRANS_TQ_VALID
expr_stmt|;
name|pccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_CMP
expr_stmt|;
name|xpt_done
argument_list|(
name|pccb
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|XPT_SET_TRAN_SETTINGS
case|:
block|{
name|struct
name|ccb_trans_settings
modifier|*
name|cts
decl_stmt|;
name|struct
name|amd_target_info
modifier|*
name|targ_info
decl_stmt|;
name|u_int
name|update_type
decl_stmt|;
name|int
name|intflag
decl_stmt|;
name|int
name|last_entry
decl_stmt|;
name|cts
operator|=
operator|&
name|pccb
operator|->
name|cts
expr_stmt|;
name|update_type
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|cts
operator|->
name|flags
operator|&
name|CCB_TRANS_CURRENT_SETTINGS
operator|)
operator|!=
literal|0
condition|)
block|{
name|update_type
operator||=
name|AMD_TRANS_GOAL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|cts
operator|->
name|flags
operator|&
name|CCB_TRANS_USER_SETTINGS
operator|)
operator|!=
literal|0
condition|)
block|{
name|update_type
operator||=
name|AMD_TRANS_USER
expr_stmt|;
block|}
if|if
condition|(
name|update_type
operator|==
literal|0
operator|||
name|update_type
operator|==
operator|(
name|AMD_TRANS_USER
operator||
name|AMD_TRANS_GOAL
operator|)
condition|)
block|{
name|cts
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_INVALID
expr_stmt|;
name|xpt_done
argument_list|(
name|pccb
argument_list|)
expr_stmt|;
block|}
name|intflag
operator|=
name|splcam
argument_list|()
expr_stmt|;
name|targ_info
operator|=
operator|&
name|amd
operator|->
name|tinfo
index|[
name|target_id
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|cts
operator|->
name|valid
operator|&
name|CCB_TRANS_DISC_VALID
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|update_type
operator|&
name|AMD_TRANS_GOAL
condition|)
block|{
if|if
condition|(
operator|(
name|cts
operator|->
name|flags
operator|&
name|CCB_TRANS_DISC_ENB
operator|)
operator|!=
literal|0
condition|)
block|{
name|targ_info
operator|->
name|disc_tag
operator||=
name|AMD_CUR_DISCENB
expr_stmt|;
block|}
else|else
block|{
name|targ_info
operator|->
name|disc_tag
operator|&=
operator|~
name|AMD_CUR_DISCENB
expr_stmt|;
block|}
block|}
if|if
condition|(
name|update_type
operator|&
name|AMD_TRANS_USER
condition|)
block|{
if|if
condition|(
operator|(
name|cts
operator|->
name|flags
operator|&
name|CCB_TRANS_DISC_ENB
operator|)
operator|!=
literal|0
condition|)
block|{
name|targ_info
operator|->
name|disc_tag
operator||=
name|AMD_USR_DISCENB
expr_stmt|;
block|}
else|else
block|{
name|targ_info
operator|->
name|disc_tag
operator|&=
operator|~
name|AMD_USR_DISCENB
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
operator|(
name|cts
operator|->
name|valid
operator|&
name|CCB_TRANS_TQ_VALID
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|update_type
operator|&
name|AMD_TRANS_GOAL
condition|)
block|{
if|if
condition|(
operator|(
name|cts
operator|->
name|flags
operator|&
name|CCB_TRANS_TAG_ENB
operator|)
operator|!=
literal|0
condition|)
block|{
name|targ_info
operator|->
name|disc_tag
operator||=
name|AMD_CUR_TAGENB
expr_stmt|;
block|}
else|else
block|{
name|targ_info
operator|->
name|disc_tag
operator|&=
operator|~
name|AMD_CUR_TAGENB
expr_stmt|;
block|}
block|}
if|if
condition|(
name|update_type
operator|&
name|AMD_TRANS_USER
condition|)
block|{
if|if
condition|(
operator|(
name|cts
operator|->
name|flags
operator|&
name|CCB_TRANS_TAG_ENB
operator|)
operator|!=
literal|0
condition|)
block|{
name|targ_info
operator|->
name|disc_tag
operator||=
name|AMD_USR_TAGENB
expr_stmt|;
block|}
else|else
block|{
name|targ_info
operator|->
name|disc_tag
operator|&=
operator|~
name|AMD_USR_TAGENB
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
operator|(
name|cts
operator|->
name|valid
operator|&
name|CCB_TRANS_SYNC_OFFSET_VALID
operator|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|update_type
operator|&
name|AMD_TRANS_GOAL
condition|)
name|cts
operator|->
name|sync_offset
operator|=
name|targ_info
operator|->
name|goal
operator|.
name|offset
expr_stmt|;
else|else
name|cts
operator|->
name|sync_offset
operator|=
name|targ_info
operator|->
name|user
operator|.
name|offset
expr_stmt|;
block|}
if|if
condition|(
name|cts
operator|->
name|sync_offset
operator|>
name|AMD_MAX_SYNC_OFFSET
condition|)
name|cts
operator|->
name|sync_offset
operator|=
name|AMD_MAX_SYNC_OFFSET
expr_stmt|;
if|if
condition|(
operator|(
name|cts
operator|->
name|valid
operator|&
name|CCB_TRANS_SYNC_RATE_VALID
operator|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|update_type
operator|&
name|AMD_TRANS_GOAL
condition|)
name|cts
operator|->
name|sync_period
operator|=
name|targ_info
operator|->
name|goal
operator|.
name|period
expr_stmt|;
else|else
name|cts
operator|->
name|sync_period
operator|=
name|targ_info
operator|->
name|user
operator|.
name|period
expr_stmt|;
block|}
name|last_entry
operator|=
sizeof|sizeof
argument_list|(
name|tinfo_sync_period
argument_list|)
operator|-
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|cts
operator|->
name|sync_period
operator|!=
literal|0
operator|)
operator|&&
operator|(
name|cts
operator|->
name|sync_period
operator|<
name|tinfo_sync_period
index|[
literal|0
index|]
operator|)
condition|)
name|cts
operator|->
name|sync_period
operator|=
name|tinfo_sync_period
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|cts
operator|->
name|sync_period
operator|>
name|tinfo_sync_period
index|[
name|last_entry
index|]
condition|)
name|cts
operator|->
name|sync_period
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|cts
operator|->
name|sync_offset
operator|==
literal|0
condition|)
name|cts
operator|->
name|sync_period
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|update_type
operator|&
name|AMD_TRANS_USER
operator|)
operator|!=
literal|0
condition|)
block|{
name|targ_info
operator|->
name|user
operator|.
name|period
operator|=
name|cts
operator|->
name|sync_period
expr_stmt|;
name|targ_info
operator|->
name|user
operator|.
name|offset
operator|=
name|cts
operator|->
name|sync_offset
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|update_type
operator|&
name|AMD_TRANS_GOAL
operator|)
operator|!=
literal|0
condition|)
block|{
name|targ_info
operator|->
name|goal
operator|.
name|period
operator|=
name|cts
operator|->
name|sync_period
expr_stmt|;
name|targ_info
operator|->
name|goal
operator|.
name|offset
operator|=
name|cts
operator|->
name|sync_offset
expr_stmt|;
block|}
name|splx
argument_list|(
name|intflag
argument_list|)
expr_stmt|;
name|pccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_CMP
expr_stmt|;
name|xpt_done
argument_list|(
name|pccb
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|XPT_CALC_GEOMETRY
case|:
block|{
name|struct
name|ccb_calc_geometry
modifier|*
name|ccg
decl_stmt|;
name|u_int32_t
name|size_mb
decl_stmt|;
name|u_int32_t
name|secs_per_cylinder
decl_stmt|;
name|int
name|extended
decl_stmt|;
name|ccg
operator|=
operator|&
name|pccb
operator|->
name|ccg
expr_stmt|;
name|size_mb
operator|=
name|ccg
operator|->
name|volume_size
operator|/
operator|(
operator|(
literal|1024L
operator|*
literal|1024L
operator|)
operator|/
name|ccg
operator|->
name|block_size
operator|)
expr_stmt|;
name|extended
operator|=
operator|(
name|amd
operator|->
name|eepromBuf
index|[
name|EE_MODE2
index|]
operator|&
name|GREATER_1G
operator|)
operator|!=
literal|0
expr_stmt|;
if|if
condition|(
name|size_mb
operator|>
literal|1024
operator|&&
name|extended
condition|)
block|{
name|ccg
operator|->
name|heads
operator|=
literal|255
expr_stmt|;
name|ccg
operator|->
name|secs_per_track
operator|=
literal|63
expr_stmt|;
block|}
else|else
block|{
name|ccg
operator|->
name|heads
operator|=
literal|64
expr_stmt|;
name|ccg
operator|->
name|secs_per_track
operator|=
literal|32
expr_stmt|;
block|}
name|secs_per_cylinder
operator|=
name|ccg
operator|->
name|heads
operator|*
name|ccg
operator|->
name|secs_per_track
expr_stmt|;
name|ccg
operator|->
name|cylinders
operator|=
name|ccg
operator|->
name|volume_size
operator|/
name|secs_per_cylinder
expr_stmt|;
name|pccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_CMP
expr_stmt|;
name|xpt_done
argument_list|(
name|pccb
argument_list|)
expr_stmt|;
break|break;
block|}
default|default:
name|pccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_INVALID
expr_stmt|;
name|xpt_done
argument_list|(
name|pccb
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|amd_poll
parameter_list|(
name|struct
name|cam_sim
modifier|*
name|psim
parameter_list|)
block|{
name|amd_intr
argument_list|(
name|cam_sim_softc
argument_list|(
name|psim
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|u_int8_t
modifier|*
name|phystovirt
parameter_list|(
name|struct
name|amd_srb
modifier|*
name|pSRB
parameter_list|,
name|u_int32_t
name|xferCnt
parameter_list|)
block|{
name|int
name|dataPtr
decl_stmt|;
name|struct
name|ccb_scsiio
modifier|*
name|pcsio
decl_stmt|;
name|u_int8_t
name|i
decl_stmt|;
name|struct
name|amd_sg
modifier|*
name|pseg
decl_stmt|;
name|dataPtr
operator|=
literal|0
expr_stmt|;
name|pcsio
operator|=
operator|&
name|pSRB
operator|->
name|pccb
operator|->
name|csio
expr_stmt|;
name|dataPtr
operator|=
operator|(
name|int
operator|)
name|pcsio
operator|->
name|data_ptr
expr_stmt|;
name|pseg
operator|=
name|pSRB
operator|->
name|SGsegment
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pSRB
operator|->
name|SGIndex
condition|;
name|i
operator|++
control|)
block|{
name|dataPtr
operator|+=
operator|(
name|int
operator|)
name|pseg
operator|->
name|SGXLen
expr_stmt|;
name|pseg
operator|++
expr_stmt|;
block|}
name|dataPtr
operator|+=
operator|(
name|int
operator|)
name|xferCnt
expr_stmt|;
return|return
operator|(
operator|(
name|u_int8_t
operator|*
operator|)
name|dataPtr
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ResetDevParam
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|)
block|{
name|u_int
name|target
decl_stmt|;
for|for
control|(
name|target
operator|=
literal|0
init|;
name|target
operator|<=
name|amd
operator|->
name|max_id
condition|;
name|target
operator|++
control|)
block|{
if|if
condition|(
name|amd
operator|->
name|AdaptSCSIID
operator|!=
name|target
condition|)
block|{
name|amdsetsync
argument_list|(
name|amd
argument_list|,
name|target
argument_list|,
comment|/*clockrate*/
literal|0
argument_list|,
comment|/*period*/
literal|0
argument_list|,
comment|/*offset*/
literal|0
argument_list|,
name|AMD_TRANS_CUR
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|amdcompletematch
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|,
name|target_id_t
name|target
parameter_list|,
name|lun_id_t
name|lun
parameter_list|,
name|u_int
name|tag
parameter_list|,
name|struct
name|srb_queue
modifier|*
name|queue
parameter_list|,
name|cam_status
name|status
parameter_list|)
block|{
name|struct
name|amd_srb
modifier|*
name|srb
decl_stmt|;
name|struct
name|amd_srb
modifier|*
name|next_srb
decl_stmt|;
for|for
control|(
name|srb
operator|=
name|TAILQ_FIRST
argument_list|(
name|queue
argument_list|)
init|;
name|srb
operator|!=
name|NULL
condition|;
name|srb
operator|=
name|next_srb
control|)
block|{
name|union
name|ccb
modifier|*
name|ccb
decl_stmt|;
name|next_srb
operator|=
name|TAILQ_NEXT
argument_list|(
name|srb
argument_list|,
name|links
argument_list|)
expr_stmt|;
if|if
condition|(
name|srb
operator|->
name|pccb
operator|->
name|ccb_h
operator|.
name|target_id
operator|!=
name|target
operator|&&
name|target
operator|!=
name|CAM_TARGET_WILDCARD
condition|)
continue|continue;
if|if
condition|(
name|srb
operator|->
name|pccb
operator|->
name|ccb_h
operator|.
name|target_lun
operator|!=
name|lun
operator|&&
name|lun
operator|!=
name|CAM_LUN_WILDCARD
condition|)
continue|continue;
if|if
condition|(
name|srb
operator|->
name|TagNumber
operator|!=
name|tag
operator|&&
name|tag
operator|!=
name|AMD_TAG_WILDCARD
condition|)
continue|continue;
name|ccb
operator|=
name|srb
operator|->
name|pccb
expr_stmt|;
name|TAILQ_REMOVE
argument_list|(
name|queue
argument_list|,
name|srb
argument_list|,
name|links
argument_list|)
expr_stmt|;
name|TAILQ_INSERT_HEAD
argument_list|(
operator|&
name|amd
operator|->
name|free_srbs
argument_list|,
name|srb
argument_list|,
name|links
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|&
name|CAM_DEV_QFRZN
operator|)
operator|==
literal|0
operator|&&
operator|(
name|status
operator|&
name|CAM_DEV_QFRZN
operator|)
operator|!=
literal|0
condition|)
name|xpt_freeze_devq
argument_list|(
name|ccb
operator|->
name|ccb_h
operator|.
name|path
argument_list|,
comment|/*count*/
literal|1
argument_list|)
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|status
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|amdsetsync
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|,
name|u_int
name|target
parameter_list|,
name|u_int
name|clockrate
parameter_list|,
name|u_int
name|period
parameter_list|,
name|u_int
name|offset
parameter_list|,
name|u_int
name|type
parameter_list|)
block|{
name|struct
name|amd_target_info
modifier|*
name|tinfo
decl_stmt|;
name|u_int
name|old_period
decl_stmt|;
name|u_int
name|old_offset
decl_stmt|;
name|tinfo
operator|=
operator|&
name|amd
operator|->
name|tinfo
index|[
name|target
index|]
expr_stmt|;
name|old_period
operator|=
name|tinfo
operator|->
name|current
operator|.
name|period
expr_stmt|;
name|old_offset
operator|=
name|tinfo
operator|->
name|current
operator|.
name|offset
expr_stmt|;
if|if
condition|(
operator|(
name|type
operator|&
name|AMD_TRANS_CUR
operator|)
operator|!=
literal|0
operator|&&
operator|(
name|old_period
operator|!=
name|period
operator|||
name|old_offset
operator|!=
name|offset
operator|)
condition|)
block|{
name|struct
name|cam_path
modifier|*
name|path
decl_stmt|;
name|tinfo
operator|->
name|current
operator|.
name|period
operator|=
name|period
expr_stmt|;
name|tinfo
operator|->
name|current
operator|.
name|offset
operator|=
name|offset
expr_stmt|;
name|tinfo
operator|->
name|sync_period_reg
operator|=
name|clockrate
expr_stmt|;
name|tinfo
operator|->
name|sync_offset_reg
operator|=
name|offset
expr_stmt|;
name|tinfo
operator|->
name|CtrlR3
operator|&=
operator|~
name|FAST_SCSI
expr_stmt|;
name|tinfo
operator|->
name|CtrlR4
operator|&=
operator|~
name|EATER_25NS
expr_stmt|;
if|if
condition|(
name|clockrate
operator|>
literal|7
condition|)
name|tinfo
operator|->
name|CtrlR4
operator||=
name|EATER_25NS
expr_stmt|;
else|else
name|tinfo
operator|->
name|CtrlR3
operator||=
name|FAST_SCSI
expr_stmt|;
if|if
condition|(
operator|(
name|type
operator|&
name|AMD_TRANS_ACTIVE
operator|)
operator|==
name|AMD_TRANS_ACTIVE
condition|)
block|{
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|SYNCPERIOREG
argument_list|,
name|tinfo
operator|->
name|sync_period_reg
argument_list|)
expr_stmt|;
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|SYNCOFFREG
argument_list|,
name|tinfo
operator|->
name|sync_offset_reg
argument_list|)
expr_stmt|;
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|CNTLREG3
argument_list|,
name|tinfo
operator|->
name|CtrlR3
argument_list|)
expr_stmt|;
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|CNTLREG4
argument_list|,
name|tinfo
operator|->
name|CtrlR4
argument_list|)
expr_stmt|;
block|}
comment|/* If possible, update the XPT's notion of our transfer rate */
if|if
condition|(
name|xpt_create_path
argument_list|(
operator|&
name|path
argument_list|,
comment|/*periph*/
name|NULL
argument_list|,
name|cam_sim_path
argument_list|(
name|amd
operator|->
name|psim
argument_list|)
argument_list|,
name|target
argument_list|,
name|CAM_LUN_WILDCARD
argument_list|)
operator|==
name|CAM_REQ_CMP
condition|)
block|{
name|struct
name|ccb_trans_settings
name|neg
decl_stmt|;
name|xpt_setup_ccb
argument_list|(
operator|&
name|neg
operator|.
name|ccb_h
argument_list|,
name|path
argument_list|,
comment|/*priority*/
literal|1
argument_list|)
expr_stmt|;
name|neg
operator|.
name|sync_period
operator|=
name|period
expr_stmt|;
name|neg
operator|.
name|sync_offset
operator|=
name|offset
expr_stmt|;
name|neg
operator|.
name|valid
operator|=
name|CCB_TRANS_SYNC_RATE_VALID
operator||
name|CCB_TRANS_SYNC_OFFSET_VALID
expr_stmt|;
name|xpt_async
argument_list|(
name|AC_TRANSFER_NEG
argument_list|,
name|path
argument_list|,
operator|&
name|neg
argument_list|)
expr_stmt|;
name|xpt_free_path
argument_list|(
name|path
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|type
operator|&
name|AMD_TRANS_GOAL
operator|)
operator|!=
literal|0
condition|)
block|{
name|tinfo
operator|->
name|goal
operator|.
name|period
operator|=
name|period
expr_stmt|;
name|tinfo
operator|->
name|goal
operator|.
name|offset
operator|=
name|offset
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|type
operator|&
name|AMD_TRANS_USER
operator|)
operator|!=
literal|0
condition|)
block|{
name|tinfo
operator|->
name|user
operator|.
name|period
operator|=
name|period
expr_stmt|;
name|tinfo
operator|->
name|user
operator|.
name|offset
operator|=
name|offset
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|amdsettags
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|,
name|u_int
name|target
parameter_list|,
name|int
name|tagenb
parameter_list|)
block|{
name|panic
argument_list|(
literal|"Implement me!\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  **********************************************************************  * Function : amd_reset (struct amd_softc * amd)  * Purpose  : perform a hard reset on the SCSI bus( and AMD chip).  * Inputs   : cmd - command which caused the SCSI RESET  **********************************************************************  */
end_comment

begin_function
specifier|static
name|void
name|amd_reset
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|)
block|{
name|int
name|intflag
decl_stmt|;
name|u_int8_t
name|bval
decl_stmt|;
name|u_int16_t
name|i
decl_stmt|;
ifdef|#
directive|ifdef
name|AMD_DEBUG0
name|printf
argument_list|(
literal|"DC390: RESET"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|intflag
operator|=
name|splcam
argument_list|()
expr_stmt|;
name|bval
operator|=
name|amd_read8
argument_list|(
name|amd
argument_list|,
name|CNTLREG1
argument_list|)
expr_stmt|;
name|bval
operator||=
name|DIS_INT_ON_SCSI_RST
expr_stmt|;
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|CNTLREG1
argument_list|,
name|bval
argument_list|)
expr_stmt|;
comment|/* disable interrupt */
name|amd_ResetSCSIBus
argument_list|(
name|amd
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|500
condition|;
name|i
operator|++
control|)
block|{
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
block|}
name|bval
operator|=
name|amd_read8
argument_list|(
name|amd
argument_list|,
name|CNTLREG1
argument_list|)
expr_stmt|;
name|bval
operator|&=
operator|~
name|DIS_INT_ON_SCSI_RST
expr_stmt|;
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|CNTLREG1
argument_list|,
name|bval
argument_list|)
expr_stmt|;
comment|/* re-enable interrupt */
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|DMA_Cmd
argument_list|,
name|DMA_IDLE_CMD
argument_list|)
expr_stmt|;
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|SCSICMDREG
argument_list|,
name|CLEAR_FIFO_CMD
argument_list|)
expr_stmt|;
name|ResetDevParam
argument_list|(
name|amd
argument_list|)
expr_stmt|;
name|amdcompletematch
argument_list|(
name|amd
argument_list|,
name|CAM_TARGET_WILDCARD
argument_list|,
name|CAM_LUN_WILDCARD
argument_list|,
name|AMD_TAG_WILDCARD
argument_list|,
operator|&
name|amd
operator|->
name|running_srbs
argument_list|,
name|CAM_DEV_QFRZN
operator||
name|CAM_SCSI_BUS_RESET
argument_list|)
expr_stmt|;
name|amdcompletematch
argument_list|(
name|amd
argument_list|,
name|CAM_TARGET_WILDCARD
argument_list|,
name|CAM_LUN_WILDCARD
argument_list|,
name|AMD_TAG_WILDCARD
argument_list|,
operator|&
name|amd
operator|->
name|waiting_srbs
argument_list|,
name|CAM_DEV_QFRZN
operator||
name|CAM_SCSI_BUS_RESET
argument_list|)
expr_stmt|;
name|amd
operator|->
name|active_srb
operator|=
name|NULL
expr_stmt|;
name|amd
operator|->
name|ACBFlag
operator|=
literal|0
expr_stmt|;
name|splx
argument_list|(
name|intflag
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|void
name|amd_timeout
parameter_list|(
name|void
modifier|*
name|arg1
parameter_list|)
block|{
name|struct
name|amd_srb
modifier|*
name|pSRB
decl_stmt|;
name|pSRB
operator|=
operator|(
expr|struct
name|amd_srb
operator|*
operator|)
name|arg1
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|amdstart
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|,
name|struct
name|amd_srb
modifier|*
name|pSRB
parameter_list|)
block|{
name|union
name|ccb
modifier|*
name|pccb
decl_stmt|;
name|struct
name|ccb_scsiio
modifier|*
name|pcsio
decl_stmt|;
name|struct
name|amd_target_info
modifier|*
name|targ_info
decl_stmt|;
name|u_int
name|identify_msg
decl_stmt|;
name|u_int
name|command
decl_stmt|;
name|u_int
name|target
decl_stmt|;
name|u_int
name|lun
decl_stmt|;
name|int
name|tagged
decl_stmt|;
name|pccb
operator|=
name|pSRB
operator|->
name|pccb
expr_stmt|;
name|pcsio
operator|=
operator|&
name|pccb
operator|->
name|csio
expr_stmt|;
name|target
operator|=
name|pccb
operator|->
name|ccb_h
operator|.
name|target_id
expr_stmt|;
name|lun
operator|=
name|pccb
operator|->
name|ccb_h
operator|.
name|target_lun
expr_stmt|;
name|targ_info
operator|=
operator|&
name|amd
operator|->
name|tinfo
index|[
name|target
index|]
expr_stmt|;
name|amd_clear_msg_state
argument_list|(
name|amd
argument_list|)
expr_stmt|;
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|SCSIDESTIDREG
argument_list|,
name|target
argument_list|)
expr_stmt|;
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|SYNCPERIOREG
argument_list|,
name|targ_info
operator|->
name|sync_period_reg
argument_list|)
expr_stmt|;
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|SYNCOFFREG
argument_list|,
name|targ_info
operator|->
name|sync_offset_reg
argument_list|)
expr_stmt|;
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|CNTLREG1
argument_list|,
name|targ_info
operator|->
name|CtrlR1
argument_list|)
expr_stmt|;
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|CNTLREG3
argument_list|,
name|targ_info
operator|->
name|CtrlR3
argument_list|)
expr_stmt|;
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|CNTLREG4
argument_list|,
name|targ_info
operator|->
name|CtrlR4
argument_list|)
expr_stmt|;
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|SCSICMDREG
argument_list|,
name|CLEAR_FIFO_CMD
argument_list|)
expr_stmt|;
name|identify_msg
operator|=
name|MSG_IDENTIFYFLAG
operator||
name|lun
expr_stmt|;
if|if
condition|(
operator|(
name|targ_info
operator|->
name|disc_tag
operator|&
name|AMD_CUR_DISCENB
operator|)
operator|!=
literal|0
operator|&&
operator|(
name|pccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_DIS_DISCONNECT
operator|)
operator|==
literal|0
operator|&&
operator|(
name|pSRB
operator|->
name|CmdBlock
index|[
literal|0
index|]
operator|!=
name|REQUEST_SENSE
operator|)
operator|&&
operator|(
name|pSRB
operator|->
name|SRBFlag
operator|&
name|AUTO_REQSENSE
operator|)
operator|==
literal|0
condition|)
name|identify_msg
operator||=
name|MSG_IDENTIFY_DISCFLAG
expr_stmt|;
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|SCSIFIFOREG
argument_list|,
name|identify_msg
argument_list|)
expr_stmt|;
name|tagged
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|targ_info
operator|->
name|disc_tag
operator|&
name|AMD_CUR_TAGENB
operator|)
operator|==
literal|0
operator|||
operator|(
name|identify_msg
operator|&
name|MSG_IDENTIFY_DISCFLAG
operator|)
operator|==
literal|0
condition|)
name|pccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&=
operator|~
name|CAM_TAG_ACTION_VALID
expr_stmt|;
if|if
condition|(
name|targ_info
operator|->
name|current
operator|.
name|period
operator|!=
name|targ_info
operator|->
name|goal
operator|.
name|period
operator|||
name|targ_info
operator|->
name|current
operator|.
name|offset
operator|!=
name|targ_info
operator|->
name|goal
operator|.
name|offset
condition|)
block|{
name|command
operator|=
name|SEL_W_ATN_STOP
expr_stmt|;
name|amdconstructsdtr
argument_list|(
name|amd
argument_list|,
name|targ_info
operator|->
name|goal
operator|.
name|period
argument_list|,
name|targ_info
operator|->
name|goal
operator|.
name|offset
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|pccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_TAG_ACTION_VALID
operator|)
operator|!=
literal|0
condition|)
block|{
name|command
operator|=
name|SEL_W_ATN2
expr_stmt|;
name|pSRB
operator|->
name|SRBState
operator|=
name|SRB_START
expr_stmt|;
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|SCSIFIFOREG
argument_list|,
name|pcsio
operator|->
name|tag_action
argument_list|)
expr_stmt|;
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|SCSIFIFOREG
argument_list|,
name|pSRB
operator|->
name|TagNumber
argument_list|)
expr_stmt|;
name|tagged
operator|++
expr_stmt|;
block|}
else|else
block|{
name|command
operator|=
name|SEL_W_ATN
expr_stmt|;
name|pSRB
operator|->
name|SRBState
operator|=
name|SRB_START
expr_stmt|;
block|}
if|if
condition|(
name|command
operator|!=
name|SEL_W_ATN_STOP
condition|)
name|amdsetupcommand
argument_list|(
name|amd
argument_list|,
name|pSRB
argument_list|)
expr_stmt|;
if|if
condition|(
name|amd_read8
argument_list|(
name|amd
argument_list|,
name|SCSISTATREG
argument_list|)
operator|&
name|INTERRUPT
condition|)
block|{
name|pSRB
operator|->
name|SRBState
operator|=
name|SRB_READY
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
else|else
block|{
name|amd
operator|->
name|last_phase
operator|=
name|SCSI_ARBITRATING
expr_stmt|;
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|SCSICMDREG
argument_list|,
name|command
argument_list|)
expr_stmt|;
name|amd
operator|->
name|active_srb
operator|=
name|pSRB
expr_stmt|;
name|amd
operator|->
name|cur_target
operator|=
name|target
expr_stmt|;
name|amd
operator|->
name|cur_lun
operator|=
name|lun
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
end_function

begin_comment
comment|/*  *  Catch an interrupt from the adapter.  *  Process pending device interrupts.  */
end_comment

begin_function
specifier|static
name|void
name|amd_intr
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|amd_softc
modifier|*
name|amd
decl_stmt|;
name|struct
name|amd_srb
modifier|*
name|pSRB
decl_stmt|;
name|u_int
name|internstat
init|=
literal|0
decl_stmt|;
name|u_int
name|scsistat
decl_stmt|;
name|u_int
name|intstat
decl_stmt|;
name|amd
operator|=
operator|(
expr|struct
name|amd_softc
operator|*
operator|)
name|arg
expr_stmt|;
if|if
condition|(
name|amd
operator|==
name|NULL
condition|)
block|{
ifdef|#
directive|ifdef
name|AMD_DEBUG0
name|printf
argument_list|(
literal|"amd_intr: amd NULL return......"
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
name|scsistat
operator|=
name|amd_read8
argument_list|(
name|amd
argument_list|,
name|SCSISTATREG
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|scsistat
operator|&
name|INTERRUPT
operator|)
condition|)
block|{
ifdef|#
directive|ifdef
name|AMD_DEBUG0
name|printf
argument_list|(
literal|"amd_intr: scsistat = NULL ,return......"
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
ifdef|#
directive|ifdef
name|AMD_DEBUG_SCSI_PHASE
name|printf
argument_list|(
literal|"scsistat=%2x,"
argument_list|,
name|scsistat
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|internstat
operator|=
name|amd_read8
argument_list|(
name|amd
argument_list|,
name|INTERNSTATREG
argument_list|)
expr_stmt|;
name|intstat
operator|=
name|amd_read8
argument_list|(
name|amd
argument_list|,
name|INTSTATREG
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|AMD_DEBUG_SCSI_PHASE
name|printf
argument_list|(
literal|"intstat=%2x,"
argument_list|,
name|intstat
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|intstat
operator|&
name|DISCONNECTED
condition|)
block|{
name|amd_Disconnect
argument_list|(
name|amd
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|intstat
operator|&
name|RESELECTED
condition|)
block|{
name|amd_Reselect
argument_list|(
name|amd
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|intstat
operator|&
name|INVALID_CMD
condition|)
block|{
name|amd_InvalidCmd
argument_list|(
name|amd
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|intstat
operator|&
name|SCSI_RESET_
condition|)
block|{
name|amd_ScsiRstDetect
argument_list|(
name|amd
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|intstat
operator|&
operator|(
name|SUCCESSFUL_OP
operator|+
name|SERVICE_REQUEST
operator|)
condition|)
block|{
name|pSRB
operator|=
name|amd
operator|->
name|active_srb
expr_stmt|;
comment|/* 		 * Run our state engine.  First perform 		 * post processing for the last phase we 		 * were in, followed by any processing 		 * required to handle the current phase. 		 */
name|scsistat
operator|=
name|amd_SCSI_phase0
index|[
name|amd
operator|->
name|last_phase
index|]
operator|(
name|amd
operator|,
name|pSRB
operator|,
name|scsistat
operator|)
expr_stmt|;
name|amd
operator|->
name|last_phase
operator|=
name|scsistat
operator|&
name|SCSI_PHASE_MASK
expr_stmt|;
operator|(
name|void
operator|)
name|amd_SCSI_phase1
index|[
name|amd
operator|->
name|last_phase
index|]
operator|(
name|amd
operator|,
name|pSRB
operator|,
name|scsistat
operator|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|u_int
name|amd_DataOutPhase0
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|,
name|struct
name|amd_srb
modifier|*
name|pSRB
parameter_list|,
name|u_int
name|scsistat
parameter_list|)
block|{
name|struct
name|amd_sg
modifier|*
name|psgl
decl_stmt|;
name|u_int32_t
name|ResidCnt
decl_stmt|,
name|xferCnt
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|pSRB
operator|->
name|SRBState
operator|&
name|SRB_XFERPAD
operator|)
condition|)
block|{
if|if
condition|(
name|scsistat
operator|&
name|PARITY_ERR
condition|)
block|{
name|pSRB
operator|->
name|SRBStatus
operator||=
name|PARITY_ERROR
expr_stmt|;
block|}
if|if
condition|(
name|scsistat
operator|&
name|COUNT_2_ZERO
condition|)
block|{
while|while
condition|(
operator|(
name|amd_read8
argument_list|(
name|amd
argument_list|,
name|DMA_Status
argument_list|)
operator|&
name|DMA_XFER_DONE
operator|)
operator|==
literal|0
condition|)
empty_stmt|;
name|pSRB
operator|->
name|TotalXferredLen
operator|+=
name|pSRB
operator|->
name|SGToBeXferLen
expr_stmt|;
name|pSRB
operator|->
name|SGIndex
operator|++
expr_stmt|;
if|if
condition|(
name|pSRB
operator|->
name|SGIndex
operator|<
name|pSRB
operator|->
name|SGcount
condition|)
block|{
name|pSRB
operator|->
name|pSGlist
operator|++
expr_stmt|;
name|psgl
operator|=
name|pSRB
operator|->
name|pSGlist
expr_stmt|;
name|pSRB
operator|->
name|SGPhysAddr
operator|=
name|psgl
operator|->
name|SGXPtr
expr_stmt|;
name|pSRB
operator|->
name|SGToBeXferLen
operator|=
name|psgl
operator|->
name|SGXLen
expr_stmt|;
block|}
else|else
block|{
name|pSRB
operator|->
name|SGToBeXferLen
operator|=
literal|0
expr_stmt|;
block|}
block|}
else|else
block|{
name|ResidCnt
operator|=
name|amd_read8
argument_list|(
name|amd
argument_list|,
name|CURRENTFIFOREG
argument_list|)
operator|&
literal|0x1f
expr_stmt|;
name|ResidCnt
operator|+=
name|amd_read8
argument_list|(
name|amd
argument_list|,
name|CTCREG_LOW
argument_list|)
operator||
operator|(
name|amd_read8
argument_list|(
name|amd
argument_list|,
name|CTCREG_MID
argument_list|)
operator|<<
literal|8
operator|)
operator||
operator|(
name|amd_read8
argument_list|(
name|amd
argument_list|,
name|CURTXTCNTREG
argument_list|)
operator|<<
literal|16
operator|)
expr_stmt|;
name|xferCnt
operator|=
name|pSRB
operator|->
name|SGToBeXferLen
operator|-
name|ResidCnt
expr_stmt|;
name|pSRB
operator|->
name|SGPhysAddr
operator|+=
name|xferCnt
expr_stmt|;
name|pSRB
operator|->
name|TotalXferredLen
operator|+=
name|xferCnt
expr_stmt|;
name|pSRB
operator|->
name|SGToBeXferLen
operator|=
name|ResidCnt
expr_stmt|;
block|}
block|}
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|DMA_Cmd
argument_list|,
name|WRITE_DIRECTION
operator||
name|DMA_IDLE_CMD
argument_list|)
expr_stmt|;
return|return
operator|(
name|scsistat
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|u_int
name|amd_DataInPhase0
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|,
name|struct
name|amd_srb
modifier|*
name|pSRB
parameter_list|,
name|u_int
name|scsistat
parameter_list|)
block|{
name|u_int8_t
name|bval
decl_stmt|;
name|u_int16_t
name|i
decl_stmt|,
name|residual
decl_stmt|;
name|struct
name|amd_sg
modifier|*
name|psgl
decl_stmt|;
name|u_int32_t
name|ResidCnt
decl_stmt|,
name|xferCnt
decl_stmt|;
name|u_int8_t
modifier|*
name|ptr
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|pSRB
operator|->
name|SRBState
operator|&
name|SRB_XFERPAD
operator|)
condition|)
block|{
if|if
condition|(
name|scsistat
operator|&
name|PARITY_ERR
condition|)
block|{
name|pSRB
operator|->
name|SRBStatus
operator||=
name|PARITY_ERROR
expr_stmt|;
block|}
if|if
condition|(
name|scsistat
operator|&
name|COUNT_2_ZERO
condition|)
block|{
while|while
condition|(
literal|1
condition|)
block|{
name|bval
operator|=
name|amd_read8
argument_list|(
name|amd
argument_list|,
name|DMA_Status
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|bval
operator|&
name|DMA_XFER_DONE
operator|)
operator|!=
literal|0
condition|)
break|break;
block|}
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|DMA_Cmd
argument_list|,
name|READ_DIRECTION
operator||
name|DMA_IDLE_CMD
argument_list|)
expr_stmt|;
name|pSRB
operator|->
name|TotalXferredLen
operator|+=
name|pSRB
operator|->
name|SGToBeXferLen
expr_stmt|;
name|pSRB
operator|->
name|SGIndex
operator|++
expr_stmt|;
if|if
condition|(
name|pSRB
operator|->
name|SGIndex
operator|<
name|pSRB
operator|->
name|SGcount
condition|)
block|{
name|pSRB
operator|->
name|pSGlist
operator|++
expr_stmt|;
name|psgl
operator|=
name|pSRB
operator|->
name|pSGlist
expr_stmt|;
name|pSRB
operator|->
name|SGPhysAddr
operator|=
name|psgl
operator|->
name|SGXPtr
expr_stmt|;
name|pSRB
operator|->
name|SGToBeXferLen
operator|=
name|psgl
operator|->
name|SGXLen
expr_stmt|;
block|}
else|else
block|{
name|pSRB
operator|->
name|SGToBeXferLen
operator|=
literal|0
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* phase changed */
name|residual
operator|=
literal|0
expr_stmt|;
name|bval
operator|=
name|amd_read8
argument_list|(
name|amd
argument_list|,
name|CURRENTFIFOREG
argument_list|)
expr_stmt|;
while|while
condition|(
name|bval
operator|&
literal|0x1f
condition|)
block|{
if|if
condition|(
operator|(
name|bval
operator|&
literal|0x1f
operator|)
operator|==
literal|1
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|0x100
condition|;
name|i
operator|++
control|)
block|{
name|bval
operator|=
name|amd_read8
argument_list|(
name|amd
argument_list|,
name|CURRENTFIFOREG
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|bval
operator|&
literal|0x1f
operator|)
condition|)
block|{
goto|goto
name|din_1
goto|;
block|}
elseif|else
if|if
condition|(
name|i
operator|==
literal|0x0ff
condition|)
block|{
name|residual
operator|=
literal|1
expr_stmt|;
goto|goto
name|din_1
goto|;
block|}
block|}
block|}
else|else
block|{
name|bval
operator|=
name|amd_read8
argument_list|(
name|amd
argument_list|,
name|CURRENTFIFOREG
argument_list|)
expr_stmt|;
block|}
block|}
name|din_1
label|:
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|DMA_Cmd
argument_list|,
name|READ_DIRECTION
operator||
name|DMA_BLAST_CMD
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|0x8000
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|amd_read8
argument_list|(
name|amd
argument_list|,
name|DMA_Status
argument_list|)
operator|&
name|BLAST_COMPLETE
operator|)
condition|)
break|break;
block|}
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|DMA_Cmd
argument_list|,
name|READ_DIRECTION
operator||
name|DMA_IDLE_CMD
argument_list|)
expr_stmt|;
name|ResidCnt
operator|=
name|amd_read8
argument_list|(
name|amd
argument_list|,
name|CTCREG_LOW
argument_list|)
operator||
operator|(
name|amd_read8
argument_list|(
name|amd
argument_list|,
name|CTCREG_MID
argument_list|)
operator|<<
literal|8
operator|)
operator||
operator|(
name|amd_read8
argument_list|(
name|amd
argument_list|,
name|CURTXTCNTREG
argument_list|)
operator|<<
literal|16
operator|)
expr_stmt|;
name|xferCnt
operator|=
name|pSRB
operator|->
name|SGToBeXferLen
operator|-
name|ResidCnt
expr_stmt|;
name|pSRB
operator|->
name|SGPhysAddr
operator|+=
name|xferCnt
expr_stmt|;
name|pSRB
operator|->
name|TotalXferredLen
operator|+=
name|xferCnt
expr_stmt|;
name|pSRB
operator|->
name|SGToBeXferLen
operator|=
name|ResidCnt
expr_stmt|;
if|if
condition|(
name|residual
condition|)
block|{
comment|/* get residual byte */
name|bval
operator|=
name|amd_read8
argument_list|(
name|amd
argument_list|,
name|SCSIFIFOREG
argument_list|)
expr_stmt|;
name|ptr
operator|=
name|phystovirt
argument_list|(
name|pSRB
argument_list|,
name|xferCnt
argument_list|)
expr_stmt|;
operator|*
name|ptr
operator|=
name|bval
expr_stmt|;
name|pSRB
operator|->
name|SGPhysAddr
operator|++
expr_stmt|;
name|pSRB
operator|->
name|TotalXferredLen
operator|++
expr_stmt|;
name|pSRB
operator|->
name|SGToBeXferLen
operator|--
expr_stmt|;
block|}
block|}
block|}
return|return
operator|(
name|scsistat
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|u_int
name|amd_StatusPhase0
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|,
name|struct
name|amd_srb
modifier|*
name|pSRB
parameter_list|,
name|u_int
name|scsistat
parameter_list|)
block|{
name|pSRB
operator|->
name|TargetStatus
operator|=
name|amd_read8
argument_list|(
name|amd
argument_list|,
name|SCSIFIFOREG
argument_list|)
expr_stmt|;
comment|/* get message */
name|pSRB
operator|->
name|EndMessage
operator|=
name|amd_read8
argument_list|(
name|amd
argument_list|,
name|SCSIFIFOREG
argument_list|)
expr_stmt|;
name|pSRB
operator|->
name|SRBState
operator|=
name|SRB_COMPLETED
expr_stmt|;
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|SCSICMDREG
argument_list|,
name|MSG_ACCEPTED_CMD
argument_list|)
expr_stmt|;
return|return
operator|(
name|SCSI_NOP0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|u_int
name|amd_MsgOutPhase0
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|,
name|struct
name|amd_srb
modifier|*
name|pSRB
parameter_list|,
name|u_int
name|scsistat
parameter_list|)
block|{
if|if
condition|(
name|pSRB
operator|->
name|SRBState
operator|&
operator|(
name|SRB_UNEXPECT_RESEL
operator|+
name|SRB_ABORT_SENT
operator|)
condition|)
block|{
name|scsistat
operator|=
name|SCSI_NOP0
expr_stmt|;
block|}
return|return
operator|(
name|scsistat
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|u_int
name|amd_MsgInPhase0
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|,
name|struct
name|amd_srb
modifier|*
name|pSRB
parameter_list|,
name|u_int
name|scsistat
parameter_list|)
block|{
name|int
name|done
decl_stmt|;
name|amd
operator|->
name|msgin_buf
index|[
name|amd
operator|->
name|msgin_index
index|]
operator|=
name|amd_read8
argument_list|(
name|amd
argument_list|,
name|SCSIFIFOREG
argument_list|)
expr_stmt|;
name|done
operator|=
name|amdparsemsg
argument_list|(
name|amd
argument_list|)
expr_stmt|;
if|if
condition|(
name|done
condition|)
name|amd
operator|->
name|msgin_index
operator|=
literal|0
expr_stmt|;
else|else
name|amd
operator|->
name|msgin_index
operator|++
expr_stmt|;
return|return
operator|(
name|SCSI_NOP0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|amdparsemsg
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|)
block|{
name|struct
name|amd_target_info
modifier|*
name|targ_info
decl_stmt|;
name|int
name|reject
decl_stmt|;
name|int
name|done
decl_stmt|;
name|int
name|response
decl_stmt|;
name|done
operator|=
name|FALSE
expr_stmt|;
name|response
operator|=
name|FALSE
expr_stmt|;
name|reject
operator|=
name|FALSE
expr_stmt|;
name|targ_info
operator|=
operator|&
name|amd
operator|->
name|tinfo
index|[
name|amd
operator|->
name|cur_target
index|]
expr_stmt|;
comment|/* 	 * Parse as much of the message as is availible, 	 * rejecting it if we don't support it.  When 	 * the entire message is availible and has been 	 * handled, return TRUE indicating that we have 	 * parsed an entire message. 	 */
switch|switch
condition|(
name|amd
operator|->
name|msgin_buf
index|[
literal|0
index|]
condition|)
block|{
case|case
name|MSG_DISCONNECT
case|:
name|amd
operator|->
name|active_srb
operator|->
name|SRBState
operator|=
name|SRB_DISCONNECT
expr_stmt|;
name|amd
operator|->
name|disc_count
index|[
name|amd
operator|->
name|cur_target
index|]
index|[
name|amd
operator|->
name|cur_lun
index|]
operator|++
expr_stmt|;
name|done
operator|=
name|TRUE
expr_stmt|;
break|break;
case|case
name|MSG_SIMPLE_Q_TAG
case|:
block|{
name|struct
name|amd_srb
modifier|*
name|disc_srb
decl_stmt|;
if|if
condition|(
name|amd
operator|->
name|msgin_index
operator|<
literal|1
condition|)
break|break;
name|disc_srb
operator|=
operator|&
name|amd
operator|->
name|SRB_array
index|[
name|amd
operator|->
name|msgin_buf
index|[
literal|1
index|]
index|]
expr_stmt|;
if|if
condition|(
name|amd
operator|->
name|active_srb
operator|!=
name|NULL
operator|||
name|disc_srb
operator|->
name|SRBState
operator|!=
name|SRB_DISCONNECT
operator|||
name|disc_srb
operator|->
name|pccb
operator|->
name|ccb_h
operator|.
name|target_id
operator|!=
name|amd
operator|->
name|cur_target
operator|||
name|disc_srb
operator|->
name|pccb
operator|->
name|ccb_h
operator|.
name|target_lun
operator|!=
name|amd
operator|->
name|cur_lun
condition|)
block|{
name|printf
argument_list|(
literal|"amd%d: Unexpected tagged reselection "
literal|"for target %d, Issuing Abort\n"
argument_list|,
name|amd
operator|->
name|unit
argument_list|,
name|amd
operator|->
name|cur_target
argument_list|)
expr_stmt|;
name|amd
operator|->
name|msgout_buf
index|[
literal|0
index|]
operator|=
name|MSG_ABORT
expr_stmt|;
name|amd
operator|->
name|msgout_len
operator|=
literal|1
expr_stmt|;
name|response
operator|=
name|TRUE
expr_stmt|;
break|break;
block|}
name|amd
operator|->
name|active_srb
operator|=
name|disc_srb
expr_stmt|;
name|amd
operator|->
name|disc_count
index|[
name|amd
operator|->
name|cur_target
index|]
index|[
name|amd
operator|->
name|cur_lun
index|]
operator|--
expr_stmt|;
name|done
operator|=
name|TRUE
expr_stmt|;
break|break;
block|}
case|case
name|MSG_MESSAGE_REJECT
case|:
name|response
operator|=
name|amdhandlemsgreject
argument_list|(
name|amd
argument_list|)
expr_stmt|;
if|if
condition|(
name|response
operator|==
name|FALSE
condition|)
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|SCSICMDREG
argument_list|,
name|RESET_ATN_CMD
argument_list|)
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|MSG_NOOP
case|:
name|done
operator|=
name|TRUE
expr_stmt|;
break|break;
case|case
name|MSG_EXTENDED
case|:
block|{
name|u_int
name|clockrate
decl_stmt|;
name|u_int
name|period
decl_stmt|;
name|u_int
name|offset
decl_stmt|;
name|u_int
name|saved_offset
decl_stmt|;
comment|/* Wait for enough of the message to begin validation */
if|if
condition|(
name|amd
operator|->
name|msgin_index
operator|<
literal|1
condition|)
break|break;
if|if
condition|(
name|amd
operator|->
name|msgin_buf
index|[
literal|1
index|]
operator|!=
name|MSG_EXT_SDTR_LEN
condition|)
block|{
name|reject
operator|=
name|TRUE
expr_stmt|;
break|break;
block|}
comment|/* Wait for opcode */
if|if
condition|(
name|amd
operator|->
name|msgin_index
operator|<
literal|2
condition|)
break|break;
if|if
condition|(
name|amd
operator|->
name|msgin_buf
index|[
literal|2
index|]
operator|!=
name|MSG_EXT_SDTR
condition|)
block|{
name|reject
operator|=
name|TRUE
expr_stmt|;
break|break;
block|}
comment|/* 		 * Wait until we have both args before validating 		 * and acting on this message. 		 * 		 * Add one to MSG_EXT_SDTR_LEN to account for 		 * the extended message preamble. 		 */
if|if
condition|(
name|amd
operator|->
name|msgin_index
operator|<
operator|(
name|MSG_EXT_SDTR_LEN
operator|+
literal|1
operator|)
condition|)
break|break;
name|period
operator|=
name|amd
operator|->
name|msgin_buf
index|[
literal|3
index|]
expr_stmt|;
name|saved_offset
operator|=
name|offset
operator|=
name|amd
operator|->
name|msgin_buf
index|[
literal|4
index|]
expr_stmt|;
name|clockrate
operator|=
name|amdfindclockrate
argument_list|(
name|amd
argument_list|,
operator|&
name|period
argument_list|)
expr_stmt|;
if|if
condition|(
name|offset
operator|>
name|AMD_MAX_SYNC_OFFSET
condition|)
name|offset
operator|=
name|AMD_MAX_SYNC_OFFSET
expr_stmt|;
if|if
condition|(
name|period
operator|==
literal|0
operator|||
name|offset
operator|==
literal|0
condition|)
block|{
name|offset
operator|=
literal|0
expr_stmt|;
name|period
operator|=
literal|0
expr_stmt|;
name|clockrate
operator|=
literal|0
expr_stmt|;
block|}
name|amdsetsync
argument_list|(
name|amd
argument_list|,
name|amd
operator|->
name|cur_target
argument_list|,
name|clockrate
argument_list|,
name|period
argument_list|,
name|offset
argument_list|,
name|AMD_TRANS_ACTIVE
operator||
name|AMD_TRANS_GOAL
argument_list|)
expr_stmt|;
comment|/* 		 * See if we initiated Sync Negotiation 		 * and didn't have to fall down to async 		 * transfers. 		 */
if|if
condition|(
name|amdsentmsg
argument_list|(
name|amd
argument_list|,
name|MSG_EXT_SDTR
argument_list|,
comment|/*full*/
name|TRUE
argument_list|)
condition|)
block|{
comment|/* We started it */
if|if
condition|(
name|saved_offset
operator|!=
name|offset
condition|)
block|{
comment|/* Went too low - force async */
name|reject
operator|=
name|TRUE
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* 			 * Send our own SDTR in reply 			 */
if|if
condition|(
name|bootverbose
condition|)
name|printf
argument_list|(
literal|"Sending SDTR!\n"
argument_list|)
expr_stmt|;
name|amd
operator|->
name|msgout_index
operator|=
literal|0
expr_stmt|;
name|amd
operator|->
name|msgout_len
operator|=
literal|0
expr_stmt|;
name|amdconstructsdtr
argument_list|(
name|amd
argument_list|,
name|period
argument_list|,
name|offset
argument_list|)
expr_stmt|;
name|amd
operator|->
name|msgout_index
operator|=
literal|0
expr_stmt|;
name|response
operator|=
name|TRUE
expr_stmt|;
block|}
name|done
operator|=
name|TRUE
expr_stmt|;
break|break;
block|}
case|case
name|MSG_SAVEDATAPOINTER
case|:
case|case
name|MSG_RESTOREPOINTERS
case|:
comment|/* XXX Implement!!! */
name|done
operator|=
name|TRUE
expr_stmt|;
break|break;
default|default:
name|reject
operator|=
name|TRUE
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|reject
condition|)
block|{
name|amd
operator|->
name|msgout_index
operator|=
literal|0
expr_stmt|;
name|amd
operator|->
name|msgout_len
operator|=
literal|1
expr_stmt|;
name|amd
operator|->
name|msgout_buf
index|[
literal|0
index|]
operator|=
name|MSG_MESSAGE_REJECT
expr_stmt|;
name|done
operator|=
name|TRUE
expr_stmt|;
name|response
operator|=
name|TRUE
expr_stmt|;
block|}
if|if
condition|(
name|response
condition|)
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|SCSICMDREG
argument_list|,
name|SET_ATN_CMD
argument_list|)
expr_stmt|;
if|if
condition|(
name|done
operator|&&
operator|!
name|response
condition|)
comment|/* Clear the outgoing message buffer */
name|amd
operator|->
name|msgout_len
operator|=
literal|0
expr_stmt|;
comment|/* Drop Ack */
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|SCSICMDREG
argument_list|,
name|MSG_ACCEPTED_CMD
argument_list|)
expr_stmt|;
return|return
operator|(
name|done
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|u_int
name|amdfindclockrate
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|,
name|u_int
modifier|*
name|period
parameter_list|)
block|{
name|u_int
name|i
decl_stmt|;
name|u_int
name|clockrate
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|tinfo_sync_period
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|u_int8_t
modifier|*
name|table_entry
decl_stmt|;
name|table_entry
operator|=
operator|&
name|tinfo_sync_period
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
operator|*
name|period
operator|<=
operator|*
name|table_entry
condition|)
block|{
comment|/* 			 * When responding to a target that requests 			 * sync, the requested rate may fall between 			 * two rates that we can output, but still be 			 * a rate that we can receive.  Because of this, 			 * we want to respond to the target with 			 * the same rate that it sent to us even 			 * if the period we use to send data to it 			 * is lower.  Only lower the response period 			 * if we must. 			 */
if|if
condition|(
name|i
operator|==
literal|0
condition|)
block|{
operator|*
name|period
operator|=
operator|*
name|table_entry
expr_stmt|;
block|}
break|break;
block|}
block|}
if|if
condition|(
name|i
operator|==
sizeof|sizeof
argument_list|(
name|tinfo_sync_period
argument_list|)
condition|)
block|{
comment|/* Too slow for us.  Use asnyc transfers. */
operator|*
name|period
operator|=
literal|0
expr_stmt|;
name|clockrate
operator|=
literal|0
expr_stmt|;
block|}
else|else
name|clockrate
operator|=
name|i
operator|+
literal|4
expr_stmt|;
return|return
operator|(
name|clockrate
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * See if we sent a particular extended message to the target.  * If "full" is true, the target saw the full message.  * If "full" is false, the target saw at least the first  * byte of the message.  */
end_comment

begin_function
specifier|static
name|int
name|amdsentmsg
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|,
name|u_int
name|msgtype
parameter_list|,
name|int
name|full
parameter_list|)
block|{
name|int
name|found
decl_stmt|;
name|int
name|index
decl_stmt|;
name|found
operator|=
name|FALSE
expr_stmt|;
name|index
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|index
operator|<
name|amd
operator|->
name|msgout_len
condition|)
block|{
if|if
condition|(
operator|(
name|amd
operator|->
name|msgout_buf
index|[
name|index
index|]
operator|&
name|MSG_IDENTIFYFLAG
operator|)
operator|!=
literal|0
operator|||
name|amd
operator|->
name|msgout_buf
index|[
name|index
index|]
operator|==
name|MSG_MESSAGE_REJECT
condition|)
name|index
operator|++
expr_stmt|;
elseif|else
if|if
condition|(
name|amd
operator|->
name|msgout_buf
index|[
name|index
index|]
operator|>=
name|MSG_SIMPLE_Q_TAG
operator|&&
name|amd
operator|->
name|msgout_buf
index|[
name|index
index|]
operator|<
name|MSG_IGN_WIDE_RESIDUE
condition|)
block|{
comment|/* Skip tag type and tag id */
name|index
operator|+=
literal|2
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|amd
operator|->
name|msgout_buf
index|[
name|index
index|]
operator|==
name|MSG_EXTENDED
condition|)
block|{
comment|/* Found a candidate */
if|if
condition|(
name|amd
operator|->
name|msgout_buf
index|[
name|index
operator|+
literal|2
index|]
operator|==
name|msgtype
condition|)
block|{
name|u_int
name|end_index
decl_stmt|;
name|end_index
operator|=
name|index
operator|+
literal|1
operator|+
name|amd
operator|->
name|msgout_buf
index|[
name|index
operator|+
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|full
condition|)
block|{
if|if
condition|(
name|amd
operator|->
name|msgout_index
operator|>
name|end_index
condition|)
name|found
operator|=
name|TRUE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|amd
operator|->
name|msgout_index
operator|>
name|index
condition|)
name|found
operator|=
name|TRUE
expr_stmt|;
block|}
break|break;
block|}
else|else
block|{
name|panic
argument_list|(
literal|"amdsentmsg: Inconsistent msg buffer"
argument_list|)
expr_stmt|;
block|}
block|}
return|return
operator|(
name|found
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|amdconstructsdtr
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|,
name|u_int
name|period
parameter_list|,
name|u_int
name|offset
parameter_list|)
block|{
name|amd
operator|->
name|msgout_buf
index|[
name|amd
operator|->
name|msgout_index
operator|++
index|]
operator|=
name|MSG_EXTENDED
expr_stmt|;
name|amd
operator|->
name|msgout_buf
index|[
name|amd
operator|->
name|msgout_index
operator|++
index|]
operator|=
name|MSG_EXT_SDTR_LEN
expr_stmt|;
name|amd
operator|->
name|msgout_buf
index|[
name|amd
operator|->
name|msgout_index
operator|++
index|]
operator|=
name|MSG_EXT_SDTR
expr_stmt|;
name|amd
operator|->
name|msgout_buf
index|[
name|amd
operator|->
name|msgout_index
operator|++
index|]
operator|=
name|period
expr_stmt|;
name|amd
operator|->
name|msgout_buf
index|[
name|amd
operator|->
name|msgout_index
operator|++
index|]
operator|=
name|offset
expr_stmt|;
name|amd
operator|->
name|msgout_len
operator|+=
literal|5
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|amdhandlemsgreject
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|)
block|{
comment|/* 	 * If we had an outstanding SDTR for this 	 * target, this is a signal that the target 	 * is refusing negotiation.  Also watch out 	 * for rejected tag messages. 	 */
name|struct
name|amd_srb
modifier|*
name|srb
decl_stmt|;
name|struct
name|amd_target_info
modifier|*
name|targ_info
decl_stmt|;
name|int
name|response
init|=
name|FALSE
decl_stmt|;
name|srb
operator|=
name|amd
operator|->
name|active_srb
expr_stmt|;
name|targ_info
operator|=
operator|&
name|amd
operator|->
name|tinfo
index|[
name|amd
operator|->
name|cur_target
index|]
expr_stmt|;
if|if
condition|(
name|amdsentmsg
argument_list|(
name|amd
argument_list|,
name|MSG_EXT_SDTR
argument_list|,
comment|/*full*/
name|FALSE
argument_list|)
condition|)
block|{
comment|/* note asynch xfers and clear flag */
name|amdsetsync
argument_list|(
name|amd
argument_list|,
name|amd
operator|->
name|cur_target
argument_list|,
comment|/*clockrate*/
literal|0
argument_list|,
comment|/*period*/
literal|0
argument_list|,
comment|/*offset*/
literal|0
argument_list|,
name|AMD_TRANS_ACTIVE
operator||
name|AMD_TRANS_GOAL
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"amd%d:%d: refuses synchronous negotiation. "
literal|"Using asynchronous transfers\n"
argument_list|,
name|amd
operator|->
name|unit
argument_list|,
name|amd
operator|->
name|cur_target
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|srb
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|srb
operator|->
name|pccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_TAG_ACTION_VALID
operator|)
operator|!=
literal|0
condition|)
block|{
name|struct
name|ccb_trans_settings
name|neg
decl_stmt|;
name|printf
argument_list|(
literal|"amd%d:%d: refuses tagged commands.  Performing "
literal|"non-tagged I/O\n"
argument_list|,
name|amd
operator|->
name|unit
argument_list|,
name|amd
operator|->
name|cur_target
argument_list|)
expr_stmt|;
name|amdsettags
argument_list|(
name|amd
argument_list|,
name|amd
operator|->
name|cur_target
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|neg
operator|.
name|flags
operator|=
literal|0
expr_stmt|;
name|neg
operator|.
name|valid
operator|=
name|CCB_TRANS_TQ_VALID
expr_stmt|;
name|xpt_setup_ccb
argument_list|(
operator|&
name|neg
operator|.
name|ccb_h
argument_list|,
name|srb
operator|->
name|pccb
operator|->
name|ccb_h
operator|.
name|path
argument_list|,
comment|/*priority*/
literal|1
argument_list|)
expr_stmt|;
name|xpt_async
argument_list|(
name|AC_TRANSFER_NEG
argument_list|,
name|srb
operator|->
name|pccb
operator|->
name|ccb_h
operator|.
name|path
argument_list|,
operator|&
name|neg
argument_list|)
expr_stmt|;
comment|/* 		 * Resend the identify for this CCB as the target 		 * may believe that the selection is invalid otherwise. 		 */
if|if
condition|(
name|amd
operator|->
name|msgout_len
operator|!=
literal|0
condition|)
name|bcopy
argument_list|(
operator|&
name|amd
operator|->
name|msgout_buf
index|[
literal|0
index|]
argument_list|,
operator|&
name|amd
operator|->
name|msgout_buf
index|[
literal|1
index|]
argument_list|,
name|amd
operator|->
name|msgout_len
argument_list|)
expr_stmt|;
name|amd
operator|->
name|msgout_buf
index|[
literal|0
index|]
operator|=
name|MSG_IDENTIFYFLAG
operator||
name|srb
operator|->
name|pccb
operator|->
name|ccb_h
operator|.
name|target_lun
expr_stmt|;
name|amd
operator|->
name|msgout_len
operator|++
expr_stmt|;
if|if
condition|(
operator|(
name|targ_info
operator|->
name|disc_tag
operator|&
name|AMD_CUR_DISCENB
operator|)
operator|!=
literal|0
operator|&&
operator|(
name|srb
operator|->
name|pccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_DIS_DISCONNECT
operator|)
operator|==
literal|0
condition|)
name|amd
operator|->
name|msgout_buf
index|[
literal|0
index|]
operator||=
name|MSG_IDENTIFY_DISCFLAG
expr_stmt|;
name|srb
operator|->
name|pccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&=
operator|~
name|CAM_TAG_ACTION_VALID
expr_stmt|;
comment|/* 		 * Requeue all tagged commands for this target 		 * currently in our posession so they can be 		 * converted to untagged commands. 		 */
name|amdcompletematch
argument_list|(
name|amd
argument_list|,
name|amd
operator|->
name|cur_target
argument_list|,
name|amd
operator|->
name|cur_lun
argument_list|,
name|AMD_TAG_WILDCARD
argument_list|,
operator|&
name|amd
operator|->
name|waiting_srbs
argument_list|,
name|CAM_DEV_QFRZN
operator||
name|CAM_REQUEUE_REQ
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* 		 * Otherwise, we ignore it. 		 */
name|printf
argument_list|(
literal|"amd%d:%d: Message reject received -- ignored\n"
argument_list|,
name|amd
operator|->
name|unit
argument_list|,
name|amd
operator|->
name|cur_target
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|response
operator|)
return|;
block|}
end_function

begin_if
if|#
directive|if
literal|0
end_if

begin_comment
unit|if (!(pSRB->SRBState& SRB_MSGIN_MULTI)) { 		if (bval == MSG_DISCONNECT) { 			pSRB->SRBState = SRB_DISCONNECT; 		} else if (bval == MSG_SAVEDATAPOINTER) { 			goto min6; 		} else if ((bval == MSG_EXTENDED) 			|| ((bval>= MSG_SIMPLE_Q_TAG)&& (bval<= MSG_ORDERED_Q_TAG))) { 			pSRB->SRBState |= SRB_MSGIN_MULTI; 			pSRB->MsgInBuf[0] = bval; 			pSRB->MsgCnt = 1; 			pSRB->pMsgPtr =&pSRB->MsgInBuf[1]; 		} else if (bval == MSG_MESSAGE_REJECT) { 			amd_write8(amd, SCSICMDREG, RESET_ATN_CMD);  			if (pSRB->SRBState& DO_SYNC_NEGO) { 				goto set_async; 			} 		} else if (bval == MSG_RESTOREPOINTERS) { 			goto min6; 		} else { 			goto min6; 		} 	} else {
comment|/* minx: */
end_comment

begin_comment
unit|*pSRB->pMsgPtr = bval; 		pSRB->MsgCnt++; 		pSRB->pMsgPtr++; 		if ((pSRB->MsgInBuf[0]>= MSG_SIMPLE_Q_TAG)&& (pSRB->MsgInBuf[0]<= MSG_ORDERED_Q_TAG)) { 			if (pSRB->MsgCnt == 2) { 				pSRB->SRBState = 0; 				pSRB =&amd->SRB_array[pSRB->MsgInBuf[1]]; 				if (pSRB->SRBState& SRB_DISCONNECT) == 0) { 					pSRB = amd->pTmpSRB; 					pSRB->SRBState = SRB_UNEXPECT_RESEL; 					pDCB->pActiveSRB = pSRB; 					pSRB->MsgOutBuf[0] = MSG_ABORT_TAG; 					EnableMsgOut2(amd, pSRB); 				} else { 					if (pDCB->DCBFlag& ABORT_DEV_) { 						pSRB->SRBState = SRB_ABORT_SENT; 						EnableMsgOut1(amd, pSRB); 					} 					pDCB->pActiveSRB = pSRB; 					pSRB->SRBState = SRB_DATA_XFER; 				} 			} 		} else if ((pSRB->MsgInBuf[0] == MSG_EXTENDED)&& (pSRB->MsgCnt == 5)) { 			pSRB->SRBState&= ~(SRB_MSGIN_MULTI + DO_SYNC_NEGO); 			if ((pSRB->MsgInBuf[1] != 3) 			 || (pSRB->MsgInBuf[2] != 1)) {
comment|/* reject_msg: */
end_comment

begin_comment
unit|pSRB->MsgCnt = 1; 				pSRB->MsgInBuf[0] = MSG_MESSAGE_REJECT; 				amd_write8(amd, SCSICMDREG, SET_ATN_CMD); 			} else if (!(pSRB->MsgInBuf[3]) 				|| !(pSRB->MsgInBuf[4])) { 		set_async:
comment|/* set async */
end_comment

begin_comment
unit|pDCB = pSRB->pSRBDCB;
comment|/* disable sync& sync nego */
end_comment

begin_comment
unit|pDCB->SyncMode&= ~(SYNC_ENABLE|SYNC_NEGO_DONE); 				pDCB->SyncPeriod = 0; 				pDCB->SyncOffset = 0;  				pDCB->tinfo.goal.period = 0; 				pDCB->tinfo.goal.offset = 0;  				pDCB->tinfo.current.period = 0; 				pDCB->tinfo.current.offset = 0; 				pDCB->tinfo.current.width = 				    MSG_EXT_WDTR_BUS_8_BIT;  				pDCB->CtrlR3 = FAST_CLK;
comment|/* non_fast */
end_comment

begin_comment
unit|pDCB->CtrlR4&= 0x3f; 				pDCB->CtrlR4 |= EATER_25NS;  				goto re_prog; 			} else {
comment|/* set sync */
end_comment

begin_comment
unit|pDCB = pSRB->pSRBDCB;
comment|/* enable sync& sync nego */
end_comment

begin_comment
unit|pDCB->SyncMode |= SYNC_ENABLE|SYNC_NEGO_DONE;
comment|/* set sync offset */
end_comment

begin_comment
unit|pDCB->SyncOffset&= 0x0f0; 				pDCB->SyncOffset |= pSRB->MsgInBuf[4];
comment|/* set sync period */
end_comment

begin_comment
unit|pDCB->MaxNegoPeriod = pSRB->MsgInBuf[3];  				wval = (u_int16_t) pSRB->MsgInBuf[3]; 				wval = wval<< 2; 				wval--; 				wval1 = wval / 25; 				if ((wval1 * 25) != wval) { 					wval1++; 				} 				bval = FAST_CLK|FAST_SCSI; 				pDCB->CtrlR4&= 0x3f; 				if (wval1>= 8) {
comment|/* Fast SCSI */
end_comment

begin_comment
unit|wval1--; 					bval = FAST_CLK; 					pDCB->CtrlR4 |= EATER_25NS; 				} 				pDCB->CtrlR3 = bval; 				pDCB->SyncPeriod = (u_int8_t) wval1;  				pDCB->tinfo.goal.period = 				    tinfo_sync_period[pDCB->SyncPeriod - 4]; 				pDCB->tinfo.goal.offset = pDCB->SyncOffset; 				pDCB->tinfo.current.period = 				    tinfo_sync_period[pDCB->SyncPeriod - 4];; 				pDCB->tinfo.current.offset = pDCB->SyncOffset;
comment|/* 				 * program SCSI control register 				 */
end_comment

begin_endif
unit|re_prog: 				amd_write8(amd, SYNCPERIOREG, pDCB->SyncPeriod); 				amd_write8(amd, SYNCOFFREG, pDCB->SyncOffset); 				amd_write8(amd, CNTLREG3, pDCB->CtrlR3); 				amd_write8(amd, CNTLREG4, pDCB->CtrlR4); 			} 		} 	} min6: 	amd_write8(amd, SCSICMDREG, MSG_ACCEPTED_CMD); 	return (SCSI_NOP0); }
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|u_int
name|amd_DataOutPhase1
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|,
name|struct
name|amd_srb
modifier|*
name|pSRB
parameter_list|,
name|u_int
name|scsistat
parameter_list|)
block|{
name|DataIO_Comm
argument_list|(
name|amd
argument_list|,
name|pSRB
argument_list|,
name|WRITE_DIRECTION
argument_list|)
expr_stmt|;
return|return
operator|(
name|scsistat
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|u_int
name|amd_DataInPhase1
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|,
name|struct
name|amd_srb
modifier|*
name|pSRB
parameter_list|,
name|u_int
name|scsistat
parameter_list|)
block|{
name|DataIO_Comm
argument_list|(
name|amd
argument_list|,
name|pSRB
argument_list|,
name|READ_DIRECTION
argument_list|)
expr_stmt|;
return|return
operator|(
name|scsistat
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|DataIO_Comm
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|,
name|struct
name|amd_srb
modifier|*
name|pSRB
parameter_list|,
name|u_int
name|ioDir
parameter_list|)
block|{
name|struct
name|amd_sg
modifier|*
name|psgl
decl_stmt|;
name|u_int32_t
name|lval
decl_stmt|;
if|if
condition|(
name|pSRB
operator|->
name|SGIndex
operator|<
name|pSRB
operator|->
name|SGcount
condition|)
block|{
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|DMA_Cmd
argument_list|,
name|DMA_IDLE_CMD
operator||
name|ioDir
argument_list|)
expr_stmt|;
comment|/* |EN_DMA_INT */
if|if
condition|(
operator|!
name|pSRB
operator|->
name|SGToBeXferLen
condition|)
block|{
name|psgl
operator|=
name|pSRB
operator|->
name|pSGlist
expr_stmt|;
name|pSRB
operator|->
name|SGPhysAddr
operator|=
name|psgl
operator|->
name|SGXPtr
expr_stmt|;
name|pSRB
operator|->
name|SGToBeXferLen
operator|=
name|psgl
operator|->
name|SGXLen
expr_stmt|;
block|}
name|lval
operator|=
name|pSRB
operator|->
name|SGToBeXferLen
expr_stmt|;
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|CTCREG_LOW
argument_list|,
name|lval
argument_list|)
expr_stmt|;
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|CTCREG_MID
argument_list|,
name|lval
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|CURTXTCNTREG
argument_list|,
name|lval
operator|>>
literal|16
argument_list|)
expr_stmt|;
name|amd_write32
argument_list|(
name|amd
argument_list|,
name|DMA_XferCnt
argument_list|,
name|pSRB
operator|->
name|SGToBeXferLen
argument_list|)
expr_stmt|;
name|amd_write32
argument_list|(
name|amd
argument_list|,
name|DMA_XferAddr
argument_list|,
name|pSRB
operator|->
name|SGPhysAddr
argument_list|)
expr_stmt|;
name|pSRB
operator|->
name|SRBState
operator|=
name|SRB_DATA_XFER
expr_stmt|;
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|SCSICMDREG
argument_list|,
name|DMA_COMMAND
operator||
name|INFO_XFER_CMD
argument_list|)
expr_stmt|;
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|DMA_Cmd
argument_list|,
name|DMA_IDLE_CMD
operator||
name|ioDir
argument_list|)
expr_stmt|;
comment|/* |EN_DMA_INT */
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|DMA_Cmd
argument_list|,
name|DMA_START_CMD
operator||
name|ioDir
argument_list|)
expr_stmt|;
comment|/* |EN_DMA_INT */
block|}
else|else
block|{
comment|/* xfer pad */
if|if
condition|(
name|pSRB
operator|->
name|SGcount
condition|)
block|{
name|pSRB
operator|->
name|AdaptStatus
operator|=
name|H_OVER_UNDER_RUN
expr_stmt|;
name|pSRB
operator|->
name|SRBStatus
operator||=
name|OVER_RUN
expr_stmt|;
block|}
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|CTCREG_LOW
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|CTCREG_MID
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|CURTXTCNTREG
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|pSRB
operator|->
name|SRBState
operator||=
name|SRB_XFERPAD
expr_stmt|;
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|SCSICMDREG
argument_list|,
name|DMA_COMMAND
operator||
name|XFER_PAD_BYTE
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|u_int
name|amd_CommandPhase1
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|,
name|struct
name|amd_srb
modifier|*
name|srb
parameter_list|,
name|u_int
name|scsistat
parameter_list|)
block|{
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|SCSICMDREG
argument_list|,
name|RESET_ATN_CMD
argument_list|)
expr_stmt|;
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|SCSICMDREG
argument_list|,
name|CLEAR_FIFO_CMD
argument_list|)
expr_stmt|;
name|amdsetupcommand
argument_list|(
name|amd
argument_list|,
name|srb
argument_list|)
expr_stmt|;
name|srb
operator|->
name|SRBState
operator|=
name|SRB_COMMAND
expr_stmt|;
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|SCSICMDREG
argument_list|,
name|INFO_XFER_CMD
argument_list|)
expr_stmt|;
return|return
operator|(
name|scsistat
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|u_int
name|amd_StatusPhase1
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|,
name|struct
name|amd_srb
modifier|*
name|pSRB
parameter_list|,
name|u_int
name|scsistat
parameter_list|)
block|{
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|SCSICMDREG
argument_list|,
name|CLEAR_FIFO_CMD
argument_list|)
expr_stmt|;
name|pSRB
operator|->
name|SRBState
operator|=
name|SRB_STATUS
expr_stmt|;
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|SCSICMDREG
argument_list|,
name|INITIATOR_CMD_CMPLTE
argument_list|)
expr_stmt|;
return|return
operator|(
name|scsistat
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|u_int
name|amd_MsgOutPhase1
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|,
name|struct
name|amd_srb
modifier|*
name|pSRB
parameter_list|,
name|u_int
name|scsistat
parameter_list|)
block|{
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|SCSICMDREG
argument_list|,
name|CLEAR_FIFO_CMD
argument_list|)
expr_stmt|;
if|if
condition|(
name|amd
operator|->
name|msgout_len
operator|==
literal|0
condition|)
block|{
name|amd
operator|->
name|msgout_buf
index|[
literal|0
index|]
operator|=
name|MSG_NOOP
expr_stmt|;
name|amd
operator|->
name|msgout_len
operator|=
literal|1
expr_stmt|;
block|}
name|amd_write8_multi
argument_list|(
name|amd
argument_list|,
name|SCSIFIFOREG
argument_list|,
name|amd
operator|->
name|msgout_buf
argument_list|,
name|amd
operator|->
name|msgout_len
argument_list|)
expr_stmt|;
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|SCSICMDREG
argument_list|,
name|INFO_XFER_CMD
argument_list|)
expr_stmt|;
return|return
operator|(
name|scsistat
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|u_int
name|amd_MsgInPhase1
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|,
name|struct
name|amd_srb
modifier|*
name|pSRB
parameter_list|,
name|u_int
name|scsistat
parameter_list|)
block|{
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|SCSICMDREG
argument_list|,
name|CLEAR_FIFO_CMD
argument_list|)
expr_stmt|;
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|SCSICMDREG
argument_list|,
name|INFO_XFER_CMD
argument_list|)
expr_stmt|;
return|return
operator|(
name|scsistat
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|u_int
name|amd_NopPhase
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|,
name|struct
name|amd_srb
modifier|*
name|pSRB
parameter_list|,
name|u_int
name|scsistat
parameter_list|)
block|{
return|return
operator|(
name|scsistat
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|amd_Disconnect
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|)
block|{
name|struct
name|amd_srb
modifier|*
name|srb
decl_stmt|;
name|int
name|target
decl_stmt|;
name|int
name|lun
decl_stmt|;
name|srb
operator|=
name|amd
operator|->
name|active_srb
expr_stmt|;
name|amd
operator|->
name|active_srb
operator|=
name|NULL
expr_stmt|;
name|amd
operator|->
name|last_phase
operator|=
name|SCSI_BUS_FREE
expr_stmt|;
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|SCSICMDREG
argument_list|,
name|EN_SEL_RESEL
argument_list|)
expr_stmt|;
name|target
operator|=
name|amd
operator|->
name|cur_target
expr_stmt|;
name|lun
operator|=
name|amd
operator|->
name|cur_lun
expr_stmt|;
if|if
condition|(
name|srb
operator|==
name|NULL
condition|)
block|{
comment|/* Invalid reselection */
name|amdrunwaiting
argument_list|(
name|amd
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|srb
operator|->
name|SRBState
operator|&
name|SRB_ABORT_SENT
condition|)
block|{
comment|/* Clean up and done this srb */
if|#
directive|if
literal|0
block|while (( = TAILQ_FIRST(&amd->running_srbs)) != NULL) {
comment|/* XXX What about "done'ing" these srbs??? */
block|if (pSRB->pSRBDCB == pDCB) { 				TAILQ_REMOVE(&amd->running_srbs, pSRB, links); 				TAILQ_INSERT_HEAD(&amd->free_srbs, pSRB, links); 			} 		} 		amdrunwaiting(amd);
endif|#
directive|endif
block|}
else|else
block|{
if|if
condition|(
operator|(
name|srb
operator|->
name|SRBState
operator|&
operator|(
name|SRB_START
operator||
name|SRB_MSGOUT
operator|)
operator|)
operator|||
operator|!
operator|(
name|srb
operator|->
name|SRBState
operator|&
operator|(
name|SRB_DISCONNECT
operator||
name|SRB_COMPLETED
operator|)
operator|)
condition|)
block|{
name|srb
operator|->
name|TargetStatus
operator|=
name|AMD_SCSI_STAT_SEL_TIMEOUT
expr_stmt|;
goto|goto
name|disc1
goto|;
block|}
elseif|else
if|if
condition|(
name|srb
operator|->
name|SRBState
operator|&
name|SRB_DISCONNECT
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|srb
operator|->
name|pccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_TAG_ACTION_VALID
operator|)
condition|)
name|amd
operator|->
name|untagged_srbs
index|[
name|target
index|]
index|[
name|lun
index|]
operator|=
name|srb
expr_stmt|;
name|amdrunwaiting
argument_list|(
name|amd
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|srb
operator|->
name|SRBState
operator|&
name|SRB_COMPLETED
condition|)
block|{
name|disc1
label|:
name|srb
operator|->
name|SRBState
operator|=
name|SRB_FREE
expr_stmt|;
name|SRBdone
argument_list|(
name|amd
argument_list|,
name|srb
argument_list|)
expr_stmt|;
block|}
block|}
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|amd_Reselect
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|)
block|{
name|struct
name|amd_target_info
modifier|*
name|tinfo
decl_stmt|;
name|u_int16_t
name|disc_count
decl_stmt|;
name|amd_clear_msg_state
argument_list|(
name|amd
argument_list|)
expr_stmt|;
if|if
condition|(
name|amd
operator|->
name|active_srb
operator|!=
name|NULL
condition|)
block|{
comment|/* Requeue the SRB for our attempted Selection */
name|TAILQ_REMOVE
argument_list|(
operator|&
name|amd
operator|->
name|running_srbs
argument_list|,
name|amd
operator|->
name|active_srb
argument_list|,
name|links
argument_list|)
expr_stmt|;
name|TAILQ_INSERT_HEAD
argument_list|(
operator|&
name|amd
operator|->
name|waiting_srbs
argument_list|,
name|amd
operator|->
name|active_srb
argument_list|,
name|links
argument_list|)
expr_stmt|;
name|amd
operator|->
name|active_srb
operator|=
name|NULL
expr_stmt|;
block|}
comment|/* get ID */
name|amd
operator|->
name|cur_target
operator|=
name|amd_read8
argument_list|(
name|amd
argument_list|,
name|SCSIFIFOREG
argument_list|)
expr_stmt|;
name|amd
operator|->
name|cur_target
operator|^=
name|amd
operator|->
name|HostID_Bit
expr_stmt|;
name|amd
operator|->
name|cur_target
operator|=
name|ffs
argument_list|(
name|amd
operator|->
name|cur_target
argument_list|)
operator|-
literal|1
expr_stmt|;
name|amd
operator|->
name|cur_lun
operator|=
name|amd_read8
argument_list|(
name|amd
argument_list|,
name|SCSIFIFOREG
argument_list|)
operator|&
literal|7
expr_stmt|;
name|tinfo
operator|=
operator|&
name|amd
operator|->
name|tinfo
index|[
name|amd
operator|->
name|cur_target
index|]
expr_stmt|;
name|amd
operator|->
name|active_srb
operator|=
name|amd
operator|->
name|untagged_srbs
index|[
name|amd
operator|->
name|cur_target
index|]
index|[
name|amd
operator|->
name|cur_lun
index|]
expr_stmt|;
name|disc_count
operator|=
name|amd
operator|->
name|disc_count
index|[
name|amd
operator|->
name|cur_target
index|]
index|[
name|amd
operator|->
name|cur_lun
index|]
expr_stmt|;
if|if
condition|(
name|disc_count
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"amd%d: Unexpected reselection for target %d, "
literal|"Issuing Abort\n"
argument_list|,
name|amd
operator|->
name|unit
argument_list|,
name|amd
operator|->
name|cur_target
argument_list|)
expr_stmt|;
name|amd
operator|->
name|msgout_buf
index|[
literal|0
index|]
operator|=
name|MSG_ABORT
expr_stmt|;
name|amd
operator|->
name|msgout_len
operator|=
literal|1
expr_stmt|;
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|SCSICMDREG
argument_list|,
name|SET_ATN_CMD
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|amd
operator|->
name|active_srb
operator|!=
name|NULL
condition|)
block|{
name|amd
operator|->
name|disc_count
index|[
name|amd
operator|->
name|cur_target
index|]
index|[
name|amd
operator|->
name|cur_lun
index|]
operator|--
expr_stmt|;
name|amd
operator|->
name|untagged_srbs
index|[
name|amd
operator|->
name|cur_target
index|]
index|[
name|amd
operator|->
name|cur_lun
index|]
operator|=
name|NULL
expr_stmt|;
block|}
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|SCSIDESTIDREG
argument_list|,
name|amd
operator|->
name|cur_target
argument_list|)
expr_stmt|;
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|SYNCPERIOREG
argument_list|,
name|tinfo
operator|->
name|sync_period_reg
argument_list|)
expr_stmt|;
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|SYNCOFFREG
argument_list|,
name|tinfo
operator|->
name|sync_offset_reg
argument_list|)
expr_stmt|;
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|CNTLREG1
argument_list|,
name|tinfo
operator|->
name|CtrlR1
argument_list|)
expr_stmt|;
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|CNTLREG3
argument_list|,
name|tinfo
operator|->
name|CtrlR3
argument_list|)
expr_stmt|;
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|CNTLREG4
argument_list|,
name|tinfo
operator|->
name|CtrlR4
argument_list|)
expr_stmt|;
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|SCSICMDREG
argument_list|,
name|MSG_ACCEPTED_CMD
argument_list|)
expr_stmt|;
comment|/* drop /ACK */
name|amd
operator|->
name|last_phase
operator|=
name|SCSI_NOP0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|SRBdone
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|,
name|struct
name|amd_srb
modifier|*
name|pSRB
parameter_list|)
block|{
name|u_int8_t
name|bval
decl_stmt|,
name|i
decl_stmt|,
name|status
decl_stmt|;
name|union
name|ccb
modifier|*
name|pccb
decl_stmt|;
name|struct
name|ccb_scsiio
modifier|*
name|pcsio
decl_stmt|;
name|int
name|intflag
decl_stmt|;
name|struct
name|amd_sg
modifier|*
name|ptr2
decl_stmt|;
name|u_int32_t
name|swlval
decl_stmt|;
name|u_int
name|target_id
decl_stmt|,
name|target_lun
decl_stmt|;
name|pccb
operator|=
name|pSRB
operator|->
name|pccb
expr_stmt|;
name|pcsio
operator|=
operator|&
name|pccb
operator|->
name|csio
expr_stmt|;
name|target_id
operator|=
name|pSRB
operator|->
name|pccb
operator|->
name|ccb_h
operator|.
name|target_id
expr_stmt|;
name|target_lun
operator|=
name|pSRB
operator|->
name|pccb
operator|->
name|ccb_h
operator|.
name|target_lun
expr_stmt|;
name|CAM_DEBUG
argument_list|(
name|pccb
operator|->
name|ccb_h
operator|.
name|path
argument_list|,
name|CAM_DEBUG_TRACE
argument_list|,
operator|(
literal|"SRBdone - TagNumber %d\n"
operator|,
name|pSRB
operator|->
name|TagNumber
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_DIR_MASK
operator|)
operator|!=
name|CAM_DIR_NONE
condition|)
block|{
name|bus_dmasync_op_t
name|op
decl_stmt|;
if|if
condition|(
operator|(
name|pccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_DIR_MASK
operator|)
operator|==
name|CAM_DIR_IN
condition|)
name|op
operator|=
name|BUS_DMASYNC_POSTREAD
expr_stmt|;
else|else
name|op
operator|=
name|BUS_DMASYNC_POSTWRITE
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|amd
operator|->
name|buffer_dmat
argument_list|,
name|pSRB
operator|->
name|dmamap
argument_list|,
name|op
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|amd
operator|->
name|buffer_dmat
argument_list|,
name|pSRB
operator|->
name|dmamap
argument_list|)
expr_stmt|;
block|}
name|status
operator|=
name|pSRB
operator|->
name|TargetStatus
expr_stmt|;
name|pccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_CMP
expr_stmt|;
name|pccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_CMP
expr_stmt|;
if|if
condition|(
name|pSRB
operator|->
name|SRBFlag
operator|&
name|AUTO_REQSENSE
condition|)
block|{
name|pSRB
operator|->
name|SRBFlag
operator|&=
operator|~
name|AUTO_REQSENSE
expr_stmt|;
name|pSRB
operator|->
name|AdaptStatus
operator|=
literal|0
expr_stmt|;
name|pSRB
operator|->
name|TargetStatus
operator|=
name|SCSI_STATUS_CHECK_COND
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|SCSI_STATUS_CHECK_COND
condition|)
block|{
name|pccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_SEL_TIMEOUT
expr_stmt|;
goto|goto
name|ckc_e
goto|;
block|}
operator|*
operator|(
operator|(
name|u_int32_t
operator|*
operator|)
operator|&
operator|(
name|pSRB
operator|->
name|CmdBlock
index|[
literal|0
index|]
operator|)
operator|)
operator|=
name|pSRB
operator|->
name|Segment0
index|[
literal|0
index|]
expr_stmt|;
name|pcsio
operator|->
name|sense_resid
operator|=
name|pcsio
operator|->
name|sense_len
operator|-
name|pSRB
operator|->
name|TotalXferredLen
expr_stmt|;
name|pSRB
operator|->
name|TotalXferredLen
operator|=
name|pSRB
operator|->
name|Segment1
index|[
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|pSRB
operator|->
name|TotalXferredLen
condition|)
block|{
comment|/* ???? */
name|pcsio
operator|->
name|resid
operator|=
name|pcsio
operator|->
name|dxfer_len
operator|-
name|pSRB
operator|->
name|TotalXferredLen
expr_stmt|;
comment|/* The resid field contains valid data	 */
comment|/* Flush resid bytes on complete        */
block|}
else|else
block|{
name|pcsio
operator|->
name|scsi_status
operator|=
name|SCSI_STATUS_CHECK_COND
expr_stmt|;
block|}
name|pccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_AUTOSNS_VALID
operator||
name|CAM_SCSI_STATUS_ERROR
expr_stmt|;
goto|goto
name|ckc_e
goto|;
block|}
if|if
condition|(
name|status
condition|)
block|{
if|if
condition|(
name|status
operator|==
name|SCSI_STATUS_CHECK_COND
condition|)
block|{
if|if
condition|(
operator|(
name|pSRB
operator|->
name|SGIndex
operator|<
name|pSRB
operator|->
name|SGcount
operator|)
operator|&&
operator|(
name|pSRB
operator|->
name|SGcount
operator|)
operator|&&
operator|(
name|pSRB
operator|->
name|SGToBeXferLen
operator|)
condition|)
block|{
name|bval
operator|=
name|pSRB
operator|->
name|SGcount
expr_stmt|;
name|swlval
operator|=
name|pSRB
operator|->
name|SGToBeXferLen
expr_stmt|;
name|ptr2
operator|=
name|pSRB
operator|->
name|pSGlist
expr_stmt|;
name|ptr2
operator|++
expr_stmt|;
for|for
control|(
name|i
operator|=
name|pSRB
operator|->
name|SGIndex
operator|+
literal|1
init|;
name|i
operator|<
name|bval
condition|;
name|i
operator|++
control|)
block|{
name|swlval
operator|+=
name|ptr2
operator|->
name|SGXLen
expr_stmt|;
name|ptr2
operator|++
expr_stmt|;
block|}
comment|/* ??????? */
name|pcsio
operator|->
name|resid
operator|=
operator|(
name|u_int32_t
operator|)
name|swlval
expr_stmt|;
ifdef|#
directive|ifdef
name|AMD_DEBUG0
name|printf
argument_list|(
literal|"XferredLen=%8x,NotYetXferLen=%8x,"
argument_list|,
name|pSRB
operator|->
name|TotalXferredLen
argument_list|,
name|swlval
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
if|if
condition|(
operator|(
name|pcsio
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_DIS_AUTOSENSE
operator|)
operator|==
literal|0
condition|)
block|{
ifdef|#
directive|ifdef
name|AMD_DEBUG0
name|printf
argument_list|(
literal|"RequestSense..................\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|RequestSense
argument_list|(
name|amd
argument_list|,
name|pSRB
argument_list|)
expr_stmt|;
return|return;
block|}
name|pcsio
operator|->
name|scsi_status
operator|=
name|SCSI_STATUS_CHECK_COND
expr_stmt|;
name|pccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_SCSI_STATUS_ERROR
expr_stmt|;
goto|goto
name|ckc_e
goto|;
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|SCSI_STATUS_QUEUE_FULL
condition|)
block|{
name|pSRB
operator|->
name|AdaptStatus
operator|=
literal|0
expr_stmt|;
name|pSRB
operator|->
name|TargetStatus
operator|=
literal|0
expr_stmt|;
name|pcsio
operator|->
name|scsi_status
operator|=
name|SCSI_STATUS_QUEUE_FULL
expr_stmt|;
name|pccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_SCSI_STATUS_ERROR
expr_stmt|;
goto|goto
name|ckc_e
goto|;
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|AMD_SCSI_STAT_SEL_TIMEOUT
condition|)
block|{
name|pSRB
operator|->
name|AdaptStatus
operator|=
name|H_SEL_TIMEOUT
expr_stmt|;
name|pSRB
operator|->
name|TargetStatus
operator|=
literal|0
expr_stmt|;
name|pcsio
operator|->
name|scsi_status
operator|=
name|AMD_SCSI_STAT_SEL_TIMEOUT
expr_stmt|;
name|pccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_SEL_TIMEOUT
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|SCSI_STATUS_BUSY
condition|)
block|{
ifdef|#
directive|ifdef
name|AMD_DEBUG0
name|printf
argument_list|(
literal|"DC390: target busy at %s %d\n"
argument_list|,
name|__FILE__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pcsio
operator|->
name|scsi_status
operator|=
name|SCSI_STATUS_BUSY
expr_stmt|;
name|pccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_SCSI_BUSY
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|SCSI_STATUS_RESERV_CONFLICT
condition|)
block|{
ifdef|#
directive|ifdef
name|AMD_DEBUG0
name|printf
argument_list|(
literal|"DC390: target reserved at %s %d\n"
argument_list|,
name|__FILE__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pcsio
operator|->
name|scsi_status
operator|=
name|SCSI_STATUS_RESERV_CONFLICT
expr_stmt|;
name|pccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_SCSI_STATUS_ERROR
expr_stmt|;
comment|/* XXX */
block|}
else|else
block|{
name|pSRB
operator|->
name|AdaptStatus
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|AMD_DEBUG0
name|printf
argument_list|(
literal|"DC390: driver stuffup at %s %d\n"
argument_list|,
name|__FILE__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_SCSI_STATUS_ERROR
expr_stmt|;
block|}
block|}
else|else
block|{
name|status
operator|=
name|pSRB
operator|->
name|AdaptStatus
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|H_OVER_UNDER_RUN
condition|)
block|{
name|pSRB
operator|->
name|TargetStatus
operator|=
literal|0
expr_stmt|;
name|pccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_DATA_RUN_ERR
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pSRB
operator|->
name|SRBStatus
operator|&
name|PARITY_ERROR
condition|)
block|{
ifdef|#
directive|ifdef
name|AMD_DEBUG0
name|printf
argument_list|(
literal|"DC390: driver stuffup %s %d\n"
argument_list|,
name|__FILE__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* Driver failed to perform operation	  */
name|pccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_UNCOR_PARITY
expr_stmt|;
block|}
else|else
block|{
comment|/* No error */
name|pSRB
operator|->
name|AdaptStatus
operator|=
literal|0
expr_stmt|;
name|pSRB
operator|->
name|TargetStatus
operator|=
literal|0
expr_stmt|;
name|pcsio
operator|->
name|resid
operator|=
literal|0
expr_stmt|;
comment|/* there is no error, (sense is invalid)  */
block|}
block|}
name|ckc_e
label|:
name|intflag
operator|=
name|splcam
argument_list|()
expr_stmt|;
if|if
condition|(
operator|(
name|pccb
operator|->
name|ccb_h
operator|.
name|status
operator|&
name|CAM_STATUS_MASK
operator|)
operator|!=
name|CAM_REQ_CMP
condition|)
block|{
comment|/* CAM request not yet complete =>device_Q frozen */
name|xpt_freeze_devq
argument_list|(
name|pccb
operator|->
name|ccb_h
operator|.
name|path
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pccb
operator|->
name|ccb_h
operator|.
name|status
operator||=
name|CAM_DEV_QFRZN
expr_stmt|;
block|}
name|TAILQ_REMOVE
argument_list|(
operator|&
name|amd
operator|->
name|running_srbs
argument_list|,
name|pSRB
argument_list|,
name|links
argument_list|)
expr_stmt|;
name|TAILQ_INSERT_HEAD
argument_list|(
operator|&
name|amd
operator|->
name|free_srbs
argument_list|,
name|pSRB
argument_list|,
name|links
argument_list|)
expr_stmt|;
name|amdrunwaiting
argument_list|(
name|amd
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|intflag
argument_list|)
expr_stmt|;
name|xpt_done
argument_list|(
name|pccb
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|amd_ResetSCSIBus
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|)
block|{
name|int
name|intflag
decl_stmt|;
name|intflag
operator|=
name|splcam
argument_list|()
expr_stmt|;
name|amd
operator|->
name|ACBFlag
operator||=
name|RESET_DEV
expr_stmt|;
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|DMA_Cmd
argument_list|,
name|DMA_IDLE_CMD
argument_list|)
expr_stmt|;
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|SCSICMDREG
argument_list|,
name|RST_SCSI_BUS_CMD
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|intflag
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|amd_ScsiRstDetect
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|)
block|{
name|int
name|intflag
decl_stmt|;
name|u_int32_t
name|wlval
decl_stmt|;
ifdef|#
directive|ifdef
name|AMD_DEBUG0
name|printf
argument_list|(
literal|"amd_ScsiRstDetect \n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|wlval
operator|=
literal|1000
expr_stmt|;
while|while
condition|(
operator|--
name|wlval
condition|)
block|{
comment|/* delay 1 sec */
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
block|}
name|intflag
operator|=
name|splcam
argument_list|()
expr_stmt|;
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|DMA_Cmd
argument_list|,
name|DMA_IDLE_CMD
argument_list|)
expr_stmt|;
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|SCSICMDREG
argument_list|,
name|CLEAR_FIFO_CMD
argument_list|)
expr_stmt|;
if|if
condition|(
name|amd
operator|->
name|ACBFlag
operator|&
name|RESET_DEV
condition|)
block|{
name|amd
operator|->
name|ACBFlag
operator||=
name|RESET_DONE
expr_stmt|;
block|}
else|else
block|{
name|amd
operator|->
name|ACBFlag
operator||=
name|RESET_DETECT
expr_stmt|;
name|ResetDevParam
argument_list|(
name|amd
argument_list|)
expr_stmt|;
name|amdcompletematch
argument_list|(
name|amd
argument_list|,
name|CAM_TARGET_WILDCARD
argument_list|,
name|CAM_LUN_WILDCARD
argument_list|,
name|AMD_TAG_WILDCARD
argument_list|,
operator|&
name|amd
operator|->
name|running_srbs
argument_list|,
name|CAM_DEV_QFRZN
operator||
name|CAM_SCSI_BUS_RESET
argument_list|)
expr_stmt|;
name|amdcompletematch
argument_list|(
name|amd
argument_list|,
name|CAM_TARGET_WILDCARD
argument_list|,
name|CAM_LUN_WILDCARD
argument_list|,
name|AMD_TAG_WILDCARD
argument_list|,
operator|&
name|amd
operator|->
name|waiting_srbs
argument_list|,
name|CAM_DEV_QFRZN
operator||
name|CAM_SCSI_BUS_RESET
argument_list|)
expr_stmt|;
name|amd
operator|->
name|active_srb
operator|=
name|NULL
expr_stmt|;
name|amd
operator|->
name|ACBFlag
operator|=
literal|0
expr_stmt|;
name|amdrunwaiting
argument_list|(
name|amd
argument_list|)
expr_stmt|;
block|}
name|splx
argument_list|(
name|intflag
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|RequestSense
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|,
name|struct
name|amd_srb
modifier|*
name|pSRB
parameter_list|)
block|{
name|union
name|ccb
modifier|*
name|pccb
decl_stmt|;
name|struct
name|ccb_scsiio
modifier|*
name|pcsio
decl_stmt|;
name|pccb
operator|=
name|pSRB
operator|->
name|pccb
expr_stmt|;
name|pcsio
operator|=
operator|&
name|pccb
operator|->
name|csio
expr_stmt|;
name|pSRB
operator|->
name|SRBFlag
operator||=
name|AUTO_REQSENSE
expr_stmt|;
name|pSRB
operator|->
name|Segment0
index|[
literal|0
index|]
operator|=
operator|*
operator|(
operator|(
name|u_int32_t
operator|*
operator|)
operator|&
operator|(
name|pSRB
operator|->
name|CmdBlock
index|[
literal|0
index|]
operator|)
operator|)
expr_stmt|;
name|pSRB
operator|->
name|Segment0
index|[
literal|1
index|]
operator|=
operator|*
operator|(
operator|(
name|u_int32_t
operator|*
operator|)
operator|&
operator|(
name|pSRB
operator|->
name|CmdBlock
index|[
literal|4
index|]
operator|)
operator|)
expr_stmt|;
name|pSRB
operator|->
name|Segment1
index|[
literal|0
index|]
operator|=
operator|(
name|pSRB
operator|->
name|ScsiCmdLen
operator|<<
literal|8
operator|)
operator|+
name|pSRB
operator|->
name|SGcount
expr_stmt|;
name|pSRB
operator|->
name|Segment1
index|[
literal|1
index|]
operator|=
name|pSRB
operator|->
name|TotalXferredLen
expr_stmt|;
name|pSRB
operator|->
name|AdaptStatus
operator|=
literal|0
expr_stmt|;
name|pSRB
operator|->
name|TargetStatus
operator|=
literal|0
expr_stmt|;
name|pSRB
operator|->
name|Segmentx
operator|.
name|SGXPtr
operator|=
operator|(
name|u_int32_t
operator|)
name|vtophys
argument_list|(
operator|&
name|pcsio
operator|->
name|sense_data
argument_list|)
expr_stmt|;
name|pSRB
operator|->
name|Segmentx
operator|.
name|SGXLen
operator|=
operator|(
name|u_int32_t
operator|)
name|pcsio
operator|->
name|sense_len
expr_stmt|;
name|pSRB
operator|->
name|pSGlist
operator|=
operator|&
name|pSRB
operator|->
name|Segmentx
expr_stmt|;
name|pSRB
operator|->
name|SGcount
operator|=
literal|1
expr_stmt|;
name|pSRB
operator|->
name|SGIndex
operator|=
literal|0
expr_stmt|;
operator|*
operator|(
operator|(
name|u_int32_t
operator|*
operator|)
operator|&
operator|(
name|pSRB
operator|->
name|CmdBlock
index|[
literal|0
index|]
operator|)
operator|)
operator|=
literal|0x00000003
expr_stmt|;
name|pSRB
operator|->
name|CmdBlock
index|[
literal|1
index|]
operator|=
name|pSRB
operator|->
name|pccb
operator|->
name|ccb_h
operator|.
name|target_lun
operator|<<
literal|5
expr_stmt|;
operator|*
operator|(
operator|(
name|u_int16_t
operator|*
operator|)
operator|&
operator|(
name|pSRB
operator|->
name|CmdBlock
index|[
literal|4
index|]
operator|)
operator|)
operator|=
name|pcsio
operator|->
name|sense_len
expr_stmt|;
name|pSRB
operator|->
name|ScsiCmdLen
operator|=
literal|6
expr_stmt|;
name|pSRB
operator|->
name|TotalXferredLen
operator|=
literal|0
expr_stmt|;
name|pSRB
operator|->
name|SGToBeXferLen
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|amdstart
argument_list|(
name|amd
argument_list|,
name|pSRB
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|TAILQ_REMOVE
argument_list|(
operator|&
name|amd
operator|->
name|running_srbs
argument_list|,
name|pSRB
argument_list|,
name|links
argument_list|)
expr_stmt|;
name|TAILQ_INSERT_HEAD
argument_list|(
operator|&
name|amd
operator|->
name|waiting_srbs
argument_list|,
name|pSRB
argument_list|,
name|links
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|amd_InvalidCmd
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|)
block|{
name|struct
name|amd_srb
modifier|*
name|srb
decl_stmt|;
name|srb
operator|=
name|amd
operator|->
name|active_srb
expr_stmt|;
if|if
condition|(
name|srb
operator|->
name|SRBState
operator|&
operator|(
name|SRB_START
operator||
name|SRB_MSGOUT
operator|)
condition|)
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|SCSICMDREG
argument_list|,
name|CLEAR_FIFO_CMD
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|amd_linkSRB
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|)
block|{
name|u_int16_t
name|count
decl_stmt|,
name|i
decl_stmt|;
name|struct
name|amd_srb
modifier|*
name|psrb
decl_stmt|;
name|count
operator|=
name|amd
operator|->
name|SRBCount
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
block|{
name|psrb
operator|=
operator|(
expr|struct
name|amd_srb
operator|*
operator|)
operator|&
name|amd
operator|->
name|SRB_array
index|[
name|i
index|]
expr_stmt|;
name|psrb
operator|->
name|TagNumber
operator|=
name|i
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|amd
operator|->
name|free_srbs
argument_list|,
name|psrb
argument_list|,
name|links
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|amd_EnDisableCE
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|,
name|int
name|mode
parameter_list|,
name|int
modifier|*
name|regval
parameter_list|)
block|{
if|if
condition|(
name|mode
operator|==
name|ENABLE_CE
condition|)
block|{
operator|*
name|regval
operator|=
literal|0xc0
expr_stmt|;
block|}
else|else
block|{
operator|*
name|regval
operator|=
literal|0x80
expr_stmt|;
block|}
name|pci_write_config
argument_list|(
name|amd
operator|->
name|dev
argument_list|,
operator|*
name|regval
argument_list|,
literal|0
argument_list|,
comment|/*bytes*/
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|mode
operator|==
name|DISABLE_CE
condition|)
block|{
name|pci_write_config
argument_list|(
name|amd
operator|->
name|dev
argument_list|,
operator|*
name|regval
argument_list|,
literal|0
argument_list|,
comment|/*bytes*/
literal|1
argument_list|)
expr_stmt|;
block|}
name|DELAY
argument_list|(
literal|160
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|amd_EEpromOutDI
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|,
name|int
modifier|*
name|regval
parameter_list|,
name|int
name|Carry
parameter_list|)
block|{
name|u_int
name|bval
decl_stmt|;
name|bval
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|Carry
condition|)
block|{
name|bval
operator|=
literal|0x40
expr_stmt|;
operator|*
name|regval
operator|=
literal|0x80
expr_stmt|;
name|pci_write_config
argument_list|(
name|amd
operator|->
name|dev
argument_list|,
operator|*
name|regval
argument_list|,
name|bval
argument_list|,
comment|/*bytes*/
literal|1
argument_list|)
expr_stmt|;
block|}
name|DELAY
argument_list|(
literal|160
argument_list|)
expr_stmt|;
name|bval
operator||=
literal|0x80
expr_stmt|;
name|pci_write_config
argument_list|(
name|amd
operator|->
name|dev
argument_list|,
operator|*
name|regval
argument_list|,
name|bval
argument_list|,
comment|/*bytes*/
literal|1
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|160
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|amd
operator|->
name|dev
argument_list|,
operator|*
name|regval
argument_list|,
literal|0
argument_list|,
comment|/*bytes*/
literal|1
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|160
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|amd_EEpromInDO
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|)
block|{
name|pci_write_config
argument_list|(
name|amd
operator|->
name|dev
argument_list|,
literal|0x80
argument_list|,
literal|0x80
argument_list|,
comment|/*bytes*/
literal|1
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|160
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|amd
operator|->
name|dev
argument_list|,
literal|0x80
argument_list|,
literal|0x40
argument_list|,
comment|/*bytes*/
literal|1
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|160
argument_list|)
expr_stmt|;
if|if
condition|(
name|pci_read_config
argument_list|(
name|amd
operator|->
name|dev
argument_list|,
literal|0
argument_list|,
comment|/*bytes*/
literal|1
argument_list|)
operator|==
literal|0x22
condition|)
return|return
operator|(
literal|1
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|u_int16_t
name|EEpromGetData1
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|)
block|{
name|u_int
name|i
decl_stmt|;
name|u_int
name|carryFlag
decl_stmt|;
name|u_int16_t
name|wval
decl_stmt|;
name|wval
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
block|{
name|wval
operator|<<=
literal|1
expr_stmt|;
name|carryFlag
operator|=
name|amd_EEpromInDO
argument_list|(
name|amd
argument_list|)
expr_stmt|;
name|wval
operator||=
name|carryFlag
expr_stmt|;
block|}
return|return
operator|(
name|wval
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|amd_Prepare
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|,
name|int
modifier|*
name|regval
parameter_list|,
name|u_int8_t
name|EEpromCmd
parameter_list|)
block|{
name|u_int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|int
name|carryFlag
decl_stmt|;
name|carryFlag
operator|=
literal|1
expr_stmt|;
name|j
operator|=
literal|0x80
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|9
condition|;
name|i
operator|++
control|)
block|{
name|amd_EEpromOutDI
argument_list|(
name|amd
argument_list|,
name|regval
argument_list|,
name|carryFlag
argument_list|)
expr_stmt|;
name|carryFlag
operator|=
operator|(
name|EEpromCmd
operator|&
name|j
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|j
operator|>>=
literal|1
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|amd_ReadEEprom
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|)
block|{
name|int
name|regval
decl_stmt|;
name|u_int
name|i
decl_stmt|;
name|u_int16_t
modifier|*
name|ptr
decl_stmt|;
name|u_int8_t
name|cmd
decl_stmt|;
name|ptr
operator|=
operator|(
name|u_int16_t
operator|*
operator|)
operator|&
name|amd
operator|->
name|eepromBuf
index|[
literal|0
index|]
expr_stmt|;
name|cmd
operator|=
name|EEPROM_READ
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|0x40
condition|;
name|i
operator|++
control|)
block|{
name|amd_EnDisableCE
argument_list|(
name|amd
argument_list|,
name|ENABLE_CE
argument_list|,
operator|&
name|regval
argument_list|)
expr_stmt|;
name|amd_Prepare
argument_list|(
name|amd
argument_list|,
operator|&
name|regval
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
operator|*
name|ptr
operator|=
name|EEpromGetData1
argument_list|(
name|amd
argument_list|)
expr_stmt|;
name|ptr
operator|++
expr_stmt|;
name|cmd
operator|++
expr_stmt|;
name|amd_EnDisableCE
argument_list|(
name|amd
argument_list|,
name|DISABLE_CE
argument_list|,
operator|&
name|regval
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|amd_load_defaults
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|)
block|{
name|int
name|target
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|amd
operator|->
name|eepromBuf
argument_list|,
sizeof|sizeof
name|amd
operator|->
name|eepromBuf
argument_list|)
expr_stmt|;
for|for
control|(
name|target
operator|=
literal|0
init|;
name|target
operator|<
name|MAX_SCSI_ID
condition|;
name|target
operator|++
control|)
name|amd
operator|->
name|eepromBuf
index|[
name|target
operator|<<
literal|2
index|]
operator|=
operator|(
name|TAG_QUEUING
operator||
name|EN_DISCONNECT
operator||
name|SYNC_NEGO
operator||
name|PARITY_CHK
operator|)
expr_stmt|;
name|amd
operator|->
name|eepromBuf
index|[
name|EE_ADAPT_SCSI_ID
index|]
operator|=
literal|7
expr_stmt|;
name|amd
operator|->
name|eepromBuf
index|[
name|EE_MODE2
index|]
operator|=
name|ACTIVE_NEGATION
operator||
name|LUN_CHECK
operator||
name|GREATER_1G
expr_stmt|;
name|amd
operator|->
name|eepromBuf
index|[
name|EE_TAG_CMD_NUM
index|]
operator|=
literal|4
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|amd_load_eeprom_or_defaults
parameter_list|(
name|struct
name|amd_softc
modifier|*
name|amd
parameter_list|)
block|{
name|u_int16_t
name|wval
decl_stmt|,
modifier|*
name|ptr
decl_stmt|;
name|u_int8_t
name|i
decl_stmt|;
name|amd_ReadEEprom
argument_list|(
name|amd
argument_list|)
expr_stmt|;
name|wval
operator|=
literal|0
expr_stmt|;
name|ptr
operator|=
operator|(
name|u_int16_t
operator|*
operator|)
operator|&
name|amd
operator|->
name|eepromBuf
index|[
literal|0
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|EE_DATA_SIZE
condition|;
name|i
operator|+=
literal|2
operator|,
name|ptr
operator|++
control|)
name|wval
operator|+=
operator|*
name|ptr
expr_stmt|;
if|if
condition|(
name|wval
operator|!=
name|EE_CHECKSUM
condition|)
block|{
if|if
condition|(
name|bootverbose
condition|)
name|printf
argument_list|(
literal|"amd%d: SEEPROM data unavailable.  "
literal|"Using default device parameters.\n"
argument_list|,
name|amd
operator|->
name|unit
argument_list|)
expr_stmt|;
name|amd_load_defaults
argument_list|(
name|amd
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  **********************************************************************  * Function      : static int amd_init (struct Scsi_Host *host)  * Purpose       : initialize the internal structures for a given SCSI host  * Inputs        : host - pointer to this host adapter's structure/  **********************************************************************  */
end_comment

begin_function
specifier|static
name|int
name|amd_init
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|amd_softc
modifier|*
name|amd
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|resource
modifier|*
name|iores
decl_stmt|;
name|int
name|i
decl_stmt|,
name|rid
decl_stmt|;
name|u_int
name|bval
decl_stmt|;
name|rid
operator|=
name|PCI_BASE_ADDR0
expr_stmt|;
name|iores
operator|=
name|bus_alloc_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IOPORT
argument_list|,
operator|&
name|rid
argument_list|,
literal|0
argument_list|,
operator|~
literal|0
argument_list|,
literal|1
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|iores
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|bootverbose
condition|)
name|printf
argument_list|(
literal|"amd_init: bus_alloc_resource failure!\n"
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
name|amd
operator|->
name|tag
operator|=
name|rman_get_bustag
argument_list|(
name|iores
argument_list|)
expr_stmt|;
name|amd
operator|->
name|bsh
operator|=
name|rman_get_bushandle
argument_list|(
name|iores
argument_list|)
expr_stmt|;
comment|/* DMA tag for mapping buffers into device visible space. */
if|if
condition|(
name|bus_dma_tag_create
argument_list|(
comment|/*parent_dmat*/
name|NULL
argument_list|,
comment|/*alignment*/
literal|1
argument_list|,
comment|/*boundary*/
literal|0
argument_list|,
comment|/*lowaddr*/
name|BUS_SPACE_MAXADDR_32BIT
argument_list|,
comment|/*highaddr*/
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/*filter*/
name|NULL
argument_list|,
comment|/*filterarg*/
name|NULL
argument_list|,
comment|/*maxsize*/
name|MAXBSIZE
argument_list|,
comment|/*nsegments*/
name|AMD_NSEG
argument_list|,
comment|/*maxsegsz*/
name|AMD_MAXTRANSFER_SIZE
argument_list|,
comment|/*flags*/
name|BUS_DMA_ALLOCNOW
argument_list|,
operator|&
name|amd
operator|->
name|buffer_dmat
argument_list|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|bootverbose
condition|)
name|printf
argument_list|(
literal|"amd_init: bus_dma_tag_create failure!\n"
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
name|TAILQ_INIT
argument_list|(
operator|&
name|amd
operator|->
name|free_srbs
argument_list|)
expr_stmt|;
name|TAILQ_INIT
argument_list|(
operator|&
name|amd
operator|->
name|running_srbs
argument_list|)
expr_stmt|;
name|TAILQ_INIT
argument_list|(
operator|&
name|amd
operator|->
name|waiting_srbs
argument_list|)
expr_stmt|;
name|amd
operator|->
name|last_phase
operator|=
name|SCSI_BUS_FREE
expr_stmt|;
name|amd
operator|->
name|dev
operator|=
name|dev
expr_stmt|;
name|amd
operator|->
name|unit
operator|=
name|device_get_unit
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|amd
operator|->
name|SRBCount
operator|=
name|MAX_SRB_CNT
expr_stmt|;
name|amd
operator|->
name|status
operator|=
literal|0
expr_stmt|;
name|amd_load_eeprom_or_defaults
argument_list|(
name|amd
argument_list|)
expr_stmt|;
name|amd
operator|->
name|max_id
operator|=
literal|7
expr_stmt|;
if|if
condition|(
name|amd
operator|->
name|eepromBuf
index|[
name|EE_MODE2
index|]
operator|&
name|LUN_CHECK
condition|)
block|{
name|amd
operator|->
name|max_lun
operator|=
literal|7
expr_stmt|;
block|}
else|else
block|{
name|amd
operator|->
name|max_lun
operator|=
literal|0
expr_stmt|;
block|}
name|amd
operator|->
name|AdaptSCSIID
operator|=
name|amd
operator|->
name|eepromBuf
index|[
name|EE_ADAPT_SCSI_ID
index|]
expr_stmt|;
name|amd
operator|->
name|HostID_Bit
operator|=
operator|(
literal|1
operator|<<
name|amd
operator|->
name|AdaptSCSIID
operator|)
expr_stmt|;
name|amd
operator|->
name|AdaptSCSILUN
operator|=
literal|0
expr_stmt|;
comment|/* (eepromBuf[EE_TAG_CMD_NUM])<< 2; */
name|amd
operator|->
name|ACBFlag
operator|=
literal|0
expr_stmt|;
name|amd
operator|->
name|Gmode2
operator|=
name|amd
operator|->
name|eepromBuf
index|[
name|EE_MODE2
index|]
expr_stmt|;
name|amd_linkSRB
argument_list|(
name|amd
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
name|amd
operator|->
name|max_id
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|amd
operator|->
name|AdaptSCSIID
operator|!=
name|i
condition|)
block|{
name|struct
name|amd_target_info
modifier|*
name|tinfo
decl_stmt|;
name|PEEprom
name|prom
decl_stmt|;
name|tinfo
operator|=
operator|&
name|amd
operator|->
name|tinfo
index|[
name|i
index|]
expr_stmt|;
name|prom
operator|=
operator|(
name|PEEprom
operator|)
operator|&
name|amd
operator|->
name|eepromBuf
index|[
name|i
operator|<<
literal|2
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|prom
operator|->
name|EE_MODE1
operator|&
name|EN_DISCONNECT
operator|)
operator|!=
literal|0
condition|)
block|{
name|tinfo
operator|->
name|disc_tag
operator||=
name|AMD_USR_DISCENB
expr_stmt|;
if|if
condition|(
operator|(
name|prom
operator|->
name|EE_MODE1
operator|&
name|TAG_QUEUING
operator|)
operator|!=
literal|0
condition|)
name|tinfo
operator|->
name|disc_tag
operator||=
name|AMD_USR_TAGENB
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|prom
operator|->
name|EE_MODE1
operator|&
name|SYNC_NEGO
operator|)
operator|!=
literal|0
condition|)
block|{
name|tinfo
operator|->
name|user
operator|.
name|period
operator|=
name|eeprom_period
index|[
name|prom
operator|->
name|EE_SPEED
index|]
expr_stmt|;
name|tinfo
operator|->
name|user
operator|.
name|offset
operator|=
name|AMD_MAX_SYNC_OFFSET
expr_stmt|;
block|}
name|tinfo
operator|->
name|CtrlR1
operator|=
name|amd
operator|->
name|AdaptSCSIID
expr_stmt|;
if|if
condition|(
operator|(
name|prom
operator|->
name|EE_MODE1
operator|&
name|PARITY_CHK
operator|)
operator|!=
literal|0
condition|)
name|tinfo
operator|->
name|CtrlR1
operator||=
name|PARITY_ERR_REPO
expr_stmt|;
name|tinfo
operator|->
name|CtrlR3
operator|=
name|FAST_CLK
expr_stmt|;
name|tinfo
operator|->
name|CtrlR4
operator|=
name|EATER_25NS
expr_stmt|;
if|if
condition|(
operator|(
name|amd
operator|->
name|eepromBuf
index|[
name|EE_MODE2
index|]
operator|&
name|ACTIVE_NEGATION
operator|)
operator|!=
literal|0
condition|)
name|tinfo
operator|->
name|CtrlR4
operator||=
name|NEGATE_REQACKDATA
expr_stmt|;
block|}
block|}
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|SCSITIMEOUTREG
argument_list|,
literal|153
argument_list|)
expr_stmt|;
comment|/* 250ms selection timeout */
comment|/* Conversion factor = 0 , 40MHz clock */
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|CLKFACTREG
argument_list|,
name|CLK_FREQ_40MHZ
argument_list|)
expr_stmt|;
comment|/* NOP cmd - clear command register */
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|SCSICMDREG
argument_list|,
name|NOP_CMD
argument_list|)
expr_stmt|;
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|CNTLREG2
argument_list|,
name|EN_FEATURE
operator||
name|EN_SCSI2_CMD
argument_list|)
expr_stmt|;
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|CNTLREG3
argument_list|,
name|FAST_CLK
argument_list|)
expr_stmt|;
name|bval
operator|=
name|EATER_25NS
expr_stmt|;
if|if
condition|(
name|amd
operator|->
name|eepromBuf
index|[
name|EE_MODE2
index|]
operator|&
name|ACTIVE_NEGATION
condition|)
block|{
name|bval
operator||=
name|NEGATE_REQACKDATA
expr_stmt|;
block|}
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|CNTLREG4
argument_list|,
name|bval
argument_list|)
expr_stmt|;
comment|/* Disable SCSI bus reset interrupt */
name|amd_write8
argument_list|(
name|amd
argument_list|,
name|CNTLREG1
argument_list|,
name|DIS_INT_ON_SCSI_RST
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * attach and init a host adapter  */
end_comment

begin_function
specifier|static
name|int
name|amd_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|cam_devq
modifier|*
name|devq
decl_stmt|;
comment|/* Device Queue to use for this SIM */
name|u_int8_t
name|intstat
decl_stmt|;
name|struct
name|amd_softc
modifier|*
name|amd
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|unit
init|=
name|device_get_unit
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|rid
decl_stmt|;
name|void
modifier|*
name|ih
decl_stmt|;
name|struct
name|resource
modifier|*
name|irqres
decl_stmt|;
if|if
condition|(
name|amd_init
argument_list|(
name|dev
argument_list|)
condition|)
block|{
if|if
condition|(
name|bootverbose
condition|)
name|printf
argument_list|(
literal|"amd_attach: amd_init failure!\n"
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
comment|/* Reset Pending INT */
name|intstat
operator|=
name|amd_read8
argument_list|(
name|amd
argument_list|,
name|INTSTATREG
argument_list|)
expr_stmt|;
comment|/* After setting up the adapter, map our interrupt */
name|rid
operator|=
literal|0
expr_stmt|;
name|irqres
operator|=
name|bus_alloc_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
operator|&
name|rid
argument_list|,
literal|0
argument_list|,
operator|~
literal|0
argument_list|,
literal|1
argument_list|,
name|RF_SHAREABLE
operator||
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|irqres
operator|==
name|NULL
operator|||
name|bus_setup_intr
argument_list|(
name|dev
argument_list|,
name|irqres
argument_list|,
name|INTR_TYPE_CAM
argument_list|,
name|amd_intr
argument_list|,
name|amd
argument_list|,
operator|&
name|ih
argument_list|)
condition|)
block|{
if|if
condition|(
name|bootverbose
condition|)
name|printf
argument_list|(
literal|"amd%d: unable to register interrupt handler!\n"
argument_list|,
name|unit
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
comment|/* 	 * Now let the CAM generic SCSI layer find the SCSI devices on 	 * the bus *  start queue to reset to the idle loop. * 	 * Create device queue of SIM(s) *  (MAX_START_JOB - 1) : 	 * max_sim_transactions 	 */
name|devq
operator|=
name|cam_simq_alloc
argument_list|(
name|MAX_START_JOB
argument_list|)
expr_stmt|;
if|if
condition|(
name|devq
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|bootverbose
condition|)
name|printf
argument_list|(
literal|"amd_attach: cam_simq_alloc failure!\n"
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
name|amd
operator|->
name|psim
operator|=
name|cam_sim_alloc
argument_list|(
name|amd_action
argument_list|,
name|amd_poll
argument_list|,
literal|"amd"
argument_list|,
name|amd
argument_list|,
name|amd
operator|->
name|unit
argument_list|,
literal|1
argument_list|,
name|MAX_TAGS_CMD_QUEUE
argument_list|,
name|devq
argument_list|)
expr_stmt|;
if|if
condition|(
name|amd
operator|->
name|psim
operator|==
name|NULL
condition|)
block|{
name|cam_simq_free
argument_list|(
name|devq
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|printf
argument_list|(
literal|"amd_attach: cam_sim_alloc failure!\n"
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
if|if
condition|(
name|xpt_bus_register
argument_list|(
name|amd
operator|->
name|psim
argument_list|,
literal|0
argument_list|)
operator|!=
name|CAM_SUCCESS
condition|)
block|{
name|cam_sim_free
argument_list|(
name|amd
operator|->
name|psim
argument_list|,
comment|/*free_devq*/
name|TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|printf
argument_list|(
literal|"amd_attach: xpt_bus_register failure!\n"
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
if|if
condition|(
name|xpt_create_path
argument_list|(
operator|&
name|amd
operator|->
name|ppath
argument_list|,
comment|/* periph */
name|NULL
argument_list|,
name|cam_sim_path
argument_list|(
name|amd
operator|->
name|psim
argument_list|)
argument_list|,
name|CAM_TARGET_WILDCARD
argument_list|,
name|CAM_LUN_WILDCARD
argument_list|)
operator|!=
name|CAM_REQ_CMP
condition|)
block|{
name|xpt_bus_deregister
argument_list|(
name|cam_sim_path
argument_list|(
name|amd
operator|->
name|psim
argument_list|)
argument_list|)
expr_stmt|;
name|cam_sim_free
argument_list|(
name|amd
operator|->
name|psim
argument_list|,
comment|/* free_simq */
name|TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|printf
argument_list|(
literal|"amd_attach: xpt_create_path failure!\n"
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|amd_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
if|if
condition|(
name|pci_get_devid
argument_list|(
name|dev
argument_list|)
operator|==
name|PCI_DEVICE_ID_AMD53C974
condition|)
block|{
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"Tekram DC390(T)/AMD53c974 SCSI Host Adapter"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
name|ENXIO
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|device_method_t
name|amd_methods
index|[]
init|=
block|{
comment|/* Device interface */
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|amd_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|amd_attach
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|amd_driver
init|=
block|{
literal|"amd"
block|,
name|amd_methods
block|,
expr|sizeof
operator|(
expr|struct
name|amd_softc
operator|)
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|amd_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|amd
argument_list|,
name|pci
argument_list|,
name|amd_driver
argument_list|,
name|amd_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


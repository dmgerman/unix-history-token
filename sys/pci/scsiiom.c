begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/***********************************************************************  *	FILE NAME : SCSIIOM.C					       *  *	     BY   : C.L. Huang	  (ching@tekram.com.tw) 	       *  *	Description: Device Driver for Tekram DC-390 (T) PCI SCSI      *  *		     Bus Master Host Adapter			       *  ***********************************************************************/
end_comment

begin_function
specifier|static
name|USHORT
name|DC390_StartSCSI
parameter_list|(
name|PACB
name|pACB
parameter_list|,
name|PDCB
name|pDCB
parameter_list|,
name|PSRB
name|pSRB
parameter_list|)
block|{
name|USHORT
name|ioport
decl_stmt|,
name|rc
decl_stmt|;
name|UCHAR
name|bval
decl_stmt|,
name|bval1
decl_stmt|,
name|i
decl_stmt|,
name|cnt
decl_stmt|;
name|PUCHAR
name|ptr
decl_stmt|;
name|ULONG
name|wlval
decl_stmt|;
name|pSRB
operator|->
name|TagNumber
operator|=
literal|31
expr_stmt|;
name|ioport
operator|=
name|pACB
operator|->
name|IOPortBase
expr_stmt|;
name|bval
operator|=
name|pDCB
operator|->
name|UnitSCSIID
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|Scsi_Dest_ID
argument_list|)
expr_stmt|;
name|bval
operator|=
name|pDCB
operator|->
name|SyncPeriod
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|Sync_Period
argument_list|)
expr_stmt|;
name|bval
operator|=
name|pDCB
operator|->
name|SyncOffset
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|Sync_Offset
argument_list|)
expr_stmt|;
name|bval
operator|=
name|pDCB
operator|->
name|CtrlR1
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|CtrlReg1
argument_list|)
expr_stmt|;
name|bval
operator|=
name|pDCB
operator|->
name|CtrlR3
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|CtrlReg3
argument_list|)
expr_stmt|;
name|bval
operator|=
name|pDCB
operator|->
name|CtrlR4
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|CtrlReg4
argument_list|)
expr_stmt|;
name|bval
operator|=
name|CLEAR_FIFO_CMD
expr_stmt|;
comment|/* Flush FIFO */
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|ScsiCmd
argument_list|)
expr_stmt|;
name|pSRB
operator|->
name|ScsiPhase
operator|=
name|SCSI_NOP0
expr_stmt|;
name|bval
operator|=
name|pDCB
operator|->
name|IdentifyMsg
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|pDCB
operator|->
name|SyncMode
operator|&
name|EN_ATN_STOP
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|pSRB
operator|->
name|CmdBlock
index|[
literal|0
index|]
operator|==
name|INQUIRY
operator|)
operator|||
operator|(
name|pSRB
operator|->
name|CmdBlock
index|[
literal|0
index|]
operator|==
name|REQUEST_SENSE
operator|)
operator|||
operator|(
name|pSRB
operator|->
name|SRBFlag
operator|&
name|AUTO_REQSENSE
operator|)
condition|)
block|{
name|bval
operator|&=
literal|0xBF
expr_stmt|;
comment|/* NO disconnection */
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|ScsiFifo
argument_list|)
expr_stmt|;
name|bval1
operator|=
name|SELECT_W_ATN
expr_stmt|;
name|pSRB
operator|->
name|SRBState
operator|=
name|SRB_START_
expr_stmt|;
if|if
condition|(
name|pDCB
operator|->
name|SyncMode
operator|&
name|SYNC_ENABLE
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|pDCB
operator|->
name|IdentifyMsg
operator|&
literal|7
operator|)
operator|||
operator|(
name|pSRB
operator|->
name|CmdBlock
index|[
literal|0
index|]
operator|!=
name|INQUIRY
operator|)
condition|)
block|{
name|bval1
operator|=
name|SEL_W_ATN_STOP
expr_stmt|;
name|pSRB
operator|->
name|SRBState
operator|=
name|SRB_MSGOUT
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
if|if
condition|(
name|pDCB
operator|->
name|SyncMode
operator|&
name|EN_TAG_QUEUING
condition|)
block|{
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|ScsiFifo
argument_list|)
expr_stmt|;
name|bval
operator|=
name|MSG_SIMPLE_QTAG
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|ScsiFifo
argument_list|)
expr_stmt|;
name|wlval
operator|=
literal|1
expr_stmt|;
name|bval
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|wlval
operator|&
name|pDCB
operator|->
name|TagMask
condition|)
block|{
name|wlval
operator|=
name|wlval
operator|<<
literal|1
expr_stmt|;
name|bval
operator|++
expr_stmt|;
block|}
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|ScsiFifo
argument_list|)
expr_stmt|;
name|pDCB
operator|->
name|TagMask
operator||=
name|wlval
expr_stmt|;
name|pSRB
operator|->
name|TagNumber
operator|=
name|bval
expr_stmt|;
name|bval1
operator|=
name|SEL_W_ATN2
expr_stmt|;
name|pSRB
operator|->
name|SRBState
operator|=
name|SRB_START_
expr_stmt|;
block|}
else|else
block|{
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|ScsiFifo
argument_list|)
expr_stmt|;
name|bval1
operator|=
name|SELECT_W_ATN
expr_stmt|;
name|pSRB
operator|->
name|SRBState
operator|=
name|SRB_START_
expr_stmt|;
block|}
block|}
if|if
condition|(
name|pSRB
operator|->
name|SRBFlag
operator|&
name|AUTO_REQSENSE
condition|)
block|{
name|bval
operator|=
name|REQUEST_SENSE
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|ScsiFifo
argument_list|)
expr_stmt|;
name|bval
operator|=
name|pDCB
operator|->
name|IdentifyMsg
operator|<<
literal|5
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|ScsiFifo
argument_list|)
expr_stmt|;
name|bval
operator|=
literal|0
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|ScsiFifo
argument_list|)
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|ScsiFifo
argument_list|)
expr_stmt|;
name|bval
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|scsi_sense_data
argument_list|)
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|ScsiFifo
argument_list|)
expr_stmt|;
name|bval
operator|=
literal|0
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|ScsiFifo
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|cnt
operator|=
name|pSRB
operator|->
name|ScsiCmdLen
expr_stmt|;
name|ptr
operator|=
operator|(
name|PUCHAR
operator|)
name|pSRB
operator|->
name|CmdBlock
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cnt
condition|;
name|i
operator|++
control|)
block|{
name|bval
operator|=
operator|*
name|ptr
operator|++
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|ScsiFifo
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
comment|/* ATN_STOP */
block|{
if|if
condition|(
operator|(
name|pSRB
operator|->
name|CmdBlock
index|[
literal|0
index|]
operator|==
name|INQUIRY
operator|)
operator|||
operator|(
name|pSRB
operator|->
name|CmdBlock
index|[
literal|0
index|]
operator|==
name|REQUEST_SENSE
operator|)
operator|||
operator|(
name|pSRB
operator|->
name|SRBFlag
operator|&
name|AUTO_REQSENSE
operator|)
condition|)
block|{
name|bval
operator|&=
literal|0xBF
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|ScsiFifo
argument_list|)
expr_stmt|;
name|bval1
operator|=
name|SELECT_W_ATN
expr_stmt|;
name|pSRB
operator|->
name|SRBState
operator|=
name|SRB_START_
expr_stmt|;
if|if
condition|(
name|pDCB
operator|->
name|SyncMode
operator|&
name|SYNC_ENABLE
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|pDCB
operator|->
name|IdentifyMsg
operator|&
literal|7
operator|)
operator|||
operator|(
name|pSRB
operator|->
name|CmdBlock
index|[
literal|0
index|]
operator|!=
name|INQUIRY
operator|)
condition|)
block|{
name|bval1
operator|=
name|SEL_W_ATN_STOP
expr_stmt|;
name|pSRB
operator|->
name|SRBState
operator|=
name|SRB_MSGOUT
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
if|if
condition|(
name|pDCB
operator|->
name|SyncMode
operator|&
name|EN_TAG_QUEUING
condition|)
block|{
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|ScsiFifo
argument_list|)
expr_stmt|;
name|pSRB
operator|->
name|MsgOutBuf
index|[
literal|0
index|]
operator|=
name|MSG_SIMPLE_QTAG
expr_stmt|;
name|wlval
operator|=
literal|1
expr_stmt|;
name|bval
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|wlval
operator|&
name|pDCB
operator|->
name|TagMask
condition|)
block|{
name|wlval
operator|=
name|wlval
operator|<<
literal|1
expr_stmt|;
name|bval
operator|++
expr_stmt|;
block|}
name|pDCB
operator|->
name|TagMask
operator||=
name|wlval
expr_stmt|;
name|pSRB
operator|->
name|TagNumber
operator|=
name|bval
expr_stmt|;
name|pSRB
operator|->
name|MsgOutBuf
index|[
literal|1
index|]
operator|=
name|bval
expr_stmt|;
name|pSRB
operator|->
name|MsgCnt
operator|=
literal|2
expr_stmt|;
name|bval1
operator|=
name|SEL_W_ATN_STOP
expr_stmt|;
name|pSRB
operator|->
name|SRBState
operator|=
name|SRB_START_
expr_stmt|;
block|}
else|else
block|{
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|ScsiFifo
argument_list|)
expr_stmt|;
name|pSRB
operator|->
name|MsgOutBuf
index|[
literal|0
index|]
operator|=
name|MSG_NOP
expr_stmt|;
name|pSRB
operator|->
name|MsgCnt
operator|=
literal|1
expr_stmt|;
name|pSRB
operator|->
name|SRBState
operator|=
name|SRB_START_
expr_stmt|;
name|bval1
operator|=
name|SEL_W_ATN_STOP
expr_stmt|;
block|}
block|}
block|}
name|bval
operator|=
name|inb
argument_list|(
name|ioport
operator|+
name|Scsi_Status
argument_list|)
expr_stmt|;
if|if
condition|(
name|bval
operator|&
name|INTERRUPT
condition|)
block|{
name|pSRB
operator|->
name|SRBState
operator|=
name|SRB_READY
expr_stmt|;
name|pDCB
operator|->
name|TagMask
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|pSRB
operator|->
name|TagNumber
operator|)
expr_stmt|;
name|rc
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|pSRB
operator|->
name|ScsiPhase
operator|=
name|SCSI_NOP1
expr_stmt|;
name|pACB
operator|->
name|pActiveDCB
operator|=
name|pDCB
expr_stmt|;
name|pDCB
operator|->
name|pActiveSRB
operator|=
name|pSRB
expr_stmt|;
name|rc
operator|=
literal|0
expr_stmt|;
name|OutB
argument_list|(
name|bval1
argument_list|,
name|ioport
operator|+
name|ScsiCmd
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|REL_2_1_0
end_ifdef

begin_decl_stmt
specifier|static
name|int
name|DC390_Interrupt
argument_list|(
name|PACB
name|pACB
argument_list|)
endif|#
directive|endif
ifdef|#
directive|ifdef
name|REL_2_1_5
decl|static
name|void
name|DC390_Interrupt
argument_list|(
name|PACB
name|pACB
argument_list|)
endif|#
directive|endif
block|{
name|PDCB
name|pDCB
decl_stmt|;
name|PSRB
name|pSRB
decl_stmt|;
name|USHORT
name|ioport
init|=
literal|0
decl_stmt|;
name|USHORT
name|phase
decl_stmt|;
name|void
function_decl|(
modifier|*
name|stateV
function_decl|)
parameter_list|(
name|PACB
parameter_list|,
name|PSRB
parameter_list|,
name|PUCHAR
parameter_list|)
function_decl|;
name|UCHAR
name|istate
init|=
literal|0
decl_stmt|;
name|UCHAR
name|sstatus
init|=
literal|0
decl_stmt|,
name|istatus
decl_stmt|;
if|if
condition|(
name|pACB
operator|==
name|NULL
condition|)
ifdef|#
directive|ifdef
name|REL_2_1_0
return|return
literal|0
return|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|REL_2_1_5
return|return;
endif|#
directive|endif
name|ioport
operator|=
name|pACB
operator|->
name|IOPortBase
expr_stmt|;
name|sstatus
operator|=
name|inb
argument_list|(
name|ioport
operator|+
name|Scsi_Status
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|sstatus
operator|&
name|INTERRUPT
operator|)
condition|)
ifdef|#
directive|ifdef
name|REL_2_1_0
return|return
literal|0
return|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|REL_2_1_5
return|return;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|DC390_DEBUG1
name|printf
argument_list|(
literal|"sstatus=%2x,"
argument_list|,
name|sstatus
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|istate
operator|=
name|inb
argument_list|(
name|ioport
operator|+
name|Intern_State
argument_list|)
expr_stmt|;
name|istatus
operator|=
name|inb
argument_list|(
name|ioport
operator|+
name|INT_Status
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DC390_DEBUG1
name|printf
argument_list|(
literal|"Istatus=%2x,"
argument_list|,
name|istatus
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|istatus
operator|&
name|DISCONNECTED
condition|)
block|{
name|DC390_Disconnect
argument_list|(
name|pACB
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|REL_2_1_0
return|return
literal|1
return|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|REL_2_1_5
return|return;
endif|#
directive|endif
block|}
if|if
condition|(
name|istatus
operator|&
name|RESELECTED
condition|)
block|{
name|DC390_Reselect
argument_list|(
name|pACB
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|REL_2_1_0
return|return
literal|1
return|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|REL_2_1_5
return|return;
endif|#
directive|endif
block|}
if|if
condition|(
name|istatus
operator|&
name|INVALID_CMD
condition|)
block|{
name|DC390_InvalidCmd
argument_list|(
name|pACB
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|REL_2_1_0
return|return
literal|1
return|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|REL_2_1_5
return|return;
endif|#
directive|endif
block|}
if|if
condition|(
name|istatus
operator|&
name|SCSI_RESET_
condition|)
block|{
name|DC390_ScsiRstDetect
argument_list|(
name|pACB
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|REL_2_1_0
return|return
literal|1
return|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|REL_2_1_5
return|return;
endif|#
directive|endif
block|}
if|if
condition|(
name|istatus
operator|&
operator|(
name|SUCCESSFUL_OP
operator|+
name|SERVICE_REQUEST
operator|)
condition|)
block|{
name|pDCB
operator|=
name|pACB
operator|->
name|pActiveDCB
expr_stmt|;
name|pSRB
operator|=
name|pDCB
operator|->
name|pActiveSRB
expr_stmt|;
if|if
condition|(
name|pDCB
condition|)
block|{
if|if
condition|(
name|pDCB
operator|->
name|DCBFlag
operator|&
name|ABORT_DEV_
condition|)
name|EnableMsgOut
argument_list|(
name|pACB
argument_list|,
name|pSRB
argument_list|)
expr_stmt|;
block|}
name|phase
operator|=
operator|(
name|USHORT
operator|)
name|pSRB
operator|->
name|ScsiPhase
expr_stmt|;
name|stateV
operator|=
operator|(
name|void
operator|*
operator|)
name|DC390_phase0
index|[
name|phase
index|]
expr_stmt|;
name|stateV
argument_list|(
name|pACB
argument_list|,
name|pSRB
argument_list|,
operator|&
name|sstatus
argument_list|)
expr_stmt|;
name|pSRB
operator|->
name|ScsiPhase
operator|=
name|sstatus
operator|&
literal|7
expr_stmt|;
name|phase
operator|=
operator|(
name|USHORT
operator|)
name|sstatus
operator|&
literal|7
expr_stmt|;
name|stateV
operator|=
operator|(
name|void
operator|*
operator|)
name|DC390_phase1
index|[
name|phase
index|]
expr_stmt|;
name|stateV
argument_list|(
name|pACB
argument_list|,
name|pSRB
argument_list|,
operator|&
name|sstatus
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|REL_2_1_0
return|return
literal|1
return|;
endif|#
directive|endif
block|}
end_decl_stmt

begin_function
specifier|static
name|void
name|DC390_DataOut_0
parameter_list|(
name|PACB
name|pACB
parameter_list|,
name|PSRB
name|pSRB
parameter_list|,
name|PUCHAR
name|psstatus
parameter_list|)
block|{
name|UCHAR
name|sstatus
decl_stmt|,
name|bval
decl_stmt|;
name|USHORT
name|ioport
decl_stmt|;
name|PSEG
name|psgl
decl_stmt|;
name|ULONG
name|ResidCnt
decl_stmt|,
name|xferCnt
decl_stmt|;
name|ioport
operator|=
name|pACB
operator|->
name|IOPortBase
expr_stmt|;
name|sstatus
operator|=
operator|*
name|psstatus
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|pSRB
operator|->
name|SRBState
operator|&
name|SRB_XFERPAD
operator|)
condition|)
block|{
if|if
condition|(
name|sstatus
operator|&
name|PARITY_ERR
condition|)
name|pSRB
operator|->
name|SRBStatus
operator||=
name|PARITY_ERROR
expr_stmt|;
if|if
condition|(
name|sstatus
operator|&
name|COUNT_2_ZERO
condition|)
block|{
name|bval
operator|=
name|inb
argument_list|(
name|ioport
operator|+
name|DMA_Status
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
operator|(
name|bval
operator|&
name|DMA_XFER_DONE
operator|)
condition|)
name|bval
operator|=
name|inb
argument_list|(
name|ioport
operator|+
name|DMA_Status
argument_list|)
expr_stmt|;
name|pSRB
operator|->
name|TotalXferredLen
operator|+=
name|pSRB
operator|->
name|SGToBeXferLen
expr_stmt|;
name|pSRB
operator|->
name|SGIndex
operator|++
expr_stmt|;
if|if
condition|(
name|pSRB
operator|->
name|SGIndex
operator|<
name|pSRB
operator|->
name|SGcount
condition|)
block|{
name|pSRB
operator|->
name|pSegmentList
operator|++
expr_stmt|;
name|psgl
operator|=
name|pSRB
operator|->
name|pSegmentList
expr_stmt|;
name|pSRB
operator|->
name|SGPhysAddr
operator|=
name|psgl
operator|->
name|SGXPtr
expr_stmt|;
name|pSRB
operator|->
name|SGToBeXferLen
operator|=
name|psgl
operator|->
name|SGXLen
expr_stmt|;
block|}
else|else
name|pSRB
operator|->
name|SGToBeXferLen
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|bval
operator|=
name|inb
argument_list|(
name|ioport
operator|+
name|Current_Fifo
argument_list|)
expr_stmt|;
name|bval
operator|&=
literal|0x1f
expr_stmt|;
name|ResidCnt
operator|=
operator|(
name|ULONG
operator|)
name|inb
argument_list|(
name|ioport
operator|+
name|CtcReg_High
argument_list|)
expr_stmt|;
name|ResidCnt
operator|=
name|ResidCnt
operator|<<
literal|8
expr_stmt|;
name|ResidCnt
operator||=
operator|(
name|ULONG
operator|)
name|inb
argument_list|(
name|ioport
operator|+
name|CtcReg_Mid
argument_list|)
expr_stmt|;
name|ResidCnt
operator|=
name|ResidCnt
operator|<<
literal|8
expr_stmt|;
name|ResidCnt
operator||=
operator|(
name|ULONG
operator|)
name|inb
argument_list|(
name|ioport
operator|+
name|CtcReg_Low
argument_list|)
expr_stmt|;
name|ResidCnt
operator|+=
operator|(
name|ULONG
operator|)
name|bval
expr_stmt|;
name|xferCnt
operator|=
name|pSRB
operator|->
name|SGToBeXferLen
operator|-
name|ResidCnt
expr_stmt|;
name|pSRB
operator|->
name|SGPhysAddr
operator|+=
name|xferCnt
expr_stmt|;
name|pSRB
operator|->
name|TotalXferredLen
operator|+=
name|xferCnt
expr_stmt|;
name|pSRB
operator|->
name|SGToBeXferLen
operator|=
name|ResidCnt
expr_stmt|;
block|}
block|}
name|bval
operator|=
name|WRITE_DIRECTION
operator|+
name|DMA_IDLE_CMD
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|DMA_Cmd
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|DC390_DataIn_0
parameter_list|(
name|PACB
name|pACB
parameter_list|,
name|PSRB
name|pSRB
parameter_list|,
name|PUCHAR
name|psstatus
parameter_list|)
block|{
name|UCHAR
name|sstatus
decl_stmt|,
name|bval
decl_stmt|;
name|USHORT
name|i
decl_stmt|,
name|ioport
decl_stmt|,
name|residual
decl_stmt|;
name|PSEG
name|psgl
decl_stmt|;
name|ULONG
name|ResidCnt
decl_stmt|,
name|xferCnt
decl_stmt|;
name|PUCHAR
name|ptr
decl_stmt|;
name|ioport
operator|=
name|pACB
operator|->
name|IOPortBase
expr_stmt|;
name|sstatus
operator|=
operator|*
name|psstatus
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|pSRB
operator|->
name|SRBState
operator|&
name|SRB_XFERPAD
operator|)
condition|)
block|{
if|if
condition|(
name|sstatus
operator|&
name|PARITY_ERR
condition|)
name|pSRB
operator|->
name|SRBStatus
operator||=
name|PARITY_ERROR
expr_stmt|;
if|if
condition|(
name|sstatus
operator|&
name|COUNT_2_ZERO
condition|)
block|{
name|bval
operator|=
name|inb
argument_list|(
name|ioport
operator|+
name|DMA_Status
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
operator|(
name|bval
operator|&
name|DMA_XFER_DONE
operator|)
condition|)
name|bval
operator|=
name|inb
argument_list|(
name|ioport
operator|+
name|DMA_Status
argument_list|)
expr_stmt|;
name|bval
operator|=
name|READ_DIRECTION
operator|+
name|DMA_IDLE_CMD
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|DMA_Cmd
argument_list|)
expr_stmt|;
name|pSRB
operator|->
name|TotalXferredLen
operator|+=
name|pSRB
operator|->
name|SGToBeXferLen
expr_stmt|;
name|pSRB
operator|->
name|SGIndex
operator|++
expr_stmt|;
if|if
condition|(
name|pSRB
operator|->
name|SGIndex
operator|<
name|pSRB
operator|->
name|SGcount
condition|)
block|{
name|pSRB
operator|->
name|pSegmentList
operator|++
expr_stmt|;
name|psgl
operator|=
name|pSRB
operator|->
name|pSegmentList
expr_stmt|;
name|pSRB
operator|->
name|SGPhysAddr
operator|=
name|psgl
operator|->
name|SGXPtr
expr_stmt|;
name|pSRB
operator|->
name|SGToBeXferLen
operator|=
name|psgl
operator|->
name|SGXLen
expr_stmt|;
block|}
else|else
name|pSRB
operator|->
name|SGToBeXferLen
operator|=
literal|0
expr_stmt|;
block|}
else|else
comment|/* phase changed */
block|{
name|residual
operator|=
literal|0
expr_stmt|;
name|bval
operator|=
name|inb
argument_list|(
name|ioport
operator|+
name|Current_Fifo
argument_list|)
expr_stmt|;
while|while
condition|(
name|bval
operator|&
literal|0x1f
condition|)
block|{
if|if
condition|(
operator|(
name|bval
operator|&
literal|0x1f
operator|)
operator|==
literal|1
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|0x100
condition|;
name|i
operator|++
control|)
block|{
name|bval
operator|=
name|inb
argument_list|(
name|ioport
operator|+
name|Current_Fifo
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|bval
operator|&
literal|0x1f
operator|)
condition|)
goto|goto
name|din_1
goto|;
elseif|else
if|if
condition|(
name|i
operator|==
literal|0x0ff
condition|)
block|{
name|residual
operator|=
literal|1
expr_stmt|;
comment|/* ;1 residual byte */
goto|goto
name|din_1
goto|;
block|}
block|}
block|}
else|else
name|bval
operator|=
name|inb
argument_list|(
name|ioport
operator|+
name|Current_Fifo
argument_list|)
expr_stmt|;
block|}
name|din_1
label|:
name|bval
operator|=
name|READ_DIRECTION
operator|+
name|DMA_BLAST_CMD
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|DMA_Cmd
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|0x8000
condition|;
name|i
operator|++
control|)
block|{
name|bval
operator|=
name|inb
argument_list|(
name|ioport
operator|+
name|DMA_Status
argument_list|)
expr_stmt|;
if|if
condition|(
name|bval
operator|&
name|BLAST_COMPLETE
condition|)
break|break;
block|}
name|bval
operator|=
name|READ_DIRECTION
operator|+
name|DMA_IDLE_CMD
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|DMA_Cmd
argument_list|)
expr_stmt|;
name|ResidCnt
operator|=
operator|(
name|ULONG
operator|)
name|inb
argument_list|(
name|ioport
operator|+
name|CtcReg_High
argument_list|)
expr_stmt|;
name|ResidCnt
operator|=
name|ResidCnt
operator|<<
literal|8
expr_stmt|;
name|ResidCnt
operator||=
operator|(
name|ULONG
operator|)
name|inb
argument_list|(
name|ioport
operator|+
name|CtcReg_Mid
argument_list|)
expr_stmt|;
name|ResidCnt
operator|=
name|ResidCnt
operator|<<
literal|8
expr_stmt|;
name|ResidCnt
operator||=
operator|(
name|ULONG
operator|)
name|inb
argument_list|(
name|ioport
operator|+
name|CtcReg_Low
argument_list|)
expr_stmt|;
name|xferCnt
operator|=
name|pSRB
operator|->
name|SGToBeXferLen
operator|-
name|ResidCnt
expr_stmt|;
name|pSRB
operator|->
name|SGPhysAddr
operator|+=
name|xferCnt
expr_stmt|;
name|pSRB
operator|->
name|TotalXferredLen
operator|+=
name|xferCnt
expr_stmt|;
name|pSRB
operator|->
name|SGToBeXferLen
operator|=
name|ResidCnt
expr_stmt|;
if|if
condition|(
name|residual
condition|)
block|{
name|bval
operator|=
name|inb
argument_list|(
name|ioport
operator|+
name|ScsiFifo
argument_list|)
expr_stmt|;
comment|/* get residual byte */
name|ptr
operator|=
name|phystovirt
argument_list|(
name|pSRB
argument_list|,
name|xferCnt
argument_list|)
expr_stmt|;
operator|*
name|ptr
operator|=
name|bval
expr_stmt|;
name|pSRB
operator|->
name|SGPhysAddr
operator|++
expr_stmt|;
name|pSRB
operator|->
name|TotalXferredLen
operator|++
expr_stmt|;
name|pSRB
operator|->
name|SGToBeXferLen
operator|--
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|DC390_Command_0
parameter_list|(
name|PACB
name|pACB
parameter_list|,
name|PSRB
name|pSRB
parameter_list|,
name|PUCHAR
name|psstatus
parameter_list|)
block|{ }
end_function

begin_function
specifier|static
name|void
name|DC390_Status_0
parameter_list|(
name|PACB
name|pACB
parameter_list|,
name|PSRB
name|pSRB
parameter_list|,
name|PUCHAR
name|psstatus
parameter_list|)
block|{
name|UCHAR
name|bval
decl_stmt|;
name|USHORT
name|ioport
decl_stmt|;
name|ioport
operator|=
name|pACB
operator|->
name|IOPortBase
expr_stmt|;
name|bval
operator|=
name|inb
argument_list|(
name|ioport
operator|+
name|ScsiFifo
argument_list|)
expr_stmt|;
name|pSRB
operator|->
name|TargetStatus
operator|=
name|bval
expr_stmt|;
name|bval
operator|++
expr_stmt|;
name|bval
operator|=
name|inb
argument_list|(
name|ioport
operator|+
name|ScsiFifo
argument_list|)
expr_stmt|;
comment|/* get message */
name|pSRB
operator|->
name|EndMessage
operator|=
name|bval
expr_stmt|;
operator|*
name|psstatus
operator|=
name|SCSI_NOP0
expr_stmt|;
name|pSRB
operator|->
name|SRBState
operator|=
name|SRB_COMPLETED
expr_stmt|;
name|bval
operator|=
name|MSG_ACCEPTED_CMD
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|ScsiCmd
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|DC390_MsgOut_0
parameter_list|(
name|PACB
name|pACB
parameter_list|,
name|PSRB
name|pSRB
parameter_list|,
name|PUCHAR
name|psstatus
parameter_list|)
block|{
if|if
condition|(
name|pSRB
operator|->
name|SRBState
operator|&
operator|(
name|SRB_UNEXPECT_RESEL
operator|+
name|SRB_ABORT_SENT
operator|)
condition|)
operator|*
name|psstatus
operator|=
name|SCSI_NOP0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|DC390_MsgIn_0
parameter_list|(
name|PACB
name|pACB
parameter_list|,
name|PSRB
name|pSRB
parameter_list|,
name|PUCHAR
name|psstatus
parameter_list|)
block|{
name|UCHAR
name|bval
decl_stmt|;
name|USHORT
name|ioport
decl_stmt|,
name|wval
decl_stmt|,
name|wval1
decl_stmt|;
name|PDCB
name|pDCB
decl_stmt|;
name|PSRB
name|psrb
decl_stmt|;
name|ioport
operator|=
name|pACB
operator|->
name|IOPortBase
expr_stmt|;
name|pDCB
operator|=
name|pACB
operator|->
name|pActiveDCB
expr_stmt|;
name|bval
operator|=
name|inb
argument_list|(
name|ioport
operator|+
name|ScsiFifo
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|pSRB
operator|->
name|SRBState
operator|&
name|SRB_MSGIN_MULTI
operator|)
condition|)
block|{
if|if
condition|(
name|bval
operator|==
name|MSG_DISCONNECT
condition|)
block|{
name|pSRB
operator|->
name|SRBState
operator|=
name|SRB_DISCONNECT
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|bval
operator|==
name|MSG_SAVE_PTR
condition|)
goto|goto
name|min6
goto|;
elseif|else
if|if
condition|(
operator|(
name|bval
operator|==
name|MSG_EXTENDED
operator|)
operator|||
operator|(
operator|(
name|bval
operator|>=
name|MSG_SIMPLE_QTAG
operator|)
operator|&&
operator|(
name|bval
operator|<=
name|MSG_ORDER_QTAG
operator|)
operator|)
condition|)
block|{
name|pSRB
operator|->
name|SRBState
operator||=
name|SRB_MSGIN_MULTI
expr_stmt|;
name|pSRB
operator|->
name|MsgInBuf
index|[
literal|0
index|]
operator|=
name|bval
expr_stmt|;
name|pSRB
operator|->
name|MsgCnt
operator|=
literal|1
expr_stmt|;
name|pSRB
operator|->
name|pMsgPtr
operator|=
operator|&
name|pSRB
operator|->
name|MsgInBuf
index|[
literal|1
index|]
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|bval
operator|==
name|MSG_REJECT_
condition|)
block|{
name|bval
operator|=
name|RESET_ATN_CMD
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|ScsiCmd
argument_list|)
expr_stmt|;
if|if
condition|(
name|pSRB
operator|->
name|SRBState
operator|&
name|DO_SYNC_NEGO
condition|)
goto|goto
name|set_async
goto|;
block|}
elseif|else
if|if
condition|(
name|bval
operator|==
name|MSG_RESTORE_PTR
condition|)
goto|goto
name|min6
goto|;
else|else
goto|goto
name|min6
goto|;
block|}
else|else
block|{
comment|/* minx: */
operator|*
name|pSRB
operator|->
name|pMsgPtr
operator|=
name|bval
expr_stmt|;
name|pSRB
operator|->
name|MsgCnt
operator|++
expr_stmt|;
name|pSRB
operator|->
name|pMsgPtr
operator|++
expr_stmt|;
if|if
condition|(
operator|(
name|pSRB
operator|->
name|MsgInBuf
index|[
literal|0
index|]
operator|>=
name|MSG_SIMPLE_QTAG
operator|)
operator|&&
operator|(
name|pSRB
operator|->
name|MsgInBuf
index|[
literal|0
index|]
operator|<=
name|MSG_ORDER_QTAG
operator|)
condition|)
block|{
if|if
condition|(
name|pSRB
operator|->
name|MsgCnt
operator|==
literal|2
condition|)
block|{
name|pSRB
operator|->
name|SRBState
operator|=
literal|0
expr_stmt|;
name|bval
operator|=
name|pSRB
operator|->
name|MsgInBuf
index|[
literal|1
index|]
expr_stmt|;
name|pSRB
operator|=
name|pDCB
operator|->
name|pGoingSRB
expr_stmt|;
name|psrb
operator|=
name|pDCB
operator|->
name|pGoingLast
expr_stmt|;
if|if
condition|(
name|pSRB
condition|)
block|{
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|pSRB
operator|->
name|TagNumber
operator|!=
name|bval
condition|)
block|{
if|if
condition|(
name|pSRB
operator|==
name|psrb
condition|)
goto|goto
name|mingx0
goto|;
name|pSRB
operator|=
name|pSRB
operator|->
name|pNextSRB
expr_stmt|;
block|}
else|else
break|break;
block|}
if|if
condition|(
name|pDCB
operator|->
name|DCBFlag
operator|&
name|ABORT_DEV_
condition|)
block|{
name|pSRB
operator|->
name|SRBState
operator|=
name|SRB_ABORT_SENT
expr_stmt|;
name|EnableMsgOut
argument_list|(
name|pACB
argument_list|,
name|pSRB
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|(
name|pSRB
operator|->
name|SRBState
operator|&
name|SRB_DISCONNECT
operator|)
condition|)
goto|goto
name|mingx0
goto|;
name|pDCB
operator|->
name|pActiveSRB
operator|=
name|pSRB
expr_stmt|;
name|pSRB
operator|->
name|SRBState
operator|=
name|SRB_DATA_XFER
expr_stmt|;
block|}
else|else
block|{
name|mingx0
label|:
name|pSRB
operator|=
name|pACB
operator|->
name|pTmpSRB
expr_stmt|;
name|pSRB
operator|->
name|SRBState
operator|=
name|SRB_UNEXPECT_RESEL
expr_stmt|;
name|pDCB
operator|->
name|pActiveSRB
operator|=
name|pSRB
expr_stmt|;
name|pSRB
operator|->
name|MsgOutBuf
index|[
literal|0
index|]
operator|=
name|MSG_ABORT_TAG
expr_stmt|;
name|EnableMsgOut2
argument_list|(
name|pACB
argument_list|,
name|pSRB
argument_list|)
expr_stmt|;
block|}
block|}
block|}
elseif|else
if|if
condition|(
operator|(
name|pSRB
operator|->
name|MsgInBuf
index|[
literal|0
index|]
operator|==
name|MSG_EXTENDED
operator|)
operator|&&
operator|(
name|pSRB
operator|->
name|MsgCnt
operator|==
literal|5
operator|)
condition|)
block|{
name|pSRB
operator|->
name|SRBState
operator|&=
operator|~
operator|(
name|SRB_MSGIN_MULTI
operator|+
name|DO_SYNC_NEGO
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|pSRB
operator|->
name|MsgInBuf
index|[
literal|1
index|]
operator|!=
literal|3
operator|)
operator|||
operator|(
name|pSRB
operator|->
name|MsgInBuf
index|[
literal|2
index|]
operator|!=
literal|1
operator|)
condition|)
block|{
comment|/* reject_msg: */
name|pSRB
operator|->
name|MsgCnt
operator|=
literal|1
expr_stmt|;
name|pSRB
operator|->
name|MsgInBuf
index|[
literal|0
index|]
operator|=
name|MSG_REJECT_
expr_stmt|;
name|bval
operator|=
name|SET_ATN_CMD
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|ScsiCmd
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
operator|(
name|pSRB
operator|->
name|MsgInBuf
index|[
literal|3
index|]
operator|)
operator|||
operator|!
operator|(
name|pSRB
operator|->
name|MsgInBuf
index|[
literal|4
index|]
operator|)
condition|)
block|{
name|set_async
label|:
name|pDCB
operator|=
name|pSRB
operator|->
name|pSRBDCB
expr_stmt|;
name|pDCB
operator|->
name|SyncMode
operator|&=
operator|~
operator|(
name|SYNC_ENABLE
operator|+
name|SYNC_NEGO_DONE
operator|)
expr_stmt|;
name|pDCB
operator|->
name|SyncPeriod
operator|=
literal|0
expr_stmt|;
name|pDCB
operator|->
name|SyncOffset
operator|=
literal|0
expr_stmt|;
name|pDCB
operator|->
name|CtrlR3
operator|=
name|FAST_CLK
expr_stmt|;
comment|/* ;non_fast */
name|pDCB
operator|->
name|CtrlR4
operator|&=
literal|0x3f
expr_stmt|;
name|pDCB
operator|->
name|CtrlR4
operator||=
name|EATER_25NS
expr_stmt|;
comment|/* ; 25ns glitch eater */
goto|goto
name|re_prog
goto|;
block|}
else|else
block|{
comment|/* set_sync: */
name|pDCB
operator|=
name|pSRB
operator|->
name|pSRBDCB
expr_stmt|;
name|pDCB
operator|->
name|SyncMode
operator||=
name|SYNC_ENABLE
operator|+
name|SYNC_NEGO_DONE
expr_stmt|;
name|pDCB
operator|->
name|SyncOffset
operator|&=
literal|0x0f0
expr_stmt|;
name|pDCB
operator|->
name|SyncOffset
operator||=
name|pSRB
operator|->
name|MsgInBuf
index|[
literal|4
index|]
expr_stmt|;
name|pDCB
operator|->
name|NegoPeriod
operator|=
name|pSRB
operator|->
name|MsgInBuf
index|[
literal|3
index|]
expr_stmt|;
name|wval
operator|=
operator|(
name|USHORT
operator|)
name|pSRB
operator|->
name|MsgInBuf
index|[
literal|3
index|]
expr_stmt|;
name|wval
operator|=
name|wval
operator|<<
literal|2
expr_stmt|;
name|wval
operator|--
expr_stmt|;
name|wval1
operator|=
name|wval
operator|/
literal|25
expr_stmt|;
if|if
condition|(
operator|(
name|wval1
operator|*
literal|25
operator|)
operator|!=
name|wval
condition|)
name|wval1
operator|++
expr_stmt|;
name|bval
operator|=
name|FAST_CLK
operator|+
name|FAST_SCSI
expr_stmt|;
name|pDCB
operator|->
name|CtrlR4
operator|&=
literal|0x3f
expr_stmt|;
if|if
condition|(
name|wval1
operator|>=
literal|8
condition|)
block|{
name|wval1
operator|--
expr_stmt|;
name|bval
operator|=
name|FAST_CLK
expr_stmt|;
comment|/* ;fast clock/normal scsi */
name|pDCB
operator|->
name|CtrlR4
operator||=
name|EATER_25NS
expr_stmt|;
comment|/* ;25 ns glitch eater */
block|}
name|pDCB
operator|->
name|CtrlR3
operator|=
name|bval
expr_stmt|;
name|pDCB
operator|->
name|SyncPeriod
operator|=
operator|(
name|UCHAR
operator|)
name|wval1
expr_stmt|;
name|re_prog
label|:
name|bval
operator|=
name|pDCB
operator|->
name|SyncPeriod
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|Sync_Period
argument_list|)
expr_stmt|;
name|bval
operator|=
name|pDCB
operator|->
name|SyncOffset
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|Sync_Offset
argument_list|)
expr_stmt|;
name|bval
operator|=
name|pDCB
operator|->
name|CtrlR3
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|CtrlReg3
argument_list|)
expr_stmt|;
name|bval
operator|=
name|pDCB
operator|->
name|CtrlR4
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|CtrlReg4
argument_list|)
expr_stmt|;
name|SetXferRate
argument_list|(
name|pACB
argument_list|,
name|pDCB
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|min6
label|:
operator|*
name|psstatus
operator|=
name|SCSI_NOP0
expr_stmt|;
name|bval
operator|=
name|MSG_ACCEPTED_CMD
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|ScsiCmd
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|DataIO_Comm
parameter_list|(
name|PACB
name|pACB
parameter_list|,
name|PSRB
name|pSRB
parameter_list|,
name|UCHAR
name|ioDir
parameter_list|)
block|{
name|PSEG
name|psgl
decl_stmt|;
name|UCHAR
name|bval
decl_stmt|;
name|USHORT
name|ioport
decl_stmt|;
name|ULONG
name|lval
decl_stmt|;
name|ioport
operator|=
name|pACB
operator|->
name|IOPortBase
expr_stmt|;
if|if
condition|(
name|pSRB
operator|->
name|SGIndex
operator|<
name|pSRB
operator|->
name|SGcount
condition|)
block|{
name|bval
operator|=
name|DMA_IDLE_CMD
operator||
name|ioDir
expr_stmt|;
comment|/* ;+EN_DMA_INT */
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|DMA_Cmd
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pSRB
operator|->
name|SGToBeXferLen
condition|)
block|{
name|psgl
operator|=
name|pSRB
operator|->
name|pSegmentList
expr_stmt|;
name|pSRB
operator|->
name|SGPhysAddr
operator|=
name|psgl
operator|->
name|SGXPtr
expr_stmt|;
name|pSRB
operator|->
name|SGToBeXferLen
operator|=
name|psgl
operator|->
name|SGXLen
expr_stmt|;
block|}
name|lval
operator|=
name|pSRB
operator|->
name|SGToBeXferLen
expr_stmt|;
name|bval
operator|=
operator|(
name|UCHAR
operator|)
name|lval
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|CtcReg_Low
argument_list|)
expr_stmt|;
name|lval
operator|=
name|lval
operator|>>
literal|8
expr_stmt|;
name|bval
operator|=
operator|(
name|UCHAR
operator|)
name|lval
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|CtcReg_Mid
argument_list|)
expr_stmt|;
name|lval
operator|=
name|lval
operator|>>
literal|8
expr_stmt|;
name|bval
operator|=
operator|(
name|UCHAR
operator|)
name|lval
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|CtcReg_High
argument_list|)
expr_stmt|;
name|lval
operator|=
name|pSRB
operator|->
name|SGToBeXferLen
expr_stmt|;
name|OutL
argument_list|(
name|lval
argument_list|,
name|ioport
operator|+
name|DMA_XferCnt
argument_list|)
expr_stmt|;
name|lval
operator|=
name|pSRB
operator|->
name|SGPhysAddr
expr_stmt|;
name|OutL
argument_list|(
name|lval
argument_list|,
name|ioport
operator|+
name|DMA_XferAddr
argument_list|)
expr_stmt|;
name|pSRB
operator|->
name|SRBState
operator|=
name|SRB_DATA_XFER
expr_stmt|;
name|bval
operator|=
name|DMA_COMMAND
operator|+
name|INFO_XFER_CMD
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|ScsiCmd
argument_list|)
expr_stmt|;
name|bval
operator|=
name|DMA_IDLE_CMD
operator||
name|ioDir
expr_stmt|;
comment|/* ;+EN_DMA_INT */
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|DMA_Cmd
argument_list|)
expr_stmt|;
name|bval
operator|=
name|DMA_START_CMD
operator||
name|ioDir
expr_stmt|;
comment|/* ;+EN_DMA_INT */
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|DMA_Cmd
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* xfer pad */
block|{
if|if
condition|(
name|pSRB
operator|->
name|SGcount
condition|)
block|{
name|pSRB
operator|->
name|AdaptStatus
operator|=
name|H_OVER_UNDER_RUN
expr_stmt|;
name|pSRB
operator|->
name|SRBStatus
operator||=
name|OVER_RUN
expr_stmt|;
block|}
name|bval
operator|=
literal|0
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|CtcReg_Low
argument_list|)
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|CtcReg_Mid
argument_list|)
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|CtcReg_High
argument_list|)
expr_stmt|;
name|pSRB
operator|->
name|SRBState
operator||=
name|SRB_XFERPAD
expr_stmt|;
name|bval
operator|=
name|DMA_COMMAND
operator|+
name|XFER_PAD_BYTE
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|ScsiCmd
argument_list|)
expr_stmt|;
comment|/* 	bval = DMA_IDLE_CMD | ioDir;	;+EN_DMA_INT 	OutB(bval, ioport+DMA_Cmd); 	bval = DMA_START_CMD | ioDir;	;+EN_DMA_INT 	OutB(bval, ioport+DMA_Cmd); */
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|DC390_DataOutPhase
parameter_list|(
name|PACB
name|pACB
parameter_list|,
name|PSRB
name|pSRB
parameter_list|,
name|PUCHAR
name|psstatus
parameter_list|)
block|{
name|UCHAR
name|ioDir
decl_stmt|;
name|ioDir
operator|=
name|WRITE_DIRECTION
expr_stmt|;
name|DataIO_Comm
argument_list|(
name|pACB
argument_list|,
name|pSRB
argument_list|,
name|ioDir
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|DC390_DataInPhase
parameter_list|(
name|PACB
name|pACB
parameter_list|,
name|PSRB
name|pSRB
parameter_list|,
name|PUCHAR
name|psstatus
parameter_list|)
block|{
name|UCHAR
name|ioDir
decl_stmt|;
name|ioDir
operator|=
name|READ_DIRECTION
expr_stmt|;
name|DataIO_Comm
argument_list|(
name|pACB
argument_list|,
name|pSRB
argument_list|,
name|ioDir
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|DC390_CommandPhase
parameter_list|(
name|PACB
name|pACB
parameter_list|,
name|PSRB
name|pSRB
parameter_list|,
name|PUCHAR
name|psstatus
parameter_list|)
block|{
name|PDCB
name|pDCB
decl_stmt|;
name|UCHAR
name|bval
decl_stmt|;
name|PUCHAR
name|ptr
decl_stmt|;
name|USHORT
name|ioport
decl_stmt|,
name|i
decl_stmt|,
name|cnt
decl_stmt|;
name|ioport
operator|=
name|pACB
operator|->
name|IOPortBase
expr_stmt|;
name|bval
operator|=
name|RESET_ATN_CMD
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|ScsiCmd
argument_list|)
expr_stmt|;
name|bval
operator|=
name|CLEAR_FIFO_CMD
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|ScsiCmd
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|pSRB
operator|->
name|SRBFlag
operator|&
name|AUTO_REQSENSE
operator|)
condition|)
block|{
name|cnt
operator|=
operator|(
name|USHORT
operator|)
name|pSRB
operator|->
name|ScsiCmdLen
expr_stmt|;
name|ptr
operator|=
operator|(
name|PUCHAR
operator|)
name|pSRB
operator|->
name|CmdBlock
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cnt
condition|;
name|i
operator|++
control|)
block|{
name|OutB
argument_list|(
operator|*
name|ptr
argument_list|,
name|ioport
operator|+
name|ScsiFifo
argument_list|)
expr_stmt|;
name|ptr
operator|++
expr_stmt|;
block|}
block|}
else|else
block|{
name|bval
operator|=
name|REQUEST_SENSE
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|ScsiFifo
argument_list|)
expr_stmt|;
name|pDCB
operator|=
name|pACB
operator|->
name|pActiveDCB
expr_stmt|;
name|bval
operator|=
name|pDCB
operator|->
name|IdentifyMsg
operator|<<
literal|5
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|ScsiFifo
argument_list|)
expr_stmt|;
name|bval
operator|=
literal|0
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|ScsiFifo
argument_list|)
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|ScsiFifo
argument_list|)
expr_stmt|;
name|bval
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|scsi_sense_data
argument_list|)
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|ScsiFifo
argument_list|)
expr_stmt|;
name|bval
operator|=
literal|0
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|ScsiFifo
argument_list|)
expr_stmt|;
block|}
name|pSRB
operator|->
name|SRBState
operator|=
name|SRB_COMMAND
expr_stmt|;
name|bval
operator|=
name|INFO_XFER_CMD
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|ScsiCmd
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|DC390_StatusPhase
parameter_list|(
name|PACB
name|pACB
parameter_list|,
name|PSRB
name|pSRB
parameter_list|,
name|PUCHAR
name|psstatus
parameter_list|)
block|{
name|UCHAR
name|bval
decl_stmt|;
name|USHORT
name|ioport
decl_stmt|;
name|ioport
operator|=
name|pACB
operator|->
name|IOPortBase
expr_stmt|;
name|bval
operator|=
name|CLEAR_FIFO_CMD
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|ScsiCmd
argument_list|)
expr_stmt|;
name|pSRB
operator|->
name|SRBState
operator|=
name|SRB_STATUS
expr_stmt|;
name|bval
operator|=
name|INITIATOR_CMD_CMPLTE
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|ScsiCmd
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|DC390_MsgOutPhase
parameter_list|(
name|PACB
name|pACB
parameter_list|,
name|PSRB
name|pSRB
parameter_list|,
name|PUCHAR
name|psstatus
parameter_list|)
block|{
name|UCHAR
name|bval
decl_stmt|;
name|USHORT
name|ioport
decl_stmt|,
name|i
decl_stmt|,
name|cnt
decl_stmt|;
name|PUCHAR
name|ptr
decl_stmt|;
name|PDCB
name|pDCB
decl_stmt|;
name|ioport
operator|=
name|pACB
operator|->
name|IOPortBase
expr_stmt|;
name|bval
operator|=
name|CLEAR_FIFO_CMD
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|ScsiCmd
argument_list|)
expr_stmt|;
name|pDCB
operator|=
name|pACB
operator|->
name|pActiveDCB
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|pSRB
operator|->
name|SRBState
operator|&
name|SRB_MSGOUT
operator|)
condition|)
block|{
name|cnt
operator|=
name|pSRB
operator|->
name|MsgCnt
expr_stmt|;
if|if
condition|(
name|cnt
condition|)
block|{
name|ptr
operator|=
operator|(
name|PUCHAR
operator|)
name|pSRB
operator|->
name|MsgOutBuf
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cnt
condition|;
name|i
operator|++
control|)
block|{
name|OutB
argument_list|(
operator|*
name|ptr
argument_list|,
name|ioport
operator|+
name|ScsiFifo
argument_list|)
expr_stmt|;
name|ptr
operator|++
expr_stmt|;
block|}
name|pSRB
operator|->
name|MsgCnt
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|pDCB
operator|->
name|DCBFlag
operator|&
name|ABORT_DEV_
operator|)
operator|&&
operator|(
name|pSRB
operator|->
name|MsgOutBuf
index|[
literal|0
index|]
operator|==
name|MSG_ABORT
operator|)
condition|)
name|pSRB
operator|->
name|SRBState
operator|=
name|SRB_ABORT_SENT
expr_stmt|;
block|}
else|else
block|{
name|bval
operator|=
name|MSG_ABORT
expr_stmt|;
comment|/* ??? MSG_NOP */
if|if
condition|(
operator|(
name|pSRB
operator|->
name|CmdBlock
index|[
literal|0
index|]
operator|==
name|INQUIRY
operator|)
operator|||
operator|(
name|pSRB
operator|->
name|CmdBlock
index|[
literal|0
index|]
operator|==
name|REQUEST_SENSE
operator|)
operator|||
operator|(
name|pSRB
operator|->
name|SRBFlag
operator|&
name|AUTO_REQSENSE
operator|)
condition|)
block|{
if|if
condition|(
name|pDCB
operator|->
name|SyncMode
operator|&
name|SYNC_ENABLE
condition|)
goto|goto
name|mop1
goto|;
block|}
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|ScsiFifo
argument_list|)
expr_stmt|;
block|}
name|bval
operator|=
name|INFO_XFER_CMD
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|ScsiCmd
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|mop1
label|:
name|bval
operator|=
name|MSG_EXTENDED
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|ScsiFifo
argument_list|)
expr_stmt|;
name|bval
operator|=
literal|3
expr_stmt|;
comment|/*    ;length of extended msg */
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|ScsiFifo
argument_list|)
expr_stmt|;
name|bval
operator|=
literal|1
expr_stmt|;
comment|/*    ; sync nego */
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|ScsiFifo
argument_list|)
expr_stmt|;
name|bval
operator|=
name|pDCB
operator|->
name|NegoPeriod
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|ScsiFifo
argument_list|)
expr_stmt|;
name|bval
operator|=
name|SYNC_NEGO_OFFSET
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|ScsiFifo
argument_list|)
expr_stmt|;
name|pSRB
operator|->
name|SRBState
operator||=
name|DO_SYNC_NEGO
expr_stmt|;
name|bval
operator|=
name|INFO_XFER_CMD
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|ScsiCmd
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|DC390_MsgInPhase
parameter_list|(
name|PACB
name|pACB
parameter_list|,
name|PSRB
name|pSRB
parameter_list|,
name|PUCHAR
name|psstatus
parameter_list|)
block|{
name|UCHAR
name|bval
decl_stmt|;
name|USHORT
name|ioport
decl_stmt|;
name|ioport
operator|=
name|pACB
operator|->
name|IOPortBase
expr_stmt|;
name|bval
operator|=
name|CLEAR_FIFO_CMD
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|ScsiCmd
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|pSRB
operator|->
name|SRBState
operator|&
name|SRB_MSGIN
operator|)
condition|)
block|{
name|pSRB
operator|->
name|SRBState
operator|&=
name|SRB_DISCONNECT
expr_stmt|;
name|pSRB
operator|->
name|SRBState
operator||=
name|SRB_MSGIN
expr_stmt|;
block|}
name|bval
operator|=
name|INFO_XFER_CMD
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|ScsiCmd
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|DC390_Nop_0
parameter_list|(
name|PACB
name|pACB
parameter_list|,
name|PSRB
name|pSRB
parameter_list|,
name|PUCHAR
name|psstatus
parameter_list|)
block|{ }
end_function

begin_function
specifier|static
name|void
name|DC390_Nop_1
parameter_list|(
name|PACB
name|pACB
parameter_list|,
name|PSRB
name|pSRB
parameter_list|,
name|PUCHAR
name|psstatus
parameter_list|)
block|{ }
end_function

begin_function
specifier|static
name|void
name|SetXferRate
parameter_list|(
name|PACB
name|pACB
parameter_list|,
name|PDCB
name|pDCB
parameter_list|)
block|{
name|UCHAR
name|bval
decl_stmt|;
name|USHORT
name|cnt
decl_stmt|,
name|i
decl_stmt|;
name|PDCB
name|ptr
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|pDCB
operator|->
name|IdentifyMsg
operator|&
literal|0x07
operator|)
condition|)
block|{
if|if
condition|(
name|pACB
operator|->
name|scan_devices
condition|)
block|{
name|CurrSyncOffset
operator|=
name|pDCB
operator|->
name|SyncOffset
expr_stmt|;
block|}
else|else
block|{
name|ptr
operator|=
name|pACB
operator|->
name|pLinkDCB
expr_stmt|;
name|cnt
operator|=
name|pACB
operator|->
name|DeviceCnt
expr_stmt|;
name|bval
operator|=
name|pDCB
operator|->
name|UnitSCSIID
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cnt
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ptr
operator|->
name|UnitSCSIID
operator|==
name|bval
condition|)
block|{
name|ptr
operator|->
name|SyncPeriod
operator|=
name|pDCB
operator|->
name|SyncPeriod
expr_stmt|;
name|ptr
operator|->
name|SyncOffset
operator|=
name|pDCB
operator|->
name|SyncOffset
expr_stmt|;
name|ptr
operator|->
name|CtrlR3
operator|=
name|pDCB
operator|->
name|CtrlR3
expr_stmt|;
name|ptr
operator|->
name|CtrlR4
operator|=
name|pDCB
operator|->
name|CtrlR4
expr_stmt|;
name|ptr
operator|->
name|SyncMode
operator|=
name|pDCB
operator|->
name|SyncMode
expr_stmt|;
block|}
name|ptr
operator|=
name|ptr
operator|->
name|pNextDCB
expr_stmt|;
block|}
block|}
block|}
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|DC390_Disconnect
parameter_list|(
name|PACB
name|pACB
parameter_list|)
block|{
name|PDCB
name|pDCB
decl_stmt|;
name|PSRB
name|pSRB
decl_stmt|,
name|psrb
decl_stmt|;
name|int
name|flags
decl_stmt|;
name|USHORT
name|ioport
decl_stmt|,
name|i
decl_stmt|,
name|cnt
decl_stmt|;
name|UCHAR
name|bval
decl_stmt|;
ifdef|#
directive|ifdef
name|DC390_DEBUG0
name|printf
argument_list|(
literal|"DISC,"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|flags
operator|=
name|splbio
argument_list|()
expr_stmt|;
name|ioport
operator|=
name|pACB
operator|->
name|IOPortBase
expr_stmt|;
name|pDCB
operator|=
name|pACB
operator|->
name|pActiveDCB
expr_stmt|;
name|pSRB
operator|=
name|pDCB
operator|->
name|pActiveSRB
expr_stmt|;
name|pACB
operator|->
name|pActiveDCB
operator|=
literal|0
expr_stmt|;
name|pSRB
operator|->
name|ScsiPhase
operator|=
name|SCSI_NOP0
expr_stmt|;
name|bval
operator|=
name|EN_SEL_RESEL
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|ScsiCmd
argument_list|)
expr_stmt|;
if|if
condition|(
name|pSRB
operator|->
name|SRBState
operator|&
name|SRB_UNEXPECT_RESEL
condition|)
block|{
name|pSRB
operator|->
name|SRBState
operator|=
literal|0
expr_stmt|;
name|DoWaitingSRB
argument_list|(
name|pACB
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pSRB
operator|->
name|SRBState
operator|&
name|SRB_ABORT_SENT
condition|)
block|{
name|pDCB
operator|->
name|TagMask
operator|=
literal|0
expr_stmt|;
name|pDCB
operator|->
name|DCBFlag
operator|=
literal|0
expr_stmt|;
name|cnt
operator|=
name|pDCB
operator|->
name|GoingSRBCnt
expr_stmt|;
name|pDCB
operator|->
name|GoingSRBCnt
operator|=
literal|0
expr_stmt|;
name|pSRB
operator|=
name|pDCB
operator|->
name|pGoingSRB
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cnt
condition|;
name|i
operator|++
control|)
block|{
name|psrb
operator|=
name|pSRB
operator|->
name|pNextSRB
expr_stmt|;
name|pSRB
operator|->
name|pNextSRB
operator|=
name|pACB
operator|->
name|pFreeSRB
expr_stmt|;
name|pACB
operator|->
name|pFreeSRB
operator|=
name|pSRB
expr_stmt|;
name|pSRB
operator|=
name|psrb
expr_stmt|;
block|}
name|pDCB
operator|->
name|pGoingSRB
operator|=
literal|0
expr_stmt|;
name|DoWaitingSRB
argument_list|(
name|pACB
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|(
name|pSRB
operator|->
name|SRBState
operator|&
operator|(
name|SRB_START_
operator|+
name|SRB_MSGOUT
operator|)
operator|)
operator|||
operator|!
operator|(
name|pSRB
operator|->
name|SRBState
operator|&
operator|(
name|SRB_DISCONNECT
operator|+
name|SRB_COMPLETED
operator|)
operator|)
condition|)
block|{
comment|/* Selection time out */
if|if
condition|(
operator|!
operator|(
name|pACB
operator|->
name|scan_devices
operator|)
condition|)
block|{
name|pSRB
operator|->
name|SRBState
operator|=
name|SRB_READY
expr_stmt|;
name|RewaitSRB
argument_list|(
name|pDCB
argument_list|,
name|pSRB
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|pSRB
operator|->
name|TargetStatus
operator|=
name|SCSI_STAT_SEL_TIMEOUT
expr_stmt|;
goto|goto
name|disc1
goto|;
block|}
block|}
elseif|else
if|if
condition|(
name|pSRB
operator|->
name|SRBState
operator|&
name|SRB_DISCONNECT
condition|)
block|{
name|DoWaitingSRB
argument_list|(
name|pACB
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pSRB
operator|->
name|SRBState
operator|&
name|SRB_COMPLETED
condition|)
block|{
name|disc1
label|:
if|if
condition|(
name|pDCB
operator|->
name|MaxCommand
operator|>
literal|1
condition|)
block|{
name|bval
operator|=
name|pSRB
operator|->
name|TagNumber
expr_stmt|;
name|pDCB
operator|->
name|TagMask
operator|&=
operator|(
operator|~
operator|(
literal|1
operator|<<
name|bval
operator|)
operator|)
expr_stmt|;
comment|/* free tag mask */
block|}
name|pDCB
operator|->
name|pActiveSRB
operator|=
literal|0
expr_stmt|;
name|pSRB
operator|->
name|SRBState
operator|=
name|SRB_FREE
expr_stmt|;
name|SRBdone
argument_list|(
name|pACB
argument_list|,
name|pDCB
argument_list|,
name|pSRB
argument_list|)
expr_stmt|;
block|}
block|}
name|splx
argument_list|(
name|flags
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|DC390_Reselect
parameter_list|(
name|PACB
name|pACB
parameter_list|)
block|{
name|PDCB
name|pDCB
decl_stmt|;
name|PSRB
name|pSRB
decl_stmt|;
name|USHORT
name|ioport
decl_stmt|,
name|wval
decl_stmt|;
name|UCHAR
name|bval
decl_stmt|,
name|bval1
decl_stmt|;
ifdef|#
directive|ifdef
name|DC390_DEBUG0
name|printf
argument_list|(
literal|"RSEL,"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|ioport
operator|=
name|pACB
operator|->
name|IOPortBase
expr_stmt|;
name|pDCB
operator|=
name|pACB
operator|->
name|pActiveDCB
expr_stmt|;
if|if
condition|(
name|pDCB
condition|)
block|{
comment|/* Arbitration lost but Reselection win */
name|pSRB
operator|=
name|pDCB
operator|->
name|pActiveSRB
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|pACB
operator|->
name|scan_devices
operator|)
condition|)
block|{
name|pSRB
operator|->
name|SRBState
operator|=
name|SRB_READY
expr_stmt|;
name|RewaitSRB
argument_list|(
name|pDCB
argument_list|,
name|pSRB
argument_list|)
expr_stmt|;
block|}
block|}
name|bval
operator|=
name|inb
argument_list|(
name|ioport
operator|+
name|ScsiFifo
argument_list|)
expr_stmt|;
comment|/* get ID */
name|bval
operator|=
name|bval
operator|^
name|pACB
operator|->
name|HostID_Bit
expr_stmt|;
name|wval
operator|=
literal|0
expr_stmt|;
name|bval1
operator|=
literal|1
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|bval
operator|&
name|bval1
operator|)
condition|)
block|{
name|bval1
operator|=
name|bval1
operator|<<
literal|1
expr_stmt|;
name|wval
operator|++
expr_stmt|;
block|}
else|else
break|break;
block|}
name|wval
operator||=
operator|(
operator|(
name|USHORT
operator|)
name|inb
argument_list|(
name|ioport
operator|+
name|ScsiFifo
argument_list|)
operator|&
literal|7
operator|)
operator|<<
literal|8
expr_stmt|;
comment|/* get LUN */
name|pDCB
operator|=
name|pACB
operator|->
name|pLinkDCB
expr_stmt|;
while|while
condition|(
name|wval
operator|!=
operator|*
operator|(
operator|(
name|PUSHORT
operator|)
operator|&
name|pDCB
operator|->
name|UnitSCSIID
operator|)
condition|)
name|pDCB
operator|=
name|pDCB
operator|->
name|pNextDCB
expr_stmt|;
name|pACB
operator|->
name|pActiveDCB
operator|=
name|pDCB
expr_stmt|;
if|if
condition|(
name|pDCB
operator|->
name|SyncMode
operator|&
name|EN_TAG_QUEUING
condition|)
block|{
name|pSRB
operator|=
name|pACB
operator|->
name|pTmpSRB
expr_stmt|;
name|pDCB
operator|->
name|pActiveSRB
operator|=
name|pSRB
expr_stmt|;
block|}
else|else
block|{
name|pSRB
operator|=
name|pDCB
operator|->
name|pActiveSRB
expr_stmt|;
if|if
condition|(
operator|!
name|pSRB
operator|||
operator|!
operator|(
name|pSRB
operator|->
name|SRBState
operator|&
name|SRB_DISCONNECT
operator|)
condition|)
block|{
name|pSRB
operator|=
name|pACB
operator|->
name|pTmpSRB
expr_stmt|;
name|pSRB
operator|->
name|SRBState
operator|=
name|SRB_UNEXPECT_RESEL
expr_stmt|;
name|pDCB
operator|->
name|pActiveSRB
operator|=
name|pSRB
expr_stmt|;
name|EnableMsgOut
argument_list|(
name|pACB
argument_list|,
name|pSRB
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|pDCB
operator|->
name|DCBFlag
operator|&
name|ABORT_DEV_
condition|)
block|{
name|pSRB
operator|->
name|SRBState
operator|=
name|SRB_ABORT_SENT
expr_stmt|;
name|EnableMsgOut
argument_list|(
name|pACB
argument_list|,
name|pSRB
argument_list|)
expr_stmt|;
block|}
else|else
name|pSRB
operator|->
name|SRBState
operator|=
name|SRB_DATA_XFER
expr_stmt|;
block|}
block|}
name|pSRB
operator|->
name|ScsiPhase
operator|=
name|SCSI_NOP0
expr_stmt|;
name|bval
operator|=
name|pDCB
operator|->
name|UnitSCSIID
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|Scsi_Dest_ID
argument_list|)
expr_stmt|;
name|bval
operator|=
name|pDCB
operator|->
name|SyncPeriod
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|Sync_Period
argument_list|)
expr_stmt|;
name|bval
operator|=
name|pDCB
operator|->
name|SyncOffset
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|Sync_Offset
argument_list|)
expr_stmt|;
name|bval
operator|=
name|pDCB
operator|->
name|CtrlR1
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|CtrlReg1
argument_list|)
expr_stmt|;
name|bval
operator|=
name|pDCB
operator|->
name|CtrlR3
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|CtrlReg3
argument_list|)
expr_stmt|;
name|bval
operator|=
name|pDCB
operator|->
name|CtrlR4
expr_stmt|;
comment|/* ; Glitch eater */
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|CtrlReg4
argument_list|)
expr_stmt|;
name|bval
operator|=
name|MSG_ACCEPTED_CMD
expr_stmt|;
comment|/* ;to rls the /ACK signal */
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|ScsiCmd
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|SRBdone
parameter_list|(
name|PACB
name|pACB
parameter_list|,
name|PDCB
name|pDCB
parameter_list|,
name|PSRB
name|pSRB
parameter_list|)
block|{
name|PSRB
name|psrb
decl_stmt|;
name|UCHAR
name|bval
decl_stmt|,
name|bval1
decl_stmt|,
name|i
decl_stmt|,
name|j
decl_stmt|,
name|status
decl_stmt|;
name|PSCSICMD
name|pcmd
decl_stmt|;
name|PSCLINK
name|plink
decl_stmt|;
name|PSCSI_INQDATA
name|ptr
decl_stmt|;
name|USHORT
name|disable_tag
decl_stmt|;
name|int
name|flags
decl_stmt|;
name|PSEG
name|ptr2
decl_stmt|;
name|ULONG
name|swlval
decl_stmt|;
name|pcmd
operator|=
name|pSRB
operator|->
name|pcmd
expr_stmt|;
name|plink
operator|=
name|pcmd
operator|->
name|sc_link
expr_stmt|;
name|status
operator|=
name|pSRB
operator|->
name|TargetStatus
expr_stmt|;
if|if
condition|(
name|pSRB
operator|->
name|SRBFlag
operator|&
name|AUTO_REQSENSE
condition|)
block|{
name|pSRB
operator|->
name|SRBFlag
operator|&=
operator|~
name|AUTO_REQSENSE
expr_stmt|;
name|pSRB
operator|->
name|AdaptStatus
operator|=
literal|0
expr_stmt|;
name|pSRB
operator|->
name|TargetStatus
operator|=
name|SCSI_STAT_CHECKCOND
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|SCSI_STAT_CHECKCOND
condition|)
block|{
name|pcmd
operator|->
name|error
operator|=
name|XS_TIMEOUT
expr_stmt|;
goto|goto
name|ckc_e
goto|;
block|}
if|if
condition|(
name|pSRB
operator|->
name|RetryCnt
operator|==
literal|0
condition|)
block|{
operator|*
operator|(
operator|(
name|PULONG
operator|)
operator|&
operator|(
name|pSRB
operator|->
name|CmdBlock
index|[
literal|0
index|]
operator|)
operator|)
operator|=
name|pSRB
operator|->
name|Segment0
index|[
literal|0
index|]
expr_stmt|;
name|pSRB
operator|->
name|TotalXferredLen
operator|=
name|pSRB
operator|->
name|Segment1
index|[
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|pSRB
operator|->
name|TotalXferredLen
condition|)
block|{
name|pcmd
operator|->
name|resid
operator|=
name|pcmd
operator|->
name|datalen
operator|-
name|pSRB
operator|->
name|TotalXferredLen
expr_stmt|;
name|pcmd
operator|->
name|error
operator|=
name|XS_SENSE
expr_stmt|;
name|pcmd
operator|->
name|flags
operator||=
name|SCSI_RESID_VALID
expr_stmt|;
block|}
else|else
block|{
name|pcmd
operator|->
name|error
operator|=
name|XS_SENSE
expr_stmt|;
name|pcmd
operator|->
name|status
operator|=
name|SCSI_STAT_CHECKCOND
expr_stmt|;
block|}
goto|goto
name|ckc_e
goto|;
block|}
else|else
block|{
name|pSRB
operator|->
name|RetryCnt
operator|--
expr_stmt|;
name|pSRB
operator|->
name|AdaptStatus
operator|=
literal|0
expr_stmt|;
name|pSRB
operator|->
name|TargetStatus
operator|=
literal|0
expr_stmt|;
operator|*
operator|(
operator|(
name|PULONG
operator|)
operator|&
operator|(
name|pSRB
operator|->
name|CmdBlock
index|[
literal|0
index|]
operator|)
operator|)
operator|=
name|pSRB
operator|->
name|Segment0
index|[
literal|0
index|]
expr_stmt|;
operator|*
operator|(
operator|(
name|PULONG
operator|)
operator|&
operator|(
name|pSRB
operator|->
name|CmdBlock
index|[
literal|4
index|]
operator|)
operator|)
operator|=
name|pSRB
operator|->
name|Segment0
index|[
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|pSRB
operator|->
name|CmdBlock
index|[
literal|0
index|]
operator|==
name|TEST_UNIT_READY
condition|)
block|{
name|pcmd
operator|->
name|error
operator|=
name|XS_SENSE
expr_stmt|;
name|pcmd
operator|->
name|status
operator|=
name|SCSI_STAT_CHECKCOND
expr_stmt|;
goto|goto
name|ckc_e
goto|;
block|}
name|pcmd
operator|->
name|error
operator|=
name|XS_SENSE
expr_stmt|;
name|pSRB
operator|->
name|SGcount
operator|=
operator|(
name|UCHAR
operator|)
name|pSRB
operator|->
name|Segment1
index|[
literal|0
index|]
expr_stmt|;
name|pSRB
operator|->
name|ScsiCmdLen
operator|=
call|(
name|UCHAR
call|)
argument_list|(
name|pSRB
operator|->
name|Segment1
index|[
literal|0
index|]
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pSRB
operator|->
name|pSegmentList
operator|=
operator|(
name|PSEG
operator|)
operator|&
name|pSRB
operator|->
name|SGsegment
index|[
literal|0
index|]
expr_stmt|;
name|pSRB
operator|->
name|SGIndex
operator|=
literal|0
expr_stmt|;
name|pSRB
operator|->
name|TotalXferredLen
operator|=
literal|0
expr_stmt|;
name|pSRB
operator|->
name|SGToBeXferLen
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|DC390_StartSCSI
argument_list|(
name|pACB
argument_list|,
name|pDCB
argument_list|,
name|pSRB
argument_list|)
condition|)
name|RewaitSRB
argument_list|(
name|pDCB
argument_list|,
name|pSRB
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
if|if
condition|(
name|status
condition|)
block|{
if|if
condition|(
name|status
operator|==
name|SCSI_STAT_CHECKCOND
condition|)
block|{
if|if
condition|(
operator|(
name|pSRB
operator|->
name|SGIndex
operator|<
name|pSRB
operator|->
name|SGcount
operator|)
operator|&&
operator|(
name|pSRB
operator|->
name|SGcount
operator|)
operator|&&
operator|(
name|pSRB
operator|->
name|SGToBeXferLen
operator|)
condition|)
block|{
name|bval
operator|=
name|pSRB
operator|->
name|SGcount
expr_stmt|;
name|swlval
operator|=
name|pSRB
operator|->
name|SGToBeXferLen
expr_stmt|;
name|ptr2
operator|=
name|pSRB
operator|->
name|pSegmentList
expr_stmt|;
name|ptr2
operator|++
expr_stmt|;
for|for
control|(
name|i
operator|=
name|pSRB
operator|->
name|SGIndex
operator|+
literal|1
init|;
name|i
operator|<
name|bval
condition|;
name|i
operator|++
control|)
block|{
name|swlval
operator|+=
name|ptr2
operator|->
name|SGXLen
expr_stmt|;
name|ptr2
operator|++
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|DC390_DEBUG0
name|printf
argument_list|(
literal|"XferredLen=%8x,NotXferLen=%8x,"
argument_list|,
operator|(
name|UINT
operator|)
name|pSRB
operator|->
name|TotalXferredLen
argument_list|,
operator|(
name|UINT
operator|)
name|swlval
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
name|RequestSense
argument_list|(
name|pACB
argument_list|,
name|pDCB
argument_list|,
name|pSRB
argument_list|)
expr_stmt|;
return|return;
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|SCSI_STAT_QUEUEFULL
condition|)
block|{
name|bval
operator|=
operator|(
name|UCHAR
operator|)
name|pDCB
operator|->
name|GoingSRBCnt
expr_stmt|;
name|bval
operator|--
expr_stmt|;
name|pDCB
operator|->
name|MaxCommand
operator|=
name|bval
expr_stmt|;
name|RewaitSRB
argument_list|(
name|pDCB
argument_list|,
name|pSRB
argument_list|)
expr_stmt|;
name|pSRB
operator|->
name|AdaptStatus
operator|=
literal|0
expr_stmt|;
name|pSRB
operator|->
name|TargetStatus
operator|=
literal|0
expr_stmt|;
return|return;
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|SCSI_STAT_SEL_TIMEOUT
condition|)
block|{
name|pSRB
operator|->
name|AdaptStatus
operator|=
name|H_SEL_TIMEOUT
expr_stmt|;
name|pSRB
operator|->
name|TargetStatus
operator|=
literal|0
expr_stmt|;
name|pcmd
operator|->
name|error
operator|=
name|XS_TIMEOUT
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|SCSI_STAT_BUSY
condition|)
block|{
ifdef|#
directive|ifdef
name|DC390_DEBUG0
name|printf
argument_list|(
literal|"DC390: target busy at %s %d\n"
argument_list|,
name|__FILE__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pcmd
operator|->
name|error
operator|=
name|XS_BUSY
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|SCSI_STAT_RESCONFLICT
condition|)
block|{
ifdef|#
directive|ifdef
name|DC390_DEBUG0
name|printf
argument_list|(
literal|"DC390: target reserved at %s %d\n"
argument_list|,
name|__FILE__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pcmd
operator|->
name|error
operator|=
name|XS_BUSY
expr_stmt|;
comment|/*XXX*/
block|}
else|else
block|{
name|pSRB
operator|->
name|AdaptStatus
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|pSRB
operator|->
name|RetryCnt
condition|)
block|{
name|pSRB
operator|->
name|RetryCnt
operator|--
expr_stmt|;
name|pSRB
operator|->
name|TargetStatus
operator|=
literal|0
expr_stmt|;
name|pSRB
operator|->
name|SGIndex
operator|=
literal|0
expr_stmt|;
name|pSRB
operator|->
name|TotalXferredLen
operator|=
literal|0
expr_stmt|;
name|pSRB
operator|->
name|SGToBeXferLen
operator|=
literal|0
expr_stmt|;
name|pSRB
operator|->
name|pSegmentList
operator|=
operator|(
name|PSEG
operator|)
operator|&
name|pSRB
operator|->
name|SGsegment
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|DC390_StartSCSI
argument_list|(
name|pACB
argument_list|,
name|pDCB
argument_list|,
name|pSRB
argument_list|)
condition|)
name|RewaitSRB
argument_list|(
name|pDCB
argument_list|,
name|pSRB
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
ifdef|#
directive|ifdef
name|DC390_DEBUG0
name|printf
argument_list|(
literal|"DC390: driver stuffup at %s %d\n"
argument_list|,
name|__FILE__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pcmd
operator|->
name|error
operator|=
name|XS_DRIVER_STUFFUP
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|status
operator|=
name|pSRB
operator|->
name|AdaptStatus
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|H_OVER_UNDER_RUN
condition|)
block|{
name|pSRB
operator|->
name|TargetStatus
operator|=
literal|0
expr_stmt|;
name|pcmd
operator|->
name|error
operator|=
name|XS_LENGTH
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pSRB
operator|->
name|SRBStatus
operator|&
name|PARITY_ERROR
condition|)
block|{
ifdef|#
directive|ifdef
name|DC390_DEBUG0
name|printf
argument_list|(
literal|"DC390: driver stuffup %s %d\n"
argument_list|,
name|__FILE__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pcmd
operator|->
name|error
operator|=
name|XS_DRIVER_STUFFUP
expr_stmt|;
block|}
else|else
comment|/* No error */
block|{
name|pSRB
operator|->
name|AdaptStatus
operator|=
literal|0
expr_stmt|;
name|pSRB
operator|->
name|TargetStatus
operator|=
literal|0
expr_stmt|;
name|pcmd
operator|->
name|error
operator|=
name|XS_NOERROR
expr_stmt|;
block|}
block|}
name|ckc_e
label|:
if|if
condition|(
name|pACB
operator|->
name|scan_devices
condition|)
block|{
if|if
condition|(
name|pSRB
operator|->
name|CmdBlock
index|[
literal|0
index|]
operator|==
name|TEST_UNIT_READY
condition|)
block|{
if|if
condition|(
name|pcmd
operator|->
name|error
operator|==
name|XS_TIMEOUT
condition|)
block|{
name|pACB
operator|->
name|DCBmap
index|[
name|plink
operator|->
name|target
index|]
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|plink
operator|->
name|lun
operator|)
expr_stmt|;
name|pPrevDCB
operator|->
name|pNextDCB
operator|=
name|pACB
operator|->
name|pLinkDCB
expr_stmt|;
block|}
else|else
block|{
name|pPrevDCB
operator|->
name|pNextDCB
operator|=
name|pDCB
expr_stmt|;
name|pDCB
operator|->
name|pNextDCB
operator|=
name|pACB
operator|->
name|pLinkDCB
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|pSRB
operator|->
name|CmdBlock
index|[
literal|0
index|]
operator|==
name|INQUIRY
condition|)
block|{
if|if
condition|(
operator|(
name|plink
operator|->
name|target
operator|==
name|pACB
operator|->
name|max_id
operator|)
operator|&&
operator|(
name|plink
operator|->
name|lun
operator|==
name|pACB
operator|->
name|max_lun
operator|)
condition|)
name|pACB
operator|->
name|scan_devices
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|pcmd
operator|->
name|error
operator|==
name|XS_TIMEOUT
condition|)
goto|goto
name|NO_DEV
goto|;
name|ptr
operator|=
call|(
name|PSCSI_INQDATA
call|)
argument_list|(
name|pcmd
operator|->
name|data
argument_list|)
expr_stmt|;
name|bval1
operator|=
name|ptr
operator|->
name|DevType
operator|&
name|SCSI_DEVTYPE
expr_stmt|;
if|if
condition|(
name|bval1
operator|==
name|SCSI_NODEV
condition|)
block|{
name|NO_DEV
label|:
name|pACB
operator|->
name|DCBmap
index|[
name|plink
operator|->
name|target
index|]
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|plink
operator|->
name|lun
operator|)
expr_stmt|;
name|pPrevDCB
operator|->
name|pNextDCB
operator|=
name|pACB
operator|->
name|pLinkDCB
expr_stmt|;
block|}
else|else
block|{
name|pACB
operator|->
name|DeviceCnt
operator|++
expr_stmt|;
name|pPrevDCB
operator|=
name|pDCB
expr_stmt|;
name|pACB
operator|->
name|pDCB_free
operator|=
call|(
name|PDCB
call|)
argument_list|(
call|(
name|ULONG
call|)
argument_list|(
name|pACB
operator|->
name|pDCB_free
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|DC390_DCB
argument_list|)
argument_list|)
expr_stmt|;
name|pDCB
operator|->
name|DevType
operator|=
name|bval1
expr_stmt|;
if|if
condition|(
name|bval1
operator|==
name|SCSI_DASD
operator|||
name|bval1
operator|==
name|SCSI_OPTICAL
condition|)
block|{
if|if
condition|(
operator|(
operator|(
operator|(
name|ptr
operator|->
name|Vers
operator|&
literal|0x07
operator|)
operator|>=
literal|2
operator|)
operator|||
operator|(
operator|(
name|ptr
operator|->
name|RDF
operator|&
literal|0x0F
operator|)
operator|==
literal|2
operator|)
operator|)
operator|&&
operator|(
name|ptr
operator|->
name|Flags
operator|&
name|SCSI_INQ_CMDQUEUE
operator|)
operator|&&
operator|(
name|pDCB
operator|->
name|DevMode
operator|&
name|TAG_QUEUING_
operator|)
operator|&&
operator|(
name|pDCB
operator|->
name|DevMode
operator|&
name|EN_DISCONNECT_
operator|)
condition|)
block|{
name|disable_tag
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|BADDEVCNT
condition|;
name|i
operator|++
control|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|28
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
operator|(
operator|(
name|PUCHAR
operator|)
name|ptr
operator|)
index|[
literal|8
operator|+
name|j
index|]
operator|!=
name|baddevname1
index|[
name|i
index|]
index|[
name|j
index|]
condition|)
break|break;
block|}
if|if
condition|(
name|j
operator|==
literal|28
condition|)
block|{
name|disable_tag
operator|=
literal|1
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
operator|!
name|disable_tag
condition|)
block|{
name|pDCB
operator|->
name|MaxCommand
operator|=
name|pACB
operator|->
name|TagMaxNum
expr_stmt|;
name|pDCB
operator|->
name|SyncMode
operator||=
name|EN_TAG_QUEUING
expr_stmt|;
name|pDCB
operator|->
name|TagMask
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|pDCB
operator|->
name|SyncMode
operator||=
name|EN_ATN_STOP
expr_stmt|;
block|}
block|}
block|}
block|}
block|}
block|}
name|flags
operator|=
name|splbio
argument_list|()
expr_stmt|;
comment|/*  ReleaseSRB( pDCB, pSRB ); */
if|if
condition|(
name|pSRB
operator|==
name|pDCB
operator|->
name|pGoingSRB
condition|)
block|{
name|pDCB
operator|->
name|pGoingSRB
operator|=
name|pSRB
operator|->
name|pNextSRB
expr_stmt|;
block|}
else|else
block|{
name|psrb
operator|=
name|pDCB
operator|->
name|pGoingSRB
expr_stmt|;
while|while
condition|(
name|psrb
operator|->
name|pNextSRB
operator|!=
name|pSRB
condition|)
name|psrb
operator|=
name|psrb
operator|->
name|pNextSRB
expr_stmt|;
name|psrb
operator|->
name|pNextSRB
operator|=
name|pSRB
operator|->
name|pNextSRB
expr_stmt|;
if|if
condition|(
name|pSRB
operator|==
name|pDCB
operator|->
name|pGoingLast
condition|)
name|pDCB
operator|->
name|pGoingLast
operator|=
name|psrb
expr_stmt|;
block|}
name|pSRB
operator|->
name|pNextSRB
operator|=
name|pACB
operator|->
name|pFreeSRB
expr_stmt|;
name|pACB
operator|->
name|pFreeSRB
operator|=
name|pSRB
expr_stmt|;
name|pDCB
operator|->
name|GoingSRBCnt
operator|--
expr_stmt|;
name|DoWaitingSRB
argument_list|(
name|pACB
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|flags
argument_list|)
expr_stmt|;
name|pcmd
operator|->
name|flags
operator||=
name|ITSDONE
expr_stmt|;
comment|/*  Notify cmd done */
name|scsi_done
argument_list|(
name|pcmd
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|DoingSRB_Done
parameter_list|(
name|PACB
name|pACB
parameter_list|)
block|{
name|PDCB
name|pDCB
decl_stmt|,
name|pdcb
decl_stmt|;
name|PSRB
name|psrb
decl_stmt|,
name|psrb2
decl_stmt|;
name|USHORT
name|cnt
decl_stmt|,
name|i
decl_stmt|;
name|PSCSICMD
name|pcmd
decl_stmt|;
name|pDCB
operator|=
name|pACB
operator|->
name|pLinkDCB
expr_stmt|;
name|pdcb
operator|=
name|pDCB
expr_stmt|;
do|do
block|{
name|cnt
operator|=
name|pdcb
operator|->
name|GoingSRBCnt
expr_stmt|;
name|psrb
operator|=
name|pdcb
operator|->
name|pGoingSRB
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cnt
condition|;
name|i
operator|++
control|)
block|{
name|psrb2
operator|=
name|psrb
operator|->
name|pNextSRB
expr_stmt|;
name|pcmd
operator|=
name|psrb
operator|->
name|pcmd
expr_stmt|;
name|pcmd
operator|->
name|error
operator|=
name|XS_TIMEOUT
expr_stmt|;
comment|/*	    ReleaseSRB( pDCB, pSRB ); */
name|psrb
operator|->
name|pNextSRB
operator|=
name|pACB
operator|->
name|pFreeSRB
expr_stmt|;
name|pACB
operator|->
name|pFreeSRB
operator|=
name|psrb
expr_stmt|;
name|scsi_done
argument_list|(
name|pcmd
argument_list|)
expr_stmt|;
name|psrb
operator|=
name|psrb2
expr_stmt|;
block|}
name|pdcb
operator|->
name|GoingSRBCnt
operator|=
literal|0
expr_stmt|;
empty_stmt|;
name|pdcb
operator|->
name|pGoingSRB
operator|=
name|NULL
expr_stmt|;
name|pdcb
operator|->
name|TagMask
operator|=
literal|0
expr_stmt|;
name|pdcb
operator|=
name|pdcb
operator|->
name|pNextDCB
expr_stmt|;
block|}
do|while
condition|(
name|pdcb
operator|!=
name|pDCB
condition|)
do|;
block|}
end_function

begin_function
specifier|static
name|void
name|DC390_ResetSCSIBus
parameter_list|(
name|PACB
name|pACB
parameter_list|)
block|{
name|USHORT
name|ioport
decl_stmt|;
name|UCHAR
name|bval
decl_stmt|;
name|int
name|flags
decl_stmt|;
name|flags
operator|=
name|splbio
argument_list|()
expr_stmt|;
name|pACB
operator|->
name|ACBFlag
operator||=
name|RESET_DEV
expr_stmt|;
name|ioport
operator|=
name|pACB
operator|->
name|IOPortBase
expr_stmt|;
name|bval
operator|=
name|DMA_IDLE_CMD
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|DMA_Cmd
argument_list|)
expr_stmt|;
name|bval
operator|=
name|RST_SCSI_BUS_CMD
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|ScsiCmd
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|flags
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|DC390_ScsiRstDetect
parameter_list|(
name|PACB
name|pACB
parameter_list|)
block|{
name|int
name|flags
decl_stmt|;
name|ULONG
name|wlval
decl_stmt|;
name|USHORT
name|ioport
decl_stmt|;
name|UCHAR
name|bval
decl_stmt|;
ifdef|#
directive|ifdef
name|DC390_DEBUG0
name|printf
argument_list|(
literal|"RST_DETEC"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|wlval
operator|=
literal|1000
expr_stmt|;
while|while
condition|(
operator|--
name|wlval
condition|)
comment|/* delay 1 sec */
block|{
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
block|}
name|flags
operator|=
name|splbio
argument_list|()
expr_stmt|;
name|ioport
operator|=
name|pACB
operator|->
name|IOPortBase
expr_stmt|;
name|bval
operator|=
name|DMA_IDLE_CMD
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|DMA_Cmd
argument_list|)
expr_stmt|;
name|bval
operator|=
name|CLEAR_FIFO_CMD
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|ScsiCmd
argument_list|)
expr_stmt|;
if|if
condition|(
name|pACB
operator|->
name|ACBFlag
operator|&
name|RESET_DEV
condition|)
name|pACB
operator|->
name|ACBFlag
operator||=
name|RESET_DONE
expr_stmt|;
else|else
block|{
name|pACB
operator|->
name|ACBFlag
operator||=
name|RESET_DETECT
expr_stmt|;
name|ResetDevParam
argument_list|(
name|pACB
argument_list|)
expr_stmt|;
comment|/*	DoingSRB_Done( pACB ); ???? */
name|RecoverSRB
argument_list|(
name|pACB
argument_list|)
expr_stmt|;
name|pACB
operator|->
name|pActiveDCB
operator|=
name|NULL
expr_stmt|;
name|pACB
operator|->
name|ACBFlag
operator|=
literal|0
expr_stmt|;
name|DoWaitingSRB
argument_list|(
name|pACB
argument_list|)
expr_stmt|;
block|}
name|splx
argument_list|(
name|flags
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|RequestSense
parameter_list|(
name|PACB
name|pACB
parameter_list|,
name|PDCB
name|pDCB
parameter_list|,
name|PSRB
name|pSRB
parameter_list|)
block|{
name|PSCSICMD
name|pcmd
decl_stmt|;
name|pSRB
operator|->
name|SRBFlag
operator||=
name|AUTO_REQSENSE
expr_stmt|;
name|pSRB
operator|->
name|Segment0
index|[
literal|0
index|]
operator|=
operator|*
operator|(
operator|(
name|PULONG
operator|)
operator|&
operator|(
name|pSRB
operator|->
name|CmdBlock
index|[
literal|0
index|]
operator|)
operator|)
expr_stmt|;
name|pSRB
operator|->
name|Segment0
index|[
literal|1
index|]
operator|=
operator|*
operator|(
operator|(
name|PULONG
operator|)
operator|&
operator|(
name|pSRB
operator|->
name|CmdBlock
index|[
literal|4
index|]
operator|)
operator|)
expr_stmt|;
name|pSRB
operator|->
name|Segment1
index|[
literal|0
index|]
operator|=
call|(
name|ULONG
call|)
argument_list|(
operator|(
name|pSRB
operator|->
name|ScsiCmdLen
operator|<<
literal|8
operator|)
operator|+
name|pSRB
operator|->
name|SGcount
argument_list|)
expr_stmt|;
name|pSRB
operator|->
name|Segment1
index|[
literal|1
index|]
operator|=
name|pSRB
operator|->
name|TotalXferredLen
expr_stmt|;
name|pSRB
operator|->
name|AdaptStatus
operator|=
literal|0
expr_stmt|;
name|pSRB
operator|->
name|TargetStatus
operator|=
literal|0
expr_stmt|;
name|pcmd
operator|=
name|pSRB
operator|->
name|pcmd
expr_stmt|;
name|pSRB
operator|->
name|Segmentx
operator|.
name|SGXPtr
operator|=
operator|(
name|ULONG
operator|)
name|vtophys
argument_list|(
operator|&
name|pcmd
operator|->
name|sense
argument_list|)
expr_stmt|;
name|pSRB
operator|->
name|Segmentx
operator|.
name|SGXLen
operator|=
operator|(
name|ULONG
operator|)
sizeof|sizeof
argument_list|(
expr|struct
name|scsi_sense_data
argument_list|)
expr_stmt|;
name|pSRB
operator|->
name|pSegmentList
operator|=
operator|&
name|pSRB
operator|->
name|Segmentx
expr_stmt|;
name|pSRB
operator|->
name|SGcount
operator|=
literal|1
expr_stmt|;
name|pSRB
operator|->
name|SGIndex
operator|=
literal|0
expr_stmt|;
operator|*
operator|(
operator|(
name|PULONG
operator|)
operator|&
operator|(
name|pSRB
operator|->
name|CmdBlock
index|[
literal|0
index|]
operator|)
operator|)
operator|=
literal|0x00000003
expr_stmt|;
name|pSRB
operator|->
name|CmdBlock
index|[
literal|1
index|]
operator|=
name|pDCB
operator|->
name|IdentifyMsg
operator|<<
literal|5
expr_stmt|;
operator|*
operator|(
operator|(
name|PUSHORT
operator|)
operator|&
operator|(
name|pSRB
operator|->
name|CmdBlock
index|[
literal|4
index|]
operator|)
operator|)
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|scsi_sense_data
argument_list|)
expr_stmt|;
name|pSRB
operator|->
name|ScsiCmdLen
operator|=
literal|6
expr_stmt|;
name|pSRB
operator|->
name|TotalXferredLen
operator|=
literal|0
expr_stmt|;
name|pSRB
operator|->
name|SGToBeXferLen
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|DC390_StartSCSI
argument_list|(
name|pACB
argument_list|,
name|pDCB
argument_list|,
name|pSRB
argument_list|)
condition|)
name|RewaitSRB
argument_list|(
name|pDCB
argument_list|,
name|pSRB
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|EnableMsgOut2
parameter_list|(
name|PACB
name|pACB
parameter_list|,
name|PSRB
name|pSRB
parameter_list|)
block|{
name|USHORT
name|ioport
decl_stmt|;
name|UCHAR
name|bval
decl_stmt|;
name|ioport
operator|=
name|pACB
operator|->
name|IOPortBase
expr_stmt|;
name|pSRB
operator|->
name|MsgCnt
operator|=
literal|1
expr_stmt|;
name|bval
operator|=
name|SET_ATN_CMD
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|ScsiCmd
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|EnableMsgOut
parameter_list|(
name|PACB
name|pACB
parameter_list|,
name|PSRB
name|pSRB
parameter_list|)
block|{
name|pSRB
operator|->
name|MsgOutBuf
index|[
literal|0
index|]
operator|=
name|MSG_ABORT
expr_stmt|;
name|EnableMsgOut2
argument_list|(
name|pACB
argument_list|,
name|pSRB
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|DC390_InvalidCmd
parameter_list|(
name|PACB
name|pACB
parameter_list|)
block|{
name|UCHAR
name|bval
decl_stmt|;
name|USHORT
name|ioport
decl_stmt|;
name|PSRB
name|pSRB
decl_stmt|;
name|pSRB
operator|=
name|pACB
operator|->
name|pActiveDCB
operator|->
name|pActiveSRB
expr_stmt|;
if|if
condition|(
name|pSRB
operator|->
name|SRBState
operator|&
operator|(
name|SRB_START_
operator|+
name|SRB_MSGOUT
operator|)
condition|)
block|{
name|ioport
operator|=
name|pACB
operator|->
name|IOPortBase
expr_stmt|;
name|bval
operator|=
name|CLEAR_FIFO_CMD
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
operator|(
name|ioport
operator|+
name|ScsiCmd
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

end_unit


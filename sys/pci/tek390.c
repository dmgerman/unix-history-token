begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/***********************************************************************  *	FILE NAME : TEK390.C					       *  *	     BY   : C.L. Huang	(ching@tekram.com.tw)		       *  *	Description: Device Driver for Tekram DC-390(T) PCI SCSI       *  *		     Bus Master Host Adapter			       *  * (C)Copyright 1995-1996 Tekram Technology Co., Ltd.		       *  ***********************************************************************/
end_comment

begin_comment
comment|/***********************************************************************  *	HISTORY:						       *  *								       *  *	REV#	DATE	NAME	DESCRIPTION			       *  *	1.00  07/02/96	CLH	First release for RELEASE-2.1.0        *  *	1.01  08/20/96	CLH	Update for RELEASE-2.1.5	       *  *								       *  ***********************************************************************/
end_comment

begin_comment
comment|/**************************************************************************  *  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. The name of the author may not be used to endorse or promote products  *    derived from this software without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  *  **************************************************************************/
end_comment

begin_comment
comment|/**************************************************************************/
end_comment

begin_comment
comment|/* Imported into FreeBSD source repository, and updated to compile under  */
end_comment

begin_comment
comment|/* FreeBSD-3.0-DEVELOPMENT, by Stefan Esser<se@FreeBSD.Org>, 1996-12-17  */
end_comment

begin_comment
comment|/**************************************************************************/
end_comment

begin_comment
comment|/* #define REL_2_1_0 */
end_comment

begin_define
define|#
directive|define
name|REL_2_1_5
end_define

begin_define
define|#
directive|define
name|DC390_DEBUG
end_define

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_comment
comment|/* XXX this doesn't actually compile unless KERNEL is defined. */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|KERNEL
end_ifdef

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/buf.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm.h>
end_include

begin_include
include|#
directive|include
file|<vm/pmap.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* KERNEL */
end_comment

begin_include
include|#
directive|include
file|<pci/pcivar.h>
end_include

begin_include
include|#
directive|include
file|<pci/pcireg.h>
end_include

begin_include
include|#
directive|include
file|<scsi/scsiconf.h>
end_include

begin_include
include|#
directive|include
file|<machine/clock.h>
end_include

begin_include
include|#
directive|include
file|<pci/tek390.h>
end_include

begin_define
define|#
directive|define
name|INT32
value|int32
end_define

begin_define
define|#
directive|define
name|U_INT32
value|u_int32
end_define

begin_define
define|#
directive|define
name|OutB
parameter_list|(
name|val
parameter_list|,
name|port
parameter_list|)
value|outb(port, val)
end_define

begin_define
define|#
directive|define
name|OutW
parameter_list|(
name|val
parameter_list|,
name|port
parameter_list|)
value|outw(port, val)
end_define

begin_define
define|#
directive|define
name|OutL
parameter_list|(
name|val
parameter_list|,
name|port
parameter_list|)
value|outl(port, val)
end_define

begin_define
define|#
directive|define
name|PCI_DEVICE_ID_AMD53C974
value|0x20201022ul
end_define

begin_define
define|#
directive|define
name|PCI_BASE_ADDR0
value|0x10
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|REL_2_1_0
end_ifdef

begin_function_decl
specifier|static
name|int
name|DC390_Interrupt
parameter_list|(
name|PACB
name|pACB
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|REL_2_1_5
end_ifdef

begin_function_decl
specifier|static
name|void
name|DC390_Interrupt
parameter_list|(
name|PACB
name|pACB
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|USHORT
name|DC390_StartSCSI
parameter_list|(
name|PACB
name|pACB
parameter_list|,
name|PDCB
name|pDCB
parameter_list|,
name|PSRB
name|pSRB
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|DC390_DataOut_0
parameter_list|(
name|PACB
name|pACB
parameter_list|,
name|PSRB
name|pSRB
parameter_list|,
name|PUCHAR
name|psstatus
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|DC390_DataIn_0
parameter_list|(
name|PACB
name|pACB
parameter_list|,
name|PSRB
name|pSRB
parameter_list|,
name|PUCHAR
name|psstatus
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|DC390_Command_0
parameter_list|(
name|PACB
name|pACB
parameter_list|,
name|PSRB
name|pSRB
parameter_list|,
name|PUCHAR
name|psstatus
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|DC390_Status_0
parameter_list|(
name|PACB
name|pACB
parameter_list|,
name|PSRB
name|pSRB
parameter_list|,
name|PUCHAR
name|psstatus
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|DC390_MsgOut_0
parameter_list|(
name|PACB
name|pACB
parameter_list|,
name|PSRB
name|pSRB
parameter_list|,
name|PUCHAR
name|psstatus
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|DC390_MsgIn_0
parameter_list|(
name|PACB
name|pACB
parameter_list|,
name|PSRB
name|pSRB
parameter_list|,
name|PUCHAR
name|psstatus
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|DC390_DataOutPhase
parameter_list|(
name|PACB
name|pACB
parameter_list|,
name|PSRB
name|pSRB
parameter_list|,
name|PUCHAR
name|psstatus
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|DC390_DataInPhase
parameter_list|(
name|PACB
name|pACB
parameter_list|,
name|PSRB
name|pSRB
parameter_list|,
name|PUCHAR
name|psstatus
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|DC390_CommandPhase
parameter_list|(
name|PACB
name|pACB
parameter_list|,
name|PSRB
name|pSRB
parameter_list|,
name|PUCHAR
name|psstatus
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|DC390_StatusPhase
parameter_list|(
name|PACB
name|pACB
parameter_list|,
name|PSRB
name|pSRB
parameter_list|,
name|PUCHAR
name|psstatus
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|DC390_MsgOutPhase
parameter_list|(
name|PACB
name|pACB
parameter_list|,
name|PSRB
name|pSRB
parameter_list|,
name|PUCHAR
name|psstatus
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|DC390_MsgInPhase
parameter_list|(
name|PACB
name|pACB
parameter_list|,
name|PSRB
name|pSRB
parameter_list|,
name|PUCHAR
name|psstatus
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|DC390_Nop_0
parameter_list|(
name|PACB
name|pACB
parameter_list|,
name|PSRB
name|pSRB
parameter_list|,
name|PUCHAR
name|psstatus
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|DC390_Nop_1
parameter_list|(
name|PACB
name|pACB
parameter_list|,
name|PSRB
name|pSRB
parameter_list|,
name|PUCHAR
name|psstatus
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|SetXferRate
parameter_list|(
name|PACB
name|pACB
parameter_list|,
name|PDCB
name|pDCB
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|DC390_Disconnect
parameter_list|(
name|PACB
name|pACB
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|DC390_Reselect
parameter_list|(
name|PACB
name|pACB
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|SRBdone
parameter_list|(
name|PACB
name|pACB
parameter_list|,
name|PDCB
name|pDCB
parameter_list|,
name|PSRB
name|pSRB
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|DoingSRB_Done
parameter_list|(
name|PACB
name|pACB
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|DC390_ScsiRstDetect
parameter_list|(
name|PACB
name|pACB
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|DC390_ResetSCSIBus
parameter_list|(
name|PACB
name|pACB
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|RequestSense
parameter_list|(
name|PACB
name|pACB
parameter_list|,
name|PDCB
name|pDCB
parameter_list|,
name|PSRB
name|pSRB
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|EnableMsgOut2
parameter_list|(
name|PACB
name|pACB
parameter_list|,
name|PSRB
name|pSRB
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|EnableMsgOut
parameter_list|(
name|PACB
name|pACB
parameter_list|,
name|PSRB
name|pSRB
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|DC390_InvalidCmd
parameter_list|(
name|PACB
name|pACB
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * XXX No timeouts are scheduled in this driver as the timeout handler  *     doesn't do anything yet!!!  */
end_comment

begin_function_decl
specifier|static
name|void
name|DC390_timeout
parameter_list|(
name|void
modifier|*
name|arg1
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|DC390_reset
parameter_list|(
name|PACB
name|pACB
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|PUCHAR
name|phystovirt
parameter_list|(
name|PSRB
name|pSRB
parameter_list|,
name|ULONG
name|xferCnt
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|DC390_initDCB
parameter_list|(
name|PACB
name|pACB
parameter_list|,
name|PDCB
name|pDCB
parameter_list|,
name|PSCSICMD
name|cmd
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|DC390_initSRB
parameter_list|(
name|PSRB
name|psrb
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|DC390_linkSRB
parameter_list|(
name|PACB
name|pACB
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|DC390_initACB
parameter_list|(
name|PACB
name|pACB
parameter_list|,
name|ULONG
name|io_port
parameter_list|,
name|UCHAR
name|Irq
parameter_list|,
name|USHORT
name|index
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|DC390_initAdapter
parameter_list|(
name|PACB
name|pACB
parameter_list|,
name|ULONG
name|io_port
parameter_list|,
name|UCHAR
name|Irq
parameter_list|,
name|USHORT
name|index
parameter_list|,
name|pcici_t
name|config_id
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|DC390_EnableCfg
parameter_list|(
name|USHORT
name|mechnum
parameter_list|,
name|UCHAR
name|regval
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|DC390_DisableCfg
parameter_list|(
name|USHORT
name|mechnum
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|UCHAR
name|DC390_inByte
parameter_list|(
name|USHORT
name|mechnum
parameter_list|,
name|UCHAR
name|regval
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|USHORT
name|DC390_inWord
parameter_list|(
name|USHORT
name|mechnum
parameter_list|,
name|UCHAR
name|regval
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|ULONG
name|DC390_inDword
parameter_list|(
name|USHORT
name|mechnum
parameter_list|,
name|UCHAR
name|regval
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|DC390_OutB
parameter_list|(
name|USHORT
name|mechnum
parameter_list|,
name|UCHAR
name|regval
parameter_list|,
name|UCHAR
name|bval
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|DC390_EnDisableCE
parameter_list|(
name|UCHAR
name|mode
parameter_list|,
name|USHORT
name|mechnum
parameter_list|,
name|PUCHAR
name|regval
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|DC390_EEpromOutDI
parameter_list|(
name|USHORT
name|mechnum
parameter_list|,
name|PUCHAR
name|regval
parameter_list|,
name|USHORT
name|Carry
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|UCHAR
name|DC390_EEpromInDO
parameter_list|(
name|USHORT
name|mechnum
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|USHORT
name|EEpromGetData1
parameter_list|(
name|USHORT
name|mechnum
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|DC390_Prepare
parameter_list|(
name|USHORT
name|mechnum
parameter_list|,
name|PUCHAR
name|regval
parameter_list|,
name|UCHAR
name|EEpromCmd
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|DC390_ReadEEprom
parameter_list|(
name|USHORT
name|mechnum
parameter_list|,
name|USHORT
name|index
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|USHORT
name|DC390_DefaultEEprom
parameter_list|(
name|USHORT
name|mechnum
parameter_list|,
name|USHORT
name|index
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|USHORT
name|DC390_CheckEEpromCheckSum
parameter_list|(
name|USHORT
name|MechNum
parameter_list|,
name|USHORT
name|index
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|USHORT
name|DC390_ToMech
parameter_list|(
name|USHORT
name|Mechnum
parameter_list|,
name|pcici_t
name|config_id
parameter_list|)
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|KERNEL
end_ifdef

begin_function_decl
specifier|static
name|char
modifier|*
name|trmamd_probe
parameter_list|(
name|pcici_t
name|tag
parameter_list|,
name|pcidi_t
name|type
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|trmamd_attach
parameter_list|(
name|pcici_t
name|tag
parameter_list|,
name|int
name|unit
parameter_list|)
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|REL_2_1_0
end_ifdef

begin_function_decl
specifier|static
name|int32
name|trmamd_scsi_cmd
parameter_list|(
name|struct
name|scsi_xfer
modifier|*
name|sx
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|REL_2_1_5
end_ifdef

begin_function_decl
specifier|static
name|int32_t
name|trmamd_scsi_cmd
parameter_list|(
name|struct
name|scsi_xfer
modifier|*
name|sx
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|void
name|trmamd_min_phys
parameter_list|(
name|struct
name|buf
modifier|*
name|pbuf
parameter_list|)
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|REL_2_1_0
end_ifdef

begin_function_decl
specifier|static
name|u_int32
name|trmamd_info
parameter_list|(
name|int
name|unit
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* KERNEL */
end_comment

begin_decl_stmt
specifier|static
name|u_long
name|trmamd_count
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|pci_device
name|trmamd_device
init|=
block|{
literal|"amd"
block|,
name|trmamd_probe
block|,
name|trmamd_attach
block|,
operator|&
name|trmamd_count
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DATA_SET
argument_list|(
name|pcidevice_set
argument_list|,
name|trmamd_device
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|struct
name|scsi_adapter
name|trmamd_switch
init|=
block|{
name|trmamd_scsi_cmd
block|,
name|trmamd_min_phys
block|,
literal|0
block|,
literal|0
block|,
ifdef|#
directive|ifdef
name|REL_2_1_0
name|trmamd_info
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|REL_2_1_5
literal|0
block|,
endif|#
directive|endif
literal|"amd"
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|scsi_device
name|trmamd_dev
init|=
block|{
name|NULL
block|,
comment|/* Use default error handler */
name|NULL
block|,
comment|/* have a queue, served by this */
name|NULL
block|,
comment|/* have no async handler */
name|NULL
block|,
comment|/* Use default 'done' routine */
literal|"amd"
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|PACB
name|pACB0
index|[
name|MAX_ADAPTER_NUM
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|PACB
name|pACB_start
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|PACB
name|pACB_current
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|PDCB
name|pPrevDCB
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|USHORT
name|adapterCnt
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|USHORT
name|CurrSyncOffset
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|USHORT
name|mech2Agent
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|ULONG
name|mech1addr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|UCHAR
name|mech2bus
decl_stmt|,
name|mech2CfgSPenR
decl_stmt|,
name|CurrentID
decl_stmt|,
name|CurrentLUN
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|PVOID
name|DC390_phase0
index|[]
init|=
block|{
name|DC390_DataOut_0
block|,
name|DC390_DataIn_0
block|,
name|DC390_Command_0
block|,
name|DC390_Status_0
block|,
name|DC390_Nop_0
block|,
name|DC390_Nop_0
block|,
name|DC390_MsgOut_0
block|,
name|DC390_MsgIn_0
block|,
name|DC390_Nop_1
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|PVOID
name|DC390_phase1
index|[]
init|=
block|{
name|DC390_DataOutPhase
block|,
name|DC390_DataInPhase
block|,
name|DC390_CommandPhase
block|,
name|DC390_StatusPhase
block|,
name|DC390_Nop_0
block|,
name|DC390_Nop_0
block|,
name|DC390_MsgOutPhase
block|,
name|DC390_MsgInPhase
block|,
name|DC390_Nop_1
block|,        }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|UCHAR
name|eepromBuf
index|[
name|MAX_ADAPTER_NUM
index|]
index|[
literal|128
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|UCHAR
name|clock_period1
index|[]
init|=
block|{
literal|4
block|,
literal|5
block|,
literal|6
block|,
literal|7
block|,
literal|8
block|,
literal|10
block|,
literal|13
block|,
literal|20
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|UCHAR
name|baddevname1
index|[
literal|2
index|]
index|[
literal|28
index|]
init|=
block|{
literal|"SEAGATE ST3390N  ???    9546"
block|,
literal|"HP      C3323-300       4269"
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|BADDEVCNT
value|2
end_define

begin_comment
comment|/***********************************************************************  *  *  *  **********************************************************************/
end_comment

begin_function
specifier|static
name|PSRB
name|GetSRB
parameter_list|(
name|PACB
name|pACB
parameter_list|)
block|{
name|int
name|flags
decl_stmt|;
name|PSRB
name|pSRB
decl_stmt|;
name|flags
operator|=
name|splbio
argument_list|()
expr_stmt|;
name|pSRB
operator|=
name|pACB
operator|->
name|pFreeSRB
expr_stmt|;
if|if
condition|(
name|pSRB
condition|)
block|{
name|pACB
operator|->
name|pFreeSRB
operator|=
name|pSRB
operator|->
name|pNextSRB
expr_stmt|;
name|pSRB
operator|->
name|pNextSRB
operator|=
name|NULL
expr_stmt|;
block|}
name|splx
argument_list|(
name|flags
argument_list|)
expr_stmt|;
return|return
operator|(
name|pSRB
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|RewaitSRB0
parameter_list|(
name|PDCB
name|pDCB
parameter_list|,
name|PSRB
name|pSRB
parameter_list|)
block|{
name|PSRB
name|psrb1
decl_stmt|;
name|int
name|flags
decl_stmt|;
name|flags
operator|=
name|splbio
argument_list|()
expr_stmt|;
if|if
condition|(
operator|(
name|psrb1
operator|=
name|pDCB
operator|->
name|pWaitingSRB
operator|)
condition|)
block|{
name|pSRB
operator|->
name|pNextSRB
operator|=
name|psrb1
expr_stmt|;
name|pDCB
operator|->
name|pWaitingSRB
operator|=
name|pSRB
expr_stmt|;
block|}
else|else
block|{
name|pSRB
operator|->
name|pNextSRB
operator|=
name|NULL
expr_stmt|;
name|pDCB
operator|->
name|pWaitingSRB
operator|=
name|pSRB
expr_stmt|;
name|pDCB
operator|->
name|pWaitLast
operator|=
name|pSRB
expr_stmt|;
block|}
name|splx
argument_list|(
name|flags
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|RewaitSRB
parameter_list|(
name|PDCB
name|pDCB
parameter_list|,
name|PSRB
name|pSRB
parameter_list|)
block|{
name|PSRB
name|psrb1
decl_stmt|;
name|int
name|flags
decl_stmt|;
name|UCHAR
name|bval
decl_stmt|;
name|flags
operator|=
name|splbio
argument_list|()
expr_stmt|;
name|pDCB
operator|->
name|GoingSRBCnt
operator|--
expr_stmt|;
name|psrb1
operator|=
name|pDCB
operator|->
name|pGoingSRB
expr_stmt|;
if|if
condition|(
name|pSRB
operator|==
name|psrb1
condition|)
block|{
name|pDCB
operator|->
name|pGoingSRB
operator|=
name|psrb1
operator|->
name|pNextSRB
expr_stmt|;
block|}
else|else
block|{
while|while
condition|(
name|pSRB
operator|!=
name|psrb1
operator|->
name|pNextSRB
condition|)
name|psrb1
operator|=
name|psrb1
operator|->
name|pNextSRB
expr_stmt|;
name|psrb1
operator|->
name|pNextSRB
operator|=
name|pSRB
operator|->
name|pNextSRB
expr_stmt|;
if|if
condition|(
name|pSRB
operator|==
name|pDCB
operator|->
name|pGoingLast
condition|)
name|pDCB
operator|->
name|pGoingLast
operator|=
name|psrb1
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|psrb1
operator|=
name|pDCB
operator|->
name|pWaitingSRB
operator|)
condition|)
block|{
name|pSRB
operator|->
name|pNextSRB
operator|=
name|psrb1
expr_stmt|;
name|pDCB
operator|->
name|pWaitingSRB
operator|=
name|pSRB
expr_stmt|;
block|}
else|else
block|{
name|pSRB
operator|->
name|pNextSRB
operator|=
name|NULL
expr_stmt|;
name|pDCB
operator|->
name|pWaitingSRB
operator|=
name|pSRB
expr_stmt|;
name|pDCB
operator|->
name|pWaitLast
operator|=
name|pSRB
expr_stmt|;
block|}
name|bval
operator|=
name|pSRB
operator|->
name|TagNumber
expr_stmt|;
name|pDCB
operator|->
name|TagMask
operator|&=
operator|(
operator|~
operator|(
literal|1
operator|<<
name|bval
operator|)
operator|)
expr_stmt|;
comment|/* Free TAG number */
name|splx
argument_list|(
name|flags
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|DoWaitingSRB
parameter_list|(
name|PACB
name|pACB
parameter_list|)
block|{
name|int
name|flags
decl_stmt|;
name|PDCB
name|ptr
decl_stmt|,
name|ptr1
decl_stmt|;
name|PSRB
name|pSRB
decl_stmt|;
name|flags
operator|=
name|splbio
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|pACB
operator|->
name|pActiveDCB
operator|)
operator|&&
operator|!
operator|(
name|pACB
operator|->
name|ACBFlag
operator|&
operator|(
name|RESET_DETECT
operator|+
name|RESET_DONE
operator|+
name|RESET_DEV
operator|)
operator|)
condition|)
block|{
name|ptr
operator|=
name|pACB
operator|->
name|pDCBRunRobin
expr_stmt|;
if|if
condition|(
operator|!
name|ptr
condition|)
block|{
name|ptr
operator|=
name|pACB
operator|->
name|pLinkDCB
expr_stmt|;
name|pACB
operator|->
name|pDCBRunRobin
operator|=
name|ptr
expr_stmt|;
block|}
name|ptr1
operator|=
name|ptr
expr_stmt|;
for|for
control|(
init|;
name|ptr1
condition|;
control|)
block|{
name|pACB
operator|->
name|pDCBRunRobin
operator|=
name|ptr1
operator|->
name|pNextDCB
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ptr1
operator|->
name|MaxCommand
operator|>
name|ptr1
operator|->
name|GoingSRBCnt
operator|)
operator|||
operator|!
operator|(
name|pSRB
operator|=
name|ptr1
operator|->
name|pWaitingSRB
operator|)
condition|)
block|{
if|if
condition|(
name|pACB
operator|->
name|pDCBRunRobin
operator|==
name|ptr
condition|)
break|break;
name|ptr1
operator|=
name|ptr1
operator|->
name|pNextDCB
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|DC390_StartSCSI
argument_list|(
name|pACB
argument_list|,
name|ptr1
argument_list|,
name|pSRB
argument_list|)
condition|)
block|{
name|ptr1
operator|->
name|GoingSRBCnt
operator|++
expr_stmt|;
if|if
condition|(
name|ptr1
operator|->
name|pWaitLast
operator|==
name|pSRB
condition|)
block|{
name|ptr1
operator|->
name|pWaitingSRB
operator|=
name|NULL
expr_stmt|;
name|ptr1
operator|->
name|pWaitLast
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|ptr1
operator|->
name|pWaitingSRB
operator|=
name|pSRB
operator|->
name|pNextSRB
expr_stmt|;
block|}
name|pSRB
operator|->
name|pNextSRB
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|ptr1
operator|->
name|pGoingSRB
condition|)
name|ptr1
operator|->
name|pGoingLast
operator|->
name|pNextSRB
operator|=
name|pSRB
expr_stmt|;
else|else
name|ptr1
operator|->
name|pGoingSRB
operator|=
name|pSRB
expr_stmt|;
name|ptr1
operator|->
name|pGoingLast
operator|=
name|pSRB
expr_stmt|;
block|}
break|break;
block|}
block|}
block|}
name|splx
argument_list|(
name|flags
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|SRBwaiting
parameter_list|(
name|PDCB
name|pDCB
parameter_list|,
name|PSRB
name|pSRB
parameter_list|)
block|{
if|if
condition|(
name|pDCB
operator|->
name|pWaitingSRB
condition|)
block|{
name|pDCB
operator|->
name|pWaitLast
operator|->
name|pNextSRB
operator|=
name|pSRB
expr_stmt|;
name|pDCB
operator|->
name|pWaitLast
operator|=
name|pSRB
expr_stmt|;
name|pSRB
operator|->
name|pNextSRB
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|pDCB
operator|->
name|pWaitingSRB
operator|=
name|pSRB
expr_stmt|;
name|pDCB
operator|->
name|pWaitLast
operator|=
name|pSRB
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|SendSRB
parameter_list|(
name|PSCSICMD
name|pcmd
parameter_list|,
name|PACB
name|pACB
parameter_list|,
name|PSRB
name|pSRB
parameter_list|)
block|{
name|int
name|flags
decl_stmt|;
name|PDCB
name|pDCB
decl_stmt|;
name|flags
operator|=
name|splbio
argument_list|()
expr_stmt|;
name|pDCB
operator|=
name|pSRB
operator|->
name|pSRBDCB
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|pDCB
operator|->
name|MaxCommand
operator|>
name|pDCB
operator|->
name|GoingSRBCnt
operator|)
operator|||
operator|(
name|pACB
operator|->
name|pActiveDCB
operator|)
operator|||
operator|(
name|pACB
operator|->
name|ACBFlag
operator|&
operator|(
name|RESET_DETECT
operator|+
name|RESET_DONE
operator|+
name|RESET_DEV
operator|)
operator|)
condition|)
block|{
name|SRBwaiting
argument_list|(
name|pDCB
argument_list|,
name|pSRB
argument_list|)
expr_stmt|;
goto|goto
name|SND_EXIT
goto|;
block|}
if|if
condition|(
name|pDCB
operator|->
name|pWaitingSRB
condition|)
block|{
name|SRBwaiting
argument_list|(
name|pDCB
argument_list|,
name|pSRB
argument_list|)
expr_stmt|;
comment|/*	pSRB = GetWaitingSRB(pDCB); */
name|pSRB
operator|=
name|pDCB
operator|->
name|pWaitingSRB
expr_stmt|;
name|pDCB
operator|->
name|pWaitingSRB
operator|=
name|pSRB
operator|->
name|pNextSRB
expr_stmt|;
name|pSRB
operator|->
name|pNextSRB
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|DC390_StartSCSI
argument_list|(
name|pACB
argument_list|,
name|pDCB
argument_list|,
name|pSRB
argument_list|)
condition|)
block|{
name|pDCB
operator|->
name|GoingSRBCnt
operator|++
expr_stmt|;
if|if
condition|(
name|pDCB
operator|->
name|pGoingSRB
condition|)
block|{
name|pDCB
operator|->
name|pGoingLast
operator|->
name|pNextSRB
operator|=
name|pSRB
expr_stmt|;
name|pDCB
operator|->
name|pGoingLast
operator|=
name|pSRB
expr_stmt|;
block|}
else|else
block|{
name|pDCB
operator|->
name|pGoingSRB
operator|=
name|pSRB
expr_stmt|;
name|pDCB
operator|->
name|pGoingLast
operator|=
name|pSRB
expr_stmt|;
block|}
block|}
else|else
name|RewaitSRB0
argument_list|(
name|pDCB
argument_list|,
name|pSRB
argument_list|)
expr_stmt|;
name|SND_EXIT
label|:
name|splx
argument_list|(
name|flags
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***********************************************************************  * Function : static int32 dc390_scsi_cmd (struct scsi_xfer *cmd)  * Purpose : enqueues a SCSI command  ***********************************************************************/
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|REL_2_1_0
end_ifdef

begin_function
name|int32
endif|#
directive|endif
ifdef|#
directive|ifdef
name|REL_2_1_5
name|int32_t
endif|#
directive|endif
name|trmamd_scsi_cmd
parameter_list|(
name|PSCSICMD
name|cmd
parameter_list|)
block|{
name|USHORT
name|ioport
decl_stmt|,
name|i
decl_stmt|;
name|PSCSICMD
name|pcmd
decl_stmt|;
name|PSCLINK
name|plink
decl_stmt|;
name|PACB
name|pACB
decl_stmt|;
name|PDCB
name|pDCB
decl_stmt|;
name|PSRB
name|pSRB
decl_stmt|;
name|int
name|flags
decl_stmt|,
name|cflags
decl_stmt|,
name|unit
decl_stmt|,
name|CurrPgVaddr
decl_stmt|;
name|ULONG
name|sglen
decl_stmt|,
name|pglen
decl_stmt|,
name|datalen
decl_stmt|,
name|CurrPgPaddr
decl_stmt|,
name|NextPgPaddr
decl_stmt|;
name|PUCHAR
name|ptr
decl_stmt|,
name|ptr1
decl_stmt|;
name|PSEG
name|psg
decl_stmt|;
name|UCHAR
name|sgc
decl_stmt|,
name|sstatus
decl_stmt|;
name|plink
operator|=
name|cmd
operator|->
name|sc_link
expr_stmt|;
name|unit
operator|=
name|plink
operator|->
name|adapter_unit
expr_stmt|;
name|pACB
operator|=
name|pACB0
index|[
name|unit
index|]
expr_stmt|;
name|ioport
operator|=
name|pACB
operator|->
name|IOPortBase
expr_stmt|;
ifdef|#
directive|ifdef
name|DC390_DEBUG0
name|printf
argument_list|(
literal|"Cmd=%2x,ID=%d,LUN=%d,"
argument_list|,
name|cmd
operator|->
name|cmd
operator|->
name|opcode
argument_list|,
name|plink
operator|->
name|target
argument_list|,
name|plink
operator|->
name|lun
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|pACB
operator|->
name|scan_devices
condition|)
block|{
if|if
condition|(
operator|(
name|plink
operator|->
name|target
operator|>
name|CurrentID
operator|)
operator|||
operator|(
name|plink
operator|->
name|target
operator|==
name|CurrentID
operator|)
operator|&&
operator|(
name|plink
operator|->
name|lun
operator|>=
name|CurrentLUN
operator|)
condition|)
block|{
name|CurrentID
operator|=
name|plink
operator|->
name|target
expr_stmt|;
name|CurrentLUN
operator|=
name|plink
operator|->
name|lun
expr_stmt|;
block|}
else|else
block|{
name|pACB
operator|->
name|scan_devices
operator|=
literal|0
expr_stmt|;
name|pPrevDCB
operator|->
name|pNextDCB
operator|=
name|pACB
operator|->
name|pLinkDCB
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|plink
operator|->
name|target
operator|>
name|pACB
operator|->
name|max_id
operator|)
operator|||
operator|(
name|plink
operator|->
name|lun
operator|>
name|pACB
operator|->
name|max_lun
operator|)
condition|)
block|{
ifdef|#
directive|ifdef
name|DC390_DEBUG0
name|printf
argument_list|(
literal|"DC390: Ignore target %d lun %d\n"
argument_list|,
name|plink
operator|->
name|target
argument_list|,
name|plink
operator|->
name|lun
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|cmd
operator|->
name|error
operator|=
name|XS_DRIVER_STUFFUP
expr_stmt|;
return|return
operator|(
name|COMPLETE
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|pACB
operator|->
name|scan_devices
operator|)
operator|&&
operator|!
operator|(
name|pACB
operator|->
name|DCBmap
index|[
name|plink
operator|->
name|target
index|]
operator|&
operator|(
literal|1
operator|<<
name|plink
operator|->
name|lun
operator|)
operator|)
condition|)
block|{
if|if
condition|(
name|pACB
operator|->
name|DeviceCnt
operator|<
name|MAX_DEVICES
condition|)
block|{
name|pACB
operator|->
name|DCBmap
index|[
name|plink
operator|->
name|target
index|]
operator||=
operator|(
literal|1
operator|<<
name|plink
operator|->
name|lun
operator|)
expr_stmt|;
name|pDCB
operator|=
name|pACB
operator|->
name|pDCB_free
expr_stmt|;
ifdef|#
directive|ifdef
name|DC390_DEBUG0
name|printf
argument_list|(
literal|"pDCB=%8x,ID=%2x,"
argument_list|,
operator|(
name|UINT
operator|)
name|pDCB
argument_list|,
name|plink
operator|->
name|target
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|DC390_initDCB
argument_list|(
name|pACB
argument_list|,
name|pDCB
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* ???? */
block|{
ifdef|#
directive|ifdef
name|DC390_DEBUG0
name|printf
argument_list|(
literal|"DC390: Ignore target %d lun %d\n"
argument_list|,
name|plink
operator|->
name|target
argument_list|,
name|plink
operator|->
name|lun
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|cmd
operator|->
name|error
operator|=
name|XS_DRIVER_STUFFUP
expr_stmt|;
return|return
operator|(
name|COMPLETE
operator|)
return|;
block|}
block|}
elseif|else
if|if
condition|(
operator|!
operator|(
name|pACB
operator|->
name|scan_devices
operator|)
operator|&&
operator|!
operator|(
name|pACB
operator|->
name|DCBmap
index|[
name|plink
operator|->
name|target
index|]
operator|&
operator|(
literal|1
operator|<<
name|plink
operator|->
name|lun
operator|)
operator|)
condition|)
block|{
ifdef|#
directive|ifdef
name|DC390_DEBUG0
name|printf
argument_list|(
literal|"DC390: Ignore target %d lun %d\n"
argument_list|,
name|plink
operator|->
name|target
argument_list|,
name|plink
operator|->
name|lun
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|cmd
operator|->
name|error
operator|=
name|XS_DRIVER_STUFFUP
expr_stmt|;
return|return
operator|(
name|COMPLETE
operator|)
return|;
block|}
else|else
block|{
name|pDCB
operator|=
name|pACB
operator|->
name|pLinkDCB
expr_stmt|;
while|while
condition|(
operator|(
name|pDCB
operator|->
name|UnitSCSIID
operator|!=
name|plink
operator|->
name|target
operator|)
operator|||
operator|(
name|pDCB
operator|->
name|UnitSCSILUN
operator|!=
name|plink
operator|->
name|lun
operator|)
condition|)
block|{
name|pDCB
operator|=
name|pDCB
operator|->
name|pNextDCB
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|DC390_DEBUG0
name|printf
argument_list|(
literal|"pDCB=%8x,ID=%2x,"
argument_list|,
operator|(
name|UINT
operator|)
name|pDCB
argument_list|,
name|plink
operator|->
name|target
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
name|cflags
operator|=
name|cmd
operator|->
name|flags
expr_stmt|;
if|if
condition|(
name|cflags
operator|&
name|SCSI_RESET
condition|)
block|{
name|DC390_reset
argument_list|(
name|pACB
argument_list|)
expr_stmt|;
name|cmd
operator|->
name|error
operator|=
name|XS_NOERROR
expr_stmt|;
return|return
operator|(
name|COMPLETE
operator|)
return|;
block|}
if|if
condition|(
name|cflags
operator|&
name|ITSDONE
condition|)
block|{
name|printf
argument_list|(
literal|"DC390: Is it done?\n"
argument_list|)
expr_stmt|;
name|cmd
operator|->
name|flags
operator|&=
operator|~
name|ITSDONE
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|(
name|cflags
operator|&
name|INUSE
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"DC390: In Use?\n"
argument_list|)
expr_stmt|;
name|cmd
operator|->
name|flags
operator||=
name|INUSE
expr_stmt|;
block|}
name|cmd
operator|->
name|error
operator|=
literal|0
expr_stmt|;
name|cmd
operator|->
name|resid
operator|=
literal|0
expr_stmt|;
name|flags
operator|=
name|splbio
argument_list|()
expr_stmt|;
name|pcmd
operator|=
name|cmd
expr_stmt|;
name|pSRB
operator|=
name|GetSRB
argument_list|(
name|pACB
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pSRB
condition|)
block|{
name|pcmd
operator|->
name|error
operator|=
name|XS_DRIVER_STUFFUP
expr_stmt|;
name|splx
argument_list|(
name|flags
argument_list|)
expr_stmt|;
return|return
operator|(
name|TRY_AGAIN_LATER
operator|)
return|;
block|}
comment|/*  BuildSRB(pSRB); */
name|pSRB
operator|->
name|pSRBDCB
operator|=
name|pDCB
expr_stmt|;
name|pSRB
operator|->
name|pcmd
operator|=
name|pcmd
expr_stmt|;
name|ptr
operator|=
operator|(
name|PUCHAR
operator|)
name|pSRB
operator|->
name|CmdBlock
expr_stmt|;
name|ptr1
operator|=
operator|(
name|PUCHAR
operator|)
name|pcmd
operator|->
name|cmd
expr_stmt|;
name|pSRB
operator|->
name|ScsiCmdLen
operator|=
name|pcmd
operator|->
name|cmdlen
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pcmd
operator|->
name|cmdlen
condition|;
name|i
operator|++
control|)
block|{
operator|*
name|ptr
operator|=
operator|*
name|ptr1
expr_stmt|;
name|ptr
operator|++
expr_stmt|;
name|ptr1
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|pcmd
operator|->
name|datalen
condition|)
block|{
name|psg
operator|=
operator|(
name|PSEG
operator|)
operator|&
name|pSRB
operator|->
name|SGsegment
index|[
literal|0
index|]
expr_stmt|;
name|pSRB
operator|->
name|pSegmentList
operator|=
name|psg
expr_stmt|;
name|sgc
operator|=
literal|0
expr_stmt|;
comment|/* Set up the scatter gather list */
name|datalen
operator|=
name|pcmd
operator|->
name|datalen
expr_stmt|;
name|CurrPgVaddr
operator|=
operator|(
name|int
operator|)
name|pcmd
operator|->
name|data
expr_stmt|;
name|CurrPgPaddr
operator|=
name|vtophys
argument_list|(
name|CurrPgVaddr
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|datalen
operator|)
operator|&&
operator|(
name|sgc
operator|<
name|MAX_SG_ENTRY
operator|)
condition|)
block|{
name|sglen
operator|=
literal|0
expr_stmt|;
name|psg
operator|->
name|SGXPtr
operator|=
name|CurrPgPaddr
expr_stmt|;
name|NextPgPaddr
operator|=
name|CurrPgPaddr
expr_stmt|;
while|while
condition|(
operator|(
name|datalen
operator|)
operator|&&
operator|(
name|CurrPgPaddr
operator|==
name|NextPgPaddr
operator|)
condition|)
block|{
comment|/* 		 * This page is contiguous (physically) with the the last, 		 * just extend the length 		 */
name|NextPgPaddr
operator|=
operator|(
name|CurrPgPaddr
operator|&
operator|(
operator|~
operator|(
name|PAGELEN
operator|-
literal|1
operator|)
operator|)
operator|)
operator|+
name|PAGELEN
expr_stmt|;
name|pglen
operator|=
name|NextPgPaddr
operator|-
name|CurrPgPaddr
expr_stmt|;
if|if
condition|(
name|datalen
operator|<
name|pglen
condition|)
name|pglen
operator|=
name|datalen
expr_stmt|;
name|sglen
operator|+=
name|pglen
expr_stmt|;
name|datalen
operator|-=
name|pglen
expr_stmt|;
name|CurrPgVaddr
operator|=
operator|(
name|CurrPgVaddr
operator|&
operator|(
operator|~
operator|(
name|PAGELEN
operator|-
literal|1
operator|)
operator|)
operator|)
operator|+
name|PAGELEN
expr_stmt|;
if|if
condition|(
name|datalen
condition|)
name|CurrPgPaddr
operator|=
name|vtophys
argument_list|(
name|CurrPgVaddr
argument_list|)
expr_stmt|;
block|}
comment|/* 	       next page isn't contiguous, finish this segment 	     */
name|psg
operator|->
name|SGXLen
operator|=
name|sglen
expr_stmt|;
name|psg
operator|++
expr_stmt|;
name|sgc
operator|++
expr_stmt|;
block|}
name|pSRB
operator|->
name|SGcount
operator|=
name|sgc
expr_stmt|;
if|if
condition|(
name|datalen
condition|)
block|{
name|printf
argument_list|(
literal|"DC390: Out Of Segment Buffer!\n"
argument_list|)
expr_stmt|;
name|pSRB
operator|->
name|pNextSRB
operator|=
name|pACB
operator|->
name|pFreeSRB
expr_stmt|;
name|pACB
operator|->
name|pFreeSRB
operator|=
name|pSRB
expr_stmt|;
name|pcmd
operator|->
name|error
operator|=
name|XS_DRIVER_STUFFUP
expr_stmt|;
name|splx
argument_list|(
name|flags
argument_list|)
expr_stmt|;
return|return
operator|(
name|HAD_ERROR
operator|)
return|;
block|}
block|}
else|else
name|pSRB
operator|->
name|SGcount
operator|=
literal|0
expr_stmt|;
name|pSRB
operator|->
name|SGIndex
operator|=
literal|0
expr_stmt|;
name|pSRB
operator|->
name|AdaptStatus
operator|=
literal|0
expr_stmt|;
name|pSRB
operator|->
name|TargetStatus
operator|=
literal|0
expr_stmt|;
name|pSRB
operator|->
name|MsgCnt
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|pDCB
operator|->
name|DevType
operator|!=
name|SCSI_SEQACESS
condition|)
name|pSRB
operator|->
name|RetryCnt
operator|=
literal|1
expr_stmt|;
else|else
name|pSRB
operator|->
name|RetryCnt
operator|=
literal|0
expr_stmt|;
name|pSRB
operator|->
name|SRBStatus
operator|=
literal|0
expr_stmt|;
name|pSRB
operator|->
name|SRBFlag
operator|=
literal|0
expr_stmt|;
name|pSRB
operator|->
name|SRBState
operator|=
literal|0
expr_stmt|;
name|pSRB
operator|->
name|TotalXferredLen
operator|=
literal|0
expr_stmt|;
name|pSRB
operator|->
name|SGPhysAddr
operator|=
literal|0
expr_stmt|;
name|pSRB
operator|->
name|SGToBeXferLen
operator|=
literal|0
expr_stmt|;
name|pSRB
operator|->
name|ScsiPhase
operator|=
literal|0
expr_stmt|;
name|pSRB
operator|->
name|EndMessage
operator|=
literal|0
expr_stmt|;
name|splx
argument_list|(
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|cflags
operator|&
name|SCSI_NOMASK
operator|)
condition|)
block|{
name|flags
operator|=
name|splbio
argument_list|()
expr_stmt|;
name|SendSRB
argument_list|(
name|pcmd
argument_list|,
name|pACB
argument_list|,
name|pSRB
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|flags
argument_list|)
expr_stmt|;
return|return
operator|(
name|SUCCESSFULLY_QUEUED
operator|)
return|;
block|}
else|else
block|{
name|SendSRB
argument_list|(
name|pcmd
argument_list|,
name|pACB
argument_list|,
name|pSRB
argument_list|)
expr_stmt|;
do|do
block|{
while|while
condition|(
operator|--
name|pcmd
operator|->
name|timeout
condition|)
block|{
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
name|sstatus
operator|=
name|inb
argument_list|(
name|ioport
operator|+
name|Scsi_Status
argument_list|)
expr_stmt|;
if|if
condition|(
name|sstatus
operator|&
name|INTERRUPT
condition|)
break|break;
block|}
if|if
condition|(
name|pcmd
operator|->
name|timeout
operator|==
literal|0
condition|)
block|{
return|return
operator|(
name|HAD_ERROR
operator|)
return|;
block|}
else|else
block|{
name|DC390_Interrupt
argument_list|(
name|pACB
argument_list|)
expr_stmt|;
block|}
block|}
do|while
condition|(
operator|!
operator|(
name|pcmd
operator|->
name|flags
operator|&
name|ITSDONE
operator|)
condition|)
do|;
if|if
condition|(
name|pcmd
operator|->
name|error
operator|==
name|XS_TIMEOUT
condition|)
return|return
operator|(
name|HAD_ERROR
operator|)
return|;
else|else
return|return
operator|(
name|COMPLETE
operator|)
return|;
block|}
block|}
end_function

begin_function
name|void
name|trmamd_min_phys
parameter_list|(
name|struct
name|buf
modifier|*
name|bp
parameter_list|)
block|{
if|if
condition|(
name|bp
operator|->
name|b_bcount
operator|>
operator|(
operator|(
name|MAX_SG_ENTRY
operator|-
literal|1
operator|)
operator|*
name|PAGELEN
operator|)
condition|)
name|bp
operator|->
name|b_bcount
operator|=
operator|(
operator|(
name|MAX_SG_ENTRY
operator|-
literal|1
operator|)
operator|*
name|PAGELEN
operator|)
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|REL_2_1_0
end_ifdef

begin_function
name|u_int32
name|trmamd_info
parameter_list|(
name|int
name|unit
parameter_list|)
block|{
return|return
operator|(
name|MAX_CMD_PER_LUN
operator|)
return|;
comment|/* outstanding requests at a time per device */
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|PUCHAR
name|phystovirt
parameter_list|(
name|PSRB
name|pSRB
parameter_list|,
name|ULONG
name|xferCnt
parameter_list|)
block|{
name|int
name|dataPtr
decl_stmt|;
name|PSCSICMD
name|pcmd
decl_stmt|;
name|UCHAR
name|i
decl_stmt|;
name|PSEG
name|pseg
decl_stmt|;
name|pcmd
operator|=
name|pSRB
operator|->
name|pcmd
expr_stmt|;
name|dataPtr
operator|=
operator|(
name|int
operator|)
name|pcmd
operator|->
name|data
expr_stmt|;
name|pseg
operator|=
name|pSRB
operator|->
name|SGsegment
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pSRB
operator|->
name|SGIndex
condition|;
name|i
operator|++
control|)
block|{
name|dataPtr
operator|+=
operator|(
name|int
operator|)
name|pseg
operator|->
name|SGXLen
expr_stmt|;
name|pseg
operator|++
expr_stmt|;
block|}
name|dataPtr
operator|+=
operator|(
name|int
operator|)
name|xferCnt
expr_stmt|;
return|return
operator|(
operator|(
name|PUCHAR
operator|)
name|dataPtr
operator|)
return|;
block|}
end_function

begin_comment
comment|/***********************************************************************  * Function : int DC390_abort (SCSICMD *cmd)  *  * Purpose : Abort an errant SCSI command  *  * Inputs : cmd - command to abort  *  * Returns : 0 on success, -1 on failure.  ***********************************************************************/
end_comment

begin_comment
comment|/* int DC390_abort (SCSICMD *cmd) {     int   flags;     PACB  pACB;     PDCB  pDCB, pdcb;     PSRB  pSRB, psrb;     USHORT count, i;     PSCSICMD  pcmd, pcmd1;     int   status;   #ifdef DC390_DEBUG0     printf("DC390 : Abort Cmd."); #endif      flags = splbio();      pACB = (PACB) cmd->host->hostdata;     pDCB = pACB->pLinkDCB;     pdcb = pDCB;     while( (pDCB->UnitSCSIID != cmd->sc_link->target) || 	   (pDCB->UnitSCSILUN != cmd->sc_link->lun) )     { 	pDCB = pDCB->pNextDCB; 	if( pDCB == pdcb ) 	    goto  NOT_RUN;     }       pSRB = pDCB->pWaitingSRB;     if( !pSRB ) 	goto  ON_GOING;     if( pSRB->pcmd == cmd )     { 	pDCB->pWaitingSRB = pSRB->pNextSRB; 	goto  IN_WAIT;     }     else     { 	psrb = pSRB; 	while( psrb->pNextSRB->pcmd != cmd ) 	{ 	    psrb = psrb->pNextSRB; 	    if( !psrb ) 		goto ON_GOING; 	} 	pSRB = psrb->pNextSRB; 	psrb->pNextSRB = pSRB->pNextSRB; 	if( pSRB == pDCB->pWaitLast ) 	    pDCB->pWaitLast = psrb; IN_WAIT: 	pSRB->pNextSRB = pACB->pFreeSRB; 	pACB->pFreeSRB = pSRB; 	cmd->next = NULL; 	status = SCSI_ABORT_SUCCESS; 	goto  ABO_X;     }  ON_GOING:     pSRB = pDCB->pGoingSRB;     for( count = pDCB->GoingSRBCnt, i=0; i<count; i++)     { 	if( pSRB->pcmd != cmd ) 	    pSRB = pSRB->pNextSRB; 	else 	{ 	    if( (pACB->pActiveDCB == pDCB)&& (pDCB->pActiveSRB == pSRB) ) 	    { 		status = SCSI_ABORT_BUSY; 		goto  ABO_X; 	    } 	    else 	    { 		status = SCSI_ABORT_SNOOZE; 		goto  ABO_X; 	    } 	}     }  NOT_RUN:     status = SCSI_ABORT_NOT_RUNNING;  ABO_X:     cmd->error = XS_NOERROR;     scsi_done(cmd);     splx(flags);     return( status ); } */
end_comment

begin_function
specifier|static
name|void
name|ResetDevParam
parameter_list|(
name|PACB
name|pACB
parameter_list|)
block|{
name|PDCB
name|pDCB
decl_stmt|,
name|pdcb
decl_stmt|;
name|pDCB
operator|=
name|pACB
operator|->
name|pLinkDCB
expr_stmt|;
if|if
condition|(
name|pDCB
operator|==
name|NULL
condition|)
return|return;
name|pdcb
operator|=
name|pDCB
expr_stmt|;
do|do
block|{
name|pDCB
operator|->
name|SyncMode
operator|&=
operator|~
name|SYNC_NEGO_DONE
expr_stmt|;
name|pDCB
operator|->
name|SyncPeriod
operator|=
literal|0
expr_stmt|;
name|pDCB
operator|->
name|SyncOffset
operator|=
literal|0
expr_stmt|;
name|pDCB
operator|->
name|CtrlR3
operator|=
name|FAST_CLK
expr_stmt|;
name|pDCB
operator|->
name|CtrlR4
operator|&=
name|NEGATE_REQACKDATA
expr_stmt|;
name|pDCB
operator|->
name|CtrlR4
operator||=
name|EATER_25NS
expr_stmt|;
name|pDCB
operator|=
name|pDCB
operator|->
name|pNextDCB
expr_stmt|;
block|}
do|while
condition|(
name|pdcb
operator|!=
name|pDCB
condition|)
do|;
block|}
end_function

begin_function
specifier|static
name|void
name|RecoverSRB
parameter_list|(
name|PACB
name|pACB
parameter_list|)
block|{
name|PDCB
name|pDCB
decl_stmt|,
name|pdcb
decl_stmt|;
name|PSRB
name|psrb
decl_stmt|,
name|psrb2
decl_stmt|;
name|USHORT
name|cnt
decl_stmt|,
name|i
decl_stmt|;
name|pDCB
operator|=
name|pACB
operator|->
name|pLinkDCB
expr_stmt|;
if|if
condition|(
name|pDCB
operator|==
name|NULL
condition|)
return|return;
name|pdcb
operator|=
name|pDCB
expr_stmt|;
do|do
block|{
name|cnt
operator|=
name|pdcb
operator|->
name|GoingSRBCnt
expr_stmt|;
name|psrb
operator|=
name|pdcb
operator|->
name|pGoingSRB
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cnt
condition|;
name|i
operator|++
control|)
block|{
name|psrb2
operator|=
name|psrb
expr_stmt|;
name|psrb
operator|=
name|psrb
operator|->
name|pNextSRB
expr_stmt|;
comment|/*	    RewaitSRB( pDCB, psrb ); */
if|if
condition|(
name|pdcb
operator|->
name|pWaitingSRB
condition|)
block|{
name|psrb2
operator|->
name|pNextSRB
operator|=
name|pdcb
operator|->
name|pWaitingSRB
expr_stmt|;
name|pdcb
operator|->
name|pWaitingSRB
operator|=
name|psrb2
expr_stmt|;
block|}
else|else
block|{
name|pdcb
operator|->
name|pWaitingSRB
operator|=
name|psrb2
expr_stmt|;
name|pdcb
operator|->
name|pWaitLast
operator|=
name|psrb2
expr_stmt|;
name|psrb2
operator|->
name|pNextSRB
operator|=
name|NULL
expr_stmt|;
block|}
block|}
name|pdcb
operator|->
name|GoingSRBCnt
operator|=
literal|0
expr_stmt|;
name|pdcb
operator|->
name|pGoingSRB
operator|=
name|NULL
expr_stmt|;
name|pdcb
operator|->
name|TagMask
operator|=
literal|0
expr_stmt|;
name|pdcb
operator|=
name|pdcb
operator|->
name|pNextDCB
expr_stmt|;
block|}
do|while
condition|(
name|pdcb
operator|!=
name|pDCB
condition|)
do|;
block|}
end_function

begin_comment
comment|/***********************************************************************  * Function : DC390_reset (PACB pACB)  *  * Purpose : perform a hard reset on the SCSI bus( and AMD chip).  *  * Inputs : cmd - command which caused the SCSI RESET  *  ***********************************************************************/
end_comment

begin_function
specifier|static
name|void
name|DC390_reset
parameter_list|(
name|PACB
name|pACB
parameter_list|)
block|{
name|USHORT
name|ioport
decl_stmt|;
name|int
name|flags
decl_stmt|;
name|UCHAR
name|bval
decl_stmt|;
name|USHORT
name|i
decl_stmt|;
ifdef|#
directive|ifdef
name|DC390_DEBUG0
name|printf
argument_list|(
literal|"DC390: RESET,"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|flags
operator|=
name|splbio
argument_list|()
expr_stmt|;
name|ioport
operator|=
name|pACB
operator|->
name|IOPortBase
expr_stmt|;
name|bval
operator|=
name|inb
argument_list|(
name|ioport
operator|+
name|CtrlReg1
argument_list|)
expr_stmt|;
name|bval
operator||=
name|DIS_INT_ON_SCSI_RST
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|CtrlReg1
argument_list|)
expr_stmt|;
comment|/* disable interrupt */
name|DC390_ResetSCSIBus
argument_list|(
name|pACB
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|500
condition|;
name|i
operator|++
control|)
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
name|bval
operator|=
name|inb
argument_list|(
name|ioport
operator|+
name|CtrlReg1
argument_list|)
expr_stmt|;
name|bval
operator|&=
operator|~
name|DIS_INT_ON_SCSI_RST
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|CtrlReg1
argument_list|)
expr_stmt|;
comment|/* re-enable interrupt */
name|bval
operator|=
name|DMA_IDLE_CMD
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|DMA_Cmd
argument_list|)
expr_stmt|;
name|bval
operator|=
name|CLEAR_FIFO_CMD
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|ScsiCmd
argument_list|)
expr_stmt|;
name|ResetDevParam
argument_list|(
name|pACB
argument_list|)
expr_stmt|;
name|DoingSRB_Done
argument_list|(
name|pACB
argument_list|)
expr_stmt|;
name|pACB
operator|->
name|pActiveDCB
operator|=
name|NULL
expr_stmt|;
name|pACB
operator|->
name|ACBFlag
operator|=
literal|0
expr_stmt|;
name|DoWaitingSRB
argument_list|(
name|pACB
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|flags
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|void
name|DC390_timeout
parameter_list|(
name|void
modifier|*
name|arg1
parameter_list|)
block|{
name|PSRB
name|pSRB
decl_stmt|;
name|pSRB
operator|=
operator|(
name|PSRB
operator|)
name|arg1
expr_stmt|;
block|}
end_function

begin_include
include|#
directive|include
file|<pci/scsiiom.c>
end_include

begin_comment
comment|/***********************************************************************  * Function : static void DC390_initDCB  *  * Purpose :  initialize the internal structures for a given DCB  *  * Inputs : cmd - pointer to this scsi cmd request block structure  *  ***********************************************************************/
end_comment

begin_function
name|void
name|DC390_initDCB
parameter_list|(
name|PACB
name|pACB
parameter_list|,
name|PDCB
name|pDCB
parameter_list|,
name|PSCSICMD
name|cmd
parameter_list|)
block|{
name|PEEprom
name|prom
decl_stmt|;
name|UCHAR
name|bval
decl_stmt|;
name|USHORT
name|index
decl_stmt|;
name|PSCLINK
name|plink
decl_stmt|;
if|if
condition|(
name|pACB
operator|->
name|DeviceCnt
operator|==
literal|0
condition|)
block|{
name|pACB
operator|->
name|pLinkDCB
operator|=
name|pDCB
expr_stmt|;
name|pACB
operator|->
name|pDCBRunRobin
operator|=
name|pDCB
expr_stmt|;
name|pDCB
operator|->
name|pNextDCB
operator|=
name|pDCB
expr_stmt|;
name|pPrevDCB
operator|=
name|pDCB
expr_stmt|;
block|}
else|else
name|pPrevDCB
operator|->
name|pNextDCB
operator|=
name|pDCB
expr_stmt|;
name|plink
operator|=
name|cmd
operator|->
name|sc_link
expr_stmt|;
name|pDCB
operator|->
name|pDCBACB
operator|=
name|pACB
expr_stmt|;
name|pDCB
operator|->
name|UnitSCSIID
operator|=
name|plink
operator|->
name|target
expr_stmt|;
name|pDCB
operator|->
name|UnitSCSILUN
operator|=
name|plink
operator|->
name|lun
expr_stmt|;
name|pDCB
operator|->
name|pWaitingSRB
operator|=
name|NULL
expr_stmt|;
name|pDCB
operator|->
name|pGoingSRB
operator|=
name|NULL
expr_stmt|;
name|pDCB
operator|->
name|GoingSRBCnt
operator|=
literal|0
expr_stmt|;
name|pDCB
operator|->
name|pActiveSRB
operator|=
name|NULL
expr_stmt|;
name|pDCB
operator|->
name|TagMask
operator|=
literal|0
expr_stmt|;
name|pDCB
operator|->
name|MaxCommand
operator|=
literal|1
expr_stmt|;
name|pDCB
operator|->
name|AdaptIndex
operator|=
name|pACB
operator|->
name|AdapterIndex
expr_stmt|;
name|index
operator|=
name|pACB
operator|->
name|AdapterIndex
expr_stmt|;
name|pDCB
operator|->
name|DCBFlag
operator|=
literal|0
expr_stmt|;
name|prom
operator|=
operator|(
name|PEEprom
operator|)
operator|&
name|eepromBuf
index|[
name|index
index|]
index|[
name|plink
operator|->
name|target
operator|<<
literal|2
index|]
expr_stmt|;
name|pDCB
operator|->
name|DevMode
operator|=
name|prom
operator|->
name|EE_MODE1
expr_stmt|;
name|pDCB
operator|->
name|AdpMode
operator|=
name|eepromBuf
index|[
name|index
index|]
index|[
name|EE_MODE2
index|]
expr_stmt|;
if|if
condition|(
name|pDCB
operator|->
name|DevMode
operator|&
name|EN_DISCONNECT_
condition|)
name|bval
operator|=
literal|0xC0
expr_stmt|;
else|else
name|bval
operator|=
literal|0x80
expr_stmt|;
name|bval
operator||=
name|plink
operator|->
name|lun
expr_stmt|;
name|pDCB
operator|->
name|IdentifyMsg
operator|=
name|bval
expr_stmt|;
name|pDCB
operator|->
name|SyncMode
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|pDCB
operator|->
name|DevMode
operator|&
name|SYNC_NEGO_
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|plink
operator|->
name|lun
operator|)
operator|||
name|CurrSyncOffset
condition|)
name|pDCB
operator|->
name|SyncMode
operator|=
name|SYNC_ENABLE
expr_stmt|;
block|}
name|pDCB
operator|->
name|SyncPeriod
operator|=
literal|0
expr_stmt|;
name|pDCB
operator|->
name|SyncOffset
operator|=
literal|0
expr_stmt|;
name|pDCB
operator|->
name|NegoPeriod
operator|=
operator|(
name|clock_period1
index|[
name|prom
operator|->
name|EE_SPEED
index|]
operator|*
literal|25
operator|)
operator|>>
literal|2
expr_stmt|;
name|pDCB
operator|->
name|CtrlR1
operator|=
name|pACB
operator|->
name|AdaptSCSIID
expr_stmt|;
if|if
condition|(
name|pDCB
operator|->
name|DevMode
operator|&
name|PARITY_CHK_
condition|)
name|pDCB
operator|->
name|CtrlR1
operator||=
name|PARITY_ERR_REPO
expr_stmt|;
name|pDCB
operator|->
name|CtrlR3
operator|=
name|FAST_CLK
expr_stmt|;
name|pDCB
operator|->
name|CtrlR4
operator|=
name|EATER_25NS
expr_stmt|;
if|if
condition|(
name|pDCB
operator|->
name|AdpMode
operator|&
name|ACTIVE_NEGATION
condition|)
name|pDCB
operator|->
name|CtrlR4
operator||=
name|NEGATE_REQACKDATA
expr_stmt|;
block|}
end_function

begin_comment
comment|/***********************************************************************  * Function : static void DC390_initSRB  *  * Purpose :  initialize the internal structures for a given SRB  *  * Inputs : psrb - pointer to this scsi request block structure  *  ***********************************************************************/
end_comment

begin_function
name|void
name|DC390_initSRB
parameter_list|(
name|PSRB
name|psrb
parameter_list|)
block|{
name|psrb
operator|->
name|PhysSRB
operator|=
name|vtophys
argument_list|(
name|psrb
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|DC390_linkSRB
parameter_list|(
name|PACB
name|pACB
parameter_list|)
block|{
name|USHORT
name|count
decl_stmt|,
name|i
decl_stmt|;
name|PSRB
name|psrb
decl_stmt|;
name|count
operator|=
name|pACB
operator|->
name|SRBCount
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|!=
name|count
operator|-
literal|1
condition|)
name|pACB
operator|->
name|SRB_array
index|[
name|i
index|]
operator|.
name|pNextSRB
operator|=
operator|&
name|pACB
operator|->
name|SRB_array
index|[
name|i
operator|+
literal|1
index|]
expr_stmt|;
else|else
name|pACB
operator|->
name|SRB_array
index|[
name|i
index|]
operator|.
name|pNextSRB
operator|=
name|NULL
expr_stmt|;
name|psrb
operator|=
operator|(
name|PSRB
operator|)
operator|&
name|pACB
operator|->
name|SRB_array
index|[
name|i
index|]
expr_stmt|;
name|DC390_initSRB
argument_list|(
name|psrb
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/***********************************************************************  * Function : static void DC390_initACB  *  * Purpose :  initialize the internal structures for a given SCSI host  *  * Inputs : psh - pointer to this host adapter's structure  *  ***********************************************************************/
end_comment

begin_function
name|void
name|DC390_initACB
parameter_list|(
name|PACB
name|pACB
parameter_list|,
name|ULONG
name|io_port
parameter_list|,
name|UCHAR
name|Irq
parameter_list|,
name|USHORT
name|index
parameter_list|)
block|{
name|USHORT
name|i
decl_stmt|;
name|pACB
operator|->
name|max_id
operator|=
literal|7
expr_stmt|;
if|if
condition|(
name|pACB
operator|->
name|max_id
operator|==
name|eepromBuf
index|[
name|index
index|]
index|[
name|EE_ADAPT_SCSI_ID
index|]
condition|)
name|pACB
operator|->
name|max_id
operator|--
expr_stmt|;
if|if
condition|(
name|eepromBuf
index|[
name|index
index|]
index|[
name|EE_MODE2
index|]
operator|&
name|LUN_CHECK
condition|)
name|pACB
operator|->
name|max_lun
operator|=
literal|7
expr_stmt|;
else|else
name|pACB
operator|->
name|max_lun
operator|=
literal|0
expr_stmt|;
name|pACB
operator|->
name|IOPortBase
operator|=
operator|(
name|USHORT
operator|)
name|io_port
expr_stmt|;
name|pACB
operator|->
name|pLinkDCB
operator|=
name|NULL
expr_stmt|;
name|pACB
operator|->
name|pDCBRunRobin
operator|=
name|NULL
expr_stmt|;
name|pACB
operator|->
name|pActiveDCB
operator|=
name|NULL
expr_stmt|;
name|pACB
operator|->
name|pFreeSRB
operator|=
name|pACB
operator|->
name|SRB_array
expr_stmt|;
name|pACB
operator|->
name|SRBCount
operator|=
name|MAX_SRB_CNT
expr_stmt|;
name|pACB
operator|->
name|AdapterIndex
operator|=
name|index
expr_stmt|;
name|pACB
operator|->
name|status
operator|=
literal|0
expr_stmt|;
name|pACB
operator|->
name|AdaptSCSIID
operator|=
name|eepromBuf
index|[
name|index
index|]
index|[
name|EE_ADAPT_SCSI_ID
index|]
expr_stmt|;
name|pACB
operator|->
name|HostID_Bit
operator|=
operator|(
literal|1
operator|<<
name|pACB
operator|->
name|AdaptSCSIID
operator|)
expr_stmt|;
name|pACB
operator|->
name|AdaptSCSILUN
operator|=
literal|0
expr_stmt|;
name|pACB
operator|->
name|DeviceCnt
operator|=
literal|0
expr_stmt|;
name|pACB
operator|->
name|IRQLevel
operator|=
name|Irq
expr_stmt|;
name|pACB
operator|->
name|TagMaxNum
operator|=
operator|(
name|eepromBuf
index|[
name|index
index|]
index|[
name|EE_TAG_CMD_NUM
index|]
operator|)
operator|<<
literal|2
expr_stmt|;
name|pACB
operator|->
name|ACBFlag
operator|=
literal|0
expr_stmt|;
name|pACB
operator|->
name|scan_devices
operator|=
literal|1
expr_stmt|;
name|pACB
operator|->
name|Gmode2
operator|=
name|eepromBuf
index|[
name|index
index|]
index|[
name|EE_MODE2
index|]
expr_stmt|;
if|if
condition|(
name|eepromBuf
index|[
name|index
index|]
index|[
name|EE_MODE2
index|]
operator|&
name|LUN_CHECK
condition|)
name|pACB
operator|->
name|LUNchk
operator|=
literal|1
expr_stmt|;
name|pACB
operator|->
name|pDCB_free
operator|=
operator|&
name|pACB
operator|->
name|DCB_array
index|[
literal|0
index|]
expr_stmt|;
name|DC390_linkSRB
argument_list|(
name|pACB
argument_list|)
expr_stmt|;
name|pACB
operator|->
name|pTmpSRB
operator|=
operator|&
name|pACB
operator|->
name|TmpSRB
expr_stmt|;
name|DC390_initSRB
argument_list|(
name|pACB
operator|->
name|pTmpSRB
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_SCSI_ID
condition|;
name|i
operator|++
control|)
name|pACB
operator|->
name|DCBmap
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|pACB
operator|->
name|ScsiLink
operator|.
name|adapter_unit
operator|=
name|index
expr_stmt|;
name|pACB
operator|->
name|ScsiLink
operator|.
name|adapter_targ
operator|=
name|pACB
operator|->
name|AdaptSCSIID
expr_stmt|;
name|pACB
operator|->
name|ScsiLink
operator|.
name|fordriver
operator|=
literal|0
expr_stmt|;
name|pACB
operator|->
name|ScsiLink
operator|.
name|opennings
operator|=
literal|2
expr_stmt|;
name|pACB
operator|->
name|ScsiLink
operator|.
name|adapter
operator|=
operator|&
name|trmamd_switch
expr_stmt|;
name|pACB
operator|->
name|ScsiLink
operator|.
name|device
operator|=
operator|&
name|trmamd_dev
expr_stmt|;
name|pACB
operator|->
name|ScsiLink
operator|.
name|flags
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_comment
comment|/***********************************************************************  * Function : static int DC390_initAdapter  *  * Purpose :  initialize the SCSI chip ctrl registers  *  * Inputs : psh - pointer to this host adapter's structure  *  ***********************************************************************/
end_comment

begin_function
name|int
name|DC390_initAdapter
parameter_list|(
name|PACB
name|pACB
parameter_list|,
name|ULONG
name|io_port
parameter_list|,
name|UCHAR
name|Irq
parameter_list|,
name|USHORT
name|index
parameter_list|,
name|pcici_t
name|config_id
parameter_list|)
block|{
name|USHORT
name|ioport
decl_stmt|;
name|UCHAR
name|bval
decl_stmt|;
ifdef|#
directive|ifdef
name|CHECK_SHARE_INT
name|PACB
name|pacb
decl_stmt|;
name|USHORT
name|used_irq
init|=
literal|0
decl_stmt|;
name|pacb
operator|=
name|pACB_start
expr_stmt|;
if|if
condition|(
name|pacb
operator|!=
name|NULL
condition|)
block|{
for|for
control|(
init|;
operator|(
name|pacb
operator|!=
operator|(
name|PACB
operator|)
operator|-
literal|1
operator|)
condition|;
control|)
block|{
if|if
condition|(
name|pacb
operator|->
name|IRQLevel
operator|==
name|Irq
condition|)
block|{
name|used_irq
operator|=
literal|1
expr_stmt|;
break|break;
block|}
else|else
name|pacb
operator|=
name|pacb
operator|->
name|pNextACB
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|used_irq
condition|)
block|{
endif|#
directive|endif
if|if
condition|(
operator|!
name|pci_map_int
argument_list|(
name|config_id
argument_list|,
operator|(
name|PVOID
operator|)
name|DC390_Interrupt
argument_list|,
name|pACB
argument_list|,
operator|&
name|bio_imask
argument_list|)
condition|)
block|{
if|if
condition|(
name|bootverbose
condition|)
name|printf
argument_list|(
literal|"DC390: register Interrupt handler error!\n"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
ifdef|#
directive|ifdef
name|CHECK_SHARE_INT
block|}
endif|#
directive|endif
name|ioport
operator|=
operator|(
name|USHORT
operator|)
name|io_port
expr_stmt|;
name|bval
operator|=
literal|153
expr_stmt|;
comment|/* 250ms selection timeout */
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|Scsi_TimeOut
argument_list|)
expr_stmt|;
name|bval
operator|=
name|CLK_FREQ_40MHZ
expr_stmt|;
comment|/* Conversion factor = 0 , 40MHz clock */
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|Clk_Factor
argument_list|)
expr_stmt|;
name|bval
operator|=
name|NOP_CMD
expr_stmt|;
comment|/* NOP cmd - clear command register */
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|ScsiCmd
argument_list|)
expr_stmt|;
name|bval
operator|=
name|EN_FEATURE
operator|+
name|EN_SCSI2_CMD
expr_stmt|;
comment|/* Enable Feature and SCSI-2 */
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|CtrlReg2
argument_list|)
expr_stmt|;
name|bval
operator|=
name|FAST_CLK
expr_stmt|;
comment|/* fast clock */
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|CtrlReg3
argument_list|)
expr_stmt|;
name|bval
operator|=
name|EATER_25NS
expr_stmt|;
if|if
condition|(
name|eepromBuf
index|[
name|index
index|]
index|[
name|EE_MODE2
index|]
operator|&
name|ACTIVE_NEGATION
condition|)
name|bval
operator||=
name|NEGATE_REQACKDATA
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|CtrlReg4
argument_list|)
expr_stmt|;
name|bval
operator|=
name|DIS_INT_ON_SCSI_RST
expr_stmt|;
comment|/* Disable SCSI bus reset interrupt */
name|OutB
argument_list|(
name|bval
argument_list|,
name|ioport
operator|+
name|CtrlReg1
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|PCI_COMPAT
end_ifdef

begin_decl_stmt
specifier|static
name|pcicfgregs
modifier|*
name|cfg
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|DC390_EnableCfg
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
end_define

begin_define
define|#
directive|define
name|DC390_DisableCfg
parameter_list|(
name|a
parameter_list|)
end_define

begin_define
define|#
directive|define
name|DC390_inByte
parameter_list|(
name|a
parameter_list|,
name|reg
parameter_list|)
value|pci_cfgread(cfg,reg,1)
end_define

begin_define
define|#
directive|define
name|DC390_inWord
parameter_list|(
name|a
parameter_list|,
name|reg
parameter_list|)
value|pci_cfgread(cfg,reg,2)
end_define

begin_define
define|#
directive|define
name|DC390_inDword
parameter_list|(
name|a
parameter_list|,
name|reg
parameter_list|)
value|pci_cfgread(cfg,reg,4)
end_define

begin_define
define|#
directive|define
name|DC390_OutB
parameter_list|(
name|a
parameter_list|,
name|reg
parameter_list|,
name|val
parameter_list|)
value|pci_cfgwrite(cfg,reg,val,1)
end_define

begin_else
else|#
directive|else
end_else

begin_function
name|void
name|DC390_EnableCfg
parameter_list|(
name|USHORT
name|mechnum
parameter_list|,
name|UCHAR
name|regval
parameter_list|)
block|{
name|ULONG
name|wlval
decl_stmt|;
if|if
condition|(
name|mechnum
operator|==
literal|2
condition|)
block|{
name|OutB
argument_list|(
name|mech2bus
argument_list|,
name|PCI_CFG2_FORWARD_REG
argument_list|)
expr_stmt|;
name|OutB
argument_list|(
name|mech2CfgSPenR
argument_list|,
name|PCI_CFG2_ENABLE_REG
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|regval
operator|&=
literal|0xFC
expr_stmt|;
name|wlval
operator|=
name|mech1addr
expr_stmt|;
name|wlval
operator||=
operator|(
operator|(
operator|(
name|ULONG
operator|)
name|regval
operator|)
operator|&
literal|0xff
operator|)
expr_stmt|;
name|OutL
argument_list|(
name|wlval
argument_list|,
name|PCI_CFG1_ADDRESS_REG
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|DC390_DisableCfg
parameter_list|(
name|USHORT
name|mechnum
parameter_list|)
block|{
if|if
condition|(
name|mechnum
operator|==
literal|2
condition|)
name|OutB
argument_list|(
literal|0
argument_list|,
name|PCI_CFG2_ENABLE_REG
argument_list|)
expr_stmt|;
else|else
name|OutL
argument_list|(
literal|0
argument_list|,
name|PCI_CFG1_ADDRESS_REG
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|UCHAR
name|DC390_inByte
parameter_list|(
name|USHORT
name|mechnum
parameter_list|,
name|UCHAR
name|regval
parameter_list|)
block|{
name|UCHAR
name|bval
decl_stmt|;
name|USHORT
name|wval
decl_stmt|;
name|int
name|flags
decl_stmt|;
name|flags
operator|=
name|splbio
argument_list|()
expr_stmt|;
name|DC390_EnableCfg
argument_list|(
name|mechnum
argument_list|,
name|regval
argument_list|)
expr_stmt|;
if|if
condition|(
name|mechnum
operator|==
literal|2
condition|)
block|{
name|wval
operator|=
name|mech2Agent
expr_stmt|;
name|wval
operator|<<=
literal|8
expr_stmt|;
name|wval
operator||=
operator|(
operator|(
name|USHORT
operator|)
name|regval
operator|)
operator|&
literal|0xff
expr_stmt|;
name|bval
operator|=
name|inb
argument_list|(
name|wval
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|regval
operator|&=
literal|3
expr_stmt|;
name|bval
operator|=
name|inb
argument_list|(
name|PCI_CFG1_DATA_REG
operator||
name|regval
argument_list|)
expr_stmt|;
block|}
name|DC390_DisableCfg
argument_list|(
name|mechnum
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|flags
argument_list|)
expr_stmt|;
return|return
operator|(
name|bval
operator|)
return|;
block|}
end_function

begin_function
name|USHORT
name|DC390_inWord
parameter_list|(
name|USHORT
name|mechnum
parameter_list|,
name|UCHAR
name|regval
parameter_list|)
block|{
name|USHORT
name|wval
decl_stmt|;
name|int
name|flags
decl_stmt|;
name|flags
operator|=
name|splbio
argument_list|()
expr_stmt|;
name|DC390_EnableCfg
argument_list|(
name|mechnum
argument_list|,
name|regval
argument_list|)
expr_stmt|;
if|if
condition|(
name|mechnum
operator|==
literal|2
condition|)
block|{
name|wval
operator|=
name|mech2Agent
expr_stmt|;
name|wval
operator|<<=
literal|8
expr_stmt|;
name|wval
operator||=
name|regval
expr_stmt|;
name|wval
operator|=
name|inw
argument_list|(
name|wval
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|regval
operator|&=
literal|3
expr_stmt|;
name|wval
operator|=
name|inw
argument_list|(
name|PCI_CFG1_DATA_REG
operator||
name|regval
argument_list|)
expr_stmt|;
block|}
name|DC390_DisableCfg
argument_list|(
name|mechnum
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|flags
argument_list|)
expr_stmt|;
return|return
operator|(
name|wval
operator|)
return|;
block|}
end_function

begin_function
name|ULONG
name|DC390_inDword
parameter_list|(
name|USHORT
name|mechnum
parameter_list|,
name|UCHAR
name|regval
parameter_list|)
block|{
name|ULONG
name|wlval
decl_stmt|;
name|int
name|flags
decl_stmt|;
name|USHORT
name|wval
decl_stmt|;
name|flags
operator|=
name|splbio
argument_list|()
expr_stmt|;
name|DC390_EnableCfg
argument_list|(
name|mechnum
argument_list|,
name|regval
argument_list|)
expr_stmt|;
if|if
condition|(
name|mechnum
operator|==
literal|2
condition|)
block|{
name|wval
operator|=
name|mech2Agent
expr_stmt|;
name|wval
operator|<<=
literal|8
expr_stmt|;
name|wval
operator||=
name|regval
expr_stmt|;
name|wlval
operator|=
name|inl
argument_list|(
name|wval
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wlval
operator|=
name|inl
argument_list|(
name|PCI_CFG1_DATA_REG
argument_list|)
expr_stmt|;
block|}
name|DC390_DisableCfg
argument_list|(
name|mechnum
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|flags
argument_list|)
expr_stmt|;
return|return
operator|(
name|wlval
operator|)
return|;
block|}
end_function

begin_function
name|void
name|DC390_OutB
parameter_list|(
name|USHORT
name|mechnum
parameter_list|,
name|UCHAR
name|regval
parameter_list|,
name|UCHAR
name|bval
parameter_list|)
block|{
name|USHORT
name|wval
decl_stmt|;
name|int
name|flags
decl_stmt|;
name|flags
operator|=
name|splbio
argument_list|()
expr_stmt|;
name|DC390_EnableCfg
argument_list|(
name|mechnum
argument_list|,
name|regval
argument_list|)
expr_stmt|;
if|if
condition|(
name|mechnum
operator|==
literal|2
condition|)
block|{
name|wval
operator|=
name|mech2Agent
expr_stmt|;
name|wval
operator|<<=
literal|8
expr_stmt|;
name|wval
operator||=
name|regval
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|wval
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|regval
operator|&=
literal|3
expr_stmt|;
name|OutB
argument_list|(
name|bval
argument_list|,
name|PCI_CFG1_DATA_REG
operator||
name|regval
argument_list|)
expr_stmt|;
block|}
name|DC390_DisableCfg
argument_list|(
name|mechnum
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|flags
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
endif|/PCI_COMPAT */
end_endif

begin_function
name|void
name|DC390_EnDisableCE
parameter_list|(
name|UCHAR
name|mode
parameter_list|,
name|USHORT
name|mechnum
parameter_list|,
name|PUCHAR
name|regval
parameter_list|)
block|{
name|UCHAR
name|bval
decl_stmt|;
name|bval
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|mode
operator|==
name|ENABLE_CE
condition|)
operator|*
name|regval
operator|=
literal|0xc0
expr_stmt|;
else|else
operator|*
name|regval
operator|=
literal|0x80
expr_stmt|;
name|DC390_OutB
argument_list|(
name|mechnum
argument_list|,
operator|*
name|regval
argument_list|,
name|bval
argument_list|)
expr_stmt|;
if|if
condition|(
name|mode
operator|==
name|DISABLE_CE
condition|)
name|DC390_OutB
argument_list|(
name|mechnum
argument_list|,
operator|*
name|regval
argument_list|,
name|bval
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|160
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|DC390_EEpromOutDI
parameter_list|(
name|USHORT
name|mechnum
parameter_list|,
name|PUCHAR
name|regval
parameter_list|,
name|USHORT
name|Carry
parameter_list|)
block|{
name|UCHAR
name|bval
decl_stmt|;
name|bval
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|Carry
condition|)
block|{
name|bval
operator|=
literal|0x40
expr_stmt|;
operator|*
name|regval
operator|=
literal|0x80
expr_stmt|;
name|DC390_OutB
argument_list|(
name|mechnum
argument_list|,
operator|*
name|regval
argument_list|,
name|bval
argument_list|)
expr_stmt|;
block|}
name|DELAY
argument_list|(
literal|160
argument_list|)
expr_stmt|;
name|bval
operator||=
literal|0x80
expr_stmt|;
name|DC390_OutB
argument_list|(
name|mechnum
argument_list|,
operator|*
name|regval
argument_list|,
name|bval
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|160
argument_list|)
expr_stmt|;
name|bval
operator|=
literal|0
expr_stmt|;
name|DC390_OutB
argument_list|(
name|mechnum
argument_list|,
operator|*
name|regval
argument_list|,
name|bval
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|160
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|UCHAR
name|DC390_EEpromInDO
parameter_list|(
name|USHORT
name|mechnum
parameter_list|)
block|{
name|UCHAR
name|bval
decl_stmt|,
name|regval
decl_stmt|;
name|regval
operator|=
literal|0x80
expr_stmt|;
name|bval
operator|=
literal|0x80
expr_stmt|;
name|DC390_OutB
argument_list|(
name|mechnum
argument_list|,
name|regval
argument_list|,
name|bval
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|160
argument_list|)
expr_stmt|;
name|bval
operator|=
literal|0x40
expr_stmt|;
name|DC390_OutB
argument_list|(
name|mechnum
argument_list|,
name|regval
argument_list|,
name|bval
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|160
argument_list|)
expr_stmt|;
name|regval
operator|=
literal|0x0
expr_stmt|;
name|bval
operator|=
name|DC390_inByte
argument_list|(
name|mechnum
argument_list|,
name|regval
argument_list|)
expr_stmt|;
if|if
condition|(
name|bval
operator|==
literal|0x22
condition|)
return|return
operator|(
literal|1
operator|)
return|;
else|else
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|USHORT
name|EEpromGetData1
parameter_list|(
name|USHORT
name|mechnum
parameter_list|)
block|{
name|UCHAR
name|i
decl_stmt|;
name|UCHAR
name|carryFlag
decl_stmt|;
name|USHORT
name|wval
decl_stmt|;
name|wval
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
block|{
name|wval
operator|<<=
literal|1
expr_stmt|;
name|carryFlag
operator|=
name|DC390_EEpromInDO
argument_list|(
name|mechnum
argument_list|)
expr_stmt|;
name|wval
operator||=
name|carryFlag
expr_stmt|;
block|}
return|return
operator|(
name|wval
operator|)
return|;
block|}
end_function

begin_function
name|void
name|DC390_Prepare
parameter_list|(
name|USHORT
name|mechnum
parameter_list|,
name|PUCHAR
name|regval
parameter_list|,
name|UCHAR
name|EEpromCmd
parameter_list|)
block|{
name|UCHAR
name|i
decl_stmt|,
name|j
decl_stmt|;
name|USHORT
name|carryFlag
decl_stmt|;
name|carryFlag
operator|=
literal|1
expr_stmt|;
name|j
operator|=
literal|0x80
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|9
condition|;
name|i
operator|++
control|)
block|{
name|DC390_EEpromOutDI
argument_list|(
name|mechnum
argument_list|,
name|regval
argument_list|,
name|carryFlag
argument_list|)
expr_stmt|;
name|carryFlag
operator|=
operator|(
name|EEpromCmd
operator|&
name|j
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|j
operator|>>=
literal|1
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|DC390_ReadEEprom
parameter_list|(
name|USHORT
name|mechnum
parameter_list|,
name|USHORT
name|index
parameter_list|)
block|{
name|UCHAR
name|regval
decl_stmt|,
name|cmd
decl_stmt|;
name|PUSHORT
name|ptr
decl_stmt|;
name|USHORT
name|i
decl_stmt|;
name|ptr
operator|=
operator|(
name|PUSHORT
operator|)
operator|&
name|eepromBuf
index|[
name|index
index|]
index|[
literal|0
index|]
expr_stmt|;
name|cmd
operator|=
name|EEPROM_READ
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|0x40
condition|;
name|i
operator|++
control|)
block|{
name|DC390_EnDisableCE
argument_list|(
name|ENABLE_CE
argument_list|,
name|mechnum
argument_list|,
operator|&
name|regval
argument_list|)
expr_stmt|;
name|DC390_Prepare
argument_list|(
name|mechnum
argument_list|,
operator|&
name|regval
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
operator|*
name|ptr
operator|=
name|EEpromGetData1
argument_list|(
name|mechnum
argument_list|)
expr_stmt|;
name|ptr
operator|++
expr_stmt|;
name|cmd
operator|++
expr_stmt|;
name|DC390_EnDisableCE
argument_list|(
name|DISABLE_CE
argument_list|,
name|mechnum
argument_list|,
operator|&
name|regval
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|USHORT
name|DC390_DefaultEEprom
parameter_list|(
name|USHORT
name|mechnum
parameter_list|,
name|USHORT
name|index
parameter_list|)
block|{
name|PUCHAR
name|ptr
decl_stmt|;
name|USHORT
name|i
decl_stmt|;
name|ptr
operator|=
operator|(
name|PUCHAR
operator|)
operator|&
name|eepromBuf
index|[
name|index
index|]
index|[
literal|0
index|]
expr_stmt|;
name|bzero
argument_list|(
name|ptr
argument_list|,
sizeof|sizeof
name|eepromBuf
index|[
name|index
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|0x40
condition|;
name|i
operator|++
control|)
block|{
operator|*
name|ptr
operator|=
operator|(
name|TAG_QUEUING_
operator||
name|EN_DISCONNECT_
operator||
name|SYNC_NEGO_
operator||
name|PARITY_CHK_
operator|)
expr_stmt|;
name|ptr
operator|+=
literal|4
expr_stmt|;
block|}
name|eepromBuf
index|[
name|index
index|]
index|[
name|EE_ADAPT_SCSI_ID
index|]
operator|=
literal|7
expr_stmt|;
name|eepromBuf
index|[
name|index
index|]
index|[
name|EE_MODE2
index|]
operator|=
operator|(
name|LUN_CHECK
operator||
name|ACTIVE_NEGATION
operator|)
expr_stmt|;
name|eepromBuf
index|[
name|index
index|]
index|[
name|EE_TAG_CMD_NUM
index|]
operator|=
literal|4
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|USHORT
name|DC390_CheckEEpromCheckSum
parameter_list|(
name|USHORT
name|MechNum
parameter_list|,
name|USHORT
name|index
parameter_list|)
block|{
name|USHORT
name|wval
decl_stmt|,
name|rc
decl_stmt|,
modifier|*
name|ptr
decl_stmt|;
name|UCHAR
name|i
decl_stmt|;
name|DC390_ReadEEprom
argument_list|(
name|MechNum
argument_list|,
name|index
argument_list|)
expr_stmt|;
name|wval
operator|=
literal|0
expr_stmt|;
name|ptr
operator|=
operator|(
name|PUSHORT
operator|)
operator|&
name|eepromBuf
index|[
name|index
index|]
index|[
literal|0
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|128
condition|;
name|i
operator|+=
literal|2
operator|,
name|ptr
operator|++
control|)
name|wval
operator|+=
operator|*
name|ptr
expr_stmt|;
if|if
condition|(
name|wval
operator|==
literal|0x1234
condition|)
name|rc
operator|=
literal|0
expr_stmt|;
else|else
name|rc
operator|=
name|DC390_DefaultEEprom
argument_list|(
name|MechNum
argument_list|,
name|index
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
name|USHORT
name|DC390_ToMech
parameter_list|(
name|USHORT
name|Mechnum
parameter_list|,
name|pcici_t
name|config_id
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|PCI_COMPAT
name|cfg
operator|=
name|config_id
expr_stmt|;
else|#
directive|else
if|if
condition|(
name|Mechnum
operator|==
literal|2
condition|)
block|{
name|mech2bus
operator|=
name|config_id
operator|.
name|cfg2
operator|.
name|forward
expr_stmt|;
comment|/* Bus num */
name|mech2Agent
operator|=
name|config_id
operator|.
name|cfg2
operator|.
name|port
operator|>>
literal|8
expr_stmt|;
comment|/* Dev num */
name|mech2CfgSPenR
operator|=
name|config_id
operator|.
name|cfg2
operator|.
name|enable
expr_stmt|;
comment|/* Fun num */
block|}
else|else
comment|/* use mech #1 method */
block|{
name|mech1addr
operator|=
name|config_id
operator|.
name|cfg1
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* PCI_COMPAT */
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/***********************************************************************  * Function : static int DC390_init (struct Scsi_Host *host)  *  * Purpose :  initialize the internal structures for a given SCSI host  *  * Inputs : host - pointer to this host adapter's structure/  *  * Preconditions : when this function is called, the chip_type  *	field of the pACB structure MUST have been set.  ***********************************************************************/
end_comment

begin_function
specifier|static
name|int
name|DC390_init
parameter_list|(
name|ULONG
name|io_port
parameter_list|,
name|UCHAR
name|Irq
parameter_list|,
name|USHORT
name|index
parameter_list|,
name|USHORT
name|MechNum
parameter_list|,
name|pcici_t
name|config_id
parameter_list|)
block|{
name|PACB
name|pACB
decl_stmt|;
if|if
condition|(
operator|!
name|DC390_CheckEEpromCheckSum
argument_list|(
name|MechNum
argument_list|,
name|index
argument_list|)
condition|)
block|{
name|pACB
operator|=
operator|(
name|PACB
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|_ACB
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pACB
condition|)
block|{
name|printf
argument_list|(
literal|"DC390%d: cannot allocate ACB !\n"
argument_list|,
name|index
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|bzero
argument_list|(
name|pACB
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|_ACB
argument_list|)
argument_list|)
expr_stmt|;
name|DC390_initACB
argument_list|(
name|pACB
argument_list|,
name|io_port
argument_list|,
name|Irq
argument_list|,
name|index
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|DC390_initAdapter
argument_list|(
name|pACB
argument_list|,
name|io_port
argument_list|,
name|Irq
argument_list|,
name|index
argument_list|,
name|config_id
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|pACB_start
condition|)
block|{
name|pACB_start
operator|=
name|pACB
expr_stmt|;
name|pACB_current
operator|=
name|pACB
expr_stmt|;
name|pACB
operator|->
name|pNextACB
operator|=
operator|(
name|PACB
operator|)
operator|-
literal|1
expr_stmt|;
block|}
else|else
block|{
name|pACB_current
operator|->
name|pNextACB
operator|=
name|pACB
expr_stmt|;
name|pACB_current
operator|=
name|pACB
expr_stmt|;
name|pACB
operator|->
name|pNextACB
operator|=
operator|(
name|PACB
operator|)
operator|-
literal|1
expr_stmt|;
block|}
name|pACB0
index|[
name|index
index|]
operator|=
name|pACB
expr_stmt|;
ifdef|#
directive|ifdef
name|DC390_DEBUG0
name|printf
argument_list|(
literal|"DC390: pACB = %8x, pDCB_array = %8x, pSRB_array = %8x\n"
argument_list|,
operator|(
name|UINT
operator|)
name|pACB
argument_list|,
operator|(
name|UINT
operator|)
name|pACB
operator|->
name|DCB_array
argument_list|,
operator|(
name|UINT
operator|)
name|pACB
operator|->
name|SRB_array
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"DC390: ACB size= %4x, DCB size= %4x, SRB size= %4x\n"
argument_list|,
sizeof|sizeof
argument_list|(
name|DC390_ACB
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|DC390_DCB
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|DC390_SRB
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
literal|0
operator|)
return|;
block|}
else|else
block|{
name|free
argument_list|(
name|pACB
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
else|else
block|{
name|printf
argument_list|(
literal|"DC390_init: EEPROM reading error!\n"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
end_function

begin_function
name|void
name|trmamd_attach
parameter_list|(
name|pcici_t
name|config_id
parameter_list|,
name|int
name|unit
parameter_list|)
block|{
name|struct
name|scsibus_data
modifier|*
name|scbus
decl_stmt|;
name|UCHAR
name|irq
decl_stmt|;
name|USHORT
name|MechNum
decl_stmt|;
name|ULONG
name|io_port
decl_stmt|,
name|wlval
decl_stmt|;
name|PACB
name|pACB
init|=
literal|0
decl_stmt|;
name|int
name|flags
decl_stmt|;
if|if
condition|(
name|unit
operator|>=
name|MAX_ADAPTER_NUM
condition|)
return|return;
if|if
condition|(
name|pACB0
index|[
name|unit
index|]
condition|)
return|return;
name|CurrentID
operator|=
literal|0
expr_stmt|;
name|CurrentLUN
operator|=
literal|0
expr_stmt|;
name|MechNum
operator|=
name|pci_mechanism
expr_stmt|;
ifdef|#
directive|ifdef
name|DC390_DEBUG0
if|if
condition|(
name|bootverbose
condition|)
name|printf
argument_list|(
literal|"DC390: Mech=%2x,\n"
argument_list|,
operator|(
name|UCHAR
operator|)
name|MechNum
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|DC390_ToMech
argument_list|(
name|MechNum
argument_list|,
name|config_id
argument_list|)
condition|)
block|{
name|wlval
operator|=
name|DC390_inDword
argument_list|(
name|MechNum
argument_list|,
name|PCI_ID_REG
argument_list|)
expr_stmt|;
if|if
condition|(
name|wlval
operator|==
name|PCI_DEVICE_ID_AMD53C974
condition|)
block|{
name|io_port
operator|=
name|DC390_inDword
argument_list|(
name|MechNum
argument_list|,
name|PCI_BASE_ADDR0
argument_list|)
operator|&
literal|0xFFFE
expr_stmt|;
name|irq
operator|=
name|DC390_inByte
argument_list|(
name|MechNum
argument_list|,
name|PCI_INTERRUPT_REG
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DC390_DEBUG0
if|if
condition|(
name|bootverbose
condition|)
name|printf
argument_list|(
literal|"DC390: IO_PORT=%4x,IRQ=%x,\n"
argument_list|,
operator|(
name|UINT
operator|)
name|io_port
argument_list|,
name|irq
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|DC390_init
argument_list|(
name|io_port
argument_list|,
name|irq
argument_list|,
operator|(
name|USHORT
operator|)
name|unit
argument_list|,
name|MechNum
argument_list|,
name|config_id
argument_list|)
condition|)
block|{
name|adapterCnt
operator|++
expr_stmt|;
block|}
else|else
return|return;
block|}
block|}
name|pACB
operator|=
name|pACB0
index|[
name|unit
index|]
expr_stmt|;
comment|/*   Now let the generic SCSI driver look for the SCSI devices on the bus */
name|flags
operator|=
name|splbio
argument_list|()
expr_stmt|;
name|scbus
operator|=
name|scsi_alloc_bus
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|scbus
condition|)
block|{
name|splx
argument_list|(
name|flags
argument_list|)
expr_stmt|;
return|return;
block|}
name|scbus
operator|->
name|adapter_link
operator|=
operator|&
name|pACB
operator|->
name|ScsiLink
expr_stmt|;
name|scbus
operator|->
name|maxtarg
operator|=
name|pACB
operator|->
name|max_id
expr_stmt|;
ifdef|#
directive|ifdef
name|DC390_DEBUG
if|if
condition|(
name|bootverbose
condition|)
name|printf
argument_list|(
literal|"\nDC390: scanning for devices ...\n\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|scsi_attachdevs
argument_list|(
name|scbus
argument_list|)
expr_stmt|;
name|scbus
operator|=
name|NULL
expr_stmt|;
comment|/* Upper-level SCSI code owns this now */
ifdef|#
directive|ifdef
name|DC390_DEBUG
if|if
condition|(
name|bootverbose
condition|)
name|printf
argument_list|(
literal|"\n\nDC390: Attach devices return\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|splx
argument_list|(
name|flags
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|trmamd_probe
parameter_list|(
name|pcici_t
name|tag
parameter_list|,
name|pcidi_t
name|type
parameter_list|)
block|{
if|if
condition|(
name|type
operator|==
name|PCI_DEVICE_ID_AMD53C974
condition|)
return|return
operator|(
literal|"amd 53c974 scsi"
operator|)
return|;
else|else
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

end_unit


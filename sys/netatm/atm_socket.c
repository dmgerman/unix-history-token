begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  *  * ===================================  * HARP  |  Host ATM Research Platform  * ===================================  *  *  * This Host ATM Research Platform ("HARP") file (the "Software") is  * made available by Network Computing Services, Inc. ("NetworkCS")  * "AS IS".  NetworkCS does not provide maintenance, improvements or  * support of any kind.  *  * NETWORKCS MAKES NO WARRANTIES OR REPRESENTATIONS, EXPRESS OR IMPLIED,  * INCLUDING, BUT NOT LIMITED TO, IMPLIED WARRANTIES OF MERCHANTABILITY  * AND FITNESS FOR A PARTICULAR PURPOSE, AS TO ANY ELEMENT OF THE  * SOFTWARE OR ANY SUPPORT PROVIDED IN CONNECTION WITH THIS SOFTWARE.  * In no event shall NetworkCS be responsible for any damages, including  * but not limited to consequential damages, arising from or relating to  * any use of the Software or related support.  *  * Copyright 1994-1998 Network Computing Services, Inc.  *  * Copies of this Software may be made, however, the above copyright  * notice must be reproduced on all copies.  *  *	@(#) $Id: atm_socket.c,v 1.3 1998/07/30 22:30:53 mks Exp $  *  */
end_comment

begin_comment
comment|/*  * Core ATM Services  * -----------------  *  * ATM common socket protocol processing  *  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|RCSid
init|=
literal|"@(#) $Id: atm_socket.c,v 1.3 1998/07/30 22:30:53 mks Exp $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<netatm/kern_include.h>
end_include

begin_comment
comment|/*  * Local functions  */
end_comment

begin_comment
comment|/*  * Local variables  */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|sp_info
name|atm_pcb_pool
init|=
block|{
literal|"atm pcb pool"
block|,
comment|/* si_name */
sizeof|sizeof
argument_list|(
name|Atm_pcb
argument_list|)
block|,
comment|/* si_blksiz */
literal|10
block|,
comment|/* si_blkcnt */
literal|100
comment|/* si_maxallow */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|t_atm_cause
name|atm_sock_cause
init|=
block|{
name|T_ATM_ITU_CODING
block|,
name|T_ATM_LOC_USER
block|,
name|T_ATM_CAUSE_UNSPECIFIED_NORMAL
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Allocate resources for a new ATM socket  *  * Called at splnet.  *  * Arguments:  *	so	pointer to socket  *	send	socket send buffer maximum  *	recv	socket receive buffer maximum  *  * Returns:  *	0	attach successful  *	errno	attach failed - reason indicated  *  */
end_comment

begin_function
name|int
name|atm_sock_attach
parameter_list|(
name|so
parameter_list|,
name|send
parameter_list|,
name|recv
parameter_list|)
name|struct
name|socket
modifier|*
name|so
decl_stmt|;
name|u_long
name|send
decl_stmt|;
name|u_long
name|recv
decl_stmt|;
block|{
name|Atm_pcb
modifier|*
name|atp
init|=
name|sotoatmpcb
argument_list|(
name|so
argument_list|)
decl_stmt|;
name|int
name|err
decl_stmt|;
comment|/* 	 * Make sure initialization has happened 	 */
if|if
condition|(
operator|!
name|atm_init
condition|)
name|atm_initialize
argument_list|()
expr_stmt|;
comment|/* 	 * Make sure we're not already attached 	 */
if|if
condition|(
name|atp
condition|)
return|return
operator|(
name|EISCONN
operator|)
return|;
comment|/* 	 * Reserve socket buffer space, if not already done 	 */
if|if
condition|(
operator|(
name|so
operator|->
name|so_snd
operator|.
name|sb_hiwat
operator|==
literal|0
operator|)
operator|||
operator|(
name|so
operator|->
name|so_rcv
operator|.
name|sb_hiwat
operator|==
literal|0
operator|)
condition|)
block|{
name|err
operator|=
name|soreserve
argument_list|(
name|so
argument_list|,
name|send
argument_list|,
name|recv
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
operator|(
name|err
operator|)
return|;
block|}
comment|/* 	 * Allocate and initialize our control block 	 */
name|atp
operator|=
operator|(
name|Atm_pcb
operator|*
operator|)
name|atm_allocate
argument_list|(
operator|&
name|atm_pcb_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|atp
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
name|atp
operator|->
name|atp_socket
operator|=
name|so
expr_stmt|;
name|so
operator|->
name|so_pcb
operator|=
operator|(
name|caddr_t
operator|)
name|atp
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Detach from socket and free resources  *  * Called at splnet.  *  * Arguments:  *	so	pointer to socket  *  * Returns:  *	0	detach successful  *	errno	detach failed - reason indicated  *  */
end_comment

begin_function
name|int
name|atm_sock_detach
parameter_list|(
name|so
parameter_list|)
name|struct
name|socket
modifier|*
name|so
decl_stmt|;
block|{
name|Atm_pcb
modifier|*
name|atp
init|=
name|sotoatmpcb
argument_list|(
name|so
argument_list|)
decl_stmt|;
comment|/* 	 * Make sure we're still attached 	 */
if|if
condition|(
name|atp
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOTCONN
operator|)
return|;
comment|/* 	 * Terminate any (possibly pending) connection 	 */
if|if
condition|(
name|atp
operator|->
name|atp_conn
condition|)
block|{
operator|(
name|void
operator|)
name|atm_sock_disconnect
argument_list|(
name|so
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Break links and free control blocks 	 */
name|so
operator|->
name|so_pcb
operator|=
name|NULL
expr_stmt|;
name|sofree
argument_list|(
name|so
argument_list|)
expr_stmt|;
name|atm_free
argument_list|(
operator|(
name|caddr_t
operator|)
name|atp
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Bind local address to socket  *  * Called at splnet.  *  * Arguments:  *	so	pointer to socket  *	addr	pointer to protocol address  *  * Returns:  *	0	request processed  *	errno	error processing request - reason indicated  *  */
end_comment

begin_function
name|int
name|atm_sock_bind
parameter_list|(
name|so
parameter_list|,
name|addr
parameter_list|)
name|struct
name|socket
modifier|*
name|so
decl_stmt|;
name|struct
name|sockaddr
modifier|*
name|addr
decl_stmt|;
block|{
name|Atm_pcb
modifier|*
name|atp
init|=
name|sotoatmpcb
argument_list|(
name|so
argument_list|)
decl_stmt|;
name|Atm_attributes
name|attr
decl_stmt|;
name|struct
name|sockaddr_atm
modifier|*
name|satm
decl_stmt|;
name|struct
name|t_atm_sap_addr
modifier|*
name|sapadr
decl_stmt|;
name|struct
name|t_atm_sap_layer2
modifier|*
name|sapl2
decl_stmt|;
name|struct
name|t_atm_sap_layer3
modifier|*
name|sapl3
decl_stmt|;
name|struct
name|t_atm_sap_appl
modifier|*
name|sapapl
decl_stmt|;
comment|/* 	 * Make sure we're still attached 	 */
if|if
condition|(
name|atp
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOTCONN
operator|)
return|;
comment|/* 	 * Can't change local address once we've started connection process 	 */
if|if
condition|(
name|atp
operator|->
name|atp_conn
operator|!=
name|NULL
condition|)
return|return
operator|(
name|EADDRNOTAVAIL
operator|)
return|;
comment|/* 	 * Validate requested local address 	 */
name|satm
operator|=
operator|(
expr|struct
name|sockaddr_atm
operator|*
operator|)
name|addr
expr_stmt|;
if|if
condition|(
name|satm
operator|->
name|satm_family
operator|!=
name|AF_ATM
condition|)
return|return
operator|(
name|EAFNOSUPPORT
operator|)
return|;
name|sapadr
operator|=
operator|&
name|satm
operator|->
name|satm_addr
operator|.
name|t_atm_sap_addr
expr_stmt|;
if|if
condition|(
name|sapadr
operator|->
name|SVE_tag_addr
operator|==
name|T_ATM_PRESENT
condition|)
block|{
if|if
condition|(
name|sapadr
operator|->
name|address_format
operator|==
name|T_ATM_ENDSYS_ADDR
condition|)
block|{
if|if
condition|(
name|sapadr
operator|->
name|SVE_tag_selector
operator|!=
name|T_ATM_PRESENT
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|sapadr
operator|->
name|address_format
operator|==
name|T_ATM_E164_ADDR
condition|)
block|{
if|if
condition|(
name|sapadr
operator|->
name|SVE_tag_selector
operator|!=
name|T_ATM_ABSENT
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
else|else
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
elseif|else
if|if
condition|(
operator|(
name|sapadr
operator|->
name|SVE_tag_addr
operator|!=
name|T_ATM_ABSENT
operator|)
operator|&&
operator|(
name|sapadr
operator|->
name|SVE_tag_addr
operator|!=
name|T_ATM_ANY
operator|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
name|sapadr
operator|->
name|address_length
operator|>
name|ATM_ADDR_LEN
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|sapl2
operator|=
operator|&
name|satm
operator|->
name|satm_addr
operator|.
name|t_atm_sap_layer2
expr_stmt|;
if|if
condition|(
name|sapl2
operator|->
name|SVE_tag
operator|==
name|T_ATM_PRESENT
condition|)
block|{
if|if
condition|(
operator|(
name|sapl2
operator|->
name|ID_type
operator|!=
name|T_ATM_SIMPLE_ID
operator|)
operator|&&
operator|(
name|sapl2
operator|->
name|ID_type
operator|!=
name|T_ATM_USER_ID
operator|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
elseif|else
if|if
condition|(
operator|(
name|sapl2
operator|->
name|SVE_tag
operator|!=
name|T_ATM_ABSENT
operator|)
operator|&&
operator|(
name|sapl2
operator|->
name|SVE_tag
operator|!=
name|T_ATM_ANY
operator|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|sapl3
operator|=
operator|&
name|satm
operator|->
name|satm_addr
operator|.
name|t_atm_sap_layer3
expr_stmt|;
if|if
condition|(
name|sapl3
operator|->
name|SVE_tag
operator|==
name|T_ATM_PRESENT
condition|)
block|{
if|if
condition|(
operator|(
name|sapl3
operator|->
name|ID_type
operator|!=
name|T_ATM_SIMPLE_ID
operator|)
operator|&&
operator|(
name|sapl3
operator|->
name|ID_type
operator|!=
name|T_ATM_IPI_ID
operator|)
operator|&&
operator|(
name|sapl3
operator|->
name|ID_type
operator|!=
name|T_ATM_SNAP_ID
operator|)
operator|&&
operator|(
name|sapl3
operator|->
name|ID_type
operator|!=
name|T_ATM_USER_ID
operator|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
elseif|else
if|if
condition|(
operator|(
name|sapl3
operator|->
name|SVE_tag
operator|!=
name|T_ATM_ABSENT
operator|)
operator|&&
operator|(
name|sapl3
operator|->
name|SVE_tag
operator|!=
name|T_ATM_ANY
operator|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|sapapl
operator|=
operator|&
name|satm
operator|->
name|satm_addr
operator|.
name|t_atm_sap_appl
expr_stmt|;
if|if
condition|(
name|sapapl
operator|->
name|SVE_tag
operator|==
name|T_ATM_PRESENT
condition|)
block|{
if|if
condition|(
operator|(
name|sapapl
operator|->
name|ID_type
operator|!=
name|T_ATM_ISO_APP_ID
operator|)
operator|&&
operator|(
name|sapapl
operator|->
name|ID_type
operator|!=
name|T_ATM_USER_APP_ID
operator|)
operator|&&
operator|(
name|sapapl
operator|->
name|ID_type
operator|!=
name|T_ATM_VENDOR_APP_ID
operator|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
elseif|else
if|if
condition|(
operator|(
name|sapapl
operator|->
name|SVE_tag
operator|!=
name|T_ATM_ABSENT
operator|)
operator|&&
operator|(
name|sapapl
operator|->
name|SVE_tag
operator|!=
name|T_ATM_ANY
operator|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
comment|/* 	 * Create temporary attributes list so that we can check out the 	 * new bind parameters before we modify the socket's values; 	 */
name|attr
operator|=
name|atp
operator|->
name|atp_attr
expr_stmt|;
name|attr
operator|.
name|called
operator|.
name|tag
operator|=
name|sapadr
operator|->
name|SVE_tag_addr
expr_stmt|;
name|KM_COPY
argument_list|(
operator|&
name|sapadr
operator|->
name|address_format
argument_list|,
operator|&
name|attr
operator|.
name|called
operator|.
name|addr
argument_list|,
sizeof|sizeof
argument_list|(
name|Atm_addr
argument_list|)
argument_list|)
expr_stmt|;
name|attr
operator|.
name|blli
operator|.
name|tag_l2
operator|=
name|sapl2
operator|->
name|SVE_tag
expr_stmt|;
if|if
condition|(
name|sapl2
operator|->
name|SVE_tag
operator|==
name|T_ATM_PRESENT
condition|)
block|{
name|attr
operator|.
name|blli
operator|.
name|v
operator|.
name|layer_2_protocol
operator|.
name|ID_type
operator|=
name|sapl2
operator|->
name|ID_type
expr_stmt|;
name|KM_COPY
argument_list|(
operator|&
name|sapl2
operator|->
name|ID
argument_list|,
operator|&
name|attr
operator|.
name|blli
operator|.
name|v
operator|.
name|layer_2_protocol
operator|.
name|ID
argument_list|,
sizeof|sizeof
argument_list|(
name|attr
operator|.
name|blli
operator|.
name|v
operator|.
name|layer_2_protocol
operator|.
name|ID
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|attr
operator|.
name|blli
operator|.
name|tag_l3
operator|=
name|sapl3
operator|->
name|SVE_tag
expr_stmt|;
if|if
condition|(
name|sapl3
operator|->
name|SVE_tag
operator|==
name|T_ATM_PRESENT
condition|)
block|{
name|attr
operator|.
name|blli
operator|.
name|v
operator|.
name|layer_3_protocol
operator|.
name|ID_type
operator|=
name|sapl3
operator|->
name|ID_type
expr_stmt|;
name|KM_COPY
argument_list|(
operator|&
name|sapl3
operator|->
name|ID
argument_list|,
operator|&
name|attr
operator|.
name|blli
operator|.
name|v
operator|.
name|layer_3_protocol
operator|.
name|ID
argument_list|,
sizeof|sizeof
argument_list|(
name|attr
operator|.
name|blli
operator|.
name|v
operator|.
name|layer_3_protocol
operator|.
name|ID
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|attr
operator|.
name|bhli
operator|.
name|tag
operator|=
name|sapapl
operator|->
name|SVE_tag
expr_stmt|;
if|if
condition|(
name|sapapl
operator|->
name|SVE_tag
operator|==
name|T_ATM_PRESENT
condition|)
block|{
name|attr
operator|.
name|bhli
operator|.
name|v
operator|.
name|ID_type
operator|=
name|sapapl
operator|->
name|ID_type
expr_stmt|;
name|KM_COPY
argument_list|(
operator|&
name|sapapl
operator|->
name|ID
argument_list|,
operator|&
name|attr
operator|.
name|bhli
operator|.
name|v
operator|.
name|ID
argument_list|,
sizeof|sizeof
argument_list|(
name|attr
operator|.
name|bhli
operator|.
name|v
operator|.
name|ID
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Make sure we have unique listening attributes 	 */
if|if
condition|(
name|atm_cm_match
argument_list|(
operator|&
name|attr
argument_list|,
name|NULL
argument_list|)
operator|!=
name|NULL
condition|)
return|return
operator|(
name|EADDRINUSE
operator|)
return|;
comment|/* 	 * Looks good, save new attributes 	 */
name|atp
operator|->
name|atp_attr
operator|=
name|attr
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Listen for incoming connections  *  * Called at splnet.  *  * Arguments:  *	so	pointer to socket  *	epp	pointer to endpoint definition structure  *  * Returns:  *	0	request processed  *	errno	error processing request - reason indicated  *  */
end_comment

begin_function
name|int
name|atm_sock_listen
parameter_list|(
name|so
parameter_list|,
name|epp
parameter_list|)
name|struct
name|socket
modifier|*
name|so
decl_stmt|;
name|Atm_endpoint
modifier|*
name|epp
decl_stmt|;
block|{
name|Atm_pcb
modifier|*
name|atp
init|=
name|sotoatmpcb
argument_list|(
name|so
argument_list|)
decl_stmt|;
comment|/* 	 * Make sure we're still attached 	 */
if|if
condition|(
name|atp
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOTCONN
operator|)
return|;
comment|/* 	 * Start listening for incoming calls 	 */
return|return
operator|(
name|atm_cm_listen
argument_list|(
name|epp
argument_list|,
name|atp
argument_list|,
operator|&
name|atp
operator|->
name|atp_attr
argument_list|,
operator|&
name|atp
operator|->
name|atp_conn
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Connect socket to peer  *  * Called at splnet.  *  * Arguments:  *	so	pointer to socket  *	addr	pointer to protocol address  *	epp	pointer to endpoint definition structure  *  * Returns:  *	0	request processed  *	errno	error processing request - reason indicated  *  */
end_comment

begin_function
name|int
name|atm_sock_connect
parameter_list|(
name|so
parameter_list|,
name|addr
parameter_list|,
name|epp
parameter_list|)
name|struct
name|socket
modifier|*
name|so
decl_stmt|;
name|struct
name|sockaddr
modifier|*
name|addr
decl_stmt|;
name|Atm_endpoint
modifier|*
name|epp
decl_stmt|;
block|{
name|Atm_pcb
modifier|*
name|atp
init|=
name|sotoatmpcb
argument_list|(
name|so
argument_list|)
decl_stmt|;
name|struct
name|sockaddr_atm
modifier|*
name|satm
decl_stmt|;
name|struct
name|t_atm_sap_addr
modifier|*
name|sapadr
decl_stmt|;
name|struct
name|t_atm_sap_layer2
modifier|*
name|sapl2
decl_stmt|;
name|struct
name|t_atm_sap_layer3
modifier|*
name|sapl3
decl_stmt|;
name|struct
name|t_atm_sap_appl
modifier|*
name|sapapl
decl_stmt|;
name|int
name|err
decl_stmt|;
comment|/* 	 * Make sure we're still attached 	 */
if|if
condition|(
name|atp
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOTCONN
operator|)
return|;
comment|/* 	 * Validate requested peer address 	 */
name|satm
operator|=
operator|(
expr|struct
name|sockaddr_atm
operator|*
operator|)
name|addr
expr_stmt|;
if|if
condition|(
name|satm
operator|->
name|satm_family
operator|!=
name|AF_ATM
condition|)
return|return
operator|(
name|EAFNOSUPPORT
operator|)
return|;
name|sapadr
operator|=
operator|&
name|satm
operator|->
name|satm_addr
operator|.
name|t_atm_sap_addr
expr_stmt|;
if|if
condition|(
name|sapadr
operator|->
name|SVE_tag_addr
operator|!=
name|T_ATM_PRESENT
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
name|sapadr
operator|->
name|address_format
operator|==
name|T_ATM_ENDSYS_ADDR
condition|)
block|{
if|if
condition|(
name|sapadr
operator|->
name|SVE_tag_selector
operator|!=
name|T_ATM_PRESENT
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|sapadr
operator|->
name|address_format
operator|==
name|T_ATM_E164_ADDR
condition|)
block|{
if|if
condition|(
name|sapadr
operator|->
name|SVE_tag_selector
operator|!=
name|T_ATM_ABSENT
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|sapadr
operator|->
name|address_format
operator|==
name|T_ATM_PVC_ADDR
condition|)
block|{
if|if
condition|(
name|sapadr
operator|->
name|SVE_tag_selector
operator|!=
name|T_ATM_ABSENT
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
else|else
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
name|sapadr
operator|->
name|address_length
operator|>
name|ATM_ADDR_LEN
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|sapl2
operator|=
operator|&
name|satm
operator|->
name|satm_addr
operator|.
name|t_atm_sap_layer2
expr_stmt|;
if|if
condition|(
name|sapl2
operator|->
name|SVE_tag
operator|==
name|T_ATM_PRESENT
condition|)
block|{
if|if
condition|(
operator|(
name|sapl2
operator|->
name|ID_type
operator|!=
name|T_ATM_SIMPLE_ID
operator|)
operator|&&
operator|(
name|sapl2
operator|->
name|ID_type
operator|!=
name|T_ATM_USER_ID
operator|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|sapl2
operator|->
name|SVE_tag
operator|!=
name|T_ATM_ABSENT
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|sapl3
operator|=
operator|&
name|satm
operator|->
name|satm_addr
operator|.
name|t_atm_sap_layer3
expr_stmt|;
if|if
condition|(
name|sapl3
operator|->
name|SVE_tag
operator|==
name|T_ATM_PRESENT
condition|)
block|{
if|if
condition|(
operator|(
name|sapl3
operator|->
name|ID_type
operator|!=
name|T_ATM_SIMPLE_ID
operator|)
operator|&&
operator|(
name|sapl3
operator|->
name|ID_type
operator|!=
name|T_ATM_IPI_ID
operator|)
operator|&&
operator|(
name|sapl3
operator|->
name|ID_type
operator|!=
name|T_ATM_SNAP_ID
operator|)
operator|&&
operator|(
name|sapl3
operator|->
name|ID_type
operator|!=
name|T_ATM_USER_ID
operator|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|sapl3
operator|->
name|SVE_tag
operator|!=
name|T_ATM_ABSENT
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|sapapl
operator|=
operator|&
name|satm
operator|->
name|satm_addr
operator|.
name|t_atm_sap_appl
expr_stmt|;
if|if
condition|(
name|sapapl
operator|->
name|SVE_tag
operator|==
name|T_ATM_PRESENT
condition|)
block|{
if|if
condition|(
operator|(
name|sapapl
operator|->
name|ID_type
operator|!=
name|T_ATM_ISO_APP_ID
operator|)
operator|&&
operator|(
name|sapapl
operator|->
name|ID_type
operator|!=
name|T_ATM_USER_APP_ID
operator|)
operator|&&
operator|(
name|sapapl
operator|->
name|ID_type
operator|!=
name|T_ATM_VENDOR_APP_ID
operator|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|sapapl
operator|->
name|SVE_tag
operator|!=
name|T_ATM_ABSENT
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
comment|/* 	 * Select an outgoing network interface 	 */
if|if
condition|(
name|atp
operator|->
name|atp_attr
operator|.
name|nif
operator|==
name|NULL
condition|)
block|{
name|struct
name|atm_pif
modifier|*
name|pip
decl_stmt|;
for|for
control|(
name|pip
operator|=
name|atm_interface_head
init|;
name|pip
operator|!=
name|NULL
condition|;
name|pip
operator|=
name|pip
operator|->
name|pif_next
control|)
block|{
if|if
condition|(
name|pip
operator|->
name|pif_nif
operator|!=
name|NULL
condition|)
block|{
name|atp
operator|->
name|atp_attr
operator|.
name|nif
operator|=
name|pip
operator|->
name|pif_nif
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|atp
operator|->
name|atp_attr
operator|.
name|nif
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
comment|/* 	 * Set supplied connection attributes 	 */
name|atp
operator|->
name|atp_attr
operator|.
name|called
operator|.
name|tag
operator|=
name|T_ATM_PRESENT
expr_stmt|;
name|KM_COPY
argument_list|(
operator|&
name|sapadr
operator|->
name|address_format
argument_list|,
operator|&
name|atp
operator|->
name|atp_attr
operator|.
name|called
operator|.
name|addr
argument_list|,
sizeof|sizeof
argument_list|(
name|Atm_addr
argument_list|)
argument_list|)
expr_stmt|;
name|atp
operator|->
name|atp_attr
operator|.
name|blli
operator|.
name|tag_l2
operator|=
name|sapl2
operator|->
name|SVE_tag
expr_stmt|;
if|if
condition|(
name|sapl2
operator|->
name|SVE_tag
operator|==
name|T_ATM_PRESENT
condition|)
block|{
name|atp
operator|->
name|atp_attr
operator|.
name|blli
operator|.
name|v
operator|.
name|layer_2_protocol
operator|.
name|ID_type
operator|=
name|sapl2
operator|->
name|ID_type
expr_stmt|;
name|KM_COPY
argument_list|(
operator|&
name|sapl2
operator|->
name|ID
argument_list|,
operator|&
name|atp
operator|->
name|atp_attr
operator|.
name|blli
operator|.
name|v
operator|.
name|layer_2_protocol
operator|.
name|ID
argument_list|,
sizeof|sizeof
argument_list|(
name|atp
operator|->
name|atp_attr
operator|.
name|blli
operator|.
name|v
operator|.
name|layer_2_protocol
operator|.
name|ID
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|atp
operator|->
name|atp_attr
operator|.
name|blli
operator|.
name|tag_l3
operator|=
name|sapl3
operator|->
name|SVE_tag
expr_stmt|;
if|if
condition|(
name|sapl3
operator|->
name|SVE_tag
operator|==
name|T_ATM_PRESENT
condition|)
block|{
name|atp
operator|->
name|atp_attr
operator|.
name|blli
operator|.
name|v
operator|.
name|layer_3_protocol
operator|.
name|ID_type
operator|=
name|sapl3
operator|->
name|ID_type
expr_stmt|;
name|KM_COPY
argument_list|(
operator|&
name|sapl3
operator|->
name|ID
argument_list|,
operator|&
name|atp
operator|->
name|atp_attr
operator|.
name|blli
operator|.
name|v
operator|.
name|layer_3_protocol
operator|.
name|ID
argument_list|,
sizeof|sizeof
argument_list|(
name|atp
operator|->
name|atp_attr
operator|.
name|blli
operator|.
name|v
operator|.
name|layer_3_protocol
operator|.
name|ID
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|atp
operator|->
name|atp_attr
operator|.
name|bhli
operator|.
name|tag
operator|=
name|sapapl
operator|->
name|SVE_tag
expr_stmt|;
if|if
condition|(
name|sapapl
operator|->
name|SVE_tag
operator|==
name|T_ATM_PRESENT
condition|)
block|{
name|atp
operator|->
name|atp_attr
operator|.
name|bhli
operator|.
name|v
operator|.
name|ID_type
operator|=
name|sapapl
operator|->
name|ID_type
expr_stmt|;
name|KM_COPY
argument_list|(
operator|&
name|sapapl
operator|->
name|ID
argument_list|,
operator|&
name|atp
operator|->
name|atp_attr
operator|.
name|bhli
operator|.
name|v
operator|.
name|ID
argument_list|,
sizeof|sizeof
argument_list|(
name|atp
operator|->
name|atp_attr
operator|.
name|bhli
operator|.
name|v
operator|.
name|ID
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * We're finally ready to initiate the ATM connection 	 */
name|soisconnecting
argument_list|(
name|so
argument_list|)
expr_stmt|;
name|atm_sock_stat
operator|.
name|as_connreq
index|[
name|atp
operator|->
name|atp_type
index|]
operator|++
expr_stmt|;
name|err
operator|=
name|atm_cm_connect
argument_list|(
name|epp
argument_list|,
name|atp
argument_list|,
operator|&
name|atp
operator|->
name|atp_attr
argument_list|,
operator|&
name|atp
operator|->
name|atp_conn
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
literal|0
condition|)
block|{
comment|/* 		 * Connection is setup 		 */
name|atm_sock_stat
operator|.
name|as_conncomp
index|[
name|atp
operator|->
name|atp_type
index|]
operator|++
expr_stmt|;
name|soisconnected
argument_list|(
name|so
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|err
operator|==
name|EINPROGRESS
condition|)
block|{
comment|/* 		 * We've got to wait for a connected event 		 */
name|err
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
comment|/* 		 * Call failed... 		 */
name|atm_sock_stat
operator|.
name|as_connfail
index|[
name|atp
operator|->
name|atp_type
index|]
operator|++
expr_stmt|;
name|soisdisconnected
argument_list|(
name|so
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Disconnect connected socket  *  * Called at splnet.  *  * Arguments:  *	so	pointer to socket  *  * Returns:  *	0	request processed  *	errno	error processing request - reason indicated  *  */
end_comment

begin_function
name|int
name|atm_sock_disconnect
parameter_list|(
name|so
parameter_list|)
name|struct
name|socket
modifier|*
name|so
decl_stmt|;
block|{
name|Atm_pcb
modifier|*
name|atp
init|=
name|sotoatmpcb
argument_list|(
name|so
argument_list|)
decl_stmt|;
name|struct
name|t_atm_cause
modifier|*
name|cause
decl_stmt|;
name|int
name|err
decl_stmt|;
comment|/* 	 * Make sure we're still attached 	 */
if|if
condition|(
name|atp
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOTCONN
operator|)
return|;
comment|/* 	 * Release the ATM connection 	 */
if|if
condition|(
name|atp
operator|->
name|atp_conn
condition|)
block|{
if|if
condition|(
name|atp
operator|->
name|atp_attr
operator|.
name|cause
operator|.
name|tag
operator|==
name|T_ATM_PRESENT
condition|)
name|cause
operator|=
operator|&
name|atp
operator|->
name|atp_attr
operator|.
name|cause
operator|.
name|v
expr_stmt|;
else|else
name|cause
operator|=
operator|&
name|atm_sock_cause
expr_stmt|;
name|err
operator|=
name|atm_cm_release
argument_list|(
name|atp
operator|->
name|atp_conn
argument_list|,
name|cause
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"atm_sock_disconnect: release fail (%d)\n"
argument_list|,
name|err
argument_list|)
expr_stmt|;
name|atm_sock_stat
operator|.
name|as_connrel
index|[
name|atp
operator|->
name|atp_type
index|]
operator|++
expr_stmt|;
name|atp
operator|->
name|atp_conn
operator|=
name|NULL
expr_stmt|;
block|}
name|soisdisconnected
argument_list|(
name|so
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Retrieve local socket address  *  * Called at splnet.  *  * Arguments:  *	so	pointer to socket  *	addr	pointer to pointer to contain protocol address  *  * Returns:  *	0	request processed  *	errno	error processing request - reason indicated  *  */
end_comment

begin_function
name|int
name|atm_sock_sockaddr
parameter_list|(
name|so
parameter_list|,
name|addr
parameter_list|)
name|struct
name|socket
modifier|*
name|so
decl_stmt|;
name|struct
name|sockaddr
modifier|*
modifier|*
name|addr
decl_stmt|;
block|{
name|struct
name|sockaddr_atm
modifier|*
name|satm
decl_stmt|;
name|struct
name|t_atm_sap_addr
modifier|*
name|saddr
decl_stmt|;
name|Atm_pcb
modifier|*
name|atp
init|=
name|sotoatmpcb
argument_list|(
name|so
argument_list|)
decl_stmt|;
comment|/* 	 * Return local interface address, if known 	 */
name|satm
operator|=
name|KM_ALLOC
argument_list|(
sizeof|sizeof
expr|*
name|satm
argument_list|,
name|M_SONAME
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
if|if
condition|(
name|satm
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
name|KM_ZERO
argument_list|(
name|satm
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|satm
argument_list|)
argument_list|)
expr_stmt|;
name|satm
operator|->
name|satm_family
operator|=
name|AF_ATM
expr_stmt|;
if|#
directive|if
operator|(
name|defined
argument_list|(
name|BSD
argument_list|)
operator|&&
operator|(
name|BSD
operator|>=
literal|199103
operator|)
operator|)
name|satm
operator|->
name|satm_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|satm
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|saddr
operator|=
operator|&
name|satm
operator|->
name|satm_addr
operator|.
name|t_atm_sap_addr
expr_stmt|;
if|if
condition|(
name|atp
operator|->
name|atp_attr
operator|.
name|nif
operator|&&
name|atp
operator|->
name|atp_attr
operator|.
name|nif
operator|->
name|nif_pif
operator|->
name|pif_siginst
condition|)
block|{
name|saddr
operator|->
name|SVE_tag_addr
operator|=
name|T_ATM_PRESENT
expr_stmt|;
name|ATM_ADDR_SEL_COPY
argument_list|(
operator|&
name|atp
operator|->
name|atp_attr
operator|.
name|nif
operator|->
name|nif_pif
operator|->
name|pif_siginst
operator|->
name|si_addr
argument_list|,
name|atp
operator|->
name|atp_attr
operator|.
name|nif
operator|->
name|nif_sel
argument_list|,
name|saddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|saddr
operator|->
name|address_format
operator|==
name|T_ATM_ENDSYS_ADDR
condition|)
name|saddr
operator|->
name|SVE_tag_selector
operator|=
name|T_ATM_PRESENT
expr_stmt|;
else|else
name|saddr
operator|->
name|SVE_tag_selector
operator|=
name|T_ATM_ABSENT
expr_stmt|;
block|}
else|else
block|{
name|saddr
operator|->
name|SVE_tag_addr
operator|=
name|T_ATM_ABSENT
expr_stmt|;
name|saddr
operator|->
name|SVE_tag_selector
operator|=
name|T_ATM_ABSENT
expr_stmt|;
name|saddr
operator|->
name|address_format
operator|=
name|T_ATM_ABSENT
expr_stmt|;
block|}
name|satm
operator|->
name|satm_addr
operator|.
name|t_atm_sap_layer2
operator|.
name|SVE_tag
operator|=
name|T_ATM_ABSENT
expr_stmt|;
name|satm
operator|->
name|satm_addr
operator|.
name|t_atm_sap_layer3
operator|.
name|SVE_tag
operator|=
name|T_ATM_ABSENT
expr_stmt|;
name|satm
operator|->
name|satm_addr
operator|.
name|t_atm_sap_appl
operator|.
name|SVE_tag
operator|=
name|T_ATM_ABSENT
expr_stmt|;
operator|*
name|addr
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
name|satm
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Retrieve peer socket address  *  * Called at splnet.  *  * Arguments:  *	so	pointer to socket  *	addr	pointer to pointer to contain protocol address  *  * Returns:  *	0	request processed  *	errno	error processing request - reason indicated  *  */
end_comment

begin_function
name|int
name|atm_sock_peeraddr
parameter_list|(
name|so
parameter_list|,
name|addr
parameter_list|)
name|struct
name|socket
modifier|*
name|so
decl_stmt|;
name|struct
name|sockaddr
modifier|*
modifier|*
name|addr
decl_stmt|;
block|{
name|struct
name|sockaddr_atm
modifier|*
name|satm
decl_stmt|;
name|struct
name|t_atm_sap_addr
modifier|*
name|saddr
decl_stmt|;
name|Atm_pcb
modifier|*
name|atp
init|=
name|sotoatmpcb
argument_list|(
name|so
argument_list|)
decl_stmt|;
name|Atm_connvc
modifier|*
name|cvp
decl_stmt|;
comment|/* 	 * Return remote address, if known 	 */
name|satm
operator|=
name|KM_ALLOC
argument_list|(
sizeof|sizeof
expr|*
name|satm
argument_list|,
name|M_SONAME
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
if|if
condition|(
name|satm
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
name|KM_ZERO
argument_list|(
name|satm
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|satm
argument_list|)
argument_list|)
expr_stmt|;
name|satm
operator|->
name|satm_family
operator|=
name|AF_ATM
expr_stmt|;
if|#
directive|if
operator|(
name|defined
argument_list|(
name|BSD
argument_list|)
operator|&&
operator|(
name|BSD
operator|>=
literal|199103
operator|)
operator|)
name|satm
operator|->
name|satm_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|satm
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|saddr
operator|=
operator|&
name|satm
operator|->
name|satm_addr
operator|.
name|t_atm_sap_addr
expr_stmt|;
if|if
condition|(
name|so
operator|->
name|so_state
operator|&
name|SS_ISCONNECTED
condition|)
block|{
name|cvp
operator|=
name|atp
operator|->
name|atp_conn
operator|->
name|co_connvc
expr_stmt|;
name|saddr
operator|->
name|SVE_tag_addr
operator|=
name|T_ATM_PRESENT
expr_stmt|;
if|if
condition|(
name|cvp
operator|->
name|cvc_flags
operator|&
name|CVCF_CALLER
condition|)
block|{
name|ATM_ADDR_COPY
argument_list|(
operator|&
name|cvp
operator|->
name|cvc_attr
operator|.
name|called
operator|.
name|addr
argument_list|,
name|saddr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|cvp
operator|->
name|cvc_attr
operator|.
name|calling
operator|.
name|tag
operator|==
name|T_ATM_PRESENT
condition|)
block|{
name|ATM_ADDR_COPY
argument_list|(
operator|&
name|cvp
operator|->
name|cvc_attr
operator|.
name|calling
operator|.
name|addr
argument_list|,
name|saddr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|saddr
operator|->
name|SVE_tag_addr
operator|=
name|T_ATM_ABSENT
expr_stmt|;
name|saddr
operator|->
name|address_format
operator|=
name|T_ATM_ABSENT
expr_stmt|;
block|}
block|}
if|if
condition|(
name|saddr
operator|->
name|address_format
operator|==
name|T_ATM_ENDSYS_ADDR
condition|)
name|saddr
operator|->
name|SVE_tag_selector
operator|=
name|T_ATM_PRESENT
expr_stmt|;
else|else
name|saddr
operator|->
name|SVE_tag_selector
operator|=
name|T_ATM_ABSENT
expr_stmt|;
block|}
else|else
block|{
name|saddr
operator|->
name|SVE_tag_addr
operator|=
name|T_ATM_ABSENT
expr_stmt|;
name|saddr
operator|->
name|SVE_tag_selector
operator|=
name|T_ATM_ABSENT
expr_stmt|;
name|saddr
operator|->
name|address_format
operator|=
name|T_ATM_ABSENT
expr_stmt|;
block|}
name|satm
operator|->
name|satm_addr
operator|.
name|t_atm_sap_layer2
operator|.
name|SVE_tag
operator|=
name|T_ATM_ABSENT
expr_stmt|;
name|satm
operator|->
name|satm_addr
operator|.
name|t_atm_sap_layer3
operator|.
name|SVE_tag
operator|=
name|T_ATM_ABSENT
expr_stmt|;
name|satm
operator|->
name|satm_addr
operator|.
name|t_atm_sap_appl
operator|.
name|SVE_tag
operator|=
name|T_ATM_ABSENT
expr_stmt|;
operator|*
name|addr
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
name|satm
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Common setsockopt processing  *  * Called at splnet.  *  * Arguments:  *	so	pointer to socket  *	sopt	pointer to socket option info  *	atp	pointer to ATM PCB  *  * Returns:  *	0 	request processed  *	errno	error processing request - reason indicated  *  */
end_comment

begin_function
name|int
name|atm_sock_setopt
parameter_list|(
name|so
parameter_list|,
name|sopt
parameter_list|,
name|atp
parameter_list|)
name|struct
name|socket
modifier|*
name|so
decl_stmt|;
name|struct
name|sockopt
modifier|*
name|sopt
decl_stmt|;
name|Atm_pcb
modifier|*
name|atp
decl_stmt|;
block|{
name|int
name|err
init|=
literal|0
decl_stmt|;
union|union
block|{
name|struct
name|t_atm_aal5
name|aal5
decl_stmt|;
name|struct
name|t_atm_traffic
name|trf
decl_stmt|;
name|struct
name|t_atm_bearer
name|brr
decl_stmt|;
name|struct
name|t_atm_bhli
name|bhl
decl_stmt|;
name|struct
name|t_atm_blli
name|bll
decl_stmt|;
name|Atm_addr
name|addr
decl_stmt|;
name|struct
name|t_atm_cause
name|cau
decl_stmt|;
name|struct
name|t_atm_qos
name|qos
decl_stmt|;
name|struct
name|t_atm_transit
name|trn
decl_stmt|;
name|struct
name|t_atm_net_intf
name|nif
decl_stmt|;
name|struct
name|t_atm_llc
name|llc
decl_stmt|;
name|struct
name|t_atm_app_name
name|appn
decl_stmt|;
block|}
name|p
union|;
define|#
directive|define
name|MAXVAL
parameter_list|(
name|bits
parameter_list|)
value|((1<< bits) - 1)
define|#
directive|define
name|MAXMASK
parameter_list|(
name|bits
parameter_list|)
value|(~MAXVAL(bits))
switch|switch
condition|(
name|sopt
operator|->
name|sopt_name
condition|)
block|{
case|case
name|T_ATM_AAL5
case|:
name|err
operator|=
name|sooptcopyin
argument_list|(
name|sopt
argument_list|,
operator|&
name|p
operator|.
name|aal5
argument_list|,
sizeof|sizeof
name|p
operator|.
name|aal5
argument_list|,
sizeof|sizeof
name|p
operator|.
name|aal5
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
break|break;
if|if
condition|(
operator|(
name|p
operator|.
name|aal5
operator|.
name|forward_max_SDU_size
operator|!=
name|T_ATM_ABSENT
operator|)
operator|&&
operator|(
name|p
operator|.
name|aal5
operator|.
name|forward_max_SDU_size
operator|&
name|MAXMASK
argument_list|(
literal|16
argument_list|)
operator|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
operator|(
name|p
operator|.
name|aal5
operator|.
name|backward_max_SDU_size
operator|!=
name|T_ATM_ABSENT
operator|)
operator|&&
operator|(
name|p
operator|.
name|aal5
operator|.
name|backward_max_SDU_size
operator|&
name|MAXMASK
argument_list|(
literal|16
argument_list|)
operator|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
operator|(
name|p
operator|.
name|aal5
operator|.
name|SSCS_type
operator|!=
name|T_ATM_ABSENT
operator|)
operator|&&
operator|(
name|p
operator|.
name|aal5
operator|.
name|SSCS_type
operator|!=
name|T_ATM_NULL
operator|)
operator|&&
operator|(
name|p
operator|.
name|aal5
operator|.
name|SSCS_type
operator|!=
name|T_ATM_SSCS_SSCOP_REL
operator|)
operator|&&
operator|(
name|p
operator|.
name|aal5
operator|.
name|SSCS_type
operator|!=
name|T_ATM_SSCS_SSCOP_UNREL
operator|)
operator|&&
operator|(
name|p
operator|.
name|aal5
operator|.
name|SSCS_type
operator|!=
name|T_ATM_SSCS_FR
operator|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
operator|(
name|p
operator|.
name|aal5
operator|.
name|forward_max_SDU_size
operator|==
name|T_ATM_ABSENT
operator|)
operator|&&
operator|(
name|p
operator|.
name|aal5
operator|.
name|backward_max_SDU_size
operator|==
name|T_ATM_ABSENT
operator|)
operator|&&
operator|(
name|p
operator|.
name|aal5
operator|.
name|SSCS_type
operator|==
name|T_ATM_ABSENT
operator|)
condition|)
name|atp
operator|->
name|atp_attr
operator|.
name|aal
operator|.
name|tag
operator|=
name|T_ATM_ABSENT
expr_stmt|;
else|else
block|{
name|atp
operator|->
name|atp_attr
operator|.
name|aal
operator|.
name|tag
operator|=
name|T_ATM_PRESENT
expr_stmt|;
name|atp
operator|->
name|atp_attr
operator|.
name|aal
operator|.
name|type
operator|=
name|ATM_AAL5
expr_stmt|;
name|atp
operator|->
name|atp_attr
operator|.
name|aal
operator|.
name|v
operator|.
name|aal5
operator|=
name|p
operator|.
name|aal5
expr_stmt|;
block|}
break|break;
case|case
name|T_ATM_TRAFFIC
case|:
name|err
operator|=
name|sooptcopyin
argument_list|(
name|sopt
argument_list|,
operator|&
name|p
operator|.
name|trf
argument_list|,
sizeof|sizeof
name|p
operator|.
name|trf
argument_list|,
sizeof|sizeof
name|p
operator|.
name|trf
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
break|break;
if|if
condition|(
operator|(
name|p
operator|.
name|trf
operator|.
name|forward
operator|.
name|PCR_high_priority
operator|!=
name|T_ATM_ABSENT
operator|)
operator|&&
operator|(
name|p
operator|.
name|trf
operator|.
name|forward
operator|.
name|PCR_high_priority
operator|&
name|MAXMASK
argument_list|(
literal|24
argument_list|)
operator|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
name|p
operator|.
name|trf
operator|.
name|forward
operator|.
name|PCR_all_traffic
operator|&
name|MAXMASK
argument_list|(
literal|24
argument_list|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
operator|(
name|p
operator|.
name|trf
operator|.
name|forward
operator|.
name|SCR_high_priority
operator|!=
name|T_ATM_ABSENT
operator|)
operator|&&
operator|(
name|p
operator|.
name|trf
operator|.
name|forward
operator|.
name|SCR_high_priority
operator|&
name|MAXMASK
argument_list|(
literal|24
argument_list|)
operator|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
operator|(
name|p
operator|.
name|trf
operator|.
name|forward
operator|.
name|SCR_all_traffic
operator|!=
name|T_ATM_ABSENT
operator|)
operator|&&
operator|(
name|p
operator|.
name|trf
operator|.
name|forward
operator|.
name|SCR_all_traffic
operator|&
name|MAXMASK
argument_list|(
literal|24
argument_list|)
operator|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
operator|(
name|p
operator|.
name|trf
operator|.
name|forward
operator|.
name|MBS_high_priority
operator|!=
name|T_ATM_ABSENT
operator|)
operator|&&
operator|(
name|p
operator|.
name|trf
operator|.
name|forward
operator|.
name|MBS_high_priority
operator|&
name|MAXMASK
argument_list|(
literal|24
argument_list|)
operator|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
operator|(
name|p
operator|.
name|trf
operator|.
name|forward
operator|.
name|MBS_all_traffic
operator|!=
name|T_ATM_ABSENT
operator|)
operator|&&
operator|(
name|p
operator|.
name|trf
operator|.
name|forward
operator|.
name|MBS_all_traffic
operator|&
name|MAXMASK
argument_list|(
literal|24
argument_list|)
operator|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
operator|(
name|p
operator|.
name|trf
operator|.
name|forward
operator|.
name|tagging
operator|!=
name|T_YES
operator|)
operator|&&
operator|(
name|p
operator|.
name|trf
operator|.
name|forward
operator|.
name|tagging
operator|!=
name|T_NO
operator|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
operator|(
name|p
operator|.
name|trf
operator|.
name|backward
operator|.
name|PCR_high_priority
operator|!=
name|T_ATM_ABSENT
operator|)
operator|&&
operator|(
name|p
operator|.
name|trf
operator|.
name|backward
operator|.
name|PCR_high_priority
operator|&
name|MAXMASK
argument_list|(
literal|24
argument_list|)
operator|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
name|p
operator|.
name|trf
operator|.
name|backward
operator|.
name|PCR_all_traffic
operator|&
name|MAXMASK
argument_list|(
literal|24
argument_list|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
operator|(
name|p
operator|.
name|trf
operator|.
name|backward
operator|.
name|SCR_high_priority
operator|!=
name|T_ATM_ABSENT
operator|)
operator|&&
operator|(
name|p
operator|.
name|trf
operator|.
name|backward
operator|.
name|SCR_high_priority
operator|&
name|MAXMASK
argument_list|(
literal|24
argument_list|)
operator|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
operator|(
name|p
operator|.
name|trf
operator|.
name|backward
operator|.
name|SCR_all_traffic
operator|!=
name|T_ATM_ABSENT
operator|)
operator|&&
operator|(
name|p
operator|.
name|trf
operator|.
name|backward
operator|.
name|SCR_all_traffic
operator|&
name|MAXMASK
argument_list|(
literal|24
argument_list|)
operator|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
operator|(
name|p
operator|.
name|trf
operator|.
name|backward
operator|.
name|MBS_high_priority
operator|!=
name|T_ATM_ABSENT
operator|)
operator|&&
operator|(
name|p
operator|.
name|trf
operator|.
name|backward
operator|.
name|MBS_high_priority
operator|&
name|MAXMASK
argument_list|(
literal|24
argument_list|)
operator|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
operator|(
name|p
operator|.
name|trf
operator|.
name|backward
operator|.
name|MBS_all_traffic
operator|!=
name|T_ATM_ABSENT
operator|)
operator|&&
operator|(
name|p
operator|.
name|trf
operator|.
name|backward
operator|.
name|MBS_all_traffic
operator|&
name|MAXMASK
argument_list|(
literal|24
argument_list|)
operator|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
operator|(
name|p
operator|.
name|trf
operator|.
name|backward
operator|.
name|tagging
operator|!=
name|T_YES
operator|)
operator|&&
operator|(
name|p
operator|.
name|trf
operator|.
name|backward
operator|.
name|tagging
operator|!=
name|T_NO
operator|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
operator|(
name|p
operator|.
name|trf
operator|.
name|best_effort
operator|!=
name|T_YES
operator|)
operator|&&
operator|(
name|p
operator|.
name|trf
operator|.
name|best_effort
operator|!=
name|T_NO
operator|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|atp
operator|->
name|atp_attr
operator|.
name|traffic
operator|.
name|tag
operator|=
name|T_ATM_PRESENT
expr_stmt|;
name|atp
operator|->
name|atp_attr
operator|.
name|traffic
operator|.
name|v
operator|=
name|p
operator|.
name|trf
expr_stmt|;
break|break;
case|case
name|T_ATM_BEARER_CAP
case|:
name|err
operator|=
name|sooptcopyin
argument_list|(
name|sopt
argument_list|,
operator|&
name|p
operator|.
name|brr
argument_list|,
sizeof|sizeof
name|p
operator|.
name|brr
argument_list|,
sizeof|sizeof
name|p
operator|.
name|brr
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
break|break;
if|if
condition|(
operator|(
name|p
operator|.
name|brr
operator|.
name|bearer_class
operator|!=
name|T_ATM_CLASS_A
operator|)
operator|&&
operator|(
name|p
operator|.
name|brr
operator|.
name|bearer_class
operator|!=
name|T_ATM_CLASS_C
operator|)
operator|&&
operator|(
name|p
operator|.
name|brr
operator|.
name|bearer_class
operator|!=
name|T_ATM_CLASS_X
operator|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
operator|(
name|p
operator|.
name|brr
operator|.
name|traffic_type
operator|!=
name|T_ATM_NULL
operator|)
operator|&&
operator|(
name|p
operator|.
name|brr
operator|.
name|traffic_type
operator|!=
name|T_ATM_CBR
operator|)
operator|&&
operator|(
name|p
operator|.
name|brr
operator|.
name|traffic_type
operator|!=
name|T_ATM_VBR
operator|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
operator|(
name|p
operator|.
name|brr
operator|.
name|timing_requirements
operator|!=
name|T_ATM_NULL
operator|)
operator|&&
operator|(
name|p
operator|.
name|brr
operator|.
name|timing_requirements
operator|!=
name|T_ATM_END_TO_END
operator|)
operator|&&
operator|(
name|p
operator|.
name|brr
operator|.
name|timing_requirements
operator|!=
name|T_ATM_NO_END_TO_END
operator|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
operator|(
name|p
operator|.
name|brr
operator|.
name|clipping_susceptibility
operator|!=
name|T_NO
operator|)
operator|&&
operator|(
name|p
operator|.
name|brr
operator|.
name|clipping_susceptibility
operator|!=
name|T_YES
operator|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
operator|(
name|p
operator|.
name|brr
operator|.
name|connection_configuration
operator|!=
name|T_ATM_1_TO_1
operator|)
operator|&&
operator|(
name|p
operator|.
name|brr
operator|.
name|connection_configuration
operator|!=
name|T_ATM_1_TO_MANY
operator|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|atp
operator|->
name|atp_attr
operator|.
name|bearer
operator|.
name|tag
operator|=
name|T_ATM_PRESENT
expr_stmt|;
name|atp
operator|->
name|atp_attr
operator|.
name|bearer
operator|.
name|v
operator|=
name|p
operator|.
name|brr
expr_stmt|;
break|break;
case|case
name|T_ATM_BHLI
case|:
name|err
operator|=
name|sooptcopyin
argument_list|(
name|sopt
argument_list|,
operator|&
name|p
operator|.
name|bhl
argument_list|,
sizeof|sizeof
name|p
operator|.
name|bhl
argument_list|,
sizeof|sizeof
name|p
operator|.
name|bhl
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
break|break;
if|if
condition|(
operator|(
name|p
operator|.
name|bhl
operator|.
name|ID_type
operator|!=
name|T_ATM_ABSENT
operator|)
operator|&&
operator|(
name|p
operator|.
name|bhl
operator|.
name|ID_type
operator|!=
name|T_ATM_ISO_APP_ID
operator|)
operator|&&
operator|(
name|p
operator|.
name|bhl
operator|.
name|ID_type
operator|!=
name|T_ATM_USER_APP_ID
operator|)
operator|&&
operator|(
name|p
operator|.
name|bhl
operator|.
name|ID_type
operator|!=
name|T_ATM_VENDOR_APP_ID
operator|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
name|p
operator|.
name|bhl
operator|.
name|ID_type
operator|==
name|T_ATM_ABSENT
condition|)
name|atp
operator|->
name|atp_attr
operator|.
name|bhli
operator|.
name|tag
operator|=
name|T_ATM_ABSENT
expr_stmt|;
else|else
block|{
name|atp
operator|->
name|atp_attr
operator|.
name|bhli
operator|.
name|tag
operator|=
name|T_ATM_PRESENT
expr_stmt|;
name|atp
operator|->
name|atp_attr
operator|.
name|bhli
operator|.
name|v
operator|=
name|p
operator|.
name|bhl
expr_stmt|;
block|}
break|break;
case|case
name|T_ATM_BLLI
case|:
name|err
operator|=
name|sooptcopyin
argument_list|(
name|sopt
argument_list|,
operator|&
name|p
operator|.
name|bll
argument_list|,
sizeof|sizeof
name|p
operator|.
name|bll
argument_list|,
sizeof|sizeof
name|p
operator|.
name|bll
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
break|break;
if|if
condition|(
operator|(
name|p
operator|.
name|bll
operator|.
name|layer_2_protocol
operator|.
name|ID_type
operator|!=
name|T_ATM_ABSENT
operator|)
operator|&&
operator|(
name|p
operator|.
name|bll
operator|.
name|layer_2_protocol
operator|.
name|ID_type
operator|!=
name|T_ATM_SIMPLE_ID
operator|)
operator|&&
operator|(
name|p
operator|.
name|bll
operator|.
name|layer_2_protocol
operator|.
name|ID_type
operator|!=
name|T_ATM_USER_ID
operator|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
operator|(
name|p
operator|.
name|bll
operator|.
name|layer_2_protocol
operator|.
name|mode
operator|!=
name|T_ATM_ABSENT
operator|)
operator|&&
operator|(
name|p
operator|.
name|bll
operator|.
name|layer_2_protocol
operator|.
name|mode
operator|!=
name|T_ATM_BLLI_NORMAL_MODE
operator|)
operator|&&
operator|(
name|p
operator|.
name|bll
operator|.
name|layer_2_protocol
operator|.
name|mode
operator|!=
name|T_ATM_BLLI_EXTENDED_MODE
operator|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
operator|(
name|p
operator|.
name|bll
operator|.
name|layer_2_protocol
operator|.
name|window_size
operator|!=
name|T_ATM_ABSENT
operator|)
operator|&&
operator|(
name|p
operator|.
name|bll
operator|.
name|layer_2_protocol
operator|.
name|window_size
operator|<
literal|1
operator|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
operator|(
name|p
operator|.
name|bll
operator|.
name|layer_3_protocol
operator|.
name|ID_type
operator|!=
name|T_ATM_ABSENT
operator|)
operator|&&
operator|(
name|p
operator|.
name|bll
operator|.
name|layer_3_protocol
operator|.
name|ID_type
operator|!=
name|T_ATM_SIMPLE_ID
operator|)
operator|&&
operator|(
name|p
operator|.
name|bll
operator|.
name|layer_3_protocol
operator|.
name|ID_type
operator|!=
name|T_ATM_IPI_ID
operator|)
operator|&&
operator|(
name|p
operator|.
name|bll
operator|.
name|layer_3_protocol
operator|.
name|ID_type
operator|!=
name|T_ATM_SNAP_ID
operator|)
operator|&&
operator|(
name|p
operator|.
name|bll
operator|.
name|layer_3_protocol
operator|.
name|ID_type
operator|!=
name|T_ATM_USER_ID
operator|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
operator|(
name|p
operator|.
name|bll
operator|.
name|layer_3_protocol
operator|.
name|mode
operator|!=
name|T_ATM_ABSENT
operator|)
operator|&&
operator|(
name|p
operator|.
name|bll
operator|.
name|layer_3_protocol
operator|.
name|mode
operator|!=
name|T_ATM_BLLI_NORMAL_MODE
operator|)
operator|&&
operator|(
name|p
operator|.
name|bll
operator|.
name|layer_3_protocol
operator|.
name|mode
operator|!=
name|T_ATM_BLLI_EXTENDED_MODE
operator|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
operator|(
name|p
operator|.
name|bll
operator|.
name|layer_3_protocol
operator|.
name|packet_size
operator|!=
name|T_ATM_ABSENT
operator|)
operator|&&
operator|(
name|p
operator|.
name|bll
operator|.
name|layer_3_protocol
operator|.
name|packet_size
operator|&
name|MAXMASK
argument_list|(
literal|4
argument_list|)
operator|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
operator|(
name|p
operator|.
name|bll
operator|.
name|layer_3_protocol
operator|.
name|window_size
operator|!=
name|T_ATM_ABSENT
operator|)
operator|&&
operator|(
name|p
operator|.
name|bll
operator|.
name|layer_3_protocol
operator|.
name|window_size
operator|<
literal|1
operator|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
name|p
operator|.
name|bll
operator|.
name|layer_2_protocol
operator|.
name|ID_type
operator|==
name|T_ATM_ABSENT
condition|)
name|atp
operator|->
name|atp_attr
operator|.
name|blli
operator|.
name|tag_l2
operator|=
name|T_ATM_ABSENT
expr_stmt|;
else|else
name|atp
operator|->
name|atp_attr
operator|.
name|blli
operator|.
name|tag_l2
operator|=
name|T_ATM_PRESENT
expr_stmt|;
if|if
condition|(
name|p
operator|.
name|bll
operator|.
name|layer_3_protocol
operator|.
name|ID_type
operator|==
name|T_ATM_ABSENT
condition|)
name|atp
operator|->
name|atp_attr
operator|.
name|blli
operator|.
name|tag_l3
operator|=
name|T_ATM_ABSENT
expr_stmt|;
else|else
name|atp
operator|->
name|atp_attr
operator|.
name|blli
operator|.
name|tag_l3
operator|=
name|T_ATM_PRESENT
expr_stmt|;
if|if
condition|(
operator|(
name|atp
operator|->
name|atp_attr
operator|.
name|blli
operator|.
name|tag_l2
operator|==
name|T_ATM_PRESENT
operator|)
operator|||
operator|(
name|atp
operator|->
name|atp_attr
operator|.
name|blli
operator|.
name|tag_l3
operator|==
name|T_ATM_PRESENT
operator|)
condition|)
name|atp
operator|->
name|atp_attr
operator|.
name|blli
operator|.
name|v
operator|=
name|p
operator|.
name|bll
expr_stmt|;
break|break;
case|case
name|T_ATM_DEST_ADDR
case|:
name|err
operator|=
name|sooptcopyin
argument_list|(
name|sopt
argument_list|,
operator|&
name|p
operator|.
name|addr
argument_list|,
sizeof|sizeof
name|p
operator|.
name|addr
argument_list|,
sizeof|sizeof
name|p
operator|.
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
break|break;
if|if
condition|(
operator|(
name|p
operator|.
name|addr
operator|.
name|address_format
operator|!=
name|T_ATM_ENDSYS_ADDR
operator|)
operator|&&
operator|(
name|p
operator|.
name|addr
operator|.
name|address_format
operator|!=
name|T_ATM_E164_ADDR
operator|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
name|p
operator|.
name|addr
operator|.
name|address_length
operator|>
name|ATM_ADDR_LEN
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|atp
operator|->
name|atp_attr
operator|.
name|called
operator|.
name|tag
operator|=
name|T_ATM_PRESENT
expr_stmt|;
name|atp
operator|->
name|atp_attr
operator|.
name|called
operator|.
name|addr
operator|=
name|p
operator|.
name|addr
expr_stmt|;
break|break;
case|case
name|T_ATM_DEST_SUB
case|:
name|err
operator|=
name|sooptcopyin
argument_list|(
name|sopt
argument_list|,
operator|&
name|p
operator|.
name|addr
argument_list|,
sizeof|sizeof
name|p
operator|.
name|addr
argument_list|,
sizeof|sizeof
name|p
operator|.
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
break|break;
if|if
condition|(
operator|(
name|p
operator|.
name|addr
operator|.
name|address_format
operator|!=
name|T_ATM_ABSENT
operator|)
operator|&&
operator|(
name|p
operator|.
name|addr
operator|.
name|address_format
operator|!=
name|T_ATM_NSAP_ADDR
operator|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
name|p
operator|.
name|addr
operator|.
name|address_length
operator|>
name|ATM_ADDR_LEN
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
comment|/* T_ATM_DEST_ADDR controls tag */
name|atp
operator|->
name|atp_attr
operator|.
name|called
operator|.
name|subaddr
operator|=
name|p
operator|.
name|addr
expr_stmt|;
break|break;
case|case
name|T_ATM_ORIG_ADDR
case|:
return|return
operator|(
name|EACCES
operator|)
return|;
case|case
name|T_ATM_ORIG_SUB
case|:
return|return
operator|(
name|EACCES
operator|)
return|;
case|case
name|T_ATM_CALLER_ID
case|:
return|return
operator|(
name|EACCES
operator|)
return|;
case|case
name|T_ATM_CAUSE
case|:
name|err
operator|=
name|sooptcopyin
argument_list|(
name|sopt
argument_list|,
operator|&
name|p
operator|.
name|cau
argument_list|,
sizeof|sizeof
name|p
operator|.
name|cau
argument_list|,
sizeof|sizeof
name|p
operator|.
name|cau
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
break|break;
if|if
condition|(
operator|(
name|p
operator|.
name|cau
operator|.
name|coding_standard
operator|!=
name|T_ATM_ABSENT
operator|)
operator|&&
operator|(
name|p
operator|.
name|cau
operator|.
name|coding_standard
operator|!=
name|T_ATM_ITU_CODING
operator|)
operator|&&
operator|(
name|p
operator|.
name|cau
operator|.
name|coding_standard
operator|!=
name|T_ATM_NETWORK_CODING
operator|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
operator|(
name|p
operator|.
name|cau
operator|.
name|location
operator|!=
name|T_ATM_LOC_USER
operator|)
operator|&&
operator|(
name|p
operator|.
name|cau
operator|.
name|location
operator|!=
name|T_ATM_LOC_LOCAL_PRIVATE_NET
operator|)
operator|&&
operator|(
name|p
operator|.
name|cau
operator|.
name|location
operator|!=
name|T_ATM_LOC_LOCAL_PUBLIC_NET
operator|)
operator|&&
operator|(
name|p
operator|.
name|cau
operator|.
name|location
operator|!=
name|T_ATM_LOC_TRANSIT_NET
operator|)
operator|&&
operator|(
name|p
operator|.
name|cau
operator|.
name|location
operator|!=
name|T_ATM_LOC_REMOTE_PUBLIC_NET
operator|)
operator|&&
operator|(
name|p
operator|.
name|cau
operator|.
name|location
operator|!=
name|T_ATM_LOC_REMOTE_PRIVATE_NET
operator|)
operator|&&
operator|(
name|p
operator|.
name|cau
operator|.
name|location
operator|!=
name|T_ATM_LOC_INTERNATIONAL_NET
operator|)
operator|&&
operator|(
name|p
operator|.
name|cau
operator|.
name|location
operator|!=
name|T_ATM_LOC_BEYOND_INTERWORKING
operator|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
name|p
operator|.
name|cau
operator|.
name|coding_standard
operator|==
name|T_ATM_ABSENT
condition|)
name|atp
operator|->
name|atp_attr
operator|.
name|cause
operator|.
name|tag
operator|=
name|T_ATM_ABSENT
expr_stmt|;
else|else
block|{
name|atp
operator|->
name|atp_attr
operator|.
name|cause
operator|.
name|tag
operator|=
name|T_ATM_PRESENT
expr_stmt|;
name|atp
operator|->
name|atp_attr
operator|.
name|cause
operator|.
name|v
operator|=
name|p
operator|.
name|cau
expr_stmt|;
block|}
break|break;
case|case
name|T_ATM_QOS
case|:
name|err
operator|=
name|sooptcopyin
argument_list|(
name|sopt
argument_list|,
operator|&
name|p
operator|.
name|qos
argument_list|,
sizeof|sizeof
name|p
operator|.
name|qos
argument_list|,
sizeof|sizeof
name|p
operator|.
name|qos
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
break|break;
if|if
condition|(
operator|(
name|p
operator|.
name|qos
operator|.
name|coding_standard
operator|!=
name|T_ATM_ABSENT
operator|)
operator|&&
operator|(
name|p
operator|.
name|qos
operator|.
name|coding_standard
operator|!=
name|T_ATM_ITU_CODING
operator|)
operator|&&
operator|(
name|p
operator|.
name|qos
operator|.
name|coding_standard
operator|!=
name|T_ATM_NETWORK_CODING
operator|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
operator|(
name|p
operator|.
name|qos
operator|.
name|forward
operator|.
name|qos_class
operator|!=
name|T_ATM_QOS_CLASS_0
operator|)
operator|&&
operator|(
name|p
operator|.
name|qos
operator|.
name|forward
operator|.
name|qos_class
operator|!=
name|T_ATM_QOS_CLASS_1
operator|)
operator|&&
operator|(
name|p
operator|.
name|qos
operator|.
name|forward
operator|.
name|qos_class
operator|!=
name|T_ATM_QOS_CLASS_2
operator|)
operator|&&
operator|(
name|p
operator|.
name|qos
operator|.
name|forward
operator|.
name|qos_class
operator|!=
name|T_ATM_QOS_CLASS_3
operator|)
operator|&&
operator|(
name|p
operator|.
name|qos
operator|.
name|forward
operator|.
name|qos_class
operator|!=
name|T_ATM_QOS_CLASS_4
operator|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
operator|(
name|p
operator|.
name|qos
operator|.
name|backward
operator|.
name|qos_class
operator|!=
name|T_ATM_QOS_CLASS_0
operator|)
operator|&&
operator|(
name|p
operator|.
name|qos
operator|.
name|backward
operator|.
name|qos_class
operator|!=
name|T_ATM_QOS_CLASS_1
operator|)
operator|&&
operator|(
name|p
operator|.
name|qos
operator|.
name|backward
operator|.
name|qos_class
operator|!=
name|T_ATM_QOS_CLASS_2
operator|)
operator|&&
operator|(
name|p
operator|.
name|qos
operator|.
name|backward
operator|.
name|qos_class
operator|!=
name|T_ATM_QOS_CLASS_3
operator|)
operator|&&
operator|(
name|p
operator|.
name|qos
operator|.
name|backward
operator|.
name|qos_class
operator|!=
name|T_ATM_QOS_CLASS_4
operator|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
name|p
operator|.
name|qos
operator|.
name|coding_standard
operator|==
name|T_ATM_ABSENT
condition|)
name|atp
operator|->
name|atp_attr
operator|.
name|qos
operator|.
name|tag
operator|=
name|T_ATM_ABSENT
expr_stmt|;
else|else
block|{
name|atp
operator|->
name|atp_attr
operator|.
name|qos
operator|.
name|tag
operator|=
name|T_ATM_PRESENT
expr_stmt|;
name|atp
operator|->
name|atp_attr
operator|.
name|qos
operator|.
name|v
operator|=
name|p
operator|.
name|qos
expr_stmt|;
block|}
break|break;
case|case
name|T_ATM_TRANSIT
case|:
name|err
operator|=
name|sooptcopyin
argument_list|(
name|sopt
argument_list|,
operator|&
name|p
operator|.
name|trn
argument_list|,
sizeof|sizeof
name|p
operator|.
name|trn
argument_list|,
sizeof|sizeof
name|p
operator|.
name|trn
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
break|break;
if|if
condition|(
name|p
operator|.
name|trn
operator|.
name|length
operator|>
name|T_ATM_MAX_NET_ID
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
name|p
operator|.
name|trn
operator|.
name|length
operator|==
literal|0
condition|)
name|atp
operator|->
name|atp_attr
operator|.
name|transit
operator|.
name|tag
operator|=
name|T_ATM_ABSENT
expr_stmt|;
else|else
block|{
name|atp
operator|->
name|atp_attr
operator|.
name|transit
operator|.
name|tag
operator|=
name|T_ATM_PRESENT
expr_stmt|;
name|atp
operator|->
name|atp_attr
operator|.
name|transit
operator|.
name|v
operator|=
name|p
operator|.
name|trn
expr_stmt|;
block|}
break|break;
case|case
name|T_ATM_ADD_LEAF
case|:
return|return
operator|(
name|EPROTONOSUPPORT
operator|)
return|;
comment|/* XXX */
case|case
name|T_ATM_DROP_LEAF
case|:
return|return
operator|(
name|EPROTONOSUPPORT
operator|)
return|;
comment|/* XXX */
case|case
name|T_ATM_NET_INTF
case|:
name|err
operator|=
name|sooptcopyin
argument_list|(
name|sopt
argument_list|,
operator|&
name|p
operator|.
name|nif
argument_list|,
sizeof|sizeof
name|p
operator|.
name|nif
argument_list|,
sizeof|sizeof
name|p
operator|.
name|nif
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
break|break;
name|atp
operator|->
name|atp_attr
operator|.
name|nif
operator|=
name|atm_nifname
argument_list|(
name|p
operator|.
name|nif
operator|.
name|net_intf
argument_list|)
expr_stmt|;
if|if
condition|(
name|atp
operator|->
name|atp_attr
operator|.
name|nif
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
break|break;
case|case
name|T_ATM_LLC
case|:
name|err
operator|=
name|sooptcopyin
argument_list|(
name|sopt
argument_list|,
operator|&
name|p
operator|.
name|llc
argument_list|,
sizeof|sizeof
name|p
operator|.
name|llc
argument_list|,
sizeof|sizeof
name|p
operator|.
name|llc
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
break|break;
if|if
condition|(
operator|(
name|p
operator|.
name|llc
operator|.
name|llc_len
operator|<
name|T_ATM_LLC_MIN_LEN
operator|)
operator|||
operator|(
name|p
operator|.
name|llc
operator|.
name|llc_len
operator|>
name|T_ATM_LLC_MAX_LEN
operator|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|atp
operator|->
name|atp_attr
operator|.
name|llc
operator|.
name|tag
operator|=
name|T_ATM_PRESENT
expr_stmt|;
name|atp
operator|->
name|atp_attr
operator|.
name|llc
operator|.
name|v
operator|=
name|p
operator|.
name|llc
expr_stmt|;
break|break;
case|case
name|T_ATM_APP_NAME
case|:
name|err
operator|=
name|sooptcopyin
argument_list|(
name|sopt
argument_list|,
operator|&
name|p
operator|.
name|appn
argument_list|,
sizeof|sizeof
name|p
operator|.
name|appn
argument_list|,
sizeof|sizeof
name|p
operator|.
name|appn
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
break|break;
name|strncpy
argument_list|(
name|atp
operator|->
name|atp_name
argument_list|,
name|p
operator|.
name|appn
operator|.
name|app_name
argument_list|,
name|T_ATM_APP_NAME_LEN
argument_list|)
expr_stmt|;
break|break;
default|default:
return|return
operator|(
name|ENOPROTOOPT
operator|)
return|;
block|}
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Common getsockopt processing  *  * Called at splnet.  *  * Arguments:  *	so	pointer to socket  *	sopt	pointer to socket option info  *	atp	pointer to ATM PCB  *  * Returns:  *	0 	request processed  *	errno	error processing request - reason indicated  *  */
end_comment

begin_function
name|int
name|atm_sock_getopt
parameter_list|(
name|so
parameter_list|,
name|sopt
parameter_list|,
name|atp
parameter_list|)
name|struct
name|socket
modifier|*
name|so
decl_stmt|;
name|struct
name|sockopt
modifier|*
name|sopt
decl_stmt|;
name|Atm_pcb
modifier|*
name|atp
decl_stmt|;
block|{
name|Atm_attributes
modifier|*
name|ap
decl_stmt|;
comment|/* 	 * If socket is connected, return attributes for the VCC in use, 	 * otherwise just return what the user has setup so far. 	 */
if|if
condition|(
name|so
operator|->
name|so_state
operator|&
name|SS_ISCONNECTED
condition|)
name|ap
operator|=
operator|&
name|atp
operator|->
name|atp_conn
operator|->
name|co_connvc
operator|->
name|cvc_attr
expr_stmt|;
else|else
name|ap
operator|=
operator|&
name|atp
operator|->
name|atp_attr
expr_stmt|;
switch|switch
condition|(
name|sopt
operator|->
name|sopt_name
condition|)
block|{
case|case
name|T_ATM_AAL5
case|:
if|if
condition|(
operator|(
name|ap
operator|->
name|aal
operator|.
name|tag
operator|==
name|T_ATM_PRESENT
operator|)
operator|&&
operator|(
name|ap
operator|->
name|aal
operator|.
name|type
operator|==
name|ATM_AAL5
operator|)
condition|)
block|{
return|return
operator|(
name|sooptcopyout
argument_list|(
name|sopt
argument_list|,
operator|&
name|ap
operator|->
name|aal
operator|.
name|v
operator|.
name|aal5
argument_list|,
sizeof|sizeof
name|ap
operator|->
name|aal
operator|.
name|v
operator|.
name|aal5
argument_list|)
operator|)
return|;
block|}
else|else
block|{
return|return
operator|(
name|ENOENT
operator|)
return|;
block|}
break|break;
case|case
name|T_ATM_TRAFFIC
case|:
if|if
condition|(
name|ap
operator|->
name|traffic
operator|.
name|tag
operator|==
name|T_ATM_PRESENT
condition|)
block|{
return|return
operator|(
name|sooptcopyout
argument_list|(
name|sopt
argument_list|,
operator|&
name|ap
operator|->
name|traffic
operator|.
name|v
argument_list|,
sizeof|sizeof
name|ap
operator|->
name|traffic
operator|.
name|v
argument_list|)
operator|)
return|;
block|}
else|else
block|{
return|return
operator|(
name|ENOENT
operator|)
return|;
block|}
break|break;
case|case
name|T_ATM_BEARER_CAP
case|:
if|if
condition|(
name|ap
operator|->
name|bearer
operator|.
name|tag
operator|==
name|T_ATM_PRESENT
condition|)
block|{
return|return
operator|(
name|sooptcopyout
argument_list|(
name|sopt
argument_list|,
operator|&
name|ap
operator|->
name|bearer
operator|.
name|v
argument_list|,
sizeof|sizeof
name|ap
operator|->
name|bearer
operator|.
name|v
argument_list|)
operator|)
return|;
block|}
else|else
block|{
return|return
operator|(
name|ENOENT
operator|)
return|;
block|}
break|break;
case|case
name|T_ATM_BHLI
case|:
if|if
condition|(
name|ap
operator|->
name|bhli
operator|.
name|tag
operator|==
name|T_ATM_PRESENT
condition|)
block|{
return|return
operator|(
name|sooptcopyout
argument_list|(
name|sopt
argument_list|,
operator|&
name|ap
operator|->
name|bhli
operator|.
name|v
argument_list|,
sizeof|sizeof
name|ap
operator|->
name|bhli
operator|.
name|v
argument_list|)
operator|)
return|;
block|}
else|else
block|{
return|return
operator|(
name|ENOENT
operator|)
return|;
block|}
break|break;
case|case
name|T_ATM_BLLI
case|:
if|if
condition|(
operator|(
name|ap
operator|->
name|blli
operator|.
name|tag_l2
operator|==
name|T_ATM_PRESENT
operator|)
operator|||
operator|(
name|ap
operator|->
name|blli
operator|.
name|tag_l3
operator|==
name|T_ATM_PRESENT
operator|)
condition|)
block|{
return|return
operator|(
name|sooptcopyout
argument_list|(
name|sopt
argument_list|,
operator|&
name|ap
operator|->
name|blli
operator|.
name|v
argument_list|,
sizeof|sizeof
name|ap
operator|->
name|blli
operator|.
name|v
argument_list|)
operator|)
return|;
block|}
else|else
block|{
return|return
operator|(
name|ENOENT
operator|)
return|;
block|}
break|break;
case|case
name|T_ATM_DEST_ADDR
case|:
if|if
condition|(
name|ap
operator|->
name|called
operator|.
name|tag
operator|==
name|T_ATM_PRESENT
condition|)
block|{
return|return
operator|(
name|sooptcopyout
argument_list|(
name|sopt
argument_list|,
operator|&
name|ap
operator|->
name|called
operator|.
name|addr
argument_list|,
sizeof|sizeof
name|ap
operator|->
name|called
operator|.
name|addr
argument_list|)
operator|)
return|;
block|}
else|else
block|{
return|return
operator|(
name|ENOENT
operator|)
return|;
block|}
break|break;
case|case
name|T_ATM_DEST_SUB
case|:
if|if
condition|(
name|ap
operator|->
name|called
operator|.
name|tag
operator|==
name|T_ATM_PRESENT
condition|)
block|{
return|return
operator|(
name|sooptcopyout
argument_list|(
name|sopt
argument_list|,
operator|&
name|ap
operator|->
name|called
operator|.
name|subaddr
argument_list|,
sizeof|sizeof
name|ap
operator|->
name|called
operator|.
name|subaddr
argument_list|)
operator|)
return|;
block|}
else|else
block|{
return|return
operator|(
name|ENOENT
operator|)
return|;
block|}
break|break;
case|case
name|T_ATM_ORIG_ADDR
case|:
if|if
condition|(
name|ap
operator|->
name|calling
operator|.
name|tag
operator|==
name|T_ATM_PRESENT
condition|)
block|{
return|return
operator|(
name|sooptcopyout
argument_list|(
name|sopt
argument_list|,
operator|&
name|ap
operator|->
name|calling
operator|.
name|addr
argument_list|,
sizeof|sizeof
name|ap
operator|->
name|calling
operator|.
name|addr
argument_list|)
operator|)
return|;
block|}
else|else
block|{
return|return
operator|(
name|ENOENT
operator|)
return|;
block|}
break|break;
case|case
name|T_ATM_ORIG_SUB
case|:
if|if
condition|(
name|ap
operator|->
name|calling
operator|.
name|tag
operator|==
name|T_ATM_PRESENT
condition|)
block|{
return|return
operator|(
name|sooptcopyout
argument_list|(
name|sopt
argument_list|,
operator|&
name|ap
operator|->
name|calling
operator|.
name|subaddr
argument_list|,
sizeof|sizeof
name|ap
operator|->
name|calling
operator|.
name|subaddr
argument_list|)
operator|)
return|;
block|}
else|else
block|{
return|return
operator|(
name|ENOENT
operator|)
return|;
block|}
break|break;
case|case
name|T_ATM_CALLER_ID
case|:
if|if
condition|(
name|ap
operator|->
name|calling
operator|.
name|tag
operator|==
name|T_ATM_PRESENT
condition|)
block|{
return|return
operator|(
name|sooptcopyout
argument_list|(
name|sopt
argument_list|,
operator|&
name|ap
operator|->
name|calling
operator|.
name|cid
argument_list|,
sizeof|sizeof
name|ap
operator|->
name|calling
operator|.
name|cid
argument_list|)
operator|)
return|;
block|}
else|else
block|{
return|return
operator|(
name|ENOENT
operator|)
return|;
block|}
break|break;
case|case
name|T_ATM_CAUSE
case|:
if|if
condition|(
name|ap
operator|->
name|cause
operator|.
name|tag
operator|==
name|T_ATM_PRESENT
condition|)
block|{
return|return
operator|(
name|sooptcopyout
argument_list|(
name|sopt
argument_list|,
operator|&
name|ap
operator|->
name|cause
operator|.
name|v
argument_list|,
sizeof|sizeof
name|ap
operator|->
name|cause
operator|.
name|v
argument_list|)
operator|)
return|;
block|}
else|else
block|{
return|return
operator|(
name|ENOENT
operator|)
return|;
block|}
break|break;
case|case
name|T_ATM_QOS
case|:
if|if
condition|(
name|ap
operator|->
name|qos
operator|.
name|tag
operator|==
name|T_ATM_PRESENT
condition|)
block|{
return|return
operator|(
name|sooptcopyout
argument_list|(
name|sopt
argument_list|,
operator|&
name|ap
operator|->
name|qos
operator|.
name|v
argument_list|,
sizeof|sizeof
name|ap
operator|->
name|qos
operator|.
name|v
argument_list|)
operator|)
return|;
block|}
else|else
block|{
return|return
operator|(
name|ENOENT
operator|)
return|;
block|}
break|break;
case|case
name|T_ATM_TRANSIT
case|:
if|if
condition|(
name|ap
operator|->
name|transit
operator|.
name|tag
operator|==
name|T_ATM_PRESENT
condition|)
block|{
return|return
operator|(
name|sooptcopyout
argument_list|(
name|sopt
argument_list|,
operator|&
name|ap
operator|->
name|transit
operator|.
name|v
argument_list|,
sizeof|sizeof
name|ap
operator|->
name|transit
operator|.
name|v
argument_list|)
operator|)
return|;
block|}
else|else
block|{
return|return
operator|(
name|ENOENT
operator|)
return|;
block|}
break|break;
case|case
name|T_ATM_LEAF_IND
case|:
return|return
operator|(
name|EPROTONOSUPPORT
operator|)
return|;
comment|/* XXX */
case|case
name|T_ATM_NET_INTF
case|:
if|if
condition|(
name|ap
operator|->
name|nif
condition|)
block|{
name|struct
name|t_atm_net_intf
name|netif
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|ifp
operator|=
operator|&
name|ap
operator|->
name|nif
operator|->
name|nif_if
expr_stmt|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|netif
operator|.
name|net_intf
argument_list|,
literal|"%s%d"
argument_list|,
name|ifp
operator|->
name|if_name
argument_list|,
name|ifp
operator|->
name|if_unit
argument_list|)
expr_stmt|;
return|return
operator|(
name|sooptcopyout
argument_list|(
name|sopt
argument_list|,
operator|&
name|netif
argument_list|,
sizeof|sizeof
name|netif
argument_list|)
operator|)
return|;
block|}
else|else
block|{
return|return
operator|(
name|ENOENT
operator|)
return|;
block|}
break|break;
case|case
name|T_ATM_LLC
case|:
if|if
condition|(
name|ap
operator|->
name|llc
operator|.
name|tag
operator|==
name|T_ATM_PRESENT
condition|)
block|{
return|return
operator|(
name|sooptcopyout
argument_list|(
name|sopt
argument_list|,
operator|&
name|ap
operator|->
name|llc
operator|.
name|v
argument_list|,
sizeof|sizeof
name|ap
operator|->
name|llc
operator|.
name|v
argument_list|)
operator|)
return|;
block|}
else|else
block|{
return|return
operator|(
name|ENOENT
operator|)
return|;
block|}
break|break;
default|default:
return|return
operator|(
name|ENOPROTOOPT
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Process Socket VCC Connected Notification  *  * Arguments:  *	toku	owner's connection token (atm_pcb protocol block)  *  * Returns:  *	none  *  */
end_comment

begin_function
name|void
name|atm_sock_connected
parameter_list|(
name|toku
parameter_list|)
name|void
modifier|*
name|toku
decl_stmt|;
block|{
name|Atm_pcb
modifier|*
name|atp
init|=
operator|(
name|Atm_pcb
operator|*
operator|)
name|toku
decl_stmt|;
comment|/* 	 * Connection is setup 	 */
name|atm_sock_stat
operator|.
name|as_conncomp
index|[
name|atp
operator|->
name|atp_type
index|]
operator|++
expr_stmt|;
name|soisconnected
argument_list|(
name|atp
operator|->
name|atp_socket
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Process Socket VCC Cleared Notification  *  * Arguments:  *	toku	owner's connection token (atm_pcb protocol block)  *	cause	pointer to cause code  *  * Returns:  *	none  *  */
end_comment

begin_function
name|void
name|atm_sock_cleared
parameter_list|(
name|toku
parameter_list|,
name|cause
parameter_list|)
name|void
modifier|*
name|toku
decl_stmt|;
name|struct
name|t_atm_cause
modifier|*
name|cause
decl_stmt|;
block|{
name|Atm_pcb
modifier|*
name|atp
init|=
operator|(
name|Atm_pcb
operator|*
operator|)
name|toku
decl_stmt|;
name|struct
name|socket
modifier|*
name|so
decl_stmt|;
name|so
operator|=
name|atp
operator|->
name|atp_socket
expr_stmt|;
comment|/* 	 * Save call clearing cause 	 */
name|atp
operator|->
name|atp_attr
operator|.
name|cause
operator|.
name|tag
operator|=
name|T_ATM_PRESENT
expr_stmt|;
name|atp
operator|->
name|atp_attr
operator|.
name|cause
operator|.
name|v
operator|=
operator|*
name|cause
expr_stmt|;
comment|/* 	 * Set user error code 	 */
if|if
condition|(
name|so
operator|->
name|so_state
operator|&
name|SS_ISCONNECTED
condition|)
block|{
name|so
operator|->
name|so_error
operator|=
name|ECONNRESET
expr_stmt|;
name|atm_sock_stat
operator|.
name|as_connclr
index|[
name|atp
operator|->
name|atp_type
index|]
operator|++
expr_stmt|;
block|}
else|else
block|{
name|so
operator|->
name|so_error
operator|=
name|ECONNREFUSED
expr_stmt|;
name|atm_sock_stat
operator|.
name|as_connfail
index|[
name|atp
operator|->
name|atp_type
index|]
operator|++
expr_stmt|;
block|}
comment|/* 	 * Connection is gone 	 */
name|atp
operator|->
name|atp_conn
operator|=
name|NULL
expr_stmt|;
name|soisdisconnected
argument_list|(
name|so
argument_list|)
expr_stmt|;
comment|/* 	 * Cleanup failed incoming connection setup 	 */
if|if
condition|(
name|so
operator|->
name|so_state
operator|&
name|SS_NOFDREF
condition|)
block|{
operator|(
name|void
operator|)
name|atm_sock_detach
argument_list|(
name|so
argument_list|)
expr_stmt|;
block|}
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  *  * ===================================  * HARP  |  Host ATM Research Platform  * ===================================  *  *  * This Host ATM Research Platform ("HARP") file (the "Software") is  * made available by Network Computing Services, Inc. ("NetworkCS")  * "AS IS".  NetworkCS does not provide maintenance, improvements or  * support of any kind.  *  * NETWORKCS MAKES NO WARRANTIES OR REPRESENTATIONS, EXPRESS OR IMPLIED,  * INCLUDING, BUT NOT LIMITED TO, IMPLIED WARRANTIES OF MERCHANTABILITY  * AND FITNESS FOR A PARTICULAR PURPOSE, AS TO ANY ELEMENT OF THE  * SOFTWARE OR ANY SUPPORT PROVIDED IN CONNECTION WITH THIS SOFTWARE.  * In no event shall NetworkCS be responsible for any damages, including  * but not limited to consequential damages, arising from or relating to  * any use of the Software or related support.  *  * Copyright 1994-1998 Network Computing Services, Inc.  *  * Copies of this Software may be made, however, the above copyright  * notice must be reproduced on all copies.  *  *	@(#) $FreeBSD$  *  */
end_comment

begin_comment
comment|/*  * ATM Forum UNI 3.0/3.1 Signalling Manager  * ----------------------------------------  *  * Subroutines  *  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/errno.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/socketvar.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<netatm/port.h>
end_include

begin_include
include|#
directive|include
file|<netatm/queue.h>
end_include

begin_include
include|#
directive|include
file|<netatm/atm.h>
end_include

begin_include
include|#
directive|include
file|<netatm/atm_sys.h>
end_include

begin_include
include|#
directive|include
file|<netatm/atm_sap.h>
end_include

begin_include
include|#
directive|include
file|<netatm/atm_cm.h>
end_include

begin_include
include|#
directive|include
file|<netatm/atm_if.h>
end_include

begin_include
include|#
directive|include
file|<netatm/atm_vc.h>
end_include

begin_include
include|#
directive|include
file|<netatm/atm_sigmgr.h>
end_include

begin_include
include|#
directive|include
file|<netatm/atm_stack.h>
end_include

begin_include
include|#
directive|include
file|<netatm/atm_pcb.h>
end_include

begin_include
include|#
directive|include
file|<netatm/atm_var.h>
end_include

begin_include
include|#
directive|include
file|<netatm/uni/unisig_var.h>
end_include

begin_include
include|#
directive|include
file|<netatm/uni/unisig_msg.h>
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_expr_stmt
name|__RCSID
argument_list|(
literal|"@(#) $FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * External variables  */
end_comment

begin_decl_stmt
specifier|extern
name|struct
name|ie_aalp
name|ie_aalp_absent
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|struct
name|ie_clrt
name|ie_clrt_absent
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|struct
name|ie_bbcp
name|ie_bbcp_absent
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|struct
name|ie_bhli
name|ie_bhli_absent
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|struct
name|ie_blli
name|ie_blli_absent
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|struct
name|ie_clst
name|ie_clst_absent
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|struct
name|ie_cdad
name|ie_cdad_absent
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|struct
name|ie_cdsa
name|ie_cdsa_absent
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|struct
name|ie_cgad
name|ie_cgad_absent
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|struct
name|ie_cgsa
name|ie_cgsa_absent
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|struct
name|ie_caus
name|ie_caus_absent
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|struct
name|ie_cnid
name|ie_cnid_absent
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|struct
name|ie_qosp
name|ie_qosp_absent
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|struct
name|ie_brpi
name|ie_brpi_absent
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|struct
name|ie_rsti
name|ie_rsti_absent
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|struct
name|ie_blsh
name|ie_blsh_absent
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|struct
name|ie_bnsh
name|ie_bnsh_absent
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|struct
name|ie_bsdc
name|ie_bsdc_absent
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|struct
name|ie_trnt
name|ie_trnt_absent
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|struct
name|ie_eprf
name|ie_eprf_absent
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|struct
name|ie_epst
name|ie_epst_absent
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Set a User Location cause code in an ATM attribute block  *  * Arguments:  *	aap	pointer to attribute block  *	cause	cause code  *  * Returns:  *	none  *  */
end_comment

begin_function
name|void
name|unisig_cause_attr_from_user
parameter_list|(
name|aap
parameter_list|,
name|cause
parameter_list|)
name|Atm_attributes
modifier|*
name|aap
decl_stmt|;
name|int
name|cause
decl_stmt|;
block|{
if|if
condition|(
name|cause
operator|==
name|T_ATM_ABSENT
condition|)
return|return;
comment|/* 	 * Set the fields in the attribute block 	 */
name|aap
operator|->
name|cause
operator|.
name|tag
operator|=
name|T_ATM_PRESENT
expr_stmt|;
name|aap
operator|->
name|cause
operator|.
name|v
operator|.
name|coding_standard
operator|=
name|T_ATM_ITU_CODING
expr_stmt|;
name|aap
operator|->
name|cause
operator|.
name|v
operator|.
name|location
operator|=
name|T_ATM_LOC_USER
expr_stmt|;
name|aap
operator|->
name|cause
operator|.
name|v
operator|.
name|cause_value
operator|=
name|cause
expr_stmt|;
name|bzero
argument_list|(
name|aap
operator|->
name|cause
operator|.
name|v
operator|.
name|diagnostics
argument_list|,
sizeof|sizeof
argument_list|(
name|aap
operator|->
name|cause
operator|.
name|v
operator|.
name|diagnostics
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Set a cause code in an ATM attribute block from a Cause IE  *  * Arguments:  *	aap	pointer to attribute block  *	iep	pointer to Cause IE  *  * Returns:  *	none  *  */
end_comment

begin_function
name|void
name|unisig_cause_attr_from_ie
parameter_list|(
name|aap
parameter_list|,
name|iep
parameter_list|)
name|Atm_attributes
modifier|*
name|aap
decl_stmt|;
name|struct
name|ie_generic
modifier|*
name|iep
decl_stmt|;
block|{
comment|/* 	 * Set the fields in the attribute block 	 */
name|aap
operator|->
name|cause
operator|.
name|tag
operator|=
name|T_ATM_PRESENT
expr_stmt|;
name|aap
operator|->
name|cause
operator|.
name|v
operator|.
name|coding_standard
operator|=
name|iep
operator|->
name|ie_coding
expr_stmt|;
name|aap
operator|->
name|cause
operator|.
name|v
operator|.
name|location
operator|=
name|iep
operator|->
name|ie_caus_loc
expr_stmt|;
name|aap
operator|->
name|cause
operator|.
name|v
operator|.
name|cause_value
operator|=
name|iep
operator|->
name|ie_caus_cause
expr_stmt|;
name|bzero
argument_list|(
name|aap
operator|->
name|cause
operator|.
name|v
operator|.
name|diagnostics
argument_list|,
sizeof|sizeof
argument_list|(
name|aap
operator|->
name|cause
operator|.
name|v
operator|.
name|diagnostics
argument_list|)
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|iep
operator|->
name|ie_caus_diagnostic
argument_list|,
name|aap
operator|->
name|cause
operator|.
name|v
operator|.
name|diagnostics
argument_list|,
name|MIN
argument_list|(
sizeof|sizeof
argument_list|(
name|aap
operator|->
name|cause
operator|.
name|v
operator|.
name|diagnostics
argument_list|)
argument_list|,
name|iep
operator|->
name|ie_caus_diag_len
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Open a UNI VCC  *  * Called when a user wants to open a VC.  This function will construct  * a VCCB and, if we are opening an SVC, call the Q.2931 VC state  * machine.  The user will have to wait for a notify event to be sure  * the SVC is fully open.  *  * Must be called at splnet.  *  * Arguments:  *	usp	pointer to UNISIG protocol instance  *	cvp	pointer to connection parameters for the VCC  *  * Returns:  *	0	VCC creation successful  *	errno	VCC setup failed - reason indicated  *  */
end_comment

begin_function
name|int
name|unisig_open_vcc
parameter_list|(
name|usp
parameter_list|,
name|cvp
parameter_list|)
name|struct
name|unisig
modifier|*
name|usp
decl_stmt|;
name|Atm_connvc
modifier|*
name|cvp
decl_stmt|;
block|{
name|struct
name|atm_pif
modifier|*
name|pip
init|=
name|usp
operator|->
name|us_pif
decl_stmt|;
name|struct
name|unisig_vccb
modifier|*
name|uvp
decl_stmt|;
name|Atm_addr_pvc
modifier|*
name|pvp
decl_stmt|;
name|int
name|err
decl_stmt|,
name|pvc
decl_stmt|;
name|ATM_DEBUG2
argument_list|(
literal|"unisig_open_vcc: usp=%p, cvp=%p\n"
argument_list|,
name|usp
argument_list|,
name|cvp
argument_list|)
expr_stmt|;
comment|/* 	 * Validate user parameters.  AAL and encapsulation are 	 * checked by the connection manager 	 */
comment|/* 	 * Check called party address(es) 	 */
if|if
condition|(
name|cvp
operator|->
name|cvc_attr
operator|.
name|called
operator|.
name|tag
operator|!=
name|T_ATM_PRESENT
operator|||
name|cvp
operator|->
name|cvc_attr
operator|.
name|called
operator|.
name|addr
operator|.
name|address_format
operator|==
name|T_ATM_ABSENT
condition|)
block|{
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
switch|switch
condition|(
name|cvp
operator|->
name|cvc_attr
operator|.
name|called
operator|.
name|addr
operator|.
name|address_format
condition|)
block|{
case|case
name|T_ATM_PVC_ADDR
case|:
comment|/* 		 * Make sure VPI/VCI is valid 		 */
name|pvc
operator|=
literal|1
expr_stmt|;
name|pvp
operator|=
operator|(
name|Atm_addr_pvc
operator|*
operator|)
name|cvp
operator|->
name|cvc_attr
operator|.
name|called
operator|.
name|addr
operator|.
name|address
expr_stmt|;
if|if
condition|(
operator|(
name|ATM_PVC_GET_VPI
argument_list|(
name|pvp
argument_list|)
operator|>
name|pip
operator|->
name|pif_maxvpi
operator|)
operator|||
operator|(
name|ATM_PVC_GET_VCI
argument_list|(
name|pvp
argument_list|)
operator|==
literal|0
operator|)
operator|||
operator|(
name|ATM_PVC_GET_VCI
argument_list|(
name|pvp
argument_list|)
operator|>
name|pip
operator|->
name|pif_maxvci
operator|)
condition|)
block|{
return|return
operator|(
name|ERANGE
operator|)
return|;
block|}
comment|/* 		 * Make sure VPI/VCI is not already in use 		 */
if|if
condition|(
name|unisig_find_vpvc
argument_list|(
name|usp
argument_list|,
name|ATM_PVC_GET_VPI
argument_list|(
name|pvp
argument_list|)
argument_list|,
name|ATM_PVC_GET_VCI
argument_list|(
name|pvp
argument_list|)
argument_list|,
literal|0
argument_list|)
condition|)
block|{
return|return
operator|(
name|EEXIST
operator|)
return|;
block|}
name|ATM_DEBUG2
argument_list|(
literal|"unisig_open_vcc: VPI.VCI=%d.%d\n"
argument_list|,
name|ATM_PVC_GET_VPI
argument_list|(
name|pvp
argument_list|)
argument_list|,
name|ATM_PVC_GET_VCI
argument_list|(
name|pvp
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|T_ATM_ENDSYS_ADDR
case|:
comment|/* 		 * Check signalling state 		 */
name|pvc
operator|=
literal|0
expr_stmt|;
name|pvp
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|usp
operator|->
name|us_state
operator|!=
name|UNISIG_ACTIVE
condition|)
block|{
return|return
operator|(
name|ENETDOWN
operator|)
return|;
block|}
comment|/* 		 * Make sure there's no subaddress 		 */
if|if
condition|(
name|cvp
operator|->
name|cvc_attr
operator|.
name|called
operator|.
name|subaddr
operator|.
name|address_format
operator|!=
name|T_ATM_ABSENT
condition|)
block|{
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
break|break;
case|case
name|T_ATM_E164_ADDR
case|:
comment|/* 		 * Check signalling state 		 */
name|pvc
operator|=
literal|0
expr_stmt|;
name|pvp
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|usp
operator|->
name|us_state
operator|!=
name|UNISIG_ACTIVE
condition|)
block|{
return|return
operator|(
name|ENETDOWN
operator|)
return|;
block|}
comment|/* 		 * Check destination address format 		 */
if|if
condition|(
name|cvp
operator|->
name|cvc_attr
operator|.
name|called
operator|.
name|subaddr
operator|.
name|address_format
operator|!=
name|T_ATM_ENDSYS_ADDR
operator|&&
name|cvp
operator|->
name|cvc_attr
operator|.
name|called
operator|.
name|subaddr
operator|.
name|address_format
operator|!=
name|T_ATM_ABSENT
condition|)
block|{
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
break|break;
default|default:
return|return
operator|(
name|EPROTONOSUPPORT
operator|)
return|;
block|}
comment|/* 	 * Check that this is for the same interface UNISIG uses 	 */
if|if
condition|(
operator|!
name|cvp
operator|->
name|cvc_attr
operator|.
name|nif
operator|||
name|cvp
operator|->
name|cvc_attr
operator|.
name|nif
operator|->
name|nif_pif
operator|!=
name|usp
operator|->
name|us_pif
condition|)
block|{
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
comment|/* 	 * Allocate control block for VCC 	 */
name|uvp
operator|=
name|uma_zalloc
argument_list|(
name|unisig_vc_zone
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|uvp
operator|==
name|NULL
condition|)
block|{
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
comment|/* 	 * Fill in VCCB 	 */
if|if
condition|(
name|pvc
condition|)
block|{
name|uvp
operator|->
name|uv_type
operator|=
name|VCC_PVC
operator||
name|VCC_IN
operator||
name|VCC_OUT
expr_stmt|;
name|uvp
operator|->
name|uv_vpi
operator|=
name|ATM_PVC_GET_VPI
argument_list|(
name|pvp
argument_list|)
expr_stmt|;
name|uvp
operator|->
name|uv_vci
operator|=
name|ATM_PVC_GET_VCI
argument_list|(
name|pvp
argument_list|)
expr_stmt|;
name|uvp
operator|->
name|uv_sstate
operator|=
operator|(
name|usp
operator|->
name|us_state
operator|==
name|UNISIG_ACTIVE
condition|?
name|UNI_PVC_ACTIVE
else|:
name|UNI_PVC_ACT_DOWN
operator|)
expr_stmt|;
name|uvp
operator|->
name|uv_ustate
operator|=
name|VCCU_OPEN
expr_stmt|;
block|}
else|else
block|{
name|uvp
operator|->
name|uv_type
operator|=
name|VCC_SVC
operator||
name|VCC_IN
operator||
name|VCC_OUT
expr_stmt|;
name|uvp
operator|->
name|uv_sstate
operator|=
name|UNI_NULL
expr_stmt|;
name|uvp
operator|->
name|uv_ustate
operator|=
name|VCCU_POPEN
expr_stmt|;
block|}
name|uvp
operator|->
name|uv_proto
operator|=
name|usp
operator|->
name|us_pif
operator|->
name|pif_sigmgr
operator|->
name|sm_proto
expr_stmt|;
name|uvp
operator|->
name|uv_pif
operator|=
name|usp
operator|->
name|us_pif
expr_stmt|;
name|uvp
operator|->
name|uv_nif
operator|=
name|cvp
operator|->
name|cvc_attr
operator|.
name|nif
expr_stmt|;
name|uvp
operator|->
name|uv_connvc
operator|=
name|cvp
expr_stmt|;
name|uvp
operator|->
name|uv_tstamp
operator|=
name|time_second
expr_stmt|;
comment|/* 	 * Put VCCB on UNISIG queue 	 */
name|ENQUEUE
argument_list|(
name|uvp
argument_list|,
expr|struct
name|unisig_vccb
argument_list|,
name|uv_sigelem
argument_list|,
name|usp
operator|->
name|us_vccq
argument_list|)
expr_stmt|;
comment|/* 	 * Call the VC state machine if this is an SVC 	 */
if|if
condition|(
operator|!
name|pvc
condition|)
block|{
name|err
operator|=
name|unisig_vc_state
argument_list|(
name|usp
argument_list|,
name|uvp
argument_list|,
name|UNI_VC_SETUP_CALL
argument_list|,
operator|(
expr|struct
name|unisig_msg
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
comment|/* 			 * On error, delete the VCCB 			 */
name|DEQUEUE
argument_list|(
name|uvp
argument_list|,
expr|struct
name|unisig_vccb
argument_list|,
name|uv_sigelem
argument_list|,
name|usp
operator|->
name|us_vccq
argument_list|)
expr_stmt|;
name|uma_zfree
argument_list|(
name|unisig_vc_zone
argument_list|,
name|uvp
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
block|}
comment|/* 	 * Link VCCB to VCC connection block 	 */
name|cvp
operator|->
name|cvc_vcc
operator|=
operator|(
expr|struct
name|vccb
operator|*
operator|)
name|uvp
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Close a UNISIG VCC  *  * Called when a user wants to close a VCC.  This function will clean  * up the VCCB and, for an SVC, send a close request.  *  * Must be called at splnet.  *  * Arguments:  *	usp	pointer to UNISIG protocol instance  *	uvp	pointer to VCCB for the VCC to be closed  *  * Returns:  *	0	VCC is now closed  *	errno	error encountered  */
end_comment

begin_function
name|int
name|unisig_close_vcc
parameter_list|(
name|usp
parameter_list|,
name|uvp
parameter_list|)
name|struct
name|unisig
modifier|*
name|usp
decl_stmt|;
name|struct
name|unisig_vccb
modifier|*
name|uvp
decl_stmt|;
block|{
name|int
name|err
init|=
literal|0
decl_stmt|;
name|ATM_DEBUG2
argument_list|(
literal|"unisig_close_vcc: uvp=%p, state=%d\n"
argument_list|,
name|uvp
argument_list|,
name|uvp
operator|->
name|uv_sstate
argument_list|)
expr_stmt|;
comment|/* 	 * Check that this is for the same interface UNISIG uses 	 */
if|if
condition|(
name|uvp
operator|->
name|uv_pif
operator|!=
name|usp
operator|->
name|us_pif
condition|)
block|{
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
comment|/* 	 * Mark the close time. 	 */
name|uvp
operator|->
name|uv_tstamp
operator|=
name|time_second
expr_stmt|;
comment|/* 	 * Process based on the connection type 	 */
if|if
condition|(
name|uvp
operator|->
name|uv_type
operator|&
name|VCC_PVC
condition|)
block|{
name|uvp
operator|->
name|uv_sstate
operator|=
name|UNI_FREE
expr_stmt|;
name|uvp
operator|->
name|uv_ustate
operator|=
name|VCCU_CLOSED
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|uvp
operator|->
name|uv_type
operator|&
name|VCC_SVC
condition|)
block|{
comment|/* 		 * Call the VC state machine 		 */
name|uvp
operator|->
name|uv_ustate
operator|=
name|VCCU_CLOSED
expr_stmt|;
name|err
operator|=
name|unisig_vc_state
argument_list|(
name|usp
argument_list|,
name|uvp
argument_list|,
name|UNI_VC_RELEASE_CALL
argument_list|,
operator|(
expr|struct
name|unisig_msg
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Wait for user to free resources 	 */
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Clear a UNISIG VCC  *  * Called to internally clear a VCC.  No external protocol is  * initiated, the VCC is just closed and the owner is notified.  *  * Must be called at splnet.  *  * Arguments:  *	usp	pointer to UNISIG protocol instance  *	uvp	pointer to VCCB for the VCC to be closed  *	cause	cause code giving the reason for the close  *  * Returns:  *	0	VCC is closed  *	errno	error encountered  */
end_comment

begin_function
name|int
name|unisig_clear_vcc
parameter_list|(
name|usp
parameter_list|,
name|uvp
parameter_list|,
name|cause
parameter_list|)
name|struct
name|unisig
modifier|*
name|usp
decl_stmt|;
name|struct
name|unisig_vccb
modifier|*
name|uvp
decl_stmt|;
name|int
name|cause
decl_stmt|;
block|{
name|u_char
name|outstate
decl_stmt|;
name|ATM_DEBUG3
argument_list|(
literal|"unisig_clear_vcc: uvp=%p, state=%d, cause=%d\n"
argument_list|,
name|uvp
argument_list|,
name|uvp
operator|->
name|uv_sstate
argument_list|,
name|cause
argument_list|)
expr_stmt|;
comment|/* 	 * Check that this is for the same interface UNISIG uses 	 */
if|if
condition|(
name|uvp
operator|->
name|uv_pif
operator|!=
name|usp
operator|->
name|us_pif
condition|)
block|{
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
comment|/* 	 * Kill any possible timer 	 */
name|UNISIG_VC_CANCEL
argument_list|(
operator|(
expr|struct
name|vccb
operator|*
operator|)
name|uvp
argument_list|)
expr_stmt|;
comment|/* 	 * Mark the close time. 	 */
name|uvp
operator|->
name|uv_tstamp
operator|=
name|time_second
expr_stmt|;
comment|/* 	 * Close the VCC and notify the user 	 */
name|outstate
operator|=
name|uvp
operator|->
name|uv_sstate
expr_stmt|;
name|uvp
operator|->
name|uv_sstate
operator|=
name|UNI_FREE
expr_stmt|;
name|uvp
operator|->
name|uv_ustate
operator|=
name|VCCU_CLOSED
expr_stmt|;
if|if
condition|(
name|outstate
operator|==
name|UNI_ACTIVE
operator|||
name|outstate
operator|==
name|UNI_CALL_INITIATED
operator|||
name|outstate
operator|==
name|UNI_CALL_OUT_PROC
operator|||
name|outstate
operator|==
name|UNI_CONNECT_REQUEST
operator|||
name|outstate
operator|==
name|UNI_RELEASE_REQUEST
operator|||
name|outstate
operator|==
name|UNI_RELEASE_IND
operator|||
name|outstate
operator|==
name|UNI_SSCF_RECOV
operator|||
name|outstate
operator|==
name|UNI_PVC_ACT_DOWN
operator|||
name|outstate
operator|==
name|UNI_PVC_ACTIVE
condition|)
block|{
name|unisig_cause_attr_from_user
argument_list|(
operator|&
name|uvp
operator|->
name|uv_connvc
operator|->
name|cvc_attr
argument_list|,
name|cause
argument_list|)
expr_stmt|;
name|atm_cm_cleared
argument_list|(
name|uvp
operator|->
name|uv_connvc
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Wait for user to free resources 	 */
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|NOTDEF
end_ifdef

begin_comment
comment|/*  * Reset the switch state  *  * Arguments:  *	usp	pointer to UNISIG protocol instance  *  * Returns:  *	none  *  */
end_comment

begin_function
name|void
name|unisig_switch_reset
parameter_list|(
name|usp
parameter_list|,
name|cause
parameter_list|)
name|struct
name|unisig
modifier|*
name|usp
decl_stmt|;
name|int
name|cause
decl_stmt|;
block|{
name|int
name|s
decl_stmt|;
name|struct
name|unisig_vccb
modifier|*
name|uvp
decl_stmt|,
modifier|*
name|vnext
decl_stmt|;
name|ATM_DEBUG2
argument_list|(
literal|"unisig_switch_reset: usp=%p, cause=%d\n"
argument_list|,
name|usp
argument_list|,
name|cause
argument_list|)
expr_stmt|;
comment|/* 	 * Terminate all of our VCCs 	 */
name|s
operator|=
name|splnet
argument_list|()
expr_stmt|;
for|for
control|(
name|uvp
operator|=
name|Q_HEAD
argument_list|(
name|usp
operator|->
name|us_vccq
argument_list|,
expr|struct
name|unisig_vccb
argument_list|)
init|;
name|uvp
condition|;
name|uvp
operator|=
name|vnext
control|)
block|{
name|vnext
operator|=
name|Q_NEXT
argument_list|(
name|uvp
argument_list|,
expr|struct
name|unisig_vccb
argument_list|,
name|uv_sigelem
argument_list|)
expr_stmt|;
if|if
condition|(
name|uvp
operator|->
name|uv_type
operator|&
name|VCC_SVC
condition|)
block|{
comment|/* 			 * Close the SVC and notify the owner 			 */
operator|(
name|void
operator|)
name|unisig_clear_vcc
argument_list|(
name|usp
argument_list|,
name|uvp
argument_list|,
name|T_ATM_CAUSE_NORMAL_CALL_CLEARING
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|uvp
operator|->
name|uv_type
operator|&
name|VCC_PVC
condition|)
block|{
comment|/* 			 * Notify PVC owner of the state change 			 */
switch|switch
condition|(
name|cause
condition|)
block|{
case|case
name|UNI_DOWN
case|:
name|uvp
operator|->
name|uv_sstate
operator|=
name|UNI_PVC_ACT_DOWN
expr_stmt|;
break|break;
case|case
name|UNI_UP
case|:
name|uvp
operator|->
name|uv_sstate
operator|=
name|UNI_PVC_ACTIVE
expr_stmt|;
break|break;
block|}
name|atm_cm_cleared
argument_list|(
name|uvp
operator|->
name|uv_connvc
argument_list|,
name|cause
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"unisig: invalid VCC type: vccb=%p, type=%d\n"
argument_list|,
name|uvp
argument_list|,
name|uvp
operator|->
name|uv_type
argument_list|)
expr_stmt|;
block|}
block|}
operator|(
name|void
operator|)
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * Copy connection parameters from UNI 3.0 message IEs into  * an attribute block  *  * Arguments:  *	usp	pointer to UNISIG protocol instance  *	msg	pointer to the SETUP message  *	ap	pointer to the attribute block  *  * Returns:  *	none  *  */
end_comment

begin_function
name|void
name|unisig_save_attrs
parameter_list|(
name|usp
parameter_list|,
name|msg
parameter_list|,
name|ap
parameter_list|)
name|struct
name|unisig
modifier|*
name|usp
decl_stmt|;
name|struct
name|unisig_msg
modifier|*
name|msg
decl_stmt|;
name|Atm_attributes
modifier|*
name|ap
decl_stmt|;
block|{
comment|/* 	 * Sanity check 	 */
if|if
condition|(
operator|!
name|msg
operator|||
operator|!
name|ap
condition|)
return|return;
comment|/* 	 * Save the AAL parameters (AAL 3/4 and AAL 5 only) 	 */
if|if
condition|(
name|msg
operator|->
name|msg_ie_aalp
condition|)
block|{
name|struct
name|ie_generic
modifier|*
name|aalp
init|=
name|msg
operator|->
name|msg_ie_aalp
decl_stmt|;
switch|switch
condition|(
name|msg
operator|->
name|msg_ie_aalp
operator|->
name|ie_aalp_aal_type
condition|)
block|{
case|case
name|UNI_IE_AALP_AT_AAL3
case|:
name|ap
operator|->
name|aal
operator|.
name|tag
operator|=
name|T_ATM_PRESENT
expr_stmt|;
name|ap
operator|->
name|aal
operator|.
name|type
operator|=
name|msg
operator|->
name|msg_ie_aalp
operator|->
name|ie_aalp_aal_type
expr_stmt|;
name|ap
operator|->
name|aal
operator|.
name|v
operator|.
name|aal4
operator|.
name|forward_max_SDU_size
operator|=
name|msg
operator|->
name|msg_ie_aalp
operator|->
name|ie_aalp_4_fwd_max_sdu
expr_stmt|;
name|ap
operator|->
name|aal
operator|.
name|v
operator|.
name|aal4
operator|.
name|backward_max_SDU_size
operator|=
name|msg
operator|->
name|msg_ie_aalp
operator|->
name|ie_aalp_4_bkwd_max_sdu
expr_stmt|;
name|ap
operator|->
name|aal
operator|.
name|v
operator|.
name|aal4
operator|.
name|SSCS_type
operator|=
name|msg
operator|->
name|msg_ie_aalp
operator|->
name|ie_aalp_4_sscs_type
expr_stmt|;
if|if
condition|(
name|aalp
operator|->
name|ie_aalp_4_mid_range
operator|==
name|T_ATM_ABSENT
condition|)
block|{
name|ap
operator|->
name|aal
operator|.
name|v
operator|.
name|aal4
operator|.
name|mid_low
operator|=
name|T_ATM_ABSENT
expr_stmt|;
name|ap
operator|->
name|aal
operator|.
name|v
operator|.
name|aal4
operator|.
name|mid_high
operator|=
name|T_ATM_ABSENT
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|usp
operator|->
name|us_proto
operator|==
name|ATM_SIG_UNI30
condition|)
block|{
name|ap
operator|->
name|aal
operator|.
name|v
operator|.
name|aal4
operator|.
name|mid_low
operator|=
literal|0
expr_stmt|;
name|ap
operator|->
name|aal
operator|.
name|v
operator|.
name|aal4
operator|.
name|mid_high
operator|=
name|aalp
operator|->
name|ie_aalp_4_mid_range
operator|&
name|UNI_IE_AALP_A3_R_MASK
expr_stmt|;
block|}
else|else
block|{
name|ap
operator|->
name|aal
operator|.
name|v
operator|.
name|aal4
operator|.
name|mid_low
operator|=
operator|(
name|aalp
operator|->
name|ie_aalp_4_mid_range
operator|>>
name|UNI_IE_AALP_A3_R_SHIFT
operator|)
operator|&
name|UNI_IE_AALP_A3_R_MASK
expr_stmt|;
name|ap
operator|->
name|aal
operator|.
name|v
operator|.
name|aal4
operator|.
name|mid_high
operator|=
name|aalp
operator|->
name|ie_aalp_4_mid_range
operator|&
name|UNI_IE_AALP_A3_R_MASK
expr_stmt|;
block|}
block|}
break|break;
case|case
name|UNI_IE_AALP_AT_AAL5
case|:
name|ap
operator|->
name|aal
operator|.
name|tag
operator|=
name|T_ATM_PRESENT
expr_stmt|;
name|ap
operator|->
name|aal
operator|.
name|type
operator|=
name|msg
operator|->
name|msg_ie_aalp
operator|->
name|ie_aalp_aal_type
expr_stmt|;
name|ap
operator|->
name|aal
operator|.
name|v
operator|.
name|aal5
operator|.
name|forward_max_SDU_size
operator|=
name|msg
operator|->
name|msg_ie_aalp
operator|->
name|ie_aalp_5_fwd_max_sdu
expr_stmt|;
name|ap
operator|->
name|aal
operator|.
name|v
operator|.
name|aal5
operator|.
name|backward_max_SDU_size
operator|=
name|msg
operator|->
name|msg_ie_aalp
operator|->
name|ie_aalp_5_bkwd_max_sdu
expr_stmt|;
name|ap
operator|->
name|aal
operator|.
name|v
operator|.
name|aal5
operator|.
name|SSCS_type
operator|=
name|msg
operator|->
name|msg_ie_aalp
operator|->
name|ie_aalp_5_sscs_type
expr_stmt|;
break|break;
block|}
block|}
comment|/* 	 * Save traffic descriptor attributes 	 */
if|if
condition|(
name|msg
operator|->
name|msg_ie_clrt
condition|)
block|{
name|ap
operator|->
name|traffic
operator|.
name|tag
operator|=
name|T_ATM_PRESENT
expr_stmt|;
name|ap
operator|->
name|traffic
operator|.
name|v
operator|.
name|forward
operator|.
name|PCR_high_priority
operator|=
name|msg
operator|->
name|msg_ie_clrt
operator|->
name|ie_clrt_fwd_peak
expr_stmt|;
name|ap
operator|->
name|traffic
operator|.
name|v
operator|.
name|forward
operator|.
name|PCR_all_traffic
operator|=
name|msg
operator|->
name|msg_ie_clrt
operator|->
name|ie_clrt_fwd_peak_01
expr_stmt|;
name|ap
operator|->
name|traffic
operator|.
name|v
operator|.
name|forward
operator|.
name|SCR_high_priority
operator|=
name|msg
operator|->
name|msg_ie_clrt
operator|->
name|ie_clrt_fwd_sust
expr_stmt|;
name|ap
operator|->
name|traffic
operator|.
name|v
operator|.
name|forward
operator|.
name|SCR_all_traffic
operator|=
name|msg
operator|->
name|msg_ie_clrt
operator|->
name|ie_clrt_fwd_sust_01
expr_stmt|;
name|ap
operator|->
name|traffic
operator|.
name|v
operator|.
name|forward
operator|.
name|MBS_high_priority
operator|=
name|msg
operator|->
name|msg_ie_clrt
operator|->
name|ie_clrt_fwd_burst
expr_stmt|;
name|ap
operator|->
name|traffic
operator|.
name|v
operator|.
name|forward
operator|.
name|MBS_all_traffic
operator|=
name|msg
operator|->
name|msg_ie_clrt
operator|->
name|ie_clrt_fwd_burst_01
expr_stmt|;
name|ap
operator|->
name|traffic
operator|.
name|v
operator|.
name|backward
operator|.
name|PCR_high_priority
operator|=
name|msg
operator|->
name|msg_ie_clrt
operator|->
name|ie_clrt_bkwd_peak
expr_stmt|;
name|ap
operator|->
name|traffic
operator|.
name|v
operator|.
name|backward
operator|.
name|PCR_all_traffic
operator|=
name|msg
operator|->
name|msg_ie_clrt
operator|->
name|ie_clrt_bkwd_peak_01
expr_stmt|;
name|ap
operator|->
name|traffic
operator|.
name|v
operator|.
name|backward
operator|.
name|SCR_high_priority
operator|=
name|msg
operator|->
name|msg_ie_clrt
operator|->
name|ie_clrt_bkwd_sust
expr_stmt|;
name|ap
operator|->
name|traffic
operator|.
name|v
operator|.
name|backward
operator|.
name|SCR_all_traffic
operator|=
name|msg
operator|->
name|msg_ie_clrt
operator|->
name|ie_clrt_bkwd_sust_01
expr_stmt|;
name|ap
operator|->
name|traffic
operator|.
name|v
operator|.
name|backward
operator|.
name|MBS_high_priority
operator|=
name|msg
operator|->
name|msg_ie_clrt
operator|->
name|ie_clrt_bkwd_burst
expr_stmt|;
name|ap
operator|->
name|traffic
operator|.
name|v
operator|.
name|backward
operator|.
name|MBS_all_traffic
operator|=
name|msg
operator|->
name|msg_ie_clrt
operator|->
name|ie_clrt_bkwd_burst_01
expr_stmt|;
name|ap
operator|->
name|traffic
operator|.
name|v
operator|.
name|best_effort
operator|=
name|msg
operator|->
name|msg_ie_clrt
operator|->
name|ie_clrt_best_effort
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|msg_ie_clrt
operator|->
name|ie_clrt_tm_options
operator|==
name|T_ATM_ABSENT
condition|)
block|{
name|ap
operator|->
name|traffic
operator|.
name|v
operator|.
name|forward
operator|.
name|tagging
operator|=
name|T_NO
expr_stmt|;
name|ap
operator|->
name|traffic
operator|.
name|v
operator|.
name|backward
operator|.
name|tagging
operator|=
name|T_NO
expr_stmt|;
block|}
else|else
block|{
name|ap
operator|->
name|traffic
operator|.
name|v
operator|.
name|forward
operator|.
name|tagging
operator|=
operator|(
name|msg
operator|->
name|msg_ie_clrt
operator|->
name|ie_clrt_tm_options
operator|&
name|UNI_IE_CLRT_TM_FWD_TAG
operator|)
operator|!=
literal|0
expr_stmt|;
name|ap
operator|->
name|traffic
operator|.
name|v
operator|.
name|backward
operator|.
name|tagging
operator|=
operator|(
name|msg
operator|->
name|msg_ie_clrt
operator|->
name|ie_clrt_tm_options
operator|&
name|UNI_IE_CLRT_TM_BKWD_TAG
operator|)
operator|!=
literal|0
expr_stmt|;
block|}
block|}
comment|/* 	 * Save broadband bearer attributes 	 */
if|if
condition|(
name|msg
operator|->
name|msg_ie_bbcp
condition|)
block|{
name|ap
operator|->
name|bearer
operator|.
name|tag
operator|=
name|T_ATM_PRESENT
expr_stmt|;
name|ap
operator|->
name|bearer
operator|.
name|v
operator|.
name|bearer_class
operator|=
name|msg
operator|->
name|msg_ie_bbcp
operator|->
name|ie_bbcp_bearer_class
expr_stmt|;
name|ap
operator|->
name|bearer
operator|.
name|v
operator|.
name|traffic_type
operator|=
name|msg
operator|->
name|msg_ie_bbcp
operator|->
name|ie_bbcp_traffic_type
expr_stmt|;
name|ap
operator|->
name|bearer
operator|.
name|v
operator|.
name|timing_requirements
operator|=
name|msg
operator|->
name|msg_ie_bbcp
operator|->
name|ie_bbcp_timing_req
expr_stmt|;
name|ap
operator|->
name|bearer
operator|.
name|v
operator|.
name|clipping_susceptibility
operator|=
name|msg
operator|->
name|msg_ie_bbcp
operator|->
name|ie_bbcp_clipping
expr_stmt|;
name|ap
operator|->
name|bearer
operator|.
name|v
operator|.
name|connection_configuration
operator|=
name|msg
operator|->
name|msg_ie_bbcp
operator|->
name|ie_bbcp_conn_config
expr_stmt|;
block|}
comment|/* 	 * Save broadband high layer attributes 	 */
if|if
condition|(
name|msg
operator|->
name|msg_ie_bhli
condition|)
block|{
name|ap
operator|->
name|bhli
operator|.
name|tag
operator|=
name|T_ATM_PRESENT
expr_stmt|;
name|ap
operator|->
name|bhli
operator|.
name|v
operator|.
name|ID_type
operator|=
name|msg
operator|->
name|msg_ie_bhli
operator|->
name|ie_bhli_type
expr_stmt|;
switch|switch
condition|(
name|ap
operator|->
name|bhli
operator|.
name|v
operator|.
name|ID_type
condition|)
block|{
case|case
name|T_ATM_ISO_APP_ID
case|:
name|bcopy
argument_list|(
name|msg
operator|->
name|msg_ie_bhli
operator|->
name|ie_bhli_info
argument_list|,
name|ap
operator|->
name|bhli
operator|.
name|v
operator|.
name|ID
operator|.
name|ISO_ID
argument_list|,
sizeof|sizeof
argument_list|(
name|ap
operator|->
name|bhli
operator|.
name|v
operator|.
name|ID
operator|.
name|ISO_ID
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|T_ATM_USER_APP_ID
case|:
name|bcopy
argument_list|(
name|msg
operator|->
name|msg_ie_bhli
operator|->
name|ie_bhli_info
argument_list|,
name|ap
operator|->
name|bhli
operator|.
name|v
operator|.
name|ID
operator|.
name|user_defined_ID
argument_list|,
sizeof|sizeof
argument_list|(
name|ap
operator|->
name|bhli
operator|.
name|v
operator|.
name|ID
operator|.
name|user_defined_ID
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|T_ATM_VENDOR_APP_ID
case|:
name|bcopy
argument_list|(
name|msg
operator|->
name|msg_ie_bhli
operator|->
name|ie_bhli_info
argument_list|,
name|ap
operator|->
name|bhli
operator|.
name|v
operator|.
name|ID
operator|.
name|vendor_ID
operator|.
name|OUI
argument_list|,
sizeof|sizeof
argument_list|(
name|ap
operator|->
name|bhli
operator|.
name|v
operator|.
name|ID
operator|.
name|vendor_ID
operator|.
name|OUI
argument_list|)
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|&
name|msg
operator|->
name|msg_ie_bhli
operator|->
name|ie_bhli_info
index|[
sizeof|sizeof
argument_list|(
name|ap
operator|->
name|bhli
operator|.
name|v
operator|.
name|ID
operator|.
name|vendor_ID
operator|.
name|OUI
argument_list|)
operator|-
literal|1
index|]
argument_list|,
name|ap
operator|->
name|bhli
operator|.
name|v
operator|.
name|ID
operator|.
name|vendor_ID
operator|.
name|app_ID
argument_list|,
sizeof|sizeof
argument_list|(
name|ap
operator|->
name|bhli
operator|.
name|v
operator|.
name|ID
operator|.
name|vendor_ID
operator|.
name|app_ID
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
comment|/* 	 * Save Broadband low layer, user layer 2 and 3 attributes 	 */
if|if
condition|(
name|msg
operator|->
name|msg_ie_blli
condition|)
block|{
comment|/* 		 * Layer 2 parameters 		 */
switch|switch
condition|(
name|msg
operator|->
name|msg_ie_blli
operator|->
name|ie_blli_l2_id
condition|)
block|{
case|case
name|UNI_IE_BLLI_L2P_ISO1745
case|:
case|case
name|UNI_IE_BLLI_L2P_Q921
case|:
case|case
name|UNI_IE_BLLI_L2P_X25L
case|:
case|case
name|UNI_IE_BLLI_L2P_X25M
case|:
case|case
name|UNI_IE_BLLI_L2P_LAPB
case|:
case|case
name|UNI_IE_BLLI_L2P_HDLC1
case|:
case|case
name|UNI_IE_BLLI_L2P_HDLC2
case|:
case|case
name|UNI_IE_BLLI_L2P_HDLC3
case|:
case|case
name|UNI_IE_BLLI_L2P_LLC
case|:
case|case
name|UNI_IE_BLLI_L2P_X75
case|:
case|case
name|UNI_IE_BLLI_L2P_Q922
case|:
case|case
name|UNI_IE_BLLI_L2P_ISO7776
case|:
name|ap
operator|->
name|blli
operator|.
name|tag_l2
operator|=
name|T_ATM_PRESENT
expr_stmt|;
name|ap
operator|->
name|blli
operator|.
name|v
operator|.
name|layer_2_protocol
operator|.
name|ID_type
operator|=
name|T_ATM_SIMPLE_ID
expr_stmt|;
name|ap
operator|->
name|blli
operator|.
name|v
operator|.
name|layer_2_protocol
operator|.
name|ID
operator|.
name|simple_ID
operator|=
name|msg
operator|->
name|msg_ie_blli
operator|->
name|ie_blli_l2_id
expr_stmt|;
break|break;
case|case
name|UNI_IE_BLLI_L2P_USER
case|:
name|ap
operator|->
name|blli
operator|.
name|tag_l2
operator|=
name|T_ATM_PRESENT
expr_stmt|;
name|ap
operator|->
name|blli
operator|.
name|v
operator|.
name|layer_2_protocol
operator|.
name|ID_type
operator|=
name|T_ATM_USER_ID
expr_stmt|;
name|ap
operator|->
name|blli
operator|.
name|v
operator|.
name|layer_2_protocol
operator|.
name|ID
operator|.
name|user_defined_ID
operator|=
name|msg
operator|->
name|msg_ie_blli
operator|->
name|ie_blli_l2_user_proto
expr_stmt|;
break|break;
default|default:
name|ap
operator|->
name|blli
operator|.
name|tag_l2
operator|=
name|T_ATM_ABSENT
expr_stmt|;
block|}
if|if
condition|(
name|ap
operator|->
name|blli
operator|.
name|tag_l2
operator|==
name|T_ATM_PRESENT
condition|)
block|{
name|ap
operator|->
name|blli
operator|.
name|v
operator|.
name|layer_2_protocol
operator|.
name|mode
operator|=
name|msg
operator|->
name|msg_ie_blli
operator|->
name|ie_blli_l2_mode
expr_stmt|;
name|ap
operator|->
name|blli
operator|.
name|v
operator|.
name|layer_2_protocol
operator|.
name|window_size
operator|=
name|msg
operator|->
name|msg_ie_blli
operator|->
name|ie_blli_l2_window
expr_stmt|;
block|}
comment|/* 		 * Layer 3 parameters 		 */
switch|switch
condition|(
name|msg
operator|->
name|msg_ie_blli
operator|->
name|ie_blli_l3_id
condition|)
block|{
case|case
name|UNI_IE_BLLI_L3P_X25
case|:
case|case
name|UNI_IE_BLLI_L3P_ISO8208
case|:
case|case
name|UNI_IE_BLLI_L3P_ISO8878
case|:
case|case
name|UNI_IE_BLLI_L3P_ISO8473
case|:
case|case
name|UNI_IE_BLLI_L3P_T70
case|:
name|ap
operator|->
name|blli
operator|.
name|tag_l3
operator|=
name|T_ATM_PRESENT
expr_stmt|;
name|ap
operator|->
name|blli
operator|.
name|v
operator|.
name|layer_3_protocol
operator|.
name|ID_type
operator|=
name|T_ATM_SIMPLE_ID
expr_stmt|;
name|ap
operator|->
name|blli
operator|.
name|v
operator|.
name|layer_3_protocol
operator|.
name|ID
operator|.
name|simple_ID
operator|=
name|msg
operator|->
name|msg_ie_blli
operator|->
name|ie_blli_l3_id
expr_stmt|;
break|break;
case|case
name|UNI_IE_BLLI_L3P_ISO9577
case|:
name|ap
operator|->
name|blli
operator|.
name|tag_l3
operator|=
name|T_ATM_PRESENT
expr_stmt|;
name|ap
operator|->
name|blli
operator|.
name|v
operator|.
name|layer_3_protocol
operator|.
name|ID_type
operator|=
name|T_ATM_SIMPLE_ID
expr_stmt|;
name|ap
operator|->
name|blli
operator|.
name|v
operator|.
name|layer_3_protocol
operator|.
name|ID
operator|.
name|simple_ID
operator|=
name|msg
operator|->
name|msg_ie_blli
operator|->
name|ie_blli_l3_id
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|msg_ie_blli
operator|->
name|ie_blli_l3_ipi
operator|==
name|UNI_IE_BLLI_L3IPI_SNAP
condition|)
block|{
name|bcopy
argument_list|(
name|msg
operator|->
name|msg_ie_blli
operator|->
name|ie_blli_l3_oui
argument_list|,
name|ap
operator|->
name|blli
operator|.
name|v
operator|.
name|layer_3_protocol
operator|.
name|ID
operator|.
name|SNAP_ID
operator|.
name|OUI
argument_list|,
sizeof|sizeof
argument_list|(
name|ap
operator|->
name|blli
operator|.
name|v
operator|.
name|layer_3_protocol
operator|.
name|ID
operator|.
name|SNAP_ID
operator|.
name|OUI
argument_list|)
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|msg
operator|->
name|msg_ie_blli
operator|->
name|ie_blli_l3_pid
argument_list|,
name|ap
operator|->
name|blli
operator|.
name|v
operator|.
name|layer_3_protocol
operator|.
name|ID
operator|.
name|SNAP_ID
operator|.
name|PID
argument_list|,
sizeof|sizeof
argument_list|(
name|ap
operator|->
name|blli
operator|.
name|v
operator|.
name|layer_3_protocol
operator|.
name|ID
operator|.
name|SNAP_ID
operator|.
name|PID
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ap
operator|->
name|blli
operator|.
name|v
operator|.
name|layer_3_protocol
operator|.
name|ID
operator|.
name|IPI_ID
operator|=
name|msg
operator|->
name|msg_ie_blli
operator|->
name|ie_blli_l3_ipi
expr_stmt|;
block|}
break|break;
case|case
name|UNI_IE_BLLI_L3P_USER
case|:
name|ap
operator|->
name|blli
operator|.
name|tag_l3
operator|=
name|T_ATM_PRESENT
expr_stmt|;
name|ap
operator|->
name|blli
operator|.
name|v
operator|.
name|layer_3_protocol
operator|.
name|ID_type
operator|=
name|T_ATM_USER_ID
expr_stmt|;
name|ap
operator|->
name|blli
operator|.
name|v
operator|.
name|layer_3_protocol
operator|.
name|ID
operator|.
name|user_defined_ID
operator|=
name|msg
operator|->
name|msg_ie_blli
operator|->
name|ie_blli_l3_user_proto
expr_stmt|;
break|break;
default|default:
name|ap
operator|->
name|blli
operator|.
name|tag_l3
operator|=
name|T_ATM_ABSENT
expr_stmt|;
block|}
if|if
condition|(
name|ap
operator|->
name|blli
operator|.
name|tag_l3
operator|==
name|T_ATM_PRESENT
condition|)
block|{
name|ap
operator|->
name|blli
operator|.
name|v
operator|.
name|layer_3_protocol
operator|.
name|mode
operator|=
name|msg
operator|->
name|msg_ie_blli
operator|->
name|ie_blli_l3_mode
expr_stmt|;
name|ap
operator|->
name|blli
operator|.
name|v
operator|.
name|layer_3_protocol
operator|.
name|packet_size
operator|=
name|msg
operator|->
name|msg_ie_blli
operator|->
name|ie_blli_l3_packet_size
expr_stmt|;
name|ap
operator|->
name|blli
operator|.
name|v
operator|.
name|layer_3_protocol
operator|.
name|window_size
operator|=
name|msg
operator|->
name|msg_ie_blli
operator|->
name|ie_blli_l3_window
expr_stmt|;
block|}
block|}
comment|/* 	 * Save the called party address and subaddress 	 */
if|if
condition|(
name|msg
operator|->
name|msg_ie_cdad
condition|)
block|{
name|ap
operator|->
name|called
operator|.
name|tag
operator|=
name|T_ATM_PRESENT
expr_stmt|;
name|ATM_ADDR_COPY
argument_list|(
operator|&
name|msg
operator|->
name|msg_ie_cdad
operator|->
name|ie_cdad_addr
argument_list|,
operator|&
name|ap
operator|->
name|called
operator|.
name|addr
argument_list|)
expr_stmt|;
name|ap
operator|->
name|called
operator|.
name|subaddr
operator|.
name|address_format
operator|=
name|T_ATM_ABSENT
expr_stmt|;
name|ap
operator|->
name|called
operator|.
name|subaddr
operator|.
name|address_length
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|msg
operator|->
name|msg_ie_cdsa
condition|)
block|{
name|ATM_ADDR_COPY
argument_list|(
operator|&
name|msg
operator|->
name|msg_ie_cdsa
operator|->
name|ie_cdsa_addr
argument_list|,
operator|&
name|ap
operator|->
name|called
operator|.
name|subaddr
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Save the calling party address and subaddress 	 */
if|if
condition|(
name|msg
operator|->
name|msg_ie_cgad
condition|)
block|{
name|ap
operator|->
name|calling
operator|.
name|tag
operator|=
name|T_ATM_PRESENT
expr_stmt|;
name|ATM_ADDR_COPY
argument_list|(
operator|&
name|msg
operator|->
name|msg_ie_cgad
operator|->
name|ie_cgad_addr
argument_list|,
operator|&
name|ap
operator|->
name|calling
operator|.
name|addr
argument_list|)
expr_stmt|;
name|ap
operator|->
name|calling
operator|.
name|subaddr
operator|.
name|address_format
operator|=
name|T_ATM_ABSENT
expr_stmt|;
name|ap
operator|->
name|calling
operator|.
name|subaddr
operator|.
name|address_length
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|msg
operator|->
name|msg_ie_cgsa
condition|)
block|{
name|ATM_ADDR_COPY
argument_list|(
operator|&
name|msg
operator|->
name|msg_ie_cgsa
operator|->
name|ie_cgsa_addr
argument_list|,
operator|&
name|ap
operator|->
name|calling
operator|.
name|subaddr
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Save quality of service attributes 	 */
if|if
condition|(
name|msg
operator|->
name|msg_ie_qosp
condition|)
block|{
name|ap
operator|->
name|qos
operator|.
name|tag
operator|=
name|T_ATM_PRESENT
expr_stmt|;
name|ap
operator|->
name|qos
operator|.
name|v
operator|.
name|coding_standard
operator|=
name|msg
operator|->
name|msg_ie_qosp
operator|->
name|ie_coding
expr_stmt|;
name|ap
operator|->
name|qos
operator|.
name|v
operator|.
name|forward
operator|.
name|qos_class
operator|=
name|msg
operator|->
name|msg_ie_qosp
operator|->
name|ie_qosp_fwd_class
expr_stmt|;
name|ap
operator|->
name|qos
operator|.
name|v
operator|.
name|forward
operator|.
name|qos_class
operator|=
name|msg
operator|->
name|msg_ie_qosp
operator|->
name|ie_qosp_bkwd_class
expr_stmt|;
block|}
comment|/* 	 * Save transit network attributes 	 */
if|if
condition|(
name|msg
operator|->
name|msg_ie_trnt
condition|)
block|{
name|ap
operator|->
name|transit
operator|.
name|tag
operator|=
name|T_ATM_PRESENT
expr_stmt|;
name|ap
operator|->
name|transit
operator|.
name|v
operator|.
name|length
operator|=
name|MIN
argument_list|(
name|msg
operator|->
name|msg_ie_trnt
operator|->
name|ie_trnt_id_len
argument_list|,
sizeof|sizeof
argument_list|(
name|ap
operator|->
name|transit
operator|.
name|v
operator|.
name|network_id
argument_list|)
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|msg
operator|->
name|msg_ie_trnt
operator|->
name|ie_trnt_id
argument_list|,
name|ap
operator|->
name|transit
operator|.
name|v
operator|.
name|network_id
argument_list|,
name|ap
operator|->
name|transit
operator|.
name|v
operator|.
name|length
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Save cause code 	 */
if|if
condition|(
name|msg
operator|->
name|msg_ie_caus
condition|)
block|{
name|ap
operator|->
name|cause
operator|.
name|tag
operator|=
name|T_ATM_PRESENT
expr_stmt|;
name|ap
operator|->
name|cause
operator|.
name|v
operator|.
name|coding_standard
operator|=
name|msg
operator|->
name|msg_ie_caus
operator|->
name|ie_coding
expr_stmt|;
name|ap
operator|->
name|cause
operator|.
name|v
operator|.
name|location
operator|=
name|msg
operator|->
name|msg_ie_caus
operator|->
name|ie_caus_loc
expr_stmt|;
name|ap
operator|->
name|cause
operator|.
name|v
operator|.
name|cause_value
operator|=
name|msg
operator|->
name|msg_ie_caus
operator|->
name|ie_caus_cause
expr_stmt|;
name|bzero
argument_list|(
name|ap
operator|->
name|cause
operator|.
name|v
operator|.
name|diagnostics
argument_list|,
sizeof|sizeof
argument_list|(
name|ap
operator|->
name|cause
operator|.
name|v
operator|.
name|diagnostics
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|NOTDEF
name|bcopy
argument_list|(
name|msg
operator|->
name|msg_ie_caus
operator|->
name|ie_caus_diagnostic
argument_list|,
name|ap
operator|->
name|transit
operator|.
name|v
operator|.
name|diagnostics
argument_list|,
name|MIN
argument_list|(
sizeof|sizeof
argument_list|(
name|ap
operator|->
name|transit
operator|.
name|v
operator|.
name|diagnostics
argument_list|)
argument_list|,
name|msg
operator|->
name|msg_ie_caus
operator|->
name|ie_caus_diag_len
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
block|}
end_function

begin_comment
comment|/*  * Copy connection parameters from an attribute block into  * UNI 3.0 message IEs  *  * Arguments:  *	usp	pointer to UNISIG protocol instance  *	msg	pointer to the SETUP message  *	ap	pointer to the attribute block  *  * Returns:  *	0	everything OK  *	else	error encountered  *  */
end_comment

begin_function
name|int
name|unisig_set_attrs
parameter_list|(
name|usp
parameter_list|,
name|msg
parameter_list|,
name|ap
parameter_list|)
name|struct
name|unisig
modifier|*
name|usp
decl_stmt|;
name|struct
name|unisig_msg
modifier|*
name|msg
decl_stmt|;
name|Atm_attributes
modifier|*
name|ap
decl_stmt|;
block|{
name|int
name|err
init|=
literal|0
decl_stmt|;
comment|/* 	 * Sanity check 	 */
if|if
condition|(
operator|!
name|msg
operator|||
operator|!
name|ap
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
comment|/* 	 * Set the AAL parameters (AAL 3/4 and AAL 5 only) 	 */
if|if
condition|(
name|ap
operator|->
name|aal
operator|.
name|tag
operator|==
name|T_ATM_PRESENT
condition|)
block|{
if|if
condition|(
operator|!
name|msg
operator|->
name|msg_ie_aalp
condition|)
block|{
name|msg
operator|->
name|msg_ie_aalp
operator|=
name|uma_zalloc
argument_list|(
name|unisig_ie_zone
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|msg_ie_aalp
operator|==
name|NULL
condition|)
block|{
name|err
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|done
goto|;
block|}
block|}
name|bcopy
argument_list|(
operator|&
name|ie_aalp_absent
argument_list|,
operator|&
name|msg
operator|->
name|msg_ie_aalp
operator|->
name|ie_u
operator|.
name|ie_aalp
argument_list|,
sizeof|sizeof
argument_list|(
name|ie_aalp_absent
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|->
name|msg_ie_aalp
operator|->
name|ie_ident
operator|=
name|UNI_IE_AALP
expr_stmt|;
name|msg
operator|->
name|msg_ie_aalp
operator|->
name|ie_aalp_aal_type
operator|=
name|ap
operator|->
name|aal
operator|.
name|type
expr_stmt|;
switch|switch
condition|(
name|ap
operator|->
name|aal
operator|.
name|type
condition|)
block|{
case|case
name|ATM_AAL3_4
case|:
name|msg
operator|->
name|msg_ie_aalp
operator|->
name|ie_aalp_4_fwd_max_sdu
operator|=
name|ap
operator|->
name|aal
operator|.
name|v
operator|.
name|aal4
operator|.
name|forward_max_SDU_size
expr_stmt|;
name|msg
operator|->
name|msg_ie_aalp
operator|->
name|ie_aalp_4_bkwd_max_sdu
operator|=
name|ap
operator|->
name|aal
operator|.
name|v
operator|.
name|aal4
operator|.
name|backward_max_SDU_size
expr_stmt|;
name|msg
operator|->
name|msg_ie_aalp
operator|->
name|ie_aalp_4_mode
operator|=
name|UNI_IE_AALP_A5_M_MSG
expr_stmt|;
name|msg
operator|->
name|msg_ie_aalp
operator|->
name|ie_aalp_4_sscs_type
operator|=
name|ap
operator|->
name|aal
operator|.
name|v
operator|.
name|aal4
operator|.
name|SSCS_type
expr_stmt|;
if|if
condition|(
name|ap
operator|->
name|aal
operator|.
name|v
operator|.
name|aal4
operator|.
name|mid_low
operator|==
name|T_ATM_ABSENT
condition|)
block|{
name|msg
operator|->
name|msg_ie_aalp
operator|->
name|ie_aalp_4_mid_range
operator|=
name|T_ATM_ABSENT
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|usp
operator|->
name|us_proto
operator|==
name|ATM_SIG_UNI30
condition|)
block|{
name|msg
operator|->
name|msg_ie_aalp
operator|->
name|ie_aalp_4_mid_range
operator|=
name|ap
operator|->
name|aal
operator|.
name|v
operator|.
name|aal4
operator|.
name|mid_high
operator|&
name|UNI_IE_AALP_A3_R_MASK
expr_stmt|;
block|}
else|else
block|{
name|msg
operator|->
name|msg_ie_aalp
operator|->
name|ie_aalp_4_mid_range
operator|=
operator|(
operator|(
name|ap
operator|->
name|aal
operator|.
name|v
operator|.
name|aal4
operator|.
name|mid_low
operator|&
name|UNI_IE_AALP_A3_R_MASK
operator|)
operator|<<
name|UNI_IE_AALP_A3_R_SHIFT
operator|)
operator||
operator|(
name|ap
operator|->
name|aal
operator|.
name|v
operator|.
name|aal4
operator|.
name|mid_high
operator|&
name|UNI_IE_AALP_A3_R_MASK
operator|)
expr_stmt|;
block|}
block|}
break|break;
case|case
name|ATM_AAL5
case|:
name|msg
operator|->
name|msg_ie_aalp
operator|->
name|ie_aalp_5_fwd_max_sdu
operator|=
name|ap
operator|->
name|aal
operator|.
name|v
operator|.
name|aal5
operator|.
name|forward_max_SDU_size
expr_stmt|;
name|msg
operator|->
name|msg_ie_aalp
operator|->
name|ie_aalp_5_bkwd_max_sdu
operator|=
name|ap
operator|->
name|aal
operator|.
name|v
operator|.
name|aal5
operator|.
name|backward_max_SDU_size
expr_stmt|;
name|msg
operator|->
name|msg_ie_aalp
operator|->
name|ie_aalp_5_mode
operator|=
name|UNI_IE_AALP_A5_M_MSG
expr_stmt|;
name|msg
operator|->
name|msg_ie_aalp
operator|->
name|ie_aalp_5_sscs_type
operator|=
name|ap
operator|->
name|aal
operator|.
name|v
operator|.
name|aal5
operator|.
name|SSCS_type
expr_stmt|;
break|break;
block|}
block|}
comment|/* 	 * Set traffic descriptor attributes 	 */
if|if
condition|(
name|ap
operator|->
name|traffic
operator|.
name|tag
operator|==
name|T_ATM_PRESENT
condition|)
block|{
if|if
condition|(
operator|!
name|msg
operator|->
name|msg_ie_clrt
condition|)
block|{
name|msg
operator|->
name|msg_ie_clrt
operator|=
name|uma_zalloc
argument_list|(
name|unisig_ie_zone
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|msg_ie_clrt
operator|==
name|NULL
condition|)
block|{
name|err
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|done
goto|;
block|}
block|}
name|bcopy
argument_list|(
operator|&
name|ie_clrt_absent
argument_list|,
operator|&
name|msg
operator|->
name|msg_ie_clrt
operator|->
name|ie_u
operator|.
name|ie_clrt
argument_list|,
sizeof|sizeof
argument_list|(
name|ie_clrt_absent
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|->
name|msg_ie_clrt
operator|->
name|ie_ident
operator|=
name|UNI_IE_CLRT
expr_stmt|;
name|msg
operator|->
name|msg_ie_clrt
operator|->
name|ie_clrt_fwd_peak
operator|=
name|ap
operator|->
name|traffic
operator|.
name|v
operator|.
name|forward
operator|.
name|PCR_high_priority
expr_stmt|;
name|msg
operator|->
name|msg_ie_clrt
operator|->
name|ie_clrt_fwd_peak_01
operator|=
name|ap
operator|->
name|traffic
operator|.
name|v
operator|.
name|forward
operator|.
name|PCR_all_traffic
expr_stmt|;
name|msg
operator|->
name|msg_ie_clrt
operator|->
name|ie_clrt_fwd_sust
operator|=
name|ap
operator|->
name|traffic
operator|.
name|v
operator|.
name|forward
operator|.
name|SCR_high_priority
expr_stmt|;
name|msg
operator|->
name|msg_ie_clrt
operator|->
name|ie_clrt_fwd_sust_01
operator|=
name|ap
operator|->
name|traffic
operator|.
name|v
operator|.
name|forward
operator|.
name|SCR_all_traffic
expr_stmt|;
name|msg
operator|->
name|msg_ie_clrt
operator|->
name|ie_clrt_fwd_burst
operator|=
name|ap
operator|->
name|traffic
operator|.
name|v
operator|.
name|forward
operator|.
name|MBS_high_priority
expr_stmt|;
name|msg
operator|->
name|msg_ie_clrt
operator|->
name|ie_clrt_fwd_burst_01
operator|=
name|ap
operator|->
name|traffic
operator|.
name|v
operator|.
name|forward
operator|.
name|MBS_all_traffic
expr_stmt|;
name|msg
operator|->
name|msg_ie_clrt
operator|->
name|ie_clrt_bkwd_peak
operator|=
name|ap
operator|->
name|traffic
operator|.
name|v
operator|.
name|backward
operator|.
name|PCR_high_priority
expr_stmt|;
name|msg
operator|->
name|msg_ie_clrt
operator|->
name|ie_clrt_bkwd_peak_01
operator|=
name|ap
operator|->
name|traffic
operator|.
name|v
operator|.
name|backward
operator|.
name|PCR_all_traffic
expr_stmt|;
name|msg
operator|->
name|msg_ie_clrt
operator|->
name|ie_clrt_bkwd_sust
operator|=
name|ap
operator|->
name|traffic
operator|.
name|v
operator|.
name|backward
operator|.
name|SCR_high_priority
expr_stmt|;
name|msg
operator|->
name|msg_ie_clrt
operator|->
name|ie_clrt_bkwd_sust_01
operator|=
name|ap
operator|->
name|traffic
operator|.
name|v
operator|.
name|backward
operator|.
name|SCR_all_traffic
expr_stmt|;
name|msg
operator|->
name|msg_ie_clrt
operator|->
name|ie_clrt_bkwd_burst
operator|=
name|ap
operator|->
name|traffic
operator|.
name|v
operator|.
name|backward
operator|.
name|MBS_high_priority
expr_stmt|;
name|msg
operator|->
name|msg_ie_clrt
operator|->
name|ie_clrt_bkwd_burst_01
operator|=
name|ap
operator|->
name|traffic
operator|.
name|v
operator|.
name|backward
operator|.
name|MBS_all_traffic
expr_stmt|;
name|msg
operator|->
name|msg_ie_clrt
operator|->
name|ie_clrt_best_effort
operator|=
name|ap
operator|->
name|traffic
operator|.
name|v
operator|.
name|best_effort
expr_stmt|;
name|msg
operator|->
name|msg_ie_clrt
operator|->
name|ie_clrt_tm_options
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ap
operator|->
name|traffic
operator|.
name|v
operator|.
name|forward
operator|.
name|tagging
condition|)
block|{
name|msg
operator|->
name|msg_ie_clrt
operator|->
name|ie_clrt_tm_options
operator||=
name|UNI_IE_CLRT_TM_FWD_TAG
expr_stmt|;
block|}
if|if
condition|(
name|ap
operator|->
name|traffic
operator|.
name|v
operator|.
name|backward
operator|.
name|tagging
condition|)
block|{
name|msg
operator|->
name|msg_ie_clrt
operator|->
name|ie_clrt_tm_options
operator||=
name|UNI_IE_CLRT_TM_BKWD_TAG
expr_stmt|;
block|}
if|if
condition|(
name|msg
operator|->
name|msg_ie_clrt
operator|->
name|ie_clrt_tm_options
operator|==
literal|0
condition|)
block|{
name|msg
operator|->
name|msg_ie_clrt
operator|->
name|ie_clrt_tm_options
operator|=
name|T_ATM_ABSENT
expr_stmt|;
block|}
block|}
comment|/* 	 * Set broadband bearer attributes 	 */
if|if
condition|(
name|ap
operator|->
name|bearer
operator|.
name|tag
operator|==
name|T_ATM_PRESENT
condition|)
block|{
if|if
condition|(
operator|!
name|msg
operator|->
name|msg_ie_bbcp
condition|)
block|{
name|msg
operator|->
name|msg_ie_bbcp
operator|=
name|uma_zalloc
argument_list|(
name|unisig_ie_zone
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|msg_ie_bbcp
operator|==
name|NULL
condition|)
block|{
name|err
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|done
goto|;
block|}
block|}
name|bcopy
argument_list|(
operator|&
name|ie_bbcp_absent
argument_list|,
operator|&
name|msg
operator|->
name|msg_ie_bbcp
operator|->
name|ie_u
operator|.
name|ie_bbcp
argument_list|,
sizeof|sizeof
argument_list|(
name|ie_bbcp_absent
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|->
name|msg_ie_bbcp
operator|->
name|ie_ident
operator|=
name|UNI_IE_BBCP
expr_stmt|;
name|msg
operator|->
name|msg_ie_bbcp
operator|->
name|ie_bbcp_bearer_class
operator|=
name|ap
operator|->
name|bearer
operator|.
name|v
operator|.
name|bearer_class
expr_stmt|;
name|msg
operator|->
name|msg_ie_bbcp
operator|->
name|ie_bbcp_traffic_type
operator|=
name|ap
operator|->
name|bearer
operator|.
name|v
operator|.
name|traffic_type
expr_stmt|;
name|msg
operator|->
name|msg_ie_bbcp
operator|->
name|ie_bbcp_timing_req
operator|=
name|ap
operator|->
name|bearer
operator|.
name|v
operator|.
name|timing_requirements
expr_stmt|;
name|msg
operator|->
name|msg_ie_bbcp
operator|->
name|ie_bbcp_clipping
operator|=
name|ap
operator|->
name|bearer
operator|.
name|v
operator|.
name|clipping_susceptibility
expr_stmt|;
name|msg
operator|->
name|msg_ie_bbcp
operator|->
name|ie_bbcp_conn_config
operator|=
name|ap
operator|->
name|bearer
operator|.
name|v
operator|.
name|connection_configuration
expr_stmt|;
block|}
comment|/* 	 * Set broadband high layer attributes 	 */
if|if
condition|(
name|ap
operator|->
name|bhli
operator|.
name|tag
operator|==
name|T_ATM_PRESENT
condition|)
block|{
if|if
condition|(
operator|!
name|msg
operator|->
name|msg_ie_bhli
condition|)
block|{
name|msg
operator|->
name|msg_ie_bhli
operator|=
name|uma_zalloc
argument_list|(
name|unisig_ie_zone
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|msg_ie_bhli
operator|==
name|NULL
condition|)
block|{
name|err
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|done
goto|;
block|}
block|}
name|bcopy
argument_list|(
operator|&
name|ie_bhli_absent
argument_list|,
operator|&
name|msg
operator|->
name|msg_ie_bhli
operator|->
name|ie_u
operator|.
name|ie_bhli
argument_list|,
sizeof|sizeof
argument_list|(
name|ie_bhli_absent
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|->
name|msg_ie_bhli
operator|->
name|ie_ident
operator|=
name|UNI_IE_BHLI
expr_stmt|;
name|msg
operator|->
name|msg_ie_bhli
operator|->
name|ie_bhli_type
operator|=
name|ap
operator|->
name|bhli
operator|.
name|v
operator|.
name|ID_type
expr_stmt|;
switch|switch
condition|(
name|ap
operator|->
name|bhli
operator|.
name|v
operator|.
name|ID_type
condition|)
block|{
case|case
name|T_ATM_ISO_APP_ID
case|:
name|bcopy
argument_list|(
name|ap
operator|->
name|bhli
operator|.
name|v
operator|.
name|ID
operator|.
name|ISO_ID
argument_list|,
name|msg
operator|->
name|msg_ie_bhli
operator|->
name|ie_bhli_info
argument_list|,
sizeof|sizeof
argument_list|(
name|ap
operator|->
name|bhli
operator|.
name|v
operator|.
name|ID
operator|.
name|ISO_ID
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|T_ATM_USER_APP_ID
case|:
name|bcopy
argument_list|(
name|ap
operator|->
name|bhli
operator|.
name|v
operator|.
name|ID
operator|.
name|user_defined_ID
argument_list|,
name|msg
operator|->
name|msg_ie_bhli
operator|->
name|ie_bhli_info
argument_list|,
sizeof|sizeof
argument_list|(
name|ap
operator|->
name|bhli
operator|.
name|v
operator|.
name|ID
operator|.
name|user_defined_ID
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|T_ATM_VENDOR_APP_ID
case|:
name|bcopy
argument_list|(
name|ap
operator|->
name|bhli
operator|.
name|v
operator|.
name|ID
operator|.
name|vendor_ID
operator|.
name|OUI
argument_list|,
name|msg
operator|->
name|msg_ie_bhli
operator|->
name|ie_bhli_info
argument_list|,
sizeof|sizeof
argument_list|(
name|ap
operator|->
name|bhli
operator|.
name|v
operator|.
name|ID
operator|.
name|vendor_ID
operator|.
name|OUI
argument_list|)
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|ap
operator|->
name|bhli
operator|.
name|v
operator|.
name|ID
operator|.
name|vendor_ID
operator|.
name|app_ID
argument_list|,
operator|&
name|msg
operator|->
name|msg_ie_bhli
operator|->
name|ie_bhli_info
index|[
sizeof|sizeof
argument_list|(
name|ap
operator|->
name|bhli
operator|.
name|v
operator|.
name|ID
operator|.
name|vendor_ID
operator|.
name|OUI
argument_list|)
operator|-
literal|1
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|ap
operator|->
name|bhli
operator|.
name|v
operator|.
name|ID
operator|.
name|vendor_ID
operator|.
name|app_ID
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
comment|/* 	 * Set Broadband low layer, user layer 2 and 3 attributes 	 */
if|if
condition|(
name|ap
operator|->
name|blli
operator|.
name|tag_l2
operator|==
name|T_ATM_PRESENT
operator|||
name|ap
operator|->
name|blli
operator|.
name|tag_l3
operator|==
name|T_ATM_PRESENT
condition|)
block|{
if|if
condition|(
operator|!
name|msg
operator|->
name|msg_ie_blli
condition|)
block|{
name|msg
operator|->
name|msg_ie_blli
operator|=
name|uma_zalloc
argument_list|(
name|unisig_ie_zone
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|msg_ie_blli
operator|==
name|NULL
condition|)
block|{
name|err
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|done
goto|;
block|}
block|}
name|bcopy
argument_list|(
operator|&
name|ie_blli_absent
argument_list|,
operator|&
name|msg
operator|->
name|msg_ie_blli
operator|->
name|ie_u
operator|.
name|ie_blli
argument_list|,
sizeof|sizeof
argument_list|(
name|ie_blli_absent
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|->
name|msg_ie_blli
operator|->
name|ie_ident
operator|=
name|UNI_IE_BLLI
expr_stmt|;
if|if
condition|(
name|ap
operator|->
name|blli
operator|.
name|tag_l2
operator|==
name|T_ATM_PRESENT
condition|)
block|{
switch|switch
condition|(
name|ap
operator|->
name|blli
operator|.
name|v
operator|.
name|layer_2_protocol
operator|.
name|ID_type
condition|)
block|{
case|case
name|T_ATM_SIMPLE_ID
case|:
name|msg
operator|->
name|msg_ie_blli
operator|->
name|ie_blli_l2_id
operator|=
name|ap
operator|->
name|blli
operator|.
name|v
operator|.
name|layer_2_protocol
operator|.
name|ID
operator|.
name|simple_ID
expr_stmt|;
break|break;
case|case
name|T_ATM_USER_ID
case|:
name|msg
operator|->
name|msg_ie_blli
operator|->
name|ie_blli_l2_id
operator|=
name|UNI_IE_BLLI_L2P_USER
expr_stmt|;
name|msg
operator|->
name|msg_ie_blli
operator|->
name|ie_blli_l2_user_proto
operator|=
name|ap
operator|->
name|blli
operator|.
name|v
operator|.
name|layer_2_protocol
operator|.
name|ID
operator|.
name|user_defined_ID
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ap
operator|->
name|blli
operator|.
name|v
operator|.
name|layer_2_protocol
operator|.
name|ID_type
operator|!=
name|T_ATM_ABSENT
condition|)
block|{
name|msg
operator|->
name|msg_ie_blli
operator|->
name|ie_blli_l2_mode
operator|=
name|ap
operator|->
name|blli
operator|.
name|v
operator|.
name|layer_2_protocol
operator|.
name|mode
expr_stmt|;
name|msg
operator|->
name|msg_ie_blli
operator|->
name|ie_blli_l2_window
operator|=
name|ap
operator|->
name|blli
operator|.
name|v
operator|.
name|layer_2_protocol
operator|.
name|window_size
expr_stmt|;
block|}
block|}
if|if
condition|(
name|ap
operator|->
name|blli
operator|.
name|tag_l3
operator|==
name|T_ATM_PRESENT
condition|)
block|{
switch|switch
condition|(
name|ap
operator|->
name|blli
operator|.
name|v
operator|.
name|layer_3_protocol
operator|.
name|ID_type
condition|)
block|{
case|case
name|T_ATM_SIMPLE_ID
case|:
name|msg
operator|->
name|msg_ie_blli
operator|->
name|ie_blli_l3_id
operator|=
name|ap
operator|->
name|blli
operator|.
name|v
operator|.
name|layer_3_protocol
operator|.
name|ID
operator|.
name|simple_ID
expr_stmt|;
break|break;
case|case
name|T_ATM_IPI_ID
case|:
name|msg
operator|->
name|msg_ie_blli
operator|->
name|ie_blli_l3_id
operator|=
name|UNI_IE_BLLI_L3P_ISO9577
expr_stmt|;
name|msg
operator|->
name|msg_ie_blli
operator|->
name|ie_blli_l3_ipi
operator|=
name|ap
operator|->
name|blli
operator|.
name|v
operator|.
name|layer_3_protocol
operator|.
name|ID
operator|.
name|IPI_ID
expr_stmt|;
break|break;
case|case
name|T_ATM_SNAP_ID
case|:
name|msg
operator|->
name|msg_ie_blli
operator|->
name|ie_blli_l3_id
operator|=
name|UNI_IE_BLLI_L3P_ISO9577
expr_stmt|;
name|msg
operator|->
name|msg_ie_blli
operator|->
name|ie_blli_l3_ipi
operator|=
name|UNI_IE_BLLI_L3IPI_SNAP
expr_stmt|;
name|bcopy
argument_list|(
name|ap
operator|->
name|blli
operator|.
name|v
operator|.
name|layer_3_protocol
operator|.
name|ID
operator|.
name|SNAP_ID
operator|.
name|OUI
argument_list|,
name|msg
operator|->
name|msg_ie_blli
operator|->
name|ie_blli_l3_oui
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
operator|->
name|msg_ie_blli
operator|->
name|ie_blli_l3_oui
argument_list|)
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|ap
operator|->
name|blli
operator|.
name|v
operator|.
name|layer_3_protocol
operator|.
name|ID
operator|.
name|SNAP_ID
operator|.
name|PID
argument_list|,
name|msg
operator|->
name|msg_ie_blli
operator|->
name|ie_blli_l3_pid
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
operator|->
name|msg_ie_blli
operator|->
name|ie_blli_l3_pid
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|T_ATM_USER_ID
case|:
name|msg
operator|->
name|msg_ie_blli
operator|->
name|ie_blli_l3_id
operator|=
name|UNI_IE_BLLI_L3P_USER
expr_stmt|;
name|msg
operator|->
name|msg_ie_blli
operator|->
name|ie_blli_l3_user_proto
operator|=
name|ap
operator|->
name|blli
operator|.
name|v
operator|.
name|layer_3_protocol
operator|.
name|ID
operator|.
name|user_defined_ID
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ap
operator|->
name|blli
operator|.
name|v
operator|.
name|layer_3_protocol
operator|.
name|ID_type
operator|!=
name|T_ATM_ABSENT
condition|)
block|{
name|msg
operator|->
name|msg_ie_blli
operator|->
name|ie_blli_l3_mode
operator|=
name|ap
operator|->
name|blli
operator|.
name|v
operator|.
name|layer_3_protocol
operator|.
name|mode
expr_stmt|;
name|msg
operator|->
name|msg_ie_blli
operator|->
name|ie_blli_l3_packet_size
operator|=
name|ap
operator|->
name|blli
operator|.
name|v
operator|.
name|layer_3_protocol
operator|.
name|packet_size
expr_stmt|;
name|msg
operator|->
name|msg_ie_blli
operator|->
name|ie_blli_l3_window
operator|=
name|ap
operator|->
name|blli
operator|.
name|v
operator|.
name|layer_3_protocol
operator|.
name|window_size
expr_stmt|;
block|}
block|}
block|}
comment|/* 	 * Set the called party address and subaddress 	 */
if|if
condition|(
name|ap
operator|->
name|called
operator|.
name|tag
operator|==
name|T_ATM_PRESENT
condition|)
block|{
if|if
condition|(
operator|!
name|msg
operator|->
name|msg_ie_cdad
condition|)
block|{
name|msg
operator|->
name|msg_ie_cdad
operator|=
name|uma_zalloc
argument_list|(
name|unisig_ie_zone
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|msg_ie_cdad
operator|==
name|NULL
condition|)
block|{
name|err
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|done
goto|;
block|}
block|}
name|bcopy
argument_list|(
operator|&
name|ie_cdad_absent
argument_list|,
operator|&
name|msg
operator|->
name|msg_ie_cdad
operator|->
name|ie_u
operator|.
name|ie_cdad
argument_list|,
sizeof|sizeof
argument_list|(
name|ie_cdad_absent
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|->
name|msg_ie_cdad
operator|->
name|ie_ident
operator|=
name|UNI_IE_CDAD
expr_stmt|;
name|ATM_ADDR_COPY
argument_list|(
operator|&
name|ap
operator|->
name|called
operator|.
name|addr
argument_list|,
operator|&
name|msg
operator|->
name|msg_ie_cdad
operator|->
name|ie_cdad_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ap
operator|->
name|called
operator|.
name|subaddr
operator|.
name|address_format
operator|!=
name|T_ATM_ABSENT
condition|)
block|{
if|if
condition|(
operator|!
name|msg
operator|->
name|msg_ie_cdsa
condition|)
block|{
name|msg
operator|->
name|msg_ie_cdsa
operator|=
name|uma_zalloc
argument_list|(
name|unisig_ie_zone
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|msg_ie_cdsa
operator|==
name|NULL
condition|)
block|{
name|err
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|done
goto|;
block|}
block|}
name|bcopy
argument_list|(
operator|&
name|ie_cdsa_absent
argument_list|,
operator|&
name|msg
operator|->
name|msg_ie_cdsa
operator|->
name|ie_u
operator|.
name|ie_cdsa
argument_list|,
sizeof|sizeof
argument_list|(
name|ie_cdsa_absent
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|->
name|msg_ie_cdsa
operator|->
name|ie_ident
operator|=
name|UNI_IE_CDSA
expr_stmt|;
name|ATM_ADDR_COPY
argument_list|(
operator|&
name|ap
operator|->
name|called
operator|.
name|subaddr
argument_list|,
operator|&
name|msg
operator|->
name|msg_ie_cdsa
operator|->
name|ie_cdsa_addr
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* 	 * Set the calling party address and subaddress 	 */
if|if
condition|(
name|ap
operator|->
name|calling
operator|.
name|tag
operator|==
name|T_ATM_PRESENT
condition|)
block|{
if|if
condition|(
operator|!
name|msg
operator|->
name|msg_ie_cgad
condition|)
block|{
name|msg
operator|->
name|msg_ie_cgad
operator|=
name|uma_zalloc
argument_list|(
name|unisig_ie_zone
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|msg_ie_cgad
operator|==
name|NULL
condition|)
block|{
name|err
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|done
goto|;
block|}
block|}
name|bcopy
argument_list|(
operator|&
name|ie_cgad_absent
argument_list|,
operator|&
name|msg
operator|->
name|msg_ie_cgad
operator|->
name|ie_u
operator|.
name|ie_cgad
argument_list|,
sizeof|sizeof
argument_list|(
name|ie_cgad_absent
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|->
name|msg_ie_cgsa
operator|->
name|ie_ident
operator|=
name|UNI_IE_CGSA
expr_stmt|;
name|ATM_ADDR_COPY
argument_list|(
operator|&
name|ap
operator|->
name|calling
operator|.
name|addr
argument_list|,
operator|&
name|msg
operator|->
name|msg_ie_cgad
operator|->
name|ie_cgad_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ap
operator|->
name|calling
operator|.
name|subaddr
operator|.
name|address_format
operator|!=
name|T_ATM_ABSENT
condition|)
block|{
if|if
condition|(
operator|!
name|msg
operator|->
name|msg_ie_cgsa
condition|)
block|{
name|msg
operator|->
name|msg_ie_cgsa
operator|=
name|uma_zalloc
argument_list|(
name|unisig_ie_zone
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|msg_ie_cgsa
operator|==
name|NULL
condition|)
block|{
name|err
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|done
goto|;
block|}
block|}
name|bcopy
argument_list|(
operator|&
name|ie_cgsa_absent
argument_list|,
operator|&
name|msg
operator|->
name|msg_ie_cgsa
operator|->
name|ie_u
operator|.
name|ie_cgsa
argument_list|,
sizeof|sizeof
argument_list|(
name|ie_cgsa_absent
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|->
name|msg_ie_cgsa
operator|->
name|ie_ident
operator|=
name|UNI_IE_CGSA
expr_stmt|;
name|ATM_ADDR_COPY
argument_list|(
operator|&
name|ap
operator|->
name|calling
operator|.
name|subaddr
argument_list|,
operator|&
name|msg
operator|->
name|msg_ie_cgsa
operator|->
name|ie_cgsa_addr
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* 	 * Set quality of service attributes 	 */
if|if
condition|(
name|ap
operator|->
name|qos
operator|.
name|tag
operator|==
name|T_ATM_PRESENT
condition|)
block|{
if|if
condition|(
operator|!
name|msg
operator|->
name|msg_ie_qosp
condition|)
block|{
name|msg
operator|->
name|msg_ie_qosp
operator|=
name|uma_zalloc
argument_list|(
name|unisig_ie_zone
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|msg_ie_qosp
operator|==
name|NULL
condition|)
block|{
name|err
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|done
goto|;
block|}
block|}
name|bcopy
argument_list|(
operator|&
name|ie_qosp_absent
argument_list|,
operator|&
name|msg
operator|->
name|msg_ie_qosp
operator|->
name|ie_u
operator|.
name|ie_qosp
argument_list|,
sizeof|sizeof
argument_list|(
name|ie_qosp_absent
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|->
name|msg_ie_qosp
operator|->
name|ie_ident
operator|=
name|UNI_IE_QOSP
expr_stmt|;
if|if
condition|(
name|usp
operator|->
name|us_proto
operator|==
name|ATM_SIG_UNI30
condition|)
name|msg
operator|->
name|msg_ie_qosp
operator|->
name|ie_coding
operator|=
name|UNI_IE_CODE_STD
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|ap
operator|->
name|qos
operator|.
name|v
operator|.
name|forward
operator|.
name|qos_class
operator|==
name|T_ATM_QOS_CLASS_0
operator|)
operator|||
operator|(
name|ap
operator|->
name|qos
operator|.
name|v
operator|.
name|backward
operator|.
name|qos_class
operator|==
name|T_ATM_QOS_CLASS_0
operator|)
condition|)
name|msg
operator|->
name|msg_ie_qosp
operator|->
name|ie_coding
operator|=
name|UNI_IE_CODE_CCITT
expr_stmt|;
else|else
name|msg
operator|->
name|msg_ie_qosp
operator|->
name|ie_coding
operator|=
name|ap
operator|->
name|qos
operator|.
name|v
operator|.
name|coding_standard
expr_stmt|;
name|msg
operator|->
name|msg_ie_qosp
operator|->
name|ie_qosp_fwd_class
operator|=
name|ap
operator|->
name|qos
operator|.
name|v
operator|.
name|forward
operator|.
name|qos_class
expr_stmt|;
name|msg
operator|->
name|msg_ie_qosp
operator|->
name|ie_qosp_bkwd_class
operator|=
name|ap
operator|->
name|qos
operator|.
name|v
operator|.
name|backward
operator|.
name|qos_class
expr_stmt|;
block|}
comment|/* 	 * Set transit network attributes 	 */
if|if
condition|(
name|ap
operator|->
name|transit
operator|.
name|tag
operator|==
name|T_ATM_PRESENT
operator|&&
name|ap
operator|->
name|transit
operator|.
name|v
operator|.
name|length
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|msg
operator|->
name|msg_ie_trnt
condition|)
block|{
name|msg
operator|->
name|msg_ie_trnt
operator|=
name|uma_zalloc
argument_list|(
name|unisig_ie_zone
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|msg_ie_trnt
operator|==
name|NULL
condition|)
block|{
name|err
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|done
goto|;
block|}
block|}
name|bcopy
argument_list|(
operator|&
name|ie_trnt_absent
argument_list|,
operator|&
name|msg
operator|->
name|msg_ie_trnt
operator|->
name|ie_u
operator|.
name|ie_trnt
argument_list|,
sizeof|sizeof
argument_list|(
name|ie_trnt_absent
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|->
name|msg_ie_trnt
operator|->
name|ie_ident
operator|=
name|UNI_IE_TRNT
expr_stmt|;
name|msg
operator|->
name|msg_ie_trnt
operator|->
name|ie_trnt_id_type
operator|=
name|UNI_IE_TRNT_IDT_NATL
expr_stmt|;
name|msg
operator|->
name|msg_ie_trnt
operator|->
name|ie_trnt_id_plan
operator|=
name|UNI_IE_TRNT_IDP_CIC
expr_stmt|;
name|bcopy
argument_list|(
name|ap
operator|->
name|transit
operator|.
name|v
operator|.
name|network_id
argument_list|,
name|msg
operator|->
name|msg_ie_trnt
operator|->
name|ie_trnt_id
argument_list|,
name|ap
operator|->
name|transit
operator|.
name|v
operator|.
name|length
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Set cause code 	 */
if|if
condition|(
name|ap
operator|->
name|cause
operator|.
name|tag
operator|==
name|T_ATM_PRESENT
condition|)
block|{
if|if
condition|(
operator|!
name|msg
operator|->
name|msg_ie_caus
condition|)
block|{
name|msg
operator|->
name|msg_ie_caus
operator|=
name|uma_zalloc
argument_list|(
name|unisig_ie_zone
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|msg_ie_caus
operator|==
name|NULL
condition|)
block|{
name|err
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|done
goto|;
block|}
block|}
name|bcopy
argument_list|(
operator|&
name|ie_caus_absent
argument_list|,
operator|&
name|msg
operator|->
name|msg_ie_caus
operator|->
name|ie_u
operator|.
name|ie_caus
argument_list|,
sizeof|sizeof
argument_list|(
name|ie_caus_absent
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|->
name|msg_ie_caus
operator|->
name|ie_ident
operator|=
name|UNI_IE_CAUS
expr_stmt|;
name|msg
operator|->
name|msg_ie_caus
operator|->
name|ie_coding
operator|=
name|ap
operator|->
name|cause
operator|.
name|v
operator|.
name|coding_standard
expr_stmt|;
name|msg
operator|->
name|msg_ie_caus
operator|->
name|ie_caus_loc
operator|=
name|ap
operator|->
name|cause
operator|.
name|v
operator|.
name|location
expr_stmt|;
name|msg
operator|->
name|msg_ie_caus
operator|->
name|ie_caus_cause
operator|=
name|ap
operator|->
name|cause
operator|.
name|v
operator|.
name|cause_value
expr_stmt|;
comment|/* 		 * Don't copy the diagnostics from the attribute 		 * block, as there's no way to tell how much of 		 * the diagnostic field is relevant 		 */
name|msg
operator|->
name|msg_ie_caus
operator|->
name|ie_caus_diag_len
operator|=
literal|0
expr_stmt|;
block|}
name|done
label|:
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

end_unit


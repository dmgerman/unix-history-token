begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  *  * ===================================  * HARP  |  Host ATM Research Platform  * ===================================  *  *  * This Host ATM Research Platform ("HARP") file (the "Software") is  * made available by Network Computing Services, Inc. ("NetworkCS")  * "AS IS".  NetworkCS does not provide maintenance, improvements or  * support of any kind.  *  * NETWORKCS MAKES NO WARRANTIES OR REPRESENTATIONS, EXPRESS OR IMPLIED,  * INCLUDING, BUT NOT LIMITED TO, IMPLIED WARRANTIES OF MERCHANTABILITY  * AND FITNESS FOR A PARTICULAR PURPOSE, AS TO ANY ELEMENT OF THE  * SOFTWARE OR ANY SUPPORT PROVIDED IN CONNECTION WITH THIS SOFTWARE.  * In no event shall NetworkCS be responsible for any damages, including  * but not limited to consequential damages, arising from or relating to  * any use of the Software or related support.  *  * Copyright 1994-1998 Network Computing Services, Inc.  *  * Copies of this Software may be made, however, the above copyright  * notice must be reproduced on all copies.  *  *	@(#) $FreeBSD$  *  */
end_comment

begin_comment
comment|/*  * ATM Forum UNI Support  * ---------------------  *  * SSCOP - CPCS SAP interface processing  *  */
end_comment

begin_include
include|#
directive|include
file|<netatm/kern_include.h>
end_include

begin_include
include|#
directive|include
file|<netatm/uni/uni.h>
end_include

begin_include
include|#
directive|include
file|<netatm/uni/sscop.h>
end_include

begin_include
include|#
directive|include
file|<netatm/uni/sscop_misc.h>
end_include

begin_include
include|#
directive|include
file|<netatm/uni/sscop_pdu.h>
end_include

begin_include
include|#
directive|include
file|<netatm/uni/sscop_var.h>
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_expr_stmt
name|__RCSID
argument_list|(
literal|"@(#) $FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * Local functions  */
end_comment

begin_decl_stmt
specifier|static
name|caddr_t
name|sscop_pdu_receive
name|__P
argument_list|(
operator|(
name|KBuffer
operator|*
operator|,
expr|struct
name|sscop
operator|*
operator|,
name|int
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Local variables  */
end_comment

begin_union
specifier|static
union|union
block|{
name|struct
name|bgn_pdu
name|t_bgn
decl_stmt|;
name|struct
name|bgak_pdu
name|t_bgak
decl_stmt|;
name|struct
name|end_pdu
name|t_end
decl_stmt|;
name|struct
name|endak_q2110_pdu
name|t_endak_q2110
decl_stmt|;
name|struct
name|endak_qsaal_pdu
name|t_endak_qsaal
decl_stmt|;
name|struct
name|rs_pdu
name|t_rs
decl_stmt|;
name|struct
name|rsak_q2110_pdu
name|t_rsak_q2110
decl_stmt|;
name|struct
name|rsak_qsaal_pdu
name|t_rsak_qsaal
decl_stmt|;
name|struct
name|bgrej_pdu
name|t_bgrej
decl_stmt|;
name|struct
name|sd_pdu
name|t_sd
decl_stmt|;
name|struct
name|sdp_pdu
name|t_sdp
decl_stmt|;
name|struct
name|er_pdu
name|t_er
decl_stmt|;
name|struct
name|poll_pdu
name|t_poll
decl_stmt|;
name|struct
name|stat_pdu
name|t_stat
decl_stmt|;
name|struct
name|ustat_pdu
name|t_ustat
decl_stmt|;
name|struct
name|ud_pdu
name|t_ud
decl_stmt|;
name|struct
name|md_pdu
name|t_md
decl_stmt|;
name|struct
name|erak_pdu
name|t_erak
decl_stmt|;
block|}
name|sscop_trailer
union|;
end_union

begin_comment
comment|/*  * PDU length validation table  */
end_comment

begin_struct
struct|struct
name|pdulen
block|{
name|int
name|min
decl_stmt|;
name|int
name|max
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|struct
name|pdulen
name|qsaal_pdulen
index|[]
init|=
block|{
block|{
literal|0
block|,
literal|0
block|}
block|,
block|{
sizeof|sizeof
argument_list|(
expr|struct
name|bgn_pdu
argument_list|)
block|,
expr|sizeof
operator|(
expr|struct
name|bgn_pdu
operator|)
block|}
block|,
block|{
sizeof|sizeof
argument_list|(
expr|struct
name|bgak_pdu
argument_list|)
block|,
expr|sizeof
operator|(
expr|struct
name|bgak_pdu
operator|)
block|}
block|,
block|{
sizeof|sizeof
argument_list|(
expr|struct
name|end_pdu
argument_list|)
block|,
expr|sizeof
operator|(
expr|struct
name|end_pdu
operator|)
block|}
block|,
block|{
sizeof|sizeof
argument_list|(
expr|struct
name|endak_qsaal_pdu
argument_list|)
block|,
expr|sizeof
operator|(
expr|struct
name|endak_qsaal_pdu
operator|)
block|}
block|,
block|{
sizeof|sizeof
argument_list|(
expr|struct
name|rs_pdu
argument_list|)
block|,
expr|sizeof
operator|(
expr|struct
name|rs_pdu
operator|)
block|}
block|,
block|{
sizeof|sizeof
argument_list|(
expr|struct
name|rsak_qsaal_pdu
argument_list|)
block|,
expr|sizeof
operator|(
expr|struct
name|rsak_qsaal_pdu
operator|)
block|}
block|,
block|{
sizeof|sizeof
argument_list|(
expr|struct
name|bgrej_pdu
argument_list|)
block|,
expr|sizeof
operator|(
expr|struct
name|bgrej_pdu
operator|)
block|}
block|,
block|{
sizeof|sizeof
argument_list|(
expr|struct
name|sd_pdu
argument_list|)
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|sd_pdu
argument_list|)
operator|+
name|PDU_MAX_INFO
block|}
block|,
block|{
sizeof|sizeof
argument_list|(
expr|struct
name|sdp_pdu
argument_list|)
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|sdp_pdu
argument_list|)
operator|+
name|PDU_MAX_INFO
block|}
block|,
block|{
sizeof|sizeof
argument_list|(
expr|struct
name|poll_pdu
argument_list|)
block|,
expr|sizeof
operator|(
expr|struct
name|poll_pdu
operator|)
block|}
block|,
block|{
sizeof|sizeof
argument_list|(
expr|struct
name|stat_pdu
argument_list|)
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|stat_pdu
argument_list|)
operator|+
name|PDU_MAX_STAT
block|}
block|,
block|{
sizeof|sizeof
argument_list|(
expr|struct
name|ustat_pdu
argument_list|)
block|,
expr|sizeof
operator|(
expr|struct
name|ustat_pdu
operator|)
block|}
block|,
block|{
sizeof|sizeof
argument_list|(
expr|struct
name|ud_pdu
argument_list|)
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|ud_pdu
argument_list|)
operator|+
name|PDU_MAX_INFO
block|}
block|,
block|{
sizeof|sizeof
argument_list|(
expr|struct
name|md_pdu
argument_list|)
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|md_pdu
argument_list|)
operator|+
name|PDU_MAX_INFO
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|pdulen
name|q2110_pdulen
index|[]
init|=
block|{
block|{
literal|0
block|,
literal|0
block|}
block|,
block|{
sizeof|sizeof
argument_list|(
expr|struct
name|bgn_pdu
argument_list|)
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|bgn_pdu
argument_list|)
operator|+
name|PDU_MAX_UU
block|}
block|,
block|{
sizeof|sizeof
argument_list|(
expr|struct
name|bgak_pdu
argument_list|)
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|bgak_pdu
argument_list|)
operator|+
name|PDU_MAX_UU
block|}
block|,
block|{
sizeof|sizeof
argument_list|(
expr|struct
name|end_pdu
argument_list|)
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|end_pdu
argument_list|)
operator|+
name|PDU_MAX_UU
block|}
block|,
block|{
sizeof|sizeof
argument_list|(
expr|struct
name|endak_q2110_pdu
argument_list|)
block|,
expr|sizeof
operator|(
expr|struct
name|endak_q2110_pdu
operator|)
block|}
block|,
block|{
sizeof|sizeof
argument_list|(
expr|struct
name|rs_pdu
argument_list|)
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|rs_pdu
argument_list|)
operator|+
name|PDU_MAX_UU
block|}
block|,
block|{
sizeof|sizeof
argument_list|(
expr|struct
name|rsak_q2110_pdu
argument_list|)
block|,
expr|sizeof
operator|(
expr|struct
name|rsak_q2110_pdu
operator|)
block|}
block|,
block|{
sizeof|sizeof
argument_list|(
expr|struct
name|bgrej_pdu
argument_list|)
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|bgrej_pdu
argument_list|)
operator|+
name|PDU_MAX_UU
block|}
block|,
block|{
sizeof|sizeof
argument_list|(
expr|struct
name|sd_pdu
argument_list|)
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|sd_pdu
argument_list|)
operator|+
name|PDU_MAX_INFO
block|}
block|,
block|{
sizeof|sizeof
argument_list|(
expr|struct
name|er_pdu
argument_list|)
block|,
expr|sizeof
operator|(
expr|struct
name|er_pdu
operator|)
block|}
block|,
block|{
sizeof|sizeof
argument_list|(
expr|struct
name|poll_pdu
argument_list|)
block|,
expr|sizeof
operator|(
expr|struct
name|poll_pdu
operator|)
block|}
block|,
block|{
sizeof|sizeof
argument_list|(
expr|struct
name|stat_pdu
argument_list|)
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|stat_pdu
argument_list|)
operator|+
name|PDU_MAX_STAT
block|}
block|,
block|{
sizeof|sizeof
argument_list|(
expr|struct
name|ustat_pdu
argument_list|)
block|,
expr|sizeof
operator|(
expr|struct
name|ustat_pdu
operator|)
block|}
block|,
block|{
sizeof|sizeof
argument_list|(
expr|struct
name|ud_pdu
argument_list|)
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|ud_pdu
argument_list|)
operator|+
name|PDU_MAX_INFO
block|}
block|,
block|{
sizeof|sizeof
argument_list|(
expr|struct
name|md_pdu
argument_list|)
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|md_pdu
argument_list|)
operator|+
name|PDU_MAX_INFO
block|}
block|,
block|{
sizeof|sizeof
argument_list|(
expr|struct
name|erak_pdu
argument_list|)
block|,
expr|sizeof
operator|(
expr|struct
name|erak_pdu
operator|)
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * PDUs with Pad Length Fields  */
end_comment

begin_decl_stmt
specifier|static
name|u_char
name|qsaal_padlen
index|[]
init|=
block|{
literal|0
block|,
comment|/* --- */
literal|0
block|,
comment|/* BGN */
literal|0
block|,
comment|/* BGAK */
literal|0
block|,
comment|/* END */
literal|0
block|,
comment|/* ENDAK */
literal|0
block|,
comment|/* RS */
literal|0
block|,
comment|/* RSAK */
literal|0
block|,
comment|/* BGREJ */
literal|1
block|,
comment|/* SD */
literal|1
block|,
comment|/* SDP */
literal|0
block|,
comment|/* POLL */
literal|0
block|,
comment|/* STAT */
literal|0
block|,
comment|/* USTAT */
literal|1
block|,
comment|/* UD */
literal|1
block|,
comment|/* MD */
literal|0
comment|/* --- */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|u_char
name|q2110_padlen
index|[]
init|=
block|{
literal|0
block|,
comment|/* --- */
literal|1
block|,
comment|/* BGN */
literal|1
block|,
comment|/* BGAK */
literal|1
block|,
comment|/* END */
literal|0
block|,
comment|/* ENDAK */
literal|1
block|,
comment|/* RS */
literal|0
block|,
comment|/* RSAK */
literal|1
block|,
comment|/* BGREJ */
literal|1
block|,
comment|/* SD */
literal|0
block|,
comment|/* ER */
literal|0
block|,
comment|/* POLL */
literal|0
block|,
comment|/* STAT */
literal|0
block|,
comment|/* USTAT */
literal|1
block|,
comment|/* UD */
literal|1
block|,
comment|/* MD */
literal|0
comment|/* ERAK */
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * SSCOP Upper Stack Command Handler  *   * This function will receive all of the stack commands issued from the   * layer below SSCOP (ie. CPCS).  Currently, only incoming PDUs will be  * received here.  The appropriate processing function will be determined   * based on the received PDU type and the current sscop control block state.  *  * Arguments:  *	cmd	stack command code  *	tok	session token  *	arg1	command specific argument  *	arg2	command specific argument  *  * Returns:  *	none  *  */
end_comment

begin_function
name|void
name|sscop_upper
parameter_list|(
name|cmd
parameter_list|,
name|tok
parameter_list|,
name|arg1
parameter_list|,
name|arg2
parameter_list|)
name|int
name|cmd
decl_stmt|;
name|void
modifier|*
name|tok
decl_stmt|;
name|int
name|arg1
decl_stmt|;
name|int
name|arg2
decl_stmt|;
block|{
name|struct
name|sscop
modifier|*
name|sop
init|=
operator|(
expr|struct
name|sscop
operator|*
operator|)
name|tok
decl_stmt|;
name|void
argument_list|(
argument|**ptab
argument_list|)
name|__P
argument_list|(
operator|(
expr|struct
name|sscop
operator|*
operator|,
name|KBuffer
operator|*
operator|,
name|caddr_t
operator|)
argument_list|)
expr_stmt|;
name|void
argument_list|(
argument|*func
argument_list|)
name|__P
argument_list|(
operator|(
expr|struct
name|sscop
operator|*
operator|,
name|KBuffer
operator|*
operator|,
name|caddr_t
operator|)
argument_list|)
expr_stmt|;
name|caddr_t
name|trlr
decl_stmt|;
name|int
name|type
decl_stmt|;
name|ATM_DEBUG5
argument_list|(
literal|"sscop_upper: cmd=0x%x, sop=%p, state=%d, arg1=0x%x, arg2=0x%x\n"
argument_list|,
name|cmd
argument_list|,
name|sop
argument_list|,
name|sop
operator|->
name|so_state
argument_list|,
name|arg1
argument_list|,
name|arg2
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|CPCS_UNITDATA_SIG
case|:
comment|/* 		 * Decode/validate received PDU 		 */
name|trlr
operator|=
name|sscop_pdu_receive
argument_list|(
operator|(
name|KBuffer
operator|*
operator|)
name|arg1
argument_list|,
name|sop
argument_list|,
operator|&
name|type
argument_list|)
expr_stmt|;
if|if
condition|(
name|trlr
operator|==
name|NULL
condition|)
block|{
return|return;
block|}
comment|/* 		 * Validate sscop state 		 */
if|if
condition|(
name|sop
operator|->
name|so_state
operator|>
name|SOS_MAXSTATE
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"sscop_upper: invalid state sop=%p, state=%d\n"
argument_list|,
name|sop
argument_list|,
name|sop
operator|->
name|so_state
argument_list|)
expr_stmt|;
name|KB_FREEALL
argument_list|(
operator|(
name|KBuffer
operator|*
operator|)
name|arg1
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 		 * Call event processing function 		 */
name|ptab
operator|=
name|sop
operator|->
name|so_vers
operator|==
name|SSCOP_VERS_QSAAL
condition|?
name|sscop_qsaal_pdutab
index|[
name|type
index|]
else|:
name|sscop_q2110_pdutab
index|[
name|type
index|]
expr_stmt|;
name|func
operator|=
name|ptab
index|[
name|sop
operator|->
name|so_state
index|]
expr_stmt|;
if|if
condition|(
name|func
operator|==
name|NULL
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"sscop_upper: unsupported pdu=%d, state=%d\n"
argument_list|,
name|type
argument_list|,
name|sop
operator|->
name|so_state
argument_list|)
expr_stmt|;
break|break;
block|}
call|(
modifier|*
name|func
call|)
argument_list|(
name|sop
argument_list|,
operator|(
name|KBuffer
operator|*
operator|)
name|arg1
argument_list|,
name|trlr
argument_list|)
expr_stmt|;
break|break;
default|default:
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"sscop_upper: unknown cmd 0x%x, sop=%p\n"
argument_list|,
name|cmd
argument_list|,
name|sop
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_comment
comment|/*  * Decode and Validate Received PDU  *   * This function will process all received SSCOP PDUs.  The PDU type will be  * determined and PDU format validation will be performed.  If the PDU is  * successfully decoded and validated, the buffer chain will have the PDU  * trailer removed, but any resultant zero-length buffers will NOT be freed.    * If the PDU fails validation, then the buffer chain will be freed.  *  * Arguments:  *	m	pointer to PDU buffer chain  *	sop	pointer to sscop connection block  *	typep	address to store PDU type  *  * Returns:  *	addr	pointer to (contiguous) PDU trailer  *	0	invalid PDU, buffer chain freed  *  */
end_comment

begin_function
specifier|static
name|caddr_t
name|sscop_pdu_receive
parameter_list|(
name|m
parameter_list|,
name|sop
parameter_list|,
name|typep
parameter_list|)
name|KBuffer
modifier|*
name|m
decl_stmt|;
name|struct
name|sscop
modifier|*
name|sop
decl_stmt|;
name|int
modifier|*
name|typep
decl_stmt|;
block|{
name|KBuffer
modifier|*
name|m0
decl_stmt|,
modifier|*
name|ml
decl_stmt|,
modifier|*
name|mn
decl_stmt|;
name|caddr_t
name|cp
decl_stmt|,
name|tp
decl_stmt|;
name|int
name|len
decl_stmt|,
name|tlen
decl_stmt|,
name|type
decl_stmt|,
name|plen
decl_stmt|;
comment|/* 	 * Calculate PDU length and find the last two buffers in the chain 	 */
name|len
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|m0
operator|=
name|m
operator|,
name|ml
operator|=
name|mn
operator|=
name|NULL
init|;
name|m0
condition|;
name|m0
operator|=
name|KB_NEXT
argument_list|(
name|m0
argument_list|)
control|)
block|{
name|len
operator|+=
name|KB_LEN
argument_list|(
name|m0
argument_list|)
expr_stmt|;
name|mn
operator|=
name|ml
expr_stmt|;
name|ml
operator|=
name|m0
expr_stmt|;
block|}
comment|/* 	 * Make sure we've got a minimum sized PDU 	 */
if|if
condition|(
name|len
operator|<
name|PDU_MIN_LEN
condition|)
goto|goto
name|badpdu
goto|;
comment|/* 	 * Get PDU type field 	 */
if|if
condition|(
name|KB_LEN
argument_list|(
name|ml
argument_list|)
operator|>=
name|PDU_MIN_LEN
condition|)
block|{
name|KB_DATAEND
argument_list|(
name|ml
argument_list|,
name|tp
argument_list|,
name|caddr_t
argument_list|)
expr_stmt|;
name|tp
operator|-=
name|PDU_MIN_LEN
expr_stmt|;
block|}
else|else
block|{
name|KB_DATAEND
argument_list|(
name|mn
argument_list|,
name|tp
argument_list|,
name|caddr_t
argument_list|)
expr_stmt|;
name|tp
operator|-=
operator|(
name|PDU_MIN_LEN
operator|-
name|KB_LEN
argument_list|(
name|ml
argument_list|)
operator|)
expr_stmt|;
block|}
operator|*
name|typep
operator|=
name|type
operator|=
operator|*
name|tp
operator|&
name|PT_TYPE_MASK
expr_stmt|;
comment|/* 	 * Check up on PDU length 	 */
if|if
condition|(
name|sop
operator|->
name|so_vers
operator|==
name|SSCOP_VERS_QSAAL
condition|)
block|{
if|if
condition|(
operator|(
name|len
operator|<
operator|(
name|tlen
operator|=
name|qsaal_pdulen
index|[
name|type
index|]
operator|.
name|min
operator|)
operator|)
operator|||
operator|(
name|len
operator|>
name|qsaal_pdulen
index|[
name|type
index|]
operator|.
name|max
operator|)
operator|||
operator|(
name|len
operator|&
name|PDU_LEN_MASK
operator|)
condition|)
goto|goto
name|badpdu
goto|;
block|}
else|else
block|{
if|if
condition|(
operator|(
name|len
operator|<
operator|(
name|tlen
operator|=
name|q2110_pdulen
index|[
name|type
index|]
operator|.
name|min
operator|)
operator|)
operator|||
operator|(
name|len
operator|>
name|q2110_pdulen
index|[
name|type
index|]
operator|.
name|max
operator|)
operator|||
operator|(
name|len
operator|&
name|PDU_LEN_MASK
operator|)
condition|)
goto|goto
name|badpdu
goto|;
block|}
comment|/* 	 * Get a contiguous, aligned PDU trailer and adjust buffer 	 * controls to remove trailer 	 */
if|if
condition|(
name|KB_LEN
argument_list|(
name|ml
argument_list|)
operator|>=
name|tlen
condition|)
block|{
comment|/* 		 * Trailer is contained in last buffer 		 */
name|KB_TAILADJ
argument_list|(
name|ml
argument_list|,
operator|-
name|tlen
argument_list|)
expr_stmt|;
name|KB_DATAEND
argument_list|(
name|ml
argument_list|,
name|cp
argument_list|,
name|caddr_t
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|int
operator|)
name|cp
operator|&
name|PDU_ADDR_MASK
condition|)
block|{
comment|/* 			 * Trailer not aligned in buffer, use local memory 			 */
name|KM_COPY
argument_list|(
name|cp
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|sscop_trailer
argument_list|,
name|tlen
argument_list|)
expr_stmt|;
name|cp
operator|=
operator|(
name|caddr_t
operator|)
operator|&
name|sscop_trailer
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* 		 * Trailer is split across buffers, use local memory 		 */
name|caddr_t
name|cp1
decl_stmt|;
name|int
name|off
init|=
name|tlen
operator|-
name|KB_LEN
argument_list|(
name|ml
argument_list|)
decl_stmt|;
name|cp
operator|=
operator|(
name|caddr_t
operator|)
operator|&
name|sscop_trailer
expr_stmt|;
comment|/* 		 * Ensure trailer is within last two buffers 		 */
if|if
condition|(
operator|(
name|mn
operator|==
name|NULL
operator|)
operator|||
operator|(
name|KB_LEN
argument_list|(
name|mn
argument_list|)
operator|<
name|off
operator|)
condition|)
goto|goto
name|badpdu
goto|;
name|KB_DATASTART
argument_list|(
name|ml
argument_list|,
name|cp1
argument_list|,
name|caddr_t
argument_list|)
expr_stmt|;
name|KM_COPY
argument_list|(
name|cp1
argument_list|,
name|cp
operator|+
name|off
argument_list|,
name|KB_LEN
argument_list|(
name|ml
argument_list|)
argument_list|)
expr_stmt|;
name|KB_LEN
argument_list|(
name|ml
argument_list|)
operator|=
literal|0
expr_stmt|;
name|KB_TAILADJ
argument_list|(
name|mn
argument_list|,
operator|-
name|off
argument_list|)
expr_stmt|;
name|KB_DATAEND
argument_list|(
name|mn
argument_list|,
name|cp1
argument_list|,
name|caddr_t
argument_list|)
expr_stmt|;
name|KM_COPY
argument_list|(
name|cp1
argument_list|,
name|cp
argument_list|,
name|off
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Get possible PDU Pad Length 	 */
if|if
condition|(
name|sop
operator|->
name|so_vers
operator|==
name|SSCOP_VERS_QSAAL
condition|)
block|{
if|if
condition|(
name|qsaal_padlen
index|[
name|type
index|]
condition|)
name|plen
operator|=
operator|(
operator|*
name|tp
operator|&
name|PT_PAD_MASK
operator|)
operator|>>
name|PT_PAD_SHIFT
expr_stmt|;
else|else
name|plen
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|q2110_padlen
index|[
name|type
index|]
condition|)
name|plen
operator|=
operator|(
operator|*
name|tp
operator|&
name|PT_PAD_MASK
operator|)
operator|>>
name|PT_PAD_SHIFT
expr_stmt|;
else|else
name|plen
operator|=
literal|0
expr_stmt|;
block|}
comment|/* 	 * Perform Pad Length adjustments  	 */
if|if
condition|(
name|plen
condition|)
block|{
if|if
condition|(
name|KB_LEN
argument_list|(
name|ml
argument_list|)
operator|>=
name|plen
condition|)
block|{
comment|/* 			 * All pad bytes in last buffer 			 */
name|KB_TAILADJ
argument_list|(
name|ml
argument_list|,
operator|-
name|plen
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* 			 * Pad bytes split between buffers 			 */
name|plen
operator|-=
name|KB_LEN
argument_list|(
name|ml
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|mn
operator|==
name|NULL
operator|)
operator|||
operator|(
name|KB_LEN
argument_list|(
name|mn
argument_list|)
operator|<
name|plen
operator|)
condition|)
goto|goto
name|badpdu
goto|;
name|KB_LEN
argument_list|(
name|ml
argument_list|)
operator|=
literal|0
expr_stmt|;
name|KB_TAILADJ
argument_list|(
name|mn
argument_list|,
operator|-
name|plen
argument_list|)
expr_stmt|;
block|}
block|}
return|return
operator|(
name|cp
operator|)
return|;
name|badpdu
label|:
comment|/* 	 * This MAA Error is only supposed to be for a PDU length violation, 	 * but we use it for any PDU format error. 	 */
name|sscop_maa_error
argument_list|(
name|sop
argument_list|,
literal|'U'
argument_list|)
expr_stmt|;
name|sscop_pdu_print
argument_list|(
name|sop
argument_list|,
name|m
argument_list|,
literal|"badpdu received"
argument_list|)
expr_stmt|;
name|KB_FREEALL
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

end_unit


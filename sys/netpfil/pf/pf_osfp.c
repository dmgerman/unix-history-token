begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2003 Mike Frantzen<frantzen@w4g.org>  *  * Permission to use, copy, modify, and distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES  * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF  * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR  * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES  * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN  * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF  * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.  *  *	$OpenBSD: pf_osfp.c,v 1.14 2008/06/12 18:17:01 henning Exp $  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/rwlock.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip.h>
end_include

begin_include
include|#
directive|include
file|<netinet/tcp.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/vnet.h>
end_include

begin_include
include|#
directive|include
file|<net/pfvar.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip6.h>
end_include

begin_expr_stmt
specifier|static
name|MALLOC_DEFINE
argument_list|(
name|M_PFOSFP
argument_list|,
literal|"pf_osfp"
argument_list|,
literal|"pf(4) operating system fingerprints"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_define
define|#
directive|define
name|DPFPRINTF
parameter_list|(
name|format
parameter_list|,
name|x
modifier|...
parameter_list|)
define|\
value|if (V_pf_status.debug>= PF_DEBUG_NOISY)	\ 		printf(format , ##x)
end_define

begin_expr_stmt
name|SLIST_HEAD
argument_list|(
name|pf_osfp_list
argument_list|,
name|pf_os_fingerprint
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|VNET_DEFINE
argument_list|(
expr|struct
name|pf_osfp_list
argument_list|,
name|pf_osfp_list
argument_list|)
operator|=
name|SLIST_HEAD_INITIALIZER
argument_list|()
expr_stmt|;
end_expr_stmt

begin_define
define|#
directive|define
name|V_pf_osfp_list
value|VNET(pf_osfp_list)
end_define

begin_function_decl
specifier|static
name|struct
name|pf_osfp_enlist
modifier|*
name|pf_osfp_fingerprint_hdr
parameter_list|(
specifier|const
name|struct
name|ip
modifier|*
parameter_list|,
specifier|const
name|struct
name|ip6_hdr
modifier|*
parameter_list|,
specifier|const
name|struct
name|tcphdr
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|pf_os_fingerprint
modifier|*
name|pf_osfp_find
parameter_list|(
name|struct
name|pf_osfp_list
modifier|*
parameter_list|,
name|struct
name|pf_os_fingerprint
modifier|*
parameter_list|,
name|u_int8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|pf_os_fingerprint
modifier|*
name|pf_osfp_find_exact
parameter_list|(
name|struct
name|pf_osfp_list
modifier|*
parameter_list|,
name|struct
name|pf_os_fingerprint
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|pf_osfp_insert
parameter_list|(
name|struct
name|pf_osfp_list
modifier|*
parameter_list|,
name|struct
name|pf_os_fingerprint
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|PFDEBUG
end_ifdef

begin_function_decl
specifier|static
name|struct
name|pf_os_fingerprint
modifier|*
name|pf_osfp_validate
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * Passively fingerprint the OS of the host (IPv4 TCP SYN packets only)  * Returns the list of possible OSes.  */
end_comment

begin_function
name|struct
name|pf_osfp_enlist
modifier|*
name|pf_osfp_fingerprint
parameter_list|(
name|struct
name|pf_pdesc
modifier|*
name|pd
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|int
name|off
parameter_list|,
specifier|const
name|struct
name|tcphdr
modifier|*
name|tcp
parameter_list|)
block|{
name|struct
name|ip
modifier|*
name|ip
decl_stmt|;
name|struct
name|ip6_hdr
modifier|*
name|ip6
decl_stmt|;
name|char
name|hdr
index|[
literal|60
index|]
decl_stmt|;
if|if
condition|(
operator|(
name|pd
operator|->
name|af
operator|!=
name|PF_INET
operator|&&
name|pd
operator|->
name|af
operator|!=
name|PF_INET6
operator|)
operator|||
name|pd
operator|->
name|proto
operator|!=
name|IPPROTO_TCP
operator|||
operator|(
name|tcp
operator|->
name|th_off
operator|<<
literal|2
operator|)
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|tcp
argument_list|)
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
if|if
condition|(
name|pd
operator|->
name|af
operator|==
name|PF_INET
condition|)
block|{
name|ip
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ip
operator|*
argument_list|)
expr_stmt|;
name|ip6
operator|=
operator|(
expr|struct
name|ip6_hdr
operator|*
operator|)
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|ip
operator|=
operator|(
expr|struct
name|ip
operator|*
operator|)
name|NULL
expr_stmt|;
name|ip6
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ip6_hdr
operator|*
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|pf_pull_hdr
argument_list|(
name|m
argument_list|,
name|off
argument_list|,
name|hdr
argument_list|,
name|tcp
operator|->
name|th_off
operator|<<
literal|2
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|pd
operator|->
name|af
argument_list|)
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
return|return
operator|(
name|pf_osfp_fingerprint_hdr
argument_list|(
name|ip
argument_list|,
name|ip6
argument_list|,
operator|(
expr|struct
name|tcphdr
operator|*
operator|)
name|hdr
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|pf_osfp_enlist
modifier|*
name|pf_osfp_fingerprint_hdr
parameter_list|(
specifier|const
name|struct
name|ip
modifier|*
name|ip
parameter_list|,
specifier|const
name|struct
name|ip6_hdr
modifier|*
name|ip6
parameter_list|,
specifier|const
name|struct
name|tcphdr
modifier|*
name|tcp
parameter_list|)
block|{
name|struct
name|pf_os_fingerprint
name|fp
decl_stmt|,
modifier|*
name|fpresult
decl_stmt|;
name|int
name|cnt
decl_stmt|,
name|optlen
init|=
literal|0
decl_stmt|;
specifier|const
name|u_int8_t
modifier|*
name|optp
decl_stmt|;
name|char
name|srcname
index|[
literal|128
index|]
decl_stmt|;
if|if
condition|(
operator|(
name|tcp
operator|->
name|th_flags
operator|&
operator|(
name|TH_SYN
operator||
name|TH_ACK
operator|)
operator|)
operator|!=
name|TH_SYN
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
if|if
condition|(
name|ip
condition|)
block|{
if|if
condition|(
operator|(
name|ip
operator|->
name|ip_off
operator|&
name|htons
argument_list|(
name|IP_OFFMASK
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|memset
argument_list|(
operator|&
name|fp
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|fp
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ip
condition|)
block|{
name|fp
operator|.
name|fp_psize
operator|=
name|ntohs
argument_list|(
name|ip
operator|->
name|ip_len
argument_list|)
expr_stmt|;
name|fp
operator|.
name|fp_ttl
operator|=
name|ip
operator|->
name|ip_ttl
expr_stmt|;
if|if
condition|(
name|ip
operator|->
name|ip_off
operator|&
name|htons
argument_list|(
name|IP_DF
argument_list|)
condition|)
name|fp
operator|.
name|fp_flags
operator||=
name|PF_OSFP_DF
expr_stmt|;
name|strlcpy
argument_list|(
name|srcname
argument_list|,
name|inet_ntoa
argument_list|(
name|ip
operator|->
name|ip_src
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|srcname
argument_list|)
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|INET6
elseif|else
if|if
condition|(
name|ip6
condition|)
block|{
comment|/* jumbo payload? */
name|fp
operator|.
name|fp_psize
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ip6_hdr
argument_list|)
operator|+
name|ntohs
argument_list|(
name|ip6
operator|->
name|ip6_plen
argument_list|)
expr_stmt|;
name|fp
operator|.
name|fp_ttl
operator|=
name|ip6
operator|->
name|ip6_hlim
expr_stmt|;
name|fp
operator|.
name|fp_flags
operator||=
name|PF_OSFP_DF
expr_stmt|;
name|fp
operator|.
name|fp_flags
operator||=
name|PF_OSFP_INET6
expr_stmt|;
name|strlcpy
argument_list|(
name|srcname
argument_list|,
name|ip6_sprintf
argument_list|(
operator|(
expr|struct
name|in6_addr
operator|*
operator|)
operator|&
name|ip6
operator|->
name|ip6_src
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|srcname
argument_list|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
else|else
return|return
operator|(
name|NULL
operator|)
return|;
name|fp
operator|.
name|fp_wsize
operator|=
name|ntohs
argument_list|(
name|tcp
operator|->
name|th_win
argument_list|)
expr_stmt|;
name|cnt
operator|=
operator|(
name|tcp
operator|->
name|th_off
operator|<<
literal|2
operator|)
operator|-
sizeof|sizeof
argument_list|(
operator|*
name|tcp
argument_list|)
expr_stmt|;
name|optp
operator|=
operator|(
specifier|const
name|u_int8_t
operator|*
operator|)
operator|(
operator|(
specifier|const
name|char
operator|*
operator|)
name|tcp
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|tcp
argument_list|)
operator|)
expr_stmt|;
for|for
control|(
init|;
name|cnt
operator|>
literal|0
condition|;
name|cnt
operator|-=
name|optlen
operator|,
name|optp
operator|+=
name|optlen
control|)
block|{
if|if
condition|(
operator|*
name|optp
operator|==
name|TCPOPT_EOL
condition|)
break|break;
name|fp
operator|.
name|fp_optcnt
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|optp
operator|==
name|TCPOPT_NOP
condition|)
block|{
name|fp
operator|.
name|fp_tcpopts
operator|=
operator|(
name|fp
operator|.
name|fp_tcpopts
operator|<<
name|PF_OSFP_TCPOPT_BITS
operator|)
operator||
name|PF_OSFP_TCPOPT_NOP
expr_stmt|;
name|optlen
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|cnt
operator|<
literal|2
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|optlen
operator|=
name|optp
index|[
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|optlen
operator|>
name|cnt
operator|||
name|optlen
operator|<
literal|2
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
switch|switch
condition|(
operator|*
name|optp
condition|)
block|{
case|case
name|TCPOPT_MAXSEG
case|:
if|if
condition|(
name|optlen
operator|>=
name|TCPOLEN_MAXSEG
condition|)
name|memcpy
argument_list|(
operator|&
name|fp
operator|.
name|fp_mss
argument_list|,
operator|&
name|optp
index|[
literal|2
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|fp
operator|.
name|fp_mss
argument_list|)
argument_list|)
expr_stmt|;
name|fp
operator|.
name|fp_tcpopts
operator|=
operator|(
name|fp
operator|.
name|fp_tcpopts
operator|<<
name|PF_OSFP_TCPOPT_BITS
operator|)
operator||
name|PF_OSFP_TCPOPT_MSS
expr_stmt|;
name|NTOHS
argument_list|(
name|fp
operator|.
name|fp_mss
argument_list|)
expr_stmt|;
break|break;
case|case
name|TCPOPT_WINDOW
case|:
if|if
condition|(
name|optlen
operator|>=
name|TCPOLEN_WINDOW
condition|)
name|memcpy
argument_list|(
operator|&
name|fp
operator|.
name|fp_wscale
argument_list|,
operator|&
name|optp
index|[
literal|2
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|fp
operator|.
name|fp_wscale
argument_list|)
argument_list|)
expr_stmt|;
name|NTOHS
argument_list|(
name|fp
operator|.
name|fp_wscale
argument_list|)
expr_stmt|;
name|fp
operator|.
name|fp_tcpopts
operator|=
operator|(
name|fp
operator|.
name|fp_tcpopts
operator|<<
name|PF_OSFP_TCPOPT_BITS
operator|)
operator||
name|PF_OSFP_TCPOPT_WSCALE
expr_stmt|;
break|break;
case|case
name|TCPOPT_SACK_PERMITTED
case|:
name|fp
operator|.
name|fp_tcpopts
operator|=
operator|(
name|fp
operator|.
name|fp_tcpopts
operator|<<
name|PF_OSFP_TCPOPT_BITS
operator|)
operator||
name|PF_OSFP_TCPOPT_SACK
expr_stmt|;
break|break;
case|case
name|TCPOPT_TIMESTAMP
case|:
if|if
condition|(
name|optlen
operator|>=
name|TCPOLEN_TIMESTAMP
condition|)
block|{
name|u_int32_t
name|ts
decl_stmt|;
name|memcpy
argument_list|(
operator|&
name|ts
argument_list|,
operator|&
name|optp
index|[
literal|2
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|ts
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ts
operator|==
literal|0
condition|)
name|fp
operator|.
name|fp_flags
operator||=
name|PF_OSFP_TS0
expr_stmt|;
block|}
name|fp
operator|.
name|fp_tcpopts
operator|=
operator|(
name|fp
operator|.
name|fp_tcpopts
operator|<<
name|PF_OSFP_TCPOPT_BITS
operator|)
operator||
name|PF_OSFP_TCPOPT_TS
expr_stmt|;
break|break;
default|default:
return|return
operator|(
name|NULL
operator|)
return|;
block|}
block|}
name|optlen
operator|=
name|MAX
argument_list|(
name|optlen
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* paranoia */
block|}
name|DPFPRINTF
argument_list|(
literal|"fingerprinted %s:%d  %d:%d:%d:%d:%llx (%d) "
literal|"(TS=%s,M=%s%d,W=%s%d)\n"
argument_list|,
name|srcname
argument_list|,
name|ntohs
argument_list|(
name|tcp
operator|->
name|th_sport
argument_list|)
argument_list|,
name|fp
operator|.
name|fp_wsize
argument_list|,
name|fp
operator|.
name|fp_ttl
argument_list|,
operator|(
name|fp
operator|.
name|fp_flags
operator|&
name|PF_OSFP_DF
operator|)
operator|!=
literal|0
argument_list|,
name|fp
operator|.
name|fp_psize
argument_list|,
operator|(
name|long
name|long
name|int
operator|)
name|fp
operator|.
name|fp_tcpopts
argument_list|,
name|fp
operator|.
name|fp_optcnt
argument_list|,
operator|(
name|fp
operator|.
name|fp_flags
operator|&
name|PF_OSFP_TS0
operator|)
condition|?
literal|"0"
else|:
literal|""
argument_list|,
operator|(
name|fp
operator|.
name|fp_flags
operator|&
name|PF_OSFP_MSS_MOD
operator|)
condition|?
literal|"%"
else|:
operator|(
name|fp
operator|.
name|fp_flags
operator|&
name|PF_OSFP_MSS_DC
operator|)
condition|?
literal|"*"
else|:
literal|""
argument_list|,
name|fp
operator|.
name|fp_mss
argument_list|,
operator|(
name|fp
operator|.
name|fp_flags
operator|&
name|PF_OSFP_WSCALE_MOD
operator|)
condition|?
literal|"%"
else|:
operator|(
name|fp
operator|.
name|fp_flags
operator|&
name|PF_OSFP_WSCALE_DC
operator|)
condition|?
literal|"*"
else|:
literal|""
argument_list|,
name|fp
operator|.
name|fp_wscale
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fpresult
operator|=
name|pf_osfp_find
argument_list|(
operator|&
name|V_pf_osfp_list
argument_list|,
operator|&
name|fp
argument_list|,
name|PF_OSFP_MAXTTL_OFFSET
argument_list|)
operator|)
condition|)
return|return
operator|(
operator|&
name|fpresult
operator|->
name|fp_oses
operator|)
return|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Match a fingerprint ID against a list of OSes */
end_comment

begin_function
name|int
name|pf_osfp_match
parameter_list|(
name|struct
name|pf_osfp_enlist
modifier|*
name|list
parameter_list|,
name|pf_osfp_t
name|os
parameter_list|)
block|{
name|struct
name|pf_osfp_entry
modifier|*
name|entry
decl_stmt|;
name|int
name|os_class
decl_stmt|,
name|os_version
decl_stmt|,
name|os_subtype
decl_stmt|;
name|int
name|en_class
decl_stmt|,
name|en_version
decl_stmt|,
name|en_subtype
decl_stmt|;
if|if
condition|(
name|os
operator|==
name|PF_OSFP_ANY
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
name|list
operator|==
name|NULL
condition|)
block|{
name|DPFPRINTF
argument_list|(
literal|"osfp no match against %x\n"
argument_list|,
name|os
argument_list|)
expr_stmt|;
return|return
operator|(
name|os
operator|==
name|PF_OSFP_UNKNOWN
operator|)
return|;
block|}
name|PF_OSFP_UNPACK
argument_list|(
name|os
argument_list|,
name|os_class
argument_list|,
name|os_version
argument_list|,
name|os_subtype
argument_list|)
expr_stmt|;
name|SLIST_FOREACH
argument_list|(
argument|entry
argument_list|,
argument|list
argument_list|,
argument|fp_entry
argument_list|)
block|{
name|PF_OSFP_UNPACK
argument_list|(
name|entry
operator|->
name|fp_os
argument_list|,
name|en_class
argument_list|,
name|en_version
argument_list|,
name|en_subtype
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|os_class
operator|==
name|PF_OSFP_ANY
operator|||
name|en_class
operator|==
name|os_class
operator|)
operator|&&
operator|(
name|os_version
operator|==
name|PF_OSFP_ANY
operator|||
name|en_version
operator|==
name|os_version
operator|)
operator|&&
operator|(
name|os_subtype
operator|==
name|PF_OSFP_ANY
operator|||
name|en_subtype
operator|==
name|os_subtype
operator|)
condition|)
block|{
name|DPFPRINTF
argument_list|(
literal|"osfp matched %s %s %s  %x==%x\n"
argument_list|,
name|entry
operator|->
name|fp_class_nm
argument_list|,
name|entry
operator|->
name|fp_version_nm
argument_list|,
name|entry
operator|->
name|fp_subtype_nm
argument_list|,
name|os
argument_list|,
name|entry
operator|->
name|fp_os
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
block|}
name|DPFPRINTF
argument_list|(
literal|"fingerprint 0x%x didn't match\n"
argument_list|,
name|os
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Flush the fingerprint list */
end_comment

begin_function
name|void
name|pf_osfp_flush
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|pf_os_fingerprint
modifier|*
name|fp
decl_stmt|;
name|struct
name|pf_osfp_entry
modifier|*
name|entry
decl_stmt|;
while|while
condition|(
operator|(
name|fp
operator|=
name|SLIST_FIRST
argument_list|(
operator|&
name|V_pf_osfp_list
argument_list|)
operator|)
condition|)
block|{
name|SLIST_REMOVE_HEAD
argument_list|(
operator|&
name|V_pf_osfp_list
argument_list|,
name|fp_next
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|entry
operator|=
name|SLIST_FIRST
argument_list|(
operator|&
name|fp
operator|->
name|fp_oses
argument_list|)
operator|)
condition|)
block|{
name|SLIST_REMOVE_HEAD
argument_list|(
operator|&
name|fp
operator|->
name|fp_oses
argument_list|,
name|fp_entry
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|entry
argument_list|,
name|M_PFOSFP
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|fp
argument_list|,
name|M_PFOSFP
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* Add a fingerprint */
end_comment

begin_function
name|int
name|pf_osfp_add
parameter_list|(
name|struct
name|pf_osfp_ioctl
modifier|*
name|fpioc
parameter_list|)
block|{
name|struct
name|pf_os_fingerprint
modifier|*
name|fp
decl_stmt|,
name|fpadd
decl_stmt|;
name|struct
name|pf_osfp_entry
modifier|*
name|entry
decl_stmt|;
name|PF_RULES_WASSERT
argument_list|()
expr_stmt|;
name|memset
argument_list|(
operator|&
name|fpadd
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|fpadd
argument_list|)
argument_list|)
expr_stmt|;
name|fpadd
operator|.
name|fp_tcpopts
operator|=
name|fpioc
operator|->
name|fp_tcpopts
expr_stmt|;
name|fpadd
operator|.
name|fp_wsize
operator|=
name|fpioc
operator|->
name|fp_wsize
expr_stmt|;
name|fpadd
operator|.
name|fp_psize
operator|=
name|fpioc
operator|->
name|fp_psize
expr_stmt|;
name|fpadd
operator|.
name|fp_mss
operator|=
name|fpioc
operator|->
name|fp_mss
expr_stmt|;
name|fpadd
operator|.
name|fp_flags
operator|=
name|fpioc
operator|->
name|fp_flags
expr_stmt|;
name|fpadd
operator|.
name|fp_optcnt
operator|=
name|fpioc
operator|->
name|fp_optcnt
expr_stmt|;
name|fpadd
operator|.
name|fp_wscale
operator|=
name|fpioc
operator|->
name|fp_wscale
expr_stmt|;
name|fpadd
operator|.
name|fp_ttl
operator|=
name|fpioc
operator|->
name|fp_ttl
expr_stmt|;
if|#
directive|if
literal|0
comment|/* XXX RYAN wants to fix logging */
block|DPFPRINTF("adding osfp %s %s %s = %s%d:%d:%d:%s%d:0x%llx %d " 	    "(TS=%s,M=%s%d,W=%s%d) %x\n", 	    fpioc->fp_os.fp_class_nm, fpioc->fp_os.fp_version_nm, 	    fpioc->fp_os.fp_subtype_nm, 	    (fpadd.fp_flags& PF_OSFP_WSIZE_MOD) ? "%" : 	    (fpadd.fp_flags& PF_OSFP_WSIZE_MSS) ? "S" : 	    (fpadd.fp_flags& PF_OSFP_WSIZE_MTU) ? "T" : 	    (fpadd.fp_flags& PF_OSFP_WSIZE_DC) ? "*" : "", 	    fpadd.fp_wsize, 	    fpadd.fp_ttl, 	    (fpadd.fp_flags& PF_OSFP_DF) ? 1 : 0, 	    (fpadd.fp_flags& PF_OSFP_PSIZE_MOD) ? "%" : 	    (fpadd.fp_flags& PF_OSFP_PSIZE_DC) ? "*" : "", 	    fpadd.fp_psize, 	    (long long int)fpadd.fp_tcpopts, fpadd.fp_optcnt, 	    (fpadd.fp_flags& PF_OSFP_TS0) ? "0" : "", 	    (fpadd.fp_flags& PF_OSFP_MSS_MOD) ? "%" : 	    (fpadd.fp_flags& PF_OSFP_MSS_DC) ? "*" : "", 	    fpadd.fp_mss, 	    (fpadd.fp_flags& PF_OSFP_WSCALE_MOD) ? "%" : 	    (fpadd.fp_flags& PF_OSFP_WSCALE_DC) ? "*" : "", 	    fpadd.fp_wscale, 	    fpioc->fp_os.fp_os);
endif|#
directive|endif
if|if
condition|(
operator|(
name|fp
operator|=
name|pf_osfp_find_exact
argument_list|(
operator|&
name|V_pf_osfp_list
argument_list|,
operator|&
name|fpadd
argument_list|)
operator|)
condition|)
block|{
name|SLIST_FOREACH
argument_list|(
argument|entry
argument_list|,
argument|&fp->fp_oses
argument_list|,
argument|fp_entry
argument_list|)
block|{
if|if
condition|(
name|PF_OSFP_ENTRY_EQ
argument_list|(
name|entry
argument_list|,
operator|&
name|fpioc
operator|->
name|fp_os
argument_list|)
condition|)
return|return
operator|(
name|EEXIST
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|entry
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|entry
argument_list|)
argument_list|,
name|M_PFOSFP
argument_list|,
name|M_NOWAIT
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
else|else
block|{
if|if
condition|(
operator|(
name|fp
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|fp
argument_list|)
argument_list|,
name|M_PFOSFP
argument_list|,
name|M_ZERO
operator||
name|M_NOWAIT
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
name|fp
operator|->
name|fp_tcpopts
operator|=
name|fpioc
operator|->
name|fp_tcpopts
expr_stmt|;
name|fp
operator|->
name|fp_wsize
operator|=
name|fpioc
operator|->
name|fp_wsize
expr_stmt|;
name|fp
operator|->
name|fp_psize
operator|=
name|fpioc
operator|->
name|fp_psize
expr_stmt|;
name|fp
operator|->
name|fp_mss
operator|=
name|fpioc
operator|->
name|fp_mss
expr_stmt|;
name|fp
operator|->
name|fp_flags
operator|=
name|fpioc
operator|->
name|fp_flags
expr_stmt|;
name|fp
operator|->
name|fp_optcnt
operator|=
name|fpioc
operator|->
name|fp_optcnt
expr_stmt|;
name|fp
operator|->
name|fp_wscale
operator|=
name|fpioc
operator|->
name|fp_wscale
expr_stmt|;
name|fp
operator|->
name|fp_ttl
operator|=
name|fpioc
operator|->
name|fp_ttl
expr_stmt|;
name|SLIST_INIT
argument_list|(
operator|&
name|fp
operator|->
name|fp_oses
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|entry
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|entry
argument_list|)
argument_list|,
name|M_PFOSFP
argument_list|,
name|M_NOWAIT
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
name|fp
argument_list|,
name|M_PFOSFP
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
name|pf_osfp_insert
argument_list|(
operator|&
name|V_pf_osfp_list
argument_list|,
name|fp
argument_list|)
expr_stmt|;
block|}
name|memcpy
argument_list|(
name|entry
argument_list|,
operator|&
name|fpioc
operator|->
name|fp_os
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|entry
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Make sure the strings are NUL terminated */
name|entry
operator|->
name|fp_class_nm
index|[
sizeof|sizeof
argument_list|(
name|entry
operator|->
name|fp_class_nm
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|entry
operator|->
name|fp_version_nm
index|[
sizeof|sizeof
argument_list|(
name|entry
operator|->
name|fp_version_nm
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|entry
operator|->
name|fp_subtype_nm
index|[
sizeof|sizeof
argument_list|(
name|entry
operator|->
name|fp_subtype_nm
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|SLIST_INSERT_HEAD
argument_list|(
operator|&
name|fp
operator|->
name|fp_oses
argument_list|,
name|entry
argument_list|,
name|fp_entry
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|PFDEBUG
if|if
condition|(
operator|(
name|fp
operator|=
name|pf_osfp_validate
argument_list|()
operator|)
condition|)
name|printf
argument_list|(
literal|"Invalid fingerprint list\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* PFDEBUG */
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Find a fingerprint in the list */
end_comment

begin_function
specifier|static
name|struct
name|pf_os_fingerprint
modifier|*
name|pf_osfp_find
parameter_list|(
name|struct
name|pf_osfp_list
modifier|*
name|list
parameter_list|,
name|struct
name|pf_os_fingerprint
modifier|*
name|find
parameter_list|,
name|u_int8_t
name|ttldiff
parameter_list|)
block|{
name|struct
name|pf_os_fingerprint
modifier|*
name|f
decl_stmt|;
define|#
directive|define
name|MATCH_INT
parameter_list|(
name|_MOD
parameter_list|,
name|_DC
parameter_list|,
name|_field
parameter_list|)
define|\
value|if ((f->fp_flags& _DC) == 0) {					\ 		if ((f->fp_flags& _MOD) == 0) {			\ 			if (f->_field != find->_field)			\ 				continue;				\ 		} else {						\ 			if (f->_field == 0 || find->_field % f->_field)	\ 				continue;				\ 		}							\ 	}
name|SLIST_FOREACH
argument_list|(
argument|f
argument_list|,
argument|list
argument_list|,
argument|fp_next
argument_list|)
block|{
if|if
condition|(
name|f
operator|->
name|fp_tcpopts
operator|!=
name|find
operator|->
name|fp_tcpopts
operator|||
name|f
operator|->
name|fp_optcnt
operator|!=
name|find
operator|->
name|fp_optcnt
operator|||
name|f
operator|->
name|fp_ttl
operator|<
name|find
operator|->
name|fp_ttl
operator|||
name|f
operator|->
name|fp_ttl
operator|-
name|find
operator|->
name|fp_ttl
operator|>
name|ttldiff
operator|||
operator|(
name|f
operator|->
name|fp_flags
operator|&
operator|(
name|PF_OSFP_DF
operator||
name|PF_OSFP_TS0
operator|)
operator|)
operator|!=
operator|(
name|find
operator|->
name|fp_flags
operator|&
operator|(
name|PF_OSFP_DF
operator||
name|PF_OSFP_TS0
operator|)
operator|)
condition|)
continue|continue;
name|MATCH_INT
argument_list|(
argument|PF_OSFP_PSIZE_MOD
argument_list|,
argument|PF_OSFP_PSIZE_DC
argument_list|,
argument|fp_psize
argument_list|)
name|MATCH_INT
argument_list|(
argument|PF_OSFP_MSS_MOD
argument_list|,
argument|PF_OSFP_MSS_DC
argument_list|,
argument|fp_mss
argument_list|)
name|MATCH_INT
argument_list|(
argument|PF_OSFP_WSCALE_MOD
argument_list|,
argument|PF_OSFP_WSCALE_DC
argument_list|,
argument|fp_wscale
argument_list|)
if|if
condition|(
operator|(
name|f
operator|->
name|fp_flags
operator|&
name|PF_OSFP_WSIZE_DC
operator|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|f
operator|->
name|fp_flags
operator|&
name|PF_OSFP_WSIZE_MSS
condition|)
block|{
if|if
condition|(
name|find
operator|->
name|fp_mss
operator|==
literal|0
condition|)
continue|continue;
comment|/*  * Some "smart" NAT devices and DSL routers will tweak the MSS size and  * will set it to whatever is suitable for the link type.  */
define|#
directive|define
name|SMART_MSS
value|1460
if|if
condition|(
operator|(
name|find
operator|->
name|fp_wsize
operator|%
name|find
operator|->
name|fp_mss
operator|||
name|find
operator|->
name|fp_wsize
operator|/
name|find
operator|->
name|fp_mss
operator|!=
name|f
operator|->
name|fp_wsize
operator|)
operator|&&
operator|(
name|find
operator|->
name|fp_wsize
operator|%
name|SMART_MSS
operator|||
name|find
operator|->
name|fp_wsize
operator|/
name|SMART_MSS
operator|!=
name|f
operator|->
name|fp_wsize
operator|)
condition|)
continue|continue;
block|}
elseif|else
if|if
condition|(
name|f
operator|->
name|fp_flags
operator|&
name|PF_OSFP_WSIZE_MTU
condition|)
block|{
if|if
condition|(
name|find
operator|->
name|fp_mss
operator|==
literal|0
condition|)
continue|continue;
define|#
directive|define
name|MTUOFF
value|(sizeof(struct ip) + sizeof(struct tcphdr))
define|#
directive|define
name|SMART_MTU
value|(SMART_MSS + MTUOFF)
if|if
condition|(
operator|(
name|find
operator|->
name|fp_wsize
operator|%
operator|(
name|find
operator|->
name|fp_mss
operator|+
name|MTUOFF
operator|)
operator|||
name|find
operator|->
name|fp_wsize
operator|/
operator|(
name|find
operator|->
name|fp_mss
operator|+
name|MTUOFF
operator|)
operator|!=
name|f
operator|->
name|fp_wsize
operator|)
operator|&&
operator|(
name|find
operator|->
name|fp_wsize
operator|%
name|SMART_MTU
operator|||
name|find
operator|->
name|fp_wsize
operator|/
name|SMART_MTU
operator|!=
name|f
operator|->
name|fp_wsize
operator|)
condition|)
continue|continue;
block|}
elseif|else
if|if
condition|(
name|f
operator|->
name|fp_flags
operator|&
name|PF_OSFP_WSIZE_MOD
condition|)
block|{
if|if
condition|(
name|f
operator|->
name|fp_wsize
operator|==
literal|0
operator|||
name|find
operator|->
name|fp_wsize
operator|%
name|f
operator|->
name|fp_wsize
condition|)
continue|continue;
block|}
else|else
block|{
if|if
condition|(
name|f
operator|->
name|fp_wsize
operator|!=
name|find
operator|->
name|fp_wsize
condition|)
continue|continue;
block|}
block|}
return|return
operator|(
name|f
operator|)
return|;
block|}
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Find an exact fingerprint in the list */
end_comment

begin_function
specifier|static
name|struct
name|pf_os_fingerprint
modifier|*
name|pf_osfp_find_exact
parameter_list|(
name|struct
name|pf_osfp_list
modifier|*
name|list
parameter_list|,
name|struct
name|pf_os_fingerprint
modifier|*
name|find
parameter_list|)
block|{
name|struct
name|pf_os_fingerprint
modifier|*
name|f
decl_stmt|;
name|SLIST_FOREACH
argument_list|(
argument|f
argument_list|,
argument|list
argument_list|,
argument|fp_next
argument_list|)
block|{
if|if
condition|(
name|f
operator|->
name|fp_tcpopts
operator|==
name|find
operator|->
name|fp_tcpopts
operator|&&
name|f
operator|->
name|fp_wsize
operator|==
name|find
operator|->
name|fp_wsize
operator|&&
name|f
operator|->
name|fp_psize
operator|==
name|find
operator|->
name|fp_psize
operator|&&
name|f
operator|->
name|fp_mss
operator|==
name|find
operator|->
name|fp_mss
operator|&&
name|f
operator|->
name|fp_flags
operator|==
name|find
operator|->
name|fp_flags
operator|&&
name|f
operator|->
name|fp_optcnt
operator|==
name|find
operator|->
name|fp_optcnt
operator|&&
name|f
operator|->
name|fp_wscale
operator|==
name|find
operator|->
name|fp_wscale
operator|&&
name|f
operator|->
name|fp_ttl
operator|==
name|find
operator|->
name|fp_ttl
condition|)
return|return
operator|(
name|f
operator|)
return|;
block|}
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Insert a fingerprint into the list */
end_comment

begin_function
specifier|static
name|void
name|pf_osfp_insert
parameter_list|(
name|struct
name|pf_osfp_list
modifier|*
name|list
parameter_list|,
name|struct
name|pf_os_fingerprint
modifier|*
name|ins
parameter_list|)
block|{
name|struct
name|pf_os_fingerprint
modifier|*
name|f
decl_stmt|,
modifier|*
name|prev
init|=
name|NULL
decl_stmt|;
comment|/* XXX need to go semi tree based.  can key on tcp options */
name|SLIST_FOREACH
argument_list|(
argument|f
argument_list|,
argument|list
argument_list|,
argument|fp_next
argument_list|)
name|prev
operator|=
name|f
expr_stmt|;
if|if
condition|(
name|prev
condition|)
name|SLIST_INSERT_AFTER
argument_list|(
name|prev
argument_list|,
name|ins
argument_list|,
name|fp_next
argument_list|)
expr_stmt|;
else|else
name|SLIST_INSERT_HEAD
argument_list|(
name|list
argument_list|,
name|ins
argument_list|,
name|fp_next
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Fill a fingerprint by its number (from an ioctl) */
end_comment

begin_function
name|int
name|pf_osfp_get
parameter_list|(
name|struct
name|pf_osfp_ioctl
modifier|*
name|fpioc
parameter_list|)
block|{
name|struct
name|pf_os_fingerprint
modifier|*
name|fp
decl_stmt|;
name|struct
name|pf_osfp_entry
modifier|*
name|entry
decl_stmt|;
name|int
name|num
init|=
name|fpioc
operator|->
name|fp_getnum
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
name|memset
argument_list|(
name|fpioc
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|fpioc
argument_list|)
argument_list|)
expr_stmt|;
name|SLIST_FOREACH
argument_list|(
argument|fp
argument_list|,
argument|&V_pf_osfp_list
argument_list|,
argument|fp_next
argument_list|)
block|{
name|SLIST_FOREACH
argument_list|(
argument|entry
argument_list|,
argument|&fp->fp_oses
argument_list|,
argument|fp_entry
argument_list|)
block|{
if|if
condition|(
name|i
operator|++
operator|==
name|num
condition|)
block|{
name|fpioc
operator|->
name|fp_mss
operator|=
name|fp
operator|->
name|fp_mss
expr_stmt|;
name|fpioc
operator|->
name|fp_wsize
operator|=
name|fp
operator|->
name|fp_wsize
expr_stmt|;
name|fpioc
operator|->
name|fp_flags
operator|=
name|fp
operator|->
name|fp_flags
expr_stmt|;
name|fpioc
operator|->
name|fp_psize
operator|=
name|fp
operator|->
name|fp_psize
expr_stmt|;
name|fpioc
operator|->
name|fp_ttl
operator|=
name|fp
operator|->
name|fp_ttl
expr_stmt|;
name|fpioc
operator|->
name|fp_wscale
operator|=
name|fp
operator|->
name|fp_wscale
expr_stmt|;
name|fpioc
operator|->
name|fp_getnum
operator|=
name|num
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|fpioc
operator|->
name|fp_os
argument_list|,
name|entry
argument_list|,
sizeof|sizeof
argument_list|(
name|fpioc
operator|->
name|fp_os
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
block|}
return|return
operator|(
name|EBUSY
operator|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|PFDEBUG
end_ifdef

begin_comment
comment|/* Validate that each signature is reachable */
end_comment

begin_function
specifier|static
name|struct
name|pf_os_fingerprint
modifier|*
name|pf_osfp_validate
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|pf_os_fingerprint
modifier|*
name|f
decl_stmt|,
modifier|*
name|f2
decl_stmt|,
name|find
decl_stmt|;
name|SLIST_FOREACH
argument_list|(
argument|f
argument_list|,
argument|&V_pf_osfp_list
argument_list|,
argument|fp_next
argument_list|)
block|{
name|memcpy
argument_list|(
operator|&
name|find
argument_list|,
name|f
argument_list|,
sizeof|sizeof
argument_list|(
name|find
argument_list|)
argument_list|)
expr_stmt|;
comment|/* We do a few MSS/th_win percolations to make things unique */
if|if
condition|(
name|find
operator|.
name|fp_mss
operator|==
literal|0
condition|)
name|find
operator|.
name|fp_mss
operator|=
literal|128
expr_stmt|;
if|if
condition|(
name|f
operator|->
name|fp_flags
operator|&
name|PF_OSFP_WSIZE_MSS
condition|)
name|find
operator|.
name|fp_wsize
operator|*=
name|find
operator|.
name|fp_mss
expr_stmt|;
elseif|else
if|if
condition|(
name|f
operator|->
name|fp_flags
operator|&
name|PF_OSFP_WSIZE_MTU
condition|)
name|find
operator|.
name|fp_wsize
operator|*=
operator|(
name|find
operator|.
name|fp_mss
operator|+
literal|40
operator|)
expr_stmt|;
elseif|else
if|if
condition|(
name|f
operator|->
name|fp_flags
operator|&
name|PF_OSFP_WSIZE_MOD
condition|)
name|find
operator|.
name|fp_wsize
operator|*=
literal|2
expr_stmt|;
if|if
condition|(
name|f
operator|!=
operator|(
name|f2
operator|=
name|pf_osfp_find
argument_list|(
operator|&
name|V_pf_osfp_list
argument_list|,
operator|&
name|find
argument_list|,
literal|0
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
name|f2
condition|)
name|printf
argument_list|(
literal|"Found \"%s %s %s\" instead of "
literal|"\"%s %s %s\"\n"
argument_list|,
name|SLIST_FIRST
argument_list|(
operator|&
name|f2
operator|->
name|fp_oses
argument_list|)
operator|->
name|fp_class_nm
argument_list|,
name|SLIST_FIRST
argument_list|(
operator|&
name|f2
operator|->
name|fp_oses
argument_list|)
operator|->
name|fp_version_nm
argument_list|,
name|SLIST_FIRST
argument_list|(
operator|&
name|f2
operator|->
name|fp_oses
argument_list|)
operator|->
name|fp_subtype_nm
argument_list|,
name|SLIST_FIRST
argument_list|(
operator|&
name|f
operator|->
name|fp_oses
argument_list|)
operator|->
name|fp_class_nm
argument_list|,
name|SLIST_FIRST
argument_list|(
operator|&
name|f
operator|->
name|fp_oses
argument_list|)
operator|->
name|fp_version_nm
argument_list|,
name|SLIST_FIRST
argument_list|(
operator|&
name|f
operator|->
name|fp_oses
argument_list|)
operator|->
name|fp_subtype_nm
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"Couldn't find \"%s %s %s\"\n"
argument_list|,
name|SLIST_FIRST
argument_list|(
operator|&
name|f
operator|->
name|fp_oses
argument_list|)
operator|->
name|fp_class_nm
argument_list|,
name|SLIST_FIRST
argument_list|(
operator|&
name|f
operator|->
name|fp_oses
argument_list|)
operator|->
name|fp_version_nm
argument_list|,
name|SLIST_FIRST
argument_list|(
operator|&
name|f
operator|->
name|fp_oses
argument_list|)
operator|->
name|fp_subtype_nm
argument_list|)
expr_stmt|;
return|return
operator|(
name|f
operator|)
return|;
block|}
block|}
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* PFDEBUG */
end_comment

end_unit


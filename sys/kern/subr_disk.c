begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * ----------------------------------------------------------------------------  * "THE BEER-WARE LICENSE" (Revision 42):  *<phk@FreeBSD.ORG> wrote this file.  As long as you retain this notice you  * can do whatever you want with this stuff. If we meet some day, and you think  * this stuff is worth it, you can buy me a beer in return.   Poul-Henning Kamp  * ----------------------------------------------------------------------------  *  * $FreeBSD$  *  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/buf.h>
end_include

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_include
include|#
directive|include
file|<sys/disk.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/vnode.h>
end_include

begin_include
include|#
directive|include
file|<machine/md_var.h>
end_include

begin_expr_stmt
name|MALLOC_DEFINE
argument_list|(
name|M_DISK
argument_list|,
literal|"disk"
argument_list|,
literal|"disk data"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|d_strategy_t
name|diskstrategy
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|d_open_t
name|diskopen
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|d_close_t
name|diskclose
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|d_ioctl_t
name|diskioctl
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|d_psize_t
name|diskpsize
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|cdevsw
name|disk_cdevsw
init|=
block|{
comment|/* open */
name|diskopen
block|,
comment|/* close */
name|diskclose
block|,
comment|/* read */
name|physread
block|,
comment|/* write */
name|physwrite
block|,
comment|/* ioctl */
name|diskioctl
block|,
comment|/* stop */
name|nostop
block|,
comment|/* reset */
name|noreset
block|,
comment|/* devtotty */
name|nodevtotty
block|,
comment|/* poll */
name|nopoll
block|,
comment|/* mmap */
name|nommap
block|,
comment|/* strategy */
name|diskstrategy
block|,
comment|/* name */
literal|"disk"
block|,
comment|/* parms */
name|noparms
block|,
comment|/* maj */
operator|-
literal|1
block|,
comment|/* dump */
name|nodump
block|,
comment|/* psize */
name|diskpsize
block|,
comment|/* flags */
name|D_DISK
block|,
comment|/* maxio */
literal|0
block|,
comment|/* bmaj */
operator|-
literal|1
block|, }
decl_stmt|;
end_decl_stmt

begin_function
name|dev_t
name|disk_create
parameter_list|(
name|int
name|unit
parameter_list|,
name|struct
name|disk
modifier|*
name|dp
parameter_list|,
name|int
name|flags
parameter_list|,
name|struct
name|cdevsw
modifier|*
name|cdevsw
parameter_list|)
block|{
name|dev_t
name|dev
decl_stmt|;
name|struct
name|cdevsw
modifier|*
name|cds
decl_stmt|;
name|dev
operator|=
name|makedev
argument_list|(
name|cdevsw
operator|->
name|d_maj
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|cds
operator|=
name|devsw
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cds
condition|)
block|{
comment|/* Build the "real" cdevsw */
name|MALLOC
argument_list|(
name|cds
argument_list|,
expr|struct
name|cdevsw
operator|*
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|cds
argument_list|)
argument_list|,
name|M_DISK
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
operator|*
name|cds
operator|=
name|disk_cdevsw
expr_stmt|;
name|cds
operator|->
name|d_name
operator|=
name|cdevsw
operator|->
name|d_name
expr_stmt|;
name|cds
operator|->
name|d_maj
operator|=
name|cdevsw
operator|->
name|d_maj
expr_stmt|;
name|cds
operator|->
name|d_bmaj
operator|=
name|cdevsw
operator|->
name|d_bmaj
expr_stmt|;
name|cds
operator|->
name|d_flags
operator|=
name|cdevsw
operator|->
name|d_flags
operator|&
operator|~
name|D_TRACKCLOSE
expr_stmt|;
name|cds
operator|->
name|d_dump
operator|=
name|cdevsw
operator|->
name|d_dump
expr_stmt|;
name|cdevsw_add
argument_list|(
name|cds
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Creating DISK %s%d\n"
argument_list|,
name|cds
operator|->
name|d_name
argument_list|,
name|unit
argument_list|)
expr_stmt|;
name|dev
operator|=
name|make_dev
argument_list|(
name|cds
argument_list|,
name|dkmakeminor
argument_list|(
name|unit
argument_list|,
name|WHOLE_DISK_SLICE
argument_list|,
name|RAW_PART
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|"r%s%d"
argument_list|,
name|cds
operator|->
name|d_name
argument_list|,
name|unit
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|dp
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|dp
argument_list|)
argument_list|)
expr_stmt|;
name|dp
operator|->
name|d_devsw
operator|=
name|cdevsw
expr_stmt|;
name|dev
operator|->
name|si_disk
operator|=
name|dp
expr_stmt|;
name|dp
operator|->
name|d_dev
operator|=
name|dev
expr_stmt|;
name|dp
operator|->
name|d_flags
operator|=
name|flags
expr_stmt|;
return|return
operator|(
name|dev
operator|)
return|;
block|}
end_function

begin_function
name|int
name|disk_dumpcheck
parameter_list|(
name|dev_t
name|dev
parameter_list|,
name|u_int
modifier|*
name|count
parameter_list|,
name|u_int
modifier|*
name|blkno
parameter_list|,
name|u_int
modifier|*
name|secsize
parameter_list|)
block|{
name|struct
name|disk
modifier|*
name|dp
decl_stmt|;
name|struct
name|disklabel
modifier|*
name|dl
decl_stmt|;
name|u_int
name|boff
decl_stmt|;
name|dp
operator|=
name|dev
operator|->
name|si_disk
expr_stmt|;
if|if
condition|(
operator|!
name|dp
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
operator|!
name|dp
operator|->
name|d_slice
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|dl
operator|=
name|dsgetlabel
argument_list|(
name|dev
argument_list|,
name|dp
operator|->
name|d_slice
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dl
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
operator|*
name|count
operator|=
operator|(
name|u_long
operator|)
name|Maxmem
operator|*
name|PAGE_SIZE
operator|/
name|dl
operator|->
name|d_secsize
expr_stmt|;
if|if
condition|(
name|dumplo
operator|<
literal|0
operator|||
operator|(
name|dumplo
operator|+
operator|*
name|count
operator|>
name|dl
operator|->
name|d_partitions
index|[
name|dkpart
argument_list|(
name|dev
argument_list|)
index|]
operator|.
name|p_size
operator|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|boff
operator|=
name|dl
operator|->
name|d_partitions
index|[
name|dkpart
argument_list|(
name|dev
argument_list|)
index|]
operator|.
name|p_offset
operator|+
name|dp
operator|->
name|d_slice
operator|->
name|dss_slices
index|[
name|dkslice
argument_list|(
name|dev
argument_list|)
index|]
operator|.
name|ds_offset
expr_stmt|;
operator|*
name|blkno
operator|=
name|boff
operator|+
name|dumplo
expr_stmt|;
operator|*
name|secsize
operator|=
name|dl
operator|->
name|d_secsize
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|void
name|disk_invalidate
parameter_list|(
name|struct
name|disk
modifier|*
name|disk
parameter_list|)
block|{
name|dsgone
argument_list|(
operator|&
name|disk
operator|->
name|d_slice
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|disk_delete
parameter_list|(
name|dev_t
name|dev
parameter_list|)
block|{
return|return;
block|}
end_function

begin_comment
comment|/*  * The cdevsw functions  */
end_comment

begin_function
specifier|static
name|int
name|diskopen
parameter_list|(
name|dev_t
name|dev
parameter_list|,
name|int
name|oflags
parameter_list|,
name|int
name|devtype
parameter_list|,
name|struct
name|proc
modifier|*
name|p
parameter_list|)
block|{
name|dev_t
name|pdev
decl_stmt|;
name|struct
name|disk
modifier|*
name|dp
decl_stmt|;
name|int
name|error
decl_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
name|pdev
operator|=
name|dkmodpart
argument_list|(
name|dkmodslice
argument_list|(
name|dev
argument_list|,
name|WHOLE_DISK_SLICE
argument_list|)
argument_list|,
name|RAW_PART
argument_list|)
expr_stmt|;
name|dp
operator|=
name|pdev
operator|->
name|si_disk
expr_stmt|;
if|if
condition|(
operator|!
name|dp
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|dev
operator|->
name|si_disk
operator|=
name|dp
expr_stmt|;
name|dev
operator|->
name|si_drv1
operator|=
name|pdev
operator|->
name|si_drv1
expr_stmt|;
name|dev
operator|->
name|si_drv2
operator|=
name|pdev
operator|->
name|si_drv2
expr_stmt|;
if|if
condition|(
operator|!
name|dsisopen
argument_list|(
name|dp
operator|->
name|d_slice
argument_list|)
condition|)
name|error
operator|=
name|dp
operator|->
name|d_devsw
operator|->
name|d_open
argument_list|(
name|dev
argument_list|,
name|oflags
argument_list|,
name|devtype
argument_list|,
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|error
operator|=
name|dsopen
argument_list|(
name|dev
argument_list|,
name|devtype
argument_list|,
name|dp
operator|->
name|d_flags
argument_list|,
operator|&
name|dp
operator|->
name|d_slice
argument_list|,
operator|&
name|dp
operator|->
name|d_label
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dsisopen
argument_list|(
name|dp
operator|->
name|d_slice
argument_list|)
condition|)
name|dp
operator|->
name|d_devsw
operator|->
name|d_close
argument_list|(
name|dev
argument_list|,
name|oflags
argument_list|,
name|devtype
argument_list|,
name|p
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|diskclose
parameter_list|(
name|dev_t
name|dev
parameter_list|,
name|int
name|fflag
parameter_list|,
name|int
name|devtype
parameter_list|,
name|struct
name|proc
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|disk
modifier|*
name|dp
decl_stmt|;
name|int
name|error
decl_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
name|dp
operator|=
name|dev
operator|->
name|si_disk
expr_stmt|;
name|dsclose
argument_list|(
name|dev
argument_list|,
name|devtype
argument_list|,
name|dp
operator|->
name|d_slice
argument_list|)
expr_stmt|;
if|if
condition|(
name|dsisopen
argument_list|(
name|dp
operator|->
name|d_slice
argument_list|)
condition|)
name|error
operator|=
name|dp
operator|->
name|d_devsw
operator|->
name|d_close
argument_list|(
name|dev
argument_list|,
name|fflag
argument_list|,
name|devtype
argument_list|,
name|p
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|diskstrategy
parameter_list|(
name|struct
name|buf
modifier|*
name|bp
parameter_list|)
block|{
name|dev_t
name|pdev
decl_stmt|;
name|struct
name|disk
modifier|*
name|dp
decl_stmt|;
name|dp
operator|=
name|bp
operator|->
name|b_dev
operator|->
name|si_disk
expr_stmt|;
if|if
condition|(
operator|!
name|dp
condition|)
block|{
name|pdev
operator|=
name|dkmodpart
argument_list|(
name|dkmodslice
argument_list|(
name|bp
operator|->
name|b_dev
argument_list|,
name|WHOLE_DISK_SLICE
argument_list|)
argument_list|,
name|RAW_PART
argument_list|)
expr_stmt|;
name|dp
operator|=
name|pdev
operator|->
name|si_disk
expr_stmt|;
name|bp
operator|->
name|b_dev
operator|->
name|si_drv1
operator|=
name|pdev
operator|->
name|si_drv1
expr_stmt|;
name|bp
operator|->
name|b_dev
operator|->
name|si_drv2
operator|=
name|pdev
operator|->
name|si_drv2
expr_stmt|;
comment|/* XXX: don't set bp->b_dev->si_disk (?) */
block|}
else|else
block|{
name|pdev
operator|=
name|dp
operator|->
name|d_dev
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|dp
condition|)
block|{
name|bp
operator|->
name|b_error
operator|=
name|ENXIO
expr_stmt|;
name|bp
operator|->
name|b_flags
operator||=
name|B_ERROR
expr_stmt|;
name|biodone
argument_list|(
name|bp
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|dscheck
argument_list|(
name|bp
argument_list|,
name|dp
operator|->
name|d_slice
argument_list|)
operator|<
literal|0
condition|)
block|{
name|biodone
argument_list|(
name|bp
argument_list|)
expr_stmt|;
return|return;
block|}
name|dp
operator|->
name|d_devsw
operator|->
name|d_strategy
argument_list|(
name|bp
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|diskioctl
parameter_list|(
name|dev_t
name|dev
parameter_list|,
name|u_long
name|cmd
parameter_list|,
name|caddr_t
name|data
parameter_list|,
name|int
name|fflag
parameter_list|,
name|struct
name|proc
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|disk
modifier|*
name|dp
decl_stmt|;
name|int
name|error
decl_stmt|;
name|dp
operator|=
name|dev
operator|->
name|si_disk
expr_stmt|;
name|error
operator|=
name|dsioctl
argument_list|(
name|dev
argument_list|,
name|cmd
argument_list|,
name|data
argument_list|,
name|fflag
argument_list|,
operator|&
name|dp
operator|->
name|d_slice
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
name|ENOIOCTL
condition|)
name|error
operator|=
name|dp
operator|->
name|d_devsw
operator|->
name|d_ioctl
argument_list|(
name|dev
argument_list|,
name|cmd
argument_list|,
name|data
argument_list|,
name|fflag
argument_list|,
name|p
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|diskpsize
parameter_list|(
name|dev_t
name|dev
parameter_list|)
block|{
name|struct
name|disk
modifier|*
name|dp
decl_stmt|;
name|dev_t
name|pdev
decl_stmt|;
name|dp
operator|=
name|dev
operator|->
name|si_disk
expr_stmt|;
if|if
condition|(
operator|!
name|dp
condition|)
block|{
name|pdev
operator|=
name|dkmodpart
argument_list|(
name|dkmodslice
argument_list|(
name|dev
argument_list|,
name|WHOLE_DISK_SLICE
argument_list|)
argument_list|,
name|RAW_PART
argument_list|)
expr_stmt|;
name|dp
operator|=
name|pdev
operator|->
name|si_disk
expr_stmt|;
name|dev
operator|->
name|si_drv1
operator|=
name|pdev
operator|->
name|si_drv1
expr_stmt|;
name|dev
operator|->
name|si_drv2
operator|=
name|pdev
operator|->
name|si_drv2
expr_stmt|;
comment|/* XXX: don't set bp->b_dev->si_disk (?) */
block|}
return|return
operator|(
name|dssize
argument_list|(
name|dev
argument_list|,
operator|&
name|dp
operator|->
name|d_slice
argument_list|)
operator|)
return|;
block|}
end_function

begin_expr_stmt
name|SYSCTL_DECL
argument_list|(
name|_debug_sizeof
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_debug_sizeof
argument_list|,
name|OID_AUTO
argument_list|,
name|disklabel
argument_list|,
name|CTLFLAG_RD
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|disklabel
argument_list|)
argument_list|,
literal|"sizeof(struct disklabel)"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_debug_sizeof
argument_list|,
name|OID_AUTO
argument_list|,
name|diskslices
argument_list|,
name|CTLFLAG_RD
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|diskslices
argument_list|)
argument_list|,
literal|"sizeof(struct diskslices)"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_debug_sizeof
argument_list|,
name|OID_AUTO
argument_list|,
name|disk
argument_list|,
name|CTLFLAG_RD
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|disk
argument_list|)
argument_list|,
literal|"sizeof(struct disk)"
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


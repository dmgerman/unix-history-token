begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Initial implementation:  * Copyright (c) 2001 Robert Drehmel  * All rights reserved.  *  * As long as the above copyright statement and this notice remain  * unchanged, you can do what ever you want with this file.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<machine/cpufunc.h>
end_include

begin_include
include|#
directive|include
file|<machine/md_var.h>
end_include

begin_include
include|#
directive|include
file|<machine/ver.h>
end_include

begin_decl_stmt
specifier|static
name|char
name|machine
index|[]
init|=
literal|"sparc64"
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|SYSCTL_STRING
argument_list|(
name|_hw
argument_list|,
name|HW_MACHINE
argument_list|,
name|machine
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|machine
argument_list|,
literal|0
argument_list|,
literal|"Machine class"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|char
name|cpu_model
index|[
literal|128
index|]
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|SYSCTL_STRING
argument_list|(
name|_hw
argument_list|,
name|HW_MODEL
argument_list|,
name|model
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|cpu_model
argument_list|,
literal|0
argument_list|,
literal|"Machine model"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|cpu_impl
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|cpu_identify
parameter_list|(
name|u_long
name|vers
parameter_list|,
name|u_int
name|freq
parameter_list|,
name|u_int
name|id
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|manus
decl_stmt|;
specifier|const
name|char
modifier|*
name|impls
decl_stmt|;
name|manus
operator|=
name|NULL
expr_stmt|;
name|impls
operator|=
name|NULL
expr_stmt|;
switch|switch
condition|(
name|VER_MANUF
argument_list|(
name|vers
argument_list|)
condition|)
block|{
case|case
literal|0x04
case|:
name|manus
operator|=
literal|"HAL"
expr_stmt|;
break|break;
case|case
literal|0x13
case|:
case|case
literal|0x17
case|:
case|case
literal|0x22
case|:
name|manus
operator|=
literal|"Sun Microsystems"
expr_stmt|;
break|break;
block|}
name|cpu_impl
operator|=
name|VER_IMPL
argument_list|(
name|vers
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cpu_impl
condition|)
block|{
case|case
name|CPU_IMPL_SPARC64
case|:
name|impls
operator|=
literal|"SPARC64"
expr_stmt|;
break|break;
case|case
name|CPU_IMPL_ULTRASPARCI
case|:
name|impls
operator|=
literal|"UltraSparc-I"
expr_stmt|;
break|break;
case|case
name|CPU_IMPL_ULTRASPARCII
case|:
name|impls
operator|=
literal|"UltraSparc-II"
expr_stmt|;
break|break;
case|case
name|CPU_IMPL_ULTRASPARCIIi
case|:
name|impls
operator|=
literal|"UltraSparc-IIi"
expr_stmt|;
break|break;
case|case
name|CPU_IMPL_ULTRASPARCIIe
case|:
comment|/* V9 Manual says `UltraSparc-e'.  I assume this is wrong. */
name|impls
operator|=
literal|"UltraSparc-IIe"
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|manus
operator|==
name|NULL
operator|||
name|impls
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"CPU: unknown; please e-mail the following value together\n"
literal|"     with the exact name of your processor to "
literal|"<freebsd-sparc@FreeBSD.org>.\n"
literal|"     version register:<0x%lx>\n"
argument_list|,
name|vers
argument_list|)
expr_stmt|;
return|return;
block|}
name|snprintf
argument_list|(
name|cpu_model
argument_list|,
sizeof|sizeof
argument_list|(
name|cpu_model
argument_list|)
argument_list|,
literal|"%s %s"
argument_list|,
name|manus
argument_list|,
name|impls
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"cpu%d: %s %s Processor (%d.%02d MHZ CPU)\n"
argument_list|,
name|id
argument_list|,
name|manus
argument_list|,
name|impls
argument_list|,
operator|(
name|freq
operator|+
literal|4999
operator|)
operator|/
literal|1000000
argument_list|,
operator|(
operator|(
name|freq
operator|+
literal|4999
operator|)
operator|/
literal|10000
operator|)
operator|%
literal|100
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
block|{
name|printf
argument_list|(
literal|"  mask=0x%lx maxtl=%ld maxwin=%ld\n"
argument_list|,
name|VER_MASK
argument_list|(
name|vers
argument_list|)
argument_list|,
name|VER_MAXTL
argument_list|(
name|vers
argument_list|)
argument_list|,
name|VER_MAXWIN
argument_list|(
name|vers
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

end_unit


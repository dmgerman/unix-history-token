begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	ioctl.c	4.4	81/03/08	*/
end_comment

begin_comment
comment|/*  * Ioctl.  */
end_comment

begin_include
include|#
directive|include
file|"../h/param.h"
end_include

begin_include
include|#
directive|include
file|"../h/systm.h"
end_include

begin_include
include|#
directive|include
file|"../h/dir.h"
end_include

begin_include
include|#
directive|include
file|"../h/user.h"
end_include

begin_include
include|#
directive|include
file|"../h/tty.h"
end_include

begin_include
include|#
directive|include
file|"../h/proc.h"
end_include

begin_include
include|#
directive|include
file|"../h/inode.h"
end_include

begin_include
include|#
directive|include
file|"../h/file.h"
end_include

begin_include
include|#
directive|include
file|"../h/conf.h"
end_include

begin_comment
comment|/*  * stty/gtty writearound  */
end_comment

begin_macro
name|stty
argument_list|()
end_macro

begin_block
block|{
name|u
operator|.
name|u_arg
index|[
literal|2
index|]
operator|=
name|u
operator|.
name|u_arg
index|[
literal|1
index|]
expr_stmt|;
name|u
operator|.
name|u_arg
index|[
literal|1
index|]
operator|=
name|TIOCSETP
expr_stmt|;
name|ioctl
argument_list|()
expr_stmt|;
block|}
end_block

begin_macro
name|gtty
argument_list|()
end_macro

begin_block
block|{
name|u
operator|.
name|u_arg
index|[
literal|2
index|]
operator|=
name|u
operator|.
name|u_arg
index|[
literal|1
index|]
expr_stmt|;
name|u
operator|.
name|u_arg
index|[
literal|1
index|]
operator|=
name|TIOCGETP
expr_stmt|;
name|ioctl
argument_list|()
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * ioctl system call  * Check legality, execute common code, and switch out to individual  * device routine.  */
end_comment

begin_macro
name|ioctl
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|struct
name|file
modifier|*
name|fp
decl_stmt|;
specifier|register
name|struct
name|inode
modifier|*
name|ip
decl_stmt|;
specifier|register
struct|struct
name|a
block|{
name|int
name|fdes
decl_stmt|;
name|int
name|cmd
decl_stmt|;
name|caddr_t
name|cmarg
decl_stmt|;
block|}
modifier|*
name|uap
struct|;
specifier|register
name|dev_t
name|dev
decl_stmt|;
specifier|register
name|fmt
expr_stmt|;
name|uap
operator|=
operator|(
expr|struct
name|a
operator|*
operator|)
name|u
operator|.
name|u_ap
expr_stmt|;
if|if
condition|(
operator|(
name|fp
operator|=
name|getf
argument_list|(
name|uap
operator|->
name|fdes
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
operator|(
name|fp
operator|->
name|f_flag
operator|&
operator|(
name|FREAD
operator||
name|FWRITE
operator|)
operator|)
operator|==
literal|0
condition|)
block|{
name|u
operator|.
name|u_error
operator|=
name|EBADF
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|uap
operator|->
name|cmd
operator|==
name|FIOCLEX
condition|)
block|{
name|u
operator|.
name|u_pofile
index|[
name|uap
operator|->
name|fdes
index|]
operator||=
name|EXCLOSE
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|uap
operator|->
name|cmd
operator|==
name|FIONCLEX
condition|)
block|{
name|u
operator|.
name|u_pofile
index|[
name|uap
operator|->
name|fdes
index|]
operator|&=
operator|~
name|EXCLOSE
expr_stmt|;
return|return;
block|}
name|ip
operator|=
name|fp
operator|->
name|f_inode
expr_stmt|;
name|fmt
operator|=
name|ip
operator|->
name|i_mode
operator|&
name|IFMT
expr_stmt|;
if|if
condition|(
name|fmt
operator|!=
name|IFCHR
operator|&&
name|fmt
operator|!=
name|IFMPC
condition|)
block|{
comment|/* begin local */
if|if
condition|(
name|uap
operator|->
name|cmd
operator|==
name|FIONREAD
operator|&&
operator|(
name|fmt
operator|==
name|IFREG
operator|||
name|fmt
operator|==
name|IFDIR
operator|)
condition|)
block|{
name|off_t
name|nread
init|=
name|ip
operator|->
name|i_size
operator|-
name|fp
operator|->
name|f_un
operator|.
name|f_offset
decl_stmt|;
if|if
condition|(
name|copyout
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
name|nread
argument_list|,
name|uap
operator|->
name|cmarg
argument_list|,
sizeof|sizeof
argument_list|(
name|off_t
argument_list|)
argument_list|)
condition|)
name|u
operator|.
name|u_error
operator|=
name|EFAULT
expr_stmt|;
block|}
else|else
comment|/* end local */
name|u
operator|.
name|u_error
operator|=
name|ENOTTY
expr_stmt|;
return|return;
block|}
name|dev
operator|=
name|ip
operator|->
name|i_un
operator|.
name|i_rdev
expr_stmt|;
name|u
operator|.
name|u_r
operator|.
name|r_val1
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|u
operator|.
name|u_procp
operator|->
name|p_flag
operator|&
name|SNUSIG
operator|)
operator|&&
name|setjmp
argument_list|(
name|u
operator|.
name|u_qsav
argument_list|)
condition|)
block|{
name|u
operator|.
name|u_eosys
operator|=
name|RESTARTSYS
expr_stmt|;
return|return;
block|}
operator|(
operator|*
name|cdevsw
index|[
name|major
argument_list|(
name|dev
argument_list|)
index|]
operator|.
name|d_ioctl
operator|)
operator|(
name|dev
operator|,
name|uap
operator|->
name|cmd
operator|,
name|uap
operator|->
name|cmarg
operator|,
literal|0
operator|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * Do nothing specific version of line  * discipline specific ioctl command.  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_macro
name|nullioctl
argument_list|(
argument|tp
argument_list|,
argument|cmd
argument_list|,
argument|addr
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|tty
modifier|*
name|tp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|caddr_t
name|addr
decl_stmt|;
end_decl_stmt

begin_block
block|{
return|return
operator|(
name|cmd
operator|)
return|;
block|}
end_block

end_unit


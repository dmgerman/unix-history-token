begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2007 Mellanox Technologies. All rights reserved.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  *  */
end_comment

begin_include
include|#
directive|include
file|<linux/kernel.h>
end_include

begin_include
include|#
directive|include
file|<linux/ethtool.h>
end_include

begin_include
include|#
directive|include
file|<linux/netdevice.h>
end_include

begin_include
include|#
directive|include
file|<linux/if_vlan.h>
end_include

begin_include
include|#
directive|include
file|"mlx4_en.h"
end_include

begin_include
include|#
directive|include
file|"en_port.h"
end_include

begin_function
specifier|static
name|void
name|mlx4_en_update_lro_stats
parameter_list|(
name|struct
name|mlx4_en_priv
modifier|*
name|priv
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|priv
operator|->
name|port_stats
operator|.
name|lro_aggregated
operator|=
literal|0
expr_stmt|;
name|priv
operator|->
name|port_stats
operator|.
name|lro_flushed
operator|=
literal|0
expr_stmt|;
name|priv
operator|->
name|port_stats
operator|.
name|lro_no_desc
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|rx_ring_num
condition|;
name|i
operator|++
control|)
block|{
name|priv
operator|->
name|port_stats
operator|.
name|lro_aggregated
operator|+=
name|priv
operator|->
name|rx_ring
index|[
name|i
index|]
operator|.
name|lro
operator|.
name|stats
operator|.
name|aggregated
expr_stmt|;
name|priv
operator|->
name|port_stats
operator|.
name|lro_flushed
operator|+=
name|priv
operator|->
name|rx_ring
index|[
name|i
index|]
operator|.
name|lro
operator|.
name|stats
operator|.
name|flushed
expr_stmt|;
name|priv
operator|->
name|port_stats
operator|.
name|lro_no_desc
operator|+=
name|priv
operator|->
name|rx_ring
index|[
name|i
index|]
operator|.
name|lro
operator|.
name|stats
operator|.
name|no_desc
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_en_get_drvinfo
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|,
name|struct
name|ethtool_drvinfo
modifier|*
name|drvinfo
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|mlx4_en_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|sprintf
argument_list|(
name|drvinfo
operator|->
name|driver
argument_list|,
name|DRV_NAME
literal|" (%s)"
argument_list|,
name|mdev
operator|->
name|dev
operator|->
name|board_id
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|drvinfo
operator|->
name|version
argument_list|,
name|DRV_VERSION
literal|" ("
name|DRV_RELDATE
literal|")"
argument_list|,
literal|32
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|drvinfo
operator|->
name|fw_version
argument_list|,
literal|"%d.%d.%d"
argument_list|,
call|(
name|u16
call|)
argument_list|(
name|mdev
operator|->
name|dev
operator|->
name|caps
operator|.
name|fw_ver
operator|>>
literal|32
argument_list|)
argument_list|,
call|(
name|u16
call|)
argument_list|(
operator|(
name|mdev
operator|->
name|dev
operator|->
name|caps
operator|.
name|fw_ver
operator|>>
literal|16
operator|)
operator|&
literal|0xffff
argument_list|)
argument_list|,
call|(
name|u16
call|)
argument_list|(
name|mdev
operator|->
name|dev
operator|->
name|caps
operator|.
name|fw_ver
operator|&
literal|0xffff
argument_list|)
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|drvinfo
operator|->
name|bus_info
argument_list|,
name|pci_name
argument_list|(
name|mdev
operator|->
name|dev
operator|->
name|pdev
argument_list|)
argument_list|,
literal|32
argument_list|)
expr_stmt|;
name|drvinfo
operator|->
name|n_stats
operator|=
literal|0
expr_stmt|;
name|drvinfo
operator|->
name|regdump_len
operator|=
literal|0
expr_stmt|;
name|drvinfo
operator|->
name|eedump_len
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|u32
name|mlx4_en_get_tso
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|)
block|{
return|return
operator|(
name|dev
operator|->
name|features
operator|&
name|NETIF_F_TSO
operator|)
operator|!=
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_en_set_tso
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|,
name|u32
name|data
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|data
condition|)
block|{
if|if
condition|(
operator|!
name|priv
operator|->
name|mdev
operator|->
name|LSO_support
condition|)
return|return
operator|-
name|EPERM
return|;
name|dev
operator|->
name|features
operator||=
operator|(
name|NETIF_F_TSO
operator||
name|NETIF_F_TSO6
operator|)
expr_stmt|;
ifdef|#
directive|ifdef
name|HAVE_NETDEV_VLAN_FEATURES
name|dev
operator|->
name|vlan_features
operator||=
operator|(
name|NETIF_F_TSO
operator||
name|NETIF_F_TSO6
operator|)
expr_stmt|;
else|#
directive|else
if|if
condition|(
name|priv
operator|->
name|vlgrp
condition|)
block|{
name|int
name|i
decl_stmt|;
name|struct
name|net_device
modifier|*
name|vdev
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|VLAN_GROUP_ARRAY_LEN
condition|;
name|i
operator|++
control|)
block|{
name|vdev
operator|=
name|vlan_group_get_device
argument_list|(
name|priv
operator|->
name|vlgrp
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|vdev
condition|)
block|{
name|vdev
operator|->
name|features
operator||=
operator|(
name|NETIF_F_TSO
operator||
name|NETIF_F_TSO6
operator|)
expr_stmt|;
name|vlan_group_set_device
argument_list|(
name|priv
operator|->
name|vlgrp
argument_list|,
name|i
argument_list|,
name|vdev
argument_list|)
expr_stmt|;
block|}
block|}
block|}
endif|#
directive|endif
block|}
else|else
block|{
name|dev
operator|->
name|features
operator|&=
operator|~
operator|(
name|NETIF_F_TSO
operator||
name|NETIF_F_TSO6
operator|)
expr_stmt|;
ifdef|#
directive|ifdef
name|HAVE_NETDEV_VLAN_FEATURES
name|dev
operator|->
name|vlan_features
operator|&=
operator|~
operator|(
name|NETIF_F_TSO
operator||
name|NETIF_F_TSO6
operator|)
expr_stmt|;
else|#
directive|else
if|if
condition|(
name|priv
operator|->
name|vlgrp
condition|)
block|{
name|int
name|i
decl_stmt|;
name|struct
name|net_device
modifier|*
name|vdev
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|VLAN_GROUP_ARRAY_LEN
condition|;
name|i
operator|++
control|)
block|{
name|vdev
operator|=
name|vlan_group_get_device
argument_list|(
name|priv
operator|->
name|vlgrp
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|vdev
condition|)
block|{
name|vdev
operator|->
name|features
operator|&=
operator|~
operator|(
name|NETIF_F_TSO
operator||
name|NETIF_F_TSO6
operator|)
expr_stmt|;
name|vlan_group_set_device
argument_list|(
name|priv
operator|->
name|vlgrp
argument_list|,
name|i
argument_list|,
name|vdev
argument_list|)
expr_stmt|;
block|}
block|}
block|}
endif|#
directive|endif
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|u32
name|mlx4_en_get_rx_csum
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
return|return
name|priv
operator|->
name|rx_csum
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_en_set_rx_csum
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|,
name|u32
name|data
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|priv
operator|->
name|rx_csum
operator|=
operator|(
name|data
operator|!=
literal|0
operator|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|char
name|main_strings
index|[]
index|[
name|ETH_GSTRING_LEN
index|]
init|=
block|{
literal|"rx_packets"
block|,
literal|"tx_packets"
block|,
literal|"rx_bytes"
block|,
literal|"tx_bytes"
block|,
literal|"rx_errors"
block|,
literal|"tx_errors"
block|,
literal|"rx_dropped"
block|,
literal|"tx_dropped"
block|,
literal|"multicast"
block|,
literal|"collisions"
block|,
literal|"rx_length_errors"
block|,
literal|"rx_over_errors"
block|,
literal|"rx_crc_errors"
block|,
literal|"rx_frame_errors"
block|,
literal|"rx_fifo_errors"
block|,
literal|"rx_missed_errors"
block|,
literal|"tx_aborted_errors"
block|,
literal|"tx_carrier_errors"
block|,
literal|"tx_fifo_errors"
block|,
literal|"tx_heartbeat_errors"
block|,
literal|"tx_window_errors"
block|,
comment|/* port statistics */
literal|"lro_aggregated"
block|,
literal|"lro_flushed"
block|,
literal|"lro_no_desc"
block|,
literal|"tso_packets"
block|,
literal|"queue_stopped"
block|,
literal|"wake_queue"
block|,
literal|"tx_timeout"
block|,
literal|"rx_alloc_failed"
block|,
literal|"rx_csum_good"
block|,
literal|"rx_csum_none"
block|,
literal|"tx_chksum_offload"
block|,
comment|/* packet statistics */
literal|"broadcast"
block|,
literal|"rx_prio_0"
block|,
literal|"rx_prio_1"
block|,
literal|"rx_prio_2"
block|,
literal|"rx_prio_3"
block|,
literal|"rx_prio_4"
block|,
literal|"rx_prio_5"
block|,
literal|"rx_prio_6"
block|,
literal|"rx_prio_7"
block|,
literal|"tx_prio_0"
block|,
literal|"tx_prio_1"
block|,
literal|"tx_prio_2"
block|,
literal|"tx_prio_3"
block|,
literal|"tx_prio_4"
block|,
literal|"tx_prio_5"
block|,
literal|"tx_prio_6"
block|,
literal|"tx_prio_7"
block|, }
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|NUM_MAIN_STATS
value|21
end_define

begin_define
define|#
directive|define
name|NUM_ALL_STATS
value|(NUM_MAIN_STATS + NUM_PORT_STATS + NUM_PKT_STATS + NUM_PERF_STATS)
end_define

begin_decl_stmt
specifier|static
specifier|const
name|char
name|mlx4_en_test_names
index|[]
index|[
name|ETH_GSTRING_LEN
index|]
init|=
block|{
literal|"Interupt Test"
block|,
literal|"Link Test"
block|,
literal|"Speed Test"
block|,
literal|"Register Test"
block|,
literal|"Loopback Test"
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|u32
name|mlx4_en_get_msglevel
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|)
block|{
return|return
operator|(
operator|(
expr|struct
name|mlx4_en_priv
operator|*
operator|)
name|netdev_priv
argument_list|(
name|dev
argument_list|)
operator|)
operator|->
name|msg_enable
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_en_set_msglevel
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|,
name|u32
name|val
parameter_list|)
block|{
operator|(
operator|(
expr|struct
name|mlx4_en_priv
operator|*
operator|)
name|netdev_priv
argument_list|(
name|dev
argument_list|)
operator|)
operator|->
name|msg_enable
operator|=
name|val
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_en_get_wol
parameter_list|(
name|struct
name|net_device
modifier|*
name|netdev
parameter_list|,
name|struct
name|ethtool_wolinfo
modifier|*
name|wol
parameter_list|)
block|{
name|wol
operator|->
name|supported
operator|=
literal|0
expr_stmt|;
name|wol
operator|->
name|wolopts
operator|=
literal|0
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_en_get_sset_count
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|,
name|int
name|sset
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
switch|switch
condition|(
name|sset
condition|)
block|{
case|case
name|ETH_SS_STATS
case|:
return|return
name|NUM_ALL_STATS
operator|+
operator|(
name|priv
operator|->
name|tx_ring_num
operator|+
name|priv
operator|->
name|rx_ring_num
operator|)
operator|*
literal|2
return|;
case|case
name|ETH_SS_TEST
case|:
return|return
name|MLX4_EN_NUM_SELF_TEST
operator|-
operator|!
operator|(
name|priv
operator|->
name|mdev
operator|->
name|dev
operator|->
name|caps
operator|.
name|loopback_support
operator|)
operator|*
literal|2
return|;
default|default:
return|return
operator|-
name|EOPNOTSUPP
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_en_get_ethtool_stats
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|,
name|struct
name|ethtool_stats
modifier|*
name|stats
parameter_list|,
name|uint64_t
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|index
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
name|spin_lock_bh
argument_list|(
operator|&
name|priv
operator|->
name|stats_lock
argument_list|)
expr_stmt|;
name|mlx4_en_update_lro_stats
argument_list|(
name|priv
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_MAIN_STATS
condition|;
name|i
operator|++
control|)
name|data
index|[
name|index
operator|++
index|]
operator|=
operator|(
operator|(
name|unsigned
name|long
operator|*
operator|)
operator|&
name|priv
operator|->
name|stats
operator|)
index|[
name|i
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_PORT_STATS
condition|;
name|i
operator|++
control|)
name|data
index|[
name|index
operator|++
index|]
operator|=
operator|(
operator|(
name|unsigned
name|long
operator|*
operator|)
operator|&
name|priv
operator|->
name|port_stats
operator|)
index|[
name|i
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|tx_ring_num
condition|;
name|i
operator|++
control|)
block|{
name|data
index|[
name|index
operator|++
index|]
operator|=
name|priv
operator|->
name|tx_ring
index|[
name|i
index|]
operator|.
name|packets
expr_stmt|;
name|data
index|[
name|index
operator|++
index|]
operator|=
name|priv
operator|->
name|tx_ring
index|[
name|i
index|]
operator|.
name|bytes
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|rx_ring_num
condition|;
name|i
operator|++
control|)
block|{
name|data
index|[
name|index
operator|++
index|]
operator|=
name|priv
operator|->
name|rx_ring
index|[
name|i
index|]
operator|.
name|packets
expr_stmt|;
name|data
index|[
name|index
operator|++
index|]
operator|=
name|priv
operator|->
name|rx_ring
index|[
name|i
index|]
operator|.
name|bytes
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_PKT_STATS
condition|;
name|i
operator|++
control|)
name|data
index|[
name|index
operator|++
index|]
operator|=
operator|(
operator|(
name|unsigned
name|long
operator|*
operator|)
operator|&
name|priv
operator|->
name|pkstats
operator|)
index|[
name|i
index|]
expr_stmt|;
name|spin_unlock_bh
argument_list|(
operator|&
name|priv
operator|->
name|stats_lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_en_self_test
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|,
name|struct
name|ethtool_test
modifier|*
name|etest
parameter_list|,
name|u64
modifier|*
name|buf
parameter_list|)
block|{
name|mlx4_en_ex_selftest
argument_list|(
name|dev
argument_list|,
operator|&
name|etest
operator|->
name|flags
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_en_get_strings
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|,
name|uint32_t
name|stringset
parameter_list|,
name|uint8_t
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|index
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
switch|switch
condition|(
name|stringset
condition|)
block|{
case|case
name|ETH_SS_TEST
case|:
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MLX4_EN_NUM_SELF_TEST
operator|-
literal|2
condition|;
name|i
operator|++
control|)
name|strcpy
argument_list|(
name|data
operator|+
name|i
operator|*
name|ETH_GSTRING_LEN
argument_list|,
name|mlx4_en_test_names
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|mdev
operator|->
name|dev
operator|->
name|caps
operator|.
name|loopback_support
condition|)
for|for
control|(
init|;
name|i
operator|<
name|MLX4_EN_NUM_SELF_TEST
condition|;
name|i
operator|++
control|)
name|strcpy
argument_list|(
name|data
operator|+
name|i
operator|*
name|ETH_GSTRING_LEN
argument_list|,
name|mlx4_en_test_names
index|[
name|i
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|ETH_SS_STATS
case|:
comment|/* Add main counters */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_MAIN_STATS
condition|;
name|i
operator|++
control|)
name|strcpy
argument_list|(
name|data
operator|+
operator|(
name|index
operator|++
operator|)
operator|*
name|ETH_GSTRING_LEN
argument_list|,
name|main_strings
index|[
name|i
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_PORT_STATS
condition|;
name|i
operator|++
control|)
name|strcpy
argument_list|(
name|data
operator|+
operator|(
name|index
operator|++
operator|)
operator|*
name|ETH_GSTRING_LEN
argument_list|,
name|main_strings
index|[
name|i
operator|+
name|NUM_MAIN_STATS
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|tx_ring_num
condition|;
name|i
operator|++
control|)
block|{
name|sprintf
argument_list|(
name|data
operator|+
operator|(
name|index
operator|++
operator|)
operator|*
name|ETH_GSTRING_LEN
argument_list|,
literal|"tx%d_packets"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|data
operator|+
operator|(
name|index
operator|++
operator|)
operator|*
name|ETH_GSTRING_LEN
argument_list|,
literal|"tx%d_bytes"
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|rx_ring_num
condition|;
name|i
operator|++
control|)
block|{
name|sprintf
argument_list|(
name|data
operator|+
operator|(
name|index
operator|++
operator|)
operator|*
name|ETH_GSTRING_LEN
argument_list|,
literal|"rx%d_packets"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|data
operator|+
operator|(
name|index
operator|++
operator|)
operator|*
name|ETH_GSTRING_LEN
argument_list|,
literal|"rx%d_bytes"
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_PKT_STATS
condition|;
name|i
operator|++
control|)
name|strcpy
argument_list|(
name|data
operator|+
operator|(
name|index
operator|++
operator|)
operator|*
name|ETH_GSTRING_LEN
argument_list|,
name|main_strings
index|[
name|i
operator|+
name|NUM_MAIN_STATS
operator|+
name|NUM_PORT_STATS
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_en_get_settings
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|,
name|struct
name|ethtool_cmd
modifier|*
name|cmd
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|trans_type
decl_stmt|;
name|cmd
operator|->
name|autoneg
operator|=
name|AUTONEG_DISABLE
expr_stmt|;
name|cmd
operator|->
name|supported
operator|=
name|SUPPORTED_10000baseT_Full
expr_stmt|;
name|cmd
operator|->
name|advertising
operator|=
name|ADVERTISED_10000baseT_Full
expr_stmt|;
if|if
condition|(
name|mlx4_en_QUERY_PORT
argument_list|(
name|priv
operator|->
name|mdev
argument_list|,
name|priv
operator|->
name|port
argument_list|)
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|trans_type
operator|=
name|priv
operator|->
name|port_state
operator|.
name|transciver
expr_stmt|;
if|if
condition|(
name|netif_carrier_ok
argument_list|(
name|dev
argument_list|)
condition|)
block|{
name|cmd
operator|->
name|speed
operator|=
name|priv
operator|->
name|port_state
operator|.
name|link_speed
expr_stmt|;
name|cmd
operator|->
name|duplex
operator|=
name|DUPLEX_FULL
expr_stmt|;
block|}
else|else
block|{
name|cmd
operator|->
name|speed
operator|=
operator|-
literal|1
expr_stmt|;
name|cmd
operator|->
name|duplex
operator|=
operator|-
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|trans_type
operator|>
literal|0
operator|&&
name|trans_type
operator|<=
literal|0xC
condition|)
block|{
name|cmd
operator|->
name|port
operator|=
name|PORT_FIBRE
expr_stmt|;
name|cmd
operator|->
name|transceiver
operator|=
name|XCVR_EXTERNAL
expr_stmt|;
name|cmd
operator|->
name|supported
operator||=
name|SUPPORTED_FIBRE
expr_stmt|;
name|cmd
operator|->
name|advertising
operator||=
name|ADVERTISED_FIBRE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|trans_type
operator|==
literal|0x80
operator|||
name|trans_type
operator|==
literal|0
condition|)
block|{
name|cmd
operator|->
name|port
operator|=
name|PORT_TP
expr_stmt|;
name|cmd
operator|->
name|transceiver
operator|=
name|XCVR_INTERNAL
expr_stmt|;
name|cmd
operator|->
name|supported
operator||=
name|SUPPORTED_TP
expr_stmt|;
name|cmd
operator|->
name|advertising
operator||=
name|ADVERTISED_TP
expr_stmt|;
block|}
else|else
block|{
name|cmd
operator|->
name|port
operator|=
operator|-
literal|1
expr_stmt|;
name|cmd
operator|->
name|transceiver
operator|=
operator|-
literal|1
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_en_set_settings
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|,
name|struct
name|ethtool_cmd
modifier|*
name|cmd
parameter_list|)
block|{
if|if
condition|(
operator|(
name|cmd
operator|->
name|autoneg
operator|==
name|AUTONEG_ENABLE
operator|)
operator|||
operator|(
name|cmd
operator|->
name|speed
operator|!=
name|SPEED_10000
operator|)
operator|||
operator|(
name|cmd
operator|->
name|duplex
operator|!=
name|DUPLEX_FULL
operator|)
condition|)
return|return
operator|-
name|EINVAL
return|;
comment|/* Nothing to change */
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_en_get_coalesce
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|,
name|struct
name|ethtool_coalesce
modifier|*
name|coal
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|coal
operator|->
name|tx_coalesce_usecs
operator|=
literal|0
expr_stmt|;
name|coal
operator|->
name|tx_max_coalesced_frames
operator|=
literal|0
expr_stmt|;
name|coal
operator|->
name|rx_coalesce_usecs
operator|=
name|priv
operator|->
name|rx_usecs
expr_stmt|;
name|coal
operator|->
name|rx_max_coalesced_frames
operator|=
name|priv
operator|->
name|rx_frames
expr_stmt|;
name|coal
operator|->
name|pkt_rate_low
operator|=
name|priv
operator|->
name|pkt_rate_low
expr_stmt|;
name|coal
operator|->
name|rx_coalesce_usecs_low
operator|=
name|priv
operator|->
name|rx_usecs_low
expr_stmt|;
name|coal
operator|->
name|pkt_rate_high
operator|=
name|priv
operator|->
name|pkt_rate_high
expr_stmt|;
name|coal
operator|->
name|rx_coalesce_usecs_high
operator|=
name|priv
operator|->
name|rx_usecs_high
expr_stmt|;
name|coal
operator|->
name|rate_sample_interval
operator|=
name|priv
operator|->
name|sample_interval
expr_stmt|;
name|coal
operator|->
name|use_adaptive_rx_coalesce
operator|=
name|priv
operator|->
name|adaptive_rx_coal
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_en_set_coalesce
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|,
name|struct
name|ethtool_coalesce
modifier|*
name|coal
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|err
decl_stmt|,
name|i
decl_stmt|;
name|priv
operator|->
name|rx_frames
operator|=
operator|(
name|coal
operator|->
name|rx_max_coalesced_frames
operator|==
name|MLX4_EN_AUTO_CONF
operator|)
condition|?
name|MLX4_EN_RX_COAL_TARGET
operator|/
name|priv
operator|->
name|dev
operator|->
name|mtu
operator|+
literal|1
else|:
name|coal
operator|->
name|rx_max_coalesced_frames
expr_stmt|;
name|priv
operator|->
name|rx_usecs
operator|=
operator|(
name|coal
operator|->
name|rx_coalesce_usecs
operator|==
name|MLX4_EN_AUTO_CONF
operator|)
condition|?
name|MLX4_EN_RX_COAL_TIME
else|:
name|coal
operator|->
name|rx_coalesce_usecs
expr_stmt|;
comment|/* Set adaptive coalescing params */
name|priv
operator|->
name|pkt_rate_low
operator|=
name|coal
operator|->
name|pkt_rate_low
expr_stmt|;
name|priv
operator|->
name|rx_usecs_low
operator|=
name|coal
operator|->
name|rx_coalesce_usecs_low
expr_stmt|;
name|priv
operator|->
name|pkt_rate_high
operator|=
name|coal
operator|->
name|pkt_rate_high
expr_stmt|;
name|priv
operator|->
name|rx_usecs_high
operator|=
name|coal
operator|->
name|rx_coalesce_usecs_high
expr_stmt|;
name|priv
operator|->
name|sample_interval
operator|=
name|coal
operator|->
name|rate_sample_interval
expr_stmt|;
name|priv
operator|->
name|adaptive_rx_coal
operator|=
name|coal
operator|->
name|use_adaptive_rx_coalesce
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|adaptive_rx_coal
condition|)
return|return
literal|0
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|rx_ring_num
condition|;
name|i
operator|++
control|)
block|{
name|priv
operator|->
name|rx_cq
index|[
name|i
index|]
operator|.
name|moder_cnt
operator|=
name|priv
operator|->
name|rx_frames
expr_stmt|;
name|priv
operator|->
name|rx_cq
index|[
name|i
index|]
operator|.
name|moder_time
operator|=
name|priv
operator|->
name|rx_usecs
expr_stmt|;
name|priv
operator|->
name|last_moder_time
index|[
name|i
index|]
operator|=
name|MLX4_EN_AUTO_CONF
expr_stmt|;
name|err
operator|=
name|mlx4_en_set_cq_moder
argument_list|(
name|priv
argument_list|,
operator|&
name|priv
operator|->
name|rx_cq
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_en_set_pauseparam
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|,
name|struct
name|ethtool_pauseparam
modifier|*
name|pause
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|mlx4_en_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|int
name|err
decl_stmt|;
name|priv
operator|->
name|prof
operator|->
name|tx_pause
operator|=
name|pause
operator|->
name|tx_pause
operator|!=
literal|0
expr_stmt|;
name|priv
operator|->
name|prof
operator|->
name|rx_pause
operator|=
name|pause
operator|->
name|rx_pause
operator|!=
literal|0
expr_stmt|;
name|err
operator|=
name|mlx4_SET_PORT_general
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|,
name|priv
operator|->
name|rx_mb_size
operator|+
name|ETH_FCS_LEN
argument_list|,
name|priv
operator|->
name|prof
operator|->
name|tx_pause
argument_list|,
name|priv
operator|->
name|prof
operator|->
name|tx_ppp
argument_list|,
name|priv
operator|->
name|prof
operator|->
name|rx_pause
argument_list|,
name|priv
operator|->
name|prof
operator|->
name|rx_ppp
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed setting pause params\n"
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_en_get_pauseparam
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|,
name|struct
name|ethtool_pauseparam
modifier|*
name|pause
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|pause
operator|->
name|tx_pause
operator|=
name|priv
operator|->
name|prof
operator|->
name|tx_pause
expr_stmt|;
name|pause
operator|->
name|rx_pause
operator|=
name|priv
operator|->
name|prof
operator|->
name|rx_pause
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_en_set_ringparam
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|,
name|struct
name|ethtool_ringparam
modifier|*
name|param
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|mlx4_en_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|u32
name|rx_size
decl_stmt|,
name|tx_size
decl_stmt|;
name|int
name|port_up
init|=
literal|0
decl_stmt|;
name|int
name|err
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|param
operator|->
name|rx_jumbo_pending
operator|||
name|param
operator|->
name|rx_mini_pending
condition|)
return|return
operator|-
name|EINVAL
return|;
name|rx_size
operator|=
name|roundup_pow_of_two
argument_list|(
name|param
operator|->
name|rx_pending
argument_list|)
expr_stmt|;
name|rx_size
operator|=
name|max_t
argument_list|(
name|u32
argument_list|,
name|rx_size
argument_list|,
name|MLX4_EN_MIN_RX_SIZE
argument_list|)
expr_stmt|;
name|rx_size
operator|=
name|min_t
argument_list|(
name|u32
argument_list|,
name|rx_size
argument_list|,
name|MLX4_EN_MAX_RX_SIZE
argument_list|)
expr_stmt|;
name|tx_size
operator|=
name|roundup_pow_of_two
argument_list|(
name|param
operator|->
name|tx_pending
argument_list|)
expr_stmt|;
name|tx_size
operator|=
name|max_t
argument_list|(
name|u32
argument_list|,
name|tx_size
argument_list|,
name|MLX4_EN_MIN_TX_SIZE
argument_list|)
expr_stmt|;
name|tx_size
operator|=
name|min_t
argument_list|(
name|u32
argument_list|,
name|tx_size
argument_list|,
name|MLX4_EN_MAX_TX_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|rx_size
operator|==
operator|(
name|priv
operator|->
name|port_up
condition|?
name|priv
operator|->
name|rx_ring
index|[
literal|0
index|]
operator|.
name|actual_size
else|:
name|priv
operator|->
name|rx_ring
index|[
literal|0
index|]
operator|.
name|size
operator|)
operator|&&
name|tx_size
operator|==
name|priv
operator|->
name|tx_ring
index|[
literal|0
index|]
operator|.
name|size
condition|)
return|return
literal|0
return|;
name|mutex_lock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|port_up
condition|)
block|{
name|port_up
operator|=
literal|1
expr_stmt|;
name|mlx4_en_stop_port
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
name|mlx4_en_free_resources
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|priv
operator|->
name|prof
operator|->
name|tx_ring_size
operator|=
name|tx_size
expr_stmt|;
name|priv
operator|->
name|prof
operator|->
name|rx_ring_size
operator|=
name|rx_size
expr_stmt|;
name|err
operator|=
name|mlx4_en_alloc_resources
argument_list|(
name|priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed reallocating port resources\n"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|port_up
condition|)
block|{
name|err
operator|=
name|mlx4_en_start_port
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed starting port\n"
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|rx_ring_num
condition|;
name|i
operator|++
control|)
block|{
name|priv
operator|->
name|rx_cq
index|[
name|i
index|]
operator|.
name|moder_cnt
operator|=
name|priv
operator|->
name|rx_frames
expr_stmt|;
name|priv
operator|->
name|rx_cq
index|[
name|i
index|]
operator|.
name|moder_time
operator|=
name|priv
operator|->
name|rx_usecs
expr_stmt|;
name|priv
operator|->
name|last_moder_time
index|[
name|i
index|]
operator|=
name|MLX4_EN_AUTO_CONF
expr_stmt|;
name|err
operator|=
name|mlx4_en_set_cq_moder
argument_list|(
name|priv
argument_list|,
operator|&
name|priv
operator|->
name|rx_cq
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|out
goto|;
block|}
name|out
label|:
name|mutex_unlock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_en_get_ringparam
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|,
name|struct
name|ethtool_ringparam
modifier|*
name|param
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|memset
argument_list|(
name|param
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|param
argument_list|)
argument_list|)
expr_stmt|;
name|param
operator|->
name|rx_max_pending
operator|=
name|MLX4_EN_MAX_RX_SIZE
expr_stmt|;
name|param
operator|->
name|tx_max_pending
operator|=
name|MLX4_EN_MAX_TX_SIZE
expr_stmt|;
name|param
operator|->
name|rx_pending
operator|=
name|priv
operator|->
name|port_up
condition|?
name|priv
operator|->
name|rx_ring
index|[
literal|0
index|]
operator|.
name|actual_size
else|:
name|priv
operator|->
name|rx_ring
index|[
literal|0
index|]
operator|.
name|size
expr_stmt|;
name|param
operator|->
name|tx_pending
operator|=
name|priv
operator|->
name|tx_ring
index|[
literal|0
index|]
operator|.
name|size
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|const
name|struct
name|ethtool_ops
name|mlx4_en_ethtool_ops
init|=
block|{
operator|.
name|get_drvinfo
operator|=
name|mlx4_en_get_drvinfo
block|,
operator|.
name|get_settings
operator|=
name|mlx4_en_get_settings
block|,
operator|.
name|set_settings
operator|=
name|mlx4_en_set_settings
block|,
ifdef|#
directive|ifdef
name|NETIF_F_TSO
operator|.
name|get_tso
operator|=
name|mlx4_en_get_tso
block|,
operator|.
name|set_tso
operator|=
name|mlx4_en_set_tso
block|,
endif|#
directive|endif
operator|.
name|get_sg
operator|=
name|ethtool_op_get_sg
block|,
operator|.
name|set_sg
operator|=
name|ethtool_op_set_sg
block|,
operator|.
name|get_link
operator|=
name|ethtool_op_get_link
block|,
operator|.
name|get_rx_csum
operator|=
name|mlx4_en_get_rx_csum
block|,
operator|.
name|set_rx_csum
operator|=
name|mlx4_en_set_rx_csum
block|,
operator|.
name|get_tx_csum
operator|=
name|ethtool_op_get_tx_csum
block|,
operator|.
name|set_tx_csum
operator|=
name|ethtool_op_set_tx_ipv6_csum
block|,
operator|.
name|get_strings
operator|=
name|mlx4_en_get_strings
block|,
operator|.
name|get_sset_count
operator|=
name|mlx4_en_get_sset_count
block|,
operator|.
name|get_ethtool_stats
operator|=
name|mlx4_en_get_ethtool_stats
block|,
operator|.
name|self_test
operator|=
name|mlx4_en_self_test
block|,
operator|.
name|get_wol
operator|=
name|mlx4_en_get_wol
block|,
operator|.
name|set_wol
operator|=
name|mlx4_en_set_wol
block|,
operator|.
name|get_msglevel
operator|=
name|mlx4_en_get_msglevel
block|,
operator|.
name|set_msglevel
operator|=
name|mlx4_en_set_msglevel
block|,
operator|.
name|get_coalesce
operator|=
name|mlx4_en_get_coalesce
block|,
operator|.
name|set_coalesce
operator|=
name|mlx4_en_set_coalesce
block|,
operator|.
name|get_pauseparam
operator|=
name|mlx4_en_get_pauseparam
block|,
operator|.
name|set_pauseparam
operator|=
name|mlx4_en_set_pauseparam
block|,
operator|.
name|get_ringparam
operator|=
name|mlx4_en_get_ringparam
block|,
operator|.
name|set_ringparam
operator|=
name|mlx4_en_set_ringparam
block|,
operator|.
name|get_flags
operator|=
name|ethtool_op_get_flags
block|,
operator|.
name|set_flags
operator|=
name|ethtool_op_set_flags
block|, }
decl_stmt|;
end_decl_stmt

end_unit


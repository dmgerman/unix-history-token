begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2007, 2014 Mellanox Technologies. All rights reserved.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  *  */
end_comment

begin_include
include|#
directive|include
file|<linux/kernel.h>
end_include

begin_include
include|#
directive|include
file|<linux/ethtool.h>
end_include

begin_include
include|#
directive|include
file|<linux/netdevice.h>
end_include

begin_include
include|#
directive|include
file|<linux/mlx4/driver.h>
end_include

begin_include
include|#
directive|include
file|<linux/in.h>
end_include

begin_include
include|#
directive|include
file|<net/ip.h>
end_include

begin_include
include|#
directive|include
file|<linux/bitmap.h>
end_include

begin_include
include|#
directive|include
file|"mlx4_en.h"
end_include

begin_include
include|#
directive|include
file|"en_port.h"
end_include

begin_define
define|#
directive|define
name|EN_ETHTOOL_QP_ATTACH
value|(1ull<< 63)
end_define

begin_union
union|union
name|mlx4_ethtool_flow_union
block|{
name|struct
name|ethtool_tcpip4_spec
name|tcp_ip4_spec
decl_stmt|;
name|struct
name|ethtool_tcpip4_spec
name|udp_ip4_spec
decl_stmt|;
name|struct
name|ethtool_tcpip4_spec
name|sctp_ip4_spec
decl_stmt|;
name|struct
name|ethtool_ah_espip4_spec
name|ah_ip4_spec
decl_stmt|;
name|struct
name|ethtool_ah_espip4_spec
name|esp_ip4_spec
decl_stmt|;
name|struct
name|ethtool_usrip4_spec
name|usr_ip4_spec
decl_stmt|;
name|struct
name|ethhdr
name|ether_spec
decl_stmt|;
name|__u8
name|hdata
index|[
literal|52
index|]
decl_stmt|;
block|}
union|;
end_union

begin_struct
struct|struct
name|mlx4_ethtool_flow_ext
block|{
name|__u8
name|padding
index|[
literal|2
index|]
decl_stmt|;
name|unsigned
name|char
name|h_dest
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|__be16
name|vlan_etype
decl_stmt|;
name|__be16
name|vlan_tci
decl_stmt|;
name|__be32
name|data
index|[
literal|2
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|mlx4_ethtool_rx_flow_spec
block|{
name|__u32
name|flow_type
decl_stmt|;
name|union
name|mlx4_ethtool_flow_union
name|h_u
decl_stmt|;
name|struct
name|mlx4_ethtool_flow_ext
name|h_ext
decl_stmt|;
name|union
name|mlx4_ethtool_flow_union
name|m_u
decl_stmt|;
name|struct
name|mlx4_ethtool_flow_ext
name|m_ext
decl_stmt|;
name|__u64
name|ring_cookie
decl_stmt|;
name|__u32
name|location
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|mlx4_ethtool_rxnfc
block|{
name|__u32
name|cmd
decl_stmt|;
name|__u32
name|flow_type
decl_stmt|;
name|__u64
name|data
decl_stmt|;
name|struct
name|mlx4_ethtool_rx_flow_spec
name|fs
decl_stmt|;
name|__u32
name|rule_cnt
decl_stmt|;
name|__u32
name|rule_locs
index|[
literal|0
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_ifndef
ifndef|#
directive|ifndef
name|FLOW_MAC_EXT
end_ifndef

begin_define
define|#
directive|define
name|FLOW_MAC_EXT
value|0x40000000
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|void
name|mlx4_en_get_drvinfo
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|,
name|struct
name|ethtool_drvinfo
modifier|*
name|drvinfo
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|mlx4_en_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|strlcpy
argument_list|(
name|drvinfo
operator|->
name|driver
argument_list|,
name|DRV_NAME
argument_list|,
sizeof|sizeof
argument_list|(
name|drvinfo
operator|->
name|driver
argument_list|)
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|drvinfo
operator|->
name|version
argument_list|,
name|DRV_VERSION
literal|" ("
name|DRV_RELDATE
literal|")"
argument_list|,
sizeof|sizeof
argument_list|(
name|drvinfo
operator|->
name|version
argument_list|)
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|drvinfo
operator|->
name|fw_version
argument_list|,
sizeof|sizeof
argument_list|(
name|drvinfo
operator|->
name|fw_version
argument_list|)
argument_list|,
literal|"%d.%d.%d"
argument_list|,
call|(
name|u16
call|)
argument_list|(
name|mdev
operator|->
name|dev
operator|->
name|caps
operator|.
name|fw_ver
operator|>>
literal|32
argument_list|)
argument_list|,
call|(
name|u16
call|)
argument_list|(
operator|(
name|mdev
operator|->
name|dev
operator|->
name|caps
operator|.
name|fw_ver
operator|>>
literal|16
operator|)
operator|&
literal|0xffff
argument_list|)
argument_list|,
call|(
name|u16
call|)
argument_list|(
name|mdev
operator|->
name|dev
operator|->
name|caps
operator|.
name|fw_ver
operator|&
literal|0xffff
argument_list|)
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|drvinfo
operator|->
name|bus_info
argument_list|,
name|pci_name
argument_list|(
name|mdev
operator|->
name|dev
operator|->
name|pdev
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|drvinfo
operator|->
name|bus_info
argument_list|)
argument_list|)
expr_stmt|;
name|drvinfo
operator|->
name|n_stats
operator|=
literal|0
expr_stmt|;
name|drvinfo
operator|->
name|regdump_len
operator|=
literal|0
expr_stmt|;
name|drvinfo
operator|->
name|eedump_len
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|char
name|main_strings
index|[]
index|[
name|ETH_GSTRING_LEN
index|]
init|=
block|{
comment|/* packet statistics */
literal|"rx_packets"
block|,
literal|"rx_bytes"
block|,
literal|"rx_multicast_packets"
block|,
literal|"rx_broadcast_packets"
block|,
literal|"rx_errors"
block|,
literal|"rx_dropped"
block|,
literal|"rx_length_errors"
block|,
literal|"rx_over_errors"
block|,
literal|"rx_crc_errors"
block|,
literal|"rx_jabbers"
block|,
literal|"rx_in_range_length_error"
block|,
literal|"rx_out_range_length_error"
block|,
literal|"rx_lt_64_bytes_packets"
block|,
literal|"rx_127_bytes_packets"
block|,
literal|"rx_255_bytes_packets"
block|,
literal|"rx_511_bytes_packets"
block|,
literal|"rx_1023_bytes_packets"
block|,
literal|"rx_1518_bytes_packets"
block|,
literal|"rx_1522_bytes_packets"
block|,
literal|"rx_1548_bytes_packets"
block|,
literal|"rx_gt_1548_bytes_packets"
block|,
literal|"tx_packets"
block|,
literal|"tx_bytes"
block|,
literal|"tx_multicast_packets"
block|,
literal|"tx_broadcast_packets"
block|,
literal|"tx_errors"
block|,
literal|"tx_dropped"
block|,
literal|"tx_lt_64_bytes_packets"
block|,
literal|"tx_127_bytes_packets"
block|,
literal|"tx_255_bytes_packets"
block|,
literal|"tx_511_bytes_packets"
block|,
literal|"tx_1023_bytes_packets"
block|,
literal|"tx_1518_bytes_packets"
block|,
literal|"tx_1522_bytes_packets"
block|,
literal|"tx_1548_bytes_packets"
block|,
literal|"tx_gt_1548_bytes_packets"
block|,
literal|"rx_prio_0_packets"
block|,
literal|"rx_prio_0_bytes"
block|,
literal|"rx_prio_1_packets"
block|,
literal|"rx_prio_1_bytes"
block|,
literal|"rx_prio_2_packets"
block|,
literal|"rx_prio_2_bytes"
block|,
literal|"rx_prio_3_packets"
block|,
literal|"rx_prio_3_bytes"
block|,
literal|"rx_prio_4_packets"
block|,
literal|"rx_prio_4_bytes"
block|,
literal|"rx_prio_5_packets"
block|,
literal|"rx_prio_5_bytes"
block|,
literal|"rx_prio_6_packets"
block|,
literal|"rx_prio_6_bytes"
block|,
literal|"rx_prio_7_packets"
block|,
literal|"rx_prio_7_bytes"
block|,
literal|"rx_novlan_packets"
block|,
literal|"rx_novlan_bytes"
block|,
literal|"tx_prio_0_packets"
block|,
literal|"tx_prio_0_bytes"
block|,
literal|"tx_prio_1_packets"
block|,
literal|"tx_prio_1_bytes"
block|,
literal|"tx_prio_2_packets"
block|,
literal|"tx_prio_2_bytes"
block|,
literal|"tx_prio_3_packets"
block|,
literal|"tx_prio_3_bytes"
block|,
literal|"tx_prio_4_packets"
block|,
literal|"tx_prio_4_bytes"
block|,
literal|"tx_prio_5_packets"
block|,
literal|"tx_prio_5_bytes"
block|,
literal|"tx_prio_6_packets"
block|,
literal|"tx_prio_6_bytes"
block|,
literal|"tx_prio_7_packets"
block|,
literal|"tx_prio_7_bytes"
block|,
literal|"tx_novlan_packets"
block|,
literal|"tx_novlan_bytes"
block|,
comment|/* flow control statistics */
literal|"rx_pause_prio_0"
block|,
literal|"rx_pause_duration_prio_0"
block|,
literal|"rx_pause_transition_prio_0"
block|,
literal|"tx_pause_prio_0"
block|,
literal|"tx_pause_duration_prio_0"
block|,
literal|"tx_pause_transition_prio_0"
block|,
literal|"rx_pause_prio_1"
block|,
literal|"rx_pause_duration_prio_1"
block|,
literal|"rx_pause_transition_prio_1"
block|,
literal|"tx_pause_prio_1"
block|,
literal|"tx_pause_duration_prio_1"
block|,
literal|"tx_pause_transition_prio_1"
block|,
literal|"rx_pause_prio_2"
block|,
literal|"rx_pause_duration_prio_2"
block|,
literal|"rx_pause_transition_prio_2"
block|,
literal|"tx_pause_prio_2"
block|,
literal|"tx_pause_duration_prio_2"
block|,
literal|"tx_pause_transition_prio_2"
block|,
literal|"rx_pause_prio_3"
block|,
literal|"rx_pause_duration_prio_3"
block|,
literal|"rx_pause_transition_prio_3"
block|,
literal|"tx_pause_prio_3"
block|,
literal|"tx_pause_duration_prio_3"
block|,
literal|"tx_pause_transition_prio_3"
block|,
literal|"rx_pause_prio_4"
block|,
literal|"rx_pause_duration_prio_4"
block|,
literal|"rx_pause_transition_prio_4"
block|,
literal|"tx_pause_prio_4"
block|,
literal|"tx_pause_duration_prio_4"
block|,
literal|"tx_pause_transition_prio_4"
block|,
literal|"rx_pause_prio_5"
block|,
literal|"rx_pause_duration_prio_5"
block|,
literal|"rx_pause_transition_prio_5"
block|,
literal|"tx_pause_prio_5"
block|,
literal|"tx_pause_duration_prio_5"
block|,
literal|"tx_pause_transition_prio_5"
block|,
literal|"rx_pause_prio_6"
block|,
literal|"rx_pause_duration_prio_6"
block|,
literal|"rx_pause_transition_prio_6"
block|,
literal|"tx_pause_prio_6"
block|,
literal|"tx_pause_duration_prio_6"
block|,
literal|"tx_pause_transition_prio_6"
block|,
literal|"rx_pause_prio_7"
block|,
literal|"rx_pause_duration_prio_7"
block|,
literal|"rx_pause_transition_prio_7"
block|,
literal|"tx_pause_prio_7"
block|,
literal|"tx_pause_duration_prio_7"
block|,
literal|"tx_pause_transition_prio_7"
block|,
comment|/* VF statistics */
literal|"rx_packets"
block|,
literal|"rx_bytes"
block|,
literal|"rx_multicast_packets"
block|,
literal|"rx_broadcast_packets"
block|,
literal|"rx_errors"
block|,
literal|"rx_dropped"
block|,
literal|"tx_packets"
block|,
literal|"tx_bytes"
block|,
literal|"tx_multicast_packets"
block|,
literal|"tx_broadcast_packets"
block|,
literal|"tx_errors"
block|,
comment|/* VPort statistics */
literal|"vport_rx_unicast_packets"
block|,
literal|"vport_rx_unicast_bytes"
block|,
literal|"vport_rx_multicast_packets"
block|,
literal|"vport_rx_multicast_bytes"
block|,
literal|"vport_rx_broadcast_packets"
block|,
literal|"vport_rx_broadcast_bytes"
block|,
literal|"vport_rx_dropped"
block|,
literal|"vport_rx_errors"
block|,
literal|"vport_tx_unicast_packets"
block|,
literal|"vport_tx_unicast_bytes"
block|,
literal|"vport_tx_multicast_packets"
block|,
literal|"vport_tx_multicast_bytes"
block|,
literal|"vport_tx_broadcast_packets"
block|,
literal|"vport_tx_broadcast_bytes"
block|,
literal|"vport_tx_errors"
block|,
comment|/* port statistics */
literal|"tx_tso_packets"
block|,
literal|"tx_queue_stopped"
block|,
literal|"tx_wake_queue"
block|,
literal|"tx_timeout"
block|,
literal|"rx_alloc_failed"
block|,
literal|"rx_csum_good"
block|,
literal|"rx_csum_none"
block|,
literal|"tx_chksum_offload"
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
name|mlx4_en_test_names
index|[]
index|[
name|ETH_GSTRING_LEN
index|]
init|=
block|{
literal|"Interrupt Test"
block|,
literal|"Link Test"
block|,
literal|"Speed Test"
block|,
literal|"Register Test"
block|,
literal|"Loopback Test"
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|u32
name|mlx4_en_get_msglevel
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|)
block|{
return|return
operator|(
operator|(
expr|struct
name|mlx4_en_priv
operator|*
operator|)
name|netdev_priv
argument_list|(
name|dev
argument_list|)
operator|)
operator|->
name|msg_enable
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_en_set_msglevel
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|,
name|u32
name|val
parameter_list|)
block|{
operator|(
operator|(
expr|struct
name|mlx4_en_priv
operator|*
operator|)
name|netdev_priv
argument_list|(
name|dev
argument_list|)
operator|)
operator|->
name|msg_enable
operator|=
name|val
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_en_get_wol
parameter_list|(
name|struct
name|net_device
modifier|*
name|netdev
parameter_list|,
name|struct
name|ethtool_wolinfo
modifier|*
name|wol
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|netdev
argument_list|)
decl_stmt|;
name|int
name|err
init|=
literal|0
decl_stmt|;
name|u64
name|config
init|=
literal|0
decl_stmt|;
name|u64
name|mask
decl_stmt|;
if|if
condition|(
operator|(
name|priv
operator|->
name|port
operator|<
literal|1
operator|)
operator|||
operator|(
name|priv
operator|->
name|port
operator|>
literal|2
operator|)
condition|)
block|{
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed to get WoL information\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|mask
operator|=
operator|(
name|priv
operator|->
name|port
operator|==
literal|1
operator|)
condition|?
name|MLX4_DEV_CAP_FLAG_WOL_PORT1
else|:
name|MLX4_DEV_CAP_FLAG_WOL_PORT2
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|priv
operator|->
name|mdev
operator|->
name|dev
operator|->
name|caps
operator|.
name|flags
operator|&
name|mask
operator|)
condition|)
block|{
name|wol
operator|->
name|supported
operator|=
literal|0
expr_stmt|;
name|wol
operator|->
name|wolopts
operator|=
literal|0
expr_stmt|;
return|return;
block|}
name|err
operator|=
name|mlx4_wol_read
argument_list|(
name|priv
operator|->
name|mdev
operator|->
name|dev
argument_list|,
operator|&
name|config
argument_list|,
name|priv
operator|->
name|port
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed to get WoL information\n"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|config
operator|&
name|MLX4_EN_WOL_MAGIC
condition|)
name|wol
operator|->
name|supported
operator|=
name|WAKE_MAGIC
expr_stmt|;
else|else
name|wol
operator|->
name|supported
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|config
operator|&
name|MLX4_EN_WOL_ENABLED
condition|)
name|wol
operator|->
name|wolopts
operator|=
name|WAKE_MAGIC
expr_stmt|;
else|else
name|wol
operator|->
name|wolopts
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_en_set_wol
parameter_list|(
name|struct
name|net_device
modifier|*
name|netdev
parameter_list|,
name|struct
name|ethtool_wolinfo
modifier|*
name|wol
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|netdev
argument_list|)
decl_stmt|;
name|u64
name|config
init|=
literal|0
decl_stmt|;
name|int
name|err
init|=
literal|0
decl_stmt|;
name|u64
name|mask
decl_stmt|;
if|if
condition|(
operator|(
name|priv
operator|->
name|port
operator|<
literal|1
operator|)
operator|||
operator|(
name|priv
operator|->
name|port
operator|>
literal|2
operator|)
condition|)
return|return
operator|-
name|EOPNOTSUPP
return|;
name|mask
operator|=
operator|(
name|priv
operator|->
name|port
operator|==
literal|1
operator|)
condition|?
name|MLX4_DEV_CAP_FLAG_WOL_PORT1
else|:
name|MLX4_DEV_CAP_FLAG_WOL_PORT2
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|priv
operator|->
name|mdev
operator|->
name|dev
operator|->
name|caps
operator|.
name|flags
operator|&
name|mask
operator|)
condition|)
return|return
operator|-
name|EOPNOTSUPP
return|;
if|if
condition|(
name|wol
operator|->
name|supported
operator|&
operator|~
name|WAKE_MAGIC
condition|)
return|return
operator|-
name|EINVAL
return|;
name|err
operator|=
name|mlx4_wol_read
argument_list|(
name|priv
operator|->
name|mdev
operator|->
name|dev
argument_list|,
operator|&
name|config
argument_list|,
name|priv
operator|->
name|port
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed to get WoL info, unable to modify\n"
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
if|if
condition|(
name|wol
operator|->
name|wolopts
operator|&
name|WAKE_MAGIC
condition|)
block|{
name|config
operator||=
name|MLX4_EN_WOL_DO_MODIFY
operator||
name|MLX4_EN_WOL_ENABLED
operator||
name|MLX4_EN_WOL_MAGIC
expr_stmt|;
block|}
else|else
block|{
name|config
operator|&=
operator|~
operator|(
name|MLX4_EN_WOL_ENABLED
operator||
name|MLX4_EN_WOL_MAGIC
operator|)
expr_stmt|;
name|config
operator||=
name|MLX4_EN_WOL_DO_MODIFY
expr_stmt|;
block|}
name|err
operator|=
name|mlx4_wol_write
argument_list|(
name|priv
operator|->
name|mdev
operator|->
name|dev
argument_list|,
name|config
argument_list|,
name|priv
operator|->
name|port
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed to set WoL information\n"
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_struct
struct|struct
name|bitmap_sim_iterator
block|{
name|bool
name|advance_array
decl_stmt|;
name|unsigned
name|long
modifier|*
name|stats_bitmap
decl_stmt|;
name|unsigned
name|int
name|count
decl_stmt|;
name|unsigned
name|int
name|j
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
specifier|inline
name|void
name|bitmap_sim_iterator_init
parameter_list|(
name|struct
name|bitmap_sim_iterator
modifier|*
name|h
parameter_list|,
name|unsigned
name|long
modifier|*
name|stats_bitmap
parameter_list|,
name|int
name|count
parameter_list|)
block|{
name|h
operator|->
name|j
operator|=
literal|0
expr_stmt|;
name|h
operator|->
name|advance_array
operator|=
operator|!
name|bitmap_empty
argument_list|(
name|stats_bitmap
argument_list|,
name|count
argument_list|)
expr_stmt|;
name|h
operator|->
name|count
operator|=
name|h
operator|->
name|advance_array
condition|?
name|bitmap_weight
argument_list|(
name|stats_bitmap
argument_list|,
name|count
argument_list|)
else|:
name|count
expr_stmt|;
name|h
operator|->
name|stats_bitmap
operator|=
name|stats_bitmap
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|int
name|bitmap_sim_iterator_test
parameter_list|(
name|struct
name|bitmap_sim_iterator
modifier|*
name|h
parameter_list|)
block|{
return|return
operator|!
name|h
operator|->
name|advance_array
condition|?
literal|1
else|:
name|test_bit
argument_list|(
name|h
operator|->
name|j
argument_list|,
name|h
operator|->
name|stats_bitmap
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|int
name|bitmap_sim_iterator_inc
parameter_list|(
name|struct
name|bitmap_sim_iterator
modifier|*
name|h
parameter_list|)
block|{
return|return
name|h
operator|->
name|j
operator|++
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|unsigned
name|int
name|bitmap_sim_iterator_count
parameter_list|(
name|struct
name|bitmap_sim_iterator
modifier|*
name|h
parameter_list|)
block|{
return|return
name|h
operator|->
name|count
return|;
block|}
end_function

begin_function
name|int
name|mlx4_en_get_sset_count
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|,
name|int
name|sset
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|bitmap_sim_iterator
name|it
decl_stmt|;
name|int
name|num_of_stats
init|=
name|NUM_ALL_STATS
operator|-
operator|(
operator|(
name|priv
operator|->
name|mdev
operator|->
name|dev
operator|->
name|caps
operator|.
name|flags2
operator|&
name|MLX4_DEV_CAP_FLAG2_FLOWSTATS_EN
operator|)
condition|?
literal|0
else|:
name|NUM_FLOW_STATS
operator|)
decl_stmt|;
name|bitmap_sim_iterator_init
argument_list|(
operator|&
name|it
argument_list|,
name|priv
operator|->
name|stats_bitmap
argument_list|,
name|num_of_stats
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|sset
condition|)
block|{
case|case
name|ETH_SS_STATS
case|:
return|return
name|bitmap_sim_iterator_count
argument_list|(
operator|&
name|it
argument_list|)
operator|+
operator|(
name|priv
operator|->
name|tx_ring_num
operator|*
literal|2
operator|)
operator|+
ifdef|#
directive|ifdef
name|LL_EXTENDED_STATS
operator|(
name|priv
operator|->
name|rx_ring_num
operator|*
literal|5
operator|)
return|;
else|#
directive|else
operator|(
name|priv
operator|->
name|rx_ring_num
operator|*
literal|2
operator|)
expr_stmt|;
endif|#
directive|endif
case|case
name|ETH_SS_TEST
case|:
return|return
name|MLX4_EN_NUM_SELF_TEST
operator|-
operator|!
operator|(
name|priv
operator|->
name|mdev
operator|->
name|dev
operator|->
name|caps
operator|.
name|flags
operator|&
name|MLX4_DEV_CAP_FLAG_UC_LOOPBACK
operator|)
operator|*
literal|2
return|;
default|default:
return|return
operator|-
name|EOPNOTSUPP
return|;
block|}
block|}
end_function

begin_function
name|void
name|mlx4_en_get_ethtool_stats
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|,
name|struct
name|ethtool_stats
modifier|*
name|stats
parameter_list|,
name|u64
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|index
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
name|struct
name|bitmap_sim_iterator
name|it
decl_stmt|;
name|int
name|num_of_stats
init|=
name|NUM_ALL_STATS
operator|-
operator|(
operator|(
name|priv
operator|->
name|mdev
operator|->
name|dev
operator|->
name|caps
operator|.
name|flags2
operator|&
name|MLX4_DEV_CAP_FLAG2_FLOWSTATS_EN
operator|)
condition|?
literal|0
else|:
name|NUM_FLOW_STATS
operator|)
decl_stmt|;
name|bitmap_sim_iterator_init
argument_list|(
operator|&
name|it
argument_list|,
name|priv
operator|->
name|stats_bitmap
argument_list|,
name|num_of_stats
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|data
operator|||
operator|!
name|priv
operator|->
name|port_up
condition|)
return|return;
name|spin_lock_bh
argument_list|(
operator|&
name|priv
operator|->
name|stats_lock
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_PKT_STATS
condition|;
name|i
operator|++
operator|,
name|bitmap_sim_iterator_inc
argument_list|(
operator|&
name|it
argument_list|)
control|)
if|if
condition|(
name|bitmap_sim_iterator_test
argument_list|(
operator|&
name|it
argument_list|)
condition|)
name|data
index|[
name|index
operator|++
index|]
operator|=
operator|(
operator|(
name|unsigned
name|long
operator|*
operator|)
operator|&
name|priv
operator|->
name|pkstats
operator|)
index|[
name|i
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_FLOW_STATS
condition|;
name|i
operator|++
operator|,
name|bitmap_sim_iterator_inc
argument_list|(
operator|&
name|it
argument_list|)
control|)
if|if
condition|(
name|priv
operator|->
name|mdev
operator|->
name|dev
operator|->
name|caps
operator|.
name|flags2
operator|&
name|MLX4_DEV_CAP_FLAG2_FLOWSTATS_EN
condition|)
if|if
condition|(
name|bitmap_sim_iterator_test
argument_list|(
operator|&
name|it
argument_list|)
condition|)
name|data
index|[
name|index
operator|++
index|]
operator|=
operator|(
operator|(
name|u64
operator|*
operator|)
operator|&
name|priv
operator|->
name|flowstats
operator|)
index|[
name|i
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_VF_STATS
condition|;
name|i
operator|++
operator|,
name|bitmap_sim_iterator_inc
argument_list|(
operator|&
name|it
argument_list|)
control|)
if|if
condition|(
name|bitmap_sim_iterator_test
argument_list|(
operator|&
name|it
argument_list|)
condition|)
name|data
index|[
name|index
operator|++
index|]
operator|=
operator|(
operator|(
name|unsigned
name|long
operator|*
operator|)
operator|&
name|priv
operator|->
name|vf_stats
operator|)
index|[
name|i
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_VPORT_STATS
condition|;
name|i
operator|++
operator|,
name|bitmap_sim_iterator_inc
argument_list|(
operator|&
name|it
argument_list|)
control|)
if|if
condition|(
name|bitmap_sim_iterator_test
argument_list|(
operator|&
name|it
argument_list|)
condition|)
name|data
index|[
name|index
operator|++
index|]
operator|=
operator|(
operator|(
name|unsigned
name|long
operator|*
operator|)
operator|&
name|priv
operator|->
name|vport_stats
operator|)
index|[
name|i
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_PORT_STATS
condition|;
name|i
operator|++
operator|,
name|bitmap_sim_iterator_inc
argument_list|(
operator|&
name|it
argument_list|)
control|)
if|if
condition|(
name|bitmap_sim_iterator_test
argument_list|(
operator|&
name|it
argument_list|)
condition|)
name|data
index|[
name|index
operator|++
index|]
operator|=
operator|(
operator|(
name|unsigned
name|long
operator|*
operator|)
operator|&
name|priv
operator|->
name|port_stats
operator|)
index|[
name|i
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|tx_ring_num
condition|;
name|i
operator|++
control|)
block|{
name|data
index|[
name|index
operator|++
index|]
operator|=
name|priv
operator|->
name|tx_ring
index|[
name|i
index|]
operator|->
name|packets
expr_stmt|;
name|data
index|[
name|index
operator|++
index|]
operator|=
name|priv
operator|->
name|tx_ring
index|[
name|i
index|]
operator|->
name|bytes
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|rx_ring_num
condition|;
name|i
operator|++
control|)
block|{
name|data
index|[
name|index
operator|++
index|]
operator|=
name|priv
operator|->
name|rx_ring
index|[
name|i
index|]
operator|->
name|packets
expr_stmt|;
name|data
index|[
name|index
operator|++
index|]
operator|=
name|priv
operator|->
name|rx_ring
index|[
name|i
index|]
operator|->
name|bytes
expr_stmt|;
ifdef|#
directive|ifdef
name|LL_EXTENDED_STATS
name|data
index|[
name|index
operator|++
index|]
operator|=
name|priv
operator|->
name|rx_ring
index|[
name|i
index|]
operator|->
name|yields
expr_stmt|;
name|data
index|[
name|index
operator|++
index|]
operator|=
name|priv
operator|->
name|rx_ring
index|[
name|i
index|]
operator|->
name|misses
expr_stmt|;
name|data
index|[
name|index
operator|++
index|]
operator|=
name|priv
operator|->
name|rx_ring
index|[
name|i
index|]
operator|->
name|cleaned
expr_stmt|;
endif|#
directive|endif
block|}
name|spin_unlock_bh
argument_list|(
operator|&
name|priv
operator|->
name|stats_lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|mlx4_en_restore_ethtool_stats
parameter_list|(
name|struct
name|mlx4_en_priv
modifier|*
name|priv
parameter_list|,
name|u64
modifier|*
name|data
parameter_list|)
block|{
name|int
name|index
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
name|struct
name|bitmap_sim_iterator
name|it
decl_stmt|;
name|int
name|num_of_stats
init|=
name|NUM_ALL_STATS
operator|-
operator|(
operator|(
name|priv
operator|->
name|mdev
operator|->
name|dev
operator|->
name|caps
operator|.
name|flags2
operator|&
name|MLX4_DEV_CAP_FLAG2_FLOWSTATS_EN
operator|)
condition|?
literal|0
else|:
name|NUM_FLOW_STATS
operator|)
decl_stmt|;
name|bitmap_sim_iterator_init
argument_list|(
operator|&
name|it
argument_list|,
name|priv
operator|->
name|stats_bitmap
argument_list|,
name|num_of_stats
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|data
operator|||
operator|!
name|priv
operator|->
name|port_up
condition|)
return|return;
name|spin_lock_bh
argument_list|(
operator|&
name|priv
operator|->
name|stats_lock
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_PKT_STATS
condition|;
name|i
operator|++
operator|,
name|bitmap_sim_iterator_inc
argument_list|(
operator|&
name|it
argument_list|)
control|)
if|if
condition|(
name|bitmap_sim_iterator_test
argument_list|(
operator|&
name|it
argument_list|)
condition|)
operator|(
operator|(
name|unsigned
name|long
operator|*
operator|)
operator|&
name|priv
operator|->
name|pkstats
operator|)
index|[
name|i
index|]
operator|=
name|data
index|[
name|index
operator|++
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_FLOW_STATS
condition|;
name|i
operator|++
operator|,
name|bitmap_sim_iterator_inc
argument_list|(
operator|&
name|it
argument_list|)
control|)
if|if
condition|(
name|priv
operator|->
name|mdev
operator|->
name|dev
operator|->
name|caps
operator|.
name|flags2
operator|&
name|MLX4_DEV_CAP_FLAG2_FLOWSTATS_EN
condition|)
if|if
condition|(
name|bitmap_sim_iterator_test
argument_list|(
operator|&
name|it
argument_list|)
condition|)
operator|(
operator|(
name|u64
operator|*
operator|)
operator|&
name|priv
operator|->
name|flowstats
operator|)
index|[
name|i
index|]
operator|=
name|data
index|[
name|index
operator|++
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_VF_STATS
condition|;
name|i
operator|++
operator|,
name|bitmap_sim_iterator_inc
argument_list|(
operator|&
name|it
argument_list|)
control|)
if|if
condition|(
name|bitmap_sim_iterator_test
argument_list|(
operator|&
name|it
argument_list|)
condition|)
operator|(
operator|(
name|unsigned
name|long
operator|*
operator|)
operator|&
name|priv
operator|->
name|vf_stats
operator|)
index|[
name|i
index|]
operator|=
name|data
index|[
name|index
operator|++
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_VPORT_STATS
condition|;
name|i
operator|++
operator|,
name|bitmap_sim_iterator_inc
argument_list|(
operator|&
name|it
argument_list|)
control|)
if|if
condition|(
name|bitmap_sim_iterator_test
argument_list|(
operator|&
name|it
argument_list|)
condition|)
operator|(
operator|(
name|unsigned
name|long
operator|*
operator|)
operator|&
name|priv
operator|->
name|vport_stats
operator|)
index|[
name|i
index|]
operator|=
name|data
index|[
name|index
operator|++
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_PORT_STATS
condition|;
name|i
operator|++
operator|,
name|bitmap_sim_iterator_inc
argument_list|(
operator|&
name|it
argument_list|)
control|)
if|if
condition|(
name|bitmap_sim_iterator_test
argument_list|(
operator|&
name|it
argument_list|)
condition|)
operator|(
operator|(
name|unsigned
name|long
operator|*
operator|)
operator|&
name|priv
operator|->
name|port_stats
operator|)
index|[
name|i
index|]
operator|=
name|data
index|[
name|index
operator|++
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|tx_ring_num
condition|;
name|i
operator|++
control|)
block|{
name|priv
operator|->
name|tx_ring
index|[
name|i
index|]
operator|->
name|packets
operator|=
name|data
index|[
name|index
operator|++
index|]
expr_stmt|;
name|priv
operator|->
name|tx_ring
index|[
name|i
index|]
operator|->
name|bytes
operator|=
name|data
index|[
name|index
operator|++
index|]
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|rx_ring_num
condition|;
name|i
operator|++
control|)
block|{
name|priv
operator|->
name|rx_ring
index|[
name|i
index|]
operator|->
name|packets
operator|=
name|data
index|[
name|index
operator|++
index|]
expr_stmt|;
name|priv
operator|->
name|rx_ring
index|[
name|i
index|]
operator|->
name|bytes
operator|=
name|data
index|[
name|index
operator|++
index|]
expr_stmt|;
block|}
name|spin_unlock_bh
argument_list|(
operator|&
name|priv
operator|->
name|stats_lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_en_self_test
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|,
name|struct
name|ethtool_test
modifier|*
name|etest
parameter_list|,
name|u64
modifier|*
name|buf
parameter_list|)
block|{
name|mlx4_en_ex_selftest
argument_list|(
name|dev
argument_list|,
operator|&
name|etest
operator|->
name|flags
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_en_get_strings
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|,
name|uint32_t
name|stringset
parameter_list|,
name|uint8_t
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|index
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|,
name|k
decl_stmt|;
name|struct
name|bitmap_sim_iterator
name|it
decl_stmt|;
name|int
name|num_of_stats
init|=
name|NUM_ALL_STATS
operator|-
operator|(
operator|(
name|priv
operator|->
name|mdev
operator|->
name|dev
operator|->
name|caps
operator|.
name|flags2
operator|&
name|MLX4_DEV_CAP_FLAG2_FLOWSTATS_EN
operator|)
condition|?
literal|0
else|:
name|NUM_FLOW_STATS
operator|)
decl_stmt|;
name|bitmap_sim_iterator_init
argument_list|(
operator|&
name|it
argument_list|,
name|priv
operator|->
name|stats_bitmap
argument_list|,
name|num_of_stats
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|stringset
condition|)
block|{
case|case
name|ETH_SS_TEST
case|:
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MLX4_EN_NUM_SELF_TEST
operator|-
literal|2
condition|;
name|i
operator|++
control|)
name|strcpy
argument_list|(
name|data
operator|+
name|i
operator|*
name|ETH_GSTRING_LEN
argument_list|,
name|mlx4_en_test_names
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|mdev
operator|->
name|dev
operator|->
name|caps
operator|.
name|flags
operator|&
name|MLX4_DEV_CAP_FLAG_UC_LOOPBACK
condition|)
for|for
control|(
init|;
name|i
operator|<
name|MLX4_EN_NUM_SELF_TEST
condition|;
name|i
operator|++
control|)
name|strcpy
argument_list|(
name|data
operator|+
name|i
operator|*
name|ETH_GSTRING_LEN
argument_list|,
name|mlx4_en_test_names
index|[
name|i
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|ETH_SS_STATS
case|:
comment|/* Add main counters */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_PKT_STATS
condition|;
name|i
operator|++
operator|,
name|bitmap_sim_iterator_inc
argument_list|(
operator|&
name|it
argument_list|)
control|)
if|if
condition|(
name|bitmap_sim_iterator_test
argument_list|(
operator|&
name|it
argument_list|)
condition|)
name|strcpy
argument_list|(
name|data
operator|+
operator|(
name|index
operator|++
operator|)
operator|*
name|ETH_GSTRING_LEN
argument_list|,
name|main_strings
index|[
name|i
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
name|NUM_FLOW_STATS
condition|;
name|k
operator|++
operator|,
name|bitmap_sim_iterator_inc
argument_list|(
operator|&
name|it
argument_list|)
control|)
if|if
condition|(
name|priv
operator|->
name|mdev
operator|->
name|dev
operator|->
name|caps
operator|.
name|flags2
operator|&
name|MLX4_DEV_CAP_FLAG2_FLOWSTATS_EN
condition|)
if|if
condition|(
name|bitmap_sim_iterator_test
argument_list|(
operator|&
name|it
argument_list|)
condition|)
name|strcpy
argument_list|(
name|data
operator|+
operator|(
name|index
operator|++
operator|)
operator|*
name|ETH_GSTRING_LEN
argument_list|,
name|main_strings
index|[
name|i
operator|+
name|k
index|]
argument_list|)
expr_stmt|;
for|for
control|(
init|;
operator|(
name|i
operator|+
name|k
operator|)
operator|<
name|num_of_stats
condition|;
name|i
operator|++
operator|,
name|bitmap_sim_iterator_inc
argument_list|(
operator|&
name|it
argument_list|)
control|)
if|if
condition|(
name|bitmap_sim_iterator_test
argument_list|(
operator|&
name|it
argument_list|)
condition|)
name|strcpy
argument_list|(
name|data
operator|+
operator|(
name|index
operator|++
operator|)
operator|*
name|ETH_GSTRING_LEN
argument_list|,
name|main_strings
index|[
name|i
operator|+
name|k
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|tx_ring_num
condition|;
name|i
operator|++
control|)
block|{
name|sprintf
argument_list|(
name|data
operator|+
operator|(
name|index
operator|++
operator|)
operator|*
name|ETH_GSTRING_LEN
argument_list|,
literal|"tx%d_packets"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|data
operator|+
operator|(
name|index
operator|++
operator|)
operator|*
name|ETH_GSTRING_LEN
argument_list|,
literal|"tx%d_bytes"
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|rx_ring_num
condition|;
name|i
operator|++
control|)
block|{
name|sprintf
argument_list|(
name|data
operator|+
operator|(
name|index
operator|++
operator|)
operator|*
name|ETH_GSTRING_LEN
argument_list|,
literal|"rx%d_packets"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|data
operator|+
operator|(
name|index
operator|++
operator|)
operator|*
name|ETH_GSTRING_LEN
argument_list|,
literal|"rx%d_bytes"
argument_list|,
name|i
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|LL_EXTENDED_STATS
name|sprintf
argument_list|(
name|data
operator|+
operator|(
name|index
operator|++
operator|)
operator|*
name|ETH_GSTRING_LEN
argument_list|,
literal|"rx%d_napi_yield"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|data
operator|+
operator|(
name|index
operator|++
operator|)
operator|*
name|ETH_GSTRING_LEN
argument_list|,
literal|"rx%d_misses"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|data
operator|+
operator|(
name|index
operator|++
operator|)
operator|*
name|ETH_GSTRING_LEN
argument_list|,
literal|"rx%d_cleaned"
argument_list|,
name|i
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|u32
name|mlx4_en_autoneg_get
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|mlx4_en_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|u32
name|autoneg
init|=
name|AUTONEG_DISABLE
decl_stmt|;
if|if
condition|(
operator|(
name|mdev
operator|->
name|dev
operator|->
name|caps
operator|.
name|flags2
operator|&
name|MLX4_DEV_CAP_FLAG2_ETH_BACKPL_AN_REP
operator|)
operator|&&
name|priv
operator|->
name|port_state
operator|.
name|autoneg
condition|)
block|{
name|autoneg
operator|=
name|AUTONEG_ENABLE
expr_stmt|;
block|}
return|return
name|autoneg
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_en_get_settings
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|,
name|struct
name|ethtool_cmd
modifier|*
name|cmd
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|trans_type
decl_stmt|;
comment|/* SUPPORTED_1000baseT_Half isn't supported */
name|cmd
operator|->
name|supported
operator|=
name|SUPPORTED_1000baseT_Full
operator||
name|SUPPORTED_10000baseT_Full
expr_stmt|;
name|cmd
operator|->
name|advertising
operator|=
name|ADVERTISED_1000baseT_Full
operator||
name|ADVERTISED_10000baseT_Full
expr_stmt|;
name|cmd
operator|->
name|supported
operator||=
name|SUPPORTED_1000baseKX_Full
operator||
name|SUPPORTED_10000baseKX4_Full
operator||
name|SUPPORTED_10000baseKR_Full
operator||
name|SUPPORTED_10000baseR_FEC
operator||
name|SUPPORTED_40000baseKR4_Full
operator||
name|SUPPORTED_40000baseCR4_Full
operator||
name|SUPPORTED_40000baseSR4_Full
operator||
name|SUPPORTED_40000baseLR4_Full
expr_stmt|;
comment|/* ADVERTISED_1000baseT_Half isn't advertised */
name|cmd
operator|->
name|advertising
operator||=
name|ADVERTISED_1000baseKX_Full
operator||
name|ADVERTISED_10000baseKX4_Full
operator||
name|ADVERTISED_10000baseKR_Full
operator||
name|ADVERTISED_10000baseR_FEC
operator||
name|ADVERTISED_40000baseKR4_Full
operator||
name|ADVERTISED_40000baseCR4_Full
operator||
name|ADVERTISED_40000baseSR4_Full
operator||
name|ADVERTISED_40000baseLR4_Full
expr_stmt|;
if|if
condition|(
name|mlx4_en_QUERY_PORT
argument_list|(
name|priv
operator|->
name|mdev
argument_list|,
name|priv
operator|->
name|port
argument_list|)
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|cmd
operator|->
name|autoneg
operator|=
name|mlx4_en_autoneg_get
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd
operator|->
name|autoneg
operator|==
name|AUTONEG_ENABLE
condition|)
block|{
name|cmd
operator|->
name|supported
operator||=
name|SUPPORTED_Autoneg
expr_stmt|;
name|cmd
operator|->
name|advertising
operator||=
name|ADVERTISED_Autoneg
expr_stmt|;
block|}
name|trans_type
operator|=
name|priv
operator|->
name|port_state
operator|.
name|transciver
expr_stmt|;
if|if
condition|(
name|netif_carrier_ok
argument_list|(
name|dev
argument_list|)
condition|)
block|{
name|ethtool_cmd_speed_set
argument_list|(
name|cmd
argument_list|,
name|priv
operator|->
name|port_state
operator|.
name|link_speed
argument_list|)
expr_stmt|;
name|cmd
operator|->
name|duplex
operator|=
name|DUPLEX_FULL
expr_stmt|;
block|}
else|else
block|{
name|ethtool_cmd_speed_set
argument_list|(
name|cmd
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|cmd
operator|->
name|duplex
operator|=
operator|-
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|trans_type
operator|>
literal|0
operator|&&
name|trans_type
operator|<=
literal|0xC
condition|)
block|{
name|cmd
operator|->
name|port
operator|=
name|PORT_FIBRE
expr_stmt|;
name|cmd
operator|->
name|transceiver
operator|=
name|XCVR_EXTERNAL
expr_stmt|;
name|cmd
operator|->
name|supported
operator||=
name|SUPPORTED_FIBRE
expr_stmt|;
name|cmd
operator|->
name|advertising
operator||=
name|ADVERTISED_FIBRE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|trans_type
operator|==
literal|0x80
operator|||
name|trans_type
operator|==
literal|0
condition|)
block|{
name|cmd
operator|->
name|port
operator|=
name|PORT_TP
expr_stmt|;
name|cmd
operator|->
name|transceiver
operator|=
name|XCVR_INTERNAL
expr_stmt|;
name|cmd
operator|->
name|supported
operator||=
name|SUPPORTED_TP
expr_stmt|;
name|cmd
operator|->
name|advertising
operator||=
name|ADVERTISED_TP
expr_stmt|;
block|}
else|else
block|{
name|cmd
operator|->
name|port
operator|=
operator|-
literal|1
expr_stmt|;
name|cmd
operator|->
name|transceiver
operator|=
operator|-
literal|1
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|mlx4_en_duplex_to_string
parameter_list|(
name|int
name|duplex
parameter_list|)
block|{
switch|switch
condition|(
name|duplex
condition|)
block|{
case|case
name|DUPLEX_FULL
case|:
return|return
literal|"FULL"
return|;
case|case
name|DUPLEX_HALF
case|:
return|return
literal|"HALF"
return|;
default|default:
break|break;
block|}
return|return
literal|"UNKNOWN"
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_en_set_settings
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|,
name|struct
name|ethtool_cmd
modifier|*
name|cmd
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|mlx4_en_port_state
modifier|*
name|port_state
init|=
operator|&
name|priv
operator|->
name|port_state
decl_stmt|;
if|if
condition|(
operator|(
name|cmd
operator|->
name|autoneg
operator|!=
name|port_state
operator|->
name|autoneg
operator|)
operator|||
operator|(
name|ethtool_cmd_speed
argument_list|(
name|cmd
argument_list|)
operator|!=
name|port_state
operator|->
name|link_speed
operator|)
operator|||
operator|(
name|cmd
operator|->
name|duplex
operator|!=
name|DUPLEX_FULL
operator|)
condition|)
block|{
name|en_info
argument_list|(
name|priv
argument_list|,
literal|"Changing port state properties (auto-negotiation"
literal|" , speed/duplex) is not supported. Current:"
literal|" auto-negotiation=%d speed/duplex=%d/%s\n"
argument_list|,
name|port_state
operator|->
name|autoneg
argument_list|,
name|port_state
operator|->
name|link_speed
argument_list|,
name|mlx4_en_duplex_to_string
argument_list|(
name|DUPLEX_FULL
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EOPNOTSUPP
return|;
block|}
comment|/* User provided same port state properties that are currently set. 	 * Nothing to change 	 */
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_en_get_coalesce
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|,
name|struct
name|ethtool_coalesce
modifier|*
name|coal
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|coal
operator|->
name|tx_coalesce_usecs
operator|=
name|priv
operator|->
name|tx_usecs
expr_stmt|;
name|coal
operator|->
name|tx_max_coalesced_frames
operator|=
name|priv
operator|->
name|tx_frames
expr_stmt|;
name|coal
operator|->
name|rx_coalesce_usecs
operator|=
name|priv
operator|->
name|rx_usecs
expr_stmt|;
name|coal
operator|->
name|rx_max_coalesced_frames
operator|=
name|priv
operator|->
name|rx_frames
expr_stmt|;
name|coal
operator|->
name|pkt_rate_low
operator|=
name|priv
operator|->
name|pkt_rate_low
expr_stmt|;
name|coal
operator|->
name|rx_coalesce_usecs_low
operator|=
name|priv
operator|->
name|rx_usecs_low
expr_stmt|;
name|coal
operator|->
name|pkt_rate_high
operator|=
name|priv
operator|->
name|pkt_rate_high
expr_stmt|;
name|coal
operator|->
name|rx_coalesce_usecs_high
operator|=
name|priv
operator|->
name|rx_usecs_high
expr_stmt|;
name|coal
operator|->
name|rate_sample_interval
operator|=
name|priv
operator|->
name|sample_interval
expr_stmt|;
name|coal
operator|->
name|use_adaptive_rx_coalesce
operator|=
name|priv
operator|->
name|adaptive_rx_coal
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_en_set_coalesce
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|,
name|struct
name|ethtool_coalesce
modifier|*
name|coal
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|err
decl_stmt|,
name|i
decl_stmt|;
name|priv
operator|->
name|rx_frames
operator|=
operator|(
name|coal
operator|->
name|rx_max_coalesced_frames
operator|==
name|MLX4_EN_AUTO_CONF
operator|)
condition|?
name|MLX4_EN_RX_COAL_TARGET
operator|/
name|priv
operator|->
name|dev
operator|->
name|mtu
operator|+
literal|1
else|:
name|coal
operator|->
name|rx_max_coalesced_frames
expr_stmt|;
name|priv
operator|->
name|rx_usecs
operator|=
operator|(
name|coal
operator|->
name|rx_coalesce_usecs
operator|==
name|MLX4_EN_AUTO_CONF
operator|)
condition|?
name|MLX4_EN_RX_COAL_TIME
else|:
name|coal
operator|->
name|rx_coalesce_usecs
expr_stmt|;
comment|/* Setting TX coalescing parameters */
if|if
condition|(
name|coal
operator|->
name|tx_coalesce_usecs
operator|!=
name|priv
operator|->
name|tx_usecs
operator|||
name|coal
operator|->
name|tx_max_coalesced_frames
operator|!=
name|priv
operator|->
name|tx_frames
condition|)
block|{
name|priv
operator|->
name|tx_usecs
operator|=
name|coal
operator|->
name|tx_coalesce_usecs
expr_stmt|;
name|priv
operator|->
name|tx_frames
operator|=
name|coal
operator|->
name|tx_max_coalesced_frames
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|port_up
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|tx_ring_num
condition|;
name|i
operator|++
control|)
block|{
name|priv
operator|->
name|tx_cq
index|[
name|i
index|]
operator|->
name|moder_cnt
operator|=
name|priv
operator|->
name|tx_frames
expr_stmt|;
name|priv
operator|->
name|tx_cq
index|[
name|i
index|]
operator|->
name|moder_time
operator|=
name|priv
operator|->
name|tx_usecs
expr_stmt|;
if|if
condition|(
name|mlx4_en_set_cq_moder
argument_list|(
name|priv
argument_list|,
name|priv
operator|->
name|tx_cq
index|[
name|i
index|]
argument_list|)
condition|)
name|en_warn
argument_list|(
name|priv
argument_list|,
literal|"Failed changing moderation for TX cq %d\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/* Set adaptive coalescing params */
name|priv
operator|->
name|pkt_rate_low
operator|=
name|coal
operator|->
name|pkt_rate_low
expr_stmt|;
name|priv
operator|->
name|rx_usecs_low
operator|=
name|coal
operator|->
name|rx_coalesce_usecs_low
expr_stmt|;
name|priv
operator|->
name|pkt_rate_high
operator|=
name|coal
operator|->
name|pkt_rate_high
expr_stmt|;
name|priv
operator|->
name|rx_usecs_high
operator|=
name|coal
operator|->
name|rx_coalesce_usecs_high
expr_stmt|;
name|priv
operator|->
name|sample_interval
operator|=
name|coal
operator|->
name|rate_sample_interval
expr_stmt|;
name|priv
operator|->
name|adaptive_rx_coal
operator|=
name|coal
operator|->
name|use_adaptive_rx_coalesce
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|adaptive_rx_coal
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|priv
operator|->
name|port_up
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|rx_ring_num
condition|;
name|i
operator|++
control|)
block|{
name|priv
operator|->
name|rx_cq
index|[
name|i
index|]
operator|->
name|moder_cnt
operator|=
name|priv
operator|->
name|rx_frames
expr_stmt|;
name|priv
operator|->
name|rx_cq
index|[
name|i
index|]
operator|->
name|moder_time
operator|=
name|priv
operator|->
name|rx_usecs
expr_stmt|;
name|priv
operator|->
name|last_moder_time
index|[
name|i
index|]
operator|=
name|MLX4_EN_AUTO_CONF
expr_stmt|;
name|err
operator|=
name|mlx4_en_set_cq_moder
argument_list|(
name|priv
argument_list|,
name|priv
operator|->
name|rx_cq
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_en_set_pauseparam
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|,
name|struct
name|ethtool_pauseparam
modifier|*
name|pause
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|mlx4_en_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|int
name|err
decl_stmt|;
if|if
condition|(
name|pause
operator|->
name|autoneg
condition|)
return|return
operator|-
name|EOPNOTSUPP
return|;
name|priv
operator|->
name|prof
operator|->
name|tx_pause
operator|=
name|pause
operator|->
name|tx_pause
operator|!=
literal|0
expr_stmt|;
name|priv
operator|->
name|prof
operator|->
name|rx_pause
operator|=
name|pause
operator|->
name|rx_pause
operator|!=
literal|0
expr_stmt|;
name|err
operator|=
name|mlx4_SET_PORT_general
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|,
name|priv
operator|->
name|rx_skb_size
operator|+
name|ETH_FCS_LEN
argument_list|,
name|priv
operator|->
name|prof
operator|->
name|tx_pause
argument_list|,
name|priv
operator|->
name|prof
operator|->
name|tx_ppp
argument_list|,
name|priv
operator|->
name|prof
operator|->
name|rx_pause
argument_list|,
name|priv
operator|->
name|prof
operator|->
name|rx_ppp
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed setting pause params\n"
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_en_get_pauseparam
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|,
name|struct
name|ethtool_pauseparam
modifier|*
name|pause
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|pause
operator|->
name|tx_pause
operator|=
name|priv
operator|->
name|prof
operator|->
name|tx_pause
expr_stmt|;
name|pause
operator|->
name|rx_pause
operator|=
name|priv
operator|->
name|prof
operator|->
name|rx_pause
expr_stmt|;
name|pause
operator|->
name|autoneg
operator|=
name|mlx4_en_autoneg_get
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* rtnl lock must be taken before calling */
end_comment

begin_function
name|int
name|mlx4_en_pre_config
parameter_list|(
name|struct
name|mlx4_en_priv
modifier|*
name|priv
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|CONFIG_RFS_ACCEL
name|struct
name|cpu_rmap
modifier|*
name|rmap
decl_stmt|;
if|if
condition|(
operator|!
name|priv
operator|->
name|dev
operator|->
name|rx_cpu_rmap
condition|)
return|return
literal|0
return|;
comment|/* Disable RFS events 	 * Must have all RFS jobs flushed before freeing resources 	 */
name|rmap
operator|=
name|priv
operator|->
name|dev
operator|->
name|rx_cpu_rmap
expr_stmt|;
name|priv
operator|->
name|dev
operator|->
name|rx_cpu_rmap
operator|=
name|NULL
expr_stmt|;
name|rtnl_unlock
argument_list|()
expr_stmt|;
name|free_irq_cpu_rmap
argument_list|(
name|rmap
argument_list|)
expr_stmt|;
name|rtnl_lock
argument_list|()
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|dev
operator|->
name|rx_cpu_rmap
condition|)
return|return
operator|-
name|EBUSY
return|;
comment|/* another configuration completed while lock 				* was free 				*/
comment|/* Make sure all currently running filter_work are being processed 	 * Other work will return immediatly because of disable_rfs 	 */
name|flush_workqueue
argument_list|(
name|priv
operator|->
name|mdev
operator|->
name|workqueue
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_en_set_ringparam
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|,
name|struct
name|ethtool_ringparam
modifier|*
name|param
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|mlx4_en_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|u32
name|rx_size
decl_stmt|,
name|tx_size
decl_stmt|;
name|int
name|port_up
init|=
literal|0
decl_stmt|;
name|int
name|err
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|,
name|n_stats
decl_stmt|;
name|u64
modifier|*
name|data
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|!
name|priv
operator|->
name|port_up
condition|)
return|return
operator|-
name|ENOMEM
return|;
if|if
condition|(
name|param
operator|->
name|rx_jumbo_pending
operator|||
name|param
operator|->
name|rx_mini_pending
condition|)
return|return
operator|-
name|EINVAL
return|;
name|rx_size
operator|=
name|roundup_pow_of_two
argument_list|(
name|param
operator|->
name|rx_pending
argument_list|)
expr_stmt|;
name|rx_size
operator|=
name|max_t
argument_list|(
name|u32
argument_list|,
name|rx_size
argument_list|,
name|MLX4_EN_MIN_RX_SIZE
argument_list|)
expr_stmt|;
name|rx_size
operator|=
name|min_t
argument_list|(
name|u32
argument_list|,
name|rx_size
argument_list|,
name|MLX4_EN_MAX_RX_SIZE
argument_list|)
expr_stmt|;
name|tx_size
operator|=
name|roundup_pow_of_two
argument_list|(
name|param
operator|->
name|tx_pending
argument_list|)
expr_stmt|;
name|tx_size
operator|=
name|max_t
argument_list|(
name|u32
argument_list|,
name|tx_size
argument_list|,
name|MLX4_EN_MIN_TX_SIZE
argument_list|)
expr_stmt|;
name|tx_size
operator|=
name|min_t
argument_list|(
name|u32
argument_list|,
name|tx_size
argument_list|,
name|MLX4_EN_MAX_TX_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|rx_size
operator|==
operator|(
name|priv
operator|->
name|port_up
condition|?
name|priv
operator|->
name|rx_ring
index|[
literal|0
index|]
operator|->
name|actual_size
else|:
name|priv
operator|->
name|rx_ring
index|[
literal|0
index|]
operator|->
name|size
operator|)
operator|&&
name|tx_size
operator|==
name|priv
operator|->
name|tx_ring
index|[
literal|0
index|]
operator|->
name|size
condition|)
return|return
literal|0
return|;
name|err
operator|=
name|mlx4_en_pre_config
argument_list|(
name|priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
name|mutex_lock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|port_up
condition|)
block|{
name|port_up
operator|=
literal|1
expr_stmt|;
name|mlx4_en_stop_port
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
comment|/* Cache port statistics */
name|n_stats
operator|=
name|mlx4_en_get_sset_count
argument_list|(
name|dev
argument_list|,
name|ETH_SS_STATS
argument_list|)
expr_stmt|;
if|if
condition|(
name|n_stats
operator|>
literal|0
condition|)
block|{
name|data
operator|=
name|kmalloc
argument_list|(
name|n_stats
operator|*
sizeof|sizeof
argument_list|(
name|u64
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
condition|)
name|mlx4_en_get_ethtool_stats
argument_list|(
name|dev
argument_list|,
name|NULL
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
name|mlx4_en_free_resources
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|priv
operator|->
name|prof
operator|->
name|tx_ring_size
operator|=
name|tx_size
expr_stmt|;
name|priv
operator|->
name|prof
operator|->
name|rx_ring_size
operator|=
name|rx_size
expr_stmt|;
name|err
operator|=
name|mlx4_en_alloc_resources
argument_list|(
name|priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed reallocating port resources\n"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* Restore port statistics */
if|if
condition|(
name|n_stats
operator|>
literal|0
operator|&&
name|data
condition|)
name|mlx4_en_restore_ethtool_stats
argument_list|(
name|priv
argument_list|,
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|port_up
condition|)
block|{
name|err
operator|=
name|mlx4_en_start_port
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed starting port\n"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|rx_ring_num
condition|;
name|i
operator|++
control|)
block|{
name|priv
operator|->
name|rx_cq
index|[
name|i
index|]
operator|->
name|moder_cnt
operator|=
name|priv
operator|->
name|rx_frames
expr_stmt|;
name|priv
operator|->
name|rx_cq
index|[
name|i
index|]
operator|->
name|moder_time
operator|=
name|priv
operator|->
name|rx_usecs
expr_stmt|;
name|priv
operator|->
name|last_moder_time
index|[
name|i
index|]
operator|=
name|MLX4_EN_AUTO_CONF
expr_stmt|;
name|err
operator|=
name|mlx4_en_set_cq_moder
argument_list|(
name|priv
argument_list|,
name|priv
operator|->
name|rx_cq
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|out
goto|;
block|}
block|}
name|out
label|:
name|kfree
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|mutex_unlock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_en_get_ringparam
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|,
name|struct
name|ethtool_ringparam
modifier|*
name|param
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|priv
operator|->
name|port_up
condition|)
return|return;
name|memset
argument_list|(
name|param
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|param
argument_list|)
argument_list|)
expr_stmt|;
name|param
operator|->
name|rx_max_pending
operator|=
name|MLX4_EN_MAX_RX_SIZE
expr_stmt|;
name|param
operator|->
name|tx_max_pending
operator|=
name|MLX4_EN_MAX_TX_SIZE
expr_stmt|;
name|param
operator|->
name|rx_pending
operator|=
name|priv
operator|->
name|port_up
condition|?
name|priv
operator|->
name|rx_ring
index|[
literal|0
index|]
operator|->
name|actual_size
else|:
name|priv
operator|->
name|rx_ring
index|[
literal|0
index|]
operator|->
name|size
expr_stmt|;
name|param
operator|->
name|tx_pending
operator|=
name|priv
operator|->
name|tx_ring
index|[
literal|0
index|]
operator|->
name|size
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|u32
name|mlx4_en_get_rxfh_indir_size
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
return|return
name|priv
operator|->
name|rx_ring_num
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_en_get_rxfh_indir
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|,
name|u32
modifier|*
name|ring_index
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|mlx4_en_rss_map
modifier|*
name|rss_map
init|=
operator|&
name|priv
operator|->
name|rss_map
decl_stmt|;
name|int
name|rss_rings
decl_stmt|;
name|size_t
name|n
init|=
name|priv
operator|->
name|rx_ring_num
decl_stmt|;
name|int
name|err
init|=
literal|0
decl_stmt|;
name|rss_rings
operator|=
name|priv
operator|->
name|prof
operator|->
name|rss_rings
condition|?
else|:
name|priv
operator|->
name|rx_ring_num
expr_stmt|;
name|rss_rings
operator|=
literal|1
operator|<<
name|ilog2
argument_list|(
name|rss_rings
argument_list|)
expr_stmt|;
while|while
condition|(
name|n
operator|--
condition|)
block|{
name|ring_index
index|[
name|n
index|]
operator|=
name|rss_map
operator|->
name|qps
index|[
name|n
operator|%
name|rss_rings
index|]
operator|.
name|qpn
operator|-
name|rss_map
operator|->
name|base_qpn
expr_stmt|;
block|}
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_en_set_rxfh_indir
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|,
specifier|const
name|u32
modifier|*
name|ring_index
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|mlx4_en_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|int
name|port_up
init|=
literal|0
decl_stmt|;
name|int
name|err
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|rss_rings
init|=
literal|0
decl_stmt|;
comment|/* Calculate RSS table size and make sure flows are spread evenly 	 * between rings 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|rx_ring_num
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|>
literal|0
operator|&&
operator|!
name|ring_index
index|[
name|i
index|]
operator|&&
operator|!
name|rss_rings
condition|)
name|rss_rings
operator|=
name|i
expr_stmt|;
if|if
condition|(
name|ring_index
index|[
name|i
index|]
operator|!=
operator|(
name|i
operator|%
operator|(
name|rss_rings
condition|?
else|:
name|priv
operator|->
name|rx_ring_num
operator|)
operator|)
condition|)
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
operator|!
name|rss_rings
condition|)
name|rss_rings
operator|=
name|priv
operator|->
name|rx_ring_num
expr_stmt|;
comment|/* RSS table size must be an order of 2 */
if|if
condition|(
operator|!
name|is_power_of_2
argument_list|(
name|rss_rings
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
name|mutex_lock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|port_up
condition|)
block|{
name|port_up
operator|=
literal|1
expr_stmt|;
name|mlx4_en_stop_port
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
name|priv
operator|->
name|prof
operator|->
name|rss_rings
operator|=
name|rss_rings
expr_stmt|;
if|if
condition|(
name|port_up
condition|)
block|{
name|err
operator|=
name|mlx4_en_start_port
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed starting port\n"
argument_list|)
expr_stmt|;
block|}
name|mutex_unlock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_define
define|#
directive|define
name|all_zeros_or_all_ones
parameter_list|(
name|field
parameter_list|)
define|\
value|((field) == 0 || (field) == (__force typeof(field))-1)
end_define

begin_function
specifier|static
name|int
name|mlx4_en_validate_flow
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|,
name|struct
name|mlx4_ethtool_rxnfc
modifier|*
name|cmd
parameter_list|)
block|{
name|struct
name|ethtool_usrip4_spec
modifier|*
name|l3_mask
decl_stmt|;
name|struct
name|ethtool_tcpip4_spec
modifier|*
name|l4_mask
decl_stmt|;
name|struct
name|ethhdr
modifier|*
name|eth_mask
decl_stmt|;
if|if
condition|(
name|cmd
operator|->
name|fs
operator|.
name|location
operator|>=
name|MAX_NUM_OF_FS_RULES
condition|)
return|return
operator|-
name|EINVAL
return|;
if|if
condition|(
name|cmd
operator|->
name|fs
operator|.
name|flow_type
operator|&
name|FLOW_MAC_EXT
condition|)
block|{
comment|/* dest mac mask must be ff:ff:ff:ff:ff:ff */
if|if
condition|(
operator|!
name|is_broadcast_ether_addr
argument_list|(
name|cmd
operator|->
name|fs
operator|.
name|m_ext
operator|.
name|h_dest
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
block|}
switch|switch
condition|(
name|cmd
operator|->
name|fs
operator|.
name|flow_type
operator|&
operator|~
operator|(
name|FLOW_EXT
operator||
name|FLOW_MAC_EXT
operator|)
condition|)
block|{
case|case
name|TCP_V4_FLOW
case|:
case|case
name|UDP_V4_FLOW
case|:
if|if
condition|(
name|cmd
operator|->
name|fs
operator|.
name|m_u
operator|.
name|tcp_ip4_spec
operator|.
name|tos
condition|)
return|return
operator|-
name|EINVAL
return|;
name|l4_mask
operator|=
operator|&
name|cmd
operator|->
name|fs
operator|.
name|m_u
operator|.
name|tcp_ip4_spec
expr_stmt|;
comment|/* don't allow mask which isn't all 0 or 1 */
if|if
condition|(
operator|!
name|all_zeros_or_all_ones
argument_list|(
name|l4_mask
operator|->
name|ip4src
argument_list|)
operator|||
operator|!
name|all_zeros_or_all_ones
argument_list|(
name|l4_mask
operator|->
name|ip4dst
argument_list|)
operator|||
operator|!
name|all_zeros_or_all_ones
argument_list|(
name|l4_mask
operator|->
name|psrc
argument_list|)
operator|||
operator|!
name|all_zeros_or_all_ones
argument_list|(
name|l4_mask
operator|->
name|pdst
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
break|break;
case|case
name|IP_USER_FLOW
case|:
name|l3_mask
operator|=
operator|&
name|cmd
operator|->
name|fs
operator|.
name|m_u
operator|.
name|usr_ip4_spec
expr_stmt|;
if|if
condition|(
name|l3_mask
operator|->
name|l4_4_bytes
operator|||
name|l3_mask
operator|->
name|tos
operator|||
name|l3_mask
operator|->
name|proto
operator|||
name|cmd
operator|->
name|fs
operator|.
name|h_u
operator|.
name|usr_ip4_spec
operator|.
name|ip_ver
operator|!=
name|ETH_RX_NFC_IP4
operator|||
operator|(
operator|!
name|l3_mask
operator|->
name|ip4src
operator|&&
operator|!
name|l3_mask
operator|->
name|ip4dst
operator|)
operator|||
operator|!
name|all_zeros_or_all_ones
argument_list|(
name|l3_mask
operator|->
name|ip4src
argument_list|)
operator|||
operator|!
name|all_zeros_or_all_ones
argument_list|(
name|l3_mask
operator|->
name|ip4dst
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
break|break;
case|case
name|ETHER_FLOW
case|:
name|eth_mask
operator|=
operator|&
name|cmd
operator|->
name|fs
operator|.
name|m_u
operator|.
name|ether_spec
expr_stmt|;
comment|/* source mac mask must not be set */
if|if
condition|(
operator|!
name|is_zero_ether_addr
argument_list|(
name|eth_mask
operator|->
name|h_source
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
comment|/* dest mac mask must be ff:ff:ff:ff:ff:ff */
if|if
condition|(
operator|!
name|is_broadcast_ether_addr
argument_list|(
name|eth_mask
operator|->
name|h_dest
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
if|if
condition|(
operator|!
name|all_zeros_or_all_ones
argument_list|(
name|eth_mask
operator|->
name|h_proto
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
break|break;
default|default:
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
operator|(
name|cmd
operator|->
name|fs
operator|.
name|flow_type
operator|&
name|FLOW_EXT
operator|)
condition|)
block|{
if|if
condition|(
name|cmd
operator|->
name|fs
operator|.
name|m_ext
operator|.
name|vlan_etype
operator|||
operator|!
operator|(
name|cmd
operator|->
name|fs
operator|.
name|m_ext
operator|.
name|vlan_tci
operator|==
literal|0
operator|||
name|cmd
operator|->
name|fs
operator|.
name|m_ext
operator|.
name|vlan_tci
operator|==
name|cpu_to_be16
argument_list|(
literal|0xfff
argument_list|)
operator|)
condition|)
return|return
operator|-
name|EINVAL
return|;
if|if
condition|(
name|cmd
operator|->
name|fs
operator|.
name|m_ext
operator|.
name|vlan_tci
condition|)
block|{
if|if
condition|(
name|be16_to_cpu
argument_list|(
name|cmd
operator|->
name|fs
operator|.
name|h_ext
operator|.
name|vlan_tci
argument_list|)
operator|<
name|VLAN_MIN_VALUE
operator|||
name|be16_to_cpu
argument_list|(
name|cmd
operator|->
name|fs
operator|.
name|h_ext
operator|.
name|vlan_tci
argument_list|)
operator|>
name|VLAN_MAX_VALUE
condition|)
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_en_ethtool_add_mac_rule
parameter_list|(
name|struct
name|mlx4_ethtool_rxnfc
modifier|*
name|cmd
parameter_list|,
name|struct
name|list_head
modifier|*
name|rule_list_h
parameter_list|,
name|struct
name|mlx4_spec_list
modifier|*
name|spec_l2
parameter_list|,
name|unsigned
name|char
modifier|*
name|mac
parameter_list|)
block|{
name|int
name|err
init|=
literal|0
decl_stmt|;
name|__be64
name|mac_msk
init|=
name|cpu_to_be64
argument_list|(
name|MLX4_MAC_MASK
operator|<<
literal|16
argument_list|)
decl_stmt|;
name|spec_l2
operator|->
name|id
operator|=
name|MLX4_NET_TRANS_RULE_ID_ETH
expr_stmt|;
name|memcpy
argument_list|(
name|spec_l2
operator|->
name|eth
operator|.
name|dst_mac_msk
argument_list|,
operator|&
name|mac_msk
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|spec_l2
operator|->
name|eth
operator|.
name|dst_mac
argument_list|,
name|mac
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|cmd
operator|->
name|fs
operator|.
name|flow_type
operator|&
name|FLOW_EXT
operator|)
operator|&&
name|cmd
operator|->
name|fs
operator|.
name|m_ext
operator|.
name|vlan_tci
condition|)
block|{
name|spec_l2
operator|->
name|eth
operator|.
name|vlan_id
operator|=
name|cmd
operator|->
name|fs
operator|.
name|h_ext
operator|.
name|vlan_tci
expr_stmt|;
name|spec_l2
operator|->
name|eth
operator|.
name|vlan_id_msk
operator|=
name|cpu_to_be16
argument_list|(
literal|0xfff
argument_list|)
expr_stmt|;
block|}
name|list_add_tail
argument_list|(
operator|&
name|spec_l2
operator|->
name|list
argument_list|,
name|rule_list_h
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_en_ethtool_add_mac_rule_by_ipv4
parameter_list|(
name|struct
name|mlx4_en_priv
modifier|*
name|priv
parameter_list|,
name|struct
name|mlx4_ethtool_rxnfc
modifier|*
name|cmd
parameter_list|,
name|struct
name|list_head
modifier|*
name|rule_list_h
parameter_list|,
name|struct
name|mlx4_spec_list
modifier|*
name|spec_l2
parameter_list|,
name|__be32
name|ipv4_dst
parameter_list|)
block|{
name|unsigned
name|char
name|mac
index|[
name|ETH_ALEN
index|]
decl_stmt|;
if|if
condition|(
operator|!
name|ipv4_is_multicast
argument_list|(
name|ipv4_dst
argument_list|)
condition|)
block|{
if|if
condition|(
name|cmd
operator|->
name|fs
operator|.
name|flow_type
operator|&
name|FLOW_MAC_EXT
condition|)
name|memcpy
argument_list|(
operator|&
name|mac
argument_list|,
name|cmd
operator|->
name|fs
operator|.
name|h_ext
operator|.
name|h_dest
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
else|else
name|memcpy
argument_list|(
operator|&
name|mac
argument_list|,
name|priv
operator|->
name|dev
operator|->
name|dev_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ip_eth_mc_map
argument_list|(
name|ipv4_dst
argument_list|,
name|mac
argument_list|)
expr_stmt|;
block|}
return|return
name|mlx4_en_ethtool_add_mac_rule
argument_list|(
name|cmd
argument_list|,
name|rule_list_h
argument_list|,
name|spec_l2
argument_list|,
operator|&
name|mac
index|[
literal|0
index|]
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|add_ip_rule
parameter_list|(
name|struct
name|mlx4_en_priv
modifier|*
name|priv
parameter_list|,
name|struct
name|mlx4_ethtool_rxnfc
modifier|*
name|cmd
parameter_list|,
name|struct
name|list_head
modifier|*
name|list_h
parameter_list|)
block|{
name|struct
name|mlx4_spec_list
modifier|*
name|spec_l2
init|=
name|NULL
decl_stmt|;
name|struct
name|mlx4_spec_list
modifier|*
name|spec_l3
init|=
name|NULL
decl_stmt|;
name|struct
name|ethtool_usrip4_spec
modifier|*
name|l3_mask
init|=
operator|&
name|cmd
operator|->
name|fs
operator|.
name|m_u
operator|.
name|usr_ip4_spec
decl_stmt|;
name|spec_l3
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|spec_l3
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
name|spec_l2
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|spec_l2
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|spec_l2
operator|||
operator|!
name|spec_l3
condition|)
block|{
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Fail to alloc ethtool rule.\n"
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|spec_l2
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|spec_l3
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOMEM
return|;
block|}
name|mlx4_en_ethtool_add_mac_rule_by_ipv4
argument_list|(
name|priv
argument_list|,
name|cmd
argument_list|,
name|list_h
argument_list|,
name|spec_l2
argument_list|,
name|cmd
operator|->
name|fs
operator|.
name|h_u
operator|.
name|usr_ip4_spec
operator|.
name|ip4dst
argument_list|)
expr_stmt|;
name|spec_l3
operator|->
name|id
operator|=
name|MLX4_NET_TRANS_RULE_ID_IPV4
expr_stmt|;
name|spec_l3
operator|->
name|ipv4
operator|.
name|src_ip
operator|=
name|cmd
operator|->
name|fs
operator|.
name|h_u
operator|.
name|usr_ip4_spec
operator|.
name|ip4src
expr_stmt|;
if|if
condition|(
name|l3_mask
operator|->
name|ip4src
condition|)
name|spec_l3
operator|->
name|ipv4
operator|.
name|src_ip_msk
operator|=
name|MLX4_BE_WORD_MASK
expr_stmt|;
name|spec_l3
operator|->
name|ipv4
operator|.
name|dst_ip
operator|=
name|cmd
operator|->
name|fs
operator|.
name|h_u
operator|.
name|usr_ip4_spec
operator|.
name|ip4dst
expr_stmt|;
if|if
condition|(
name|l3_mask
operator|->
name|ip4dst
condition|)
name|spec_l3
operator|->
name|ipv4
operator|.
name|dst_ip_msk
operator|=
name|MLX4_BE_WORD_MASK
expr_stmt|;
name|list_add_tail
argument_list|(
operator|&
name|spec_l3
operator|->
name|list
argument_list|,
name|list_h
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|add_tcp_udp_rule
parameter_list|(
name|struct
name|mlx4_en_priv
modifier|*
name|priv
parameter_list|,
name|struct
name|mlx4_ethtool_rxnfc
modifier|*
name|cmd
parameter_list|,
name|struct
name|list_head
modifier|*
name|list_h
parameter_list|,
name|int
name|proto
parameter_list|)
block|{
name|struct
name|mlx4_spec_list
modifier|*
name|spec_l2
init|=
name|NULL
decl_stmt|;
name|struct
name|mlx4_spec_list
modifier|*
name|spec_l3
init|=
name|NULL
decl_stmt|;
name|struct
name|mlx4_spec_list
modifier|*
name|spec_l4
init|=
name|NULL
decl_stmt|;
name|struct
name|ethtool_tcpip4_spec
modifier|*
name|l4_mask
init|=
operator|&
name|cmd
operator|->
name|fs
operator|.
name|m_u
operator|.
name|tcp_ip4_spec
decl_stmt|;
name|spec_l2
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|spec_l2
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
name|spec_l3
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|spec_l3
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
name|spec_l4
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|spec_l4
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|spec_l2
operator|||
operator|!
name|spec_l3
operator|||
operator|!
name|spec_l4
condition|)
block|{
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Fail to alloc ethtool rule.\n"
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|spec_l2
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|spec_l3
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|spec_l4
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOMEM
return|;
block|}
name|spec_l3
operator|->
name|id
operator|=
name|MLX4_NET_TRANS_RULE_ID_IPV4
expr_stmt|;
if|if
condition|(
name|proto
operator|==
name|TCP_V4_FLOW
condition|)
block|{
name|mlx4_en_ethtool_add_mac_rule_by_ipv4
argument_list|(
name|priv
argument_list|,
name|cmd
argument_list|,
name|list_h
argument_list|,
name|spec_l2
argument_list|,
name|cmd
operator|->
name|fs
operator|.
name|h_u
operator|.
name|tcp_ip4_spec
operator|.
name|ip4dst
argument_list|)
expr_stmt|;
name|spec_l4
operator|->
name|id
operator|=
name|MLX4_NET_TRANS_RULE_ID_TCP
expr_stmt|;
name|spec_l3
operator|->
name|ipv4
operator|.
name|src_ip
operator|=
name|cmd
operator|->
name|fs
operator|.
name|h_u
operator|.
name|tcp_ip4_spec
operator|.
name|ip4src
expr_stmt|;
name|spec_l3
operator|->
name|ipv4
operator|.
name|dst_ip
operator|=
name|cmd
operator|->
name|fs
operator|.
name|h_u
operator|.
name|tcp_ip4_spec
operator|.
name|ip4dst
expr_stmt|;
name|spec_l4
operator|->
name|tcp_udp
operator|.
name|src_port
operator|=
name|cmd
operator|->
name|fs
operator|.
name|h_u
operator|.
name|tcp_ip4_spec
operator|.
name|psrc
expr_stmt|;
name|spec_l4
operator|->
name|tcp_udp
operator|.
name|dst_port
operator|=
name|cmd
operator|->
name|fs
operator|.
name|h_u
operator|.
name|tcp_ip4_spec
operator|.
name|pdst
expr_stmt|;
block|}
else|else
block|{
name|mlx4_en_ethtool_add_mac_rule_by_ipv4
argument_list|(
name|priv
argument_list|,
name|cmd
argument_list|,
name|list_h
argument_list|,
name|spec_l2
argument_list|,
name|cmd
operator|->
name|fs
operator|.
name|h_u
operator|.
name|udp_ip4_spec
operator|.
name|ip4dst
argument_list|)
expr_stmt|;
name|spec_l4
operator|->
name|id
operator|=
name|MLX4_NET_TRANS_RULE_ID_UDP
expr_stmt|;
name|spec_l3
operator|->
name|ipv4
operator|.
name|src_ip
operator|=
name|cmd
operator|->
name|fs
operator|.
name|h_u
operator|.
name|udp_ip4_spec
operator|.
name|ip4src
expr_stmt|;
name|spec_l3
operator|->
name|ipv4
operator|.
name|dst_ip
operator|=
name|cmd
operator|->
name|fs
operator|.
name|h_u
operator|.
name|udp_ip4_spec
operator|.
name|ip4dst
expr_stmt|;
name|spec_l4
operator|->
name|tcp_udp
operator|.
name|src_port
operator|=
name|cmd
operator|->
name|fs
operator|.
name|h_u
operator|.
name|udp_ip4_spec
operator|.
name|psrc
expr_stmt|;
name|spec_l4
operator|->
name|tcp_udp
operator|.
name|dst_port
operator|=
name|cmd
operator|->
name|fs
operator|.
name|h_u
operator|.
name|udp_ip4_spec
operator|.
name|pdst
expr_stmt|;
block|}
if|if
condition|(
name|l4_mask
operator|->
name|ip4src
condition|)
name|spec_l3
operator|->
name|ipv4
operator|.
name|src_ip_msk
operator|=
name|MLX4_BE_WORD_MASK
expr_stmt|;
if|if
condition|(
name|l4_mask
operator|->
name|ip4dst
condition|)
name|spec_l3
operator|->
name|ipv4
operator|.
name|dst_ip_msk
operator|=
name|MLX4_BE_WORD_MASK
expr_stmt|;
if|if
condition|(
name|l4_mask
operator|->
name|psrc
condition|)
name|spec_l4
operator|->
name|tcp_udp
operator|.
name|src_port_msk
operator|=
name|MLX4_BE_SHORT_MASK
expr_stmt|;
if|if
condition|(
name|l4_mask
operator|->
name|pdst
condition|)
name|spec_l4
operator|->
name|tcp_udp
operator|.
name|dst_port_msk
operator|=
name|MLX4_BE_SHORT_MASK
expr_stmt|;
name|list_add_tail
argument_list|(
operator|&
name|spec_l3
operator|->
name|list
argument_list|,
name|list_h
argument_list|)
expr_stmt|;
name|list_add_tail
argument_list|(
operator|&
name|spec_l4
operator|->
name|list
argument_list|,
name|list_h
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_en_ethtool_to_net_trans_rule
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|,
name|struct
name|mlx4_ethtool_rxnfc
modifier|*
name|cmd
parameter_list|,
name|struct
name|list_head
modifier|*
name|rule_list_h
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|struct
name|ethhdr
modifier|*
name|eth_spec
decl_stmt|;
name|struct
name|mlx4_spec_list
modifier|*
name|spec_l2
decl_stmt|;
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|err
operator|=
name|mlx4_en_validate_flow
argument_list|(
name|dev
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
switch|switch
condition|(
name|cmd
operator|->
name|fs
operator|.
name|flow_type
operator|&
operator|~
operator|(
name|FLOW_EXT
operator||
name|FLOW_MAC_EXT
operator|)
condition|)
block|{
case|case
name|ETHER_FLOW
case|:
name|spec_l2
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|spec_l2
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|spec_l2
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|eth_spec
operator|=
operator|&
name|cmd
operator|->
name|fs
operator|.
name|h_u
operator|.
name|ether_spec
expr_stmt|;
name|mlx4_en_ethtool_add_mac_rule
argument_list|(
name|cmd
argument_list|,
name|rule_list_h
argument_list|,
name|spec_l2
argument_list|,
operator|&
name|eth_spec
operator|->
name|h_dest
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|spec_l2
operator|->
name|eth
operator|.
name|ether_type
operator|=
name|eth_spec
operator|->
name|h_proto
expr_stmt|;
if|if
condition|(
name|eth_spec
operator|->
name|h_proto
condition|)
name|spec_l2
operator|->
name|eth
operator|.
name|ether_type_enable
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|IP_USER_FLOW
case|:
name|err
operator|=
name|add_ip_rule
argument_list|(
name|priv
argument_list|,
name|cmd
argument_list|,
name|rule_list_h
argument_list|)
expr_stmt|;
break|break;
case|case
name|TCP_V4_FLOW
case|:
name|err
operator|=
name|add_tcp_udp_rule
argument_list|(
name|priv
argument_list|,
name|cmd
argument_list|,
name|rule_list_h
argument_list|,
name|TCP_V4_FLOW
argument_list|)
expr_stmt|;
break|break;
case|case
name|UDP_V4_FLOW
case|:
name|err
operator|=
name|add_tcp_udp_rule
argument_list|(
name|priv
argument_list|,
name|cmd
argument_list|,
name|rule_list_h
argument_list|,
name|UDP_V4_FLOW
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_en_flow_replace
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|,
name|struct
name|mlx4_ethtool_rxnfc
modifier|*
name|cmd
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|mlx4_en_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|struct
name|ethtool_flow_id
modifier|*
name|loc_rule
decl_stmt|;
name|struct
name|mlx4_spec_list
modifier|*
name|spec
decl_stmt|,
modifier|*
name|tmp_spec
decl_stmt|;
name|u32
name|qpn
decl_stmt|;
name|u64
name|reg_id
decl_stmt|;
name|struct
name|mlx4_net_trans_rule
name|rule
init|=
block|{
operator|.
name|queue_mode
operator|=
name|MLX4_NET_TRANS_Q_FIFO
block|,
operator|.
name|exclusive
operator|=
literal|0
block|,
operator|.
name|allow_loopback
operator|=
literal|1
block|,
operator|.
name|promisc_mode
operator|=
name|MLX4_FS_REGULAR
block|, 	}
decl_stmt|;
name|rule
operator|.
name|port
operator|=
name|priv
operator|->
name|port
expr_stmt|;
name|rule
operator|.
name|priority
operator|=
name|MLX4_DOMAIN_ETHTOOL
operator||
name|cmd
operator|->
name|fs
operator|.
name|location
expr_stmt|;
name|INIT_LIST_HEAD
argument_list|(
operator|&
name|rule
operator|.
name|list
argument_list|)
expr_stmt|;
comment|/* Allow direct QP attaches if the EN_ETHTOOL_QP_ATTACH flag is set */
if|if
condition|(
name|cmd
operator|->
name|fs
operator|.
name|ring_cookie
operator|==
name|RX_CLS_FLOW_DISC
condition|)
name|qpn
operator|=
name|priv
operator|->
name|drop_qp
operator|.
name|qpn
expr_stmt|;
elseif|else
if|if
condition|(
name|cmd
operator|->
name|fs
operator|.
name|ring_cookie
operator|&
name|EN_ETHTOOL_QP_ATTACH
condition|)
block|{
name|qpn
operator|=
name|cmd
operator|->
name|fs
operator|.
name|ring_cookie
operator|&
operator|(
name|EN_ETHTOOL_QP_ATTACH
operator|-
literal|1
operator|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|cmd
operator|->
name|fs
operator|.
name|ring_cookie
operator|>=
name|priv
operator|->
name|rx_ring_num
condition|)
block|{
name|en_warn
argument_list|(
name|priv
argument_list|,
literal|"rxnfc: RX ring (%llu) doesn't exist.\n"
argument_list|,
name|cmd
operator|->
name|fs
operator|.
name|ring_cookie
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|qpn
operator|=
name|priv
operator|->
name|rss_map
operator|.
name|qps
index|[
name|cmd
operator|->
name|fs
operator|.
name|ring_cookie
index|]
operator|.
name|qpn
expr_stmt|;
if|if
condition|(
operator|!
name|qpn
condition|)
block|{
name|en_warn
argument_list|(
name|priv
argument_list|,
literal|"rxnfc: RX ring (%llu) is inactive.\n"
argument_list|,
name|cmd
operator|->
name|fs
operator|.
name|ring_cookie
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
name|rule
operator|.
name|qpn
operator|=
name|qpn
expr_stmt|;
name|err
operator|=
name|mlx4_en_ethtool_to_net_trans_rule
argument_list|(
name|dev
argument_list|,
name|cmd
argument_list|,
operator|&
name|rule
operator|.
name|list
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|out_free_list
goto|;
name|mutex_lock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
name|loc_rule
operator|=
operator|&
name|priv
operator|->
name|ethtool_rules
index|[
name|cmd
operator|->
name|fs
operator|.
name|location
index|]
expr_stmt|;
if|if
condition|(
name|loc_rule
operator|->
name|id
condition|)
block|{
name|err
operator|=
name|mlx4_flow_detach
argument_list|(
name|priv
operator|->
name|mdev
operator|->
name|dev
argument_list|,
name|loc_rule
operator|->
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Fail to detach network rule at location %d. registration id = %llx\n"
argument_list|,
name|cmd
operator|->
name|fs
operator|.
name|location
argument_list|,
name|loc_rule
operator|->
name|id
argument_list|)
expr_stmt|;
goto|goto
name|unlock
goto|;
block|}
name|loc_rule
operator|->
name|id
operator|=
literal|0
expr_stmt|;
name|memset
argument_list|(
operator|&
name|loc_rule
operator|->
name|flow_spec
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ethtool_rx_flow_spec
argument_list|)
argument_list|)
expr_stmt|;
name|list_del
argument_list|(
operator|&
name|loc_rule
operator|->
name|list
argument_list|)
expr_stmt|;
block|}
name|err
operator|=
name|mlx4_flow_attach
argument_list|(
name|priv
operator|->
name|mdev
operator|->
name|dev
argument_list|,
operator|&
name|rule
argument_list|,
operator|&
name|reg_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Fail to attach network rule at location %d.\n"
argument_list|,
name|cmd
operator|->
name|fs
operator|.
name|location
argument_list|)
expr_stmt|;
goto|goto
name|unlock
goto|;
block|}
name|loc_rule
operator|->
name|id
operator|=
name|reg_id
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|loc_rule
operator|->
name|flow_spec
argument_list|,
operator|&
name|cmd
operator|->
name|fs
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ethtool_rx_flow_spec
argument_list|)
argument_list|)
expr_stmt|;
name|list_add_tail
argument_list|(
operator|&
name|loc_rule
operator|->
name|list
argument_list|,
operator|&
name|priv
operator|->
name|ethtool_list
argument_list|)
expr_stmt|;
name|unlock
label|:
name|mutex_unlock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
name|out_free_list
label|:
name|list_for_each_entry_safe
argument_list|(
argument|spec
argument_list|,
argument|tmp_spec
argument_list|,
argument|&rule.list
argument_list|,
argument|list
argument_list|)
block|{
name|list_del
argument_list|(
operator|&
name|spec
operator|->
name|list
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|spec
argument_list|)
expr_stmt|;
block|}
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_en_flow_detach
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|,
name|struct
name|mlx4_ethtool_rxnfc
modifier|*
name|cmd
parameter_list|)
block|{
name|int
name|err
init|=
literal|0
decl_stmt|;
name|struct
name|ethtool_flow_id
modifier|*
name|rule
decl_stmt|;
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|mlx4_en_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
if|if
condition|(
name|cmd
operator|->
name|fs
operator|.
name|location
operator|>=
name|MAX_NUM_OF_FS_RULES
condition|)
return|return
operator|-
name|EINVAL
return|;
name|mutex_lock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
name|rule
operator|=
operator|&
name|priv
operator|->
name|ethtool_rules
index|[
name|cmd
operator|->
name|fs
operator|.
name|location
index|]
expr_stmt|;
if|if
condition|(
operator|!
name|rule
operator|->
name|id
condition|)
block|{
name|err
operator|=
operator|-
name|ENOENT
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|err
operator|=
name|mlx4_flow_detach
argument_list|(
name|priv
operator|->
name|mdev
operator|->
name|dev
argument_list|,
name|rule
operator|->
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Fail to detach network rule at location %d. registration id = 0x%llx\n"
argument_list|,
name|cmd
operator|->
name|fs
operator|.
name|location
argument_list|,
name|rule
operator|->
name|id
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|rule
operator|->
name|id
operator|=
literal|0
expr_stmt|;
name|memset
argument_list|(
operator|&
name|rule
operator|->
name|flow_spec
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ethtool_rx_flow_spec
argument_list|)
argument_list|)
expr_stmt|;
name|list_del
argument_list|(
operator|&
name|rule
operator|->
name|list
argument_list|)
expr_stmt|;
name|out
label|:
name|mutex_unlock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_en_get_flow
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|,
name|struct
name|mlx4_ethtool_rxnfc
modifier|*
name|cmd
parameter_list|,
name|int
name|loc
parameter_list|)
block|{
name|int
name|err
init|=
literal|0
decl_stmt|;
name|struct
name|ethtool_flow_id
modifier|*
name|rule
decl_stmt|;
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|loc
operator|<
literal|0
operator|||
name|loc
operator|>=
name|MAX_NUM_OF_FS_RULES
condition|)
return|return
operator|-
name|EINVAL
return|;
name|rule
operator|=
operator|&
name|priv
operator|->
name|ethtool_rules
index|[
name|loc
index|]
expr_stmt|;
if|if
condition|(
name|rule
operator|->
name|id
condition|)
name|memcpy
argument_list|(
operator|&
name|cmd
operator|->
name|fs
argument_list|,
operator|&
name|rule
operator|->
name|flow_spec
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ethtool_rx_flow_spec
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|err
operator|=
operator|-
name|ENOENT
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_en_get_num_flows
parameter_list|(
name|struct
name|mlx4_en_priv
modifier|*
name|priv
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|res
init|=
literal|0
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_NUM_OF_FS_RULES
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|priv
operator|->
name|ethtool_rules
index|[
name|i
index|]
operator|.
name|id
condition|)
name|res
operator|++
expr_stmt|;
block|}
return|return
name|res
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_en_get_rxnfc
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|,
name|struct
name|ethtool_rxnfc
modifier|*
name|c
parameter_list|,
name|u32
modifier|*
name|rule_locs
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|mlx4_en_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|int
name|err
init|=
literal|0
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|,
name|priority
init|=
literal|0
decl_stmt|;
name|struct
name|mlx4_ethtool_rxnfc
modifier|*
name|cmd
init|=
operator|(
expr|struct
name|mlx4_ethtool_rxnfc
operator|*
operator|)
name|c
decl_stmt|;
if|if
condition|(
operator|(
name|cmd
operator|->
name|cmd
operator|==
name|ETHTOOL_GRXCLSRLCNT
operator|||
name|cmd
operator|->
name|cmd
operator|==
name|ETHTOOL_GRXCLSRULE
operator|||
name|cmd
operator|->
name|cmd
operator|==
name|ETHTOOL_GRXCLSRLALL
operator|)
operator|&&
operator|(
name|mdev
operator|->
name|dev
operator|->
name|caps
operator|.
name|steering_mode
operator|!=
name|MLX4_STEERING_MODE_DEVICE_MANAGED
operator|||
operator|!
name|priv
operator|->
name|port_up
operator|)
condition|)
return|return
operator|-
name|EINVAL
return|;
switch|switch
condition|(
name|cmd
operator|->
name|cmd
condition|)
block|{
case|case
name|ETHTOOL_GRXRINGS
case|:
name|cmd
operator|->
name|data
operator|=
name|priv
operator|->
name|rx_ring_num
expr_stmt|;
break|break;
case|case
name|ETHTOOL_GRXCLSRLCNT
case|:
name|cmd
operator|->
name|rule_cnt
operator|=
name|mlx4_en_get_num_flows
argument_list|(
name|priv
argument_list|)
expr_stmt|;
break|break;
case|case
name|ETHTOOL_GRXCLSRULE
case|:
name|err
operator|=
name|mlx4_en_get_flow
argument_list|(
name|dev
argument_list|,
name|cmd
argument_list|,
name|cmd
operator|->
name|fs
operator|.
name|location
argument_list|)
expr_stmt|;
break|break;
case|case
name|ETHTOOL_GRXCLSRLALL
case|:
while|while
condition|(
operator|(
operator|!
name|err
operator|||
name|err
operator|==
operator|-
name|ENOENT
operator|)
operator|&&
name|priority
operator|<
name|cmd
operator|->
name|rule_cnt
condition|)
block|{
name|err
operator|=
name|mlx4_en_get_flow
argument_list|(
name|dev
argument_list|,
name|cmd
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|err
condition|)
name|rule_locs
index|[
name|priority
operator|++
index|]
operator|=
name|i
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
name|err
operator|=
literal|0
expr_stmt|;
break|break;
default|default:
name|err
operator|=
operator|-
name|EOPNOTSUPP
expr_stmt|;
break|break;
block|}
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_en_set_rxnfc
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|,
name|struct
name|ethtool_rxnfc
modifier|*
name|c
parameter_list|)
block|{
name|int
name|err
init|=
literal|0
decl_stmt|;
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|mlx4_en_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|struct
name|mlx4_ethtool_rxnfc
modifier|*
name|cmd
init|=
operator|(
expr|struct
name|mlx4_ethtool_rxnfc
operator|*
operator|)
name|c
decl_stmt|;
if|if
condition|(
name|mdev
operator|->
name|dev
operator|->
name|caps
operator|.
name|steering_mode
operator|!=
name|MLX4_STEERING_MODE_DEVICE_MANAGED
operator|||
operator|!
name|priv
operator|->
name|port_up
condition|)
return|return
operator|-
name|EINVAL
return|;
switch|switch
condition|(
name|cmd
operator|->
name|cmd
condition|)
block|{
case|case
name|ETHTOOL_SRXCLSRLINS
case|:
name|err
operator|=
name|mlx4_en_flow_replace
argument_list|(
name|dev
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
break|break;
case|case
name|ETHTOOL_SRXCLSRLDEL
case|:
name|err
operator|=
name|mlx4_en_flow_detach
argument_list|(
name|dev
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
break|break;
default|default:
name|en_warn
argument_list|(
name|priv
argument_list|,
literal|"Unsupported ethtool command. (%d)\n"
argument_list|,
name|cmd
operator|->
name|cmd
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_en_get_channels
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|,
name|struct
name|ethtool_channels
modifier|*
name|channel
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|memset
argument_list|(
name|channel
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|channel
argument_list|)
argument_list|)
expr_stmt|;
name|channel
operator|->
name|max_rx
operator|=
name|MAX_RX_RINGS
expr_stmt|;
name|channel
operator|->
name|max_tx
operator|=
name|MLX4_EN_MAX_TX_RING_P_UP
expr_stmt|;
name|channel
operator|->
name|rx_count
operator|=
name|priv
operator|->
name|rx_ring_num
expr_stmt|;
name|channel
operator|->
name|tx_count
operator|=
name|priv
operator|->
name|tx_ring_num
operator|/
name|MLX4_EN_NUM_UP
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_en_set_channels
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|,
name|struct
name|ethtool_channels
modifier|*
name|channel
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|mlx4_en_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|int
name|port_up
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|err
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|channel
operator|->
name|other_count
operator|||
name|channel
operator|->
name|combined_count
operator|||
name|channel
operator|->
name|tx_count
operator|>
name|MLX4_EN_MAX_TX_RING_P_UP
operator|||
name|channel
operator|->
name|rx_count
operator|>
name|MAX_RX_RINGS
operator|||
operator|!
name|channel
operator|->
name|tx_count
operator|||
operator|!
name|channel
operator|->
name|rx_count
condition|)
return|return
operator|-
name|EINVAL
return|;
name|err
operator|=
name|mlx4_en_pre_config
argument_list|(
name|priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
name|mutex_lock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|port_up
condition|)
block|{
name|port_up
operator|=
literal|1
expr_stmt|;
name|mlx4_en_stop_port
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
name|mlx4_en_free_resources
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|priv
operator|->
name|num_tx_rings_p_up
operator|=
name|channel
operator|->
name|tx_count
expr_stmt|;
name|priv
operator|->
name|tx_ring_num
operator|=
name|channel
operator|->
name|tx_count
operator|*
name|MLX4_EN_NUM_UP
expr_stmt|;
name|priv
operator|->
name|rx_ring_num
operator|=
name|channel
operator|->
name|rx_count
expr_stmt|;
name|err
operator|=
name|mlx4_en_alloc_resources
argument_list|(
name|priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed reallocating port resources\n"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|netif_set_real_num_tx_queues
argument_list|(
name|dev
argument_list|,
name|priv
operator|->
name|tx_ring_num
argument_list|)
expr_stmt|;
name|netif_set_real_num_rx_queues
argument_list|(
name|dev
argument_list|,
name|priv
operator|->
name|rx_ring_num
argument_list|)
expr_stmt|;
name|mlx4_en_setup_tc
argument_list|(
name|dev
argument_list|,
name|MLX4_EN_NUM_UP
argument_list|)
expr_stmt|;
name|en_warn
argument_list|(
name|priv
argument_list|,
literal|"Using %d TX rings\n"
argument_list|,
name|priv
operator|->
name|tx_ring_num
argument_list|)
expr_stmt|;
name|en_warn
argument_list|(
name|priv
argument_list|,
literal|"Using %d RX rings\n"
argument_list|,
name|priv
operator|->
name|rx_ring_num
argument_list|)
expr_stmt|;
if|if
condition|(
name|port_up
condition|)
block|{
name|err
operator|=
name|mlx4_en_start_port
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed starting port\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|rx_ring_num
condition|;
name|i
operator|++
control|)
block|{
name|priv
operator|->
name|rx_cq
index|[
name|i
index|]
operator|->
name|moder_cnt
operator|=
name|priv
operator|->
name|rx_frames
expr_stmt|;
name|priv
operator|->
name|rx_cq
index|[
name|i
index|]
operator|->
name|moder_time
operator|=
name|priv
operator|->
name|rx_usecs
expr_stmt|;
name|priv
operator|->
name|last_moder_time
index|[
name|i
index|]
operator|=
name|MLX4_EN_AUTO_CONF
expr_stmt|;
name|err
operator|=
name|mlx4_en_set_cq_moder
argument_list|(
name|priv
argument_list|,
name|priv
operator|->
name|rx_cq
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|out
goto|;
block|}
block|}
name|out
label|:
name|mutex_unlock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_en_get_ts_info
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|,
name|struct
name|ethtool_ts_info
modifier|*
name|info
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|mlx4_en_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|ethtool_op_get_ts_info
argument_list|(
name|dev
argument_list|,
name|info
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
if|if
condition|(
name|mdev
operator|->
name|dev
operator|->
name|caps
operator|.
name|flags2
operator|&
name|MLX4_DEV_CAP_FLAG2_TS
condition|)
block|{
name|info
operator|->
name|so_timestamping
operator||=
name|SOF_TIMESTAMPING_TX_HARDWARE
operator||
name|SOF_TIMESTAMPING_RX_HARDWARE
operator||
name|SOF_TIMESTAMPING_RAW_HARDWARE
expr_stmt|;
name|info
operator|->
name|tx_types
operator|=
operator|(
literal|1
operator|<<
name|HWTSTAMP_TX_OFF
operator|)
operator||
operator|(
literal|1
operator|<<
name|HWTSTAMP_TX_ON
operator|)
expr_stmt|;
name|info
operator|->
name|rx_filters
operator|=
operator|(
literal|1
operator|<<
name|HWTSTAMP_FILTER_NONE
operator|)
operator||
operator|(
literal|1
operator|<<
name|HWTSTAMP_FILTER_ALL
operator|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_decl_stmt
specifier|const
name|struct
name|ethtool_ops
name|mlx4_en_ethtool_ops
init|=
block|{
operator|.
name|get_drvinfo
operator|=
name|mlx4_en_get_drvinfo
block|,
operator|.
name|get_settings
operator|=
name|mlx4_en_get_settings
block|,
operator|.
name|set_settings
operator|=
name|mlx4_en_set_settings
block|,
operator|.
name|get_link
operator|=
name|ethtool_op_get_link
block|,
operator|.
name|get_strings
operator|=
name|mlx4_en_get_strings
block|,
operator|.
name|get_sset_count
operator|=
name|mlx4_en_get_sset_count
block|,
operator|.
name|get_ethtool_stats
operator|=
name|mlx4_en_get_ethtool_stats
block|,
operator|.
name|self_test
operator|=
name|mlx4_en_self_test
block|,
operator|.
name|get_wol
operator|=
name|mlx4_en_get_wol
block|,
operator|.
name|set_wol
operator|=
name|mlx4_en_set_wol
block|,
operator|.
name|get_msglevel
operator|=
name|mlx4_en_get_msglevel
block|,
operator|.
name|set_msglevel
operator|=
name|mlx4_en_set_msglevel
block|,
operator|.
name|get_coalesce
operator|=
name|mlx4_en_get_coalesce
block|,
operator|.
name|set_coalesce
operator|=
name|mlx4_en_set_coalesce
block|,
operator|.
name|get_pauseparam
operator|=
name|mlx4_en_get_pauseparam
block|,
operator|.
name|set_pauseparam
operator|=
name|mlx4_en_set_pauseparam
block|,
operator|.
name|get_ringparam
operator|=
name|mlx4_en_get_ringparam
block|,
operator|.
name|set_ringparam
operator|=
name|mlx4_en_set_ringparam
block|,
operator|.
name|get_rxnfc
operator|=
name|mlx4_en_get_rxnfc
block|,
operator|.
name|set_rxnfc
operator|=
name|mlx4_en_set_rxnfc
block|,
operator|.
name|get_rxfh_indir_size
operator|=
name|mlx4_en_get_rxfh_indir_size
block|,
operator|.
name|get_rxfh_indir
operator|=
name|mlx4_en_get_rxfh_indir
block|,
operator|.
name|set_rxfh_indir
operator|=
name|mlx4_en_set_rxfh_indir
block|,
operator|.
name|get_channels
operator|=
name|mlx4_en_get_channels
block|,
operator|.
name|set_channels
operator|=
name|mlx4_en_set_channels
block|,
operator|.
name|get_ts_info
operator|=
name|mlx4_en_get_ts_info
block|, }
decl_stmt|;
end_decl_stmt

end_unit


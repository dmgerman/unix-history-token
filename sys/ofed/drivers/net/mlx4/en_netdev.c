begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2007 Mellanox Technologies. All rights reserved.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  *  */
end_comment

begin_include
include|#
directive|include
file|"mlx4_en.h"
end_include

begin_include
include|#
directive|include
file|<linux/mlx4/driver.h>
end_include

begin_include
include|#
directive|include
file|<linux/mlx4/device.h>
end_include

begin_include
include|#
directive|include
file|<linux/mlx4/cmd.h>
end_include

begin_include
include|#
directive|include
file|<linux/mlx4/cq.h>
end_include

begin_include
include|#
directive|include
file|<linux/delay.h>
end_include

begin_include
include|#
directive|include
file|<net/ethernet.h>
end_include

begin_include
include|#
directive|include
file|<net/if_vlan_var.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_function_decl
specifier|static
name|void
name|mlx4_en_init_locked
parameter_list|(
name|struct
name|mlx4_en_priv
modifier|*
name|priv
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|mlx4_en_sysctl_stat
parameter_list|(
name|struct
name|mlx4_en_priv
modifier|*
name|priv
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|void
name|mlx4_en_vlan_rx_add_vid
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|struct
name|net_device
modifier|*
name|dev
parameter_list|,
name|u16
name|vid
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|idx
decl_stmt|;
name|u8
name|field
decl_stmt|;
if|if
condition|(
name|arg
operator|!=
name|priv
condition|)
return|return;
if|if
condition|(
operator|(
name|vid
operator|==
literal|0
operator|)
operator|||
operator|(
name|vid
operator|>
literal|4095
operator|)
condition|)
comment|/* Invalid */
return|return;
name|en_dbg
argument_list|(
name|HW
argument_list|,
name|priv
argument_list|,
literal|"adding VLAN:%d\n"
argument_list|,
name|vid
argument_list|)
expr_stmt|;
name|idx
operator|=
name|vid
operator|>>
literal|5
expr_stmt|;
name|field
operator|=
literal|1
operator|<<
operator|(
name|vid
operator|&
literal|0x1f
operator|)
expr_stmt|;
name|spin_lock
argument_list|(
operator|&
name|priv
operator|->
name|vlan_lock
argument_list|)
expr_stmt|;
name|priv
operator|->
name|vlgrp_modified
operator|=
name|true
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|vlan_unregister
index|[
name|idx
index|]
operator|&
name|field
condition|)
name|priv
operator|->
name|vlan_unregister
index|[
name|idx
index|]
operator|&=
operator|~
name|field
expr_stmt|;
else|else
name|priv
operator|->
name|vlan_register
index|[
name|idx
index|]
operator||=
name|field
expr_stmt|;
name|priv
operator|->
name|vlans
index|[
name|idx
index|]
operator||=
name|field
expr_stmt|;
name|spin_unlock
argument_list|(
operator|&
name|priv
operator|->
name|vlan_lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_en_vlan_rx_kill_vid
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|struct
name|net_device
modifier|*
name|dev
parameter_list|,
name|u16
name|vid
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|idx
decl_stmt|;
name|u8
name|field
decl_stmt|;
if|if
condition|(
name|arg
operator|!=
name|priv
condition|)
return|return;
if|if
condition|(
operator|(
name|vid
operator|==
literal|0
operator|)
operator|||
operator|(
name|vid
operator|>
literal|4095
operator|)
condition|)
comment|/* Invalid */
return|return;
name|en_dbg
argument_list|(
name|HW
argument_list|,
name|priv
argument_list|,
literal|"Killing VID:%d\n"
argument_list|,
name|vid
argument_list|)
expr_stmt|;
name|idx
operator|=
name|vid
operator|>>
literal|5
expr_stmt|;
name|field
operator|=
literal|1
operator|<<
operator|(
name|vid
operator|&
literal|0x1f
operator|)
expr_stmt|;
name|spin_lock
argument_list|(
operator|&
name|priv
operator|->
name|vlan_lock
argument_list|)
expr_stmt|;
name|priv
operator|->
name|vlgrp_modified
operator|=
name|true
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|vlan_register
index|[
name|idx
index|]
operator|&
name|field
condition|)
name|priv
operator|->
name|vlan_register
index|[
name|idx
index|]
operator|&=
operator|~
name|field
expr_stmt|;
else|else
name|priv
operator|->
name|vlan_unregister
index|[
name|idx
index|]
operator||=
name|field
expr_stmt|;
name|priv
operator|->
name|vlans
index|[
name|idx
index|]
operator|&=
operator|~
name|field
expr_stmt|;
name|spin_unlock
argument_list|(
operator|&
name|priv
operator|->
name|vlan_lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|u64
name|mlx4_en_mac_to_u64
parameter_list|(
name|u8
modifier|*
name|addr
parameter_list|)
block|{
name|u64
name|mac
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ETHER_ADDR_LEN
condition|;
name|i
operator|++
control|)
block|{
name|mac
operator|<<=
literal|8
expr_stmt|;
name|mac
operator||=
name|addr
index|[
name|i
index|]
expr_stmt|;
block|}
return|return
name|mac
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_en_cache_mclist
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|,
name|u64
modifier|*
modifier|*
name|mcaddrp
parameter_list|)
block|{
name|struct
name|ifmultiaddr
modifier|*
name|ifma
decl_stmt|;
name|u64
modifier|*
name|mcaddr
decl_stmt|;
name|int
name|cnt
decl_stmt|;
name|int
name|i
decl_stmt|;
operator|*
name|mcaddrp
operator|=
name|NULL
expr_stmt|;
name|restart
label|:
name|cnt
operator|=
literal|0
expr_stmt|;
name|if_maddr_rlock
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|ifma
argument_list|,
argument|&dev->if_multiaddrs
argument_list|,
argument|ifma_link
argument_list|)
block|{
if|if
condition|(
name|ifma
operator|->
name|ifma_addr
operator|->
name|sa_family
operator|!=
name|AF_LINK
condition|)
continue|continue;
if|if
condition|(
operator|(
operator|(
expr|struct
name|sockaddr_dl
operator|*
operator|)
name|ifma
operator|->
name|ifma_addr
operator|)
operator|->
name|sdl_alen
operator|!=
name|ETHER_ADDR_LEN
condition|)
continue|continue;
name|cnt
operator|++
expr_stmt|;
block|}
name|if_maddr_runlock
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|cnt
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|mcaddr
operator|=
name|kmalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|u64
argument_list|)
operator|*
name|cnt
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
name|mcaddr
operator|==
name|NULL
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|i
operator|=
literal|0
expr_stmt|;
name|if_maddr_rlock
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|ifma
argument_list|,
argument|&dev->if_multiaddrs
argument_list|,
argument|ifma_link
argument_list|)
block|{
if|if
condition|(
name|ifma
operator|->
name|ifma_addr
operator|->
name|sa_family
operator|!=
name|AF_LINK
condition|)
continue|continue;
if|if
condition|(
operator|(
operator|(
expr|struct
name|sockaddr_dl
operator|*
operator|)
name|ifma
operator|->
name|ifma_addr
operator|)
operator|->
name|sdl_alen
operator|!=
name|ETHER_ADDR_LEN
condition|)
continue|continue;
comment|/* Make sure the list didn't grow. */
if|if
condition|(
name|i
operator|==
name|cnt
condition|)
block|{
name|if_maddr_runlock
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|mcaddr
argument_list|)
expr_stmt|;
goto|goto
name|restart
goto|;
block|}
name|mcaddr
index|[
name|i
operator|++
index|]
operator|=
name|mlx4_en_mac_to_u64
argument_list|(
name|LLADDR
argument_list|(
operator|(
expr|struct
name|sockaddr_dl
operator|*
operator|)
name|ifma
operator|->
name|ifma_addr
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|if_maddr_runlock
argument_list|(
name|dev
argument_list|)
expr_stmt|;
operator|*
name|mcaddrp
operator|=
name|mcaddr
expr_stmt|;
return|return
operator|(
name|i
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_en_stop_port
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|queue_work
argument_list|(
name|priv
operator|->
name|mdev
operator|->
name|workqueue
argument_list|,
operator|&
name|priv
operator|->
name|stop_port_task
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_en_start_port
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|queue_work
argument_list|(
name|priv
operator|->
name|mdev
operator|->
name|workqueue
argument_list|,
operator|&
name|priv
operator|->
name|start_port_task
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_en_set_multicast
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|priv
operator|->
name|port_up
condition|)
return|return;
name|queue_work
argument_list|(
name|priv
operator|->
name|mdev
operator|->
name|workqueue
argument_list|,
operator|&
name|priv
operator|->
name|mcast_task
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_en_do_set_multicast
parameter_list|(
name|struct
name|work_struct
modifier|*
name|work
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|container_of
argument_list|(
name|work
argument_list|,
expr|struct
name|mlx4_en_priv
argument_list|,
name|mcast_task
argument_list|)
decl_stmt|;
name|struct
name|net_device
modifier|*
name|dev
init|=
name|priv
operator|->
name|dev
decl_stmt|;
name|struct
name|mlx4_en_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|int
name|err
decl_stmt|;
name|mutex_lock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mdev
operator|->
name|device_up
condition|)
block|{
name|en_dbg
argument_list|(
name|HW
argument_list|,
name|priv
argument_list|,
literal|"Card is not up, "
literal|"ignoring multicast change.\n"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
operator|!
name|priv
operator|->
name|port_up
condition|)
block|{
name|en_dbg
argument_list|(
name|HW
argument_list|,
name|priv
argument_list|,
literal|"Port is down, "
literal|"ignoring  multicast change.\n"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* 	 * Promsicuous mode: disable all filters 	 */
if|if
condition|(
name|dev
operator|->
name|if_flags
operator|&
name|IFF_PROMISC
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|priv
operator|->
name|flags
operator|&
name|MLX4_EN_FLAG_PROMISC
operator|)
condition|)
block|{
name|priv
operator|->
name|flags
operator||=
name|MLX4_EN_FLAG_PROMISC
expr_stmt|;
comment|/* Enable promiscouos mode */
name|err
operator|=
name|mlx4_SET_PORT_qpn_calc
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|,
name|priv
operator|->
name|base_qpn
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed enabling "
literal|"promiscous mode\n"
argument_list|)
expr_stmt|;
comment|/* Disable port multicast filter (unconditionally) */
name|err
operator|=
name|mlx4_SET_MCAST_FLTR
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|MLX4_MCAST_DISABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed disabling "
literal|"multicast filter\n"
argument_list|)
expr_stmt|;
comment|/* Disable port VLAN filter */
name|err
operator|=
name|mlx4_SET_VLAN_FLTR
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed disabling VLAN filter\n"
argument_list|)
expr_stmt|;
block|}
goto|goto
name|out
goto|;
block|}
comment|/* 	 * Not in promiscous mode 	 */
if|if
condition|(
name|priv
operator|->
name|flags
operator|&
name|MLX4_EN_FLAG_PROMISC
condition|)
block|{
name|priv
operator|->
name|flags
operator|&=
operator|~
name|MLX4_EN_FLAG_PROMISC
expr_stmt|;
comment|/* Disable promiscouos mode */
name|err
operator|=
name|mlx4_SET_PORT_qpn_calc
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|,
name|priv
operator|->
name|base_qpn
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed disabling promiscous mode\n"
argument_list|)
expr_stmt|;
comment|/* Enable port VLAN filter */
name|err
operator|=
name|mlx4_SET_VLAN_FLTR
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|,
name|priv
operator|->
name|vlans
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed enabling VLAN filter\n"
argument_list|)
expr_stmt|;
block|}
comment|/* Enable/disable the multicast filter according to IFF_ALLMULTI */
if|if
condition|(
name|dev
operator|->
name|if_flags
operator|&
name|IFF_ALLMULTI
condition|)
block|{
name|err
operator|=
name|mlx4_SET_MCAST_FLTR
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|MLX4_MCAST_DISABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed disabling multicast filter\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|u64
modifier|*
name|mcaddr
decl_stmt|;
name|int
name|mccount
decl_stmt|;
name|int
name|i
decl_stmt|;
name|err
operator|=
name|mlx4_SET_MCAST_FLTR
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|MLX4_MCAST_DISABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed disabling multicast filter\n"
argument_list|)
expr_stmt|;
comment|/* Flush mcast filter and init it with broadcast address */
name|mlx4_SET_MCAST_FLTR
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|,
name|ETH_BCAST
argument_list|,
literal|1
argument_list|,
name|MLX4_MCAST_CONFIG
argument_list|)
expr_stmt|;
comment|/* Update multicast list - we cache all addresses so they won't 		 * change while HW is updated holding the command semaphor */
name|mccount
operator|=
name|mlx4_en_cache_mclist
argument_list|(
name|dev
argument_list|,
operator|&
name|mcaddr
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|mccount
condition|;
name|i
operator|++
control|)
name|mlx4_SET_MCAST_FLTR
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|,
name|mcaddr
index|[
name|i
index|]
argument_list|,
literal|0
argument_list|,
name|MLX4_MCAST_CONFIG
argument_list|)
expr_stmt|;
name|err
operator|=
name|mlx4_SET_MCAST_FLTR
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|MLX4_MCAST_ENABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed enabling multicast filter\n"
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|mcaddr
argument_list|)
expr_stmt|;
block|}
name|out
label|:
name|mutex_unlock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_NET_POLL_CONTROLLER
end_ifdef

begin_function
specifier|static
name|void
name|mlx4_en_netpoll
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|mlx4_en_cq
modifier|*
name|cq
decl_stmt|;
name|unsigned
name|long
name|flags
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|rx_ring_num
condition|;
name|i
operator|++
control|)
block|{
name|cq
operator|=
operator|&
name|priv
operator|->
name|rx_cq
index|[
name|i
index|]
expr_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|cq
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|napi_synchronize
argument_list|(
operator|&
name|cq
operator|->
name|napi
argument_list|)
expr_stmt|;
name|mlx4_en_process_rx_cq
argument_list|(
name|dev
argument_list|,
name|cq
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|cq
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|void
name|mlx4_en_watchdog_timeout
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|arg
decl_stmt|;
name|struct
name|mlx4_en_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|en_dbg
argument_list|(
name|DRV
argument_list|,
name|priv
argument_list|,
literal|"Scheduling watchdog\n"
argument_list|)
expr_stmt|;
name|queue_work
argument_list|(
name|mdev
operator|->
name|workqueue
argument_list|,
operator|&
name|priv
operator|->
name|watchdog_task
argument_list|)
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|port_up
condition|)
name|callout_reset
argument_list|(
operator|&
name|priv
operator|->
name|watchdog_timer
argument_list|,
name|MLX4_EN_WATCHDOG_TIMEOUT
argument_list|,
name|mlx4_en_watchdog_timeout
argument_list|,
name|priv
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* XXX This clears user settings in too many cases. */
end_comment

begin_function
specifier|static
name|void
name|mlx4_en_set_default_moderation
parameter_list|(
name|struct
name|mlx4_en_priv
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|mlx4_en_cq
modifier|*
name|cq
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* If we haven't received a specific coalescing setting 	 * (module param), we set the moderation paramters as follows: 	 * - moder_cnt is set to the number of mtu sized packets to 	 *   satisfy our coelsing target. 	 * - moder_time is set to a fixed value. 	 */
name|priv
operator|->
name|rx_frames
operator|=
name|MLX4_EN_RX_COAL_TARGET
operator|/
name|priv
operator|->
name|dev
operator|->
name|if_mtu
operator|+
literal|1
expr_stmt|;
name|priv
operator|->
name|rx_usecs
operator|=
name|MLX4_EN_RX_COAL_TIME
expr_stmt|;
name|en_dbg
argument_list|(
name|INTR
argument_list|,
name|priv
argument_list|,
literal|"Default coalesing params for mtu:%u - "
literal|"rx_frames:%d rx_usecs:%d\n"
argument_list|,
name|priv
operator|->
name|dev
operator|->
name|if_mtu
argument_list|,
name|priv
operator|->
name|rx_frames
argument_list|,
name|priv
operator|->
name|rx_usecs
argument_list|)
expr_stmt|;
comment|/* Setup cq moderation params */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|rx_ring_num
condition|;
name|i
operator|++
control|)
block|{
name|cq
operator|=
operator|&
name|priv
operator|->
name|rx_cq
index|[
name|i
index|]
expr_stmt|;
name|cq
operator|->
name|moder_cnt
operator|=
name|priv
operator|->
name|rx_frames
expr_stmt|;
name|cq
operator|->
name|moder_time
operator|=
name|priv
operator|->
name|rx_usecs
expr_stmt|;
name|priv
operator|->
name|last_moder_time
index|[
name|i
index|]
operator|=
name|MLX4_EN_AUTO_CONF
expr_stmt|;
name|priv
operator|->
name|last_moder_packets
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|priv
operator|->
name|last_moder_bytes
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|tx_ring_num
condition|;
name|i
operator|++
control|)
block|{
name|cq
operator|=
operator|&
name|priv
operator|->
name|tx_cq
index|[
name|i
index|]
expr_stmt|;
name|cq
operator|->
name|moder_cnt
operator|=
name|MLX4_EN_TX_COAL_PKTS
expr_stmt|;
name|cq
operator|->
name|moder_time
operator|=
name|MLX4_EN_TX_COAL_TIME
expr_stmt|;
block|}
comment|/* Reset auto-moderation params */
name|priv
operator|->
name|pkt_rate_low
operator|=
name|MLX4_EN_RX_RATE_LOW
expr_stmt|;
name|priv
operator|->
name|rx_usecs_low
operator|=
name|MLX4_EN_RX_COAL_TIME_LOW
expr_stmt|;
name|priv
operator|->
name|pkt_rate_high
operator|=
name|MLX4_EN_RX_RATE_HIGH
expr_stmt|;
name|priv
operator|->
name|rx_usecs_high
operator|=
name|MLX4_EN_RX_COAL_TIME_HIGH
expr_stmt|;
name|priv
operator|->
name|sample_interval
operator|=
name|MLX4_EN_SAMPLE_INTERVAL
expr_stmt|;
name|priv
operator|->
name|adaptive_rx_coal
operator|=
literal|1
expr_stmt|;
name|priv
operator|->
name|last_moder_jiffies
operator|=
literal|0
expr_stmt|;
name|priv
operator|->
name|last_moder_tx_packets
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_en_auto_moderation
parameter_list|(
name|struct
name|mlx4_en_priv
modifier|*
name|priv
parameter_list|)
block|{
name|unsigned
name|long
name|period
init|=
call|(
name|unsigned
name|long
call|)
argument_list|(
name|jiffies
operator|-
name|priv
operator|->
name|last_moder_jiffies
argument_list|)
decl_stmt|;
name|struct
name|mlx4_en_cq
modifier|*
name|cq
decl_stmt|;
name|unsigned
name|long
name|packets
decl_stmt|;
name|unsigned
name|long
name|rate
decl_stmt|;
name|unsigned
name|long
name|avg_pkt_size
decl_stmt|;
name|unsigned
name|long
name|rx_packets
decl_stmt|;
name|unsigned
name|long
name|rx_bytes
decl_stmt|;
name|unsigned
name|long
name|rx_pkt_diff
decl_stmt|;
name|int
name|moder_time
decl_stmt|;
name|int
name|ring
decl_stmt|,
name|err
decl_stmt|;
if|if
condition|(
operator|!
name|priv
operator|->
name|adaptive_rx_coal
operator|||
name|period
operator|<
name|priv
operator|->
name|sample_interval
operator|*
name|HZ
condition|)
return|return;
for|for
control|(
name|ring
operator|=
literal|0
init|;
name|ring
operator|<
name|priv
operator|->
name|rx_ring_num
condition|;
name|ring
operator|++
control|)
block|{
name|spin_lock
argument_list|(
operator|&
name|priv
operator|->
name|stats_lock
argument_list|)
expr_stmt|;
name|rx_packets
operator|=
name|priv
operator|->
name|rx_ring
index|[
name|ring
index|]
operator|.
name|packets
expr_stmt|;
name|rx_bytes
operator|=
name|priv
operator|->
name|rx_ring
index|[
name|ring
index|]
operator|.
name|bytes
expr_stmt|;
name|spin_unlock
argument_list|(
operator|&
name|priv
operator|->
name|stats_lock
argument_list|)
expr_stmt|;
name|rx_pkt_diff
operator|=
operator|(
call|(
name|unsigned
name|long
call|)
argument_list|(
name|rx_packets
operator|-
name|priv
operator|->
name|last_moder_packets
index|[
name|ring
index|]
argument_list|)
operator|)
expr_stmt|;
name|packets
operator|=
name|rx_pkt_diff
expr_stmt|;
name|rate
operator|=
name|packets
operator|*
name|HZ
operator|/
name|period
expr_stmt|;
name|avg_pkt_size
operator|=
name|packets
condition|?
operator|(
call|(
name|unsigned
name|long
call|)
argument_list|(
name|rx_bytes
operator|-
name|priv
operator|->
name|last_moder_bytes
index|[
name|ring
index|]
argument_list|)
operator|)
operator|/
name|packets
else|:
literal|0
expr_stmt|;
comment|/* Apply auto-moderation only when packet rate 		* exceeds a rate that it matters */
if|if
condition|(
name|rate
operator|>
operator|(
name|MLX4_EN_RX_RATE_THRESH
operator|/
name|priv
operator|->
name|rx_ring_num
operator|)
operator|&&
name|avg_pkt_size
operator|>
name|MLX4_EN_AVG_PKT_SMALL
condition|)
block|{
if|if
condition|(
name|rate
operator|<
name|priv
operator|->
name|pkt_rate_low
operator|||
name|avg_pkt_size
operator|<
name|MLX4_EN_AVG_PKT_SMALL
condition|)
name|moder_time
operator|=
name|priv
operator|->
name|rx_usecs_low
expr_stmt|;
elseif|else
if|if
condition|(
name|rate
operator|>
name|priv
operator|->
name|pkt_rate_high
condition|)
name|moder_time
operator|=
name|priv
operator|->
name|rx_usecs_high
expr_stmt|;
else|else
name|moder_time
operator|=
operator|(
name|rate
operator|-
name|priv
operator|->
name|pkt_rate_low
operator|)
operator|*
operator|(
name|priv
operator|->
name|rx_usecs_high
operator|-
name|priv
operator|->
name|rx_usecs_low
operator|)
operator|/
operator|(
name|priv
operator|->
name|pkt_rate_high
operator|-
name|priv
operator|->
name|pkt_rate_low
operator|)
operator|+
name|priv
operator|->
name|rx_usecs_low
expr_stmt|;
block|}
else|else
block|{
name|moder_time
operator|=
name|priv
operator|->
name|rx_usecs_low
expr_stmt|;
block|}
if|if
condition|(
name|moder_time
operator|!=
name|priv
operator|->
name|last_moder_time
index|[
name|ring
index|]
condition|)
block|{
name|priv
operator|->
name|last_moder_time
index|[
name|ring
index|]
operator|=
name|moder_time
expr_stmt|;
name|cq
operator|=
operator|&
name|priv
operator|->
name|rx_cq
index|[
name|ring
index|]
expr_stmt|;
name|cq
operator|->
name|moder_time
operator|=
name|moder_time
expr_stmt|;
name|err
operator|=
name|mlx4_en_set_cq_moder
argument_list|(
name|priv
argument_list|,
name|cq
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed modifying moderation "
literal|"for cq:%d\n"
argument_list|,
name|ring
argument_list|)
expr_stmt|;
block|}
name|priv
operator|->
name|last_moder_packets
index|[
name|ring
index|]
operator|=
name|rx_packets
expr_stmt|;
name|priv
operator|->
name|last_moder_bytes
index|[
name|ring
index|]
operator|=
name|rx_bytes
expr_stmt|;
block|}
name|priv
operator|->
name|last_moder_jiffies
operator|=
name|jiffies
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_en_handle_vlans
parameter_list|(
name|struct
name|mlx4_en_priv
modifier|*
name|priv
parameter_list|)
block|{
name|u8
name|vlan_register
index|[
name|VLAN_FLTR_SIZE
index|]
decl_stmt|;
name|u8
name|vlan_unregister
index|[
name|VLAN_FLTR_SIZE
index|]
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|idx
decl_stmt|;
name|u16
name|vid
decl_stmt|;
comment|/* cache the vlan data for processing  	 * done under lock to avoid changes during work */
name|spin_lock
argument_list|(
operator|&
name|priv
operator|->
name|vlan_lock
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|VLAN_FLTR_SIZE
condition|;
name|i
operator|++
control|)
block|{
name|vlan_register
index|[
name|i
index|]
operator|=
name|priv
operator|->
name|vlan_register
index|[
name|i
index|]
expr_stmt|;
name|priv
operator|->
name|vlan_register
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|vlan_unregister
index|[
name|i
index|]
operator|=
name|priv
operator|->
name|vlan_unregister
index|[
name|i
index|]
expr_stmt|;
name|priv
operator|->
name|vlan_unregister
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
block|}
name|priv
operator|->
name|vlgrp_modified
operator|=
name|false
expr_stmt|;
name|spin_unlock
argument_list|(
operator|&
name|priv
operator|->
name|vlan_lock
argument_list|)
expr_stmt|;
comment|/* Configure the vlan filter  	 * The vlgrp is updated with all the vids that need to be allowed */
if|if
condition|(
name|mlx4_SET_VLAN_FLTR
argument_list|(
name|priv
operator|->
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|,
name|priv
operator|->
name|vlans
argument_list|)
condition|)
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed configuring VLAN filter\n"
argument_list|)
expr_stmt|;
comment|/* Configure the VLAN table */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|VLAN_FLTR_SIZE
condition|;
name|i
operator|++
control|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|32
condition|;
name|j
operator|++
control|)
block|{
name|vid
operator|=
operator|(
name|i
operator|<<
literal|5
operator|)
operator|+
name|j
expr_stmt|;
if|if
condition|(
name|vlan_register
index|[
name|i
index|]
operator|&
operator|(
literal|1
operator|<<
name|j
operator|)
condition|)
if|if
condition|(
name|mlx4_register_vlan
argument_list|(
name|priv
operator|->
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|,
name|vid
argument_list|,
operator|&
name|idx
argument_list|)
condition|)
name|en_dbg
argument_list|(
name|HW
argument_list|,
name|priv
argument_list|,
literal|"failed registering vlan %d\n"
argument_list|,
name|vid
argument_list|)
expr_stmt|;
if|if
condition|(
name|vlan_unregister
index|[
name|i
index|]
operator|&
operator|(
literal|1
operator|<<
name|j
operator|)
condition|)
block|{
if|if
condition|(
operator|!
name|mlx4_find_cached_vlan
argument_list|(
name|priv
operator|->
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|,
name|vid
argument_list|,
operator|&
name|idx
argument_list|)
condition|)
name|mlx4_unregister_vlan
argument_list|(
name|priv
operator|->
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|,
name|idx
argument_list|)
expr_stmt|;
else|else
name|en_dbg
argument_list|(
name|HW
argument_list|,
name|priv
argument_list|,
literal|"could not find vid %d in cache\n"
argument_list|,
name|vid
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_en_do_get_stats
parameter_list|(
name|struct
name|work_struct
modifier|*
name|work
parameter_list|)
block|{
name|struct
name|delayed_work
modifier|*
name|delay
init|=
name|to_delayed_work
argument_list|(
name|work
argument_list|)
decl_stmt|;
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|container_of
argument_list|(
name|delay
argument_list|,
expr|struct
name|mlx4_en_priv
argument_list|,
name|stats_task
argument_list|)
decl_stmt|;
name|struct
name|mlx4_en_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|int
name|err
decl_stmt|;
name|err
operator|=
name|mlx4_en_DUMP_ETH_STATS
argument_list|(
name|mdev
argument_list|,
name|priv
operator|->
name|port
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|en_dbg
argument_list|(
name|HW
argument_list|,
name|priv
argument_list|,
literal|"Could not update stats \n"
argument_list|)
expr_stmt|;
name|mutex_lock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|mdev
operator|->
name|device_up
condition|)
block|{
if|if
condition|(
name|priv
operator|->
name|port_up
condition|)
block|{
if|if
condition|(
name|priv
operator|->
name|vlgrp_modified
condition|)
name|mlx4_en_handle_vlans
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|mlx4_en_auto_moderation
argument_list|(
name|priv
argument_list|)
expr_stmt|;
block|}
name|queue_delayed_work
argument_list|(
name|mdev
operator|->
name|workqueue
argument_list|,
operator|&
name|priv
operator|->
name|stats_task
argument_list|,
name|STATS_DELAY
argument_list|)
expr_stmt|;
block|}
name|mlx4_en_QUERY_PORT
argument_list|(
name|priv
operator|->
name|mdev
argument_list|,
name|priv
operator|->
name|port
argument_list|)
expr_stmt|;
name|mutex_unlock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_en_linkstate
parameter_list|(
name|struct
name|work_struct
modifier|*
name|work
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|container_of
argument_list|(
name|work
argument_list|,
expr|struct
name|mlx4_en_priv
argument_list|,
name|linkstate_task
argument_list|)
decl_stmt|;
name|struct
name|mlx4_en_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|int
name|linkstate
init|=
name|priv
operator|->
name|link_state
decl_stmt|;
name|mutex_lock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
comment|/* If observable port state changed set carrier state and 	 * report to system log */
if|if
condition|(
name|priv
operator|->
name|last_link_state
operator|!=
name|linkstate
condition|)
block|{
if|if
condition|(
name|linkstate
operator|==
name|MLX4_DEV_EVENT_PORT_DOWN
condition|)
block|{
name|if_link_state_change
argument_list|(
name|priv
operator|->
name|dev
argument_list|,
name|LINK_STATE_DOWN
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|en_info
argument_list|(
name|priv
argument_list|,
literal|"Link Up\n"
argument_list|)
expr_stmt|;
name|if_link_state_change
argument_list|(
name|priv
operator|->
name|dev
argument_list|,
name|LINK_STATE_UP
argument_list|)
expr_stmt|;
block|}
block|}
name|priv
operator|->
name|last_link_state
operator|=
name|linkstate
expr_stmt|;
name|mutex_unlock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_en_lock_and_stop_port
parameter_list|(
name|struct
name|work_struct
modifier|*
name|work
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|container_of
argument_list|(
name|work
argument_list|,
expr|struct
name|mlx4_en_priv
argument_list|,
name|stop_port_task
argument_list|)
decl_stmt|;
name|struct
name|net_device
modifier|*
name|dev
init|=
name|priv
operator|->
name|dev
decl_stmt|;
name|struct
name|mlx4_en_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|mutex_lock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
name|mlx4_en_do_stop_port
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|mutex_unlock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_en_lock_and_start_port
parameter_list|(
name|struct
name|work_struct
modifier|*
name|work
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|container_of
argument_list|(
name|work
argument_list|,
expr|struct
name|mlx4_en_priv
argument_list|,
name|start_port_task
argument_list|)
decl_stmt|;
name|struct
name|net_device
modifier|*
name|dev
init|=
name|priv
operator|->
name|dev
decl_stmt|;
name|struct
name|mlx4_en_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|mutex_lock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
name|mlx4_en_do_start_port
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|mutex_unlock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|mlx4_en_do_start_port
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|mlx4_en_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|struct
name|mlx4_en_cq
modifier|*
name|cq
decl_stmt|;
name|struct
name|mlx4_en_tx_ring
modifier|*
name|tx_ring
decl_stmt|;
name|u64
name|config
decl_stmt|;
name|int
name|rx_index
init|=
literal|0
decl_stmt|;
name|int
name|tx_index
init|=
literal|0
decl_stmt|;
name|int
name|err
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|j
decl_stmt|;
if|if
condition|(
name|priv
operator|->
name|port_up
condition|)
block|{
name|en_dbg
argument_list|(
name|DRV
argument_list|,
name|priv
argument_list|,
literal|"start port called while port already up\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* Calculate Rx buf size */
name|dev
operator|->
name|if_mtu
operator|=
name|min
argument_list|(
name|dev
operator|->
name|if_mtu
argument_list|,
name|priv
operator|->
name|max_mtu
argument_list|)
expr_stmt|;
name|mlx4_en_calc_rx_buf
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|en_dbg
argument_list|(
name|DRV
argument_list|,
name|priv
argument_list|,
literal|"Rx buf size:%d\n"
argument_list|,
name|priv
operator|->
name|rx_mb_size
argument_list|)
expr_stmt|;
comment|/* Configure rx cq's and rings */
name|err
operator|=
name|mlx4_en_activate_rx_rings
argument_list|(
name|priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed to activate RX rings\n"
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|rx_ring_num
condition|;
name|i
operator|++
control|)
block|{
name|cq
operator|=
operator|&
name|priv
operator|->
name|rx_cq
index|[
name|i
index|]
expr_stmt|;
name|err
operator|=
name|mlx4_en_activate_cq
argument_list|(
name|priv
argument_list|,
name|cq
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed activating Rx CQ\n"
argument_list|)
expr_stmt|;
goto|goto
name|cq_err
goto|;
block|}
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|cq
operator|->
name|size
condition|;
name|j
operator|++
control|)
name|cq
operator|->
name|buf
index|[
name|j
index|]
operator|.
name|owner_sr_opcode
operator|=
name|MLX4_CQE_OWNER_MASK
expr_stmt|;
name|err
operator|=
name|mlx4_en_set_cq_moder
argument_list|(
name|priv
argument_list|,
name|cq
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed setting cq moderation parameters"
argument_list|)
expr_stmt|;
name|mlx4_en_deactivate_cq
argument_list|(
name|priv
argument_list|,
name|cq
argument_list|)
expr_stmt|;
goto|goto
name|cq_err
goto|;
block|}
name|mlx4_en_arm_cq
argument_list|(
name|priv
argument_list|,
name|cq
argument_list|)
expr_stmt|;
name|priv
operator|->
name|rx_ring
index|[
name|i
index|]
operator|.
name|cqn
operator|=
name|cq
operator|->
name|mcq
operator|.
name|cqn
expr_stmt|;
operator|++
name|rx_index
expr_stmt|;
block|}
name|err
operator|=
name|mlx4_en_config_rss_steer
argument_list|(
name|priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed configuring rss steering\n"
argument_list|)
expr_stmt|;
goto|goto
name|cq_err
goto|;
block|}
comment|/* Configure tx cq's and rings */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|tx_ring_num
condition|;
name|i
operator|++
control|)
block|{
comment|/* Configure cq */
name|cq
operator|=
operator|&
name|priv
operator|->
name|tx_cq
index|[
name|i
index|]
expr_stmt|;
name|err
operator|=
name|mlx4_en_activate_cq
argument_list|(
name|priv
argument_list|,
name|cq
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed allocating Tx CQ\n"
argument_list|)
expr_stmt|;
goto|goto
name|tx_err
goto|;
block|}
name|err
operator|=
name|mlx4_en_set_cq_moder
argument_list|(
name|priv
argument_list|,
name|cq
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed setting cq moderation parameters"
argument_list|)
expr_stmt|;
name|mlx4_en_deactivate_cq
argument_list|(
name|priv
argument_list|,
name|cq
argument_list|)
expr_stmt|;
goto|goto
name|tx_err
goto|;
block|}
name|en_dbg
argument_list|(
name|DRV
argument_list|,
name|priv
argument_list|,
literal|"Resetting index of collapsed CQ:%d to -1\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|cq
operator|->
name|buf
operator|->
name|wqe_index
operator|=
name|cpu_to_be16
argument_list|(
literal|0xffff
argument_list|)
expr_stmt|;
comment|/* Configure ring */
name|tx_ring
operator|=
operator|&
name|priv
operator|->
name|tx_ring
index|[
name|i
index|]
expr_stmt|;
name|err
operator|=
name|mlx4_en_activate_tx_ring
argument_list|(
name|priv
argument_list|,
name|tx_ring
argument_list|,
name|cq
operator|->
name|mcq
operator|.
name|cqn
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed allocating Tx ring\n"
argument_list|)
expr_stmt|;
name|mlx4_en_deactivate_cq
argument_list|(
name|priv
argument_list|,
name|cq
argument_list|)
expr_stmt|;
goto|goto
name|tx_err
goto|;
block|}
comment|/* Set initial ownership of all Tx TXBBs to SW (1) */
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|tx_ring
operator|->
name|buf_size
condition|;
name|j
operator|+=
name|STAMP_STRIDE
control|)
operator|*
operator|(
operator|(
name|u32
operator|*
operator|)
operator|(
name|tx_ring
operator|->
name|buf
operator|+
name|j
operator|)
operator|)
operator|=
literal|0xffffffff
expr_stmt|;
operator|++
name|tx_index
expr_stmt|;
block|}
comment|/* Configure port */
name|err
operator|=
name|mlx4_SET_PORT_general
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|,
name|priv
operator|->
name|rx_mb_size
operator|+
name|ETHER_CRC_LEN
argument_list|,
name|priv
operator|->
name|prof
operator|->
name|tx_pause
argument_list|,
name|priv
operator|->
name|prof
operator|->
name|tx_ppp
argument_list|,
name|priv
operator|->
name|prof
operator|->
name|rx_pause
argument_list|,
name|priv
operator|->
name|prof
operator|->
name|rx_ppp
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed setting port general configurations "
literal|"for port %d, with error %d\n"
argument_list|,
name|priv
operator|->
name|port
argument_list|,
name|err
argument_list|)
expr_stmt|;
goto|goto
name|tx_err
goto|;
block|}
comment|/* Set default qp number */
name|err
operator|=
name|mlx4_SET_PORT_qpn_calc
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|,
name|priv
operator|->
name|base_qpn
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed setting default qp numbers\n"
argument_list|)
expr_stmt|;
goto|goto
name|tx_err
goto|;
block|}
comment|/* Set port mac number */
name|en_dbg
argument_list|(
name|DRV
argument_list|,
name|priv
argument_list|,
literal|"Setting mac for port %d\n"
argument_list|,
name|priv
operator|->
name|port
argument_list|)
expr_stmt|;
name|err
operator|=
name|mlx4_register_mac
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|,
name|mlx4_en_mac_to_u64
argument_list|(
name|IF_LLADDR
argument_list|(
name|dev
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|<
literal|0
condition|)
block|{
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed setting port mac err=%d\n"
argument_list|,
name|err
argument_list|)
expr_stmt|;
goto|goto
name|tx_err
goto|;
block|}
name|mdev
operator|->
name|mac_removed
index|[
name|priv
operator|->
name|port
index|]
operator|=
literal|0
expr_stmt|;
comment|/* Init port */
name|en_dbg
argument_list|(
name|HW
argument_list|,
name|priv
argument_list|,
literal|"Initializing port\n"
argument_list|)
expr_stmt|;
name|err
operator|=
name|mlx4_INIT_PORT
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed Initializing port\n"
argument_list|)
expr_stmt|;
goto|goto
name|mac_err
goto|;
block|}
comment|/* Set the various hardware offload abilities */
name|dev
operator|->
name|if_hwassist
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|dev
operator|->
name|if_capenable
operator|&
name|IFCAP_TSO4
condition|)
name|dev
operator|->
name|if_hwassist
operator||=
name|CSUM_TSO
expr_stmt|;
if|if
condition|(
name|dev
operator|->
name|if_capenable
operator|&
name|IFCAP_TXCSUM
condition|)
name|dev
operator|->
name|if_hwassist
operator||=
operator|(
name|CSUM_TCP
operator||
name|CSUM_UDP
operator||
name|CSUM_IP
operator|)
expr_stmt|;
if|if
condition|(
name|dev
operator|->
name|if_capenable
operator|&
name|IFCAP_RXCSUM
condition|)
name|priv
operator|->
name|rx_csum
operator|=
literal|1
expr_stmt|;
else|else
name|priv
operator|->
name|rx_csum
operator|=
literal|0
expr_stmt|;
comment|/* set TSO limits so that we don't have to drop TX packets */
name|dev
operator|->
name|if_hw_tsomax
operator|=
literal|65536
operator|-
operator|(
name|ETHER_HDR_LEN
operator|+
name|ETHER_VLAN_ENCAP_LEN
operator|)
expr_stmt|;
name|dev
operator|->
name|if_hw_tsomaxsegcount
operator|=
literal|16
expr_stmt|;
name|dev
operator|->
name|if_hw_tsomaxsegsize
operator|=
literal|65536
expr_stmt|;
comment|/* XXX can do up to 4GByte */
name|err
operator|=
name|mlx4_wol_read
argument_list|(
name|priv
operator|->
name|mdev
operator|->
name|dev
argument_list|,
operator|&
name|config
argument_list|,
name|priv
operator|->
name|port
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed to get WoL info, unable to modify\n"
argument_list|)
expr_stmt|;
goto|goto
name|wol_err
goto|;
block|}
if|if
condition|(
name|dev
operator|->
name|if_capenable
operator|&
name|IFCAP_WOL_MAGIC
condition|)
block|{
name|config
operator||=
name|MLX4_EN_WOL_DO_MODIFY
operator||
name|MLX4_EN_WOL_ENABLED
operator||
name|MLX4_EN_WOL_MAGIC
expr_stmt|;
block|}
else|else
block|{
name|config
operator|&=
operator|~
operator|(
name|MLX4_EN_WOL_ENABLED
operator||
name|MLX4_EN_WOL_MAGIC
operator|)
expr_stmt|;
name|config
operator||=
name|MLX4_EN_WOL_DO_MODIFY
expr_stmt|;
block|}
name|err
operator|=
name|mlx4_wol_write
argument_list|(
name|priv
operator|->
name|mdev
operator|->
name|dev
argument_list|,
name|config
argument_list|,
name|priv
operator|->
name|port
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed to set WoL information\n"
argument_list|)
expr_stmt|;
goto|goto
name|wol_err
goto|;
block|}
name|priv
operator|->
name|port_up
operator|=
name|true
expr_stmt|;
comment|/* Populate multicast list */
name|mlx4_en_set_multicast
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* Enable the queues. */
name|dev
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_OACTIVE
expr_stmt|;
name|dev
operator|->
name|if_drv_flags
operator||=
name|IFF_DRV_RUNNING
expr_stmt|;
name|callout_reset
argument_list|(
operator|&
name|priv
operator|->
name|watchdog_timer
argument_list|,
name|MLX4_EN_WATCHDOG_TIMEOUT
argument_list|,
name|mlx4_en_watchdog_timeout
argument_list|,
name|priv
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|wol_err
label|:
comment|/* close port*/
name|mlx4_CLOSE_PORT
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|)
expr_stmt|;
name|mac_err
label|:
name|mlx4_unregister_mac
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|,
name|priv
operator|->
name|mac
argument_list|)
expr_stmt|;
name|tx_err
label|:
while|while
condition|(
name|tx_index
operator|--
condition|)
block|{
name|mlx4_en_deactivate_tx_ring
argument_list|(
name|priv
argument_list|,
operator|&
name|priv
operator|->
name|tx_ring
index|[
name|tx_index
index|]
argument_list|)
expr_stmt|;
name|mlx4_en_deactivate_cq
argument_list|(
name|priv
argument_list|,
operator|&
name|priv
operator|->
name|tx_cq
index|[
name|tx_index
index|]
argument_list|)
expr_stmt|;
block|}
name|mlx4_en_release_rss_steer
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|cq_err
label|:
while|while
condition|(
name|rx_index
operator|--
condition|)
name|mlx4_en_deactivate_cq
argument_list|(
name|priv
argument_list|,
operator|&
name|priv
operator|->
name|rx_cq
index|[
name|rx_index
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|rx_ring_num
condition|;
name|i
operator|++
control|)
name|mlx4_en_deactivate_rx_ring
argument_list|(
name|priv
argument_list|,
operator|&
name|priv
operator|->
name|rx_ring
index|[
name|i
index|]
argument_list|)
expr_stmt|;
return|return
name|err
return|;
comment|/* need to close devices */
block|}
end_function

begin_function
name|void
name|mlx4_en_do_stop_port
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|mlx4_en_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|priv
operator|->
name|port_up
condition|)
block|{
name|en_dbg
argument_list|(
name|DRV
argument_list|,
name|priv
argument_list|,
literal|"stop port called while port already down\n"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Set port as not active */
name|priv
operator|->
name|port_up
operator|=
name|false
expr_stmt|;
comment|/* Unregister Mac address for the port */
name|mlx4_unregister_mac
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|,
name|priv
operator|->
name|mac
argument_list|)
expr_stmt|;
name|mdev
operator|->
name|mac_removed
index|[
name|priv
operator|->
name|port
index|]
operator|=
literal|1
expr_stmt|;
comment|/* Free TX Rings */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|tx_ring_num
condition|;
name|i
operator|++
control|)
block|{
name|mlx4_en_deactivate_tx_ring
argument_list|(
name|priv
argument_list|,
operator|&
name|priv
operator|->
name|tx_ring
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|mlx4_en_deactivate_cq
argument_list|(
name|priv
argument_list|,
operator|&
name|priv
operator|->
name|tx_cq
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|msleep
argument_list|(
literal|10
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|tx_ring_num
condition|;
name|i
operator|++
control|)
name|mlx4_en_free_tx_buf
argument_list|(
name|dev
argument_list|,
operator|&
name|priv
operator|->
name|tx_ring
index|[
name|i
index|]
argument_list|)
expr_stmt|;
comment|/* Free RSS qps */
name|mlx4_en_release_rss_steer
argument_list|(
name|priv
argument_list|)
expr_stmt|;
comment|/* Free RX Rings */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|rx_ring_num
condition|;
name|i
operator|++
control|)
block|{
name|mlx4_en_deactivate_rx_ring
argument_list|(
name|priv
argument_list|,
operator|&
name|priv
operator|->
name|rx_ring
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|mlx4_en_deactivate_cq
argument_list|(
name|priv
argument_list|,
operator|&
name|priv
operator|->
name|rx_cq
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
comment|/* close port*/
name|mlx4_CLOSE_PORT
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|)
expr_stmt|;
name|callout_stop
argument_list|(
operator|&
name|priv
operator|->
name|watchdog_timer
argument_list|)
expr_stmt|;
name|dev
operator|->
name|if_drv_flags
operator|&=
operator|~
operator|(
name|IFF_DRV_RUNNING
operator||
name|IFF_DRV_OACTIVE
operator|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_en_restart
parameter_list|(
name|struct
name|work_struct
modifier|*
name|work
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|container_of
argument_list|(
name|work
argument_list|,
expr|struct
name|mlx4_en_priv
argument_list|,
name|watchdog_task
argument_list|)
decl_stmt|;
name|struct
name|mlx4_en_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|struct
name|net_device
modifier|*
name|dev
init|=
name|priv
operator|->
name|dev
decl_stmt|;
name|struct
name|mlx4_en_tx_ring
modifier|*
name|ring
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|priv
operator|->
name|blocked
operator|==
literal|0
operator|||
name|priv
operator|->
name|port_up
operator|==
literal|0
condition|)
return|return;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|tx_ring_num
condition|;
name|i
operator|++
control|)
block|{
name|ring
operator|=
operator|&
name|priv
operator|->
name|tx_ring
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|ring
operator|->
name|blocked
operator|&&
name|ring
operator|->
name|watchdog_time
operator|+
name|MLX4_EN_WATCHDOG_TIMEOUT
operator|<
name|ticks
condition|)
goto|goto
name|reset
goto|;
block|}
return|return;
name|reset
label|:
name|priv
operator|->
name|port_stats
operator|.
name|tx_timeout
operator|++
expr_stmt|;
name|en_dbg
argument_list|(
name|DRV
argument_list|,
name|priv
argument_list|,
literal|"Watchdog task called for port %d\n"
argument_list|,
name|priv
operator|->
name|port
argument_list|)
expr_stmt|;
name|mutex_lock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|port_up
condition|)
block|{
name|mlx4_en_do_stop_port
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|mlx4_en_do_start_port
argument_list|(
name|dev
argument_list|)
condition|)
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed restarting port %d\n"
argument_list|,
name|priv
operator|->
name|port
argument_list|)
expr_stmt|;
block|}
name|mutex_unlock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_en_init
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
decl_stmt|;
name|struct
name|mlx4_en_dev
modifier|*
name|mdev
decl_stmt|;
name|priv
operator|=
name|arg
expr_stmt|;
name|mdev
operator|=
name|priv
operator|->
name|mdev
expr_stmt|;
name|mutex_lock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
name|mlx4_en_init_locked
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|mutex_unlock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_en_init_locked
parameter_list|(
name|struct
name|mlx4_en_priv
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|mlx4_en_dev
modifier|*
name|mdev
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|dev
decl_stmt|;
name|int
name|i
decl_stmt|;
name|dev
operator|=
name|priv
operator|->
name|dev
expr_stmt|;
name|mdev
operator|=
name|priv
operator|->
name|mdev
expr_stmt|;
if|if
condition|(
name|dev
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
name|mlx4_en_do_stop_port
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mdev
operator|->
name|device_up
condition|)
block|{
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Cannot open - device down/disabled\n"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Reset HW statistics and performance counters */
if|if
condition|(
name|mlx4_en_DUMP_ETH_STATS
argument_list|(
name|mdev
argument_list|,
name|priv
operator|->
name|port
argument_list|,
literal|1
argument_list|)
condition|)
name|en_dbg
argument_list|(
name|HW
argument_list|,
name|priv
argument_list|,
literal|"Failed dumping statistics\n"
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|priv
operator|->
name|pstats
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|priv
operator|->
name|pstats
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|tx_ring_num
condition|;
name|i
operator|++
control|)
block|{
name|priv
operator|->
name|tx_ring
index|[
name|i
index|]
operator|.
name|bytes
operator|=
literal|0
expr_stmt|;
name|priv
operator|->
name|tx_ring
index|[
name|i
index|]
operator|.
name|packets
operator|=
literal|0
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|rx_ring_num
condition|;
name|i
operator|++
control|)
block|{
name|priv
operator|->
name|rx_ring
index|[
name|i
index|]
operator|.
name|bytes
operator|=
literal|0
expr_stmt|;
name|priv
operator|->
name|rx_ring
index|[
name|i
index|]
operator|.
name|packets
operator|=
literal|0
expr_stmt|;
block|}
name|mlx4_en_set_default_moderation
argument_list|(
name|priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|mlx4_en_do_start_port
argument_list|(
name|dev
argument_list|)
condition|)
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed starting port:%d\n"
argument_list|,
name|priv
operator|->
name|port
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|mlx4_en_free_resources
parameter_list|(
name|struct
name|mlx4_en_priv
modifier|*
name|priv
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|tx_ring_num
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|priv
operator|->
name|tx_ring
index|[
name|i
index|]
operator|.
name|tx_info
condition|)
name|mlx4_en_destroy_tx_ring
argument_list|(
name|priv
argument_list|,
operator|&
name|priv
operator|->
name|tx_ring
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|tx_cq
index|[
name|i
index|]
operator|.
name|buf
condition|)
name|mlx4_en_destroy_cq
argument_list|(
name|priv
argument_list|,
operator|&
name|priv
operator|->
name|tx_cq
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|rx_ring_num
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|priv
operator|->
name|rx_ring
index|[
name|i
index|]
operator|.
name|rx_info
condition|)
name|mlx4_en_destroy_rx_ring
argument_list|(
name|priv
argument_list|,
operator|&
name|priv
operator|->
name|rx_ring
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|rx_cq
index|[
name|i
index|]
operator|.
name|buf
condition|)
name|mlx4_en_destroy_cq
argument_list|(
name|priv
argument_list|,
operator|&
name|priv
operator|->
name|rx_cq
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
comment|/* Free the stats tree when we resize the rings. */
if|if
condition|(
name|priv
operator|->
name|sysctl
condition|)
name|sysctl_ctx_free
argument_list|(
operator|&
name|priv
operator|->
name|stat_ctx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|mlx4_en_alloc_resources
parameter_list|(
name|struct
name|mlx4_en_priv
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|mlx4_en_port_profile
modifier|*
name|prof
init|=
name|priv
operator|->
name|prof
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* Create tx Rings */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|tx_ring_num
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|mlx4_en_create_cq
argument_list|(
name|priv
argument_list|,
operator|&
name|priv
operator|->
name|tx_cq
index|[
name|i
index|]
argument_list|,
name|prof
operator|->
name|tx_ring_size
argument_list|,
name|i
argument_list|,
name|TX
argument_list|)
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
name|mlx4_en_create_tx_ring
argument_list|(
name|priv
argument_list|,
operator|&
name|priv
operator|->
name|tx_ring
index|[
name|i
index|]
argument_list|,
name|prof
operator|->
name|tx_ring_size
argument_list|,
name|TXBB_SIZE
argument_list|)
condition|)
goto|goto
name|err
goto|;
block|}
comment|/* Create rx Rings */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|rx_ring_num
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|mlx4_en_create_cq
argument_list|(
name|priv
argument_list|,
operator|&
name|priv
operator|->
name|rx_cq
index|[
name|i
index|]
argument_list|,
name|prof
operator|->
name|rx_ring_size
argument_list|,
name|i
argument_list|,
name|RX
argument_list|)
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
name|mlx4_en_create_rx_ring
argument_list|(
name|priv
argument_list|,
operator|&
name|priv
operator|->
name|rx_ring
index|[
name|i
index|]
argument_list|,
name|prof
operator|->
name|rx_ring_size
argument_list|)
condition|)
goto|goto
name|err
goto|;
block|}
comment|/* Re-create stat sysctls in case the number of rings changed. */
name|mlx4_en_sysctl_stat
argument_list|(
name|priv
argument_list|)
expr_stmt|;
comment|/* Populate Tx priority mappings */
name|mlx4_en_set_prio_map
argument_list|(
name|priv
argument_list|,
name|priv
operator|->
name|tx_prio_map
argument_list|,
name|priv
operator|->
name|tx_ring_num
operator|-
name|MLX4_EN_NUM_HASH_RINGS
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|err
label|:
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed to allocate NIC resources\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOMEM
return|;
block|}
end_function

begin_function
name|void
name|mlx4_en_destroy_netdev
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|mlx4_en_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|en_dbg
argument_list|(
name|DRV
argument_list|,
name|priv
argument_list|,
literal|"Destroying netdev on port:%d\n"
argument_list|,
name|priv
operator|->
name|port
argument_list|)
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|vlan_attach
operator|!=
name|NULL
condition|)
name|EVENTHANDLER_DEREGISTER
argument_list|(
name|vlan_config
argument_list|,
name|priv
operator|->
name|vlan_attach
argument_list|)
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|vlan_detach
operator|!=
name|NULL
condition|)
name|EVENTHANDLER_DEREGISTER
argument_list|(
name|vlan_unconfig
argument_list|,
name|priv
operator|->
name|vlan_detach
argument_list|)
expr_stmt|;
comment|/* Unregister device - this will close the port if it was up */
if|if
condition|(
name|priv
operator|->
name|registered
condition|)
name|ether_ifdetach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|allocated
condition|)
name|mlx4_free_hwq_res
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
operator|&
name|priv
operator|->
name|res
argument_list|,
name|MLX4_EN_PAGE_SIZE
argument_list|)
expr_stmt|;
name|mutex_lock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
name|mlx4_en_do_stop_port
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|mutex_unlock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
name|cancel_delayed_work
argument_list|(
operator|&
name|priv
operator|->
name|stats_task
argument_list|)
expr_stmt|;
comment|/* flush any pending task for this netdev */
name|flush_workqueue
argument_list|(
name|mdev
operator|->
name|workqueue
argument_list|)
expr_stmt|;
name|callout_drain
argument_list|(
operator|&
name|priv
operator|->
name|watchdog_timer
argument_list|)
expr_stmt|;
comment|/* Detach the netdev so tasks would not attempt to access it */
name|mutex_lock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
name|mdev
operator|->
name|pndev
index|[
name|priv
operator|->
name|port
index|]
operator|=
name|NULL
expr_stmt|;
name|mutex_unlock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
name|mlx4_en_free_resources
argument_list|(
name|priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|sysctl
condition|)
name|sysctl_ctx_free
argument_list|(
operator|&
name|priv
operator|->
name|conf_ctx
argument_list|)
expr_stmt|;
name|mtx_destroy
argument_list|(
operator|&
name|priv
operator|->
name|stats_lock
operator|.
name|m
argument_list|)
expr_stmt|;
name|mtx_destroy
argument_list|(
operator|&
name|priv
operator|->
name|vlan_lock
operator|.
name|m
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|if_free
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_en_change_mtu
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|,
name|int
name|new_mtu
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|mlx4_en_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|int
name|err
init|=
literal|0
decl_stmt|;
name|en_dbg
argument_list|(
name|DRV
argument_list|,
name|priv
argument_list|,
literal|"Change MTU called - current:%u new:%d\n"
argument_list|,
name|dev
operator|->
name|if_mtu
argument_list|,
name|new_mtu
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|new_mtu
operator|<
name|MLX4_EN_MIN_MTU
operator|)
operator|||
operator|(
name|new_mtu
operator|>
name|priv
operator|->
name|max_mtu
operator|)
condition|)
block|{
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Bad MTU size:%d.\n"
argument_list|,
name|new_mtu
argument_list|)
expr_stmt|;
return|return
operator|-
name|EPERM
return|;
block|}
name|mutex_lock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
name|dev
operator|->
name|if_mtu
operator|=
name|new_mtu
expr_stmt|;
if|if
condition|(
name|dev
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
block|{
if|if
condition|(
operator|!
name|mdev
operator|->
name|device_up
condition|)
block|{
comment|/* NIC is probably restarting - let watchdog task reset 			 * the port */
name|en_dbg
argument_list|(
name|DRV
argument_list|,
name|priv
argument_list|,
literal|"Change MTU called with card down!?\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|mlx4_en_do_stop_port
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|mlx4_en_set_default_moderation
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|err
operator|=
name|mlx4_en_do_start_port
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed restarting port:%d\n"
argument_list|,
name|priv
operator|->
name|port
argument_list|)
expr_stmt|;
name|queue_work
argument_list|(
name|mdev
operator|->
name|workqueue
argument_list|,
operator|&
name|priv
operator|->
name|watchdog_task
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|mutex_unlock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_en_calc_media
parameter_list|(
name|struct
name|mlx4_en_priv
modifier|*
name|priv
parameter_list|)
block|{
name|int
name|trans_type
decl_stmt|;
name|int
name|active
decl_stmt|;
name|active
operator|=
name|IFM_ETHER
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|last_link_state
operator|==
name|MLX4_DEV_EVENT_PORT_DOWN
condition|)
return|return
operator|(
name|active
operator|)
return|;
comment|/* 	 * [ShaharK] mlx4_en_QUERY_PORT sleeps and cannot be called under a 	 * non-sleepable lock. 	 * I moved it to the periodic mlx4_en_do_get_stats.  	if (mlx4_en_QUERY_PORT(priv->mdev, priv->port))  		return (active); 	*/
name|active
operator||=
name|IFM_FDX
expr_stmt|;
name|trans_type
operator|=
name|priv
operator|->
name|port_state
operator|.
name|transciver
expr_stmt|;
comment|/* XXX I don't know all of the transceiver values. */
switch|switch
condition|(
name|priv
operator|->
name|port_state
operator|.
name|link_speed
condition|)
block|{
case|case
literal|1000
case|:
name|active
operator||=
name|IFM_1000_T
expr_stmt|;
break|break;
case|case
literal|10000
case|:
if|if
condition|(
name|trans_type
operator|>
literal|0
operator|&&
name|trans_type
operator|<=
literal|0xC
condition|)
name|active
operator||=
name|IFM_10G_SR
expr_stmt|;
elseif|else
if|if
condition|(
name|trans_type
operator|==
literal|0x80
operator|||
name|trans_type
operator|==
literal|0
condition|)
name|active
operator||=
name|IFM_10G_CX4
expr_stmt|;
break|break;
case|case
literal|40000
case|:
name|active
operator||=
name|IFM_40G_CR4
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|priv
operator|->
name|prof
operator|->
name|tx_pause
condition|)
name|active
operator||=
name|IFM_ETH_TXPAUSE
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|prof
operator|->
name|rx_pause
condition|)
name|active
operator||=
name|IFM_ETH_RXPAUSE
expr_stmt|;
return|return
operator|(
name|active
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_en_media_status
parameter_list|(
name|struct
name|ifnet
modifier|*
name|dev
parameter_list|,
name|struct
name|ifmediareq
modifier|*
name|ifmr
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
decl_stmt|;
name|priv
operator|=
name|dev
operator|->
name|if_softc
expr_stmt|;
name|ifmr
operator|->
name|ifm_status
operator|=
name|IFM_AVALID
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|last_link_state
operator|!=
name|MLX4_DEV_EVENT_PORT_DOWN
condition|)
name|ifmr
operator|->
name|ifm_status
operator||=
name|IFM_ACTIVE
expr_stmt|;
name|ifmr
operator|->
name|ifm_active
operator|=
name|mlx4_en_calc_media
argument_list|(
name|priv
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_en_media_change
parameter_list|(
name|struct
name|ifnet
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
decl_stmt|;
name|struct
name|ifmedia
modifier|*
name|ifm
decl_stmt|;
name|int
name|rxpause
decl_stmt|;
name|int
name|txpause
decl_stmt|;
name|int
name|error
decl_stmt|;
name|priv
operator|=
name|dev
operator|->
name|if_softc
expr_stmt|;
name|ifm
operator|=
operator|&
name|priv
operator|->
name|media
expr_stmt|;
name|rxpause
operator|=
name|txpause
operator|=
literal|0
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|IFM_TYPE
argument_list|(
name|ifm
operator|->
name|ifm_media
argument_list|)
operator|!=
name|IFM_ETHER
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
switch|switch
condition|(
name|IFM_SUBTYPE
argument_list|(
name|ifm
operator|->
name|ifm_media
argument_list|)
condition|)
block|{
case|case
name|IFM_AUTO
case|:
break|break;
case|case
name|IFM_10G_SR
case|:
case|case
name|IFM_10G_CX4
case|:
case|case
name|IFM_1000_T
case|:
if|if
condition|(
name|IFM_SUBTYPE
argument_list|(
name|ifm
operator|->
name|ifm_media
argument_list|)
operator|==
name|IFM_SUBTYPE
argument_list|(
name|mlx4_en_calc_media
argument_list|(
name|priv
argument_list|)
argument_list|)
operator|&&
operator|(
name|ifm
operator|->
name|ifm_media
operator|&
name|IFM_FDX
operator|)
condition|)
break|break;
comment|/* Fallthrough */
default|default:
name|printf
argument_list|(
literal|"%s: Only auto media type\n"
argument_list|,
name|if_name
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
comment|/* Allow user to set/clear pause */
if|if
condition|(
name|IFM_OPTIONS
argument_list|(
name|ifm
operator|->
name|ifm_media
argument_list|)
operator|&
name|IFM_ETH_RXPAUSE
condition|)
name|rxpause
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|IFM_OPTIONS
argument_list|(
name|ifm
operator|->
name|ifm_media
argument_list|)
operator|&
name|IFM_ETH_TXPAUSE
condition|)
name|txpause
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|prof
operator|->
name|tx_pause
operator|!=
name|txpause
operator|||
name|priv
operator|->
name|prof
operator|->
name|rx_pause
operator|!=
name|rxpause
condition|)
block|{
name|priv
operator|->
name|prof
operator|->
name|tx_pause
operator|=
name|txpause
expr_stmt|;
name|priv
operator|->
name|prof
operator|->
name|rx_pause
operator|=
name|rxpause
expr_stmt|;
name|error
operator|=
operator|-
name|mlx4_SET_PORT_general
argument_list|(
name|priv
operator|->
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|,
name|priv
operator|->
name|rx_mb_size
operator|+
name|ETHER_CRC_LEN
argument_list|,
name|priv
operator|->
name|prof
operator|->
name|tx_pause
argument_list|,
name|priv
operator|->
name|prof
operator|->
name|tx_ppp
argument_list|,
name|priv
operator|->
name|prof
operator|->
name|rx_pause
argument_list|,
name|priv
operator|->
name|prof
operator|->
name|rx_ppp
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_en_ioctl
parameter_list|(
name|struct
name|ifnet
modifier|*
name|dev
parameter_list|,
name|u_long
name|command
parameter_list|,
name|caddr_t
name|data
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
decl_stmt|;
name|struct
name|mlx4_en_dev
modifier|*
name|mdev
decl_stmt|;
name|struct
name|ifreq
modifier|*
name|ifr
decl_stmt|;
name|int
name|error
decl_stmt|;
name|int
name|mask
decl_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
name|mask
operator|=
literal|0
expr_stmt|;
name|priv
operator|=
name|dev
operator|->
name|if_softc
expr_stmt|;
name|mdev
operator|=
name|priv
operator|->
name|mdev
expr_stmt|;
name|ifr
operator|=
operator|(
expr|struct
name|ifreq
operator|*
operator|)
name|data
expr_stmt|;
switch|switch
condition|(
name|command
condition|)
block|{
case|case
name|SIOCSIFMTU
case|:
name|error
operator|=
operator|-
name|mlx4_en_change_mtu
argument_list|(
name|dev
argument_list|,
name|ifr
operator|->
name|ifr_mtu
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCSIFFLAGS
case|:
if|if
condition|(
name|dev
operator|->
name|if_flags
operator|&
name|IFF_UP
condition|)
block|{
if|if
condition|(
operator|(
name|dev
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
operator|==
literal|0
condition|)
name|mlx4_en_start_port
argument_list|(
name|dev
argument_list|)
expr_stmt|;
else|else
name|mlx4_en_set_multicast
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|dev
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
block|{
name|mlx4_en_stop_port
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|if_link_state_change
argument_list|(
name|dev
argument_list|,
name|LINK_STATE_DOWN
argument_list|)
expr_stmt|;
comment|/* 				 * Since mlx4_en_stop_port is defered we 				 * have to wait till it's finished. 				 */
for|for
control|(
name|int
name|count
init|=
literal|0
init|;
name|count
operator|<
literal|10
condition|;
name|count
operator|++
control|)
block|{
if|if
condition|(
name|dev
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
block|{
name|DELAY
argument_list|(
literal|20000
argument_list|)
expr_stmt|;
block|}
else|else
block|{
break|break;
block|}
block|}
block|}
block|}
break|break;
case|case
name|SIOCADDMULTI
case|:
case|case
name|SIOCDELMULTI
case|:
name|mlx4_en_set_multicast
argument_list|(
name|dev
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCSIFMEDIA
case|:
case|case
name|SIOCGIFMEDIA
case|:
name|error
operator|=
name|ifmedia_ioctl
argument_list|(
name|dev
argument_list|,
name|ifr
argument_list|,
operator|&
name|priv
operator|->
name|media
argument_list|,
name|command
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCSIFCAP
case|:
name|mutex_lock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
name|mask
operator|=
name|ifr
operator|->
name|ifr_reqcap
operator|^
name|dev
operator|->
name|if_capenable
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|IFCAP_HWCSUM
condition|)
name|dev
operator|->
name|if_capenable
operator|^=
name|IFCAP_HWCSUM
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|IFCAP_TSO4
condition|)
name|dev
operator|->
name|if_capenable
operator|^=
name|IFCAP_TSO4
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|IFCAP_LRO
condition|)
name|dev
operator|->
name|if_capenable
operator|^=
name|IFCAP_LRO
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|IFCAP_VLAN_HWTAGGING
condition|)
name|dev
operator|->
name|if_capenable
operator|^=
name|IFCAP_VLAN_HWTAGGING
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|IFCAP_VLAN_HWFILTER
condition|)
name|dev
operator|->
name|if_capenable
operator|^=
name|IFCAP_VLAN_HWFILTER
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|IFCAP_WOL_MAGIC
condition|)
name|dev
operator|->
name|if_capenable
operator|^=
name|IFCAP_WOL_MAGIC
expr_stmt|;
if|if
condition|(
name|dev
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
name|mlx4_en_init_locked
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|mutex_unlock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
name|VLAN_CAPABILITIES
argument_list|(
name|dev
argument_list|)
expr_stmt|;
break|break;
default|default:
name|error
operator|=
name|ether_ioctl
argument_list|(
name|dev
argument_list|,
name|command
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_en_set_ring_size
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|,
name|int
name|rx_size
parameter_list|,
name|int
name|tx_size
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|mlx4_en_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|int
name|port_up
init|=
literal|0
decl_stmt|;
name|int
name|err
init|=
literal|0
decl_stmt|;
name|rx_size
operator|=
name|roundup_pow_of_two
argument_list|(
name|rx_size
argument_list|)
expr_stmt|;
name|rx_size
operator|=
name|max_t
argument_list|(
name|u32
argument_list|,
name|rx_size
argument_list|,
name|MLX4_EN_MIN_RX_SIZE
argument_list|)
expr_stmt|;
name|rx_size
operator|=
name|min_t
argument_list|(
name|u32
argument_list|,
name|rx_size
argument_list|,
name|MLX4_EN_MAX_RX_SIZE
argument_list|)
expr_stmt|;
name|tx_size
operator|=
name|roundup_pow_of_two
argument_list|(
name|tx_size
argument_list|)
expr_stmt|;
name|tx_size
operator|=
name|max_t
argument_list|(
name|u32
argument_list|,
name|tx_size
argument_list|,
name|MLX4_EN_MIN_TX_SIZE
argument_list|)
expr_stmt|;
name|tx_size
operator|=
name|min_t
argument_list|(
name|u32
argument_list|,
name|tx_size
argument_list|,
name|MLX4_EN_MAX_TX_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|rx_size
operator|==
operator|(
name|priv
operator|->
name|port_up
condition|?
name|priv
operator|->
name|rx_ring
index|[
literal|0
index|]
operator|.
name|actual_size
else|:
name|priv
operator|->
name|rx_ring
index|[
literal|0
index|]
operator|.
name|size
operator|)
operator|&&
name|tx_size
operator|==
name|priv
operator|->
name|tx_ring
index|[
literal|0
index|]
operator|.
name|size
condition|)
return|return
literal|0
return|;
name|mutex_lock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|port_up
condition|)
block|{
name|port_up
operator|=
literal|1
expr_stmt|;
name|mlx4_en_do_stop_port
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
name|mlx4_en_free_resources
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|priv
operator|->
name|prof
operator|->
name|tx_ring_size
operator|=
name|tx_size
expr_stmt|;
name|priv
operator|->
name|prof
operator|->
name|rx_ring_size
operator|=
name|rx_size
expr_stmt|;
name|err
operator|=
name|mlx4_en_alloc_resources
argument_list|(
name|priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed reallocating port resources\n"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|port_up
condition|)
block|{
name|err
operator|=
name|mlx4_en_do_start_port
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed starting port\n"
argument_list|)
expr_stmt|;
block|}
name|out
label|:
name|mutex_unlock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_en_set_rx_ring_size
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
decl_stmt|;
name|int
name|size
decl_stmt|;
name|int
name|error
decl_stmt|;
name|priv
operator|=
name|arg1
expr_stmt|;
name|size
operator|=
name|priv
operator|->
name|prof
operator|->
name|rx_ring_size
expr_stmt|;
name|error
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|size
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|||
operator|!
name|req
operator|->
name|newptr
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|error
operator|=
operator|-
name|mlx4_en_set_ring_size
argument_list|(
name|priv
operator|->
name|dev
argument_list|,
name|size
argument_list|,
name|priv
operator|->
name|prof
operator|->
name|tx_ring_size
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_en_set_tx_ring_size
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
decl_stmt|;
name|int
name|size
decl_stmt|;
name|int
name|error
decl_stmt|;
name|priv
operator|=
name|arg1
expr_stmt|;
name|size
operator|=
name|priv
operator|->
name|prof
operator|->
name|tx_ring_size
expr_stmt|;
name|error
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|size
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|||
operator|!
name|req
operator|->
name|newptr
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|error
operator|=
operator|-
name|mlx4_en_set_ring_size
argument_list|(
name|priv
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|prof
operator|->
name|rx_ring_size
argument_list|,
name|size
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_en_set_tx_ppp
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
decl_stmt|;
name|int
name|ppp
decl_stmt|;
name|int
name|error
decl_stmt|;
name|priv
operator|=
name|arg1
expr_stmt|;
name|ppp
operator|=
name|priv
operator|->
name|prof
operator|->
name|tx_ppp
expr_stmt|;
name|error
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|ppp
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|||
operator|!
name|req
operator|->
name|newptr
condition|)
return|return
operator|(
name|error
operator|)
return|;
if|if
condition|(
name|ppp
operator|>
literal|0xff
operator|||
name|ppp
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
name|EINVAL
operator|)
return|;
name|priv
operator|->
name|prof
operator|->
name|tx_ppp
operator|=
name|ppp
expr_stmt|;
name|error
operator|=
operator|-
name|mlx4_SET_PORT_general
argument_list|(
name|priv
operator|->
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|,
name|priv
operator|->
name|rx_mb_size
operator|+
name|ETHER_CRC_LEN
argument_list|,
name|priv
operator|->
name|prof
operator|->
name|tx_pause
argument_list|,
name|priv
operator|->
name|prof
operator|->
name|tx_ppp
argument_list|,
name|priv
operator|->
name|prof
operator|->
name|rx_pause
argument_list|,
name|priv
operator|->
name|prof
operator|->
name|rx_ppp
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_en_set_rx_ppp
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
decl_stmt|;
name|struct
name|mlx4_en_dev
modifier|*
name|mdev
decl_stmt|;
name|int
name|tx_ring_num
decl_stmt|;
name|int
name|ppp
decl_stmt|;
name|int
name|error
decl_stmt|;
name|int
name|port_up
decl_stmt|;
name|port_up
operator|=
literal|0
expr_stmt|;
name|priv
operator|=
name|arg1
expr_stmt|;
name|mdev
operator|=
name|priv
operator|->
name|mdev
expr_stmt|;
name|ppp
operator|=
name|priv
operator|->
name|prof
operator|->
name|rx_ppp
expr_stmt|;
name|error
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|ppp
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|||
operator|!
name|req
operator|->
name|newptr
condition|)
return|return
operator|(
name|error
operator|)
return|;
if|if
condition|(
name|ppp
operator|>
literal|0xff
operator|||
name|ppp
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
name|EINVAL
operator|)
return|;
comment|/* See if we have to change the number of tx queues. */
if|if
condition|(
operator|!
name|ppp
operator|!=
operator|!
name|priv
operator|->
name|prof
operator|->
name|rx_ppp
condition|)
block|{
name|tx_ring_num
operator|=
name|MLX4_EN_NUM_HASH_RINGS
operator|+
literal|1
operator|+
operator|(
operator|!
operator|!
name|ppp
operator|)
operator|*
name|MLX4_EN_NUM_PPP_RINGS
expr_stmt|;
name|mutex_lock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|port_up
condition|)
block|{
name|port_up
operator|=
literal|1
expr_stmt|;
name|mlx4_en_do_stop_port
argument_list|(
name|priv
operator|->
name|dev
argument_list|)
expr_stmt|;
block|}
name|mlx4_en_free_resources
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|priv
operator|->
name|tx_ring_num
operator|=
name|tx_ring_num
expr_stmt|;
name|priv
operator|->
name|prof
operator|->
name|rx_ppp
operator|=
name|ppp
expr_stmt|;
name|error
operator|=
operator|-
name|mlx4_en_alloc_resources
argument_list|(
name|priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed reallocating port resources\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
operator|&&
name|port_up
condition|)
block|{
name|error
operator|=
operator|-
name|mlx4_en_do_start_port
argument_list|(
name|priv
operator|->
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed starting port\n"
argument_list|)
expr_stmt|;
block|}
name|mutex_unlock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|priv
operator|->
name|prof
operator|->
name|rx_ppp
operator|=
name|ppp
expr_stmt|;
name|error
operator|=
operator|-
name|mlx4_SET_PORT_general
argument_list|(
name|priv
operator|->
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|,
name|priv
operator|->
name|rx_mb_size
operator|+
name|ETHER_CRC_LEN
argument_list|,
name|priv
operator|->
name|prof
operator|->
name|tx_pause
argument_list|,
name|priv
operator|->
name|prof
operator|->
name|tx_ppp
argument_list|,
name|priv
operator|->
name|prof
operator|->
name|rx_pause
argument_list|,
name|priv
operator|->
name|prof
operator|->
name|rx_ppp
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_en_sysctl_conf
parameter_list|(
name|struct
name|mlx4_en_priv
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|net_device
modifier|*
name|dev
decl_stmt|;
name|struct
name|sysctl_ctx_list
modifier|*
name|ctx
decl_stmt|;
name|struct
name|sysctl_oid
modifier|*
name|node
decl_stmt|;
name|struct
name|sysctl_oid_list
modifier|*
name|node_list
decl_stmt|;
name|struct
name|sysctl_oid
modifier|*
name|coal
decl_stmt|;
name|struct
name|sysctl_oid_list
modifier|*
name|coal_list
decl_stmt|;
name|dev
operator|=
name|priv
operator|->
name|dev
expr_stmt|;
name|ctx
operator|=
operator|&
name|priv
operator|->
name|conf_ctx
expr_stmt|;
name|sysctl_ctx_init
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
name|priv
operator|->
name|sysctl
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_STATIC_CHILDREN
argument_list|(
name|_hw
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
name|dev
operator|->
name|if_xname
argument_list|,
name|CTLFLAG_RD
argument_list|,
literal|0
argument_list|,
literal|"mlx4 10gig ethernet"
argument_list|)
expr_stmt|;
name|node
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|priv
operator|->
name|sysctl
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"conf"
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|NULL
argument_list|,
literal|"Configuration"
argument_list|)
expr_stmt|;
name|node_list
operator|=
name|SYSCTL_CHILDREN
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"msg_enable"
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|priv
operator|->
name|msg_enable
argument_list|,
literal|0
argument_list|,
literal|"Driver message enable bitfield"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_rings"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|rx_ring_num
argument_list|,
literal|0
argument_list|,
literal|"Number of receive rings"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_rings"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|tx_ring_num
argument_list|,
literal|0
argument_list|,
literal|"Number of transmit rings"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_size"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RW
operator||
name|CTLFLAG_MPSAFE
argument_list|,
name|priv
argument_list|,
literal|0
argument_list|,
name|mlx4_en_set_rx_ring_size
argument_list|,
literal|"I"
argument_list|,
literal|"Receive ring size"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_size"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RW
operator||
name|CTLFLAG_MPSAFE
argument_list|,
name|priv
argument_list|,
literal|0
argument_list|,
name|mlx4_en_set_tx_ring_size
argument_list|,
literal|"I"
argument_list|,
literal|"Transmit ring size"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"ip_reasm"
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|priv
operator|->
name|ip_reasm
argument_list|,
literal|0
argument_list|,
literal|"Allow reassembly of IP fragments."
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_ppp"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RW
operator||
name|CTLFLAG_MPSAFE
argument_list|,
name|priv
argument_list|,
literal|0
argument_list|,
name|mlx4_en_set_tx_ppp
argument_list|,
literal|"I"
argument_list|,
literal|"TX Per-priority pause"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_ppp"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RW
operator||
name|CTLFLAG_MPSAFE
argument_list|,
name|priv
argument_list|,
literal|0
argument_list|,
name|mlx4_en_set_rx_ppp
argument_list|,
literal|"I"
argument_list|,
literal|"RX Per-priority pause"
argument_list|)
expr_stmt|;
comment|/* Add coalescer configuration. */
name|coal
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"coalesce"
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|NULL
argument_list|,
literal|"Interrupt coalesce configuration"
argument_list|)
expr_stmt|;
name|coal_list
operator|=
name|SYSCTL_CHILDREN
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|coal_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"pkt_rate_low"
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|priv
operator|->
name|pkt_rate_low
argument_list|,
literal|0
argument_list|,
literal|"Packets per-second for minimum delay"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|coal_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_usecs_low"
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|priv
operator|->
name|rx_usecs_low
argument_list|,
literal|0
argument_list|,
literal|"Minimum RX delay in micro-seconds"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|coal_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"pkt_rate_high"
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|priv
operator|->
name|pkt_rate_high
argument_list|,
literal|0
argument_list|,
literal|"Packets per-second for maximum delay"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|coal_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_usecs_high"
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|priv
operator|->
name|rx_usecs_high
argument_list|,
literal|0
argument_list|,
literal|"Maximum RX delay in micro-seconds"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|coal_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"sample_interval"
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|priv
operator|->
name|sample_interval
argument_list|,
literal|0
argument_list|,
literal|"adaptive frequency in units of HZ ticks"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|coal_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"adaptive_rx_coal"
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|priv
operator|->
name|adaptive_rx_coal
argument_list|,
literal|0
argument_list|,
literal|"Enable adaptive rx coalescing"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_en_sysctl_stat
parameter_list|(
name|struct
name|mlx4_en_priv
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|net_device
modifier|*
name|dev
decl_stmt|;
name|struct
name|sysctl_ctx_list
modifier|*
name|ctx
decl_stmt|;
name|struct
name|sysctl_oid
modifier|*
name|node
decl_stmt|;
name|struct
name|sysctl_oid_list
modifier|*
name|node_list
decl_stmt|;
name|struct
name|sysctl_oid
modifier|*
name|ring_node
decl_stmt|;
name|struct
name|sysctl_oid_list
modifier|*
name|ring_list
decl_stmt|;
name|struct
name|mlx4_en_tx_ring
modifier|*
name|tx_ring
decl_stmt|;
name|struct
name|mlx4_en_rx_ring
modifier|*
name|rx_ring
decl_stmt|;
name|char
name|namebuf
index|[
literal|128
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
name|dev
operator|=
name|priv
operator|->
name|dev
expr_stmt|;
name|ctx
operator|=
operator|&
name|priv
operator|->
name|stat_ctx
expr_stmt|;
name|sysctl_ctx_init
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
name|node
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|priv
operator|->
name|sysctl
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"stat"
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|NULL
argument_list|,
literal|"Statistics"
argument_list|)
expr_stmt|;
name|node_list
operator|=
name|SYSCTL_CHILDREN
argument_list|(
name|node
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MLX4_EN_PERF_STAT
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_poll"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pstats
operator|.
name|tx_poll
argument_list|,
literal|"TX Poll calls"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_pktsz_avg"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pstats
operator|.
name|tx_pktsz_avg
argument_list|,
literal|"TX average packet size"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"inflight_avg"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pstats
operator|.
name|inflight_avg
argument_list|,
literal|"TX average packets in-flight"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_coal_avg"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pstats
operator|.
name|tx_coal_avg
argument_list|,
literal|"TX average coalesced completions"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_coal_avg"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pstats
operator|.
name|rx_coal_avg
argument_list|,
literal|"RX average coalesced completions"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tso_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|port_stats
operator|.
name|tso_packets
argument_list|,
literal|"TSO packets sent"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"queue_stopped"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|port_stats
operator|.
name|queue_stopped
argument_list|,
literal|"Queue full"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"wake_queue"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|port_stats
operator|.
name|wake_queue
argument_list|,
literal|"Queue resumed after full"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_timeout"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|port_stats
operator|.
name|tx_timeout
argument_list|,
literal|"Transmit timeouts"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_alloc_failed"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|port_stats
operator|.
name|rx_alloc_failed
argument_list|,
literal|"RX failed to allocate mbuf"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_chksum_good"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|port_stats
operator|.
name|rx_chksum_good
argument_list|,
literal|"RX checksum offload success"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_chksum_none"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|port_stats
operator|.
name|rx_chksum_none
argument_list|,
literal|"RX without checksum offload"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_chksum_offload"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|port_stats
operator|.
name|tx_chksum_offload
argument_list|,
literal|"TX checksum offloads"
argument_list|)
expr_stmt|;
comment|/* Could strdup the names and add in a loop.  This is simpler. */
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"broadcast"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pkstats
operator|.
name|broadcast
argument_list|,
literal|"Broadcast packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_prio0"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pkstats
operator|.
name|tx_prio
index|[
literal|0
index|]
argument_list|,
literal|"TX Priority 0 packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_prio1"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pkstats
operator|.
name|tx_prio
index|[
literal|1
index|]
argument_list|,
literal|"TX Priority 1 packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_prio2"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pkstats
operator|.
name|tx_prio
index|[
literal|2
index|]
argument_list|,
literal|"TX Priority 2 packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_prio3"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pkstats
operator|.
name|tx_prio
index|[
literal|3
index|]
argument_list|,
literal|"TX Priority 3 packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_prio4"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pkstats
operator|.
name|tx_prio
index|[
literal|4
index|]
argument_list|,
literal|"TX Priority 4 packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_prio5"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pkstats
operator|.
name|tx_prio
index|[
literal|5
index|]
argument_list|,
literal|"TX Priority 5 packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_prio6"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pkstats
operator|.
name|tx_prio
index|[
literal|6
index|]
argument_list|,
literal|"TX Priority 6 packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_prio7"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pkstats
operator|.
name|tx_prio
index|[
literal|7
index|]
argument_list|,
literal|"TX Priority 7 packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_prio0"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pkstats
operator|.
name|rx_prio
index|[
literal|0
index|]
argument_list|,
literal|"RX Priority 0 packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_prio1"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pkstats
operator|.
name|rx_prio
index|[
literal|1
index|]
argument_list|,
literal|"RX Priority 1 packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_prio2"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pkstats
operator|.
name|rx_prio
index|[
literal|2
index|]
argument_list|,
literal|"RX Priority 2 packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_prio3"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pkstats
operator|.
name|rx_prio
index|[
literal|3
index|]
argument_list|,
literal|"RX Priority 3 packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_prio4"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pkstats
operator|.
name|rx_prio
index|[
literal|4
index|]
argument_list|,
literal|"RX Priority 4 packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_prio5"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pkstats
operator|.
name|rx_prio
index|[
literal|5
index|]
argument_list|,
literal|"RX Priority 5 packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_prio6"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pkstats
operator|.
name|rx_prio
index|[
literal|6
index|]
argument_list|,
literal|"RX Priority 6 packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_prio7"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pkstats
operator|.
name|rx_prio
index|[
literal|7
index|]
argument_list|,
literal|"RX Priority 7 packets"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|tx_ring_num
condition|;
name|i
operator|++
control|)
block|{
name|tx_ring
operator|=
operator|&
name|priv
operator|->
name|tx_ring
index|[
name|i
index|]
expr_stmt|;
name|snprintf
argument_list|(
name|namebuf
argument_list|,
sizeof|sizeof
argument_list|(
name|namebuf
argument_list|)
argument_list|,
literal|"tx_ring%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|ring_node
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
name|namebuf
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|NULL
argument_list|,
literal|"TX Ring"
argument_list|)
expr_stmt|;
name|ring_list
operator|=
name|SYSCTL_CHILDREN
argument_list|(
name|ring_node
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|ring_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|tx_ring
operator|->
name|packets
argument_list|,
literal|"TX packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|ring_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"bytes"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|tx_ring
operator|->
name|bytes
argument_list|,
literal|"TX bytes"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|ring_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"error"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|tx_ring
operator|->
name|errors
argument_list|,
literal|"TX soft errors"
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|rx_ring_num
condition|;
name|i
operator|++
control|)
block|{
name|rx_ring
operator|=
operator|&
name|priv
operator|->
name|rx_ring
index|[
name|i
index|]
expr_stmt|;
name|snprintf
argument_list|(
name|namebuf
argument_list|,
sizeof|sizeof
argument_list|(
name|namebuf
argument_list|)
argument_list|,
literal|"rx_ring%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|ring_node
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
name|namebuf
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|NULL
argument_list|,
literal|"RX Ring"
argument_list|)
expr_stmt|;
name|ring_list
operator|=
name|SYSCTL_CHILDREN
argument_list|(
name|ring_node
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|ring_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|rx_ring
operator|->
name|packets
argument_list|,
literal|"RX packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|ring_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"bytes"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|rx_ring
operator|->
name|bytes
argument_list|,
literal|"RX bytes"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|ring_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"error"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|rx_ring
operator|->
name|errors
argument_list|,
literal|"RX soft errors"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|ring_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"lro_queued"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|rx_ring
operator|->
name|lro
operator|.
name|lro_queued
argument_list|,
literal|0
argument_list|,
literal|"LRO Queued"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|ring_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"lro_flushed"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|rx_ring
operator|->
name|lro
operator|.
name|lro_flushed
argument_list|,
literal|0
argument_list|,
literal|"LRO Flushed"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|mlx4_en_init_netdev
parameter_list|(
name|struct
name|mlx4_en_dev
modifier|*
name|mdev
parameter_list|,
name|int
name|port
parameter_list|,
name|struct
name|mlx4_en_port_profile
modifier|*
name|prof
parameter_list|)
block|{
specifier|static
specifier|volatile
name|int
name|mlx4_en_unit
decl_stmt|;
name|struct
name|net_device
modifier|*
name|dev
decl_stmt|;
name|struct
name|mlx4_en_priv
modifier|*
name|priv
decl_stmt|;
name|uint8_t
name|dev_addr
index|[
name|ETHER_ADDR_LEN
index|]
decl_stmt|;
name|int
name|err
decl_stmt|;
name|int
name|i
decl_stmt|;
name|priv
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|priv
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
name|dev
operator|=
name|priv
operator|->
name|dev
operator|=
name|if_alloc
argument_list|(
name|IFT_ETHER
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev
operator|==
name|NULL
condition|)
block|{
name|mlx4_err
argument_list|(
name|mdev
argument_list|,
literal|"Net device allocation failed\n"
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|priv
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOMEM
return|;
block|}
name|dev
operator|->
name|if_softc
operator|=
name|priv
expr_stmt|;
name|if_initname
argument_list|(
name|dev
argument_list|,
literal|"mlxen"
argument_list|,
name|atomic_fetchadd_int
argument_list|(
operator|&
name|mlx4_en_unit
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|dev
operator|->
name|if_mtu
operator|=
name|ETHERMTU
expr_stmt|;
name|dev
operator|->
name|if_baudrate
operator|=
literal|1000000000
expr_stmt|;
name|dev
operator|->
name|if_init
operator|=
name|mlx4_en_init
expr_stmt|;
name|dev
operator|->
name|if_flags
operator|=
name|IFF_BROADCAST
operator||
name|IFF_SIMPLEX
operator||
name|IFF_MULTICAST
expr_stmt|;
name|dev
operator|->
name|if_ioctl
operator|=
name|mlx4_en_ioctl
expr_stmt|;
name|dev
operator|->
name|if_transmit
operator|=
name|mlx4_en_transmit
expr_stmt|;
name|dev
operator|->
name|if_qflush
operator|=
name|mlx4_en_qflush
expr_stmt|;
name|dev
operator|->
name|if_snd
operator|.
name|ifq_maxlen
operator|=
name|prof
operator|->
name|tx_ring_size
expr_stmt|;
comment|/* 	 * Initialize driver private data 	 */
name|priv
operator|->
name|dev
operator|=
name|dev
expr_stmt|;
name|priv
operator|->
name|mdev
operator|=
name|mdev
expr_stmt|;
name|priv
operator|->
name|prof
operator|=
name|prof
expr_stmt|;
name|priv
operator|->
name|port
operator|=
name|port
expr_stmt|;
name|priv
operator|->
name|port_up
operator|=
name|false
expr_stmt|;
name|priv
operator|->
name|rx_csum
operator|=
literal|1
expr_stmt|;
name|priv
operator|->
name|flags
operator|=
name|prof
operator|->
name|flags
expr_stmt|;
name|priv
operator|->
name|tx_ring_num
operator|=
name|prof
operator|->
name|tx_ring_num
expr_stmt|;
name|priv
operator|->
name|rx_ring_num
operator|=
name|prof
operator|->
name|rx_ring_num
expr_stmt|;
name|priv
operator|->
name|mac_index
operator|=
operator|-
literal|1
expr_stmt|;
name|priv
operator|->
name|msg_enable
operator|=
name|MLX4_EN_MSG_LEVEL
expr_stmt|;
name|priv
operator|->
name|ip_reasm
operator|=
name|priv
operator|->
name|mdev
operator|->
name|profile
operator|.
name|ip_reasm
expr_stmt|;
name|mtx_init
argument_list|(
operator|&
name|priv
operator|->
name|stats_lock
operator|.
name|m
argument_list|,
literal|"mlx4 stats"
argument_list|,
name|NULL
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
name|mtx_init
argument_list|(
operator|&
name|priv
operator|->
name|vlan_lock
operator|.
name|m
argument_list|,
literal|"mlx4 vlan"
argument_list|,
name|NULL
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
name|INIT_WORK
argument_list|(
operator|&
name|priv
operator|->
name|start_port_task
argument_list|,
name|mlx4_en_lock_and_start_port
argument_list|)
expr_stmt|;
name|INIT_WORK
argument_list|(
operator|&
name|priv
operator|->
name|stop_port_task
argument_list|,
name|mlx4_en_lock_and_stop_port
argument_list|)
expr_stmt|;
name|INIT_WORK
argument_list|(
operator|&
name|priv
operator|->
name|mcast_task
argument_list|,
name|mlx4_en_do_set_multicast
argument_list|)
expr_stmt|;
name|INIT_WORK
argument_list|(
operator|&
name|priv
operator|->
name|watchdog_task
argument_list|,
name|mlx4_en_restart
argument_list|)
expr_stmt|;
name|INIT_WORK
argument_list|(
operator|&
name|priv
operator|->
name|linkstate_task
argument_list|,
name|mlx4_en_linkstate
argument_list|)
expr_stmt|;
name|INIT_DELAYED_WORK
argument_list|(
operator|&
name|priv
operator|->
name|stats_task
argument_list|,
name|mlx4_en_do_get_stats
argument_list|)
expr_stmt|;
name|callout_init
argument_list|(
operator|&
name|priv
operator|->
name|watchdog_timer
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* Query for default mac and max mtu */
name|priv
operator|->
name|max_mtu
operator|=
name|mdev
operator|->
name|dev
operator|->
name|caps
operator|.
name|eth_mtu_cap
index|[
name|priv
operator|->
name|port
index|]
expr_stmt|;
name|priv
operator|->
name|mac
operator|=
name|mdev
operator|->
name|dev
operator|->
name|caps
operator|.
name|def_mac
index|[
name|priv
operator|->
name|port
index|]
expr_stmt|;
if|if
condition|(
name|ILLEGAL_MAC
argument_list|(
name|priv
operator|->
name|mac
argument_list|)
condition|)
block|{
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Port: %d, invalid mac burned: 0x%llx, quiting\n"
argument_list|,
name|priv
operator|->
name|port
argument_list|,
operator|(
name|long
name|long
operator|)
name|priv
operator|->
name|mac
argument_list|)
expr_stmt|;
name|err
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|mlx4_en_sysctl_conf
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|err
operator|=
name|mlx4_en_alloc_resources
argument_list|(
name|priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|out
goto|;
comment|/* Allocate page for receive rings */
name|err
operator|=
name|mlx4_alloc_hwq_res
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
operator|&
name|priv
operator|->
name|res
argument_list|,
name|MLX4_EN_PAGE_SIZE
argument_list|,
name|MLX4_EN_PAGE_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed to allocate page for rx qps\n"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|priv
operator|->
name|allocated
operator|=
literal|1
expr_stmt|;
comment|/* 	 * Set driver features 	 */
name|dev
operator|->
name|if_capabilities
operator||=
name|IFCAP_RXCSUM
operator||
name|IFCAP_TXCSUM
expr_stmt|;
name|dev
operator|->
name|if_capabilities
operator||=
name|IFCAP_VLAN_MTU
operator||
name|IFCAP_VLAN_HWTAGGING
expr_stmt|;
name|dev
operator|->
name|if_capabilities
operator||=
name|IFCAP_VLAN_HWCSUM
operator||
name|IFCAP_VLAN_HWFILTER
expr_stmt|;
name|dev
operator|->
name|if_capabilities
operator||=
name|IFCAP_LINKSTATE
operator||
name|IFCAP_JUMBO_MTU
expr_stmt|;
if|if
condition|(
name|mdev
operator|->
name|LSO_support
condition|)
name|dev
operator|->
name|if_capabilities
operator||=
name|IFCAP_TSO4
operator||
name|IFCAP_VLAN_HWTSO
expr_stmt|;
if|if
condition|(
name|mdev
operator|->
name|profile
operator|.
name|num_lro
condition|)
name|dev
operator|->
name|if_capabilities
operator||=
name|IFCAP_LRO
expr_stmt|;
name|dev
operator|->
name|if_capenable
operator|=
name|dev
operator|->
name|if_capabilities
expr_stmt|;
comment|/* 	 * Setup wake-on-lan. 	 */
if|#
directive|if
literal|0
block|if (priv->mdev->dev->caps.wol) { 		u64 config; 		if (mlx4_wol_read(priv->mdev->dev,&config, priv->port) == 0) { 			if (config& MLX4_EN_WOL_MAGIC) 				dev->if_capabilities |= IFCAP_WOL_MAGIC; 			if (config& MLX4_EN_WOL_ENABLED) 				dev->if_capenable |= IFCAP_WOL_MAGIC; 		} 	}
endif|#
directive|endif
comment|/* Register for VLAN events */
name|priv
operator|->
name|vlan_attach
operator|=
name|EVENTHANDLER_REGISTER
argument_list|(
name|vlan_config
argument_list|,
name|mlx4_en_vlan_rx_add_vid
argument_list|,
name|priv
argument_list|,
name|EVENTHANDLER_PRI_FIRST
argument_list|)
expr_stmt|;
name|priv
operator|->
name|vlan_detach
operator|=
name|EVENTHANDLER_REGISTER
argument_list|(
name|vlan_unconfig
argument_list|,
name|mlx4_en_vlan_rx_kill_vid
argument_list|,
name|priv
argument_list|,
name|EVENTHANDLER_PRI_FIRST
argument_list|)
expr_stmt|;
name|mdev
operator|->
name|pndev
index|[
name|priv
operator|->
name|port
index|]
operator|=
name|dev
expr_stmt|;
name|priv
operator|->
name|last_link_state
operator|=
name|MLX4_DEV_EVENT_PORT_DOWN
expr_stmt|;
name|if_link_state_change
argument_list|(
name|dev
argument_list|,
name|LINK_STATE_DOWN
argument_list|)
expr_stmt|;
comment|/* Set default MAC */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ETHER_ADDR_LEN
condition|;
name|i
operator|++
control|)
name|dev_addr
index|[
name|ETHER_ADDR_LEN
operator|-
literal|1
operator|-
name|i
index|]
operator|=
call|(
name|u8
call|)
argument_list|(
name|priv
operator|->
name|mac
operator|>>
operator|(
literal|8
operator|*
name|i
operator|)
argument_list|)
expr_stmt|;
name|ether_ifattach
argument_list|(
name|dev
argument_list|,
name|dev_addr
argument_list|)
expr_stmt|;
name|ifmedia_init
argument_list|(
operator|&
name|priv
operator|->
name|media
argument_list|,
name|IFM_IMASK
operator||
name|IFM_ETH_FMASK
argument_list|,
name|mlx4_en_media_change
argument_list|,
name|mlx4_en_media_status
argument_list|)
expr_stmt|;
name|ifmedia_add
argument_list|(
operator|&
name|priv
operator|->
name|media
argument_list|,
name|IFM_ETHER
operator||
name|IFM_FDX
operator||
name|IFM_1000_T
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ifmedia_add
argument_list|(
operator|&
name|priv
operator|->
name|media
argument_list|,
name|IFM_ETHER
operator||
name|IFM_FDX
operator||
name|IFM_10G_SR
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ifmedia_add
argument_list|(
operator|&
name|priv
operator|->
name|media
argument_list|,
name|IFM_ETHER
operator||
name|IFM_FDX
operator||
name|IFM_10G_CX4
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ifmedia_add
argument_list|(
operator|&
name|priv
operator|->
name|media
argument_list|,
name|IFM_ETHER
operator||
name|IFM_AUTO
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ifmedia_set
argument_list|(
operator|&
name|priv
operator|->
name|media
argument_list|,
name|IFM_ETHER
operator||
name|IFM_AUTO
argument_list|)
expr_stmt|;
name|en_warn
argument_list|(
name|priv
argument_list|,
literal|"Using %d TX rings\n"
argument_list|,
name|prof
operator|->
name|tx_ring_num
argument_list|)
expr_stmt|;
name|en_warn
argument_list|(
name|priv
argument_list|,
literal|"Using %d RX rings\n"
argument_list|,
name|prof
operator|->
name|rx_ring_num
argument_list|)
expr_stmt|;
name|priv
operator|->
name|registered
operator|=
literal|1
expr_stmt|;
name|queue_delayed_work
argument_list|(
name|mdev
operator|->
name|workqueue
argument_list|,
operator|&
name|priv
operator|->
name|stats_task
argument_list|,
name|STATS_DELAY
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|out
label|:
name|mlx4_en_destroy_netdev
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

end_unit


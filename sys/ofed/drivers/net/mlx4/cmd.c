begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2004, 2005 Topspin Communications.  All rights reserved.  * Copyright (c) 2005, 2006, 2007, 2008, 2014 Mellanox Technologies. All rights reserved.  * Copyright (c) 2005, 2006, 2007 Cisco Systems, Inc.  All rights reserved.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  */
end_comment

begin_include
include|#
directive|include
file|<linux/sched.h>
end_include

begin_include
include|#
directive|include
file|<linux/slab.h>
end_include

begin_include
include|#
directive|include
file|<linux/module.h>
end_include

begin_include
include|#
directive|include
file|<linux/pci.h>
end_include

begin_include
include|#
directive|include
file|<linux/errno.h>
end_include

begin_include
include|#
directive|include
file|<linux/mlx4/cmd.h>
end_include

begin_include
include|#
directive|include
file|<linux/mlx4/device.h>
end_include

begin_include
include|#
directive|include
file|<linux/semaphore.h>
end_include

begin_include
include|#
directive|include
file|<rdma/ib_smi.h>
end_include

begin_include
include|#
directive|include
file|<asm/io.h>
end_include

begin_include
include|#
directive|include
file|<linux/ktime.h>
end_include

begin_include
include|#
directive|include
file|"mlx4.h"
end_include

begin_include
include|#
directive|include
file|"fw.h"
end_include

begin_define
define|#
directive|define
name|CMD_POLL_TOKEN
value|0xffff
end_define

begin_define
define|#
directive|define
name|INBOX_MASK
value|0xffffffffffffff00ULL
end_define

begin_define
define|#
directive|define
name|CMD_CHAN_VER
value|1
end_define

begin_define
define|#
directive|define
name|CMD_CHAN_IF_REV
value|1
end_define

begin_enum
enum|enum
block|{
comment|/* command completed successfully: */
name|CMD_STAT_OK
init|=
literal|0x00
block|,
comment|/* Internal error (such as a bus error) occurred while processing command: */
name|CMD_STAT_INTERNAL_ERR
init|=
literal|0x01
block|,
comment|/* Operation/command not supported or opcode modifier not supported: */
name|CMD_STAT_BAD_OP
init|=
literal|0x02
block|,
comment|/* Parameter not supported or parameter out of range: */
name|CMD_STAT_BAD_PARAM
init|=
literal|0x03
block|,
comment|/* System not enabled or bad system state: */
name|CMD_STAT_BAD_SYS_STATE
init|=
literal|0x04
block|,
comment|/* Attempt to access reserved or unallocaterd resource: */
name|CMD_STAT_BAD_RESOURCE
init|=
literal|0x05
block|,
comment|/* Requested resource is currently executing a command, or is otherwise busy: */
name|CMD_STAT_RESOURCE_BUSY
init|=
literal|0x06
block|,
comment|/* Required capability exceeds device limits: */
name|CMD_STAT_EXCEED_LIM
init|=
literal|0x08
block|,
comment|/* Resource is not in the appropriate state or ownership: */
name|CMD_STAT_BAD_RES_STATE
init|=
literal|0x09
block|,
comment|/* Index out of range: */
name|CMD_STAT_BAD_INDEX
init|=
literal|0x0a
block|,
comment|/* FW image corrupted: */
name|CMD_STAT_BAD_NVMEM
init|=
literal|0x0b
block|,
comment|/* Error in ICM mapping (e.g. not enough auxiliary ICM pages to execute command): */
name|CMD_STAT_ICM_ERROR
init|=
literal|0x0c
block|,
comment|/* Attempt to modify a QP/EE which is not in the presumed state: */
name|CMD_STAT_BAD_QP_STATE
init|=
literal|0x10
block|,
comment|/* Bad segment parameters (Address/Size): */
name|CMD_STAT_BAD_SEG_PARAM
init|=
literal|0x20
block|,
comment|/* Memory Region has Memory Windows bound to: */
name|CMD_STAT_REG_BOUND
init|=
literal|0x21
block|,
comment|/* HCA local attached memory not present: */
name|CMD_STAT_LAM_NOT_PRE
init|=
literal|0x22
block|,
comment|/* Bad management packet (silently discarded): */
name|CMD_STAT_BAD_PKT
init|=
literal|0x30
block|,
comment|/* More outstanding CQEs in CQ than new CQ size: */
name|CMD_STAT_BAD_SIZE
init|=
literal|0x40
block|,
comment|/* Multi Function device support required: */
name|CMD_STAT_MULTI_FUNC_REQ
init|=
literal|0x50
block|, }
enum|;
end_enum

begin_enum
enum|enum
block|{
name|HCR_IN_PARAM_OFFSET
init|=
literal|0x00
block|,
name|HCR_IN_MODIFIER_OFFSET
init|=
literal|0x08
block|,
name|HCR_OUT_PARAM_OFFSET
init|=
literal|0x0c
block|,
name|HCR_TOKEN_OFFSET
init|=
literal|0x14
block|,
name|HCR_STATUS_OFFSET
init|=
literal|0x18
block|,
name|HCR_OPMOD_SHIFT
init|=
literal|12
block|,
name|HCR_T_BIT
init|=
literal|21
block|,
name|HCR_E_BIT
init|=
literal|22
block|,
name|HCR_GO_BIT
init|=
literal|23
block|}
enum|;
end_enum

begin_enum
enum|enum
block|{
name|GO_BIT_TIMEOUT_MSECS
init|=
literal|10000
block|}
enum|;
end_enum

begin_enum
enum|enum
name|mlx4_vlan_transition
block|{
name|MLX4_VLAN_TRANSITION_VST_VST
init|=
literal|0
block|,
name|MLX4_VLAN_TRANSITION_VST_VGT
init|=
literal|1
block|,
name|MLX4_VLAN_TRANSITION_VGT_VST
init|=
literal|2
block|,
name|MLX4_VLAN_TRANSITION_VGT_VGT
init|=
literal|3
block|, }
enum|;
end_enum

begin_struct
struct|struct
name|mlx4_cmd_context
block|{
name|struct
name|completion
name|done
decl_stmt|;
name|int
name|result
decl_stmt|;
name|int
name|next
decl_stmt|;
name|u64
name|out_param
decl_stmt|;
name|u16
name|token
decl_stmt|;
name|u8
name|fw_status
decl_stmt|;
block|}
struct|;
end_struct

begin_function_decl
specifier|static
name|int
name|mlx4_master_process_vhcr
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|int
name|slave
parameter_list|,
name|struct
name|mlx4_vhcr_cmd
modifier|*
name|in_vhcr
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|int
name|mlx4_status_to_errno
parameter_list|(
name|u8
name|status
parameter_list|)
block|{
specifier|static
specifier|const
name|int
name|trans_table
index|[]
init|=
block|{
index|[
name|CMD_STAT_INTERNAL_ERR
index|]
operator|=
operator|-
name|EIO
block|,
index|[
name|CMD_STAT_BAD_OP
index|]
operator|=
operator|-
name|EPERM
block|,
index|[
name|CMD_STAT_BAD_PARAM
index|]
operator|=
operator|-
name|EINVAL
block|,
index|[
name|CMD_STAT_BAD_SYS_STATE
index|]
operator|=
operator|-
name|ENXIO
block|,
index|[
name|CMD_STAT_BAD_RESOURCE
index|]
operator|=
operator|-
name|EBADF
block|,
index|[
name|CMD_STAT_RESOURCE_BUSY
index|]
operator|=
operator|-
name|EBUSY
block|,
index|[
name|CMD_STAT_EXCEED_LIM
index|]
operator|=
operator|-
name|ENOMEM
block|,
index|[
name|CMD_STAT_BAD_RES_STATE
index|]
operator|=
operator|-
name|EBADF
block|,
index|[
name|CMD_STAT_BAD_INDEX
index|]
operator|=
operator|-
name|EBADF
block|,
index|[
name|CMD_STAT_BAD_NVMEM
index|]
operator|=
operator|-
name|EFAULT
block|,
index|[
name|CMD_STAT_ICM_ERROR
index|]
operator|=
operator|-
name|ENFILE
block|,
index|[
name|CMD_STAT_BAD_QP_STATE
index|]
operator|=
operator|-
name|EINVAL
block|,
index|[
name|CMD_STAT_BAD_SEG_PARAM
index|]
operator|=
operator|-
name|EFAULT
block|,
index|[
name|CMD_STAT_REG_BOUND
index|]
operator|=
operator|-
name|EBUSY
block|,
index|[
name|CMD_STAT_LAM_NOT_PRE
index|]
operator|=
operator|-
name|EAGAIN
block|,
index|[
name|CMD_STAT_BAD_PKT
index|]
operator|=
operator|-
name|EINVAL
block|,
index|[
name|CMD_STAT_BAD_SIZE
index|]
operator|=
operator|-
name|ENOMEM
block|,
index|[
name|CMD_STAT_MULTI_FUNC_REQ
index|]
operator|=
operator|-
name|EACCES
block|, 	}
decl_stmt|;
if|if
condition|(
name|status
operator|>=
name|ARRAY_SIZE
argument_list|(
name|trans_table
argument_list|)
operator|||
operator|(
name|status
operator|!=
name|CMD_STAT_OK
operator|&&
name|trans_table
index|[
name|status
index|]
operator|==
literal|0
operator|)
condition|)
return|return
operator|-
name|EIO
return|;
return|return
name|trans_table
index|[
name|status
index|]
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|cmd_to_str
parameter_list|(
name|u16
name|cmd
parameter_list|)
block|{
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|MLX4_CMD_SYS_EN
case|:
return|return
literal|"SYS_EN"
return|;
case|case
name|MLX4_CMD_SYS_DIS
case|:
return|return
literal|"SYS_DIS"
return|;
case|case
name|MLX4_CMD_MAP_FA
case|:
return|return
literal|"MAP_FA"
return|;
case|case
name|MLX4_CMD_UNMAP_FA
case|:
return|return
literal|"UNMAP_FA"
return|;
case|case
name|MLX4_CMD_RUN_FW
case|:
return|return
literal|"RUN_FW"
return|;
case|case
name|MLX4_CMD_MOD_STAT_CFG
case|:
return|return
literal|"MOD_STAT_CFG"
return|;
case|case
name|MLX4_CMD_QUERY_DEV_CAP
case|:
return|return
literal|"QUERY_DEV_CAP"
return|;
case|case
name|MLX4_CMD_QUERY_FW
case|:
return|return
literal|"QUERY_FW"
return|;
case|case
name|MLX4_CMD_ENABLE_LAM
case|:
return|return
literal|"ENABLE_LAM"
return|;
case|case
name|MLX4_CMD_DISABLE_LAM
case|:
return|return
literal|"DISABLE_LAM"
return|;
case|case
name|MLX4_CMD_QUERY_DDR
case|:
return|return
literal|"QUERY_DDR"
return|;
case|case
name|MLX4_CMD_QUERY_ADAPTER
case|:
return|return
literal|"QUERY_ADAPTER"
return|;
case|case
name|MLX4_CMD_INIT_HCA
case|:
return|return
literal|"INIT_HCA"
return|;
case|case
name|MLX4_CMD_CLOSE_HCA
case|:
return|return
literal|"CLOSE_HCA"
return|;
case|case
name|MLX4_CMD_INIT_PORT
case|:
return|return
literal|"INIT_PORT"
return|;
case|case
name|MLX4_CMD_CLOSE_PORT
case|:
return|return
literal|"CLOSE_PORT"
return|;
case|case
name|MLX4_CMD_QUERY_HCA
case|:
return|return
literal|"QUERY_HCA"
return|;
case|case
name|MLX4_CMD_QUERY_PORT
case|:
return|return
literal|"QUERY_PORT"
return|;
case|case
name|MLX4_CMD_SENSE_PORT
case|:
return|return
literal|"SENSE_PORT"
return|;
case|case
name|MLX4_CMD_HW_HEALTH_CHECK
case|:
return|return
literal|"HW_HEALTH_CHECK"
return|;
case|case
name|MLX4_CMD_SET_PORT
case|:
return|return
literal|"SET_PORT"
return|;
case|case
name|MLX4_CMD_SET_NODE
case|:
return|return
literal|"SET_NODE"
return|;
case|case
name|MLX4_CMD_QUERY_FUNC
case|:
return|return
literal|"QUERY_FUNC"
return|;
case|case
name|MLX4_CMD_MAP_ICM
case|:
return|return
literal|"MAP_ICM"
return|;
case|case
name|MLX4_CMD_UNMAP_ICM
case|:
return|return
literal|"UNMAP_ICM"
return|;
case|case
name|MLX4_CMD_MAP_ICM_AUX
case|:
return|return
literal|"MAP_ICM_AUX"
return|;
case|case
name|MLX4_CMD_UNMAP_ICM_AUX
case|:
return|return
literal|"UNMAP_ICM_AUX"
return|;
case|case
name|MLX4_CMD_SET_ICM_SIZE
case|:
return|return
literal|"SET_ICM_SIZE"
return|;
comment|/*master notify fw on finish for slave's flr*/
case|case
name|MLX4_CMD_INFORM_FLR_DONE
case|:
return|return
literal|"INFORM_FLR_DONE"
return|;
case|case
name|MLX4_CMD_GET_OP_REQ
case|:
return|return
literal|"GET_OP_REQ"
return|;
comment|/* TPT commands */
case|case
name|MLX4_CMD_SW2HW_MPT
case|:
return|return
literal|"SW2HW_MPT"
return|;
case|case
name|MLX4_CMD_QUERY_MPT
case|:
return|return
literal|"QUERY_MPT"
return|;
case|case
name|MLX4_CMD_HW2SW_MPT
case|:
return|return
literal|"HW2SW_MPT"
return|;
case|case
name|MLX4_CMD_READ_MTT
case|:
return|return
literal|"READ_MTT"
return|;
case|case
name|MLX4_CMD_WRITE_MTT
case|:
return|return
literal|"WRITE_MTT"
return|;
case|case
name|MLX4_CMD_SYNC_TPT
case|:
return|return
literal|"SYNC_TPT"
return|;
comment|/* EQ commands */
case|case
name|MLX4_CMD_MAP_EQ
case|:
return|return
literal|"MAP_EQ"
return|;
case|case
name|MLX4_CMD_SW2HW_EQ
case|:
return|return
literal|"SW2HW_EQ"
return|;
case|case
name|MLX4_CMD_HW2SW_EQ
case|:
return|return
literal|"HW2SW_EQ"
return|;
case|case
name|MLX4_CMD_QUERY_EQ
case|:
return|return
literal|"QUERY_EQ"
return|;
comment|/* CQ commands */
case|case
name|MLX4_CMD_SW2HW_CQ
case|:
return|return
literal|"SW2HW_CQ"
return|;
case|case
name|MLX4_CMD_HW2SW_CQ
case|:
return|return
literal|"HW2SW_CQ"
return|;
case|case
name|MLX4_CMD_QUERY_CQ
case|:
return|return
literal|"QUERY_CQ:"
return|;
case|case
name|MLX4_CMD_MODIFY_CQ
case|:
return|return
literal|"MODIFY_CQ:"
return|;
comment|/* SRQ commands */
case|case
name|MLX4_CMD_SW2HW_SRQ
case|:
return|return
literal|"SW2HW_SRQ"
return|;
case|case
name|MLX4_CMD_HW2SW_SRQ
case|:
return|return
literal|"HW2SW_SRQ"
return|;
case|case
name|MLX4_CMD_QUERY_SRQ
case|:
return|return
literal|"QUERY_SRQ"
return|;
case|case
name|MLX4_CMD_ARM_SRQ
case|:
return|return
literal|"ARM_SRQ"
return|;
comment|/* QP/EE commands */
case|case
name|MLX4_CMD_RST2INIT_QP
case|:
return|return
literal|"RST2INIT_QP"
return|;
case|case
name|MLX4_CMD_INIT2RTR_QP
case|:
return|return
literal|"INIT2RTR_QP"
return|;
case|case
name|MLX4_CMD_RTR2RTS_QP
case|:
return|return
literal|"RTR2RTS_QP"
return|;
case|case
name|MLX4_CMD_RTS2RTS_QP
case|:
return|return
literal|"RTS2RTS_QP"
return|;
case|case
name|MLX4_CMD_SQERR2RTS_QP
case|:
return|return
literal|"SQERR2RTS_QP"
return|;
case|case
name|MLX4_CMD_2ERR_QP
case|:
return|return
literal|"2ERR_QP"
return|;
case|case
name|MLX4_CMD_RTS2SQD_QP
case|:
return|return
literal|"RTS2SQD_QP"
return|;
case|case
name|MLX4_CMD_SQD2SQD_QP
case|:
return|return
literal|"SQD2SQD_QP"
return|;
case|case
name|MLX4_CMD_SQD2RTS_QP
case|:
return|return
literal|"SQD2RTS_QP"
return|;
case|case
name|MLX4_CMD_2RST_QP
case|:
return|return
literal|"2RST_QP"
return|;
case|case
name|MLX4_CMD_QUERY_QP
case|:
return|return
literal|"QUERY_QP"
return|;
case|case
name|MLX4_CMD_INIT2INIT_QP
case|:
return|return
literal|"INIT2INIT_QP"
return|;
case|case
name|MLX4_CMD_SUSPEND_QP
case|:
return|return
literal|"SUSPEND_QP"
return|;
case|case
name|MLX4_CMD_UNSUSPEND_QP
case|:
return|return
literal|"UNSUSPEND_QP"
return|;
comment|/* special QP and management commands */
case|case
name|MLX4_CMD_CONF_SPECIAL_QP
case|:
return|return
literal|"CONF_SPECIAL_QP"
return|;
case|case
name|MLX4_CMD_MAD_IFC
case|:
return|return
literal|"MAD_IFC"
return|;
comment|/* multicast commands */
case|case
name|MLX4_CMD_READ_MCG
case|:
return|return
literal|"READ_MCG"
return|;
case|case
name|MLX4_CMD_WRITE_MCG
case|:
return|return
literal|"WRITE_MCG"
return|;
case|case
name|MLX4_CMD_MGID_HASH
case|:
return|return
literal|"MGID_HASH"
return|;
comment|/* miscellaneous commands */
case|case
name|MLX4_CMD_DIAG_RPRT
case|:
return|return
literal|"DIAG_RPRT"
return|;
case|case
name|MLX4_CMD_NOP
case|:
return|return
literal|"NOP"
return|;
case|case
name|MLX4_CMD_ACCESS_MEM
case|:
return|return
literal|"ACCESS_MEM"
return|;
case|case
name|MLX4_CMD_SET_VEP
case|:
return|return
literal|"SET_VEP"
return|;
comment|/* Ethernet specific commands */
case|case
name|MLX4_CMD_SET_VLAN_FLTR
case|:
return|return
literal|"SET_VLAN_FLTR"
return|;
case|case
name|MLX4_CMD_SET_MCAST_FLTR
case|:
return|return
literal|"SET_MCAST_FLTR"
return|;
case|case
name|MLX4_CMD_DUMP_ETH_STATS
case|:
return|return
literal|"DUMP_ETH_STATS"
return|;
comment|/* Communication channel commands */
case|case
name|MLX4_CMD_ARM_COMM_CHANNEL
case|:
return|return
literal|"ARM_COMM_CHANNEL"
return|;
case|case
name|MLX4_CMD_GEN_EQE
case|:
return|return
literal|"GEN_EQE"
return|;
comment|/* virtual commands */
case|case
name|MLX4_CMD_ALLOC_RES
case|:
return|return
literal|"ALLOC_RES"
return|;
case|case
name|MLX4_CMD_FREE_RES
case|:
return|return
literal|"FREE_RES"
return|;
case|case
name|MLX4_CMD_MCAST_ATTACH
case|:
return|return
literal|"MCAST_ATTACH"
return|;
case|case
name|MLX4_CMD_UCAST_ATTACH
case|:
return|return
literal|"UCAST_ATTACH"
return|;
case|case
name|MLX4_CMD_PROMISC
case|:
return|return
literal|"PROMISC"
return|;
case|case
name|MLX4_CMD_QUERY_FUNC_CAP
case|:
return|return
literal|"QUERY_FUNC_CAP"
return|;
case|case
name|MLX4_CMD_QP_ATTACH
case|:
return|return
literal|"QP_ATTACH"
return|;
comment|/* debug commands */
case|case
name|MLX4_CMD_QUERY_DEBUG_MSG
case|:
return|return
literal|"QUERY_DEBUG_MSG"
return|;
case|case
name|MLX4_CMD_SET_DEBUG_MSG
case|:
return|return
literal|"SET_DEBUG_MSG"
return|;
comment|/* statistics commands */
case|case
name|MLX4_CMD_QUERY_IF_STAT
case|:
return|return
literal|"QUERY_IF_STAT"
return|;
case|case
name|MLX4_CMD_SET_IF_STAT
case|:
return|return
literal|"SET_IF_STAT"
return|;
comment|/* register/delete flow steering network rules */
case|case
name|MLX4_QP_FLOW_STEERING_ATTACH
case|:
return|return
literal|"QP_FLOW_STEERING_ATTACH"
return|;
case|case
name|MLX4_QP_FLOW_STEERING_DETACH
case|:
return|return
literal|"QP_FLOW_STEERING_DETACH"
return|;
case|case
name|MLX4_FLOW_STEERING_IB_UC_QP_RANGE
case|:
return|return
literal|"FLOW_STEERING_IB_UC_QP_RANGE"
return|;
default|default:
return|return
literal|"OTHER"
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|u8
name|mlx4_errno_to_status
parameter_list|(
name|int
name|errno
parameter_list|)
block|{
switch|switch
condition|(
name|errno
condition|)
block|{
case|case
operator|-
name|EPERM
case|:
return|return
name|CMD_STAT_BAD_OP
return|;
case|case
operator|-
name|EINVAL
case|:
return|return
name|CMD_STAT_BAD_PARAM
return|;
case|case
operator|-
name|ENXIO
case|:
return|return
name|CMD_STAT_BAD_SYS_STATE
return|;
case|case
operator|-
name|EBUSY
case|:
return|return
name|CMD_STAT_RESOURCE_BUSY
return|;
case|case
operator|-
name|ENOMEM
case|:
return|return
name|CMD_STAT_EXCEED_LIM
return|;
case|case
operator|-
name|ENFILE
case|:
return|return
name|CMD_STAT_ICM_ERROR
return|;
default|default:
return|return
name|CMD_STAT_INTERNAL_ERR
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|comm_pending
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|mlx4_priv
modifier|*
name|priv
init|=
name|mlx4_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|u32
name|status
init|=
name|readl
argument_list|(
operator|&
name|priv
operator|->
name|mfunc
operator|.
name|comm
operator|->
name|slave_read
argument_list|)
decl_stmt|;
return|return
operator|(
name|swab32
argument_list|(
name|status
argument_list|)
operator|>>
literal|31
operator|)
operator|!=
name|priv
operator|->
name|cmd
operator|.
name|comm_toggle
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_comm_cmd_post
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|u8
name|cmd
parameter_list|,
name|u16
name|param
parameter_list|)
block|{
name|struct
name|mlx4_priv
modifier|*
name|priv
init|=
name|mlx4_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|u32
name|val
decl_stmt|;
name|priv
operator|->
name|cmd
operator|.
name|comm_toggle
operator|^=
literal|1
expr_stmt|;
name|val
operator|=
name|param
operator||
operator|(
name|cmd
operator|<<
literal|16
operator|)
operator||
operator|(
name|priv
operator|->
name|cmd
operator|.
name|comm_toggle
operator|<<
literal|31
operator|)
expr_stmt|;
name|__raw_writel
argument_list|(
operator|(
name|__force
name|u32
operator|)
name|cpu_to_be32
argument_list|(
name|val
argument_list|)
argument_list|,
operator|&
name|priv
operator|->
name|mfunc
operator|.
name|comm
operator|->
name|slave_write
argument_list|)
expr_stmt|;
name|mmiowb
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_comm_cmd_poll
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|u8
name|cmd
parameter_list|,
name|u16
name|param
parameter_list|,
name|unsigned
name|long
name|timeout
parameter_list|)
block|{
name|struct
name|mlx4_priv
modifier|*
name|priv
init|=
name|mlx4_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|unsigned
name|long
name|end
decl_stmt|;
name|int
name|err
init|=
literal|0
decl_stmt|;
name|int
name|ret_from_pending
init|=
literal|0
decl_stmt|;
comment|/* First, verify that the master reports correct status */
if|if
condition|(
name|comm_pending
argument_list|(
name|dev
argument_list|)
condition|)
block|{
name|mlx4_warn
argument_list|(
name|dev
argument_list|,
literal|"Communication channel is not idle."
literal|"my toggle is %d (cmd:0x%x)\n"
argument_list|,
name|priv
operator|->
name|cmd
operator|.
name|comm_toggle
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
return|return
operator|-
name|EAGAIN
return|;
block|}
comment|/* Write command */
name|down
argument_list|(
operator|&
name|priv
operator|->
name|cmd
operator|.
name|poll_sem
argument_list|)
expr_stmt|;
name|mlx4_comm_cmd_post
argument_list|(
name|dev
argument_list|,
name|cmd
argument_list|,
name|param
argument_list|)
expr_stmt|;
name|end
operator|=
name|msecs_to_jiffies
argument_list|(
name|timeout
argument_list|)
operator|+
name|jiffies
expr_stmt|;
while|while
condition|(
name|comm_pending
argument_list|(
name|dev
argument_list|)
operator|&&
name|time_before
argument_list|(
name|jiffies
argument_list|,
name|end
argument_list|)
condition|)
name|cond_resched
argument_list|()
expr_stmt|;
name|ret_from_pending
operator|=
name|comm_pending
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret_from_pending
condition|)
block|{
comment|/* check if the slave is trying to boot in the middle of 		 * FLR process. The only non-zero result in the RESET command 		 * is MLX4_DELAY_RESET_SLAVE*/
if|if
condition|(
operator|(
name|MLX4_COMM_CMD_RESET
operator|==
name|cmd
operator|)
condition|)
block|{
name|mlx4_warn
argument_list|(
name|dev
argument_list|,
literal|"Got slave FLRed from Communication"
literal|" channel (ret:0x%x)\n"
argument_list|,
name|ret_from_pending
argument_list|)
expr_stmt|;
name|err
operator|=
name|MLX4_DELAY_RESET_SLAVE
expr_stmt|;
block|}
else|else
block|{
name|mlx4_warn
argument_list|(
name|dev
argument_list|,
literal|"Communication channel timed out\n"
argument_list|)
expr_stmt|;
name|err
operator|=
operator|-
name|ETIMEDOUT
expr_stmt|;
block|}
block|}
name|up
argument_list|(
operator|&
name|priv
operator|->
name|cmd
operator|.
name|poll_sem
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_comm_cmd_wait
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|u8
name|op
parameter_list|,
name|u16
name|param
parameter_list|,
name|unsigned
name|long
name|timeout
parameter_list|)
block|{
name|struct
name|mlx4_cmd
modifier|*
name|cmd
init|=
operator|&
name|mlx4_priv
argument_list|(
name|dev
argument_list|)
operator|->
name|cmd
decl_stmt|;
name|struct
name|mlx4_cmd_context
modifier|*
name|context
decl_stmt|;
name|unsigned
name|long
name|end
decl_stmt|;
name|int
name|err
init|=
literal|0
decl_stmt|;
name|down
argument_list|(
operator|&
name|cmd
operator|->
name|event_sem
argument_list|)
expr_stmt|;
name|end
operator|=
name|msecs_to_jiffies
argument_list|(
name|timeout
argument_list|)
operator|+
name|jiffies
expr_stmt|;
while|while
condition|(
name|comm_pending
argument_list|(
name|dev
argument_list|)
operator|&&
name|time_before
argument_list|(
name|jiffies
argument_list|,
name|end
argument_list|)
condition|)
name|cond_resched
argument_list|()
expr_stmt|;
if|if
condition|(
name|comm_pending
argument_list|(
name|dev
argument_list|)
condition|)
block|{
name|mlx4_warn
argument_list|(
name|dev
argument_list|,
literal|"mlx4_comm_cmd_wait: Comm channel "
literal|"is not idle. My toggle is %d (op: 0x%x)\n"
argument_list|,
name|mlx4_priv
argument_list|(
name|dev
argument_list|)
operator|->
name|cmd
operator|.
name|comm_toggle
argument_list|,
name|op
argument_list|)
expr_stmt|;
name|up
argument_list|(
operator|&
name|cmd
operator|->
name|event_sem
argument_list|)
expr_stmt|;
return|return
operator|-
name|EAGAIN
return|;
block|}
name|spin_lock
argument_list|(
operator|&
name|cmd
operator|->
name|context_lock
argument_list|)
expr_stmt|;
name|BUG_ON
argument_list|(
name|cmd
operator|->
name|free_head
operator|<
literal|0
argument_list|)
expr_stmt|;
name|context
operator|=
operator|&
name|cmd
operator|->
name|context
index|[
name|cmd
operator|->
name|free_head
index|]
expr_stmt|;
name|context
operator|->
name|token
operator|+=
name|cmd
operator|->
name|token_mask
operator|+
literal|1
expr_stmt|;
name|cmd
operator|->
name|free_head
operator|=
name|context
operator|->
name|next
expr_stmt|;
name|spin_unlock
argument_list|(
operator|&
name|cmd
operator|->
name|context_lock
argument_list|)
expr_stmt|;
name|init_completion
argument_list|(
operator|&
name|context
operator|->
name|done
argument_list|)
expr_stmt|;
name|mlx4_comm_cmd_post
argument_list|(
name|dev
argument_list|,
name|op
argument_list|,
name|param
argument_list|)
expr_stmt|;
comment|/* In slave, wait unconditionally for completion */
name|wait_for_completion
argument_list|(
operator|&
name|context
operator|->
name|done
argument_list|)
expr_stmt|;
name|err
operator|=
name|context
operator|->
name|result
expr_stmt|;
if|if
condition|(
name|err
operator|&&
name|context
operator|->
name|fw_status
operator|!=
name|CMD_STAT_MULTI_FUNC_REQ
condition|)
block|{
name|mlx4_err
argument_list|(
name|dev
argument_list|,
literal|"command 0x%x failed: fw status = 0x%x\n"
argument_list|,
name|op
argument_list|,
name|context
operator|->
name|fw_status
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|out
label|:
comment|/* wait for comm channel ready 	 * this is necessary for prevention the race 	 * when switching between event to polling mode 	 */
name|end
operator|=
name|msecs_to_jiffies
argument_list|(
name|timeout
argument_list|)
operator|+
name|jiffies
expr_stmt|;
while|while
condition|(
name|comm_pending
argument_list|(
name|dev
argument_list|)
operator|&&
name|time_before
argument_list|(
name|jiffies
argument_list|,
name|end
argument_list|)
condition|)
name|cond_resched
argument_list|()
expr_stmt|;
name|spin_lock
argument_list|(
operator|&
name|cmd
operator|->
name|context_lock
argument_list|)
expr_stmt|;
name|context
operator|->
name|next
operator|=
name|cmd
operator|->
name|free_head
expr_stmt|;
name|cmd
operator|->
name|free_head
operator|=
name|context
operator|-
name|cmd
operator|->
name|context
expr_stmt|;
name|spin_unlock
argument_list|(
operator|&
name|cmd
operator|->
name|context_lock
argument_list|)
expr_stmt|;
name|up
argument_list|(
operator|&
name|cmd
operator|->
name|event_sem
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|int
name|mlx4_comm_cmd
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|u8
name|cmd
parameter_list|,
name|u16
name|param
parameter_list|,
name|unsigned
name|long
name|timeout
parameter_list|)
block|{
if|if
condition|(
name|mlx4_priv
argument_list|(
name|dev
argument_list|)
operator|->
name|cmd
operator|.
name|use_events
condition|)
return|return
name|mlx4_comm_cmd_wait
argument_list|(
name|dev
argument_list|,
name|cmd
argument_list|,
name|param
argument_list|,
name|timeout
argument_list|)
return|;
return|return
name|mlx4_comm_cmd_poll
argument_list|(
name|dev
argument_list|,
name|cmd
argument_list|,
name|param
argument_list|,
name|timeout
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cmd_pending
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|)
block|{
name|u32
name|status
decl_stmt|;
if|if
condition|(
name|pci_channel_offline
argument_list|(
name|dev
operator|->
name|pdev
argument_list|)
condition|)
return|return
operator|-
name|EIO
return|;
name|status
operator|=
name|readl
argument_list|(
name|mlx4_priv
argument_list|(
name|dev
argument_list|)
operator|->
name|cmd
operator|.
name|hcr
operator|+
name|HCR_STATUS_OFFSET
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|&
name|swab32
argument_list|(
literal|1
operator|<<
name|HCR_GO_BIT
argument_list|)
operator|)
operator|||
operator|(
name|mlx4_priv
argument_list|(
name|dev
argument_list|)
operator|->
name|cmd
operator|.
name|toggle
operator|==
operator|!
operator|!
operator|(
name|status
operator|&
name|swab32
argument_list|(
literal|1
operator|<<
name|HCR_T_BIT
argument_list|)
operator|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|get_status
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|u32
modifier|*
name|status
parameter_list|,
name|int
modifier|*
name|go_bit
parameter_list|,
name|int
modifier|*
name|t_bit
parameter_list|)
block|{
if|if
condition|(
name|pci_channel_offline
argument_list|(
name|dev
operator|->
name|pdev
argument_list|)
condition|)
return|return
operator|-
name|EIO
return|;
operator|*
name|status
operator|=
name|readl
argument_list|(
name|mlx4_priv
argument_list|(
name|dev
argument_list|)
operator|->
name|cmd
operator|.
name|hcr
operator|+
name|HCR_STATUS_OFFSET
argument_list|)
expr_stmt|;
operator|*
name|t_bit
operator|=
operator|!
operator|!
operator|(
operator|*
name|status
operator|&
name|swab32
argument_list|(
literal|1
operator|<<
name|HCR_T_BIT
argument_list|)
operator|)
expr_stmt|;
operator|*
name|go_bit
operator|=
operator|!
operator|!
operator|(
operator|*
name|status
operator|&
name|swab32
argument_list|(
literal|1
operator|<<
name|HCR_GO_BIT
argument_list|)
operator|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_cmd_post
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|timespec
modifier|*
name|ts1
parameter_list|,
name|u64
name|in_param
parameter_list|,
name|u64
name|out_param
parameter_list|,
name|u32
name|in_modifier
parameter_list|,
name|u8
name|op_modifier
parameter_list|,
name|u16
name|op
parameter_list|,
name|u16
name|token
parameter_list|,
name|int
name|event
parameter_list|)
block|{
name|struct
name|mlx4_cmd
modifier|*
name|cmd
init|=
operator|&
name|mlx4_priv
argument_list|(
name|dev
argument_list|)
operator|->
name|cmd
decl_stmt|;
name|u32
name|__iomem
modifier|*
name|hcr
init|=
name|cmd
operator|->
name|hcr
decl_stmt|;
name|int
name|ret
init|=
operator|-
name|EAGAIN
decl_stmt|;
name|unsigned
name|long
name|end
decl_stmt|;
name|int
name|err
decl_stmt|,
name|go_bit
init|=
literal|0
decl_stmt|,
name|t_bit
init|=
literal|0
decl_stmt|;
name|u32
name|status
init|=
literal|0
decl_stmt|;
name|mutex_lock
argument_list|(
operator|&
name|cmd
operator|->
name|hcr_mutex
argument_list|)
expr_stmt|;
if|if
condition|(
name|pci_channel_offline
argument_list|(
name|dev
operator|->
name|pdev
argument_list|)
condition|)
block|{
comment|/* 		 * Device is going through error recovery 		 * and cannot accept commands. 		 */
name|ret
operator|=
operator|-
name|EIO
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|end
operator|=
name|jiffies
expr_stmt|;
if|if
condition|(
name|event
condition|)
name|end
operator|+=
name|msecs_to_jiffies
argument_list|(
name|GO_BIT_TIMEOUT_MSECS
argument_list|)
expr_stmt|;
while|while
condition|(
name|cmd_pending
argument_list|(
name|dev
argument_list|)
condition|)
block|{
if|if
condition|(
name|pci_channel_offline
argument_list|(
name|dev
operator|->
name|pdev
argument_list|)
condition|)
block|{
comment|/* 			 * Device is going through error recovery 			 * and cannot accept commands. 			 */
name|ret
operator|=
operator|-
name|EIO
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|time_after_eq
argument_list|(
name|jiffies
argument_list|,
name|end
argument_list|)
condition|)
block|{
name|mlx4_err
argument_list|(
name|dev
argument_list|,
literal|"%s:cmd_pending failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|cond_resched
argument_list|()
expr_stmt|;
block|}
comment|/* 	 * We use writel (instead of something like memcpy_toio) 	 * because writes of less than 32 bits to the HCR don't work 	 * (and some architectures such as ia64 implement memcpy_toio 	 * in terms of writeb). 	 */
name|__raw_writel
argument_list|(
operator|(
name|__force
name|u32
operator|)
name|cpu_to_be32
argument_list|(
name|in_param
operator|>>
literal|32
argument_list|)
argument_list|,
name|hcr
operator|+
literal|0
argument_list|)
expr_stmt|;
name|__raw_writel
argument_list|(
operator|(
name|__force
name|u32
operator|)
name|cpu_to_be32
argument_list|(
name|in_param
operator|&
literal|0xfffffffful
argument_list|)
argument_list|,
name|hcr
operator|+
literal|1
argument_list|)
expr_stmt|;
name|__raw_writel
argument_list|(
operator|(
name|__force
name|u32
operator|)
name|cpu_to_be32
argument_list|(
name|in_modifier
argument_list|)
argument_list|,
name|hcr
operator|+
literal|2
argument_list|)
expr_stmt|;
name|__raw_writel
argument_list|(
operator|(
name|__force
name|u32
operator|)
name|cpu_to_be32
argument_list|(
name|out_param
operator|>>
literal|32
argument_list|)
argument_list|,
name|hcr
operator|+
literal|3
argument_list|)
expr_stmt|;
name|__raw_writel
argument_list|(
operator|(
name|__force
name|u32
operator|)
name|cpu_to_be32
argument_list|(
name|out_param
operator|&
literal|0xfffffffful
argument_list|)
argument_list|,
name|hcr
operator|+
literal|4
argument_list|)
expr_stmt|;
name|__raw_writel
argument_list|(
operator|(
name|__force
name|u32
operator|)
name|cpu_to_be32
argument_list|(
name|token
operator|<<
literal|16
argument_list|)
argument_list|,
name|hcr
operator|+
literal|5
argument_list|)
expr_stmt|;
if|if
condition|(
name|ts1
condition|)
name|ktime_get_ts
argument_list|(
name|ts1
argument_list|)
expr_stmt|;
comment|/* __raw_writel may not order writes. */
name|wmb
argument_list|()
expr_stmt|;
name|__raw_writel
argument_list|(
operator|(
name|__force
name|u32
operator|)
name|cpu_to_be32
argument_list|(
operator|(
literal|1
operator|<<
name|HCR_GO_BIT
operator|)
operator||
operator|(
name|cmd
operator|->
name|toggle
operator|<<
name|HCR_T_BIT
operator|)
operator||
operator|(
name|event
condition|?
operator|(
literal|1
operator|<<
name|HCR_E_BIT
operator|)
else|:
literal|0
operator|)
operator||
operator|(
name|op_modifier
operator|<<
name|HCR_OPMOD_SHIFT
operator|)
operator||
name|op
argument_list|)
argument_list|,
name|hcr
operator|+
literal|6
argument_list|)
expr_stmt|;
comment|/* 	 * Make sure that our HCR writes don't get mixed in with 	 * writes from another CPU starting a FW command. 	 */
name|mmiowb
argument_list|()
expr_stmt|;
name|cmd
operator|->
name|toggle
operator|=
name|cmd
operator|->
name|toggle
operator|^
literal|1
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
name|out
label|:
if|if
condition|(
name|ret
condition|)
block|{
name|err
operator|=
name|get_status
argument_list|(
name|dev
argument_list|,
operator|&
name|status
argument_list|,
operator|&
name|go_bit
argument_list|,
operator|&
name|t_bit
argument_list|)
expr_stmt|;
name|mlx4_warn
argument_list|(
name|dev
argument_list|,
literal|"Could not post command %s (0x%x): ret=%d, "
literal|"in_param=0x%llx, in_mod=0x%x, op_mod=0x%x, "
literal|"get_status err=%d, status_reg=0x%x, go_bit=%d, "
literal|"t_bit=%d, toggle=0x%x\n"
argument_list|,
name|cmd_to_str
argument_list|(
name|op
argument_list|)
argument_list|,
name|op
argument_list|,
name|ret
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|in_param
argument_list|,
name|in_modifier
argument_list|,
name|op_modifier
argument_list|,
name|err
argument_list|,
name|status
argument_list|,
name|go_bit
argument_list|,
name|t_bit
argument_list|,
name|cmd
operator|->
name|toggle
argument_list|)
expr_stmt|;
block|}
name|mutex_unlock
argument_list|(
operator|&
name|cmd
operator|->
name|hcr_mutex
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_slave_cmd
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|u64
name|in_param
parameter_list|,
name|u64
modifier|*
name|out_param
parameter_list|,
name|int
name|out_is_imm
parameter_list|,
name|u32
name|in_modifier
parameter_list|,
name|u8
name|op_modifier
parameter_list|,
name|u16
name|op
parameter_list|,
name|unsigned
name|long
name|timeout
parameter_list|)
block|{
name|struct
name|mlx4_priv
modifier|*
name|priv
init|=
name|mlx4_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|mlx4_vhcr_cmd
modifier|*
name|vhcr
init|=
name|priv
operator|->
name|mfunc
operator|.
name|vhcr
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|mutex_lock
argument_list|(
operator|&
name|priv
operator|->
name|cmd
operator|.
name|slave_cmd_mutex
argument_list|)
expr_stmt|;
name|vhcr
operator|->
name|in_param
operator|=
name|cpu_to_be64
argument_list|(
name|in_param
argument_list|)
expr_stmt|;
name|vhcr
operator|->
name|out_param
operator|=
name|out_param
condition|?
name|cpu_to_be64
argument_list|(
operator|*
name|out_param
argument_list|)
else|:
literal|0
expr_stmt|;
name|vhcr
operator|->
name|in_modifier
operator|=
name|cpu_to_be32
argument_list|(
name|in_modifier
argument_list|)
expr_stmt|;
name|vhcr
operator|->
name|opcode
operator|=
name|cpu_to_be16
argument_list|(
operator|(
operator|(
operator|(
name|u16
operator|)
name|op_modifier
operator|)
operator|<<
literal|12
operator|)
operator||
operator|(
name|op
operator|&
literal|0xfff
operator|)
argument_list|)
expr_stmt|;
name|vhcr
operator|->
name|token
operator|=
name|cpu_to_be16
argument_list|(
name|CMD_POLL_TOKEN
argument_list|)
expr_stmt|;
name|vhcr
operator|->
name|status
operator|=
literal|0
expr_stmt|;
name|vhcr
operator|->
name|flags
operator|=
operator|!
operator|!
operator|(
name|priv
operator|->
name|cmd
operator|.
name|use_events
operator|)
operator|<<
literal|6
expr_stmt|;
if|if
condition|(
name|mlx4_is_master
argument_list|(
name|dev
argument_list|)
condition|)
block|{
name|ret
operator|=
name|mlx4_master_process_vhcr
argument_list|(
name|dev
argument_list|,
name|dev
operator|->
name|caps
operator|.
name|function
argument_list|,
name|vhcr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
block|{
if|if
condition|(
name|out_is_imm
condition|)
block|{
if|if
condition|(
name|out_param
condition|)
operator|*
name|out_param
operator|=
name|be64_to_cpu
argument_list|(
name|vhcr
operator|->
name|out_param
argument_list|)
expr_stmt|;
else|else
block|{
name|mlx4_err
argument_list|(
name|dev
argument_list|,
literal|"response expected while"
literal|"output mailbox is NULL for "
literal|"command 0x%x\n"
argument_list|,
name|op
argument_list|)
expr_stmt|;
name|vhcr
operator|->
name|status
operator|=
name|CMD_STAT_BAD_PARAM
expr_stmt|;
block|}
block|}
name|ret
operator|=
name|mlx4_status_to_errno
argument_list|(
name|vhcr
operator|->
name|status
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|ret
operator|=
name|mlx4_comm_cmd
argument_list|(
name|dev
argument_list|,
name|MLX4_COMM_CMD_VHCR_POST
argument_list|,
literal|0
argument_list|,
name|MLX4_COMM_TIME
operator|+
name|timeout
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
block|{
if|if
condition|(
name|out_is_imm
condition|)
block|{
if|if
condition|(
name|out_param
condition|)
operator|*
name|out_param
operator|=
name|be64_to_cpu
argument_list|(
name|vhcr
operator|->
name|out_param
argument_list|)
expr_stmt|;
else|else
block|{
name|mlx4_err
argument_list|(
name|dev
argument_list|,
literal|"response expected while"
literal|"output mailbox is NULL for "
literal|"command 0x%x\n"
argument_list|,
name|op
argument_list|)
expr_stmt|;
name|vhcr
operator|->
name|status
operator|=
name|CMD_STAT_BAD_PARAM
expr_stmt|;
block|}
block|}
name|ret
operator|=
name|mlx4_status_to_errno
argument_list|(
name|vhcr
operator|->
name|status
argument_list|)
expr_stmt|;
block|}
else|else
name|mlx4_err
argument_list|(
name|dev
argument_list|,
literal|"failed execution of VHCR_POST command"
literal|"opcode %s (0x%x)\n"
argument_list|,
name|cmd_to_str
argument_list|(
name|op
argument_list|)
argument_list|,
name|op
argument_list|)
expr_stmt|;
block|}
name|mutex_unlock
argument_list|(
operator|&
name|priv
operator|->
name|cmd
operator|.
name|slave_cmd_mutex
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_cmd_poll
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|u64
name|in_param
parameter_list|,
name|u64
modifier|*
name|out_param
parameter_list|,
name|int
name|out_is_imm
parameter_list|,
name|u32
name|in_modifier
parameter_list|,
name|u8
name|op_modifier
parameter_list|,
name|u16
name|op
parameter_list|,
name|unsigned
name|long
name|timeout
parameter_list|)
block|{
name|struct
name|mlx4_priv
modifier|*
name|priv
init|=
name|mlx4_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|void
name|__iomem
modifier|*
name|hcr
init|=
name|priv
operator|->
name|cmd
operator|.
name|hcr
decl_stmt|;
name|int
name|err
init|=
literal|0
decl_stmt|;
name|unsigned
name|long
name|end
decl_stmt|;
name|u32
name|stat
decl_stmt|;
name|down
argument_list|(
operator|&
name|priv
operator|->
name|cmd
operator|.
name|poll_sem
argument_list|)
expr_stmt|;
if|if
condition|(
name|pci_channel_offline
argument_list|(
name|dev
operator|->
name|pdev
argument_list|)
condition|)
block|{
comment|/* 		 * Device is going through error recovery 		 * and cannot accept commands. 		 */
name|err
operator|=
operator|-
name|EIO
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|err
operator|=
name|mlx4_cmd_post
argument_list|(
name|dev
argument_list|,
name|NULL
argument_list|,
name|in_param
argument_list|,
name|out_param
condition|?
operator|*
name|out_param
else|:
literal|0
argument_list|,
name|in_modifier
argument_list|,
name|op_modifier
argument_list|,
name|op
argument_list|,
name|CMD_POLL_TOKEN
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|out
goto|;
name|end
operator|=
name|msecs_to_jiffies
argument_list|(
name|timeout
argument_list|)
operator|+
name|jiffies
expr_stmt|;
while|while
condition|(
name|cmd_pending
argument_list|(
name|dev
argument_list|)
operator|&&
name|time_before
argument_list|(
name|jiffies
argument_list|,
name|end
argument_list|)
condition|)
block|{
if|if
condition|(
name|pci_channel_offline
argument_list|(
name|dev
operator|->
name|pdev
argument_list|)
condition|)
block|{
comment|/* 			 * Device is going through error recovery 			 * and cannot accept commands. 			 */
name|err
operator|=
operator|-
name|EIO
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|cond_resched
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|cmd_pending
argument_list|(
name|dev
argument_list|)
condition|)
block|{
name|mlx4_warn
argument_list|(
name|dev
argument_list|,
literal|"command %s (0x%x) timed out (go bit not cleared)\n"
argument_list|,
name|cmd_to_str
argument_list|(
name|op
argument_list|)
argument_list|,
name|op
argument_list|)
expr_stmt|;
name|err
operator|=
operator|-
name|ETIMEDOUT
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|out_is_imm
condition|)
operator|*
name|out_param
operator|=
operator|(
name|u64
operator|)
name|be32_to_cpu
argument_list|(
operator|(
name|__force
name|__be32
operator|)
name|__raw_readl
argument_list|(
name|hcr
operator|+
name|HCR_OUT_PARAM_OFFSET
argument_list|)
argument_list|)
operator|<<
literal|32
operator||
operator|(
name|u64
operator|)
name|be32_to_cpu
argument_list|(
operator|(
name|__force
name|__be32
operator|)
name|__raw_readl
argument_list|(
name|hcr
operator|+
name|HCR_OUT_PARAM_OFFSET
operator|+
literal|4
argument_list|)
argument_list|)
expr_stmt|;
name|stat
operator|=
name|be32_to_cpu
argument_list|(
operator|(
name|__force
name|__be32
operator|)
name|__raw_readl
argument_list|(
name|hcr
operator|+
name|HCR_STATUS_OFFSET
argument_list|)
argument_list|)
operator|>>
literal|24
expr_stmt|;
name|err
operator|=
name|mlx4_status_to_errno
argument_list|(
name|stat
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|mlx4_err
argument_list|(
name|dev
argument_list|,
literal|"command %s (0x%x) failed: fw status = 0x%x\n"
argument_list|,
name|cmd_to_str
argument_list|(
name|op
argument_list|)
argument_list|,
name|op
argument_list|,
name|stat
argument_list|)
expr_stmt|;
name|out
label|:
name|up
argument_list|(
operator|&
name|priv
operator|->
name|cmd
operator|.
name|poll_sem
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|void
name|mlx4_cmd_event
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|u16
name|token
parameter_list|,
name|u8
name|status
parameter_list|,
name|u64
name|out_param
parameter_list|)
block|{
name|struct
name|mlx4_priv
modifier|*
name|priv
init|=
name|mlx4_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|mlx4_cmd_context
modifier|*
name|context
init|=
operator|&
name|priv
operator|->
name|cmd
operator|.
name|context
index|[
name|token
operator|&
name|priv
operator|->
name|cmd
operator|.
name|token_mask
index|]
decl_stmt|;
comment|/* previously timed out command completing at long last */
if|if
condition|(
name|token
operator|!=
name|context
operator|->
name|token
condition|)
return|return;
name|context
operator|->
name|fw_status
operator|=
name|status
expr_stmt|;
name|context
operator|->
name|result
operator|=
name|mlx4_status_to_errno
argument_list|(
name|status
argument_list|)
expr_stmt|;
name|context
operator|->
name|out_param
operator|=
name|out_param
expr_stmt|;
name|complete
argument_list|(
operator|&
name|context
operator|->
name|done
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_cmd_wait
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|u64
name|in_param
parameter_list|,
name|u64
modifier|*
name|out_param
parameter_list|,
name|int
name|out_is_imm
parameter_list|,
name|u32
name|in_modifier
parameter_list|,
name|u8
name|op_modifier
parameter_list|,
name|u16
name|op
parameter_list|,
name|unsigned
name|long
name|timeout
parameter_list|)
block|{
name|struct
name|mlx4_cmd
modifier|*
name|cmd
init|=
operator|&
name|mlx4_priv
argument_list|(
name|dev
argument_list|)
operator|->
name|cmd
decl_stmt|;
name|struct
name|mlx4_cmd_context
modifier|*
name|context
decl_stmt|;
name|int
name|err
init|=
literal|0
decl_stmt|;
name|int
name|go_bit
init|=
literal|0
decl_stmt|,
name|t_bit
init|=
literal|0
decl_stmt|,
name|stat_err
decl_stmt|;
name|u32
name|status
init|=
literal|0
decl_stmt|;
name|struct
name|timespec
name|ts1
decl_stmt|,
name|ts2
decl_stmt|;
name|ktime_t
name|t1
decl_stmt|,
name|t2
decl_stmt|,
name|delta
decl_stmt|;
name|s64
name|ds
decl_stmt|;
if|if
condition|(
name|out_is_imm
operator|&&
operator|!
name|out_param
condition|)
return|return
operator|-
name|EINVAL
return|;
name|down
argument_list|(
operator|&
name|cmd
operator|->
name|event_sem
argument_list|)
expr_stmt|;
name|spin_lock
argument_list|(
operator|&
name|cmd
operator|->
name|context_lock
argument_list|)
expr_stmt|;
name|BUG_ON
argument_list|(
name|cmd
operator|->
name|free_head
operator|<
literal|0
argument_list|)
expr_stmt|;
name|context
operator|=
operator|&
name|cmd
operator|->
name|context
index|[
name|cmd
operator|->
name|free_head
index|]
expr_stmt|;
name|context
operator|->
name|token
operator|+=
name|cmd
operator|->
name|token_mask
operator|+
literal|1
expr_stmt|;
name|cmd
operator|->
name|free_head
operator|=
name|context
operator|->
name|next
expr_stmt|;
name|spin_unlock
argument_list|(
operator|&
name|cmd
operator|->
name|context_lock
argument_list|)
expr_stmt|;
name|init_completion
argument_list|(
operator|&
name|context
operator|->
name|done
argument_list|)
expr_stmt|;
name|err
operator|=
name|mlx4_cmd_post
argument_list|(
name|dev
argument_list|,
operator|&
name|ts1
argument_list|,
name|in_param
argument_list|,
name|out_param
condition|?
operator|*
name|out_param
else|:
literal|0
argument_list|,
name|in_modifier
argument_list|,
name|op_modifier
argument_list|,
name|op
argument_list|,
name|context
operator|->
name|token
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
operator|!
name|wait_for_completion_timeout
argument_list|(
operator|&
name|context
operator|->
name|done
argument_list|,
name|msecs_to_jiffies
argument_list|(
name|timeout
argument_list|)
argument_list|)
condition|)
block|{
name|stat_err
operator|=
name|get_status
argument_list|(
name|dev
argument_list|,
operator|&
name|status
argument_list|,
operator|&
name|go_bit
argument_list|,
operator|&
name|t_bit
argument_list|)
expr_stmt|;
name|mlx4_warn
argument_list|(
name|dev
argument_list|,
literal|"command %s (0x%x) timed out: in_param=0x%llx, "
literal|"in_mod=0x%x, op_mod=0x%x, get_status err=%d, "
literal|"status_reg=0x%x, go_bit=%d, t_bit=%d, toggle=0x%x\n"
argument_list|,
name|cmd_to_str
argument_list|(
name|op
argument_list|)
argument_list|,
name|op
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|in_param
argument_list|,
name|in_modifier
argument_list|,
name|op_modifier
argument_list|,
name|stat_err
argument_list|,
name|status
argument_list|,
name|go_bit
argument_list|,
name|t_bit
argument_list|,
name|mlx4_priv
argument_list|(
name|dev
argument_list|)
operator|->
name|cmd
operator|.
name|toggle
argument_list|)
expr_stmt|;
name|err
operator|=
operator|-
name|EBUSY
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|mlx4_debug_level
operator|&
name|MLX4_DEBUG_MASK_CMD_TIME
condition|)
block|{
name|ktime_get_ts
argument_list|(
operator|&
name|ts2
argument_list|)
expr_stmt|;
name|t1
operator|=
name|timespec_to_ktime
argument_list|(
name|ts1
argument_list|)
expr_stmt|;
name|t2
operator|=
name|timespec_to_ktime
argument_list|(
name|ts2
argument_list|)
expr_stmt|;
name|delta
operator|=
name|ktime_sub
argument_list|(
name|t2
argument_list|,
name|t1
argument_list|)
expr_stmt|;
name|ds
operator|=
name|ktime_to_ns
argument_list|(
name|delta
argument_list|)
expr_stmt|;
name|pr_info
argument_list|(
literal|"mlx4: fw exec time for %s is %lld nsec\n"
argument_list|,
name|cmd_to_str
argument_list|(
name|op
argument_list|)
argument_list|,
operator|(
name|long
name|long
operator|)
name|ds
argument_list|)
expr_stmt|;
block|}
name|err
operator|=
name|context
operator|->
name|result
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|mlx4_err
argument_list|(
name|dev
argument_list|,
literal|"command %s (0x%x) failed: in_param=0x%llx, "
literal|"in_mod=0x%x, op_mod=0x%x, fw status = 0x%x\n"
argument_list|,
name|cmd_to_str
argument_list|(
name|op
argument_list|)
argument_list|,
name|op
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|in_param
argument_list|,
name|in_modifier
argument_list|,
name|op_modifier
argument_list|,
name|context
operator|->
name|fw_status
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|context
operator|->
name|fw_status
condition|)
block|{
case|case
name|CMD_STAT_BAD_PARAM
case|:
name|mlx4_err
argument_list|(
name|dev
argument_list|,
literal|"Parameter is not supported, "
literal|"parameter is out of range\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|CMD_STAT_EXCEED_LIM
case|:
name|mlx4_err
argument_list|(
name|dev
argument_list|,
literal|"Required capability exceeded "
literal|"device limits\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|out_is_imm
condition|)
operator|*
name|out_param
operator|=
name|context
operator|->
name|out_param
expr_stmt|;
name|out
label|:
name|spin_lock
argument_list|(
operator|&
name|cmd
operator|->
name|context_lock
argument_list|)
expr_stmt|;
name|context
operator|->
name|next
operator|=
name|cmd
operator|->
name|free_head
expr_stmt|;
name|cmd
operator|->
name|free_head
operator|=
name|context
operator|-
name|cmd
operator|->
name|context
expr_stmt|;
name|spin_unlock
argument_list|(
operator|&
name|cmd
operator|->
name|context_lock
argument_list|)
expr_stmt|;
name|up
argument_list|(
operator|&
name|cmd
operator|->
name|event_sem
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|int
name|__mlx4_cmd
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|u64
name|in_param
parameter_list|,
name|u64
modifier|*
name|out_param
parameter_list|,
name|int
name|out_is_imm
parameter_list|,
name|u32
name|in_modifier
parameter_list|,
name|u8
name|op_modifier
parameter_list|,
name|u16
name|op
parameter_list|,
name|unsigned
name|long
name|timeout
parameter_list|,
name|int
name|native
parameter_list|)
block|{
if|if
condition|(
name|pci_channel_offline
argument_list|(
name|dev
operator|->
name|pdev
argument_list|)
condition|)
return|return
operator|-
name|EIO
return|;
if|if
condition|(
operator|!
name|mlx4_is_mfunc
argument_list|(
name|dev
argument_list|)
operator|||
operator|(
name|native
operator|&&
name|mlx4_is_master
argument_list|(
name|dev
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
name|mlx4_priv
argument_list|(
name|dev
argument_list|)
operator|->
name|cmd
operator|.
name|use_events
condition|)
return|return
name|mlx4_cmd_wait
argument_list|(
name|dev
argument_list|,
name|in_param
argument_list|,
name|out_param
argument_list|,
name|out_is_imm
argument_list|,
name|in_modifier
argument_list|,
name|op_modifier
argument_list|,
name|op
argument_list|,
name|timeout
argument_list|)
return|;
else|else
return|return
name|mlx4_cmd_poll
argument_list|(
name|dev
argument_list|,
name|in_param
argument_list|,
name|out_param
argument_list|,
name|out_is_imm
argument_list|,
name|in_modifier
argument_list|,
name|op_modifier
argument_list|,
name|op
argument_list|,
name|timeout
argument_list|)
return|;
block|}
return|return
name|mlx4_slave_cmd
argument_list|(
name|dev
argument_list|,
name|in_param
argument_list|,
name|out_param
argument_list|,
name|out_is_imm
argument_list|,
name|in_modifier
argument_list|,
name|op_modifier
argument_list|,
name|op
argument_list|,
name|timeout
argument_list|)
return|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL_GPL
argument_list|(
name|__mlx4_cmd
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|int
name|mlx4_ARM_COMM_CHANNEL
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|)
block|{
return|return
name|mlx4_cmd
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|MLX4_CMD_ARM_COMM_CHANNEL
argument_list|,
name|MLX4_CMD_TIME_CLASS_B
argument_list|,
name|MLX4_CMD_NATIVE
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_ACCESS_MEM
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|u64
name|master_addr
parameter_list|,
name|int
name|slave
parameter_list|,
name|u64
name|slave_addr
parameter_list|,
name|int
name|size
parameter_list|,
name|int
name|is_read
parameter_list|)
block|{
name|u64
name|in_param
decl_stmt|;
name|u64
name|out_param
decl_stmt|;
if|if
condition|(
operator|(
name|slave_addr
operator|&
literal|0xfff
operator|)
operator||
operator|(
name|master_addr
operator|&
literal|0xfff
operator|)
operator||
operator|(
name|slave
operator|&
operator|~
literal|0x7f
operator|)
operator||
operator|(
name|size
operator|&
literal|0xff
operator|)
condition|)
block|{
name|mlx4_err
argument_list|(
name|dev
argument_list|,
literal|"Bad access mem params - slave_addr:0x%llx "
literal|"master_addr:0x%llx slave_id:%d size:%d\n"
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|slave_addr
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|master_addr
argument_list|,
name|slave
argument_list|,
name|size
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|is_read
condition|)
block|{
name|in_param
operator|=
operator|(
name|u64
operator|)
name|slave
operator||
name|slave_addr
expr_stmt|;
name|out_param
operator|=
operator|(
name|u64
operator|)
name|dev
operator|->
name|caps
operator|.
name|function
operator||
name|master_addr
expr_stmt|;
block|}
else|else
block|{
name|in_param
operator|=
operator|(
name|u64
operator|)
name|dev
operator|->
name|caps
operator|.
name|function
operator||
name|master_addr
expr_stmt|;
name|out_param
operator|=
operator|(
name|u64
operator|)
name|slave
operator||
name|slave_addr
expr_stmt|;
block|}
return|return
name|mlx4_cmd_imm
argument_list|(
name|dev
argument_list|,
name|in_param
argument_list|,
operator|&
name|out_param
argument_list|,
name|size
argument_list|,
literal|0
argument_list|,
name|MLX4_CMD_ACCESS_MEM
argument_list|,
name|MLX4_CMD_TIME_CLASS_A
argument_list|,
name|MLX4_CMD_NATIVE
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|query_pkey_block
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|u8
name|port
parameter_list|,
name|u16
name|index
parameter_list|,
name|u16
modifier|*
name|pkey
parameter_list|,
name|struct
name|mlx4_cmd_mailbox
modifier|*
name|inbox
parameter_list|,
name|struct
name|mlx4_cmd_mailbox
modifier|*
name|outbox
parameter_list|)
block|{
name|struct
name|ib_smp
modifier|*
name|in_mad
init|=
operator|(
expr|struct
name|ib_smp
operator|*
operator|)
operator|(
name|inbox
operator|->
name|buf
operator|)
decl_stmt|;
name|struct
name|ib_smp
modifier|*
name|out_mad
init|=
operator|(
expr|struct
name|ib_smp
operator|*
operator|)
operator|(
name|outbox
operator|->
name|buf
operator|)
decl_stmt|;
name|int
name|err
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|index
operator|&
literal|0x1f
condition|)
return|return
operator|-
name|EINVAL
return|;
name|in_mad
operator|->
name|attr_mod
operator|=
name|cpu_to_be32
argument_list|(
name|index
operator|/
literal|32
argument_list|)
expr_stmt|;
name|err
operator|=
name|mlx4_cmd_box
argument_list|(
name|dev
argument_list|,
name|inbox
operator|->
name|dma
argument_list|,
name|outbox
operator|->
name|dma
argument_list|,
name|port
argument_list|,
literal|3
argument_list|,
name|MLX4_CMD_MAD_IFC
argument_list|,
name|MLX4_CMD_TIME_CLASS_C
argument_list|,
name|MLX4_CMD_NATIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
operator|++
name|i
control|)
name|pkey
index|[
name|i
index|]
operator|=
name|be16_to_cpu
argument_list|(
operator|(
operator|(
name|__be16
operator|*
operator|)
name|out_mad
operator|->
name|data
operator|)
index|[
name|i
index|]
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|get_full_pkey_table
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|u8
name|port
parameter_list|,
name|u16
modifier|*
name|table
parameter_list|,
name|struct
name|mlx4_cmd_mailbox
modifier|*
name|inbox
parameter_list|,
name|struct
name|mlx4_cmd_mailbox
modifier|*
name|outbox
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|err
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dev
operator|->
name|caps
operator|.
name|pkey_table_len
index|[
name|port
index|]
condition|;
name|i
operator|+=
literal|32
control|)
block|{
name|err
operator|=
name|query_pkey_block
argument_list|(
name|dev
argument_list|,
name|port
argument_list|,
name|i
argument_list|,
name|table
operator|+
name|i
argument_list|,
name|inbox
argument_list|,
name|outbox
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_define
define|#
directive|define
name|PORT_CAPABILITY_LOCATION_IN_SMP
value|20
end_define

begin_define
define|#
directive|define
name|PORT_STATE_OFFSET
value|32
end_define

begin_function
specifier|static
name|enum
name|ib_port_state
name|vf_port_state
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|int
name|port
parameter_list|,
name|int
name|vf
parameter_list|)
block|{
if|if
condition|(
name|mlx4_get_slave_port_state
argument_list|(
name|dev
argument_list|,
name|vf
argument_list|,
name|port
argument_list|)
operator|==
name|SLAVE_PORT_UP
condition|)
return|return
name|IB_PORT_ACTIVE
return|;
else|else
return|return
name|IB_PORT_DOWN
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_MAD_IFC_wrapper
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|int
name|slave
parameter_list|,
name|struct
name|mlx4_vhcr
modifier|*
name|vhcr
parameter_list|,
name|struct
name|mlx4_cmd_mailbox
modifier|*
name|inbox
parameter_list|,
name|struct
name|mlx4_cmd_mailbox
modifier|*
name|outbox
parameter_list|,
name|struct
name|mlx4_cmd_info
modifier|*
name|cmd
parameter_list|)
block|{
name|struct
name|ib_smp
modifier|*
name|smp
init|=
name|inbox
operator|->
name|buf
decl_stmt|;
name|u32
name|index
decl_stmt|;
name|u8
name|port
decl_stmt|;
name|u16
modifier|*
name|table
decl_stmt|;
name|int
name|err
decl_stmt|;
name|int
name|vidx
decl_stmt|,
name|pidx
decl_stmt|;
name|struct
name|mlx4_priv
modifier|*
name|priv
init|=
name|mlx4_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ib_smp
modifier|*
name|outsmp
init|=
name|outbox
operator|->
name|buf
decl_stmt|;
name|__be16
modifier|*
name|outtab
init|=
operator|(
name|__be16
operator|*
operator|)
operator|(
name|outsmp
operator|->
name|data
operator|)
decl_stmt|;
name|__be32
name|slave_cap_mask
decl_stmt|;
name|__be64
name|slave_node_guid
decl_stmt|;
name|port
operator|=
name|vhcr
operator|->
name|in_modifier
expr_stmt|;
if|if
condition|(
name|smp
operator|->
name|base_version
operator|==
literal|1
operator|&&
name|smp
operator|->
name|mgmt_class
operator|==
name|IB_MGMT_CLASS_SUBN_LID_ROUTED
operator|&&
name|smp
operator|->
name|class_version
operator|==
literal|1
condition|)
block|{
if|if
condition|(
name|smp
operator|->
name|method
operator|==
name|IB_MGMT_METHOD_GET
condition|)
block|{
if|if
condition|(
name|smp
operator|->
name|attr_id
operator|==
name|IB_SMP_ATTR_PKEY_TABLE
condition|)
block|{
name|index
operator|=
name|be32_to_cpu
argument_list|(
name|smp
operator|->
name|attr_mod
argument_list|)
expr_stmt|;
if|if
condition|(
name|port
operator|<
literal|1
operator|||
name|port
operator|>
name|dev
operator|->
name|caps
operator|.
name|num_ports
condition|)
return|return
operator|-
name|EINVAL
return|;
name|table
operator|=
name|kcalloc
argument_list|(
name|dev
operator|->
name|caps
operator|.
name|pkey_table_len
index|[
name|port
index|]
argument_list|,
sizeof|sizeof
expr|*
name|table
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|table
condition|)
return|return
operator|-
name|ENOMEM
return|;
comment|/* need to get the full pkey table because the paravirtualized 				 * pkeys may be scattered among several pkey blocks. 				 */
name|err
operator|=
name|get_full_pkey_table
argument_list|(
name|dev
argument_list|,
name|port
argument_list|,
name|table
argument_list|,
name|inbox
argument_list|,
name|outbox
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|err
condition|)
block|{
for|for
control|(
name|vidx
operator|=
name|index
operator|*
literal|32
init|;
name|vidx
operator|<
operator|(
name|index
operator|+
literal|1
operator|)
operator|*
literal|32
condition|;
operator|++
name|vidx
control|)
block|{
name|pidx
operator|=
name|priv
operator|->
name|virt2phys_pkey
index|[
name|slave
index|]
index|[
name|port
operator|-
literal|1
index|]
index|[
name|vidx
index|]
expr_stmt|;
name|outtab
index|[
name|vidx
operator|%
literal|32
index|]
operator|=
name|cpu_to_be16
argument_list|(
name|table
index|[
name|pidx
index|]
argument_list|)
expr_stmt|;
block|}
block|}
name|kfree
argument_list|(
name|table
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
if|if
condition|(
name|smp
operator|->
name|attr_id
operator|==
name|IB_SMP_ATTR_PORT_INFO
condition|)
block|{
comment|/*get the slave specific caps:*/
comment|/*do the command */
name|err
operator|=
name|mlx4_cmd_box
argument_list|(
name|dev
argument_list|,
name|inbox
operator|->
name|dma
argument_list|,
name|outbox
operator|->
name|dma
argument_list|,
name|vhcr
operator|->
name|in_modifier
argument_list|,
name|vhcr
operator|->
name|op_modifier
argument_list|,
name|vhcr
operator|->
name|op
argument_list|,
name|MLX4_CMD_TIME_CLASS_C
argument_list|,
name|MLX4_CMD_NATIVE
argument_list|)
expr_stmt|;
comment|/* modify the response for slaves */
if|if
condition|(
operator|!
name|err
operator|&&
name|slave
operator|!=
name|mlx4_master_func_num
argument_list|(
name|dev
argument_list|)
condition|)
block|{
name|u8
modifier|*
name|state
init|=
name|outsmp
operator|->
name|data
operator|+
name|PORT_STATE_OFFSET
decl_stmt|;
operator|*
name|state
operator|=
operator|(
operator|*
name|state
operator|&
literal|0xf0
operator|)
operator||
name|vf_port_state
argument_list|(
name|dev
argument_list|,
name|port
argument_list|,
name|slave
argument_list|)
expr_stmt|;
name|slave_cap_mask
operator|=
name|priv
operator|->
name|mfunc
operator|.
name|master
operator|.
name|slave_state
index|[
name|slave
index|]
operator|.
name|ib_cap_mask
index|[
name|port
index|]
expr_stmt|;
name|memcpy
argument_list|(
name|outsmp
operator|->
name|data
operator|+
name|PORT_CAPABILITY_LOCATION_IN_SMP
argument_list|,
operator|&
name|slave_cap_mask
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
return|return
name|err
return|;
block|}
if|if
condition|(
name|smp
operator|->
name|attr_id
operator|==
name|IB_SMP_ATTR_GUID_INFO
condition|)
block|{
comment|/* compute slave's gid block */
name|smp
operator|->
name|attr_mod
operator|=
name|cpu_to_be32
argument_list|(
name|slave
operator|/
literal|8
argument_list|)
expr_stmt|;
comment|/* execute cmd */
name|err
operator|=
name|mlx4_cmd_box
argument_list|(
name|dev
argument_list|,
name|inbox
operator|->
name|dma
argument_list|,
name|outbox
operator|->
name|dma
argument_list|,
name|vhcr
operator|->
name|in_modifier
argument_list|,
name|vhcr
operator|->
name|op_modifier
argument_list|,
name|vhcr
operator|->
name|op
argument_list|,
name|MLX4_CMD_TIME_CLASS_C
argument_list|,
name|MLX4_CMD_NATIVE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|err
condition|)
block|{
comment|/* if needed, move slave gid to index 0 */
if|if
condition|(
name|slave
operator|%
literal|8
condition|)
name|memcpy
argument_list|(
name|outsmp
operator|->
name|data
argument_list|,
name|outsmp
operator|->
name|data
operator|+
operator|(
name|slave
operator|%
literal|8
operator|)
operator|*
literal|8
argument_list|,
literal|8
argument_list|)
expr_stmt|;
comment|/* delete all other gids */
name|memset
argument_list|(
name|outsmp
operator|->
name|data
operator|+
literal|8
argument_list|,
literal|0
argument_list|,
literal|56
argument_list|)
expr_stmt|;
block|}
return|return
name|err
return|;
block|}
if|if
condition|(
name|smp
operator|->
name|attr_id
operator|==
name|IB_SMP_ATTR_NODE_INFO
condition|)
block|{
name|err
operator|=
name|mlx4_cmd_box
argument_list|(
name|dev
argument_list|,
name|inbox
operator|->
name|dma
argument_list|,
name|outbox
operator|->
name|dma
argument_list|,
name|vhcr
operator|->
name|in_modifier
argument_list|,
name|vhcr
operator|->
name|op_modifier
argument_list|,
name|vhcr
operator|->
name|op
argument_list|,
name|MLX4_CMD_TIME_CLASS_C
argument_list|,
name|MLX4_CMD_NATIVE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|err
condition|)
block|{
name|slave_node_guid
operator|=
name|mlx4_get_slave_node_guid
argument_list|(
name|dev
argument_list|,
name|slave
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|outsmp
operator|->
name|data
operator|+
literal|12
argument_list|,
operator|&
name|slave_node_guid
argument_list|,
literal|8
argument_list|)
expr_stmt|;
block|}
return|return
name|err
return|;
block|}
block|}
block|}
if|if
condition|(
name|slave
operator|!=
name|mlx4_master_func_num
argument_list|(
name|dev
argument_list|)
operator|&&
operator|(
operator|(
name|smp
operator|->
name|mgmt_class
operator|==
name|IB_MGMT_CLASS_SUBN_DIRECTED_ROUTE
operator|)
operator|||
operator|(
name|smp
operator|->
name|mgmt_class
operator|==
name|IB_MGMT_CLASS_SUBN_LID_ROUTED
operator|&&
name|smp
operator|->
name|method
operator|==
name|IB_MGMT_METHOD_SET
operator|)
operator|)
condition|)
block|{
name|mlx4_err
argument_list|(
name|dev
argument_list|,
literal|"slave %d is trying to execute a Subnet MGMT MAD, "
literal|"class 0x%x, method 0x%x for attr 0x%x. Rejecting\n"
argument_list|,
name|slave
argument_list|,
name|smp
operator|->
name|method
argument_list|,
name|smp
operator|->
name|mgmt_class
argument_list|,
name|be16_to_cpu
argument_list|(
name|smp
operator|->
name|attr_id
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EPERM
return|;
block|}
comment|/*default:*/
return|return
name|mlx4_cmd_box
argument_list|(
name|dev
argument_list|,
name|inbox
operator|->
name|dma
argument_list|,
name|outbox
operator|->
name|dma
argument_list|,
name|vhcr
operator|->
name|in_modifier
argument_list|,
name|vhcr
operator|->
name|op_modifier
argument_list|,
name|vhcr
operator|->
name|op
argument_list|,
name|MLX4_CMD_TIME_CLASS_C
argument_list|,
name|MLX4_CMD_NATIVE
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|MLX4_CMD_DIAG_RPRT_wrapper
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|int
name|slave
parameter_list|,
name|struct
name|mlx4_vhcr
modifier|*
name|vhcr
parameter_list|,
name|struct
name|mlx4_cmd_mailbox
modifier|*
name|inbox
parameter_list|,
name|struct
name|mlx4_cmd_mailbox
modifier|*
name|outbox
parameter_list|,
name|struct
name|mlx4_cmd_info
modifier|*
name|cmd
parameter_list|)
block|{
return|return
operator|-
name|EPERM
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|MLX4_CMD_UPDATE_QP_wrapper
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|int
name|slave
parameter_list|,
name|struct
name|mlx4_vhcr
modifier|*
name|vhcr
parameter_list|,
name|struct
name|mlx4_cmd_mailbox
modifier|*
name|inbox
parameter_list|,
name|struct
name|mlx4_cmd_mailbox
modifier|*
name|outbox
parameter_list|,
name|struct
name|mlx4_cmd_info
modifier|*
name|cmd
parameter_list|)
block|{
return|return
operator|-
name|EPERM
return|;
block|}
end_function

begin_function
name|int
name|mlx4_DMA_wrapper
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|int
name|slave
parameter_list|,
name|struct
name|mlx4_vhcr
modifier|*
name|vhcr
parameter_list|,
name|struct
name|mlx4_cmd_mailbox
modifier|*
name|inbox
parameter_list|,
name|struct
name|mlx4_cmd_mailbox
modifier|*
name|outbox
parameter_list|,
name|struct
name|mlx4_cmd_info
modifier|*
name|cmd
parameter_list|)
block|{
name|u64
name|in_param
decl_stmt|;
name|u64
name|out_param
decl_stmt|;
name|int
name|err
decl_stmt|;
name|in_param
operator|=
name|cmd
operator|->
name|has_inbox
condition|?
operator|(
name|u64
operator|)
name|inbox
operator|->
name|dma
else|:
name|vhcr
operator|->
name|in_param
expr_stmt|;
name|out_param
operator|=
name|cmd
operator|->
name|has_outbox
condition|?
operator|(
name|u64
operator|)
name|outbox
operator|->
name|dma
else|:
name|vhcr
operator|->
name|out_param
expr_stmt|;
if|if
condition|(
name|cmd
operator|->
name|encode_slave_id
condition|)
block|{
name|in_param
operator|&=
literal|0xffffffffffffff00ll
expr_stmt|;
name|in_param
operator||=
name|slave
expr_stmt|;
block|}
name|err
operator|=
name|__mlx4_cmd
argument_list|(
name|dev
argument_list|,
name|in_param
argument_list|,
operator|&
name|out_param
argument_list|,
name|cmd
operator|->
name|out_is_imm
argument_list|,
name|vhcr
operator|->
name|in_modifier
argument_list|,
name|vhcr
operator|->
name|op_modifier
argument_list|,
name|vhcr
operator|->
name|op
argument_list|,
name|MLX4_CMD_TIME_CLASS_A
argument_list|,
name|MLX4_CMD_NATIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd
operator|->
name|out_is_imm
condition|)
name|vhcr
operator|->
name|out_param
operator|=
name|out_param
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|struct
name|mlx4_cmd_info
name|cmd_info
index|[]
init|=
block|{
block|{
operator|.
name|opcode
operator|=
name|MLX4_CMD_QUERY_FW
block|,
operator|.
name|has_inbox
operator|=
name|false
block|,
operator|.
name|has_outbox
operator|=
name|true
block|,
operator|.
name|out_is_imm
operator|=
name|false
block|,
operator|.
name|encode_slave_id
operator|=
name|false
block|,
operator|.
name|verify
operator|=
name|NULL
block|,
operator|.
name|wrapper
operator|=
name|mlx4_QUERY_FW_wrapper
block|}
block|,
block|{
operator|.
name|opcode
operator|=
name|MLX4_CMD_QUERY_HCA
block|,
operator|.
name|has_inbox
operator|=
name|false
block|,
operator|.
name|has_outbox
operator|=
name|true
block|,
operator|.
name|out_is_imm
operator|=
name|false
block|,
operator|.
name|encode_slave_id
operator|=
name|false
block|,
operator|.
name|verify
operator|=
name|NULL
block|,
operator|.
name|wrapper
operator|=
name|NULL
block|}
block|,
block|{
operator|.
name|opcode
operator|=
name|MLX4_CMD_QUERY_DEV_CAP
block|,
operator|.
name|has_inbox
operator|=
name|false
block|,
operator|.
name|has_outbox
operator|=
name|true
block|,
operator|.
name|out_is_imm
operator|=
name|false
block|,
operator|.
name|encode_slave_id
operator|=
name|false
block|,
operator|.
name|verify
operator|=
name|NULL
block|,
operator|.
name|wrapper
operator|=
name|mlx4_QUERY_DEV_CAP_wrapper
block|}
block|,
block|{
operator|.
name|opcode
operator|=
name|MLX4_CMD_QUERY_FUNC_CAP
block|,
operator|.
name|has_inbox
operator|=
name|false
block|,
operator|.
name|has_outbox
operator|=
name|true
block|,
operator|.
name|out_is_imm
operator|=
name|false
block|,
operator|.
name|encode_slave_id
operator|=
name|false
block|,
operator|.
name|verify
operator|=
name|NULL
block|,
operator|.
name|wrapper
operator|=
name|mlx4_QUERY_FUNC_CAP_wrapper
block|}
block|,
block|{
operator|.
name|opcode
operator|=
name|MLX4_CMD_QUERY_ADAPTER
block|,
operator|.
name|has_inbox
operator|=
name|false
block|,
operator|.
name|has_outbox
operator|=
name|true
block|,
operator|.
name|out_is_imm
operator|=
name|false
block|,
operator|.
name|encode_slave_id
operator|=
name|false
block|,
operator|.
name|verify
operator|=
name|NULL
block|,
operator|.
name|wrapper
operator|=
name|NULL
block|}
block|,
block|{
operator|.
name|opcode
operator|=
name|MLX4_CMD_INIT_PORT
block|,
operator|.
name|has_inbox
operator|=
name|false
block|,
operator|.
name|has_outbox
operator|=
name|false
block|,
operator|.
name|out_is_imm
operator|=
name|false
block|,
operator|.
name|encode_slave_id
operator|=
name|false
block|,
operator|.
name|verify
operator|=
name|NULL
block|,
operator|.
name|wrapper
operator|=
name|mlx4_INIT_PORT_wrapper
block|}
block|,
block|{
operator|.
name|opcode
operator|=
name|MLX4_CMD_CLOSE_PORT
block|,
operator|.
name|has_inbox
operator|=
name|false
block|,
operator|.
name|has_outbox
operator|=
name|false
block|,
operator|.
name|out_is_imm
operator|=
name|false
block|,
operator|.
name|encode_slave_id
operator|=
name|false
block|,
operator|.
name|verify
operator|=
name|NULL
block|,
operator|.
name|wrapper
operator|=
name|mlx4_CLOSE_PORT_wrapper
block|}
block|,
block|{
operator|.
name|opcode
operator|=
name|MLX4_CMD_QUERY_PORT
block|,
operator|.
name|has_inbox
operator|=
name|false
block|,
operator|.
name|has_outbox
operator|=
name|true
block|,
operator|.
name|out_is_imm
operator|=
name|false
block|,
operator|.
name|encode_slave_id
operator|=
name|false
block|,
operator|.
name|verify
operator|=
name|NULL
block|,
operator|.
name|wrapper
operator|=
name|mlx4_QUERY_PORT_wrapper
block|}
block|,
block|{
operator|.
name|opcode
operator|=
name|MLX4_CMD_SET_PORT
block|,
operator|.
name|has_inbox
operator|=
name|true
block|,
operator|.
name|has_outbox
operator|=
name|false
block|,
operator|.
name|out_is_imm
operator|=
name|false
block|,
operator|.
name|encode_slave_id
operator|=
name|false
block|,
operator|.
name|verify
operator|=
name|NULL
block|,
operator|.
name|wrapper
operator|=
name|mlx4_SET_PORT_wrapper
block|}
block|,
block|{
operator|.
name|opcode
operator|=
name|MLX4_CMD_MAP_EQ
block|,
operator|.
name|has_inbox
operator|=
name|false
block|,
operator|.
name|has_outbox
operator|=
name|false
block|,
operator|.
name|out_is_imm
operator|=
name|false
block|,
operator|.
name|encode_slave_id
operator|=
name|false
block|,
operator|.
name|verify
operator|=
name|NULL
block|,
operator|.
name|wrapper
operator|=
name|mlx4_MAP_EQ_wrapper
block|}
block|,
block|{
operator|.
name|opcode
operator|=
name|MLX4_CMD_SW2HW_EQ
block|,
operator|.
name|has_inbox
operator|=
name|true
block|,
operator|.
name|has_outbox
operator|=
name|false
block|,
operator|.
name|out_is_imm
operator|=
name|false
block|,
operator|.
name|encode_slave_id
operator|=
name|true
block|,
operator|.
name|verify
operator|=
name|NULL
block|,
operator|.
name|wrapper
operator|=
name|mlx4_SW2HW_EQ_wrapper
block|}
block|,
block|{
operator|.
name|opcode
operator|=
name|MLX4_CMD_HW_HEALTH_CHECK
block|,
operator|.
name|has_inbox
operator|=
name|false
block|,
operator|.
name|has_outbox
operator|=
name|false
block|,
operator|.
name|out_is_imm
operator|=
name|false
block|,
operator|.
name|encode_slave_id
operator|=
name|false
block|,
operator|.
name|verify
operator|=
name|NULL
block|,
operator|.
name|wrapper
operator|=
name|NULL
block|}
block|,
block|{
operator|.
name|opcode
operator|=
name|MLX4_CMD_DIAG_RPRT
block|,
operator|.
name|has_inbox
operator|=
name|false
block|,
operator|.
name|has_outbox
operator|=
name|false
block|,
operator|.
name|out_is_imm
operator|=
name|false
block|,
operator|.
name|encode_slave_id
operator|=
name|false
block|,
operator|.
name|skip_err_print
operator|=
name|true
block|,
operator|.
name|verify
operator|=
name|NULL
block|,
operator|.
name|wrapper
operator|=
name|MLX4_CMD_DIAG_RPRT_wrapper
block|}
block|,
block|{
operator|.
name|opcode
operator|=
name|MLX4_CMD_NOP
block|,
operator|.
name|has_inbox
operator|=
name|false
block|,
operator|.
name|has_outbox
operator|=
name|false
block|,
operator|.
name|out_is_imm
operator|=
name|false
block|,
operator|.
name|encode_slave_id
operator|=
name|false
block|,
operator|.
name|verify
operator|=
name|NULL
block|,
operator|.
name|wrapper
operator|=
name|NULL
block|}
block|,
block|{
operator|.
name|opcode
operator|=
name|MLX4_CMD_ALLOC_RES
block|,
operator|.
name|has_inbox
operator|=
name|false
block|,
operator|.
name|has_outbox
operator|=
name|false
block|,
operator|.
name|out_is_imm
operator|=
name|true
block|,
operator|.
name|encode_slave_id
operator|=
name|false
block|,
operator|.
name|verify
operator|=
name|NULL
block|,
operator|.
name|wrapper
operator|=
name|mlx4_ALLOC_RES_wrapper
block|}
block|,
block|{
operator|.
name|opcode
operator|=
name|MLX4_CMD_FREE_RES
block|,
operator|.
name|has_inbox
operator|=
name|false
block|,
operator|.
name|has_outbox
operator|=
name|false
block|,
operator|.
name|out_is_imm
operator|=
name|false
block|,
operator|.
name|encode_slave_id
operator|=
name|false
block|,
operator|.
name|verify
operator|=
name|NULL
block|,
operator|.
name|wrapper
operator|=
name|mlx4_FREE_RES_wrapper
block|}
block|,
block|{
operator|.
name|opcode
operator|=
name|MLX4_CMD_SW2HW_MPT
block|,
operator|.
name|has_inbox
operator|=
name|true
block|,
operator|.
name|has_outbox
operator|=
name|false
block|,
operator|.
name|out_is_imm
operator|=
name|false
block|,
operator|.
name|encode_slave_id
operator|=
name|true
block|,
operator|.
name|verify
operator|=
name|NULL
block|,
operator|.
name|wrapper
operator|=
name|mlx4_SW2HW_MPT_wrapper
block|}
block|,
block|{
operator|.
name|opcode
operator|=
name|MLX4_CMD_QUERY_MPT
block|,
operator|.
name|has_inbox
operator|=
name|false
block|,
operator|.
name|has_outbox
operator|=
name|true
block|,
operator|.
name|out_is_imm
operator|=
name|false
block|,
operator|.
name|encode_slave_id
operator|=
name|false
block|,
operator|.
name|verify
operator|=
name|NULL
block|,
operator|.
name|wrapper
operator|=
name|mlx4_QUERY_MPT_wrapper
block|}
block|,
block|{
operator|.
name|opcode
operator|=
name|MLX4_CMD_HW2SW_MPT
block|,
operator|.
name|has_inbox
operator|=
name|false
block|,
operator|.
name|has_outbox
operator|=
name|false
block|,
operator|.
name|out_is_imm
operator|=
name|false
block|,
operator|.
name|encode_slave_id
operator|=
name|false
block|,
operator|.
name|verify
operator|=
name|NULL
block|,
operator|.
name|wrapper
operator|=
name|mlx4_HW2SW_MPT_wrapper
block|}
block|,
block|{
operator|.
name|opcode
operator|=
name|MLX4_CMD_READ_MTT
block|,
operator|.
name|has_inbox
operator|=
name|false
block|,
operator|.
name|has_outbox
operator|=
name|true
block|,
operator|.
name|out_is_imm
operator|=
name|false
block|,
operator|.
name|encode_slave_id
operator|=
name|false
block|,
operator|.
name|verify
operator|=
name|NULL
block|,
operator|.
name|wrapper
operator|=
name|NULL
block|}
block|,
block|{
operator|.
name|opcode
operator|=
name|MLX4_CMD_WRITE_MTT
block|,
operator|.
name|has_inbox
operator|=
name|true
block|,
operator|.
name|has_outbox
operator|=
name|false
block|,
operator|.
name|out_is_imm
operator|=
name|false
block|,
operator|.
name|encode_slave_id
operator|=
name|false
block|,
operator|.
name|verify
operator|=
name|NULL
block|,
operator|.
name|wrapper
operator|=
name|mlx4_WRITE_MTT_wrapper
block|}
block|,
block|{
operator|.
name|opcode
operator|=
name|MLX4_CMD_SYNC_TPT
block|,
operator|.
name|has_inbox
operator|=
name|true
block|,
operator|.
name|has_outbox
operator|=
name|false
block|,
operator|.
name|out_is_imm
operator|=
name|false
block|,
operator|.
name|encode_slave_id
operator|=
name|false
block|,
operator|.
name|verify
operator|=
name|NULL
block|,
operator|.
name|wrapper
operator|=
name|NULL
block|}
block|,
block|{
operator|.
name|opcode
operator|=
name|MLX4_CMD_HW2SW_EQ
block|,
operator|.
name|has_inbox
operator|=
name|false
block|,
operator|.
name|has_outbox
operator|=
name|true
block|,
operator|.
name|out_is_imm
operator|=
name|false
block|,
operator|.
name|encode_slave_id
operator|=
name|true
block|,
operator|.
name|verify
operator|=
name|NULL
block|,
operator|.
name|wrapper
operator|=
name|mlx4_HW2SW_EQ_wrapper
block|}
block|,
block|{
operator|.
name|opcode
operator|=
name|MLX4_CMD_QUERY_EQ
block|,
operator|.
name|has_inbox
operator|=
name|false
block|,
operator|.
name|has_outbox
operator|=
name|true
block|,
operator|.
name|out_is_imm
operator|=
name|false
block|,
operator|.
name|encode_slave_id
operator|=
name|true
block|,
operator|.
name|verify
operator|=
name|NULL
block|,
operator|.
name|wrapper
operator|=
name|mlx4_QUERY_EQ_wrapper
block|}
block|,
block|{
operator|.
name|opcode
operator|=
name|MLX4_CMD_SW2HW_CQ
block|,
operator|.
name|has_inbox
operator|=
name|true
block|,
operator|.
name|has_outbox
operator|=
name|false
block|,
operator|.
name|out_is_imm
operator|=
name|false
block|,
operator|.
name|encode_slave_id
operator|=
name|true
block|,
operator|.
name|verify
operator|=
name|NULL
block|,
operator|.
name|wrapper
operator|=
name|mlx4_SW2HW_CQ_wrapper
block|}
block|,
block|{
operator|.
name|opcode
operator|=
name|MLX4_CMD_HW2SW_CQ
block|,
operator|.
name|has_inbox
operator|=
name|false
block|,
operator|.
name|has_outbox
operator|=
name|false
block|,
operator|.
name|out_is_imm
operator|=
name|false
block|,
operator|.
name|encode_slave_id
operator|=
name|false
block|,
operator|.
name|verify
operator|=
name|NULL
block|,
operator|.
name|wrapper
operator|=
name|mlx4_HW2SW_CQ_wrapper
block|}
block|,
block|{
operator|.
name|opcode
operator|=
name|MLX4_CMD_QUERY_CQ
block|,
operator|.
name|has_inbox
operator|=
name|false
block|,
operator|.
name|has_outbox
operator|=
name|true
block|,
operator|.
name|out_is_imm
operator|=
name|false
block|,
operator|.
name|encode_slave_id
operator|=
name|false
block|,
operator|.
name|verify
operator|=
name|NULL
block|,
operator|.
name|wrapper
operator|=
name|mlx4_QUERY_CQ_wrapper
block|}
block|,
block|{
operator|.
name|opcode
operator|=
name|MLX4_CMD_MODIFY_CQ
block|,
operator|.
name|has_inbox
operator|=
name|true
block|,
operator|.
name|has_outbox
operator|=
name|false
block|,
operator|.
name|out_is_imm
operator|=
name|true
block|,
operator|.
name|encode_slave_id
operator|=
name|false
block|,
operator|.
name|verify
operator|=
name|NULL
block|,
operator|.
name|wrapper
operator|=
name|mlx4_MODIFY_CQ_wrapper
block|}
block|,
block|{
operator|.
name|opcode
operator|=
name|MLX4_CMD_SW2HW_SRQ
block|,
operator|.
name|has_inbox
operator|=
name|true
block|,
operator|.
name|has_outbox
operator|=
name|false
block|,
operator|.
name|out_is_imm
operator|=
name|false
block|,
operator|.
name|encode_slave_id
operator|=
name|true
block|,
operator|.
name|verify
operator|=
name|NULL
block|,
operator|.
name|wrapper
operator|=
name|mlx4_SW2HW_SRQ_wrapper
block|}
block|,
block|{
operator|.
name|opcode
operator|=
name|MLX4_CMD_HW2SW_SRQ
block|,
operator|.
name|has_inbox
operator|=
name|false
block|,
operator|.
name|has_outbox
operator|=
name|false
block|,
operator|.
name|out_is_imm
operator|=
name|false
block|,
operator|.
name|encode_slave_id
operator|=
name|false
block|,
operator|.
name|verify
operator|=
name|NULL
block|,
operator|.
name|wrapper
operator|=
name|mlx4_HW2SW_SRQ_wrapper
block|}
block|,
block|{
operator|.
name|opcode
operator|=
name|MLX4_CMD_QUERY_SRQ
block|,
operator|.
name|has_inbox
operator|=
name|false
block|,
operator|.
name|has_outbox
operator|=
name|true
block|,
operator|.
name|out_is_imm
operator|=
name|false
block|,
operator|.
name|encode_slave_id
operator|=
name|false
block|,
operator|.
name|verify
operator|=
name|NULL
block|,
operator|.
name|wrapper
operator|=
name|mlx4_QUERY_SRQ_wrapper
block|}
block|,
block|{
operator|.
name|opcode
operator|=
name|MLX4_CMD_ARM_SRQ
block|,
operator|.
name|has_inbox
operator|=
name|false
block|,
operator|.
name|has_outbox
operator|=
name|false
block|,
operator|.
name|out_is_imm
operator|=
name|false
block|,
operator|.
name|encode_slave_id
operator|=
name|false
block|,
operator|.
name|verify
operator|=
name|NULL
block|,
operator|.
name|wrapper
operator|=
name|mlx4_ARM_SRQ_wrapper
block|}
block|,
block|{
operator|.
name|opcode
operator|=
name|MLX4_CMD_RST2INIT_QP
block|,
operator|.
name|has_inbox
operator|=
name|true
block|,
operator|.
name|has_outbox
operator|=
name|false
block|,
operator|.
name|out_is_imm
operator|=
name|false
block|,
operator|.
name|encode_slave_id
operator|=
name|true
block|,
operator|.
name|verify
operator|=
name|NULL
block|,
operator|.
name|wrapper
operator|=
name|mlx4_RST2INIT_QP_wrapper
block|}
block|,
block|{
operator|.
name|opcode
operator|=
name|MLX4_CMD_INIT2INIT_QP
block|,
operator|.
name|has_inbox
operator|=
name|true
block|,
operator|.
name|has_outbox
operator|=
name|false
block|,
operator|.
name|out_is_imm
operator|=
name|false
block|,
operator|.
name|encode_slave_id
operator|=
name|false
block|,
operator|.
name|verify
operator|=
name|NULL
block|,
operator|.
name|wrapper
operator|=
name|mlx4_INIT2INIT_QP_wrapper
block|}
block|,
block|{
operator|.
name|opcode
operator|=
name|MLX4_CMD_INIT2RTR_QP
block|,
operator|.
name|has_inbox
operator|=
name|true
block|,
operator|.
name|has_outbox
operator|=
name|false
block|,
operator|.
name|out_is_imm
operator|=
name|false
block|,
operator|.
name|encode_slave_id
operator|=
name|false
block|,
operator|.
name|verify
operator|=
name|NULL
block|,
operator|.
name|wrapper
operator|=
name|mlx4_INIT2RTR_QP_wrapper
block|}
block|,
block|{
operator|.
name|opcode
operator|=
name|MLX4_CMD_RTR2RTS_QP
block|,
operator|.
name|has_inbox
operator|=
name|true
block|,
operator|.
name|has_outbox
operator|=
name|false
block|,
operator|.
name|out_is_imm
operator|=
name|false
block|,
operator|.
name|encode_slave_id
operator|=
name|false
block|,
operator|.
name|verify
operator|=
name|NULL
block|,
operator|.
name|wrapper
operator|=
name|mlx4_RTR2RTS_QP_wrapper
block|}
block|,
block|{
operator|.
name|opcode
operator|=
name|MLX4_CMD_RTS2RTS_QP
block|,
operator|.
name|has_inbox
operator|=
name|true
block|,
operator|.
name|has_outbox
operator|=
name|false
block|,
operator|.
name|out_is_imm
operator|=
name|false
block|,
operator|.
name|encode_slave_id
operator|=
name|false
block|,
operator|.
name|verify
operator|=
name|NULL
block|,
operator|.
name|wrapper
operator|=
name|mlx4_RTS2RTS_QP_wrapper
block|}
block|,
block|{
operator|.
name|opcode
operator|=
name|MLX4_CMD_SQERR2RTS_QP
block|,
operator|.
name|has_inbox
operator|=
name|true
block|,
operator|.
name|has_outbox
operator|=
name|false
block|,
operator|.
name|out_is_imm
operator|=
name|false
block|,
operator|.
name|encode_slave_id
operator|=
name|false
block|,
operator|.
name|verify
operator|=
name|NULL
block|,
operator|.
name|wrapper
operator|=
name|mlx4_SQERR2RTS_QP_wrapper
block|}
block|,
block|{
operator|.
name|opcode
operator|=
name|MLX4_CMD_2ERR_QP
block|,
operator|.
name|has_inbox
operator|=
name|false
block|,
operator|.
name|has_outbox
operator|=
name|false
block|,
operator|.
name|out_is_imm
operator|=
name|false
block|,
operator|.
name|encode_slave_id
operator|=
name|false
block|,
operator|.
name|verify
operator|=
name|NULL
block|,
operator|.
name|wrapper
operator|=
name|mlx4_GEN_QP_wrapper
block|}
block|,
block|{
operator|.
name|opcode
operator|=
name|MLX4_CMD_RTS2SQD_QP
block|,
operator|.
name|has_inbox
operator|=
name|false
block|,
operator|.
name|has_outbox
operator|=
name|false
block|,
operator|.
name|out_is_imm
operator|=
name|false
block|,
operator|.
name|encode_slave_id
operator|=
name|false
block|,
operator|.
name|verify
operator|=
name|NULL
block|,
operator|.
name|wrapper
operator|=
name|mlx4_GEN_QP_wrapper
block|}
block|,
block|{
operator|.
name|opcode
operator|=
name|MLX4_CMD_SQD2SQD_QP
block|,
operator|.
name|has_inbox
operator|=
name|true
block|,
operator|.
name|has_outbox
operator|=
name|false
block|,
operator|.
name|out_is_imm
operator|=
name|false
block|,
operator|.
name|encode_slave_id
operator|=
name|false
block|,
operator|.
name|verify
operator|=
name|NULL
block|,
operator|.
name|wrapper
operator|=
name|mlx4_SQD2SQD_QP_wrapper
block|}
block|,
block|{
operator|.
name|opcode
operator|=
name|MLX4_CMD_SQD2RTS_QP
block|,
operator|.
name|has_inbox
operator|=
name|true
block|,
operator|.
name|has_outbox
operator|=
name|false
block|,
operator|.
name|out_is_imm
operator|=
name|false
block|,
operator|.
name|encode_slave_id
operator|=
name|false
block|,
operator|.
name|verify
operator|=
name|NULL
block|,
operator|.
name|wrapper
operator|=
name|mlx4_SQD2RTS_QP_wrapper
block|}
block|,
block|{
operator|.
name|opcode
operator|=
name|MLX4_CMD_2RST_QP
block|,
operator|.
name|has_inbox
operator|=
name|false
block|,
operator|.
name|has_outbox
operator|=
name|false
block|,
operator|.
name|out_is_imm
operator|=
name|false
block|,
operator|.
name|encode_slave_id
operator|=
name|false
block|,
operator|.
name|verify
operator|=
name|NULL
block|,
operator|.
name|wrapper
operator|=
name|mlx4_2RST_QP_wrapper
block|}
block|,
block|{
operator|.
name|opcode
operator|=
name|MLX4_CMD_QUERY_QP
block|,
operator|.
name|has_inbox
operator|=
name|false
block|,
operator|.
name|has_outbox
operator|=
name|true
block|,
operator|.
name|out_is_imm
operator|=
name|false
block|,
operator|.
name|encode_slave_id
operator|=
name|false
block|,
operator|.
name|verify
operator|=
name|NULL
block|,
operator|.
name|wrapper
operator|=
name|mlx4_GEN_QP_wrapper
block|}
block|,
block|{
operator|.
name|opcode
operator|=
name|MLX4_CMD_SUSPEND_QP
block|,
operator|.
name|has_inbox
operator|=
name|false
block|,
operator|.
name|has_outbox
operator|=
name|false
block|,
operator|.
name|out_is_imm
operator|=
name|false
block|,
operator|.
name|encode_slave_id
operator|=
name|false
block|,
operator|.
name|verify
operator|=
name|NULL
block|,
operator|.
name|wrapper
operator|=
name|mlx4_GEN_QP_wrapper
block|}
block|,
block|{
operator|.
name|opcode
operator|=
name|MLX4_CMD_UNSUSPEND_QP
block|,
operator|.
name|has_inbox
operator|=
name|false
block|,
operator|.
name|has_outbox
operator|=
name|false
block|,
operator|.
name|out_is_imm
operator|=
name|false
block|,
operator|.
name|encode_slave_id
operator|=
name|false
block|,
operator|.
name|verify
operator|=
name|NULL
block|,
operator|.
name|wrapper
operator|=
name|mlx4_GEN_QP_wrapper
block|}
block|,
block|{
operator|.
name|opcode
operator|=
name|MLX4_CMD_UPDATE_QP
block|,
operator|.
name|has_inbox
operator|=
name|false
block|,
operator|.
name|has_outbox
operator|=
name|false
block|,
operator|.
name|out_is_imm
operator|=
name|false
block|,
operator|.
name|encode_slave_id
operator|=
name|false
block|,
operator|.
name|skip_err_print
operator|=
name|true
block|,
operator|.
name|verify
operator|=
name|NULL
block|,
operator|.
name|wrapper
operator|=
name|MLX4_CMD_UPDATE_QP_wrapper
block|}
block|,
block|{
operator|.
name|opcode
operator|=
name|MLX4_CMD_CONF_SPECIAL_QP
block|,
operator|.
name|has_inbox
operator|=
name|false
block|,
operator|.
name|has_outbox
operator|=
name|false
block|,
operator|.
name|out_is_imm
operator|=
name|false
block|,
operator|.
name|encode_slave_id
operator|=
name|false
block|,
operator|.
name|verify
operator|=
name|NULL
block|,
comment|/* XXX verify: only demux can do this */
operator|.
name|wrapper
operator|=
name|NULL
block|}
block|,
block|{
operator|.
name|opcode
operator|=
name|MLX4_CMD_MAD_IFC
block|,
operator|.
name|has_inbox
operator|=
name|true
block|,
operator|.
name|has_outbox
operator|=
name|true
block|,
operator|.
name|out_is_imm
operator|=
name|false
block|,
operator|.
name|encode_slave_id
operator|=
name|false
block|,
operator|.
name|verify
operator|=
name|NULL
block|,
operator|.
name|wrapper
operator|=
name|mlx4_MAD_IFC_wrapper
block|}
block|,
block|{
operator|.
name|opcode
operator|=
name|MLX4_CMD_QUERY_IF_STAT
block|,
operator|.
name|has_inbox
operator|=
name|false
block|,
operator|.
name|has_outbox
operator|=
name|true
block|,
operator|.
name|out_is_imm
operator|=
name|false
block|,
operator|.
name|encode_slave_id
operator|=
name|false
block|,
operator|.
name|verify
operator|=
name|NULL
block|,
operator|.
name|wrapper
operator|=
name|mlx4_QUERY_IF_STAT_wrapper
block|}
block|,
comment|/* Native multicast commands are not available for guests */
block|{
operator|.
name|opcode
operator|=
name|MLX4_CMD_QP_ATTACH
block|,
operator|.
name|has_inbox
operator|=
name|true
block|,
operator|.
name|has_outbox
operator|=
name|false
block|,
operator|.
name|out_is_imm
operator|=
name|false
block|,
operator|.
name|encode_slave_id
operator|=
name|false
block|,
operator|.
name|verify
operator|=
name|NULL
block|,
operator|.
name|wrapper
operator|=
name|mlx4_QP_ATTACH_wrapper
block|}
block|,
block|{
operator|.
name|opcode
operator|=
name|MLX4_CMD_PROMISC
block|,
operator|.
name|has_inbox
operator|=
name|false
block|,
operator|.
name|has_outbox
operator|=
name|false
block|,
operator|.
name|out_is_imm
operator|=
name|false
block|,
operator|.
name|encode_slave_id
operator|=
name|false
block|,
operator|.
name|verify
operator|=
name|NULL
block|,
operator|.
name|wrapper
operator|=
name|mlx4_PROMISC_wrapper
block|}
block|,
comment|/* Ethernet specific commands */
block|{
operator|.
name|opcode
operator|=
name|MLX4_CMD_SET_VLAN_FLTR
block|,
operator|.
name|has_inbox
operator|=
name|true
block|,
operator|.
name|has_outbox
operator|=
name|false
block|,
operator|.
name|out_is_imm
operator|=
name|false
block|,
operator|.
name|encode_slave_id
operator|=
name|false
block|,
operator|.
name|verify
operator|=
name|NULL
block|,
operator|.
name|wrapper
operator|=
name|mlx4_SET_VLAN_FLTR_wrapper
block|}
block|,
block|{
operator|.
name|opcode
operator|=
name|MLX4_CMD_SET_MCAST_FLTR
block|,
operator|.
name|has_inbox
operator|=
name|false
block|,
operator|.
name|has_outbox
operator|=
name|false
block|,
operator|.
name|out_is_imm
operator|=
name|false
block|,
operator|.
name|encode_slave_id
operator|=
name|false
block|,
operator|.
name|verify
operator|=
name|NULL
block|,
operator|.
name|wrapper
operator|=
name|mlx4_SET_MCAST_FLTR_wrapper
block|}
block|,
block|{
operator|.
name|opcode
operator|=
name|MLX4_CMD_DUMP_ETH_STATS
block|,
operator|.
name|has_inbox
operator|=
name|false
block|,
operator|.
name|has_outbox
operator|=
name|true
block|,
operator|.
name|out_is_imm
operator|=
name|false
block|,
operator|.
name|encode_slave_id
operator|=
name|false
block|,
operator|.
name|verify
operator|=
name|NULL
block|,
operator|.
name|wrapper
operator|=
name|mlx4_DUMP_ETH_STATS_wrapper
block|}
block|,
block|{
operator|.
name|opcode
operator|=
name|MLX4_CMD_INFORM_FLR_DONE
block|,
operator|.
name|has_inbox
operator|=
name|false
block|,
operator|.
name|has_outbox
operator|=
name|false
block|,
operator|.
name|out_is_imm
operator|=
name|false
block|,
operator|.
name|encode_slave_id
operator|=
name|false
block|,
operator|.
name|verify
operator|=
name|NULL
block|,
operator|.
name|wrapper
operator|=
name|NULL
block|}
block|,
comment|/* flow steering commands */
block|{
operator|.
name|opcode
operator|=
name|MLX4_QP_FLOW_STEERING_ATTACH
block|,
operator|.
name|has_inbox
operator|=
name|true
block|,
operator|.
name|has_outbox
operator|=
name|false
block|,
operator|.
name|out_is_imm
operator|=
name|true
block|,
operator|.
name|encode_slave_id
operator|=
name|false
block|,
operator|.
name|verify
operator|=
name|NULL
block|,
operator|.
name|wrapper
operator|=
name|mlx4_QP_FLOW_STEERING_ATTACH_wrapper
block|}
block|,
block|{
operator|.
name|opcode
operator|=
name|MLX4_QP_FLOW_STEERING_DETACH
block|,
operator|.
name|has_inbox
operator|=
name|false
block|,
operator|.
name|has_outbox
operator|=
name|false
block|,
operator|.
name|out_is_imm
operator|=
name|false
block|,
operator|.
name|encode_slave_id
operator|=
name|false
block|,
operator|.
name|verify
operator|=
name|NULL
block|,
operator|.
name|wrapper
operator|=
name|mlx4_QP_FLOW_STEERING_DETACH_wrapper
block|}
block|,
comment|/* wol commands */
block|{
operator|.
name|opcode
operator|=
name|MLX4_CMD_MOD_STAT_CFG
block|,
operator|.
name|has_inbox
operator|=
name|false
block|,
operator|.
name|has_outbox
operator|=
name|false
block|,
operator|.
name|out_is_imm
operator|=
name|false
block|,
operator|.
name|encode_slave_id
operator|=
name|false
block|,
operator|.
name|skip_err_print
operator|=
name|true
block|,
operator|.
name|verify
operator|=
name|NULL
block|,
operator|.
name|wrapper
operator|=
name|mlx4_MOD_STAT_CFG_wrapper
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|mlx4_master_process_vhcr
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|int
name|slave
parameter_list|,
name|struct
name|mlx4_vhcr_cmd
modifier|*
name|in_vhcr
parameter_list|)
block|{
name|struct
name|mlx4_priv
modifier|*
name|priv
init|=
name|mlx4_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|mlx4_cmd_info
modifier|*
name|cmd
init|=
name|NULL
decl_stmt|;
name|struct
name|mlx4_vhcr_cmd
modifier|*
name|vhcr_cmd
init|=
name|in_vhcr
condition|?
name|in_vhcr
else|:
name|priv
operator|->
name|mfunc
operator|.
name|vhcr
decl_stmt|;
name|struct
name|mlx4_vhcr
modifier|*
name|vhcr
decl_stmt|;
name|struct
name|mlx4_cmd_mailbox
modifier|*
name|inbox
init|=
name|NULL
decl_stmt|;
name|struct
name|mlx4_cmd_mailbox
modifier|*
name|outbox
init|=
name|NULL
decl_stmt|;
name|u64
name|in_param
decl_stmt|;
name|u64
name|out_param
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|err
init|=
literal|0
decl_stmt|;
comment|/* Create sw representation of Virtual HCR */
name|vhcr
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|mlx4_vhcr
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|vhcr
condition|)
return|return
operator|-
name|ENOMEM
return|;
comment|/* DMA in the vHCR */
if|if
condition|(
operator|!
name|in_vhcr
condition|)
block|{
name|ret
operator|=
name|mlx4_ACCESS_MEM
argument_list|(
name|dev
argument_list|,
name|priv
operator|->
name|mfunc
operator|.
name|vhcr_dma
argument_list|,
name|slave
argument_list|,
name|priv
operator|->
name|mfunc
operator|.
name|master
operator|.
name|slave_state
index|[
name|slave
index|]
operator|.
name|vhcr_dma
argument_list|,
name|ALIGN
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|mlx4_vhcr_cmd
argument_list|)
argument_list|,
name|MLX4_ACCESS_MEM_ALIGN
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|mlx4_err
argument_list|(
name|dev
argument_list|,
literal|"%s:Failed reading vhcr"
literal|"ret: 0x%x\n"
argument_list|,
name|__func__
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|vhcr
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
block|}
comment|/* Fill SW VHCR fields */
name|vhcr
operator|->
name|in_param
operator|=
name|be64_to_cpu
argument_list|(
name|vhcr_cmd
operator|->
name|in_param
argument_list|)
expr_stmt|;
name|vhcr
operator|->
name|out_param
operator|=
name|be64_to_cpu
argument_list|(
name|vhcr_cmd
operator|->
name|out_param
argument_list|)
expr_stmt|;
name|vhcr
operator|->
name|in_modifier
operator|=
name|be32_to_cpu
argument_list|(
name|vhcr_cmd
operator|->
name|in_modifier
argument_list|)
expr_stmt|;
name|vhcr
operator|->
name|token
operator|=
name|be16_to_cpu
argument_list|(
name|vhcr_cmd
operator|->
name|token
argument_list|)
expr_stmt|;
name|vhcr
operator|->
name|op
operator|=
name|be16_to_cpu
argument_list|(
name|vhcr_cmd
operator|->
name|opcode
argument_list|)
operator|&
literal|0xfff
expr_stmt|;
name|vhcr
operator|->
name|op_modifier
operator|=
call|(
name|u8
call|)
argument_list|(
name|be16_to_cpu
argument_list|(
name|vhcr_cmd
operator|->
name|opcode
argument_list|)
operator|>>
literal|12
argument_list|)
expr_stmt|;
name|vhcr
operator|->
name|e_bit
operator|=
name|vhcr_cmd
operator|->
name|flags
operator|&
operator|(
literal|1
operator|<<
literal|6
operator|)
expr_stmt|;
comment|/* Lookup command */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ARRAY_SIZE
argument_list|(
name|cmd_info
argument_list|)
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|vhcr
operator|->
name|op
operator|==
name|cmd_info
index|[
name|i
index|]
operator|.
name|opcode
condition|)
block|{
name|cmd
operator|=
operator|&
name|cmd_info
index|[
name|i
index|]
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
operator|!
name|cmd
condition|)
block|{
name|mlx4_err
argument_list|(
name|dev
argument_list|,
literal|"unparavirt command: %s (0x%x) accepted from slave:%d\n"
argument_list|,
name|cmd_to_str
argument_list|(
name|vhcr
operator|->
name|op
argument_list|)
argument_list|,
name|vhcr
operator|->
name|op
argument_list|,
name|slave
argument_list|)
expr_stmt|;
name|vhcr_cmd
operator|->
name|status
operator|=
name|CMD_STAT_BAD_PARAM
expr_stmt|;
goto|goto
name|out_status
goto|;
block|}
comment|/* Read inbox */
if|if
condition|(
name|cmd
operator|->
name|has_inbox
condition|)
block|{
name|vhcr
operator|->
name|in_param
operator|&=
name|INBOX_MASK
expr_stmt|;
name|inbox
operator|=
name|mlx4_alloc_cmd_mailbox
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|inbox
argument_list|)
condition|)
block|{
name|vhcr_cmd
operator|->
name|status
operator|=
name|CMD_STAT_BAD_SIZE
expr_stmt|;
name|inbox
operator|=
name|NULL
expr_stmt|;
goto|goto
name|out_status
goto|;
block|}
if|if
condition|(
name|mlx4_ACCESS_MEM
argument_list|(
name|dev
argument_list|,
name|inbox
operator|->
name|dma
argument_list|,
name|slave
argument_list|,
name|vhcr
operator|->
name|in_param
argument_list|,
name|MLX4_MAILBOX_SIZE
argument_list|,
literal|1
argument_list|)
condition|)
block|{
name|mlx4_err
argument_list|(
name|dev
argument_list|,
literal|"%s: Failed reading inbox for cmd %s (0x%x)\n"
argument_list|,
name|__func__
argument_list|,
name|cmd_to_str
argument_list|(
name|cmd
operator|->
name|opcode
argument_list|)
argument_list|,
name|cmd
operator|->
name|opcode
argument_list|)
expr_stmt|;
name|vhcr_cmd
operator|->
name|status
operator|=
name|CMD_STAT_INTERNAL_ERR
expr_stmt|;
goto|goto
name|out_status
goto|;
block|}
block|}
comment|/* Apply permission and bound checks if applicable */
if|if
condition|(
name|cmd
operator|->
name|verify
operator|&&
name|cmd
operator|->
name|verify
argument_list|(
name|dev
argument_list|,
name|slave
argument_list|,
name|vhcr
argument_list|,
name|inbox
argument_list|)
condition|)
block|{
name|mlx4_warn
argument_list|(
name|dev
argument_list|,
literal|"Command %s (0x%x) from slave: %d failed protection "
literal|"checks for resource_id: %d\n"
argument_list|,
name|cmd_to_str
argument_list|(
name|vhcr
operator|->
name|op
argument_list|)
argument_list|,
name|vhcr
operator|->
name|op
argument_list|,
name|slave
argument_list|,
name|vhcr
operator|->
name|in_modifier
argument_list|)
expr_stmt|;
name|vhcr_cmd
operator|->
name|status
operator|=
name|CMD_STAT_BAD_OP
expr_stmt|;
goto|goto
name|out_status
goto|;
block|}
comment|/* Allocate outbox */
if|if
condition|(
name|cmd
operator|->
name|has_outbox
condition|)
block|{
name|outbox
operator|=
name|mlx4_alloc_cmd_mailbox
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|outbox
argument_list|)
condition|)
block|{
name|vhcr_cmd
operator|->
name|status
operator|=
name|CMD_STAT_BAD_SIZE
expr_stmt|;
name|outbox
operator|=
name|NULL
expr_stmt|;
goto|goto
name|out_status
goto|;
block|}
block|}
comment|/* Execute the command! */
if|if
condition|(
name|cmd
operator|->
name|wrapper
condition|)
block|{
name|err
operator|=
name|cmd
operator|->
name|wrapper
argument_list|(
name|dev
argument_list|,
name|slave
argument_list|,
name|vhcr
argument_list|,
name|inbox
argument_list|,
name|outbox
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd
operator|->
name|out_is_imm
condition|)
name|vhcr_cmd
operator|->
name|out_param
operator|=
name|cpu_to_be64
argument_list|(
name|vhcr
operator|->
name|out_param
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|in_param
operator|=
name|cmd
operator|->
name|has_inbox
condition|?
operator|(
name|u64
operator|)
name|inbox
operator|->
name|dma
else|:
name|vhcr
operator|->
name|in_param
expr_stmt|;
name|out_param
operator|=
name|cmd
operator|->
name|has_outbox
condition|?
operator|(
name|u64
operator|)
name|outbox
operator|->
name|dma
else|:
name|vhcr
operator|->
name|out_param
expr_stmt|;
name|err
operator|=
name|__mlx4_cmd
argument_list|(
name|dev
argument_list|,
name|in_param
argument_list|,
operator|&
name|out_param
argument_list|,
name|cmd
operator|->
name|out_is_imm
argument_list|,
name|vhcr
operator|->
name|in_modifier
argument_list|,
name|vhcr
operator|->
name|op_modifier
argument_list|,
name|vhcr
operator|->
name|op
argument_list|,
name|MLX4_CMD_TIME_CLASS_A
argument_list|,
name|MLX4_CMD_NATIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd
operator|->
name|out_is_imm
condition|)
block|{
name|vhcr
operator|->
name|out_param
operator|=
name|out_param
expr_stmt|;
name|vhcr_cmd
operator|->
name|out_param
operator|=
name|cpu_to_be64
argument_list|(
name|vhcr
operator|->
name|out_param
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|err
condition|)
block|{
if|if
condition|(
operator|!
name|cmd
operator|->
name|skip_err_print
condition|)
name|mlx4_warn
argument_list|(
name|dev
argument_list|,
literal|"vhcr command %s (0x%x) slave:%d "
literal|"in_param 0x%llx in_mod=0x%x, op_mod=0x%x "
literal|"failed with error:%d, status %d\n"
argument_list|,
name|cmd_to_str
argument_list|(
name|vhcr
operator|->
name|op
argument_list|)
argument_list|,
name|vhcr
operator|->
name|op
argument_list|,
name|slave
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|vhcr
operator|->
name|in_param
argument_list|,
name|vhcr
operator|->
name|in_modifier
argument_list|,
name|vhcr
operator|->
name|op_modifier
argument_list|,
name|vhcr
operator|->
name|errno
argument_list|,
name|err
argument_list|)
expr_stmt|;
name|vhcr_cmd
operator|->
name|status
operator|=
name|mlx4_errno_to_status
argument_list|(
name|err
argument_list|)
expr_stmt|;
goto|goto
name|out_status
goto|;
block|}
comment|/* Write outbox if command completed successfully */
if|if
condition|(
name|cmd
operator|->
name|has_outbox
operator|&&
operator|!
name|vhcr_cmd
operator|->
name|status
condition|)
block|{
name|ret
operator|=
name|mlx4_ACCESS_MEM
argument_list|(
name|dev
argument_list|,
name|outbox
operator|->
name|dma
argument_list|,
name|slave
argument_list|,
name|vhcr
operator|->
name|out_param
argument_list|,
name|MLX4_MAILBOX_SIZE
argument_list|,
name|MLX4_CMD_WRAPPED
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
comment|/* If we failed to write back the outbox after the 			 *command was successfully executed, we must fail this 			 * slave, as it is now in undefined state */
name|mlx4_err
argument_list|(
name|dev
argument_list|,
literal|"%s: Failed writing outbox\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
name|out_status
label|:
comment|/* DMA back vhcr result */
if|if
condition|(
operator|!
name|in_vhcr
condition|)
block|{
name|ret
operator|=
name|mlx4_ACCESS_MEM
argument_list|(
name|dev
argument_list|,
name|priv
operator|->
name|mfunc
operator|.
name|vhcr_dma
argument_list|,
name|slave
argument_list|,
name|priv
operator|->
name|mfunc
operator|.
name|master
operator|.
name|slave_state
index|[
name|slave
index|]
operator|.
name|vhcr_dma
argument_list|,
name|ALIGN
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|mlx4_vhcr
argument_list|)
argument_list|,
name|MLX4_ACCESS_MEM_ALIGN
argument_list|)
argument_list|,
name|MLX4_CMD_WRAPPED
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|mlx4_err
argument_list|(
name|dev
argument_list|,
literal|"%s:Failed writing vhcr result\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|vhcr
operator|->
name|e_bit
operator|&&
name|mlx4_GEN_EQE
argument_list|(
name|dev
argument_list|,
name|slave
argument_list|,
operator|&
name|priv
operator|->
name|mfunc
operator|.
name|master
operator|.
name|cmd_eqe
argument_list|)
condition|)
name|mlx4_warn
argument_list|(
name|dev
argument_list|,
literal|"Failed to generate command completion "
literal|"eqe for slave %d\n"
argument_list|,
name|slave
argument_list|)
expr_stmt|;
block|}
name|out
label|:
name|kfree
argument_list|(
name|vhcr
argument_list|)
expr_stmt|;
name|mlx4_free_cmd_mailbox
argument_list|(
name|dev
argument_list|,
name|inbox
argument_list|)
expr_stmt|;
name|mlx4_free_cmd_mailbox
argument_list|(
name|dev
argument_list|,
name|outbox
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_master_immediate_activate_vlan_qos
parameter_list|(
name|struct
name|mlx4_priv
modifier|*
name|priv
parameter_list|,
name|int
name|slave
parameter_list|,
name|int
name|port
parameter_list|)
block|{
name|struct
name|mlx4_vport_oper_state
modifier|*
name|vp_oper
decl_stmt|;
name|struct
name|mlx4_vport_state
modifier|*
name|vp_admin
decl_stmt|;
name|struct
name|mlx4_vf_immed_vlan_work
modifier|*
name|work
decl_stmt|;
name|int
name|err
decl_stmt|;
name|int
name|admin_vlan_ix
init|=
name|NO_INDX
decl_stmt|;
name|vp_oper
operator|=
operator|&
name|priv
operator|->
name|mfunc
operator|.
name|master
operator|.
name|vf_oper
index|[
name|slave
index|]
operator|.
name|vport
index|[
name|port
index|]
expr_stmt|;
name|vp_admin
operator|=
operator|&
name|priv
operator|->
name|mfunc
operator|.
name|master
operator|.
name|vf_admin
index|[
name|slave
index|]
operator|.
name|vport
index|[
name|port
index|]
expr_stmt|;
if|if
condition|(
name|vp_oper
operator|->
name|state
operator|.
name|default_vlan
operator|==
name|vp_admin
operator|->
name|default_vlan
operator|&&
name|vp_oper
operator|->
name|state
operator|.
name|default_qos
operator|==
name|vp_admin
operator|->
name|default_qos
condition|)
return|return
literal|0
return|;
name|work
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|work
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|work
condition|)
return|return
operator|-
name|ENOMEM
return|;
if|if
condition|(
name|vp_oper
operator|->
name|state
operator|.
name|default_vlan
operator|!=
name|vp_admin
operator|->
name|default_vlan
condition|)
block|{
if|if
condition|(
name|MLX4_VGT
operator|!=
name|vp_admin
operator|->
name|default_vlan
condition|)
block|{
name|err
operator|=
name|__mlx4_register_vlan
argument_list|(
operator|&
name|priv
operator|->
name|dev
argument_list|,
name|port
argument_list|,
name|vp_admin
operator|->
name|default_vlan
argument_list|,
operator|&
name|admin_vlan_ix
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|mlx4_warn
argument_list|(
operator|(
operator|&
name|priv
operator|->
name|dev
operator|)
argument_list|,
literal|"No vlan resources slave %d, port %d\n"
argument_list|,
name|slave
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|work
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
block|}
else|else
block|{
name|admin_vlan_ix
operator|=
name|NO_INDX
expr_stmt|;
block|}
name|work
operator|->
name|flags
operator||=
name|MLX4_VF_IMMED_VLAN_FLAG_VLAN
expr_stmt|;
name|mlx4_dbg
argument_list|(
operator|(
operator|&
operator|(
name|priv
operator|->
name|dev
operator|)
operator|)
argument_list|,
literal|"alloc vlan %d idx  %d slave %d port %d\n"
argument_list|,
call|(
name|int
call|)
argument_list|(
name|vp_admin
operator|->
name|default_vlan
argument_list|)
argument_list|,
name|admin_vlan_ix
argument_list|,
name|slave
argument_list|,
name|port
argument_list|)
expr_stmt|;
block|}
comment|/* save original vlan ix and vlan id */
name|work
operator|->
name|orig_vlan_id
operator|=
name|vp_oper
operator|->
name|state
operator|.
name|default_vlan
expr_stmt|;
name|work
operator|->
name|orig_vlan_ix
operator|=
name|vp_oper
operator|->
name|vlan_idx
expr_stmt|;
comment|/* handle new qos */
if|if
condition|(
name|vp_oper
operator|->
name|state
operator|.
name|default_qos
operator|!=
name|vp_admin
operator|->
name|default_qos
condition|)
name|work
operator|->
name|flags
operator||=
name|MLX4_VF_IMMED_VLAN_FLAG_QOS
expr_stmt|;
if|if
condition|(
name|work
operator|->
name|flags
operator|&
name|MLX4_VF_IMMED_VLAN_FLAG_VLAN
condition|)
name|vp_oper
operator|->
name|vlan_idx
operator|=
name|admin_vlan_ix
expr_stmt|;
name|vp_oper
operator|->
name|state
operator|.
name|default_vlan
operator|=
name|vp_admin
operator|->
name|default_vlan
expr_stmt|;
name|vp_oper
operator|->
name|state
operator|.
name|default_qos
operator|=
name|vp_admin
operator|->
name|default_qos
expr_stmt|;
comment|/* iterate over QPs owned by this slave, using UPDATE_QP */
name|work
operator|->
name|port
operator|=
name|port
expr_stmt|;
name|work
operator|->
name|slave
operator|=
name|slave
expr_stmt|;
name|work
operator|->
name|qos
operator|=
name|vp_oper
operator|->
name|state
operator|.
name|default_qos
expr_stmt|;
name|work
operator|->
name|vlan_id
operator|=
name|vp_oper
operator|->
name|state
operator|.
name|default_vlan
expr_stmt|;
name|work
operator|->
name|vlan_ix
operator|=
name|vp_oper
operator|->
name|vlan_idx
expr_stmt|;
name|work
operator|->
name|priv
operator|=
name|priv
expr_stmt|;
name|INIT_WORK
argument_list|(
operator|&
name|work
operator|->
name|work
argument_list|,
name|mlx4_vf_immed_vlan_work_handler
argument_list|)
expr_stmt|;
name|queue_work
argument_list|(
name|priv
operator|->
name|mfunc
operator|.
name|master
operator|.
name|comm_wq
argument_list|,
operator|&
name|work
operator|->
name|work
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_master_activate_admin_state
parameter_list|(
name|struct
name|mlx4_priv
modifier|*
name|priv
parameter_list|,
name|int
name|slave
parameter_list|)
block|{
name|int
name|port
decl_stmt|,
name|err
decl_stmt|;
name|struct
name|mlx4_vport_state
modifier|*
name|vp_admin
decl_stmt|;
name|struct
name|mlx4_vport_oper_state
modifier|*
name|vp_oper
decl_stmt|;
for|for
control|(
name|port
operator|=
literal|1
init|;
name|port
operator|<=
name|MLX4_MAX_PORTS
condition|;
name|port
operator|++
control|)
block|{
name|vp_oper
operator|=
operator|&
name|priv
operator|->
name|mfunc
operator|.
name|master
operator|.
name|vf_oper
index|[
name|slave
index|]
operator|.
name|vport
index|[
name|port
index|]
expr_stmt|;
name|vp_admin
operator|=
operator|&
name|priv
operator|->
name|mfunc
operator|.
name|master
operator|.
name|vf_admin
index|[
name|slave
index|]
operator|.
name|vport
index|[
name|port
index|]
expr_stmt|;
name|vp_oper
operator|->
name|state
operator|=
operator|*
name|vp_admin
expr_stmt|;
if|if
condition|(
name|MLX4_VGT
operator|!=
name|vp_admin
operator|->
name|default_vlan
condition|)
block|{
name|err
operator|=
name|__mlx4_register_vlan
argument_list|(
operator|&
name|priv
operator|->
name|dev
argument_list|,
name|port
argument_list|,
name|vp_admin
operator|->
name|default_vlan
argument_list|,
operator|&
operator|(
name|vp_oper
operator|->
name|vlan_idx
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|vp_oper
operator|->
name|vlan_idx
operator|=
name|NO_INDX
expr_stmt|;
name|mlx4_warn
argument_list|(
operator|(
operator|&
name|priv
operator|->
name|dev
operator|)
argument_list|,
literal|"No vlan resorces slave %d, port %d\n"
argument_list|,
name|slave
argument_list|,
name|port
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
name|mlx4_dbg
argument_list|(
operator|(
operator|&
operator|(
name|priv
operator|->
name|dev
operator|)
operator|)
argument_list|,
literal|"alloc vlan %d idx  %d slave %d port %d\n"
argument_list|,
call|(
name|int
call|)
argument_list|(
name|vp_oper
operator|->
name|state
operator|.
name|default_vlan
argument_list|)
argument_list|,
name|vp_oper
operator|->
name|vlan_idx
argument_list|,
name|slave
argument_list|,
name|port
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|vp_admin
operator|->
name|spoofchk
condition|)
block|{
name|vp_oper
operator|->
name|mac_idx
operator|=
name|__mlx4_register_mac
argument_list|(
operator|&
name|priv
operator|->
name|dev
argument_list|,
name|port
argument_list|,
name|vp_admin
operator|->
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
literal|0
operator|>
name|vp_oper
operator|->
name|mac_idx
condition|)
block|{
name|err
operator|=
name|vp_oper
operator|->
name|mac_idx
expr_stmt|;
name|vp_oper
operator|->
name|mac_idx
operator|=
name|NO_INDX
expr_stmt|;
name|mlx4_warn
argument_list|(
operator|(
operator|&
name|priv
operator|->
name|dev
operator|)
argument_list|,
literal|"No mac resources slave %d, port %d\n"
argument_list|,
name|slave
argument_list|,
name|port
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
name|mlx4_dbg
argument_list|(
operator|(
operator|&
operator|(
name|priv
operator|->
name|dev
operator|)
operator|)
argument_list|,
literal|"alloc mac %llx idx  %d slave %d port %d\n"
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|vp_oper
operator|->
name|state
operator|.
name|mac
argument_list|,
name|vp_oper
operator|->
name|mac_idx
argument_list|,
name|slave
argument_list|,
name|port
argument_list|)
expr_stmt|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_master_deactivate_admin_state
parameter_list|(
name|struct
name|mlx4_priv
modifier|*
name|priv
parameter_list|,
name|int
name|slave
parameter_list|)
block|{
name|int
name|port
decl_stmt|;
name|struct
name|mlx4_vport_oper_state
modifier|*
name|vp_oper
decl_stmt|;
for|for
control|(
name|port
operator|=
literal|1
init|;
name|port
operator|<=
name|MLX4_MAX_PORTS
condition|;
name|port
operator|++
control|)
block|{
name|vp_oper
operator|=
operator|&
name|priv
operator|->
name|mfunc
operator|.
name|master
operator|.
name|vf_oper
index|[
name|slave
index|]
operator|.
name|vport
index|[
name|port
index|]
expr_stmt|;
if|if
condition|(
name|NO_INDX
operator|!=
name|vp_oper
operator|->
name|vlan_idx
condition|)
block|{
name|__mlx4_unregister_vlan
argument_list|(
operator|&
name|priv
operator|->
name|dev
argument_list|,
name|port
argument_list|,
name|vp_oper
operator|->
name|state
operator|.
name|default_vlan
argument_list|)
expr_stmt|;
name|vp_oper
operator|->
name|vlan_idx
operator|=
name|NO_INDX
expr_stmt|;
block|}
if|if
condition|(
name|NO_INDX
operator|!=
name|vp_oper
operator|->
name|mac_idx
condition|)
block|{
name|__mlx4_unregister_mac
argument_list|(
operator|&
name|priv
operator|->
name|dev
argument_list|,
name|port
argument_list|,
name|vp_oper
operator|->
name|state
operator|.
name|mac
argument_list|)
expr_stmt|;
name|vp_oper
operator|->
name|mac_idx
operator|=
name|NO_INDX
expr_stmt|;
block|}
block|}
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_master_do_cmd
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|int
name|slave
parameter_list|,
name|u8
name|cmd
parameter_list|,
name|u16
name|param
parameter_list|,
name|u8
name|toggle
parameter_list|)
block|{
name|struct
name|mlx4_priv
modifier|*
name|priv
init|=
name|mlx4_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|mlx4_slave_state
modifier|*
name|slave_state
init|=
name|priv
operator|->
name|mfunc
operator|.
name|master
operator|.
name|slave_state
decl_stmt|;
name|u32
name|reply
decl_stmt|;
name|u8
name|is_going_down
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
name|unsigned
name|long
name|flags
decl_stmt|;
name|slave_state
index|[
name|slave
index|]
operator|.
name|comm_toggle
operator|^=
literal|1
expr_stmt|;
name|reply
operator|=
operator|(
name|u32
operator|)
name|slave_state
index|[
name|slave
index|]
operator|.
name|comm_toggle
operator|<<
literal|31
expr_stmt|;
if|if
condition|(
name|toggle
operator|!=
name|slave_state
index|[
name|slave
index|]
operator|.
name|comm_toggle
condition|)
block|{
name|mlx4_warn
argument_list|(
name|dev
argument_list|,
literal|"Incorrect toggle %d from slave %d. *** MASTER"
literal|"STATE COMPROMISIED ***\n"
argument_list|,
name|toggle
argument_list|,
name|slave
argument_list|)
expr_stmt|;
goto|goto
name|reset_slave
goto|;
block|}
if|if
condition|(
name|cmd
operator|==
name|MLX4_COMM_CMD_RESET
condition|)
block|{
name|mlx4_warn
argument_list|(
name|dev
argument_list|,
literal|"Received reset from slave:%d\n"
argument_list|,
name|slave
argument_list|)
expr_stmt|;
name|slave_state
index|[
name|slave
index|]
operator|.
name|active
operator|=
name|false
expr_stmt|;
name|slave_state
index|[
name|slave
index|]
operator|.
name|old_vlan_api
operator|=
name|false
expr_stmt|;
name|mlx4_master_deactivate_admin_state
argument_list|(
name|priv
argument_list|,
name|slave
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MLX4_EVENT_TYPES_NUM
condition|;
operator|++
name|i
control|)
block|{
name|slave_state
index|[
name|slave
index|]
operator|.
name|event_eq
index|[
name|i
index|]
operator|.
name|eqn
operator|=
operator|-
literal|1
expr_stmt|;
name|slave_state
index|[
name|slave
index|]
operator|.
name|event_eq
index|[
name|i
index|]
operator|.
name|token
operator|=
literal|0
expr_stmt|;
block|}
comment|/*check if we are in the middle of FLR process, 		if so return "retry" status to the slave*/
if|if
condition|(
name|MLX4_COMM_CMD_FLR
operator|==
name|slave_state
index|[
name|slave
index|]
operator|.
name|last_cmd
condition|)
goto|goto
name|inform_slave_state
goto|;
name|mlx4_dispatch_event
argument_list|(
name|dev
argument_list|,
name|MLX4_DEV_EVENT_SLAVE_SHUTDOWN
argument_list|,
name|slave
argument_list|)
expr_stmt|;
comment|/* write the version in the event field */
name|reply
operator||=
name|mlx4_comm_get_version
argument_list|()
expr_stmt|;
goto|goto
name|reset_slave
goto|;
block|}
comment|/*command from slave in the middle of FLR*/
if|if
condition|(
name|cmd
operator|!=
name|MLX4_COMM_CMD_RESET
operator|&&
name|MLX4_COMM_CMD_FLR
operator|==
name|slave_state
index|[
name|slave
index|]
operator|.
name|last_cmd
condition|)
block|{
name|mlx4_warn
argument_list|(
name|dev
argument_list|,
literal|"slave:%d is Trying to run cmd (0x%x) "
literal|"in the middle of FLR\n"
argument_list|,
name|slave
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
return|return;
block|}
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|MLX4_COMM_CMD_VHCR0
case|:
if|if
condition|(
name|slave_state
index|[
name|slave
index|]
operator|.
name|last_cmd
operator|!=
name|MLX4_COMM_CMD_RESET
condition|)
goto|goto
name|reset_slave
goto|;
name|slave_state
index|[
name|slave
index|]
operator|.
name|vhcr_dma
operator|=
operator|(
operator|(
name|u64
operator|)
name|param
operator|)
operator|<<
literal|48
expr_stmt|;
name|priv
operator|->
name|mfunc
operator|.
name|master
operator|.
name|slave_state
index|[
name|slave
index|]
operator|.
name|cookie
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|MLX4_COMM_CMD_VHCR1
case|:
if|if
condition|(
name|slave_state
index|[
name|slave
index|]
operator|.
name|last_cmd
operator|!=
name|MLX4_COMM_CMD_VHCR0
condition|)
goto|goto
name|reset_slave
goto|;
name|slave_state
index|[
name|slave
index|]
operator|.
name|vhcr_dma
operator||=
operator|(
operator|(
name|u64
operator|)
name|param
operator|)
operator|<<
literal|32
expr_stmt|;
break|break;
case|case
name|MLX4_COMM_CMD_VHCR2
case|:
if|if
condition|(
name|slave_state
index|[
name|slave
index|]
operator|.
name|last_cmd
operator|!=
name|MLX4_COMM_CMD_VHCR1
condition|)
goto|goto
name|reset_slave
goto|;
name|slave_state
index|[
name|slave
index|]
operator|.
name|vhcr_dma
operator||=
operator|(
operator|(
name|u64
operator|)
name|param
operator|)
operator|<<
literal|16
expr_stmt|;
break|break;
case|case
name|MLX4_COMM_CMD_VHCR_EN
case|:
if|if
condition|(
name|slave_state
index|[
name|slave
index|]
operator|.
name|last_cmd
operator|!=
name|MLX4_COMM_CMD_VHCR2
condition|)
goto|goto
name|reset_slave
goto|;
name|slave_state
index|[
name|slave
index|]
operator|.
name|vhcr_dma
operator||=
name|param
expr_stmt|;
if|if
condition|(
name|mlx4_master_activate_admin_state
argument_list|(
name|priv
argument_list|,
name|slave
argument_list|)
condition|)
goto|goto
name|reset_slave
goto|;
name|slave_state
index|[
name|slave
index|]
operator|.
name|active
operator|=
name|true
expr_stmt|;
name|mlx4_dispatch_event
argument_list|(
name|dev
argument_list|,
name|MLX4_DEV_EVENT_SLAVE_INIT
argument_list|,
name|slave
argument_list|)
expr_stmt|;
break|break;
case|case
name|MLX4_COMM_CMD_VHCR_POST
case|:
if|if
condition|(
operator|(
name|slave_state
index|[
name|slave
index|]
operator|.
name|last_cmd
operator|!=
name|MLX4_COMM_CMD_VHCR_EN
operator|)
operator|&&
operator|(
name|slave_state
index|[
name|slave
index|]
operator|.
name|last_cmd
operator|!=
name|MLX4_COMM_CMD_VHCR_POST
operator|)
condition|)
goto|goto
name|reset_slave
goto|;
name|mutex_lock
argument_list|(
operator|&
name|priv
operator|->
name|cmd
operator|.
name|slave_cmd_mutex
argument_list|)
expr_stmt|;
if|if
condition|(
name|mlx4_master_process_vhcr
argument_list|(
name|dev
argument_list|,
name|slave
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|mlx4_err
argument_list|(
name|dev
argument_list|,
literal|"Failed processing vhcr for slave: %d,"
literal|" resetting slave.\n"
argument_list|,
name|slave
argument_list|)
expr_stmt|;
name|mutex_unlock
argument_list|(
operator|&
name|priv
operator|->
name|cmd
operator|.
name|slave_cmd_mutex
argument_list|)
expr_stmt|;
goto|goto
name|reset_slave
goto|;
block|}
name|mutex_unlock
argument_list|(
operator|&
name|priv
operator|->
name|cmd
operator|.
name|slave_cmd_mutex
argument_list|)
expr_stmt|;
break|break;
default|default:
name|mlx4_warn
argument_list|(
name|dev
argument_list|,
literal|"Bad comm cmd: %d from slave: %d\n"
argument_list|,
name|cmd
argument_list|,
name|slave
argument_list|)
expr_stmt|;
goto|goto
name|reset_slave
goto|;
block|}
name|spin_lock_irqsave
argument_list|(
operator|&
name|priv
operator|->
name|mfunc
operator|.
name|master
operator|.
name|slave_state_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|slave_state
index|[
name|slave
index|]
operator|.
name|is_slave_going_down
condition|)
name|slave_state
index|[
name|slave
index|]
operator|.
name|last_cmd
operator|=
name|cmd
expr_stmt|;
else|else
name|is_going_down
operator|=
literal|1
expr_stmt|;
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|priv
operator|->
name|mfunc
operator|.
name|master
operator|.
name|slave_state_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_going_down
condition|)
block|{
name|mlx4_warn
argument_list|(
name|dev
argument_list|,
literal|"Slave is going down aborting command (%d)"
literal|" executing from slave: %d\n"
argument_list|,
name|cmd
argument_list|,
name|slave
argument_list|)
expr_stmt|;
return|return;
block|}
name|__raw_writel
argument_list|(
operator|(
name|__force
name|u32
operator|)
name|cpu_to_be32
argument_list|(
name|reply
argument_list|)
argument_list|,
operator|&
name|priv
operator|->
name|mfunc
operator|.
name|comm
index|[
name|slave
index|]
operator|.
name|slave_read
argument_list|)
expr_stmt|;
name|mmiowb
argument_list|()
expr_stmt|;
return|return;
name|reset_slave
label|:
comment|/* cleanup any slave resources */
name|mlx4_delete_all_resources_for_slave
argument_list|(
name|dev
argument_list|,
name|slave
argument_list|)
expr_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|priv
operator|->
name|mfunc
operator|.
name|master
operator|.
name|slave_state_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|slave_state
index|[
name|slave
index|]
operator|.
name|is_slave_going_down
condition|)
name|slave_state
index|[
name|slave
index|]
operator|.
name|last_cmd
operator|=
name|MLX4_COMM_CMD_RESET
expr_stmt|;
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|priv
operator|->
name|mfunc
operator|.
name|master
operator|.
name|slave_state_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
comment|/*with slave in the middle of flr, no need to clean resources again.*/
name|inform_slave_state
label|:
name|__raw_writel
argument_list|(
operator|(
name|__force
name|u32
operator|)
name|cpu_to_be32
argument_list|(
name|reply
argument_list|)
argument_list|,
operator|&
name|priv
operator|->
name|mfunc
operator|.
name|comm
index|[
name|slave
index|]
operator|.
name|slave_read
argument_list|)
expr_stmt|;
name|wmb
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/* master command processing */
end_comment

begin_function
name|void
name|mlx4_master_comm_channel
parameter_list|(
name|struct
name|work_struct
modifier|*
name|work
parameter_list|)
block|{
name|struct
name|mlx4_mfunc_master_ctx
modifier|*
name|master
init|=
name|container_of
argument_list|(
name|work
argument_list|,
expr|struct
name|mlx4_mfunc_master_ctx
argument_list|,
name|comm_work
argument_list|)
decl_stmt|;
name|struct
name|mlx4_mfunc
modifier|*
name|mfunc
init|=
name|container_of
argument_list|(
name|master
argument_list|,
expr|struct
name|mlx4_mfunc
argument_list|,
name|master
argument_list|)
decl_stmt|;
name|struct
name|mlx4_priv
modifier|*
name|priv
init|=
name|container_of
argument_list|(
name|mfunc
argument_list|,
expr|struct
name|mlx4_priv
argument_list|,
name|mfunc
argument_list|)
decl_stmt|;
name|struct
name|mlx4_dev
modifier|*
name|dev
init|=
operator|&
name|priv
operator|->
name|dev
decl_stmt|;
name|__be32
modifier|*
name|bit_vec
decl_stmt|;
name|u32
name|comm_cmd
decl_stmt|;
name|u32
name|vec
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|slave
decl_stmt|;
name|int
name|toggle
decl_stmt|;
name|int
name|served
init|=
literal|0
decl_stmt|;
name|int
name|reported
init|=
literal|0
decl_stmt|;
name|u32
name|slt
decl_stmt|;
name|bit_vec
operator|=
name|master
operator|->
name|comm_arm_bit_vector
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|COMM_CHANNEL_BIT_ARRAY_SIZE
condition|;
name|i
operator|++
control|)
block|{
name|vec
operator|=
name|be32_to_cpu
argument_list|(
name|bit_vec
index|[
name|i
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|32
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|vec
operator|&
operator|(
literal|1
operator|<<
name|j
operator|)
operator|)
condition|)
continue|continue;
operator|++
name|reported
expr_stmt|;
name|slave
operator|=
operator|(
name|i
operator|*
literal|32
operator|)
operator|+
name|j
expr_stmt|;
name|comm_cmd
operator|=
name|swab32
argument_list|(
name|readl
argument_list|(
operator|&
name|mfunc
operator|->
name|comm
index|[
name|slave
index|]
operator|.
name|slave_write
argument_list|)
argument_list|)
expr_stmt|;
name|slt
operator|=
name|swab32
argument_list|(
name|readl
argument_list|(
operator|&
name|mfunc
operator|->
name|comm
index|[
name|slave
index|]
operator|.
name|slave_read
argument_list|)
argument_list|)
operator|>>
literal|31
expr_stmt|;
name|toggle
operator|=
name|comm_cmd
operator|>>
literal|31
expr_stmt|;
if|if
condition|(
name|toggle
operator|!=
name|slt
condition|)
block|{
if|if
condition|(
name|master
operator|->
name|slave_state
index|[
name|slave
index|]
operator|.
name|comm_toggle
operator|!=
name|slt
condition|)
block|{
name|mlx4_info
argument_list|(
name|dev
argument_list|,
literal|"slave %d out of sync."
literal|" read toggle %d, state toggle %d. "
literal|"Resynching.\n"
argument_list|,
name|slave
argument_list|,
name|slt
argument_list|,
name|master
operator|->
name|slave_state
index|[
name|slave
index|]
operator|.
name|comm_toggle
argument_list|)
expr_stmt|;
name|master
operator|->
name|slave_state
index|[
name|slave
index|]
operator|.
name|comm_toggle
operator|=
name|slt
expr_stmt|;
block|}
name|mlx4_master_do_cmd
argument_list|(
name|dev
argument_list|,
name|slave
argument_list|,
name|comm_cmd
operator|>>
literal|16
operator|&
literal|0xff
argument_list|,
name|comm_cmd
operator|&
literal|0xffff
argument_list|,
name|toggle
argument_list|)
expr_stmt|;
operator|++
name|served
expr_stmt|;
block|}
else|else
name|mlx4_err
argument_list|(
name|dev
argument_list|,
literal|"slave %d out of sync."
literal|" read toggle %d, write toggle %d.\n"
argument_list|,
name|slave
argument_list|,
name|slt
argument_list|,
name|toggle
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|reported
operator|&&
name|reported
operator|!=
name|served
condition|)
name|mlx4_warn
argument_list|(
name|dev
argument_list|,
literal|"Got command event with bitmask from %d slaves"
literal|" but %d were served\n"
argument_list|,
name|reported
argument_list|,
name|served
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* master command processing */
end_comment

begin_function
name|void
name|mlx4_master_arm_comm_channel
parameter_list|(
name|struct
name|work_struct
modifier|*
name|work
parameter_list|)
block|{
name|struct
name|mlx4_mfunc_master_ctx
modifier|*
name|master
init|=
name|container_of
argument_list|(
name|work
argument_list|,
expr|struct
name|mlx4_mfunc_master_ctx
argument_list|,
name|arm_comm_work
argument_list|)
decl_stmt|;
name|struct
name|mlx4_mfunc
modifier|*
name|mfunc
init|=
name|container_of
argument_list|(
name|master
argument_list|,
expr|struct
name|mlx4_mfunc
argument_list|,
name|master
argument_list|)
decl_stmt|;
name|struct
name|mlx4_priv
modifier|*
name|priv
init|=
name|container_of
argument_list|(
name|mfunc
argument_list|,
expr|struct
name|mlx4_priv
argument_list|,
name|mfunc
argument_list|)
decl_stmt|;
name|struct
name|mlx4_dev
modifier|*
name|dev
init|=
operator|&
name|priv
operator|->
name|dev
decl_stmt|;
if|if
condition|(
name|mlx4_ARM_COMM_CHANNEL
argument_list|(
name|dev
argument_list|)
condition|)
name|mlx4_warn
argument_list|(
name|dev
argument_list|,
literal|"Failed to arm comm channel events\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|sync_toggles
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|mlx4_priv
modifier|*
name|priv
init|=
name|mlx4_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|wr_toggle
decl_stmt|;
name|int
name|rd_toggle
decl_stmt|;
name|unsigned
name|long
name|end
decl_stmt|;
name|wr_toggle
operator|=
name|swab32
argument_list|(
name|readl
argument_list|(
operator|&
name|priv
operator|->
name|mfunc
operator|.
name|comm
operator|->
name|slave_write
argument_list|)
argument_list|)
operator|>>
literal|31
expr_stmt|;
name|end
operator|=
name|jiffies
operator|+
name|msecs_to_jiffies
argument_list|(
literal|5000
argument_list|)
expr_stmt|;
while|while
condition|(
name|time_before
argument_list|(
name|jiffies
argument_list|,
name|end
argument_list|)
condition|)
block|{
name|rd_toggle
operator|=
name|swab32
argument_list|(
name|readl
argument_list|(
operator|&
name|priv
operator|->
name|mfunc
operator|.
name|comm
operator|->
name|slave_read
argument_list|)
argument_list|)
operator|>>
literal|31
expr_stmt|;
if|if
condition|(
name|rd_toggle
operator|==
name|wr_toggle
condition|)
block|{
name|priv
operator|->
name|cmd
operator|.
name|comm_toggle
operator|=
name|rd_toggle
expr_stmt|;
return|return
literal|0
return|;
block|}
name|cond_resched
argument_list|()
expr_stmt|;
block|}
comment|/* 	 * we could reach here if for example the previous VM using this 	 * function misbehaved and left the channel with unsynced state. We 	 * should fix this here and give this VM a chance to use a properly 	 * synced channel 	 */
name|mlx4_warn
argument_list|(
name|dev
argument_list|,
literal|"recovering from previously mis-behaved VM\n"
argument_list|)
expr_stmt|;
name|__raw_writel
argument_list|(
operator|(
name|__force
name|u32
operator|)
literal|0
argument_list|,
operator|&
name|priv
operator|->
name|mfunc
operator|.
name|comm
operator|->
name|slave_read
argument_list|)
expr_stmt|;
name|__raw_writel
argument_list|(
operator|(
name|__force
name|u32
operator|)
literal|0
argument_list|,
operator|&
name|priv
operator|->
name|mfunc
operator|.
name|comm
operator|->
name|slave_write
argument_list|)
expr_stmt|;
name|priv
operator|->
name|cmd
operator|.
name|comm_toggle
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|mlx4_multi_func_init
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|mlx4_priv
modifier|*
name|priv
init|=
name|mlx4_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|mlx4_slave_state
modifier|*
name|s_state
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|err
decl_stmt|,
name|port
decl_stmt|;
if|if
condition|(
name|mlx4_is_master
argument_list|(
name|dev
argument_list|)
condition|)
name|priv
operator|->
name|mfunc
operator|.
name|comm
operator|=
name|ioremap
argument_list|(
name|pci_resource_start
argument_list|(
name|dev
operator|->
name|pdev
argument_list|,
name|priv
operator|->
name|fw
operator|.
name|comm_bar
argument_list|)
operator|+
name|priv
operator|->
name|fw
operator|.
name|comm_base
argument_list|,
name|MLX4_COMM_PAGESIZE
argument_list|)
expr_stmt|;
else|else
name|priv
operator|->
name|mfunc
operator|.
name|comm
operator|=
name|ioremap
argument_list|(
name|pci_resource_start
argument_list|(
name|dev
operator|->
name|pdev
argument_list|,
literal|2
argument_list|)
operator|+
name|MLX4_SLAVE_COMM_BASE
argument_list|,
name|MLX4_COMM_PAGESIZE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|priv
operator|->
name|mfunc
operator|.
name|comm
condition|)
block|{
name|mlx4_err
argument_list|(
name|dev
argument_list|,
literal|"Couldn't map communication vector.\n"
argument_list|)
expr_stmt|;
goto|goto
name|err_vhcr
goto|;
block|}
if|if
condition|(
name|mlx4_is_master
argument_list|(
name|dev
argument_list|)
condition|)
block|{
name|priv
operator|->
name|mfunc
operator|.
name|master
operator|.
name|slave_state
operator|=
name|kzalloc
argument_list|(
name|dev
operator|->
name|num_slaves
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|mlx4_slave_state
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|priv
operator|->
name|mfunc
operator|.
name|master
operator|.
name|slave_state
condition|)
goto|goto
name|err_comm
goto|;
name|priv
operator|->
name|mfunc
operator|.
name|master
operator|.
name|vf_admin
operator|=
name|kzalloc
argument_list|(
name|dev
operator|->
name|num_slaves
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|mlx4_vf_admin_state
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|priv
operator|->
name|mfunc
operator|.
name|master
operator|.
name|vf_admin
condition|)
goto|goto
name|err_comm_admin
goto|;
name|priv
operator|->
name|mfunc
operator|.
name|master
operator|.
name|vf_oper
operator|=
name|kzalloc
argument_list|(
name|dev
operator|->
name|num_slaves
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|mlx4_vf_oper_state
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|priv
operator|->
name|mfunc
operator|.
name|master
operator|.
name|vf_oper
condition|)
goto|goto
name|err_comm_oper
goto|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dev
operator|->
name|num_slaves
condition|;
operator|++
name|i
control|)
block|{
name|s_state
operator|=
operator|&
name|priv
operator|->
name|mfunc
operator|.
name|master
operator|.
name|slave_state
index|[
name|i
index|]
expr_stmt|;
name|s_state
operator|->
name|last_cmd
operator|=
name|MLX4_COMM_CMD_RESET
expr_stmt|;
name|mutex_init
argument_list|(
operator|&
name|priv
operator|->
name|mfunc
operator|.
name|master
operator|.
name|gen_eqe_mutex
index|[
name|i
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|MLX4_EVENT_TYPES_NUM
condition|;
operator|++
name|j
control|)
name|s_state
operator|->
name|event_eq
index|[
name|j
index|]
operator|.
name|eqn
operator|=
operator|-
literal|1
expr_stmt|;
name|__raw_writel
argument_list|(
operator|(
name|__force
name|u32
operator|)
literal|0
argument_list|,
operator|&
name|priv
operator|->
name|mfunc
operator|.
name|comm
index|[
name|i
index|]
operator|.
name|slave_write
argument_list|)
expr_stmt|;
name|__raw_writel
argument_list|(
operator|(
name|__force
name|u32
operator|)
literal|0
argument_list|,
operator|&
name|priv
operator|->
name|mfunc
operator|.
name|comm
index|[
name|i
index|]
operator|.
name|slave_read
argument_list|)
expr_stmt|;
name|mmiowb
argument_list|()
expr_stmt|;
for|for
control|(
name|port
operator|=
literal|1
init|;
name|port
operator|<=
name|MLX4_MAX_PORTS
condition|;
name|port
operator|++
control|)
block|{
name|s_state
operator|->
name|vlan_filter
index|[
name|port
index|]
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|mlx4_vlan_fltr
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|s_state
operator|->
name|vlan_filter
index|[
name|port
index|]
condition|)
block|{
if|if
condition|(
operator|--
name|port
condition|)
name|kfree
argument_list|(
name|s_state
operator|->
name|vlan_filter
index|[
name|port
index|]
argument_list|)
expr_stmt|;
goto|goto
name|err_slaves
goto|;
block|}
name|INIT_LIST_HEAD
argument_list|(
operator|&
name|s_state
operator|->
name|mcast_filters
index|[
name|port
index|]
argument_list|)
expr_stmt|;
name|priv
operator|->
name|mfunc
operator|.
name|master
operator|.
name|vf_admin
index|[
name|i
index|]
operator|.
name|vport
index|[
name|port
index|]
operator|.
name|default_vlan
operator|=
name|MLX4_VGT
expr_stmt|;
name|priv
operator|->
name|mfunc
operator|.
name|master
operator|.
name|vf_oper
index|[
name|i
index|]
operator|.
name|vport
index|[
name|port
index|]
operator|.
name|state
operator|.
name|default_vlan
operator|=
name|MLX4_VGT
expr_stmt|;
name|priv
operator|->
name|mfunc
operator|.
name|master
operator|.
name|vf_oper
index|[
name|i
index|]
operator|.
name|vport
index|[
name|port
index|]
operator|.
name|vlan_idx
operator|=
name|NO_INDX
expr_stmt|;
name|priv
operator|->
name|mfunc
operator|.
name|master
operator|.
name|vf_oper
index|[
name|i
index|]
operator|.
name|vport
index|[
name|port
index|]
operator|.
name|mac_idx
operator|=
name|NO_INDX
expr_stmt|;
block|}
name|spin_lock_init
argument_list|(
operator|&
name|s_state
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
name|memset
argument_list|(
operator|&
name|priv
operator|->
name|mfunc
operator|.
name|master
operator|.
name|cmd_eqe
argument_list|,
literal|0
argument_list|,
name|dev
operator|->
name|caps
operator|.
name|eqe_size
argument_list|)
expr_stmt|;
name|priv
operator|->
name|mfunc
operator|.
name|master
operator|.
name|cmd_eqe
operator|.
name|type
operator|=
name|MLX4_EVENT_TYPE_CMD
expr_stmt|;
name|INIT_WORK
argument_list|(
operator|&
name|priv
operator|->
name|mfunc
operator|.
name|master
operator|.
name|comm_work
argument_list|,
name|mlx4_master_comm_channel
argument_list|)
expr_stmt|;
name|INIT_WORK
argument_list|(
operator|&
name|priv
operator|->
name|mfunc
operator|.
name|master
operator|.
name|arm_comm_work
argument_list|,
name|mlx4_master_arm_comm_channel
argument_list|)
expr_stmt|;
name|INIT_WORK
argument_list|(
operator|&
name|priv
operator|->
name|mfunc
operator|.
name|master
operator|.
name|slave_event_work
argument_list|,
name|mlx4_gen_slave_eqe
argument_list|)
expr_stmt|;
name|INIT_WORK
argument_list|(
operator|&
name|priv
operator|->
name|mfunc
operator|.
name|master
operator|.
name|slave_flr_event_work
argument_list|,
name|mlx4_master_handle_slave_flr
argument_list|)
expr_stmt|;
name|spin_lock_init
argument_list|(
operator|&
name|priv
operator|->
name|mfunc
operator|.
name|master
operator|.
name|slave_state_lock
argument_list|)
expr_stmt|;
name|spin_lock_init
argument_list|(
operator|&
name|priv
operator|->
name|mfunc
operator|.
name|master
operator|.
name|slave_eq
operator|.
name|event_lock
argument_list|)
expr_stmt|;
name|priv
operator|->
name|mfunc
operator|.
name|master
operator|.
name|comm_wq
operator|=
name|create_singlethread_workqueue
argument_list|(
literal|"mlx4_comm"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|priv
operator|->
name|mfunc
operator|.
name|master
operator|.
name|comm_wq
condition|)
goto|goto
name|err_slaves
goto|;
if|if
condition|(
name|mlx4_init_resource_tracker
argument_list|(
name|dev
argument_list|)
condition|)
goto|goto
name|err_thread
goto|;
name|err
operator|=
name|mlx4_ARM_COMM_CHANNEL
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|mlx4_err
argument_list|(
name|dev
argument_list|,
literal|" Failed to arm comm channel eq: %x\n"
argument_list|,
name|err
argument_list|)
expr_stmt|;
goto|goto
name|err_resource
goto|;
block|}
block|}
else|else
block|{
name|err
operator|=
name|sync_toggles
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|mlx4_err
argument_list|(
name|dev
argument_list|,
literal|"Couldn't sync toggles\n"
argument_list|)
expr_stmt|;
goto|goto
name|err_comm
goto|;
block|}
block|}
return|return
literal|0
return|;
name|err_resource
label|:
name|mlx4_free_resource_tracker
argument_list|(
name|dev
argument_list|,
name|RES_TR_FREE_ALL
argument_list|)
expr_stmt|;
name|err_thread
label|:
name|flush_workqueue
argument_list|(
name|priv
operator|->
name|mfunc
operator|.
name|master
operator|.
name|comm_wq
argument_list|)
expr_stmt|;
name|destroy_workqueue
argument_list|(
name|priv
operator|->
name|mfunc
operator|.
name|master
operator|.
name|comm_wq
argument_list|)
expr_stmt|;
name|err_slaves
label|:
while|while
condition|(
operator|--
name|i
condition|)
block|{
for|for
control|(
name|port
operator|=
literal|1
init|;
name|port
operator|<=
name|MLX4_MAX_PORTS
condition|;
name|port
operator|++
control|)
name|kfree
argument_list|(
name|priv
operator|->
name|mfunc
operator|.
name|master
operator|.
name|slave_state
index|[
name|i
index|]
operator|.
name|vlan_filter
index|[
name|port
index|]
argument_list|)
expr_stmt|;
block|}
name|kfree
argument_list|(
name|priv
operator|->
name|mfunc
operator|.
name|master
operator|.
name|vf_oper
argument_list|)
expr_stmt|;
name|err_comm_oper
label|:
name|kfree
argument_list|(
name|priv
operator|->
name|mfunc
operator|.
name|master
operator|.
name|vf_admin
argument_list|)
expr_stmt|;
name|err_comm_admin
label|:
name|kfree
argument_list|(
name|priv
operator|->
name|mfunc
operator|.
name|master
operator|.
name|slave_state
argument_list|)
expr_stmt|;
name|err_comm
label|:
name|iounmap
argument_list|(
name|priv
operator|->
name|mfunc
operator|.
name|comm
argument_list|)
expr_stmt|;
name|err_vhcr
label|:
name|dma_free_coherent
argument_list|(
operator|&
operator|(
name|dev
operator|->
name|pdev
operator|->
name|dev
operator|)
argument_list|,
name|PAGE_SIZE
argument_list|,
name|priv
operator|->
name|mfunc
operator|.
name|vhcr
argument_list|,
name|priv
operator|->
name|mfunc
operator|.
name|vhcr_dma
argument_list|)
expr_stmt|;
name|priv
operator|->
name|mfunc
operator|.
name|vhcr
operator|=
name|NULL
expr_stmt|;
return|return
operator|-
name|ENOMEM
return|;
block|}
end_function

begin_function
name|int
name|mlx4_cmd_init
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|mlx4_priv
modifier|*
name|priv
init|=
name|mlx4_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|mutex_init
argument_list|(
operator|&
name|priv
operator|->
name|cmd
operator|.
name|hcr_mutex
argument_list|)
expr_stmt|;
name|mutex_init
argument_list|(
operator|&
name|priv
operator|->
name|cmd
operator|.
name|slave_cmd_mutex
argument_list|)
expr_stmt|;
name|sema_init
argument_list|(
operator|&
name|priv
operator|->
name|cmd
operator|.
name|poll_sem
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|priv
operator|->
name|cmd
operator|.
name|use_events
operator|=
literal|0
expr_stmt|;
name|priv
operator|->
name|cmd
operator|.
name|toggle
operator|=
literal|1
expr_stmt|;
name|priv
operator|->
name|cmd
operator|.
name|hcr
operator|=
name|NULL
expr_stmt|;
name|priv
operator|->
name|mfunc
operator|.
name|vhcr
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|!
name|mlx4_is_slave
argument_list|(
name|dev
argument_list|)
condition|)
block|{
name|priv
operator|->
name|cmd
operator|.
name|hcr
operator|=
name|ioremap
argument_list|(
name|pci_resource_start
argument_list|(
name|dev
operator|->
name|pdev
argument_list|,
literal|0
argument_list|)
operator|+
name|MLX4_HCR_BASE
argument_list|,
name|MLX4_HCR_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|priv
operator|->
name|cmd
operator|.
name|hcr
condition|)
block|{
name|mlx4_err
argument_list|(
name|dev
argument_list|,
literal|"Couldn't map command register.\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOMEM
return|;
block|}
block|}
if|if
condition|(
name|mlx4_is_mfunc
argument_list|(
name|dev
argument_list|)
condition|)
block|{
name|priv
operator|->
name|mfunc
operator|.
name|vhcr
operator|=
name|dma_alloc_coherent
argument_list|(
operator|&
operator|(
name|dev
operator|->
name|pdev
operator|->
name|dev
operator|)
argument_list|,
name|PAGE_SIZE
argument_list|,
operator|&
name|priv
operator|->
name|mfunc
operator|.
name|vhcr_dma
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|priv
operator|->
name|mfunc
operator|.
name|vhcr
condition|)
block|{
name|mlx4_err
argument_list|(
name|dev
argument_list|,
literal|"Couldn't allocate VHCR.\n"
argument_list|)
expr_stmt|;
goto|goto
name|err_hcr
goto|;
block|}
block|}
name|priv
operator|->
name|cmd
operator|.
name|pool
operator|=
name|pci_pool_create
argument_list|(
literal|"mlx4_cmd"
argument_list|,
name|dev
operator|->
name|pdev
argument_list|,
name|MLX4_MAILBOX_SIZE
argument_list|,
name|MLX4_MAILBOX_SIZE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|priv
operator|->
name|cmd
operator|.
name|pool
condition|)
goto|goto
name|err_vhcr
goto|;
return|return
literal|0
return|;
name|err_vhcr
label|:
if|if
condition|(
name|mlx4_is_mfunc
argument_list|(
name|dev
argument_list|)
condition|)
name|dma_free_coherent
argument_list|(
operator|&
operator|(
name|dev
operator|->
name|pdev
operator|->
name|dev
operator|)
argument_list|,
name|PAGE_SIZE
argument_list|,
name|priv
operator|->
name|mfunc
operator|.
name|vhcr
argument_list|,
name|priv
operator|->
name|mfunc
operator|.
name|vhcr_dma
argument_list|)
expr_stmt|;
name|priv
operator|->
name|mfunc
operator|.
name|vhcr
operator|=
name|NULL
expr_stmt|;
name|err_hcr
label|:
if|if
condition|(
operator|!
name|mlx4_is_slave
argument_list|(
name|dev
argument_list|)
condition|)
name|iounmap
argument_list|(
name|priv
operator|->
name|cmd
operator|.
name|hcr
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOMEM
return|;
block|}
end_function

begin_function
name|void
name|mlx4_multi_func_cleanup
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|mlx4_priv
modifier|*
name|priv
init|=
name|mlx4_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|i
decl_stmt|,
name|port
decl_stmt|;
if|if
condition|(
name|mlx4_is_master
argument_list|(
name|dev
argument_list|)
condition|)
block|{
name|flush_workqueue
argument_list|(
name|priv
operator|->
name|mfunc
operator|.
name|master
operator|.
name|comm_wq
argument_list|)
expr_stmt|;
name|destroy_workqueue
argument_list|(
name|priv
operator|->
name|mfunc
operator|.
name|master
operator|.
name|comm_wq
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dev
operator|->
name|num_slaves
condition|;
name|i
operator|++
control|)
block|{
for|for
control|(
name|port
operator|=
literal|1
init|;
name|port
operator|<=
name|MLX4_MAX_PORTS
condition|;
name|port
operator|++
control|)
name|kfree
argument_list|(
name|priv
operator|->
name|mfunc
operator|.
name|master
operator|.
name|slave_state
index|[
name|i
index|]
operator|.
name|vlan_filter
index|[
name|port
index|]
argument_list|)
expr_stmt|;
block|}
name|kfree
argument_list|(
name|priv
operator|->
name|mfunc
operator|.
name|master
operator|.
name|slave_state
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|priv
operator|->
name|mfunc
operator|.
name|master
operator|.
name|vf_admin
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|priv
operator|->
name|mfunc
operator|.
name|master
operator|.
name|vf_oper
argument_list|)
expr_stmt|;
block|}
name|iounmap
argument_list|(
name|priv
operator|->
name|mfunc
operator|.
name|comm
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|mlx4_cmd_cleanup
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|mlx4_priv
modifier|*
name|priv
init|=
name|mlx4_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|pci_pool_destroy
argument_list|(
name|priv
operator|->
name|cmd
operator|.
name|pool
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mlx4_is_slave
argument_list|(
name|dev
argument_list|)
condition|)
name|iounmap
argument_list|(
name|priv
operator|->
name|cmd
operator|.
name|hcr
argument_list|)
expr_stmt|;
if|if
condition|(
name|mlx4_is_mfunc
argument_list|(
name|dev
argument_list|)
condition|)
name|dma_free_coherent
argument_list|(
operator|&
operator|(
name|dev
operator|->
name|pdev
operator|->
name|dev
operator|)
argument_list|,
name|PAGE_SIZE
argument_list|,
name|priv
operator|->
name|mfunc
operator|.
name|vhcr
argument_list|,
name|priv
operator|->
name|mfunc
operator|.
name|vhcr_dma
argument_list|)
expr_stmt|;
name|priv
operator|->
name|mfunc
operator|.
name|vhcr
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Switch to using events to issue FW commands (can only be called  * after event queue for command events has been initialized).  */
end_comment

begin_function
name|int
name|mlx4_cmd_use_events
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|mlx4_priv
modifier|*
name|priv
init|=
name|mlx4_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|err
init|=
literal|0
decl_stmt|;
name|priv
operator|->
name|cmd
operator|.
name|context
operator|=
name|kmalloc
argument_list|(
name|priv
operator|->
name|cmd
operator|.
name|max_cmds
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|mlx4_cmd_context
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|priv
operator|->
name|cmd
operator|.
name|context
condition|)
return|return
operator|-
name|ENOMEM
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|cmd
operator|.
name|max_cmds
condition|;
operator|++
name|i
control|)
block|{
name|priv
operator|->
name|cmd
operator|.
name|context
index|[
name|i
index|]
operator|.
name|token
operator|=
name|i
expr_stmt|;
name|priv
operator|->
name|cmd
operator|.
name|context
index|[
name|i
index|]
operator|.
name|next
operator|=
name|i
operator|+
literal|1
expr_stmt|;
block|}
name|priv
operator|->
name|cmd
operator|.
name|context
index|[
name|priv
operator|->
name|cmd
operator|.
name|max_cmds
operator|-
literal|1
index|]
operator|.
name|next
operator|=
operator|-
literal|1
expr_stmt|;
name|priv
operator|->
name|cmd
operator|.
name|free_head
operator|=
literal|0
expr_stmt|;
name|sema_init
argument_list|(
operator|&
name|priv
operator|->
name|cmd
operator|.
name|event_sem
argument_list|,
name|priv
operator|->
name|cmd
operator|.
name|max_cmds
argument_list|)
expr_stmt|;
name|spin_lock_init
argument_list|(
operator|&
name|priv
operator|->
name|cmd
operator|.
name|context_lock
argument_list|)
expr_stmt|;
for|for
control|(
name|priv
operator|->
name|cmd
operator|.
name|token_mask
operator|=
literal|1
init|;
name|priv
operator|->
name|cmd
operator|.
name|token_mask
operator|<
name|priv
operator|->
name|cmd
operator|.
name|max_cmds
condition|;
name|priv
operator|->
name|cmd
operator|.
name|token_mask
operator|<<=
literal|1
control|)
empty_stmt|;
comment|/* nothing */
operator|--
name|priv
operator|->
name|cmd
operator|.
name|token_mask
expr_stmt|;
name|down
argument_list|(
operator|&
name|priv
operator|->
name|cmd
operator|.
name|poll_sem
argument_list|)
expr_stmt|;
name|priv
operator|->
name|cmd
operator|.
name|use_events
operator|=
literal|1
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_comment
comment|/*  * Switch back to polling (used when shutting down the device)  */
end_comment

begin_function
name|void
name|mlx4_cmd_use_polling
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|mlx4_priv
modifier|*
name|priv
init|=
name|mlx4_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|i
decl_stmt|;
name|priv
operator|->
name|cmd
operator|.
name|use_events
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|cmd
operator|.
name|max_cmds
condition|;
operator|++
name|i
control|)
name|down
argument_list|(
operator|&
name|priv
operator|->
name|cmd
operator|.
name|event_sem
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|priv
operator|->
name|cmd
operator|.
name|context
argument_list|)
expr_stmt|;
name|up
argument_list|(
operator|&
name|priv
operator|->
name|cmd
operator|.
name|poll_sem
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|struct
name|mlx4_cmd_mailbox
modifier|*
name|mlx4_alloc_cmd_mailbox
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|mlx4_cmd_mailbox
modifier|*
name|mailbox
decl_stmt|;
name|mailbox
operator|=
name|kmalloc
argument_list|(
sizeof|sizeof
expr|*
name|mailbox
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mailbox
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|ENOMEM
argument_list|)
return|;
name|mailbox
operator|->
name|buf
operator|=
name|pci_pool_alloc
argument_list|(
name|mlx4_priv
argument_list|(
name|dev
argument_list|)
operator|->
name|cmd
operator|.
name|pool
argument_list|,
name|GFP_KERNEL
argument_list|,
operator|&
name|mailbox
operator|->
name|dma
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mailbox
operator|->
name|buf
condition|)
block|{
name|kfree
argument_list|(
name|mailbox
argument_list|)
expr_stmt|;
return|return
name|ERR_PTR
argument_list|(
operator|-
name|ENOMEM
argument_list|)
return|;
block|}
name|memset
argument_list|(
name|mailbox
operator|->
name|buf
argument_list|,
literal|0
argument_list|,
name|MLX4_MAILBOX_SIZE
argument_list|)
expr_stmt|;
return|return
name|mailbox
return|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL_GPL
argument_list|(
name|mlx4_alloc_cmd_mailbox
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
name|void
name|mlx4_free_cmd_mailbox
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mlx4_cmd_mailbox
modifier|*
name|mailbox
parameter_list|)
block|{
if|if
condition|(
operator|!
name|mailbox
condition|)
return|return;
name|pci_pool_free
argument_list|(
name|mlx4_priv
argument_list|(
name|dev
argument_list|)
operator|->
name|cmd
operator|.
name|pool
argument_list|,
name|mailbox
operator|->
name|buf
argument_list|,
name|mailbox
operator|->
name|dma
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|mailbox
argument_list|)
expr_stmt|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL_GPL
argument_list|(
name|mlx4_free_cmd_mailbox
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
name|u32
name|mlx4_comm_get_version
parameter_list|(
name|void
parameter_list|)
block|{
return|return
operator|(
operator|(
name|u32
operator|)
name|CMD_CHAN_IF_REV
operator|<<
literal|8
operator|)
operator||
operator|(
name|u32
operator|)
name|CMD_CHAN_VER
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_get_slave_indx
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|int
name|vf
parameter_list|)
block|{
if|if
condition|(
operator|(
name|vf
operator|<
literal|0
operator|)
operator|||
operator|(
name|vf
operator|>=
name|dev
operator|->
name|num_vfs
operator|)
condition|)
block|{
name|mlx4_err
argument_list|(
name|dev
argument_list|,
literal|"Bad vf number:%d (number of activated vf: %d)\n"
argument_list|,
name|vf
argument_list|,
name|dev
operator|->
name|num_vfs
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
return|return
operator|(
name|vf
operator|+
literal|1
operator|)
return|;
block|}
end_function

begin_function
name|int
name|mlx4_set_vf_mac
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|int
name|port
parameter_list|,
name|int
name|vf
parameter_list|,
name|u8
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|mlx4_priv
modifier|*
name|priv
init|=
name|mlx4_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|mlx4_vport_state
modifier|*
name|s_info
decl_stmt|;
name|int
name|slave
decl_stmt|;
if|if
condition|(
operator|!
name|mlx4_is_master
argument_list|(
name|dev
argument_list|)
condition|)
return|return
operator|-
name|EPROTONOSUPPORT
return|;
name|slave
operator|=
name|mlx4_get_slave_indx
argument_list|(
name|dev
argument_list|,
name|vf
argument_list|)
expr_stmt|;
if|if
condition|(
name|slave
operator|<
literal|0
condition|)
return|return
operator|-
name|EINVAL
return|;
name|s_info
operator|=
operator|&
name|priv
operator|->
name|mfunc
operator|.
name|master
operator|.
name|vf_admin
index|[
name|slave
index|]
operator|.
name|vport
index|[
name|port
index|]
expr_stmt|;
name|s_info
operator|->
name|mac
operator|=
name|mlx4_mac_to_u64
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|mlx4_info
argument_list|(
name|dev
argument_list|,
literal|"default mac on vf %d port %d to %llX will take afect only after vf restart\n"
argument_list|,
name|vf
argument_list|,
name|port
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|s_info
operator|->
name|mac
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL_GPL
argument_list|(
name|mlx4_set_vf_mac
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
name|int
name|mlx4_set_vf_vlan
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|int
name|port
parameter_list|,
name|int
name|vf
parameter_list|,
name|u16
name|vlan
parameter_list|,
name|u8
name|qos
parameter_list|)
block|{
name|struct
name|mlx4_priv
modifier|*
name|priv
init|=
name|mlx4_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|mlx4_vport_oper_state
modifier|*
name|vf_oper
decl_stmt|;
name|struct
name|mlx4_vport_state
modifier|*
name|vf_admin
decl_stmt|;
name|int
name|slave
decl_stmt|;
if|if
condition|(
operator|(
operator|!
name|mlx4_is_master
argument_list|(
name|dev
argument_list|)
operator|)
operator|||
operator|!
operator|(
name|dev
operator|->
name|caps
operator|.
name|flags2
operator|&
name|MLX4_DEV_CAP_FLAG2_VLAN_CONTROL
operator|)
condition|)
return|return
operator|-
name|EPROTONOSUPPORT
return|;
if|if
condition|(
operator|(
name|vlan
operator|>
literal|4095
operator|)
operator|||
operator|(
name|qos
operator|>
literal|7
operator|)
condition|)
return|return
operator|-
name|EINVAL
return|;
name|slave
operator|=
name|mlx4_get_slave_indx
argument_list|(
name|dev
argument_list|,
name|vf
argument_list|)
expr_stmt|;
if|if
condition|(
name|slave
operator|<
literal|0
condition|)
return|return
operator|-
name|EINVAL
return|;
name|vf_admin
operator|=
operator|&
name|priv
operator|->
name|mfunc
operator|.
name|master
operator|.
name|vf_admin
index|[
name|slave
index|]
operator|.
name|vport
index|[
name|port
index|]
expr_stmt|;
name|vf_oper
operator|=
operator|&
name|priv
operator|->
name|mfunc
operator|.
name|master
operator|.
name|vf_oper
index|[
name|slave
index|]
operator|.
name|vport
index|[
name|port
index|]
expr_stmt|;
if|if
condition|(
operator|(
literal|0
operator|==
name|vlan
operator|)
operator|&&
operator|(
literal|0
operator|==
name|qos
operator|)
condition|)
name|vf_admin
operator|->
name|default_vlan
operator|=
name|MLX4_VGT
expr_stmt|;
else|else
name|vf_admin
operator|->
name|default_vlan
operator|=
name|vlan
expr_stmt|;
name|vf_admin
operator|->
name|default_qos
operator|=
name|qos
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|mfunc
operator|.
name|master
operator|.
name|slave_state
index|[
name|slave
index|]
operator|.
name|active
operator|&&
name|dev
operator|->
name|caps
operator|.
name|flags2
operator|&
name|MLX4_DEV_CAP_FLAG2_UPDATE_QP
condition|)
block|{
name|mlx4_info
argument_list|(
name|dev
argument_list|,
literal|"updating vf %d port %d config params immediately\n"
argument_list|,
name|vf
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|mlx4_master_immediate_activate_vlan_qos
argument_list|(
name|priv
argument_list|,
name|slave
argument_list|,
name|port
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL_GPL
argument_list|(
name|mlx4_set_vf_vlan
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* mlx4_get_slave_default_vlan -  * retrun true if VST ( default vlan)  * if VST will fill vlan& qos (if not NULL) */
end_comment

begin_function
name|bool
name|mlx4_get_slave_default_vlan
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|int
name|port
parameter_list|,
name|int
name|slave
parameter_list|,
name|u16
modifier|*
name|vlan
parameter_list|,
name|u8
modifier|*
name|qos
parameter_list|)
block|{
name|struct
name|mlx4_vport_oper_state
modifier|*
name|vp_oper
decl_stmt|;
name|struct
name|mlx4_priv
modifier|*
name|priv
decl_stmt|;
name|priv
operator|=
name|mlx4_priv
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|vp_oper
operator|=
operator|&
name|priv
operator|->
name|mfunc
operator|.
name|master
operator|.
name|vf_oper
index|[
name|slave
index|]
operator|.
name|vport
index|[
name|port
index|]
expr_stmt|;
if|if
condition|(
name|MLX4_VGT
operator|!=
name|vp_oper
operator|->
name|state
operator|.
name|default_vlan
condition|)
block|{
if|if
condition|(
name|vlan
condition|)
operator|*
name|vlan
operator|=
name|vp_oper
operator|->
name|state
operator|.
name|default_vlan
expr_stmt|;
if|if
condition|(
name|qos
condition|)
operator|*
name|qos
operator|=
name|vp_oper
operator|->
name|state
operator|.
name|default_qos
expr_stmt|;
return|return
name|true
return|;
block|}
return|return
name|false
return|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL_GPL
argument_list|(
name|mlx4_get_slave_default_vlan
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
name|int
name|mlx4_set_vf_spoofchk
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|int
name|port
parameter_list|,
name|int
name|vf
parameter_list|,
name|bool
name|setting
parameter_list|)
block|{
name|struct
name|mlx4_priv
modifier|*
name|priv
init|=
name|mlx4_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|mlx4_vport_state
modifier|*
name|s_info
decl_stmt|;
name|int
name|slave
decl_stmt|;
if|if
condition|(
operator|(
operator|!
name|mlx4_is_master
argument_list|(
name|dev
argument_list|)
operator|)
operator|||
operator|!
operator|(
name|dev
operator|->
name|caps
operator|.
name|flags2
operator|&
name|MLX4_DEV_CAP_FLAG2_FSM
operator|)
condition|)
return|return
operator|-
name|EPROTONOSUPPORT
return|;
name|slave
operator|=
name|mlx4_get_slave_indx
argument_list|(
name|dev
argument_list|,
name|vf
argument_list|)
expr_stmt|;
if|if
condition|(
name|slave
operator|<
literal|0
condition|)
return|return
operator|-
name|EINVAL
return|;
name|s_info
operator|=
operator|&
name|priv
operator|->
name|mfunc
operator|.
name|master
operator|.
name|vf_admin
index|[
name|slave
index|]
operator|.
name|vport
index|[
name|port
index|]
expr_stmt|;
name|s_info
operator|->
name|spoofchk
operator|=
name|setting
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL_GPL
argument_list|(
name|mlx4_set_vf_spoofchk
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
name|int
name|mlx4_set_vf_link_state
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|int
name|port
parameter_list|,
name|int
name|vf
parameter_list|,
name|int
name|link_state
parameter_list|)
block|{
name|struct
name|mlx4_priv
modifier|*
name|priv
init|=
name|mlx4_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|mlx4_vport_state
modifier|*
name|s_info
decl_stmt|;
name|struct
name|mlx4_vport_oper_state
modifier|*
name|vp_oper
decl_stmt|;
name|int
name|slave
decl_stmt|;
name|u8
name|link_stat_event
decl_stmt|;
name|slave
operator|=
name|mlx4_get_slave_indx
argument_list|(
name|dev
argument_list|,
name|vf
argument_list|)
expr_stmt|;
if|if
condition|(
name|slave
operator|<
literal|0
condition|)
return|return
operator|-
name|EINVAL
return|;
switch|switch
condition|(
name|link_state
condition|)
block|{
case|case
name|IFLA_VF_LINK_STATE_AUTO
case|:
comment|/* get link curent state */
if|if
condition|(
operator|!
name|priv
operator|->
name|sense
operator|.
name|do_sense_port
index|[
name|port
index|]
condition|)
name|link_stat_event
operator|=
name|MLX4_PORT_CHANGE_SUBTYPE_ACTIVE
expr_stmt|;
else|else
name|link_stat_event
operator|=
name|MLX4_PORT_CHANGE_SUBTYPE_DOWN
expr_stmt|;
break|break;
case|case
name|IFLA_VF_LINK_STATE_ENABLE
case|:
name|link_stat_event
operator|=
name|MLX4_PORT_CHANGE_SUBTYPE_ACTIVE
expr_stmt|;
break|break;
case|case
name|IFLA_VF_LINK_STATE_DISABLE
case|:
name|link_stat_event
operator|=
name|MLX4_PORT_CHANGE_SUBTYPE_DOWN
expr_stmt|;
break|break;
default|default:
name|mlx4_warn
argument_list|(
name|dev
argument_list|,
literal|"unknown value for link_state %02x on slave %d port %d\n"
argument_list|,
name|link_state
argument_list|,
name|slave
argument_list|,
name|port
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
comment|/* update the admin& oper state on the link state */
name|s_info
operator|=
operator|&
name|priv
operator|->
name|mfunc
operator|.
name|master
operator|.
name|vf_admin
index|[
name|slave
index|]
operator|.
name|vport
index|[
name|port
index|]
expr_stmt|;
name|vp_oper
operator|=
operator|&
name|priv
operator|->
name|mfunc
operator|.
name|master
operator|.
name|vf_oper
index|[
name|slave
index|]
operator|.
name|vport
index|[
name|port
index|]
expr_stmt|;
name|s_info
operator|->
name|link_state
operator|=
name|link_state
expr_stmt|;
name|vp_oper
operator|->
name|state
operator|.
name|link_state
operator|=
name|link_state
expr_stmt|;
comment|/* send event */
name|mlx4_gen_port_state_change_eqe
argument_list|(
name|dev
argument_list|,
name|slave
argument_list|,
name|port
argument_list|,
name|link_stat_event
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL_GPL
argument_list|(
name|mlx4_set_vf_link_state
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
name|int
name|mlx4_get_vf_link_state
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|int
name|port
parameter_list|,
name|int
name|vf
parameter_list|)
block|{
name|struct
name|mlx4_priv
modifier|*
name|priv
init|=
name|mlx4_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|mlx4_vport_state
modifier|*
name|s_info
decl_stmt|;
name|int
name|slave
decl_stmt|;
if|if
condition|(
operator|!
name|mlx4_is_master
argument_list|(
name|dev
argument_list|)
condition|)
return|return
operator|-
name|EPROTONOSUPPORT
return|;
name|slave
operator|=
name|mlx4_get_slave_indx
argument_list|(
name|dev
argument_list|,
name|vf
argument_list|)
expr_stmt|;
if|if
condition|(
name|slave
operator|<
literal|0
condition|)
return|return
operator|-
name|EINVAL
return|;
name|s_info
operator|=
operator|&
name|priv
operator|->
name|mfunc
operator|.
name|master
operator|.
name|vf_admin
index|[
name|slave
index|]
operator|.
name|vport
index|[
name|port
index|]
expr_stmt|;
return|return
name|s_info
operator|->
name|link_state
return|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL_GPL
argument_list|(
name|mlx4_get_vf_link_state
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


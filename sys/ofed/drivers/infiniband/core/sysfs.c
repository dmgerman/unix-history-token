begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2004, 2005 Topspin Communications.  All rights reserved.  * Copyright (c) 2005 Mellanox Technologies Ltd.  All rights reserved.  * Copyright (c) 2005 Sun Microsystems, Inc. All rights reserved.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  */
end_comment

begin_include
include|#
directive|include
file|"core_priv.h"
end_include

begin_include
include|#
directive|include
file|<linux/slab.h>
end_include

begin_include
include|#
directive|include
file|<linux/string.h>
end_include

begin_include
include|#
directive|include
file|<linux/fs.h>
end_include

begin_include
include|#
directive|include
file|<rdma/ib_mad.h>
end_include

begin_include
include|#
directive|include
file|<rdma/ib_pma.h>
end_include

begin_struct
struct|struct
name|ib_port
block|{
name|struct
name|kobject
name|kobj
decl_stmt|;
name|struct
name|ib_device
modifier|*
name|ibdev
decl_stmt|;
name|struct
name|attribute_group
name|gid_group
decl_stmt|;
name|struct
name|attribute_group
name|pkey_group
decl_stmt|;
name|u8
name|port_num
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|port_attribute
block|{
name|struct
name|attribute
name|attr
decl_stmt|;
name|ssize_t
function_decl|(
modifier|*
name|show
function_decl|)
parameter_list|(
name|struct
name|ib_port
modifier|*
parameter_list|,
name|struct
name|port_attribute
modifier|*
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
function_decl|;
name|ssize_t
function_decl|(
modifier|*
name|store
function_decl|)
parameter_list|(
name|struct
name|ib_port
modifier|*
parameter_list|,
name|struct
name|port_attribute
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|count
parameter_list|)
function_decl|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|PORT_ATTR
parameter_list|(
name|_name
parameter_list|,
name|_mode
parameter_list|,
name|_show
parameter_list|,
name|_store
parameter_list|)
define|\
value|struct port_attribute port_attr_##_name = __ATTR(_name, _mode, _show, _store)
end_define

begin_define
define|#
directive|define
name|PORT_ATTR_RO
parameter_list|(
name|_name
parameter_list|)
define|\
value|struct port_attribute port_attr_##_name = __ATTR_RO(_name)
end_define

begin_struct
struct|struct
name|port_table_attribute
block|{
name|struct
name|port_attribute
name|attr
decl_stmt|;
name|char
name|name
index|[
literal|8
index|]
decl_stmt|;
name|int
name|index
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|ssize_t
name|port_attr_show
parameter_list|(
name|struct
name|kobject
modifier|*
name|kobj
parameter_list|,
name|struct
name|attribute
modifier|*
name|attr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|port_attribute
modifier|*
name|port_attr
init|=
name|container_of
argument_list|(
name|attr
argument_list|,
expr|struct
name|port_attribute
argument_list|,
name|attr
argument_list|)
decl_stmt|;
name|struct
name|ib_port
modifier|*
name|p
init|=
name|container_of
argument_list|(
name|kobj
argument_list|,
expr|struct
name|ib_port
argument_list|,
name|kobj
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|port_attr
operator|->
name|show
condition|)
return|return
operator|-
name|EIO
return|;
return|return
name|port_attr
operator|->
name|show
argument_list|(
name|p
argument_list|,
name|port_attr
argument_list|,
name|buf
argument_list|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|sysfs_ops
name|port_sysfs_ops
init|=
block|{
operator|.
name|show
operator|=
name|port_attr_show
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|ssize_t
name|state_show
parameter_list|(
name|struct
name|ib_port
modifier|*
name|p
parameter_list|,
name|struct
name|port_attribute
modifier|*
name|unused
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|ib_port_attr
name|attr
decl_stmt|;
name|ssize_t
name|ret
decl_stmt|;
specifier|static
specifier|const
name|char
modifier|*
name|state_name
index|[]
init|=
block|{
index|[
name|IB_PORT_NOP
index|]
operator|=
literal|"NOP"
block|,
index|[
name|IB_PORT_DOWN
index|]
operator|=
literal|"DOWN"
block|,
index|[
name|IB_PORT_INIT
index|]
operator|=
literal|"INIT"
block|,
index|[
name|IB_PORT_ARMED
index|]
operator|=
literal|"ARMED"
block|,
index|[
name|IB_PORT_ACTIVE
index|]
operator|=
literal|"ACTIVE"
block|,
index|[
name|IB_PORT_ACTIVE_DEFER
index|]
operator|=
literal|"ACTIVE_DEFER"
block|}
decl_stmt|;
name|ret
operator|=
name|ib_query_port
argument_list|(
name|p
operator|->
name|ibdev
argument_list|,
name|p
operator|->
name|port_num
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%d: %s\n"
argument_list|,
name|attr
operator|.
name|state
argument_list|,
name|attr
operator|.
name|state
operator|<
name|ARRAY_SIZE
argument_list|(
name|state_name
argument_list|)
condition|?
name|state_name
index|[
name|attr
operator|.
name|state
index|]
else|:
literal|"UNKNOWN"
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|lid_show
parameter_list|(
name|struct
name|ib_port
modifier|*
name|p
parameter_list|,
name|struct
name|port_attribute
modifier|*
name|unused
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|ib_port_attr
name|attr
decl_stmt|;
name|ssize_t
name|ret
decl_stmt|;
name|ret
operator|=
name|ib_query_port
argument_list|(
name|p
operator|->
name|ibdev
argument_list|,
name|p
operator|->
name|port_num
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"0x%x\n"
argument_list|,
name|attr
operator|.
name|lid
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|lid_mask_count_show
parameter_list|(
name|struct
name|ib_port
modifier|*
name|p
parameter_list|,
name|struct
name|port_attribute
modifier|*
name|unused
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|ib_port_attr
name|attr
decl_stmt|;
name|ssize_t
name|ret
decl_stmt|;
name|ret
operator|=
name|ib_query_port
argument_list|(
name|p
operator|->
name|ibdev
argument_list|,
name|p
operator|->
name|port_num
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%d\n"
argument_list|,
name|attr
operator|.
name|lmc
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|sm_lid_show
parameter_list|(
name|struct
name|ib_port
modifier|*
name|p
parameter_list|,
name|struct
name|port_attribute
modifier|*
name|unused
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|ib_port_attr
name|attr
decl_stmt|;
name|ssize_t
name|ret
decl_stmt|;
name|ret
operator|=
name|ib_query_port
argument_list|(
name|p
operator|->
name|ibdev
argument_list|,
name|p
operator|->
name|port_num
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"0x%x\n"
argument_list|,
name|attr
operator|.
name|sm_lid
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|sm_sl_show
parameter_list|(
name|struct
name|ib_port
modifier|*
name|p
parameter_list|,
name|struct
name|port_attribute
modifier|*
name|unused
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|ib_port_attr
name|attr
decl_stmt|;
name|ssize_t
name|ret
decl_stmt|;
name|ret
operator|=
name|ib_query_port
argument_list|(
name|p
operator|->
name|ibdev
argument_list|,
name|p
operator|->
name|port_num
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%d\n"
argument_list|,
name|attr
operator|.
name|sm_sl
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|cap_mask_show
parameter_list|(
name|struct
name|ib_port
modifier|*
name|p
parameter_list|,
name|struct
name|port_attribute
modifier|*
name|unused
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|ib_port_attr
name|attr
decl_stmt|;
name|ssize_t
name|ret
decl_stmt|;
name|ret
operator|=
name|ib_query_port
argument_list|(
name|p
operator|->
name|ibdev
argument_list|,
name|p
operator|->
name|port_num
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"0x%08x\n"
argument_list|,
name|attr
operator|.
name|port_cap_flags
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|rate_show
parameter_list|(
name|struct
name|ib_port
modifier|*
name|p
parameter_list|,
name|struct
name|port_attribute
modifier|*
name|unused
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|ib_port_attr
name|attr
decl_stmt|;
name|char
modifier|*
name|speed
init|=
literal|""
decl_stmt|;
name|int
name|rate
decl_stmt|;
name|ssize_t
name|ret
decl_stmt|;
name|ret
operator|=
name|ib_query_port
argument_list|(
name|p
operator|->
name|ibdev
argument_list|,
name|p
operator|->
name|port_num
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
switch|switch
condition|(
name|attr
operator|.
name|active_speed
condition|)
block|{
case|case
literal|2
case|:
name|speed
operator|=
literal|" DDR"
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|speed
operator|=
literal|" QDR"
expr_stmt|;
break|break;
block|}
name|rate
operator|=
literal|25
operator|*
name|ib_width_enum_to_int
argument_list|(
name|attr
operator|.
name|active_width
argument_list|)
operator|*
name|attr
operator|.
name|active_speed
expr_stmt|;
if|if
condition|(
name|rate
operator|<
literal|0
condition|)
return|return
operator|-
name|EINVAL
return|;
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%d%s Gb/sec (%dX%s)\n"
argument_list|,
name|rate
operator|/
literal|10
argument_list|,
name|rate
operator|%
literal|10
condition|?
literal|".5"
else|:
literal|""
argument_list|,
name|ib_width_enum_to_int
argument_list|(
name|attr
operator|.
name|active_width
argument_list|)
argument_list|,
name|speed
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|phys_state_show
parameter_list|(
name|struct
name|ib_port
modifier|*
name|p
parameter_list|,
name|struct
name|port_attribute
modifier|*
name|unused
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|ib_port_attr
name|attr
decl_stmt|;
name|ssize_t
name|ret
decl_stmt|;
name|ret
operator|=
name|ib_query_port
argument_list|(
name|p
operator|->
name|ibdev
argument_list|,
name|p
operator|->
name|port_num
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
switch|switch
condition|(
name|attr
operator|.
name|phys_state
condition|)
block|{
case|case
literal|1
case|:
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"1: Sleep\n"
argument_list|)
return|;
case|case
literal|2
case|:
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"2: Polling\n"
argument_list|)
return|;
case|case
literal|3
case|:
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"3: Disabled\n"
argument_list|)
return|;
case|case
literal|4
case|:
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"4: PortConfigurationTraining\n"
argument_list|)
return|;
case|case
literal|5
case|:
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"5: LinkUp\n"
argument_list|)
return|;
case|case
literal|6
case|:
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"6: LinkErrorRecovery\n"
argument_list|)
return|;
case|case
literal|7
case|:
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"7: Phy Test\n"
argument_list|)
return|;
default|default:
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%d:<unknown>\n"
argument_list|,
name|attr
operator|.
name|phys_state
argument_list|)
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|link_layer_show
parameter_list|(
name|struct
name|ib_port
modifier|*
name|p
parameter_list|,
name|struct
name|port_attribute
modifier|*
name|unused
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
switch|switch
condition|(
name|rdma_port_get_link_layer
argument_list|(
name|p
operator|->
name|ibdev
argument_list|,
name|p
operator|->
name|port_num
argument_list|)
condition|)
block|{
case|case
name|IB_LINK_LAYER_INFINIBAND
case|:
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%s\n"
argument_list|,
literal|"IB"
argument_list|)
return|;
case|case
name|IB_LINK_LAYER_ETHERNET
case|:
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%s\n"
argument_list|,
literal|"Ethernet"
argument_list|)
return|;
default|default:
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%s\n"
argument_list|,
literal|"Unknown"
argument_list|)
return|;
block|}
block|}
end_function

begin_expr_stmt
specifier|static
name|PORT_ATTR_RO
argument_list|(
name|state
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_ATTR_RO
argument_list|(
name|lid
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_ATTR_RO
argument_list|(
name|lid_mask_count
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_ATTR_RO
argument_list|(
name|sm_lid
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_ATTR_RO
argument_list|(
name|sm_sl
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_ATTR_RO
argument_list|(
name|cap_mask
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_ATTR_RO
argument_list|(
name|rate
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_ATTR_RO
argument_list|(
name|phys_state
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_ATTR_RO
argument_list|(
name|link_layer
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|struct
name|attribute
modifier|*
name|port_default_attrs
index|[]
init|=
block|{
operator|&
name|port_attr_state
operator|.
name|attr
block|,
operator|&
name|port_attr_lid
operator|.
name|attr
block|,
operator|&
name|port_attr_lid_mask_count
operator|.
name|attr
block|,
operator|&
name|port_attr_sm_lid
operator|.
name|attr
block|,
operator|&
name|port_attr_sm_sl
operator|.
name|attr
block|,
operator|&
name|port_attr_cap_mask
operator|.
name|attr
block|,
operator|&
name|port_attr_rate
operator|.
name|attr
block|,
operator|&
name|port_attr_phys_state
operator|.
name|attr
block|,
operator|&
name|port_attr_link_layer
operator|.
name|attr
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|ssize_t
name|show_port_gid
parameter_list|(
name|struct
name|ib_port
modifier|*
name|p
parameter_list|,
name|struct
name|port_attribute
modifier|*
name|attr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|port_table_attribute
modifier|*
name|tab_attr
init|=
name|container_of
argument_list|(
name|attr
argument_list|,
expr|struct
name|port_table_attribute
argument_list|,
name|attr
argument_list|)
decl_stmt|;
name|union
name|ib_gid
name|gid
decl_stmt|;
name|ssize_t
name|ret
decl_stmt|;
name|u16
modifier|*
name|raw
decl_stmt|;
name|ret
operator|=
name|ib_query_gid
argument_list|(
name|p
operator|->
name|ibdev
argument_list|,
name|p
operator|->
name|port_num
argument_list|,
name|tab_attr
operator|->
name|index
argument_list|,
operator|&
name|gid
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|raw
operator|=
operator|(
name|u16
operator|*
operator|)
name|gid
operator|.
name|raw
expr_stmt|;
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%.4x:%.4x:%.4x:%.4x:%.4x:%.4x:%.4x:%.4x\n"
argument_list|,
name|htons
argument_list|(
name|raw
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|htons
argument_list|(
name|raw
index|[
literal|1
index|]
argument_list|)
argument_list|,
name|htons
argument_list|(
name|raw
index|[
literal|2
index|]
argument_list|)
argument_list|,
name|htons
argument_list|(
name|raw
index|[
literal|3
index|]
argument_list|)
argument_list|,
name|htons
argument_list|(
name|raw
index|[
literal|4
index|]
argument_list|)
argument_list|,
name|htons
argument_list|(
name|raw
index|[
literal|5
index|]
argument_list|)
argument_list|,
name|htons
argument_list|(
name|raw
index|[
literal|6
index|]
argument_list|)
argument_list|,
name|htons
argument_list|(
name|raw
index|[
literal|7
index|]
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|show_port_pkey
parameter_list|(
name|struct
name|ib_port
modifier|*
name|p
parameter_list|,
name|struct
name|port_attribute
modifier|*
name|attr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|port_table_attribute
modifier|*
name|tab_attr
init|=
name|container_of
argument_list|(
name|attr
argument_list|,
expr|struct
name|port_table_attribute
argument_list|,
name|attr
argument_list|)
decl_stmt|;
name|u16
name|pkey
decl_stmt|;
name|ssize_t
name|ret
decl_stmt|;
name|ret
operator|=
name|ib_query_pkey
argument_list|(
name|p
operator|->
name|ibdev
argument_list|,
name|p
operator|->
name|port_num
argument_list|,
name|tab_attr
operator|->
name|index
argument_list|,
operator|&
name|pkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"0x%04x\n"
argument_list|,
name|pkey
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|get_pma_counters
parameter_list|(
name|struct
name|ib_port
modifier|*
name|p
parameter_list|,
name|struct
name|port_attribute
modifier|*
name|attr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|int
name|c_ext
parameter_list|)
block|{
name|struct
name|port_table_attribute
modifier|*
name|tab_attr
init|=
name|container_of
argument_list|(
name|attr
argument_list|,
expr|struct
name|port_table_attribute
argument_list|,
name|attr
argument_list|)
decl_stmt|;
name|int
name|offset
init|=
name|tab_attr
operator|->
name|index
operator|&
literal|0xffff
decl_stmt|;
name|int
name|width
init|=
operator|(
name|tab_attr
operator|->
name|index
operator|>>
literal|16
operator|)
operator|&
literal|0xff
decl_stmt|;
name|struct
name|ib_mad
modifier|*
name|in_mad
init|=
name|NULL
decl_stmt|;
name|struct
name|ib_mad
modifier|*
name|out_mad
init|=
name|NULL
decl_stmt|;
name|ssize_t
name|ret
decl_stmt|;
if|if
condition|(
operator|!
name|p
operator|->
name|ibdev
operator|->
name|process_mad
condition|)
return|return
operator|-
name|ENXIO
return|;
name|in_mad
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
expr|*
name|in_mad
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
name|out_mad
operator|=
name|kmalloc
argument_list|(
sizeof|sizeof
expr|*
name|out_mad
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|in_mad
operator|||
operator|!
name|out_mad
condition|)
block|{
name|ret
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|in_mad
operator|->
name|mad_hdr
operator|.
name|base_version
operator|=
literal|1
expr_stmt|;
name|in_mad
operator|->
name|mad_hdr
operator|.
name|mgmt_class
operator|=
name|IB_MGMT_CLASS_PERF_MGMT
expr_stmt|;
name|in_mad
operator|->
name|mad_hdr
operator|.
name|class_version
operator|=
literal|1
expr_stmt|;
name|in_mad
operator|->
name|mad_hdr
operator|.
name|method
operator|=
name|IB_MGMT_METHOD_GET
expr_stmt|;
if|if
condition|(
name|c_ext
condition|)
name|in_mad
operator|->
name|mad_hdr
operator|.
name|attr_id
operator|=
name|IB_PMA_PORT_COUNTERS_EXT
expr_stmt|;
else|else
name|in_mad
operator|->
name|mad_hdr
operator|.
name|attr_id
operator|=
name|IB_PMA_PORT_COUNTERS
expr_stmt|;
name|in_mad
operator|->
name|data
index|[
literal|41
index|]
operator|=
name|p
operator|->
name|port_num
expr_stmt|;
comment|/* PortSelect field */
if|if
condition|(
operator|(
name|p
operator|->
name|ibdev
operator|->
name|process_mad
argument_list|(
name|p
operator|->
name|ibdev
argument_list|,
name|IB_MAD_IGNORE_MKEY
argument_list|,
name|p
operator|->
name|port_num
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|in_mad
argument_list|,
name|out_mad
argument_list|)
operator|&
operator|(
name|IB_MAD_RESULT_SUCCESS
operator||
name|IB_MAD_RESULT_REPLY
operator|)
operator|)
operator|!=
operator|(
name|IB_MAD_RESULT_SUCCESS
operator||
name|IB_MAD_RESULT_REPLY
operator|)
condition|)
block|{
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
switch|switch
condition|(
name|width
condition|)
block|{
case|case
literal|4
case|:
name|ret
operator|=
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%u\n"
argument_list|,
operator|(
name|out_mad
operator|->
name|data
index|[
literal|40
operator|+
name|offset
operator|/
literal|8
index|]
operator|>>
operator|(
literal|4
operator|-
operator|(
name|offset
operator|%
literal|8
operator|)
operator|)
operator|)
operator|&
literal|0xf
argument_list|)
expr_stmt|;
break|break;
case|case
literal|8
case|:
name|ret
operator|=
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%u\n"
argument_list|,
name|out_mad
operator|->
name|data
index|[
literal|40
operator|+
name|offset
operator|/
literal|8
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|16
case|:
name|ret
operator|=
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%u\n"
argument_list|,
name|be16_to_cpup
argument_list|(
operator|(
name|__be16
operator|*
operator|)
operator|(
name|out_mad
operator|->
name|data
operator|+
literal|40
operator|+
name|offset
operator|/
literal|8
operator|)
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|32
case|:
name|ret
operator|=
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%u\n"
argument_list|,
name|be32_to_cpup
argument_list|(
operator|(
name|__be32
operator|*
operator|)
operator|(
name|out_mad
operator|->
name|data
operator|+
literal|40
operator|+
name|offset
operator|/
literal|8
operator|)
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|64
case|:
name|ret
operator|=
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%llu\n"
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|be64_to_cpup
argument_list|(
operator|(
name|__be64
operator|*
operator|)
operator|(
name|out_mad
operator|->
name|data
operator|+
literal|40
operator|+
name|offset
operator|/
literal|8
operator|)
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|ret
operator|=
literal|0
expr_stmt|;
block|}
name|out
label|:
name|kfree
argument_list|(
name|in_mad
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|out_mad
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_define
define|#
directive|define
name|PORT_PMA_ATTR
parameter_list|(
name|_name
parameter_list|,
name|_counter
parameter_list|,
name|_width
parameter_list|,
name|_offset
parameter_list|)
define|\
value|struct port_table_attribute port_pma_attr_##_name = {                   \         .attr  = __ATTR(_name, S_IRUGO, show_pma_counter, NULL),        \         .index = (_offset) | ((_width)<< 16) | ((_counter)<< 24)      \ }
end_define

begin_function
specifier|static
name|ssize_t
name|show_pma_counter
parameter_list|(
name|struct
name|ib_port
modifier|*
name|p
parameter_list|,
name|struct
name|port_attribute
modifier|*
name|attr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
return|return
name|get_pma_counters
argument_list|(
name|p
argument_list|,
name|attr
argument_list|,
name|buf
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_expr_stmt
specifier|static
name|PORT_PMA_ATTR
argument_list|(
name|symbol_error
argument_list|,
literal|0
argument_list|,
literal|16
argument_list|,
literal|32
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_PMA_ATTR
argument_list|(
name|link_error_recovery
argument_list|,
literal|1
argument_list|,
literal|8
argument_list|,
literal|48
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_PMA_ATTR
argument_list|(
name|link_downed
argument_list|,
literal|2
argument_list|,
literal|8
argument_list|,
literal|56
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_PMA_ATTR
argument_list|(
name|port_rcv_errors
argument_list|,
literal|3
argument_list|,
literal|16
argument_list|,
literal|64
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_PMA_ATTR
argument_list|(
name|port_rcv_remote_physical_errors
argument_list|,
literal|4
argument_list|,
literal|16
argument_list|,
literal|80
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_PMA_ATTR
argument_list|(
name|port_rcv_switch_relay_errors
argument_list|,
literal|5
argument_list|,
literal|16
argument_list|,
literal|96
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_PMA_ATTR
argument_list|(
name|port_xmit_discards
argument_list|,
literal|6
argument_list|,
literal|16
argument_list|,
literal|112
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_PMA_ATTR
argument_list|(
name|port_xmit_constraint_errors
argument_list|,
literal|7
argument_list|,
literal|8
argument_list|,
literal|128
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_PMA_ATTR
argument_list|(
name|port_rcv_constraint_errors
argument_list|,
literal|8
argument_list|,
literal|8
argument_list|,
literal|136
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_PMA_ATTR
argument_list|(
name|local_link_integrity_errors
argument_list|,
literal|9
argument_list|,
literal|4
argument_list|,
literal|152
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_PMA_ATTR
argument_list|(
name|excessive_buffer_overrun_errors
argument_list|,
literal|10
argument_list|,
literal|4
argument_list|,
literal|156
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_PMA_ATTR
argument_list|(
name|VL15_dropped
argument_list|,
literal|11
argument_list|,
literal|16
argument_list|,
literal|176
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_PMA_ATTR
argument_list|(
name|port_xmit_data
argument_list|,
literal|12
argument_list|,
literal|32
argument_list|,
literal|192
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_PMA_ATTR
argument_list|(
name|port_rcv_data
argument_list|,
literal|13
argument_list|,
literal|32
argument_list|,
literal|224
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_PMA_ATTR
argument_list|(
name|port_xmit_packets
argument_list|,
literal|14
argument_list|,
literal|32
argument_list|,
literal|256
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_PMA_ATTR
argument_list|(
name|port_rcv_packets
argument_list|,
literal|15
argument_list|,
literal|32
argument_list|,
literal|288
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|struct
name|attribute
modifier|*
name|pma_attrs
index|[]
init|=
block|{
operator|&
name|port_pma_attr_symbol_error
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_link_error_recovery
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_link_downed
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_port_rcv_errors
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_port_rcv_remote_physical_errors
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_port_rcv_switch_relay_errors
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_port_xmit_discards
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_port_xmit_constraint_errors
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_port_rcv_constraint_errors
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_local_link_integrity_errors
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_excessive_buffer_overrun_errors
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_VL15_dropped
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_port_xmit_data
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_port_rcv_data
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_port_xmit_packets
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_port_rcv_packets
operator|.
name|attr
operator|.
name|attr
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|attribute_group
name|pma_group
init|=
block|{
operator|.
name|name
operator|=
literal|"counters"
block|,
operator|.
name|attrs
operator|=
name|pma_attrs
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|PORT_PMA_ATTR_EXT
parameter_list|(
name|_name
parameter_list|,
name|_counter
parameter_list|,
name|_width
parameter_list|,
name|_offset
parameter_list|)
define|\
value|struct port_table_attribute port_pma_attr_ext_##_name = {               \         .attr  = __ATTR(_name, S_IRUGO, show_pma_counter_ext, NULL),    \         .index = (_offset) | ((_width)<< 16) | ((_counter)<< 24)      \ }
end_define

begin_function
specifier|static
name|ssize_t
name|show_pma_counter_ext
parameter_list|(
name|struct
name|ib_port
modifier|*
name|p
parameter_list|,
name|struct
name|port_attribute
modifier|*
name|attr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
return|return
name|get_pma_counters
argument_list|(
name|p
argument_list|,
name|attr
argument_list|,
name|buf
argument_list|,
literal|1
argument_list|)
return|;
block|}
end_function

begin_expr_stmt
specifier|static
name|PORT_PMA_ATTR_EXT
argument_list|(
name|port_xmit_data_64
argument_list|,
literal|0
argument_list|,
literal|64
argument_list|,
literal|64
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_PMA_ATTR_EXT
argument_list|(
name|port_rcv_data_64
argument_list|,
literal|0
argument_list|,
literal|64
argument_list|,
literal|128
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_PMA_ATTR_EXT
argument_list|(
name|port_xmit_packets_64
argument_list|,
literal|0
argument_list|,
literal|64
argument_list|,
literal|192
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_PMA_ATTR_EXT
argument_list|(
name|port_rcv_packets_64
argument_list|,
literal|0
argument_list|,
literal|64
argument_list|,
literal|256
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_PMA_ATTR_EXT
argument_list|(
name|port_unicast_xmit_packets
argument_list|,
literal|0
argument_list|,
literal|64
argument_list|,
literal|320
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_PMA_ATTR_EXT
argument_list|(
name|port_unicast_rcv_packets
argument_list|,
literal|0
argument_list|,
literal|64
argument_list|,
literal|384
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_PMA_ATTR_EXT
argument_list|(
name|port_multicast_xmit_packets
argument_list|,
literal|0
argument_list|,
literal|64
argument_list|,
literal|448
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_PMA_ATTR_EXT
argument_list|(
name|port_multicast_rcv_packets
argument_list|,
literal|0
argument_list|,
literal|64
argument_list|,
literal|512
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|struct
name|attribute
modifier|*
name|pma_attrs_ext
index|[]
init|=
block|{
operator|&
name|port_pma_attr_ext_port_xmit_data_64
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_ext_port_rcv_data_64
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_ext_port_xmit_packets_64
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_ext_port_rcv_packets_64
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_ext_port_unicast_xmit_packets
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_ext_port_unicast_rcv_packets
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_ext_port_multicast_xmit_packets
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_ext_port_multicast_rcv_packets
operator|.
name|attr
operator|.
name|attr
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|attribute_group
name|pma_ext_group
init|=
block|{
operator|.
name|name
operator|=
literal|"counters_ext"
block|,
operator|.
name|attrs
operator|=
name|pma_attrs_ext
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|ib_port_release
parameter_list|(
name|struct
name|kobject
modifier|*
name|kobj
parameter_list|)
block|{
name|struct
name|ib_port
modifier|*
name|p
init|=
name|container_of
argument_list|(
name|kobj
argument_list|,
expr|struct
name|ib_port
argument_list|,
name|kobj
argument_list|)
decl_stmt|;
name|struct
name|attribute
modifier|*
name|a
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|(
name|a
operator|=
name|p
operator|->
name|gid_group
operator|.
name|attrs
index|[
name|i
index|]
operator|)
condition|;
operator|++
name|i
control|)
name|kfree
argument_list|(
name|a
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|p
operator|->
name|gid_group
operator|.
name|attrs
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|(
name|a
operator|=
name|p
operator|->
name|pkey_group
operator|.
name|attrs
index|[
name|i
index|]
operator|)
condition|;
operator|++
name|i
control|)
name|kfree
argument_list|(
name|a
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|p
operator|->
name|pkey_group
operator|.
name|attrs
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
name|struct
name|kobj_type
name|port_type
init|=
block|{
operator|.
name|release
operator|=
name|ib_port_release
block|,
operator|.
name|sysfs_ops
operator|=
operator|&
name|port_sysfs_ops
block|,
operator|.
name|default_attrs
operator|=
name|port_default_attrs
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|ib_device_release
parameter_list|(
name|struct
name|device
modifier|*
name|device
parameter_list|)
block|{
name|struct
name|ib_device
modifier|*
name|dev
init|=
name|container_of
argument_list|(
name|device
argument_list|,
expr|struct
name|ib_device
argument_list|,
name|dev
argument_list|)
decl_stmt|;
name|kfree
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|__linux__
end_ifdef

begin_comment
comment|/* BSD supports this through devfs(5) and devd(8). */
end_comment

begin_function
specifier|static
name|int
name|ib_device_uevent
parameter_list|(
name|struct
name|device
modifier|*
name|device
parameter_list|,
name|struct
name|kobj_uevent_env
modifier|*
name|env
parameter_list|)
block|{
name|struct
name|ib_device
modifier|*
name|dev
init|=
name|container_of
argument_list|(
name|device
argument_list|,
expr|struct
name|ib_device
argument_list|,
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|add_uevent_var
argument_list|(
name|env
argument_list|,
literal|"NAME=%s"
argument_list|,
name|dev
operator|->
name|name
argument_list|)
condition|)
return|return
operator|-
name|ENOMEM
return|;
comment|/* 	 * It would be nice to pass the node GUID with the event... 	 */
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|struct
name|attribute
modifier|*
modifier|*
name|alloc_group_attrs
parameter_list|(
name|ssize_t
function_decl|(
modifier|*
name|show
function_decl|)
parameter_list|(
name|struct
name|ib_port
modifier|*
parameter_list|,
name|struct
name|port_attribute
modifier|*
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|struct
name|attribute
modifier|*
modifier|*
name|tab_attr
decl_stmt|;
name|struct
name|port_table_attribute
modifier|*
name|element
decl_stmt|;
name|int
name|i
decl_stmt|;
name|tab_attr
operator|=
name|kcalloc
argument_list|(
literal|1
operator|+
name|len
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|attribute
operator|*
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tab_attr
condition|)
return|return
name|NULL
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
block|{
name|element
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|port_table_attribute
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|element
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
name|snprintf
argument_list|(
name|element
operator|->
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|element
operator|->
name|name
argument_list|)
argument_list|,
literal|"%d"
argument_list|,
name|i
argument_list|)
operator|>=
sizeof|sizeof
argument_list|(
name|element
operator|->
name|name
argument_list|)
condition|)
block|{
name|kfree
argument_list|(
name|element
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|element
operator|->
name|attr
operator|.
name|attr
operator|.
name|name
operator|=
name|element
operator|->
name|name
expr_stmt|;
name|element
operator|->
name|attr
operator|.
name|attr
operator|.
name|mode
operator|=
name|S_IRUGO
expr_stmt|;
name|element
operator|->
name|attr
operator|.
name|show
operator|=
name|show
expr_stmt|;
name|element
operator|->
name|index
operator|=
name|i
expr_stmt|;
name|tab_attr
index|[
name|i
index|]
operator|=
operator|&
name|element
operator|->
name|attr
operator|.
name|attr
expr_stmt|;
block|}
return|return
name|tab_attr
return|;
name|err
label|:
while|while
condition|(
operator|--
name|i
operator|>=
literal|0
condition|)
name|kfree
argument_list|(
name|tab_attr
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|tab_attr
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|add_port
parameter_list|(
name|struct
name|ib_device
modifier|*
name|device
parameter_list|,
name|int
name|port_num
parameter_list|,
name|int
function_decl|(
modifier|*
name|port_callback
function_decl|)
parameter_list|(
name|struct
name|ib_device
modifier|*
parameter_list|,
name|u8
parameter_list|,
name|struct
name|kobject
modifier|*
parameter_list|)
parameter_list|)
block|{
name|struct
name|ib_port
modifier|*
name|p
decl_stmt|;
name|struct
name|ib_port_attr
name|attr
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|ib_query_port
argument_list|(
name|device
argument_list|,
name|port_num
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|p
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
expr|*
name|p
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|p
operator|->
name|ibdev
operator|=
name|device
expr_stmt|;
name|p
operator|->
name|port_num
operator|=
name|port_num
expr_stmt|;
name|ret
operator|=
name|kobject_init_and_add
argument_list|(
operator|&
name|p
operator|->
name|kobj
argument_list|,
operator|&
name|port_type
argument_list|,
name|kobject_get
argument_list|(
name|device
operator|->
name|ports_parent
argument_list|)
argument_list|,
literal|"%d"
argument_list|,
name|port_num
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err_put
goto|;
name|ret
operator|=
name|sysfs_create_group
argument_list|(
operator|&
name|p
operator|->
name|kobj
argument_list|,
operator|&
name|pma_group
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err_put
goto|;
name|ret
operator|=
name|sysfs_create_group
argument_list|(
operator|&
name|p
operator|->
name|kobj
argument_list|,
operator|&
name|pma_ext_group
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err_remove_pma
goto|;
name|p
operator|->
name|gid_group
operator|.
name|name
operator|=
literal|"gids"
expr_stmt|;
name|p
operator|->
name|gid_group
operator|.
name|attrs
operator|=
name|alloc_group_attrs
argument_list|(
name|show_port_gid
argument_list|,
name|attr
operator|.
name|gid_tbl_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p
operator|->
name|gid_group
operator|.
name|attrs
condition|)
goto|goto
name|err_remove_pma_ext
goto|;
name|ret
operator|=
name|sysfs_create_group
argument_list|(
operator|&
name|p
operator|->
name|kobj
argument_list|,
operator|&
name|p
operator|->
name|gid_group
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err_free_gid
goto|;
name|p
operator|->
name|pkey_group
operator|.
name|name
operator|=
literal|"pkeys"
expr_stmt|;
name|p
operator|->
name|pkey_group
operator|.
name|attrs
operator|=
name|alloc_group_attrs
argument_list|(
name|show_port_pkey
argument_list|,
name|attr
operator|.
name|pkey_tbl_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p
operator|->
name|pkey_group
operator|.
name|attrs
condition|)
goto|goto
name|err_remove_gid
goto|;
name|ret
operator|=
name|sysfs_create_group
argument_list|(
operator|&
name|p
operator|->
name|kobj
argument_list|,
operator|&
name|p
operator|->
name|pkey_group
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err_free_pkey
goto|;
if|if
condition|(
name|port_callback
condition|)
block|{
name|ret
operator|=
name|port_callback
argument_list|(
name|device
argument_list|,
name|port_num
argument_list|,
operator|&
name|p
operator|->
name|kobj
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err_remove_pkey
goto|;
block|}
name|list_add_tail
argument_list|(
operator|&
name|p
operator|->
name|kobj
operator|.
name|entry
argument_list|,
operator|&
name|device
operator|->
name|port_list
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|__linux__
name|kobject_uevent
argument_list|(
operator|&
name|p
operator|->
name|kobj
argument_list|,
name|KOBJ_ADD
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
literal|0
return|;
name|err_remove_pkey
label|:
name|sysfs_remove_group
argument_list|(
operator|&
name|p
operator|->
name|kobj
argument_list|,
operator|&
name|p
operator|->
name|pkey_group
argument_list|)
expr_stmt|;
name|err_free_pkey
label|:
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|attr
operator|.
name|pkey_tbl_len
condition|;
operator|++
name|i
control|)
name|kfree
argument_list|(
name|p
operator|->
name|pkey_group
operator|.
name|attrs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|p
operator|->
name|pkey_group
operator|.
name|attrs
argument_list|)
expr_stmt|;
name|err_remove_gid
label|:
name|sysfs_remove_group
argument_list|(
operator|&
name|p
operator|->
name|kobj
argument_list|,
operator|&
name|p
operator|->
name|gid_group
argument_list|)
expr_stmt|;
name|err_free_gid
label|:
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|attr
operator|.
name|gid_tbl_len
condition|;
operator|++
name|i
control|)
name|kfree
argument_list|(
name|p
operator|->
name|gid_group
operator|.
name|attrs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|p
operator|->
name|gid_group
operator|.
name|attrs
argument_list|)
expr_stmt|;
name|err_remove_pma_ext
label|:
name|sysfs_remove_group
argument_list|(
operator|&
name|p
operator|->
name|kobj
argument_list|,
operator|&
name|pma_ext_group
argument_list|)
expr_stmt|;
name|err_remove_pma
label|:
name|sysfs_remove_group
argument_list|(
operator|&
name|p
operator|->
name|kobj
argument_list|,
operator|&
name|pma_group
argument_list|)
expr_stmt|;
name|err_put
label|:
name|kobject_put
argument_list|(
name|device
operator|->
name|ports_parent
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|show_node_type
parameter_list|(
name|struct
name|device
modifier|*
name|device
parameter_list|,
name|struct
name|device_attribute
modifier|*
name|attr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|ib_device
modifier|*
name|dev
init|=
name|container_of
argument_list|(
name|device
argument_list|,
expr|struct
name|ib_device
argument_list|,
name|dev
argument_list|)
decl_stmt|;
switch|switch
condition|(
name|dev
operator|->
name|node_type
condition|)
block|{
case|case
name|RDMA_NODE_IB_CA
case|:
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%d: CA\n"
argument_list|,
name|dev
operator|->
name|node_type
argument_list|)
return|;
case|case
name|RDMA_NODE_RNIC
case|:
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%d: RNIC\n"
argument_list|,
name|dev
operator|->
name|node_type
argument_list|)
return|;
case|case
name|RDMA_NODE_IB_SWITCH
case|:
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%d: switch\n"
argument_list|,
name|dev
operator|->
name|node_type
argument_list|)
return|;
case|case
name|RDMA_NODE_IB_ROUTER
case|:
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%d: router\n"
argument_list|,
name|dev
operator|->
name|node_type
argument_list|)
return|;
default|default:
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%d:<unknown>\n"
argument_list|,
name|dev
operator|->
name|node_type
argument_list|)
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|show_sys_image_guid
parameter_list|(
name|struct
name|device
modifier|*
name|device
parameter_list|,
name|struct
name|device_attribute
modifier|*
name|dev_attr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|ib_device
modifier|*
name|dev
init|=
name|container_of
argument_list|(
name|device
argument_list|,
expr|struct
name|ib_device
argument_list|,
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ib_device_attr
name|attr
decl_stmt|;
name|ssize_t
name|ret
decl_stmt|;
name|ret
operator|=
name|ib_query_device
argument_list|(
name|dev
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%04x:%04x:%04x:%04x\n"
argument_list|,
name|be16_to_cpu
argument_list|(
operator|(
operator|(
name|__be16
operator|*
operator|)
operator|&
name|attr
operator|.
name|sys_image_guid
operator|)
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|be16_to_cpu
argument_list|(
operator|(
operator|(
name|__be16
operator|*
operator|)
operator|&
name|attr
operator|.
name|sys_image_guid
operator|)
index|[
literal|1
index|]
argument_list|)
argument_list|,
name|be16_to_cpu
argument_list|(
operator|(
operator|(
name|__be16
operator|*
operator|)
operator|&
name|attr
operator|.
name|sys_image_guid
operator|)
index|[
literal|2
index|]
argument_list|)
argument_list|,
name|be16_to_cpu
argument_list|(
operator|(
operator|(
name|__be16
operator|*
operator|)
operator|&
name|attr
operator|.
name|sys_image_guid
operator|)
index|[
literal|3
index|]
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|show_node_guid
parameter_list|(
name|struct
name|device
modifier|*
name|device
parameter_list|,
name|struct
name|device_attribute
modifier|*
name|attr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|ib_device
modifier|*
name|dev
init|=
name|container_of
argument_list|(
name|device
argument_list|,
expr|struct
name|ib_device
argument_list|,
name|dev
argument_list|)
decl_stmt|;
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%04x:%04x:%04x:%04x\n"
argument_list|,
name|be16_to_cpu
argument_list|(
operator|(
operator|(
name|__be16
operator|*
operator|)
operator|&
name|dev
operator|->
name|node_guid
operator|)
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|be16_to_cpu
argument_list|(
operator|(
operator|(
name|__be16
operator|*
operator|)
operator|&
name|dev
operator|->
name|node_guid
operator|)
index|[
literal|1
index|]
argument_list|)
argument_list|,
name|be16_to_cpu
argument_list|(
operator|(
operator|(
name|__be16
operator|*
operator|)
operator|&
name|dev
operator|->
name|node_guid
operator|)
index|[
literal|2
index|]
argument_list|)
argument_list|,
name|be16_to_cpu
argument_list|(
operator|(
operator|(
name|__be16
operator|*
operator|)
operator|&
name|dev
operator|->
name|node_guid
operator|)
index|[
literal|3
index|]
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|show_node_desc
parameter_list|(
name|struct
name|device
modifier|*
name|device
parameter_list|,
name|struct
name|device_attribute
modifier|*
name|attr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|ib_device
modifier|*
name|dev
init|=
name|container_of
argument_list|(
name|device
argument_list|,
expr|struct
name|ib_device
argument_list|,
name|dev
argument_list|)
decl_stmt|;
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%.64s\n"
argument_list|,
name|dev
operator|->
name|node_desc
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|set_node_desc
parameter_list|(
name|struct
name|device
modifier|*
name|device
parameter_list|,
name|struct
name|device_attribute
modifier|*
name|attr
parameter_list|,
specifier|const
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|count
parameter_list|)
block|{
name|struct
name|ib_device
modifier|*
name|dev
init|=
name|container_of
argument_list|(
name|device
argument_list|,
expr|struct
name|ib_device
argument_list|,
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ib_device_modify
name|desc
init|=
block|{}
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
operator|!
name|dev
operator|->
name|modify_device
condition|)
return|return
operator|-
name|EIO
return|;
name|memcpy
argument_list|(
name|desc
operator|.
name|node_desc
argument_list|,
name|buf
argument_list|,
name|min_t
argument_list|(
name|int
argument_list|,
name|count
argument_list|,
literal|64
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ib_modify_device
argument_list|(
name|dev
argument_list|,
name|IB_DEVICE_MODIFY_NODE_DESC
argument_list|,
operator|&
name|desc
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
return|return
name|count
return|;
block|}
end_function

begin_expr_stmt
specifier|static
name|DEVICE_ATTR
argument_list|(
name|node_type
argument_list|,
name|S_IRUGO
argument_list|,
name|show_node_type
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|DEVICE_ATTR
argument_list|(
name|sys_image_guid
argument_list|,
name|S_IRUGO
argument_list|,
name|show_sys_image_guid
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|DEVICE_ATTR
argument_list|(
name|node_guid
argument_list|,
name|S_IRUGO
argument_list|,
name|show_node_guid
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|DEVICE_ATTR
argument_list|(
name|node_desc
argument_list|,
name|S_IRUGO
operator||
name|S_IWUSR
argument_list|,
name|show_node_desc
argument_list|,
name|set_node_desc
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|struct
name|device_attribute
modifier|*
name|ib_class_attributes
index|[]
init|=
block|{
operator|&
name|dev_attr_node_type
block|,
operator|&
name|dev_attr_sys_image_guid
block|,
operator|&
name|dev_attr_node_guid
block|,
operator|&
name|dev_attr_node_desc
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|class
name|ib_class
init|=
block|{
operator|.
name|name
operator|=
literal|"infiniband"
block|,
operator|.
name|dev_release
operator|=
name|ib_device_release
block|,
ifdef|#
directive|ifdef
name|__linux__
operator|.
name|dev_uevent
operator|=
name|ib_device_uevent
block|,
endif|#
directive|endif
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Show a given an attribute in the statistics group */
end_comment

begin_function
specifier|static
name|ssize_t
name|show_protocol_stat
parameter_list|(
specifier|const
name|struct
name|device
modifier|*
name|device
parameter_list|,
name|struct
name|device_attribute
modifier|*
name|attr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|unsigned
name|offset
parameter_list|)
block|{
name|struct
name|ib_device
modifier|*
name|dev
init|=
name|container_of
argument_list|(
name|__DECONST
argument_list|(
expr|struct
name|device
operator|*
argument_list|,
name|device
argument_list|)
argument_list|,
expr|struct
name|ib_device
argument_list|,
name|dev
argument_list|)
decl_stmt|;
name|union
name|rdma_protocol_stats
name|stats
decl_stmt|;
name|ssize_t
name|ret
decl_stmt|;
name|ret
operator|=
name|dev
operator|->
name|get_protocol_stats
argument_list|(
name|dev
argument_list|,
operator|&
name|stats
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%llu\n"
argument_list|,
call|(
name|unsigned
name|long
name|long
call|)
argument_list|(
operator|(
name|u64
operator|*
operator|)
operator|&
name|stats
argument_list|)
index|[
name|offset
index|]
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* generate a read-only iwarp statistics attribute */
end_comment

begin_define
define|#
directive|define
name|IW_STATS_ENTRY
parameter_list|(
name|name
parameter_list|)
define|\
value|static ssize_t show_##name(struct device *device,			\ 			   struct device_attribute *attr, char *buf)	\ {									\ 	return show_protocol_stat(device, attr, buf,			\ 				  offsetof(struct iw_protocol_stats, name) / \ 				  sizeof (u64));			\ }									\ static DEVICE_ATTR(name, S_IRUGO, show_##name, NULL)
end_define

begin_expr_stmt
name|IW_STATS_ENTRY
argument_list|(
name|ipInReceives
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|IW_STATS_ENTRY
argument_list|(
name|ipInHdrErrors
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|IW_STATS_ENTRY
argument_list|(
name|ipInTooBigErrors
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|IW_STATS_ENTRY
argument_list|(
name|ipInNoRoutes
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|IW_STATS_ENTRY
argument_list|(
name|ipInAddrErrors
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|IW_STATS_ENTRY
argument_list|(
name|ipInUnknownProtos
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|IW_STATS_ENTRY
argument_list|(
name|ipInTruncatedPkts
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|IW_STATS_ENTRY
argument_list|(
name|ipInDiscards
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|IW_STATS_ENTRY
argument_list|(
name|ipInDelivers
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|IW_STATS_ENTRY
argument_list|(
name|ipOutForwDatagrams
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|IW_STATS_ENTRY
argument_list|(
name|ipOutRequests
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|IW_STATS_ENTRY
argument_list|(
name|ipOutDiscards
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|IW_STATS_ENTRY
argument_list|(
name|ipOutNoRoutes
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|IW_STATS_ENTRY
argument_list|(
name|ipReasmTimeout
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|IW_STATS_ENTRY
argument_list|(
name|ipReasmReqds
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|IW_STATS_ENTRY
argument_list|(
name|ipReasmOKs
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|IW_STATS_ENTRY
argument_list|(
name|ipReasmFails
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|IW_STATS_ENTRY
argument_list|(
name|ipFragOKs
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|IW_STATS_ENTRY
argument_list|(
name|ipFragFails
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|IW_STATS_ENTRY
argument_list|(
name|ipFragCreates
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|IW_STATS_ENTRY
argument_list|(
name|ipInMcastPkts
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|IW_STATS_ENTRY
argument_list|(
name|ipOutMcastPkts
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|IW_STATS_ENTRY
argument_list|(
name|ipInBcastPkts
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|IW_STATS_ENTRY
argument_list|(
name|ipOutBcastPkts
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|IW_STATS_ENTRY
argument_list|(
name|tcpRtoAlgorithm
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|IW_STATS_ENTRY
argument_list|(
name|tcpRtoMin
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|IW_STATS_ENTRY
argument_list|(
name|tcpRtoMax
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|IW_STATS_ENTRY
argument_list|(
name|tcpMaxConn
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|IW_STATS_ENTRY
argument_list|(
name|tcpActiveOpens
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|IW_STATS_ENTRY
argument_list|(
name|tcpPassiveOpens
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|IW_STATS_ENTRY
argument_list|(
name|tcpAttemptFails
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|IW_STATS_ENTRY
argument_list|(
name|tcpEstabResets
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|IW_STATS_ENTRY
argument_list|(
name|tcpCurrEstab
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|IW_STATS_ENTRY
argument_list|(
name|tcpInSegs
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|IW_STATS_ENTRY
argument_list|(
name|tcpOutSegs
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|IW_STATS_ENTRY
argument_list|(
name|tcpRetransSegs
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|IW_STATS_ENTRY
argument_list|(
name|tcpInErrs
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|IW_STATS_ENTRY
argument_list|(
name|tcpOutRsts
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|struct
name|attribute
modifier|*
name|iw_proto_stats_attrs
index|[]
init|=
block|{
operator|&
name|dev_attr_ipInReceives
operator|.
name|attr
block|,
operator|&
name|dev_attr_ipInHdrErrors
operator|.
name|attr
block|,
operator|&
name|dev_attr_ipInTooBigErrors
operator|.
name|attr
block|,
operator|&
name|dev_attr_ipInNoRoutes
operator|.
name|attr
block|,
operator|&
name|dev_attr_ipInAddrErrors
operator|.
name|attr
block|,
operator|&
name|dev_attr_ipInUnknownProtos
operator|.
name|attr
block|,
operator|&
name|dev_attr_ipInTruncatedPkts
operator|.
name|attr
block|,
operator|&
name|dev_attr_ipInDiscards
operator|.
name|attr
block|,
operator|&
name|dev_attr_ipInDelivers
operator|.
name|attr
block|,
operator|&
name|dev_attr_ipOutForwDatagrams
operator|.
name|attr
block|,
operator|&
name|dev_attr_ipOutRequests
operator|.
name|attr
block|,
operator|&
name|dev_attr_ipOutDiscards
operator|.
name|attr
block|,
operator|&
name|dev_attr_ipOutNoRoutes
operator|.
name|attr
block|,
operator|&
name|dev_attr_ipReasmTimeout
operator|.
name|attr
block|,
operator|&
name|dev_attr_ipReasmReqds
operator|.
name|attr
block|,
operator|&
name|dev_attr_ipReasmOKs
operator|.
name|attr
block|,
operator|&
name|dev_attr_ipReasmFails
operator|.
name|attr
block|,
operator|&
name|dev_attr_ipFragOKs
operator|.
name|attr
block|,
operator|&
name|dev_attr_ipFragFails
operator|.
name|attr
block|,
operator|&
name|dev_attr_ipFragCreates
operator|.
name|attr
block|,
operator|&
name|dev_attr_ipInMcastPkts
operator|.
name|attr
block|,
operator|&
name|dev_attr_ipOutMcastPkts
operator|.
name|attr
block|,
operator|&
name|dev_attr_ipInBcastPkts
operator|.
name|attr
block|,
operator|&
name|dev_attr_ipOutBcastPkts
operator|.
name|attr
block|,
operator|&
name|dev_attr_tcpRtoAlgorithm
operator|.
name|attr
block|,
operator|&
name|dev_attr_tcpRtoMin
operator|.
name|attr
block|,
operator|&
name|dev_attr_tcpRtoMax
operator|.
name|attr
block|,
operator|&
name|dev_attr_tcpMaxConn
operator|.
name|attr
block|,
operator|&
name|dev_attr_tcpActiveOpens
operator|.
name|attr
block|,
operator|&
name|dev_attr_tcpPassiveOpens
operator|.
name|attr
block|,
operator|&
name|dev_attr_tcpAttemptFails
operator|.
name|attr
block|,
operator|&
name|dev_attr_tcpEstabResets
operator|.
name|attr
block|,
operator|&
name|dev_attr_tcpCurrEstab
operator|.
name|attr
block|,
operator|&
name|dev_attr_tcpInSegs
operator|.
name|attr
block|,
operator|&
name|dev_attr_tcpOutSegs
operator|.
name|attr
block|,
operator|&
name|dev_attr_tcpRetransSegs
operator|.
name|attr
block|,
operator|&
name|dev_attr_tcpInErrs
operator|.
name|attr
block|,
operator|&
name|dev_attr_tcpOutRsts
operator|.
name|attr
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|attribute_group
name|iw_stats_group
init|=
block|{
operator|.
name|name
operator|=
literal|"proto_stats"
block|,
operator|.
name|attrs
operator|=
name|iw_proto_stats_attrs
block|, }
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|ib_device_register_sysfs
parameter_list|(
name|struct
name|ib_device
modifier|*
name|device
parameter_list|,
name|int
function_decl|(
modifier|*
name|port_callback
function_decl|)
parameter_list|(
name|struct
name|ib_device
modifier|*
parameter_list|,
name|u8
parameter_list|,
name|struct
name|kobject
modifier|*
parameter_list|)
parameter_list|)
block|{
name|struct
name|device
modifier|*
name|class_dev
init|=
operator|&
name|device
operator|->
name|dev
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|int
name|i
decl_stmt|;
name|class_dev
operator|->
name|class
operator|=
operator|&
name|ib_class
expr_stmt|;
name|class_dev
operator|->
name|parent
operator|=
name|device
operator|->
name|dma_device
expr_stmt|;
name|dev_set_name
argument_list|(
name|class_dev
argument_list|,
name|device
operator|->
name|name
argument_list|)
expr_stmt|;
name|dev_set_drvdata
argument_list|(
name|class_dev
argument_list|,
name|device
argument_list|)
expr_stmt|;
name|INIT_LIST_HEAD
argument_list|(
operator|&
name|device
operator|->
name|port_list
argument_list|)
expr_stmt|;
name|ret
operator|=
name|device_register
argument_list|(
name|class_dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err
goto|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ARRAY_SIZE
argument_list|(
name|ib_class_attributes
argument_list|)
condition|;
operator|++
name|i
control|)
block|{
name|ret
operator|=
name|device_create_file
argument_list|(
name|class_dev
argument_list|,
name|ib_class_attributes
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err_unregister
goto|;
block|}
name|device
operator|->
name|ports_parent
operator|=
name|kobject_create_and_add
argument_list|(
literal|"ports"
argument_list|,
name|kobject_get
argument_list|(
operator|&
name|class_dev
operator|->
name|kobj
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|device
operator|->
name|ports_parent
condition|)
block|{
name|ret
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|err_put
goto|;
block|}
if|if
condition|(
name|device
operator|->
name|node_type
operator|==
name|RDMA_NODE_IB_SWITCH
condition|)
block|{
name|ret
operator|=
name|add_port
argument_list|(
name|device
argument_list|,
literal|0
argument_list|,
name|port_callback
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err_put
goto|;
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
name|device
operator|->
name|phys_port_cnt
condition|;
operator|++
name|i
control|)
block|{
name|ret
operator|=
name|add_port
argument_list|(
name|device
argument_list|,
name|i
argument_list|,
name|port_callback
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err_put
goto|;
block|}
block|}
if|if
condition|(
name|device
operator|->
name|node_type
operator|==
name|RDMA_NODE_RNIC
operator|&&
name|device
operator|->
name|get_protocol_stats
condition|)
block|{
name|ret
operator|=
name|sysfs_create_group
argument_list|(
operator|&
name|class_dev
operator|->
name|kobj
argument_list|,
operator|&
name|iw_stats_group
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err_put
goto|;
block|}
return|return
literal|0
return|;
name|err_put
label|:
block|{
name|struct
name|kobject
modifier|*
name|p
decl_stmt|,
modifier|*
name|t
decl_stmt|;
name|struct
name|ib_port
modifier|*
name|port
decl_stmt|;
name|list_for_each_entry_safe
argument_list|(
argument|p
argument_list|,
argument|t
argument_list|,
argument|&device->port_list
argument_list|,
argument|entry
argument_list|)
block|{
name|list_del
argument_list|(
operator|&
name|p
operator|->
name|entry
argument_list|)
expr_stmt|;
name|port
operator|=
name|container_of
argument_list|(
name|p
argument_list|,
expr|struct
name|ib_port
argument_list|,
name|kobj
argument_list|)
expr_stmt|;
name|sysfs_remove_group
argument_list|(
name|p
argument_list|,
operator|&
name|pma_group
argument_list|)
expr_stmt|;
name|sysfs_remove_group
argument_list|(
name|p
argument_list|,
operator|&
name|port
operator|->
name|pkey_group
argument_list|)
expr_stmt|;
name|sysfs_remove_group
argument_list|(
name|p
argument_list|,
operator|&
name|port
operator|->
name|gid_group
argument_list|)
expr_stmt|;
name|kobject_put
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
block|}
name|kobject_put
argument_list|(
operator|&
name|class_dev
operator|->
name|kobj
argument_list|)
expr_stmt|;
name|err_unregister
label|:
name|device_unregister
argument_list|(
name|class_dev
argument_list|)
expr_stmt|;
name|err
label|:
return|return
name|ret
return|;
block|}
end_function

begin_function
name|void
name|ib_device_unregister_sysfs
parameter_list|(
name|struct
name|ib_device
modifier|*
name|device
parameter_list|)
block|{
name|struct
name|kobject
modifier|*
name|p
decl_stmt|,
modifier|*
name|t
decl_stmt|;
name|struct
name|ib_port
modifier|*
name|port
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* Hold kobject until ib_dealloc_device() */
name|kobject_get
argument_list|(
operator|&
name|device
operator|->
name|dev
operator|.
name|kobj
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ARRAY_SIZE
argument_list|(
name|ib_class_attributes
argument_list|)
condition|;
operator|++
name|i
control|)
block|{
name|device_remove_file
argument_list|(
operator|&
name|device
operator|->
name|dev
argument_list|,
name|ib_class_attributes
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|list_for_each_entry_safe
argument_list|(
argument|p
argument_list|,
argument|t
argument_list|,
argument|&device->port_list
argument_list|,
argument|entry
argument_list|)
block|{
name|list_del
argument_list|(
operator|&
name|p
operator|->
name|entry
argument_list|)
expr_stmt|;
name|port
operator|=
name|container_of
argument_list|(
name|p
argument_list|,
expr|struct
name|ib_port
argument_list|,
name|kobj
argument_list|)
expr_stmt|;
name|sysfs_remove_group
argument_list|(
name|p
argument_list|,
operator|&
name|pma_group
argument_list|)
expr_stmt|;
name|sysfs_remove_group
argument_list|(
name|p
argument_list|,
operator|&
name|port
operator|->
name|pkey_group
argument_list|)
expr_stmt|;
name|sysfs_remove_group
argument_list|(
name|p
argument_list|,
operator|&
name|port
operator|->
name|gid_group
argument_list|)
expr_stmt|;
name|kobject_put
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
name|kobject_put
argument_list|(
name|device
operator|->
name|ports_parent
argument_list|)
expr_stmt|;
name|device_unregister
argument_list|(
operator|&
name|device
operator|->
name|dev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|ib_sysfs_setup
parameter_list|(
name|void
parameter_list|)
block|{
return|return
name|class_register
argument_list|(
operator|&
name|ib_class
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|ib_sysfs_cleanup
parameter_list|(
name|void
parameter_list|)
block|{
name|class_unregister
argument_list|(
operator|&
name|ib_class
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*int ib_sysfs_create_port_files(struct ib_device *device, 			       int (*create)(struct ib_device *dev, u8 port_num, 					     struct kobject *kobj)) { 	struct kobject *p; 	struct ib_port *port; 	int ret = 0;  	list_for_each_entry(p,&device->port_list, entry) { 		port = container_of(p, struct ib_port, kobj); 		ret = create(device, port->port_num,&port->kobj); 		if (ret) 			break; 	}  	return ret; } EXPORT_SYMBOL(ib_sysfs_create_port_files);*/
end_comment

end_unit


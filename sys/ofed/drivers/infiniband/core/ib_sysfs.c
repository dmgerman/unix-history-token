begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2004, 2005 Topspin Communications.  All rights reserved.  * Copyright (c) 2005 Mellanox Technologies Ltd.  All rights reserved.  * Copyright (c) 2005 Sun Microsystems, Inc. All rights reserved.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  */
end_comment

begin_include
include|#
directive|include
file|"core_priv.h"
end_include

begin_include
include|#
directive|include
file|<linux/slab.h>
end_include

begin_include
include|#
directive|include
file|<linux/string.h>
end_include

begin_include
include|#
directive|include
file|<linux/netdevice.h>
end_include

begin_include
include|#
directive|include
file|<linux/fs.h>
end_include

begin_include
include|#
directive|include
file|<linux/printk.h>
end_include

begin_include
include|#
directive|include
file|<rdma/ib_mad.h>
end_include

begin_include
include|#
directive|include
file|<rdma/ib_pma.h>
end_include

begin_struct_decl
struct_decl|struct
name|ib_port
struct_decl|;
end_struct_decl

begin_struct
struct|struct
name|gid_attr_group
block|{
name|struct
name|ib_port
modifier|*
name|port
decl_stmt|;
name|struct
name|kobject
name|kobj
decl_stmt|;
name|struct
name|attribute_group
name|ndev
decl_stmt|;
name|struct
name|attribute_group
name|type
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|ib_port
block|{
name|struct
name|kobject
name|kobj
decl_stmt|;
name|struct
name|ib_device
modifier|*
name|ibdev
decl_stmt|;
name|struct
name|gid_attr_group
modifier|*
name|gid_attr_group
decl_stmt|;
name|struct
name|attribute_group
name|gid_group
decl_stmt|;
name|struct
name|attribute_group
name|pkey_group
decl_stmt|;
name|struct
name|attribute_group
modifier|*
name|pma_table
decl_stmt|;
name|struct
name|attribute_group
modifier|*
name|hw_stats_ag
decl_stmt|;
name|struct
name|rdma_hw_stats
modifier|*
name|hw_stats
decl_stmt|;
name|u8
name|port_num
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|port_attribute
block|{
name|struct
name|attribute
name|attr
decl_stmt|;
name|ssize_t
function_decl|(
modifier|*
name|show
function_decl|)
parameter_list|(
name|struct
name|ib_port
modifier|*
parameter_list|,
name|struct
name|port_attribute
modifier|*
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
function_decl|;
name|ssize_t
function_decl|(
modifier|*
name|store
function_decl|)
parameter_list|(
name|struct
name|ib_port
modifier|*
parameter_list|,
name|struct
name|port_attribute
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|count
parameter_list|)
function_decl|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|PORT_ATTR
parameter_list|(
name|_name
parameter_list|,
name|_mode
parameter_list|,
name|_show
parameter_list|,
name|_store
parameter_list|)
define|\
value|struct port_attribute port_attr_##_name = __ATTR(_name, _mode, _show, _store)
end_define

begin_define
define|#
directive|define
name|PORT_ATTR_RO
parameter_list|(
name|_name
parameter_list|)
define|\
value|struct port_attribute port_attr_##_name = __ATTR_RO(_name)
end_define

begin_struct
struct|struct
name|port_table_attribute
block|{
name|struct
name|port_attribute
name|attr
decl_stmt|;
name|char
name|name
index|[
literal|8
index|]
decl_stmt|;
name|int
name|index
decl_stmt|;
name|__be16
name|attr_id
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|hw_stats_attribute
block|{
name|struct
name|attribute
name|attr
decl_stmt|;
name|ssize_t
function_decl|(
modifier|*
name|show
function_decl|)
parameter_list|(
name|struct
name|kobject
modifier|*
name|kobj
parameter_list|,
name|struct
name|attribute
modifier|*
name|attr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
function_decl|;
name|ssize_t
function_decl|(
modifier|*
name|store
function_decl|)
parameter_list|(
name|struct
name|kobject
modifier|*
name|kobj
parameter_list|,
name|struct
name|attribute
modifier|*
name|attr
parameter_list|,
specifier|const
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|count
parameter_list|)
function_decl|;
name|int
name|index
decl_stmt|;
name|u8
name|port_num
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|ssize_t
name|port_attr_show
parameter_list|(
name|struct
name|kobject
modifier|*
name|kobj
parameter_list|,
name|struct
name|attribute
modifier|*
name|attr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|port_attribute
modifier|*
name|port_attr
init|=
name|container_of
argument_list|(
name|attr
argument_list|,
expr|struct
name|port_attribute
argument_list|,
name|attr
argument_list|)
decl_stmt|;
name|struct
name|ib_port
modifier|*
name|p
init|=
name|container_of
argument_list|(
name|kobj
argument_list|,
expr|struct
name|ib_port
argument_list|,
name|kobj
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|port_attr
operator|->
name|show
condition|)
return|return
operator|-
name|EIO
return|;
return|return
name|port_attr
operator|->
name|show
argument_list|(
name|p
argument_list|,
name|port_attr
argument_list|,
name|buf
argument_list|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|sysfs_ops
name|port_sysfs_ops
init|=
block|{
operator|.
name|show
operator|=
name|port_attr_show
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|ssize_t
name|gid_attr_show
parameter_list|(
name|struct
name|kobject
modifier|*
name|kobj
parameter_list|,
name|struct
name|attribute
modifier|*
name|attr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|port_attribute
modifier|*
name|port_attr
init|=
name|container_of
argument_list|(
name|attr
argument_list|,
expr|struct
name|port_attribute
argument_list|,
name|attr
argument_list|)
decl_stmt|;
name|struct
name|ib_port
modifier|*
name|p
init|=
name|container_of
argument_list|(
name|kobj
argument_list|,
expr|struct
name|gid_attr_group
argument_list|,
name|kobj
argument_list|)
operator|->
name|port
decl_stmt|;
if|if
condition|(
operator|!
name|port_attr
operator|->
name|show
condition|)
return|return
operator|-
name|EIO
return|;
return|return
name|port_attr
operator|->
name|show
argument_list|(
name|p
argument_list|,
name|port_attr
argument_list|,
name|buf
argument_list|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|sysfs_ops
name|gid_attr_sysfs_ops
init|=
block|{
operator|.
name|show
operator|=
name|gid_attr_show
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|ssize_t
name|state_show
parameter_list|(
name|struct
name|ib_port
modifier|*
name|p
parameter_list|,
name|struct
name|port_attribute
modifier|*
name|unused
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|ib_port_attr
name|attr
decl_stmt|;
name|ssize_t
name|ret
decl_stmt|;
specifier|static
specifier|const
name|char
modifier|*
name|state_name
index|[]
init|=
block|{
index|[
name|IB_PORT_NOP
index|]
operator|=
literal|"NOP"
block|,
index|[
name|IB_PORT_DOWN
index|]
operator|=
literal|"DOWN"
block|,
index|[
name|IB_PORT_INIT
index|]
operator|=
literal|"INIT"
block|,
index|[
name|IB_PORT_ARMED
index|]
operator|=
literal|"ARMED"
block|,
index|[
name|IB_PORT_ACTIVE
index|]
operator|=
literal|"ACTIVE"
block|,
index|[
name|IB_PORT_ACTIVE_DEFER
index|]
operator|=
literal|"ACTIVE_DEFER"
block|}
decl_stmt|;
name|ret
operator|=
name|ib_query_port
argument_list|(
name|p
operator|->
name|ibdev
argument_list|,
name|p
operator|->
name|port_num
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%d: %s\n"
argument_list|,
name|attr
operator|.
name|state
argument_list|,
name|attr
operator|.
name|state
operator|>=
literal|0
operator|&&
name|attr
operator|.
name|state
operator|<
name|ARRAY_SIZE
argument_list|(
name|state_name
argument_list|)
condition|?
name|state_name
index|[
name|attr
operator|.
name|state
index|]
else|:
literal|"UNKNOWN"
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|lid_show
parameter_list|(
name|struct
name|ib_port
modifier|*
name|p
parameter_list|,
name|struct
name|port_attribute
modifier|*
name|unused
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|ib_port_attr
name|attr
decl_stmt|;
name|ssize_t
name|ret
decl_stmt|;
name|ret
operator|=
name|ib_query_port
argument_list|(
name|p
operator|->
name|ibdev
argument_list|,
name|p
operator|->
name|port_num
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"0x%x\n"
argument_list|,
name|attr
operator|.
name|lid
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|lid_mask_count_show
parameter_list|(
name|struct
name|ib_port
modifier|*
name|p
parameter_list|,
name|struct
name|port_attribute
modifier|*
name|unused
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|ib_port_attr
name|attr
decl_stmt|;
name|ssize_t
name|ret
decl_stmt|;
name|ret
operator|=
name|ib_query_port
argument_list|(
name|p
operator|->
name|ibdev
argument_list|,
name|p
operator|->
name|port_num
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%d\n"
argument_list|,
name|attr
operator|.
name|lmc
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|sm_lid_show
parameter_list|(
name|struct
name|ib_port
modifier|*
name|p
parameter_list|,
name|struct
name|port_attribute
modifier|*
name|unused
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|ib_port_attr
name|attr
decl_stmt|;
name|ssize_t
name|ret
decl_stmt|;
name|ret
operator|=
name|ib_query_port
argument_list|(
name|p
operator|->
name|ibdev
argument_list|,
name|p
operator|->
name|port_num
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"0x%x\n"
argument_list|,
name|attr
operator|.
name|sm_lid
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|sm_sl_show
parameter_list|(
name|struct
name|ib_port
modifier|*
name|p
parameter_list|,
name|struct
name|port_attribute
modifier|*
name|unused
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|ib_port_attr
name|attr
decl_stmt|;
name|ssize_t
name|ret
decl_stmt|;
name|ret
operator|=
name|ib_query_port
argument_list|(
name|p
operator|->
name|ibdev
argument_list|,
name|p
operator|->
name|port_num
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%d\n"
argument_list|,
name|attr
operator|.
name|sm_sl
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|cap_mask_show
parameter_list|(
name|struct
name|ib_port
modifier|*
name|p
parameter_list|,
name|struct
name|port_attribute
modifier|*
name|unused
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|ib_port_attr
name|attr
decl_stmt|;
name|ssize_t
name|ret
decl_stmt|;
name|ret
operator|=
name|ib_query_port
argument_list|(
name|p
operator|->
name|ibdev
argument_list|,
name|p
operator|->
name|port_num
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"0x%08x\n"
argument_list|,
name|attr
operator|.
name|port_cap_flags
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|rate_show
parameter_list|(
name|struct
name|ib_port
modifier|*
name|p
parameter_list|,
name|struct
name|port_attribute
modifier|*
name|unused
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|ib_port_attr
name|attr
decl_stmt|;
name|char
modifier|*
name|speed
init|=
literal|""
decl_stmt|;
name|int
name|rate
decl_stmt|;
comment|/* in deci-Gb/sec */
name|ssize_t
name|ret
decl_stmt|;
name|ret
operator|=
name|ib_query_port
argument_list|(
name|p
operator|->
name|ibdev
argument_list|,
name|p
operator|->
name|port_num
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
switch|switch
condition|(
name|attr
operator|.
name|active_speed
condition|)
block|{
case|case
name|IB_SPEED_DDR
case|:
name|speed
operator|=
literal|" DDR"
expr_stmt|;
name|rate
operator|=
literal|50
expr_stmt|;
break|break;
case|case
name|IB_SPEED_QDR
case|:
name|speed
operator|=
literal|" QDR"
expr_stmt|;
name|rate
operator|=
literal|100
expr_stmt|;
break|break;
case|case
name|IB_SPEED_FDR10
case|:
name|speed
operator|=
literal|" FDR10"
expr_stmt|;
name|rate
operator|=
literal|100
expr_stmt|;
break|break;
case|case
name|IB_SPEED_FDR
case|:
name|speed
operator|=
literal|" FDR"
expr_stmt|;
name|rate
operator|=
literal|140
expr_stmt|;
break|break;
case|case
name|IB_SPEED_EDR
case|:
name|speed
operator|=
literal|" EDR"
expr_stmt|;
name|rate
operator|=
literal|250
expr_stmt|;
break|break;
case|case
name|IB_SPEED_SDR
case|:
default|default:
comment|/* default to SDR for invalid rates */
name|rate
operator|=
literal|25
expr_stmt|;
break|break;
block|}
name|rate
operator|*=
name|ib_width_enum_to_int
argument_list|(
name|attr
operator|.
name|active_width
argument_list|)
expr_stmt|;
if|if
condition|(
name|rate
operator|<
literal|0
condition|)
return|return
operator|-
name|EINVAL
return|;
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%d%s Gb/sec (%dX%s)\n"
argument_list|,
name|rate
operator|/
literal|10
argument_list|,
name|rate
operator|%
literal|10
condition|?
literal|".5"
else|:
literal|""
argument_list|,
name|ib_width_enum_to_int
argument_list|(
name|attr
operator|.
name|active_width
argument_list|)
argument_list|,
name|speed
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|phys_state_show
parameter_list|(
name|struct
name|ib_port
modifier|*
name|p
parameter_list|,
name|struct
name|port_attribute
modifier|*
name|unused
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|ib_port_attr
name|attr
decl_stmt|;
name|ssize_t
name|ret
decl_stmt|;
name|ret
operator|=
name|ib_query_port
argument_list|(
name|p
operator|->
name|ibdev
argument_list|,
name|p
operator|->
name|port_num
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
switch|switch
condition|(
name|attr
operator|.
name|phys_state
condition|)
block|{
case|case
literal|1
case|:
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"1: Sleep\n"
argument_list|)
return|;
case|case
literal|2
case|:
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"2: Polling\n"
argument_list|)
return|;
case|case
literal|3
case|:
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"3: Disabled\n"
argument_list|)
return|;
case|case
literal|4
case|:
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"4: PortConfigurationTraining\n"
argument_list|)
return|;
case|case
literal|5
case|:
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"5: LinkUp\n"
argument_list|)
return|;
case|case
literal|6
case|:
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"6: LinkErrorRecovery\n"
argument_list|)
return|;
case|case
literal|7
case|:
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"7: Phy Test\n"
argument_list|)
return|;
default|default:
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%d:<unknown>\n"
argument_list|,
name|attr
operator|.
name|phys_state
argument_list|)
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|link_layer_show
parameter_list|(
name|struct
name|ib_port
modifier|*
name|p
parameter_list|,
name|struct
name|port_attribute
modifier|*
name|unused
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
switch|switch
condition|(
name|rdma_port_get_link_layer
argument_list|(
name|p
operator|->
name|ibdev
argument_list|,
name|p
operator|->
name|port_num
argument_list|)
condition|)
block|{
case|case
name|IB_LINK_LAYER_INFINIBAND
case|:
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%s\n"
argument_list|,
literal|"InfiniBand"
argument_list|)
return|;
case|case
name|IB_LINK_LAYER_ETHERNET
case|:
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%s\n"
argument_list|,
literal|"Ethernet"
argument_list|)
return|;
default|default:
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%s\n"
argument_list|,
literal|"Unknown"
argument_list|)
return|;
block|}
block|}
end_function

begin_expr_stmt
specifier|static
name|PORT_ATTR_RO
argument_list|(
name|state
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_ATTR_RO
argument_list|(
name|lid
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_ATTR_RO
argument_list|(
name|lid_mask_count
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_ATTR_RO
argument_list|(
name|sm_lid
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_ATTR_RO
argument_list|(
name|sm_sl
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_ATTR_RO
argument_list|(
name|cap_mask
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_ATTR_RO
argument_list|(
name|rate
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_ATTR_RO
argument_list|(
name|phys_state
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_ATTR_RO
argument_list|(
name|link_layer
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|struct
name|attribute
modifier|*
name|port_default_attrs
index|[]
init|=
block|{
operator|&
name|port_attr_state
operator|.
name|attr
block|,
operator|&
name|port_attr_lid
operator|.
name|attr
block|,
operator|&
name|port_attr_lid_mask_count
operator|.
name|attr
block|,
operator|&
name|port_attr_sm_lid
operator|.
name|attr
block|,
operator|&
name|port_attr_sm_sl
operator|.
name|attr
block|,
operator|&
name|port_attr_cap_mask
operator|.
name|attr
block|,
operator|&
name|port_attr_rate
operator|.
name|attr
block|,
operator|&
name|port_attr_phys_state
operator|.
name|attr
block|,
operator|&
name|port_attr_link_layer
operator|.
name|attr
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|size_t
name|print_ndev
parameter_list|(
name|struct
name|ib_gid_attr
modifier|*
name|gid_attr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
if|if
condition|(
operator|!
name|gid_attr
operator|->
name|ndev
condition|)
return|return
operator|-
name|EINVAL
return|;
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%s\n"
argument_list|,
name|if_name
argument_list|(
name|gid_attr
operator|->
name|ndev
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|size_t
name|print_gid_type
parameter_list|(
name|struct
name|ib_gid_attr
modifier|*
name|gid_attr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%s\n"
argument_list|,
name|ib_cache_gid_type_str
argument_list|(
name|gid_attr
operator|->
name|gid_type
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|_show_port_gid_attr
parameter_list|(
name|struct
name|ib_port
modifier|*
name|p
parameter_list|,
name|struct
name|port_attribute
modifier|*
name|attr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
function_decl|(
modifier|*
name|print
function_decl|)
parameter_list|(
name|struct
name|ib_gid_attr
modifier|*
name|gid_attr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
parameter_list|)
block|{
name|struct
name|port_table_attribute
modifier|*
name|tab_attr
init|=
name|container_of
argument_list|(
name|attr
argument_list|,
expr|struct
name|port_table_attribute
argument_list|,
name|attr
argument_list|)
decl_stmt|;
name|union
name|ib_gid
name|gid
decl_stmt|;
name|struct
name|ib_gid_attr
name|gid_attr
init|=
block|{}
decl_stmt|;
name|ssize_t
name|ret
decl_stmt|;
name|ret
operator|=
name|ib_query_gid
argument_list|(
name|p
operator|->
name|ibdev
argument_list|,
name|p
operator|->
name|port_num
argument_list|,
name|tab_attr
operator|->
name|index
argument_list|,
operator|&
name|gid
argument_list|,
operator|&
name|gid_attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err
goto|;
name|ret
operator|=
name|print
argument_list|(
operator|&
name|gid_attr
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|err
label|:
if|if
condition|(
name|gid_attr
operator|.
name|ndev
condition|)
name|dev_put
argument_list|(
name|gid_attr
operator|.
name|ndev
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|show_port_gid
parameter_list|(
name|struct
name|ib_port
modifier|*
name|p
parameter_list|,
name|struct
name|port_attribute
modifier|*
name|attr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|port_table_attribute
modifier|*
name|tab_attr
init|=
name|container_of
argument_list|(
name|attr
argument_list|,
expr|struct
name|port_table_attribute
argument_list|,
name|attr
argument_list|)
decl_stmt|;
name|union
name|ib_gid
name|gid
decl_stmt|;
name|ssize_t
name|ret
decl_stmt|;
name|ret
operator|=
name|ib_query_gid
argument_list|(
name|p
operator|->
name|ibdev
argument_list|,
name|p
operator|->
name|port_num
argument_list|,
name|tab_attr
operator|->
name|index
argument_list|,
operator|&
name|gid
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
name|GID_PRINT_FMT
literal|"\n"
argument_list|,
name|GID_PRINT_ARGS
argument_list|(
name|gid
operator|.
name|raw
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|show_port_gid_attr_ndev
parameter_list|(
name|struct
name|ib_port
modifier|*
name|p
parameter_list|,
name|struct
name|port_attribute
modifier|*
name|attr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
return|return
name|_show_port_gid_attr
argument_list|(
name|p
argument_list|,
name|attr
argument_list|,
name|buf
argument_list|,
name|print_ndev
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|show_port_gid_attr_gid_type
parameter_list|(
name|struct
name|ib_port
modifier|*
name|p
parameter_list|,
name|struct
name|port_attribute
modifier|*
name|attr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
return|return
name|_show_port_gid_attr
argument_list|(
name|p
argument_list|,
name|attr
argument_list|,
name|buf
argument_list|,
name|print_gid_type
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|show_port_pkey
parameter_list|(
name|struct
name|ib_port
modifier|*
name|p
parameter_list|,
name|struct
name|port_attribute
modifier|*
name|attr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|port_table_attribute
modifier|*
name|tab_attr
init|=
name|container_of
argument_list|(
name|attr
argument_list|,
expr|struct
name|port_table_attribute
argument_list|,
name|attr
argument_list|)
decl_stmt|;
name|u16
name|pkey
decl_stmt|;
name|ssize_t
name|ret
decl_stmt|;
name|ret
operator|=
name|ib_query_pkey
argument_list|(
name|p
operator|->
name|ibdev
argument_list|,
name|p
operator|->
name|port_num
argument_list|,
name|tab_attr
operator|->
name|index
argument_list|,
operator|&
name|pkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"0x%04x\n"
argument_list|,
name|pkey
argument_list|)
return|;
block|}
end_function

begin_define
define|#
directive|define
name|PORT_PMA_ATTR
parameter_list|(
name|_name
parameter_list|,
name|_counter
parameter_list|,
name|_width
parameter_list|,
name|_offset
parameter_list|)
define|\
value|struct port_table_attribute port_pma_attr_##_name = {			\ 	.attr  = __ATTR(_name, S_IRUGO, show_pma_counter, NULL),	\ 	.index = (_offset) | ((_width)<< 16) | ((_counter)<< 24),	\ 	.attr_id = IB_PMA_PORT_COUNTERS ,				\ }
end_define

begin_define
define|#
directive|define
name|PORT_PMA_ATTR_EXT
parameter_list|(
name|_name
parameter_list|,
name|_width
parameter_list|,
name|_offset
parameter_list|)
define|\
value|struct port_table_attribute port_pma_attr_ext_##_name = {		\ 	.attr  = __ATTR(_name, S_IRUGO, show_pma_counter, NULL),	\ 	.index = (_offset) | ((_width)<< 16),				\ 	.attr_id = IB_PMA_PORT_COUNTERS_EXT ,				\ }
end_define

begin_comment
comment|/*  * Get a Perfmgmt MAD block of data.  * Returns error code or the number of bytes retrieved.  */
end_comment

begin_function
specifier|static
name|int
name|get_perf_mad
parameter_list|(
name|struct
name|ib_device
modifier|*
name|dev
parameter_list|,
name|int
name|port_num
parameter_list|,
name|__be16
name|attr
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|int
name|offset
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
name|struct
name|ib_mad
modifier|*
name|in_mad
decl_stmt|;
name|struct
name|ib_mad
modifier|*
name|out_mad
decl_stmt|;
name|size_t
name|mad_size
init|=
sizeof|sizeof
argument_list|(
operator|*
name|out_mad
argument_list|)
decl_stmt|;
name|u16
name|out_mad_pkey_index
init|=
literal|0
decl_stmt|;
name|ssize_t
name|ret
decl_stmt|;
if|if
condition|(
operator|!
name|dev
operator|->
name|process_mad
condition|)
return|return
operator|-
name|ENOSYS
return|;
name|in_mad
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
expr|*
name|in_mad
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
name|out_mad
operator|=
name|kmalloc
argument_list|(
sizeof|sizeof
expr|*
name|out_mad
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|in_mad
operator|||
operator|!
name|out_mad
condition|)
block|{
name|ret
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|in_mad
operator|->
name|mad_hdr
operator|.
name|base_version
operator|=
literal|1
expr_stmt|;
name|in_mad
operator|->
name|mad_hdr
operator|.
name|mgmt_class
operator|=
name|IB_MGMT_CLASS_PERF_MGMT
expr_stmt|;
name|in_mad
operator|->
name|mad_hdr
operator|.
name|class_version
operator|=
literal|1
expr_stmt|;
name|in_mad
operator|->
name|mad_hdr
operator|.
name|method
operator|=
name|IB_MGMT_METHOD_GET
expr_stmt|;
name|in_mad
operator|->
name|mad_hdr
operator|.
name|attr_id
operator|=
name|attr
expr_stmt|;
if|if
condition|(
name|attr
operator|!=
name|IB_PMA_CLASS_PORT_INFO
condition|)
name|in_mad
operator|->
name|data
index|[
literal|41
index|]
operator|=
name|port_num
expr_stmt|;
comment|/* PortSelect field */
if|if
condition|(
operator|(
name|dev
operator|->
name|process_mad
argument_list|(
name|dev
argument_list|,
name|IB_MAD_IGNORE_MKEY
argument_list|,
name|port_num
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|(
specifier|const
expr|struct
name|ib_mad_hdr
operator|*
operator|)
name|in_mad
argument_list|,
name|mad_size
argument_list|,
operator|(
expr|struct
name|ib_mad_hdr
operator|*
operator|)
name|out_mad
argument_list|,
operator|&
name|mad_size
argument_list|,
operator|&
name|out_mad_pkey_index
argument_list|)
operator|&
operator|(
name|IB_MAD_RESULT_SUCCESS
operator||
name|IB_MAD_RESULT_REPLY
operator|)
operator|)
operator|!=
operator|(
name|IB_MAD_RESULT_SUCCESS
operator||
name|IB_MAD_RESULT_REPLY
operator|)
condition|)
block|{
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|memcpy
argument_list|(
name|data
argument_list|,
name|out_mad
operator|->
name|data
operator|+
name|offset
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|ret
operator|=
name|size
expr_stmt|;
name|out
label|:
name|kfree
argument_list|(
name|in_mad
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|out_mad
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|show_pma_counter
parameter_list|(
name|struct
name|ib_port
modifier|*
name|p
parameter_list|,
name|struct
name|port_attribute
modifier|*
name|attr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|port_table_attribute
modifier|*
name|tab_attr
init|=
name|container_of
argument_list|(
name|attr
argument_list|,
expr|struct
name|port_table_attribute
argument_list|,
name|attr
argument_list|)
decl_stmt|;
name|int
name|offset
init|=
name|tab_attr
operator|->
name|index
operator|&
literal|0xffff
decl_stmt|;
name|int
name|width
init|=
operator|(
name|tab_attr
operator|->
name|index
operator|>>
literal|16
operator|)
operator|&
literal|0xff
decl_stmt|;
name|ssize_t
name|ret
decl_stmt|;
name|u8
name|data
index|[
literal|8
index|]
decl_stmt|;
name|ret
operator|=
name|get_perf_mad
argument_list|(
name|p
operator|->
name|ibdev
argument_list|,
name|p
operator|->
name|port_num
argument_list|,
name|tab_attr
operator|->
name|attr_id
argument_list|,
operator|&
name|data
argument_list|,
literal|40
operator|+
name|offset
operator|/
literal|8
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"N/A (no PMA)\n"
argument_list|)
return|;
switch|switch
condition|(
name|width
condition|)
block|{
case|case
literal|4
case|:
name|ret
operator|=
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%u\n"
argument_list|,
operator|(
operator|*
name|data
operator|>>
operator|(
literal|4
operator|-
operator|(
name|offset
operator|%
literal|8
operator|)
operator|)
operator|)
operator|&
literal|0xf
argument_list|)
expr_stmt|;
break|break;
case|case
literal|8
case|:
name|ret
operator|=
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%u\n"
argument_list|,
operator|*
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
literal|16
case|:
name|ret
operator|=
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%u\n"
argument_list|,
name|be16_to_cpup
argument_list|(
operator|(
name|__be16
operator|*
operator|)
name|data
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|32
case|:
name|ret
operator|=
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%u\n"
argument_list|,
name|be32_to_cpup
argument_list|(
operator|(
name|__be32
operator|*
operator|)
name|data
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|64
case|:
name|ret
operator|=
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%llu\n"
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|be64_to_cpup
argument_list|(
operator|(
name|__be64
operator|*
operator|)
name|data
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|ret
operator|=
literal|0
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_expr_stmt
specifier|static
name|PORT_PMA_ATTR
argument_list|(
name|symbol_error
argument_list|,
literal|0
argument_list|,
literal|16
argument_list|,
literal|32
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_PMA_ATTR
argument_list|(
name|link_error_recovery
argument_list|,
literal|1
argument_list|,
literal|8
argument_list|,
literal|48
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_PMA_ATTR
argument_list|(
name|link_downed
argument_list|,
literal|2
argument_list|,
literal|8
argument_list|,
literal|56
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_PMA_ATTR
argument_list|(
name|port_rcv_errors
argument_list|,
literal|3
argument_list|,
literal|16
argument_list|,
literal|64
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_PMA_ATTR
argument_list|(
name|port_rcv_remote_physical_errors
argument_list|,
literal|4
argument_list|,
literal|16
argument_list|,
literal|80
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_PMA_ATTR
argument_list|(
name|port_rcv_switch_relay_errors
argument_list|,
literal|5
argument_list|,
literal|16
argument_list|,
literal|96
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_PMA_ATTR
argument_list|(
name|port_xmit_discards
argument_list|,
literal|6
argument_list|,
literal|16
argument_list|,
literal|112
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_PMA_ATTR
argument_list|(
name|port_xmit_constraint_errors
argument_list|,
literal|7
argument_list|,
literal|8
argument_list|,
literal|128
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_PMA_ATTR
argument_list|(
name|port_rcv_constraint_errors
argument_list|,
literal|8
argument_list|,
literal|8
argument_list|,
literal|136
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_PMA_ATTR
argument_list|(
name|local_link_integrity_errors
argument_list|,
literal|9
argument_list|,
literal|4
argument_list|,
literal|152
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_PMA_ATTR
argument_list|(
name|excessive_buffer_overrun_errors
argument_list|,
literal|10
argument_list|,
literal|4
argument_list|,
literal|156
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_PMA_ATTR
argument_list|(
name|VL15_dropped
argument_list|,
literal|11
argument_list|,
literal|16
argument_list|,
literal|176
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_PMA_ATTR
argument_list|(
name|port_xmit_data
argument_list|,
literal|12
argument_list|,
literal|32
argument_list|,
literal|192
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_PMA_ATTR
argument_list|(
name|port_rcv_data
argument_list|,
literal|13
argument_list|,
literal|32
argument_list|,
literal|224
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_PMA_ATTR
argument_list|(
name|port_xmit_packets
argument_list|,
literal|14
argument_list|,
literal|32
argument_list|,
literal|256
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_PMA_ATTR
argument_list|(
name|port_rcv_packets
argument_list|,
literal|15
argument_list|,
literal|32
argument_list|,
literal|288
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_PMA_ATTR
argument_list|(
name|port_xmit_wait
argument_list|,
literal|0
argument_list|,
literal|32
argument_list|,
literal|320
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*  * Counters added by extended set  */
end_comment

begin_expr_stmt
specifier|static
name|PORT_PMA_ATTR_EXT
argument_list|(
name|port_xmit_data
argument_list|,
literal|64
argument_list|,
literal|64
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_PMA_ATTR_EXT
argument_list|(
name|port_rcv_data
argument_list|,
literal|64
argument_list|,
literal|128
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_PMA_ATTR_EXT
argument_list|(
name|port_xmit_packets
argument_list|,
literal|64
argument_list|,
literal|192
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_PMA_ATTR_EXT
argument_list|(
name|port_rcv_packets
argument_list|,
literal|64
argument_list|,
literal|256
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_PMA_ATTR_EXT
argument_list|(
name|unicast_xmit_packets
argument_list|,
literal|64
argument_list|,
literal|320
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_PMA_ATTR_EXT
argument_list|(
name|unicast_rcv_packets
argument_list|,
literal|64
argument_list|,
literal|384
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_PMA_ATTR_EXT
argument_list|(
name|multicast_xmit_packets
argument_list|,
literal|64
argument_list|,
literal|448
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_PMA_ATTR_EXT
argument_list|(
name|multicast_rcv_packets
argument_list|,
literal|64
argument_list|,
literal|512
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|struct
name|attribute
modifier|*
name|pma_attrs
index|[]
init|=
block|{
operator|&
name|port_pma_attr_symbol_error
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_link_error_recovery
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_link_downed
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_port_rcv_errors
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_port_rcv_remote_physical_errors
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_port_rcv_switch_relay_errors
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_port_xmit_discards
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_port_xmit_constraint_errors
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_port_rcv_constraint_errors
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_local_link_integrity_errors
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_excessive_buffer_overrun_errors
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_VL15_dropped
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_port_xmit_data
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_port_rcv_data
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_port_xmit_packets
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_port_rcv_packets
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_port_xmit_wait
operator|.
name|attr
operator|.
name|attr
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|attribute
modifier|*
name|pma_attrs_ext
index|[]
init|=
block|{
operator|&
name|port_pma_attr_symbol_error
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_link_error_recovery
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_link_downed
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_port_rcv_errors
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_port_rcv_remote_physical_errors
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_port_rcv_switch_relay_errors
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_port_xmit_discards
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_port_xmit_constraint_errors
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_port_rcv_constraint_errors
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_local_link_integrity_errors
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_excessive_buffer_overrun_errors
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_VL15_dropped
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_ext_port_xmit_data
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_ext_port_rcv_data
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_ext_port_xmit_packets
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_port_xmit_wait
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_ext_port_rcv_packets
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_ext_unicast_rcv_packets
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_ext_unicast_xmit_packets
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_ext_multicast_rcv_packets
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_ext_multicast_xmit_packets
operator|.
name|attr
operator|.
name|attr
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|attribute
modifier|*
name|pma_attrs_noietf
index|[]
init|=
block|{
operator|&
name|port_pma_attr_symbol_error
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_link_error_recovery
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_link_downed
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_port_rcv_errors
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_port_rcv_remote_physical_errors
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_port_rcv_switch_relay_errors
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_port_xmit_discards
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_port_xmit_constraint_errors
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_port_rcv_constraint_errors
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_local_link_integrity_errors
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_excessive_buffer_overrun_errors
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_VL15_dropped
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_ext_port_xmit_data
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_ext_port_rcv_data
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_ext_port_xmit_packets
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_ext_port_rcv_packets
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_pma_attr_port_xmit_wait
operator|.
name|attr
operator|.
name|attr
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|attribute_group
name|pma_group
init|=
block|{
operator|.
name|name
operator|=
literal|"counters"
block|,
operator|.
name|attrs
operator|=
name|pma_attrs
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|attribute_group
name|pma_group_ext
init|=
block|{
operator|.
name|name
operator|=
literal|"counters"
block|,
operator|.
name|attrs
operator|=
name|pma_attrs_ext
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|attribute_group
name|pma_group_noietf
init|=
block|{
operator|.
name|name
operator|=
literal|"counters"
block|,
operator|.
name|attrs
operator|=
name|pma_attrs_noietf
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|ib_port_release
parameter_list|(
name|struct
name|kobject
modifier|*
name|kobj
parameter_list|)
block|{
name|struct
name|ib_port
modifier|*
name|p
init|=
name|container_of
argument_list|(
name|kobj
argument_list|,
expr|struct
name|ib_port
argument_list|,
name|kobj
argument_list|)
decl_stmt|;
name|struct
name|attribute
modifier|*
name|a
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|p
operator|->
name|gid_group
operator|.
name|attrs
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|(
name|a
operator|=
name|p
operator|->
name|gid_group
operator|.
name|attrs
index|[
name|i
index|]
operator|)
condition|;
operator|++
name|i
control|)
name|kfree
argument_list|(
name|a
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|p
operator|->
name|gid_group
operator|.
name|attrs
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|p
operator|->
name|pkey_group
operator|.
name|attrs
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|(
name|a
operator|=
name|p
operator|->
name|pkey_group
operator|.
name|attrs
index|[
name|i
index|]
operator|)
condition|;
operator|++
name|i
control|)
name|kfree
argument_list|(
name|a
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|p
operator|->
name|pkey_group
operator|.
name|attrs
argument_list|)
expr_stmt|;
block|}
name|kfree
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ib_port_gid_attr_release
parameter_list|(
name|struct
name|kobject
modifier|*
name|kobj
parameter_list|)
block|{
name|struct
name|gid_attr_group
modifier|*
name|g
init|=
name|container_of
argument_list|(
name|kobj
argument_list|,
expr|struct
name|gid_attr_group
argument_list|,
name|kobj
argument_list|)
decl_stmt|;
name|struct
name|attribute
modifier|*
name|a
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|g
operator|->
name|ndev
operator|.
name|attrs
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|(
name|a
operator|=
name|g
operator|->
name|ndev
operator|.
name|attrs
index|[
name|i
index|]
operator|)
condition|;
operator|++
name|i
control|)
name|kfree
argument_list|(
name|a
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|g
operator|->
name|ndev
operator|.
name|attrs
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|g
operator|->
name|type
operator|.
name|attrs
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|(
name|a
operator|=
name|g
operator|->
name|type
operator|.
name|attrs
index|[
name|i
index|]
operator|)
condition|;
operator|++
name|i
control|)
name|kfree
argument_list|(
name|a
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|g
operator|->
name|type
operator|.
name|attrs
argument_list|)
expr_stmt|;
block|}
name|kfree
argument_list|(
name|g
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
name|struct
name|kobj_type
name|port_type
init|=
block|{
operator|.
name|release
operator|=
name|ib_port_release
block|,
operator|.
name|sysfs_ops
operator|=
operator|&
name|port_sysfs_ops
block|,
operator|.
name|default_attrs
operator|=
name|port_default_attrs
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|kobj_type
name|gid_attr_type
init|=
block|{
operator|.
name|sysfs_ops
operator|=
operator|&
name|gid_attr_sysfs_ops
block|,
operator|.
name|release
operator|=
name|ib_port_gid_attr_release
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|struct
name|attribute
modifier|*
modifier|*
name|alloc_group_attrs
parameter_list|(
name|ssize_t
function_decl|(
modifier|*
name|show
function_decl|)
parameter_list|(
name|struct
name|ib_port
modifier|*
parameter_list|,
name|struct
name|port_attribute
modifier|*
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|struct
name|attribute
modifier|*
modifier|*
name|tab_attr
decl_stmt|;
name|struct
name|port_table_attribute
modifier|*
name|element
decl_stmt|;
name|int
name|i
decl_stmt|;
name|tab_attr
operator|=
name|kcalloc
argument_list|(
literal|1
operator|+
name|len
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|attribute
operator|*
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tab_attr
condition|)
return|return
name|NULL
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
block|{
name|element
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|port_table_attribute
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|element
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
name|snprintf
argument_list|(
name|element
operator|->
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|element
operator|->
name|name
argument_list|)
argument_list|,
literal|"%d"
argument_list|,
name|i
argument_list|)
operator|>=
sizeof|sizeof
argument_list|(
name|element
operator|->
name|name
argument_list|)
condition|)
block|{
name|kfree
argument_list|(
name|element
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|element
operator|->
name|attr
operator|.
name|attr
operator|.
name|name
operator|=
name|element
operator|->
name|name
expr_stmt|;
name|element
operator|->
name|attr
operator|.
name|attr
operator|.
name|mode
operator|=
name|S_IRUGO
expr_stmt|;
name|element
operator|->
name|attr
operator|.
name|show
operator|=
name|show
expr_stmt|;
name|element
operator|->
name|index
operator|=
name|i
expr_stmt|;
name|sysfs_attr_init
argument_list|(
operator|&
name|element
operator|->
name|attr
operator|.
name|attr
argument_list|)
expr_stmt|;
name|tab_attr
index|[
name|i
index|]
operator|=
operator|&
name|element
operator|->
name|attr
operator|.
name|attr
expr_stmt|;
block|}
return|return
name|tab_attr
return|;
name|err
label|:
while|while
condition|(
operator|--
name|i
operator|>=
literal|0
condition|)
name|kfree
argument_list|(
name|tab_attr
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|tab_attr
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/*  * Figure out which counter table to use depending on  * the device capabilities.  */
end_comment

begin_function
specifier|static
name|struct
name|attribute_group
modifier|*
name|get_counter_table
parameter_list|(
name|struct
name|ib_device
modifier|*
name|dev
parameter_list|,
name|int
name|port_num
parameter_list|)
block|{
name|struct
name|ib_class_port_info
name|cpi
decl_stmt|;
if|if
condition|(
name|get_perf_mad
argument_list|(
name|dev
argument_list|,
name|port_num
argument_list|,
name|IB_PMA_CLASS_PORT_INFO
argument_list|,
operator|&
name|cpi
argument_list|,
literal|40
argument_list|,
sizeof|sizeof
argument_list|(
name|cpi
argument_list|)
argument_list|)
operator|>=
literal|0
condition|)
block|{
if|if
condition|(
name|cpi
operator|.
name|capability_mask
operator|&
name|IB_PMA_CLASS_CAP_EXT_WIDTH
condition|)
comment|/* We have extended counters */
return|return
operator|&
name|pma_group_ext
return|;
if|if
condition|(
name|cpi
operator|.
name|capability_mask
operator|&
name|IB_PMA_CLASS_CAP_EXT_WIDTH_NOIETF
condition|)
comment|/* But not the IETF ones */
return|return
operator|&
name|pma_group_noietf
return|;
block|}
comment|/* Fall back to normal counters */
return|return
operator|&
name|pma_group
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|update_hw_stats
parameter_list|(
name|struct
name|ib_device
modifier|*
name|dev
parameter_list|,
name|struct
name|rdma_hw_stats
modifier|*
name|stats
parameter_list|,
name|u8
name|port_num
parameter_list|,
name|int
name|index
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|time_is_after_eq_jiffies
argument_list|(
name|stats
operator|->
name|timestamp
operator|+
name|stats
operator|->
name|lifespan
argument_list|)
condition|)
return|return
literal|0
return|;
name|ret
operator|=
name|dev
operator|->
name|get_hw_stats
argument_list|(
name|dev
argument_list|,
name|stats
argument_list|,
name|port_num
argument_list|,
name|index
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
return|return
name|ret
return|;
if|if
condition|(
name|ret
operator|==
name|stats
operator|->
name|num_counters
condition|)
name|stats
operator|->
name|timestamp
operator|=
name|jiffies
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|print_hw_stat
parameter_list|(
name|struct
name|rdma_hw_stats
modifier|*
name|stats
parameter_list|,
name|int
name|index
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%llu\n"
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|stats
operator|->
name|value
index|[
name|index
index|]
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|show_hw_stats
parameter_list|(
name|struct
name|kobject
modifier|*
name|kobj
parameter_list|,
name|struct
name|attribute
modifier|*
name|attr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|ib_device
modifier|*
name|dev
decl_stmt|;
name|struct
name|ib_port
modifier|*
name|port
decl_stmt|;
name|struct
name|hw_stats_attribute
modifier|*
name|hsa
decl_stmt|;
name|struct
name|rdma_hw_stats
modifier|*
name|stats
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|hsa
operator|=
name|container_of
argument_list|(
name|attr
argument_list|,
expr|struct
name|hw_stats_attribute
argument_list|,
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|hsa
operator|->
name|port_num
condition|)
block|{
name|dev
operator|=
name|container_of
argument_list|(
operator|(
expr|struct
name|device
operator|*
operator|)
name|kobj
argument_list|,
expr|struct
name|ib_device
argument_list|,
name|dev
argument_list|)
expr_stmt|;
name|stats
operator|=
name|dev
operator|->
name|hw_stats
expr_stmt|;
block|}
else|else
block|{
name|port
operator|=
name|container_of
argument_list|(
name|kobj
argument_list|,
expr|struct
name|ib_port
argument_list|,
name|kobj
argument_list|)
expr_stmt|;
name|dev
operator|=
name|port
operator|->
name|ibdev
expr_stmt|;
name|stats
operator|=
name|port
operator|->
name|hw_stats
expr_stmt|;
block|}
name|ret
operator|=
name|update_hw_stats
argument_list|(
name|dev
argument_list|,
name|stats
argument_list|,
name|hsa
operator|->
name|port_num
argument_list|,
name|hsa
operator|->
name|index
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
return|return
name|print_hw_stat
argument_list|(
name|stats
argument_list|,
name|hsa
operator|->
name|index
argument_list|,
name|buf
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|show_stats_lifespan
parameter_list|(
name|struct
name|kobject
modifier|*
name|kobj
parameter_list|,
name|struct
name|attribute
modifier|*
name|attr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|hw_stats_attribute
modifier|*
name|hsa
decl_stmt|;
name|int
name|msecs
decl_stmt|;
name|hsa
operator|=
name|container_of
argument_list|(
name|attr
argument_list|,
expr|struct
name|hw_stats_attribute
argument_list|,
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|hsa
operator|->
name|port_num
condition|)
block|{
name|struct
name|ib_device
modifier|*
name|dev
init|=
name|container_of
argument_list|(
operator|(
expr|struct
name|device
operator|*
operator|)
name|kobj
argument_list|,
expr|struct
name|ib_device
argument_list|,
name|dev
argument_list|)
decl_stmt|;
name|msecs
operator|=
name|jiffies_to_msecs
argument_list|(
name|dev
operator|->
name|hw_stats
operator|->
name|lifespan
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|struct
name|ib_port
modifier|*
name|p
init|=
name|container_of
argument_list|(
name|kobj
argument_list|,
expr|struct
name|ib_port
argument_list|,
name|kobj
argument_list|)
decl_stmt|;
name|msecs
operator|=
name|jiffies_to_msecs
argument_list|(
name|p
operator|->
name|hw_stats
operator|->
name|lifespan
argument_list|)
expr_stmt|;
block|}
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%d\n"
argument_list|,
name|msecs
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|set_stats_lifespan
parameter_list|(
name|struct
name|kobject
modifier|*
name|kobj
parameter_list|,
name|struct
name|attribute
modifier|*
name|attr
parameter_list|,
specifier|const
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|count
parameter_list|)
block|{
name|struct
name|hw_stats_attribute
modifier|*
name|hsa
decl_stmt|;
name|int
name|msecs
decl_stmt|;
name|int
name|jiffies
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|kstrtoint
argument_list|(
name|buf
argument_list|,
literal|10
argument_list|,
operator|&
name|msecs
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
if|if
condition|(
name|msecs
operator|<
literal|0
operator|||
name|msecs
operator|>
literal|10000
condition|)
return|return
operator|-
name|EINVAL
return|;
name|jiffies
operator|=
name|msecs_to_jiffies
argument_list|(
name|msecs
argument_list|)
expr_stmt|;
name|hsa
operator|=
name|container_of
argument_list|(
name|attr
argument_list|,
expr|struct
name|hw_stats_attribute
argument_list|,
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|hsa
operator|->
name|port_num
condition|)
block|{
name|struct
name|ib_device
modifier|*
name|dev
init|=
name|container_of
argument_list|(
operator|(
expr|struct
name|device
operator|*
operator|)
name|kobj
argument_list|,
expr|struct
name|ib_device
argument_list|,
name|dev
argument_list|)
decl_stmt|;
name|dev
operator|->
name|hw_stats
operator|->
name|lifespan
operator|=
name|jiffies
expr_stmt|;
block|}
else|else
block|{
name|struct
name|ib_port
modifier|*
name|p
init|=
name|container_of
argument_list|(
name|kobj
argument_list|,
expr|struct
name|ib_port
argument_list|,
name|kobj
argument_list|)
decl_stmt|;
name|p
operator|->
name|hw_stats
operator|->
name|lifespan
operator|=
name|jiffies
expr_stmt|;
block|}
return|return
name|count
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|free_hsag
parameter_list|(
name|struct
name|kobject
modifier|*
name|kobj
parameter_list|,
name|struct
name|attribute_group
modifier|*
name|attr_group
parameter_list|)
block|{
name|struct
name|attribute
modifier|*
modifier|*
name|attr
decl_stmt|;
name|sysfs_remove_group
argument_list|(
name|kobj
argument_list|,
name|attr_group
argument_list|)
expr_stmt|;
for|for
control|(
name|attr
operator|=
name|attr_group
operator|->
name|attrs
init|;
operator|*
name|attr
condition|;
name|attr
operator|++
control|)
name|kfree
argument_list|(
operator|*
name|attr
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|attr_group
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|attribute
modifier|*
name|alloc_hsa
parameter_list|(
name|int
name|index
parameter_list|,
name|u8
name|port_num
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
name|struct
name|hw_stats_attribute
modifier|*
name|hsa
decl_stmt|;
name|hsa
operator|=
name|kmalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|hsa
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|hsa
condition|)
return|return
name|NULL
return|;
name|hsa
operator|->
name|attr
operator|.
name|name
operator|=
name|__DECONST
argument_list|(
name|char
operator|*
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|hsa
operator|->
name|attr
operator|.
name|mode
operator|=
name|S_IRUGO
expr_stmt|;
name|hsa
operator|->
name|show
operator|=
name|show_hw_stats
expr_stmt|;
name|hsa
operator|->
name|store
operator|=
name|NULL
expr_stmt|;
name|hsa
operator|->
name|index
operator|=
name|index
expr_stmt|;
name|hsa
operator|->
name|port_num
operator|=
name|port_num
expr_stmt|;
return|return
operator|&
name|hsa
operator|->
name|attr
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|attribute
modifier|*
name|alloc_hsa_lifespan
parameter_list|(
name|char
modifier|*
name|name
parameter_list|,
name|u8
name|port_num
parameter_list|)
block|{
name|struct
name|hw_stats_attribute
modifier|*
name|hsa
decl_stmt|;
name|hsa
operator|=
name|kmalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|hsa
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|hsa
condition|)
return|return
name|NULL
return|;
name|hsa
operator|->
name|attr
operator|.
name|name
operator|=
name|name
expr_stmt|;
name|hsa
operator|->
name|attr
operator|.
name|mode
operator|=
name|S_IWUSR
operator||
name|S_IRUGO
expr_stmt|;
name|hsa
operator|->
name|show
operator|=
name|show_stats_lifespan
expr_stmt|;
name|hsa
operator|->
name|store
operator|=
name|set_stats_lifespan
expr_stmt|;
name|hsa
operator|->
name|index
operator|=
literal|0
expr_stmt|;
name|hsa
operator|->
name|port_num
operator|=
name|port_num
expr_stmt|;
return|return
operator|&
name|hsa
operator|->
name|attr
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|setup_hw_stats
parameter_list|(
name|struct
name|ib_device
modifier|*
name|device
parameter_list|,
name|struct
name|ib_port
modifier|*
name|port
parameter_list|,
name|u8
name|port_num
parameter_list|)
block|{
name|struct
name|attribute_group
modifier|*
name|hsag
decl_stmt|;
name|struct
name|rdma_hw_stats
modifier|*
name|stats
decl_stmt|;
name|int
name|i
decl_stmt|,
name|ret
decl_stmt|;
name|stats
operator|=
name|device
operator|->
name|alloc_hw_stats
argument_list|(
name|device
argument_list|,
name|port_num
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|stats
condition|)
return|return;
if|if
condition|(
operator|!
name|stats
operator|->
name|names
operator|||
name|stats
operator|->
name|num_counters
operator|<=
literal|0
condition|)
goto|goto
name|err_free_stats
goto|;
comment|/* 	 * Two extra attribue elements here, one for the lifespan entry and 	 * one to NULL terminate the list for the sysfs core code 	 */
name|hsag
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|hsag
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
operator|*
operator|(
name|stats
operator|->
name|num_counters
operator|+
literal|2
operator|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|hsag
condition|)
goto|goto
name|err_free_stats
goto|;
name|ret
operator|=
name|device
operator|->
name|get_hw_stats
argument_list|(
name|device
argument_list|,
name|stats
argument_list|,
name|port_num
argument_list|,
name|stats
operator|->
name|num_counters
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|stats
operator|->
name|num_counters
condition|)
goto|goto
name|err_free_hsag
goto|;
name|stats
operator|->
name|timestamp
operator|=
name|jiffies
expr_stmt|;
name|hsag
operator|->
name|name
operator|=
literal|"hw_counters"
expr_stmt|;
name|hsag
operator|->
name|attrs
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|hsag
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|hsag
argument_list|)
operator|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|stats
operator|->
name|num_counters
condition|;
name|i
operator|++
control|)
block|{
name|hsag
operator|->
name|attrs
index|[
name|i
index|]
operator|=
name|alloc_hsa
argument_list|(
name|i
argument_list|,
name|port_num
argument_list|,
name|stats
operator|->
name|names
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|hsag
operator|->
name|attrs
index|[
name|i
index|]
condition|)
goto|goto
name|err
goto|;
name|sysfs_attr_init
argument_list|(
name|hsag
operator|->
name|attrs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
comment|/* treat an error here as non-fatal */
name|hsag
operator|->
name|attrs
index|[
name|i
index|]
operator|=
name|alloc_hsa_lifespan
argument_list|(
literal|"lifespan"
argument_list|,
name|port_num
argument_list|)
expr_stmt|;
if|if
condition|(
name|hsag
operator|->
name|attrs
index|[
name|i
index|]
condition|)
name|sysfs_attr_init
argument_list|(
name|hsag
operator|->
name|attrs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|port
condition|)
block|{
name|struct
name|kobject
modifier|*
name|kobj
init|=
operator|&
name|port
operator|->
name|kobj
decl_stmt|;
name|ret
operator|=
name|sysfs_create_group
argument_list|(
name|kobj
argument_list|,
name|hsag
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err
goto|;
name|port
operator|->
name|hw_stats_ag
operator|=
name|hsag
expr_stmt|;
name|port
operator|->
name|hw_stats
operator|=
name|stats
expr_stmt|;
block|}
else|else
block|{
name|struct
name|kobject
modifier|*
name|kobj
init|=
operator|&
name|device
operator|->
name|dev
operator|.
name|kobj
decl_stmt|;
name|ret
operator|=
name|sysfs_create_group
argument_list|(
name|kobj
argument_list|,
name|hsag
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err
goto|;
name|device
operator|->
name|hw_stats_ag
operator|=
name|hsag
expr_stmt|;
name|device
operator|->
name|hw_stats
operator|=
name|stats
expr_stmt|;
block|}
return|return;
name|err
label|:
for|for
control|(
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
name|kfree
argument_list|(
name|hsag
operator|->
name|attrs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|err_free_hsag
label|:
name|kfree
argument_list|(
name|hsag
argument_list|)
expr_stmt|;
name|err_free_stats
label|:
name|kfree
argument_list|(
name|stats
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|add_port
parameter_list|(
name|struct
name|ib_device
modifier|*
name|device
parameter_list|,
name|int
name|port_num
parameter_list|,
name|int
function_decl|(
modifier|*
name|port_callback
function_decl|)
parameter_list|(
name|struct
name|ib_device
modifier|*
parameter_list|,
name|u8
parameter_list|,
name|struct
name|kobject
modifier|*
parameter_list|)
parameter_list|)
block|{
name|struct
name|ib_port
modifier|*
name|p
decl_stmt|;
name|struct
name|ib_port_attr
name|attr
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|ib_query_port
argument_list|(
name|device
argument_list|,
name|port_num
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|p
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
expr|*
name|p
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|p
operator|->
name|ibdev
operator|=
name|device
expr_stmt|;
name|p
operator|->
name|port_num
operator|=
name|port_num
expr_stmt|;
name|ret
operator|=
name|kobject_init_and_add
argument_list|(
operator|&
name|p
operator|->
name|kobj
argument_list|,
operator|&
name|port_type
argument_list|,
name|device
operator|->
name|ports_parent
argument_list|,
literal|"%d"
argument_list|,
name|port_num
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|kfree
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|p
operator|->
name|gid_attr_group
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|p
operator|->
name|gid_attr_group
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p
operator|->
name|gid_attr_group
condition|)
block|{
name|ret
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|err_put
goto|;
block|}
name|p
operator|->
name|gid_attr_group
operator|->
name|port
operator|=
name|p
expr_stmt|;
name|ret
operator|=
name|kobject_init_and_add
argument_list|(
operator|&
name|p
operator|->
name|gid_attr_group
operator|->
name|kobj
argument_list|,
operator|&
name|gid_attr_type
argument_list|,
operator|&
name|p
operator|->
name|kobj
argument_list|,
literal|"gid_attrs"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|kfree
argument_list|(
name|p
operator|->
name|gid_attr_group
argument_list|)
expr_stmt|;
goto|goto
name|err_put
goto|;
block|}
name|p
operator|->
name|pma_table
operator|=
name|get_counter_table
argument_list|(
name|device
argument_list|,
name|port_num
argument_list|)
expr_stmt|;
name|ret
operator|=
name|sysfs_create_group
argument_list|(
operator|&
name|p
operator|->
name|kobj
argument_list|,
name|p
operator|->
name|pma_table
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err_put_gid_attrs
goto|;
name|p
operator|->
name|gid_group
operator|.
name|name
operator|=
literal|"gids"
expr_stmt|;
name|p
operator|->
name|gid_group
operator|.
name|attrs
operator|=
name|alloc_group_attrs
argument_list|(
name|show_port_gid
argument_list|,
name|attr
operator|.
name|gid_tbl_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p
operator|->
name|gid_group
operator|.
name|attrs
condition|)
block|{
name|ret
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|err_remove_pma
goto|;
block|}
name|ret
operator|=
name|sysfs_create_group
argument_list|(
operator|&
name|p
operator|->
name|kobj
argument_list|,
operator|&
name|p
operator|->
name|gid_group
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err_free_gid
goto|;
name|p
operator|->
name|gid_attr_group
operator|->
name|ndev
operator|.
name|name
operator|=
literal|"ndevs"
expr_stmt|;
name|p
operator|->
name|gid_attr_group
operator|->
name|ndev
operator|.
name|attrs
operator|=
name|alloc_group_attrs
argument_list|(
name|show_port_gid_attr_ndev
argument_list|,
name|attr
operator|.
name|gid_tbl_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p
operator|->
name|gid_attr_group
operator|->
name|ndev
operator|.
name|attrs
condition|)
block|{
name|ret
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|err_remove_gid
goto|;
block|}
name|ret
operator|=
name|sysfs_create_group
argument_list|(
operator|&
name|p
operator|->
name|gid_attr_group
operator|->
name|kobj
argument_list|,
operator|&
name|p
operator|->
name|gid_attr_group
operator|->
name|ndev
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err_free_gid_ndev
goto|;
name|p
operator|->
name|gid_attr_group
operator|->
name|type
operator|.
name|name
operator|=
literal|"types"
expr_stmt|;
name|p
operator|->
name|gid_attr_group
operator|->
name|type
operator|.
name|attrs
operator|=
name|alloc_group_attrs
argument_list|(
name|show_port_gid_attr_gid_type
argument_list|,
name|attr
operator|.
name|gid_tbl_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p
operator|->
name|gid_attr_group
operator|->
name|type
operator|.
name|attrs
condition|)
block|{
name|ret
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|err_remove_gid_ndev
goto|;
block|}
name|ret
operator|=
name|sysfs_create_group
argument_list|(
operator|&
name|p
operator|->
name|gid_attr_group
operator|->
name|kobj
argument_list|,
operator|&
name|p
operator|->
name|gid_attr_group
operator|->
name|type
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err_free_gid_type
goto|;
name|p
operator|->
name|pkey_group
operator|.
name|name
operator|=
literal|"pkeys"
expr_stmt|;
name|p
operator|->
name|pkey_group
operator|.
name|attrs
operator|=
name|alloc_group_attrs
argument_list|(
name|show_port_pkey
argument_list|,
name|attr
operator|.
name|pkey_tbl_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p
operator|->
name|pkey_group
operator|.
name|attrs
condition|)
block|{
name|ret
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|err_remove_gid_type
goto|;
block|}
name|ret
operator|=
name|sysfs_create_group
argument_list|(
operator|&
name|p
operator|->
name|kobj
argument_list|,
operator|&
name|p
operator|->
name|pkey_group
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err_free_pkey
goto|;
if|if
condition|(
name|port_callback
condition|)
block|{
name|ret
operator|=
name|port_callback
argument_list|(
name|device
argument_list|,
name|port_num
argument_list|,
operator|&
name|p
operator|->
name|kobj
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err_remove_pkey
goto|;
block|}
comment|/* 	 * If port == 0, it means we have only one port and the parent 	 * device, not this port device, should be the holder of the 	 * hw_counters 	 */
if|if
condition|(
name|device
operator|->
name|alloc_hw_stats
operator|&&
name|port_num
condition|)
name|setup_hw_stats
argument_list|(
name|device
argument_list|,
name|p
argument_list|,
name|port_num
argument_list|)
expr_stmt|;
name|list_add_tail
argument_list|(
operator|&
name|p
operator|->
name|kobj
operator|.
name|entry
argument_list|,
operator|&
name|device
operator|->
name|port_list
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|err_remove_pkey
label|:
name|sysfs_remove_group
argument_list|(
operator|&
name|p
operator|->
name|kobj
argument_list|,
operator|&
name|p
operator|->
name|pkey_group
argument_list|)
expr_stmt|;
name|err_free_pkey
label|:
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|attr
operator|.
name|pkey_tbl_len
condition|;
operator|++
name|i
control|)
name|kfree
argument_list|(
name|p
operator|->
name|pkey_group
operator|.
name|attrs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|p
operator|->
name|pkey_group
operator|.
name|attrs
argument_list|)
expr_stmt|;
name|p
operator|->
name|pkey_group
operator|.
name|attrs
operator|=
name|NULL
expr_stmt|;
name|err_remove_gid_type
label|:
name|sysfs_remove_group
argument_list|(
operator|&
name|p
operator|->
name|gid_attr_group
operator|->
name|kobj
argument_list|,
operator|&
name|p
operator|->
name|gid_attr_group
operator|->
name|type
argument_list|)
expr_stmt|;
name|err_free_gid_type
label|:
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|attr
operator|.
name|gid_tbl_len
condition|;
operator|++
name|i
control|)
name|kfree
argument_list|(
name|p
operator|->
name|gid_attr_group
operator|->
name|type
operator|.
name|attrs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|p
operator|->
name|gid_attr_group
operator|->
name|type
operator|.
name|attrs
argument_list|)
expr_stmt|;
name|p
operator|->
name|gid_attr_group
operator|->
name|type
operator|.
name|attrs
operator|=
name|NULL
expr_stmt|;
name|err_remove_gid_ndev
label|:
name|sysfs_remove_group
argument_list|(
operator|&
name|p
operator|->
name|gid_attr_group
operator|->
name|kobj
argument_list|,
operator|&
name|p
operator|->
name|gid_attr_group
operator|->
name|ndev
argument_list|)
expr_stmt|;
name|err_free_gid_ndev
label|:
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|attr
operator|.
name|gid_tbl_len
condition|;
operator|++
name|i
control|)
name|kfree
argument_list|(
name|p
operator|->
name|gid_attr_group
operator|->
name|ndev
operator|.
name|attrs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|p
operator|->
name|gid_attr_group
operator|->
name|ndev
operator|.
name|attrs
argument_list|)
expr_stmt|;
name|p
operator|->
name|gid_attr_group
operator|->
name|ndev
operator|.
name|attrs
operator|=
name|NULL
expr_stmt|;
name|err_remove_gid
label|:
name|sysfs_remove_group
argument_list|(
operator|&
name|p
operator|->
name|kobj
argument_list|,
operator|&
name|p
operator|->
name|gid_group
argument_list|)
expr_stmt|;
name|err_free_gid
label|:
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|attr
operator|.
name|gid_tbl_len
condition|;
operator|++
name|i
control|)
name|kfree
argument_list|(
name|p
operator|->
name|gid_group
operator|.
name|attrs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|p
operator|->
name|gid_group
operator|.
name|attrs
argument_list|)
expr_stmt|;
name|p
operator|->
name|gid_group
operator|.
name|attrs
operator|=
name|NULL
expr_stmt|;
name|err_remove_pma
label|:
name|sysfs_remove_group
argument_list|(
operator|&
name|p
operator|->
name|kobj
argument_list|,
name|p
operator|->
name|pma_table
argument_list|)
expr_stmt|;
name|err_put_gid_attrs
label|:
name|kobject_put
argument_list|(
operator|&
name|p
operator|->
name|gid_attr_group
operator|->
name|kobj
argument_list|)
expr_stmt|;
name|err_put
label|:
name|kobject_put
argument_list|(
operator|&
name|p
operator|->
name|kobj
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|show_node_type
parameter_list|(
name|struct
name|device
modifier|*
name|device
parameter_list|,
name|struct
name|device_attribute
modifier|*
name|attr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|ib_device
modifier|*
name|dev
init|=
name|container_of
argument_list|(
name|device
argument_list|,
expr|struct
name|ib_device
argument_list|,
name|dev
argument_list|)
decl_stmt|;
switch|switch
condition|(
name|dev
operator|->
name|node_type
condition|)
block|{
case|case
name|RDMA_NODE_IB_CA
case|:
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%d: CA\n"
argument_list|,
name|dev
operator|->
name|node_type
argument_list|)
return|;
case|case
name|RDMA_NODE_RNIC
case|:
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%d: RNIC\n"
argument_list|,
name|dev
operator|->
name|node_type
argument_list|)
return|;
case|case
name|RDMA_NODE_USNIC
case|:
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%d: usNIC\n"
argument_list|,
name|dev
operator|->
name|node_type
argument_list|)
return|;
case|case
name|RDMA_NODE_USNIC_UDP
case|:
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%d: usNIC UDP\n"
argument_list|,
name|dev
operator|->
name|node_type
argument_list|)
return|;
case|case
name|RDMA_NODE_IB_SWITCH
case|:
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%d: switch\n"
argument_list|,
name|dev
operator|->
name|node_type
argument_list|)
return|;
case|case
name|RDMA_NODE_IB_ROUTER
case|:
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%d: router\n"
argument_list|,
name|dev
operator|->
name|node_type
argument_list|)
return|;
default|default:
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%d:<unknown>\n"
argument_list|,
name|dev
operator|->
name|node_type
argument_list|)
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|show_sys_image_guid
parameter_list|(
name|struct
name|device
modifier|*
name|device
parameter_list|,
name|struct
name|device_attribute
modifier|*
name|dev_attr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|ib_device
modifier|*
name|dev
init|=
name|container_of
argument_list|(
name|device
argument_list|,
expr|struct
name|ib_device
argument_list|,
name|dev
argument_list|)
decl_stmt|;
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%04x:%04x:%04x:%04x\n"
argument_list|,
name|be16_to_cpu
argument_list|(
operator|(
operator|(
name|__be16
operator|*
operator|)
operator|&
name|dev
operator|->
name|attrs
operator|.
name|sys_image_guid
operator|)
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|be16_to_cpu
argument_list|(
operator|(
operator|(
name|__be16
operator|*
operator|)
operator|&
name|dev
operator|->
name|attrs
operator|.
name|sys_image_guid
operator|)
index|[
literal|1
index|]
argument_list|)
argument_list|,
name|be16_to_cpu
argument_list|(
operator|(
operator|(
name|__be16
operator|*
operator|)
operator|&
name|dev
operator|->
name|attrs
operator|.
name|sys_image_guid
operator|)
index|[
literal|2
index|]
argument_list|)
argument_list|,
name|be16_to_cpu
argument_list|(
operator|(
operator|(
name|__be16
operator|*
operator|)
operator|&
name|dev
operator|->
name|attrs
operator|.
name|sys_image_guid
operator|)
index|[
literal|3
index|]
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|show_node_guid
parameter_list|(
name|struct
name|device
modifier|*
name|device
parameter_list|,
name|struct
name|device_attribute
modifier|*
name|attr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|ib_device
modifier|*
name|dev
init|=
name|container_of
argument_list|(
name|device
argument_list|,
expr|struct
name|ib_device
argument_list|,
name|dev
argument_list|)
decl_stmt|;
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%04x:%04x:%04x:%04x\n"
argument_list|,
name|be16_to_cpu
argument_list|(
operator|(
operator|(
name|__be16
operator|*
operator|)
operator|&
name|dev
operator|->
name|node_guid
operator|)
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|be16_to_cpu
argument_list|(
operator|(
operator|(
name|__be16
operator|*
operator|)
operator|&
name|dev
operator|->
name|node_guid
operator|)
index|[
literal|1
index|]
argument_list|)
argument_list|,
name|be16_to_cpu
argument_list|(
operator|(
operator|(
name|__be16
operator|*
operator|)
operator|&
name|dev
operator|->
name|node_guid
operator|)
index|[
literal|2
index|]
argument_list|)
argument_list|,
name|be16_to_cpu
argument_list|(
operator|(
operator|(
name|__be16
operator|*
operator|)
operator|&
name|dev
operator|->
name|node_guid
operator|)
index|[
literal|3
index|]
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|show_node_desc
parameter_list|(
name|struct
name|device
modifier|*
name|device
parameter_list|,
name|struct
name|device_attribute
modifier|*
name|attr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|ib_device
modifier|*
name|dev
init|=
name|container_of
argument_list|(
name|device
argument_list|,
expr|struct
name|ib_device
argument_list|,
name|dev
argument_list|)
decl_stmt|;
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%.64s\n"
argument_list|,
name|dev
operator|->
name|node_desc
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|set_node_desc
parameter_list|(
name|struct
name|device
modifier|*
name|device
parameter_list|,
name|struct
name|device_attribute
modifier|*
name|attr
parameter_list|,
specifier|const
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|count
parameter_list|)
block|{
name|struct
name|ib_device
modifier|*
name|dev
init|=
name|container_of
argument_list|(
name|device
argument_list|,
expr|struct
name|ib_device
argument_list|,
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ib_device_modify
name|desc
init|=
block|{}
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
operator|!
name|dev
operator|->
name|modify_device
condition|)
return|return
operator|-
name|EIO
return|;
name|memcpy
argument_list|(
name|desc
operator|.
name|node_desc
argument_list|,
name|buf
argument_list|,
name|min_t
argument_list|(
name|int
argument_list|,
name|count
argument_list|,
name|IB_DEVICE_NODE_DESC_MAX
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ib_modify_device
argument_list|(
name|dev
argument_list|,
name|IB_DEVICE_MODIFY_NODE_DESC
argument_list|,
operator|&
name|desc
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
return|return
name|count
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|show_fw_ver
parameter_list|(
name|struct
name|device
modifier|*
name|device
parameter_list|,
name|struct
name|device_attribute
modifier|*
name|attr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|ib_device
modifier|*
name|dev
init|=
name|container_of
argument_list|(
name|device
argument_list|,
expr|struct
name|ib_device
argument_list|,
name|dev
argument_list|)
decl_stmt|;
name|ib_get_device_fw_str
argument_list|(
name|dev
argument_list|,
name|buf
argument_list|,
name|PAGE_SIZE
argument_list|)
expr_stmt|;
name|strlcat
argument_list|(
name|buf
argument_list|,
literal|"\n"
argument_list|,
name|PAGE_SIZE
argument_list|)
expr_stmt|;
return|return
name|strlen
argument_list|(
name|buf
argument_list|)
return|;
block|}
end_function

begin_expr_stmt
specifier|static
name|DEVICE_ATTR
argument_list|(
name|node_type
argument_list|,
name|S_IRUGO
argument_list|,
name|show_node_type
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|DEVICE_ATTR
argument_list|(
name|sys_image_guid
argument_list|,
name|S_IRUGO
argument_list|,
name|show_sys_image_guid
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|DEVICE_ATTR
argument_list|(
name|node_guid
argument_list|,
name|S_IRUGO
argument_list|,
name|show_node_guid
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|DEVICE_ATTR
argument_list|(
name|node_desc
argument_list|,
name|S_IRUGO
operator||
name|S_IWUSR
argument_list|,
name|show_node_desc
argument_list|,
name|set_node_desc
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|DEVICE_ATTR
argument_list|(
name|fw_ver
argument_list|,
name|S_IRUGO
argument_list|,
name|show_fw_ver
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|struct
name|device_attribute
modifier|*
name|ib_class_attributes
index|[]
init|=
block|{
operator|&
name|dev_attr_node_type
block|,
operator|&
name|dev_attr_sys_image_guid
block|,
operator|&
name|dev_attr_node_guid
block|,
operator|&
name|dev_attr_node_desc
block|,
operator|&
name|dev_attr_fw_ver
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|free_port_list_attributes
parameter_list|(
name|struct
name|ib_device
modifier|*
name|device
parameter_list|)
block|{
name|struct
name|kobject
modifier|*
name|p
decl_stmt|,
modifier|*
name|t
decl_stmt|;
name|list_for_each_entry_safe
argument_list|(
argument|p
argument_list|,
argument|t
argument_list|,
argument|&device->port_list
argument_list|,
argument|entry
argument_list|)
block|{
name|struct
name|ib_port
modifier|*
name|port
init|=
name|container_of
argument_list|(
name|p
argument_list|,
expr|struct
name|ib_port
argument_list|,
name|kobj
argument_list|)
decl_stmt|;
name|list_del
argument_list|(
operator|&
name|p
operator|->
name|entry
argument_list|)
expr_stmt|;
if|if
condition|(
name|port
operator|->
name|hw_stats
condition|)
block|{
name|kfree
argument_list|(
name|port
operator|->
name|hw_stats
argument_list|)
expr_stmt|;
name|free_hsag
argument_list|(
operator|&
name|port
operator|->
name|kobj
argument_list|,
name|port
operator|->
name|hw_stats_ag
argument_list|)
expr_stmt|;
block|}
name|sysfs_remove_group
argument_list|(
name|p
argument_list|,
name|port
operator|->
name|pma_table
argument_list|)
expr_stmt|;
name|sysfs_remove_group
argument_list|(
name|p
argument_list|,
operator|&
name|port
operator|->
name|pkey_group
argument_list|)
expr_stmt|;
name|sysfs_remove_group
argument_list|(
name|p
argument_list|,
operator|&
name|port
operator|->
name|gid_group
argument_list|)
expr_stmt|;
name|sysfs_remove_group
argument_list|(
operator|&
name|port
operator|->
name|gid_attr_group
operator|->
name|kobj
argument_list|,
operator|&
name|port
operator|->
name|gid_attr_group
operator|->
name|ndev
argument_list|)
expr_stmt|;
name|sysfs_remove_group
argument_list|(
operator|&
name|port
operator|->
name|gid_attr_group
operator|->
name|kobj
argument_list|,
operator|&
name|port
operator|->
name|gid_attr_group
operator|->
name|type
argument_list|)
expr_stmt|;
name|kobject_put
argument_list|(
operator|&
name|port
operator|->
name|gid_attr_group
operator|->
name|kobj
argument_list|)
expr_stmt|;
name|kobject_put
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
name|kobject_put
argument_list|(
name|device
operator|->
name|ports_parent
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|ib_device_register_sysfs
parameter_list|(
name|struct
name|ib_device
modifier|*
name|device
parameter_list|,
name|int
function_decl|(
modifier|*
name|port_callback
function_decl|)
parameter_list|(
name|struct
name|ib_device
modifier|*
parameter_list|,
name|u8
parameter_list|,
name|struct
name|kobject
modifier|*
parameter_list|)
parameter_list|)
block|{
name|struct
name|device
modifier|*
name|class_dev
init|=
operator|&
name|device
operator|->
name|dev
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|int
name|i
decl_stmt|;
name|device
operator|->
name|dev
operator|.
name|parent
operator|=
name|device
operator|->
name|dma_device
expr_stmt|;
name|ret
operator|=
name|dev_set_name
argument_list|(
name|class_dev
argument_list|,
literal|"%s"
argument_list|,
name|device
operator|->
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|ret
operator|=
name|device_add
argument_list|(
name|class_dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err
goto|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ARRAY_SIZE
argument_list|(
name|ib_class_attributes
argument_list|)
condition|;
operator|++
name|i
control|)
block|{
name|ret
operator|=
name|device_create_file
argument_list|(
name|class_dev
argument_list|,
name|ib_class_attributes
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err_unregister
goto|;
block|}
name|device
operator|->
name|ports_parent
operator|=
name|kobject_create_and_add
argument_list|(
literal|"ports"
argument_list|,
operator|&
name|class_dev
operator|->
name|kobj
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|device
operator|->
name|ports_parent
condition|)
block|{
name|ret
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|err_put
goto|;
block|}
if|if
condition|(
name|rdma_cap_ib_switch
argument_list|(
name|device
argument_list|)
condition|)
block|{
name|ret
operator|=
name|add_port
argument_list|(
name|device
argument_list|,
literal|0
argument_list|,
name|port_callback
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err_put
goto|;
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
name|device
operator|->
name|phys_port_cnt
condition|;
operator|++
name|i
control|)
block|{
name|ret
operator|=
name|add_port
argument_list|(
name|device
argument_list|,
name|i
argument_list|,
name|port_callback
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err_put
goto|;
block|}
block|}
if|if
condition|(
name|device
operator|->
name|alloc_hw_stats
condition|)
name|setup_hw_stats
argument_list|(
name|device
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|err_put
label|:
name|free_port_list_attributes
argument_list|(
name|device
argument_list|)
expr_stmt|;
name|err_unregister
label|:
name|device_unregister
argument_list|(
name|class_dev
argument_list|)
expr_stmt|;
name|err
label|:
return|return
name|ret
return|;
block|}
end_function

begin_function
name|void
name|ib_device_unregister_sysfs
parameter_list|(
name|struct
name|ib_device
modifier|*
name|device
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
comment|/* Hold kobject until ib_dealloc_device() */
name|kobject_get
argument_list|(
operator|&
name|device
operator|->
name|dev
operator|.
name|kobj
argument_list|)
expr_stmt|;
name|free_port_list_attributes
argument_list|(
name|device
argument_list|)
expr_stmt|;
if|if
condition|(
name|device
operator|->
name|hw_stats
condition|)
block|{
name|kfree
argument_list|(
name|device
operator|->
name|hw_stats
argument_list|)
expr_stmt|;
name|free_hsag
argument_list|(
operator|&
name|device
operator|->
name|dev
operator|.
name|kobj
argument_list|,
name|device
operator|->
name|hw_stats_ag
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ARRAY_SIZE
argument_list|(
name|ib_class_attributes
argument_list|)
condition|;
operator|++
name|i
control|)
name|device_remove_file
argument_list|(
operator|&
name|device
operator|->
name|dev
argument_list|,
name|ib_class_attributes
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|device_unregister
argument_list|(
operator|&
name|device
operator|->
name|dev
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


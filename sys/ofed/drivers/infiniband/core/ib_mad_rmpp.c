begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2005 Intel Inc. All rights reserved.  * Copyright (c) 2005-2006 Voltaire, Inc. All rights reserved.  * Copyright (c) 2014 Intel Corporation.  All rights reserved.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  */
end_comment

begin_include
include|#
directive|include
file|<linux/slab.h>
end_include

begin_include
include|#
directive|include
file|"mad_priv.h"
end_include

begin_include
include|#
directive|include
file|"mad_rmpp.h"
end_include

begin_enum
enum|enum
name|rmpp_state
block|{
name|RMPP_STATE_ACTIVE
block|,
name|RMPP_STATE_TIMEOUT
block|,
name|RMPP_STATE_COMPLETE
block|,
name|RMPP_STATE_CANCELING
block|}
enum|;
end_enum

begin_struct
struct|struct
name|mad_rmpp_recv
block|{
name|struct
name|ib_mad_agent_private
modifier|*
name|agent
decl_stmt|;
name|struct
name|list_head
name|list
decl_stmt|;
name|struct
name|delayed_work
name|timeout_work
decl_stmt|;
name|struct
name|delayed_work
name|cleanup_work
decl_stmt|;
name|struct
name|completion
name|comp
decl_stmt|;
name|enum
name|rmpp_state
name|state
decl_stmt|;
name|spinlock_t
name|lock
decl_stmt|;
name|atomic_t
name|refcount
decl_stmt|;
name|struct
name|ib_ah
modifier|*
name|ah
decl_stmt|;
name|struct
name|ib_mad_recv_wc
modifier|*
name|rmpp_wc
decl_stmt|;
name|struct
name|ib_mad_recv_buf
modifier|*
name|cur_seg_buf
decl_stmt|;
name|int
name|last_ack
decl_stmt|;
name|int
name|seg_num
decl_stmt|;
name|int
name|newwin
decl_stmt|;
name|int
name|repwin
decl_stmt|;
name|__be64
name|tid
decl_stmt|;
name|u32
name|src_qp
decl_stmt|;
name|u16
name|slid
decl_stmt|;
name|u8
name|mgmt_class
decl_stmt|;
name|u8
name|class_version
decl_stmt|;
name|u8
name|method
decl_stmt|;
name|u8
name|base_version
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
specifier|inline
name|void
name|deref_rmpp_recv
parameter_list|(
name|struct
name|mad_rmpp_recv
modifier|*
name|rmpp_recv
parameter_list|)
block|{
if|if
condition|(
name|atomic_dec_and_test
argument_list|(
operator|&
name|rmpp_recv
operator|->
name|refcount
argument_list|)
condition|)
name|complete
argument_list|(
operator|&
name|rmpp_recv
operator|->
name|comp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|destroy_rmpp_recv
parameter_list|(
name|struct
name|mad_rmpp_recv
modifier|*
name|rmpp_recv
parameter_list|)
block|{
name|deref_rmpp_recv
argument_list|(
name|rmpp_recv
argument_list|)
expr_stmt|;
name|wait_for_completion
argument_list|(
operator|&
name|rmpp_recv
operator|->
name|comp
argument_list|)
expr_stmt|;
name|ib_destroy_ah
argument_list|(
name|rmpp_recv
operator|->
name|ah
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|rmpp_recv
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ib_cancel_rmpp_recvs
parameter_list|(
name|struct
name|ib_mad_agent_private
modifier|*
name|agent
parameter_list|)
block|{
name|struct
name|mad_rmpp_recv
modifier|*
name|rmpp_recv
decl_stmt|,
modifier|*
name|temp_rmpp_recv
decl_stmt|;
name|unsigned
name|long
name|flags
decl_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|agent
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|list_for_each_entry
argument_list|(
argument|rmpp_recv
argument_list|,
argument|&agent->rmpp_list
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|rmpp_recv
operator|->
name|state
operator|!=
name|RMPP_STATE_COMPLETE
condition|)
name|ib_free_recv_mad
argument_list|(
name|rmpp_recv
operator|->
name|rmpp_wc
argument_list|)
expr_stmt|;
name|rmpp_recv
operator|->
name|state
operator|=
name|RMPP_STATE_CANCELING
expr_stmt|;
block|}
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|agent
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|list_for_each_entry
argument_list|(
argument|rmpp_recv
argument_list|,
argument|&agent->rmpp_list
argument_list|,
argument|list
argument_list|)
block|{
name|cancel_delayed_work
argument_list|(
operator|&
name|rmpp_recv
operator|->
name|timeout_work
argument_list|)
expr_stmt|;
name|cancel_delayed_work
argument_list|(
operator|&
name|rmpp_recv
operator|->
name|cleanup_work
argument_list|)
expr_stmt|;
block|}
name|flush_workqueue
argument_list|(
name|agent
operator|->
name|qp_info
operator|->
name|port_priv
operator|->
name|wq
argument_list|)
expr_stmt|;
name|list_for_each_entry_safe
argument_list|(
argument|rmpp_recv
argument_list|,
argument|temp_rmpp_recv
argument_list|,
argument|&agent->rmpp_list
argument_list|,
argument|list
argument_list|)
block|{
name|list_del
argument_list|(
operator|&
name|rmpp_recv
operator|->
name|list
argument_list|)
expr_stmt|;
name|destroy_rmpp_recv
argument_list|(
name|rmpp_recv
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|format_ack
parameter_list|(
name|struct
name|ib_mad_send_buf
modifier|*
name|msg
parameter_list|,
name|struct
name|ib_rmpp_mad
modifier|*
name|data
parameter_list|,
name|struct
name|mad_rmpp_recv
modifier|*
name|rmpp_recv
parameter_list|)
block|{
name|struct
name|ib_rmpp_mad
modifier|*
name|ack
init|=
name|msg
operator|->
name|mad
decl_stmt|;
name|unsigned
name|long
name|flags
decl_stmt|;
name|memcpy
argument_list|(
name|ack
argument_list|,
operator|&
name|data
operator|->
name|mad_hdr
argument_list|,
name|msg
operator|->
name|hdr_len
argument_list|)
expr_stmt|;
name|ack
operator|->
name|mad_hdr
operator|.
name|method
operator|^=
name|IB_MGMT_METHOD_RESP
expr_stmt|;
name|ack
operator|->
name|rmpp_hdr
operator|.
name|rmpp_type
operator|=
name|IB_MGMT_RMPP_TYPE_ACK
expr_stmt|;
name|ib_set_rmpp_flags
argument_list|(
operator|&
name|ack
operator|->
name|rmpp_hdr
argument_list|,
name|IB_MGMT_RMPP_FLAG_ACTIVE
argument_list|)
expr_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|rmpp_recv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|rmpp_recv
operator|->
name|last_ack
operator|=
name|rmpp_recv
operator|->
name|seg_num
expr_stmt|;
name|ack
operator|->
name|rmpp_hdr
operator|.
name|seg_num
operator|=
name|cpu_to_be32
argument_list|(
name|rmpp_recv
operator|->
name|seg_num
argument_list|)
expr_stmt|;
name|ack
operator|->
name|rmpp_hdr
operator|.
name|paylen_newwin
operator|=
name|cpu_to_be32
argument_list|(
name|rmpp_recv
operator|->
name|newwin
argument_list|)
expr_stmt|;
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|rmpp_recv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ack_recv
parameter_list|(
name|struct
name|mad_rmpp_recv
modifier|*
name|rmpp_recv
parameter_list|,
name|struct
name|ib_mad_recv_wc
modifier|*
name|recv_wc
parameter_list|)
block|{
name|struct
name|ib_mad_send_buf
modifier|*
name|msg
decl_stmt|;
name|int
name|ret
decl_stmt|,
name|hdr_len
decl_stmt|;
name|hdr_len
operator|=
name|ib_get_mad_data_offset
argument_list|(
name|recv_wc
operator|->
name|recv_buf
operator|.
name|mad
operator|->
name|mad_hdr
operator|.
name|mgmt_class
argument_list|)
expr_stmt|;
name|msg
operator|=
name|ib_create_send_mad
argument_list|(
operator|&
name|rmpp_recv
operator|->
name|agent
operator|->
name|agent
argument_list|,
name|recv_wc
operator|->
name|wc
operator|->
name|src_qp
argument_list|,
name|recv_wc
operator|->
name|wc
operator|->
name|pkey_index
argument_list|,
literal|1
argument_list|,
name|hdr_len
argument_list|,
literal|0
argument_list|,
name|GFP_KERNEL
argument_list|,
name|IB_MGMT_BASE_VERSION
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|msg
argument_list|)
condition|)
return|return;
name|format_ack
argument_list|(
name|msg
argument_list|,
operator|(
expr|struct
name|ib_rmpp_mad
operator|*
operator|)
name|recv_wc
operator|->
name|recv_buf
operator|.
name|mad
argument_list|,
name|rmpp_recv
argument_list|)
expr_stmt|;
name|msg
operator|->
name|ah
operator|=
name|rmpp_recv
operator|->
name|ah
expr_stmt|;
name|ret
operator|=
name|ib_post_send_mad
argument_list|(
name|msg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|ib_free_send_mad
argument_list|(
name|msg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|ib_mad_send_buf
modifier|*
name|alloc_response_msg
parameter_list|(
name|struct
name|ib_mad_agent
modifier|*
name|agent
parameter_list|,
name|struct
name|ib_mad_recv_wc
modifier|*
name|recv_wc
parameter_list|)
block|{
name|struct
name|ib_mad_send_buf
modifier|*
name|msg
decl_stmt|;
name|struct
name|ib_ah
modifier|*
name|ah
decl_stmt|;
name|int
name|hdr_len
decl_stmt|;
name|ah
operator|=
name|ib_create_ah_from_wc
argument_list|(
name|agent
operator|->
name|qp
operator|->
name|pd
argument_list|,
name|recv_wc
operator|->
name|wc
argument_list|,
name|recv_wc
operator|->
name|recv_buf
operator|.
name|grh
argument_list|,
name|agent
operator|->
name|port_num
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|ah
argument_list|)
condition|)
return|return
operator|(
name|void
operator|*
operator|)
name|ah
return|;
name|hdr_len
operator|=
name|ib_get_mad_data_offset
argument_list|(
name|recv_wc
operator|->
name|recv_buf
operator|.
name|mad
operator|->
name|mad_hdr
operator|.
name|mgmt_class
argument_list|)
expr_stmt|;
name|msg
operator|=
name|ib_create_send_mad
argument_list|(
name|agent
argument_list|,
name|recv_wc
operator|->
name|wc
operator|->
name|src_qp
argument_list|,
name|recv_wc
operator|->
name|wc
operator|->
name|pkey_index
argument_list|,
literal|1
argument_list|,
name|hdr_len
argument_list|,
literal|0
argument_list|,
name|GFP_KERNEL
argument_list|,
name|IB_MGMT_BASE_VERSION
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|msg
argument_list|)
condition|)
name|ib_destroy_ah
argument_list|(
name|ah
argument_list|)
expr_stmt|;
else|else
block|{
name|msg
operator|->
name|ah
operator|=
name|ah
expr_stmt|;
name|msg
operator|->
name|context
index|[
literal|0
index|]
operator|=
name|ah
expr_stmt|;
block|}
return|return
name|msg
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ack_ds_ack
parameter_list|(
name|struct
name|ib_mad_agent_private
modifier|*
name|agent
parameter_list|,
name|struct
name|ib_mad_recv_wc
modifier|*
name|recv_wc
parameter_list|)
block|{
name|struct
name|ib_mad_send_buf
modifier|*
name|msg
decl_stmt|;
name|struct
name|ib_rmpp_mad
modifier|*
name|rmpp_mad
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|msg
operator|=
name|alloc_response_msg
argument_list|(
operator|&
name|agent
operator|->
name|agent
argument_list|,
name|recv_wc
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|msg
argument_list|)
condition|)
return|return;
name|rmpp_mad
operator|=
name|msg
operator|->
name|mad
expr_stmt|;
name|memcpy
argument_list|(
name|rmpp_mad
argument_list|,
name|recv_wc
operator|->
name|recv_buf
operator|.
name|mad
argument_list|,
name|msg
operator|->
name|hdr_len
argument_list|)
expr_stmt|;
name|rmpp_mad
operator|->
name|mad_hdr
operator|.
name|method
operator|^=
name|IB_MGMT_METHOD_RESP
expr_stmt|;
name|ib_set_rmpp_flags
argument_list|(
operator|&
name|rmpp_mad
operator|->
name|rmpp_hdr
argument_list|,
name|IB_MGMT_RMPP_FLAG_ACTIVE
argument_list|)
expr_stmt|;
name|rmpp_mad
operator|->
name|rmpp_hdr
operator|.
name|seg_num
operator|=
literal|0
expr_stmt|;
name|rmpp_mad
operator|->
name|rmpp_hdr
operator|.
name|paylen_newwin
operator|=
name|cpu_to_be32
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ib_post_send_mad
argument_list|(
name|msg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|ib_destroy_ah
argument_list|(
name|msg
operator|->
name|ah
argument_list|)
expr_stmt|;
name|ib_free_send_mad
argument_list|(
name|msg
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|ib_rmpp_send_handler
parameter_list|(
name|struct
name|ib_mad_send_wc
modifier|*
name|mad_send_wc
parameter_list|)
block|{
if|if
condition|(
name|mad_send_wc
operator|->
name|send_buf
operator|->
name|context
index|[
literal|0
index|]
operator|==
name|mad_send_wc
operator|->
name|send_buf
operator|->
name|ah
condition|)
name|ib_destroy_ah
argument_list|(
name|mad_send_wc
operator|->
name|send_buf
operator|->
name|ah
argument_list|)
expr_stmt|;
name|ib_free_send_mad
argument_list|(
name|mad_send_wc
operator|->
name|send_buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|nack_recv
parameter_list|(
name|struct
name|ib_mad_agent_private
modifier|*
name|agent
parameter_list|,
name|struct
name|ib_mad_recv_wc
modifier|*
name|recv_wc
parameter_list|,
name|u8
name|rmpp_status
parameter_list|)
block|{
name|struct
name|ib_mad_send_buf
modifier|*
name|msg
decl_stmt|;
name|struct
name|ib_rmpp_mad
modifier|*
name|rmpp_mad
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|msg
operator|=
name|alloc_response_msg
argument_list|(
operator|&
name|agent
operator|->
name|agent
argument_list|,
name|recv_wc
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|msg
argument_list|)
condition|)
return|return;
name|rmpp_mad
operator|=
name|msg
operator|->
name|mad
expr_stmt|;
name|memcpy
argument_list|(
name|rmpp_mad
argument_list|,
name|recv_wc
operator|->
name|recv_buf
operator|.
name|mad
argument_list|,
name|msg
operator|->
name|hdr_len
argument_list|)
expr_stmt|;
name|rmpp_mad
operator|->
name|mad_hdr
operator|.
name|method
operator|^=
name|IB_MGMT_METHOD_RESP
expr_stmt|;
name|rmpp_mad
operator|->
name|rmpp_hdr
operator|.
name|rmpp_version
operator|=
name|IB_MGMT_RMPP_VERSION
expr_stmt|;
name|rmpp_mad
operator|->
name|rmpp_hdr
operator|.
name|rmpp_type
operator|=
name|IB_MGMT_RMPP_TYPE_ABORT
expr_stmt|;
name|ib_set_rmpp_flags
argument_list|(
operator|&
name|rmpp_mad
operator|->
name|rmpp_hdr
argument_list|,
name|IB_MGMT_RMPP_FLAG_ACTIVE
argument_list|)
expr_stmt|;
name|rmpp_mad
operator|->
name|rmpp_hdr
operator|.
name|rmpp_status
operator|=
name|rmpp_status
expr_stmt|;
name|rmpp_mad
operator|->
name|rmpp_hdr
operator|.
name|seg_num
operator|=
literal|0
expr_stmt|;
name|rmpp_mad
operator|->
name|rmpp_hdr
operator|.
name|paylen_newwin
operator|=
literal|0
expr_stmt|;
name|ret
operator|=
name|ib_post_send_mad
argument_list|(
name|msg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|ib_destroy_ah
argument_list|(
name|msg
operator|->
name|ah
argument_list|)
expr_stmt|;
name|ib_free_send_mad
argument_list|(
name|msg
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|recv_timeout_handler
parameter_list|(
name|struct
name|work_struct
modifier|*
name|work
parameter_list|)
block|{
name|struct
name|mad_rmpp_recv
modifier|*
name|rmpp_recv
init|=
name|container_of
argument_list|(
name|work
argument_list|,
expr|struct
name|mad_rmpp_recv
argument_list|,
name|timeout_work
operator|.
name|work
argument_list|)
decl_stmt|;
name|struct
name|ib_mad_recv_wc
modifier|*
name|rmpp_wc
decl_stmt|;
name|unsigned
name|long
name|flags
decl_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|rmpp_recv
operator|->
name|agent
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|rmpp_recv
operator|->
name|state
operator|!=
name|RMPP_STATE_ACTIVE
condition|)
block|{
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|rmpp_recv
operator|->
name|agent
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
return|return;
block|}
name|rmpp_recv
operator|->
name|state
operator|=
name|RMPP_STATE_TIMEOUT
expr_stmt|;
name|list_del
argument_list|(
operator|&
name|rmpp_recv
operator|->
name|list
argument_list|)
expr_stmt|;
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|rmpp_recv
operator|->
name|agent
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|rmpp_wc
operator|=
name|rmpp_recv
operator|->
name|rmpp_wc
expr_stmt|;
name|nack_recv
argument_list|(
name|rmpp_recv
operator|->
name|agent
argument_list|,
name|rmpp_wc
argument_list|,
name|IB_MGMT_RMPP_STATUS_T2L
argument_list|)
expr_stmt|;
name|destroy_rmpp_recv
argument_list|(
name|rmpp_recv
argument_list|)
expr_stmt|;
name|ib_free_recv_mad
argument_list|(
name|rmpp_wc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|recv_cleanup_handler
parameter_list|(
name|struct
name|work_struct
modifier|*
name|work
parameter_list|)
block|{
name|struct
name|mad_rmpp_recv
modifier|*
name|rmpp_recv
init|=
name|container_of
argument_list|(
name|work
argument_list|,
expr|struct
name|mad_rmpp_recv
argument_list|,
name|cleanup_work
operator|.
name|work
argument_list|)
decl_stmt|;
name|unsigned
name|long
name|flags
decl_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|rmpp_recv
operator|->
name|agent
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|rmpp_recv
operator|->
name|state
operator|==
name|RMPP_STATE_CANCELING
condition|)
block|{
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|rmpp_recv
operator|->
name|agent
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
return|return;
block|}
name|list_del
argument_list|(
operator|&
name|rmpp_recv
operator|->
name|list
argument_list|)
expr_stmt|;
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|rmpp_recv
operator|->
name|agent
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|destroy_rmpp_recv
argument_list|(
name|rmpp_recv
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|mad_rmpp_recv
modifier|*
name|create_rmpp_recv
parameter_list|(
name|struct
name|ib_mad_agent_private
modifier|*
name|agent
parameter_list|,
name|struct
name|ib_mad_recv_wc
modifier|*
name|mad_recv_wc
parameter_list|)
block|{
name|struct
name|mad_rmpp_recv
modifier|*
name|rmpp_recv
decl_stmt|;
name|struct
name|ib_mad_hdr
modifier|*
name|mad_hdr
decl_stmt|;
name|rmpp_recv
operator|=
name|kmalloc
argument_list|(
sizeof|sizeof
expr|*
name|rmpp_recv
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rmpp_recv
condition|)
return|return
name|NULL
return|;
name|rmpp_recv
operator|->
name|ah
operator|=
name|ib_create_ah_from_wc
argument_list|(
name|agent
operator|->
name|agent
operator|.
name|qp
operator|->
name|pd
argument_list|,
name|mad_recv_wc
operator|->
name|wc
argument_list|,
name|mad_recv_wc
operator|->
name|recv_buf
operator|.
name|grh
argument_list|,
name|agent
operator|->
name|agent
operator|.
name|port_num
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|rmpp_recv
operator|->
name|ah
argument_list|)
condition|)
goto|goto
name|error
goto|;
name|rmpp_recv
operator|->
name|agent
operator|=
name|agent
expr_stmt|;
name|init_completion
argument_list|(
operator|&
name|rmpp_recv
operator|->
name|comp
argument_list|)
expr_stmt|;
name|INIT_DELAYED_WORK
argument_list|(
operator|&
name|rmpp_recv
operator|->
name|timeout_work
argument_list|,
name|recv_timeout_handler
argument_list|)
expr_stmt|;
name|INIT_DELAYED_WORK
argument_list|(
operator|&
name|rmpp_recv
operator|->
name|cleanup_work
argument_list|,
name|recv_cleanup_handler
argument_list|)
expr_stmt|;
name|spin_lock_init
argument_list|(
operator|&
name|rmpp_recv
operator|->
name|lock
argument_list|)
expr_stmt|;
name|rmpp_recv
operator|->
name|state
operator|=
name|RMPP_STATE_ACTIVE
expr_stmt|;
name|atomic_set
argument_list|(
operator|&
name|rmpp_recv
operator|->
name|refcount
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|rmpp_recv
operator|->
name|rmpp_wc
operator|=
name|mad_recv_wc
expr_stmt|;
name|rmpp_recv
operator|->
name|cur_seg_buf
operator|=
operator|&
name|mad_recv_wc
operator|->
name|recv_buf
expr_stmt|;
name|rmpp_recv
operator|->
name|newwin
operator|=
literal|1
expr_stmt|;
name|rmpp_recv
operator|->
name|seg_num
operator|=
literal|1
expr_stmt|;
name|rmpp_recv
operator|->
name|last_ack
operator|=
literal|0
expr_stmt|;
name|rmpp_recv
operator|->
name|repwin
operator|=
literal|1
expr_stmt|;
name|mad_hdr
operator|=
operator|&
name|mad_recv_wc
operator|->
name|recv_buf
operator|.
name|mad
operator|->
name|mad_hdr
expr_stmt|;
name|rmpp_recv
operator|->
name|tid
operator|=
name|mad_hdr
operator|->
name|tid
expr_stmt|;
name|rmpp_recv
operator|->
name|src_qp
operator|=
name|mad_recv_wc
operator|->
name|wc
operator|->
name|src_qp
expr_stmt|;
name|rmpp_recv
operator|->
name|slid
operator|=
name|mad_recv_wc
operator|->
name|wc
operator|->
name|slid
expr_stmt|;
name|rmpp_recv
operator|->
name|mgmt_class
operator|=
name|mad_hdr
operator|->
name|mgmt_class
expr_stmt|;
name|rmpp_recv
operator|->
name|class_version
operator|=
name|mad_hdr
operator|->
name|class_version
expr_stmt|;
name|rmpp_recv
operator|->
name|method
operator|=
name|mad_hdr
operator|->
name|method
expr_stmt|;
name|rmpp_recv
operator|->
name|base_version
operator|=
name|mad_hdr
operator|->
name|base_version
expr_stmt|;
return|return
name|rmpp_recv
return|;
name|error
label|:
name|kfree
argument_list|(
name|rmpp_recv
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|mad_rmpp_recv
modifier|*
name|find_rmpp_recv
parameter_list|(
name|struct
name|ib_mad_agent_private
modifier|*
name|agent
parameter_list|,
name|struct
name|ib_mad_recv_wc
modifier|*
name|mad_recv_wc
parameter_list|)
block|{
name|struct
name|mad_rmpp_recv
modifier|*
name|rmpp_recv
decl_stmt|;
name|struct
name|ib_mad_hdr
modifier|*
name|mad_hdr
init|=
operator|&
name|mad_recv_wc
operator|->
name|recv_buf
operator|.
name|mad
operator|->
name|mad_hdr
decl_stmt|;
name|list_for_each_entry
argument_list|(
argument|rmpp_recv
argument_list|,
argument|&agent->rmpp_list
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|rmpp_recv
operator|->
name|tid
operator|==
name|mad_hdr
operator|->
name|tid
operator|&&
name|rmpp_recv
operator|->
name|src_qp
operator|==
name|mad_recv_wc
operator|->
name|wc
operator|->
name|src_qp
operator|&&
name|rmpp_recv
operator|->
name|slid
operator|==
name|mad_recv_wc
operator|->
name|wc
operator|->
name|slid
operator|&&
name|rmpp_recv
operator|->
name|mgmt_class
operator|==
name|mad_hdr
operator|->
name|mgmt_class
operator|&&
name|rmpp_recv
operator|->
name|class_version
operator|==
name|mad_hdr
operator|->
name|class_version
operator|&&
name|rmpp_recv
operator|->
name|method
operator|==
name|mad_hdr
operator|->
name|method
condition|)
return|return
name|rmpp_recv
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|mad_rmpp_recv
modifier|*
name|acquire_rmpp_recv
parameter_list|(
name|struct
name|ib_mad_agent_private
modifier|*
name|agent
parameter_list|,
name|struct
name|ib_mad_recv_wc
modifier|*
name|mad_recv_wc
parameter_list|)
block|{
name|struct
name|mad_rmpp_recv
modifier|*
name|rmpp_recv
decl_stmt|;
name|unsigned
name|long
name|flags
decl_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|agent
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|rmpp_recv
operator|=
name|find_rmpp_recv
argument_list|(
name|agent
argument_list|,
name|mad_recv_wc
argument_list|)
expr_stmt|;
if|if
condition|(
name|rmpp_recv
condition|)
name|atomic_inc
argument_list|(
operator|&
name|rmpp_recv
operator|->
name|refcount
argument_list|)
expr_stmt|;
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|agent
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
return|return
name|rmpp_recv
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|mad_rmpp_recv
modifier|*
name|insert_rmpp_recv
parameter_list|(
name|struct
name|ib_mad_agent_private
modifier|*
name|agent
parameter_list|,
name|struct
name|mad_rmpp_recv
modifier|*
name|rmpp_recv
parameter_list|)
block|{
name|struct
name|mad_rmpp_recv
modifier|*
name|cur_rmpp_recv
decl_stmt|;
name|cur_rmpp_recv
operator|=
name|find_rmpp_recv
argument_list|(
name|agent
argument_list|,
name|rmpp_recv
operator|->
name|rmpp_wc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cur_rmpp_recv
condition|)
name|list_add_tail
argument_list|(
operator|&
name|rmpp_recv
operator|->
name|list
argument_list|,
operator|&
name|agent
operator|->
name|rmpp_list
argument_list|)
expr_stmt|;
return|return
name|cur_rmpp_recv
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|int
name|get_last_flag
parameter_list|(
name|struct
name|ib_mad_recv_buf
modifier|*
name|seg
parameter_list|)
block|{
name|struct
name|ib_rmpp_mad
modifier|*
name|rmpp_mad
decl_stmt|;
name|rmpp_mad
operator|=
operator|(
expr|struct
name|ib_rmpp_mad
operator|*
operator|)
name|seg
operator|->
name|mad
expr_stmt|;
return|return
name|ib_get_rmpp_flags
argument_list|(
operator|&
name|rmpp_mad
operator|->
name|rmpp_hdr
argument_list|)
operator|&
name|IB_MGMT_RMPP_FLAG_LAST
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|int
name|get_seg_num
parameter_list|(
name|struct
name|ib_mad_recv_buf
modifier|*
name|seg
parameter_list|)
block|{
name|struct
name|ib_rmpp_mad
modifier|*
name|rmpp_mad
decl_stmt|;
name|rmpp_mad
operator|=
operator|(
expr|struct
name|ib_rmpp_mad
operator|*
operator|)
name|seg
operator|->
name|mad
expr_stmt|;
return|return
name|be32_to_cpu
argument_list|(
name|rmpp_mad
operator|->
name|rmpp_hdr
operator|.
name|seg_num
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|struct
name|ib_mad_recv_buf
modifier|*
name|get_next_seg
parameter_list|(
name|struct
name|list_head
modifier|*
name|rmpp_list
parameter_list|,
name|struct
name|ib_mad_recv_buf
modifier|*
name|seg
parameter_list|)
block|{
if|if
condition|(
name|seg
operator|->
name|list
operator|.
name|next
operator|==
name|rmpp_list
condition|)
return|return
name|NULL
return|;
return|return
name|container_of
argument_list|(
name|seg
operator|->
name|list
operator|.
name|next
argument_list|,
expr|struct
name|ib_mad_recv_buf
argument_list|,
name|list
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|int
name|window_size
parameter_list|(
name|struct
name|ib_mad_agent_private
modifier|*
name|agent
parameter_list|)
block|{
return|return
name|max
argument_list|(
name|agent
operator|->
name|qp_info
operator|->
name|recv_queue
operator|.
name|max_active
operator|>>
literal|3
argument_list|,
literal|1
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|ib_mad_recv_buf
modifier|*
name|find_seg_location
parameter_list|(
name|struct
name|list_head
modifier|*
name|rmpp_list
parameter_list|,
name|int
name|seg_num
parameter_list|)
block|{
name|struct
name|ib_mad_recv_buf
modifier|*
name|seg_buf
decl_stmt|;
name|int
name|cur_seg_num
decl_stmt|;
name|list_for_each_entry_reverse
argument_list|(
argument|seg_buf
argument_list|,
argument|rmpp_list
argument_list|,
argument|list
argument_list|)
block|{
name|cur_seg_num
operator|=
name|get_seg_num
argument_list|(
name|seg_buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|seg_num
operator|>
name|cur_seg_num
condition|)
return|return
name|seg_buf
return|;
if|if
condition|(
name|seg_num
operator|==
name|cur_seg_num
condition|)
break|break;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|update_seg_num
parameter_list|(
name|struct
name|mad_rmpp_recv
modifier|*
name|rmpp_recv
parameter_list|,
name|struct
name|ib_mad_recv_buf
modifier|*
name|new_buf
parameter_list|)
block|{
name|struct
name|list_head
modifier|*
name|rmpp_list
init|=
operator|&
name|rmpp_recv
operator|->
name|rmpp_wc
operator|->
name|rmpp_list
decl_stmt|;
while|while
condition|(
name|new_buf
operator|&&
operator|(
name|get_seg_num
argument_list|(
name|new_buf
argument_list|)
operator|==
name|rmpp_recv
operator|->
name|seg_num
operator|+
literal|1
operator|)
condition|)
block|{
name|rmpp_recv
operator|->
name|cur_seg_buf
operator|=
name|new_buf
expr_stmt|;
name|rmpp_recv
operator|->
name|seg_num
operator|++
expr_stmt|;
name|new_buf
operator|=
name|get_next_seg
argument_list|(
name|rmpp_list
argument_list|,
name|new_buf
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
specifier|inline
name|int
name|get_mad_len
parameter_list|(
name|struct
name|mad_rmpp_recv
modifier|*
name|rmpp_recv
parameter_list|)
block|{
name|struct
name|ib_rmpp_mad
modifier|*
name|rmpp_mad
decl_stmt|;
name|int
name|hdr_size
decl_stmt|,
name|data_size
decl_stmt|,
name|pad
decl_stmt|;
name|bool
name|opa
init|=
name|rdma_cap_opa_mad
argument_list|(
name|rmpp_recv
operator|->
name|agent
operator|->
name|qp_info
operator|->
name|port_priv
operator|->
name|device
argument_list|,
name|rmpp_recv
operator|->
name|agent
operator|->
name|qp_info
operator|->
name|port_priv
operator|->
name|port_num
argument_list|)
decl_stmt|;
name|rmpp_mad
operator|=
operator|(
expr|struct
name|ib_rmpp_mad
operator|*
operator|)
name|rmpp_recv
operator|->
name|cur_seg_buf
operator|->
name|mad
expr_stmt|;
name|hdr_size
operator|=
name|ib_get_mad_data_offset
argument_list|(
name|rmpp_mad
operator|->
name|mad_hdr
operator|.
name|mgmt_class
argument_list|)
expr_stmt|;
if|if
condition|(
name|opa
operator|&&
name|rmpp_recv
operator|->
name|base_version
operator|==
name|OPA_MGMT_BASE_VERSION
condition|)
block|{
name|data_size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|opa_rmpp_mad
argument_list|)
operator|-
name|hdr_size
expr_stmt|;
name|pad
operator|=
name|OPA_MGMT_RMPP_DATA
operator|-
name|be32_to_cpu
argument_list|(
name|rmpp_mad
operator|->
name|rmpp_hdr
operator|.
name|paylen_newwin
argument_list|)
expr_stmt|;
if|if
condition|(
name|pad
operator|>
name|OPA_MGMT_RMPP_DATA
operator|||
name|pad
operator|<
literal|0
condition|)
name|pad
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|data_size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ib_rmpp_mad
argument_list|)
operator|-
name|hdr_size
expr_stmt|;
name|pad
operator|=
name|IB_MGMT_RMPP_DATA
operator|-
name|be32_to_cpu
argument_list|(
name|rmpp_mad
operator|->
name|rmpp_hdr
operator|.
name|paylen_newwin
argument_list|)
expr_stmt|;
if|if
condition|(
name|pad
operator|>
name|IB_MGMT_RMPP_DATA
operator|||
name|pad
operator|<
literal|0
condition|)
name|pad
operator|=
literal|0
expr_stmt|;
block|}
return|return
name|hdr_size
operator|+
name|rmpp_recv
operator|->
name|seg_num
operator|*
name|data_size
operator|-
name|pad
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|ib_mad_recv_wc
modifier|*
name|complete_rmpp
parameter_list|(
name|struct
name|mad_rmpp_recv
modifier|*
name|rmpp_recv
parameter_list|)
block|{
name|struct
name|ib_mad_recv_wc
modifier|*
name|rmpp_wc
decl_stmt|;
name|ack_recv
argument_list|(
name|rmpp_recv
argument_list|,
name|rmpp_recv
operator|->
name|rmpp_wc
argument_list|)
expr_stmt|;
if|if
condition|(
name|rmpp_recv
operator|->
name|seg_num
operator|>
literal|1
condition|)
name|cancel_delayed_work
argument_list|(
operator|&
name|rmpp_recv
operator|->
name|timeout_work
argument_list|)
expr_stmt|;
name|rmpp_wc
operator|=
name|rmpp_recv
operator|->
name|rmpp_wc
expr_stmt|;
name|rmpp_wc
operator|->
name|mad_len
operator|=
name|get_mad_len
argument_list|(
name|rmpp_recv
argument_list|)
expr_stmt|;
comment|/* 10 seconds until we can find the packet lifetime */
name|queue_delayed_work
argument_list|(
name|rmpp_recv
operator|->
name|agent
operator|->
name|qp_info
operator|->
name|port_priv
operator|->
name|wq
argument_list|,
operator|&
name|rmpp_recv
operator|->
name|cleanup_work
argument_list|,
name|msecs_to_jiffies
argument_list|(
literal|10000
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|rmpp_wc
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|ib_mad_recv_wc
modifier|*
name|continue_rmpp
parameter_list|(
name|struct
name|ib_mad_agent_private
modifier|*
name|agent
parameter_list|,
name|struct
name|ib_mad_recv_wc
modifier|*
name|mad_recv_wc
parameter_list|)
block|{
name|struct
name|mad_rmpp_recv
modifier|*
name|rmpp_recv
decl_stmt|;
name|struct
name|ib_mad_recv_buf
modifier|*
name|prev_buf
decl_stmt|;
name|struct
name|ib_mad_recv_wc
modifier|*
name|done_wc
decl_stmt|;
name|int
name|seg_num
decl_stmt|;
name|unsigned
name|long
name|flags
decl_stmt|;
name|rmpp_recv
operator|=
name|acquire_rmpp_recv
argument_list|(
name|agent
argument_list|,
name|mad_recv_wc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rmpp_recv
condition|)
goto|goto
name|drop1
goto|;
name|seg_num
operator|=
name|get_seg_num
argument_list|(
operator|&
name|mad_recv_wc
operator|->
name|recv_buf
argument_list|)
expr_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|rmpp_recv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rmpp_recv
operator|->
name|state
operator|==
name|RMPP_STATE_TIMEOUT
operator|)
operator|||
operator|(
name|seg_num
operator|>
name|rmpp_recv
operator|->
name|newwin
operator|)
condition|)
goto|goto
name|drop3
goto|;
if|if
condition|(
operator|(
name|seg_num
operator|<=
name|rmpp_recv
operator|->
name|last_ack
operator|)
operator|||
operator|(
name|rmpp_recv
operator|->
name|state
operator|==
name|RMPP_STATE_COMPLETE
operator|)
condition|)
block|{
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|rmpp_recv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|ack_recv
argument_list|(
name|rmpp_recv
argument_list|,
name|mad_recv_wc
argument_list|)
expr_stmt|;
goto|goto
name|drop2
goto|;
block|}
name|prev_buf
operator|=
name|find_seg_location
argument_list|(
operator|&
name|rmpp_recv
operator|->
name|rmpp_wc
operator|->
name|rmpp_list
argument_list|,
name|seg_num
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|prev_buf
condition|)
goto|goto
name|drop3
goto|;
name|done_wc
operator|=
name|NULL
expr_stmt|;
name|list_add
argument_list|(
operator|&
name|mad_recv_wc
operator|->
name|recv_buf
operator|.
name|list
argument_list|,
operator|&
name|prev_buf
operator|->
name|list
argument_list|)
expr_stmt|;
if|if
condition|(
name|rmpp_recv
operator|->
name|cur_seg_buf
operator|==
name|prev_buf
condition|)
block|{
name|update_seg_num
argument_list|(
name|rmpp_recv
argument_list|,
operator|&
name|mad_recv_wc
operator|->
name|recv_buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|get_last_flag
argument_list|(
name|rmpp_recv
operator|->
name|cur_seg_buf
argument_list|)
condition|)
block|{
name|rmpp_recv
operator|->
name|state
operator|=
name|RMPP_STATE_COMPLETE
expr_stmt|;
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|rmpp_recv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|done_wc
operator|=
name|complete_rmpp
argument_list|(
name|rmpp_recv
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
elseif|else
if|if
condition|(
name|rmpp_recv
operator|->
name|seg_num
operator|==
name|rmpp_recv
operator|->
name|newwin
condition|)
block|{
name|rmpp_recv
operator|->
name|newwin
operator|+=
name|window_size
argument_list|(
name|agent
argument_list|)
expr_stmt|;
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|rmpp_recv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|ack_recv
argument_list|(
name|rmpp_recv
argument_list|,
name|mad_recv_wc
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|rmpp_recv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|out
label|:
name|deref_rmpp_recv
argument_list|(
name|rmpp_recv
argument_list|)
expr_stmt|;
return|return
name|done_wc
return|;
name|drop3
label|:
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|rmpp_recv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|drop2
label|:
name|deref_rmpp_recv
argument_list|(
name|rmpp_recv
argument_list|)
expr_stmt|;
name|drop1
label|:
name|ib_free_recv_mad
argument_list|(
name|mad_recv_wc
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|ib_mad_recv_wc
modifier|*
name|start_rmpp
parameter_list|(
name|struct
name|ib_mad_agent_private
modifier|*
name|agent
parameter_list|,
name|struct
name|ib_mad_recv_wc
modifier|*
name|mad_recv_wc
parameter_list|)
block|{
name|struct
name|mad_rmpp_recv
modifier|*
name|rmpp_recv
decl_stmt|;
name|unsigned
name|long
name|flags
decl_stmt|;
name|rmpp_recv
operator|=
name|create_rmpp_recv
argument_list|(
name|agent
argument_list|,
name|mad_recv_wc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rmpp_recv
condition|)
block|{
name|ib_free_recv_mad
argument_list|(
name|mad_recv_wc
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|spin_lock_irqsave
argument_list|(
operator|&
name|agent
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|insert_rmpp_recv
argument_list|(
name|agent
argument_list|,
name|rmpp_recv
argument_list|)
condition|)
block|{
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|agent
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
comment|/* duplicate first MAD */
name|destroy_rmpp_recv
argument_list|(
name|rmpp_recv
argument_list|)
expr_stmt|;
return|return
name|continue_rmpp
argument_list|(
name|agent
argument_list|,
name|mad_recv_wc
argument_list|)
return|;
block|}
name|atomic_inc
argument_list|(
operator|&
name|rmpp_recv
operator|->
name|refcount
argument_list|)
expr_stmt|;
if|if
condition|(
name|get_last_flag
argument_list|(
operator|&
name|mad_recv_wc
operator|->
name|recv_buf
argument_list|)
condition|)
block|{
name|rmpp_recv
operator|->
name|state
operator|=
name|RMPP_STATE_COMPLETE
expr_stmt|;
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|agent
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|complete_rmpp
argument_list|(
name|rmpp_recv
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|agent
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
comment|/* 40 seconds until we can find the packet lifetimes */
name|queue_delayed_work
argument_list|(
name|agent
operator|->
name|qp_info
operator|->
name|port_priv
operator|->
name|wq
argument_list|,
operator|&
name|rmpp_recv
operator|->
name|timeout_work
argument_list|,
name|msecs_to_jiffies
argument_list|(
literal|40000
argument_list|)
argument_list|)
expr_stmt|;
name|rmpp_recv
operator|->
name|newwin
operator|+=
name|window_size
argument_list|(
name|agent
argument_list|)
expr_stmt|;
name|ack_recv
argument_list|(
name|rmpp_recv
argument_list|,
name|mad_recv_wc
argument_list|)
expr_stmt|;
name|mad_recv_wc
operator|=
name|NULL
expr_stmt|;
block|}
name|deref_rmpp_recv
argument_list|(
name|rmpp_recv
argument_list|)
expr_stmt|;
return|return
name|mad_recv_wc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|send_next_seg
parameter_list|(
name|struct
name|ib_mad_send_wr_private
modifier|*
name|mad_send_wr
parameter_list|)
block|{
name|struct
name|ib_rmpp_mad
modifier|*
name|rmpp_mad
decl_stmt|;
name|int
name|timeout
decl_stmt|;
name|u32
name|paylen
init|=
literal|0
decl_stmt|;
name|rmpp_mad
operator|=
name|mad_send_wr
operator|->
name|send_buf
operator|.
name|mad
expr_stmt|;
name|ib_set_rmpp_flags
argument_list|(
operator|&
name|rmpp_mad
operator|->
name|rmpp_hdr
argument_list|,
name|IB_MGMT_RMPP_FLAG_ACTIVE
argument_list|)
expr_stmt|;
name|rmpp_mad
operator|->
name|rmpp_hdr
operator|.
name|seg_num
operator|=
name|cpu_to_be32
argument_list|(
operator|++
name|mad_send_wr
operator|->
name|seg_num
argument_list|)
expr_stmt|;
if|if
condition|(
name|mad_send_wr
operator|->
name|seg_num
operator|==
literal|1
condition|)
block|{
name|rmpp_mad
operator|->
name|rmpp_hdr
operator|.
name|rmpp_rtime_flags
operator||=
name|IB_MGMT_RMPP_FLAG_FIRST
expr_stmt|;
name|paylen
operator|=
operator|(
name|mad_send_wr
operator|->
name|send_buf
operator|.
name|seg_count
operator|*
name|mad_send_wr
operator|->
name|send_buf
operator|.
name|seg_rmpp_size
operator|)
operator|-
name|mad_send_wr
operator|->
name|pad
expr_stmt|;
block|}
if|if
condition|(
name|mad_send_wr
operator|->
name|seg_num
operator|==
name|mad_send_wr
operator|->
name|send_buf
operator|.
name|seg_count
condition|)
block|{
name|rmpp_mad
operator|->
name|rmpp_hdr
operator|.
name|rmpp_rtime_flags
operator||=
name|IB_MGMT_RMPP_FLAG_LAST
expr_stmt|;
name|paylen
operator|=
name|mad_send_wr
operator|->
name|send_buf
operator|.
name|seg_rmpp_size
operator|-
name|mad_send_wr
operator|->
name|pad
expr_stmt|;
block|}
name|rmpp_mad
operator|->
name|rmpp_hdr
operator|.
name|paylen_newwin
operator|=
name|cpu_to_be32
argument_list|(
name|paylen
argument_list|)
expr_stmt|;
comment|/* 2 seconds for an ACK until we can find the packet lifetime */
name|timeout
operator|=
name|mad_send_wr
operator|->
name|send_buf
operator|.
name|timeout_ms
expr_stmt|;
if|if
condition|(
operator|!
name|timeout
operator|||
name|timeout
operator|>
literal|2000
condition|)
name|mad_send_wr
operator|->
name|timeout
operator|=
name|msecs_to_jiffies
argument_list|(
literal|2000
argument_list|)
expr_stmt|;
return|return
name|ib_send_mad
argument_list|(
name|mad_send_wr
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|abort_send
parameter_list|(
name|struct
name|ib_mad_agent_private
modifier|*
name|agent
parameter_list|,
name|struct
name|ib_mad_recv_wc
modifier|*
name|mad_recv_wc
parameter_list|,
name|u8
name|rmpp_status
parameter_list|)
block|{
name|struct
name|ib_mad_send_wr_private
modifier|*
name|mad_send_wr
decl_stmt|;
name|struct
name|ib_mad_send_wc
name|wc
decl_stmt|;
name|unsigned
name|long
name|flags
decl_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|agent
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|mad_send_wr
operator|=
name|ib_find_send_mad
argument_list|(
name|agent
argument_list|,
name|mad_recv_wc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mad_send_wr
condition|)
goto|goto
name|out
goto|;
comment|/* Unmatched send */
if|if
condition|(
operator|(
name|mad_send_wr
operator|->
name|last_ack
operator|==
name|mad_send_wr
operator|->
name|send_buf
operator|.
name|seg_count
operator|)
operator|||
operator|(
operator|!
name|mad_send_wr
operator|->
name|timeout
operator|)
operator|||
operator|(
name|mad_send_wr
operator|->
name|status
operator|!=
name|IB_WC_SUCCESS
operator|)
condition|)
goto|goto
name|out
goto|;
comment|/* Send is already done */
name|ib_mark_mad_done
argument_list|(
name|mad_send_wr
argument_list|)
expr_stmt|;
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|agent
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|wc
operator|.
name|status
operator|=
name|IB_WC_REM_ABORT_ERR
expr_stmt|;
name|wc
operator|.
name|vendor_err
operator|=
name|rmpp_status
expr_stmt|;
name|wc
operator|.
name|send_buf
operator|=
operator|&
name|mad_send_wr
operator|->
name|send_buf
expr_stmt|;
name|ib_mad_complete_send_wr
argument_list|(
name|mad_send_wr
argument_list|,
operator|&
name|wc
argument_list|)
expr_stmt|;
return|return;
name|out
label|:
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|agent
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|adjust_last_ack
parameter_list|(
name|struct
name|ib_mad_send_wr_private
modifier|*
name|wr
parameter_list|,
name|int
name|seg_num
parameter_list|)
block|{
name|struct
name|list_head
modifier|*
name|list
decl_stmt|;
name|wr
operator|->
name|last_ack
operator|=
name|seg_num
expr_stmt|;
name|list
operator|=
operator|&
name|wr
operator|->
name|last_ack_seg
operator|->
name|list
expr_stmt|;
name|list_for_each_entry
argument_list|(
argument|wr->last_ack_seg
argument_list|,
argument|list
argument_list|,
argument|list
argument_list|)
if|if
condition|(
name|wr
operator|->
name|last_ack_seg
operator|->
name|num
operator|==
name|seg_num
condition|)
break|break;
block|}
end_function

begin_function
specifier|static
name|void
name|process_ds_ack
parameter_list|(
name|struct
name|ib_mad_agent_private
modifier|*
name|agent
parameter_list|,
name|struct
name|ib_mad_recv_wc
modifier|*
name|mad_recv_wc
parameter_list|,
name|int
name|newwin
parameter_list|)
block|{
name|struct
name|mad_rmpp_recv
modifier|*
name|rmpp_recv
decl_stmt|;
name|rmpp_recv
operator|=
name|find_rmpp_recv
argument_list|(
name|agent
argument_list|,
name|mad_recv_wc
argument_list|)
expr_stmt|;
if|if
condition|(
name|rmpp_recv
operator|&&
name|rmpp_recv
operator|->
name|state
operator|==
name|RMPP_STATE_COMPLETE
condition|)
name|rmpp_recv
operator|->
name|repwin
operator|=
name|newwin
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|process_rmpp_ack
parameter_list|(
name|struct
name|ib_mad_agent_private
modifier|*
name|agent
parameter_list|,
name|struct
name|ib_mad_recv_wc
modifier|*
name|mad_recv_wc
parameter_list|)
block|{
name|struct
name|ib_mad_send_wr_private
modifier|*
name|mad_send_wr
decl_stmt|;
name|struct
name|ib_rmpp_mad
modifier|*
name|rmpp_mad
decl_stmt|;
name|unsigned
name|long
name|flags
decl_stmt|;
name|int
name|seg_num
decl_stmt|,
name|newwin
decl_stmt|,
name|ret
decl_stmt|;
name|rmpp_mad
operator|=
operator|(
expr|struct
name|ib_rmpp_mad
operator|*
operator|)
name|mad_recv_wc
operator|->
name|recv_buf
operator|.
name|mad
expr_stmt|;
if|if
condition|(
name|rmpp_mad
operator|->
name|rmpp_hdr
operator|.
name|rmpp_status
condition|)
block|{
name|abort_send
argument_list|(
name|agent
argument_list|,
name|mad_recv_wc
argument_list|,
name|IB_MGMT_RMPP_STATUS_BAD_STATUS
argument_list|)
expr_stmt|;
name|nack_recv
argument_list|(
name|agent
argument_list|,
name|mad_recv_wc
argument_list|,
name|IB_MGMT_RMPP_STATUS_BAD_STATUS
argument_list|)
expr_stmt|;
return|return;
block|}
name|seg_num
operator|=
name|be32_to_cpu
argument_list|(
name|rmpp_mad
operator|->
name|rmpp_hdr
operator|.
name|seg_num
argument_list|)
expr_stmt|;
name|newwin
operator|=
name|be32_to_cpu
argument_list|(
name|rmpp_mad
operator|->
name|rmpp_hdr
operator|.
name|paylen_newwin
argument_list|)
expr_stmt|;
if|if
condition|(
name|newwin
operator|<
name|seg_num
condition|)
block|{
name|abort_send
argument_list|(
name|agent
argument_list|,
name|mad_recv_wc
argument_list|,
name|IB_MGMT_RMPP_STATUS_W2S
argument_list|)
expr_stmt|;
name|nack_recv
argument_list|(
name|agent
argument_list|,
name|mad_recv_wc
argument_list|,
name|IB_MGMT_RMPP_STATUS_W2S
argument_list|)
expr_stmt|;
return|return;
block|}
name|spin_lock_irqsave
argument_list|(
operator|&
name|agent
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|mad_send_wr
operator|=
name|ib_find_send_mad
argument_list|(
name|agent
argument_list|,
name|mad_recv_wc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mad_send_wr
condition|)
block|{
if|if
condition|(
operator|!
name|seg_num
condition|)
name|process_ds_ack
argument_list|(
name|agent
argument_list|,
name|mad_recv_wc
argument_list|,
name|newwin
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
comment|/* Unmatched or DS RMPP ACK */
block|}
if|if
condition|(
operator|(
name|mad_send_wr
operator|->
name|last_ack
operator|==
name|mad_send_wr
operator|->
name|send_buf
operator|.
name|seg_count
operator|)
operator|&&
operator|(
name|mad_send_wr
operator|->
name|timeout
operator|)
condition|)
block|{
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|agent
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|ack_ds_ack
argument_list|(
name|agent
argument_list|,
name|mad_recv_wc
argument_list|)
expr_stmt|;
return|return;
comment|/* Repeated ACK for DS RMPP transaction */
block|}
if|if
condition|(
operator|(
name|mad_send_wr
operator|->
name|last_ack
operator|==
name|mad_send_wr
operator|->
name|send_buf
operator|.
name|seg_count
operator|)
operator|||
operator|(
operator|!
name|mad_send_wr
operator|->
name|timeout
operator|)
operator|||
operator|(
name|mad_send_wr
operator|->
name|status
operator|!=
name|IB_WC_SUCCESS
operator|)
condition|)
goto|goto
name|out
goto|;
comment|/* Send is already done */
if|if
condition|(
name|seg_num
operator|>
name|mad_send_wr
operator|->
name|send_buf
operator|.
name|seg_count
operator|||
name|seg_num
operator|>
name|mad_send_wr
operator|->
name|newwin
condition|)
block|{
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|agent
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|abort_send
argument_list|(
name|agent
argument_list|,
name|mad_recv_wc
argument_list|,
name|IB_MGMT_RMPP_STATUS_S2B
argument_list|)
expr_stmt|;
name|nack_recv
argument_list|(
name|agent
argument_list|,
name|mad_recv_wc
argument_list|,
name|IB_MGMT_RMPP_STATUS_S2B
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|newwin
operator|<
name|mad_send_wr
operator|->
name|newwin
operator|||
name|seg_num
operator|<
name|mad_send_wr
operator|->
name|last_ack
condition|)
goto|goto
name|out
goto|;
comment|/* Old ACK */
if|if
condition|(
name|seg_num
operator|>
name|mad_send_wr
operator|->
name|last_ack
condition|)
block|{
name|adjust_last_ack
argument_list|(
name|mad_send_wr
argument_list|,
name|seg_num
argument_list|)
expr_stmt|;
name|mad_send_wr
operator|->
name|retries_left
operator|=
name|mad_send_wr
operator|->
name|max_retries
expr_stmt|;
block|}
name|mad_send_wr
operator|->
name|newwin
operator|=
name|newwin
expr_stmt|;
if|if
condition|(
name|mad_send_wr
operator|->
name|last_ack
operator|==
name|mad_send_wr
operator|->
name|send_buf
operator|.
name|seg_count
condition|)
block|{
comment|/* If no response is expected, the ACK completes the send */
if|if
condition|(
operator|!
name|mad_send_wr
operator|->
name|send_buf
operator|.
name|timeout_ms
condition|)
block|{
name|struct
name|ib_mad_send_wc
name|wc
decl_stmt|;
name|ib_mark_mad_done
argument_list|(
name|mad_send_wr
argument_list|)
expr_stmt|;
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|agent
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|wc
operator|.
name|status
operator|=
name|IB_WC_SUCCESS
expr_stmt|;
name|wc
operator|.
name|vendor_err
operator|=
literal|0
expr_stmt|;
name|wc
operator|.
name|send_buf
operator|=
operator|&
name|mad_send_wr
operator|->
name|send_buf
expr_stmt|;
name|ib_mad_complete_send_wr
argument_list|(
name|mad_send_wr
argument_list|,
operator|&
name|wc
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|mad_send_wr
operator|->
name|refcount
operator|==
literal|1
condition|)
name|ib_reset_mad_timeout
argument_list|(
name|mad_send_wr
argument_list|,
name|mad_send_wr
operator|->
name|send_buf
operator|.
name|timeout_ms
argument_list|)
expr_stmt|;
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|agent
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|ack_ds_ack
argument_list|(
name|agent
argument_list|,
name|mad_recv_wc
argument_list|)
expr_stmt|;
return|return;
block|}
elseif|else
if|if
condition|(
name|mad_send_wr
operator|->
name|refcount
operator|==
literal|1
operator|&&
name|mad_send_wr
operator|->
name|seg_num
operator|<
name|mad_send_wr
operator|->
name|newwin
operator|&&
name|mad_send_wr
operator|->
name|seg_num
operator|<
name|mad_send_wr
operator|->
name|send_buf
operator|.
name|seg_count
condition|)
block|{
comment|/* Send failure will just result in a timeout/retry */
name|ret
operator|=
name|send_next_seg
argument_list|(
name|mad_send_wr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|mad_send_wr
operator|->
name|refcount
operator|++
expr_stmt|;
name|list_move_tail
argument_list|(
operator|&
name|mad_send_wr
operator|->
name|agent_list
argument_list|,
operator|&
name|mad_send_wr
operator|->
name|mad_agent_priv
operator|->
name|send_list
argument_list|)
expr_stmt|;
block|}
name|out
label|:
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|agent
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|ib_mad_recv_wc
modifier|*
name|process_rmpp_data
parameter_list|(
name|struct
name|ib_mad_agent_private
modifier|*
name|agent
parameter_list|,
name|struct
name|ib_mad_recv_wc
modifier|*
name|mad_recv_wc
parameter_list|)
block|{
name|struct
name|ib_rmpp_hdr
modifier|*
name|rmpp_hdr
decl_stmt|;
name|u8
name|rmpp_status
decl_stmt|;
name|rmpp_hdr
operator|=
operator|&
operator|(
operator|(
expr|struct
name|ib_rmpp_mad
operator|*
operator|)
name|mad_recv_wc
operator|->
name|recv_buf
operator|.
name|mad
operator|)
operator|->
name|rmpp_hdr
expr_stmt|;
if|if
condition|(
name|rmpp_hdr
operator|->
name|rmpp_status
condition|)
block|{
name|rmpp_status
operator|=
name|IB_MGMT_RMPP_STATUS_BAD_STATUS
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
if|if
condition|(
name|rmpp_hdr
operator|->
name|seg_num
operator|==
name|cpu_to_be32
argument_list|(
literal|1
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|ib_get_rmpp_flags
argument_list|(
name|rmpp_hdr
argument_list|)
operator|&
name|IB_MGMT_RMPP_FLAG_FIRST
operator|)
condition|)
block|{
name|rmpp_status
operator|=
name|IB_MGMT_RMPP_STATUS_BAD_SEG
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
return|return
name|start_rmpp
argument_list|(
name|agent
argument_list|,
name|mad_recv_wc
argument_list|)
return|;
block|}
else|else
block|{
if|if
condition|(
name|ib_get_rmpp_flags
argument_list|(
name|rmpp_hdr
argument_list|)
operator|&
name|IB_MGMT_RMPP_FLAG_FIRST
condition|)
block|{
name|rmpp_status
operator|=
name|IB_MGMT_RMPP_STATUS_BAD_SEG
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
return|return
name|continue_rmpp
argument_list|(
name|agent
argument_list|,
name|mad_recv_wc
argument_list|)
return|;
block|}
name|bad
label|:
name|nack_recv
argument_list|(
name|agent
argument_list|,
name|mad_recv_wc
argument_list|,
name|rmpp_status
argument_list|)
expr_stmt|;
name|ib_free_recv_mad
argument_list|(
name|mad_recv_wc
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|process_rmpp_stop
parameter_list|(
name|struct
name|ib_mad_agent_private
modifier|*
name|agent
parameter_list|,
name|struct
name|ib_mad_recv_wc
modifier|*
name|mad_recv_wc
parameter_list|)
block|{
name|struct
name|ib_rmpp_mad
modifier|*
name|rmpp_mad
decl_stmt|;
name|rmpp_mad
operator|=
operator|(
expr|struct
name|ib_rmpp_mad
operator|*
operator|)
name|mad_recv_wc
operator|->
name|recv_buf
operator|.
name|mad
expr_stmt|;
if|if
condition|(
name|rmpp_mad
operator|->
name|rmpp_hdr
operator|.
name|rmpp_status
operator|!=
name|IB_MGMT_RMPP_STATUS_RESX
condition|)
block|{
name|abort_send
argument_list|(
name|agent
argument_list|,
name|mad_recv_wc
argument_list|,
name|IB_MGMT_RMPP_STATUS_BAD_STATUS
argument_list|)
expr_stmt|;
name|nack_recv
argument_list|(
name|agent
argument_list|,
name|mad_recv_wc
argument_list|,
name|IB_MGMT_RMPP_STATUS_BAD_STATUS
argument_list|)
expr_stmt|;
block|}
else|else
name|abort_send
argument_list|(
name|agent
argument_list|,
name|mad_recv_wc
argument_list|,
name|rmpp_mad
operator|->
name|rmpp_hdr
operator|.
name|rmpp_status
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|process_rmpp_abort
parameter_list|(
name|struct
name|ib_mad_agent_private
modifier|*
name|agent
parameter_list|,
name|struct
name|ib_mad_recv_wc
modifier|*
name|mad_recv_wc
parameter_list|)
block|{
name|struct
name|ib_rmpp_mad
modifier|*
name|rmpp_mad
decl_stmt|;
name|rmpp_mad
operator|=
operator|(
expr|struct
name|ib_rmpp_mad
operator|*
operator|)
name|mad_recv_wc
operator|->
name|recv_buf
operator|.
name|mad
expr_stmt|;
if|if
condition|(
name|rmpp_mad
operator|->
name|rmpp_hdr
operator|.
name|rmpp_status
operator|<
name|IB_MGMT_RMPP_STATUS_ABORT_MIN
operator|||
name|rmpp_mad
operator|->
name|rmpp_hdr
operator|.
name|rmpp_status
operator|>
name|IB_MGMT_RMPP_STATUS_ABORT_MAX
condition|)
block|{
name|abort_send
argument_list|(
name|agent
argument_list|,
name|mad_recv_wc
argument_list|,
name|IB_MGMT_RMPP_STATUS_BAD_STATUS
argument_list|)
expr_stmt|;
name|nack_recv
argument_list|(
name|agent
argument_list|,
name|mad_recv_wc
argument_list|,
name|IB_MGMT_RMPP_STATUS_BAD_STATUS
argument_list|)
expr_stmt|;
block|}
else|else
name|abort_send
argument_list|(
name|agent
argument_list|,
name|mad_recv_wc
argument_list|,
name|rmpp_mad
operator|->
name|rmpp_hdr
operator|.
name|rmpp_status
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|struct
name|ib_mad_recv_wc
modifier|*
name|ib_process_rmpp_recv_wc
parameter_list|(
name|struct
name|ib_mad_agent_private
modifier|*
name|agent
parameter_list|,
name|struct
name|ib_mad_recv_wc
modifier|*
name|mad_recv_wc
parameter_list|)
block|{
name|struct
name|ib_rmpp_mad
modifier|*
name|rmpp_mad
decl_stmt|;
name|rmpp_mad
operator|=
operator|(
expr|struct
name|ib_rmpp_mad
operator|*
operator|)
name|mad_recv_wc
operator|->
name|recv_buf
operator|.
name|mad
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|rmpp_mad
operator|->
name|rmpp_hdr
operator|.
name|rmpp_rtime_flags
operator|&
name|IB_MGMT_RMPP_FLAG_ACTIVE
operator|)
condition|)
return|return
name|mad_recv_wc
return|;
if|if
condition|(
name|rmpp_mad
operator|->
name|rmpp_hdr
operator|.
name|rmpp_version
operator|!=
name|IB_MGMT_RMPP_VERSION
condition|)
block|{
name|abort_send
argument_list|(
name|agent
argument_list|,
name|mad_recv_wc
argument_list|,
name|IB_MGMT_RMPP_STATUS_UNV
argument_list|)
expr_stmt|;
name|nack_recv
argument_list|(
name|agent
argument_list|,
name|mad_recv_wc
argument_list|,
name|IB_MGMT_RMPP_STATUS_UNV
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
switch|switch
condition|(
name|rmpp_mad
operator|->
name|rmpp_hdr
operator|.
name|rmpp_type
condition|)
block|{
case|case
name|IB_MGMT_RMPP_TYPE_DATA
case|:
return|return
name|process_rmpp_data
argument_list|(
name|agent
argument_list|,
name|mad_recv_wc
argument_list|)
return|;
case|case
name|IB_MGMT_RMPP_TYPE_ACK
case|:
name|process_rmpp_ack
argument_list|(
name|agent
argument_list|,
name|mad_recv_wc
argument_list|)
expr_stmt|;
break|break;
case|case
name|IB_MGMT_RMPP_TYPE_STOP
case|:
name|process_rmpp_stop
argument_list|(
name|agent
argument_list|,
name|mad_recv_wc
argument_list|)
expr_stmt|;
break|break;
case|case
name|IB_MGMT_RMPP_TYPE_ABORT
case|:
name|process_rmpp_abort
argument_list|(
name|agent
argument_list|,
name|mad_recv_wc
argument_list|)
expr_stmt|;
break|break;
default|default:
name|abort_send
argument_list|(
name|agent
argument_list|,
name|mad_recv_wc
argument_list|,
name|IB_MGMT_RMPP_STATUS_BADT
argument_list|)
expr_stmt|;
name|nack_recv
argument_list|(
name|agent
argument_list|,
name|mad_recv_wc
argument_list|,
name|IB_MGMT_RMPP_STATUS_BADT
argument_list|)
expr_stmt|;
break|break;
block|}
name|out
label|:
name|ib_free_recv_mad
argument_list|(
name|mad_recv_wc
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|init_newwin
parameter_list|(
name|struct
name|ib_mad_send_wr_private
modifier|*
name|mad_send_wr
parameter_list|)
block|{
name|struct
name|ib_mad_agent_private
modifier|*
name|agent
init|=
name|mad_send_wr
operator|->
name|mad_agent_priv
decl_stmt|;
name|struct
name|ib_mad_hdr
modifier|*
name|mad_hdr
init|=
name|mad_send_wr
operator|->
name|send_buf
operator|.
name|mad
decl_stmt|;
name|struct
name|mad_rmpp_recv
modifier|*
name|rmpp_recv
decl_stmt|;
name|struct
name|ib_ah_attr
name|ah_attr
decl_stmt|;
name|unsigned
name|long
name|flags
decl_stmt|;
name|int
name|newwin
init|=
literal|1
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|mad_hdr
operator|->
name|method
operator|&
name|IB_MGMT_METHOD_RESP
operator|)
condition|)
goto|goto
name|out
goto|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|agent
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|list_for_each_entry
argument_list|(
argument|rmpp_recv
argument_list|,
argument|&agent->rmpp_list
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|rmpp_recv
operator|->
name|tid
operator|!=
name|mad_hdr
operator|->
name|tid
operator|||
name|rmpp_recv
operator|->
name|mgmt_class
operator|!=
name|mad_hdr
operator|->
name|mgmt_class
operator|||
name|rmpp_recv
operator|->
name|class_version
operator|!=
name|mad_hdr
operator|->
name|class_version
operator|||
operator|(
name|rmpp_recv
operator|->
name|method
operator|&
name|IB_MGMT_METHOD_RESP
operator|)
condition|)
continue|continue;
if|if
condition|(
name|ib_query_ah
argument_list|(
name|mad_send_wr
operator|->
name|send_buf
operator|.
name|ah
argument_list|,
operator|&
name|ah_attr
argument_list|)
condition|)
continue|continue;
if|if
condition|(
name|rmpp_recv
operator|->
name|slid
operator|==
name|ah_attr
operator|.
name|dlid
condition|)
block|{
name|newwin
operator|=
name|rmpp_recv
operator|->
name|repwin
expr_stmt|;
break|break;
block|}
block|}
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|agent
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|out
label|:
return|return
name|newwin
return|;
block|}
end_function

begin_function
name|int
name|ib_send_rmpp_mad
parameter_list|(
name|struct
name|ib_mad_send_wr_private
modifier|*
name|mad_send_wr
parameter_list|)
block|{
name|struct
name|ib_rmpp_mad
modifier|*
name|rmpp_mad
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|rmpp_mad
operator|=
name|mad_send_wr
operator|->
name|send_buf
operator|.
name|mad
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ib_get_rmpp_flags
argument_list|(
operator|&
name|rmpp_mad
operator|->
name|rmpp_hdr
argument_list|)
operator|&
name|IB_MGMT_RMPP_FLAG_ACTIVE
operator|)
condition|)
return|return
name|IB_RMPP_RESULT_UNHANDLED
return|;
if|if
condition|(
name|rmpp_mad
operator|->
name|rmpp_hdr
operator|.
name|rmpp_type
operator|!=
name|IB_MGMT_RMPP_TYPE_DATA
condition|)
block|{
name|mad_send_wr
operator|->
name|seg_num
operator|=
literal|1
expr_stmt|;
return|return
name|IB_RMPP_RESULT_INTERNAL
return|;
block|}
name|mad_send_wr
operator|->
name|newwin
operator|=
name|init_newwin
argument_list|(
name|mad_send_wr
argument_list|)
expr_stmt|;
comment|/* We need to wait for the final ACK even if there isn't a response */
name|mad_send_wr
operator|->
name|refcount
operator|+=
operator|(
name|mad_send_wr
operator|->
name|timeout
operator|==
literal|0
operator|)
expr_stmt|;
name|ret
operator|=
name|send_next_seg
argument_list|(
name|mad_send_wr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
return|return
name|IB_RMPP_RESULT_CONSUMED
return|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|ib_process_rmpp_send_wc
parameter_list|(
name|struct
name|ib_mad_send_wr_private
modifier|*
name|mad_send_wr
parameter_list|,
name|struct
name|ib_mad_send_wc
modifier|*
name|mad_send_wc
parameter_list|)
block|{
name|struct
name|ib_rmpp_mad
modifier|*
name|rmpp_mad
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|rmpp_mad
operator|=
name|mad_send_wr
operator|->
name|send_buf
operator|.
name|mad
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ib_get_rmpp_flags
argument_list|(
operator|&
name|rmpp_mad
operator|->
name|rmpp_hdr
argument_list|)
operator|&
name|IB_MGMT_RMPP_FLAG_ACTIVE
operator|)
condition|)
return|return
name|IB_RMPP_RESULT_UNHANDLED
return|;
comment|/* RMPP not active */
if|if
condition|(
name|rmpp_mad
operator|->
name|rmpp_hdr
operator|.
name|rmpp_type
operator|!=
name|IB_MGMT_RMPP_TYPE_DATA
condition|)
return|return
name|IB_RMPP_RESULT_INTERNAL
return|;
comment|/* ACK, STOP, or ABORT */
if|if
condition|(
name|mad_send_wc
operator|->
name|status
operator|!=
name|IB_WC_SUCCESS
operator|||
name|mad_send_wr
operator|->
name|status
operator|!=
name|IB_WC_SUCCESS
condition|)
return|return
name|IB_RMPP_RESULT_PROCESSED
return|;
comment|/* Canceled or send error */
if|if
condition|(
operator|!
name|mad_send_wr
operator|->
name|timeout
condition|)
return|return
name|IB_RMPP_RESULT_PROCESSED
return|;
comment|/* Response received */
if|if
condition|(
name|mad_send_wr
operator|->
name|last_ack
operator|==
name|mad_send_wr
operator|->
name|send_buf
operator|.
name|seg_count
condition|)
block|{
name|mad_send_wr
operator|->
name|timeout
operator|=
name|msecs_to_jiffies
argument_list|(
name|mad_send_wr
operator|->
name|send_buf
operator|.
name|timeout_ms
argument_list|)
expr_stmt|;
return|return
name|IB_RMPP_RESULT_PROCESSED
return|;
comment|/* Send done */
block|}
if|if
condition|(
name|mad_send_wr
operator|->
name|seg_num
operator|==
name|mad_send_wr
operator|->
name|newwin
operator|||
name|mad_send_wr
operator|->
name|seg_num
operator|==
name|mad_send_wr
operator|->
name|send_buf
operator|.
name|seg_count
condition|)
return|return
name|IB_RMPP_RESULT_PROCESSED
return|;
comment|/* Wait for ACK */
name|ret
operator|=
name|send_next_seg
argument_list|(
name|mad_send_wr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|mad_send_wc
operator|->
name|status
operator|=
name|IB_WC_GENERAL_ERR
expr_stmt|;
return|return
name|IB_RMPP_RESULT_PROCESSED
return|;
block|}
return|return
name|IB_RMPP_RESULT_CONSUMED
return|;
block|}
end_function

begin_function
name|int
name|ib_retry_rmpp
parameter_list|(
name|struct
name|ib_mad_send_wr_private
modifier|*
name|mad_send_wr
parameter_list|)
block|{
name|struct
name|ib_rmpp_mad
modifier|*
name|rmpp_mad
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|rmpp_mad
operator|=
name|mad_send_wr
operator|->
name|send_buf
operator|.
name|mad
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ib_get_rmpp_flags
argument_list|(
operator|&
name|rmpp_mad
operator|->
name|rmpp_hdr
argument_list|)
operator|&
name|IB_MGMT_RMPP_FLAG_ACTIVE
operator|)
condition|)
return|return
name|IB_RMPP_RESULT_UNHANDLED
return|;
comment|/* RMPP not active */
if|if
condition|(
name|mad_send_wr
operator|->
name|last_ack
operator|==
name|mad_send_wr
operator|->
name|send_buf
operator|.
name|seg_count
condition|)
return|return
name|IB_RMPP_RESULT_PROCESSED
return|;
name|mad_send_wr
operator|->
name|seg_num
operator|=
name|mad_send_wr
operator|->
name|last_ack
expr_stmt|;
name|mad_send_wr
operator|->
name|cur_seg
operator|=
name|mad_send_wr
operator|->
name|last_ack_seg
expr_stmt|;
name|ret
operator|=
name|send_next_seg
argument_list|(
name|mad_send_wr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|IB_RMPP_RESULT_PROCESSED
return|;
return|return
name|IB_RMPP_RESULT_CONSUMED
return|;
block|}
end_function

end_unit


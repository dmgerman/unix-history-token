begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2004-2007 Intel Corporation.  All rights reserved.  * Copyright (c) 2004 Topspin Corporation.  All rights reserved.  * Copyright (c) 2004, 2005 Voltaire Corporation.  All rights reserved.  * Copyright (c) 2005 Sun Microsystems, Inc. All rights reserved.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  */
end_comment

begin_include
include|#
directive|include
file|<linux/completion.h>
end_include

begin_include
include|#
directive|include
file|<linux/dma-mapping.h>
end_include

begin_include
include|#
directive|include
file|<linux/device.h>
end_include

begin_include
include|#
directive|include
file|<linux/module.h>
end_include

begin_include
include|#
directive|include
file|<linux/err.h>
end_include

begin_include
include|#
directive|include
file|<linux/idr.h>
end_include

begin_include
include|#
directive|include
file|<linux/interrupt.h>
end_include

begin_include
include|#
directive|include
file|<linux/random.h>
end_include

begin_include
include|#
directive|include
file|<linux/rbtree.h>
end_include

begin_include
include|#
directive|include
file|<linux/spinlock.h>
end_include

begin_include
include|#
directive|include
file|<linux/slab.h>
end_include

begin_include
include|#
directive|include
file|<linux/sysfs.h>
end_include

begin_include
include|#
directive|include
file|<linux/workqueue.h>
end_include

begin_include
include|#
directive|include
file|<linux/kdev_t.h>
end_include

begin_include
include|#
directive|include
file|<linux/string.h>
end_include

begin_include
include|#
directive|include
file|<linux/etherdevice.h>
end_include

begin_include
include|#
directive|include
file|<asm/atomic-long.h>
end_include

begin_include
include|#
directive|include
file|<rdma/ib_cache.h>
end_include

begin_include
include|#
directive|include
file|<rdma/ib_cm.h>
end_include

begin_include
include|#
directive|include
file|"cm_msgs.h"
end_include

begin_expr_stmt
name|MODULE_AUTHOR
argument_list|(
literal|"Sean Hefty"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DESCRIPTION
argument_list|(
literal|"InfiniBand CM"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_LICENSE
argument_list|(
literal|"Dual BSD/GPL"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|pr_fmt
end_ifdef

begin_undef
undef|#
directive|undef
name|pr_fmt
end_undef

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|pr_fmt
parameter_list|(
name|fmt
parameter_list|)
value|"%s:%s: " fmt, KBUILD_MODNAME, __func__
end_define

begin_function_decl
specifier|static
name|void
name|cm_add_one
parameter_list|(
name|struct
name|ib_device
modifier|*
name|device
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|cm_remove_one
parameter_list|(
name|struct
name|ib_device
modifier|*
name|device
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|struct
name|ib_client
name|cm_client
init|=
block|{
operator|.
name|name
operator|=
literal|"cm"
block|,
operator|.
name|add
operator|=
name|cm_add_one
block|,
operator|.
name|remove
operator|=
name|cm_remove_one
block|}
decl_stmt|;
end_decl_stmt

begin_struct
specifier|static
struct|struct
name|ib_cm
block|{
name|spinlock_t
name|lock
decl_stmt|;
name|struct
name|list_head
name|device_list
decl_stmt|;
name|rwlock_t
name|device_lock
decl_stmt|;
name|struct
name|rb_root
name|listen_service_table
decl_stmt|;
name|u64
name|listen_service_id
decl_stmt|;
comment|/* struct rb_root peer_service_table; todo: fix peer to peer */
name|struct
name|rb_root
name|remote_qp_table
decl_stmt|;
name|struct
name|rb_root
name|remote_id_table
decl_stmt|;
name|struct
name|rb_root
name|remote_sidr_table
decl_stmt|;
name|struct
name|idr
name|local_id_table
decl_stmt|;
name|__be32
name|random_id_operand
decl_stmt|;
name|struct
name|list_head
name|timewait_list
decl_stmt|;
name|struct
name|workqueue_struct
modifier|*
name|wq
decl_stmt|;
block|}
name|cm
struct|;
end_struct

begin_comment
comment|/* Counter indexes ordered by attribute ID */
end_comment

begin_enum
enum|enum
block|{
name|CM_REQ_COUNTER
block|,
name|CM_MRA_COUNTER
block|,
name|CM_REJ_COUNTER
block|,
name|CM_REP_COUNTER
block|,
name|CM_RTU_COUNTER
block|,
name|CM_DREQ_COUNTER
block|,
name|CM_DREP_COUNTER
block|,
name|CM_SIDR_REQ_COUNTER
block|,
name|CM_SIDR_REP_COUNTER
block|,
name|CM_LAP_COUNTER
block|,
name|CM_APR_COUNTER
block|,
name|CM_ATTR_COUNT
block|,
name|CM_ATTR_ID_OFFSET
init|=
literal|0x0010
block|, }
enum|;
end_enum

begin_enum
enum|enum
block|{
name|CM_XMIT
block|,
name|CM_XMIT_RETRIES
block|,
name|CM_RECV
block|,
name|CM_RECV_DUPLICATES
block|,
name|CM_COUNTER_GROUPS
block|}
enum|;
end_enum

begin_decl_stmt
specifier|static
name|char
specifier|const
name|counter_group_names
index|[
name|CM_COUNTER_GROUPS
index|]
index|[
sizeof|sizeof
argument_list|(
literal|"cm_rx_duplicates"
argument_list|)
index|]
init|=
block|{
literal|"cm_tx_msgs"
block|,
literal|"cm_tx_retries"
block|,
literal|"cm_rx_msgs"
block|,
literal|"cm_rx_duplicates"
block|}
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|cm_counter_group
block|{
name|struct
name|kobject
name|obj
decl_stmt|;
name|atomic_long_t
name|counter
index|[
name|CM_ATTR_COUNT
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|cm_counter_attribute
block|{
name|struct
name|attribute
name|attr
decl_stmt|;
name|int
name|index
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|CM_COUNTER_ATTR
parameter_list|(
name|_name
parameter_list|,
name|_index
parameter_list|)
define|\
value|struct cm_counter_attribute cm_##_name##_counter_attr = { \ 	.attr = { .name = __stringify(_name), .mode = 0444 }, \ 	.index = _index \ }
end_define

begin_expr_stmt
specifier|static
name|CM_COUNTER_ATTR
argument_list|(
name|req
argument_list|,
name|CM_REQ_COUNTER
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|CM_COUNTER_ATTR
argument_list|(
name|mra
argument_list|,
name|CM_MRA_COUNTER
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|CM_COUNTER_ATTR
argument_list|(
name|rej
argument_list|,
name|CM_REJ_COUNTER
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|CM_COUNTER_ATTR
argument_list|(
name|rep
argument_list|,
name|CM_REP_COUNTER
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|CM_COUNTER_ATTR
argument_list|(
name|rtu
argument_list|,
name|CM_RTU_COUNTER
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|CM_COUNTER_ATTR
argument_list|(
name|dreq
argument_list|,
name|CM_DREQ_COUNTER
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|CM_COUNTER_ATTR
argument_list|(
name|drep
argument_list|,
name|CM_DREP_COUNTER
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|CM_COUNTER_ATTR
argument_list|(
name|sidr_req
argument_list|,
name|CM_SIDR_REQ_COUNTER
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|CM_COUNTER_ATTR
argument_list|(
name|sidr_rep
argument_list|,
name|CM_SIDR_REP_COUNTER
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|CM_COUNTER_ATTR
argument_list|(
name|lap
argument_list|,
name|CM_LAP_COUNTER
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|CM_COUNTER_ATTR
argument_list|(
name|apr
argument_list|,
name|CM_APR_COUNTER
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|struct
name|attribute
modifier|*
name|cm_counter_default_attrs
index|[]
init|=
block|{
operator|&
name|cm_req_counter_attr
operator|.
name|attr
block|,
operator|&
name|cm_mra_counter_attr
operator|.
name|attr
block|,
operator|&
name|cm_rej_counter_attr
operator|.
name|attr
block|,
operator|&
name|cm_rep_counter_attr
operator|.
name|attr
block|,
operator|&
name|cm_rtu_counter_attr
operator|.
name|attr
block|,
operator|&
name|cm_dreq_counter_attr
operator|.
name|attr
block|,
operator|&
name|cm_drep_counter_attr
operator|.
name|attr
block|,
operator|&
name|cm_sidr_req_counter_attr
operator|.
name|attr
block|,
operator|&
name|cm_sidr_rep_counter_attr
operator|.
name|attr
block|,
operator|&
name|cm_lap_counter_attr
operator|.
name|attr
block|,
operator|&
name|cm_apr_counter_attr
operator|.
name|attr
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|cm_port
block|{
name|struct
name|cm_device
modifier|*
name|cm_dev
decl_stmt|;
name|struct
name|ib_mad_agent
modifier|*
name|mad_agent
decl_stmt|;
name|struct
name|kobject
name|port_obj
decl_stmt|;
name|u8
name|port_num
decl_stmt|;
name|struct
name|cm_counter_group
name|counter_group
index|[
name|CM_COUNTER_GROUPS
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|cm_device
block|{
name|struct
name|list_head
name|list
decl_stmt|;
name|struct
name|ib_device
modifier|*
name|ib_device
decl_stmt|;
name|struct
name|device
modifier|*
name|device
decl_stmt|;
name|u8
name|ack_delay
decl_stmt|;
name|struct
name|cm_port
modifier|*
name|port
index|[
literal|0
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|cm_av
block|{
name|struct
name|cm_port
modifier|*
name|port
decl_stmt|;
name|union
name|ib_gid
name|dgid
decl_stmt|;
name|struct
name|ib_ah_attr
name|ah_attr
decl_stmt|;
name|u16
name|pkey_index
decl_stmt|;
name|u8
name|timeout
decl_stmt|;
name|u8
name|valid
decl_stmt|;
name|u8
name|smac
index|[
name|ETH_ALEN
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|cm_work
block|{
name|struct
name|delayed_work
name|work
decl_stmt|;
name|struct
name|list_head
name|list
decl_stmt|;
name|struct
name|cm_port
modifier|*
name|port
decl_stmt|;
name|struct
name|ib_mad_recv_wc
modifier|*
name|mad_recv_wc
decl_stmt|;
comment|/* Received MADs */
name|__be32
name|local_id
decl_stmt|;
comment|/* Established / timewait */
name|__be32
name|remote_id
decl_stmt|;
name|struct
name|ib_cm_event
name|cm_event
decl_stmt|;
name|struct
name|ib_sa_path_rec
name|path
index|[
literal|0
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|cm_timewait_info
block|{
name|struct
name|cm_work
name|work
decl_stmt|;
comment|/* Must be first. */
name|struct
name|list_head
name|list
decl_stmt|;
name|struct
name|rb_node
name|remote_qp_node
decl_stmt|;
name|struct
name|rb_node
name|remote_id_node
decl_stmt|;
name|__be64
name|remote_ca_guid
decl_stmt|;
name|__be32
name|remote_qpn
decl_stmt|;
name|u8
name|inserted_remote_qp
decl_stmt|;
name|u8
name|inserted_remote_id
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|cm_id_private
block|{
name|struct
name|ib_cm_id
name|id
decl_stmt|;
name|struct
name|rb_node
name|service_node
decl_stmt|;
name|struct
name|rb_node
name|sidr_id_node
decl_stmt|;
name|spinlock_t
name|lock
decl_stmt|;
comment|/* Do not acquire inside cm.lock */
name|struct
name|completion
name|comp
decl_stmt|;
name|atomic_t
name|refcount
decl_stmt|;
name|struct
name|ib_mad_send_buf
modifier|*
name|msg
decl_stmt|;
name|struct
name|cm_timewait_info
modifier|*
name|timewait_info
decl_stmt|;
comment|/* todo: use alternate port on send failure */
name|struct
name|cm_av
name|av
decl_stmt|;
name|struct
name|cm_av
name|alt_av
decl_stmt|;
name|struct
name|ib_cm_compare_data
modifier|*
name|compare_data
decl_stmt|;
name|void
modifier|*
name|private_data
decl_stmt|;
name|__be64
name|tid
decl_stmt|;
name|__be32
name|local_qpn
decl_stmt|;
name|__be32
name|remote_qpn
decl_stmt|;
name|enum
name|ib_qp_type
name|qp_type
decl_stmt|;
name|__be32
name|sq_psn
decl_stmt|;
name|__be32
name|rq_psn
decl_stmt|;
name|int
name|timeout_ms
decl_stmt|;
name|enum
name|ib_mtu
name|path_mtu
decl_stmt|;
name|__be16
name|pkey
decl_stmt|;
name|u8
name|private_data_len
decl_stmt|;
name|u8
name|max_cm_retries
decl_stmt|;
name|u8
name|peer_to_peer
decl_stmt|;
name|u8
name|responder_resources
decl_stmt|;
name|u8
name|initiator_depth
decl_stmt|;
name|u8
name|retry_count
decl_stmt|;
name|u8
name|rnr_retry_count
decl_stmt|;
name|u8
name|service_timeout
decl_stmt|;
name|u8
name|target_ack_delay
decl_stmt|;
name|struct
name|list_head
name|work_list
decl_stmt|;
name|atomic_t
name|work_count
decl_stmt|;
block|}
struct|;
end_struct

begin_function_decl
specifier|static
name|void
name|cm_work_handler
parameter_list|(
name|struct
name|work_struct
modifier|*
name|work
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
specifier|inline
name|void
name|cm_deref_id
parameter_list|(
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
parameter_list|)
block|{
if|if
condition|(
name|atomic_dec_and_test
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|refcount
argument_list|)
condition|)
name|complete
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|comp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|cm_alloc_msg
parameter_list|(
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
parameter_list|,
name|struct
name|ib_mad_send_buf
modifier|*
modifier|*
name|msg
parameter_list|)
block|{
name|struct
name|ib_mad_agent
modifier|*
name|mad_agent
decl_stmt|;
name|struct
name|ib_mad_send_buf
modifier|*
name|m
decl_stmt|;
name|struct
name|ib_ah
modifier|*
name|ah
decl_stmt|;
name|mad_agent
operator|=
name|cm_id_priv
operator|->
name|av
operator|.
name|port
operator|->
name|mad_agent
expr_stmt|;
name|ah
operator|=
name|ib_create_ah
argument_list|(
name|mad_agent
operator|->
name|qp
operator|->
name|pd
argument_list|,
operator|&
name|cm_id_priv
operator|->
name|av
operator|.
name|ah_attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|ah
argument_list|)
condition|)
return|return
name|PTR_ERR
argument_list|(
name|ah
argument_list|)
return|;
name|m
operator|=
name|ib_create_send_mad
argument_list|(
name|mad_agent
argument_list|,
name|cm_id_priv
operator|->
name|id
operator|.
name|remote_cm_qpn
argument_list|,
name|cm_id_priv
operator|->
name|av
operator|.
name|pkey_index
argument_list|,
literal|0
argument_list|,
name|IB_MGMT_MAD_HDR
argument_list|,
name|IB_MGMT_MAD_DATA
argument_list|,
name|GFP_ATOMIC
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|m
argument_list|)
condition|)
block|{
name|ib_destroy_ah
argument_list|(
name|ah
argument_list|)
expr_stmt|;
return|return
name|PTR_ERR
argument_list|(
name|m
argument_list|)
return|;
block|}
comment|/* Timeout set by caller if response is expected. */
name|m
operator|->
name|ah
operator|=
name|ah
expr_stmt|;
name|m
operator|->
name|retries
operator|=
name|cm_id_priv
operator|->
name|max_cm_retries
expr_stmt|;
name|atomic_inc
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|refcount
argument_list|)
expr_stmt|;
name|m
operator|->
name|context
index|[
literal|0
index|]
operator|=
name|cm_id_priv
expr_stmt|;
operator|*
name|msg
operator|=
name|m
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cm_alloc_response_msg
parameter_list|(
name|struct
name|cm_port
modifier|*
name|port
parameter_list|,
name|struct
name|ib_mad_recv_wc
modifier|*
name|mad_recv_wc
parameter_list|,
name|struct
name|ib_mad_send_buf
modifier|*
modifier|*
name|msg
parameter_list|)
block|{
name|struct
name|ib_mad_send_buf
modifier|*
name|m
decl_stmt|;
name|struct
name|ib_ah
modifier|*
name|ah
decl_stmt|;
name|ah
operator|=
name|ib_create_ah_from_wc
argument_list|(
name|port
operator|->
name|mad_agent
operator|->
name|qp
operator|->
name|pd
argument_list|,
name|mad_recv_wc
operator|->
name|wc
argument_list|,
name|mad_recv_wc
operator|->
name|recv_buf
operator|.
name|grh
argument_list|,
name|port
operator|->
name|port_num
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|ah
argument_list|)
condition|)
return|return
name|PTR_ERR
argument_list|(
name|ah
argument_list|)
return|;
name|m
operator|=
name|ib_create_send_mad
argument_list|(
name|port
operator|->
name|mad_agent
argument_list|,
literal|1
argument_list|,
name|mad_recv_wc
operator|->
name|wc
operator|->
name|pkey_index
argument_list|,
literal|0
argument_list|,
name|IB_MGMT_MAD_HDR
argument_list|,
name|IB_MGMT_MAD_DATA
argument_list|,
name|GFP_ATOMIC
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|m
argument_list|)
condition|)
block|{
name|ib_destroy_ah
argument_list|(
name|ah
argument_list|)
expr_stmt|;
return|return
name|PTR_ERR
argument_list|(
name|m
argument_list|)
return|;
block|}
name|m
operator|->
name|ah
operator|=
name|ah
expr_stmt|;
operator|*
name|msg
operator|=
name|m
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|cm_free_msg
parameter_list|(
name|struct
name|ib_mad_send_buf
modifier|*
name|msg
parameter_list|)
block|{
name|ib_destroy_ah
argument_list|(
name|msg
operator|->
name|ah
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|context
index|[
literal|0
index|]
condition|)
name|cm_deref_id
argument_list|(
name|msg
operator|->
name|context
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|ib_free_send_mad
argument_list|(
name|msg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|cm_copy_private_data
parameter_list|(
specifier|const
name|void
modifier|*
name|private_data
parameter_list|,
name|u8
name|private_data_len
parameter_list|)
block|{
name|void
modifier|*
name|data
decl_stmt|;
if|if
condition|(
operator|!
name|private_data
operator|||
operator|!
name|private_data_len
condition|)
return|return
name|NULL
return|;
name|data
operator|=
name|kmemdup
argument_list|(
name|private_data
argument_list|,
name|private_data_len
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|data
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|ENOMEM
argument_list|)
return|;
return|return
name|data
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|cm_set_private_data
parameter_list|(
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
parameter_list|,
name|void
modifier|*
name|private_data
parameter_list|,
name|u8
name|private_data_len
parameter_list|)
block|{
if|if
condition|(
name|cm_id_priv
operator|->
name|private_data
operator|&&
name|cm_id_priv
operator|->
name|private_data_len
condition|)
name|kfree
argument_list|(
name|cm_id_priv
operator|->
name|private_data
argument_list|)
expr_stmt|;
name|cm_id_priv
operator|->
name|private_data
operator|=
name|private_data
expr_stmt|;
name|cm_id_priv
operator|->
name|private_data_len
operator|=
name|private_data_len
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|cm_init_av_for_response
parameter_list|(
name|struct
name|cm_port
modifier|*
name|port
parameter_list|,
name|struct
name|ib_wc
modifier|*
name|wc
parameter_list|,
name|struct
name|ib_grh
modifier|*
name|grh
parameter_list|,
name|struct
name|cm_av
modifier|*
name|av
parameter_list|)
block|{
name|av
operator|->
name|port
operator|=
name|port
expr_stmt|;
name|av
operator|->
name|pkey_index
operator|=
name|wc
operator|->
name|pkey_index
expr_stmt|;
name|ib_init_ah_from_wc
argument_list|(
name|port
operator|->
name|cm_dev
operator|->
name|ib_device
argument_list|,
name|port
operator|->
name|port_num
argument_list|,
name|wc
argument_list|,
name|grh
argument_list|,
operator|&
name|av
operator|->
name|ah_attr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|ib_update_cm_av
parameter_list|(
name|struct
name|ib_cm_id
modifier|*
name|id
parameter_list|,
specifier|const
name|u8
modifier|*
name|smac
parameter_list|,
specifier|const
name|u8
modifier|*
name|alt_smac
parameter_list|)
block|{
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
decl_stmt|;
name|cm_id_priv
operator|=
name|container_of
argument_list|(
name|id
argument_list|,
expr|struct
name|cm_id_private
argument_list|,
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
name|smac
operator|!=
name|NULL
condition|)
name|memcpy
argument_list|(
name|cm_id_priv
operator|->
name|av
operator|.
name|smac
argument_list|,
name|smac
argument_list|,
sizeof|sizeof
argument_list|(
name|cm_id_priv
operator|->
name|av
operator|.
name|smac
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|alt_smac
operator|!=
name|NULL
condition|)
name|memcpy
argument_list|(
name|cm_id_priv
operator|->
name|alt_av
operator|.
name|smac
argument_list|,
name|alt_smac
argument_list|,
sizeof|sizeof
argument_list|(
name|cm_id_priv
operator|->
name|alt_av
operator|.
name|smac
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL
argument_list|(
name|ib_update_cm_av
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|int
name|cm_init_av_by_path
parameter_list|(
name|struct
name|ib_sa_path_rec
modifier|*
name|path
parameter_list|,
name|struct
name|cm_av
modifier|*
name|av
parameter_list|)
block|{
name|struct
name|cm_device
modifier|*
name|cm_dev
decl_stmt|;
name|struct
name|cm_port
modifier|*
name|port
init|=
name|NULL
decl_stmt|;
name|unsigned
name|long
name|flags
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|u8
name|p
decl_stmt|;
name|read_lock_irqsave
argument_list|(
operator|&
name|cm
operator|.
name|device_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|list_for_each_entry
argument_list|(
argument|cm_dev
argument_list|,
argument|&cm.device_list
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
operator|!
name|ib_find_cached_gid
argument_list|(
name|cm_dev
operator|->
name|ib_device
argument_list|,
operator|&
name|path
operator|->
name|sgid
argument_list|,
operator|&
name|p
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|port
operator|=
name|cm_dev
operator|->
name|port
index|[
name|p
operator|-
literal|1
index|]
expr_stmt|;
break|break;
block|}
block|}
name|read_unlock_irqrestore
argument_list|(
operator|&
name|cm
operator|.
name|device_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|port
condition|)
return|return
operator|-
name|EINVAL
return|;
name|ret
operator|=
name|ib_find_cached_pkey
argument_list|(
name|cm_dev
operator|->
name|ib_device
argument_list|,
name|port
operator|->
name|port_num
argument_list|,
name|be16_to_cpu
argument_list|(
name|path
operator|->
name|pkey
argument_list|)
argument_list|,
operator|&
name|av
operator|->
name|pkey_index
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|av
operator|->
name|port
operator|=
name|port
expr_stmt|;
name|ib_init_ah_from_path
argument_list|(
name|cm_dev
operator|->
name|ib_device
argument_list|,
name|port
operator|->
name|port_num
argument_list|,
name|path
argument_list|,
operator|&
name|av
operator|->
name|ah_attr
argument_list|)
expr_stmt|;
name|av
operator|->
name|timeout
operator|=
name|path
operator|->
name|packet_life_time
operator|+
literal|1
expr_stmt|;
name|memcpy
argument_list|(
name|av
operator|->
name|smac
argument_list|,
name|path
operator|->
name|smac
argument_list|,
sizeof|sizeof
argument_list|(
name|av
operator|->
name|smac
argument_list|)
argument_list|)
expr_stmt|;
name|av
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cm_alloc_id
parameter_list|(
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
parameter_list|)
block|{
name|unsigned
name|long
name|flags
decl_stmt|;
name|int
name|ret
decl_stmt|,
name|id
decl_stmt|;
specifier|static
name|int
name|next_id
decl_stmt|;
do|do
block|{
name|spin_lock_irqsave
argument_list|(
operator|&
name|cm
operator|.
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|ret
operator|=
name|idr_get_new_above
argument_list|(
operator|&
name|cm
operator|.
name|local_id_table
argument_list|,
name|cm_id_priv
argument_list|,
name|next_id
argument_list|,
operator|&
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
name|next_id
operator|=
operator|(
operator|(
name|unsigned
operator|)
name|id
operator|+
literal|1
operator|)
operator|&
name|MAX_IDR_MASK
expr_stmt|;
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|cm
operator|.
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
operator|(
name|ret
operator|==
operator|-
name|EAGAIN
operator|)
operator|&&
name|idr_pre_get
argument_list|(
operator|&
name|cm
operator|.
name|local_id_table
argument_list|,
name|GFP_KERNEL
argument_list|)
condition|)
do|;
name|cm_id_priv
operator|->
name|id
operator|.
name|local_id
operator|=
operator|(
name|__force
name|__be32
operator|)
name|id
operator|^
name|cm
operator|.
name|random_id_operand
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|cm_free_id
parameter_list|(
name|__be32
name|local_id
parameter_list|)
block|{
name|spin_lock_irq
argument_list|(
operator|&
name|cm
operator|.
name|lock
argument_list|)
expr_stmt|;
name|idr_remove
argument_list|(
operator|&
name|cm
operator|.
name|local_id_table
argument_list|,
call|(
name|__force
name|int
call|)
argument_list|(
name|local_id
operator|^
name|cm
operator|.
name|random_id_operand
argument_list|)
argument_list|)
expr_stmt|;
name|spin_unlock_irq
argument_list|(
operator|&
name|cm
operator|.
name|lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|cm_id_private
modifier|*
name|cm_get_id
parameter_list|(
name|__be32
name|local_id
parameter_list|,
name|__be32
name|remote_id
parameter_list|)
block|{
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
decl_stmt|;
name|cm_id_priv
operator|=
name|idr_find
argument_list|(
operator|&
name|cm
operator|.
name|local_id_table
argument_list|,
call|(
name|__force
name|int
call|)
argument_list|(
name|local_id
operator|^
name|cm
operator|.
name|random_id_operand
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cm_id_priv
condition|)
block|{
if|if
condition|(
name|cm_id_priv
operator|->
name|id
operator|.
name|remote_id
operator|==
name|remote_id
condition|)
name|atomic_inc
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|refcount
argument_list|)
expr_stmt|;
else|else
name|cm_id_priv
operator|=
name|NULL
expr_stmt|;
block|}
return|return
name|cm_id_priv
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|cm_id_private
modifier|*
name|cm_acquire_id
parameter_list|(
name|__be32
name|local_id
parameter_list|,
name|__be32
name|remote_id
parameter_list|)
block|{
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
decl_stmt|;
name|spin_lock_irq
argument_list|(
operator|&
name|cm
operator|.
name|lock
argument_list|)
expr_stmt|;
name|cm_id_priv
operator|=
name|cm_get_id
argument_list|(
name|local_id
argument_list|,
name|remote_id
argument_list|)
expr_stmt|;
name|spin_unlock_irq
argument_list|(
operator|&
name|cm
operator|.
name|lock
argument_list|)
expr_stmt|;
return|return
name|cm_id_priv
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|cm_mask_copy
parameter_list|(
name|u8
modifier|*
name|dst
parameter_list|,
name|u8
modifier|*
name|src
parameter_list|,
name|u8
modifier|*
name|mask
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|IB_CM_COMPARE_SIZE
operator|/
expr|sizeof
operator|(
name|unsigned
name|long
operator|)
condition|;
name|i
operator|++
control|)
operator|(
operator|(
name|unsigned
name|long
operator|*
operator|)
name|dst
operator|)
index|[
name|i
index|]
operator|=
operator|(
operator|(
name|unsigned
name|long
operator|*
operator|)
name|src
operator|)
index|[
name|i
index|]
operator|&
operator|(
operator|(
name|unsigned
name|long
operator|*
operator|)
name|mask
operator|)
index|[
name|i
index|]
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|cm_compare_data
parameter_list|(
name|struct
name|ib_cm_compare_data
modifier|*
name|src_data
parameter_list|,
name|struct
name|ib_cm_compare_data
modifier|*
name|dst_data
parameter_list|)
block|{
name|u8
name|src
index|[
name|IB_CM_COMPARE_SIZE
index|]
decl_stmt|;
name|u8
name|dst
index|[
name|IB_CM_COMPARE_SIZE
index|]
decl_stmt|;
if|if
condition|(
operator|!
name|src_data
operator|||
operator|!
name|dst_data
condition|)
return|return
literal|0
return|;
name|cm_mask_copy
argument_list|(
name|src
argument_list|,
name|src_data
operator|->
name|data
argument_list|,
name|dst_data
operator|->
name|mask
argument_list|)
expr_stmt|;
name|cm_mask_copy
argument_list|(
name|dst
argument_list|,
name|dst_data
operator|->
name|data
argument_list|,
name|src_data
operator|->
name|mask
argument_list|)
expr_stmt|;
return|return
name|memcmp
argument_list|(
name|src
argument_list|,
name|dst
argument_list|,
name|IB_CM_COMPARE_SIZE
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cm_compare_private_data
parameter_list|(
name|u8
modifier|*
name|private_data
parameter_list|,
name|struct
name|ib_cm_compare_data
modifier|*
name|dst_data
parameter_list|)
block|{
name|u8
name|src
index|[
name|IB_CM_COMPARE_SIZE
index|]
decl_stmt|;
if|if
condition|(
operator|!
name|dst_data
condition|)
return|return
literal|0
return|;
name|cm_mask_copy
argument_list|(
name|src
argument_list|,
name|private_data
argument_list|,
name|dst_data
operator|->
name|mask
argument_list|)
expr_stmt|;
return|return
name|memcmp
argument_list|(
name|src
argument_list|,
name|dst_data
operator|->
name|data
argument_list|,
name|IB_CM_COMPARE_SIZE
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  * Trivial helpers to strip endian annotation and compare; the  * endianness doesn't actually matter since we just need a stable  * order for the RB tree.  */
end_comment

begin_function
specifier|static
name|int
name|be32_lt
parameter_list|(
name|__be32
name|a
parameter_list|,
name|__be32
name|b
parameter_list|)
block|{
return|return
operator|(
name|__force
name|u32
operator|)
name|a
operator|<
operator|(
name|__force
name|u32
operator|)
name|b
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|be32_gt
parameter_list|(
name|__be32
name|a
parameter_list|,
name|__be32
name|b
parameter_list|)
block|{
return|return
operator|(
name|__force
name|u32
operator|)
name|a
operator|>
operator|(
name|__force
name|u32
operator|)
name|b
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|be64_lt
parameter_list|(
name|__be64
name|a
parameter_list|,
name|__be64
name|b
parameter_list|)
block|{
return|return
operator|(
name|__force
name|u64
operator|)
name|a
operator|<
operator|(
name|__force
name|u64
operator|)
name|b
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|be64_gt
parameter_list|(
name|__be64
name|a
parameter_list|,
name|__be64
name|b
parameter_list|)
block|{
return|return
operator|(
name|__force
name|u64
operator|)
name|a
operator|>
operator|(
name|__force
name|u64
operator|)
name|b
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|cm_id_private
modifier|*
name|cm_insert_listen
parameter_list|(
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
parameter_list|)
block|{
name|struct
name|rb_node
modifier|*
modifier|*
name|link
init|=
operator|&
name|cm
operator|.
name|listen_service_table
operator|.
name|rb_node
decl_stmt|;
name|struct
name|rb_node
modifier|*
name|parent
init|=
name|NULL
decl_stmt|;
name|struct
name|cm_id_private
modifier|*
name|cur_cm_id_priv
decl_stmt|;
name|__be64
name|service_id
init|=
name|cm_id_priv
operator|->
name|id
operator|.
name|service_id
decl_stmt|;
name|__be64
name|service_mask
init|=
name|cm_id_priv
operator|->
name|id
operator|.
name|service_mask
decl_stmt|;
name|int
name|data_cmp
decl_stmt|;
while|while
condition|(
operator|*
name|link
condition|)
block|{
name|parent
operator|=
operator|*
name|link
expr_stmt|;
name|cur_cm_id_priv
operator|=
name|rb_entry
argument_list|(
name|parent
argument_list|,
expr|struct
name|cm_id_private
argument_list|,
name|service_node
argument_list|)
expr_stmt|;
name|data_cmp
operator|=
name|cm_compare_data
argument_list|(
name|cm_id_priv
operator|->
name|compare_data
argument_list|,
name|cur_cm_id_priv
operator|->
name|compare_data
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|cur_cm_id_priv
operator|->
name|id
operator|.
name|service_mask
operator|&
name|service_id
operator|)
operator|==
operator|(
name|service_mask
operator|&
name|cur_cm_id_priv
operator|->
name|id
operator|.
name|service_id
operator|)
operator|&&
operator|(
name|cm_id_priv
operator|->
name|id
operator|.
name|device
operator|==
name|cur_cm_id_priv
operator|->
name|id
operator|.
name|device
operator|)
operator|&&
operator|!
name|data_cmp
condition|)
return|return
name|cur_cm_id_priv
return|;
if|if
condition|(
name|cm_id_priv
operator|->
name|id
operator|.
name|device
operator|<
name|cur_cm_id_priv
operator|->
name|id
operator|.
name|device
condition|)
name|link
operator|=
operator|&
operator|(
operator|*
name|link
operator|)
operator|->
name|rb_left
expr_stmt|;
elseif|else
if|if
condition|(
name|cm_id_priv
operator|->
name|id
operator|.
name|device
operator|>
name|cur_cm_id_priv
operator|->
name|id
operator|.
name|device
condition|)
name|link
operator|=
operator|&
operator|(
operator|*
name|link
operator|)
operator|->
name|rb_right
expr_stmt|;
elseif|else
if|if
condition|(
name|be64_lt
argument_list|(
name|service_id
argument_list|,
name|cur_cm_id_priv
operator|->
name|id
operator|.
name|service_id
argument_list|)
condition|)
name|link
operator|=
operator|&
operator|(
operator|*
name|link
operator|)
operator|->
name|rb_left
expr_stmt|;
elseif|else
if|if
condition|(
name|be64_gt
argument_list|(
name|service_id
argument_list|,
name|cur_cm_id_priv
operator|->
name|id
operator|.
name|service_id
argument_list|)
condition|)
name|link
operator|=
operator|&
operator|(
operator|*
name|link
operator|)
operator|->
name|rb_right
expr_stmt|;
elseif|else
if|if
condition|(
name|data_cmp
operator|<
literal|0
condition|)
name|link
operator|=
operator|&
operator|(
operator|*
name|link
operator|)
operator|->
name|rb_left
expr_stmt|;
else|else
name|link
operator|=
operator|&
operator|(
operator|*
name|link
operator|)
operator|->
name|rb_right
expr_stmt|;
block|}
name|rb_link_node
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|service_node
argument_list|,
name|parent
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|rb_insert_color
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|service_node
argument_list|,
operator|&
name|cm
operator|.
name|listen_service_table
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|cm_id_private
modifier|*
name|cm_find_listen
parameter_list|(
name|struct
name|ib_device
modifier|*
name|device
parameter_list|,
name|__be64
name|service_id
parameter_list|,
name|u8
modifier|*
name|private_data
parameter_list|)
block|{
name|struct
name|rb_node
modifier|*
name|node
init|=
name|cm
operator|.
name|listen_service_table
operator|.
name|rb_node
decl_stmt|;
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
decl_stmt|;
name|int
name|data_cmp
decl_stmt|;
while|while
condition|(
name|node
condition|)
block|{
name|cm_id_priv
operator|=
name|rb_entry
argument_list|(
name|node
argument_list|,
expr|struct
name|cm_id_private
argument_list|,
name|service_node
argument_list|)
expr_stmt|;
name|data_cmp
operator|=
name|cm_compare_private_data
argument_list|(
name|private_data
argument_list|,
name|cm_id_priv
operator|->
name|compare_data
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|cm_id_priv
operator|->
name|id
operator|.
name|service_mask
operator|&
name|service_id
operator|)
operator|==
name|cm_id_priv
operator|->
name|id
operator|.
name|service_id
operator|&&
operator|(
name|cm_id_priv
operator|->
name|id
operator|.
name|device
operator|==
name|device
operator|)
operator|&&
operator|!
name|data_cmp
condition|)
return|return
name|cm_id_priv
return|;
if|if
condition|(
name|device
operator|<
name|cm_id_priv
operator|->
name|id
operator|.
name|device
condition|)
name|node
operator|=
name|node
operator|->
name|rb_left
expr_stmt|;
elseif|else
if|if
condition|(
name|device
operator|>
name|cm_id_priv
operator|->
name|id
operator|.
name|device
condition|)
name|node
operator|=
name|node
operator|->
name|rb_right
expr_stmt|;
elseif|else
if|if
condition|(
name|be64_lt
argument_list|(
name|service_id
argument_list|,
name|cm_id_priv
operator|->
name|id
operator|.
name|service_id
argument_list|)
condition|)
name|node
operator|=
name|node
operator|->
name|rb_left
expr_stmt|;
elseif|else
if|if
condition|(
name|be64_gt
argument_list|(
name|service_id
argument_list|,
name|cm_id_priv
operator|->
name|id
operator|.
name|service_id
argument_list|)
condition|)
name|node
operator|=
name|node
operator|->
name|rb_right
expr_stmt|;
elseif|else
if|if
condition|(
name|data_cmp
operator|<
literal|0
condition|)
name|node
operator|=
name|node
operator|->
name|rb_left
expr_stmt|;
else|else
name|node
operator|=
name|node
operator|->
name|rb_right
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|cm_timewait_info
modifier|*
name|cm_insert_remote_id
parameter_list|(
name|struct
name|cm_timewait_info
modifier|*
name|timewait_info
parameter_list|)
block|{
name|struct
name|rb_node
modifier|*
modifier|*
name|link
init|=
operator|&
name|cm
operator|.
name|remote_id_table
operator|.
name|rb_node
decl_stmt|;
name|struct
name|rb_node
modifier|*
name|parent
init|=
name|NULL
decl_stmt|;
name|struct
name|cm_timewait_info
modifier|*
name|cur_timewait_info
decl_stmt|;
name|__be64
name|remote_ca_guid
init|=
name|timewait_info
operator|->
name|remote_ca_guid
decl_stmt|;
name|__be32
name|remote_id
init|=
name|timewait_info
operator|->
name|work
operator|.
name|remote_id
decl_stmt|;
while|while
condition|(
operator|*
name|link
condition|)
block|{
name|parent
operator|=
operator|*
name|link
expr_stmt|;
name|cur_timewait_info
operator|=
name|rb_entry
argument_list|(
name|parent
argument_list|,
expr|struct
name|cm_timewait_info
argument_list|,
name|remote_id_node
argument_list|)
expr_stmt|;
if|if
condition|(
name|be32_lt
argument_list|(
name|remote_id
argument_list|,
name|cur_timewait_info
operator|->
name|work
operator|.
name|remote_id
argument_list|)
condition|)
name|link
operator|=
operator|&
operator|(
operator|*
name|link
operator|)
operator|->
name|rb_left
expr_stmt|;
elseif|else
if|if
condition|(
name|be32_gt
argument_list|(
name|remote_id
argument_list|,
name|cur_timewait_info
operator|->
name|work
operator|.
name|remote_id
argument_list|)
condition|)
name|link
operator|=
operator|&
operator|(
operator|*
name|link
operator|)
operator|->
name|rb_right
expr_stmt|;
elseif|else
if|if
condition|(
name|be64_lt
argument_list|(
name|remote_ca_guid
argument_list|,
name|cur_timewait_info
operator|->
name|remote_ca_guid
argument_list|)
condition|)
name|link
operator|=
operator|&
operator|(
operator|*
name|link
operator|)
operator|->
name|rb_left
expr_stmt|;
elseif|else
if|if
condition|(
name|be64_gt
argument_list|(
name|remote_ca_guid
argument_list|,
name|cur_timewait_info
operator|->
name|remote_ca_guid
argument_list|)
condition|)
name|link
operator|=
operator|&
operator|(
operator|*
name|link
operator|)
operator|->
name|rb_right
expr_stmt|;
else|else
return|return
name|cur_timewait_info
return|;
block|}
name|timewait_info
operator|->
name|inserted_remote_id
operator|=
literal|1
expr_stmt|;
name|rb_link_node
argument_list|(
operator|&
name|timewait_info
operator|->
name|remote_id_node
argument_list|,
name|parent
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|rb_insert_color
argument_list|(
operator|&
name|timewait_info
operator|->
name|remote_id_node
argument_list|,
operator|&
name|cm
operator|.
name|remote_id_table
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|cm_timewait_info
modifier|*
name|cm_find_remote_id
parameter_list|(
name|__be64
name|remote_ca_guid
parameter_list|,
name|__be32
name|remote_id
parameter_list|)
block|{
name|struct
name|rb_node
modifier|*
name|node
init|=
name|cm
operator|.
name|remote_id_table
operator|.
name|rb_node
decl_stmt|;
name|struct
name|cm_timewait_info
modifier|*
name|timewait_info
decl_stmt|;
while|while
condition|(
name|node
condition|)
block|{
name|timewait_info
operator|=
name|rb_entry
argument_list|(
name|node
argument_list|,
expr|struct
name|cm_timewait_info
argument_list|,
name|remote_id_node
argument_list|)
expr_stmt|;
if|if
condition|(
name|be32_lt
argument_list|(
name|remote_id
argument_list|,
name|timewait_info
operator|->
name|work
operator|.
name|remote_id
argument_list|)
condition|)
name|node
operator|=
name|node
operator|->
name|rb_left
expr_stmt|;
elseif|else
if|if
condition|(
name|be32_gt
argument_list|(
name|remote_id
argument_list|,
name|timewait_info
operator|->
name|work
operator|.
name|remote_id
argument_list|)
condition|)
name|node
operator|=
name|node
operator|->
name|rb_right
expr_stmt|;
elseif|else
if|if
condition|(
name|be64_lt
argument_list|(
name|remote_ca_guid
argument_list|,
name|timewait_info
operator|->
name|remote_ca_guid
argument_list|)
condition|)
name|node
operator|=
name|node
operator|->
name|rb_left
expr_stmt|;
elseif|else
if|if
condition|(
name|be64_gt
argument_list|(
name|remote_ca_guid
argument_list|,
name|timewait_info
operator|->
name|remote_ca_guid
argument_list|)
condition|)
name|node
operator|=
name|node
operator|->
name|rb_right
expr_stmt|;
else|else
return|return
name|timewait_info
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|cm_timewait_info
modifier|*
name|cm_insert_remote_qpn
parameter_list|(
name|struct
name|cm_timewait_info
modifier|*
name|timewait_info
parameter_list|)
block|{
name|struct
name|rb_node
modifier|*
modifier|*
name|link
init|=
operator|&
name|cm
operator|.
name|remote_qp_table
operator|.
name|rb_node
decl_stmt|;
name|struct
name|rb_node
modifier|*
name|parent
init|=
name|NULL
decl_stmt|;
name|struct
name|cm_timewait_info
modifier|*
name|cur_timewait_info
decl_stmt|;
name|__be64
name|remote_ca_guid
init|=
name|timewait_info
operator|->
name|remote_ca_guid
decl_stmt|;
name|__be32
name|remote_qpn
init|=
name|timewait_info
operator|->
name|remote_qpn
decl_stmt|;
while|while
condition|(
operator|*
name|link
condition|)
block|{
name|parent
operator|=
operator|*
name|link
expr_stmt|;
name|cur_timewait_info
operator|=
name|rb_entry
argument_list|(
name|parent
argument_list|,
expr|struct
name|cm_timewait_info
argument_list|,
name|remote_qp_node
argument_list|)
expr_stmt|;
if|if
condition|(
name|be32_lt
argument_list|(
name|remote_qpn
argument_list|,
name|cur_timewait_info
operator|->
name|remote_qpn
argument_list|)
condition|)
name|link
operator|=
operator|&
operator|(
operator|*
name|link
operator|)
operator|->
name|rb_left
expr_stmt|;
elseif|else
if|if
condition|(
name|be32_gt
argument_list|(
name|remote_qpn
argument_list|,
name|cur_timewait_info
operator|->
name|remote_qpn
argument_list|)
condition|)
name|link
operator|=
operator|&
operator|(
operator|*
name|link
operator|)
operator|->
name|rb_right
expr_stmt|;
elseif|else
if|if
condition|(
name|be64_lt
argument_list|(
name|remote_ca_guid
argument_list|,
name|cur_timewait_info
operator|->
name|remote_ca_guid
argument_list|)
condition|)
name|link
operator|=
operator|&
operator|(
operator|*
name|link
operator|)
operator|->
name|rb_left
expr_stmt|;
elseif|else
if|if
condition|(
name|be64_gt
argument_list|(
name|remote_ca_guid
argument_list|,
name|cur_timewait_info
operator|->
name|remote_ca_guid
argument_list|)
condition|)
name|link
operator|=
operator|&
operator|(
operator|*
name|link
operator|)
operator|->
name|rb_right
expr_stmt|;
else|else
return|return
name|cur_timewait_info
return|;
block|}
name|timewait_info
operator|->
name|inserted_remote_qp
operator|=
literal|1
expr_stmt|;
name|rb_link_node
argument_list|(
operator|&
name|timewait_info
operator|->
name|remote_qp_node
argument_list|,
name|parent
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|rb_insert_color
argument_list|(
operator|&
name|timewait_info
operator|->
name|remote_qp_node
argument_list|,
operator|&
name|cm
operator|.
name|remote_qp_table
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|cm_id_private
modifier|*
name|cm_insert_remote_sidr
parameter_list|(
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
parameter_list|)
block|{
name|struct
name|rb_node
modifier|*
modifier|*
name|link
init|=
operator|&
name|cm
operator|.
name|remote_sidr_table
operator|.
name|rb_node
decl_stmt|;
name|struct
name|rb_node
modifier|*
name|parent
init|=
name|NULL
decl_stmt|;
name|struct
name|cm_id_private
modifier|*
name|cur_cm_id_priv
decl_stmt|;
name|union
name|ib_gid
modifier|*
name|port_gid
init|=
operator|&
name|cm_id_priv
operator|->
name|av
operator|.
name|dgid
decl_stmt|;
name|__be32
name|remote_id
init|=
name|cm_id_priv
operator|->
name|id
operator|.
name|remote_id
decl_stmt|;
while|while
condition|(
operator|*
name|link
condition|)
block|{
name|parent
operator|=
operator|*
name|link
expr_stmt|;
name|cur_cm_id_priv
operator|=
name|rb_entry
argument_list|(
name|parent
argument_list|,
expr|struct
name|cm_id_private
argument_list|,
name|sidr_id_node
argument_list|)
expr_stmt|;
if|if
condition|(
name|be32_lt
argument_list|(
name|remote_id
argument_list|,
name|cur_cm_id_priv
operator|->
name|id
operator|.
name|remote_id
argument_list|)
condition|)
name|link
operator|=
operator|&
operator|(
operator|*
name|link
operator|)
operator|->
name|rb_left
expr_stmt|;
elseif|else
if|if
condition|(
name|be32_gt
argument_list|(
name|remote_id
argument_list|,
name|cur_cm_id_priv
operator|->
name|id
operator|.
name|remote_id
argument_list|)
condition|)
name|link
operator|=
operator|&
operator|(
operator|*
name|link
operator|)
operator|->
name|rb_right
expr_stmt|;
else|else
block|{
name|int
name|cmp
decl_stmt|;
name|cmp
operator|=
name|memcmp
argument_list|(
name|port_gid
argument_list|,
operator|&
name|cur_cm_id_priv
operator|->
name|av
operator|.
name|dgid
argument_list|,
sizeof|sizeof
expr|*
name|port_gid
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmp
operator|<
literal|0
condition|)
name|link
operator|=
operator|&
operator|(
operator|*
name|link
operator|)
operator|->
name|rb_left
expr_stmt|;
elseif|else
if|if
condition|(
name|cmp
operator|>
literal|0
condition|)
name|link
operator|=
operator|&
operator|(
operator|*
name|link
operator|)
operator|->
name|rb_right
expr_stmt|;
else|else
return|return
name|cur_cm_id_priv
return|;
block|}
block|}
name|rb_link_node
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|sidr_id_node
argument_list|,
name|parent
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|rb_insert_color
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|sidr_id_node
argument_list|,
operator|&
name|cm
operator|.
name|remote_sidr_table
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|cm_reject_sidr_req
parameter_list|(
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
parameter_list|,
name|enum
name|ib_cm_sidr_status
name|status
parameter_list|)
block|{
name|struct
name|ib_cm_sidr_rep_param
name|param
decl_stmt|;
name|memset
argument_list|(
operator|&
name|param
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|param
argument_list|)
expr_stmt|;
name|param
operator|.
name|status
operator|=
name|status
expr_stmt|;
name|ib_send_cm_sidr_rep
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|id
argument_list|,
operator|&
name|param
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|struct
name|ib_cm_id
modifier|*
name|ib_create_cm_id
parameter_list|(
name|struct
name|ib_device
modifier|*
name|device
parameter_list|,
name|ib_cm_handler
name|cm_handler
parameter_list|,
name|void
modifier|*
name|context
parameter_list|)
block|{
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|cm_id_priv
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
expr|*
name|cm_id_priv
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cm_id_priv
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|ENOMEM
argument_list|)
return|;
name|cm_id_priv
operator|->
name|id
operator|.
name|state
operator|=
name|IB_CM_IDLE
expr_stmt|;
name|cm_id_priv
operator|->
name|id
operator|.
name|device
operator|=
name|device
expr_stmt|;
name|cm_id_priv
operator|->
name|id
operator|.
name|cm_handler
operator|=
name|cm_handler
expr_stmt|;
name|cm_id_priv
operator|->
name|id
operator|.
name|context
operator|=
name|context
expr_stmt|;
name|cm_id_priv
operator|->
name|id
operator|.
name|remote_cm_qpn
operator|=
literal|1
expr_stmt|;
name|ret
operator|=
name|cm_alloc_id
argument_list|(
name|cm_id_priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|error
goto|;
name|spin_lock_init
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
name|init_completion
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|comp
argument_list|)
expr_stmt|;
name|INIT_LIST_HEAD
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|work_list
argument_list|)
expr_stmt|;
name|atomic_set
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|work_count
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|atomic_set
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|refcount
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
operator|&
name|cm_id_priv
operator|->
name|id
return|;
name|error
label|:
name|kfree
argument_list|(
name|cm_id_priv
argument_list|)
expr_stmt|;
return|return
name|ERR_PTR
argument_list|(
operator|-
name|ENOMEM
argument_list|)
return|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL
argument_list|(
name|ib_create_cm_id
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|struct
name|cm_work
modifier|*
name|cm_dequeue_work
parameter_list|(
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
parameter_list|)
block|{
name|struct
name|cm_work
modifier|*
name|work
decl_stmt|;
if|if
condition|(
name|list_empty
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|work_list
argument_list|)
condition|)
return|return
name|NULL
return|;
name|work
operator|=
name|list_entry
argument_list|(
name|cm_id_priv
operator|->
name|work_list
operator|.
name|next
argument_list|,
expr|struct
name|cm_work
argument_list|,
name|list
argument_list|)
expr_stmt|;
name|list_del
argument_list|(
operator|&
name|work
operator|->
name|list
argument_list|)
expr_stmt|;
return|return
name|work
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|cm_free_work
parameter_list|(
name|struct
name|cm_work
modifier|*
name|work
parameter_list|)
block|{
if|if
condition|(
name|work
operator|->
name|mad_recv_wc
condition|)
name|ib_free_recv_mad
argument_list|(
name|work
operator|->
name|mad_recv_wc
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|work
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|int
name|cm_convert_to_ms
parameter_list|(
name|int
name|iba_time
parameter_list|)
block|{
comment|/* approximate conversion to ms from 4.096us x 2^iba_time */
return|return
literal|1
operator|<<
name|max
argument_list|(
name|iba_time
operator|-
literal|8
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  * calculate: 4.096x2^ack_timeout = 4.096x2^ack_delay + 2x4.096x2^life_time  * Because of how ack_timeout is stored, adding one doubles the timeout.  * To avoid large timeouts, select the max(ack_delay, life_time + 1), and  * increment it (round up) only if the other is within 50%.  */
end_comment

begin_function
specifier|static
name|u8
name|cm_ack_timeout
parameter_list|(
name|u8
name|ca_ack_delay
parameter_list|,
name|u8
name|packet_life_time
parameter_list|)
block|{
name|int
name|ack_timeout
init|=
name|packet_life_time
operator|+
literal|1
decl_stmt|;
if|if
condition|(
name|ack_timeout
operator|>=
name|ca_ack_delay
condition|)
name|ack_timeout
operator|+=
operator|(
name|ca_ack_delay
operator|>=
operator|(
name|ack_timeout
operator|-
literal|1
operator|)
operator|)
expr_stmt|;
else|else
name|ack_timeout
operator|=
name|ca_ack_delay
operator|+
operator|(
name|ack_timeout
operator|>=
operator|(
name|ca_ack_delay
operator|-
literal|1
operator|)
operator|)
expr_stmt|;
return|return
name|min
argument_list|(
literal|31
argument_list|,
name|ack_timeout
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|cm_cleanup_timewait
parameter_list|(
name|struct
name|cm_timewait_info
modifier|*
name|timewait_info
parameter_list|)
block|{
if|if
condition|(
name|timewait_info
operator|->
name|inserted_remote_id
condition|)
block|{
name|rb_erase
argument_list|(
operator|&
name|timewait_info
operator|->
name|remote_id_node
argument_list|,
operator|&
name|cm
operator|.
name|remote_id_table
argument_list|)
expr_stmt|;
name|timewait_info
operator|->
name|inserted_remote_id
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|timewait_info
operator|->
name|inserted_remote_qp
condition|)
block|{
name|rb_erase
argument_list|(
operator|&
name|timewait_info
operator|->
name|remote_qp_node
argument_list|,
operator|&
name|cm
operator|.
name|remote_qp_table
argument_list|)
expr_stmt|;
name|timewait_info
operator|->
name|inserted_remote_qp
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|struct
name|cm_timewait_info
modifier|*
name|cm_create_timewait_info
parameter_list|(
name|__be32
name|local_id
parameter_list|,
name|gfp_t
name|flags
parameter_list|)
block|{
name|struct
name|cm_timewait_info
modifier|*
name|timewait_info
decl_stmt|;
name|timewait_info
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
expr|*
name|timewait_info
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|timewait_info
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|ENOMEM
argument_list|)
return|;
name|timewait_info
operator|->
name|work
operator|.
name|local_id
operator|=
name|local_id
expr_stmt|;
name|INIT_DELAYED_WORK
argument_list|(
operator|&
name|timewait_info
operator|->
name|work
operator|.
name|work
argument_list|,
name|cm_work_handler
argument_list|)
expr_stmt|;
name|timewait_info
operator|->
name|work
operator|.
name|cm_event
operator|.
name|event
operator|=
name|IB_CM_TIMEWAIT_EXIT
expr_stmt|;
return|return
name|timewait_info
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|cm_enter_timewait
parameter_list|(
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
parameter_list|)
block|{
name|int
name|wait_time
decl_stmt|;
name|unsigned
name|long
name|flags
decl_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|cm
operator|.
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|cm_cleanup_timewait
argument_list|(
name|cm_id_priv
operator|->
name|timewait_info
argument_list|)
expr_stmt|;
name|list_add_tail
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|timewait_info
operator|->
name|list
argument_list|,
operator|&
name|cm
operator|.
name|timewait_list
argument_list|)
expr_stmt|;
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|cm
operator|.
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
comment|/* 	 * The cm_id could be destroyed by the user before we exit timewait. 	 * To protect against this, we search for the cm_id after exiting 	 * timewait before notifying the user that we've exited timewait. 	 */
name|cm_id_priv
operator|->
name|id
operator|.
name|state
operator|=
name|IB_CM_TIMEWAIT
expr_stmt|;
name|wait_time
operator|=
name|cm_convert_to_ms
argument_list|(
name|cm_id_priv
operator|->
name|av
operator|.
name|timeout
argument_list|)
expr_stmt|;
name|queue_delayed_work
argument_list|(
name|cm
operator|.
name|wq
argument_list|,
operator|&
name|cm_id_priv
operator|->
name|timewait_info
operator|->
name|work
operator|.
name|work
argument_list|,
name|msecs_to_jiffies
argument_list|(
name|wait_time
argument_list|)
argument_list|)
expr_stmt|;
name|cm_id_priv
operator|->
name|timewait_info
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|cm_reset_to_idle
parameter_list|(
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
parameter_list|)
block|{
name|unsigned
name|long
name|flags
decl_stmt|;
name|cm_id_priv
operator|->
name|id
operator|.
name|state
operator|=
name|IB_CM_IDLE
expr_stmt|;
if|if
condition|(
name|cm_id_priv
operator|->
name|timewait_info
condition|)
block|{
name|spin_lock_irqsave
argument_list|(
operator|&
name|cm
operator|.
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|cm_cleanup_timewait
argument_list|(
name|cm_id_priv
operator|->
name|timewait_info
argument_list|)
expr_stmt|;
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|cm
operator|.
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|cm_id_priv
operator|->
name|timewait_info
argument_list|)
expr_stmt|;
name|cm_id_priv
operator|->
name|timewait_info
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|cm_destroy_id
parameter_list|(
name|struct
name|ib_cm_id
modifier|*
name|cm_id
parameter_list|,
name|int
name|err
parameter_list|)
block|{
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
decl_stmt|;
name|struct
name|cm_work
modifier|*
name|work
decl_stmt|;
name|cm_id_priv
operator|=
name|container_of
argument_list|(
name|cm_id
argument_list|,
expr|struct
name|cm_id_private
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|retest
label|:
name|spin_lock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cm_id
operator|->
name|state
condition|)
block|{
case|case
name|IB_CM_LISTEN
case|:
name|cm_id
operator|->
name|state
operator|=
name|IB_CM_IDLE
expr_stmt|;
name|spin_unlock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
name|spin_lock_irq
argument_list|(
operator|&
name|cm
operator|.
name|lock
argument_list|)
expr_stmt|;
name|rb_erase
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|service_node
argument_list|,
operator|&
name|cm
operator|.
name|listen_service_table
argument_list|)
expr_stmt|;
name|spin_unlock_irq
argument_list|(
operator|&
name|cm
operator|.
name|lock
argument_list|)
expr_stmt|;
break|break;
case|case
name|IB_CM_SIDR_REQ_SENT
case|:
name|cm_id
operator|->
name|state
operator|=
name|IB_CM_IDLE
expr_stmt|;
name|ib_cancel_mad
argument_list|(
name|cm_id_priv
operator|->
name|av
operator|.
name|port
operator|->
name|mad_agent
argument_list|,
name|cm_id_priv
operator|->
name|msg
argument_list|)
expr_stmt|;
name|spin_unlock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
break|break;
case|case
name|IB_CM_SIDR_REQ_RCVD
case|:
name|spin_unlock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
name|cm_reject_sidr_req
argument_list|(
name|cm_id_priv
argument_list|,
name|IB_SIDR_REJECT
argument_list|)
expr_stmt|;
break|break;
case|case
name|IB_CM_REQ_SENT
case|:
name|ib_cancel_mad
argument_list|(
name|cm_id_priv
operator|->
name|av
operator|.
name|port
operator|->
name|mad_agent
argument_list|,
name|cm_id_priv
operator|->
name|msg
argument_list|)
expr_stmt|;
name|spin_unlock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
name|ib_send_cm_rej
argument_list|(
name|cm_id
argument_list|,
name|IB_CM_REJ_TIMEOUT
argument_list|,
operator|&
name|cm_id_priv
operator|->
name|id
operator|.
name|device
operator|->
name|node_guid
argument_list|,
sizeof|sizeof
name|cm_id_priv
operator|->
name|id
operator|.
name|device
operator|->
name|node_guid
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|IB_CM_REQ_RCVD
case|:
if|if
condition|(
name|err
operator|==
operator|-
name|ENOMEM
condition|)
block|{
comment|/* Do not reject to allow future retries. */
name|cm_reset_to_idle
argument_list|(
name|cm_id_priv
argument_list|)
expr_stmt|;
name|spin_unlock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|spin_unlock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
name|ib_send_cm_rej
argument_list|(
name|cm_id
argument_list|,
name|IB_CM_REJ_CONSUMER_DEFINED
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|IB_CM_MRA_REQ_RCVD
case|:
case|case
name|IB_CM_REP_SENT
case|:
case|case
name|IB_CM_MRA_REP_RCVD
case|:
name|ib_cancel_mad
argument_list|(
name|cm_id_priv
operator|->
name|av
operator|.
name|port
operator|->
name|mad_agent
argument_list|,
name|cm_id_priv
operator|->
name|msg
argument_list|)
expr_stmt|;
comment|/* Fall through */
case|case
name|IB_CM_MRA_REQ_SENT
case|:
case|case
name|IB_CM_REP_RCVD
case|:
case|case
name|IB_CM_MRA_REP_SENT
case|:
name|spin_unlock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
name|ib_send_cm_rej
argument_list|(
name|cm_id
argument_list|,
name|IB_CM_REJ_CONSUMER_DEFINED
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|IB_CM_ESTABLISHED
case|:
name|spin_unlock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|cm_id_priv
operator|->
name|qp_type
operator|==
name|IB_QPT_XRC_TGT
condition|)
break|break;
name|ib_send_cm_dreq
argument_list|(
name|cm_id
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
goto|goto
name|retest
goto|;
case|case
name|IB_CM_DREQ_SENT
case|:
name|ib_cancel_mad
argument_list|(
name|cm_id_priv
operator|->
name|av
operator|.
name|port
operator|->
name|mad_agent
argument_list|,
name|cm_id_priv
operator|->
name|msg
argument_list|)
expr_stmt|;
name|cm_enter_timewait
argument_list|(
name|cm_id_priv
argument_list|)
expr_stmt|;
name|spin_unlock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
break|break;
case|case
name|IB_CM_DREQ_RCVD
case|:
name|spin_unlock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
name|ib_send_cm_drep
argument_list|(
name|cm_id
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
default|default:
name|spin_unlock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
break|break;
block|}
name|cm_free_id
argument_list|(
name|cm_id
operator|->
name|local_id
argument_list|)
expr_stmt|;
name|cm_deref_id
argument_list|(
name|cm_id_priv
argument_list|)
expr_stmt|;
name|wait_for_completion
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|comp
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|work
operator|=
name|cm_dequeue_work
argument_list|(
name|cm_id_priv
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
name|cm_free_work
argument_list|(
name|work
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|cm_id_priv
operator|->
name|compare_data
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|cm_id_priv
operator|->
name|private_data
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|cm_id_priv
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ib_destroy_cm_id
parameter_list|(
name|struct
name|ib_cm_id
modifier|*
name|cm_id
parameter_list|)
block|{
name|cm_destroy_id
argument_list|(
name|cm_id
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL
argument_list|(
name|ib_destroy_cm_id
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
name|int
name|ib_cm_listen
parameter_list|(
name|struct
name|ib_cm_id
modifier|*
name|cm_id
parameter_list|,
name|__be64
name|service_id
parameter_list|,
name|__be64
name|service_mask
parameter_list|,
name|struct
name|ib_cm_compare_data
modifier|*
name|compare_data
parameter_list|)
block|{
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
decl_stmt|,
modifier|*
name|cur_cm_id_priv
decl_stmt|;
name|unsigned
name|long
name|flags
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|service_mask
operator|=
name|service_mask
condition|?
name|service_mask
else|:
operator|~
name|cpu_to_be64
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|service_id
operator|&=
name|service_mask
expr_stmt|;
if|if
condition|(
operator|(
name|service_id
operator|&
name|IB_SERVICE_ID_AGN_MASK
operator|)
operator|==
name|IB_CM_ASSIGN_SERVICE_ID
operator|&&
operator|(
name|service_id
operator|!=
name|IB_CM_ASSIGN_SERVICE_ID
operator|)
condition|)
return|return
operator|-
name|EINVAL
return|;
name|cm_id_priv
operator|=
name|container_of
argument_list|(
name|cm_id
argument_list|,
expr|struct
name|cm_id_private
argument_list|,
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
name|cm_id
operator|->
name|state
operator|!=
name|IB_CM_IDLE
condition|)
return|return
operator|-
name|EINVAL
return|;
if|if
condition|(
name|compare_data
condition|)
block|{
name|cm_id_priv
operator|->
name|compare_data
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
expr|*
name|compare_data
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cm_id_priv
operator|->
name|compare_data
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|cm_mask_copy
argument_list|(
name|cm_id_priv
operator|->
name|compare_data
operator|->
name|data
argument_list|,
name|compare_data
operator|->
name|data
argument_list|,
name|compare_data
operator|->
name|mask
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|cm_id_priv
operator|->
name|compare_data
operator|->
name|mask
argument_list|,
name|compare_data
operator|->
name|mask
argument_list|,
name|IB_CM_COMPARE_SIZE
argument_list|)
expr_stmt|;
block|}
name|cm_id
operator|->
name|state
operator|=
name|IB_CM_LISTEN
expr_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|cm
operator|.
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|service_id
operator|==
name|IB_CM_ASSIGN_SERVICE_ID
condition|)
block|{
name|cm_id
operator|->
name|service_id
operator|=
name|cpu_to_be64
argument_list|(
name|cm
operator|.
name|listen_service_id
operator|++
argument_list|)
expr_stmt|;
name|cm_id
operator|->
name|service_mask
operator|=
operator|~
name|cpu_to_be64
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|cm_id
operator|->
name|service_id
operator|=
name|service_id
expr_stmt|;
name|cm_id
operator|->
name|service_mask
operator|=
name|service_mask
expr_stmt|;
block|}
name|cur_cm_id_priv
operator|=
name|cm_insert_listen
argument_list|(
name|cm_id_priv
argument_list|)
expr_stmt|;
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|cm
operator|.
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|cur_cm_id_priv
condition|)
block|{
name|cm_id
operator|->
name|state
operator|=
name|IB_CM_IDLE
expr_stmt|;
name|kfree
argument_list|(
name|cm_id_priv
operator|->
name|compare_data
argument_list|)
expr_stmt|;
name|cm_id_priv
operator|->
name|compare_data
operator|=
name|NULL
expr_stmt|;
name|ret
operator|=
operator|-
name|EBUSY
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL
argument_list|(
name|ib_cm_listen
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|__be64
name|cm_form_tid
parameter_list|(
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
parameter_list|,
name|enum
name|cm_msg_sequence
name|msg_seq
parameter_list|)
block|{
name|u64
name|hi_tid
decl_stmt|,
name|low_tid
decl_stmt|;
name|hi_tid
operator|=
operator|(
operator|(
name|u64
operator|)
name|cm_id_priv
operator|->
name|av
operator|.
name|port
operator|->
name|mad_agent
operator|->
name|hi_tid
operator|)
operator|<<
literal|32
expr_stmt|;
name|low_tid
operator|=
call|(
name|u64
call|)
argument_list|(
operator|(
name|__force
name|u32
operator|)
name|cm_id_priv
operator|->
name|id
operator|.
name|local_id
operator||
operator|(
name|msg_seq
operator|<<
literal|30
operator|)
argument_list|)
expr_stmt|;
return|return
name|cpu_to_be64
argument_list|(
name|hi_tid
operator||
name|low_tid
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|cm_format_mad_hdr
parameter_list|(
name|struct
name|ib_mad_hdr
modifier|*
name|hdr
parameter_list|,
name|__be16
name|attr_id
parameter_list|,
name|__be64
name|tid
parameter_list|)
block|{
name|hdr
operator|->
name|base_version
operator|=
name|IB_MGMT_BASE_VERSION
expr_stmt|;
name|hdr
operator|->
name|mgmt_class
operator|=
name|IB_MGMT_CLASS_CM
expr_stmt|;
name|hdr
operator|->
name|class_version
operator|=
name|IB_CM_CLASS_VERSION
expr_stmt|;
name|hdr
operator|->
name|method
operator|=
name|IB_MGMT_METHOD_SEND
expr_stmt|;
name|hdr
operator|->
name|attr_id
operator|=
name|attr_id
expr_stmt|;
name|hdr
operator|->
name|tid
operator|=
name|tid
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|cm_format_req
parameter_list|(
name|struct
name|cm_req_msg
modifier|*
name|req_msg
parameter_list|,
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
parameter_list|,
name|struct
name|ib_cm_req_param
modifier|*
name|param
parameter_list|)
block|{
name|struct
name|ib_sa_path_rec
modifier|*
name|pri_path
init|=
name|param
operator|->
name|primary_path
decl_stmt|;
name|struct
name|ib_sa_path_rec
modifier|*
name|alt_path
init|=
name|param
operator|->
name|alternate_path
decl_stmt|;
name|cm_format_mad_hdr
argument_list|(
operator|&
name|req_msg
operator|->
name|hdr
argument_list|,
name|CM_REQ_ATTR_ID
argument_list|,
name|cm_form_tid
argument_list|(
name|cm_id_priv
argument_list|,
name|CM_MSG_SEQUENCE_REQ
argument_list|)
argument_list|)
expr_stmt|;
name|req_msg
operator|->
name|local_comm_id
operator|=
name|cm_id_priv
operator|->
name|id
operator|.
name|local_id
expr_stmt|;
name|req_msg
operator|->
name|service_id
operator|=
name|param
operator|->
name|service_id
expr_stmt|;
name|req_msg
operator|->
name|local_ca_guid
operator|=
name|cm_id_priv
operator|->
name|id
operator|.
name|device
operator|->
name|node_guid
expr_stmt|;
name|cm_req_set_local_qpn
argument_list|(
name|req_msg
argument_list|,
name|cpu_to_be32
argument_list|(
name|param
operator|->
name|qp_num
argument_list|)
argument_list|)
expr_stmt|;
name|cm_req_set_init_depth
argument_list|(
name|req_msg
argument_list|,
name|param
operator|->
name|initiator_depth
argument_list|)
expr_stmt|;
name|cm_req_set_remote_resp_timeout
argument_list|(
name|req_msg
argument_list|,
name|param
operator|->
name|remote_cm_response_timeout
argument_list|)
expr_stmt|;
name|cm_req_set_qp_type
argument_list|(
name|req_msg
argument_list|,
name|param
operator|->
name|qp_type
argument_list|)
expr_stmt|;
name|cm_req_set_flow_ctrl
argument_list|(
name|req_msg
argument_list|,
name|param
operator|->
name|flow_control
argument_list|)
expr_stmt|;
name|cm_req_set_starting_psn
argument_list|(
name|req_msg
argument_list|,
name|cpu_to_be32
argument_list|(
name|param
operator|->
name|starting_psn
argument_list|)
argument_list|)
expr_stmt|;
name|cm_req_set_local_resp_timeout
argument_list|(
name|req_msg
argument_list|,
name|param
operator|->
name|local_cm_response_timeout
argument_list|)
expr_stmt|;
name|req_msg
operator|->
name|pkey
operator|=
name|param
operator|->
name|primary_path
operator|->
name|pkey
expr_stmt|;
name|cm_req_set_path_mtu
argument_list|(
name|req_msg
argument_list|,
name|param
operator|->
name|primary_path
operator|->
name|mtu
argument_list|)
expr_stmt|;
name|cm_req_set_max_cm_retries
argument_list|(
name|req_msg
argument_list|,
name|param
operator|->
name|max_cm_retries
argument_list|)
expr_stmt|;
if|if
condition|(
name|param
operator|->
name|qp_type
operator|!=
name|IB_QPT_XRC_INI
condition|)
block|{
name|cm_req_set_resp_res
argument_list|(
name|req_msg
argument_list|,
name|param
operator|->
name|responder_resources
argument_list|)
expr_stmt|;
name|cm_req_set_retry_count
argument_list|(
name|req_msg
argument_list|,
name|param
operator|->
name|retry_count
argument_list|)
expr_stmt|;
name|cm_req_set_rnr_retry_count
argument_list|(
name|req_msg
argument_list|,
name|param
operator|->
name|rnr_retry_count
argument_list|)
expr_stmt|;
name|cm_req_set_srq
argument_list|(
name|req_msg
argument_list|,
name|param
operator|->
name|srq
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pri_path
operator|->
name|hop_limit
operator|<=
literal|1
condition|)
block|{
name|req_msg
operator|->
name|primary_local_lid
operator|=
name|pri_path
operator|->
name|slid
expr_stmt|;
name|req_msg
operator|->
name|primary_remote_lid
operator|=
name|pri_path
operator|->
name|dlid
expr_stmt|;
block|}
else|else
block|{
comment|/* Work-around until there's a way to obtain remote LID info */
name|req_msg
operator|->
name|primary_local_lid
operator|=
name|IB_LID_PERMISSIVE
expr_stmt|;
name|req_msg
operator|->
name|primary_remote_lid
operator|=
name|IB_LID_PERMISSIVE
expr_stmt|;
block|}
name|req_msg
operator|->
name|primary_local_gid
operator|=
name|pri_path
operator|->
name|sgid
expr_stmt|;
name|req_msg
operator|->
name|primary_remote_gid
operator|=
name|pri_path
operator|->
name|dgid
expr_stmt|;
name|cm_req_set_primary_flow_label
argument_list|(
name|req_msg
argument_list|,
name|pri_path
operator|->
name|flow_label
argument_list|)
expr_stmt|;
name|cm_req_set_primary_packet_rate
argument_list|(
name|req_msg
argument_list|,
name|pri_path
operator|->
name|rate
argument_list|)
expr_stmt|;
name|req_msg
operator|->
name|primary_traffic_class
operator|=
name|pri_path
operator|->
name|traffic_class
expr_stmt|;
name|req_msg
operator|->
name|primary_hop_limit
operator|=
name|pri_path
operator|->
name|hop_limit
expr_stmt|;
name|cm_req_set_primary_sl
argument_list|(
name|req_msg
argument_list|,
name|pri_path
operator|->
name|sl
argument_list|)
expr_stmt|;
name|cm_req_set_primary_subnet_local
argument_list|(
name|req_msg
argument_list|,
operator|(
name|pri_path
operator|->
name|hop_limit
operator|<=
literal|1
operator|)
argument_list|)
expr_stmt|;
name|cm_req_set_primary_local_ack_timeout
argument_list|(
name|req_msg
argument_list|,
name|cm_ack_timeout
argument_list|(
name|cm_id_priv
operator|->
name|av
operator|.
name|port
operator|->
name|cm_dev
operator|->
name|ack_delay
argument_list|,
name|pri_path
operator|->
name|packet_life_time
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|alt_path
condition|)
block|{
if|if
condition|(
name|alt_path
operator|->
name|hop_limit
operator|<=
literal|1
condition|)
block|{
name|req_msg
operator|->
name|alt_local_lid
operator|=
name|alt_path
operator|->
name|slid
expr_stmt|;
name|req_msg
operator|->
name|alt_remote_lid
operator|=
name|alt_path
operator|->
name|dlid
expr_stmt|;
block|}
else|else
block|{
name|req_msg
operator|->
name|alt_local_lid
operator|=
name|IB_LID_PERMISSIVE
expr_stmt|;
name|req_msg
operator|->
name|alt_remote_lid
operator|=
name|IB_LID_PERMISSIVE
expr_stmt|;
block|}
name|req_msg
operator|->
name|alt_local_gid
operator|=
name|alt_path
operator|->
name|sgid
expr_stmt|;
name|req_msg
operator|->
name|alt_remote_gid
operator|=
name|alt_path
operator|->
name|dgid
expr_stmt|;
name|cm_req_set_alt_flow_label
argument_list|(
name|req_msg
argument_list|,
name|alt_path
operator|->
name|flow_label
argument_list|)
expr_stmt|;
name|cm_req_set_alt_packet_rate
argument_list|(
name|req_msg
argument_list|,
name|alt_path
operator|->
name|rate
argument_list|)
expr_stmt|;
name|req_msg
operator|->
name|alt_traffic_class
operator|=
name|alt_path
operator|->
name|traffic_class
expr_stmt|;
name|req_msg
operator|->
name|alt_hop_limit
operator|=
name|alt_path
operator|->
name|hop_limit
expr_stmt|;
name|cm_req_set_alt_sl
argument_list|(
name|req_msg
argument_list|,
name|alt_path
operator|->
name|sl
argument_list|)
expr_stmt|;
name|cm_req_set_alt_subnet_local
argument_list|(
name|req_msg
argument_list|,
operator|(
name|alt_path
operator|->
name|hop_limit
operator|<=
literal|1
operator|)
argument_list|)
expr_stmt|;
name|cm_req_set_alt_local_ack_timeout
argument_list|(
name|req_msg
argument_list|,
name|cm_ack_timeout
argument_list|(
name|cm_id_priv
operator|->
name|av
operator|.
name|port
operator|->
name|cm_dev
operator|->
name|ack_delay
argument_list|,
name|alt_path
operator|->
name|packet_life_time
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|param
operator|->
name|private_data
operator|&&
name|param
operator|->
name|private_data_len
condition|)
name|memcpy
argument_list|(
name|req_msg
operator|->
name|private_data
argument_list|,
name|param
operator|->
name|private_data
argument_list|,
name|param
operator|->
name|private_data_len
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|cm_validate_req_param
parameter_list|(
name|struct
name|ib_cm_req_param
modifier|*
name|param
parameter_list|)
block|{
comment|/* peer-to-peer not supported */
if|if
condition|(
name|param
operator|->
name|peer_to_peer
condition|)
return|return
operator|-
name|EINVAL
return|;
if|if
condition|(
operator|!
name|param
operator|->
name|primary_path
condition|)
return|return
operator|-
name|EINVAL
return|;
if|if
condition|(
name|param
operator|->
name|qp_type
operator|!=
name|IB_QPT_RC
operator|&&
name|param
operator|->
name|qp_type
operator|!=
name|IB_QPT_UC
operator|&&
name|param
operator|->
name|qp_type
operator|!=
name|IB_QPT_XRC_INI
condition|)
return|return
operator|-
name|EINVAL
return|;
if|if
condition|(
name|param
operator|->
name|private_data
operator|&&
name|param
operator|->
name|private_data_len
operator|>
name|IB_CM_REQ_PRIVATE_DATA_SIZE
condition|)
return|return
operator|-
name|EINVAL
return|;
if|if
condition|(
name|param
operator|->
name|alternate_path
operator|&&
operator|(
name|param
operator|->
name|alternate_path
operator|->
name|pkey
operator|!=
name|param
operator|->
name|primary_path
operator|->
name|pkey
operator|||
name|param
operator|->
name|alternate_path
operator|->
name|mtu
operator|!=
name|param
operator|->
name|primary_path
operator|->
name|mtu
operator|)
condition|)
return|return
operator|-
name|EINVAL
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|ib_send_cm_req
parameter_list|(
name|struct
name|ib_cm_id
modifier|*
name|cm_id
parameter_list|,
name|struct
name|ib_cm_req_param
modifier|*
name|param
parameter_list|)
block|{
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
decl_stmt|;
name|struct
name|cm_req_msg
modifier|*
name|req_msg
decl_stmt|;
name|unsigned
name|long
name|flags
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|cm_validate_req_param
argument_list|(
name|param
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
comment|/* Verify that we're not in timewait. */
name|cm_id_priv
operator|=
name|container_of
argument_list|(
name|cm_id
argument_list|,
expr|struct
name|cm_id_private
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|cm_id
operator|->
name|state
operator|!=
name|IB_CM_IDLE
condition|)
block|{
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|cm_id_priv
operator|->
name|timewait_info
operator|=
name|cm_create_timewait_info
argument_list|(
name|cm_id_priv
operator|->
name|id
operator|.
name|local_id
argument_list|,
name|GFP_ATOMIC
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|cm_id_priv
operator|->
name|timewait_info
argument_list|)
condition|)
block|{
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
return|return
operator|(
name|PTR_ERR
argument_list|(
name|cm_id_priv
operator|->
name|timewait_info
argument_list|)
operator|)
return|;
block|}
name|ret
operator|=
name|cm_init_av_by_path
argument_list|(
name|param
operator|->
name|primary_path
argument_list|,
operator|&
name|cm_id_priv
operator|->
name|av
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
operator|&&
name|param
operator|->
name|alternate_path
condition|)
block|{
name|ret
operator|=
name|cm_init_av_by_path
argument_list|(
name|param
operator|->
name|alternate_path
argument_list|,
operator|&
name|cm_id_priv
operator|->
name|alt_av
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ret
condition|)
block|{
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
goto|goto
name|error1
goto|;
block|}
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|cm_id
operator|->
name|service_id
operator|=
name|param
operator|->
name|service_id
expr_stmt|;
name|cm_id
operator|->
name|service_mask
operator|=
operator|~
name|cpu_to_be64
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|cm_id_priv
operator|->
name|timeout_ms
operator|=
name|cm_convert_to_ms
argument_list|(
name|param
operator|->
name|primary_path
operator|->
name|packet_life_time
argument_list|)
operator|*
literal|2
operator|+
name|cm_convert_to_ms
argument_list|(
name|param
operator|->
name|remote_cm_response_timeout
argument_list|)
expr_stmt|;
name|cm_id_priv
operator|->
name|max_cm_retries
operator|=
name|param
operator|->
name|max_cm_retries
expr_stmt|;
name|cm_id_priv
operator|->
name|initiator_depth
operator|=
name|param
operator|->
name|initiator_depth
expr_stmt|;
name|cm_id_priv
operator|->
name|responder_resources
operator|=
name|param
operator|->
name|responder_resources
expr_stmt|;
name|cm_id_priv
operator|->
name|retry_count
operator|=
name|param
operator|->
name|retry_count
expr_stmt|;
name|cm_id_priv
operator|->
name|path_mtu
operator|=
name|param
operator|->
name|primary_path
operator|->
name|mtu
expr_stmt|;
name|cm_id_priv
operator|->
name|pkey
operator|=
name|param
operator|->
name|primary_path
operator|->
name|pkey
expr_stmt|;
name|cm_id_priv
operator|->
name|qp_type
operator|=
name|param
operator|->
name|qp_type
expr_stmt|;
name|ret
operator|=
name|cm_alloc_msg
argument_list|(
name|cm_id_priv
argument_list|,
operator|&
name|cm_id_priv
operator|->
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|error1
goto|;
name|req_msg
operator|=
operator|(
expr|struct
name|cm_req_msg
operator|*
operator|)
name|cm_id_priv
operator|->
name|msg
operator|->
name|mad
expr_stmt|;
name|cm_format_req
argument_list|(
name|req_msg
argument_list|,
name|cm_id_priv
argument_list|,
name|param
argument_list|)
expr_stmt|;
name|cm_id_priv
operator|->
name|tid
operator|=
name|req_msg
operator|->
name|hdr
operator|.
name|tid
expr_stmt|;
name|cm_id_priv
operator|->
name|msg
operator|->
name|timeout_ms
operator|=
name|cm_id_priv
operator|->
name|timeout_ms
expr_stmt|;
name|cm_id_priv
operator|->
name|msg
operator|->
name|context
index|[
literal|1
index|]
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
name|unsigned
name|long
operator|)
name|IB_CM_REQ_SENT
expr_stmt|;
name|cm_id_priv
operator|->
name|local_qpn
operator|=
name|cm_req_get_local_qpn
argument_list|(
name|req_msg
argument_list|)
expr_stmt|;
name|cm_id_priv
operator|->
name|rq_psn
operator|=
name|cm_req_get_starting_psn
argument_list|(
name|req_msg
argument_list|)
expr_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ib_post_send_mad
argument_list|(
name|cm_id_priv
operator|->
name|msg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
goto|goto
name|error2
goto|;
block|}
name|BUG_ON
argument_list|(
name|cm_id
operator|->
name|state
operator|!=
name|IB_CM_IDLE
argument_list|)
expr_stmt|;
name|cm_id
operator|->
name|state
operator|=
name|IB_CM_REQ_SENT
expr_stmt|;
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|error2
label|:
name|cm_free_msg
argument_list|(
name|cm_id_priv
operator|->
name|msg
argument_list|)
expr_stmt|;
name|error1
label|:
name|kfree
argument_list|(
name|cm_id_priv
operator|->
name|timewait_info
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL
argument_list|(
name|ib_send_cm_req
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|int
name|cm_issue_rej
parameter_list|(
name|struct
name|cm_port
modifier|*
name|port
parameter_list|,
name|struct
name|ib_mad_recv_wc
modifier|*
name|mad_recv_wc
parameter_list|,
name|enum
name|ib_cm_rej_reason
name|reason
parameter_list|,
name|enum
name|cm_msg_response
name|msg_rejected
parameter_list|,
name|void
modifier|*
name|ari
parameter_list|,
name|u8
name|ari_length
parameter_list|)
block|{
name|struct
name|ib_mad_send_buf
modifier|*
name|msg
init|=
name|NULL
decl_stmt|;
name|struct
name|cm_rej_msg
modifier|*
name|rej_msg
decl_stmt|,
modifier|*
name|rcv_msg
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|cm_alloc_response_msg
argument_list|(
name|port
argument_list|,
name|mad_recv_wc
argument_list|,
operator|&
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
comment|/* We just need common CM header information.  Cast to any message. */
name|rcv_msg
operator|=
operator|(
expr|struct
name|cm_rej_msg
operator|*
operator|)
name|mad_recv_wc
operator|->
name|recv_buf
operator|.
name|mad
expr_stmt|;
name|rej_msg
operator|=
operator|(
expr|struct
name|cm_rej_msg
operator|*
operator|)
name|msg
operator|->
name|mad
expr_stmt|;
name|cm_format_mad_hdr
argument_list|(
operator|&
name|rej_msg
operator|->
name|hdr
argument_list|,
name|CM_REJ_ATTR_ID
argument_list|,
name|rcv_msg
operator|->
name|hdr
operator|.
name|tid
argument_list|)
expr_stmt|;
name|rej_msg
operator|->
name|remote_comm_id
operator|=
name|rcv_msg
operator|->
name|local_comm_id
expr_stmt|;
name|rej_msg
operator|->
name|local_comm_id
operator|=
name|rcv_msg
operator|->
name|remote_comm_id
expr_stmt|;
name|cm_rej_set_msg_rejected
argument_list|(
name|rej_msg
argument_list|,
name|msg_rejected
argument_list|)
expr_stmt|;
name|rej_msg
operator|->
name|reason
operator|=
name|cpu_to_be16
argument_list|(
name|reason
argument_list|)
expr_stmt|;
if|if
condition|(
name|ari
operator|&&
name|ari_length
condition|)
block|{
name|cm_rej_set_reject_info_len
argument_list|(
name|rej_msg
argument_list|,
name|ari_length
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|rej_msg
operator|->
name|ari
argument_list|,
name|ari
argument_list|,
name|ari_length
argument_list|)
expr_stmt|;
block|}
name|ret
operator|=
name|ib_post_send_mad
argument_list|(
name|msg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|cm_free_msg
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|int
name|cm_is_active_peer
parameter_list|(
name|__be64
name|local_ca_guid
parameter_list|,
name|__be64
name|remote_ca_guid
parameter_list|,
name|__be32
name|local_qpn
parameter_list|,
name|__be32
name|remote_qpn
parameter_list|)
block|{
return|return
operator|(
name|be64_to_cpu
argument_list|(
name|local_ca_guid
argument_list|)
operator|>
name|be64_to_cpu
argument_list|(
name|remote_ca_guid
argument_list|)
operator|||
operator|(
operator|(
name|local_ca_guid
operator|==
name|remote_ca_guid
operator|)
operator|&&
operator|(
name|be32_to_cpu
argument_list|(
name|local_qpn
argument_list|)
operator|>
name|be32_to_cpu
argument_list|(
name|remote_qpn
argument_list|)
operator|)
operator|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|cm_format_paths_from_req
parameter_list|(
name|struct
name|cm_req_msg
modifier|*
name|req_msg
parameter_list|,
name|struct
name|ib_sa_path_rec
modifier|*
name|primary_path
parameter_list|,
name|struct
name|ib_sa_path_rec
modifier|*
name|alt_path
parameter_list|)
block|{
name|memset
argument_list|(
name|primary_path
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
expr|*
name|primary_path
argument_list|)
expr_stmt|;
name|primary_path
operator|->
name|dgid
operator|=
name|req_msg
operator|->
name|primary_local_gid
expr_stmt|;
name|primary_path
operator|->
name|sgid
operator|=
name|req_msg
operator|->
name|primary_remote_gid
expr_stmt|;
name|primary_path
operator|->
name|dlid
operator|=
name|req_msg
operator|->
name|primary_local_lid
expr_stmt|;
name|primary_path
operator|->
name|slid
operator|=
name|req_msg
operator|->
name|primary_remote_lid
expr_stmt|;
name|primary_path
operator|->
name|flow_label
operator|=
name|cm_req_get_primary_flow_label
argument_list|(
name|req_msg
argument_list|)
expr_stmt|;
name|primary_path
operator|->
name|hop_limit
operator|=
name|req_msg
operator|->
name|primary_hop_limit
expr_stmt|;
name|primary_path
operator|->
name|traffic_class
operator|=
name|req_msg
operator|->
name|primary_traffic_class
expr_stmt|;
name|primary_path
operator|->
name|reversible
operator|=
literal|1
expr_stmt|;
name|primary_path
operator|->
name|pkey
operator|=
name|req_msg
operator|->
name|pkey
expr_stmt|;
name|primary_path
operator|->
name|sl
operator|=
name|cm_req_get_primary_sl
argument_list|(
name|req_msg
argument_list|)
expr_stmt|;
name|primary_path
operator|->
name|mtu_selector
operator|=
name|IB_SA_EQ
expr_stmt|;
name|primary_path
operator|->
name|mtu
operator|=
name|cm_req_get_path_mtu
argument_list|(
name|req_msg
argument_list|)
expr_stmt|;
name|primary_path
operator|->
name|rate_selector
operator|=
name|IB_SA_EQ
expr_stmt|;
name|primary_path
operator|->
name|rate
operator|=
name|cm_req_get_primary_packet_rate
argument_list|(
name|req_msg
argument_list|)
expr_stmt|;
name|primary_path
operator|->
name|packet_life_time_selector
operator|=
name|IB_SA_EQ
expr_stmt|;
name|primary_path
operator|->
name|packet_life_time
operator|=
name|cm_req_get_primary_local_ack_timeout
argument_list|(
name|req_msg
argument_list|)
expr_stmt|;
name|primary_path
operator|->
name|packet_life_time
operator|-=
operator|(
name|primary_path
operator|->
name|packet_life_time
operator|>
literal|0
operator|)
expr_stmt|;
if|if
condition|(
name|req_msg
operator|->
name|alt_local_lid
condition|)
block|{
name|memset
argument_list|(
name|alt_path
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
expr|*
name|alt_path
argument_list|)
expr_stmt|;
name|alt_path
operator|->
name|dgid
operator|=
name|req_msg
operator|->
name|alt_local_gid
expr_stmt|;
name|alt_path
operator|->
name|sgid
operator|=
name|req_msg
operator|->
name|alt_remote_gid
expr_stmt|;
name|alt_path
operator|->
name|dlid
operator|=
name|req_msg
operator|->
name|alt_local_lid
expr_stmt|;
name|alt_path
operator|->
name|slid
operator|=
name|req_msg
operator|->
name|alt_remote_lid
expr_stmt|;
name|alt_path
operator|->
name|flow_label
operator|=
name|cm_req_get_alt_flow_label
argument_list|(
name|req_msg
argument_list|)
expr_stmt|;
name|alt_path
operator|->
name|hop_limit
operator|=
name|req_msg
operator|->
name|alt_hop_limit
expr_stmt|;
name|alt_path
operator|->
name|traffic_class
operator|=
name|req_msg
operator|->
name|alt_traffic_class
expr_stmt|;
name|alt_path
operator|->
name|reversible
operator|=
literal|1
expr_stmt|;
name|alt_path
operator|->
name|pkey
operator|=
name|req_msg
operator|->
name|pkey
expr_stmt|;
name|alt_path
operator|->
name|sl
operator|=
name|cm_req_get_alt_sl
argument_list|(
name|req_msg
argument_list|)
expr_stmt|;
name|alt_path
operator|->
name|mtu_selector
operator|=
name|IB_SA_EQ
expr_stmt|;
name|alt_path
operator|->
name|mtu
operator|=
name|cm_req_get_path_mtu
argument_list|(
name|req_msg
argument_list|)
expr_stmt|;
name|alt_path
operator|->
name|rate_selector
operator|=
name|IB_SA_EQ
expr_stmt|;
name|alt_path
operator|->
name|rate
operator|=
name|cm_req_get_alt_packet_rate
argument_list|(
name|req_msg
argument_list|)
expr_stmt|;
name|alt_path
operator|->
name|packet_life_time_selector
operator|=
name|IB_SA_EQ
expr_stmt|;
name|alt_path
operator|->
name|packet_life_time
operator|=
name|cm_req_get_alt_local_ack_timeout
argument_list|(
name|req_msg
argument_list|)
expr_stmt|;
name|alt_path
operator|->
name|packet_life_time
operator|-=
operator|(
name|alt_path
operator|->
name|packet_life_time
operator|>
literal|0
operator|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|cm_format_req_event
parameter_list|(
name|struct
name|cm_work
modifier|*
name|work
parameter_list|,
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
parameter_list|,
name|struct
name|ib_cm_id
modifier|*
name|listen_id
parameter_list|)
block|{
name|struct
name|cm_req_msg
modifier|*
name|req_msg
decl_stmt|;
name|struct
name|ib_cm_req_event_param
modifier|*
name|param
decl_stmt|;
name|req_msg
operator|=
operator|(
expr|struct
name|cm_req_msg
operator|*
operator|)
name|work
operator|->
name|mad_recv_wc
operator|->
name|recv_buf
operator|.
name|mad
expr_stmt|;
name|param
operator|=
operator|&
name|work
operator|->
name|cm_event
operator|.
name|param
operator|.
name|req_rcvd
expr_stmt|;
name|param
operator|->
name|listen_id
operator|=
name|listen_id
expr_stmt|;
name|param
operator|->
name|port
operator|=
name|cm_id_priv
operator|->
name|av
operator|.
name|port
operator|->
name|port_num
expr_stmt|;
name|param
operator|->
name|primary_path
operator|=
operator|&
name|work
operator|->
name|path
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|req_msg
operator|->
name|alt_local_lid
condition|)
name|param
operator|->
name|alternate_path
operator|=
operator|&
name|work
operator|->
name|path
index|[
literal|1
index|]
expr_stmt|;
else|else
name|param
operator|->
name|alternate_path
operator|=
name|NULL
expr_stmt|;
name|param
operator|->
name|remote_ca_guid
operator|=
name|req_msg
operator|->
name|local_ca_guid
expr_stmt|;
name|param
operator|->
name|remote_qkey
operator|=
name|be32_to_cpu
argument_list|(
name|req_msg
operator|->
name|local_qkey
argument_list|)
expr_stmt|;
name|param
operator|->
name|remote_qpn
operator|=
name|be32_to_cpu
argument_list|(
name|cm_req_get_local_qpn
argument_list|(
name|req_msg
argument_list|)
argument_list|)
expr_stmt|;
name|param
operator|->
name|qp_type
operator|=
name|cm_req_get_qp_type
argument_list|(
name|req_msg
argument_list|)
expr_stmt|;
name|param
operator|->
name|starting_psn
operator|=
name|be32_to_cpu
argument_list|(
name|cm_req_get_starting_psn
argument_list|(
name|req_msg
argument_list|)
argument_list|)
expr_stmt|;
name|param
operator|->
name|responder_resources
operator|=
name|cm_req_get_init_depth
argument_list|(
name|req_msg
argument_list|)
expr_stmt|;
name|param
operator|->
name|initiator_depth
operator|=
name|cm_req_get_resp_res
argument_list|(
name|req_msg
argument_list|)
expr_stmt|;
name|param
operator|->
name|local_cm_response_timeout
operator|=
name|cm_req_get_remote_resp_timeout
argument_list|(
name|req_msg
argument_list|)
expr_stmt|;
name|param
operator|->
name|flow_control
operator|=
name|cm_req_get_flow_ctrl
argument_list|(
name|req_msg
argument_list|)
expr_stmt|;
name|param
operator|->
name|remote_cm_response_timeout
operator|=
name|cm_req_get_local_resp_timeout
argument_list|(
name|req_msg
argument_list|)
expr_stmt|;
name|param
operator|->
name|retry_count
operator|=
name|cm_req_get_retry_count
argument_list|(
name|req_msg
argument_list|)
expr_stmt|;
name|param
operator|->
name|rnr_retry_count
operator|=
name|cm_req_get_rnr_retry_count
argument_list|(
name|req_msg
argument_list|)
expr_stmt|;
name|param
operator|->
name|srq
operator|=
name|cm_req_get_srq
argument_list|(
name|req_msg
argument_list|)
expr_stmt|;
name|work
operator|->
name|cm_event
operator|.
name|private_data
operator|=
operator|&
name|req_msg
operator|->
name|private_data
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|cm_process_work
parameter_list|(
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
parameter_list|,
name|struct
name|cm_work
modifier|*
name|work
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
comment|/* We will typically only have the current event to report. */
name|ret
operator|=
name|cm_id_priv
operator|->
name|id
operator|.
name|cm_handler
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|id
argument_list|,
operator|&
name|work
operator|->
name|cm_event
argument_list|)
expr_stmt|;
name|cm_free_work
argument_list|(
name|work
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
name|ret
operator|&&
operator|!
name|atomic_add_negative
argument_list|(
operator|-
literal|1
argument_list|,
operator|&
name|cm_id_priv
operator|->
name|work_count
argument_list|)
condition|)
block|{
name|spin_lock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
name|work
operator|=
name|cm_dequeue_work
argument_list|(
name|cm_id_priv
argument_list|)
expr_stmt|;
name|spin_unlock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
name|BUG_ON
argument_list|(
operator|!
name|work
argument_list|)
expr_stmt|;
name|ret
operator|=
name|cm_id_priv
operator|->
name|id
operator|.
name|cm_handler
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|id
argument_list|,
operator|&
name|work
operator|->
name|cm_event
argument_list|)
expr_stmt|;
name|cm_free_work
argument_list|(
name|work
argument_list|)
expr_stmt|;
block|}
name|cm_deref_id
argument_list|(
name|cm_id_priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|cm_destroy_id
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|id
argument_list|,
name|ret
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|cm_format_mra
parameter_list|(
name|struct
name|cm_mra_msg
modifier|*
name|mra_msg
parameter_list|,
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
parameter_list|,
name|enum
name|cm_msg_response
name|msg_mraed
parameter_list|,
name|u8
name|service_timeout
parameter_list|,
specifier|const
name|void
modifier|*
name|private_data
parameter_list|,
name|u8
name|private_data_len
parameter_list|)
block|{
name|cm_format_mad_hdr
argument_list|(
operator|&
name|mra_msg
operator|->
name|hdr
argument_list|,
name|CM_MRA_ATTR_ID
argument_list|,
name|cm_id_priv
operator|->
name|tid
argument_list|)
expr_stmt|;
name|cm_mra_set_msg_mraed
argument_list|(
name|mra_msg
argument_list|,
name|msg_mraed
argument_list|)
expr_stmt|;
name|mra_msg
operator|->
name|local_comm_id
operator|=
name|cm_id_priv
operator|->
name|id
operator|.
name|local_id
expr_stmt|;
name|mra_msg
operator|->
name|remote_comm_id
operator|=
name|cm_id_priv
operator|->
name|id
operator|.
name|remote_id
expr_stmt|;
name|cm_mra_set_service_timeout
argument_list|(
name|mra_msg
argument_list|,
name|service_timeout
argument_list|)
expr_stmt|;
if|if
condition|(
name|private_data
operator|&&
name|private_data_len
condition|)
name|memcpy
argument_list|(
name|mra_msg
operator|->
name|private_data
argument_list|,
name|private_data
argument_list|,
name|private_data_len
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|cm_format_rej
parameter_list|(
name|struct
name|cm_rej_msg
modifier|*
name|rej_msg
parameter_list|,
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
parameter_list|,
name|enum
name|ib_cm_rej_reason
name|reason
parameter_list|,
name|void
modifier|*
name|ari
parameter_list|,
name|u8
name|ari_length
parameter_list|,
specifier|const
name|void
modifier|*
name|private_data
parameter_list|,
name|u8
name|private_data_len
parameter_list|)
block|{
name|cm_format_mad_hdr
argument_list|(
operator|&
name|rej_msg
operator|->
name|hdr
argument_list|,
name|CM_REJ_ATTR_ID
argument_list|,
name|cm_id_priv
operator|->
name|tid
argument_list|)
expr_stmt|;
name|rej_msg
operator|->
name|remote_comm_id
operator|=
name|cm_id_priv
operator|->
name|id
operator|.
name|remote_id
expr_stmt|;
switch|switch
condition|(
name|cm_id_priv
operator|->
name|id
operator|.
name|state
condition|)
block|{
case|case
name|IB_CM_REQ_RCVD
case|:
name|rej_msg
operator|->
name|local_comm_id
operator|=
literal|0
expr_stmt|;
name|cm_rej_set_msg_rejected
argument_list|(
name|rej_msg
argument_list|,
name|CM_MSG_RESPONSE_REQ
argument_list|)
expr_stmt|;
break|break;
case|case
name|IB_CM_MRA_REQ_SENT
case|:
name|rej_msg
operator|->
name|local_comm_id
operator|=
name|cm_id_priv
operator|->
name|id
operator|.
name|local_id
expr_stmt|;
name|cm_rej_set_msg_rejected
argument_list|(
name|rej_msg
argument_list|,
name|CM_MSG_RESPONSE_REQ
argument_list|)
expr_stmt|;
break|break;
case|case
name|IB_CM_REP_RCVD
case|:
case|case
name|IB_CM_MRA_REP_SENT
case|:
name|rej_msg
operator|->
name|local_comm_id
operator|=
name|cm_id_priv
operator|->
name|id
operator|.
name|local_id
expr_stmt|;
name|cm_rej_set_msg_rejected
argument_list|(
name|rej_msg
argument_list|,
name|CM_MSG_RESPONSE_REP
argument_list|)
expr_stmt|;
break|break;
default|default:
name|rej_msg
operator|->
name|local_comm_id
operator|=
name|cm_id_priv
operator|->
name|id
operator|.
name|local_id
expr_stmt|;
name|cm_rej_set_msg_rejected
argument_list|(
name|rej_msg
argument_list|,
name|CM_MSG_RESPONSE_OTHER
argument_list|)
expr_stmt|;
break|break;
block|}
name|rej_msg
operator|->
name|reason
operator|=
name|cpu_to_be16
argument_list|(
name|reason
argument_list|)
expr_stmt|;
if|if
condition|(
name|ari
operator|&&
name|ari_length
condition|)
block|{
name|cm_rej_set_reject_info_len
argument_list|(
name|rej_msg
argument_list|,
name|ari_length
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|rej_msg
operator|->
name|ari
argument_list|,
name|ari
argument_list|,
name|ari_length
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|private_data
operator|&&
name|private_data_len
condition|)
name|memcpy
argument_list|(
name|rej_msg
operator|->
name|private_data
argument_list|,
name|private_data
argument_list|,
name|private_data_len
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|cm_dup_req_handler
parameter_list|(
name|struct
name|cm_work
modifier|*
name|work
parameter_list|,
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
parameter_list|)
block|{
name|struct
name|ib_mad_send_buf
modifier|*
name|msg
init|=
name|NULL
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|atomic_long_inc
argument_list|(
operator|&
name|work
operator|->
name|port
operator|->
name|counter_group
index|[
name|CM_RECV_DUPLICATES
index|]
operator|.
name|counter
index|[
name|CM_REQ_COUNTER
index|]
argument_list|)
expr_stmt|;
comment|/* Quick state check to discard duplicate REQs. */
if|if
condition|(
name|cm_id_priv
operator|->
name|id
operator|.
name|state
operator|==
name|IB_CM_REQ_RCVD
condition|)
return|return;
name|ret
operator|=
name|cm_alloc_response_msg
argument_list|(
name|work
operator|->
name|port
argument_list|,
name|work
operator|->
name|mad_recv_wc
argument_list|,
operator|&
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return;
name|spin_lock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cm_id_priv
operator|->
name|id
operator|.
name|state
condition|)
block|{
case|case
name|IB_CM_MRA_REQ_SENT
case|:
name|cm_format_mra
argument_list|(
operator|(
expr|struct
name|cm_mra_msg
operator|*
operator|)
name|msg
operator|->
name|mad
argument_list|,
name|cm_id_priv
argument_list|,
name|CM_MSG_RESPONSE_REQ
argument_list|,
name|cm_id_priv
operator|->
name|service_timeout
argument_list|,
name|cm_id_priv
operator|->
name|private_data
argument_list|,
name|cm_id_priv
operator|->
name|private_data_len
argument_list|)
expr_stmt|;
break|break;
case|case
name|IB_CM_TIMEWAIT
case|:
name|cm_format_rej
argument_list|(
operator|(
expr|struct
name|cm_rej_msg
operator|*
operator|)
name|msg
operator|->
name|mad
argument_list|,
name|cm_id_priv
argument_list|,
name|IB_CM_REJ_STALE_CONN
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
default|default:
goto|goto
name|unlock
goto|;
block|}
name|spin_unlock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ib_post_send_mad
argument_list|(
name|msg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|free
goto|;
return|return;
name|unlock
label|:
name|spin_unlock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
name|free
label|:
name|cm_free_msg
argument_list|(
name|msg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|cm_id_private
modifier|*
name|cm_match_req
parameter_list|(
name|struct
name|cm_work
modifier|*
name|work
parameter_list|,
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
parameter_list|)
block|{
name|struct
name|cm_id_private
modifier|*
name|listen_cm_id_priv
decl_stmt|,
modifier|*
name|cur_cm_id_priv
decl_stmt|;
name|struct
name|cm_timewait_info
modifier|*
name|timewait_info
decl_stmt|;
name|struct
name|cm_req_msg
modifier|*
name|req_msg
decl_stmt|;
name|req_msg
operator|=
operator|(
expr|struct
name|cm_req_msg
operator|*
operator|)
name|work
operator|->
name|mad_recv_wc
operator|->
name|recv_buf
operator|.
name|mad
expr_stmt|;
comment|/* Check for possible duplicate REQ. */
name|spin_lock_irq
argument_list|(
operator|&
name|cm
operator|.
name|lock
argument_list|)
expr_stmt|;
name|timewait_info
operator|=
name|cm_insert_remote_id
argument_list|(
name|cm_id_priv
operator|->
name|timewait_info
argument_list|)
expr_stmt|;
if|if
condition|(
name|timewait_info
condition|)
block|{
name|cur_cm_id_priv
operator|=
name|cm_get_id
argument_list|(
name|timewait_info
operator|->
name|work
operator|.
name|local_id
argument_list|,
name|timewait_info
operator|->
name|work
operator|.
name|remote_id
argument_list|)
expr_stmt|;
name|spin_unlock_irq
argument_list|(
operator|&
name|cm
operator|.
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|cur_cm_id_priv
condition|)
block|{
name|cm_dup_req_handler
argument_list|(
name|work
argument_list|,
name|cur_cm_id_priv
argument_list|)
expr_stmt|;
name|cm_deref_id
argument_list|(
name|cur_cm_id_priv
argument_list|)
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
comment|/* Check for stale connections. */
name|timewait_info
operator|=
name|cm_insert_remote_qpn
argument_list|(
name|cm_id_priv
operator|->
name|timewait_info
argument_list|)
expr_stmt|;
if|if
condition|(
name|timewait_info
condition|)
block|{
name|cm_cleanup_timewait
argument_list|(
name|cm_id_priv
operator|->
name|timewait_info
argument_list|)
expr_stmt|;
name|spin_unlock_irq
argument_list|(
operator|&
name|cm
operator|.
name|lock
argument_list|)
expr_stmt|;
name|cm_issue_rej
argument_list|(
name|work
operator|->
name|port
argument_list|,
name|work
operator|->
name|mad_recv_wc
argument_list|,
name|IB_CM_REJ_STALE_CONN
argument_list|,
name|CM_MSG_RESPONSE_REQ
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
comment|/* Find matching listen request. */
name|listen_cm_id_priv
operator|=
name|cm_find_listen
argument_list|(
name|cm_id_priv
operator|->
name|id
operator|.
name|device
argument_list|,
name|req_msg
operator|->
name|service_id
argument_list|,
name|req_msg
operator|->
name|private_data
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|listen_cm_id_priv
condition|)
block|{
name|cm_cleanup_timewait
argument_list|(
name|cm_id_priv
operator|->
name|timewait_info
argument_list|)
expr_stmt|;
name|spin_unlock_irq
argument_list|(
operator|&
name|cm
operator|.
name|lock
argument_list|)
expr_stmt|;
name|cm_issue_rej
argument_list|(
name|work
operator|->
name|port
argument_list|,
name|work
operator|->
name|mad_recv_wc
argument_list|,
name|IB_CM_REJ_INVALID_SERVICE_ID
argument_list|,
name|CM_MSG_RESPONSE_REQ
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|atomic_inc
argument_list|(
operator|&
name|listen_cm_id_priv
operator|->
name|refcount
argument_list|)
expr_stmt|;
name|atomic_inc
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|refcount
argument_list|)
expr_stmt|;
name|cm_id_priv
operator|->
name|id
operator|.
name|state
operator|=
name|IB_CM_REQ_RCVD
expr_stmt|;
name|atomic_inc
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|work_count
argument_list|)
expr_stmt|;
name|spin_unlock_irq
argument_list|(
operator|&
name|cm
operator|.
name|lock
argument_list|)
expr_stmt|;
name|out
label|:
return|return
name|listen_cm_id_priv
return|;
block|}
end_function

begin_comment
comment|/*  * Work-around for inter-subnet connections.  If the LIDs are permissive,  * we need to override the LID/SL data in the REQ with the LID information  * in the work completion.  */
end_comment

begin_function
specifier|static
name|void
name|cm_process_routed_req
parameter_list|(
name|struct
name|cm_req_msg
modifier|*
name|req_msg
parameter_list|,
name|struct
name|ib_wc
modifier|*
name|wc
parameter_list|)
block|{
if|if
condition|(
operator|!
name|cm_req_get_primary_subnet_local
argument_list|(
name|req_msg
argument_list|)
condition|)
block|{
if|if
condition|(
name|req_msg
operator|->
name|primary_local_lid
operator|==
name|IB_LID_PERMISSIVE
condition|)
block|{
name|req_msg
operator|->
name|primary_local_lid
operator|=
name|cpu_to_be16
argument_list|(
name|wc
operator|->
name|slid
argument_list|)
expr_stmt|;
name|cm_req_set_primary_sl
argument_list|(
name|req_msg
argument_list|,
name|wc
operator|->
name|sl
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|req_msg
operator|->
name|primary_remote_lid
operator|==
name|IB_LID_PERMISSIVE
condition|)
name|req_msg
operator|->
name|primary_remote_lid
operator|=
name|cpu_to_be16
argument_list|(
name|wc
operator|->
name|dlid_path_bits
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|cm_req_get_alt_subnet_local
argument_list|(
name|req_msg
argument_list|)
condition|)
block|{
if|if
condition|(
name|req_msg
operator|->
name|alt_local_lid
operator|==
name|IB_LID_PERMISSIVE
condition|)
block|{
name|req_msg
operator|->
name|alt_local_lid
operator|=
name|cpu_to_be16
argument_list|(
name|wc
operator|->
name|slid
argument_list|)
expr_stmt|;
name|cm_req_set_alt_sl
argument_list|(
name|req_msg
argument_list|,
name|wc
operator|->
name|sl
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|req_msg
operator|->
name|alt_remote_lid
operator|==
name|IB_LID_PERMISSIVE
condition|)
name|req_msg
operator|->
name|alt_remote_lid
operator|=
name|cpu_to_be16
argument_list|(
name|wc
operator|->
name|dlid_path_bits
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|cm_req_handler
parameter_list|(
name|struct
name|cm_work
modifier|*
name|work
parameter_list|)
block|{
name|struct
name|ib_cm_id
modifier|*
name|cm_id
decl_stmt|;
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
decl_stmt|,
modifier|*
name|listen_cm_id_priv
decl_stmt|;
name|struct
name|cm_req_msg
modifier|*
name|req_msg
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|req_msg
operator|=
operator|(
expr|struct
name|cm_req_msg
operator|*
operator|)
name|work
operator|->
name|mad_recv_wc
operator|->
name|recv_buf
operator|.
name|mad
expr_stmt|;
name|cm_id
operator|=
name|ib_create_cm_id
argument_list|(
name|work
operator|->
name|port
operator|->
name|cm_dev
operator|->
name|ib_device
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|cm_id
argument_list|)
condition|)
return|return
name|PTR_ERR
argument_list|(
name|cm_id
argument_list|)
return|;
name|cm_id_priv
operator|=
name|container_of
argument_list|(
name|cm_id
argument_list|,
expr|struct
name|cm_id_private
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|cm_id_priv
operator|->
name|id
operator|.
name|remote_id
operator|=
name|req_msg
operator|->
name|local_comm_id
expr_stmt|;
name|cm_init_av_for_response
argument_list|(
name|work
operator|->
name|port
argument_list|,
name|work
operator|->
name|mad_recv_wc
operator|->
name|wc
argument_list|,
name|work
operator|->
name|mad_recv_wc
operator|->
name|recv_buf
operator|.
name|grh
argument_list|,
operator|&
name|cm_id_priv
operator|->
name|av
argument_list|)
expr_stmt|;
name|cm_id_priv
operator|->
name|timewait_info
operator|=
name|cm_create_timewait_info
argument_list|(
name|cm_id_priv
operator|->
name|id
operator|.
name|local_id
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|cm_id_priv
operator|->
name|timewait_info
argument_list|)
condition|)
block|{
name|ret
operator|=
name|PTR_ERR
argument_list|(
name|cm_id_priv
operator|->
name|timewait_info
argument_list|)
expr_stmt|;
goto|goto
name|destroy
goto|;
block|}
name|cm_id_priv
operator|->
name|timewait_info
operator|->
name|work
operator|.
name|remote_id
operator|=
name|req_msg
operator|->
name|local_comm_id
expr_stmt|;
name|cm_id_priv
operator|->
name|timewait_info
operator|->
name|remote_ca_guid
operator|=
name|req_msg
operator|->
name|local_ca_guid
expr_stmt|;
name|cm_id_priv
operator|->
name|timewait_info
operator|->
name|remote_qpn
operator|=
name|cm_req_get_local_qpn
argument_list|(
name|req_msg
argument_list|)
expr_stmt|;
name|listen_cm_id_priv
operator|=
name|cm_match_req
argument_list|(
name|work
argument_list|,
name|cm_id_priv
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|listen_cm_id_priv
condition|)
block|{
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
name|kfree
argument_list|(
name|cm_id_priv
operator|->
name|timewait_info
argument_list|)
expr_stmt|;
goto|goto
name|destroy
goto|;
block|}
name|cm_id_priv
operator|->
name|id
operator|.
name|cm_handler
operator|=
name|listen_cm_id_priv
operator|->
name|id
operator|.
name|cm_handler
expr_stmt|;
name|cm_id_priv
operator|->
name|id
operator|.
name|context
operator|=
name|listen_cm_id_priv
operator|->
name|id
operator|.
name|context
expr_stmt|;
name|cm_id_priv
operator|->
name|id
operator|.
name|service_id
operator|=
name|req_msg
operator|->
name|service_id
expr_stmt|;
name|cm_id_priv
operator|->
name|id
operator|.
name|service_mask
operator|=
operator|~
name|cpu_to_be64
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|cm_process_routed_req
argument_list|(
name|req_msg
argument_list|,
name|work
operator|->
name|mad_recv_wc
operator|->
name|wc
argument_list|)
expr_stmt|;
name|cm_format_paths_from_req
argument_list|(
name|req_msg
argument_list|,
operator|&
name|work
operator|->
name|path
index|[
literal|0
index|]
argument_list|,
operator|&
name|work
operator|->
name|path
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
comment|/* Workarround: path in req_msg doesn't contain MAC, take it from wc */
name|memcpy
argument_list|(
name|work
operator|->
name|path
index|[
literal|0
index|]
operator|.
name|dmac
argument_list|,
name|cm_id_priv
operator|->
name|av
operator|.
name|ah_attr
operator|.
name|dmac
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|work
operator|->
name|path
index|[
literal|0
index|]
operator|.
name|vlan_id
operator|=
name|cm_id_priv
operator|->
name|av
operator|.
name|ah_attr
operator|.
name|vlan_id
expr_stmt|;
name|ret
operator|=
name|cm_init_av_by_path
argument_list|(
operator|&
name|work
operator|->
name|path
index|[
literal|0
index|]
argument_list|,
operator|&
name|cm_id_priv
operator|->
name|av
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|ib_get_cached_gid
argument_list|(
name|work
operator|->
name|port
operator|->
name|cm_dev
operator|->
name|ib_device
argument_list|,
name|work
operator|->
name|port
operator|->
name|port_num
argument_list|,
literal|0
argument_list|,
operator|&
name|work
operator|->
name|path
index|[
literal|0
index|]
operator|.
name|sgid
argument_list|)
expr_stmt|;
name|ib_send_cm_rej
argument_list|(
name|cm_id
argument_list|,
name|IB_CM_REJ_INVALID_GID
argument_list|,
operator|&
name|work
operator|->
name|path
index|[
literal|0
index|]
operator|.
name|sgid
argument_list|,
sizeof|sizeof
name|work
operator|->
name|path
index|[
literal|0
index|]
operator|.
name|sgid
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
goto|goto
name|rejected
goto|;
block|}
if|if
condition|(
name|req_msg
operator|->
name|alt_local_lid
condition|)
block|{
name|ret
operator|=
name|cm_init_av_by_path
argument_list|(
operator|&
name|work
operator|->
name|path
index|[
literal|1
index|]
argument_list|,
operator|&
name|cm_id_priv
operator|->
name|alt_av
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|ib_send_cm_rej
argument_list|(
name|cm_id
argument_list|,
name|IB_CM_REJ_INVALID_ALT_GID
argument_list|,
operator|&
name|work
operator|->
name|path
index|[
literal|0
index|]
operator|.
name|sgid
argument_list|,
sizeof|sizeof
name|work
operator|->
name|path
index|[
literal|0
index|]
operator|.
name|sgid
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
goto|goto
name|rejected
goto|;
block|}
block|}
name|cm_id_priv
operator|->
name|tid
operator|=
name|req_msg
operator|->
name|hdr
operator|.
name|tid
expr_stmt|;
name|cm_id_priv
operator|->
name|timeout_ms
operator|=
name|cm_convert_to_ms
argument_list|(
name|cm_req_get_local_resp_timeout
argument_list|(
name|req_msg
argument_list|)
argument_list|)
expr_stmt|;
name|cm_id_priv
operator|->
name|max_cm_retries
operator|=
name|cm_req_get_max_cm_retries
argument_list|(
name|req_msg
argument_list|)
expr_stmt|;
name|cm_id_priv
operator|->
name|remote_qpn
operator|=
name|cm_req_get_local_qpn
argument_list|(
name|req_msg
argument_list|)
expr_stmt|;
name|cm_id_priv
operator|->
name|initiator_depth
operator|=
name|cm_req_get_resp_res
argument_list|(
name|req_msg
argument_list|)
expr_stmt|;
name|cm_id_priv
operator|->
name|responder_resources
operator|=
name|cm_req_get_init_depth
argument_list|(
name|req_msg
argument_list|)
expr_stmt|;
name|cm_id_priv
operator|->
name|path_mtu
operator|=
name|cm_req_get_path_mtu
argument_list|(
name|req_msg
argument_list|)
expr_stmt|;
name|cm_id_priv
operator|->
name|pkey
operator|=
name|req_msg
operator|->
name|pkey
expr_stmt|;
name|cm_id_priv
operator|->
name|sq_psn
operator|=
name|cm_req_get_starting_psn
argument_list|(
name|req_msg
argument_list|)
expr_stmt|;
name|cm_id_priv
operator|->
name|retry_count
operator|=
name|cm_req_get_retry_count
argument_list|(
name|req_msg
argument_list|)
expr_stmt|;
name|cm_id_priv
operator|->
name|rnr_retry_count
operator|=
name|cm_req_get_rnr_retry_count
argument_list|(
name|req_msg
argument_list|)
expr_stmt|;
name|cm_id_priv
operator|->
name|qp_type
operator|=
name|cm_req_get_qp_type
argument_list|(
name|req_msg
argument_list|)
expr_stmt|;
name|cm_format_req_event
argument_list|(
name|work
argument_list|,
name|cm_id_priv
argument_list|,
operator|&
name|listen_cm_id_priv
operator|->
name|id
argument_list|)
expr_stmt|;
name|cm_process_work
argument_list|(
name|cm_id_priv
argument_list|,
name|work
argument_list|)
expr_stmt|;
name|cm_deref_id
argument_list|(
name|listen_cm_id_priv
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|rejected
label|:
name|atomic_dec
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|refcount
argument_list|)
expr_stmt|;
name|cm_deref_id
argument_list|(
name|listen_cm_id_priv
argument_list|)
expr_stmt|;
name|destroy
label|:
name|ib_destroy_cm_id
argument_list|(
name|cm_id
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|cm_format_rep
parameter_list|(
name|struct
name|cm_rep_msg
modifier|*
name|rep_msg
parameter_list|,
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
parameter_list|,
name|struct
name|ib_cm_rep_param
modifier|*
name|param
parameter_list|)
block|{
name|cm_format_mad_hdr
argument_list|(
operator|&
name|rep_msg
operator|->
name|hdr
argument_list|,
name|CM_REP_ATTR_ID
argument_list|,
name|cm_id_priv
operator|->
name|tid
argument_list|)
expr_stmt|;
name|rep_msg
operator|->
name|local_comm_id
operator|=
name|cm_id_priv
operator|->
name|id
operator|.
name|local_id
expr_stmt|;
name|rep_msg
operator|->
name|remote_comm_id
operator|=
name|cm_id_priv
operator|->
name|id
operator|.
name|remote_id
expr_stmt|;
name|cm_rep_set_starting_psn
argument_list|(
name|rep_msg
argument_list|,
name|cpu_to_be32
argument_list|(
name|param
operator|->
name|starting_psn
argument_list|)
argument_list|)
expr_stmt|;
name|rep_msg
operator|->
name|resp_resources
operator|=
name|param
operator|->
name|responder_resources
expr_stmt|;
name|cm_rep_set_target_ack_delay
argument_list|(
name|rep_msg
argument_list|,
name|cm_id_priv
operator|->
name|av
operator|.
name|port
operator|->
name|cm_dev
operator|->
name|ack_delay
argument_list|)
expr_stmt|;
name|cm_rep_set_failover
argument_list|(
name|rep_msg
argument_list|,
name|param
operator|->
name|failover_accepted
argument_list|)
expr_stmt|;
name|cm_rep_set_rnr_retry_count
argument_list|(
name|rep_msg
argument_list|,
name|param
operator|->
name|rnr_retry_count
argument_list|)
expr_stmt|;
name|rep_msg
operator|->
name|local_ca_guid
operator|=
name|cm_id_priv
operator|->
name|id
operator|.
name|device
operator|->
name|node_guid
expr_stmt|;
if|if
condition|(
name|cm_id_priv
operator|->
name|qp_type
operator|!=
name|IB_QPT_XRC_TGT
condition|)
block|{
name|rep_msg
operator|->
name|initiator_depth
operator|=
name|param
operator|->
name|initiator_depth
expr_stmt|;
name|cm_rep_set_flow_ctrl
argument_list|(
name|rep_msg
argument_list|,
name|param
operator|->
name|flow_control
argument_list|)
expr_stmt|;
name|cm_rep_set_srq
argument_list|(
name|rep_msg
argument_list|,
name|param
operator|->
name|srq
argument_list|)
expr_stmt|;
name|cm_rep_set_local_qpn
argument_list|(
name|rep_msg
argument_list|,
name|cpu_to_be32
argument_list|(
name|param
operator|->
name|qp_num
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|cm_rep_set_srq
argument_list|(
name|rep_msg
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|cm_rep_set_local_eecn
argument_list|(
name|rep_msg
argument_list|,
name|cpu_to_be32
argument_list|(
name|param
operator|->
name|qp_num
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|param
operator|->
name|private_data
operator|&&
name|param
operator|->
name|private_data_len
condition|)
name|memcpy
argument_list|(
name|rep_msg
operator|->
name|private_data
argument_list|,
name|param
operator|->
name|private_data
argument_list|,
name|param
operator|->
name|private_data_len
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|ib_send_cm_rep
parameter_list|(
name|struct
name|ib_cm_id
modifier|*
name|cm_id
parameter_list|,
name|struct
name|ib_cm_rep_param
modifier|*
name|param
parameter_list|)
block|{
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
decl_stmt|;
name|struct
name|ib_mad_send_buf
modifier|*
name|msg
decl_stmt|;
name|struct
name|cm_rep_msg
modifier|*
name|rep_msg
decl_stmt|;
name|unsigned
name|long
name|flags
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|param
operator|->
name|private_data
operator|&&
name|param
operator|->
name|private_data_len
operator|>
name|IB_CM_REP_PRIVATE_DATA_SIZE
condition|)
return|return
operator|-
name|EINVAL
return|;
name|cm_id_priv
operator|=
name|container_of
argument_list|(
name|cm_id
argument_list|,
expr|struct
name|cm_id_private
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|cm_id
operator|->
name|state
operator|!=
name|IB_CM_REQ_RCVD
operator|&&
name|cm_id
operator|->
name|state
operator|!=
name|IB_CM_MRA_REQ_SENT
condition|)
block|{
name|pr_debug
argument_list|(
literal|"cm_id->state: %d\n"
argument_list|,
name|cm_id
operator|->
name|state
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|cm_alloc_msg
argument_list|(
name|cm_id_priv
argument_list|,
operator|&
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|rep_msg
operator|=
operator|(
expr|struct
name|cm_rep_msg
operator|*
operator|)
name|msg
operator|->
name|mad
expr_stmt|;
name|cm_format_rep
argument_list|(
name|rep_msg
argument_list|,
name|cm_id_priv
argument_list|,
name|param
argument_list|)
expr_stmt|;
name|msg
operator|->
name|timeout_ms
operator|=
name|cm_id_priv
operator|->
name|timeout_ms
expr_stmt|;
name|msg
operator|->
name|context
index|[
literal|1
index|]
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
name|unsigned
name|long
operator|)
name|IB_CM_REP_SENT
expr_stmt|;
name|ret
operator|=
name|ib_post_send_mad
argument_list|(
name|msg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|cm_free_msg
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|cm_id
operator|->
name|state
operator|=
name|IB_CM_REP_SENT
expr_stmt|;
name|cm_id_priv
operator|->
name|msg
operator|=
name|msg
expr_stmt|;
name|cm_id_priv
operator|->
name|initiator_depth
operator|=
name|param
operator|->
name|initiator_depth
expr_stmt|;
name|cm_id_priv
operator|->
name|responder_resources
operator|=
name|param
operator|->
name|responder_resources
expr_stmt|;
name|cm_id_priv
operator|->
name|rq_psn
operator|=
name|cm_rep_get_starting_psn
argument_list|(
name|rep_msg
argument_list|)
expr_stmt|;
name|cm_id_priv
operator|->
name|local_qpn
operator|=
name|cpu_to_be32
argument_list|(
name|param
operator|->
name|qp_num
operator|&
literal|0xFFFFFF
argument_list|)
expr_stmt|;
name|out
label|:
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL
argument_list|(
name|ib_send_cm_rep
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|void
name|cm_format_rtu
parameter_list|(
name|struct
name|cm_rtu_msg
modifier|*
name|rtu_msg
parameter_list|,
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
parameter_list|,
specifier|const
name|void
modifier|*
name|private_data
parameter_list|,
name|u8
name|private_data_len
parameter_list|)
block|{
name|cm_format_mad_hdr
argument_list|(
operator|&
name|rtu_msg
operator|->
name|hdr
argument_list|,
name|CM_RTU_ATTR_ID
argument_list|,
name|cm_id_priv
operator|->
name|tid
argument_list|)
expr_stmt|;
name|rtu_msg
operator|->
name|local_comm_id
operator|=
name|cm_id_priv
operator|->
name|id
operator|.
name|local_id
expr_stmt|;
name|rtu_msg
operator|->
name|remote_comm_id
operator|=
name|cm_id_priv
operator|->
name|id
operator|.
name|remote_id
expr_stmt|;
if|if
condition|(
name|private_data
operator|&&
name|private_data_len
condition|)
name|memcpy
argument_list|(
name|rtu_msg
operator|->
name|private_data
argument_list|,
name|private_data
argument_list|,
name|private_data_len
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|ib_send_cm_rtu
parameter_list|(
name|struct
name|ib_cm_id
modifier|*
name|cm_id
parameter_list|,
specifier|const
name|void
modifier|*
name|private_data
parameter_list|,
name|u8
name|private_data_len
parameter_list|)
block|{
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
decl_stmt|;
name|struct
name|ib_mad_send_buf
modifier|*
name|msg
decl_stmt|;
name|unsigned
name|long
name|flags
decl_stmt|;
name|void
modifier|*
name|data
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|private_data
operator|&&
name|private_data_len
operator|>
name|IB_CM_RTU_PRIVATE_DATA_SIZE
condition|)
return|return
operator|-
name|EINVAL
return|;
name|data
operator|=
name|cm_copy_private_data
argument_list|(
name|private_data
argument_list|,
name|private_data_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|data
argument_list|)
condition|)
return|return
name|PTR_ERR
argument_list|(
name|data
argument_list|)
return|;
name|cm_id_priv
operator|=
name|container_of
argument_list|(
name|cm_id
argument_list|,
expr|struct
name|cm_id_private
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|cm_id
operator|->
name|state
operator|!=
name|IB_CM_REP_RCVD
operator|&&
name|cm_id
operator|->
name|state
operator|!=
name|IB_CM_MRA_REP_SENT
condition|)
block|{
name|pr_debug
argument_list|(
literal|"cm_id->state: %d\n"
argument_list|,
name|cm_id
operator|->
name|state
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|ret
operator|=
name|cm_alloc_msg
argument_list|(
name|cm_id_priv
argument_list|,
operator|&
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|error
goto|;
name|cm_format_rtu
argument_list|(
operator|(
expr|struct
name|cm_rtu_msg
operator|*
operator|)
name|msg
operator|->
name|mad
argument_list|,
name|cm_id_priv
argument_list|,
name|private_data
argument_list|,
name|private_data_len
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ib_post_send_mad
argument_list|(
name|msg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|cm_free_msg
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|cm_id
operator|->
name|state
operator|=
name|IB_CM_ESTABLISHED
expr_stmt|;
name|cm_set_private_data
argument_list|(
name|cm_id_priv
argument_list|,
name|data
argument_list|,
name|private_data_len
argument_list|)
expr_stmt|;
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|error
label|:
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL
argument_list|(
name|ib_send_cm_rtu
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|void
name|cm_format_rep_event
parameter_list|(
name|struct
name|cm_work
modifier|*
name|work
parameter_list|,
name|enum
name|ib_qp_type
name|qp_type
parameter_list|)
block|{
name|struct
name|cm_rep_msg
modifier|*
name|rep_msg
decl_stmt|;
name|struct
name|ib_cm_rep_event_param
modifier|*
name|param
decl_stmt|;
name|rep_msg
operator|=
operator|(
expr|struct
name|cm_rep_msg
operator|*
operator|)
name|work
operator|->
name|mad_recv_wc
operator|->
name|recv_buf
operator|.
name|mad
expr_stmt|;
name|param
operator|=
operator|&
name|work
operator|->
name|cm_event
operator|.
name|param
operator|.
name|rep_rcvd
expr_stmt|;
name|param
operator|->
name|remote_ca_guid
operator|=
name|rep_msg
operator|->
name|local_ca_guid
expr_stmt|;
name|param
operator|->
name|remote_qkey
operator|=
name|be32_to_cpu
argument_list|(
name|rep_msg
operator|->
name|local_qkey
argument_list|)
expr_stmt|;
name|param
operator|->
name|remote_qpn
operator|=
name|be32_to_cpu
argument_list|(
name|cm_rep_get_qpn
argument_list|(
name|rep_msg
argument_list|,
name|qp_type
argument_list|)
argument_list|)
expr_stmt|;
name|param
operator|->
name|starting_psn
operator|=
name|be32_to_cpu
argument_list|(
name|cm_rep_get_starting_psn
argument_list|(
name|rep_msg
argument_list|)
argument_list|)
expr_stmt|;
name|param
operator|->
name|responder_resources
operator|=
name|rep_msg
operator|->
name|initiator_depth
expr_stmt|;
name|param
operator|->
name|initiator_depth
operator|=
name|rep_msg
operator|->
name|resp_resources
expr_stmt|;
name|param
operator|->
name|target_ack_delay
operator|=
name|cm_rep_get_target_ack_delay
argument_list|(
name|rep_msg
argument_list|)
expr_stmt|;
name|param
operator|->
name|failover_accepted
operator|=
name|cm_rep_get_failover
argument_list|(
name|rep_msg
argument_list|)
expr_stmt|;
name|param
operator|->
name|flow_control
operator|=
name|cm_rep_get_flow_ctrl
argument_list|(
name|rep_msg
argument_list|)
expr_stmt|;
name|param
operator|->
name|rnr_retry_count
operator|=
name|cm_rep_get_rnr_retry_count
argument_list|(
name|rep_msg
argument_list|)
expr_stmt|;
name|param
operator|->
name|srq
operator|=
name|cm_rep_get_srq
argument_list|(
name|rep_msg
argument_list|)
expr_stmt|;
name|work
operator|->
name|cm_event
operator|.
name|private_data
operator|=
operator|&
name|rep_msg
operator|->
name|private_data
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|cm_dup_rep_handler
parameter_list|(
name|struct
name|cm_work
modifier|*
name|work
parameter_list|)
block|{
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
decl_stmt|;
name|struct
name|cm_rep_msg
modifier|*
name|rep_msg
decl_stmt|;
name|struct
name|ib_mad_send_buf
modifier|*
name|msg
init|=
name|NULL
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|rep_msg
operator|=
operator|(
expr|struct
name|cm_rep_msg
operator|*
operator|)
name|work
operator|->
name|mad_recv_wc
operator|->
name|recv_buf
operator|.
name|mad
expr_stmt|;
name|cm_id_priv
operator|=
name|cm_acquire_id
argument_list|(
name|rep_msg
operator|->
name|remote_comm_id
argument_list|,
name|rep_msg
operator|->
name|local_comm_id
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cm_id_priv
condition|)
return|return;
name|atomic_long_inc
argument_list|(
operator|&
name|work
operator|->
name|port
operator|->
name|counter_group
index|[
name|CM_RECV_DUPLICATES
index|]
operator|.
name|counter
index|[
name|CM_REP_COUNTER
index|]
argument_list|)
expr_stmt|;
name|ret
operator|=
name|cm_alloc_response_msg
argument_list|(
name|work
operator|->
name|port
argument_list|,
name|work
operator|->
name|mad_recv_wc
argument_list|,
operator|&
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|deref
goto|;
name|spin_lock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|cm_id_priv
operator|->
name|id
operator|.
name|state
operator|==
name|IB_CM_ESTABLISHED
condition|)
name|cm_format_rtu
argument_list|(
operator|(
expr|struct
name|cm_rtu_msg
operator|*
operator|)
name|msg
operator|->
name|mad
argument_list|,
name|cm_id_priv
argument_list|,
name|cm_id_priv
operator|->
name|private_data
argument_list|,
name|cm_id_priv
operator|->
name|private_data_len
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|cm_id_priv
operator|->
name|id
operator|.
name|state
operator|==
name|IB_CM_MRA_REP_SENT
condition|)
name|cm_format_mra
argument_list|(
operator|(
expr|struct
name|cm_mra_msg
operator|*
operator|)
name|msg
operator|->
name|mad
argument_list|,
name|cm_id_priv
argument_list|,
name|CM_MSG_RESPONSE_REP
argument_list|,
name|cm_id_priv
operator|->
name|service_timeout
argument_list|,
name|cm_id_priv
operator|->
name|private_data
argument_list|,
name|cm_id_priv
operator|->
name|private_data_len
argument_list|)
expr_stmt|;
else|else
goto|goto
name|unlock
goto|;
name|spin_unlock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ib_post_send_mad
argument_list|(
name|msg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|free
goto|;
goto|goto
name|deref
goto|;
name|unlock
label|:
name|spin_unlock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
name|free
label|:
name|cm_free_msg
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|deref
label|:
name|cm_deref_id
argument_list|(
name|cm_id_priv
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|cm_rep_handler
parameter_list|(
name|struct
name|cm_work
modifier|*
name|work
parameter_list|)
block|{
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
decl_stmt|;
name|struct
name|cm_rep_msg
modifier|*
name|rep_msg
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|rep_msg
operator|=
operator|(
expr|struct
name|cm_rep_msg
operator|*
operator|)
name|work
operator|->
name|mad_recv_wc
operator|->
name|recv_buf
operator|.
name|mad
expr_stmt|;
name|cm_id_priv
operator|=
name|cm_acquire_id
argument_list|(
name|rep_msg
operator|->
name|remote_comm_id
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cm_id_priv
condition|)
block|{
name|cm_dup_rep_handler
argument_list|(
name|work
argument_list|)
expr_stmt|;
name|pr_debug
argument_list|(
literal|"no cm_id_priv\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|cm_format_rep_event
argument_list|(
name|work
argument_list|,
name|cm_id_priv
operator|->
name|qp_type
argument_list|)
expr_stmt|;
name|spin_lock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cm_id_priv
operator|->
name|id
operator|.
name|state
condition|)
block|{
case|case
name|IB_CM_REQ_SENT
case|:
case|case
name|IB_CM_MRA_REQ_RCVD
case|:
break|break;
default|default:
name|spin_unlock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
name|pr_debug
argument_list|(
literal|"cm_id_priv->id.state: %d\n"
argument_list|,
name|cm_id_priv
operator|->
name|id
operator|.
name|state
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|cm_id_priv
operator|->
name|timewait_info
operator|->
name|work
operator|.
name|remote_id
operator|=
name|rep_msg
operator|->
name|local_comm_id
expr_stmt|;
name|cm_id_priv
operator|->
name|timewait_info
operator|->
name|remote_ca_guid
operator|=
name|rep_msg
operator|->
name|local_ca_guid
expr_stmt|;
name|cm_id_priv
operator|->
name|timewait_info
operator|->
name|remote_qpn
operator|=
name|cm_rep_get_qpn
argument_list|(
name|rep_msg
argument_list|,
name|cm_id_priv
operator|->
name|qp_type
argument_list|)
expr_stmt|;
name|spin_lock
argument_list|(
operator|&
name|cm
operator|.
name|lock
argument_list|)
expr_stmt|;
comment|/* Check for duplicate REP. */
if|if
condition|(
name|cm_insert_remote_id
argument_list|(
name|cm_id_priv
operator|->
name|timewait_info
argument_list|)
condition|)
block|{
name|spin_unlock
argument_list|(
operator|&
name|cm
operator|.
name|lock
argument_list|)
expr_stmt|;
name|spin_unlock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
name|pr_debug
argument_list|(
literal|"Failed to insert remote id\n"
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
comment|/* Check for a stale connection. */
if|if
condition|(
name|cm_insert_remote_qpn
argument_list|(
name|cm_id_priv
operator|->
name|timewait_info
argument_list|)
condition|)
block|{
name|rb_erase
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|timewait_info
operator|->
name|remote_id_node
argument_list|,
operator|&
name|cm
operator|.
name|remote_id_table
argument_list|)
expr_stmt|;
name|cm_id_priv
operator|->
name|timewait_info
operator|->
name|inserted_remote_id
operator|=
literal|0
expr_stmt|;
name|spin_unlock
argument_list|(
operator|&
name|cm
operator|.
name|lock
argument_list|)
expr_stmt|;
name|spin_unlock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
name|cm_issue_rej
argument_list|(
name|work
operator|->
name|port
argument_list|,
name|work
operator|->
name|mad_recv_wc
argument_list|,
name|IB_CM_REJ_STALE_CONN
argument_list|,
name|CM_MSG_RESPONSE_REP
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
name|pr_debug
argument_list|(
literal|"Stale connection.\n"
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|spin_unlock
argument_list|(
operator|&
name|cm
operator|.
name|lock
argument_list|)
expr_stmt|;
name|cm_id_priv
operator|->
name|id
operator|.
name|state
operator|=
name|IB_CM_REP_RCVD
expr_stmt|;
name|cm_id_priv
operator|->
name|id
operator|.
name|remote_id
operator|=
name|rep_msg
operator|->
name|local_comm_id
expr_stmt|;
name|cm_id_priv
operator|->
name|remote_qpn
operator|=
name|cm_rep_get_qpn
argument_list|(
name|rep_msg
argument_list|,
name|cm_id_priv
operator|->
name|qp_type
argument_list|)
expr_stmt|;
name|cm_id_priv
operator|->
name|initiator_depth
operator|=
name|rep_msg
operator|->
name|resp_resources
expr_stmt|;
name|cm_id_priv
operator|->
name|responder_resources
operator|=
name|rep_msg
operator|->
name|initiator_depth
expr_stmt|;
name|cm_id_priv
operator|->
name|sq_psn
operator|=
name|cm_rep_get_starting_psn
argument_list|(
name|rep_msg
argument_list|)
expr_stmt|;
name|cm_id_priv
operator|->
name|rnr_retry_count
operator|=
name|cm_rep_get_rnr_retry_count
argument_list|(
name|rep_msg
argument_list|)
expr_stmt|;
name|cm_id_priv
operator|->
name|target_ack_delay
operator|=
name|cm_rep_get_target_ack_delay
argument_list|(
name|rep_msg
argument_list|)
expr_stmt|;
name|cm_id_priv
operator|->
name|av
operator|.
name|timeout
operator|=
name|cm_ack_timeout
argument_list|(
name|cm_id_priv
operator|->
name|target_ack_delay
argument_list|,
name|cm_id_priv
operator|->
name|av
operator|.
name|timeout
operator|-
literal|1
argument_list|)
expr_stmt|;
name|cm_id_priv
operator|->
name|alt_av
operator|.
name|timeout
operator|=
name|cm_ack_timeout
argument_list|(
name|cm_id_priv
operator|->
name|target_ack_delay
argument_list|,
name|cm_id_priv
operator|->
name|alt_av
operator|.
name|timeout
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* todo: handle peer_to_peer */
name|ib_cancel_mad
argument_list|(
name|cm_id_priv
operator|->
name|av
operator|.
name|port
operator|->
name|mad_agent
argument_list|,
name|cm_id_priv
operator|->
name|msg
argument_list|)
expr_stmt|;
name|ret
operator|=
name|atomic_inc_and_test
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|work_count
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
name|list_add_tail
argument_list|(
operator|&
name|work
operator|->
name|list
argument_list|,
operator|&
name|cm_id_priv
operator|->
name|work_list
argument_list|)
expr_stmt|;
name|spin_unlock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|cm_process_work
argument_list|(
name|cm_id_priv
argument_list|,
name|work
argument_list|)
expr_stmt|;
else|else
name|cm_deref_id
argument_list|(
name|cm_id_priv
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|error
label|:
name|cm_deref_id
argument_list|(
name|cm_id_priv
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cm_establish_handler
parameter_list|(
name|struct
name|cm_work
modifier|*
name|work
parameter_list|)
block|{
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
decl_stmt|;
name|int
name|ret
decl_stmt|;
comment|/* See comment in cm_establish about lookup. */
name|cm_id_priv
operator|=
name|cm_acquire_id
argument_list|(
name|work
operator|->
name|local_id
argument_list|,
name|work
operator|->
name|remote_id
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cm_id_priv
condition|)
return|return
operator|-
name|EINVAL
return|;
name|spin_lock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|cm_id_priv
operator|->
name|id
operator|.
name|state
operator|!=
name|IB_CM_ESTABLISHED
condition|)
block|{
name|spin_unlock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ib_cancel_mad
argument_list|(
name|cm_id_priv
operator|->
name|av
operator|.
name|port
operator|->
name|mad_agent
argument_list|,
name|cm_id_priv
operator|->
name|msg
argument_list|)
expr_stmt|;
name|ret
operator|=
name|atomic_inc_and_test
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|work_count
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
name|list_add_tail
argument_list|(
operator|&
name|work
operator|->
name|list
argument_list|,
operator|&
name|cm_id_priv
operator|->
name|work_list
argument_list|)
expr_stmt|;
name|spin_unlock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|cm_process_work
argument_list|(
name|cm_id_priv
argument_list|,
name|work
argument_list|)
expr_stmt|;
else|else
name|cm_deref_id
argument_list|(
name|cm_id_priv
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|out
label|:
name|cm_deref_id
argument_list|(
name|cm_id_priv
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cm_rtu_handler
parameter_list|(
name|struct
name|cm_work
modifier|*
name|work
parameter_list|)
block|{
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
decl_stmt|;
name|struct
name|cm_rtu_msg
modifier|*
name|rtu_msg
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|rtu_msg
operator|=
operator|(
expr|struct
name|cm_rtu_msg
operator|*
operator|)
name|work
operator|->
name|mad_recv_wc
operator|->
name|recv_buf
operator|.
name|mad
expr_stmt|;
name|cm_id_priv
operator|=
name|cm_acquire_id
argument_list|(
name|rtu_msg
operator|->
name|remote_comm_id
argument_list|,
name|rtu_msg
operator|->
name|local_comm_id
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cm_id_priv
condition|)
return|return
operator|-
name|EINVAL
return|;
name|work
operator|->
name|cm_event
operator|.
name|private_data
operator|=
operator|&
name|rtu_msg
operator|->
name|private_data
expr_stmt|;
name|spin_lock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|cm_id_priv
operator|->
name|id
operator|.
name|state
operator|!=
name|IB_CM_REP_SENT
operator|&&
name|cm_id_priv
operator|->
name|id
operator|.
name|state
operator|!=
name|IB_CM_MRA_REP_RCVD
condition|)
block|{
name|spin_unlock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
name|atomic_long_inc
argument_list|(
operator|&
name|work
operator|->
name|port
operator|->
name|counter_group
index|[
name|CM_RECV_DUPLICATES
index|]
operator|.
name|counter
index|[
name|CM_RTU_COUNTER
index|]
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|cm_id_priv
operator|->
name|id
operator|.
name|state
operator|=
name|IB_CM_ESTABLISHED
expr_stmt|;
name|ib_cancel_mad
argument_list|(
name|cm_id_priv
operator|->
name|av
operator|.
name|port
operator|->
name|mad_agent
argument_list|,
name|cm_id_priv
operator|->
name|msg
argument_list|)
expr_stmt|;
name|ret
operator|=
name|atomic_inc_and_test
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|work_count
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
name|list_add_tail
argument_list|(
operator|&
name|work
operator|->
name|list
argument_list|,
operator|&
name|cm_id_priv
operator|->
name|work_list
argument_list|)
expr_stmt|;
name|spin_unlock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|cm_process_work
argument_list|(
name|cm_id_priv
argument_list|,
name|work
argument_list|)
expr_stmt|;
else|else
name|cm_deref_id
argument_list|(
name|cm_id_priv
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|out
label|:
name|cm_deref_id
argument_list|(
name|cm_id_priv
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|cm_format_dreq
parameter_list|(
name|struct
name|cm_dreq_msg
modifier|*
name|dreq_msg
parameter_list|,
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
parameter_list|,
specifier|const
name|void
modifier|*
name|private_data
parameter_list|,
name|u8
name|private_data_len
parameter_list|)
block|{
name|cm_format_mad_hdr
argument_list|(
operator|&
name|dreq_msg
operator|->
name|hdr
argument_list|,
name|CM_DREQ_ATTR_ID
argument_list|,
name|cm_form_tid
argument_list|(
name|cm_id_priv
argument_list|,
name|CM_MSG_SEQUENCE_DREQ
argument_list|)
argument_list|)
expr_stmt|;
name|dreq_msg
operator|->
name|local_comm_id
operator|=
name|cm_id_priv
operator|->
name|id
operator|.
name|local_id
expr_stmt|;
name|dreq_msg
operator|->
name|remote_comm_id
operator|=
name|cm_id_priv
operator|->
name|id
operator|.
name|remote_id
expr_stmt|;
name|cm_dreq_set_remote_qpn
argument_list|(
name|dreq_msg
argument_list|,
name|cm_id_priv
operator|->
name|remote_qpn
argument_list|)
expr_stmt|;
if|if
condition|(
name|private_data
operator|&&
name|private_data_len
condition|)
name|memcpy
argument_list|(
name|dreq_msg
operator|->
name|private_data
argument_list|,
name|private_data
argument_list|,
name|private_data_len
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|ib_send_cm_dreq
parameter_list|(
name|struct
name|ib_cm_id
modifier|*
name|cm_id
parameter_list|,
specifier|const
name|void
modifier|*
name|private_data
parameter_list|,
name|u8
name|private_data_len
parameter_list|)
block|{
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
decl_stmt|;
name|struct
name|ib_mad_send_buf
modifier|*
name|msg
decl_stmt|;
name|unsigned
name|long
name|flags
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|private_data
operator|&&
name|private_data_len
operator|>
name|IB_CM_DREQ_PRIVATE_DATA_SIZE
condition|)
return|return
operator|-
name|EINVAL
return|;
name|cm_id_priv
operator|=
name|container_of
argument_list|(
name|cm_id
argument_list|,
expr|struct
name|cm_id_private
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|cm_id
operator|->
name|state
operator|!=
name|IB_CM_ESTABLISHED
condition|)
block|{
name|pr_debug
argument_list|(
literal|"cm_id->state: %d\n"
argument_list|,
name|cm_id
operator|->
name|state
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|cm_id
operator|->
name|lap_state
operator|==
name|IB_CM_LAP_SENT
operator|||
name|cm_id
operator|->
name|lap_state
operator|==
name|IB_CM_MRA_LAP_RCVD
condition|)
name|ib_cancel_mad
argument_list|(
name|cm_id_priv
operator|->
name|av
operator|.
name|port
operator|->
name|mad_agent
argument_list|,
name|cm_id_priv
operator|->
name|msg
argument_list|)
expr_stmt|;
name|ret
operator|=
name|cm_alloc_msg
argument_list|(
name|cm_id_priv
argument_list|,
operator|&
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|cm_enter_timewait
argument_list|(
name|cm_id_priv
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|cm_format_dreq
argument_list|(
operator|(
expr|struct
name|cm_dreq_msg
operator|*
operator|)
name|msg
operator|->
name|mad
argument_list|,
name|cm_id_priv
argument_list|,
name|private_data
argument_list|,
name|private_data_len
argument_list|)
expr_stmt|;
name|msg
operator|->
name|timeout_ms
operator|=
name|cm_id_priv
operator|->
name|timeout_ms
expr_stmt|;
name|msg
operator|->
name|context
index|[
literal|1
index|]
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
name|unsigned
name|long
operator|)
name|IB_CM_DREQ_SENT
expr_stmt|;
name|ret
operator|=
name|ib_post_send_mad
argument_list|(
name|msg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|cm_enter_timewait
argument_list|(
name|cm_id_priv
argument_list|)
expr_stmt|;
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|cm_free_msg
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|cm_id
operator|->
name|state
operator|=
name|IB_CM_DREQ_SENT
expr_stmt|;
name|cm_id_priv
operator|->
name|msg
operator|=
name|msg
expr_stmt|;
name|out
label|:
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL
argument_list|(
name|ib_send_cm_dreq
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|void
name|cm_format_drep
parameter_list|(
name|struct
name|cm_drep_msg
modifier|*
name|drep_msg
parameter_list|,
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
parameter_list|,
specifier|const
name|void
modifier|*
name|private_data
parameter_list|,
name|u8
name|private_data_len
parameter_list|)
block|{
name|cm_format_mad_hdr
argument_list|(
operator|&
name|drep_msg
operator|->
name|hdr
argument_list|,
name|CM_DREP_ATTR_ID
argument_list|,
name|cm_id_priv
operator|->
name|tid
argument_list|)
expr_stmt|;
name|drep_msg
operator|->
name|local_comm_id
operator|=
name|cm_id_priv
operator|->
name|id
operator|.
name|local_id
expr_stmt|;
name|drep_msg
operator|->
name|remote_comm_id
operator|=
name|cm_id_priv
operator|->
name|id
operator|.
name|remote_id
expr_stmt|;
if|if
condition|(
name|private_data
operator|&&
name|private_data_len
condition|)
name|memcpy
argument_list|(
name|drep_msg
operator|->
name|private_data
argument_list|,
name|private_data
argument_list|,
name|private_data_len
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|ib_send_cm_drep
parameter_list|(
name|struct
name|ib_cm_id
modifier|*
name|cm_id
parameter_list|,
specifier|const
name|void
modifier|*
name|private_data
parameter_list|,
name|u8
name|private_data_len
parameter_list|)
block|{
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
decl_stmt|;
name|struct
name|ib_mad_send_buf
modifier|*
name|msg
decl_stmt|;
name|unsigned
name|long
name|flags
decl_stmt|;
name|void
modifier|*
name|data
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|private_data
operator|&&
name|private_data_len
operator|>
name|IB_CM_DREP_PRIVATE_DATA_SIZE
condition|)
return|return
operator|-
name|EINVAL
return|;
name|data
operator|=
name|cm_copy_private_data
argument_list|(
name|private_data
argument_list|,
name|private_data_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|data
argument_list|)
condition|)
return|return
name|PTR_ERR
argument_list|(
name|data
argument_list|)
return|;
name|cm_id_priv
operator|=
name|container_of
argument_list|(
name|cm_id
argument_list|,
expr|struct
name|cm_id_private
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|cm_id
operator|->
name|state
operator|!=
name|IB_CM_DREQ_RCVD
condition|)
block|{
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|pr_debug
argument_list|(
literal|"cm_id->state(%d) != IB_CM_DREQ_RCVD\n"
argument_list|,
name|cm_id
operator|->
name|state
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|cm_set_private_data
argument_list|(
name|cm_id_priv
argument_list|,
name|data
argument_list|,
name|private_data_len
argument_list|)
expr_stmt|;
name|cm_enter_timewait
argument_list|(
name|cm_id_priv
argument_list|)
expr_stmt|;
name|ret
operator|=
name|cm_alloc_msg
argument_list|(
name|cm_id_priv
argument_list|,
operator|&
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|cm_format_drep
argument_list|(
operator|(
expr|struct
name|cm_drep_msg
operator|*
operator|)
name|msg
operator|->
name|mad
argument_list|,
name|cm_id_priv
argument_list|,
name|private_data
argument_list|,
name|private_data_len
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ib_post_send_mad
argument_list|(
name|msg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|cm_free_msg
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|out
label|:
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL
argument_list|(
name|ib_send_cm_drep
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|int
name|cm_issue_drep
parameter_list|(
name|struct
name|cm_port
modifier|*
name|port
parameter_list|,
name|struct
name|ib_mad_recv_wc
modifier|*
name|mad_recv_wc
parameter_list|)
block|{
name|struct
name|ib_mad_send_buf
modifier|*
name|msg
init|=
name|NULL
decl_stmt|;
name|struct
name|cm_dreq_msg
modifier|*
name|dreq_msg
decl_stmt|;
name|struct
name|cm_drep_msg
modifier|*
name|drep_msg
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|cm_alloc_response_msg
argument_list|(
name|port
argument_list|,
name|mad_recv_wc
argument_list|,
operator|&
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|dreq_msg
operator|=
operator|(
expr|struct
name|cm_dreq_msg
operator|*
operator|)
name|mad_recv_wc
operator|->
name|recv_buf
operator|.
name|mad
expr_stmt|;
name|drep_msg
operator|=
operator|(
expr|struct
name|cm_drep_msg
operator|*
operator|)
name|msg
operator|->
name|mad
expr_stmt|;
name|cm_format_mad_hdr
argument_list|(
operator|&
name|drep_msg
operator|->
name|hdr
argument_list|,
name|CM_DREP_ATTR_ID
argument_list|,
name|dreq_msg
operator|->
name|hdr
operator|.
name|tid
argument_list|)
expr_stmt|;
name|drep_msg
operator|->
name|remote_comm_id
operator|=
name|dreq_msg
operator|->
name|local_comm_id
expr_stmt|;
name|drep_msg
operator|->
name|local_comm_id
operator|=
name|dreq_msg
operator|->
name|remote_comm_id
expr_stmt|;
name|ret
operator|=
name|ib_post_send_mad
argument_list|(
name|msg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|cm_free_msg
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cm_dreq_handler
parameter_list|(
name|struct
name|cm_work
modifier|*
name|work
parameter_list|)
block|{
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
decl_stmt|;
name|struct
name|cm_dreq_msg
modifier|*
name|dreq_msg
decl_stmt|;
name|struct
name|ib_mad_send_buf
modifier|*
name|msg
init|=
name|NULL
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|dreq_msg
operator|=
operator|(
expr|struct
name|cm_dreq_msg
operator|*
operator|)
name|work
operator|->
name|mad_recv_wc
operator|->
name|recv_buf
operator|.
name|mad
expr_stmt|;
name|cm_id_priv
operator|=
name|cm_acquire_id
argument_list|(
name|dreq_msg
operator|->
name|remote_comm_id
argument_list|,
name|dreq_msg
operator|->
name|local_comm_id
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cm_id_priv
condition|)
block|{
name|atomic_long_inc
argument_list|(
operator|&
name|work
operator|->
name|port
operator|->
name|counter_group
index|[
name|CM_RECV_DUPLICATES
index|]
operator|.
name|counter
index|[
name|CM_DREQ_COUNTER
index|]
argument_list|)
expr_stmt|;
name|cm_issue_drep
argument_list|(
name|work
operator|->
name|port
argument_list|,
name|work
operator|->
name|mad_recv_wc
argument_list|)
expr_stmt|;
name|pr_debug
argument_list|(
literal|"no cm_id_priv\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|work
operator|->
name|cm_event
operator|.
name|private_data
operator|=
operator|&
name|dreq_msg
operator|->
name|private_data
expr_stmt|;
name|spin_lock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|cm_id_priv
operator|->
name|local_qpn
operator|!=
name|cm_dreq_get_remote_qpn
argument_list|(
name|dreq_msg
argument_list|)
condition|)
goto|goto
name|unlock
goto|;
switch|switch
condition|(
name|cm_id_priv
operator|->
name|id
operator|.
name|state
condition|)
block|{
case|case
name|IB_CM_REP_SENT
case|:
case|case
name|IB_CM_DREQ_SENT
case|:
name|ib_cancel_mad
argument_list|(
name|cm_id_priv
operator|->
name|av
operator|.
name|port
operator|->
name|mad_agent
argument_list|,
name|cm_id_priv
operator|->
name|msg
argument_list|)
expr_stmt|;
break|break;
case|case
name|IB_CM_ESTABLISHED
case|:
if|if
condition|(
name|cm_id_priv
operator|->
name|id
operator|.
name|lap_state
operator|==
name|IB_CM_LAP_SENT
operator|||
name|cm_id_priv
operator|->
name|id
operator|.
name|lap_state
operator|==
name|IB_CM_MRA_LAP_RCVD
condition|)
name|ib_cancel_mad
argument_list|(
name|cm_id_priv
operator|->
name|av
operator|.
name|port
operator|->
name|mad_agent
argument_list|,
name|cm_id_priv
operator|->
name|msg
argument_list|)
expr_stmt|;
break|break;
case|case
name|IB_CM_MRA_REP_RCVD
case|:
break|break;
case|case
name|IB_CM_TIMEWAIT
case|:
name|atomic_long_inc
argument_list|(
operator|&
name|work
operator|->
name|port
operator|->
name|counter_group
index|[
name|CM_RECV_DUPLICATES
index|]
operator|.
name|counter
index|[
name|CM_DREQ_COUNTER
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|cm_alloc_response_msg
argument_list|(
name|work
operator|->
name|port
argument_list|,
name|work
operator|->
name|mad_recv_wc
argument_list|,
operator|&
name|msg
argument_list|)
condition|)
goto|goto
name|unlock
goto|;
name|cm_format_drep
argument_list|(
operator|(
expr|struct
name|cm_drep_msg
operator|*
operator|)
name|msg
operator|->
name|mad
argument_list|,
name|cm_id_priv
argument_list|,
name|cm_id_priv
operator|->
name|private_data
argument_list|,
name|cm_id_priv
operator|->
name|private_data_len
argument_list|)
expr_stmt|;
name|spin_unlock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|ib_post_send_mad
argument_list|(
name|msg
argument_list|,
name|NULL
argument_list|)
condition|)
name|cm_free_msg
argument_list|(
name|msg
argument_list|)
expr_stmt|;
goto|goto
name|deref
goto|;
case|case
name|IB_CM_DREQ_RCVD
case|:
name|atomic_long_inc
argument_list|(
operator|&
name|work
operator|->
name|port
operator|->
name|counter_group
index|[
name|CM_RECV_DUPLICATES
index|]
operator|.
name|counter
index|[
name|CM_DREQ_COUNTER
index|]
argument_list|)
expr_stmt|;
goto|goto
name|unlock
goto|;
default|default:
name|pr_debug
argument_list|(
literal|"cm_id_priv->id.state: %d\n"
argument_list|,
name|cm_id_priv
operator|->
name|id
operator|.
name|state
argument_list|)
expr_stmt|;
goto|goto
name|unlock
goto|;
block|}
name|cm_id_priv
operator|->
name|id
operator|.
name|state
operator|=
name|IB_CM_DREQ_RCVD
expr_stmt|;
name|cm_id_priv
operator|->
name|tid
operator|=
name|dreq_msg
operator|->
name|hdr
operator|.
name|tid
expr_stmt|;
name|ret
operator|=
name|atomic_inc_and_test
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|work_count
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
name|list_add_tail
argument_list|(
operator|&
name|work
operator|->
name|list
argument_list|,
operator|&
name|cm_id_priv
operator|->
name|work_list
argument_list|)
expr_stmt|;
name|spin_unlock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|cm_process_work
argument_list|(
name|cm_id_priv
argument_list|,
name|work
argument_list|)
expr_stmt|;
else|else
name|cm_deref_id
argument_list|(
name|cm_id_priv
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|unlock
label|:
name|spin_unlock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
name|deref
label|:
name|cm_deref_id
argument_list|(
name|cm_id_priv
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cm_drep_handler
parameter_list|(
name|struct
name|cm_work
modifier|*
name|work
parameter_list|)
block|{
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
decl_stmt|;
name|struct
name|cm_drep_msg
modifier|*
name|drep_msg
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|drep_msg
operator|=
operator|(
expr|struct
name|cm_drep_msg
operator|*
operator|)
name|work
operator|->
name|mad_recv_wc
operator|->
name|recv_buf
operator|.
name|mad
expr_stmt|;
name|cm_id_priv
operator|=
name|cm_acquire_id
argument_list|(
name|drep_msg
operator|->
name|remote_comm_id
argument_list|,
name|drep_msg
operator|->
name|local_comm_id
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cm_id_priv
condition|)
return|return
operator|-
name|EINVAL
return|;
name|work
operator|->
name|cm_event
operator|.
name|private_data
operator|=
operator|&
name|drep_msg
operator|->
name|private_data
expr_stmt|;
name|spin_lock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|cm_id_priv
operator|->
name|id
operator|.
name|state
operator|!=
name|IB_CM_DREQ_SENT
operator|&&
name|cm_id_priv
operator|->
name|id
operator|.
name|state
operator|!=
name|IB_CM_DREQ_RCVD
condition|)
block|{
name|spin_unlock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|cm_enter_timewait
argument_list|(
name|cm_id_priv
argument_list|)
expr_stmt|;
name|ib_cancel_mad
argument_list|(
name|cm_id_priv
operator|->
name|av
operator|.
name|port
operator|->
name|mad_agent
argument_list|,
name|cm_id_priv
operator|->
name|msg
argument_list|)
expr_stmt|;
name|ret
operator|=
name|atomic_inc_and_test
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|work_count
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
name|list_add_tail
argument_list|(
operator|&
name|work
operator|->
name|list
argument_list|,
operator|&
name|cm_id_priv
operator|->
name|work_list
argument_list|)
expr_stmt|;
name|spin_unlock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|cm_process_work
argument_list|(
name|cm_id_priv
argument_list|,
name|work
argument_list|)
expr_stmt|;
else|else
name|cm_deref_id
argument_list|(
name|cm_id_priv
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|out
label|:
name|cm_deref_id
argument_list|(
name|cm_id_priv
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
end_function

begin_function
name|int
name|ib_send_cm_rej
parameter_list|(
name|struct
name|ib_cm_id
modifier|*
name|cm_id
parameter_list|,
name|enum
name|ib_cm_rej_reason
name|reason
parameter_list|,
name|void
modifier|*
name|ari
parameter_list|,
name|u8
name|ari_length
parameter_list|,
specifier|const
name|void
modifier|*
name|private_data
parameter_list|,
name|u8
name|private_data_len
parameter_list|)
block|{
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
decl_stmt|;
name|struct
name|ib_mad_send_buf
modifier|*
name|msg
decl_stmt|;
name|unsigned
name|long
name|flags
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
operator|(
name|private_data
operator|&&
name|private_data_len
operator|>
name|IB_CM_REJ_PRIVATE_DATA_SIZE
operator|)
operator|||
operator|(
name|ari
operator|&&
name|ari_length
operator|>
name|IB_CM_REJ_ARI_LENGTH
operator|)
condition|)
return|return
operator|-
name|EINVAL
return|;
name|cm_id_priv
operator|=
name|container_of
argument_list|(
name|cm_id
argument_list|,
expr|struct
name|cm_id_private
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cm_id
operator|->
name|state
condition|)
block|{
case|case
name|IB_CM_REQ_SENT
case|:
case|case
name|IB_CM_MRA_REQ_RCVD
case|:
case|case
name|IB_CM_REQ_RCVD
case|:
case|case
name|IB_CM_MRA_REQ_SENT
case|:
case|case
name|IB_CM_REP_RCVD
case|:
case|case
name|IB_CM_MRA_REP_SENT
case|:
name|ret
operator|=
name|cm_alloc_msg
argument_list|(
name|cm_id_priv
argument_list|,
operator|&
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
name|cm_format_rej
argument_list|(
operator|(
expr|struct
name|cm_rej_msg
operator|*
operator|)
name|msg
operator|->
name|mad
argument_list|,
name|cm_id_priv
argument_list|,
name|reason
argument_list|,
name|ari
argument_list|,
name|ari_length
argument_list|,
name|private_data
argument_list|,
name|private_data_len
argument_list|)
expr_stmt|;
name|cm_reset_to_idle
argument_list|(
name|cm_id_priv
argument_list|)
expr_stmt|;
break|break;
case|case
name|IB_CM_REP_SENT
case|:
case|case
name|IB_CM_MRA_REP_RCVD
case|:
name|ret
operator|=
name|cm_alloc_msg
argument_list|(
name|cm_id_priv
argument_list|,
operator|&
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
name|cm_format_rej
argument_list|(
operator|(
expr|struct
name|cm_rej_msg
operator|*
operator|)
name|msg
operator|->
name|mad
argument_list|,
name|cm_id_priv
argument_list|,
name|reason
argument_list|,
name|ari
argument_list|,
name|ari_length
argument_list|,
name|private_data
argument_list|,
name|private_data_len
argument_list|)
expr_stmt|;
name|cm_enter_timewait
argument_list|(
name|cm_id_priv
argument_list|)
expr_stmt|;
break|break;
default|default:
name|pr_debug
argument_list|(
literal|"cm_id->state: 0x%x\n"
argument_list|,
name|cm_id
operator|->
name|state
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|ret
operator|=
name|ib_post_send_mad
argument_list|(
name|msg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|cm_free_msg
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|out
label|:
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL
argument_list|(
name|ib_send_cm_rej
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|void
name|cm_format_rej_event
parameter_list|(
name|struct
name|cm_work
modifier|*
name|work
parameter_list|)
block|{
name|struct
name|cm_rej_msg
modifier|*
name|rej_msg
decl_stmt|;
name|struct
name|ib_cm_rej_event_param
modifier|*
name|param
decl_stmt|;
name|rej_msg
operator|=
operator|(
expr|struct
name|cm_rej_msg
operator|*
operator|)
name|work
operator|->
name|mad_recv_wc
operator|->
name|recv_buf
operator|.
name|mad
expr_stmt|;
name|param
operator|=
operator|&
name|work
operator|->
name|cm_event
operator|.
name|param
operator|.
name|rej_rcvd
expr_stmt|;
name|param
operator|->
name|ari
operator|=
name|rej_msg
operator|->
name|ari
expr_stmt|;
name|param
operator|->
name|ari_length
operator|=
name|cm_rej_get_reject_info_len
argument_list|(
name|rej_msg
argument_list|)
expr_stmt|;
name|param
operator|->
name|reason
operator|=
name|__be16_to_cpu
argument_list|(
name|rej_msg
operator|->
name|reason
argument_list|)
expr_stmt|;
name|work
operator|->
name|cm_event
operator|.
name|private_data
operator|=
operator|&
name|rej_msg
operator|->
name|private_data
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|cm_id_private
modifier|*
name|cm_acquire_rejected_id
parameter_list|(
name|struct
name|cm_rej_msg
modifier|*
name|rej_msg
parameter_list|)
block|{
name|struct
name|cm_timewait_info
modifier|*
name|timewait_info
decl_stmt|;
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
decl_stmt|;
name|__be32
name|remote_id
decl_stmt|;
name|remote_id
operator|=
name|rej_msg
operator|->
name|local_comm_id
expr_stmt|;
if|if
condition|(
name|__be16_to_cpu
argument_list|(
name|rej_msg
operator|->
name|reason
argument_list|)
operator|==
name|IB_CM_REJ_TIMEOUT
condition|)
block|{
name|spin_lock_irq
argument_list|(
operator|&
name|cm
operator|.
name|lock
argument_list|)
expr_stmt|;
name|timewait_info
operator|=
name|cm_find_remote_id
argument_list|(
operator|*
operator|(
operator|(
name|__be64
operator|*
operator|)
name|rej_msg
operator|->
name|ari
operator|)
argument_list|,
name|remote_id
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|timewait_info
condition|)
block|{
name|spin_unlock_irq
argument_list|(
operator|&
name|cm
operator|.
name|lock
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|cm_id_priv
operator|=
name|idr_find
argument_list|(
operator|&
name|cm
operator|.
name|local_id_table
argument_list|,
call|(
name|__force
name|int
call|)
argument_list|(
name|timewait_info
operator|->
name|work
operator|.
name|local_id
operator|^
name|cm
operator|.
name|random_id_operand
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cm_id_priv
condition|)
block|{
if|if
condition|(
name|cm_id_priv
operator|->
name|id
operator|.
name|remote_id
operator|==
name|remote_id
condition|)
name|atomic_inc
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|refcount
argument_list|)
expr_stmt|;
else|else
name|cm_id_priv
operator|=
name|NULL
expr_stmt|;
block|}
name|spin_unlock_irq
argument_list|(
operator|&
name|cm
operator|.
name|lock
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cm_rej_get_msg_rejected
argument_list|(
name|rej_msg
argument_list|)
operator|==
name|CM_MSG_RESPONSE_REQ
condition|)
name|cm_id_priv
operator|=
name|cm_acquire_id
argument_list|(
name|rej_msg
operator|->
name|remote_comm_id
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
name|cm_id_priv
operator|=
name|cm_acquire_id
argument_list|(
name|rej_msg
operator|->
name|remote_comm_id
argument_list|,
name|remote_id
argument_list|)
expr_stmt|;
return|return
name|cm_id_priv
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cm_rej_handler
parameter_list|(
name|struct
name|cm_work
modifier|*
name|work
parameter_list|)
block|{
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
decl_stmt|;
name|struct
name|cm_rej_msg
modifier|*
name|rej_msg
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|rej_msg
operator|=
operator|(
expr|struct
name|cm_rej_msg
operator|*
operator|)
name|work
operator|->
name|mad_recv_wc
operator|->
name|recv_buf
operator|.
name|mad
expr_stmt|;
name|cm_id_priv
operator|=
name|cm_acquire_rejected_id
argument_list|(
name|rej_msg
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cm_id_priv
condition|)
return|return
operator|-
name|EINVAL
return|;
name|cm_format_rej_event
argument_list|(
name|work
argument_list|)
expr_stmt|;
name|spin_lock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cm_id_priv
operator|->
name|id
operator|.
name|state
condition|)
block|{
case|case
name|IB_CM_REQ_SENT
case|:
case|case
name|IB_CM_MRA_REQ_RCVD
case|:
case|case
name|IB_CM_REP_SENT
case|:
case|case
name|IB_CM_MRA_REP_RCVD
case|:
name|ib_cancel_mad
argument_list|(
name|cm_id_priv
operator|->
name|av
operator|.
name|port
operator|->
name|mad_agent
argument_list|,
name|cm_id_priv
operator|->
name|msg
argument_list|)
expr_stmt|;
comment|/* fall through */
case|case
name|IB_CM_REQ_RCVD
case|:
case|case
name|IB_CM_MRA_REQ_SENT
case|:
if|if
condition|(
name|__be16_to_cpu
argument_list|(
name|rej_msg
operator|->
name|reason
argument_list|)
operator|==
name|IB_CM_REJ_STALE_CONN
condition|)
name|cm_enter_timewait
argument_list|(
name|cm_id_priv
argument_list|)
expr_stmt|;
else|else
name|cm_reset_to_idle
argument_list|(
name|cm_id_priv
argument_list|)
expr_stmt|;
break|break;
case|case
name|IB_CM_DREQ_SENT
case|:
name|ib_cancel_mad
argument_list|(
name|cm_id_priv
operator|->
name|av
operator|.
name|port
operator|->
name|mad_agent
argument_list|,
name|cm_id_priv
operator|->
name|msg
argument_list|)
expr_stmt|;
comment|/* fall through */
case|case
name|IB_CM_REP_RCVD
case|:
case|case
name|IB_CM_MRA_REP_SENT
case|:
name|cm_enter_timewait
argument_list|(
name|cm_id_priv
argument_list|)
expr_stmt|;
break|break;
case|case
name|IB_CM_ESTABLISHED
case|:
if|if
condition|(
name|cm_id_priv
operator|->
name|id
operator|.
name|lap_state
operator|==
name|IB_CM_LAP_UNINIT
operator|||
name|cm_id_priv
operator|->
name|id
operator|.
name|lap_state
operator|==
name|IB_CM_LAP_SENT
condition|)
block|{
if|if
condition|(
name|cm_id_priv
operator|->
name|id
operator|.
name|lap_state
operator|==
name|IB_CM_LAP_SENT
condition|)
name|ib_cancel_mad
argument_list|(
name|cm_id_priv
operator|->
name|av
operator|.
name|port
operator|->
name|mad_agent
argument_list|,
name|cm_id_priv
operator|->
name|msg
argument_list|)
expr_stmt|;
name|cm_enter_timewait
argument_list|(
name|cm_id_priv
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* fall through */
default|default:
name|spin_unlock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
name|pr_debug
argument_list|(
literal|"cm_id_priv->id.state: 0x%x\n"
argument_list|,
name|cm_id_priv
operator|->
name|id
operator|.
name|state
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|atomic_inc_and_test
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|work_count
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
name|list_add_tail
argument_list|(
operator|&
name|work
operator|->
name|list
argument_list|,
operator|&
name|cm_id_priv
operator|->
name|work_list
argument_list|)
expr_stmt|;
name|spin_unlock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|cm_process_work
argument_list|(
name|cm_id_priv
argument_list|,
name|work
argument_list|)
expr_stmt|;
else|else
name|cm_deref_id
argument_list|(
name|cm_id_priv
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|out
label|:
name|cm_deref_id
argument_list|(
name|cm_id_priv
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
end_function

begin_function
name|int
name|ib_send_cm_mra
parameter_list|(
name|struct
name|ib_cm_id
modifier|*
name|cm_id
parameter_list|,
name|u8
name|service_timeout
parameter_list|,
specifier|const
name|void
modifier|*
name|private_data
parameter_list|,
name|u8
name|private_data_len
parameter_list|)
block|{
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
decl_stmt|;
name|struct
name|ib_mad_send_buf
modifier|*
name|msg
decl_stmt|;
name|enum
name|ib_cm_state
name|cm_state
decl_stmt|;
name|enum
name|ib_cm_lap_state
name|lap_state
decl_stmt|;
name|enum
name|cm_msg_response
name|msg_response
decl_stmt|;
name|void
modifier|*
name|data
decl_stmt|;
name|unsigned
name|long
name|flags
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|private_data
operator|&&
name|private_data_len
operator|>
name|IB_CM_MRA_PRIVATE_DATA_SIZE
condition|)
return|return
operator|-
name|EINVAL
return|;
name|data
operator|=
name|cm_copy_private_data
argument_list|(
name|private_data
argument_list|,
name|private_data_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|data
argument_list|)
condition|)
return|return
name|PTR_ERR
argument_list|(
name|data
argument_list|)
return|;
name|cm_id_priv
operator|=
name|container_of
argument_list|(
name|cm_id
argument_list|,
expr|struct
name|cm_id_private
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cm_id_priv
operator|->
name|id
operator|.
name|state
condition|)
block|{
case|case
name|IB_CM_REQ_RCVD
case|:
name|cm_state
operator|=
name|IB_CM_MRA_REQ_SENT
expr_stmt|;
name|lap_state
operator|=
name|cm_id
operator|->
name|lap_state
expr_stmt|;
name|msg_response
operator|=
name|CM_MSG_RESPONSE_REQ
expr_stmt|;
break|break;
case|case
name|IB_CM_REP_RCVD
case|:
name|cm_state
operator|=
name|IB_CM_MRA_REP_SENT
expr_stmt|;
name|lap_state
operator|=
name|cm_id
operator|->
name|lap_state
expr_stmt|;
name|msg_response
operator|=
name|CM_MSG_RESPONSE_REP
expr_stmt|;
break|break;
case|case
name|IB_CM_ESTABLISHED
case|:
if|if
condition|(
name|cm_id
operator|->
name|lap_state
operator|==
name|IB_CM_LAP_RCVD
condition|)
block|{
name|cm_state
operator|=
name|cm_id
operator|->
name|state
expr_stmt|;
name|lap_state
operator|=
name|IB_CM_MRA_LAP_SENT
expr_stmt|;
name|msg_response
operator|=
name|CM_MSG_RESPONSE_OTHER
expr_stmt|;
break|break;
block|}
default|default:
name|pr_debug
argument_list|(
literal|"cm_id_priv->id.state: 0x%x\n"
argument_list|,
name|cm_id_priv
operator|->
name|id
operator|.
name|state
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|error1
goto|;
block|}
if|if
condition|(
operator|!
operator|(
name|service_timeout
operator|&
name|IB_CM_MRA_FLAG_DELAY
operator|)
condition|)
block|{
name|ret
operator|=
name|cm_alloc_msg
argument_list|(
name|cm_id_priv
argument_list|,
operator|&
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|error1
goto|;
name|cm_format_mra
argument_list|(
operator|(
expr|struct
name|cm_mra_msg
operator|*
operator|)
name|msg
operator|->
name|mad
argument_list|,
name|cm_id_priv
argument_list|,
name|msg_response
argument_list|,
name|service_timeout
argument_list|,
name|private_data
argument_list|,
name|private_data_len
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ib_post_send_mad
argument_list|(
name|msg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|error2
goto|;
block|}
name|cm_id
operator|->
name|state
operator|=
name|cm_state
expr_stmt|;
name|cm_id
operator|->
name|lap_state
operator|=
name|lap_state
expr_stmt|;
name|cm_id_priv
operator|->
name|service_timeout
operator|=
name|service_timeout
expr_stmt|;
name|cm_set_private_data
argument_list|(
name|cm_id_priv
argument_list|,
name|data
argument_list|,
name|private_data_len
argument_list|)
expr_stmt|;
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|error1
label|:
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
name|error2
label|:
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|cm_free_msg
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL
argument_list|(
name|ib_send_cm_mra
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|struct
name|cm_id_private
modifier|*
name|cm_acquire_mraed_id
parameter_list|(
name|struct
name|cm_mra_msg
modifier|*
name|mra_msg
parameter_list|)
block|{
switch|switch
condition|(
name|cm_mra_get_msg_mraed
argument_list|(
name|mra_msg
argument_list|)
condition|)
block|{
case|case
name|CM_MSG_RESPONSE_REQ
case|:
return|return
name|cm_acquire_id
argument_list|(
name|mra_msg
operator|->
name|remote_comm_id
argument_list|,
literal|0
argument_list|)
return|;
case|case
name|CM_MSG_RESPONSE_REP
case|:
case|case
name|CM_MSG_RESPONSE_OTHER
case|:
return|return
name|cm_acquire_id
argument_list|(
name|mra_msg
operator|->
name|remote_comm_id
argument_list|,
name|mra_msg
operator|->
name|local_comm_id
argument_list|)
return|;
default|default:
return|return
name|NULL
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|cm_mra_handler
parameter_list|(
name|struct
name|cm_work
modifier|*
name|work
parameter_list|)
block|{
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
decl_stmt|;
name|struct
name|cm_mra_msg
modifier|*
name|mra_msg
decl_stmt|;
name|int
name|timeout
decl_stmt|,
name|ret
decl_stmt|;
name|mra_msg
operator|=
operator|(
expr|struct
name|cm_mra_msg
operator|*
operator|)
name|work
operator|->
name|mad_recv_wc
operator|->
name|recv_buf
operator|.
name|mad
expr_stmt|;
name|cm_id_priv
operator|=
name|cm_acquire_mraed_id
argument_list|(
name|mra_msg
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cm_id_priv
condition|)
return|return
operator|-
name|EINVAL
return|;
name|work
operator|->
name|cm_event
operator|.
name|private_data
operator|=
operator|&
name|mra_msg
operator|->
name|private_data
expr_stmt|;
name|work
operator|->
name|cm_event
operator|.
name|param
operator|.
name|mra_rcvd
operator|.
name|service_timeout
operator|=
name|cm_mra_get_service_timeout
argument_list|(
name|mra_msg
argument_list|)
expr_stmt|;
name|timeout
operator|=
name|cm_convert_to_ms
argument_list|(
name|cm_mra_get_service_timeout
argument_list|(
name|mra_msg
argument_list|)
argument_list|)
operator|+
name|cm_convert_to_ms
argument_list|(
name|cm_id_priv
operator|->
name|av
operator|.
name|timeout
argument_list|)
expr_stmt|;
name|spin_lock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cm_id_priv
operator|->
name|id
operator|.
name|state
condition|)
block|{
case|case
name|IB_CM_REQ_SENT
case|:
if|if
condition|(
name|cm_mra_get_msg_mraed
argument_list|(
name|mra_msg
argument_list|)
operator|!=
name|CM_MSG_RESPONSE_REQ
operator|||
name|ib_modify_mad
argument_list|(
name|cm_id_priv
operator|->
name|av
operator|.
name|port
operator|->
name|mad_agent
argument_list|,
name|cm_id_priv
operator|->
name|msg
argument_list|,
name|timeout
argument_list|)
condition|)
goto|goto
name|out
goto|;
name|cm_id_priv
operator|->
name|id
operator|.
name|state
operator|=
name|IB_CM_MRA_REQ_RCVD
expr_stmt|;
break|break;
case|case
name|IB_CM_REP_SENT
case|:
if|if
condition|(
name|cm_mra_get_msg_mraed
argument_list|(
name|mra_msg
argument_list|)
operator|!=
name|CM_MSG_RESPONSE_REP
operator|||
name|ib_modify_mad
argument_list|(
name|cm_id_priv
operator|->
name|av
operator|.
name|port
operator|->
name|mad_agent
argument_list|,
name|cm_id_priv
operator|->
name|msg
argument_list|,
name|timeout
argument_list|)
condition|)
goto|goto
name|out
goto|;
name|cm_id_priv
operator|->
name|id
operator|.
name|state
operator|=
name|IB_CM_MRA_REP_RCVD
expr_stmt|;
break|break;
case|case
name|IB_CM_ESTABLISHED
case|:
if|if
condition|(
name|cm_mra_get_msg_mraed
argument_list|(
name|mra_msg
argument_list|)
operator|!=
name|CM_MSG_RESPONSE_OTHER
operator|||
name|cm_id_priv
operator|->
name|id
operator|.
name|lap_state
operator|!=
name|IB_CM_LAP_SENT
operator|||
name|ib_modify_mad
argument_list|(
name|cm_id_priv
operator|->
name|av
operator|.
name|port
operator|->
name|mad_agent
argument_list|,
name|cm_id_priv
operator|->
name|msg
argument_list|,
name|timeout
argument_list|)
condition|)
block|{
if|if
condition|(
name|cm_id_priv
operator|->
name|id
operator|.
name|lap_state
operator|==
name|IB_CM_MRA_LAP_RCVD
condition|)
name|atomic_long_inc
argument_list|(
operator|&
name|work
operator|->
name|port
operator|->
name|counter_group
index|[
name|CM_RECV_DUPLICATES
index|]
operator|.
name|counter
index|[
name|CM_MRA_COUNTER
index|]
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|cm_id_priv
operator|->
name|id
operator|.
name|lap_state
operator|=
name|IB_CM_MRA_LAP_RCVD
expr_stmt|;
break|break;
case|case
name|IB_CM_MRA_REQ_RCVD
case|:
case|case
name|IB_CM_MRA_REP_RCVD
case|:
name|atomic_long_inc
argument_list|(
operator|&
name|work
operator|->
name|port
operator|->
name|counter_group
index|[
name|CM_RECV_DUPLICATES
index|]
operator|.
name|counter
index|[
name|CM_MRA_COUNTER
index|]
argument_list|)
expr_stmt|;
comment|/* fall through */
default|default:
name|pr_debug
argument_list|(
literal|"cm_id_priv->id.state: 0x%x\n"
argument_list|,
name|cm_id_priv
operator|->
name|id
operator|.
name|state
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|cm_id_priv
operator|->
name|msg
operator|->
name|context
index|[
literal|1
index|]
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
name|unsigned
name|long
operator|)
name|cm_id_priv
operator|->
name|id
operator|.
name|state
expr_stmt|;
name|ret
operator|=
name|atomic_inc_and_test
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|work_count
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
name|list_add_tail
argument_list|(
operator|&
name|work
operator|->
name|list
argument_list|,
operator|&
name|cm_id_priv
operator|->
name|work_list
argument_list|)
expr_stmt|;
name|spin_unlock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|cm_process_work
argument_list|(
name|cm_id_priv
argument_list|,
name|work
argument_list|)
expr_stmt|;
else|else
name|cm_deref_id
argument_list|(
name|cm_id_priv
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|out
label|:
name|spin_unlock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
name|cm_deref_id
argument_list|(
name|cm_id_priv
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|cm_format_lap
parameter_list|(
name|struct
name|cm_lap_msg
modifier|*
name|lap_msg
parameter_list|,
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
parameter_list|,
name|struct
name|ib_sa_path_rec
modifier|*
name|alternate_path
parameter_list|,
specifier|const
name|void
modifier|*
name|private_data
parameter_list|,
name|u8
name|private_data_len
parameter_list|)
block|{
name|cm_format_mad_hdr
argument_list|(
operator|&
name|lap_msg
operator|->
name|hdr
argument_list|,
name|CM_LAP_ATTR_ID
argument_list|,
name|cm_form_tid
argument_list|(
name|cm_id_priv
argument_list|,
name|CM_MSG_SEQUENCE_LAP
argument_list|)
argument_list|)
expr_stmt|;
name|lap_msg
operator|->
name|local_comm_id
operator|=
name|cm_id_priv
operator|->
name|id
operator|.
name|local_id
expr_stmt|;
name|lap_msg
operator|->
name|remote_comm_id
operator|=
name|cm_id_priv
operator|->
name|id
operator|.
name|remote_id
expr_stmt|;
name|cm_lap_set_remote_qpn
argument_list|(
name|lap_msg
argument_list|,
name|cm_id_priv
operator|->
name|remote_qpn
argument_list|)
expr_stmt|;
comment|/* todo: need remote CM response timeout */
name|cm_lap_set_remote_resp_timeout
argument_list|(
name|lap_msg
argument_list|,
literal|0x1F
argument_list|)
expr_stmt|;
name|lap_msg
operator|->
name|alt_local_lid
operator|=
name|alternate_path
operator|->
name|slid
expr_stmt|;
name|lap_msg
operator|->
name|alt_remote_lid
operator|=
name|alternate_path
operator|->
name|dlid
expr_stmt|;
name|lap_msg
operator|->
name|alt_local_gid
operator|=
name|alternate_path
operator|->
name|sgid
expr_stmt|;
name|lap_msg
operator|->
name|alt_remote_gid
operator|=
name|alternate_path
operator|->
name|dgid
expr_stmt|;
name|cm_lap_set_flow_label
argument_list|(
name|lap_msg
argument_list|,
name|alternate_path
operator|->
name|flow_label
argument_list|)
expr_stmt|;
name|cm_lap_set_traffic_class
argument_list|(
name|lap_msg
argument_list|,
name|alternate_path
operator|->
name|traffic_class
argument_list|)
expr_stmt|;
name|lap_msg
operator|->
name|alt_hop_limit
operator|=
name|alternate_path
operator|->
name|hop_limit
expr_stmt|;
name|cm_lap_set_packet_rate
argument_list|(
name|lap_msg
argument_list|,
name|alternate_path
operator|->
name|rate
argument_list|)
expr_stmt|;
name|cm_lap_set_sl
argument_list|(
name|lap_msg
argument_list|,
name|alternate_path
operator|->
name|sl
argument_list|)
expr_stmt|;
name|cm_lap_set_subnet_local
argument_list|(
name|lap_msg
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* local only... */
name|cm_lap_set_local_ack_timeout
argument_list|(
name|lap_msg
argument_list|,
name|cm_ack_timeout
argument_list|(
name|cm_id_priv
operator|->
name|av
operator|.
name|port
operator|->
name|cm_dev
operator|->
name|ack_delay
argument_list|,
name|alternate_path
operator|->
name|packet_life_time
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|private_data
operator|&&
name|private_data_len
condition|)
name|memcpy
argument_list|(
name|lap_msg
operator|->
name|private_data
argument_list|,
name|private_data
argument_list|,
name|private_data_len
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|ib_send_cm_lap
parameter_list|(
name|struct
name|ib_cm_id
modifier|*
name|cm_id
parameter_list|,
name|struct
name|ib_sa_path_rec
modifier|*
name|alternate_path
parameter_list|,
specifier|const
name|void
modifier|*
name|private_data
parameter_list|,
name|u8
name|private_data_len
parameter_list|)
block|{
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
decl_stmt|;
name|struct
name|ib_mad_send_buf
modifier|*
name|msg
decl_stmt|;
name|unsigned
name|long
name|flags
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|private_data
operator|&&
name|private_data_len
operator|>
name|IB_CM_LAP_PRIVATE_DATA_SIZE
condition|)
return|return
operator|-
name|EINVAL
return|;
name|cm_id_priv
operator|=
name|container_of
argument_list|(
name|cm_id
argument_list|,
expr|struct
name|cm_id_private
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|cm_id
operator|->
name|state
operator|!=
name|IB_CM_ESTABLISHED
operator|||
operator|(
name|cm_id
operator|->
name|lap_state
operator|!=
name|IB_CM_LAP_UNINIT
operator|&&
name|cm_id
operator|->
name|lap_state
operator|!=
name|IB_CM_LAP_IDLE
operator|)
condition|)
block|{
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|cm_init_av_by_path
argument_list|(
name|alternate_path
argument_list|,
operator|&
name|cm_id_priv
operator|->
name|alt_av
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|cm_id_priv
operator|->
name|alt_av
operator|.
name|timeout
operator|=
name|cm_ack_timeout
argument_list|(
name|cm_id_priv
operator|->
name|target_ack_delay
argument_list|,
name|cm_id_priv
operator|->
name|alt_av
operator|.
name|timeout
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ret
operator|=
name|cm_alloc_msg
argument_list|(
name|cm_id_priv
argument_list|,
operator|&
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|cm_format_lap
argument_list|(
operator|(
expr|struct
name|cm_lap_msg
operator|*
operator|)
name|msg
operator|->
name|mad
argument_list|,
name|cm_id_priv
argument_list|,
name|alternate_path
argument_list|,
name|private_data
argument_list|,
name|private_data_len
argument_list|)
expr_stmt|;
name|msg
operator|->
name|timeout_ms
operator|=
name|cm_id_priv
operator|->
name|timeout_ms
expr_stmt|;
name|msg
operator|->
name|context
index|[
literal|1
index|]
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
name|unsigned
name|long
operator|)
name|IB_CM_ESTABLISHED
expr_stmt|;
name|ret
operator|=
name|ib_post_send_mad
argument_list|(
name|msg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|cm_free_msg
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|cm_id
operator|->
name|lap_state
operator|=
name|IB_CM_LAP_SENT
expr_stmt|;
name|cm_id_priv
operator|->
name|msg
operator|=
name|msg
expr_stmt|;
name|out
label|:
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL
argument_list|(
name|ib_send_cm_lap
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|void
name|cm_format_path_from_lap
parameter_list|(
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
parameter_list|,
name|struct
name|ib_sa_path_rec
modifier|*
name|path
parameter_list|,
name|struct
name|cm_lap_msg
modifier|*
name|lap_msg
parameter_list|)
block|{
name|memset
argument_list|(
name|path
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
expr|*
name|path
argument_list|)
expr_stmt|;
name|path
operator|->
name|dgid
operator|=
name|lap_msg
operator|->
name|alt_local_gid
expr_stmt|;
name|path
operator|->
name|sgid
operator|=
name|lap_msg
operator|->
name|alt_remote_gid
expr_stmt|;
name|path
operator|->
name|dlid
operator|=
name|lap_msg
operator|->
name|alt_local_lid
expr_stmt|;
name|path
operator|->
name|slid
operator|=
name|lap_msg
operator|->
name|alt_remote_lid
expr_stmt|;
name|path
operator|->
name|flow_label
operator|=
name|cm_lap_get_flow_label
argument_list|(
name|lap_msg
argument_list|)
expr_stmt|;
name|path
operator|->
name|hop_limit
operator|=
name|lap_msg
operator|->
name|alt_hop_limit
expr_stmt|;
name|path
operator|->
name|traffic_class
operator|=
name|cm_lap_get_traffic_class
argument_list|(
name|lap_msg
argument_list|)
expr_stmt|;
name|path
operator|->
name|reversible
operator|=
literal|1
expr_stmt|;
name|path
operator|->
name|pkey
operator|=
name|cm_id_priv
operator|->
name|pkey
expr_stmt|;
name|path
operator|->
name|sl
operator|=
name|cm_lap_get_sl
argument_list|(
name|lap_msg
argument_list|)
expr_stmt|;
name|path
operator|->
name|mtu_selector
operator|=
name|IB_SA_EQ
expr_stmt|;
name|path
operator|->
name|mtu
operator|=
name|cm_id_priv
operator|->
name|path_mtu
expr_stmt|;
name|path
operator|->
name|rate_selector
operator|=
name|IB_SA_EQ
expr_stmt|;
name|path
operator|->
name|rate
operator|=
name|cm_lap_get_packet_rate
argument_list|(
name|lap_msg
argument_list|)
expr_stmt|;
name|path
operator|->
name|packet_life_time_selector
operator|=
name|IB_SA_EQ
expr_stmt|;
name|path
operator|->
name|packet_life_time
operator|=
name|cm_lap_get_local_ack_timeout
argument_list|(
name|lap_msg
argument_list|)
expr_stmt|;
name|path
operator|->
name|packet_life_time
operator|-=
operator|(
name|path
operator|->
name|packet_life_time
operator|>
literal|0
operator|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|cm_lap_handler
parameter_list|(
name|struct
name|cm_work
modifier|*
name|work
parameter_list|)
block|{
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
decl_stmt|;
name|struct
name|cm_lap_msg
modifier|*
name|lap_msg
decl_stmt|;
name|struct
name|ib_cm_lap_event_param
modifier|*
name|param
decl_stmt|;
name|struct
name|ib_mad_send_buf
modifier|*
name|msg
init|=
name|NULL
decl_stmt|;
name|int
name|ret
decl_stmt|;
comment|/* todo: verify LAP request and send reject APR if invalid. */
name|lap_msg
operator|=
operator|(
expr|struct
name|cm_lap_msg
operator|*
operator|)
name|work
operator|->
name|mad_recv_wc
operator|->
name|recv_buf
operator|.
name|mad
expr_stmt|;
name|cm_id_priv
operator|=
name|cm_acquire_id
argument_list|(
name|lap_msg
operator|->
name|remote_comm_id
argument_list|,
name|lap_msg
operator|->
name|local_comm_id
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cm_id_priv
condition|)
return|return
operator|-
name|EINVAL
return|;
name|param
operator|=
operator|&
name|work
operator|->
name|cm_event
operator|.
name|param
operator|.
name|lap_rcvd
expr_stmt|;
name|param
operator|->
name|alternate_path
operator|=
operator|&
name|work
operator|->
name|path
index|[
literal|0
index|]
expr_stmt|;
name|cm_format_path_from_lap
argument_list|(
name|cm_id_priv
argument_list|,
name|param
operator|->
name|alternate_path
argument_list|,
name|lap_msg
argument_list|)
expr_stmt|;
name|work
operator|->
name|cm_event
operator|.
name|private_data
operator|=
operator|&
name|lap_msg
operator|->
name|private_data
expr_stmt|;
name|spin_lock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|cm_id_priv
operator|->
name|id
operator|.
name|state
operator|!=
name|IB_CM_ESTABLISHED
condition|)
goto|goto
name|unlock
goto|;
switch|switch
condition|(
name|cm_id_priv
operator|->
name|id
operator|.
name|lap_state
condition|)
block|{
case|case
name|IB_CM_LAP_UNINIT
case|:
case|case
name|IB_CM_LAP_IDLE
case|:
break|break;
case|case
name|IB_CM_MRA_LAP_SENT
case|:
name|atomic_long_inc
argument_list|(
operator|&
name|work
operator|->
name|port
operator|->
name|counter_group
index|[
name|CM_RECV_DUPLICATES
index|]
operator|.
name|counter
index|[
name|CM_LAP_COUNTER
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|cm_alloc_response_msg
argument_list|(
name|work
operator|->
name|port
argument_list|,
name|work
operator|->
name|mad_recv_wc
argument_list|,
operator|&
name|msg
argument_list|)
condition|)
goto|goto
name|unlock
goto|;
name|cm_format_mra
argument_list|(
operator|(
expr|struct
name|cm_mra_msg
operator|*
operator|)
name|msg
operator|->
name|mad
argument_list|,
name|cm_id_priv
argument_list|,
name|CM_MSG_RESPONSE_OTHER
argument_list|,
name|cm_id_priv
operator|->
name|service_timeout
argument_list|,
name|cm_id_priv
operator|->
name|private_data
argument_list|,
name|cm_id_priv
operator|->
name|private_data_len
argument_list|)
expr_stmt|;
name|spin_unlock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|ib_post_send_mad
argument_list|(
name|msg
argument_list|,
name|NULL
argument_list|)
condition|)
name|cm_free_msg
argument_list|(
name|msg
argument_list|)
expr_stmt|;
goto|goto
name|deref
goto|;
case|case
name|IB_CM_LAP_RCVD
case|:
name|atomic_long_inc
argument_list|(
operator|&
name|work
operator|->
name|port
operator|->
name|counter_group
index|[
name|CM_RECV_DUPLICATES
index|]
operator|.
name|counter
index|[
name|CM_LAP_COUNTER
index|]
argument_list|)
expr_stmt|;
goto|goto
name|unlock
goto|;
default|default:
goto|goto
name|unlock
goto|;
block|}
name|cm_id_priv
operator|->
name|id
operator|.
name|lap_state
operator|=
name|IB_CM_LAP_RCVD
expr_stmt|;
name|cm_id_priv
operator|->
name|tid
operator|=
name|lap_msg
operator|->
name|hdr
operator|.
name|tid
expr_stmt|;
name|cm_init_av_for_response
argument_list|(
name|work
operator|->
name|port
argument_list|,
name|work
operator|->
name|mad_recv_wc
operator|->
name|wc
argument_list|,
name|work
operator|->
name|mad_recv_wc
operator|->
name|recv_buf
operator|.
name|grh
argument_list|,
operator|&
name|cm_id_priv
operator|->
name|av
argument_list|)
expr_stmt|;
if|if
condition|(
name|cm_init_av_by_path
argument_list|(
name|param
operator|->
name|alternate_path
argument_list|,
operator|&
name|cm_id_priv
operator|->
name|alt_av
argument_list|)
condition|)
goto|goto
name|unlock
goto|;
name|ret
operator|=
name|atomic_inc_and_test
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|work_count
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
name|list_add_tail
argument_list|(
operator|&
name|work
operator|->
name|list
argument_list|,
operator|&
name|cm_id_priv
operator|->
name|work_list
argument_list|)
expr_stmt|;
name|spin_unlock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|cm_process_work
argument_list|(
name|cm_id_priv
argument_list|,
name|work
argument_list|)
expr_stmt|;
else|else
name|cm_deref_id
argument_list|(
name|cm_id_priv
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|unlock
label|:
name|spin_unlock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
name|deref
label|:
name|cm_deref_id
argument_list|(
name|cm_id_priv
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|cm_format_apr
parameter_list|(
name|struct
name|cm_apr_msg
modifier|*
name|apr_msg
parameter_list|,
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
parameter_list|,
name|enum
name|ib_cm_apr_status
name|status
parameter_list|,
name|void
modifier|*
name|info
parameter_list|,
name|u8
name|info_length
parameter_list|,
specifier|const
name|void
modifier|*
name|private_data
parameter_list|,
name|u8
name|private_data_len
parameter_list|)
block|{
name|cm_format_mad_hdr
argument_list|(
operator|&
name|apr_msg
operator|->
name|hdr
argument_list|,
name|CM_APR_ATTR_ID
argument_list|,
name|cm_id_priv
operator|->
name|tid
argument_list|)
expr_stmt|;
name|apr_msg
operator|->
name|local_comm_id
operator|=
name|cm_id_priv
operator|->
name|id
operator|.
name|local_id
expr_stmt|;
name|apr_msg
operator|->
name|remote_comm_id
operator|=
name|cm_id_priv
operator|->
name|id
operator|.
name|remote_id
expr_stmt|;
name|apr_msg
operator|->
name|ap_status
operator|=
operator|(
name|u8
operator|)
name|status
expr_stmt|;
if|if
condition|(
name|info
operator|&&
name|info_length
condition|)
block|{
name|apr_msg
operator|->
name|info_length
operator|=
name|info_length
expr_stmt|;
name|memcpy
argument_list|(
name|apr_msg
operator|->
name|info
argument_list|,
name|info
argument_list|,
name|info_length
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|private_data
operator|&&
name|private_data_len
condition|)
name|memcpy
argument_list|(
name|apr_msg
operator|->
name|private_data
argument_list|,
name|private_data
argument_list|,
name|private_data_len
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|ib_send_cm_apr
parameter_list|(
name|struct
name|ib_cm_id
modifier|*
name|cm_id
parameter_list|,
name|enum
name|ib_cm_apr_status
name|status
parameter_list|,
name|void
modifier|*
name|info
parameter_list|,
name|u8
name|info_length
parameter_list|,
specifier|const
name|void
modifier|*
name|private_data
parameter_list|,
name|u8
name|private_data_len
parameter_list|)
block|{
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
decl_stmt|;
name|struct
name|ib_mad_send_buf
modifier|*
name|msg
decl_stmt|;
name|unsigned
name|long
name|flags
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
operator|(
name|private_data
operator|&&
name|private_data_len
operator|>
name|IB_CM_APR_PRIVATE_DATA_SIZE
operator|)
operator|||
operator|(
name|info
operator|&&
name|info_length
operator|>
name|IB_CM_APR_INFO_LENGTH
operator|)
condition|)
return|return
operator|-
name|EINVAL
return|;
name|cm_id_priv
operator|=
name|container_of
argument_list|(
name|cm_id
argument_list|,
expr|struct
name|cm_id_private
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|cm_id
operator|->
name|state
operator|!=
name|IB_CM_ESTABLISHED
operator|||
operator|(
name|cm_id
operator|->
name|lap_state
operator|!=
name|IB_CM_LAP_RCVD
operator|&&
name|cm_id
operator|->
name|lap_state
operator|!=
name|IB_CM_MRA_LAP_SENT
operator|)
condition|)
block|{
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|cm_alloc_msg
argument_list|(
name|cm_id_priv
argument_list|,
operator|&
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|cm_format_apr
argument_list|(
operator|(
expr|struct
name|cm_apr_msg
operator|*
operator|)
name|msg
operator|->
name|mad
argument_list|,
name|cm_id_priv
argument_list|,
name|status
argument_list|,
name|info
argument_list|,
name|info_length
argument_list|,
name|private_data
argument_list|,
name|private_data_len
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ib_post_send_mad
argument_list|(
name|msg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|cm_free_msg
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|cm_id
operator|->
name|lap_state
operator|=
name|IB_CM_LAP_IDLE
expr_stmt|;
name|out
label|:
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL
argument_list|(
name|ib_send_cm_apr
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|int
name|cm_apr_handler
parameter_list|(
name|struct
name|cm_work
modifier|*
name|work
parameter_list|)
block|{
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
decl_stmt|;
name|struct
name|cm_apr_msg
modifier|*
name|apr_msg
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|apr_msg
operator|=
operator|(
expr|struct
name|cm_apr_msg
operator|*
operator|)
name|work
operator|->
name|mad_recv_wc
operator|->
name|recv_buf
operator|.
name|mad
expr_stmt|;
name|cm_id_priv
operator|=
name|cm_acquire_id
argument_list|(
name|apr_msg
operator|->
name|remote_comm_id
argument_list|,
name|apr_msg
operator|->
name|local_comm_id
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cm_id_priv
condition|)
return|return
operator|-
name|EINVAL
return|;
comment|/* Unmatched reply. */
name|work
operator|->
name|cm_event
operator|.
name|param
operator|.
name|apr_rcvd
operator|.
name|ap_status
operator|=
name|apr_msg
operator|->
name|ap_status
expr_stmt|;
name|work
operator|->
name|cm_event
operator|.
name|param
operator|.
name|apr_rcvd
operator|.
name|apr_info
operator|=
operator|&
name|apr_msg
operator|->
name|info
expr_stmt|;
name|work
operator|->
name|cm_event
operator|.
name|param
operator|.
name|apr_rcvd
operator|.
name|info_len
operator|=
name|apr_msg
operator|->
name|info_length
expr_stmt|;
name|work
operator|->
name|cm_event
operator|.
name|private_data
operator|=
operator|&
name|apr_msg
operator|->
name|private_data
expr_stmt|;
name|spin_lock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|cm_id_priv
operator|->
name|id
operator|.
name|state
operator|!=
name|IB_CM_ESTABLISHED
operator|||
operator|(
name|cm_id_priv
operator|->
name|id
operator|.
name|lap_state
operator|!=
name|IB_CM_LAP_SENT
operator|&&
name|cm_id_priv
operator|->
name|id
operator|.
name|lap_state
operator|!=
name|IB_CM_MRA_LAP_RCVD
operator|)
condition|)
block|{
name|spin_unlock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|cm_id_priv
operator|->
name|id
operator|.
name|lap_state
operator|=
name|IB_CM_LAP_IDLE
expr_stmt|;
name|ib_cancel_mad
argument_list|(
name|cm_id_priv
operator|->
name|av
operator|.
name|port
operator|->
name|mad_agent
argument_list|,
name|cm_id_priv
operator|->
name|msg
argument_list|)
expr_stmt|;
name|cm_id_priv
operator|->
name|msg
operator|=
name|NULL
expr_stmt|;
name|ret
operator|=
name|atomic_inc_and_test
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|work_count
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
name|list_add_tail
argument_list|(
operator|&
name|work
operator|->
name|list
argument_list|,
operator|&
name|cm_id_priv
operator|->
name|work_list
argument_list|)
expr_stmt|;
name|spin_unlock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|cm_process_work
argument_list|(
name|cm_id_priv
argument_list|,
name|work
argument_list|)
expr_stmt|;
else|else
name|cm_deref_id
argument_list|(
name|cm_id_priv
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|out
label|:
name|cm_deref_id
argument_list|(
name|cm_id_priv
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cm_timewait_handler
parameter_list|(
name|struct
name|cm_work
modifier|*
name|work
parameter_list|)
block|{
name|struct
name|cm_timewait_info
modifier|*
name|timewait_info
decl_stmt|;
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|timewait_info
operator|=
operator|(
expr|struct
name|cm_timewait_info
operator|*
operator|)
name|work
expr_stmt|;
name|spin_lock_irq
argument_list|(
operator|&
name|cm
operator|.
name|lock
argument_list|)
expr_stmt|;
name|list_del
argument_list|(
operator|&
name|timewait_info
operator|->
name|list
argument_list|)
expr_stmt|;
name|spin_unlock_irq
argument_list|(
operator|&
name|cm
operator|.
name|lock
argument_list|)
expr_stmt|;
name|cm_id_priv
operator|=
name|cm_acquire_id
argument_list|(
name|timewait_info
operator|->
name|work
operator|.
name|local_id
argument_list|,
name|timewait_info
operator|->
name|work
operator|.
name|remote_id
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cm_id_priv
condition|)
return|return
operator|-
name|EINVAL
return|;
name|spin_lock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|cm_id_priv
operator|->
name|id
operator|.
name|state
operator|!=
name|IB_CM_TIMEWAIT
operator|||
name|cm_id_priv
operator|->
name|remote_qpn
operator|!=
name|timewait_info
operator|->
name|remote_qpn
condition|)
block|{
name|spin_unlock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|cm_id_priv
operator|->
name|id
operator|.
name|state
operator|=
name|IB_CM_IDLE
expr_stmt|;
name|ret
operator|=
name|atomic_inc_and_test
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|work_count
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
name|list_add_tail
argument_list|(
operator|&
name|work
operator|->
name|list
argument_list|,
operator|&
name|cm_id_priv
operator|->
name|work_list
argument_list|)
expr_stmt|;
name|spin_unlock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|cm_process_work
argument_list|(
name|cm_id_priv
argument_list|,
name|work
argument_list|)
expr_stmt|;
else|else
name|cm_deref_id
argument_list|(
name|cm_id_priv
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|out
label|:
name|cm_deref_id
argument_list|(
name|cm_id_priv
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|cm_format_sidr_req
parameter_list|(
name|struct
name|cm_sidr_req_msg
modifier|*
name|sidr_req_msg
parameter_list|,
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
parameter_list|,
name|struct
name|ib_cm_sidr_req_param
modifier|*
name|param
parameter_list|)
block|{
name|cm_format_mad_hdr
argument_list|(
operator|&
name|sidr_req_msg
operator|->
name|hdr
argument_list|,
name|CM_SIDR_REQ_ATTR_ID
argument_list|,
name|cm_form_tid
argument_list|(
name|cm_id_priv
argument_list|,
name|CM_MSG_SEQUENCE_SIDR
argument_list|)
argument_list|)
expr_stmt|;
name|sidr_req_msg
operator|->
name|request_id
operator|=
name|cm_id_priv
operator|->
name|id
operator|.
name|local_id
expr_stmt|;
name|sidr_req_msg
operator|->
name|pkey
operator|=
name|param
operator|->
name|path
operator|->
name|pkey
expr_stmt|;
name|sidr_req_msg
operator|->
name|service_id
operator|=
name|param
operator|->
name|service_id
expr_stmt|;
if|if
condition|(
name|param
operator|->
name|private_data
operator|&&
name|param
operator|->
name|private_data_len
condition|)
name|memcpy
argument_list|(
name|sidr_req_msg
operator|->
name|private_data
argument_list|,
name|param
operator|->
name|private_data
argument_list|,
name|param
operator|->
name|private_data_len
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|ib_send_cm_sidr_req
parameter_list|(
name|struct
name|ib_cm_id
modifier|*
name|cm_id
parameter_list|,
name|struct
name|ib_cm_sidr_req_param
modifier|*
name|param
parameter_list|)
block|{
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
decl_stmt|;
name|struct
name|ib_mad_send_buf
modifier|*
name|msg
decl_stmt|;
name|unsigned
name|long
name|flags
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
operator|!
name|param
operator|->
name|path
operator|||
operator|(
name|param
operator|->
name|private_data
operator|&&
name|param
operator|->
name|private_data_len
operator|>
name|IB_CM_SIDR_REQ_PRIVATE_DATA_SIZE
operator|)
condition|)
return|return
operator|-
name|EINVAL
return|;
name|cm_id_priv
operator|=
name|container_of
argument_list|(
name|cm_id
argument_list|,
expr|struct
name|cm_id_private
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|ret
operator|=
name|cm_init_av_by_path
argument_list|(
name|param
operator|->
name|path
argument_list|,
operator|&
name|cm_id_priv
operator|->
name|av
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|cm_id
operator|->
name|service_id
operator|=
name|param
operator|->
name|service_id
expr_stmt|;
name|cm_id
operator|->
name|service_mask
operator|=
operator|~
name|cpu_to_be64
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|cm_id_priv
operator|->
name|timeout_ms
operator|=
name|param
operator|->
name|timeout_ms
expr_stmt|;
name|cm_id_priv
operator|->
name|max_cm_retries
operator|=
name|param
operator|->
name|max_cm_retries
expr_stmt|;
name|ret
operator|=
name|cm_alloc_msg
argument_list|(
name|cm_id_priv
argument_list|,
operator|&
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|cm_format_sidr_req
argument_list|(
operator|(
expr|struct
name|cm_sidr_req_msg
operator|*
operator|)
name|msg
operator|->
name|mad
argument_list|,
name|cm_id_priv
argument_list|,
name|param
argument_list|)
expr_stmt|;
name|msg
operator|->
name|timeout_ms
operator|=
name|cm_id_priv
operator|->
name|timeout_ms
expr_stmt|;
name|msg
operator|->
name|context
index|[
literal|1
index|]
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
name|unsigned
name|long
operator|)
name|IB_CM_SIDR_REQ_SENT
expr_stmt|;
if|if
condition|(
name|cm_id
operator|->
name|state
operator|==
name|IB_CM_IDLE
condition|)
name|ret
operator|=
name|ib_post_send_mad
argument_list|(
name|msg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
else|else
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|cm_free_msg
argument_list|(
name|msg
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|cm_id
operator|->
name|state
operator|=
name|IB_CM_SIDR_REQ_SENT
expr_stmt|;
name|cm_id_priv
operator|->
name|msg
operator|=
name|msg
expr_stmt|;
name|out
label|:
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL
argument_list|(
name|ib_send_cm_sidr_req
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|void
name|cm_format_sidr_req_event
parameter_list|(
name|struct
name|cm_work
modifier|*
name|work
parameter_list|,
name|struct
name|ib_cm_id
modifier|*
name|listen_id
parameter_list|)
block|{
name|struct
name|cm_sidr_req_msg
modifier|*
name|sidr_req_msg
decl_stmt|;
name|struct
name|ib_cm_sidr_req_event_param
modifier|*
name|param
decl_stmt|;
name|sidr_req_msg
operator|=
operator|(
expr|struct
name|cm_sidr_req_msg
operator|*
operator|)
name|work
operator|->
name|mad_recv_wc
operator|->
name|recv_buf
operator|.
name|mad
expr_stmt|;
name|param
operator|=
operator|&
name|work
operator|->
name|cm_event
operator|.
name|param
operator|.
name|sidr_req_rcvd
expr_stmt|;
name|param
operator|->
name|pkey
operator|=
name|__be16_to_cpu
argument_list|(
name|sidr_req_msg
operator|->
name|pkey
argument_list|)
expr_stmt|;
name|param
operator|->
name|listen_id
operator|=
name|listen_id
expr_stmt|;
name|param
operator|->
name|port
operator|=
name|work
operator|->
name|port
operator|->
name|port_num
expr_stmt|;
name|work
operator|->
name|cm_event
operator|.
name|private_data
operator|=
operator|&
name|sidr_req_msg
operator|->
name|private_data
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|cm_sidr_req_handler
parameter_list|(
name|struct
name|cm_work
modifier|*
name|work
parameter_list|)
block|{
name|struct
name|ib_cm_id
modifier|*
name|cm_id
decl_stmt|;
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
decl_stmt|,
modifier|*
name|cur_cm_id_priv
decl_stmt|;
name|struct
name|cm_sidr_req_msg
modifier|*
name|sidr_req_msg
decl_stmt|;
name|struct
name|ib_wc
modifier|*
name|wc
decl_stmt|;
name|cm_id
operator|=
name|ib_create_cm_id
argument_list|(
name|work
operator|->
name|port
operator|->
name|cm_dev
operator|->
name|ib_device
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|cm_id
argument_list|)
condition|)
return|return
name|PTR_ERR
argument_list|(
name|cm_id
argument_list|)
return|;
name|cm_id_priv
operator|=
name|container_of
argument_list|(
name|cm_id
argument_list|,
expr|struct
name|cm_id_private
argument_list|,
name|id
argument_list|)
expr_stmt|;
comment|/* Record SGID/SLID and request ID for lookup. */
name|sidr_req_msg
operator|=
operator|(
expr|struct
name|cm_sidr_req_msg
operator|*
operator|)
name|work
operator|->
name|mad_recv_wc
operator|->
name|recv_buf
operator|.
name|mad
expr_stmt|;
name|wc
operator|=
name|work
operator|->
name|mad_recv_wc
operator|->
name|wc
expr_stmt|;
name|cm_id_priv
operator|->
name|av
operator|.
name|dgid
operator|.
name|global
operator|.
name|subnet_prefix
operator|=
name|cpu_to_be64
argument_list|(
name|wc
operator|->
name|slid
argument_list|)
expr_stmt|;
name|cm_id_priv
operator|->
name|av
operator|.
name|dgid
operator|.
name|global
operator|.
name|interface_id
operator|=
literal|0
expr_stmt|;
name|cm_init_av_for_response
argument_list|(
name|work
operator|->
name|port
argument_list|,
name|work
operator|->
name|mad_recv_wc
operator|->
name|wc
argument_list|,
name|work
operator|->
name|mad_recv_wc
operator|->
name|recv_buf
operator|.
name|grh
argument_list|,
operator|&
name|cm_id_priv
operator|->
name|av
argument_list|)
expr_stmt|;
name|cm_id_priv
operator|->
name|id
operator|.
name|remote_id
operator|=
name|sidr_req_msg
operator|->
name|request_id
expr_stmt|;
name|cm_id_priv
operator|->
name|tid
operator|=
name|sidr_req_msg
operator|->
name|hdr
operator|.
name|tid
expr_stmt|;
name|atomic_inc
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|work_count
argument_list|)
expr_stmt|;
name|spin_lock_irq
argument_list|(
operator|&
name|cm
operator|.
name|lock
argument_list|)
expr_stmt|;
name|cur_cm_id_priv
operator|=
name|cm_insert_remote_sidr
argument_list|(
name|cm_id_priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|cur_cm_id_priv
condition|)
block|{
name|spin_unlock_irq
argument_list|(
operator|&
name|cm
operator|.
name|lock
argument_list|)
expr_stmt|;
name|atomic_long_inc
argument_list|(
operator|&
name|work
operator|->
name|port
operator|->
name|counter_group
index|[
name|CM_RECV_DUPLICATES
index|]
operator|.
name|counter
index|[
name|CM_SIDR_REQ_COUNTER
index|]
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
comment|/* Duplicate message. */
block|}
name|cm_id_priv
operator|->
name|id
operator|.
name|state
operator|=
name|IB_CM_SIDR_REQ_RCVD
expr_stmt|;
name|cur_cm_id_priv
operator|=
name|cm_find_listen
argument_list|(
name|cm_id
operator|->
name|device
argument_list|,
name|sidr_req_msg
operator|->
name|service_id
argument_list|,
name|sidr_req_msg
operator|->
name|private_data
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cur_cm_id_priv
condition|)
block|{
name|spin_unlock_irq
argument_list|(
operator|&
name|cm
operator|.
name|lock
argument_list|)
expr_stmt|;
name|cm_reject_sidr_req
argument_list|(
name|cm_id_priv
argument_list|,
name|IB_SIDR_UNSUPPORTED
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
comment|/* No match. */
block|}
name|atomic_inc
argument_list|(
operator|&
name|cur_cm_id_priv
operator|->
name|refcount
argument_list|)
expr_stmt|;
name|atomic_inc
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|refcount
argument_list|)
expr_stmt|;
name|spin_unlock_irq
argument_list|(
operator|&
name|cm
operator|.
name|lock
argument_list|)
expr_stmt|;
name|cm_id_priv
operator|->
name|id
operator|.
name|cm_handler
operator|=
name|cur_cm_id_priv
operator|->
name|id
operator|.
name|cm_handler
expr_stmt|;
name|cm_id_priv
operator|->
name|id
operator|.
name|context
operator|=
name|cur_cm_id_priv
operator|->
name|id
operator|.
name|context
expr_stmt|;
name|cm_id_priv
operator|->
name|id
operator|.
name|service_id
operator|=
name|sidr_req_msg
operator|->
name|service_id
expr_stmt|;
name|cm_id_priv
operator|->
name|id
operator|.
name|service_mask
operator|=
operator|~
name|cpu_to_be64
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|cm_format_sidr_req_event
argument_list|(
name|work
argument_list|,
operator|&
name|cur_cm_id_priv
operator|->
name|id
argument_list|)
expr_stmt|;
name|cm_process_work
argument_list|(
name|cm_id_priv
argument_list|,
name|work
argument_list|)
expr_stmt|;
name|cm_deref_id
argument_list|(
name|cur_cm_id_priv
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|out
label|:
name|ib_destroy_cm_id
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|id
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|cm_format_sidr_rep
parameter_list|(
name|struct
name|cm_sidr_rep_msg
modifier|*
name|sidr_rep_msg
parameter_list|,
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
parameter_list|,
name|struct
name|ib_cm_sidr_rep_param
modifier|*
name|param
parameter_list|)
block|{
name|cm_format_mad_hdr
argument_list|(
operator|&
name|sidr_rep_msg
operator|->
name|hdr
argument_list|,
name|CM_SIDR_REP_ATTR_ID
argument_list|,
name|cm_id_priv
operator|->
name|tid
argument_list|)
expr_stmt|;
name|sidr_rep_msg
operator|->
name|request_id
operator|=
name|cm_id_priv
operator|->
name|id
operator|.
name|remote_id
expr_stmt|;
name|sidr_rep_msg
operator|->
name|status
operator|=
name|param
operator|->
name|status
expr_stmt|;
name|cm_sidr_rep_set_qpn
argument_list|(
name|sidr_rep_msg
argument_list|,
name|cpu_to_be32
argument_list|(
name|param
operator|->
name|qp_num
argument_list|)
argument_list|)
expr_stmt|;
name|sidr_rep_msg
operator|->
name|service_id
operator|=
name|cm_id_priv
operator|->
name|id
operator|.
name|service_id
expr_stmt|;
name|sidr_rep_msg
operator|->
name|qkey
operator|=
name|cpu_to_be32
argument_list|(
name|param
operator|->
name|qkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|param
operator|->
name|info
operator|&&
name|param
operator|->
name|info_length
condition|)
name|memcpy
argument_list|(
name|sidr_rep_msg
operator|->
name|info
argument_list|,
name|param
operator|->
name|info
argument_list|,
name|param
operator|->
name|info_length
argument_list|)
expr_stmt|;
if|if
condition|(
name|param
operator|->
name|private_data
operator|&&
name|param
operator|->
name|private_data_len
condition|)
name|memcpy
argument_list|(
name|sidr_rep_msg
operator|->
name|private_data
argument_list|,
name|param
operator|->
name|private_data
argument_list|,
name|param
operator|->
name|private_data_len
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|ib_send_cm_sidr_rep
parameter_list|(
name|struct
name|ib_cm_id
modifier|*
name|cm_id
parameter_list|,
name|struct
name|ib_cm_sidr_rep_param
modifier|*
name|param
parameter_list|)
block|{
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
decl_stmt|;
name|struct
name|ib_mad_send_buf
modifier|*
name|msg
decl_stmt|;
name|unsigned
name|long
name|flags
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
operator|(
name|param
operator|->
name|info
operator|&&
name|param
operator|->
name|info_length
operator|>
name|IB_CM_SIDR_REP_INFO_LENGTH
operator|)
operator|||
operator|(
name|param
operator|->
name|private_data
operator|&&
name|param
operator|->
name|private_data_len
operator|>
name|IB_CM_SIDR_REP_PRIVATE_DATA_SIZE
operator|)
condition|)
return|return
operator|-
name|EINVAL
return|;
name|cm_id_priv
operator|=
name|container_of
argument_list|(
name|cm_id
argument_list|,
expr|struct
name|cm_id_private
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|cm_id
operator|->
name|state
operator|!=
name|IB_CM_SIDR_REQ_RCVD
condition|)
block|{
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|ret
operator|=
name|cm_alloc_msg
argument_list|(
name|cm_id_priv
argument_list|,
operator|&
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|error
goto|;
name|cm_format_sidr_rep
argument_list|(
operator|(
expr|struct
name|cm_sidr_rep_msg
operator|*
operator|)
name|msg
operator|->
name|mad
argument_list|,
name|cm_id_priv
argument_list|,
name|param
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ib_post_send_mad
argument_list|(
name|msg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|cm_free_msg
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|cm_id
operator|->
name|state
operator|=
name|IB_CM_IDLE
expr_stmt|;
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|cm
operator|.
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|rb_erase
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|sidr_id_node
argument_list|,
operator|&
name|cm
operator|.
name|remote_sidr_table
argument_list|)
expr_stmt|;
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|cm
operator|.
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|error
label|:
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL
argument_list|(
name|ib_send_cm_sidr_rep
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|void
name|cm_format_sidr_rep_event
parameter_list|(
name|struct
name|cm_work
modifier|*
name|work
parameter_list|)
block|{
name|struct
name|cm_sidr_rep_msg
modifier|*
name|sidr_rep_msg
decl_stmt|;
name|struct
name|ib_cm_sidr_rep_event_param
modifier|*
name|param
decl_stmt|;
name|sidr_rep_msg
operator|=
operator|(
expr|struct
name|cm_sidr_rep_msg
operator|*
operator|)
name|work
operator|->
name|mad_recv_wc
operator|->
name|recv_buf
operator|.
name|mad
expr_stmt|;
name|param
operator|=
operator|&
name|work
operator|->
name|cm_event
operator|.
name|param
operator|.
name|sidr_rep_rcvd
expr_stmt|;
name|param
operator|->
name|status
operator|=
name|sidr_rep_msg
operator|->
name|status
expr_stmt|;
name|param
operator|->
name|qkey
operator|=
name|be32_to_cpu
argument_list|(
name|sidr_rep_msg
operator|->
name|qkey
argument_list|)
expr_stmt|;
name|param
operator|->
name|qpn
operator|=
name|be32_to_cpu
argument_list|(
name|cm_sidr_rep_get_qpn
argument_list|(
name|sidr_rep_msg
argument_list|)
argument_list|)
expr_stmt|;
name|param
operator|->
name|info
operator|=
operator|&
name|sidr_rep_msg
operator|->
name|info
expr_stmt|;
name|param
operator|->
name|info_len
operator|=
name|sidr_rep_msg
operator|->
name|info_length
expr_stmt|;
name|work
operator|->
name|cm_event
operator|.
name|private_data
operator|=
operator|&
name|sidr_rep_msg
operator|->
name|private_data
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|cm_sidr_rep_handler
parameter_list|(
name|struct
name|cm_work
modifier|*
name|work
parameter_list|)
block|{
name|struct
name|cm_sidr_rep_msg
modifier|*
name|sidr_rep_msg
decl_stmt|;
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
decl_stmt|;
name|sidr_rep_msg
operator|=
operator|(
expr|struct
name|cm_sidr_rep_msg
operator|*
operator|)
name|work
operator|->
name|mad_recv_wc
operator|->
name|recv_buf
operator|.
name|mad
expr_stmt|;
name|cm_id_priv
operator|=
name|cm_acquire_id
argument_list|(
name|sidr_rep_msg
operator|->
name|request_id
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cm_id_priv
condition|)
return|return
operator|-
name|EINVAL
return|;
comment|/* Unmatched reply. */
name|spin_lock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|cm_id_priv
operator|->
name|id
operator|.
name|state
operator|!=
name|IB_CM_SIDR_REQ_SENT
condition|)
block|{
name|spin_unlock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|cm_id_priv
operator|->
name|id
operator|.
name|state
operator|=
name|IB_CM_IDLE
expr_stmt|;
name|ib_cancel_mad
argument_list|(
name|cm_id_priv
operator|->
name|av
operator|.
name|port
operator|->
name|mad_agent
argument_list|,
name|cm_id_priv
operator|->
name|msg
argument_list|)
expr_stmt|;
name|spin_unlock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
name|cm_format_sidr_rep_event
argument_list|(
name|work
argument_list|)
expr_stmt|;
name|cm_process_work
argument_list|(
name|cm_id_priv
argument_list|,
name|work
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|out
label|:
name|cm_deref_id
argument_list|(
name|cm_id_priv
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|cm_process_send_error
parameter_list|(
name|struct
name|ib_mad_send_buf
modifier|*
name|msg
parameter_list|,
name|enum
name|ib_wc_status
name|wc_status
parameter_list|)
block|{
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
decl_stmt|;
name|struct
name|ib_cm_event
name|cm_event
decl_stmt|;
name|enum
name|ib_cm_state
name|state
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|memset
argument_list|(
operator|&
name|cm_event
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|cm_event
argument_list|)
expr_stmt|;
name|cm_id_priv
operator|=
name|msg
operator|->
name|context
index|[
literal|0
index|]
expr_stmt|;
comment|/* Discard old sends or ones without a response. */
name|spin_lock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
name|state
operator|=
operator|(
expr|enum
name|ib_cm_state
operator|)
operator|(
name|unsigned
name|long
operator|)
name|msg
operator|->
name|context
index|[
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|msg
operator|!=
name|cm_id_priv
operator|->
name|msg
operator|||
name|state
operator|!=
name|cm_id_priv
operator|->
name|id
operator|.
name|state
condition|)
goto|goto
name|discard
goto|;
switch|switch
condition|(
name|state
condition|)
block|{
case|case
name|IB_CM_REQ_SENT
case|:
case|case
name|IB_CM_MRA_REQ_RCVD
case|:
name|cm_reset_to_idle
argument_list|(
name|cm_id_priv
argument_list|)
expr_stmt|;
name|cm_event
operator|.
name|event
operator|=
name|IB_CM_REQ_ERROR
expr_stmt|;
break|break;
case|case
name|IB_CM_REP_SENT
case|:
case|case
name|IB_CM_MRA_REP_RCVD
case|:
name|cm_reset_to_idle
argument_list|(
name|cm_id_priv
argument_list|)
expr_stmt|;
name|cm_event
operator|.
name|event
operator|=
name|IB_CM_REP_ERROR
expr_stmt|;
break|break;
case|case
name|IB_CM_DREQ_SENT
case|:
name|cm_enter_timewait
argument_list|(
name|cm_id_priv
argument_list|)
expr_stmt|;
name|cm_event
operator|.
name|event
operator|=
name|IB_CM_DREQ_ERROR
expr_stmt|;
break|break;
case|case
name|IB_CM_SIDR_REQ_SENT
case|:
name|cm_id_priv
operator|->
name|id
operator|.
name|state
operator|=
name|IB_CM_IDLE
expr_stmt|;
name|cm_event
operator|.
name|event
operator|=
name|IB_CM_SIDR_REQ_ERROR
expr_stmt|;
break|break;
default|default:
goto|goto
name|discard
goto|;
block|}
name|spin_unlock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
name|cm_event
operator|.
name|param
operator|.
name|send_status
operator|=
name|wc_status
expr_stmt|;
comment|/* No other events can occur on the cm_id at this point. */
name|ret
operator|=
name|cm_id_priv
operator|->
name|id
operator|.
name|cm_handler
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|id
argument_list|,
operator|&
name|cm_event
argument_list|)
expr_stmt|;
name|cm_free_msg
argument_list|(
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|ib_destroy_cm_id
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|id
argument_list|)
expr_stmt|;
return|return;
name|discard
label|:
name|spin_unlock_irq
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|)
expr_stmt|;
name|cm_free_msg
argument_list|(
name|msg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|cm_send_handler
parameter_list|(
name|struct
name|ib_mad_agent
modifier|*
name|mad_agent
parameter_list|,
name|struct
name|ib_mad_send_wc
modifier|*
name|mad_send_wc
parameter_list|)
block|{
name|struct
name|ib_mad_send_buf
modifier|*
name|msg
init|=
name|mad_send_wc
operator|->
name|send_buf
decl_stmt|;
name|struct
name|cm_port
modifier|*
name|port
decl_stmt|;
name|u16
name|attr_index
decl_stmt|;
name|port
operator|=
name|mad_agent
operator|->
name|context
expr_stmt|;
name|attr_index
operator|=
name|be16_to_cpu
argument_list|(
operator|(
operator|(
expr|struct
name|ib_mad_hdr
operator|*
operator|)
name|msg
operator|->
name|mad
operator|)
operator|->
name|attr_id
argument_list|)
operator|-
name|CM_ATTR_ID_OFFSET
expr_stmt|;
comment|/* 	 * If the send was in response to a received message (context[0] is not 	 * set to a cm_id), and is not a REJ, then it is a send that was 	 * manually retried. 	 */
if|if
condition|(
operator|!
name|msg
operator|->
name|context
index|[
literal|0
index|]
operator|&&
operator|(
name|attr_index
operator|!=
name|CM_REJ_COUNTER
operator|)
condition|)
name|msg
operator|->
name|retries
operator|=
literal|1
expr_stmt|;
name|atomic_long_add
argument_list|(
literal|1
operator|+
name|msg
operator|->
name|retries
argument_list|,
operator|&
name|port
operator|->
name|counter_group
index|[
name|CM_XMIT
index|]
operator|.
name|counter
index|[
name|attr_index
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|retries
condition|)
name|atomic_long_add
argument_list|(
name|msg
operator|->
name|retries
argument_list|,
operator|&
name|port
operator|->
name|counter_group
index|[
name|CM_XMIT_RETRIES
index|]
operator|.
name|counter
index|[
name|attr_index
index|]
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|mad_send_wc
operator|->
name|status
condition|)
block|{
case|case
name|IB_WC_SUCCESS
case|:
case|case
name|IB_WC_WR_FLUSH_ERR
case|:
name|cm_free_msg
argument_list|(
name|msg
argument_list|)
expr_stmt|;
break|break;
default|default:
if|if
condition|(
name|msg
operator|->
name|context
index|[
literal|0
index|]
operator|&&
name|msg
operator|->
name|context
index|[
literal|1
index|]
condition|)
name|cm_process_send_error
argument_list|(
name|msg
argument_list|,
name|mad_send_wc
operator|->
name|status
argument_list|)
expr_stmt|;
else|else
name|cm_free_msg
argument_list|(
name|msg
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|cm_work_handler
parameter_list|(
name|struct
name|work_struct
modifier|*
name|_work
parameter_list|)
block|{
name|struct
name|cm_work
modifier|*
name|work
init|=
name|container_of
argument_list|(
name|_work
argument_list|,
expr|struct
name|cm_work
argument_list|,
name|work
operator|.
name|work
argument_list|)
decl_stmt|;
name|int
name|ret
decl_stmt|;
switch|switch
condition|(
name|work
operator|->
name|cm_event
operator|.
name|event
condition|)
block|{
case|case
name|IB_CM_REQ_RECEIVED
case|:
name|ret
operator|=
name|cm_req_handler
argument_list|(
name|work
argument_list|)
expr_stmt|;
break|break;
case|case
name|IB_CM_MRA_RECEIVED
case|:
name|ret
operator|=
name|cm_mra_handler
argument_list|(
name|work
argument_list|)
expr_stmt|;
break|break;
case|case
name|IB_CM_REJ_RECEIVED
case|:
name|ret
operator|=
name|cm_rej_handler
argument_list|(
name|work
argument_list|)
expr_stmt|;
break|break;
case|case
name|IB_CM_REP_RECEIVED
case|:
name|ret
operator|=
name|cm_rep_handler
argument_list|(
name|work
argument_list|)
expr_stmt|;
break|break;
case|case
name|IB_CM_RTU_RECEIVED
case|:
name|ret
operator|=
name|cm_rtu_handler
argument_list|(
name|work
argument_list|)
expr_stmt|;
break|break;
case|case
name|IB_CM_USER_ESTABLISHED
case|:
name|ret
operator|=
name|cm_establish_handler
argument_list|(
name|work
argument_list|)
expr_stmt|;
break|break;
case|case
name|IB_CM_DREQ_RECEIVED
case|:
name|ret
operator|=
name|cm_dreq_handler
argument_list|(
name|work
argument_list|)
expr_stmt|;
break|break;
case|case
name|IB_CM_DREP_RECEIVED
case|:
name|ret
operator|=
name|cm_drep_handler
argument_list|(
name|work
argument_list|)
expr_stmt|;
break|break;
case|case
name|IB_CM_SIDR_REQ_RECEIVED
case|:
name|ret
operator|=
name|cm_sidr_req_handler
argument_list|(
name|work
argument_list|)
expr_stmt|;
break|break;
case|case
name|IB_CM_SIDR_REP_RECEIVED
case|:
name|ret
operator|=
name|cm_sidr_rep_handler
argument_list|(
name|work
argument_list|)
expr_stmt|;
break|break;
case|case
name|IB_CM_LAP_RECEIVED
case|:
name|ret
operator|=
name|cm_lap_handler
argument_list|(
name|work
argument_list|)
expr_stmt|;
break|break;
case|case
name|IB_CM_APR_RECEIVED
case|:
name|ret
operator|=
name|cm_apr_handler
argument_list|(
name|work
argument_list|)
expr_stmt|;
break|break;
case|case
name|IB_CM_TIMEWAIT_EXIT
case|:
name|ret
operator|=
name|cm_timewait_handler
argument_list|(
name|work
argument_list|)
expr_stmt|;
break|break;
default|default:
name|pr_debug
argument_list|(
literal|"work->cm_event.event: 0x%x\n"
argument_list|,
name|work
operator|->
name|cm_event
operator|.
name|event
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ret
condition|)
name|cm_free_work
argument_list|(
name|work
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|cm_establish
parameter_list|(
name|struct
name|ib_cm_id
modifier|*
name|cm_id
parameter_list|)
block|{
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
decl_stmt|;
name|struct
name|cm_work
modifier|*
name|work
decl_stmt|;
name|unsigned
name|long
name|flags
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|work
operator|=
name|kmalloc
argument_list|(
sizeof|sizeof
expr|*
name|work
argument_list|,
name|GFP_ATOMIC
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|work
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|cm_id_priv
operator|=
name|container_of
argument_list|(
name|cm_id
argument_list|,
expr|struct
name|cm_id_private
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cm_id
operator|->
name|state
condition|)
block|{
case|case
name|IB_CM_REP_SENT
case|:
case|case
name|IB_CM_MRA_REP_RCVD
case|:
name|cm_id
operator|->
name|state
operator|=
name|IB_CM_ESTABLISHED
expr_stmt|;
break|break;
case|case
name|IB_CM_ESTABLISHED
case|:
name|ret
operator|=
operator|-
name|EISCONN
expr_stmt|;
break|break;
default|default:
name|pr_debug
argument_list|(
literal|"cm_id->state: 0x%x\n"
argument_list|,
name|cm_id
operator|->
name|state
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
break|break;
block|}
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|kfree
argument_list|(
name|work
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* 	 * The CM worker thread may try to destroy the cm_id before it 	 * can execute this work item.  To prevent potential deadlock, 	 * we need to find the cm_id once we're in the context of the 	 * worker thread, rather than holding a reference on it. 	 */
name|INIT_DELAYED_WORK
argument_list|(
operator|&
name|work
operator|->
name|work
argument_list|,
name|cm_work_handler
argument_list|)
expr_stmt|;
name|work
operator|->
name|local_id
operator|=
name|cm_id
operator|->
name|local_id
expr_stmt|;
name|work
operator|->
name|remote_id
operator|=
name|cm_id
operator|->
name|remote_id
expr_stmt|;
name|work
operator|->
name|mad_recv_wc
operator|=
name|NULL
expr_stmt|;
name|work
operator|->
name|cm_event
operator|.
name|event
operator|=
name|IB_CM_USER_ESTABLISHED
expr_stmt|;
name|queue_delayed_work
argument_list|(
name|cm
operator|.
name|wq
argument_list|,
operator|&
name|work
operator|->
name|work
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|out
label|:
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cm_migrate
parameter_list|(
name|struct
name|ib_cm_id
modifier|*
name|cm_id
parameter_list|)
block|{
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
decl_stmt|;
name|unsigned
name|long
name|flags
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|cm_id_priv
operator|=
name|container_of
argument_list|(
name|cm_id
argument_list|,
expr|struct
name|cm_id_private
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|cm_id
operator|->
name|state
operator|==
name|IB_CM_ESTABLISHED
operator|&&
operator|(
name|cm_id
operator|->
name|lap_state
operator|==
name|IB_CM_LAP_UNINIT
operator|||
name|cm_id
operator|->
name|lap_state
operator|==
name|IB_CM_LAP_IDLE
operator|)
condition|)
block|{
name|cm_id
operator|->
name|lap_state
operator|=
name|IB_CM_LAP_IDLE
expr_stmt|;
name|cm_id_priv
operator|->
name|av
operator|=
name|cm_id_priv
operator|->
name|alt_av
expr_stmt|;
block|}
else|else
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|ib_cm_notify
parameter_list|(
name|struct
name|ib_cm_id
modifier|*
name|cm_id
parameter_list|,
name|enum
name|ib_event_type
name|event
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
switch|switch
condition|(
name|event
condition|)
block|{
case|case
name|IB_EVENT_COMM_EST
case|:
name|ret
operator|=
name|cm_establish
argument_list|(
name|cm_id
argument_list|)
expr_stmt|;
break|break;
case|case
name|IB_EVENT_PATH_MIG
case|:
name|ret
operator|=
name|cm_migrate
argument_list|(
name|cm_id
argument_list|)
expr_stmt|;
break|break;
default|default:
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL
argument_list|(
name|ib_cm_notify
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|void
name|cm_recv_handler
parameter_list|(
name|struct
name|ib_mad_agent
modifier|*
name|mad_agent
parameter_list|,
name|struct
name|ib_mad_recv_wc
modifier|*
name|mad_recv_wc
parameter_list|)
block|{
name|struct
name|cm_port
modifier|*
name|port
init|=
name|mad_agent
operator|->
name|context
decl_stmt|;
name|struct
name|cm_work
modifier|*
name|work
decl_stmt|;
name|enum
name|ib_cm_event_type
name|event
decl_stmt|;
name|u16
name|attr_id
decl_stmt|;
name|int
name|paths
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|mad_recv_wc
operator|->
name|recv_buf
operator|.
name|mad
operator|->
name|mad_hdr
operator|.
name|attr_id
condition|)
block|{
case|case
name|CM_REQ_ATTR_ID
case|:
name|paths
operator|=
literal|1
operator|+
operator|(
operator|(
operator|(
expr|struct
name|cm_req_msg
operator|*
operator|)
name|mad_recv_wc
operator|->
name|recv_buf
operator|.
name|mad
operator|)
operator|->
name|alt_local_lid
operator|!=
literal|0
operator|)
expr_stmt|;
name|event
operator|=
name|IB_CM_REQ_RECEIVED
expr_stmt|;
break|break;
case|case
name|CM_MRA_ATTR_ID
case|:
name|event
operator|=
name|IB_CM_MRA_RECEIVED
expr_stmt|;
break|break;
case|case
name|CM_REJ_ATTR_ID
case|:
name|event
operator|=
name|IB_CM_REJ_RECEIVED
expr_stmt|;
break|break;
case|case
name|CM_REP_ATTR_ID
case|:
name|event
operator|=
name|IB_CM_REP_RECEIVED
expr_stmt|;
break|break;
case|case
name|CM_RTU_ATTR_ID
case|:
name|event
operator|=
name|IB_CM_RTU_RECEIVED
expr_stmt|;
break|break;
case|case
name|CM_DREQ_ATTR_ID
case|:
name|event
operator|=
name|IB_CM_DREQ_RECEIVED
expr_stmt|;
break|break;
case|case
name|CM_DREP_ATTR_ID
case|:
name|event
operator|=
name|IB_CM_DREP_RECEIVED
expr_stmt|;
break|break;
case|case
name|CM_SIDR_REQ_ATTR_ID
case|:
name|event
operator|=
name|IB_CM_SIDR_REQ_RECEIVED
expr_stmt|;
break|break;
case|case
name|CM_SIDR_REP_ATTR_ID
case|:
name|event
operator|=
name|IB_CM_SIDR_REP_RECEIVED
expr_stmt|;
break|break;
case|case
name|CM_LAP_ATTR_ID
case|:
name|paths
operator|=
literal|1
expr_stmt|;
name|event
operator|=
name|IB_CM_LAP_RECEIVED
expr_stmt|;
break|break;
case|case
name|CM_APR_ATTR_ID
case|:
name|event
operator|=
name|IB_CM_APR_RECEIVED
expr_stmt|;
break|break;
default|default:
name|ib_free_recv_mad
argument_list|(
name|mad_recv_wc
argument_list|)
expr_stmt|;
return|return;
block|}
name|attr_id
operator|=
name|be16_to_cpu
argument_list|(
name|mad_recv_wc
operator|->
name|recv_buf
operator|.
name|mad
operator|->
name|mad_hdr
operator|.
name|attr_id
argument_list|)
expr_stmt|;
name|atomic_long_inc
argument_list|(
operator|&
name|port
operator|->
name|counter_group
index|[
name|CM_RECV
index|]
operator|.
name|counter
index|[
name|attr_id
operator|-
name|CM_ATTR_ID_OFFSET
index|]
argument_list|)
expr_stmt|;
name|work
operator|=
name|kmalloc
argument_list|(
sizeof|sizeof
expr|*
name|work
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|ib_sa_path_rec
argument_list|)
operator|*
name|paths
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|work
condition|)
block|{
name|ib_free_recv_mad
argument_list|(
name|mad_recv_wc
argument_list|)
expr_stmt|;
return|return;
block|}
name|INIT_DELAYED_WORK
argument_list|(
operator|&
name|work
operator|->
name|work
argument_list|,
name|cm_work_handler
argument_list|)
expr_stmt|;
name|work
operator|->
name|cm_event
operator|.
name|event
operator|=
name|event
expr_stmt|;
name|work
operator|->
name|mad_recv_wc
operator|=
name|mad_recv_wc
expr_stmt|;
name|work
operator|->
name|port
operator|=
name|port
expr_stmt|;
name|queue_delayed_work
argument_list|(
name|cm
operator|.
name|wq
argument_list|,
operator|&
name|work
operator|->
name|work
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|cm_init_qp_init_attr
parameter_list|(
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
parameter_list|,
name|struct
name|ib_qp_attr
modifier|*
name|qp_attr
parameter_list|,
name|int
modifier|*
name|qp_attr_mask
parameter_list|)
block|{
name|unsigned
name|long
name|flags
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cm_id_priv
operator|->
name|id
operator|.
name|state
condition|)
block|{
case|case
name|IB_CM_REQ_SENT
case|:
case|case
name|IB_CM_MRA_REQ_RCVD
case|:
case|case
name|IB_CM_REQ_RCVD
case|:
case|case
name|IB_CM_MRA_REQ_SENT
case|:
case|case
name|IB_CM_REP_RCVD
case|:
case|case
name|IB_CM_MRA_REP_SENT
case|:
case|case
name|IB_CM_REP_SENT
case|:
case|case
name|IB_CM_MRA_REP_RCVD
case|:
case|case
name|IB_CM_ESTABLISHED
case|:
operator|*
name|qp_attr_mask
operator|=
name|IB_QP_STATE
operator||
name|IB_QP_ACCESS_FLAGS
operator||
name|IB_QP_PKEY_INDEX
operator||
name|IB_QP_PORT
expr_stmt|;
name|qp_attr
operator|->
name|qp_access_flags
operator|=
name|IB_ACCESS_REMOTE_WRITE
expr_stmt|;
if|if
condition|(
name|cm_id_priv
operator|->
name|responder_resources
condition|)
name|qp_attr
operator|->
name|qp_access_flags
operator||=
name|IB_ACCESS_REMOTE_READ
operator||
name|IB_ACCESS_REMOTE_ATOMIC
expr_stmt|;
name|qp_attr
operator|->
name|pkey_index
operator|=
name|cm_id_priv
operator|->
name|av
operator|.
name|pkey_index
expr_stmt|;
name|qp_attr
operator|->
name|port_num
operator|=
name|cm_id_priv
operator|->
name|av
operator|.
name|port
operator|->
name|port_num
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
break|break;
default|default:
name|pr_debug
argument_list|(
literal|"cm_id_priv->id.state: 0x%x\n"
argument_list|,
name|cm_id_priv
operator|->
name|id
operator|.
name|state
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
break|break;
block|}
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cm_init_qp_rtr_attr
parameter_list|(
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
parameter_list|,
name|struct
name|ib_qp_attr
modifier|*
name|qp_attr
parameter_list|,
name|int
modifier|*
name|qp_attr_mask
parameter_list|)
block|{
name|unsigned
name|long
name|flags
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cm_id_priv
operator|->
name|id
operator|.
name|state
condition|)
block|{
case|case
name|IB_CM_REQ_RCVD
case|:
case|case
name|IB_CM_MRA_REQ_SENT
case|:
case|case
name|IB_CM_REP_RCVD
case|:
case|case
name|IB_CM_MRA_REP_SENT
case|:
case|case
name|IB_CM_REP_SENT
case|:
case|case
name|IB_CM_MRA_REP_RCVD
case|:
case|case
name|IB_CM_ESTABLISHED
case|:
operator|*
name|qp_attr_mask
operator|=
name|IB_QP_STATE
operator||
name|IB_QP_AV
operator||
name|IB_QP_PATH_MTU
operator||
name|IB_QP_DEST_QPN
operator||
name|IB_QP_RQ_PSN
expr_stmt|;
name|qp_attr
operator|->
name|ah_attr
operator|=
name|cm_id_priv
operator|->
name|av
operator|.
name|ah_attr
expr_stmt|;
if|if
condition|(
operator|!
name|cm_id_priv
operator|->
name|av
operator|.
name|valid
condition|)
return|return
operator|-
name|EINVAL
return|;
if|if
condition|(
name|cm_id_priv
operator|->
name|av
operator|.
name|ah_attr
operator|.
name|vlan_id
operator|!=
literal|0xffff
condition|)
block|{
name|qp_attr
operator|->
name|vlan_id
operator|=
name|cm_id_priv
operator|->
name|av
operator|.
name|ah_attr
operator|.
name|vlan_id
expr_stmt|;
operator|*
name|qp_attr_mask
operator||=
name|IB_QP_VID
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|is_zero_ether_addr
argument_list|(
name|cm_id_priv
operator|->
name|av
operator|.
name|smac
argument_list|)
condition|)
block|{
name|memcpy
argument_list|(
name|qp_attr
operator|->
name|smac
argument_list|,
name|cm_id_priv
operator|->
name|av
operator|.
name|smac
argument_list|,
sizeof|sizeof
argument_list|(
name|qp_attr
operator|->
name|smac
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|qp_attr_mask
operator||=
name|IB_QP_SMAC
expr_stmt|;
block|}
if|if
condition|(
name|cm_id_priv
operator|->
name|alt_av
operator|.
name|valid
condition|)
block|{
if|if
condition|(
name|cm_id_priv
operator|->
name|alt_av
operator|.
name|ah_attr
operator|.
name|vlan_id
operator|!=
literal|0xffff
condition|)
block|{
name|qp_attr
operator|->
name|alt_vlan_id
operator|=
name|cm_id_priv
operator|->
name|alt_av
operator|.
name|ah_attr
operator|.
name|vlan_id
expr_stmt|;
operator|*
name|qp_attr_mask
operator||=
name|IB_QP_ALT_VID
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|is_zero_ether_addr
argument_list|(
name|cm_id_priv
operator|->
name|alt_av
operator|.
name|smac
argument_list|)
condition|)
block|{
name|memcpy
argument_list|(
name|qp_attr
operator|->
name|alt_smac
argument_list|,
name|cm_id_priv
operator|->
name|alt_av
operator|.
name|smac
argument_list|,
sizeof|sizeof
argument_list|(
name|qp_attr
operator|->
name|alt_smac
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|qp_attr_mask
operator||=
name|IB_QP_ALT_SMAC
expr_stmt|;
block|}
block|}
name|qp_attr
operator|->
name|path_mtu
operator|=
name|cm_id_priv
operator|->
name|path_mtu
expr_stmt|;
name|qp_attr
operator|->
name|dest_qp_num
operator|=
name|be32_to_cpu
argument_list|(
name|cm_id_priv
operator|->
name|remote_qpn
argument_list|)
expr_stmt|;
name|qp_attr
operator|->
name|rq_psn
operator|=
name|be32_to_cpu
argument_list|(
name|cm_id_priv
operator|->
name|rq_psn
argument_list|)
expr_stmt|;
if|if
condition|(
name|cm_id_priv
operator|->
name|qp_type
operator|==
name|IB_QPT_RC
operator|||
name|cm_id_priv
operator|->
name|qp_type
operator|==
name|IB_QPT_XRC_TGT
condition|)
block|{
operator|*
name|qp_attr_mask
operator||=
name|IB_QP_MAX_DEST_RD_ATOMIC
operator||
name|IB_QP_MIN_RNR_TIMER
expr_stmt|;
name|qp_attr
operator|->
name|max_dest_rd_atomic
operator|=
name|cm_id_priv
operator|->
name|responder_resources
expr_stmt|;
name|qp_attr
operator|->
name|min_rnr_timer
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|cm_id_priv
operator|->
name|alt_av
operator|.
name|ah_attr
operator|.
name|dlid
condition|)
block|{
operator|*
name|qp_attr_mask
operator||=
name|IB_QP_ALT_PATH
expr_stmt|;
name|qp_attr
operator|->
name|alt_port_num
operator|=
name|cm_id_priv
operator|->
name|alt_av
operator|.
name|port
operator|->
name|port_num
expr_stmt|;
name|qp_attr
operator|->
name|alt_pkey_index
operator|=
name|cm_id_priv
operator|->
name|alt_av
operator|.
name|pkey_index
expr_stmt|;
name|qp_attr
operator|->
name|alt_timeout
operator|=
name|cm_id_priv
operator|->
name|alt_av
operator|.
name|timeout
expr_stmt|;
name|qp_attr
operator|->
name|alt_ah_attr
operator|=
name|cm_id_priv
operator|->
name|alt_av
operator|.
name|ah_attr
expr_stmt|;
block|}
name|ret
operator|=
literal|0
expr_stmt|;
break|break;
default|default:
name|pr_debug
argument_list|(
literal|"cm_id_priv->id.state: 0x%x\n"
argument_list|,
name|cm_id_priv
operator|->
name|id
operator|.
name|state
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
break|break;
block|}
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cm_init_qp_rts_attr
parameter_list|(
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
parameter_list|,
name|struct
name|ib_qp_attr
modifier|*
name|qp_attr
parameter_list|,
name|int
modifier|*
name|qp_attr_mask
parameter_list|)
block|{
name|unsigned
name|long
name|flags
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cm_id_priv
operator|->
name|id
operator|.
name|state
condition|)
block|{
comment|/* Allow transition to RTS before sending REP */
case|case
name|IB_CM_REQ_RCVD
case|:
case|case
name|IB_CM_MRA_REQ_SENT
case|:
case|case
name|IB_CM_REP_RCVD
case|:
case|case
name|IB_CM_MRA_REP_SENT
case|:
case|case
name|IB_CM_REP_SENT
case|:
case|case
name|IB_CM_MRA_REP_RCVD
case|:
case|case
name|IB_CM_ESTABLISHED
case|:
if|if
condition|(
name|cm_id_priv
operator|->
name|id
operator|.
name|lap_state
operator|==
name|IB_CM_LAP_UNINIT
condition|)
block|{
operator|*
name|qp_attr_mask
operator|=
name|IB_QP_STATE
operator||
name|IB_QP_SQ_PSN
expr_stmt|;
name|qp_attr
operator|->
name|sq_psn
operator|=
name|be32_to_cpu
argument_list|(
name|cm_id_priv
operator|->
name|sq_psn
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cm_id_priv
operator|->
name|qp_type
condition|)
block|{
case|case
name|IB_QPT_RC
case|:
case|case
name|IB_QPT_XRC_INI
case|:
operator|*
name|qp_attr_mask
operator||=
name|IB_QP_RETRY_CNT
operator||
name|IB_QP_RNR_RETRY
operator||
name|IB_QP_MAX_QP_RD_ATOMIC
expr_stmt|;
name|qp_attr
operator|->
name|retry_cnt
operator|=
name|cm_id_priv
operator|->
name|retry_count
expr_stmt|;
name|qp_attr
operator|->
name|rnr_retry
operator|=
name|cm_id_priv
operator|->
name|rnr_retry_count
expr_stmt|;
name|qp_attr
operator|->
name|max_rd_atomic
operator|=
name|cm_id_priv
operator|->
name|initiator_depth
expr_stmt|;
comment|/* fall through */
case|case
name|IB_QPT_XRC_TGT
case|:
operator|*
name|qp_attr_mask
operator||=
name|IB_QP_TIMEOUT
expr_stmt|;
name|qp_attr
operator|->
name|timeout
operator|=
name|cm_id_priv
operator|->
name|av
operator|.
name|timeout
expr_stmt|;
break|break;
default|default:
break|break;
block|}
if|if
condition|(
name|cm_id_priv
operator|->
name|alt_av
operator|.
name|ah_attr
operator|.
name|dlid
condition|)
block|{
operator|*
name|qp_attr_mask
operator||=
name|IB_QP_PATH_MIG_STATE
expr_stmt|;
name|qp_attr
operator|->
name|path_mig_state
operator|=
name|IB_MIG_REARM
expr_stmt|;
block|}
block|}
else|else
block|{
operator|*
name|qp_attr_mask
operator|=
name|IB_QP_ALT_PATH
operator||
name|IB_QP_PATH_MIG_STATE
expr_stmt|;
name|qp_attr
operator|->
name|alt_port_num
operator|=
name|cm_id_priv
operator|->
name|alt_av
operator|.
name|port
operator|->
name|port_num
expr_stmt|;
name|qp_attr
operator|->
name|alt_pkey_index
operator|=
name|cm_id_priv
operator|->
name|alt_av
operator|.
name|pkey_index
expr_stmt|;
name|qp_attr
operator|->
name|alt_timeout
operator|=
name|cm_id_priv
operator|->
name|alt_av
operator|.
name|timeout
expr_stmt|;
name|qp_attr
operator|->
name|alt_ah_attr
operator|=
name|cm_id_priv
operator|->
name|alt_av
operator|.
name|ah_attr
expr_stmt|;
name|qp_attr
operator|->
name|path_mig_state
operator|=
name|IB_MIG_REARM
expr_stmt|;
block|}
name|ret
operator|=
literal|0
expr_stmt|;
break|break;
default|default:
name|pr_debug
argument_list|(
literal|"cm_id_priv->id.state: 0x%x\n"
argument_list|,
name|cm_id_priv
operator|->
name|id
operator|.
name|state
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
break|break;
block|}
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|cm_id_priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|ib_cm_init_qp_attr
parameter_list|(
name|struct
name|ib_cm_id
modifier|*
name|cm_id
parameter_list|,
name|struct
name|ib_qp_attr
modifier|*
name|qp_attr
parameter_list|,
name|int
modifier|*
name|qp_attr_mask
parameter_list|)
block|{
name|struct
name|cm_id_private
modifier|*
name|cm_id_priv
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|cm_id_priv
operator|=
name|container_of
argument_list|(
name|cm_id
argument_list|,
expr|struct
name|cm_id_private
argument_list|,
name|id
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|qp_attr
operator|->
name|qp_state
condition|)
block|{
case|case
name|IB_QPS_INIT
case|:
name|ret
operator|=
name|cm_init_qp_init_attr
argument_list|(
name|cm_id_priv
argument_list|,
name|qp_attr
argument_list|,
name|qp_attr_mask
argument_list|)
expr_stmt|;
break|break;
case|case
name|IB_QPS_RTR
case|:
name|ret
operator|=
name|cm_init_qp_rtr_attr
argument_list|(
name|cm_id_priv
argument_list|,
name|qp_attr
argument_list|,
name|qp_attr_mask
argument_list|)
expr_stmt|;
break|break;
case|case
name|IB_QPS_RTS
case|:
name|ret
operator|=
name|cm_init_qp_rts_attr
argument_list|(
name|cm_id_priv
argument_list|,
name|qp_attr
argument_list|,
name|qp_attr_mask
argument_list|)
expr_stmt|;
break|break;
default|default:
name|pr_debug
argument_list|(
literal|"qp_attr->qp_state: 0x%x\n"
argument_list|,
name|qp_attr
operator|->
name|qp_state
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
break|break;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL
argument_list|(
name|ib_cm_init_qp_attr
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|void
name|cm_get_ack_delay
parameter_list|(
name|struct
name|cm_device
modifier|*
name|cm_dev
parameter_list|)
block|{
name|struct
name|ib_device_attr
name|attr
decl_stmt|;
if|if
condition|(
name|ib_query_device
argument_list|(
name|cm_dev
operator|->
name|ib_device
argument_list|,
operator|&
name|attr
argument_list|)
condition|)
name|cm_dev
operator|->
name|ack_delay
operator|=
literal|0
expr_stmt|;
comment|/* acks will rely on packet life time */
else|else
name|cm_dev
operator|->
name|ack_delay
operator|=
name|attr
operator|.
name|local_ca_ack_delay
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|cm_show_counter
parameter_list|(
name|struct
name|kobject
modifier|*
name|obj
parameter_list|,
name|struct
name|attribute
modifier|*
name|attr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|cm_counter_group
modifier|*
name|group
decl_stmt|;
name|struct
name|cm_counter_attribute
modifier|*
name|cm_attr
decl_stmt|;
name|group
operator|=
name|container_of
argument_list|(
name|obj
argument_list|,
expr|struct
name|cm_counter_group
argument_list|,
name|obj
argument_list|)
expr_stmt|;
name|cm_attr
operator|=
name|container_of
argument_list|(
name|attr
argument_list|,
expr|struct
name|cm_counter_attribute
argument_list|,
name|attr
argument_list|)
expr_stmt|;
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%ld\n"
argument_list|,
name|atomic_long_read
argument_list|(
operator|&
name|group
operator|->
name|counter
index|[
name|cm_attr
operator|->
name|index
index|]
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|sysfs_ops
name|cm_counter_ops
init|=
block|{
operator|.
name|show
operator|=
name|cm_show_counter
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|kobj_type
name|cm_counter_obj_type
init|=
block|{
operator|.
name|sysfs_ops
operator|=
operator|&
name|cm_counter_ops
block|,
operator|.
name|default_attrs
operator|=
name|cm_counter_default_attrs
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|cm_release_port_obj
parameter_list|(
name|struct
name|kobject
modifier|*
name|obj
parameter_list|)
block|{
name|struct
name|cm_port
modifier|*
name|cm_port
decl_stmt|;
name|cm_port
operator|=
name|container_of
argument_list|(
name|obj
argument_list|,
expr|struct
name|cm_port
argument_list|,
name|port_obj
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|cm_port
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
name|struct
name|kobj_type
name|cm_port_obj_type
init|=
block|{
operator|.
name|release
operator|=
name|cm_release_port_obj
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|char
modifier|*
name|cm_devnode
parameter_list|(
name|struct
name|device
modifier|*
name|dev
parameter_list|,
name|umode_t
modifier|*
name|mode
parameter_list|)
block|{
if|if
condition|(
name|mode
condition|)
operator|*
name|mode
operator|=
literal|0666
expr_stmt|;
return|return
name|kasprintf
argument_list|(
name|GFP_KERNEL
argument_list|,
literal|"infiniband/%s"
argument_list|,
name|dev_name
argument_list|(
name|dev
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_decl_stmt
name|struct
name|class
name|cm_class
init|=
block|{
operator|.
name|owner
operator|=
name|THIS_MODULE
block|,
operator|.
name|name
operator|=
literal|"infiniband_cm"
block|,
operator|.
name|devnode
operator|=
name|cm_devnode
block|, }
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|EXPORT_SYMBOL
argument_list|(
name|cm_class
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|int
name|cm_create_port_fs
parameter_list|(
name|struct
name|cm_port
modifier|*
name|port
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|ret
decl_stmt|;
name|ret
operator|=
name|kobject_init_and_add
argument_list|(
operator|&
name|port
operator|->
name|port_obj
argument_list|,
operator|&
name|cm_port_obj_type
argument_list|,
operator|&
name|port
operator|->
name|cm_dev
operator|->
name|device
operator|->
name|kobj
argument_list|,
literal|"%d"
argument_list|,
name|port
operator|->
name|port_num
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|kfree
argument_list|(
name|port
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|CM_COUNTER_GROUPS
condition|;
name|i
operator|++
control|)
block|{
name|ret
operator|=
name|kobject_init_and_add
argument_list|(
operator|&
name|port
operator|->
name|counter_group
index|[
name|i
index|]
operator|.
name|obj
argument_list|,
operator|&
name|cm_counter_obj_type
argument_list|,
operator|&
name|port
operator|->
name|port_obj
argument_list|,
literal|"%s"
argument_list|,
name|counter_group_names
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|error
goto|;
block|}
return|return
literal|0
return|;
name|error
label|:
while|while
condition|(
name|i
operator|--
condition|)
name|kobject_put
argument_list|(
operator|&
name|port
operator|->
name|counter_group
index|[
name|i
index|]
operator|.
name|obj
argument_list|)
expr_stmt|;
name|kobject_put
argument_list|(
operator|&
name|port
operator|->
name|port_obj
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|cm_remove_port_fs
parameter_list|(
name|struct
name|cm_port
modifier|*
name|port
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|CM_COUNTER_GROUPS
condition|;
name|i
operator|++
control|)
name|kobject_put
argument_list|(
operator|&
name|port
operator|->
name|counter_group
index|[
name|i
index|]
operator|.
name|obj
argument_list|)
expr_stmt|;
name|kobject_put
argument_list|(
operator|&
name|port
operator|->
name|port_obj
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|cm_add_one
parameter_list|(
name|struct
name|ib_device
modifier|*
name|ib_device
parameter_list|)
block|{
name|struct
name|cm_device
modifier|*
name|cm_dev
decl_stmt|;
name|struct
name|cm_port
modifier|*
name|port
decl_stmt|;
name|struct
name|ib_mad_reg_req
name|reg_req
init|=
block|{
operator|.
name|mgmt_class
operator|=
name|IB_MGMT_CLASS_CM
block|,
operator|.
name|mgmt_class_version
operator|=
name|IB_CM_CLASS_VERSION
block|}
decl_stmt|;
name|struct
name|ib_port_modify
name|port_modify
init|=
block|{
operator|.
name|set_port_cap_mask
operator|=
name|IB_PORT_CM_SUP
block|}
decl_stmt|;
name|unsigned
name|long
name|flags
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|u8
name|i
decl_stmt|;
if|if
condition|(
name|rdma_node_get_transport
argument_list|(
name|ib_device
operator|->
name|node_type
argument_list|)
operator|!=
name|RDMA_TRANSPORT_IB
condition|)
return|return;
name|cm_dev
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|cm_dev
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|port
argument_list|)
operator|*
name|ib_device
operator|->
name|phys_port_cnt
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cm_dev
condition|)
return|return;
name|cm_dev
operator|->
name|ib_device
operator|=
name|ib_device
expr_stmt|;
name|cm_get_ack_delay
argument_list|(
name|cm_dev
argument_list|)
expr_stmt|;
name|cm_dev
operator|->
name|device
operator|=
name|device_create
argument_list|(
operator|&
name|cm_class
argument_list|,
operator|&
name|ib_device
operator|->
name|dev
argument_list|,
name|MKDEV
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|"%s"
argument_list|,
name|ib_device
operator|->
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|cm_dev
operator|->
name|device
argument_list|)
condition|)
block|{
name|kfree
argument_list|(
name|cm_dev
argument_list|)
expr_stmt|;
return|return;
block|}
name|set_bit
argument_list|(
name|IB_MGMT_METHOD_SEND
argument_list|,
name|reg_req
operator|.
name|method_mask
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
name|ib_device
operator|->
name|phys_port_cnt
condition|;
name|i
operator|++
control|)
block|{
name|port
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
expr|*
name|port
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|port
condition|)
goto|goto
name|error1
goto|;
name|cm_dev
operator|->
name|port
index|[
name|i
operator|-
literal|1
index|]
operator|=
name|port
expr_stmt|;
name|port
operator|->
name|cm_dev
operator|=
name|cm_dev
expr_stmt|;
name|port
operator|->
name|port_num
operator|=
name|i
expr_stmt|;
name|ret
operator|=
name|cm_create_port_fs
argument_list|(
name|port
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|error1
goto|;
name|port
operator|->
name|mad_agent
operator|=
name|ib_register_mad_agent
argument_list|(
name|ib_device
argument_list|,
name|i
argument_list|,
name|IB_QPT_GSI
argument_list|,
operator|&
name|reg_req
argument_list|,
literal|0
argument_list|,
name|cm_send_handler
argument_list|,
name|cm_recv_handler
argument_list|,
name|port
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|port
operator|->
name|mad_agent
argument_list|)
condition|)
goto|goto
name|error2
goto|;
name|ret
operator|=
name|ib_modify_port
argument_list|(
name|ib_device
argument_list|,
name|i
argument_list|,
literal|0
argument_list|,
operator|&
name|port_modify
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|error3
goto|;
block|}
name|ib_set_client_data
argument_list|(
name|ib_device
argument_list|,
operator|&
name|cm_client
argument_list|,
name|cm_dev
argument_list|)
expr_stmt|;
name|write_lock_irqsave
argument_list|(
operator|&
name|cm
operator|.
name|device_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|list_add_tail
argument_list|(
operator|&
name|cm_dev
operator|->
name|list
argument_list|,
operator|&
name|cm
operator|.
name|device_list
argument_list|)
expr_stmt|;
name|write_unlock_irqrestore
argument_list|(
operator|&
name|cm
operator|.
name|device_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
return|return;
name|error3
label|:
name|ib_unregister_mad_agent
argument_list|(
name|port
operator|->
name|mad_agent
argument_list|)
expr_stmt|;
name|error2
label|:
name|cm_remove_port_fs
argument_list|(
name|port
argument_list|)
expr_stmt|;
name|error1
label|:
name|port_modify
operator|.
name|set_port_cap_mask
operator|=
literal|0
expr_stmt|;
name|port_modify
operator|.
name|clr_port_cap_mask
operator|=
name|IB_PORT_CM_SUP
expr_stmt|;
while|while
condition|(
operator|--
name|i
condition|)
block|{
name|port
operator|=
name|cm_dev
operator|->
name|port
index|[
name|i
operator|-
literal|1
index|]
expr_stmt|;
name|ib_modify_port
argument_list|(
name|ib_device
argument_list|,
name|port
operator|->
name|port_num
argument_list|,
literal|0
argument_list|,
operator|&
name|port_modify
argument_list|)
expr_stmt|;
name|ib_unregister_mad_agent
argument_list|(
name|port
operator|->
name|mad_agent
argument_list|)
expr_stmt|;
name|cm_remove_port_fs
argument_list|(
name|port
argument_list|)
expr_stmt|;
block|}
name|device_unregister
argument_list|(
name|cm_dev
operator|->
name|device
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|cm_dev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|cm_remove_one
parameter_list|(
name|struct
name|ib_device
modifier|*
name|ib_device
parameter_list|)
block|{
name|struct
name|cm_device
modifier|*
name|cm_dev
decl_stmt|;
name|struct
name|cm_port
modifier|*
name|port
decl_stmt|;
name|struct
name|ib_port_modify
name|port_modify
init|=
block|{
operator|.
name|clr_port_cap_mask
operator|=
name|IB_PORT_CM_SUP
block|}
decl_stmt|;
name|unsigned
name|long
name|flags
decl_stmt|;
name|int
name|i
decl_stmt|;
name|cm_dev
operator|=
name|ib_get_client_data
argument_list|(
name|ib_device
argument_list|,
operator|&
name|cm_client
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cm_dev
condition|)
return|return;
name|write_lock_irqsave
argument_list|(
operator|&
name|cm
operator|.
name|device_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|list_del
argument_list|(
operator|&
name|cm_dev
operator|->
name|list
argument_list|)
expr_stmt|;
name|write_unlock_irqrestore
argument_list|(
operator|&
name|cm
operator|.
name|device_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
name|ib_device
operator|->
name|phys_port_cnt
condition|;
name|i
operator|++
control|)
block|{
name|port
operator|=
name|cm_dev
operator|->
name|port
index|[
name|i
operator|-
literal|1
index|]
expr_stmt|;
name|ib_modify_port
argument_list|(
name|ib_device
argument_list|,
name|port
operator|->
name|port_num
argument_list|,
literal|0
argument_list|,
operator|&
name|port_modify
argument_list|)
expr_stmt|;
name|ib_unregister_mad_agent
argument_list|(
name|port
operator|->
name|mad_agent
argument_list|)
expr_stmt|;
name|flush_workqueue
argument_list|(
name|cm
operator|.
name|wq
argument_list|)
expr_stmt|;
name|cm_remove_port_fs
argument_list|(
name|port
argument_list|)
expr_stmt|;
block|}
name|device_unregister
argument_list|(
name|cm_dev
operator|->
name|device
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|cm_dev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|__init
name|ib_cm_init
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|memset
argument_list|(
operator|&
name|cm
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|cm
argument_list|)
expr_stmt|;
name|INIT_LIST_HEAD
argument_list|(
operator|&
name|cm
operator|.
name|device_list
argument_list|)
expr_stmt|;
name|rwlock_init
argument_list|(
operator|&
name|cm
operator|.
name|device_lock
argument_list|)
expr_stmt|;
name|spin_lock_init
argument_list|(
operator|&
name|cm
operator|.
name|lock
argument_list|)
expr_stmt|;
name|cm
operator|.
name|listen_service_table
operator|=
name|RB_ROOT
expr_stmt|;
name|cm
operator|.
name|listen_service_id
operator|=
name|be64_to_cpu
argument_list|(
name|IB_CM_ASSIGN_SERVICE_ID
argument_list|)
expr_stmt|;
name|cm
operator|.
name|remote_id_table
operator|=
name|RB_ROOT
expr_stmt|;
name|cm
operator|.
name|remote_qp_table
operator|=
name|RB_ROOT
expr_stmt|;
name|cm
operator|.
name|remote_sidr_table
operator|=
name|RB_ROOT
expr_stmt|;
name|idr_init
argument_list|(
operator|&
name|cm
operator|.
name|local_id_table
argument_list|)
expr_stmt|;
name|get_random_bytes
argument_list|(
operator|&
name|cm
operator|.
name|random_id_operand
argument_list|,
sizeof|sizeof
name|cm
operator|.
name|random_id_operand
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|idr_pre_get
argument_list|(
operator|&
name|cm
operator|.
name|local_id_table
argument_list|,
name|GFP_KERNEL
argument_list|)
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|INIT_LIST_HEAD
argument_list|(
operator|&
name|cm
operator|.
name|timewait_list
argument_list|)
expr_stmt|;
name|ret
operator|=
name|class_register
argument_list|(
operator|&
name|cm_class
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|ret
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|error1
goto|;
block|}
name|cm
operator|.
name|wq
operator|=
name|create_workqueue
argument_list|(
literal|"ib_cm"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cm
operator|.
name|wq
condition|)
block|{
name|ret
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|error2
goto|;
block|}
name|ret
operator|=
name|ib_register_client
argument_list|(
operator|&
name|cm_client
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|error3
goto|;
return|return
literal|0
return|;
name|error3
label|:
name|destroy_workqueue
argument_list|(
name|cm
operator|.
name|wq
argument_list|)
expr_stmt|;
name|error2
label|:
name|class_unregister
argument_list|(
operator|&
name|cm_class
argument_list|)
expr_stmt|;
name|error1
label|:
name|idr_destroy
argument_list|(
operator|&
name|cm
operator|.
name|local_id_table
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|__exit
name|ib_cm_cleanup
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|cm_timewait_info
modifier|*
name|timewait_info
decl_stmt|,
modifier|*
name|tmp
decl_stmt|;
name|spin_lock_irq
argument_list|(
operator|&
name|cm
operator|.
name|lock
argument_list|)
expr_stmt|;
name|list_for_each_entry
argument_list|(
argument|timewait_info
argument_list|,
argument|&cm.timewait_list
argument_list|,
argument|list
argument_list|)
name|cancel_delayed_work
argument_list|(
operator|&
name|timewait_info
operator|->
name|work
operator|.
name|work
argument_list|)
expr_stmt|;
name|spin_unlock_irq
argument_list|(
operator|&
name|cm
operator|.
name|lock
argument_list|)
expr_stmt|;
name|ib_unregister_client
argument_list|(
operator|&
name|cm_client
argument_list|)
expr_stmt|;
name|destroy_workqueue
argument_list|(
name|cm
operator|.
name|wq
argument_list|)
expr_stmt|;
name|list_for_each_entry_safe
argument_list|(
argument|timewait_info
argument_list|,
argument|tmp
argument_list|,
argument|&cm.timewait_list
argument_list|,
argument|list
argument_list|)
block|{
name|list_del
argument_list|(
operator|&
name|timewait_info
operator|->
name|list
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|timewait_info
argument_list|)
expr_stmt|;
block|}
name|class_unregister
argument_list|(
operator|&
name|cm_class
argument_list|)
expr_stmt|;
name|idr_destroy
argument_list|(
operator|&
name|cm
operator|.
name|local_id_table
argument_list|)
expr_stmt|;
block|}
end_function

begin_expr_stmt
name|module_init_order
argument_list|(
name|ib_cm_init
argument_list|,
name|SI_ORDER_SECOND
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|module_exit_order
argument_list|(
name|ib_cm_cleanup
argument_list|,
name|SI_ORDER_FIRST
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


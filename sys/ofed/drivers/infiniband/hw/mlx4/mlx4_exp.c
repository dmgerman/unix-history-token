begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2006, 2007 Cisco Systems, Inc. All rights reserved.  * Copyright (c) 2007, 2008 Mellanox Technologies. All rights reserved.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  */
end_comment

begin_include
include|#
directive|include
file|"mlx4_ib.h"
end_include

begin_include
include|#
directive|include
file|"mlx4_exp.h"
end_include

begin_include
include|#
directive|include
file|<linux/mlx4/qp.h>
end_include

begin_function
name|int
name|mlx4_ib_exp_query_device
parameter_list|(
name|struct
name|ib_device
modifier|*
name|ibdev
parameter_list|,
name|struct
name|ib_exp_device_attr
modifier|*
name|props
parameter_list|)
block|{
name|struct
name|ib_device_attr
modifier|*
name|base
init|=
operator|&
name|props
operator|->
name|base
decl_stmt|;
name|struct
name|mlx4_ib_dev
modifier|*
name|dev
init|=
name|to_mdev
argument_list|(
name|ibdev
argument_list|)
decl_stmt|;
name|int
name|ret
init|=
name|mlx4_ib_query_device
argument_list|(
name|ibdev
argument_list|,
operator|&
name|props
operator|->
name|base
argument_list|)
decl_stmt|;
name|props
operator|->
name|exp_comp_mask
operator|=
name|IB_EXP_DEVICE_ATTR_INLINE_RECV_SZ
expr_stmt|;
name|props
operator|->
name|inline_recv_sz
operator|=
name|dev
operator|->
name|dev
operator|->
name|caps
operator|.
name|max_rq_sg
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|mlx4_wqe_data_seg
argument_list|)
expr_stmt|;
name|props
operator|->
name|device_cap_flags2
operator|=
literal|0
expr_stmt|;
comment|/* move RSS device cap from device_cap to device_cap_flags2 */
if|if
condition|(
name|base
operator|->
name|device_cap_flags
operator|&
name|IB_DEVICE_QPG
condition|)
block|{
name|props
operator|->
name|device_cap_flags2
operator||=
name|IB_EXP_DEVICE_QPG
expr_stmt|;
if|if
condition|(
name|base
operator|->
name|device_cap_flags
operator|&
name|IB_DEVICE_UD_RSS
condition|)
name|props
operator|->
name|device_cap_flags2
operator||=
name|IB_EXP_DEVICE_UD_RSS
expr_stmt|;
block|}
name|base
operator|->
name|device_cap_flags
operator|&=
operator|~
operator|(
name|IB_DEVICE_QPG
operator||
name|IB_DEVICE_UD_RSS
operator||
name|IB_DEVICE_UD_TSS
operator|)
expr_stmt|;
if|if
condition|(
name|base
operator|->
name|max_rss_tbl_sz
operator|>
literal|0
condition|)
block|{
name|props
operator|->
name|max_rss_tbl_sz
operator|=
name|base
operator|->
name|max_rss_tbl_sz
expr_stmt|;
name|props
operator|->
name|exp_comp_mask
operator||=
name|IB_EXP_DEVICE_ATTR_RSS_TBL_SZ
expr_stmt|;
block|}
else|else
block|{
name|props
operator|->
name|max_rss_tbl_sz
operator|=
literal|0
expr_stmt|;
name|props
operator|->
name|exp_comp_mask
operator|&=
operator|~
name|IB_EXP_DEVICE_ATTR_RSS_TBL_SZ
expr_stmt|;
block|}
if|if
condition|(
name|props
operator|->
name|device_cap_flags2
condition|)
name|props
operator|->
name|exp_comp_mask
operator||=
name|IB_EXP_DEVICE_ATTR_CAP_FLAGS2
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*  * Experimental functions  */
end_comment

begin_function
name|struct
name|ib_qp
modifier|*
name|mlx4_ib_exp_create_qp
parameter_list|(
name|struct
name|ib_pd
modifier|*
name|pd
parameter_list|,
name|struct
name|ib_exp_qp_init_attr
modifier|*
name|init_attr
parameter_list|,
name|struct
name|ib_udata
modifier|*
name|udata
parameter_list|)
block|{
name|int
name|rwqe_size
decl_stmt|;
name|struct
name|ib_qp
modifier|*
name|qp
decl_stmt|;
name|struct
name|mlx4_ib_qp
modifier|*
name|mqp
decl_stmt|;
name|int
name|use_inlr
decl_stmt|;
name|struct
name|mlx4_ib_dev
modifier|*
name|dev
decl_stmt|;
if|if
condition|(
name|init_attr
operator|->
name|max_inl_recv
operator|&&
operator|!
name|udata
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|EINVAL
argument_list|)
return|;
name|use_inlr
operator|=
name|mlx4_ib_qp_has_rq
argument_list|(
operator|(
expr|struct
name|ib_qp_init_attr
operator|*
operator|)
name|init_attr
argument_list|)
operator|&&
name|init_attr
operator|->
name|max_inl_recv
operator|&&
name|pd
expr_stmt|;
if|if
condition|(
name|use_inlr
condition|)
block|{
name|rwqe_size
operator|=
name|roundup_pow_of_two
argument_list|(
name|max
argument_list|(
literal|1U
argument_list|,
name|init_attr
operator|->
name|cap
operator|.
name|max_recv_sge
argument_list|)
argument_list|)
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|mlx4_wqe_data_seg
argument_list|)
expr_stmt|;
if|if
condition|(
name|rwqe_size
operator|<
name|init_attr
operator|->
name|max_inl_recv
condition|)
block|{
name|dev
operator|=
name|to_mdev
argument_list|(
name|pd
operator|->
name|device
argument_list|)
expr_stmt|;
name|init_attr
operator|->
name|max_inl_recv
operator|=
name|min
argument_list|(
name|init_attr
operator|->
name|max_inl_recv
argument_list|,
call|(
name|u32
call|)
argument_list|(
name|dev
operator|->
name|dev
operator|->
name|caps
operator|.
name|max_rq_sg
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|mlx4_wqe_data_seg
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|init_attr
operator|->
name|cap
operator|.
name|max_recv_sge
operator|=
name|roundup_pow_of_two
argument_list|(
name|init_attr
operator|->
name|max_inl_recv
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|mlx4_wqe_data_seg
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|init_attr
operator|->
name|max_inl_recv
operator|=
literal|0
expr_stmt|;
block|}
name|qp
operator|=
name|mlx4_ib_create_qp
argument_list|(
name|pd
argument_list|,
operator|(
expr|struct
name|ib_qp_init_attr
operator|*
operator|)
name|init_attr
argument_list|,
name|udata
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|qp
argument_list|)
condition|)
return|return
name|qp
return|;
if|if
condition|(
name|use_inlr
condition|)
block|{
name|mqp
operator|=
name|to_mqp
argument_list|(
name|qp
argument_list|)
expr_stmt|;
name|mqp
operator|->
name|max_inlr_data
operator|=
literal|1
operator|<<
name|mqp
operator|->
name|rq
operator|.
name|wqe_shift
expr_stmt|;
name|init_attr
operator|->
name|max_inl_recv
operator|=
name|mqp
operator|->
name|max_inlr_data
expr_stmt|;
block|}
return|return
name|qp
return|;
block|}
end_function

end_unit


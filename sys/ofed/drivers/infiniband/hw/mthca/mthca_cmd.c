begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2004, 2005 Topspin Communications.  All rights reserved.  * Copyright (c) 2005 Mellanox Technologies. All rights reserved.  * Copyright (c) 2005, 2006 Cisco Systems.  All rights reserved.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  */
end_comment

begin_include
include|#
directive|include
file|<linux/completion.h>
end_include

begin_include
include|#
directive|include
file|<linux/pci.h>
end_include

begin_include
include|#
directive|include
file|<linux/errno.h>
end_include

begin_include
include|#
directive|include
file|<linux/sched.h>
end_include

begin_include
include|#
directive|include
file|<asm/io.h>
end_include

begin_include
include|#
directive|include
file|<rdma/ib_mad.h>
end_include

begin_include
include|#
directive|include
file|"mthca_dev.h"
end_include

begin_include
include|#
directive|include
file|"mthca_config_reg.h"
end_include

begin_include
include|#
directive|include
file|"mthca_cmd.h"
end_include

begin_include
include|#
directive|include
file|"mthca_memfree.h"
end_include

begin_define
define|#
directive|define
name|CMD_POLL_TOKEN
value|0xffff
end_define

begin_enum
enum|enum
block|{
name|HCR_IN_PARAM_OFFSET
init|=
literal|0x00
block|,
name|HCR_IN_MODIFIER_OFFSET
init|=
literal|0x08
block|,
name|HCR_OUT_PARAM_OFFSET
init|=
literal|0x0c
block|,
name|HCR_TOKEN_OFFSET
init|=
literal|0x14
block|,
name|HCR_STATUS_OFFSET
init|=
literal|0x18
block|,
name|HCR_OPMOD_SHIFT
init|=
literal|12
block|,
name|HCA_E_BIT
init|=
literal|22
block|,
name|HCR_GO_BIT
init|=
literal|23
block|}
enum|;
end_enum

begin_enum
enum|enum
block|{
comment|/* initialization and general commands */
name|CMD_SYS_EN
init|=
literal|0x1
block|,
name|CMD_SYS_DIS
init|=
literal|0x2
block|,
name|CMD_MAP_FA
init|=
literal|0xfff
block|,
name|CMD_UNMAP_FA
init|=
literal|0xffe
block|,
name|CMD_RUN_FW
init|=
literal|0xff6
block|,
name|CMD_MOD_STAT_CFG
init|=
literal|0x34
block|,
name|CMD_QUERY_DEV_LIM
init|=
literal|0x3
block|,
name|CMD_QUERY_FW
init|=
literal|0x4
block|,
name|CMD_ENABLE_LAM
init|=
literal|0xff8
block|,
name|CMD_DISABLE_LAM
init|=
literal|0xff7
block|,
name|CMD_QUERY_DDR
init|=
literal|0x5
block|,
name|CMD_QUERY_ADAPTER
init|=
literal|0x6
block|,
name|CMD_INIT_HCA
init|=
literal|0x7
block|,
name|CMD_CLOSE_HCA
init|=
literal|0x8
block|,
name|CMD_INIT_IB
init|=
literal|0x9
block|,
name|CMD_CLOSE_IB
init|=
literal|0xa
block|,
name|CMD_QUERY_HCA
init|=
literal|0xb
block|,
name|CMD_SET_IB
init|=
literal|0xc
block|,
name|CMD_ACCESS_DDR
init|=
literal|0x2e
block|,
name|CMD_MAP_ICM
init|=
literal|0xffa
block|,
name|CMD_UNMAP_ICM
init|=
literal|0xff9
block|,
name|CMD_MAP_ICM_AUX
init|=
literal|0xffc
block|,
name|CMD_UNMAP_ICM_AUX
init|=
literal|0xffb
block|,
name|CMD_SET_ICM_SIZE
init|=
literal|0xffd
block|,
comment|/* TPT commands */
name|CMD_SW2HW_MPT
init|=
literal|0xd
block|,
name|CMD_QUERY_MPT
init|=
literal|0xe
block|,
name|CMD_HW2SW_MPT
init|=
literal|0xf
block|,
name|CMD_READ_MTT
init|=
literal|0x10
block|,
name|CMD_WRITE_MTT
init|=
literal|0x11
block|,
name|CMD_SYNC_TPT
init|=
literal|0x2f
block|,
comment|/* EQ commands */
name|CMD_MAP_EQ
init|=
literal|0x12
block|,
name|CMD_SW2HW_EQ
init|=
literal|0x13
block|,
name|CMD_HW2SW_EQ
init|=
literal|0x14
block|,
name|CMD_QUERY_EQ
init|=
literal|0x15
block|,
comment|/* CQ commands */
name|CMD_SW2HW_CQ
init|=
literal|0x16
block|,
name|CMD_HW2SW_CQ
init|=
literal|0x17
block|,
name|CMD_QUERY_CQ
init|=
literal|0x18
block|,
name|CMD_RESIZE_CQ
init|=
literal|0x2c
block|,
comment|/* SRQ commands */
name|CMD_SW2HW_SRQ
init|=
literal|0x35
block|,
name|CMD_HW2SW_SRQ
init|=
literal|0x36
block|,
name|CMD_QUERY_SRQ
init|=
literal|0x37
block|,
name|CMD_ARM_SRQ
init|=
literal|0x40
block|,
comment|/* QP/EE commands */
name|CMD_RST2INIT_QPEE
init|=
literal|0x19
block|,
name|CMD_INIT2RTR_QPEE
init|=
literal|0x1a
block|,
name|CMD_RTR2RTS_QPEE
init|=
literal|0x1b
block|,
name|CMD_RTS2RTS_QPEE
init|=
literal|0x1c
block|,
name|CMD_SQERR2RTS_QPEE
init|=
literal|0x1d
block|,
name|CMD_2ERR_QPEE
init|=
literal|0x1e
block|,
name|CMD_RTS2SQD_QPEE
init|=
literal|0x1f
block|,
name|CMD_SQD2SQD_QPEE
init|=
literal|0x38
block|,
name|CMD_SQD2RTS_QPEE
init|=
literal|0x20
block|,
name|CMD_ERR2RST_QPEE
init|=
literal|0x21
block|,
name|CMD_QUERY_QPEE
init|=
literal|0x22
block|,
name|CMD_INIT2INIT_QPEE
init|=
literal|0x2d
block|,
name|CMD_SUSPEND_QPEE
init|=
literal|0x32
block|,
name|CMD_UNSUSPEND_QPEE
init|=
literal|0x33
block|,
comment|/* special QPs and management commands */
name|CMD_CONF_SPECIAL_QP
init|=
literal|0x23
block|,
name|CMD_MAD_IFC
init|=
literal|0x24
block|,
comment|/* multicast commands */
name|CMD_READ_MGM
init|=
literal|0x25
block|,
name|CMD_WRITE_MGM
init|=
literal|0x26
block|,
name|CMD_MGID_HASH
init|=
literal|0x27
block|,
comment|/* miscellaneous commands */
name|CMD_DIAG_RPRT
init|=
literal|0x30
block|,
name|CMD_NOP
init|=
literal|0x31
block|,
comment|/* debug commands */
name|CMD_QUERY_DEBUG_MSG
init|=
literal|0x2a
block|,
name|CMD_SET_DEBUG_MSG
init|=
literal|0x2b
block|, }
enum|;
end_enum

begin_comment
comment|/*  * According to Mellanox code, FW may be starved and never complete  * commands.  So we can't use strict timeouts described in PRM -- we  * just arbitrarily select 60 seconds for now.  */
end_comment

begin_if
if|#
directive|if
literal|0
end_if

begin_comment
comment|/*  * Round up and add 1 to make sure we get the full wait time (since we  * will be starting in the middle of a jiffy)  */
end_comment

begin_else
unit|enum { 	CMD_TIME_CLASS_A = (HZ + 999) / 1000 + 1, 	CMD_TIME_CLASS_B = (HZ +  99) /  100 + 1, 	CMD_TIME_CLASS_C = (HZ +   9) /   10 + 1, 	CMD_TIME_CLASS_D = 60 * HZ };
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|CMD_TIME_CLASS_A
value|(60 * HZ)
end_define

begin_define
define|#
directive|define
name|CMD_TIME_CLASS_B
value|(60 * HZ)
end_define

begin_define
define|#
directive|define
name|CMD_TIME_CLASS_C
value|(60 * HZ)
end_define

begin_define
define|#
directive|define
name|CMD_TIME_CLASS_D
value|(60 * HZ)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|GO_BIT_TIMEOUT
value|(HZ * 10)
end_define

begin_struct
struct|struct
name|mthca_cmd_context
block|{
name|struct
name|completion
name|done
decl_stmt|;
name|int
name|result
decl_stmt|;
name|int
name|next
decl_stmt|;
name|u64
name|out_param
decl_stmt|;
name|u16
name|token
decl_stmt|;
name|u8
name|status
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|int
name|fw_cmd_doorbell
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|module_param
argument_list|(
name|fw_cmd_doorbell
argument_list|,
name|int
argument_list|,
literal|0644
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_PARM_DESC
argument_list|(
name|fw_cmd_doorbell
argument_list|,
literal|"post FW commands through doorbell page if nonzero "
literal|"(and supported by FW)"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
specifier|inline
name|int
name|go_bit
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|)
block|{
return|return
name|readl
argument_list|(
name|dev
operator|->
name|hcr
operator|+
name|HCR_STATUS_OFFSET
argument_list|)
operator|&
name|swab32
argument_list|(
literal|1
operator|<<
name|HCR_GO_BIT
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mthca_cmd_post_dbell
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|,
name|u64
name|in_param
parameter_list|,
name|u64
name|out_param
parameter_list|,
name|u32
name|in_modifier
parameter_list|,
name|u8
name|op_modifier
parameter_list|,
name|u16
name|op
parameter_list|,
name|u16
name|token
parameter_list|)
block|{
name|void
name|__iomem
modifier|*
name|ptr
init|=
name|dev
operator|->
name|cmd
operator|.
name|dbell_map
decl_stmt|;
name|u16
modifier|*
name|offs
init|=
name|dev
operator|->
name|cmd
operator|.
name|dbell_offsets
decl_stmt|;
name|__raw_writel
argument_list|(
operator|(
name|__force
name|u32
operator|)
name|cpu_to_be32
argument_list|(
name|in_param
operator|>>
literal|32
argument_list|)
argument_list|,
name|ptr
operator|+
name|offs
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|wmb
argument_list|()
expr_stmt|;
name|__raw_writel
argument_list|(
operator|(
name|__force
name|u32
operator|)
name|cpu_to_be32
argument_list|(
name|in_param
operator|&
literal|0xfffffffful
argument_list|)
argument_list|,
name|ptr
operator|+
name|offs
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|wmb
argument_list|()
expr_stmt|;
name|__raw_writel
argument_list|(
operator|(
name|__force
name|u32
operator|)
name|cpu_to_be32
argument_list|(
name|in_modifier
argument_list|)
argument_list|,
name|ptr
operator|+
name|offs
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|wmb
argument_list|()
expr_stmt|;
name|__raw_writel
argument_list|(
operator|(
name|__force
name|u32
operator|)
name|cpu_to_be32
argument_list|(
name|out_param
operator|>>
literal|32
argument_list|)
argument_list|,
name|ptr
operator|+
name|offs
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|wmb
argument_list|()
expr_stmt|;
name|__raw_writel
argument_list|(
operator|(
name|__force
name|u32
operator|)
name|cpu_to_be32
argument_list|(
name|out_param
operator|&
literal|0xfffffffful
argument_list|)
argument_list|,
name|ptr
operator|+
name|offs
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
name|wmb
argument_list|()
expr_stmt|;
name|__raw_writel
argument_list|(
operator|(
name|__force
name|u32
operator|)
name|cpu_to_be32
argument_list|(
name|token
operator|<<
literal|16
argument_list|)
argument_list|,
name|ptr
operator|+
name|offs
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
name|wmb
argument_list|()
expr_stmt|;
name|__raw_writel
argument_list|(
operator|(
name|__force
name|u32
operator|)
name|cpu_to_be32
argument_list|(
operator|(
literal|1
operator|<<
name|HCR_GO_BIT
operator|)
operator||
operator|(
literal|1
operator|<<
name|HCA_E_BIT
operator|)
operator||
operator|(
name|op_modifier
operator|<<
name|HCR_OPMOD_SHIFT
operator|)
operator||
name|op
argument_list|)
argument_list|,
name|ptr
operator|+
name|offs
index|[
literal|6
index|]
argument_list|)
expr_stmt|;
name|wmb
argument_list|()
expr_stmt|;
name|__raw_writel
argument_list|(
operator|(
name|__force
name|u32
operator|)
literal|0
argument_list|,
name|ptr
operator|+
name|offs
index|[
literal|7
index|]
argument_list|)
expr_stmt|;
name|wmb
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|mthca_cmd_post_hcr
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|,
name|u64
name|in_param
parameter_list|,
name|u64
name|out_param
parameter_list|,
name|u32
name|in_modifier
parameter_list|,
name|u8
name|op_modifier
parameter_list|,
name|u16
name|op
parameter_list|,
name|u16
name|token
parameter_list|,
name|int
name|event
parameter_list|)
block|{
if|if
condition|(
name|event
condition|)
block|{
name|unsigned
name|long
name|end
init|=
name|jiffies
operator|+
name|GO_BIT_TIMEOUT
decl_stmt|;
while|while
condition|(
name|go_bit
argument_list|(
name|dev
argument_list|)
operator|&&
name|time_before
argument_list|(
name|jiffies
argument_list|,
name|end
argument_list|)
condition|)
name|sched_yield
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|go_bit
argument_list|(
name|dev
argument_list|)
condition|)
return|return
operator|-
name|EAGAIN
return|;
comment|/* 	 * We use writel (instead of something like memcpy_toio) 	 * because writes of less than 32 bits to the HCR don't work 	 * (and some architectures such as ia64 implement memcpy_toio 	 * in terms of writeb). 	 */
name|__raw_writel
argument_list|(
operator|(
name|__force
name|u32
operator|)
name|cpu_to_be32
argument_list|(
name|in_param
operator|>>
literal|32
argument_list|)
argument_list|,
name|dev
operator|->
name|hcr
operator|+
literal|0
operator|*
literal|4
argument_list|)
expr_stmt|;
name|__raw_writel
argument_list|(
operator|(
name|__force
name|u32
operator|)
name|cpu_to_be32
argument_list|(
name|in_param
operator|&
literal|0xfffffffful
argument_list|)
argument_list|,
name|dev
operator|->
name|hcr
operator|+
literal|1
operator|*
literal|4
argument_list|)
expr_stmt|;
name|__raw_writel
argument_list|(
operator|(
name|__force
name|u32
operator|)
name|cpu_to_be32
argument_list|(
name|in_modifier
argument_list|)
argument_list|,
name|dev
operator|->
name|hcr
operator|+
literal|2
operator|*
literal|4
argument_list|)
expr_stmt|;
name|__raw_writel
argument_list|(
operator|(
name|__force
name|u32
operator|)
name|cpu_to_be32
argument_list|(
name|out_param
operator|>>
literal|32
argument_list|)
argument_list|,
name|dev
operator|->
name|hcr
operator|+
literal|3
operator|*
literal|4
argument_list|)
expr_stmt|;
name|__raw_writel
argument_list|(
operator|(
name|__force
name|u32
operator|)
name|cpu_to_be32
argument_list|(
name|out_param
operator|&
literal|0xfffffffful
argument_list|)
argument_list|,
name|dev
operator|->
name|hcr
operator|+
literal|4
operator|*
literal|4
argument_list|)
expr_stmt|;
name|__raw_writel
argument_list|(
operator|(
name|__force
name|u32
operator|)
name|cpu_to_be32
argument_list|(
name|token
operator|<<
literal|16
argument_list|)
argument_list|,
name|dev
operator|->
name|hcr
operator|+
literal|5
operator|*
literal|4
argument_list|)
expr_stmt|;
comment|/* __raw_writel may not order writes. */
name|wmb
argument_list|()
expr_stmt|;
name|__raw_writel
argument_list|(
operator|(
name|__force
name|u32
operator|)
name|cpu_to_be32
argument_list|(
operator|(
literal|1
operator|<<
name|HCR_GO_BIT
operator|)
operator||
operator|(
name|event
condition|?
operator|(
literal|1
operator|<<
name|HCA_E_BIT
operator|)
else|:
literal|0
operator|)
operator||
operator|(
name|op_modifier
operator|<<
name|HCR_OPMOD_SHIFT
operator|)
operator||
name|op
argument_list|)
argument_list|,
name|dev
operator|->
name|hcr
operator|+
literal|6
operator|*
literal|4
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mthca_cmd_post
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|,
name|u64
name|in_param
parameter_list|,
name|u64
name|out_param
parameter_list|,
name|u32
name|in_modifier
parameter_list|,
name|u8
name|op_modifier
parameter_list|,
name|u16
name|op
parameter_list|,
name|u16
name|token
parameter_list|,
name|int
name|event
parameter_list|)
block|{
name|int
name|err
init|=
literal|0
decl_stmt|;
name|mutex_lock
argument_list|(
operator|&
name|dev
operator|->
name|cmd
operator|.
name|hcr_mutex
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&&
name|dev
operator|->
name|cmd
operator|.
name|flags
operator|&
name|MTHCA_CMD_POST_DOORBELLS
operator|&&
name|fw_cmd_doorbell
condition|)
name|mthca_cmd_post_dbell
argument_list|(
name|dev
argument_list|,
name|in_param
argument_list|,
name|out_param
argument_list|,
name|in_modifier
argument_list|,
name|op_modifier
argument_list|,
name|op
argument_list|,
name|token
argument_list|)
expr_stmt|;
else|else
name|err
operator|=
name|mthca_cmd_post_hcr
argument_list|(
name|dev
argument_list|,
name|in_param
argument_list|,
name|out_param
argument_list|,
name|in_modifier
argument_list|,
name|op_modifier
argument_list|,
name|op
argument_list|,
name|token
argument_list|,
name|event
argument_list|)
expr_stmt|;
comment|/* 	 * Make sure that our HCR writes don't get mixed in with 	 * writes from another CPU starting a FW command. 	 */
name|mmiowb
argument_list|()
expr_stmt|;
name|mutex_unlock
argument_list|(
operator|&
name|dev
operator|->
name|cmd
operator|.
name|hcr_mutex
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mthca_cmd_poll
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|,
name|u64
name|in_param
parameter_list|,
name|u64
modifier|*
name|out_param
parameter_list|,
name|int
name|out_is_imm
parameter_list|,
name|u32
name|in_modifier
parameter_list|,
name|u8
name|op_modifier
parameter_list|,
name|u16
name|op
parameter_list|,
name|unsigned
name|long
name|timeout
parameter_list|,
name|u8
modifier|*
name|status
parameter_list|)
block|{
name|int
name|err
init|=
literal|0
decl_stmt|;
name|unsigned
name|long
name|end
decl_stmt|;
name|down
argument_list|(
operator|&
name|dev
operator|->
name|cmd
operator|.
name|poll_sem
argument_list|)
expr_stmt|;
name|err
operator|=
name|mthca_cmd_post
argument_list|(
name|dev
argument_list|,
name|in_param
argument_list|,
name|out_param
condition|?
operator|*
name|out_param
else|:
literal|0
argument_list|,
name|in_modifier
argument_list|,
name|op_modifier
argument_list|,
name|op
argument_list|,
name|CMD_POLL_TOKEN
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|out
goto|;
name|end
operator|=
name|timeout
operator|+
name|jiffies
expr_stmt|;
while|while
condition|(
name|go_bit
argument_list|(
name|dev
argument_list|)
operator|&&
name|time_before
argument_list|(
name|jiffies
argument_list|,
name|end
argument_list|)
condition|)
name|sched_yield
argument_list|()
expr_stmt|;
if|if
condition|(
name|go_bit
argument_list|(
name|dev
argument_list|)
condition|)
block|{
name|err
operator|=
operator|-
name|EBUSY
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|out_is_imm
condition|)
operator|*
name|out_param
operator|=
operator|(
name|u64
operator|)
name|be32_to_cpu
argument_list|(
operator|(
name|__force
name|__be32
operator|)
name|__raw_readl
argument_list|(
name|dev
operator|->
name|hcr
operator|+
name|HCR_OUT_PARAM_OFFSET
argument_list|)
argument_list|)
operator|<<
literal|32
operator||
operator|(
name|u64
operator|)
name|be32_to_cpu
argument_list|(
operator|(
name|__force
name|__be32
operator|)
name|__raw_readl
argument_list|(
name|dev
operator|->
name|hcr
operator|+
name|HCR_OUT_PARAM_OFFSET
operator|+
literal|4
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|status
operator|=
name|be32_to_cpu
argument_list|(
operator|(
name|__force
name|__be32
operator|)
name|__raw_readl
argument_list|(
name|dev
operator|->
name|hcr
operator|+
name|HCR_STATUS_OFFSET
argument_list|)
argument_list|)
operator|>>
literal|24
expr_stmt|;
name|out
label|:
name|up
argument_list|(
operator|&
name|dev
operator|->
name|cmd
operator|.
name|poll_sem
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|void
name|mthca_cmd_event
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|,
name|u16
name|token
parameter_list|,
name|u8
name|status
parameter_list|,
name|u64
name|out_param
parameter_list|)
block|{
name|struct
name|mthca_cmd_context
modifier|*
name|context
init|=
operator|&
name|dev
operator|->
name|cmd
operator|.
name|context
index|[
name|token
operator|&
name|dev
operator|->
name|cmd
operator|.
name|token_mask
index|]
decl_stmt|;
comment|/* previously timed out command completing at long last */
if|if
condition|(
name|token
operator|!=
name|context
operator|->
name|token
condition|)
return|return;
name|context
operator|->
name|result
operator|=
literal|0
expr_stmt|;
name|context
operator|->
name|status
operator|=
name|status
expr_stmt|;
name|context
operator|->
name|out_param
operator|=
name|out_param
expr_stmt|;
name|complete
argument_list|(
operator|&
name|context
operator|->
name|done
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|mthca_cmd_wait
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|,
name|u64
name|in_param
parameter_list|,
name|u64
modifier|*
name|out_param
parameter_list|,
name|int
name|out_is_imm
parameter_list|,
name|u32
name|in_modifier
parameter_list|,
name|u8
name|op_modifier
parameter_list|,
name|u16
name|op
parameter_list|,
name|unsigned
name|long
name|timeout
parameter_list|,
name|u8
modifier|*
name|status
parameter_list|)
block|{
name|int
name|err
init|=
literal|0
decl_stmt|;
name|struct
name|mthca_cmd_context
modifier|*
name|context
decl_stmt|;
name|down
argument_list|(
operator|&
name|dev
operator|->
name|cmd
operator|.
name|event_sem
argument_list|)
expr_stmt|;
name|spin_lock
argument_list|(
operator|&
name|dev
operator|->
name|cmd
operator|.
name|context_lock
argument_list|)
expr_stmt|;
name|BUG_ON
argument_list|(
name|dev
operator|->
name|cmd
operator|.
name|free_head
operator|<
literal|0
argument_list|)
expr_stmt|;
name|context
operator|=
operator|&
name|dev
operator|->
name|cmd
operator|.
name|context
index|[
name|dev
operator|->
name|cmd
operator|.
name|free_head
index|]
expr_stmt|;
name|context
operator|->
name|token
operator|+=
name|dev
operator|->
name|cmd
operator|.
name|token_mask
operator|+
literal|1
expr_stmt|;
name|dev
operator|->
name|cmd
operator|.
name|free_head
operator|=
name|context
operator|->
name|next
expr_stmt|;
name|spin_unlock
argument_list|(
operator|&
name|dev
operator|->
name|cmd
operator|.
name|context_lock
argument_list|)
expr_stmt|;
name|init_completion
argument_list|(
operator|&
name|context
operator|->
name|done
argument_list|)
expr_stmt|;
name|err
operator|=
name|mthca_cmd_post
argument_list|(
name|dev
argument_list|,
name|in_param
argument_list|,
name|out_param
condition|?
operator|*
name|out_param
else|:
literal|0
argument_list|,
name|in_modifier
argument_list|,
name|op_modifier
argument_list|,
name|op
argument_list|,
name|context
operator|->
name|token
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
operator|!
name|wait_for_completion_timeout
argument_list|(
operator|&
name|context
operator|->
name|done
argument_list|,
name|timeout
argument_list|)
condition|)
block|{
name|err
operator|=
operator|-
name|EBUSY
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|err
operator|=
name|context
operator|->
name|result
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|out
goto|;
operator|*
name|status
operator|=
name|context
operator|->
name|status
expr_stmt|;
if|if
condition|(
operator|*
name|status
condition|)
name|mthca_dbg
argument_list|(
name|dev
argument_list|,
literal|"Command %02x completed with status %02x\n"
argument_list|,
name|op
argument_list|,
operator|*
name|status
argument_list|)
expr_stmt|;
if|if
condition|(
name|out_is_imm
condition|)
operator|*
name|out_param
operator|=
name|context
operator|->
name|out_param
expr_stmt|;
name|out
label|:
name|spin_lock
argument_list|(
operator|&
name|dev
operator|->
name|cmd
operator|.
name|context_lock
argument_list|)
expr_stmt|;
name|context
operator|->
name|next
operator|=
name|dev
operator|->
name|cmd
operator|.
name|free_head
expr_stmt|;
name|dev
operator|->
name|cmd
operator|.
name|free_head
operator|=
name|context
operator|-
name|dev
operator|->
name|cmd
operator|.
name|context
expr_stmt|;
name|spin_unlock
argument_list|(
operator|&
name|dev
operator|->
name|cmd
operator|.
name|context_lock
argument_list|)
expr_stmt|;
name|up
argument_list|(
operator|&
name|dev
operator|->
name|cmd
operator|.
name|event_sem
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_comment
comment|/* Invoke a command with an output mailbox */
end_comment

begin_function
specifier|static
name|int
name|mthca_cmd_box
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|,
name|u64
name|in_param
parameter_list|,
name|u64
name|out_param
parameter_list|,
name|u32
name|in_modifier
parameter_list|,
name|u8
name|op_modifier
parameter_list|,
name|u16
name|op
parameter_list|,
name|unsigned
name|long
name|timeout
parameter_list|,
name|u8
modifier|*
name|status
parameter_list|)
block|{
if|if
condition|(
name|dev
operator|->
name|cmd
operator|.
name|flags
operator|&
name|MTHCA_CMD_USE_EVENTS
condition|)
return|return
name|mthca_cmd_wait
argument_list|(
name|dev
argument_list|,
name|in_param
argument_list|,
operator|&
name|out_param
argument_list|,
literal|0
argument_list|,
name|in_modifier
argument_list|,
name|op_modifier
argument_list|,
name|op
argument_list|,
name|timeout
argument_list|,
name|status
argument_list|)
return|;
else|else
return|return
name|mthca_cmd_poll
argument_list|(
name|dev
argument_list|,
name|in_param
argument_list|,
operator|&
name|out_param
argument_list|,
literal|0
argument_list|,
name|in_modifier
argument_list|,
name|op_modifier
argument_list|,
name|op
argument_list|,
name|timeout
argument_list|,
name|status
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Invoke a command with no output parameter */
end_comment

begin_function
specifier|static
name|int
name|mthca_cmd
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|,
name|u64
name|in_param
parameter_list|,
name|u32
name|in_modifier
parameter_list|,
name|u8
name|op_modifier
parameter_list|,
name|u16
name|op
parameter_list|,
name|unsigned
name|long
name|timeout
parameter_list|,
name|u8
modifier|*
name|status
parameter_list|)
block|{
return|return
name|mthca_cmd_box
argument_list|(
name|dev
argument_list|,
name|in_param
argument_list|,
literal|0
argument_list|,
name|in_modifier
argument_list|,
name|op_modifier
argument_list|,
name|op
argument_list|,
name|timeout
argument_list|,
name|status
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  * Invoke a command with an immediate output parameter (and copy the  * output into the caller's out_param pointer after the command  * executes).  */
end_comment

begin_function
specifier|static
name|int
name|mthca_cmd_imm
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|,
name|u64
name|in_param
parameter_list|,
name|u64
modifier|*
name|out_param
parameter_list|,
name|u32
name|in_modifier
parameter_list|,
name|u8
name|op_modifier
parameter_list|,
name|u16
name|op
parameter_list|,
name|unsigned
name|long
name|timeout
parameter_list|,
name|u8
modifier|*
name|status
parameter_list|)
block|{
if|if
condition|(
name|dev
operator|->
name|cmd
operator|.
name|flags
operator|&
name|MTHCA_CMD_USE_EVENTS
condition|)
return|return
name|mthca_cmd_wait
argument_list|(
name|dev
argument_list|,
name|in_param
argument_list|,
name|out_param
argument_list|,
literal|1
argument_list|,
name|in_modifier
argument_list|,
name|op_modifier
argument_list|,
name|op
argument_list|,
name|timeout
argument_list|,
name|status
argument_list|)
return|;
else|else
return|return
name|mthca_cmd_poll
argument_list|(
name|dev
argument_list|,
name|in_param
argument_list|,
name|out_param
argument_list|,
literal|1
argument_list|,
name|in_modifier
argument_list|,
name|op_modifier
argument_list|,
name|op
argument_list|,
name|timeout
argument_list|,
name|status
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|mthca_cmd_init
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|)
block|{
name|mutex_init
argument_list|(
operator|&
name|dev
operator|->
name|cmd
operator|.
name|hcr_mutex
argument_list|)
expr_stmt|;
name|sema_init
argument_list|(
operator|&
name|dev
operator|->
name|cmd
operator|.
name|poll_sem
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|dev
operator|->
name|cmd
operator|.
name|flags
operator|=
literal|0
expr_stmt|;
name|dev
operator|->
name|hcr
operator|=
name|ioremap
argument_list|(
name|pci_resource_start
argument_list|(
name|dev
operator|->
name|pdev
argument_list|,
literal|0
argument_list|)
operator|+
name|MTHCA_HCR_BASE
argument_list|,
name|MTHCA_HCR_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dev
operator|->
name|hcr
condition|)
block|{
name|mthca_err
argument_list|(
name|dev
argument_list|,
literal|"Couldn't map command register."
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOMEM
return|;
block|}
name|dev
operator|->
name|cmd
operator|.
name|pool
operator|=
name|pci_pool_create
argument_list|(
literal|"mthca_cmd"
argument_list|,
name|dev
operator|->
name|pdev
argument_list|,
name|MTHCA_MAILBOX_SIZE
argument_list|,
name|MTHCA_MAILBOX_SIZE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dev
operator|->
name|cmd
operator|.
name|pool
condition|)
block|{
name|iounmap
argument_list|(
name|dev
operator|->
name|hcr
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOMEM
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|mthca_cmd_cleanup
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|)
block|{
name|pci_pool_destroy
argument_list|(
name|dev
operator|->
name|cmd
operator|.
name|pool
argument_list|)
expr_stmt|;
name|iounmap
argument_list|(
name|dev
operator|->
name|hcr
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev
operator|->
name|cmd
operator|.
name|flags
operator|&
name|MTHCA_CMD_POST_DOORBELLS
condition|)
name|iounmap
argument_list|(
name|dev
operator|->
name|cmd
operator|.
name|dbell_map
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Switch to using events to issue FW commands (should be called after  * event queue to command events has been initialized).  */
end_comment

begin_function
name|int
name|mthca_cmd_use_events
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|dev
operator|->
name|cmd
operator|.
name|context
operator|=
name|kmalloc
argument_list|(
name|dev
operator|->
name|cmd
operator|.
name|max_cmds
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|mthca_cmd_context
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dev
operator|->
name|cmd
operator|.
name|context
condition|)
return|return
operator|-
name|ENOMEM
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dev
operator|->
name|cmd
operator|.
name|max_cmds
condition|;
operator|++
name|i
control|)
block|{
name|dev
operator|->
name|cmd
operator|.
name|context
index|[
name|i
index|]
operator|.
name|token
operator|=
name|i
expr_stmt|;
name|dev
operator|->
name|cmd
operator|.
name|context
index|[
name|i
index|]
operator|.
name|next
operator|=
name|i
operator|+
literal|1
expr_stmt|;
block|}
name|dev
operator|->
name|cmd
operator|.
name|context
index|[
name|dev
operator|->
name|cmd
operator|.
name|max_cmds
operator|-
literal|1
index|]
operator|.
name|next
operator|=
operator|-
literal|1
expr_stmt|;
name|dev
operator|->
name|cmd
operator|.
name|free_head
operator|=
literal|0
expr_stmt|;
name|sema_init
argument_list|(
operator|&
name|dev
operator|->
name|cmd
operator|.
name|event_sem
argument_list|,
name|dev
operator|->
name|cmd
operator|.
name|max_cmds
argument_list|)
expr_stmt|;
name|spin_lock_init
argument_list|(
operator|&
name|dev
operator|->
name|cmd
operator|.
name|context_lock
argument_list|)
expr_stmt|;
for|for
control|(
name|dev
operator|->
name|cmd
operator|.
name|token_mask
operator|=
literal|1
init|;
name|dev
operator|->
name|cmd
operator|.
name|token_mask
operator|<
name|dev
operator|->
name|cmd
operator|.
name|max_cmds
condition|;
name|dev
operator|->
name|cmd
operator|.
name|token_mask
operator|<<=
literal|1
control|)
empty_stmt|;
comment|/* nothing */
operator|--
name|dev
operator|->
name|cmd
operator|.
name|token_mask
expr_stmt|;
name|dev
operator|->
name|cmd
operator|.
name|flags
operator||=
name|MTHCA_CMD_USE_EVENTS
expr_stmt|;
name|down
argument_list|(
operator|&
name|dev
operator|->
name|cmd
operator|.
name|poll_sem
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Switch back to polling (used when shutting down the device)  */
end_comment

begin_function
name|void
name|mthca_cmd_use_polling
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|dev
operator|->
name|cmd
operator|.
name|flags
operator|&=
operator|~
name|MTHCA_CMD_USE_EVENTS
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dev
operator|->
name|cmd
operator|.
name|max_cmds
condition|;
operator|++
name|i
control|)
name|down
argument_list|(
operator|&
name|dev
operator|->
name|cmd
operator|.
name|event_sem
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|dev
operator|->
name|cmd
operator|.
name|context
argument_list|)
expr_stmt|;
name|up
argument_list|(
operator|&
name|dev
operator|->
name|cmd
operator|.
name|poll_sem
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|struct
name|mthca_mailbox
modifier|*
name|mthca_alloc_mailbox
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|,
name|gfp_t
name|gfp_mask
parameter_list|)
block|{
name|struct
name|mthca_mailbox
modifier|*
name|mailbox
decl_stmt|;
name|mailbox
operator|=
name|kmalloc
argument_list|(
sizeof|sizeof
expr|*
name|mailbox
argument_list|,
name|gfp_mask
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mailbox
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|ENOMEM
argument_list|)
return|;
name|mailbox
operator|->
name|buf
operator|=
name|pci_pool_alloc
argument_list|(
name|dev
operator|->
name|cmd
operator|.
name|pool
argument_list|,
name|gfp_mask
argument_list|,
operator|&
name|mailbox
operator|->
name|dma
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mailbox
operator|->
name|buf
condition|)
block|{
name|kfree
argument_list|(
name|mailbox
argument_list|)
expr_stmt|;
return|return
name|ERR_PTR
argument_list|(
operator|-
name|ENOMEM
argument_list|)
return|;
block|}
return|return
name|mailbox
return|;
block|}
end_function

begin_function
name|void
name|mthca_free_mailbox
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mthca_mailbox
modifier|*
name|mailbox
parameter_list|)
block|{
if|if
condition|(
operator|!
name|mailbox
condition|)
return|return;
name|pci_pool_free
argument_list|(
name|dev
operator|->
name|cmd
operator|.
name|pool
argument_list|,
name|mailbox
operator|->
name|buf
argument_list|,
name|mailbox
operator|->
name|dma
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|mailbox
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|mthca_SYS_EN
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|,
name|u8
modifier|*
name|status
parameter_list|)
block|{
name|u64
name|out
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|mthca_cmd_imm
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|,
operator|&
name|out
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|CMD_SYS_EN
argument_list|,
name|CMD_TIME_CLASS_D
argument_list|,
name|status
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|status
operator|==
name|MTHCA_CMD_STAT_DDR_MEM_ERR
condition|)
name|mthca_warn
argument_list|(
name|dev
argument_list|,
literal|"SYS_EN DDR error: syn=%x, sock=%d, "
literal|"sladdr=%d, SPD source=%s\n"
argument_list|,
call|(
name|int
call|)
argument_list|(
name|out
operator|>>
literal|6
argument_list|)
operator|&
literal|0xf
argument_list|,
call|(
name|int
call|)
argument_list|(
name|out
operator|>>
literal|4
argument_list|)
operator|&
literal|3
argument_list|,
call|(
name|int
call|)
argument_list|(
name|out
operator|>>
literal|1
argument_list|)
operator|&
literal|7
argument_list|,
operator|(
name|int
operator|)
name|out
operator|&
literal|1
condition|?
literal|"NVMEM"
else|:
literal|"DIMM"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|mthca_SYS_DIS
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|,
name|u8
modifier|*
name|status
parameter_list|)
block|{
return|return
name|mthca_cmd
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|CMD_SYS_DIS
argument_list|,
name|CMD_TIME_CLASS_C
argument_list|,
name|status
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mthca_map_cmd
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|,
name|u16
name|op
parameter_list|,
name|struct
name|mthca_icm
modifier|*
name|icm
parameter_list|,
name|u64
name|virt
parameter_list|,
name|u8
modifier|*
name|status
parameter_list|)
block|{
name|struct
name|mthca_mailbox
modifier|*
name|mailbox
decl_stmt|;
name|struct
name|mthca_icm_iter
name|iter
decl_stmt|;
name|__be64
modifier|*
name|pages
decl_stmt|;
name|int
name|lg
decl_stmt|;
name|int
name|nent
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|err
init|=
literal|0
decl_stmt|;
name|int
name|ts
init|=
literal|0
decl_stmt|,
name|tc
init|=
literal|0
decl_stmt|;
name|mailbox
operator|=
name|mthca_alloc_mailbox
argument_list|(
name|dev
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|mailbox
argument_list|)
condition|)
return|return
name|PTR_ERR
argument_list|(
name|mailbox
argument_list|)
return|;
name|memset
argument_list|(
name|mailbox
operator|->
name|buf
argument_list|,
literal|0
argument_list|,
name|MTHCA_MAILBOX_SIZE
argument_list|)
expr_stmt|;
name|pages
operator|=
name|mailbox
operator|->
name|buf
expr_stmt|;
for|for
control|(
name|mthca_icm_first
argument_list|(
name|icm
argument_list|,
operator|&
name|iter
argument_list|)
init|;
operator|!
name|mthca_icm_last
argument_list|(
operator|&
name|iter
argument_list|)
condition|;
name|mthca_icm_next
argument_list|(
operator|&
name|iter
argument_list|)
control|)
block|{
comment|/* 		 * We have to pass pages that are aligned to their 		 * size, so find the least significant 1 in the 		 * address or size and use that as our log2 size. 		 */
name|lg
operator|=
name|ffs
argument_list|(
name|mthca_icm_addr
argument_list|(
operator|&
name|iter
argument_list|)
operator||
name|mthca_icm_size
argument_list|(
operator|&
name|iter
argument_list|)
argument_list|)
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|lg
operator|<
name|MTHCA_ICM_PAGE_SHIFT
condition|)
block|{
name|mthca_warn
argument_list|(
name|dev
argument_list|,
literal|"Got FW area not aligned to %d (%llx/%lx).\n"
argument_list|,
name|MTHCA_ICM_PAGE_SIZE
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|mthca_icm_addr
argument_list|(
operator|&
name|iter
argument_list|)
argument_list|,
name|mthca_icm_size
argument_list|(
operator|&
name|iter
argument_list|)
argument_list|)
expr_stmt|;
name|err
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|mthca_icm_size
argument_list|(
operator|&
name|iter
argument_list|)
operator|>>
name|lg
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|virt
operator|!=
operator|-
literal|1
condition|)
block|{
name|pages
index|[
name|nent
operator|*
literal|2
index|]
operator|=
name|cpu_to_be64
argument_list|(
name|virt
argument_list|)
expr_stmt|;
name|virt
operator|+=
literal|1
operator|<<
name|lg
expr_stmt|;
block|}
name|pages
index|[
name|nent
operator|*
literal|2
operator|+
literal|1
index|]
operator|=
name|cpu_to_be64
argument_list|(
operator|(
name|mthca_icm_addr
argument_list|(
operator|&
name|iter
argument_list|)
operator|+
operator|(
name|i
operator|<<
name|lg
operator|)
operator|)
operator||
operator|(
name|lg
operator|-
name|MTHCA_ICM_PAGE_SHIFT
operator|)
argument_list|)
expr_stmt|;
name|ts
operator|+=
literal|1
operator|<<
operator|(
name|lg
operator|-
literal|10
operator|)
expr_stmt|;
operator|++
name|tc
expr_stmt|;
if|if
condition|(
operator|++
name|nent
operator|==
name|MTHCA_MAILBOX_SIZE
operator|/
literal|16
condition|)
block|{
name|err
operator|=
name|mthca_cmd
argument_list|(
name|dev
argument_list|,
name|mailbox
operator|->
name|dma
argument_list|,
name|nent
argument_list|,
literal|0
argument_list|,
name|op
argument_list|,
name|CMD_TIME_CLASS_B
argument_list|,
name|status
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|||
operator|*
name|status
condition|)
goto|goto
name|out
goto|;
name|nent
operator|=
literal|0
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|nent
condition|)
name|err
operator|=
name|mthca_cmd
argument_list|(
name|dev
argument_list|,
name|mailbox
operator|->
name|dma
argument_list|,
name|nent
argument_list|,
literal|0
argument_list|,
name|op
argument_list|,
name|CMD_TIME_CLASS_B
argument_list|,
name|status
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|op
condition|)
block|{
case|case
name|CMD_MAP_FA
case|:
name|mthca_dbg
argument_list|(
name|dev
argument_list|,
literal|"Mapped %d chunks/%d KB for FW.\n"
argument_list|,
name|tc
argument_list|,
name|ts
argument_list|)
expr_stmt|;
break|break;
case|case
name|CMD_MAP_ICM_AUX
case|:
name|mthca_dbg
argument_list|(
name|dev
argument_list|,
literal|"Mapped %d chunks/%d KB for ICM aux.\n"
argument_list|,
name|tc
argument_list|,
name|ts
argument_list|)
expr_stmt|;
break|break;
case|case
name|CMD_MAP_ICM
case|:
name|mthca_dbg
argument_list|(
name|dev
argument_list|,
literal|"Mapped %d chunks/%d KB at %llx for ICM.\n"
argument_list|,
name|tc
argument_list|,
name|ts
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|virt
operator|-
operator|(
name|ts
operator|<<
literal|10
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|out
label|:
name|mthca_free_mailbox
argument_list|(
name|dev
argument_list|,
name|mailbox
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|int
name|mthca_MAP_FA
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mthca_icm
modifier|*
name|icm
parameter_list|,
name|u8
modifier|*
name|status
parameter_list|)
block|{
return|return
name|mthca_map_cmd
argument_list|(
name|dev
argument_list|,
name|CMD_MAP_FA
argument_list|,
name|icm
argument_list|,
operator|-
literal|1
argument_list|,
name|status
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|mthca_UNMAP_FA
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|,
name|u8
modifier|*
name|status
parameter_list|)
block|{
return|return
name|mthca_cmd
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|CMD_UNMAP_FA
argument_list|,
name|CMD_TIME_CLASS_B
argument_list|,
name|status
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|mthca_RUN_FW
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|,
name|u8
modifier|*
name|status
parameter_list|)
block|{
return|return
name|mthca_cmd
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|CMD_RUN_FW
argument_list|,
name|CMD_TIME_CLASS_A
argument_list|,
name|status
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mthca_setup_cmd_doorbells
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|,
name|u64
name|base
parameter_list|)
block|{
name|unsigned
name|long
name|addr
decl_stmt|;
name|u16
name|max_off
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
operator|++
name|i
control|)
name|max_off
operator|=
name|max
argument_list|(
name|max_off
argument_list|,
name|dev
operator|->
name|cmd
operator|.
name|dbell_offsets
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|base
operator|&
name|PAGE_MASK
operator|)
operator|!=
operator|(
operator|(
name|base
operator|+
name|max_off
operator|)
operator|&
name|PAGE_MASK
operator|)
condition|)
block|{
name|mthca_warn
argument_list|(
name|dev
argument_list|,
literal|"Firmware doorbell region at 0x%016llx, "
literal|"length 0x%x crosses a page boundary\n"
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|base
argument_list|,
name|max_off
argument_list|)
expr_stmt|;
return|return;
block|}
name|addr
operator|=
name|pci_resource_start
argument_list|(
name|dev
operator|->
name|pdev
argument_list|,
literal|2
argument_list|)
operator|+
operator|(
operator|(
name|pci_resource_len
argument_list|(
name|dev
operator|->
name|pdev
argument_list|,
literal|2
argument_list|)
operator|-
literal|1
operator|)
operator|&
name|base
operator|)
expr_stmt|;
name|dev
operator|->
name|cmd
operator|.
name|dbell_map
operator|=
name|ioremap
argument_list|(
name|addr
argument_list|,
name|max_off
operator|+
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dev
operator|->
name|cmd
operator|.
name|dbell_map
condition|)
return|return;
name|dev
operator|->
name|cmd
operator|.
name|flags
operator||=
name|MTHCA_CMD_POST_DOORBELLS
expr_stmt|;
name|mthca_dbg
argument_list|(
name|dev
argument_list|,
literal|"Mapped doorbell page for posting FW commands\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|mthca_QUERY_FW
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|,
name|u8
modifier|*
name|status
parameter_list|)
block|{
name|struct
name|mthca_mailbox
modifier|*
name|mailbox
decl_stmt|;
name|u32
modifier|*
name|outbox
decl_stmt|;
name|u64
name|base
decl_stmt|;
name|u32
name|tmp
decl_stmt|;
name|int
name|err
init|=
literal|0
decl_stmt|;
name|u8
name|lg
decl_stmt|;
name|int
name|i
decl_stmt|;
define|#
directive|define
name|QUERY_FW_OUT_SIZE
value|0x100
define|#
directive|define
name|QUERY_FW_VER_OFFSET
value|0x00
define|#
directive|define
name|QUERY_FW_MAX_CMD_OFFSET
value|0x0f
define|#
directive|define
name|QUERY_FW_ERR_START_OFFSET
value|0x30
define|#
directive|define
name|QUERY_FW_ERR_SIZE_OFFSET
value|0x38
define|#
directive|define
name|QUERY_FW_CMD_DB_EN_OFFSET
value|0x10
define|#
directive|define
name|QUERY_FW_CMD_DB_OFFSET
value|0x50
define|#
directive|define
name|QUERY_FW_CMD_DB_BASE
value|0x60
define|#
directive|define
name|QUERY_FW_START_OFFSET
value|0x20
define|#
directive|define
name|QUERY_FW_END_OFFSET
value|0x28
define|#
directive|define
name|QUERY_FW_SIZE_OFFSET
value|0x00
define|#
directive|define
name|QUERY_FW_CLR_INT_BASE_OFFSET
value|0x20
define|#
directive|define
name|QUERY_FW_EQ_ARM_BASE_OFFSET
value|0x40
define|#
directive|define
name|QUERY_FW_EQ_SET_CI_BASE_OFFSET
value|0x48
name|mailbox
operator|=
name|mthca_alloc_mailbox
argument_list|(
name|dev
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|mailbox
argument_list|)
condition|)
return|return
name|PTR_ERR
argument_list|(
name|mailbox
argument_list|)
return|;
name|outbox
operator|=
name|mailbox
operator|->
name|buf
expr_stmt|;
name|err
operator|=
name|mthca_cmd_box
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|,
name|mailbox
operator|->
name|dma
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|CMD_QUERY_FW
argument_list|,
name|CMD_TIME_CLASS_A
argument_list|,
name|status
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|out
goto|;
name|MTHCA_GET
argument_list|(
name|dev
operator|->
name|fw_ver
argument_list|,
name|outbox
argument_list|,
name|QUERY_FW_VER_OFFSET
argument_list|)
expr_stmt|;
comment|/* 	 * FW subminor version is at more significant bits than minor 	 * version, so swap here. 	 */
name|dev
operator|->
name|fw_ver
operator|=
operator|(
name|dev
operator|->
name|fw_ver
operator|&
literal|0xffff00000000ull
operator|)
operator||
operator|(
operator|(
name|dev
operator|->
name|fw_ver
operator|&
literal|0xffff0000ull
operator|)
operator|>>
literal|16
operator|)
operator||
operator|(
operator|(
name|dev
operator|->
name|fw_ver
operator|&
literal|0x0000ffffull
operator|)
operator|<<
literal|16
operator|)
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|lg
argument_list|,
name|outbox
argument_list|,
name|QUERY_FW_MAX_CMD_OFFSET
argument_list|)
expr_stmt|;
name|dev
operator|->
name|cmd
operator|.
name|max_cmds
operator|=
literal|1
operator|<<
name|lg
expr_stmt|;
name|mthca_dbg
argument_list|(
name|dev
argument_list|,
literal|"FW version %012llx, max commands %d\n"
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|dev
operator|->
name|fw_ver
argument_list|,
name|dev
operator|->
name|cmd
operator|.
name|max_cmds
argument_list|)
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|dev
operator|->
name|catas_err
operator|.
name|addr
argument_list|,
name|outbox
argument_list|,
name|QUERY_FW_ERR_START_OFFSET
argument_list|)
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|dev
operator|->
name|catas_err
operator|.
name|size
argument_list|,
name|outbox
argument_list|,
name|QUERY_FW_ERR_SIZE_OFFSET
argument_list|)
expr_stmt|;
name|mthca_dbg
argument_list|(
name|dev
argument_list|,
literal|"Catastrophic error buffer at 0x%llx, size 0x%x\n"
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|dev
operator|->
name|catas_err
operator|.
name|addr
argument_list|,
name|dev
operator|->
name|catas_err
operator|.
name|size
argument_list|)
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|tmp
argument_list|,
name|outbox
argument_list|,
name|QUERY_FW_CMD_DB_EN_OFFSET
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|&
literal|0x1
condition|)
block|{
name|mthca_dbg
argument_list|(
name|dev
argument_list|,
literal|"FW supports commands through doorbells\n"
argument_list|)
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|base
argument_list|,
name|outbox
argument_list|,
name|QUERY_FW_CMD_DB_BASE
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MTHCA_CMD_NUM_DBELL_DWORDS
condition|;
operator|++
name|i
control|)
name|MTHCA_GET
argument_list|(
name|dev
operator|->
name|cmd
operator|.
name|dbell_offsets
index|[
name|i
index|]
argument_list|,
name|outbox
argument_list|,
name|QUERY_FW_CMD_DB_OFFSET
operator|+
operator|(
name|i
operator|<<
literal|1
operator|)
argument_list|)
expr_stmt|;
name|mthca_setup_cmd_doorbells
argument_list|(
name|dev
argument_list|,
name|base
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mthca_is_memfree
argument_list|(
name|dev
argument_list|)
condition|)
block|{
name|MTHCA_GET
argument_list|(
name|dev
operator|->
name|fw
operator|.
name|arbel
operator|.
name|fw_pages
argument_list|,
name|outbox
argument_list|,
name|QUERY_FW_SIZE_OFFSET
argument_list|)
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|dev
operator|->
name|fw
operator|.
name|arbel
operator|.
name|clr_int_base
argument_list|,
name|outbox
argument_list|,
name|QUERY_FW_CLR_INT_BASE_OFFSET
argument_list|)
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|dev
operator|->
name|fw
operator|.
name|arbel
operator|.
name|eq_arm_base
argument_list|,
name|outbox
argument_list|,
name|QUERY_FW_EQ_ARM_BASE_OFFSET
argument_list|)
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|dev
operator|->
name|fw
operator|.
name|arbel
operator|.
name|eq_set_ci_base
argument_list|,
name|outbox
argument_list|,
name|QUERY_FW_EQ_SET_CI_BASE_OFFSET
argument_list|)
expr_stmt|;
name|mthca_dbg
argument_list|(
name|dev
argument_list|,
literal|"FW size %d KB\n"
argument_list|,
name|dev
operator|->
name|fw
operator|.
name|arbel
operator|.
name|fw_pages
operator|<<
literal|2
argument_list|)
expr_stmt|;
comment|/* 		 * Round up number of system pages needed in case 		 * MTHCA_ICM_PAGE_SIZE< PAGE_SIZE. 		 */
name|dev
operator|->
name|fw
operator|.
name|arbel
operator|.
name|fw_pages
operator|=
name|ALIGN
argument_list|(
name|dev
operator|->
name|fw
operator|.
name|arbel
operator|.
name|fw_pages
argument_list|,
name|PAGE_SIZE
operator|/
name|MTHCA_ICM_PAGE_SIZE
argument_list|)
operator|>>
operator|(
name|PAGE_SHIFT
operator|-
name|MTHCA_ICM_PAGE_SHIFT
operator|)
expr_stmt|;
name|mthca_dbg
argument_list|(
name|dev
argument_list|,
literal|"Clear int @ %llx, EQ arm @ %llx, EQ set CI @ %llx\n"
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|dev
operator|->
name|fw
operator|.
name|arbel
operator|.
name|clr_int_base
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|dev
operator|->
name|fw
operator|.
name|arbel
operator|.
name|eq_arm_base
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|dev
operator|->
name|fw
operator|.
name|arbel
operator|.
name|eq_set_ci_base
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|MTHCA_GET
argument_list|(
name|dev
operator|->
name|fw
operator|.
name|tavor
operator|.
name|fw_start
argument_list|,
name|outbox
argument_list|,
name|QUERY_FW_START_OFFSET
argument_list|)
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|dev
operator|->
name|fw
operator|.
name|tavor
operator|.
name|fw_end
argument_list|,
name|outbox
argument_list|,
name|QUERY_FW_END_OFFSET
argument_list|)
expr_stmt|;
name|mthca_dbg
argument_list|(
name|dev
argument_list|,
literal|"FW size %d KB (start %llx, end %llx)\n"
argument_list|,
call|(
name|int
call|)
argument_list|(
operator|(
name|dev
operator|->
name|fw
operator|.
name|tavor
operator|.
name|fw_end
operator|-
name|dev
operator|->
name|fw
operator|.
name|tavor
operator|.
name|fw_start
operator|)
operator|>>
literal|10
argument_list|)
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|dev
operator|->
name|fw
operator|.
name|tavor
operator|.
name|fw_start
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|dev
operator|->
name|fw
operator|.
name|tavor
operator|.
name|fw_end
argument_list|)
expr_stmt|;
block|}
name|out
label|:
name|mthca_free_mailbox
argument_list|(
name|dev
argument_list|,
name|mailbox
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|int
name|mthca_ENABLE_LAM
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|,
name|u8
modifier|*
name|status
parameter_list|)
block|{
name|struct
name|mthca_mailbox
modifier|*
name|mailbox
decl_stmt|;
name|u8
name|info
decl_stmt|;
name|u32
modifier|*
name|outbox
decl_stmt|;
name|int
name|err
init|=
literal|0
decl_stmt|;
define|#
directive|define
name|ENABLE_LAM_OUT_SIZE
value|0x100
define|#
directive|define
name|ENABLE_LAM_START_OFFSET
value|0x00
define|#
directive|define
name|ENABLE_LAM_END_OFFSET
value|0x08
define|#
directive|define
name|ENABLE_LAM_INFO_OFFSET
value|0x13
define|#
directive|define
name|ENABLE_LAM_INFO_HIDDEN_FLAG
value|(1<< 4)
define|#
directive|define
name|ENABLE_LAM_INFO_ECC_MASK
value|0x3
name|mailbox
operator|=
name|mthca_alloc_mailbox
argument_list|(
name|dev
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|mailbox
argument_list|)
condition|)
return|return
name|PTR_ERR
argument_list|(
name|mailbox
argument_list|)
return|;
name|outbox
operator|=
name|mailbox
operator|->
name|buf
expr_stmt|;
name|err
operator|=
name|mthca_cmd_box
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|,
name|mailbox
operator|->
name|dma
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|CMD_ENABLE_LAM
argument_list|,
name|CMD_TIME_CLASS_C
argument_list|,
name|status
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
operator|*
name|status
operator|==
name|MTHCA_CMD_STAT_LAM_NOT_PRE
condition|)
goto|goto
name|out
goto|;
name|MTHCA_GET
argument_list|(
name|dev
operator|->
name|ddr_start
argument_list|,
name|outbox
argument_list|,
name|ENABLE_LAM_START_OFFSET
argument_list|)
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|dev
operator|->
name|ddr_end
argument_list|,
name|outbox
argument_list|,
name|ENABLE_LAM_END_OFFSET
argument_list|)
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|info
argument_list|,
name|outbox
argument_list|,
name|ENABLE_LAM_INFO_OFFSET
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|!
operator|(
name|info
operator|&
name|ENABLE_LAM_INFO_HIDDEN_FLAG
operator|)
operator|!=
operator|!
operator|!
operator|(
name|dev
operator|->
name|mthca_flags
operator|&
name|MTHCA_FLAG_DDR_HIDDEN
operator|)
condition|)
block|{
name|mthca_info
argument_list|(
name|dev
argument_list|,
literal|"FW reports that HCA-attached memory "
literal|"is %s hidden; does not match PCI config\n"
argument_list|,
operator|(
name|info
operator|&
name|ENABLE_LAM_INFO_HIDDEN_FLAG
operator|)
condition|?
literal|""
else|:
literal|"not"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|info
operator|&
name|ENABLE_LAM_INFO_HIDDEN_FLAG
condition|)
name|mthca_dbg
argument_list|(
name|dev
argument_list|,
literal|"HCA-attached memory is hidden.\n"
argument_list|)
expr_stmt|;
name|mthca_dbg
argument_list|(
name|dev
argument_list|,
literal|"HCA memory size %d KB (start %llx, end %llx)\n"
argument_list|,
call|(
name|int
call|)
argument_list|(
operator|(
name|dev
operator|->
name|ddr_end
operator|-
name|dev
operator|->
name|ddr_start
operator|)
operator|>>
literal|10
argument_list|)
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|dev
operator|->
name|ddr_start
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|dev
operator|->
name|ddr_end
argument_list|)
expr_stmt|;
name|out
label|:
name|mthca_free_mailbox
argument_list|(
name|dev
argument_list|,
name|mailbox
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|int
name|mthca_DISABLE_LAM
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|,
name|u8
modifier|*
name|status
parameter_list|)
block|{
return|return
name|mthca_cmd
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|CMD_SYS_DIS
argument_list|,
name|CMD_TIME_CLASS_C
argument_list|,
name|status
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|mthca_QUERY_DDR
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|,
name|u8
modifier|*
name|status
parameter_list|)
block|{
name|struct
name|mthca_mailbox
modifier|*
name|mailbox
decl_stmt|;
name|u8
name|info
decl_stmt|;
name|u32
modifier|*
name|outbox
decl_stmt|;
name|int
name|err
init|=
literal|0
decl_stmt|;
define|#
directive|define
name|QUERY_DDR_OUT_SIZE
value|0x100
define|#
directive|define
name|QUERY_DDR_START_OFFSET
value|0x00
define|#
directive|define
name|QUERY_DDR_END_OFFSET
value|0x08
define|#
directive|define
name|QUERY_DDR_INFO_OFFSET
value|0x13
define|#
directive|define
name|QUERY_DDR_INFO_HIDDEN_FLAG
value|(1<< 4)
define|#
directive|define
name|QUERY_DDR_INFO_ECC_MASK
value|0x3
name|mailbox
operator|=
name|mthca_alloc_mailbox
argument_list|(
name|dev
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|mailbox
argument_list|)
condition|)
return|return
name|PTR_ERR
argument_list|(
name|mailbox
argument_list|)
return|;
name|outbox
operator|=
name|mailbox
operator|->
name|buf
expr_stmt|;
name|err
operator|=
name|mthca_cmd_box
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|,
name|mailbox
operator|->
name|dma
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|CMD_QUERY_DDR
argument_list|,
name|CMD_TIME_CLASS_A
argument_list|,
name|status
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|out
goto|;
name|MTHCA_GET
argument_list|(
name|dev
operator|->
name|ddr_start
argument_list|,
name|outbox
argument_list|,
name|QUERY_DDR_START_OFFSET
argument_list|)
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|dev
operator|->
name|ddr_end
argument_list|,
name|outbox
argument_list|,
name|QUERY_DDR_END_OFFSET
argument_list|)
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|info
argument_list|,
name|outbox
argument_list|,
name|QUERY_DDR_INFO_OFFSET
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|!
operator|(
name|info
operator|&
name|QUERY_DDR_INFO_HIDDEN_FLAG
operator|)
operator|!=
operator|!
operator|!
operator|(
name|dev
operator|->
name|mthca_flags
operator|&
name|MTHCA_FLAG_DDR_HIDDEN
operator|)
condition|)
block|{
name|mthca_info
argument_list|(
name|dev
argument_list|,
literal|"FW reports that HCA-attached memory "
literal|"is %s hidden; does not match PCI config\n"
argument_list|,
operator|(
name|info
operator|&
name|QUERY_DDR_INFO_HIDDEN_FLAG
operator|)
condition|?
literal|""
else|:
literal|"not"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|info
operator|&
name|QUERY_DDR_INFO_HIDDEN_FLAG
condition|)
name|mthca_dbg
argument_list|(
name|dev
argument_list|,
literal|"HCA-attached memory is hidden.\n"
argument_list|)
expr_stmt|;
name|mthca_dbg
argument_list|(
name|dev
argument_list|,
literal|"HCA memory size %d KB (start %llx, end %llx)\n"
argument_list|,
call|(
name|int
call|)
argument_list|(
operator|(
name|dev
operator|->
name|ddr_end
operator|-
name|dev
operator|->
name|ddr_start
operator|)
operator|>>
literal|10
argument_list|)
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|dev
operator|->
name|ddr_start
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|dev
operator|->
name|ddr_end
argument_list|)
expr_stmt|;
name|out
label|:
name|mthca_free_mailbox
argument_list|(
name|dev
argument_list|,
name|mailbox
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|int
name|mthca_QUERY_DEV_LIM
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mthca_dev_lim
modifier|*
name|dev_lim
parameter_list|,
name|u8
modifier|*
name|status
parameter_list|)
block|{
name|struct
name|mthca_mailbox
modifier|*
name|mailbox
decl_stmt|;
name|u32
modifier|*
name|outbox
decl_stmt|;
name|u8
name|field
decl_stmt|;
name|u16
name|size
decl_stmt|;
name|u16
name|stat_rate
decl_stmt|;
name|int
name|err
decl_stmt|;
define|#
directive|define
name|QUERY_DEV_LIM_OUT_SIZE
value|0x100
define|#
directive|define
name|QUERY_DEV_LIM_MAX_SRQ_SZ_OFFSET
value|0x10
define|#
directive|define
name|QUERY_DEV_LIM_MAX_QP_SZ_OFFSET
value|0x11
define|#
directive|define
name|QUERY_DEV_LIM_RSVD_QP_OFFSET
value|0x12
define|#
directive|define
name|QUERY_DEV_LIM_MAX_QP_OFFSET
value|0x13
define|#
directive|define
name|QUERY_DEV_LIM_RSVD_SRQ_OFFSET
value|0x14
define|#
directive|define
name|QUERY_DEV_LIM_MAX_SRQ_OFFSET
value|0x15
define|#
directive|define
name|QUERY_DEV_LIM_RSVD_EEC_OFFSET
value|0x16
define|#
directive|define
name|QUERY_DEV_LIM_MAX_EEC_OFFSET
value|0x17
define|#
directive|define
name|QUERY_DEV_LIM_MAX_CQ_SZ_OFFSET
value|0x19
define|#
directive|define
name|QUERY_DEV_LIM_RSVD_CQ_OFFSET
value|0x1a
define|#
directive|define
name|QUERY_DEV_LIM_MAX_CQ_OFFSET
value|0x1b
define|#
directive|define
name|QUERY_DEV_LIM_MAX_MPT_OFFSET
value|0x1d
define|#
directive|define
name|QUERY_DEV_LIM_RSVD_EQ_OFFSET
value|0x1e
define|#
directive|define
name|QUERY_DEV_LIM_MAX_EQ_OFFSET
value|0x1f
define|#
directive|define
name|QUERY_DEV_LIM_RSVD_MTT_OFFSET
value|0x20
define|#
directive|define
name|QUERY_DEV_LIM_MAX_MRW_SZ_OFFSET
value|0x21
define|#
directive|define
name|QUERY_DEV_LIM_RSVD_MRW_OFFSET
value|0x22
define|#
directive|define
name|QUERY_DEV_LIM_MAX_MTT_SEG_OFFSET
value|0x23
define|#
directive|define
name|QUERY_DEV_LIM_MAX_AV_OFFSET
value|0x27
define|#
directive|define
name|QUERY_DEV_LIM_MAX_REQ_QP_OFFSET
value|0x29
define|#
directive|define
name|QUERY_DEV_LIM_MAX_RES_QP_OFFSET
value|0x2b
define|#
directive|define
name|QUERY_DEV_LIM_MAX_RDMA_OFFSET
value|0x2f
define|#
directive|define
name|QUERY_DEV_LIM_RSZ_SRQ_OFFSET
value|0x33
define|#
directive|define
name|QUERY_DEV_LIM_ACK_DELAY_OFFSET
value|0x35
define|#
directive|define
name|QUERY_DEV_LIM_MTU_WIDTH_OFFSET
value|0x36
define|#
directive|define
name|QUERY_DEV_LIM_VL_PORT_OFFSET
value|0x37
define|#
directive|define
name|QUERY_DEV_LIM_MAX_GID_OFFSET
value|0x3b
define|#
directive|define
name|QUERY_DEV_LIM_RATE_SUPPORT_OFFSET
value|0x3c
define|#
directive|define
name|QUERY_DEV_LIM_MAX_PKEY_OFFSET
value|0x3f
define|#
directive|define
name|QUERY_DEV_LIM_FLAGS_OFFSET
value|0x44
define|#
directive|define
name|QUERY_DEV_LIM_RSVD_UAR_OFFSET
value|0x48
define|#
directive|define
name|QUERY_DEV_LIM_UAR_SZ_OFFSET
value|0x49
define|#
directive|define
name|QUERY_DEV_LIM_PAGE_SZ_OFFSET
value|0x4b
define|#
directive|define
name|QUERY_DEV_LIM_MAX_SG_OFFSET
value|0x51
define|#
directive|define
name|QUERY_DEV_LIM_MAX_DESC_SZ_OFFSET
value|0x52
define|#
directive|define
name|QUERY_DEV_LIM_MAX_SG_RQ_OFFSET
value|0x55
define|#
directive|define
name|QUERY_DEV_LIM_MAX_DESC_SZ_RQ_OFFSET
value|0x56
define|#
directive|define
name|QUERY_DEV_LIM_MAX_QP_MCG_OFFSET
value|0x61
define|#
directive|define
name|QUERY_DEV_LIM_RSVD_MCG_OFFSET
value|0x62
define|#
directive|define
name|QUERY_DEV_LIM_MAX_MCG_OFFSET
value|0x63
define|#
directive|define
name|QUERY_DEV_LIM_RSVD_PD_OFFSET
value|0x64
define|#
directive|define
name|QUERY_DEV_LIM_MAX_PD_OFFSET
value|0x65
define|#
directive|define
name|QUERY_DEV_LIM_RSVD_RDD_OFFSET
value|0x66
define|#
directive|define
name|QUERY_DEV_LIM_MAX_RDD_OFFSET
value|0x67
define|#
directive|define
name|QUERY_DEV_LIM_EEC_ENTRY_SZ_OFFSET
value|0x80
define|#
directive|define
name|QUERY_DEV_LIM_QPC_ENTRY_SZ_OFFSET
value|0x82
define|#
directive|define
name|QUERY_DEV_LIM_EEEC_ENTRY_SZ_OFFSET
value|0x84
define|#
directive|define
name|QUERY_DEV_LIM_EQPC_ENTRY_SZ_OFFSET
value|0x86
define|#
directive|define
name|QUERY_DEV_LIM_EQC_ENTRY_SZ_OFFSET
value|0x88
define|#
directive|define
name|QUERY_DEV_LIM_CQC_ENTRY_SZ_OFFSET
value|0x8a
define|#
directive|define
name|QUERY_DEV_LIM_SRQ_ENTRY_SZ_OFFSET
value|0x8c
define|#
directive|define
name|QUERY_DEV_LIM_UAR_ENTRY_SZ_OFFSET
value|0x8e
define|#
directive|define
name|QUERY_DEV_LIM_MTT_ENTRY_SZ_OFFSET
value|0x90
define|#
directive|define
name|QUERY_DEV_LIM_MPT_ENTRY_SZ_OFFSET
value|0x92
define|#
directive|define
name|QUERY_DEV_LIM_PBL_SZ_OFFSET
value|0x96
define|#
directive|define
name|QUERY_DEV_LIM_BMME_FLAGS_OFFSET
value|0x97
define|#
directive|define
name|QUERY_DEV_LIM_RSVD_LKEY_OFFSET
value|0x98
define|#
directive|define
name|QUERY_DEV_LIM_LAMR_OFFSET
value|0x9f
define|#
directive|define
name|QUERY_DEV_LIM_MAX_ICM_SZ_OFFSET
value|0xa0
name|mailbox
operator|=
name|mthca_alloc_mailbox
argument_list|(
name|dev
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|mailbox
argument_list|)
condition|)
return|return
name|PTR_ERR
argument_list|(
name|mailbox
argument_list|)
return|;
name|outbox
operator|=
name|mailbox
operator|->
name|buf
expr_stmt|;
name|err
operator|=
name|mthca_cmd_box
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|,
name|mailbox
operator|->
name|dma
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|CMD_QUERY_DEV_LIM
argument_list|,
name|CMD_TIME_CLASS_A
argument_list|,
name|status
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|out
goto|;
name|MTHCA_GET
argument_list|(
name|field
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_RSVD_QP_OFFSET
argument_list|)
expr_stmt|;
name|dev_lim
operator|->
name|reserved_qps
operator|=
literal|1
operator|<<
operator|(
name|field
operator|&
literal|0xf
operator|)
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|field
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_MAX_QP_OFFSET
argument_list|)
expr_stmt|;
name|dev_lim
operator|->
name|max_qps
operator|=
literal|1
operator|<<
operator|(
name|field
operator|&
literal|0x1f
operator|)
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|field
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_RSVD_SRQ_OFFSET
argument_list|)
expr_stmt|;
name|dev_lim
operator|->
name|reserved_srqs
operator|=
literal|1
operator|<<
operator|(
name|field
operator|>>
literal|4
operator|)
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|field
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_MAX_SRQ_OFFSET
argument_list|)
expr_stmt|;
name|dev_lim
operator|->
name|max_srqs
operator|=
literal|1
operator|<<
operator|(
name|field
operator|&
literal|0x1f
operator|)
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|field
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_RSVD_EEC_OFFSET
argument_list|)
expr_stmt|;
name|dev_lim
operator|->
name|reserved_eecs
operator|=
literal|1
operator|<<
operator|(
name|field
operator|&
literal|0xf
operator|)
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|field
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_MAX_EEC_OFFSET
argument_list|)
expr_stmt|;
name|dev_lim
operator|->
name|max_eecs
operator|=
literal|1
operator|<<
operator|(
name|field
operator|&
literal|0x1f
operator|)
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|field
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_MAX_CQ_SZ_OFFSET
argument_list|)
expr_stmt|;
name|dev_lim
operator|->
name|max_cq_sz
operator|=
literal|1
operator|<<
name|field
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|field
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_RSVD_CQ_OFFSET
argument_list|)
expr_stmt|;
name|dev_lim
operator|->
name|reserved_cqs
operator|=
literal|1
operator|<<
operator|(
name|field
operator|&
literal|0xf
operator|)
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|field
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_MAX_CQ_OFFSET
argument_list|)
expr_stmt|;
name|dev_lim
operator|->
name|max_cqs
operator|=
literal|1
operator|<<
operator|(
name|field
operator|&
literal|0x1f
operator|)
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|field
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_MAX_MPT_OFFSET
argument_list|)
expr_stmt|;
name|dev_lim
operator|->
name|max_mpts
operator|=
literal|1
operator|<<
operator|(
name|field
operator|&
literal|0x3f
operator|)
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|field
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_RSVD_EQ_OFFSET
argument_list|)
expr_stmt|;
name|dev_lim
operator|->
name|reserved_eqs
operator|=
literal|1
operator|<<
operator|(
name|field
operator|&
literal|0xf
operator|)
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|field
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_MAX_EQ_OFFSET
argument_list|)
expr_stmt|;
name|dev_lim
operator|->
name|max_eqs
operator|=
literal|1
operator|<<
operator|(
name|field
operator|&
literal|0x7
operator|)
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|field
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_RSVD_MTT_OFFSET
argument_list|)
expr_stmt|;
if|if
condition|(
name|mthca_is_memfree
argument_list|(
name|dev
argument_list|)
condition|)
name|dev_lim
operator|->
name|reserved_mtts
operator|=
name|ALIGN
argument_list|(
operator|(
literal|1
operator|<<
operator|(
name|field
operator|>>
literal|4
operator|)
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|u64
argument_list|)
argument_list|,
name|dev
operator|->
name|limits
operator|.
name|mtt_seg_size
argument_list|)
operator|/
name|dev
operator|->
name|limits
operator|.
name|mtt_seg_size
expr_stmt|;
else|else
name|dev_lim
operator|->
name|reserved_mtts
operator|=
literal|1
operator|<<
operator|(
name|field
operator|>>
literal|4
operator|)
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|field
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_MAX_MRW_SZ_OFFSET
argument_list|)
expr_stmt|;
name|dev_lim
operator|->
name|max_mrw_sz
operator|=
literal|1
operator|<<
name|field
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|field
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_RSVD_MRW_OFFSET
argument_list|)
expr_stmt|;
name|dev_lim
operator|->
name|reserved_mrws
operator|=
literal|1
operator|<<
operator|(
name|field
operator|&
literal|0xf
operator|)
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|field
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_MAX_MTT_SEG_OFFSET
argument_list|)
expr_stmt|;
name|dev_lim
operator|->
name|max_mtt_seg
operator|=
literal|1
operator|<<
operator|(
name|field
operator|&
literal|0x3f
operator|)
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|field
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_MAX_REQ_QP_OFFSET
argument_list|)
expr_stmt|;
name|dev_lim
operator|->
name|max_requester_per_qp
operator|=
literal|1
operator|<<
operator|(
name|field
operator|&
literal|0x3f
operator|)
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|field
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_MAX_RES_QP_OFFSET
argument_list|)
expr_stmt|;
name|dev_lim
operator|->
name|max_responder_per_qp
operator|=
literal|1
operator|<<
operator|(
name|field
operator|&
literal|0x3f
operator|)
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|field
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_MAX_RDMA_OFFSET
argument_list|)
expr_stmt|;
name|dev_lim
operator|->
name|max_rdma_global
operator|=
literal|1
operator|<<
operator|(
name|field
operator|&
literal|0x3f
operator|)
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|field
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_ACK_DELAY_OFFSET
argument_list|)
expr_stmt|;
name|dev_lim
operator|->
name|local_ca_ack_delay
operator|=
name|field
operator|&
literal|0x1f
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|field
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_MTU_WIDTH_OFFSET
argument_list|)
expr_stmt|;
name|dev_lim
operator|->
name|max_mtu
operator|=
name|field
operator|>>
literal|4
expr_stmt|;
name|dev_lim
operator|->
name|max_port_width
operator|=
name|field
operator|&
literal|0xf
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|field
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_VL_PORT_OFFSET
argument_list|)
expr_stmt|;
name|dev_lim
operator|->
name|max_vl
operator|=
name|field
operator|>>
literal|4
expr_stmt|;
name|dev_lim
operator|->
name|num_ports
operator|=
name|field
operator|&
literal|0xf
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|field
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_MAX_GID_OFFSET
argument_list|)
expr_stmt|;
name|dev_lim
operator|->
name|max_gids
operator|=
literal|1
operator|<<
operator|(
name|field
operator|&
literal|0xf
operator|)
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|stat_rate
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_RATE_SUPPORT_OFFSET
argument_list|)
expr_stmt|;
name|dev_lim
operator|->
name|stat_rate_support
operator|=
name|stat_rate
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|field
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_MAX_PKEY_OFFSET
argument_list|)
expr_stmt|;
name|dev_lim
operator|->
name|max_pkeys
operator|=
literal|1
operator|<<
operator|(
name|field
operator|&
literal|0xf
operator|)
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|dev_lim
operator|->
name|flags
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_FLAGS_OFFSET
argument_list|)
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|field
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_RSVD_UAR_OFFSET
argument_list|)
expr_stmt|;
name|dev_lim
operator|->
name|reserved_uars
operator|=
name|field
operator|>>
literal|4
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|field
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_UAR_SZ_OFFSET
argument_list|)
expr_stmt|;
name|dev_lim
operator|->
name|uar_size
operator|=
literal|1
operator|<<
operator|(
operator|(
name|field
operator|&
literal|0x3f
operator|)
operator|+
literal|20
operator|)
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|field
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_PAGE_SZ_OFFSET
argument_list|)
expr_stmt|;
name|dev_lim
operator|->
name|min_page_sz
operator|=
literal|1
operator|<<
name|field
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|field
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_MAX_SG_OFFSET
argument_list|)
expr_stmt|;
name|dev_lim
operator|->
name|max_sg
operator|=
name|field
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|size
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_MAX_DESC_SZ_OFFSET
argument_list|)
expr_stmt|;
name|dev_lim
operator|->
name|max_desc_sz
operator|=
name|size
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|field
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_MAX_QP_MCG_OFFSET
argument_list|)
expr_stmt|;
name|dev_lim
operator|->
name|max_qp_per_mcg
operator|=
literal|1
operator|<<
name|field
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|field
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_RSVD_MCG_OFFSET
argument_list|)
expr_stmt|;
name|dev_lim
operator|->
name|reserved_mgms
operator|=
name|field
operator|&
literal|0xf
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|field
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_MAX_MCG_OFFSET
argument_list|)
expr_stmt|;
name|dev_lim
operator|->
name|max_mcgs
operator|=
literal|1
operator|<<
name|field
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|field
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_RSVD_PD_OFFSET
argument_list|)
expr_stmt|;
name|dev_lim
operator|->
name|reserved_pds
operator|=
name|field
operator|>>
literal|4
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|field
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_MAX_PD_OFFSET
argument_list|)
expr_stmt|;
name|dev_lim
operator|->
name|max_pds
operator|=
literal|1
operator|<<
operator|(
name|field
operator|&
literal|0x3f
operator|)
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|field
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_RSVD_RDD_OFFSET
argument_list|)
expr_stmt|;
name|dev_lim
operator|->
name|reserved_rdds
operator|=
name|field
operator|>>
literal|4
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|field
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_MAX_RDD_OFFSET
argument_list|)
expr_stmt|;
name|dev_lim
operator|->
name|max_rdds
operator|=
literal|1
operator|<<
operator|(
name|field
operator|&
literal|0x3f
operator|)
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|size
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_EEC_ENTRY_SZ_OFFSET
argument_list|)
expr_stmt|;
name|dev_lim
operator|->
name|eec_entry_sz
operator|=
name|size
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|size
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_QPC_ENTRY_SZ_OFFSET
argument_list|)
expr_stmt|;
name|dev_lim
operator|->
name|qpc_entry_sz
operator|=
name|size
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|size
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_EEEC_ENTRY_SZ_OFFSET
argument_list|)
expr_stmt|;
name|dev_lim
operator|->
name|eeec_entry_sz
operator|=
name|size
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|size
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_EQPC_ENTRY_SZ_OFFSET
argument_list|)
expr_stmt|;
name|dev_lim
operator|->
name|eqpc_entry_sz
operator|=
name|size
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|size
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_EQC_ENTRY_SZ_OFFSET
argument_list|)
expr_stmt|;
name|dev_lim
operator|->
name|eqc_entry_sz
operator|=
name|size
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|size
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_CQC_ENTRY_SZ_OFFSET
argument_list|)
expr_stmt|;
name|dev_lim
operator|->
name|cqc_entry_sz
operator|=
name|size
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|size
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_SRQ_ENTRY_SZ_OFFSET
argument_list|)
expr_stmt|;
name|dev_lim
operator|->
name|srq_entry_sz
operator|=
name|size
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|size
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_UAR_ENTRY_SZ_OFFSET
argument_list|)
expr_stmt|;
name|dev_lim
operator|->
name|uar_scratch_entry_sz
operator|=
name|size
expr_stmt|;
if|if
condition|(
name|mthca_is_memfree
argument_list|(
name|dev
argument_list|)
condition|)
block|{
name|MTHCA_GET
argument_list|(
name|field
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_MAX_SRQ_SZ_OFFSET
argument_list|)
expr_stmt|;
name|dev_lim
operator|->
name|max_srq_sz
operator|=
literal|1
operator|<<
name|field
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|field
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_MAX_QP_SZ_OFFSET
argument_list|)
expr_stmt|;
name|dev_lim
operator|->
name|max_qp_sz
operator|=
literal|1
operator|<<
name|field
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|field
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_RSZ_SRQ_OFFSET
argument_list|)
expr_stmt|;
name|dev_lim
operator|->
name|hca
operator|.
name|arbel
operator|.
name|resize_srq
operator|=
name|field
operator|&
literal|1
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|field
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_MAX_SG_RQ_OFFSET
argument_list|)
expr_stmt|;
name|dev_lim
operator|->
name|max_sg
operator|=
name|min_t
argument_list|(
name|int
argument_list|,
name|field
argument_list|,
name|dev_lim
operator|->
name|max_sg
argument_list|)
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|size
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_MAX_DESC_SZ_RQ_OFFSET
argument_list|)
expr_stmt|;
name|dev_lim
operator|->
name|max_desc_sz
operator|=
name|min_t
argument_list|(
name|int
argument_list|,
name|size
argument_list|,
name|dev_lim
operator|->
name|max_desc_sz
argument_list|)
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|size
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_MPT_ENTRY_SZ_OFFSET
argument_list|)
expr_stmt|;
name|dev_lim
operator|->
name|mpt_entry_sz
operator|=
name|size
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|field
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_PBL_SZ_OFFSET
argument_list|)
expr_stmt|;
name|dev_lim
operator|->
name|hca
operator|.
name|arbel
operator|.
name|max_pbl_sz
operator|=
literal|1
operator|<<
operator|(
name|field
operator|&
literal|0x3f
operator|)
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|dev_lim
operator|->
name|hca
operator|.
name|arbel
operator|.
name|bmme_flags
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_BMME_FLAGS_OFFSET
argument_list|)
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|dev_lim
operator|->
name|hca
operator|.
name|arbel
operator|.
name|reserved_lkey
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_RSVD_LKEY_OFFSET
argument_list|)
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|field
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_LAMR_OFFSET
argument_list|)
expr_stmt|;
name|dev_lim
operator|->
name|hca
operator|.
name|arbel
operator|.
name|lam_required
operator|=
name|field
operator|&
literal|1
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|dev_lim
operator|->
name|hca
operator|.
name|arbel
operator|.
name|max_icm_sz
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_MAX_ICM_SZ_OFFSET
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev_lim
operator|->
name|hca
operator|.
name|arbel
operator|.
name|bmme_flags
operator|&
literal|1
condition|)
name|mthca_dbg
argument_list|(
name|dev
argument_list|,
literal|"Base MM extensions: yes "
literal|"(flags %d, max PBL %d, rsvd L_Key %08x)\n"
argument_list|,
name|dev_lim
operator|->
name|hca
operator|.
name|arbel
operator|.
name|bmme_flags
argument_list|,
name|dev_lim
operator|->
name|hca
operator|.
name|arbel
operator|.
name|max_pbl_sz
argument_list|,
name|dev_lim
operator|->
name|hca
operator|.
name|arbel
operator|.
name|reserved_lkey
argument_list|)
expr_stmt|;
else|else
name|mthca_dbg
argument_list|(
name|dev
argument_list|,
literal|"Base MM extensions: no\n"
argument_list|)
expr_stmt|;
name|mthca_dbg
argument_list|(
name|dev
argument_list|,
literal|"Max ICM size %lld MB\n"
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|dev_lim
operator|->
name|hca
operator|.
name|arbel
operator|.
name|max_icm_sz
operator|>>
literal|20
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|MTHCA_GET
argument_list|(
name|field
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_MAX_SRQ_SZ_OFFSET
argument_list|)
expr_stmt|;
name|dev_lim
operator|->
name|max_srq_sz
operator|=
operator|(
literal|1
operator|<<
name|field
operator|)
operator|-
literal|1
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|field
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_MAX_QP_SZ_OFFSET
argument_list|)
expr_stmt|;
name|dev_lim
operator|->
name|max_qp_sz
operator|=
operator|(
literal|1
operator|<<
name|field
operator|)
operator|-
literal|1
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|field
argument_list|,
name|outbox
argument_list|,
name|QUERY_DEV_LIM_MAX_AV_OFFSET
argument_list|)
expr_stmt|;
name|dev_lim
operator|->
name|hca
operator|.
name|tavor
operator|.
name|max_avs
operator|=
literal|1
operator|<<
operator|(
name|field
operator|&
literal|0x3f
operator|)
expr_stmt|;
name|dev_lim
operator|->
name|mpt_entry_sz
operator|=
name|MTHCA_MPT_ENTRY_SIZE
expr_stmt|;
block|}
name|mthca_dbg
argument_list|(
name|dev
argument_list|,
literal|"Max QPs: %d, reserved QPs: %d, entry size: %d\n"
argument_list|,
name|dev_lim
operator|->
name|max_qps
argument_list|,
name|dev_lim
operator|->
name|reserved_qps
argument_list|,
name|dev_lim
operator|->
name|qpc_entry_sz
argument_list|)
expr_stmt|;
name|mthca_dbg
argument_list|(
name|dev
argument_list|,
literal|"Max SRQs: %d, reserved SRQs: %d, entry size: %d\n"
argument_list|,
name|dev_lim
operator|->
name|max_srqs
argument_list|,
name|dev_lim
operator|->
name|reserved_srqs
argument_list|,
name|dev_lim
operator|->
name|srq_entry_sz
argument_list|)
expr_stmt|;
name|mthca_dbg
argument_list|(
name|dev
argument_list|,
literal|"Max CQs: %d, reserved CQs: %d, entry size: %d\n"
argument_list|,
name|dev_lim
operator|->
name|max_cqs
argument_list|,
name|dev_lim
operator|->
name|reserved_cqs
argument_list|,
name|dev_lim
operator|->
name|cqc_entry_sz
argument_list|)
expr_stmt|;
name|mthca_dbg
argument_list|(
name|dev
argument_list|,
literal|"Max EQs: %d, reserved EQs: %d, entry size: %d\n"
argument_list|,
name|dev_lim
operator|->
name|max_eqs
argument_list|,
name|dev_lim
operator|->
name|reserved_eqs
argument_list|,
name|dev_lim
operator|->
name|eqc_entry_sz
argument_list|)
expr_stmt|;
name|mthca_dbg
argument_list|(
name|dev
argument_list|,
literal|"reserved MPTs: %d, reserved MTTs: %d\n"
argument_list|,
name|dev_lim
operator|->
name|reserved_mrws
argument_list|,
name|dev_lim
operator|->
name|reserved_mtts
argument_list|)
expr_stmt|;
name|mthca_dbg
argument_list|(
name|dev
argument_list|,
literal|"Max PDs: %d, reserved PDs: %d, reserved UARs: %d\n"
argument_list|,
name|dev_lim
operator|->
name|max_pds
argument_list|,
name|dev_lim
operator|->
name|reserved_pds
argument_list|,
name|dev_lim
operator|->
name|reserved_uars
argument_list|)
expr_stmt|;
name|mthca_dbg
argument_list|(
name|dev
argument_list|,
literal|"Max QP/MCG: %d, reserved MGMs: %d\n"
argument_list|,
name|dev_lim
operator|->
name|max_pds
argument_list|,
name|dev_lim
operator|->
name|reserved_mgms
argument_list|)
expr_stmt|;
name|mthca_dbg
argument_list|(
name|dev
argument_list|,
literal|"Max CQEs: %d, max WQEs: %d, max SRQ WQEs: %d\n"
argument_list|,
name|dev_lim
operator|->
name|max_cq_sz
argument_list|,
name|dev_lim
operator|->
name|max_qp_sz
argument_list|,
name|dev_lim
operator|->
name|max_srq_sz
argument_list|)
expr_stmt|;
name|mthca_dbg
argument_list|(
name|dev
argument_list|,
literal|"Flags: %08x\n"
argument_list|,
name|dev_lim
operator|->
name|flags
argument_list|)
expr_stmt|;
name|out
label|:
name|mthca_free_mailbox
argument_list|(
name|dev
argument_list|,
name|mailbox
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|get_board_id
parameter_list|(
name|void
modifier|*
name|vsd
parameter_list|,
name|char
modifier|*
name|board_id
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
define|#
directive|define
name|VSD_OFFSET_SIG1
value|0x00
define|#
directive|define
name|VSD_OFFSET_SIG2
value|0xde
define|#
directive|define
name|VSD_OFFSET_MLX_BOARD_ID
value|0xd0
define|#
directive|define
name|VSD_OFFSET_TS_BOARD_ID
value|0x20
define|#
directive|define
name|VSD_SIGNATURE_TOPSPIN
value|0x5ad
name|memset
argument_list|(
name|board_id
argument_list|,
literal|0
argument_list|,
name|MTHCA_BOARD_ID_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|be16_to_cpup
argument_list|(
name|vsd
operator|+
name|VSD_OFFSET_SIG1
argument_list|)
operator|==
name|VSD_SIGNATURE_TOPSPIN
operator|&&
name|be16_to_cpup
argument_list|(
name|vsd
operator|+
name|VSD_OFFSET_SIG2
argument_list|)
operator|==
name|VSD_SIGNATURE_TOPSPIN
condition|)
block|{
name|strlcpy
argument_list|(
name|board_id
argument_list|,
name|vsd
operator|+
name|VSD_OFFSET_TS_BOARD_ID
argument_list|,
name|MTHCA_BOARD_ID_LEN
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* 		 * The board ID is a string but the firmware byte 		 * swaps each 4-byte word before passing it back to 		 * us.  Therefore we need to swab it before printing. 		 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
operator|++
name|i
control|)
operator|(
operator|(
name|u32
operator|*
operator|)
name|board_id
operator|)
index|[
name|i
index|]
operator|=
name|swab32
argument_list|(
operator|*
operator|(
name|u32
operator|*
operator|)
operator|(
name|vsd
operator|+
name|VSD_OFFSET_MLX_BOARD_ID
operator|+
name|i
operator|*
literal|4
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|mthca_QUERY_ADAPTER
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mthca_adapter
modifier|*
name|adapter
parameter_list|,
name|u8
modifier|*
name|status
parameter_list|)
block|{
name|struct
name|mthca_mailbox
modifier|*
name|mailbox
decl_stmt|;
name|u32
modifier|*
name|outbox
decl_stmt|;
name|int
name|err
decl_stmt|;
define|#
directive|define
name|QUERY_ADAPTER_OUT_SIZE
value|0x100
define|#
directive|define
name|QUERY_ADAPTER_VENDOR_ID_OFFSET
value|0x00
define|#
directive|define
name|QUERY_ADAPTER_DEVICE_ID_OFFSET
value|0x04
define|#
directive|define
name|QUERY_ADAPTER_REVISION_ID_OFFSET
value|0x08
define|#
directive|define
name|QUERY_ADAPTER_INTA_PIN_OFFSET
value|0x10
define|#
directive|define
name|QUERY_ADAPTER_VSD_OFFSET
value|0x20
name|mailbox
operator|=
name|mthca_alloc_mailbox
argument_list|(
name|dev
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|mailbox
argument_list|)
condition|)
return|return
name|PTR_ERR
argument_list|(
name|mailbox
argument_list|)
return|;
name|outbox
operator|=
name|mailbox
operator|->
name|buf
expr_stmt|;
name|err
operator|=
name|mthca_cmd_box
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|,
name|mailbox
operator|->
name|dma
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|CMD_QUERY_ADAPTER
argument_list|,
name|CMD_TIME_CLASS_A
argument_list|,
name|status
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
operator|!
name|mthca_is_memfree
argument_list|(
name|dev
argument_list|)
condition|)
block|{
name|MTHCA_GET
argument_list|(
name|adapter
operator|->
name|vendor_id
argument_list|,
name|outbox
argument_list|,
name|QUERY_ADAPTER_VENDOR_ID_OFFSET
argument_list|)
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|adapter
operator|->
name|device_id
argument_list|,
name|outbox
argument_list|,
name|QUERY_ADAPTER_DEVICE_ID_OFFSET
argument_list|)
expr_stmt|;
name|MTHCA_GET
argument_list|(
name|adapter
operator|->
name|revision_id
argument_list|,
name|outbox
argument_list|,
name|QUERY_ADAPTER_REVISION_ID_OFFSET
argument_list|)
expr_stmt|;
block|}
name|MTHCA_GET
argument_list|(
name|adapter
operator|->
name|inta_pin
argument_list|,
name|outbox
argument_list|,
name|QUERY_ADAPTER_INTA_PIN_OFFSET
argument_list|)
expr_stmt|;
name|get_board_id
argument_list|(
name|outbox
operator|+
name|QUERY_ADAPTER_VSD_OFFSET
operator|/
literal|4
argument_list|,
name|adapter
operator|->
name|board_id
argument_list|)
expr_stmt|;
name|out
label|:
name|mthca_free_mailbox
argument_list|(
name|dev
argument_list|,
name|mailbox
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|int
name|mthca_INIT_HCA
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mthca_init_hca_param
modifier|*
name|param
parameter_list|,
name|u8
modifier|*
name|status
parameter_list|)
block|{
name|struct
name|mthca_mailbox
modifier|*
name|mailbox
decl_stmt|;
name|__be32
modifier|*
name|inbox
decl_stmt|;
name|int
name|err
decl_stmt|;
define|#
directive|define
name|INIT_HCA_IN_SIZE
value|0x200
define|#
directive|define
name|INIT_HCA_FLAGS1_OFFSET
value|0x00c
define|#
directive|define
name|INIT_HCA_FLAGS2_OFFSET
value|0x014
define|#
directive|define
name|INIT_HCA_QPC_OFFSET
value|0x020
define|#
directive|define
name|INIT_HCA_QPC_BASE_OFFSET
value|(INIT_HCA_QPC_OFFSET + 0x10)
define|#
directive|define
name|INIT_HCA_LOG_QP_OFFSET
value|(INIT_HCA_QPC_OFFSET + 0x17)
define|#
directive|define
name|INIT_HCA_EEC_BASE_OFFSET
value|(INIT_HCA_QPC_OFFSET + 0x20)
define|#
directive|define
name|INIT_HCA_LOG_EEC_OFFSET
value|(INIT_HCA_QPC_OFFSET + 0x27)
define|#
directive|define
name|INIT_HCA_SRQC_BASE_OFFSET
value|(INIT_HCA_QPC_OFFSET + 0x28)
define|#
directive|define
name|INIT_HCA_LOG_SRQ_OFFSET
value|(INIT_HCA_QPC_OFFSET + 0x2f)
define|#
directive|define
name|INIT_HCA_CQC_BASE_OFFSET
value|(INIT_HCA_QPC_OFFSET + 0x30)
define|#
directive|define
name|INIT_HCA_LOG_CQ_OFFSET
value|(INIT_HCA_QPC_OFFSET + 0x37)
define|#
directive|define
name|INIT_HCA_EQPC_BASE_OFFSET
value|(INIT_HCA_QPC_OFFSET + 0x40)
define|#
directive|define
name|INIT_HCA_EEEC_BASE_OFFSET
value|(INIT_HCA_QPC_OFFSET + 0x50)
define|#
directive|define
name|INIT_HCA_EQC_BASE_OFFSET
value|(INIT_HCA_QPC_OFFSET + 0x60)
define|#
directive|define
name|INIT_HCA_LOG_EQ_OFFSET
value|(INIT_HCA_QPC_OFFSET + 0x67)
define|#
directive|define
name|INIT_HCA_RDB_BASE_OFFSET
value|(INIT_HCA_QPC_OFFSET + 0x70)
define|#
directive|define
name|INIT_HCA_UDAV_OFFSET
value|0x0b0
define|#
directive|define
name|INIT_HCA_UDAV_LKEY_OFFSET
value|(INIT_HCA_UDAV_OFFSET + 0x0)
define|#
directive|define
name|INIT_HCA_UDAV_PD_OFFSET
value|(INIT_HCA_UDAV_OFFSET + 0x4)
define|#
directive|define
name|INIT_HCA_MCAST_OFFSET
value|0x0c0
define|#
directive|define
name|INIT_HCA_MC_BASE_OFFSET
value|(INIT_HCA_MCAST_OFFSET + 0x00)
define|#
directive|define
name|INIT_HCA_LOG_MC_ENTRY_SZ_OFFSET
value|(INIT_HCA_MCAST_OFFSET + 0x12)
define|#
directive|define
name|INIT_HCA_MC_HASH_SZ_OFFSET
value|(INIT_HCA_MCAST_OFFSET + 0x16)
define|#
directive|define
name|INIT_HCA_LOG_MC_TABLE_SZ_OFFSET
value|(INIT_HCA_MCAST_OFFSET + 0x1b)
define|#
directive|define
name|INIT_HCA_TPT_OFFSET
value|0x0f0
define|#
directive|define
name|INIT_HCA_MPT_BASE_OFFSET
value|(INIT_HCA_TPT_OFFSET + 0x00)
define|#
directive|define
name|INIT_HCA_MTT_SEG_SZ_OFFSET
value|(INIT_HCA_TPT_OFFSET + 0x09)
define|#
directive|define
name|INIT_HCA_LOG_MPT_SZ_OFFSET
value|(INIT_HCA_TPT_OFFSET + 0x0b)
define|#
directive|define
name|INIT_HCA_MTT_BASE_OFFSET
value|(INIT_HCA_TPT_OFFSET + 0x10)
define|#
directive|define
name|INIT_HCA_UAR_OFFSET
value|0x120
define|#
directive|define
name|INIT_HCA_UAR_BASE_OFFSET
value|(INIT_HCA_UAR_OFFSET + 0x00)
define|#
directive|define
name|INIT_HCA_UARC_SZ_OFFSET
value|(INIT_HCA_UAR_OFFSET + 0x09)
define|#
directive|define
name|INIT_HCA_LOG_UAR_SZ_OFFSET
value|(INIT_HCA_UAR_OFFSET + 0x0a)
define|#
directive|define
name|INIT_HCA_UAR_PAGE_SZ_OFFSET
value|(INIT_HCA_UAR_OFFSET + 0x0b)
define|#
directive|define
name|INIT_HCA_UAR_SCATCH_BASE_OFFSET
value|(INIT_HCA_UAR_OFFSET + 0x10)
define|#
directive|define
name|INIT_HCA_UAR_CTX_BASE_OFFSET
value|(INIT_HCA_UAR_OFFSET + 0x18)
name|mailbox
operator|=
name|mthca_alloc_mailbox
argument_list|(
name|dev
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|mailbox
argument_list|)
condition|)
return|return
name|PTR_ERR
argument_list|(
name|mailbox
argument_list|)
return|;
name|inbox
operator|=
name|mailbox
operator|->
name|buf
expr_stmt|;
name|memset
argument_list|(
name|inbox
argument_list|,
literal|0
argument_list|,
name|INIT_HCA_IN_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev
operator|->
name|mthca_flags
operator|&
name|MTHCA_FLAG_SINAI_OPT
condition|)
name|MTHCA_PUT
argument_list|(
name|inbox
argument_list|,
literal|0x1
argument_list|,
name|INIT_HCA_FLAGS1_OFFSET
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|__LITTLE_ENDIAN
argument_list|)
operator|*
operator|(
name|inbox
operator|+
name|INIT_HCA_FLAGS2_OFFSET
operator|/
literal|4
operator|)
operator|&=
operator|~
name|cpu_to_be32
argument_list|(
literal|1
operator|<<
literal|1
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|__BIG_ENDIAN
argument_list|)
operator|*
operator|(
name|inbox
operator|+
name|INIT_HCA_FLAGS2_OFFSET
operator|/
literal|4
operator|)
operator||=
name|cpu_to_be32
argument_list|(
literal|1
operator|<<
literal|1
argument_list|)
expr_stmt|;
else|#
directive|else
error|#
directive|error
error|Host endianness not defined
endif|#
directive|endif
comment|/* Check port for UD address vector: */
operator|*
operator|(
name|inbox
operator|+
name|INIT_HCA_FLAGS2_OFFSET
operator|/
literal|4
operator|)
operator||=
name|cpu_to_be32
argument_list|(
literal|1
argument_list|)
expr_stmt|;
comment|/* Enable IPoIB checksumming if we can: */
if|if
condition|(
name|dev
operator|->
name|device_cap_flags
operator|&
name|IB_DEVICE_UD_IP_CSUM
condition|)
operator|*
operator|(
name|inbox
operator|+
name|INIT_HCA_FLAGS2_OFFSET
operator|/
literal|4
operator|)
operator||=
name|cpu_to_be32
argument_list|(
literal|7
operator|<<
literal|3
argument_list|)
expr_stmt|;
comment|/* We leave wqe_quota, responder_exu, etc as 0 (default) */
comment|/* QPC/EEC/CQC/EQC/RDB attributes */
name|MTHCA_PUT
argument_list|(
name|inbox
argument_list|,
name|param
operator|->
name|qpc_base
argument_list|,
name|INIT_HCA_QPC_BASE_OFFSET
argument_list|)
expr_stmt|;
name|MTHCA_PUT
argument_list|(
name|inbox
argument_list|,
name|param
operator|->
name|log_num_qps
argument_list|,
name|INIT_HCA_LOG_QP_OFFSET
argument_list|)
expr_stmt|;
name|MTHCA_PUT
argument_list|(
name|inbox
argument_list|,
name|param
operator|->
name|eec_base
argument_list|,
name|INIT_HCA_EEC_BASE_OFFSET
argument_list|)
expr_stmt|;
name|MTHCA_PUT
argument_list|(
name|inbox
argument_list|,
name|param
operator|->
name|log_num_eecs
argument_list|,
name|INIT_HCA_LOG_EEC_OFFSET
argument_list|)
expr_stmt|;
name|MTHCA_PUT
argument_list|(
name|inbox
argument_list|,
name|param
operator|->
name|srqc_base
argument_list|,
name|INIT_HCA_SRQC_BASE_OFFSET
argument_list|)
expr_stmt|;
name|MTHCA_PUT
argument_list|(
name|inbox
argument_list|,
name|param
operator|->
name|log_num_srqs
argument_list|,
name|INIT_HCA_LOG_SRQ_OFFSET
argument_list|)
expr_stmt|;
name|MTHCA_PUT
argument_list|(
name|inbox
argument_list|,
name|param
operator|->
name|cqc_base
argument_list|,
name|INIT_HCA_CQC_BASE_OFFSET
argument_list|)
expr_stmt|;
name|MTHCA_PUT
argument_list|(
name|inbox
argument_list|,
name|param
operator|->
name|log_num_cqs
argument_list|,
name|INIT_HCA_LOG_CQ_OFFSET
argument_list|)
expr_stmt|;
name|MTHCA_PUT
argument_list|(
name|inbox
argument_list|,
name|param
operator|->
name|eqpc_base
argument_list|,
name|INIT_HCA_EQPC_BASE_OFFSET
argument_list|)
expr_stmt|;
name|MTHCA_PUT
argument_list|(
name|inbox
argument_list|,
name|param
operator|->
name|eeec_base
argument_list|,
name|INIT_HCA_EEEC_BASE_OFFSET
argument_list|)
expr_stmt|;
name|MTHCA_PUT
argument_list|(
name|inbox
argument_list|,
name|param
operator|->
name|eqc_base
argument_list|,
name|INIT_HCA_EQC_BASE_OFFSET
argument_list|)
expr_stmt|;
name|MTHCA_PUT
argument_list|(
name|inbox
argument_list|,
name|param
operator|->
name|log_num_eqs
argument_list|,
name|INIT_HCA_LOG_EQ_OFFSET
argument_list|)
expr_stmt|;
name|MTHCA_PUT
argument_list|(
name|inbox
argument_list|,
name|param
operator|->
name|rdb_base
argument_list|,
name|INIT_HCA_RDB_BASE_OFFSET
argument_list|)
expr_stmt|;
comment|/* UD AV attributes */
comment|/* multicast attributes */
name|MTHCA_PUT
argument_list|(
name|inbox
argument_list|,
name|param
operator|->
name|mc_base
argument_list|,
name|INIT_HCA_MC_BASE_OFFSET
argument_list|)
expr_stmt|;
name|MTHCA_PUT
argument_list|(
name|inbox
argument_list|,
name|param
operator|->
name|log_mc_entry_sz
argument_list|,
name|INIT_HCA_LOG_MC_ENTRY_SZ_OFFSET
argument_list|)
expr_stmt|;
name|MTHCA_PUT
argument_list|(
name|inbox
argument_list|,
name|param
operator|->
name|mc_hash_sz
argument_list|,
name|INIT_HCA_MC_HASH_SZ_OFFSET
argument_list|)
expr_stmt|;
name|MTHCA_PUT
argument_list|(
name|inbox
argument_list|,
name|param
operator|->
name|log_mc_table_sz
argument_list|,
name|INIT_HCA_LOG_MC_TABLE_SZ_OFFSET
argument_list|)
expr_stmt|;
comment|/* TPT attributes */
name|MTHCA_PUT
argument_list|(
name|inbox
argument_list|,
name|param
operator|->
name|mpt_base
argument_list|,
name|INIT_HCA_MPT_BASE_OFFSET
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mthca_is_memfree
argument_list|(
name|dev
argument_list|)
condition|)
name|MTHCA_PUT
argument_list|(
name|inbox
argument_list|,
name|param
operator|->
name|mtt_seg_sz
argument_list|,
name|INIT_HCA_MTT_SEG_SZ_OFFSET
argument_list|)
expr_stmt|;
name|MTHCA_PUT
argument_list|(
name|inbox
argument_list|,
name|param
operator|->
name|log_mpt_sz
argument_list|,
name|INIT_HCA_LOG_MPT_SZ_OFFSET
argument_list|)
expr_stmt|;
name|MTHCA_PUT
argument_list|(
name|inbox
argument_list|,
name|param
operator|->
name|mtt_base
argument_list|,
name|INIT_HCA_MTT_BASE_OFFSET
argument_list|)
expr_stmt|;
comment|/* UAR attributes */
block|{
name|u8
name|uar_page_sz
init|=
name|PAGE_SHIFT
operator|-
literal|12
decl_stmt|;
name|MTHCA_PUT
argument_list|(
name|inbox
argument_list|,
name|uar_page_sz
argument_list|,
name|INIT_HCA_UAR_PAGE_SZ_OFFSET
argument_list|)
expr_stmt|;
block|}
name|MTHCA_PUT
argument_list|(
name|inbox
argument_list|,
name|param
operator|->
name|uar_scratch_base
argument_list|,
name|INIT_HCA_UAR_SCATCH_BASE_OFFSET
argument_list|)
expr_stmt|;
if|if
condition|(
name|mthca_is_memfree
argument_list|(
name|dev
argument_list|)
condition|)
block|{
name|MTHCA_PUT
argument_list|(
name|inbox
argument_list|,
name|param
operator|->
name|log_uarc_sz
argument_list|,
name|INIT_HCA_UARC_SZ_OFFSET
argument_list|)
expr_stmt|;
name|MTHCA_PUT
argument_list|(
name|inbox
argument_list|,
name|param
operator|->
name|log_uar_sz
argument_list|,
name|INIT_HCA_LOG_UAR_SZ_OFFSET
argument_list|)
expr_stmt|;
name|MTHCA_PUT
argument_list|(
name|inbox
argument_list|,
name|param
operator|->
name|uarc_base
argument_list|,
name|INIT_HCA_UAR_CTX_BASE_OFFSET
argument_list|)
expr_stmt|;
block|}
name|err
operator|=
name|mthca_cmd
argument_list|(
name|dev
argument_list|,
name|mailbox
operator|->
name|dma
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|CMD_INIT_HCA
argument_list|,
name|CMD_TIME_CLASS_D
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|mthca_free_mailbox
argument_list|(
name|dev
argument_list|,
name|mailbox
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|int
name|mthca_INIT_IB
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mthca_init_ib_param
modifier|*
name|param
parameter_list|,
name|int
name|port
parameter_list|,
name|u8
modifier|*
name|status
parameter_list|)
block|{
name|struct
name|mthca_mailbox
modifier|*
name|mailbox
decl_stmt|;
name|u32
modifier|*
name|inbox
decl_stmt|;
name|int
name|err
decl_stmt|;
name|u32
name|flags
decl_stmt|;
define|#
directive|define
name|INIT_IB_IN_SIZE
value|56
define|#
directive|define
name|INIT_IB_FLAGS_OFFSET
value|0x00
define|#
directive|define
name|INIT_IB_FLAG_SIG
value|(1<< 18)
define|#
directive|define
name|INIT_IB_FLAG_NG
value|(1<< 17)
define|#
directive|define
name|INIT_IB_FLAG_G0
value|(1<< 16)
define|#
directive|define
name|INIT_IB_VL_SHIFT
value|4
define|#
directive|define
name|INIT_IB_PORT_WIDTH_SHIFT
value|8
define|#
directive|define
name|INIT_IB_MTU_SHIFT
value|12
define|#
directive|define
name|INIT_IB_MAX_GID_OFFSET
value|0x06
define|#
directive|define
name|INIT_IB_MAX_PKEY_OFFSET
value|0x0a
define|#
directive|define
name|INIT_IB_GUID0_OFFSET
value|0x10
define|#
directive|define
name|INIT_IB_NODE_GUID_OFFSET
value|0x18
define|#
directive|define
name|INIT_IB_SI_GUID_OFFSET
value|0x20
name|mailbox
operator|=
name|mthca_alloc_mailbox
argument_list|(
name|dev
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|mailbox
argument_list|)
condition|)
return|return
name|PTR_ERR
argument_list|(
name|mailbox
argument_list|)
return|;
name|inbox
operator|=
name|mailbox
operator|->
name|buf
expr_stmt|;
name|memset
argument_list|(
name|inbox
argument_list|,
literal|0
argument_list|,
name|INIT_IB_IN_SIZE
argument_list|)
expr_stmt|;
name|flags
operator|=
literal|0
expr_stmt|;
name|flags
operator||=
name|param
operator|->
name|set_guid0
condition|?
name|INIT_IB_FLAG_G0
else|:
literal|0
expr_stmt|;
name|flags
operator||=
name|param
operator|->
name|set_node_guid
condition|?
name|INIT_IB_FLAG_NG
else|:
literal|0
expr_stmt|;
name|flags
operator||=
name|param
operator|->
name|set_si_guid
condition|?
name|INIT_IB_FLAG_SIG
else|:
literal|0
expr_stmt|;
name|flags
operator||=
name|param
operator|->
name|vl_cap
operator|<<
name|INIT_IB_VL_SHIFT
expr_stmt|;
name|flags
operator||=
name|param
operator|->
name|port_width
operator|<<
name|INIT_IB_PORT_WIDTH_SHIFT
expr_stmt|;
name|flags
operator||=
name|param
operator|->
name|mtu_cap
operator|<<
name|INIT_IB_MTU_SHIFT
expr_stmt|;
name|MTHCA_PUT
argument_list|(
name|inbox
argument_list|,
name|flags
argument_list|,
name|INIT_IB_FLAGS_OFFSET
argument_list|)
expr_stmt|;
name|MTHCA_PUT
argument_list|(
name|inbox
argument_list|,
name|param
operator|->
name|gid_cap
argument_list|,
name|INIT_IB_MAX_GID_OFFSET
argument_list|)
expr_stmt|;
name|MTHCA_PUT
argument_list|(
name|inbox
argument_list|,
name|param
operator|->
name|pkey_cap
argument_list|,
name|INIT_IB_MAX_PKEY_OFFSET
argument_list|)
expr_stmt|;
name|MTHCA_PUT
argument_list|(
name|inbox
argument_list|,
name|param
operator|->
name|guid0
argument_list|,
name|INIT_IB_GUID0_OFFSET
argument_list|)
expr_stmt|;
name|MTHCA_PUT
argument_list|(
name|inbox
argument_list|,
name|param
operator|->
name|node_guid
argument_list|,
name|INIT_IB_NODE_GUID_OFFSET
argument_list|)
expr_stmt|;
name|MTHCA_PUT
argument_list|(
name|inbox
argument_list|,
name|param
operator|->
name|si_guid
argument_list|,
name|INIT_IB_SI_GUID_OFFSET
argument_list|)
expr_stmt|;
name|err
operator|=
name|mthca_cmd
argument_list|(
name|dev
argument_list|,
name|mailbox
operator|->
name|dma
argument_list|,
name|port
argument_list|,
literal|0
argument_list|,
name|CMD_INIT_IB
argument_list|,
name|CMD_TIME_CLASS_A
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|mthca_free_mailbox
argument_list|(
name|dev
argument_list|,
name|mailbox
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|int
name|mthca_CLOSE_IB
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|,
name|int
name|port
parameter_list|,
name|u8
modifier|*
name|status
parameter_list|)
block|{
return|return
name|mthca_cmd
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|,
name|port
argument_list|,
literal|0
argument_list|,
name|CMD_CLOSE_IB
argument_list|,
name|CMD_TIME_CLASS_A
argument_list|,
name|status
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|mthca_CLOSE_HCA
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|,
name|int
name|panic
parameter_list|,
name|u8
modifier|*
name|status
parameter_list|)
block|{
return|return
name|mthca_cmd
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|panic
argument_list|,
name|CMD_CLOSE_HCA
argument_list|,
name|CMD_TIME_CLASS_C
argument_list|,
name|status
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|mthca_SET_IB
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mthca_set_ib_param
modifier|*
name|param
parameter_list|,
name|int
name|port
parameter_list|,
name|u8
modifier|*
name|status
parameter_list|)
block|{
name|struct
name|mthca_mailbox
modifier|*
name|mailbox
decl_stmt|;
name|u32
modifier|*
name|inbox
decl_stmt|;
name|int
name|err
decl_stmt|;
name|u32
name|flags
init|=
literal|0
decl_stmt|;
define|#
directive|define
name|SET_IB_IN_SIZE
value|0x40
define|#
directive|define
name|SET_IB_FLAGS_OFFSET
value|0x00
define|#
directive|define
name|SET_IB_FLAG_SIG
value|(1<< 18)
define|#
directive|define
name|SET_IB_FLAG_RQK
value|(1<<  0)
define|#
directive|define
name|SET_IB_CAP_MASK_OFFSET
value|0x04
define|#
directive|define
name|SET_IB_SI_GUID_OFFSET
value|0x08
name|mailbox
operator|=
name|mthca_alloc_mailbox
argument_list|(
name|dev
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|mailbox
argument_list|)
condition|)
return|return
name|PTR_ERR
argument_list|(
name|mailbox
argument_list|)
return|;
name|inbox
operator|=
name|mailbox
operator|->
name|buf
expr_stmt|;
name|memset
argument_list|(
name|inbox
argument_list|,
literal|0
argument_list|,
name|SET_IB_IN_SIZE
argument_list|)
expr_stmt|;
name|flags
operator||=
name|param
operator|->
name|set_si_guid
condition|?
name|SET_IB_FLAG_SIG
else|:
literal|0
expr_stmt|;
name|flags
operator||=
name|param
operator|->
name|reset_qkey_viol
condition|?
name|SET_IB_FLAG_RQK
else|:
literal|0
expr_stmt|;
name|MTHCA_PUT
argument_list|(
name|inbox
argument_list|,
name|flags
argument_list|,
name|SET_IB_FLAGS_OFFSET
argument_list|)
expr_stmt|;
name|MTHCA_PUT
argument_list|(
name|inbox
argument_list|,
name|param
operator|->
name|cap_mask
argument_list|,
name|SET_IB_CAP_MASK_OFFSET
argument_list|)
expr_stmt|;
name|MTHCA_PUT
argument_list|(
name|inbox
argument_list|,
name|param
operator|->
name|si_guid
argument_list|,
name|SET_IB_SI_GUID_OFFSET
argument_list|)
expr_stmt|;
name|err
operator|=
name|mthca_cmd
argument_list|(
name|dev
argument_list|,
name|mailbox
operator|->
name|dma
argument_list|,
name|port
argument_list|,
literal|0
argument_list|,
name|CMD_SET_IB
argument_list|,
name|CMD_TIME_CLASS_B
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|mthca_free_mailbox
argument_list|(
name|dev
argument_list|,
name|mailbox
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|int
name|mthca_MAP_ICM
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mthca_icm
modifier|*
name|icm
parameter_list|,
name|u64
name|virt
parameter_list|,
name|u8
modifier|*
name|status
parameter_list|)
block|{
return|return
name|mthca_map_cmd
argument_list|(
name|dev
argument_list|,
name|CMD_MAP_ICM
argument_list|,
name|icm
argument_list|,
name|virt
argument_list|,
name|status
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|mthca_MAP_ICM_page
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|,
name|u64
name|dma_addr
parameter_list|,
name|u64
name|virt
parameter_list|,
name|u8
modifier|*
name|status
parameter_list|)
block|{
name|struct
name|mthca_mailbox
modifier|*
name|mailbox
decl_stmt|;
name|__be64
modifier|*
name|inbox
decl_stmt|;
name|int
name|err
decl_stmt|;
name|mailbox
operator|=
name|mthca_alloc_mailbox
argument_list|(
name|dev
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|mailbox
argument_list|)
condition|)
return|return
name|PTR_ERR
argument_list|(
name|mailbox
argument_list|)
return|;
name|inbox
operator|=
name|mailbox
operator|->
name|buf
expr_stmt|;
name|inbox
index|[
literal|0
index|]
operator|=
name|cpu_to_be64
argument_list|(
name|virt
argument_list|)
expr_stmt|;
name|inbox
index|[
literal|1
index|]
operator|=
name|cpu_to_be64
argument_list|(
name|dma_addr
argument_list|)
expr_stmt|;
name|err
operator|=
name|mthca_cmd
argument_list|(
name|dev
argument_list|,
name|mailbox
operator|->
name|dma
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
name|CMD_MAP_ICM
argument_list|,
name|CMD_TIME_CLASS_B
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|mthca_free_mailbox
argument_list|(
name|dev
argument_list|,
name|mailbox
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|err
condition|)
name|mthca_dbg
argument_list|(
name|dev
argument_list|,
literal|"Mapped page at %llx to %llx for ICM.\n"
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|dma_addr
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|virt
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|int
name|mthca_UNMAP_ICM
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|,
name|u64
name|virt
parameter_list|,
name|u32
name|page_count
parameter_list|,
name|u8
modifier|*
name|status
parameter_list|)
block|{
name|mthca_dbg
argument_list|(
name|dev
argument_list|,
literal|"Unmapping %d pages at %llx from ICM.\n"
argument_list|,
name|page_count
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|virt
argument_list|)
expr_stmt|;
return|return
name|mthca_cmd
argument_list|(
name|dev
argument_list|,
name|virt
argument_list|,
name|page_count
argument_list|,
literal|0
argument_list|,
name|CMD_UNMAP_ICM
argument_list|,
name|CMD_TIME_CLASS_B
argument_list|,
name|status
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|mthca_MAP_ICM_AUX
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mthca_icm
modifier|*
name|icm
parameter_list|,
name|u8
modifier|*
name|status
parameter_list|)
block|{
return|return
name|mthca_map_cmd
argument_list|(
name|dev
argument_list|,
name|CMD_MAP_ICM_AUX
argument_list|,
name|icm
argument_list|,
operator|-
literal|1
argument_list|,
name|status
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|mthca_UNMAP_ICM_AUX
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|,
name|u8
modifier|*
name|status
parameter_list|)
block|{
return|return
name|mthca_cmd
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|CMD_UNMAP_ICM_AUX
argument_list|,
name|CMD_TIME_CLASS_B
argument_list|,
name|status
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|mthca_SET_ICM_SIZE
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|,
name|u64
name|icm_size
parameter_list|,
name|u64
modifier|*
name|aux_pages
parameter_list|,
name|u8
modifier|*
name|status
parameter_list|)
block|{
name|int
name|ret
init|=
name|mthca_cmd_imm
argument_list|(
name|dev
argument_list|,
name|icm_size
argument_list|,
name|aux_pages
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|CMD_SET_ICM_SIZE
argument_list|,
name|CMD_TIME_CLASS_A
argument_list|,
name|status
argument_list|)
decl_stmt|;
if|if
condition|(
name|ret
operator|||
name|status
condition|)
return|return
name|ret
return|;
comment|/* 	 * Round up number of system pages needed in case 	 * MTHCA_ICM_PAGE_SIZE< PAGE_SIZE. 	 */
operator|*
name|aux_pages
operator|=
name|ALIGN
argument_list|(
operator|*
name|aux_pages
argument_list|,
name|PAGE_SIZE
operator|/
name|MTHCA_ICM_PAGE_SIZE
argument_list|)
operator|>>
operator|(
name|PAGE_SHIFT
operator|-
name|MTHCA_ICM_PAGE_SHIFT
operator|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|mthca_SW2HW_MPT
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mthca_mailbox
modifier|*
name|mailbox
parameter_list|,
name|int
name|mpt_index
parameter_list|,
name|u8
modifier|*
name|status
parameter_list|)
block|{
return|return
name|mthca_cmd
argument_list|(
name|dev
argument_list|,
name|mailbox
operator|->
name|dma
argument_list|,
name|mpt_index
argument_list|,
literal|0
argument_list|,
name|CMD_SW2HW_MPT
argument_list|,
name|CMD_TIME_CLASS_B
argument_list|,
name|status
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|mthca_HW2SW_MPT
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mthca_mailbox
modifier|*
name|mailbox
parameter_list|,
name|int
name|mpt_index
parameter_list|,
name|u8
modifier|*
name|status
parameter_list|)
block|{
return|return
name|mthca_cmd_box
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|,
name|mailbox
condition|?
name|mailbox
operator|->
name|dma
else|:
literal|0
argument_list|,
name|mpt_index
argument_list|,
operator|!
name|mailbox
argument_list|,
name|CMD_HW2SW_MPT
argument_list|,
name|CMD_TIME_CLASS_B
argument_list|,
name|status
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|mthca_WRITE_MTT
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mthca_mailbox
modifier|*
name|mailbox
parameter_list|,
name|int
name|num_mtt
parameter_list|,
name|u8
modifier|*
name|status
parameter_list|)
block|{
return|return
name|mthca_cmd
argument_list|(
name|dev
argument_list|,
name|mailbox
operator|->
name|dma
argument_list|,
name|num_mtt
argument_list|,
literal|0
argument_list|,
name|CMD_WRITE_MTT
argument_list|,
name|CMD_TIME_CLASS_B
argument_list|,
name|status
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|mthca_SYNC_TPT
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|,
name|u8
modifier|*
name|status
parameter_list|)
block|{
return|return
name|mthca_cmd
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|CMD_SYNC_TPT
argument_list|,
name|CMD_TIME_CLASS_B
argument_list|,
name|status
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|mthca_MAP_EQ
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|,
name|u64
name|event_mask
parameter_list|,
name|int
name|unmap
parameter_list|,
name|int
name|eq_num
parameter_list|,
name|u8
modifier|*
name|status
parameter_list|)
block|{
name|mthca_dbg
argument_list|(
name|dev
argument_list|,
literal|"%s mask %016llx for eqn %d\n"
argument_list|,
name|unmap
condition|?
literal|"Clearing"
else|:
literal|"Setting"
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|event_mask
argument_list|,
name|eq_num
argument_list|)
expr_stmt|;
return|return
name|mthca_cmd
argument_list|(
name|dev
argument_list|,
name|event_mask
argument_list|,
operator|(
name|unmap
operator|<<
literal|31
operator|)
operator||
name|eq_num
argument_list|,
literal|0
argument_list|,
name|CMD_MAP_EQ
argument_list|,
name|CMD_TIME_CLASS_B
argument_list|,
name|status
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|mthca_SW2HW_EQ
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mthca_mailbox
modifier|*
name|mailbox
parameter_list|,
name|int
name|eq_num
parameter_list|,
name|u8
modifier|*
name|status
parameter_list|)
block|{
return|return
name|mthca_cmd
argument_list|(
name|dev
argument_list|,
name|mailbox
operator|->
name|dma
argument_list|,
name|eq_num
argument_list|,
literal|0
argument_list|,
name|CMD_SW2HW_EQ
argument_list|,
name|CMD_TIME_CLASS_A
argument_list|,
name|status
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|mthca_HW2SW_EQ
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mthca_mailbox
modifier|*
name|mailbox
parameter_list|,
name|int
name|eq_num
parameter_list|,
name|u8
modifier|*
name|status
parameter_list|)
block|{
return|return
name|mthca_cmd_box
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|,
name|mailbox
operator|->
name|dma
argument_list|,
name|eq_num
argument_list|,
literal|0
argument_list|,
name|CMD_HW2SW_EQ
argument_list|,
name|CMD_TIME_CLASS_A
argument_list|,
name|status
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|mthca_SW2HW_CQ
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mthca_mailbox
modifier|*
name|mailbox
parameter_list|,
name|int
name|cq_num
parameter_list|,
name|u8
modifier|*
name|status
parameter_list|)
block|{
return|return
name|mthca_cmd
argument_list|(
name|dev
argument_list|,
name|mailbox
operator|->
name|dma
argument_list|,
name|cq_num
argument_list|,
literal|0
argument_list|,
name|CMD_SW2HW_CQ
argument_list|,
name|CMD_TIME_CLASS_A
argument_list|,
name|status
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|mthca_HW2SW_CQ
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mthca_mailbox
modifier|*
name|mailbox
parameter_list|,
name|int
name|cq_num
parameter_list|,
name|u8
modifier|*
name|status
parameter_list|)
block|{
return|return
name|mthca_cmd_box
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|,
name|mailbox
operator|->
name|dma
argument_list|,
name|cq_num
argument_list|,
literal|0
argument_list|,
name|CMD_HW2SW_CQ
argument_list|,
name|CMD_TIME_CLASS_A
argument_list|,
name|status
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|mthca_RESIZE_CQ
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|,
name|int
name|cq_num
parameter_list|,
name|u32
name|lkey
parameter_list|,
name|u8
name|log_size
parameter_list|,
name|u8
modifier|*
name|status
parameter_list|)
block|{
name|struct
name|mthca_mailbox
modifier|*
name|mailbox
decl_stmt|;
name|__be32
modifier|*
name|inbox
decl_stmt|;
name|int
name|err
decl_stmt|;
define|#
directive|define
name|RESIZE_CQ_IN_SIZE
value|0x40
define|#
directive|define
name|RESIZE_CQ_LOG_SIZE_OFFSET
value|0x0c
define|#
directive|define
name|RESIZE_CQ_LKEY_OFFSET
value|0x1c
name|mailbox
operator|=
name|mthca_alloc_mailbox
argument_list|(
name|dev
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|mailbox
argument_list|)
condition|)
return|return
name|PTR_ERR
argument_list|(
name|mailbox
argument_list|)
return|;
name|inbox
operator|=
name|mailbox
operator|->
name|buf
expr_stmt|;
name|memset
argument_list|(
name|inbox
argument_list|,
literal|0
argument_list|,
name|RESIZE_CQ_IN_SIZE
argument_list|)
expr_stmt|;
comment|/* 	 * Leave start address fields zeroed out -- mthca assumes that 	 * MRs for CQs always start at virtual address 0. 	 */
name|MTHCA_PUT
argument_list|(
name|inbox
argument_list|,
name|log_size
argument_list|,
name|RESIZE_CQ_LOG_SIZE_OFFSET
argument_list|)
expr_stmt|;
name|MTHCA_PUT
argument_list|(
name|inbox
argument_list|,
name|lkey
argument_list|,
name|RESIZE_CQ_LKEY_OFFSET
argument_list|)
expr_stmt|;
name|err
operator|=
name|mthca_cmd
argument_list|(
name|dev
argument_list|,
name|mailbox
operator|->
name|dma
argument_list|,
name|cq_num
argument_list|,
literal|1
argument_list|,
name|CMD_RESIZE_CQ
argument_list|,
name|CMD_TIME_CLASS_B
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|mthca_free_mailbox
argument_list|(
name|dev
argument_list|,
name|mailbox
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|int
name|mthca_SW2HW_SRQ
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mthca_mailbox
modifier|*
name|mailbox
parameter_list|,
name|int
name|srq_num
parameter_list|,
name|u8
modifier|*
name|status
parameter_list|)
block|{
return|return
name|mthca_cmd
argument_list|(
name|dev
argument_list|,
name|mailbox
operator|->
name|dma
argument_list|,
name|srq_num
argument_list|,
literal|0
argument_list|,
name|CMD_SW2HW_SRQ
argument_list|,
name|CMD_TIME_CLASS_A
argument_list|,
name|status
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|mthca_HW2SW_SRQ
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mthca_mailbox
modifier|*
name|mailbox
parameter_list|,
name|int
name|srq_num
parameter_list|,
name|u8
modifier|*
name|status
parameter_list|)
block|{
return|return
name|mthca_cmd_box
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|,
name|mailbox
operator|->
name|dma
argument_list|,
name|srq_num
argument_list|,
literal|0
argument_list|,
name|CMD_HW2SW_SRQ
argument_list|,
name|CMD_TIME_CLASS_A
argument_list|,
name|status
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|mthca_QUERY_SRQ
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|,
name|u32
name|num
parameter_list|,
name|struct
name|mthca_mailbox
modifier|*
name|mailbox
parameter_list|,
name|u8
modifier|*
name|status
parameter_list|)
block|{
return|return
name|mthca_cmd_box
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|,
name|mailbox
operator|->
name|dma
argument_list|,
name|num
argument_list|,
literal|0
argument_list|,
name|CMD_QUERY_SRQ
argument_list|,
name|CMD_TIME_CLASS_A
argument_list|,
name|status
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|mthca_ARM_SRQ
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|,
name|int
name|srq_num
parameter_list|,
name|int
name|limit
parameter_list|,
name|u8
modifier|*
name|status
parameter_list|)
block|{
return|return
name|mthca_cmd
argument_list|(
name|dev
argument_list|,
name|limit
argument_list|,
name|srq_num
argument_list|,
literal|0
argument_list|,
name|CMD_ARM_SRQ
argument_list|,
name|CMD_TIME_CLASS_B
argument_list|,
name|status
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|mthca_MODIFY_QP
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|,
name|enum
name|ib_qp_state
name|cur
parameter_list|,
name|enum
name|ib_qp_state
name|next
parameter_list|,
name|u32
name|num
parameter_list|,
name|int
name|is_ee
parameter_list|,
name|struct
name|mthca_mailbox
modifier|*
name|mailbox
parameter_list|,
name|u32
name|optmask
parameter_list|,
name|u8
modifier|*
name|status
parameter_list|)
block|{
specifier|static
specifier|const
name|u16
name|op
index|[
name|IB_QPS_ERR
operator|+
literal|1
index|]
index|[
name|IB_QPS_ERR
operator|+
literal|1
index|]
init|=
block|{
index|[
name|IB_QPS_RESET
index|]
operator|=
block|{
index|[
name|IB_QPS_RESET
index|]
operator|=
name|CMD_ERR2RST_QPEE
block|,
index|[
name|IB_QPS_ERR
index|]
operator|=
name|CMD_2ERR_QPEE
block|,
index|[
name|IB_QPS_INIT
index|]
operator|=
name|CMD_RST2INIT_QPEE
block|, 		}
block|,
index|[
name|IB_QPS_INIT
index|]
operator|=
block|{
index|[
name|IB_QPS_RESET
index|]
operator|=
name|CMD_ERR2RST_QPEE
block|,
index|[
name|IB_QPS_ERR
index|]
operator|=
name|CMD_2ERR_QPEE
block|,
index|[
name|IB_QPS_INIT
index|]
operator|=
name|CMD_INIT2INIT_QPEE
block|,
index|[
name|IB_QPS_RTR
index|]
operator|=
name|CMD_INIT2RTR_QPEE
block|, 		}
block|,
index|[
name|IB_QPS_RTR
index|]
operator|=
block|{
index|[
name|IB_QPS_RESET
index|]
operator|=
name|CMD_ERR2RST_QPEE
block|,
index|[
name|IB_QPS_ERR
index|]
operator|=
name|CMD_2ERR_QPEE
block|,
index|[
name|IB_QPS_RTS
index|]
operator|=
name|CMD_RTR2RTS_QPEE
block|, 		}
block|,
index|[
name|IB_QPS_RTS
index|]
operator|=
block|{
index|[
name|IB_QPS_RESET
index|]
operator|=
name|CMD_ERR2RST_QPEE
block|,
index|[
name|IB_QPS_ERR
index|]
operator|=
name|CMD_2ERR_QPEE
block|,
index|[
name|IB_QPS_RTS
index|]
operator|=
name|CMD_RTS2RTS_QPEE
block|,
index|[
name|IB_QPS_SQD
index|]
operator|=
name|CMD_RTS2SQD_QPEE
block|, 		}
block|,
index|[
name|IB_QPS_SQD
index|]
operator|=
block|{
index|[
name|IB_QPS_RESET
index|]
operator|=
name|CMD_ERR2RST_QPEE
block|,
index|[
name|IB_QPS_ERR
index|]
operator|=
name|CMD_2ERR_QPEE
block|,
index|[
name|IB_QPS_RTS
index|]
operator|=
name|CMD_SQD2RTS_QPEE
block|,
index|[
name|IB_QPS_SQD
index|]
operator|=
name|CMD_SQD2SQD_QPEE
block|, 		}
block|,
index|[
name|IB_QPS_SQE
index|]
operator|=
block|{
index|[
name|IB_QPS_RESET
index|]
operator|=
name|CMD_ERR2RST_QPEE
block|,
index|[
name|IB_QPS_ERR
index|]
operator|=
name|CMD_2ERR_QPEE
block|,
index|[
name|IB_QPS_RTS
index|]
operator|=
name|CMD_SQERR2RTS_QPEE
block|, 		}
block|,
index|[
name|IB_QPS_ERR
index|]
operator|=
block|{
index|[
name|IB_QPS_RESET
index|]
operator|=
name|CMD_ERR2RST_QPEE
block|,
index|[
name|IB_QPS_ERR
index|]
operator|=
name|CMD_2ERR_QPEE
block|, 		}
block|}
decl_stmt|;
name|u8
name|op_mod
init|=
literal|0
decl_stmt|;
name|int
name|my_mailbox
init|=
literal|0
decl_stmt|;
name|int
name|err
decl_stmt|;
if|if
condition|(
name|op
index|[
name|cur
index|]
index|[
name|next
index|]
operator|==
name|CMD_ERR2RST_QPEE
condition|)
block|{
name|op_mod
operator|=
literal|3
expr_stmt|;
comment|/* don't write outbox, any->reset */
comment|/* For debugging */
if|if
condition|(
operator|!
name|mailbox
condition|)
block|{
name|mailbox
operator|=
name|mthca_alloc_mailbox
argument_list|(
name|dev
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|IS_ERR
argument_list|(
name|mailbox
argument_list|)
condition|)
block|{
name|my_mailbox
operator|=
literal|1
expr_stmt|;
name|op_mod
operator|=
literal|2
expr_stmt|;
comment|/* write outbox, any->reset */
block|}
else|else
name|mailbox
operator|=
name|NULL
expr_stmt|;
block|}
name|err
operator|=
name|mthca_cmd_box
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|,
name|mailbox
condition|?
name|mailbox
operator|->
name|dma
else|:
literal|0
argument_list|,
operator|(
operator|!
operator|!
name|is_ee
operator|<<
literal|24
operator|)
operator||
name|num
argument_list|,
name|op_mod
argument_list|,
name|op
index|[
name|cur
index|]
index|[
name|next
index|]
argument_list|,
name|CMD_TIME_CLASS_C
argument_list|,
name|status
argument_list|)
expr_stmt|;
if|if
condition|(
literal|0
operator|&&
name|mailbox
condition|)
block|{
name|int
name|i
decl_stmt|;
name|mthca_dbg
argument_list|(
name|dev
argument_list|,
literal|"Dumping QP context:\n"
argument_list|)
expr_stmt|;
name|printk
argument_list|(
literal|" %08x\n"
argument_list|,
name|be32_to_cpup
argument_list|(
name|mailbox
operator|->
name|buf
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|0x100
operator|/
literal|4
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|i
operator|%
literal|8
operator|==
literal|0
condition|)
name|printk
argument_list|(
literal|"[%02x] "
argument_list|,
name|i
operator|*
literal|4
argument_list|)
expr_stmt|;
name|printk
argument_list|(
literal|" %08x"
argument_list|,
name|be32_to_cpu
argument_list|(
operator|(
operator|(
name|__be32
operator|*
operator|)
name|mailbox
operator|->
name|buf
operator|)
index|[
name|i
operator|+
literal|2
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|+
literal|1
operator|)
operator|%
literal|8
operator|==
literal|0
condition|)
name|printk
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|my_mailbox
condition|)
name|mthca_free_mailbox
argument_list|(
name|dev
argument_list|,
name|mailbox
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
literal|0
condition|)
block|{
name|int
name|i
decl_stmt|;
name|mthca_dbg
argument_list|(
name|dev
argument_list|,
literal|"Dumping QP context:\n"
argument_list|)
expr_stmt|;
name|printk
argument_list|(
literal|"  opt param mask: %08x\n"
argument_list|,
name|be32_to_cpup
argument_list|(
name|mailbox
operator|->
name|buf
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|0x100
operator|/
literal|4
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|i
operator|%
literal|8
operator|==
literal|0
condition|)
name|printk
argument_list|(
literal|"  [%02x] "
argument_list|,
name|i
operator|*
literal|4
argument_list|)
expr_stmt|;
name|printk
argument_list|(
literal|" %08x"
argument_list|,
name|be32_to_cpu
argument_list|(
operator|(
operator|(
name|__be32
operator|*
operator|)
name|mailbox
operator|->
name|buf
operator|)
index|[
name|i
operator|+
literal|2
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|+
literal|1
operator|)
operator|%
literal|8
operator|==
literal|0
condition|)
name|printk
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
name|err
operator|=
name|mthca_cmd
argument_list|(
name|dev
argument_list|,
name|mailbox
operator|->
name|dma
argument_list|,
name|optmask
operator||
operator|(
operator|!
operator|!
name|is_ee
operator|<<
literal|24
operator|)
operator||
name|num
argument_list|,
name|op_mod
argument_list|,
name|op
index|[
name|cur
index|]
index|[
name|next
index|]
argument_list|,
name|CMD_TIME_CLASS_C
argument_list|,
name|status
argument_list|)
expr_stmt|;
block|}
return|return
name|err
return|;
block|}
end_function

begin_function
name|int
name|mthca_QUERY_QP
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|,
name|u32
name|num
parameter_list|,
name|int
name|is_ee
parameter_list|,
name|struct
name|mthca_mailbox
modifier|*
name|mailbox
parameter_list|,
name|u8
modifier|*
name|status
parameter_list|)
block|{
return|return
name|mthca_cmd_box
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|,
name|mailbox
operator|->
name|dma
argument_list|,
operator|(
operator|!
operator|!
name|is_ee
operator|<<
literal|24
operator|)
operator||
name|num
argument_list|,
literal|0
argument_list|,
name|CMD_QUERY_QPEE
argument_list|,
name|CMD_TIME_CLASS_A
argument_list|,
name|status
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|mthca_CONF_SPECIAL_QP
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|,
name|int
name|type
parameter_list|,
name|u32
name|qpn
parameter_list|,
name|u8
modifier|*
name|status
parameter_list|)
block|{
name|u8
name|op_mod
decl_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|IB_QPT_SMI
case|:
name|op_mod
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|IB_QPT_GSI
case|:
name|op_mod
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|IB_QPT_RAW_IPV6
case|:
name|op_mod
operator|=
literal|2
expr_stmt|;
break|break;
case|case
name|IB_QPT_RAW_ETHERTYPE
case|:
name|op_mod
operator|=
literal|3
expr_stmt|;
break|break;
default|default:
return|return
operator|-
name|EINVAL
return|;
block|}
return|return
name|mthca_cmd
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|,
name|qpn
argument_list|,
name|op_mod
argument_list|,
name|CMD_CONF_SPECIAL_QP
argument_list|,
name|CMD_TIME_CLASS_B
argument_list|,
name|status
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|mthca_MAD_IFC
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|,
name|int
name|ignore_mkey
parameter_list|,
name|int
name|ignore_bkey
parameter_list|,
name|int
name|port
parameter_list|,
name|struct
name|ib_wc
modifier|*
name|in_wc
parameter_list|,
name|struct
name|ib_grh
modifier|*
name|in_grh
parameter_list|,
name|void
modifier|*
name|in_mad
parameter_list|,
name|void
modifier|*
name|response_mad
parameter_list|,
name|u8
modifier|*
name|status
parameter_list|)
block|{
name|struct
name|mthca_mailbox
modifier|*
name|inmailbox
decl_stmt|,
modifier|*
name|outmailbox
decl_stmt|;
name|void
modifier|*
name|inbox
decl_stmt|;
name|int
name|err
decl_stmt|;
name|u32
name|in_modifier
init|=
name|port
decl_stmt|;
name|u8
name|op_modifier
init|=
literal|0
decl_stmt|;
define|#
directive|define
name|MAD_IFC_BOX_SIZE
value|0x400
define|#
directive|define
name|MAD_IFC_MY_QPN_OFFSET
value|0x100
define|#
directive|define
name|MAD_IFC_RQPN_OFFSET
value|0x108
define|#
directive|define
name|MAD_IFC_SL_OFFSET
value|0x10c
define|#
directive|define
name|MAD_IFC_G_PATH_OFFSET
value|0x10d
define|#
directive|define
name|MAD_IFC_RLID_OFFSET
value|0x10e
define|#
directive|define
name|MAD_IFC_PKEY_OFFSET
value|0x112
define|#
directive|define
name|MAD_IFC_GRH_OFFSET
value|0x140
name|inmailbox
operator|=
name|mthca_alloc_mailbox
argument_list|(
name|dev
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|inmailbox
argument_list|)
condition|)
return|return
name|PTR_ERR
argument_list|(
name|inmailbox
argument_list|)
return|;
name|inbox
operator|=
name|inmailbox
operator|->
name|buf
expr_stmt|;
name|outmailbox
operator|=
name|mthca_alloc_mailbox
argument_list|(
name|dev
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|outmailbox
argument_list|)
condition|)
block|{
name|mthca_free_mailbox
argument_list|(
name|dev
argument_list|,
name|inmailbox
argument_list|)
expr_stmt|;
return|return
name|PTR_ERR
argument_list|(
name|outmailbox
argument_list|)
return|;
block|}
name|memcpy
argument_list|(
name|inbox
argument_list|,
name|in_mad
argument_list|,
literal|256
argument_list|)
expr_stmt|;
comment|/* 	 * Key check traps can't be generated unless we have in_wc to 	 * tell us where to send the trap. 	 */
if|if
condition|(
name|ignore_mkey
operator|||
operator|!
name|in_wc
condition|)
name|op_modifier
operator||=
literal|0x1
expr_stmt|;
if|if
condition|(
name|ignore_bkey
operator|||
operator|!
name|in_wc
condition|)
name|op_modifier
operator||=
literal|0x2
expr_stmt|;
if|if
condition|(
name|in_wc
condition|)
block|{
name|u8
name|val
decl_stmt|;
name|memset
argument_list|(
name|inbox
operator|+
literal|256
argument_list|,
literal|0
argument_list|,
literal|256
argument_list|)
expr_stmt|;
name|MTHCA_PUT
argument_list|(
name|inbox
argument_list|,
name|in_wc
operator|->
name|qp
operator|->
name|qp_num
argument_list|,
name|MAD_IFC_MY_QPN_OFFSET
argument_list|)
expr_stmt|;
name|MTHCA_PUT
argument_list|(
name|inbox
argument_list|,
name|in_wc
operator|->
name|src_qp
argument_list|,
name|MAD_IFC_RQPN_OFFSET
argument_list|)
expr_stmt|;
name|val
operator|=
name|in_wc
operator|->
name|sl
operator|<<
literal|4
expr_stmt|;
name|MTHCA_PUT
argument_list|(
name|inbox
argument_list|,
name|val
argument_list|,
name|MAD_IFC_SL_OFFSET
argument_list|)
expr_stmt|;
name|val
operator|=
name|in_wc
operator|->
name|dlid_path_bits
operator||
operator|(
name|in_wc
operator|->
name|wc_flags
operator|&
name|IB_WC_GRH
condition|?
literal|0x80
else|:
literal|0
operator|)
expr_stmt|;
name|MTHCA_PUT
argument_list|(
name|inbox
argument_list|,
name|val
argument_list|,
name|MAD_IFC_G_PATH_OFFSET
argument_list|)
expr_stmt|;
name|MTHCA_PUT
argument_list|(
name|inbox
argument_list|,
name|in_wc
operator|->
name|slid
argument_list|,
name|MAD_IFC_RLID_OFFSET
argument_list|)
expr_stmt|;
name|MTHCA_PUT
argument_list|(
name|inbox
argument_list|,
name|in_wc
operator|->
name|pkey_index
argument_list|,
name|MAD_IFC_PKEY_OFFSET
argument_list|)
expr_stmt|;
if|if
condition|(
name|in_grh
condition|)
name|memcpy
argument_list|(
name|inbox
operator|+
name|MAD_IFC_GRH_OFFSET
argument_list|,
name|in_grh
argument_list|,
literal|40
argument_list|)
expr_stmt|;
name|op_modifier
operator||=
literal|0x4
expr_stmt|;
name|in_modifier
operator||=
name|in_wc
operator|->
name|slid
operator|<<
literal|16
expr_stmt|;
block|}
name|err
operator|=
name|mthca_cmd_box
argument_list|(
name|dev
argument_list|,
name|inmailbox
operator|->
name|dma
argument_list|,
name|outmailbox
operator|->
name|dma
argument_list|,
name|in_modifier
argument_list|,
name|op_modifier
argument_list|,
name|CMD_MAD_IFC
argument_list|,
name|CMD_TIME_CLASS_C
argument_list|,
name|status
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|err
operator|&&
operator|!
operator|*
name|status
condition|)
name|memcpy
argument_list|(
name|response_mad
argument_list|,
name|outmailbox
operator|->
name|buf
argument_list|,
literal|256
argument_list|)
expr_stmt|;
name|mthca_free_mailbox
argument_list|(
name|dev
argument_list|,
name|inmailbox
argument_list|)
expr_stmt|;
name|mthca_free_mailbox
argument_list|(
name|dev
argument_list|,
name|outmailbox
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|int
name|mthca_READ_MGM
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|,
name|int
name|index
parameter_list|,
name|struct
name|mthca_mailbox
modifier|*
name|mailbox
parameter_list|,
name|u8
modifier|*
name|status
parameter_list|)
block|{
return|return
name|mthca_cmd_box
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|,
name|mailbox
operator|->
name|dma
argument_list|,
name|index
argument_list|,
literal|0
argument_list|,
name|CMD_READ_MGM
argument_list|,
name|CMD_TIME_CLASS_A
argument_list|,
name|status
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|mthca_WRITE_MGM
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|,
name|int
name|index
parameter_list|,
name|struct
name|mthca_mailbox
modifier|*
name|mailbox
parameter_list|,
name|u8
modifier|*
name|status
parameter_list|)
block|{
return|return
name|mthca_cmd
argument_list|(
name|dev
argument_list|,
name|mailbox
operator|->
name|dma
argument_list|,
name|index
argument_list|,
literal|0
argument_list|,
name|CMD_WRITE_MGM
argument_list|,
name|CMD_TIME_CLASS_A
argument_list|,
name|status
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|mthca_MGID_HASH
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mthca_mailbox
modifier|*
name|mailbox
parameter_list|,
name|u16
modifier|*
name|hash
parameter_list|,
name|u8
modifier|*
name|status
parameter_list|)
block|{
name|u64
name|imm
decl_stmt|;
name|int
name|err
decl_stmt|;
name|err
operator|=
name|mthca_cmd_imm
argument_list|(
name|dev
argument_list|,
name|mailbox
operator|->
name|dma
argument_list|,
operator|&
name|imm
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|CMD_MGID_HASH
argument_list|,
name|CMD_TIME_CLASS_A
argument_list|,
name|status
argument_list|)
expr_stmt|;
operator|*
name|hash
operator|=
name|imm
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|int
name|mthca_NOP
parameter_list|(
name|struct
name|mthca_dev
modifier|*
name|dev
parameter_list|,
name|u8
modifier|*
name|status
parameter_list|)
block|{
return|return
name|mthca_cmd
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|,
literal|0x1f
argument_list|,
literal|0
argument_list|,
name|CMD_NOP
argument_list|,
name|msecs_to_jiffies
argument_list|(
literal|100
argument_list|)
argument_list|,
name|status
argument_list|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2009 Mellanox Technologies Ltd.  All rights reserved.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  */
end_comment

begin_include
include|#
directive|include
file|"sdp.h"
end_include

begin_expr_stmt
name|SDP_MODPARAM_INT
argument_list|(
name|rcvbuf_initial_size
argument_list|,
literal|32
operator|*
literal|1024
argument_list|,
literal|"Receive buffer initial size in bytes."
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|SDP_MODPARAM_SINT
argument_list|(
name|rcvbuf_scale
argument_list|,
literal|0x8
argument_list|,
literal|"Receive buffer size scale factor."
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* Like tcp_fin - called when SDP_MID_DISCONNECT is received */
end_comment

begin_function
specifier|static
name|void
name|sdp_handle_disconn
parameter_list|(
name|struct
name|sdp_sock
modifier|*
name|ssk
parameter_list|)
block|{
name|sdp_dbg
argument_list|(
name|ssk
operator|->
name|socket
argument_list|,
literal|"%s\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|SDP_WLOCK_ASSERT
argument_list|(
name|ssk
argument_list|)
expr_stmt|;
if|if
condition|(
name|TCPS_HAVERCVDFIN
argument_list|(
name|ssk
operator|->
name|state
argument_list|)
operator|==
literal|0
condition|)
name|socantrcvmore
argument_list|(
name|ssk
operator|->
name|socket
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ssk
operator|->
name|state
condition|)
block|{
case|case
name|TCPS_SYN_RECEIVED
case|:
case|case
name|TCPS_ESTABLISHED
case|:
name|ssk
operator|->
name|state
operator|=
name|TCPS_CLOSE_WAIT
expr_stmt|;
break|break;
case|case
name|TCPS_FIN_WAIT_1
case|:
comment|/* Received a reply FIN - start Infiniband tear down */
name|sdp_dbg
argument_list|(
name|ssk
operator|->
name|socket
argument_list|,
literal|"%s: Starting Infiniband tear down sending DREQ\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|sdp_cancel_dreq_wait_timeout
argument_list|(
name|ssk
argument_list|)
expr_stmt|;
name|ssk
operator|->
name|qp_active
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ssk
operator|->
name|id
condition|)
block|{
name|struct
name|rdma_cm_id
modifier|*
name|id
decl_stmt|;
name|id
operator|=
name|ssk
operator|->
name|id
expr_stmt|;
name|SDP_WUNLOCK
argument_list|(
name|ssk
argument_list|)
expr_stmt|;
name|rdma_disconnect
argument_list|(
name|id
argument_list|)
expr_stmt|;
name|SDP_WLOCK
argument_list|(
name|ssk
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|sdp_warn
argument_list|(
name|ssk
operator|->
name|socket
argument_list|,
literal|"%s: ssk->id is NULL\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return;
block|}
break|break;
case|case
name|TCPS_TIME_WAIT
case|:
comment|/* This is a mutual close situation and we've got the DREQ from 		   the peer before the SDP_MID_DISCONNECT */
break|break;
case|case
name|TCPS_CLOSED
case|:
comment|/* FIN arrived after IB teardown started - do nothing */
name|sdp_dbg
argument_list|(
name|ssk
operator|->
name|socket
argument_list|,
literal|"%s: fin in state %s\n"
argument_list|,
name|__func__
argument_list|,
name|sdp_state_str
argument_list|(
name|ssk
operator|->
name|state
argument_list|)
argument_list|)
expr_stmt|;
return|return;
default|default:
name|sdp_warn
argument_list|(
name|ssk
operator|->
name|socket
argument_list|,
literal|"%s: FIN in unexpected state. state=%d\n"
argument_list|,
name|__func__
argument_list|,
name|ssk
operator|->
name|state
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|sdp_post_recv
parameter_list|(
name|struct
name|sdp_sock
modifier|*
name|ssk
parameter_list|)
block|{
name|struct
name|sdp_buf
modifier|*
name|rx_req
decl_stmt|;
name|int
name|i
decl_stmt|,
name|rc
decl_stmt|;
name|u64
name|addr
decl_stmt|;
name|struct
name|ib_device
modifier|*
name|dev
decl_stmt|;
name|struct
name|ib_recv_wr
name|rx_wr
init|=
block|{
name|NULL
block|}
decl_stmt|;
name|struct
name|ib_sge
name|ibsge
index|[
name|SDP_MAX_RECV_SGES
index|]
decl_stmt|;
name|struct
name|ib_sge
modifier|*
name|sge
init|=
name|ibsge
decl_stmt|;
name|struct
name|ib_recv_wr
modifier|*
name|bad_wr
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|mb
decl_stmt|,
modifier|*
name|m
decl_stmt|;
name|struct
name|sdp_bsdh
modifier|*
name|h
decl_stmt|;
name|int
name|id
init|=
name|ring_head
argument_list|(
name|ssk
operator|->
name|rx_ring
argument_list|)
decl_stmt|;
comment|/* Now, allocate and repost recv */
name|sdp_prf
argument_list|(
name|ssk
operator|->
name|socket
argument_list|,
name|mb
argument_list|,
literal|"Posting mb"
argument_list|)
expr_stmt|;
name|mb
operator|=
name|m_getm2
argument_list|(
name|NULL
argument_list|,
name|ssk
operator|->
name|recv_bytes
argument_list|,
name|M_NOWAIT
argument_list|,
name|MT_DATA
argument_list|,
name|M_PKTHDR
argument_list|)
expr_stmt|;
if|if
condition|(
name|mb
operator|==
name|NULL
condition|)
block|{
comment|/* Retry so we can't stall out with no memory. */
if|if
condition|(
operator|!
name|rx_ring_posted
argument_list|(
name|ssk
argument_list|)
condition|)
name|queue_work
argument_list|(
name|rx_comp_wq
argument_list|,
operator|&
name|ssk
operator|->
name|rx_comp_work
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
for|for
control|(
name|m
operator|=
name|mb
init|;
name|m
operator|!=
name|NULL
condition|;
name|m
operator|=
name|m
operator|->
name|m_next
control|)
block|{
name|m
operator|->
name|m_len
operator|=
name|M_SIZE
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|mb
operator|->
name|m_pkthdr
operator|.
name|len
operator|+=
name|m
operator|->
name|m_len
expr_stmt|;
block|}
name|h
operator|=
name|mtod
argument_list|(
name|mb
argument_list|,
expr|struct
name|sdp_bsdh
operator|*
argument_list|)
expr_stmt|;
name|rx_req
operator|=
name|ssk
operator|->
name|rx_ring
operator|.
name|buffer
operator|+
operator|(
name|id
operator|&
operator|(
name|SDP_RX_SIZE
operator|-
literal|1
operator|)
operator|)
expr_stmt|;
name|rx_req
operator|->
name|mb
operator|=
name|mb
expr_stmt|;
name|dev
operator|=
name|ssk
operator|->
name|ib_device
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|mb
operator|!=
name|NULL
condition|;
name|i
operator|++
operator|,
name|mb
operator|=
name|mb
operator|->
name|m_next
operator|,
name|sge
operator|++
control|)
block|{
name|addr
operator|=
name|ib_dma_map_single
argument_list|(
name|dev
argument_list|,
name|mb
operator|->
name|m_data
argument_list|,
name|mb
operator|->
name|m_len
argument_list|,
name|DMA_TO_DEVICE
argument_list|)
expr_stmt|;
comment|/* TODO: proper error handling */
name|BUG_ON
argument_list|(
name|ib_dma_mapping_error
argument_list|(
name|dev
argument_list|,
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|BUG_ON
argument_list|(
name|i
operator|>=
name|SDP_MAX_RECV_SGES
argument_list|)
expr_stmt|;
name|rx_req
operator|->
name|mapping
index|[
name|i
index|]
operator|=
name|addr
expr_stmt|;
name|sge
operator|->
name|addr
operator|=
name|addr
expr_stmt|;
name|sge
operator|->
name|length
operator|=
name|mb
operator|->
name|m_len
expr_stmt|;
name|sge
operator|->
name|lkey
operator|=
name|ssk
operator|->
name|sdp_dev
operator|->
name|mr
operator|->
name|lkey
expr_stmt|;
block|}
name|rx_wr
operator|.
name|next
operator|=
name|NULL
expr_stmt|;
name|rx_wr
operator|.
name|wr_id
operator|=
name|id
operator||
name|SDP_OP_RECV
expr_stmt|;
name|rx_wr
operator|.
name|sg_list
operator|=
name|ibsge
expr_stmt|;
name|rx_wr
operator|.
name|num_sge
operator|=
name|i
expr_stmt|;
name|rc
operator|=
name|ib_post_recv
argument_list|(
name|ssk
operator|->
name|qp
argument_list|,
operator|&
name|rx_wr
argument_list|,
operator|&
name|bad_wr
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|rc
argument_list|)
condition|)
block|{
name|sdp_warn
argument_list|(
name|ssk
operator|->
name|socket
argument_list|,
literal|"ib_post_recv failed. status %d\n"
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|sdp_cleanup_sdp_buf
argument_list|(
name|ssk
argument_list|,
name|rx_req
argument_list|,
name|DMA_FROM_DEVICE
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|mb
argument_list|)
expr_stmt|;
name|sdp_notify
argument_list|(
name|ssk
argument_list|,
name|ECONNRESET
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|atomic_inc
argument_list|(
operator|&
name|ssk
operator|->
name|rx_ring
operator|.
name|head
argument_list|)
expr_stmt|;
name|SDPSTATS_COUNTER_INC
argument_list|(
name|post_recv
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|int
name|sdp_post_recvs_needed
parameter_list|(
name|struct
name|sdp_sock
modifier|*
name|ssk
parameter_list|)
block|{
name|unsigned
name|long
name|bytes_in_process
decl_stmt|;
name|unsigned
name|long
name|max_bytes
decl_stmt|;
name|int
name|buffer_size
decl_stmt|;
name|int
name|posted
decl_stmt|;
if|if
condition|(
operator|!
name|ssk
operator|->
name|qp_active
operator|||
operator|!
name|ssk
operator|->
name|socket
condition|)
return|return
literal|0
return|;
name|posted
operator|=
name|rx_ring_posted
argument_list|(
name|ssk
argument_list|)
expr_stmt|;
if|if
condition|(
name|posted
operator|>=
name|SDP_RX_SIZE
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|posted
operator|<
name|SDP_MIN_TX_CREDITS
condition|)
return|return
literal|1
return|;
name|buffer_size
operator|=
name|ssk
operator|->
name|recv_bytes
expr_stmt|;
name|max_bytes
operator|=
name|max
argument_list|(
name|ssk
operator|->
name|socket
operator|->
name|so_rcv
operator|.
name|sb_hiwat
argument_list|,
operator|(
literal|1
operator|+
name|SDP_MIN_TX_CREDITS
operator|)
operator|*
name|buffer_size
argument_list|)
expr_stmt|;
name|max_bytes
operator|*=
name|rcvbuf_scale
expr_stmt|;
comment|/* 	 * Compute bytes in the receive queue and socket buffer. 	 */
name|bytes_in_process
operator|=
operator|(
name|posted
operator|-
name|SDP_MIN_TX_CREDITS
operator|)
operator|*
name|buffer_size
expr_stmt|;
name|bytes_in_process
operator|+=
name|sbused
argument_list|(
operator|&
name|ssk
operator|->
name|socket
operator|->
name|so_rcv
argument_list|)
expr_stmt|;
return|return
name|bytes_in_process
operator|<
name|max_bytes
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|sdp_post_recvs
parameter_list|(
name|struct
name|sdp_sock
modifier|*
name|ssk
parameter_list|)
block|{
while|while
condition|(
name|sdp_post_recvs_needed
argument_list|(
name|ssk
argument_list|)
condition|)
if|if
condition|(
name|sdp_post_recv
argument_list|(
name|ssk
argument_list|)
condition|)
return|return;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|struct
name|mbuf
modifier|*
name|sdp_sock_queue_rcv_mb
parameter_list|(
name|struct
name|socket
modifier|*
name|sk
parameter_list|,
name|struct
name|mbuf
modifier|*
name|mb
parameter_list|)
block|{
name|struct
name|sdp_sock
modifier|*
name|ssk
init|=
name|sdp_sk
argument_list|(
name|sk
argument_list|)
decl_stmt|;
name|struct
name|sdp_bsdh
modifier|*
name|h
decl_stmt|;
name|h
operator|=
name|mtod
argument_list|(
name|mb
argument_list|,
expr|struct
name|sdp_bsdh
operator|*
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|SDP_ZCOPY
name|SDP_SKB_CB
argument_list|(
name|mb
argument_list|)
operator|->
name|seq
operator|=
name|rcv_nxt
argument_list|(
name|ssk
argument_list|)
expr_stmt|;
if|if
condition|(
name|h
operator|->
name|mid
operator|==
name|SDP_MID_SRCAVAIL
condition|)
block|{
name|struct
name|sdp_srcah
modifier|*
name|srcah
init|=
operator|(
expr|struct
name|sdp_srcah
operator|*
operator|)
operator|(
name|h
operator|+
literal|1
operator|)
decl_stmt|;
name|struct
name|rx_srcavail_state
modifier|*
name|rx_sa
decl_stmt|;
name|ssk
operator|->
name|srcavail_cancel_mseq
operator|=
literal|0
expr_stmt|;
name|ssk
operator|->
name|rx_sa
operator|=
name|rx_sa
operator|=
name|RX_SRCAVAIL_STATE
argument_list|(
name|mb
argument_list|)
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|rx_srcavail_state
argument_list|)
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
name|rx_sa
operator|->
name|mseq
operator|=
name|ntohl
argument_list|(
name|h
operator|->
name|mseq
argument_list|)
expr_stmt|;
name|rx_sa
operator|->
name|used
operator|=
literal|0
expr_stmt|;
name|rx_sa
operator|->
name|len
operator|=
name|mb_len
operator|=
name|ntohl
argument_list|(
name|srcah
operator|->
name|len
argument_list|)
expr_stmt|;
name|rx_sa
operator|->
name|rkey
operator|=
name|ntohl
argument_list|(
name|srcah
operator|->
name|rkey
argument_list|)
expr_stmt|;
name|rx_sa
operator|->
name|vaddr
operator|=
name|be64_to_cpu
argument_list|(
name|srcah
operator|->
name|vaddr
argument_list|)
expr_stmt|;
name|rx_sa
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ssk
operator|->
name|tx_sa
condition|)
block|{
name|sdp_dbg_data
argument_list|(
name|ssk
operator|->
name|socket
argument_list|,
literal|"got RX SrcAvail while waiting "
literal|"for TX SrcAvail. waking up TX SrcAvail"
literal|"to be aborted\n"
argument_list|)
expr_stmt|;
name|wake_up
argument_list|(
name|sk
operator|->
name|sk_sleep
argument_list|)
expr_stmt|;
block|}
name|atomic_add
argument_list|(
name|mb
operator|->
name|len
argument_list|,
operator|&
name|ssk
operator|->
name|rcv_nxt
argument_list|)
expr_stmt|;
name|sdp_dbg_data
argument_list|(
name|sk
argument_list|,
literal|"queueing SrcAvail. mb_len = %d vaddr = %lld\n"
argument_list|,
name|mb_len
argument_list|,
name|rx_sa
operator|->
name|vaddr
argument_list|)
expr_stmt|;
block|}
else|else
endif|#
directive|endif
block|{
name|atomic_add
argument_list|(
name|mb
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|,
operator|&
name|ssk
operator|->
name|rcv_nxt
argument_list|)
expr_stmt|;
block|}
name|m_adj
argument_list|(
name|mb
argument_list|,
name|SDP_HEAD_SIZE
argument_list|)
expr_stmt|;
name|SOCKBUF_LOCK
argument_list|(
operator|&
name|sk
operator|->
name|so_rcv
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|h
operator|->
name|flags
operator|&
name|SDP_OOB_PRES
argument_list|)
condition|)
name|sdp_urg
argument_list|(
name|ssk
argument_list|,
name|mb
argument_list|)
expr_stmt|;
name|sbappend_locked
argument_list|(
operator|&
name|sk
operator|->
name|so_rcv
argument_list|,
name|mb
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sorwakeup_locked
argument_list|(
name|sk
argument_list|)
expr_stmt|;
return|return
name|mb
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sdp_get_recv_bytes
parameter_list|(
name|struct
name|sdp_sock
modifier|*
name|ssk
parameter_list|,
name|u32
name|new_size
parameter_list|)
block|{
return|return
name|MIN
argument_list|(
name|new_size
argument_list|,
name|SDP_MAX_PACKET
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|sdp_init_buffers
parameter_list|(
name|struct
name|sdp_sock
modifier|*
name|ssk
parameter_list|,
name|u32
name|new_size
parameter_list|)
block|{
name|ssk
operator|->
name|recv_bytes
operator|=
name|sdp_get_recv_bytes
argument_list|(
name|ssk
argument_list|,
name|new_size
argument_list|)
expr_stmt|;
name|sdp_post_recvs
argument_list|(
name|ssk
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|sdp_resize_buffers
parameter_list|(
name|struct
name|sdp_sock
modifier|*
name|ssk
parameter_list|,
name|u32
name|new_size
parameter_list|)
block|{
name|u32
name|curr_size
init|=
name|ssk
operator|->
name|recv_bytes
decl_stmt|;
name|u32
name|max_size
init|=
name|SDP_MAX_PACKET
decl_stmt|;
if|if
condition|(
name|new_size
operator|>
name|curr_size
operator|&&
name|new_size
operator|<=
name|max_size
condition|)
block|{
name|ssk
operator|->
name|recv_bytes
operator|=
name|sdp_get_recv_bytes
argument_list|(
name|ssk
argument_list|,
name|new_size
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|sdp_handle_resize_request
parameter_list|(
name|struct
name|sdp_sock
modifier|*
name|ssk
parameter_list|,
name|struct
name|sdp_chrecvbuf
modifier|*
name|buf
parameter_list|)
block|{
if|if
condition|(
name|sdp_resize_buffers
argument_list|(
name|ssk
argument_list|,
name|ntohl
argument_list|(
name|buf
operator|->
name|size
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
name|ssk
operator|->
name|recv_request_head
operator|=
name|ring_head
argument_list|(
name|ssk
operator|->
name|rx_ring
argument_list|)
operator|+
literal|1
expr_stmt|;
else|else
name|ssk
operator|->
name|recv_request_head
operator|=
name|ring_tail
argument_list|(
name|ssk
operator|->
name|rx_ring
argument_list|)
expr_stmt|;
name|ssk
operator|->
name|recv_request
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|sdp_handle_resize_ack
parameter_list|(
name|struct
name|sdp_sock
modifier|*
name|ssk
parameter_list|,
name|struct
name|sdp_chrecvbuf
modifier|*
name|buf
parameter_list|)
block|{
name|u32
name|new_size
init|=
name|ntohl
argument_list|(
name|buf
operator|->
name|size
argument_list|)
decl_stmt|;
if|if
condition|(
name|new_size
operator|>
name|ssk
operator|->
name|xmit_size_goal
condition|)
name|ssk
operator|->
name|xmit_size_goal
operator|=
name|new_size
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|mbuf
modifier|*
name|sdp_recv_completion
parameter_list|(
name|struct
name|sdp_sock
modifier|*
name|ssk
parameter_list|,
name|int
name|id
parameter_list|)
block|{
name|struct
name|sdp_buf
modifier|*
name|rx_req
decl_stmt|;
name|struct
name|ib_device
modifier|*
name|dev
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|mb
decl_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|id
operator|!=
name|ring_tail
argument_list|(
name|ssk
operator|->
name|rx_ring
argument_list|)
argument_list|)
condition|)
block|{
name|printk
argument_list|(
name|KERN_WARNING
literal|"Bogus recv completion id %d tail %d\n"
argument_list|,
name|id
argument_list|,
name|ring_tail
argument_list|(
name|ssk
operator|->
name|rx_ring
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|dev
operator|=
name|ssk
operator|->
name|ib_device
expr_stmt|;
name|rx_req
operator|=
operator|&
name|ssk
operator|->
name|rx_ring
operator|.
name|buffer
index|[
name|id
operator|&
operator|(
name|SDP_RX_SIZE
operator|-
literal|1
operator|)
index|]
expr_stmt|;
name|mb
operator|=
name|rx_req
operator|->
name|mb
expr_stmt|;
name|sdp_cleanup_sdp_buf
argument_list|(
name|ssk
argument_list|,
name|rx_req
argument_list|,
name|DMA_FROM_DEVICE
argument_list|)
expr_stmt|;
name|atomic_inc
argument_list|(
operator|&
name|ssk
operator|->
name|rx_ring
operator|.
name|tail
argument_list|)
expr_stmt|;
name|atomic_dec
argument_list|(
operator|&
name|ssk
operator|->
name|remote_credits
argument_list|)
expr_stmt|;
return|return
name|mb
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|sdp_process_rx_ctl_mb
parameter_list|(
name|struct
name|sdp_sock
modifier|*
name|ssk
parameter_list|,
name|struct
name|mbuf
modifier|*
name|mb
parameter_list|)
block|{
name|struct
name|sdp_bsdh
modifier|*
name|h
decl_stmt|;
name|struct
name|socket
modifier|*
name|sk
decl_stmt|;
name|SDP_WLOCK_ASSERT
argument_list|(
name|ssk
argument_list|)
expr_stmt|;
name|sk
operator|=
name|ssk
operator|->
name|socket
expr_stmt|;
name|h
operator|=
name|mtod
argument_list|(
name|mb
argument_list|,
expr|struct
name|sdp_bsdh
operator|*
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|h
operator|->
name|mid
condition|)
block|{
case|case
name|SDP_MID_DATA
case|:
case|case
name|SDP_MID_SRCAVAIL
case|:
name|sdp_dbg
argument_list|(
name|sk
argument_list|,
literal|"DATA after socket rcv was shutdown\n"
argument_list|)
expr_stmt|;
comment|/* got data in RCV_SHUTDOWN */
if|if
condition|(
name|ssk
operator|->
name|state
operator|==
name|TCPS_FIN_WAIT_1
condition|)
block|{
name|sdp_dbg
argument_list|(
name|sk
argument_list|,
literal|"RX data when state = FIN_WAIT1\n"
argument_list|)
expr_stmt|;
name|sdp_notify
argument_list|(
name|ssk
argument_list|,
name|ECONNRESET
argument_list|)
expr_stmt|;
block|}
break|break;
ifdef|#
directive|ifdef
name|SDP_ZCOPY
case|case
name|SDP_MID_RDMARDCOMPL
case|:
break|break;
case|case
name|SDP_MID_SENDSM
case|:
name|sdp_handle_sendsm
argument_list|(
name|ssk
argument_list|,
name|ntohl
argument_list|(
name|h
operator|->
name|mseq_ack
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|SDP_MID_SRCAVAIL_CANCEL
case|:
name|sdp_dbg_data
argument_list|(
name|sk
argument_list|,
literal|"Handling SrcAvailCancel\n"
argument_list|)
expr_stmt|;
name|sdp_prf
argument_list|(
name|sk
argument_list|,
name|NULL
argument_list|,
literal|"Handling SrcAvailCancel"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssk
operator|->
name|rx_sa
condition|)
block|{
name|ssk
operator|->
name|srcavail_cancel_mseq
operator|=
name|ntohl
argument_list|(
name|h
operator|->
name|mseq
argument_list|)
expr_stmt|;
name|ssk
operator|->
name|rx_sa
operator|->
name|flags
operator||=
name|RX_SA_ABORTED
expr_stmt|;
name|ssk
operator|->
name|rx_sa
operator|=
name|NULL
expr_stmt|;
comment|/* TODO: change it into SDP_MID_DATA and get  			                      the dirty logic from recvmsg */
block|}
else|else
block|{
name|sdp_dbg
argument_list|(
name|sk
argument_list|,
literal|"Got SrcAvailCancel - "
literal|"but no SrcAvail in process\n"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SDP_MID_SINKAVAIL
case|:
name|sdp_dbg_data
argument_list|(
name|sk
argument_list|,
literal|"Got SinkAvail - not supported: ignored\n"
argument_list|)
expr_stmt|;
name|sdp_prf
argument_list|(
name|sk
argument_list|,
name|NULL
argument_list|,
literal|"Got SinkAvail - not supported: ignored"
argument_list|)
expr_stmt|;
comment|/* FALLTHROUGH */
endif|#
directive|endif
case|case
name|SDP_MID_ABORT
case|:
name|sdp_dbg_data
argument_list|(
name|sk
argument_list|,
literal|"Handling ABORT\n"
argument_list|)
expr_stmt|;
name|sdp_prf
argument_list|(
name|sk
argument_list|,
name|NULL
argument_list|,
literal|"Handling ABORT"
argument_list|)
expr_stmt|;
name|sdp_notify
argument_list|(
name|ssk
argument_list|,
name|ECONNRESET
argument_list|)
expr_stmt|;
break|break;
case|case
name|SDP_MID_DISCONN
case|:
name|sdp_dbg_data
argument_list|(
name|sk
argument_list|,
literal|"Handling DISCONN\n"
argument_list|)
expr_stmt|;
name|sdp_prf
argument_list|(
name|sk
argument_list|,
name|NULL
argument_list|,
literal|"Handling DISCONN"
argument_list|)
expr_stmt|;
name|sdp_handle_disconn
argument_list|(
name|ssk
argument_list|)
expr_stmt|;
break|break;
case|case
name|SDP_MID_CHRCVBUF
case|:
name|sdp_dbg_data
argument_list|(
name|sk
argument_list|,
literal|"Handling RX CHRCVBUF\n"
argument_list|)
expr_stmt|;
name|sdp_handle_resize_request
argument_list|(
name|ssk
argument_list|,
operator|(
expr|struct
name|sdp_chrecvbuf
operator|*
operator|)
operator|(
name|h
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|SDP_MID_CHRCVBUF_ACK
case|:
name|sdp_dbg_data
argument_list|(
name|sk
argument_list|,
literal|"Handling RX CHRCVBUF_ACK\n"
argument_list|)
expr_stmt|;
name|sdp_handle_resize_ack
argument_list|(
name|ssk
argument_list|,
operator|(
expr|struct
name|sdp_chrecvbuf
operator|*
operator|)
operator|(
name|h
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|/* TODO: Handle other messages */
name|sdp_warn
argument_list|(
name|sk
argument_list|,
literal|"SDP: FIXME MID %d\n"
argument_list|,
name|h
operator|->
name|mid
argument_list|)
expr_stmt|;
break|break;
block|}
name|m_freem
argument_list|(
name|mb
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|sdp_process_rx_mb
parameter_list|(
name|struct
name|sdp_sock
modifier|*
name|ssk
parameter_list|,
name|struct
name|mbuf
modifier|*
name|mb
parameter_list|)
block|{
name|struct
name|socket
modifier|*
name|sk
decl_stmt|;
name|struct
name|sdp_bsdh
modifier|*
name|h
decl_stmt|;
name|unsigned
name|long
name|mseq_ack
decl_stmt|;
name|int
name|credits_before
decl_stmt|;
name|h
operator|=
name|mtod
argument_list|(
name|mb
argument_list|,
expr|struct
name|sdp_bsdh
operator|*
argument_list|)
expr_stmt|;
name|sk
operator|=
name|ssk
operator|->
name|socket
expr_stmt|;
comment|/* 	 * If another thread is in so_pcbfree this may be partially torn 	 * down but no further synchronization is required as the destroying 	 * thread will wait for receive to shutdown before discarding the 	 * socket. 	 */
if|if
condition|(
name|sk
operator|==
name|NULL
condition|)
block|{
name|m_freem
argument_list|(
name|mb
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|SDPSTATS_HIST_LINEAR
argument_list|(
name|credits_before_update
argument_list|,
name|tx_credits
argument_list|(
name|ssk
argument_list|)
argument_list|)
expr_stmt|;
name|mseq_ack
operator|=
name|ntohl
argument_list|(
name|h
operator|->
name|mseq_ack
argument_list|)
expr_stmt|;
name|credits_before
operator|=
name|tx_credits
argument_list|(
name|ssk
argument_list|)
expr_stmt|;
name|atomic_set
argument_list|(
operator|&
name|ssk
operator|->
name|tx_ring
operator|.
name|credits
argument_list|,
name|mseq_ack
operator|-
name|ring_head
argument_list|(
name|ssk
operator|->
name|tx_ring
argument_list|)
operator|+
literal|1
operator|+
name|ntohs
argument_list|(
name|h
operator|->
name|bufs
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|mseq_ack
operator|>=
name|ssk
operator|->
name|nagle_last_unacked
condition|)
name|ssk
operator|->
name|nagle_last_unacked
operator|=
literal|0
expr_stmt|;
name|sdp_prf1
argument_list|(
name|ssk
operator|->
name|socket
argument_list|,
name|mb
argument_list|,
literal|"RX %s +%d c:%d->%d mseq:%d ack:%d\n"
argument_list|,
name|mid2str
argument_list|(
name|h
operator|->
name|mid
argument_list|)
argument_list|,
name|ntohs
argument_list|(
name|h
operator|->
name|bufs
argument_list|)
argument_list|,
name|credits_before
argument_list|,
name|tx_credits
argument_list|(
name|ssk
argument_list|)
argument_list|,
name|ntohl
argument_list|(
name|h
operator|->
name|mseq
argument_list|)
argument_list|,
name|ntohl
argument_list|(
name|h
operator|->
name|mseq_ack
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|h
operator|->
name|mid
operator|==
name|SDP_MID_DATA
operator|&&
name|mb
operator|->
name|m_pkthdr
operator|.
name|len
operator|==
name|SDP_HEAD_SIZE
argument_list|)
condition|)
block|{
comment|/* Credit update is valid even after RCV_SHUTDOWN */
name|m_freem
argument_list|(
name|mb
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|(
name|h
operator|->
name|mid
operator|!=
name|SDP_MID_DATA
operator|&&
name|h
operator|->
name|mid
operator|!=
name|SDP_MID_SRCAVAIL
operator|)
operator|||
name|TCPS_HAVERCVDFIN
argument_list|(
name|ssk
operator|->
name|state
argument_list|)
condition|)
block|{
name|sdp_prf
argument_list|(
name|sk
argument_list|,
name|NULL
argument_list|,
literal|"Control mb - queing to control queue"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|SDP_ZCOPY
if|if
condition|(
name|h
operator|->
name|mid
operator|==
name|SDP_MID_SRCAVAIL_CANCEL
condition|)
block|{
name|sdp_dbg_data
argument_list|(
name|sk
argument_list|,
literal|"Got SrcAvailCancel. "
literal|"seq: 0x%d seq_ack: 0x%d\n"
argument_list|,
name|ntohl
argument_list|(
name|h
operator|->
name|mseq
argument_list|)
argument_list|,
name|ntohl
argument_list|(
name|h
operator|->
name|mseq_ack
argument_list|)
argument_list|)
expr_stmt|;
name|ssk
operator|->
name|srcavail_cancel_mseq
operator|=
name|ntohl
argument_list|(
name|h
operator|->
name|mseq
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|h
operator|->
name|mid
operator|==
name|SDP_MID_RDMARDCOMPL
condition|)
block|{
name|struct
name|sdp_rrch
modifier|*
name|rrch
init|=
operator|(
expr|struct
name|sdp_rrch
operator|*
operator|)
operator|(
name|h
operator|+
literal|1
operator|)
decl_stmt|;
name|sdp_dbg_data
argument_list|(
name|sk
argument_list|,
literal|"RdmaRdCompl message arrived\n"
argument_list|)
expr_stmt|;
name|sdp_handle_rdma_read_compl
argument_list|(
name|ssk
argument_list|,
name|ntohl
argument_list|(
name|h
operator|->
name|mseq_ack
argument_list|)
argument_list|,
name|ntohl
argument_list|(
name|rrch
operator|->
name|len
argument_list|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|mbufq_enqueue
argument_list|(
operator|&
name|ssk
operator|->
name|rxctlq
argument_list|,
name|mb
argument_list|)
operator|!=
literal|0
condition|)
name|m_freem
argument_list|(
name|mb
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|sdp_prf1
argument_list|(
name|sk
argument_list|,
name|NULL
argument_list|,
literal|"queueing %s mb\n"
argument_list|,
name|mid2str
argument_list|(
name|h
operator|->
name|mid
argument_list|)
argument_list|)
expr_stmt|;
name|mb
operator|=
name|sdp_sock_queue_rcv_mb
argument_list|(
name|sk
argument_list|,
name|mb
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* called only from irq */
end_comment

begin_function
specifier|static
name|struct
name|mbuf
modifier|*
name|sdp_process_rx_wc
parameter_list|(
name|struct
name|sdp_sock
modifier|*
name|ssk
parameter_list|,
name|struct
name|ib_wc
modifier|*
name|wc
parameter_list|)
block|{
name|struct
name|mbuf
modifier|*
name|mb
decl_stmt|;
name|struct
name|sdp_bsdh
modifier|*
name|h
decl_stmt|;
name|struct
name|socket
modifier|*
name|sk
init|=
name|ssk
operator|->
name|socket
decl_stmt|;
name|int
name|mseq
decl_stmt|;
name|mb
operator|=
name|sdp_recv_completion
argument_list|(
name|ssk
argument_list|,
name|wc
operator|->
name|wr_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
operator|!
name|mb
argument_list|)
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|unlikely
argument_list|(
name|wc
operator|->
name|status
argument_list|)
condition|)
block|{
if|if
condition|(
name|ssk
operator|->
name|qp_active
operator|&&
name|sk
condition|)
block|{
name|sdp_dbg
argument_list|(
name|sk
argument_list|,
literal|"Recv completion with error. "
literal|"Status %d, vendor: %d\n"
argument_list|,
name|wc
operator|->
name|status
argument_list|,
name|wc
operator|->
name|vendor_err
argument_list|)
expr_stmt|;
name|sdp_abort
argument_list|(
name|sk
argument_list|)
expr_stmt|;
name|ssk
operator|->
name|qp_active
operator|=
literal|0
expr_stmt|;
block|}
name|m_freem
argument_list|(
name|mb
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|sdp_dbg_data
argument_list|(
name|sk
argument_list|,
literal|"Recv completion. ID %d Length %d\n"
argument_list|,
operator|(
name|int
operator|)
name|wc
operator|->
name|wr_id
argument_list|,
name|wc
operator|->
name|byte_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|wc
operator|->
name|byte_len
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|sdp_bsdh
argument_list|)
argument_list|)
condition|)
block|{
name|sdp_warn
argument_list|(
name|sk
argument_list|,
literal|"SDP BUG! byte_len %d< %zd\n"
argument_list|,
name|wc
operator|->
name|byte_len
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sdp_bsdh
argument_list|)
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|mb
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
comment|/* Use m_adj to trim the tail of data we didn't use. */
name|m_adj
argument_list|(
name|mb
argument_list|,
operator|-
operator|(
name|mb
operator|->
name|m_pkthdr
operator|.
name|len
operator|-
name|wc
operator|->
name|byte_len
operator|)
argument_list|)
expr_stmt|;
name|h
operator|=
name|mtod
argument_list|(
name|mb
argument_list|,
expr|struct
name|sdp_bsdh
operator|*
argument_list|)
expr_stmt|;
name|SDP_DUMP_PACKET
argument_list|(
name|ssk
operator|->
name|socket
argument_list|,
literal|"RX"
argument_list|,
name|mb
argument_list|,
name|h
argument_list|)
expr_stmt|;
name|ssk
operator|->
name|rx_packets
operator|++
expr_stmt|;
name|ssk
operator|->
name|rx_bytes
operator|+=
name|mb
operator|->
name|m_pkthdr
operator|.
name|len
expr_stmt|;
name|mseq
operator|=
name|ntohl
argument_list|(
name|h
operator|->
name|mseq
argument_list|)
expr_stmt|;
name|atomic_set
argument_list|(
operator|&
name|ssk
operator|->
name|mseq_ack
argument_list|,
name|mseq
argument_list|)
expr_stmt|;
if|if
condition|(
name|mseq
operator|!=
operator|(
name|int
operator|)
name|wc
operator|->
name|wr_id
condition|)
name|sdp_warn
argument_list|(
name|sk
argument_list|,
literal|"SDP BUG! mseq %d != wrid %d\n"
argument_list|,
name|mseq
argument_list|,
operator|(
name|int
operator|)
name|wc
operator|->
name|wr_id
argument_list|)
expr_stmt|;
return|return
name|mb
return|;
block|}
end_function

begin_comment
comment|/* Wakeup writers if we now have credits. */
end_comment

begin_function
specifier|static
name|void
name|sdp_bzcopy_write_space
parameter_list|(
name|struct
name|sdp_sock
modifier|*
name|ssk
parameter_list|)
block|{
name|struct
name|socket
modifier|*
name|sk
init|=
name|ssk
operator|->
name|socket
decl_stmt|;
if|if
condition|(
name|tx_credits
argument_list|(
name|ssk
argument_list|)
operator|>=
name|ssk
operator|->
name|min_bufs
operator|&&
name|sk
condition|)
name|sowwakeup
argument_list|(
name|sk
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* only from interrupt. */
end_comment

begin_function
specifier|static
name|int
name|sdp_poll_rx_cq
parameter_list|(
name|struct
name|sdp_sock
modifier|*
name|ssk
parameter_list|)
block|{
name|struct
name|ib_cq
modifier|*
name|cq
init|=
name|ssk
operator|->
name|rx_ring
operator|.
name|cq
decl_stmt|;
name|struct
name|ib_wc
name|ibwc
index|[
name|SDP_NUM_WC
index|]
decl_stmt|;
name|int
name|n
decl_stmt|,
name|i
decl_stmt|;
name|int
name|wc_processed
init|=
literal|0
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|mb
decl_stmt|;
do|do
block|{
name|n
operator|=
name|ib_poll_cq
argument_list|(
name|cq
argument_list|,
name|SDP_NUM_WC
argument_list|,
name|ibwc
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
operator|++
name|i
control|)
block|{
name|struct
name|ib_wc
modifier|*
name|wc
init|=
operator|&
name|ibwc
index|[
name|i
index|]
decl_stmt|;
name|BUG_ON
argument_list|(
operator|!
operator|(
name|wc
operator|->
name|wr_id
operator|&
name|SDP_OP_RECV
operator|)
argument_list|)
expr_stmt|;
name|mb
operator|=
name|sdp_process_rx_wc
argument_list|(
name|ssk
argument_list|,
name|wc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mb
condition|)
continue|continue;
name|sdp_process_rx_mb
argument_list|(
name|ssk
argument_list|,
name|mb
argument_list|)
expr_stmt|;
name|wc_processed
operator|++
expr_stmt|;
block|}
block|}
do|while
condition|(
name|n
operator|==
name|SDP_NUM_WC
condition|)
do|;
if|if
condition|(
name|wc_processed
condition|)
name|sdp_bzcopy_write_space
argument_list|(
name|ssk
argument_list|)
expr_stmt|;
return|return
name|wc_processed
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|sdp_rx_comp_work
parameter_list|(
name|struct
name|work_struct
modifier|*
name|work
parameter_list|)
block|{
name|struct
name|sdp_sock
modifier|*
name|ssk
init|=
name|container_of
argument_list|(
name|work
argument_list|,
expr|struct
name|sdp_sock
argument_list|,
name|rx_comp_work
argument_list|)
decl_stmt|;
name|sdp_prf
argument_list|(
name|ssk
operator|->
name|socket
argument_list|,
name|NULL
argument_list|,
literal|"%s"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|SDP_WLOCK
argument_list|(
name|ssk
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
operator|!
name|ssk
operator|->
name|qp
argument_list|)
condition|)
block|{
name|sdp_prf
argument_list|(
name|ssk
operator|->
name|socket
argument_list|,
name|NULL
argument_list|,
literal|"qp was destroyed"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|unlikely
argument_list|(
operator|!
name|ssk
operator|->
name|rx_ring
operator|.
name|cq
argument_list|)
condition|)
block|{
name|sdp_prf
argument_list|(
name|ssk
operator|->
name|socket
argument_list|,
name|NULL
argument_list|,
literal|"rx_ring.cq is NULL"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|unlikely
argument_list|(
operator|!
name|ssk
operator|->
name|poll_cq
argument_list|)
condition|)
block|{
name|struct
name|rdma_cm_id
modifier|*
name|id
init|=
name|ssk
operator|->
name|id
decl_stmt|;
if|if
condition|(
name|id
operator|&&
name|id
operator|->
name|qp
condition|)
name|rdma_notify
argument_list|(
name|id
argument_list|,
name|IB_EVENT_COMM_EST
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|sdp_do_posts
argument_list|(
name|ssk
argument_list|)
expr_stmt|;
name|out
label|:
name|SDP_WUNLOCK
argument_list|(
name|ssk
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|sdp_do_posts
parameter_list|(
name|struct
name|sdp_sock
modifier|*
name|ssk
parameter_list|)
block|{
name|struct
name|socket
modifier|*
name|sk
init|=
name|ssk
operator|->
name|socket
decl_stmt|;
name|int
name|xmit_poll_force
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|mb
decl_stmt|;
name|SDP_WLOCK_ASSERT
argument_list|(
name|ssk
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ssk
operator|->
name|qp_active
condition|)
block|{
name|sdp_dbg
argument_list|(
name|sk
argument_list|,
literal|"QP is deactivated\n"
argument_list|)
expr_stmt|;
return|return;
block|}
while|while
condition|(
operator|(
name|mb
operator|=
name|mbufq_dequeue
argument_list|(
operator|&
name|ssk
operator|->
name|rxctlq
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
name|sdp_process_rx_ctl_mb
argument_list|(
name|ssk
argument_list|,
name|mb
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssk
operator|->
name|state
operator|==
name|TCPS_TIME_WAIT
condition|)
return|return;
if|if
condition|(
operator|!
name|ssk
operator|->
name|rx_ring
operator|.
name|cq
operator|||
operator|!
name|ssk
operator|->
name|tx_ring
operator|.
name|cq
condition|)
return|return;
name|sdp_post_recvs
argument_list|(
name|ssk
argument_list|)
expr_stmt|;
if|if
condition|(
name|tx_ring_posted
argument_list|(
name|ssk
argument_list|)
condition|)
name|sdp_xmit_poll
argument_list|(
name|ssk
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|sdp_post_sends
argument_list|(
name|ssk
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
name|xmit_poll_force
operator|=
name|tx_credits
argument_list|(
name|ssk
argument_list|)
operator|<
name|SDP_MIN_TX_CREDITS
expr_stmt|;
if|if
condition|(
name|credit_update_needed
argument_list|(
name|ssk
argument_list|)
operator|||
name|xmit_poll_force
condition|)
block|{
comment|/* if has pending tx because run out of tx_credits - xmit it */
name|sdp_prf
argument_list|(
name|sk
argument_list|,
name|NULL
argument_list|,
literal|"Processing to free pending sends"
argument_list|)
expr_stmt|;
name|sdp_xmit_poll
argument_list|(
name|ssk
argument_list|,
name|xmit_poll_force
argument_list|)
expr_stmt|;
name|sdp_prf
argument_list|(
name|sk
argument_list|,
name|NULL
argument_list|,
literal|"Sending credit update"
argument_list|)
expr_stmt|;
name|sdp_post_sends
argument_list|(
name|ssk
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|sdp_process_rx
parameter_list|(
name|struct
name|sdp_sock
modifier|*
name|ssk
parameter_list|)
block|{
name|int
name|wc_processed
init|=
literal|0
decl_stmt|;
name|int
name|credits_before
decl_stmt|;
if|if
condition|(
operator|!
name|rx_ring_trylock
argument_list|(
operator|&
name|ssk
operator|->
name|rx_ring
argument_list|)
condition|)
block|{
name|sdp_dbg
argument_list|(
name|ssk
operator|->
name|socket
argument_list|,
literal|"ring destroyed. not polling it\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|credits_before
operator|=
name|tx_credits
argument_list|(
name|ssk
argument_list|)
expr_stmt|;
name|wc_processed
operator|=
name|sdp_poll_rx_cq
argument_list|(
name|ssk
argument_list|)
expr_stmt|;
name|sdp_prf
argument_list|(
name|ssk
operator|->
name|socket
argument_list|,
name|NULL
argument_list|,
literal|"processed %d"
argument_list|,
name|wc_processed
argument_list|)
expr_stmt|;
if|if
condition|(
name|wc_processed
condition|)
block|{
name|sdp_prf
argument_list|(
name|ssk
operator|->
name|socket
argument_list|,
name|NULL
argument_list|,
literal|"credits:  %d -> %d"
argument_list|,
name|credits_before
argument_list|,
name|tx_credits
argument_list|(
name|ssk
argument_list|)
argument_list|)
expr_stmt|;
name|queue_work
argument_list|(
name|rx_comp_wq
argument_list|,
operator|&
name|ssk
operator|->
name|rx_comp_work
argument_list|)
expr_stmt|;
block|}
name|sdp_arm_rx_cq
argument_list|(
name|ssk
argument_list|)
expr_stmt|;
name|rx_ring_unlock
argument_list|(
operator|&
name|ssk
operator|->
name|rx_ring
argument_list|)
expr_stmt|;
return|return
operator|(
name|wc_processed
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|sdp_rx_irq
parameter_list|(
name|struct
name|ib_cq
modifier|*
name|cq
parameter_list|,
name|void
modifier|*
name|cq_context
parameter_list|)
block|{
name|struct
name|sdp_sock
modifier|*
name|ssk
decl_stmt|;
name|ssk
operator|=
name|cq_context
expr_stmt|;
name|KASSERT
argument_list|(
name|cq
operator|==
name|ssk
operator|->
name|rx_ring
operator|.
name|cq
argument_list|,
operator|(
literal|"%s: mismatched cq on %p"
operator|,
name|__func__
operator|,
name|ssk
operator|)
argument_list|)
expr_stmt|;
name|SDPSTATS_COUNTER_INC
argument_list|(
name|rx_int_count
argument_list|)
expr_stmt|;
name|sdp_prf
argument_list|(
name|sk
argument_list|,
name|NULL
argument_list|,
literal|"rx irq"
argument_list|)
expr_stmt|;
name|sdp_process_rx
argument_list|(
name|ssk
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|sdp_rx_ring_purge
parameter_list|(
name|struct
name|sdp_sock
modifier|*
name|ssk
parameter_list|)
block|{
while|while
condition|(
name|rx_ring_posted
argument_list|(
name|ssk
argument_list|)
operator|>
literal|0
condition|)
block|{
name|struct
name|mbuf
modifier|*
name|mb
decl_stmt|;
name|mb
operator|=
name|sdp_recv_completion
argument_list|(
name|ssk
argument_list|,
name|ring_tail
argument_list|(
name|ssk
operator|->
name|rx_ring
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mb
condition|)
break|break;
name|m_freem
argument_list|(
name|mb
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|sdp_rx_ring_init
parameter_list|(
name|struct
name|sdp_sock
modifier|*
name|ssk
parameter_list|)
block|{
name|ssk
operator|->
name|rx_ring
operator|.
name|buffer
operator|=
name|NULL
expr_stmt|;
name|ssk
operator|->
name|rx_ring
operator|.
name|destroyed
operator|=
literal|0
expr_stmt|;
name|rw_init
argument_list|(
operator|&
name|ssk
operator|->
name|rx_ring
operator|.
name|destroyed_lock
argument_list|,
literal|"sdp rx lock"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|sdp_rx_cq_event_handler
parameter_list|(
name|struct
name|ib_event
modifier|*
name|event
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{ }
end_function

begin_function
name|int
name|sdp_rx_ring_create
parameter_list|(
name|struct
name|sdp_sock
modifier|*
name|ssk
parameter_list|,
name|struct
name|ib_device
modifier|*
name|device
parameter_list|)
block|{
name|struct
name|ib_cq
modifier|*
name|rx_cq
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|sdp_dbg
argument_list|(
name|ssk
operator|->
name|socket
argument_list|,
literal|"rx ring created"
argument_list|)
expr_stmt|;
name|INIT_WORK
argument_list|(
operator|&
name|ssk
operator|->
name|rx_comp_work
argument_list|,
name|sdp_rx_comp_work
argument_list|)
expr_stmt|;
name|atomic_set
argument_list|(
operator|&
name|ssk
operator|->
name|rx_ring
operator|.
name|head
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|atomic_set
argument_list|(
operator|&
name|ssk
operator|->
name|rx_ring
operator|.
name|tail
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ssk
operator|->
name|rx_ring
operator|.
name|buffer
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|ssk
operator|->
name|rx_ring
operator|.
name|buffer
argument_list|)
operator|*
name|SDP_RX_SIZE
argument_list|,
name|M_SDP
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|rx_cq
operator|=
name|ib_create_cq
argument_list|(
name|device
argument_list|,
name|sdp_rx_irq
argument_list|,
name|sdp_rx_cq_event_handler
argument_list|,
name|ssk
argument_list|,
name|SDP_RX_SIZE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|rx_cq
argument_list|)
condition|)
block|{
name|rc
operator|=
name|PTR_ERR
argument_list|(
name|rx_cq
argument_list|)
expr_stmt|;
name|sdp_warn
argument_list|(
name|ssk
operator|->
name|socket
argument_list|,
literal|"Unable to allocate RX CQ: %d.\n"
argument_list|,
name|rc
argument_list|)
expr_stmt|;
goto|goto
name|err_cq
goto|;
block|}
name|sdp_sk
argument_list|(
name|ssk
operator|->
name|socket
argument_list|)
operator|->
name|rx_ring
operator|.
name|cq
operator|=
name|rx_cq
expr_stmt|;
name|sdp_arm_rx_cq
argument_list|(
name|ssk
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|err_cq
label|:
name|free
argument_list|(
name|ssk
operator|->
name|rx_ring
operator|.
name|buffer
argument_list|,
name|M_SDP
argument_list|)
expr_stmt|;
name|ssk
operator|->
name|rx_ring
operator|.
name|buffer
operator|=
name|NULL
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
name|void
name|sdp_rx_ring_destroy
parameter_list|(
name|struct
name|sdp_sock
modifier|*
name|ssk
parameter_list|)
block|{
name|cancel_work_sync
argument_list|(
operator|&
name|ssk
operator|->
name|rx_comp_work
argument_list|)
expr_stmt|;
name|rx_ring_destroy_lock
argument_list|(
operator|&
name|ssk
operator|->
name|rx_ring
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssk
operator|->
name|rx_ring
operator|.
name|buffer
condition|)
block|{
name|sdp_rx_ring_purge
argument_list|(
name|ssk
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|ssk
operator|->
name|rx_ring
operator|.
name|buffer
argument_list|,
name|M_SDP
argument_list|)
expr_stmt|;
name|ssk
operator|->
name|rx_ring
operator|.
name|buffer
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|ssk
operator|->
name|rx_ring
operator|.
name|cq
condition|)
block|{
if|if
condition|(
name|ib_destroy_cq
argument_list|(
name|ssk
operator|->
name|rx_ring
operator|.
name|cq
argument_list|)
condition|)
block|{
name|sdp_warn
argument_list|(
name|ssk
operator|->
name|socket
argument_list|,
literal|"destroy cq(%p) failed\n"
argument_list|,
name|ssk
operator|->
name|rx_ring
operator|.
name|cq
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ssk
operator|->
name|rx_ring
operator|.
name|cq
operator|=
name|NULL
expr_stmt|;
block|}
block|}
name|WARN_ON
argument_list|(
name|ring_head
argument_list|(
name|ssk
operator|->
name|rx_ring
argument_list|)
operator|!=
name|ring_tail
argument_list|(
name|ssk
operator|->
name|rx_ring
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2008 Mellanox Technologies Ltd.  All rights reserved.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  */
end_comment

begin_include
include|#
directive|include
file|<linux/proc_fs.h>
end_include

begin_include
include|#
directive|include
file|"sdp.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_PROC_FS
end_ifdef

begin_define
define|#
directive|define
name|PROC_SDP_STATS
value|"sdpstats"
end_define

begin_define
define|#
directive|define
name|PROC_SDP_PERF
value|"sdpprf"
end_define

begin_comment
comment|/* just like TCP fs */
end_comment

begin_struct
struct|struct
name|sdp_seq_afinfo
block|{
name|struct
name|module
modifier|*
name|owner
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
name|sa_family_t
name|family
decl_stmt|;
name|int
function_decl|(
modifier|*
name|seq_show
function_decl|)
parameter_list|(
name|struct
name|seq_file
modifier|*
name|m
parameter_list|,
name|void
modifier|*
name|v
parameter_list|)
function_decl|;
name|struct
name|file_operations
modifier|*
name|seq_fops
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|sdp_iter_state
block|{
name|sa_family_t
name|family
decl_stmt|;
name|int
name|num
decl_stmt|;
name|struct
name|seq_operations
name|seq_ops
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
modifier|*
name|sdp_get_idx
parameter_list|(
name|struct
name|seq_file
modifier|*
name|seq
parameter_list|,
name|loff_t
name|pos
parameter_list|)
block|{
name|int
name|i
init|=
literal|0
decl_stmt|;
name|struct
name|sdp_sock
modifier|*
name|ssk
decl_stmt|;
if|if
condition|(
operator|!
name|list_empty
argument_list|(
operator|&
name|sock_list
argument_list|)
condition|)
name|list_for_each_entry
argument_list|(
argument|ssk
argument_list|,
argument|&sock_list
argument_list|,
argument|sock_list
argument_list|)
block|{
if|if
condition|(
name|i
operator|==
name|pos
condition|)
return|return
name|ssk
return|;
name|i
operator|++
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|sdp_seq_start
parameter_list|(
name|struct
name|seq_file
modifier|*
name|seq
parameter_list|,
name|loff_t
modifier|*
name|pos
parameter_list|)
block|{
name|void
modifier|*
name|start
init|=
name|NULL
decl_stmt|;
name|struct
name|sdp_iter_state
modifier|*
name|st
init|=
name|seq
operator|->
name|private
decl_stmt|;
name|st
operator|->
name|num
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|pos
condition|)
return|return
name|SEQ_START_TOKEN
return|;
name|spin_lock_irq
argument_list|(
operator|&
name|sock_list_lock
argument_list|)
expr_stmt|;
name|start
operator|=
name|sdp_get_idx
argument_list|(
name|seq
argument_list|,
operator|*
name|pos
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|start
condition|)
name|sock_hold
argument_list|(
operator|(
expr|struct
name|socket
operator|*
operator|)
name|start
argument_list|,
name|SOCK_REF_SEQ
argument_list|)
expr_stmt|;
name|spin_unlock_irq
argument_list|(
operator|&
name|sock_list_lock
argument_list|)
expr_stmt|;
return|return
name|start
return|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|sdp_seq_next
parameter_list|(
name|struct
name|seq_file
modifier|*
name|seq
parameter_list|,
name|void
modifier|*
name|v
parameter_list|,
name|loff_t
modifier|*
name|pos
parameter_list|)
block|{
name|struct
name|sdp_iter_state
modifier|*
name|st
init|=
name|seq
operator|->
name|private
decl_stmt|;
name|void
modifier|*
name|next
init|=
name|NULL
decl_stmt|;
name|spin_lock_irq
argument_list|(
operator|&
name|sock_list_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|==
name|SEQ_START_TOKEN
condition|)
name|next
operator|=
name|sdp_get_idx
argument_list|(
name|seq
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
name|next
operator|=
name|sdp_get_idx
argument_list|(
name|seq
argument_list|,
operator|*
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|next
condition|)
name|sock_hold
argument_list|(
operator|(
expr|struct
name|socket
operator|*
operator|)
name|next
argument_list|,
name|SOCK_REF_SEQ
argument_list|)
expr_stmt|;
name|spin_unlock_irq
argument_list|(
operator|&
name|sock_list_lock
argument_list|)
expr_stmt|;
operator|*
name|pos
operator|+=
literal|1
expr_stmt|;
name|st
operator|->
name|num
operator|++
expr_stmt|;
return|return
name|next
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|sdp_seq_stop
parameter_list|(
name|struct
name|seq_file
modifier|*
name|seq
parameter_list|,
name|void
modifier|*
name|v
parameter_list|)
block|{ }
end_function

begin_define
define|#
directive|define
name|TMPSZ
value|150
end_define

begin_function
specifier|static
name|int
name|sdp_seq_show
parameter_list|(
name|struct
name|seq_file
modifier|*
name|seq
parameter_list|,
name|void
modifier|*
name|v
parameter_list|)
block|{
name|struct
name|sdp_iter_state
modifier|*
name|st
decl_stmt|;
name|struct
name|socket
modifier|*
name|sk
init|=
name|v
decl_stmt|;
name|char
name|tmpbuf
index|[
name|TMPSZ
operator|+
literal|1
index|]
decl_stmt|;
name|unsigned
name|int
name|dest
decl_stmt|;
name|unsigned
name|int
name|src
decl_stmt|;
name|int
name|uid
decl_stmt|;
name|unsigned
name|long
name|inode
decl_stmt|;
name|__u16
name|destp
decl_stmt|;
name|__u16
name|srcp
decl_stmt|;
name|__u32
name|rx_queue
decl_stmt|,
name|tx_queue
decl_stmt|;
if|if
condition|(
name|v
operator|==
name|SEQ_START_TOKEN
condition|)
block|{
name|seq_printf
argument_list|(
name|seq
argument_list|,
literal|"%-*s\n"
argument_list|,
name|TMPSZ
operator|-
literal|1
argument_list|,
literal|"  sl  local_address rem_address        "
literal|"uid inode   rx_queue tx_queue state"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|st
operator|=
name|seq
operator|->
name|private
expr_stmt|;
name|dest
operator|=
name|inet_sk
argument_list|(
name|sk
argument_list|)
operator|->
name|daddr
expr_stmt|;
name|src
operator|=
name|inet_sk
argument_list|(
name|sk
argument_list|)
operator|->
name|rcv_saddr
expr_stmt|;
name|destp
operator|=
name|ntohs
argument_list|(
name|inet_sk
argument_list|(
name|sk
argument_list|)
operator|->
name|dport
argument_list|)
expr_stmt|;
name|srcp
operator|=
name|ntohs
argument_list|(
name|inet_sk
argument_list|(
name|sk
argument_list|)
operator|->
name|sport
argument_list|)
expr_stmt|;
name|uid
operator|=
name|sock_i_uid
argument_list|(
name|sk
argument_list|)
expr_stmt|;
name|inode
operator|=
name|sock_i_ino
argument_list|(
name|sk
argument_list|)
expr_stmt|;
name|rx_queue
operator|=
name|rcv_nxt
argument_list|(
name|sdp_sk
argument_list|(
name|sk
argument_list|)
argument_list|)
operator|-
name|sdp_sk
argument_list|(
name|sk
argument_list|)
operator|->
name|copied_seq
expr_stmt|;
name|tx_queue
operator|=
name|sdp_sk
argument_list|(
name|sk
argument_list|)
operator|->
name|write_seq
operator|-
name|sdp_sk
argument_list|(
name|sk
argument_list|)
operator|->
name|tx_ring
operator|.
name|una_seq
expr_stmt|;
name|sprintf
argument_list|(
name|tmpbuf
argument_list|,
literal|"%4d: %08X:%04X %08X:%04X %5d %lu	%08X:%08X %X"
argument_list|,
name|st
operator|->
name|num
argument_list|,
name|src
argument_list|,
name|srcp
argument_list|,
name|dest
argument_list|,
name|destp
argument_list|,
name|uid
argument_list|,
name|inode
argument_list|,
name|rx_queue
argument_list|,
name|tx_queue
argument_list|,
name|sk
operator|->
name|sk_state
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|seq
argument_list|,
literal|"%-*s\n"
argument_list|,
name|TMPSZ
operator|-
literal|1
argument_list|,
name|tmpbuf
argument_list|)
expr_stmt|;
name|sock_put
argument_list|(
name|sk
argument_list|,
name|SOCK_REF_SEQ
argument_list|)
expr_stmt|;
name|out
label|:
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sdp_seq_open
parameter_list|(
name|struct
name|inode
modifier|*
name|inode
parameter_list|,
name|struct
name|file
modifier|*
name|file
parameter_list|)
block|{
name|struct
name|sdp_seq_afinfo
modifier|*
name|afinfo
init|=
name|PDE
argument_list|(
name|inode
argument_list|)
operator|->
name|data
decl_stmt|;
name|struct
name|seq_file
modifier|*
name|seq
decl_stmt|;
name|struct
name|sdp_iter_state
modifier|*
name|s
decl_stmt|;
name|int
name|rc
decl_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|afinfo
operator|==
name|NULL
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
comment|/* Workaround bogus warning by memtrack */
define|#
directive|define
name|_kzalloc
parameter_list|(
name|size
parameter_list|,
name|flags
parameter_list|)
value|kzalloc(size,flags)
undef|#
directive|undef
name|kzalloc
name|s
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|s
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
define|#
directive|define
name|kzalloc
parameter_list|(
name|s
parameter_list|,
name|f
parameter_list|)
value|_kzalloc(s,f)
if|if
condition|(
operator|!
name|s
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|s
operator|->
name|family
operator|=
name|afinfo
operator|->
name|family
expr_stmt|;
name|s
operator|->
name|seq_ops
operator|.
name|start
operator|=
name|sdp_seq_start
expr_stmt|;
name|s
operator|->
name|seq_ops
operator|.
name|next
operator|=
name|sdp_seq_next
expr_stmt|;
name|s
operator|->
name|seq_ops
operator|.
name|show
operator|=
name|afinfo
operator|->
name|seq_show
expr_stmt|;
name|s
operator|->
name|seq_ops
operator|.
name|stop
operator|=
name|sdp_seq_stop
expr_stmt|;
name|rc
operator|=
name|seq_open
argument_list|(
name|file
argument_list|,
operator|&
name|s
operator|->
name|seq_ops
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|out_kfree
goto|;
name|seq
operator|=
name|file
operator|->
name|private_data
expr_stmt|;
name|seq
operator|->
name|private
operator|=
name|s
expr_stmt|;
name|out
label|:
return|return
name|rc
return|;
name|out_kfree
label|:
name|kfree
argument_list|(
name|s
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
end_function

begin_decl_stmt
specifier|static
name|struct
name|file_operations
name|sdp_seq_fops
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|sdp_seq_afinfo
name|sdp_seq_afinfo
init|=
block|{
operator|.
name|owner
operator|=
name|THIS_MODULE
block|,
operator|.
name|name
operator|=
literal|"sdp"
block|,
operator|.
name|family
operator|=
name|AF_INET_SDP
block|,
operator|.
name|seq_show
operator|=
name|sdp_seq_show
block|,
operator|.
name|seq_fops
operator|=
operator|&
name|sdp_seq_fops
block|, }
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|SDPSTATS_ON
end_ifdef

begin_expr_stmt
name|DEFINE_PER_CPU
argument_list|(
expr|struct
name|sdpstats
argument_list|,
name|sdpstats
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|void
name|sdpstats_seq_hist
parameter_list|(
name|struct
name|seq_file
modifier|*
name|seq
parameter_list|,
name|char
modifier|*
name|str
parameter_list|,
name|u32
modifier|*
name|h
parameter_list|,
name|int
name|n
parameter_list|,
name|int
name|is_log
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|u32
name|max
init|=
literal|0
decl_stmt|;
name|seq_printf
argument_list|(
name|seq
argument_list|,
literal|"%s:\n"
argument_list|,
name|str
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|h
index|[
name|i
index|]
operator|>
name|max
condition|)
name|max
operator|=
name|h
index|[
name|i
index|]
expr_stmt|;
block|}
if|if
condition|(
name|max
operator|==
literal|0
condition|)
block|{
name|seq_printf
argument_list|(
name|seq
argument_list|,
literal|" - all values are 0\n"
argument_list|)
expr_stmt|;
return|return;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
name|char
name|s
index|[
literal|51
index|]
decl_stmt|;
name|int
name|j
init|=
literal|50
operator|*
name|h
index|[
name|i
index|]
operator|/
name|max
decl_stmt|;
name|int
name|val
init|=
name|is_log
condition|?
operator|(
name|i
operator|==
name|n
operator|-
literal|1
condition|?
literal|0
else|:
literal|1
operator|<<
name|i
operator|)
else|:
name|i
decl_stmt|;
name|memset
argument_list|(
name|s
argument_list|,
literal|'*'
argument_list|,
name|j
argument_list|)
expr_stmt|;
name|s
index|[
name|j
index|]
operator|=
literal|'\0'
expr_stmt|;
name|seq_printf
argument_list|(
name|seq
argument_list|,
literal|"%10d | %-50s - %d\n"
argument_list|,
name|val
argument_list|,
name|s
argument_list|,
name|h
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_define
define|#
directive|define
name|SDPSTATS_COUNTER_GET
parameter_list|(
name|var
parameter_list|)
value|({ \ 	u32 __val = 0;						\ 	unsigned int __i;                                       \ 	for_each_possible_cpu(__i)                              \ 		__val += per_cpu(sdpstats, __i).var;		\ 	__val;							\ })
end_define

begin_define
define|#
directive|define
name|SDPSTATS_HIST_GET
parameter_list|(
name|hist
parameter_list|,
name|hist_len
parameter_list|,
name|sum
parameter_list|)
value|({ \ 	unsigned int __i;                                       \ 	for_each_possible_cpu(__i) {                            \ 		unsigned int __j;				\ 		u32 *h = per_cpu(sdpstats, __i).hist;		\ 		for (__j = 0; __j< hist_len; __j++) { 		\ 			sum[__j] += h[__j];			\ 		} \ 	} 							\ })
end_define

begin_define
define|#
directive|define
name|__sdpstats_seq_hist
parameter_list|(
name|seq
parameter_list|,
name|msg
parameter_list|,
name|hist
parameter_list|,
name|is_log
parameter_list|)
value|({		\ 	u32 tmp_hist[SDPSTATS_MAX_HIST_SIZE];			\ 	int hist_len = ARRAY_SIZE(__get_cpu_var(sdpstats).hist);\ 	memset(tmp_hist, 0, sizeof(tmp_hist));			\ 	SDPSTATS_HIST_GET(hist, hist_len, tmp_hist);	\ 	sdpstats_seq_hist(seq, msg, tmp_hist, hist_len, is_log);\ })
end_define

begin_function
specifier|static
name|int
name|sdpstats_seq_show
parameter_list|(
name|struct
name|seq_file
modifier|*
name|seq
parameter_list|,
name|void
modifier|*
name|v
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|seq_printf
argument_list|(
name|seq
argument_list|,
literal|"SDP statistics:\n"
argument_list|)
expr_stmt|;
name|__sdpstats_seq_hist
argument_list|(
name|seq
argument_list|,
literal|"sendmsg_seglen"
argument_list|,
name|sendmsg_seglen
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|__sdpstats_seq_hist
argument_list|(
name|seq
argument_list|,
literal|"send_size"
argument_list|,
name|send_size
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|__sdpstats_seq_hist
argument_list|(
name|seq
argument_list|,
literal|"credits_before_update"
argument_list|,
name|credits_before_update
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|seq
argument_list|,
literal|"sdp_sendmsg() calls\t\t: %d\n"
argument_list|,
name|SDPSTATS_COUNTER_GET
argument_list|(
name|sendmsg
argument_list|)
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|seq
argument_list|,
literal|"bcopy segments     \t\t: %d\n"
argument_list|,
name|SDPSTATS_COUNTER_GET
argument_list|(
name|sendmsg_bcopy_segment
argument_list|)
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|seq
argument_list|,
literal|"bzcopy segments    \t\t: %d\n"
argument_list|,
name|SDPSTATS_COUNTER_GET
argument_list|(
name|sendmsg_bzcopy_segment
argument_list|)
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|seq
argument_list|,
literal|"zcopy segments    \t\t: %d\n"
argument_list|,
name|SDPSTATS_COUNTER_GET
argument_list|(
name|sendmsg_zcopy_segment
argument_list|)
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|seq
argument_list|,
literal|"post_send_credits  \t\t: %d\n"
argument_list|,
name|SDPSTATS_COUNTER_GET
argument_list|(
name|post_send_credits
argument_list|)
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|seq
argument_list|,
literal|"memcpy_count       \t\t: %u\n"
argument_list|,
name|SDPSTATS_COUNTER_GET
argument_list|(
name|memcpy_count
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ARRAY_SIZE
argument_list|(
name|__get_cpu_var
argument_list|(
name|sdpstats
argument_list|)
operator|.
name|post_send
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|mid2str
argument_list|(
name|i
argument_list|)
condition|)
block|{
name|seq_printf
argument_list|(
name|seq
argument_list|,
literal|"post_send %-20s\t: %d\n"
argument_list|,
name|mid2str
argument_list|(
name|i
argument_list|)
argument_list|,
name|SDPSTATS_COUNTER_GET
argument_list|(
name|post_send
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
name|seq_printf
argument_list|(
name|seq
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|seq
argument_list|,
literal|"post_recv         \t\t: %d\n"
argument_list|,
name|SDPSTATS_COUNTER_GET
argument_list|(
name|post_recv
argument_list|)
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|seq
argument_list|,
literal|"BZCopy poll miss  \t\t: %d\n"
argument_list|,
name|SDPSTATS_COUNTER_GET
argument_list|(
name|bzcopy_poll_miss
argument_list|)
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|seq
argument_list|,
literal|"send_wait_for_mem \t\t: %d\n"
argument_list|,
name|SDPSTATS_COUNTER_GET
argument_list|(
name|send_wait_for_mem
argument_list|)
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|seq
argument_list|,
literal|"send_miss_no_credits\t\t: %d\n"
argument_list|,
name|SDPSTATS_COUNTER_GET
argument_list|(
name|send_miss_no_credits
argument_list|)
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|seq
argument_list|,
literal|"rx_poll_miss      \t\t: %d\n"
argument_list|,
name|SDPSTATS_COUNTER_GET
argument_list|(
name|rx_poll_miss
argument_list|)
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|seq
argument_list|,
literal|"tx_poll_miss      \t\t: %d\n"
argument_list|,
name|SDPSTATS_COUNTER_GET
argument_list|(
name|tx_poll_miss
argument_list|)
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|seq
argument_list|,
literal|"tx_poll_busy      \t\t: %d\n"
argument_list|,
name|SDPSTATS_COUNTER_GET
argument_list|(
name|tx_poll_busy
argument_list|)
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|seq
argument_list|,
literal|"tx_poll_hit       \t\t: %d\n"
argument_list|,
name|SDPSTATS_COUNTER_GET
argument_list|(
name|tx_poll_hit
argument_list|)
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|seq
argument_list|,
literal|"CQ stats:\n"
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|seq
argument_list|,
literal|"- RX interrupts\t\t: %d\n"
argument_list|,
name|SDPSTATS_COUNTER_GET
argument_list|(
name|rx_int_count
argument_list|)
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|seq
argument_list|,
literal|"- TX interrupts\t\t: %d\n"
argument_list|,
name|SDPSTATS_COUNTER_GET
argument_list|(
name|tx_int_count
argument_list|)
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|seq
argument_list|,
literal|"ZCopy stats:\n"
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|seq
argument_list|,
literal|"- TX timeout\t\t: %d\n"
argument_list|,
name|SDPSTATS_COUNTER_GET
argument_list|(
name|zcopy_tx_timeout
argument_list|)
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|seq
argument_list|,
literal|"- TX cross send\t\t: %d\n"
argument_list|,
name|SDPSTATS_COUNTER_GET
argument_list|(
name|zcopy_cross_send
argument_list|)
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|seq
argument_list|,
literal|"- TX aborted by peer\t: %d\n"
argument_list|,
name|SDPSTATS_COUNTER_GET
argument_list|(
name|zcopy_tx_aborted
argument_list|)
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|seq
argument_list|,
literal|"- TX error\t\t: %d\n"
argument_list|,
name|SDPSTATS_COUNTER_GET
argument_list|(
name|zcopy_tx_error
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|sdpstats_write
parameter_list|(
name|struct
name|file
modifier|*
name|file
parameter_list|,
specifier|const
name|char
name|__user
modifier|*
name|buf
parameter_list|,
name|size_t
name|count
parameter_list|,
name|loff_t
modifier|*
name|offs
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|for_each_possible_cpu
argument_list|(
argument|i
argument_list|)
name|memset
argument_list|(
operator|&
name|per_cpu
argument_list|(
name|sdpstats
argument_list|,
name|i
argument_list|)
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sdpstats
argument_list|)
argument_list|)
expr_stmt|;
name|printk
argument_list|(
name|KERN_WARNING
literal|"Cleared sdp statistics\n"
argument_list|)
expr_stmt|;
return|return
name|count
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sdpstats_seq_open
parameter_list|(
name|struct
name|inode
modifier|*
name|inode
parameter_list|,
name|struct
name|file
modifier|*
name|file
parameter_list|)
block|{
return|return
name|single_open
argument_list|(
name|file
argument_list|,
name|sdpstats_seq_show
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|struct
name|file_operations
name|sdpstats_fops
init|=
block|{
operator|.
name|owner
operator|=
name|THIS_MODULE
block|,
operator|.
name|open
operator|=
name|sdpstats_seq_open
block|,
operator|.
name|read
operator|=
name|seq_read
block|,
operator|.
name|write
operator|=
name|sdpstats_write
block|,
operator|.
name|llseek
operator|=
name|seq_lseek
block|,
operator|.
name|release
operator|=
name|single_release
block|, }
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|SDP_PROFILING
end_ifdef

begin_decl_stmt
name|struct
name|sdpprf_log
name|sdpprf_log
index|[
name|SDPPRF_LOG_SIZE
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|sdpprf_log_count
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|long
name|long
name|start_t
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|sdpprf_show
parameter_list|(
name|struct
name|seq_file
modifier|*
name|m
parameter_list|,
name|void
modifier|*
name|v
parameter_list|)
block|{
name|struct
name|sdpprf_log
modifier|*
name|l
init|=
name|v
decl_stmt|;
name|unsigned
name|long
name|nsec_rem
decl_stmt|,
name|t
decl_stmt|;
if|if
condition|(
operator|!
name|sdpprf_log_count
condition|)
block|{
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"No performance logs\n"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|t
operator|=
name|l
operator|->
name|time
operator|-
name|start_t
expr_stmt|;
name|nsec_rem
operator|=
name|do_div
argument_list|(
name|t
argument_list|,
literal|1000000000
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"%-6d: [%5lu.%06lu] %-50s - [%d{%d} %d:%d] "
literal|"mb: %p %s:%d\n"
argument_list|,
name|l
operator|->
name|idx
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|t
argument_list|,
name|nsec_rem
operator|/
literal|1000
argument_list|,
name|l
operator|->
name|msg
argument_list|,
name|l
operator|->
name|pid
argument_list|,
name|l
operator|->
name|cpu
argument_list|,
name|l
operator|->
name|sk_num
argument_list|,
name|l
operator|->
name|sk_dport
argument_list|,
name|l
operator|->
name|mb
argument_list|,
name|l
operator|->
name|func
argument_list|,
name|l
operator|->
name|line
argument_list|)
expr_stmt|;
name|out
label|:
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|sdpprf_start
parameter_list|(
name|struct
name|seq_file
modifier|*
name|p
parameter_list|,
name|loff_t
modifier|*
name|pos
parameter_list|)
block|{
name|int
name|idx
init|=
operator|*
name|pos
decl_stmt|;
if|if
condition|(
operator|!
operator|*
name|pos
condition|)
block|{
if|if
condition|(
operator|!
name|sdpprf_log_count
condition|)
return|return
name|SEQ_START_TOKEN
return|;
block|}
if|if
condition|(
operator|*
name|pos
operator|>=
name|MIN
argument_list|(
name|sdpprf_log_count
argument_list|,
name|SDPPRF_LOG_SIZE
operator|-
literal|1
argument_list|)
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|sdpprf_log_count
operator|>=
name|SDPPRF_LOG_SIZE
operator|-
literal|1
condition|)
block|{
name|int
name|off
init|=
name|sdpprf_log_count
operator|&
operator|(
name|SDPPRF_LOG_SIZE
operator|-
literal|1
operator|)
decl_stmt|;
name|idx
operator|=
operator|(
name|idx
operator|+
name|off
operator|)
operator|&
operator|(
name|SDPPRF_LOG_SIZE
operator|-
literal|1
operator|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|start_t
condition|)
name|start_t
operator|=
name|sdpprf_log
index|[
name|idx
index|]
operator|.
name|time
expr_stmt|;
return|return
operator|&
name|sdpprf_log
index|[
name|idx
index|]
return|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|sdpprf_next
parameter_list|(
name|struct
name|seq_file
modifier|*
name|p
parameter_list|,
name|void
modifier|*
name|v
parameter_list|,
name|loff_t
modifier|*
name|pos
parameter_list|)
block|{
name|struct
name|sdpprf_log
modifier|*
name|l
init|=
name|v
decl_stmt|;
if|if
condition|(
operator|++
operator|*
name|pos
operator|>=
name|MIN
argument_list|(
name|sdpprf_log_count
argument_list|,
name|SDPPRF_LOG_SIZE
operator|-
literal|1
argument_list|)
condition|)
return|return
name|NULL
return|;
operator|++
name|l
expr_stmt|;
if|if
condition|(
name|l
operator|-
operator|&
name|sdpprf_log
index|[
literal|0
index|]
operator|>=
name|SDPPRF_LOG_SIZE
operator|-
literal|1
condition|)
return|return
operator|&
name|sdpprf_log
index|[
literal|0
index|]
return|;
return|return
name|l
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|sdpprf_stop
parameter_list|(
name|struct
name|seq_file
modifier|*
name|p
parameter_list|,
name|void
modifier|*
name|v
parameter_list|)
block|{ }
end_function

begin_decl_stmt
specifier|static
name|struct
name|seq_operations
name|sdpprf_ops
init|=
block|{
operator|.
name|start
operator|=
name|sdpprf_start
block|,
operator|.
name|stop
operator|=
name|sdpprf_stop
block|,
operator|.
name|next
operator|=
name|sdpprf_next
block|,
operator|.
name|show
operator|=
name|sdpprf_show
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|sdpprf_open
parameter_list|(
name|struct
name|inode
modifier|*
name|inode
parameter_list|,
name|struct
name|file
modifier|*
name|file
parameter_list|)
block|{
name|int
name|res
decl_stmt|;
name|res
operator|=
name|seq_open
argument_list|(
name|file
argument_list|,
operator|&
name|sdpprf_ops
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|sdpprf_write
parameter_list|(
name|struct
name|file
modifier|*
name|file
parameter_list|,
specifier|const
name|char
name|__user
modifier|*
name|buf
parameter_list|,
name|size_t
name|count
parameter_list|,
name|loff_t
modifier|*
name|offs
parameter_list|)
block|{
name|sdpprf_log_count
operator|=
literal|0
expr_stmt|;
name|printk
argument_list|(
name|KERN_INFO
literal|"Cleared sdpprf statistics\n"
argument_list|)
expr_stmt|;
return|return
name|count
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|struct
name|file_operations
name|sdpprf_fops
init|=
block|{
operator|.
name|open
operator|=
name|sdpprf_open
block|,
operator|.
name|read
operator|=
name|seq_read
block|,
operator|.
name|llseek
operator|=
name|seq_lseek
block|,
operator|.
name|release
operator|=
name|seq_release
block|,
operator|.
name|write
operator|=
name|sdpprf_write
block|, }
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* SDP_PROFILING */
end_comment

begin_function
name|int
name|__init
name|sdp_proc_init
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|proc_dir_entry
modifier|*
name|p
init|=
name|NULL
decl_stmt|;
ifdef|#
directive|ifdef
name|SDPSTATS_ON
name|struct
name|proc_dir_entry
modifier|*
name|stats
init|=
name|NULL
decl_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|SDP_PROFILING
name|struct
name|proc_dir_entry
modifier|*
name|prof
init|=
name|NULL
decl_stmt|;
endif|#
directive|endif
name|sdp_seq_afinfo
operator|.
name|seq_fops
operator|->
name|owner
operator|=
name|sdp_seq_afinfo
operator|.
name|owner
expr_stmt|;
name|sdp_seq_afinfo
operator|.
name|seq_fops
operator|->
name|open
operator|=
name|sdp_seq_open
expr_stmt|;
name|sdp_seq_afinfo
operator|.
name|seq_fops
operator|->
name|read
operator|=
name|seq_read
expr_stmt|;
name|sdp_seq_afinfo
operator|.
name|seq_fops
operator|->
name|llseek
operator|=
name|seq_lseek
expr_stmt|;
name|sdp_seq_afinfo
operator|.
name|seq_fops
operator|->
name|release
operator|=
name|seq_release_private
expr_stmt|;
name|p
operator|=
name|proc_net_fops_create
argument_list|(
operator|&
name|init_net
argument_list|,
name|sdp_seq_afinfo
operator|.
name|name
argument_list|,
name|S_IRUGO
argument_list|,
name|sdp_seq_afinfo
operator|.
name|seq_fops
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
condition|)
name|p
operator|->
name|data
operator|=
operator|&
name|sdp_seq_afinfo
expr_stmt|;
else|else
goto|goto
name|no_mem
goto|;
ifdef|#
directive|ifdef
name|SDPSTATS_ON
name|stats
operator|=
name|proc_net_fops_create
argument_list|(
operator|&
name|init_net
argument_list|,
name|PROC_SDP_STATS
argument_list|,
name|S_IRUGO
operator||
name|S_IWUGO
argument_list|,
operator|&
name|sdpstats_fops
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|stats
condition|)
goto|goto
name|no_mem_stats
goto|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|SDP_PROFILING
name|prof
operator|=
name|proc_net_fops_create
argument_list|(
operator|&
name|init_net
argument_list|,
name|PROC_SDP_PERF
argument_list|,
name|S_IRUGO
operator||
name|S_IWUGO
argument_list|,
operator|&
name|sdpprf_fops
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|prof
condition|)
goto|goto
name|no_mem_prof
goto|;
endif|#
directive|endif
return|return
literal|0
return|;
ifdef|#
directive|ifdef
name|SDP_PROFILING
name|no_mem_prof
label|:
endif|#
directive|endif
ifdef|#
directive|ifdef
name|SDPSTATS_ON
name|proc_net_remove
argument_list|(
operator|&
name|init_net
argument_list|,
name|PROC_SDP_STATS
argument_list|)
expr_stmt|;
name|no_mem_stats
label|:
endif|#
directive|endif
name|proc_net_remove
argument_list|(
operator|&
name|init_net
argument_list|,
name|sdp_seq_afinfo
operator|.
name|name
argument_list|)
expr_stmt|;
name|no_mem
label|:
return|return
operator|-
name|ENOMEM
return|;
block|}
end_function

begin_function
name|void
name|sdp_proc_unregister
parameter_list|(
name|void
parameter_list|)
block|{
name|proc_net_remove
argument_list|(
operator|&
name|init_net
argument_list|,
name|sdp_seq_afinfo
operator|.
name|name
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|sdp_seq_afinfo
operator|.
name|seq_fops
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|sdp_seq_afinfo
operator|.
name|seq_fops
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|SDPSTATS_ON
name|proc_net_remove
argument_list|(
operator|&
name|init_net
argument_list|,
name|PROC_SDP_STATS
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|SDP_PROFILING
name|proc_net_remove
argument_list|(
operator|&
name|init_net
argument_list|,
name|PROC_SDP_PERF
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* CONFIG_PROC_FS */
end_comment

begin_function
name|int
name|__init
name|sdp_proc_init
parameter_list|(
name|void
parameter_list|)
block|{
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|sdp_proc_unregister
parameter_list|(
name|void
parameter_list|)
block|{  }
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_PROC_FS */
end_comment

end_unit


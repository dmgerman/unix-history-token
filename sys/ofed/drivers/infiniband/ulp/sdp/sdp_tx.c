begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2009 Mellanox Technologies Ltd.  All rights reserved.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  */
end_comment

begin_include
include|#
directive|include
file|"sdp.h"
end_include

begin_define
define|#
directive|define
name|sdp_cnt
parameter_list|(
name|var
parameter_list|)
value|do { (var)++; } while (0)
end_define

begin_expr_stmt
name|SDP_MODPARAM_SINT
argument_list|(
name|sdp_keepalive_probes_sent
argument_list|,
literal|0
argument_list|,
literal|"Total number of keepalive probes sent."
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function_decl
specifier|static
name|int
name|sdp_process_tx_cq
parameter_list|(
name|struct
name|sdp_sock
modifier|*
name|ssk
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|sdp_poll_tx_timeout
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|int
name|sdp_xmit_poll
parameter_list|(
name|struct
name|sdp_sock
modifier|*
name|ssk
parameter_list|,
name|int
name|force
parameter_list|)
block|{
name|int
name|wc_processed
init|=
literal|0
decl_stmt|;
name|SDP_WLOCK_ASSERT
argument_list|(
name|ssk
argument_list|)
expr_stmt|;
name|sdp_prf
argument_list|(
name|ssk
operator|->
name|socket
argument_list|,
name|NULL
argument_list|,
literal|"%s"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
comment|/* If we don't have a pending timer, set one up to catch our recent 	   post in case the interface becomes idle */
if|if
condition|(
operator|!
name|callout_pending
argument_list|(
operator|&
name|ssk
operator|->
name|tx_ring
operator|.
name|timer
argument_list|)
condition|)
name|callout_reset
argument_list|(
operator|&
name|ssk
operator|->
name|tx_ring
operator|.
name|timer
argument_list|,
name|SDP_TX_POLL_TIMEOUT
argument_list|,
name|sdp_poll_tx_timeout
argument_list|,
name|ssk
argument_list|)
expr_stmt|;
comment|/* Poll the CQ every SDP_TX_POLL_MODER packets */
if|if
condition|(
name|force
operator|||
operator|(
operator|++
name|ssk
operator|->
name|tx_ring
operator|.
name|poll_cnt
operator|&
operator|(
name|SDP_TX_POLL_MODER
operator|-
literal|1
operator|)
operator|)
operator|==
literal|0
condition|)
name|wc_processed
operator|=
name|sdp_process_tx_cq
argument_list|(
name|ssk
argument_list|)
expr_stmt|;
return|return
name|wc_processed
return|;
block|}
end_function

begin_function
name|void
name|sdp_post_send
parameter_list|(
name|struct
name|sdp_sock
modifier|*
name|ssk
parameter_list|,
name|struct
name|mbuf
modifier|*
name|mb
parameter_list|)
block|{
name|struct
name|sdp_buf
modifier|*
name|tx_req
decl_stmt|;
name|struct
name|sdp_bsdh
modifier|*
name|h
decl_stmt|;
name|unsigned
name|long
name|mseq
decl_stmt|;
name|struct
name|ib_device
modifier|*
name|dev
decl_stmt|;
name|struct
name|ib_send_wr
modifier|*
name|bad_wr
decl_stmt|;
name|struct
name|ib_sge
name|ibsge
index|[
name|SDP_MAX_SEND_SGES
index|]
decl_stmt|;
name|struct
name|ib_sge
modifier|*
name|sge
decl_stmt|;
name|struct
name|ib_send_wr
name|tx_wr
init|=
block|{
name|NULL
block|}
decl_stmt|;
name|int
name|i
decl_stmt|,
name|rc
decl_stmt|;
name|u64
name|addr
decl_stmt|;
name|SDPSTATS_COUNTER_MID_INC
argument_list|(
name|post_send
argument_list|,
name|h
operator|->
name|mid
argument_list|)
expr_stmt|;
name|SDPSTATS_HIST
argument_list|(
name|send_size
argument_list|,
name|mb
operator|->
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ssk
operator|->
name|qp_active
condition|)
block|{
name|m_freem
argument_list|(
name|mb
argument_list|)
expr_stmt|;
return|return;
block|}
name|mseq
operator|=
name|ring_head
argument_list|(
name|ssk
operator|->
name|tx_ring
argument_list|)
expr_stmt|;
name|h
operator|=
name|mtod
argument_list|(
name|mb
argument_list|,
expr|struct
name|sdp_bsdh
operator|*
argument_list|)
expr_stmt|;
name|ssk
operator|->
name|tx_packets
operator|++
expr_stmt|;
name|ssk
operator|->
name|tx_bytes
operator|+=
name|mb
operator|->
name|m_pkthdr
operator|.
name|len
expr_stmt|;
ifdef|#
directive|ifdef
name|SDP_ZCOPY
if|if
condition|(
name|unlikely
argument_list|(
name|h
operator|->
name|mid
operator|==
name|SDP_MID_SRCAVAIL
argument_list|)
condition|)
block|{
name|struct
name|tx_srcavail_state
modifier|*
name|tx_sa
init|=
name|TX_SRCAVAIL_STATE
argument_list|(
name|mb
argument_list|)
decl_stmt|;
if|if
condition|(
name|ssk
operator|->
name|tx_sa
operator|!=
name|tx_sa
condition|)
block|{
name|sdp_dbg_data
argument_list|(
name|ssk
operator|->
name|socket
argument_list|,
literal|"SrcAvail cancelled "
literal|"before being sent!\n"
argument_list|)
expr_stmt|;
name|WARN_ON
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|mb
argument_list|)
expr_stmt|;
return|return;
block|}
name|TX_SRCAVAIL_STATE
argument_list|(
name|mb
argument_list|)
operator|->
name|mseq
operator|=
name|mseq
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|unlikely
argument_list|(
name|mb
operator|->
name|m_flags
operator|&
name|M_URG
argument_list|)
condition|)
name|h
operator|->
name|flags
operator|=
name|SDP_OOB_PRES
operator||
name|SDP_OOB_PEND
expr_stmt|;
else|else
name|h
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
name|mb
operator|->
name|m_flags
operator||=
name|M_RDONLY
expr_stmt|;
comment|/* Don't allow compression once sent. */
name|h
operator|->
name|bufs
operator|=
name|htons
argument_list|(
name|rx_ring_posted
argument_list|(
name|ssk
argument_list|)
argument_list|)
expr_stmt|;
name|h
operator|->
name|len
operator|=
name|htonl
argument_list|(
name|mb
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|)
expr_stmt|;
name|h
operator|->
name|mseq
operator|=
name|htonl
argument_list|(
name|mseq
argument_list|)
expr_stmt|;
name|h
operator|->
name|mseq_ack
operator|=
name|htonl
argument_list|(
name|mseq_ack
argument_list|(
name|ssk
argument_list|)
argument_list|)
expr_stmt|;
name|sdp_prf1
argument_list|(
name|ssk
operator|->
name|socket
argument_list|,
name|mb
argument_list|,
literal|"TX: %s bufs: %d mseq:%ld ack:%d"
argument_list|,
name|mid2str
argument_list|(
name|h
operator|->
name|mid
argument_list|)
argument_list|,
name|rx_ring_posted
argument_list|(
name|ssk
argument_list|)
argument_list|,
name|mseq
argument_list|,
name|ntohl
argument_list|(
name|h
operator|->
name|mseq_ack
argument_list|)
argument_list|)
expr_stmt|;
name|SDP_DUMP_PACKET
argument_list|(
name|ssk
operator|->
name|socket
argument_list|,
literal|"TX"
argument_list|,
name|mb
argument_list|,
name|h
argument_list|)
expr_stmt|;
name|tx_req
operator|=
operator|&
name|ssk
operator|->
name|tx_ring
operator|.
name|buffer
index|[
name|mseq
operator|&
operator|(
name|SDP_TX_SIZE
operator|-
literal|1
operator|)
index|]
expr_stmt|;
name|tx_req
operator|->
name|mb
operator|=
name|mb
expr_stmt|;
name|dev
operator|=
name|ssk
operator|->
name|ib_device
expr_stmt|;
name|sge
operator|=
operator|&
name|ibsge
index|[
literal|0
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|mb
operator|!=
name|NULL
condition|;
name|i
operator|++
operator|,
name|mb
operator|=
name|mb
operator|->
name|m_next
operator|,
name|sge
operator|++
control|)
block|{
name|addr
operator|=
name|ib_dma_map_single
argument_list|(
name|dev
argument_list|,
name|mb
operator|->
name|m_data
argument_list|,
name|mb
operator|->
name|m_len
argument_list|,
name|DMA_TO_DEVICE
argument_list|)
expr_stmt|;
comment|/* TODO: proper error handling */
name|BUG_ON
argument_list|(
name|ib_dma_mapping_error
argument_list|(
name|dev
argument_list|,
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|BUG_ON
argument_list|(
name|i
operator|>=
name|SDP_MAX_SEND_SGES
argument_list|)
expr_stmt|;
name|tx_req
operator|->
name|mapping
index|[
name|i
index|]
operator|=
name|addr
expr_stmt|;
name|sge
operator|->
name|addr
operator|=
name|addr
expr_stmt|;
name|sge
operator|->
name|length
operator|=
name|mb
operator|->
name|m_len
expr_stmt|;
name|sge
operator|->
name|lkey
operator|=
name|ssk
operator|->
name|sdp_dev
operator|->
name|mr
operator|->
name|lkey
expr_stmt|;
block|}
name|tx_wr
operator|.
name|next
operator|=
name|NULL
expr_stmt|;
name|tx_wr
operator|.
name|wr_id
operator|=
name|mseq
operator||
name|SDP_OP_SEND
expr_stmt|;
name|tx_wr
operator|.
name|sg_list
operator|=
name|ibsge
expr_stmt|;
name|tx_wr
operator|.
name|num_sge
operator|=
name|i
expr_stmt|;
name|tx_wr
operator|.
name|opcode
operator|=
name|IB_WR_SEND
expr_stmt|;
name|tx_wr
operator|.
name|send_flags
operator|=
name|IB_SEND_SIGNALED
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|tx_req
operator|->
name|mb
operator|->
name|m_flags
operator|&
name|M_URG
argument_list|)
condition|)
name|tx_wr
operator|.
name|send_flags
operator||=
name|IB_SEND_SOLICITED
expr_stmt|;
name|rc
operator|=
name|ib_post_send
argument_list|(
name|ssk
operator|->
name|qp
argument_list|,
operator|&
name|tx_wr
argument_list|,
operator|&
name|bad_wr
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|rc
argument_list|)
condition|)
block|{
name|sdp_dbg
argument_list|(
name|ssk
operator|->
name|socket
argument_list|,
literal|"ib_post_send failed with status %d.\n"
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|sdp_cleanup_sdp_buf
argument_list|(
name|ssk
argument_list|,
name|tx_req
argument_list|,
name|DMA_TO_DEVICE
argument_list|)
expr_stmt|;
name|sdp_notify
argument_list|(
name|ssk
argument_list|,
name|ECONNRESET
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|tx_req
operator|->
name|mb
argument_list|)
expr_stmt|;
return|return;
block|}
name|atomic_inc
argument_list|(
operator|&
name|ssk
operator|->
name|tx_ring
operator|.
name|head
argument_list|)
expr_stmt|;
name|atomic_dec
argument_list|(
operator|&
name|ssk
operator|->
name|tx_ring
operator|.
name|credits
argument_list|)
expr_stmt|;
name|atomic_set
argument_list|(
operator|&
name|ssk
operator|->
name|remote_credits
argument_list|,
name|rx_ring_posted
argument_list|(
name|ssk
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|struct
name|mbuf
modifier|*
name|sdp_send_completion
parameter_list|(
name|struct
name|sdp_sock
modifier|*
name|ssk
parameter_list|,
name|int
name|mseq
parameter_list|)
block|{
name|struct
name|ib_device
modifier|*
name|dev
decl_stmt|;
name|struct
name|sdp_buf
modifier|*
name|tx_req
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|mb
init|=
name|NULL
decl_stmt|;
name|struct
name|sdp_tx_ring
modifier|*
name|tx_ring
init|=
operator|&
name|ssk
operator|->
name|tx_ring
decl_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|mseq
operator|!=
name|ring_tail
argument_list|(
operator|*
name|tx_ring
argument_list|)
argument_list|)
condition|)
block|{
name|printk
argument_list|(
name|KERN_WARNING
literal|"Bogus send completion id %d tail %d\n"
argument_list|,
name|mseq
argument_list|,
name|ring_tail
argument_list|(
operator|*
name|tx_ring
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|dev
operator|=
name|ssk
operator|->
name|ib_device
expr_stmt|;
name|tx_req
operator|=
operator|&
name|tx_ring
operator|->
name|buffer
index|[
name|mseq
operator|&
operator|(
name|SDP_TX_SIZE
operator|-
literal|1
operator|)
index|]
expr_stmt|;
name|mb
operator|=
name|tx_req
operator|->
name|mb
expr_stmt|;
name|sdp_cleanup_sdp_buf
argument_list|(
name|ssk
argument_list|,
name|tx_req
argument_list|,
name|DMA_TO_DEVICE
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|SDP_ZCOPY
comment|/* TODO: AIO and real zcopy code; add their context support here */
if|if
condition|(
name|BZCOPY_STATE
argument_list|(
name|mb
argument_list|)
condition|)
name|BZCOPY_STATE
argument_list|(
name|mb
argument_list|)
operator|->
name|busy
operator|--
expr_stmt|;
endif|#
directive|endif
name|atomic_inc
argument_list|(
operator|&
name|tx_ring
operator|->
name|tail
argument_list|)
expr_stmt|;
name|out
label|:
return|return
name|mb
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sdp_handle_send_comp
parameter_list|(
name|struct
name|sdp_sock
modifier|*
name|ssk
parameter_list|,
name|struct
name|ib_wc
modifier|*
name|wc
parameter_list|)
block|{
name|struct
name|mbuf
modifier|*
name|mb
init|=
name|NULL
decl_stmt|;
name|struct
name|sdp_bsdh
modifier|*
name|h
decl_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|wc
operator|->
name|status
argument_list|)
condition|)
block|{
if|if
condition|(
name|wc
operator|->
name|status
operator|!=
name|IB_WC_WR_FLUSH_ERR
condition|)
block|{
name|sdp_prf
argument_list|(
name|ssk
operator|->
name|socket
argument_list|,
name|mb
argument_list|,
literal|"Send completion with error. "
literal|"Status %d"
argument_list|,
name|wc
operator|->
name|status
argument_list|)
expr_stmt|;
name|sdp_dbg_data
argument_list|(
name|ssk
operator|->
name|socket
argument_list|,
literal|"Send completion with error. "
literal|"Status %d\n"
argument_list|,
name|wc
operator|->
name|status
argument_list|)
expr_stmt|;
name|sdp_notify
argument_list|(
name|ssk
argument_list|,
name|ECONNRESET
argument_list|)
expr_stmt|;
block|}
block|}
name|mb
operator|=
name|sdp_send_completion
argument_list|(
name|ssk
argument_list|,
name|wc
operator|->
name|wr_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
operator|!
name|mb
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|h
operator|=
name|mtod
argument_list|(
name|mb
argument_list|,
expr|struct
name|sdp_bsdh
operator|*
argument_list|)
expr_stmt|;
name|sdp_prf1
argument_list|(
name|ssk
operator|->
name|socket
argument_list|,
name|mb
argument_list|,
literal|"tx completion. mseq:%d"
argument_list|,
name|ntohl
argument_list|(
name|h
operator|->
name|mseq
argument_list|)
argument_list|)
expr_stmt|;
name|sdp_dbg
argument_list|(
name|ssk
operator|->
name|socket
argument_list|,
literal|"tx completion. %p %d mseq:%d"
argument_list|,
name|mb
argument_list|,
name|mb
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|,
name|ntohl
argument_list|(
name|h
operator|->
name|mseq
argument_list|)
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|mb
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|sdp_process_tx_wc
parameter_list|(
name|struct
name|sdp_sock
modifier|*
name|ssk
parameter_list|,
name|struct
name|ib_wc
modifier|*
name|wc
parameter_list|)
block|{
if|if
condition|(
name|likely
argument_list|(
name|wc
operator|->
name|wr_id
operator|&
name|SDP_OP_SEND
argument_list|)
condition|)
block|{
name|sdp_handle_send_comp
argument_list|(
name|ssk
argument_list|,
name|wc
argument_list|)
expr_stmt|;
return|return;
block|}
ifdef|#
directive|ifdef
name|SDP_ZCOPY
if|if
condition|(
name|wc
operator|->
name|wr_id
operator|&
name|SDP_OP_RDMA
condition|)
block|{
comment|/* TODO: handle failed RDMA read cqe */
name|sdp_dbg_data
argument_list|(
name|ssk
operator|->
name|socket
argument_list|,
literal|"TX comp: RDMA read. status: %d\n"
argument_list|,
name|wc
operator|->
name|status
argument_list|)
expr_stmt|;
name|sdp_prf1
argument_list|(
name|sk
argument_list|,
name|NULL
argument_list|,
literal|"TX comp: RDMA read"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ssk
operator|->
name|tx_ring
operator|.
name|rdma_inflight
condition|)
block|{
name|sdp_warn
argument_list|(
name|ssk
operator|->
name|socket
argument_list|,
literal|"ERROR: unexpected RDMA read\n"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|!
name|ssk
operator|->
name|tx_ring
operator|.
name|rdma_inflight
operator|->
name|busy
condition|)
block|{
name|sdp_warn
argument_list|(
name|ssk
operator|->
name|socket
argument_list|,
literal|"ERROR: too many RDMA read completions\n"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Only last RDMA read WR is signalled. Order is guaranteed - 		 * therefore if Last RDMA read WR is completed - all other 		 * have, too */
name|ssk
operator|->
name|tx_ring
operator|.
name|rdma_inflight
operator|->
name|busy
operator|=
literal|0
expr_stmt|;
name|sowwakeup
argument_list|(
name|ssk
operator|->
name|socket
argument_list|)
expr_stmt|;
name|sdp_dbg_data
argument_list|(
name|ssk
operator|->
name|socket
argument_list|,
literal|"woke up sleepers\n"
argument_list|)
expr_stmt|;
return|return;
block|}
endif|#
directive|endif
comment|/* Keepalive probe sent cleanup */
name|sdp_cnt
argument_list|(
name|sdp_keepalive_probes_sent
argument_list|)
expr_stmt|;
if|if
condition|(
name|likely
argument_list|(
operator|!
name|wc
operator|->
name|status
argument_list|)
condition|)
return|return;
name|sdp_dbg
argument_list|(
name|ssk
operator|->
name|socket
argument_list|,
literal|" %s consumes KEEPALIVE status %d\n"
argument_list|,
name|__func__
argument_list|,
name|wc
operator|->
name|status
argument_list|)
expr_stmt|;
if|if
condition|(
name|wc
operator|->
name|status
operator|==
name|IB_WC_WR_FLUSH_ERR
condition|)
return|return;
name|sdp_notify
argument_list|(
name|ssk
argument_list|,
name|ECONNRESET
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|sdp_process_tx_cq
parameter_list|(
name|struct
name|sdp_sock
modifier|*
name|ssk
parameter_list|)
block|{
name|struct
name|ib_wc
name|ibwc
index|[
name|SDP_NUM_WC
index|]
decl_stmt|;
name|int
name|n
decl_stmt|,
name|i
decl_stmt|;
name|int
name|wc_processed
init|=
literal|0
decl_stmt|;
name|SDP_WLOCK_ASSERT
argument_list|(
name|ssk
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ssk
operator|->
name|tx_ring
operator|.
name|cq
condition|)
block|{
name|sdp_dbg
argument_list|(
name|ssk
operator|->
name|socket
argument_list|,
literal|"tx irq on destroyed tx_cq\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
do|do
block|{
name|n
operator|=
name|ib_poll_cq
argument_list|(
name|ssk
operator|->
name|tx_ring
operator|.
name|cq
argument_list|,
name|SDP_NUM_WC
argument_list|,
name|ibwc
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
operator|++
name|i
control|)
block|{
name|sdp_process_tx_wc
argument_list|(
name|ssk
argument_list|,
name|ibwc
operator|+
name|i
argument_list|)
expr_stmt|;
name|wc_processed
operator|++
expr_stmt|;
block|}
block|}
do|while
condition|(
name|n
operator|==
name|SDP_NUM_WC
condition|)
do|;
if|if
condition|(
name|wc_processed
condition|)
block|{
name|sdp_post_sends
argument_list|(
name|ssk
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
name|sdp_prf1
argument_list|(
name|sk
argument_list|,
name|NULL
argument_list|,
literal|"Waking sendmsg. inflight=%d"
argument_list|,
operator|(
name|u32
operator|)
name|tx_ring_posted
argument_list|(
name|ssk
argument_list|)
argument_list|)
expr_stmt|;
name|sowwakeup
argument_list|(
name|ssk
operator|->
name|socket
argument_list|)
expr_stmt|;
block|}
return|return
name|wc_processed
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|sdp_poll_tx
parameter_list|(
name|struct
name|sdp_sock
modifier|*
name|ssk
parameter_list|)
block|{
name|struct
name|socket
modifier|*
name|sk
init|=
name|ssk
operator|->
name|socket
decl_stmt|;
name|u32
name|inflight
decl_stmt|,
name|wc_processed
decl_stmt|;
name|sdp_prf1
argument_list|(
name|ssk
operator|->
name|socket
argument_list|,
name|NULL
argument_list|,
literal|"TX timeout: inflight=%d, head=%d tail=%d"
argument_list|,
operator|(
name|u32
operator|)
name|tx_ring_posted
argument_list|(
name|ssk
argument_list|)
argument_list|,
name|ring_head
argument_list|(
name|ssk
operator|->
name|tx_ring
argument_list|)
argument_list|,
name|ring_tail
argument_list|(
name|ssk
operator|->
name|tx_ring
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|ssk
operator|->
name|state
operator|==
name|TCPS_CLOSED
argument_list|)
condition|)
block|{
name|sdp_warn
argument_list|(
name|sk
argument_list|,
literal|"Socket is closed\n"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|wc_processed
operator|=
name|sdp_process_tx_cq
argument_list|(
name|ssk
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wc_processed
condition|)
name|SDPSTATS_COUNTER_INC
argument_list|(
name|tx_poll_miss
argument_list|)
expr_stmt|;
else|else
name|SDPSTATS_COUNTER_INC
argument_list|(
name|tx_poll_hit
argument_list|)
expr_stmt|;
name|inflight
operator|=
operator|(
name|u32
operator|)
name|tx_ring_posted
argument_list|(
name|ssk
argument_list|)
expr_stmt|;
name|sdp_prf1
argument_list|(
name|ssk
operator|->
name|socket
argument_list|,
name|NULL
argument_list|,
literal|"finished tx proccessing. inflight = %d"
argument_list|,
name|inflight
argument_list|)
expr_stmt|;
comment|/* If there are still packets in flight and the timer has not already 	 * been scheduled by the Tx routine then schedule it here to guarantee 	 * completion processing of these packets */
if|if
condition|(
name|inflight
condition|)
name|callout_reset
argument_list|(
operator|&
name|ssk
operator|->
name|tx_ring
operator|.
name|timer
argument_list|,
name|SDP_TX_POLL_TIMEOUT
argument_list|,
name|sdp_poll_tx_timeout
argument_list|,
name|ssk
argument_list|)
expr_stmt|;
name|out
label|:
ifdef|#
directive|ifdef
name|SDP_ZCOPY
if|if
condition|(
name|ssk
operator|->
name|tx_ring
operator|.
name|rdma_inflight
operator|&&
name|ssk
operator|->
name|tx_ring
operator|.
name|rdma_inflight
operator|->
name|busy
condition|)
block|{
name|sdp_prf1
argument_list|(
name|sk
argument_list|,
name|NULL
argument_list|,
literal|"RDMA is inflight - arming irq"
argument_list|)
expr_stmt|;
name|sdp_arm_tx_cq
argument_list|(
name|ssk
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|sdp_poll_tx_timeout
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|sdp_sock
modifier|*
name|ssk
init|=
operator|(
expr|struct
name|sdp_sock
operator|*
operator|)
name|data
decl_stmt|;
if|if
condition|(
operator|!
name|callout_active
argument_list|(
operator|&
name|ssk
operator|->
name|tx_ring
operator|.
name|timer
argument_list|)
condition|)
return|return;
name|callout_deactivate
argument_list|(
operator|&
name|ssk
operator|->
name|tx_ring
operator|.
name|timer
argument_list|)
expr_stmt|;
name|sdp_poll_tx
argument_list|(
name|ssk
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|sdp_tx_irq
parameter_list|(
name|struct
name|ib_cq
modifier|*
name|cq
parameter_list|,
name|void
modifier|*
name|cq_context
parameter_list|)
block|{
name|struct
name|sdp_sock
modifier|*
name|ssk
decl_stmt|;
name|ssk
operator|=
name|cq_context
expr_stmt|;
name|sdp_prf1
argument_list|(
name|ssk
operator|->
name|socket
argument_list|,
name|NULL
argument_list|,
literal|"tx irq"
argument_list|)
expr_stmt|;
name|sdp_dbg_data
argument_list|(
name|ssk
operator|->
name|socket
argument_list|,
literal|"Got tx comp interrupt\n"
argument_list|)
expr_stmt|;
name|SDPSTATS_COUNTER_INC
argument_list|(
name|tx_int_count
argument_list|)
expr_stmt|;
name|SDP_WLOCK
argument_list|(
name|ssk
argument_list|)
expr_stmt|;
name|sdp_poll_tx
argument_list|(
name|ssk
argument_list|)
expr_stmt|;
name|SDP_WUNLOCK
argument_list|(
name|ssk
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|sdp_tx_ring_purge
parameter_list|(
name|struct
name|sdp_sock
modifier|*
name|ssk
parameter_list|)
block|{
while|while
condition|(
name|tx_ring_posted
argument_list|(
name|ssk
argument_list|)
condition|)
block|{
name|struct
name|mbuf
modifier|*
name|mb
decl_stmt|;
name|mb
operator|=
name|sdp_send_completion
argument_list|(
name|ssk
argument_list|,
name|ring_tail
argument_list|(
name|ssk
operator|->
name|tx_ring
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mb
condition|)
break|break;
name|m_freem
argument_list|(
name|mb
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|sdp_post_keepalive
parameter_list|(
name|struct
name|sdp_sock
modifier|*
name|ssk
parameter_list|)
block|{
name|int
name|rc
decl_stmt|;
name|struct
name|ib_send_wr
name|wr
decl_stmt|,
modifier|*
name|bad_wr
decl_stmt|;
name|sdp_dbg
argument_list|(
name|ssk
operator|->
name|socket
argument_list|,
literal|"%s\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|wr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|wr
argument_list|)
argument_list|)
expr_stmt|;
name|wr
operator|.
name|next
operator|=
name|NULL
expr_stmt|;
name|wr
operator|.
name|wr_id
operator|=
literal|0
expr_stmt|;
name|wr
operator|.
name|sg_list
operator|=
name|NULL
expr_stmt|;
name|wr
operator|.
name|num_sge
operator|=
literal|0
expr_stmt|;
name|wr
operator|.
name|opcode
operator|=
name|IB_WR_RDMA_WRITE
expr_stmt|;
name|rc
operator|=
name|ib_post_send
argument_list|(
name|ssk
operator|->
name|qp
argument_list|,
operator|&
name|wr
argument_list|,
operator|&
name|bad_wr
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|sdp_dbg
argument_list|(
name|ssk
operator|->
name|socket
argument_list|,
literal|"ib_post_keepalive failed with status %d.\n"
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|sdp_notify
argument_list|(
name|ssk
argument_list|,
name|ECONNRESET
argument_list|)
expr_stmt|;
block|}
name|sdp_cnt
argument_list|(
name|sdp_keepalive_probes_sent
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|sdp_tx_cq_event_handler
parameter_list|(
name|struct
name|ib_event
modifier|*
name|event
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{ }
end_function

begin_function
name|int
name|sdp_tx_ring_create
parameter_list|(
name|struct
name|sdp_sock
modifier|*
name|ssk
parameter_list|,
name|struct
name|ib_device
modifier|*
name|device
parameter_list|)
block|{
name|struct
name|ib_cq
modifier|*
name|tx_cq
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|sdp_dbg
argument_list|(
name|ssk
operator|->
name|socket
argument_list|,
literal|"tx ring create\n"
argument_list|)
expr_stmt|;
name|callout_init_rw
argument_list|(
operator|&
name|ssk
operator|->
name|tx_ring
operator|.
name|timer
argument_list|,
operator|&
name|ssk
operator|->
name|lock
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|callout_init_rw
argument_list|(
operator|&
name|ssk
operator|->
name|nagle_timer
argument_list|,
operator|&
name|ssk
operator|->
name|lock
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|atomic_set
argument_list|(
operator|&
name|ssk
operator|->
name|tx_ring
operator|.
name|head
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|atomic_set
argument_list|(
operator|&
name|ssk
operator|->
name|tx_ring
operator|.
name|tail
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ssk
operator|->
name|tx_ring
operator|.
name|buffer
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
expr|*
name|ssk
operator|->
name|tx_ring
operator|.
name|buffer
operator|*
name|SDP_TX_SIZE
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ssk
operator|->
name|tx_ring
operator|.
name|buffer
condition|)
block|{
name|rc
operator|=
operator|-
name|ENOMEM
expr_stmt|;
name|sdp_warn
argument_list|(
name|ssk
operator|->
name|socket
argument_list|,
literal|"Can't allocate TX Ring size %zd.\n"
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ssk
operator|->
name|tx_ring
operator|.
name|buffer
argument_list|)
operator|*
name|SDP_TX_SIZE
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|tx_cq
operator|=
name|ib_create_cq
argument_list|(
name|device
argument_list|,
name|sdp_tx_irq
argument_list|,
name|sdp_tx_cq_event_handler
argument_list|,
name|ssk
argument_list|,
name|SDP_TX_SIZE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|tx_cq
argument_list|)
condition|)
block|{
name|rc
operator|=
name|PTR_ERR
argument_list|(
name|tx_cq
argument_list|)
expr_stmt|;
name|sdp_warn
argument_list|(
name|ssk
operator|->
name|socket
argument_list|,
literal|"Unable to allocate TX CQ: %d.\n"
argument_list|,
name|rc
argument_list|)
expr_stmt|;
goto|goto
name|err_cq
goto|;
block|}
name|ssk
operator|->
name|tx_ring
operator|.
name|cq
operator|=
name|tx_cq
expr_stmt|;
name|ssk
operator|->
name|tx_ring
operator|.
name|poll_cnt
operator|=
literal|0
expr_stmt|;
name|sdp_arm_tx_cq
argument_list|(
name|ssk
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|err_cq
label|:
name|kfree
argument_list|(
name|ssk
operator|->
name|tx_ring
operator|.
name|buffer
argument_list|)
expr_stmt|;
name|ssk
operator|->
name|tx_ring
operator|.
name|buffer
operator|=
name|NULL
expr_stmt|;
name|out
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
name|void
name|sdp_tx_ring_destroy
parameter_list|(
name|struct
name|sdp_sock
modifier|*
name|ssk
parameter_list|)
block|{
name|sdp_dbg
argument_list|(
name|ssk
operator|->
name|socket
argument_list|,
literal|"tx ring destroy\n"
argument_list|)
expr_stmt|;
name|SDP_WLOCK
argument_list|(
name|ssk
argument_list|)
expr_stmt|;
name|callout_stop
argument_list|(
operator|&
name|ssk
operator|->
name|tx_ring
operator|.
name|timer
argument_list|)
expr_stmt|;
name|callout_stop
argument_list|(
operator|&
name|ssk
operator|->
name|nagle_timer
argument_list|)
expr_stmt|;
name|SDP_WUNLOCK
argument_list|(
name|ssk
argument_list|)
expr_stmt|;
name|callout_drain
argument_list|(
operator|&
name|ssk
operator|->
name|tx_ring
operator|.
name|timer
argument_list|)
expr_stmt|;
name|callout_drain
argument_list|(
operator|&
name|ssk
operator|->
name|nagle_timer
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssk
operator|->
name|tx_ring
operator|.
name|buffer
condition|)
block|{
name|sdp_tx_ring_purge
argument_list|(
name|ssk
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|ssk
operator|->
name|tx_ring
operator|.
name|buffer
argument_list|)
expr_stmt|;
name|ssk
operator|->
name|tx_ring
operator|.
name|buffer
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|ssk
operator|->
name|tx_ring
operator|.
name|cq
condition|)
block|{
if|if
condition|(
name|ib_destroy_cq
argument_list|(
name|ssk
operator|->
name|tx_ring
operator|.
name|cq
argument_list|)
condition|)
block|{
name|sdp_warn
argument_list|(
name|ssk
operator|->
name|socket
argument_list|,
literal|"destroy cq(%p) failed\n"
argument_list|,
name|ssk
operator|->
name|tx_ring
operator|.
name|cq
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ssk
operator|->
name|tx_ring
operator|.
name|cq
operator|=
name|NULL
expr_stmt|;
block|}
block|}
name|WARN_ON
argument_list|(
name|ring_head
argument_list|(
name|ssk
operator|->
name|tx_ring
argument_list|)
operator|!=
name|ring_tail
argument_list|(
name|ssk
operator|->
name|tx_ring
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

end_unit

